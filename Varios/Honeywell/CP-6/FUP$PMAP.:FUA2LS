VERSION A02

PL6.E3A0      #001=FUP$PMAP File=FUP$PMAP.:FUA2TSI                               FRI 11/21/97 11:34 Page:1    
        1        1        /*M* Portmapper code - either client or server. */
        2        2        /*T***********************************************************/
        3        3        /*T*                                                         */
        4        4        /*T* Copyright (c) Bull HN Information Systems Inc., 1997    */
        5        5        /*T*                                                         */
        6        6        /*T***********************************************************/
        7        7        /*X* plm=3 */
        8        8        /*P*  NAME: FUP$PMAP
        9        9              Purpose:
       10       10                    The portmapper routines.
       11       11        */
       12       12        /*F*  NAME: FUP$PMAP
       13       13              Purpose:
       14       14                    Does all of the work for portmapper requests.
       15       15        */
       16       16        /*D*  NAME: FUP$PMAP
       17       17              Inputs:
       18       18                    RQSCTX - contains the request, and any relevant data.
       19       19              Outputs:
       20       20                    RQSCTX - contains the results of the operations.
       21       21        */
       22       22
       23       23        FUP$PMAP: PROC( RQSCTX);
       24       24
       25       25        %INCLUDE FU_NFSSUBS_C;
       26      120        %INCLUDE FU_NFS_M;
       27      635        %INCLUDE XSL_PERR_C;
       28      690        %INCLUDE XSL_SOCKET_E;
       29      948        %INCLUDE XSL_SOCKET_M;
       30     1696
       31     1697        %FU$RQSCTX( NAME=RQSCTX, STCLASS=PARAM);
       32     1786
       33     1787    1   DCL FU_PMAPSOCKET SBIN SYMREF;
       34     1788    1   DCL FU_PORTNUM(0:0) UBIN SYMREF;
       35     1789    1   DCL FU_PROGNAME(0:0) UBIN SYMREF;
       36     1790    1   DCL FU_PROGVERS(0:0) UBIN SYMREF;
       37     1791
PL6.E3A0      #001=FUP$PMAP File=FUP$PMAP.:FUA2TSI                               FRI 11/21/97 11:34 Page:2    
       38     1792    1   DCL XSL$HTONL ENTRY(2);
       39     1793    1   DCL XSL$QCLOSE ENTRY(2) ALTRET;
       40     1794    1   DCL XSL$QSENDTO ENTRY(7) ALTRET;
       41     1795
       42     1796    1   DCL CONSTRQS(0:9) CONSTANT UBIN INIT(%BITBIN('4003002001'O), %TYPE_CALL,
       43     1797    1     %VERS_RPC, %(PROG_PMAP+PROG_SPREAD), %VERS_PMAP, %PMAPPROC_UNSET,
       44     1798    1     %AUTH_NULL, 0, %AUTH_NULL, 0);   /* constant init value for RQSCTX.CALLHDR  */
       45     1799
       46     1800    1   DCL FUP_RQSSTT STATIC SYMDEF UBIN INIT(0);
       47     1801    1   DCL LCL_ADDR UBIN STATIC;
       48     1802
       49     1803    1   DCL MAP$ PTR;
       50     1804    1   DCL 1 MAP BASED( MAP$) ALIGNED,
       51     1805    1         2 PROG# UBIN,
       52     1806    1         2 VERS# UBIN,
       53     1807    1         2 PROT# UBIN,
       54     1808    1         2 PORT# UBIN;
       55     1809
       56     1810    1   DCL I UBIN;
       57     1811
       58     1812        %EJECT;
PL6.E3A0      #001=FUP$PMAP File=FUP$PMAP.:FUA2TSI                               FRI 11/21/97 11:34 Page:3    
       59     1813    1   FUP$PMAPINIT: ENTRY( RQSCTX);      /* Send the first/next request (UNSET NFS) */
       60     1814    1      LCL_ADDR = RQSCTX.FROMADDR.S_ADDR;
       61     1815    1      GOTO NXTRQS;
       62     1816    1   FUP$PMAPRQS: ENTRY( RQSCTX);
       63     1817    2      DO CASE( RQSCTX.PROC#);
       64     1818
       65     1819    2       CASE( 0);                 /* Must be a reply or timeout in client mode    */
       66     1820    2         IF RQSCTX.CALLHDR.XID ~= CONSTRQS( 0) + FUP_RQSSTT - 1
       67     1821    2           OR RQSCTX.LEN = 0          /* timeout - resend the previous message   */
       68     1822    2         THEN FUP_RQSSTT = FUP_RQSSTT - 1;
       69     1823    3         IF RQSCTX.CALLHDR.TYPE ~= %TYPE_REPLY THEN DO;
       70     1824    3            RQSCTX.LEN = 0;                /* ignore it                          */
       71     1825    3            RETURN;
       72     1826    3            END;
       73     1827    3         IF FUP_RQSSTT = 4 THEN DO;        /* All done                           */
       74     1828    3            RQSCTX.LEN = 0;
       75     1829    3            CALL XSL$QCLOSE( I, FU_PMAPSOCKET);
       76     1830    3            FU_PMAPSOCKET = -FU_PMAPSOCKET;
       77     1831    3            FUP_RQSSTT = 0;
       78     1832    3            RETURN;
       79     1833    3            END;
       80     1834    2   NXTRQS: ;
       81     1835    2         RQSCTX.CALLHDR = CONSTRQS;
       82     1836    2         RQSCTX.CALLHDR.XID = RQSCTX.CALLHDR.XID + FUP_RQSSTT;
       83     1837    2         IF MOD( FUP_RQSSTT, 2) ~= 0
       84     1838    2         THEN RQSCTX.CALLHDR.PROC# = %PMAPPROC_SET;
       85     1839    2         I = FUP_RQSSTT/2;                 /* choose NFS or MOUNT socket         */
       86     1840    2         MAP$ = ADDR( RQSCTX.CALLHDR.AUTH_VERF);
       87     1841    2         MAP.PROG# = FU_PROGNAME( I);
       88     1842    2         MAP.VERS# = FU_PROGVERS( I);
       89     1843    2         CALL XSL$HTONL( MAP.PORT#, FU_PORTNUM( I));
       90     1844    2         MAP.PROT# = %IPPROTO_UDP;
       91     1845    2         RQSCTX.FROMADDR.S_PORT = %PORT_PMAP;
       92     1846    2         RQSCTX.FROMADDR.S_ADDR = LCL_ADDR;
       93     1847    2         RQSCTX.FROMADDR.SA_FAMILY = %XSL_AF_INET;
       94     1848    2         RQSCTX.LEN = SIZEC( RQSCTX.CALLHDR) - SIZEC( RQSCTX.CALLHDR.AUTH_VERF) +
       95     1849    2           SIZEC( MAP);
PL6.E3A0      #001=FUP$PMAP File=FUP$PMAP.:FUA2TSI                               FRI 11/21/97 11:34 Page:4    
       96     1850    2         FUP_RQSSTT = FUP_RQSSTT + 1;
       97     1851    2         GOTO OK3;
       98     1852
       99     1853    2       CASE( %PMAPPROC_GETPORT);
      100     1854    2         IF RQSCTX.LEN < 12 /* lengthc(MAP.PROG & VERS & PROT) */ THEN GOTO BAD;
      101     1855    2         MAP$ = RQSCTX.BODY$;
      102     1856    3         DO I = 0 TO 2;
      103     1857    3            IF MAP.PROG# = FU_PROGNAME( I)
      104     1858    3              AND MAP.VERS# = FU_PROGVERS( I)
      105     1859    4              AND MAP.PROT# = %IPPROTO_UDP THEN DO;
      106     1860    4               CALL XSL$HTONL( RQSCTX.REPLYHDR.NA_RESULT0, FU_PORTNUM( I));
      107     1861    4               GOTO OK;
      108     1862    4               END;
      109     1863    3            END;
      110     1864    2         GOTO BAD;
      111     1865
      112     1866    2       CASE( %PMAPPROC_DUMP);
      113     1867    3         DO I = 0 TO 2;
      114     1868    3            MAP$ = ADDR( RQSCTX.REPLYHDR.NA_RESULTS( I*5+1));
      115     1869    3            RQSCTX.REPLYHDR.NA_RESULTS( I*5) = 1;
      116     1870    3            MAP.PROG# = FU_PROGNAME( I);
      117     1871    3            MAP.VERS# = FU_PROGVERS( I);
      118     1872    3            CALL XSL$HTONL( MAP.PORT#, FU_PORTNUM( I));
      119     1873    3            MAP.PROT# = %IPPROTO_UDP;
      120     1874    3            END;
      121     1875    2         RQSCTX.REPLYHDR.NA_RESULTS( I*5) = 0; /* Terminate the list             */
      122     1876    2         RQSCTX.LEN = 24 /* sizec(RQSCTX.REPLYHDR) before NA_RESULTS */ +64;
      123     1877    2         GOTO OK2;
      124     1878
      125     1879    2       CASE( ELSE);
      126     1880    2   BAD:  RQSCTX.REPLYHDR.NA_RESULT0 = 0; /* Boolean false - we dont do SET/UNSET */
      127     1881    2   OK:   RQSCTX.LEN = 24+4;
      128     1882    2   OK2:  RQSCTX.REPLYHDR.AUTH_VERF_FLAVOR = %AUTH_NULL;
      129     1883    2         RQSCTX.REPLYHDR.AUTH_VERF_LEN = 0;
      130     1884    2         RQSCTX.REPLYHDR.NA_ACCEPT_STAT = %SUCCESS;
      131     1885    2   OK3:  CALL XSL$QSENDTO( RQSCTX.LEN, FU_PMAPSOCKET, RQSCTX.REPLYHDR, RQSCTX.LEN,
      132     1886    2           0, RQSCTX.FROMADDR, 8);
PL6.E3A0      #001=FUP$PMAP File=FUP$PMAP.:FUA2TSI                               FRI 11/21/97 11:34 Page:5    
      133     1887    2         RETURN;
      134     1888
      135     1889    2       CASE( %PMAPPROC_CALLIT);
      136     1890              /* this needs a bit of work - save the return address and XID in context,
      137     1891                 replace XID with something to get back to the context,
      138     1892                 forward the message to the local port, and await a response */
      139     1893    2         GOTO BAD;
      140     1894
      141     1895    2       END;
      142     1896    1   END FUP$PMAP;

PL6.E3A0      #001=FUP$PMAP File=FUP$PMAP.:FUA2TSI                               FRI 11/21/97 11:34 Page:6    
--  Include file information  --

   XSL_SOCKET_M.:LIBRARY  is referenced.
   XSL_SOCKET_E.:LIBRARY  is referenced.
   XSL_PERR_C.:LIBRARY  is referenced.
   FU_NFS_M.:FUA2TOU  is referenced.
   FU_NFSSUBS_C.:FUA2TOU  is referenced.
   B$JIT_C.:E05TOU  was found in the system file and is never referenced.
   CP_6_C.:E05TOU  was found in the system file and is never referenced.
      No diagnostics issued in procedure FUP$PMAP.

   Procedure FUP$PMAP requires 210 words for executable code.
   Procedure FUP$PMAP requires 14 words of local(AUTO) storage.

    No errors detected in file FUP$PMAP.:FUA2TSI    .

PL6.E3A0      #001=FUP$PMAP File=FUP$PMAP.:FUA2TSI                               FRI 11/21/97 11:34 Page:7    

 Object Unit name= FUP$PMAP                                   File name= FUP$PMAP.:FUA2TOU
 UTS= NOV 21 '97 11:34:54.96 FRI                              Compiler= PL-6/E31         Sev=      00
 SharedLib= :SHARED_SYSTEM                                    Alt SharedLib=


    ****  Control sections  ****

 Sect   Type Bound  Init  Size OctSiz  Section name(segment info)
    0  RoData even  UTS     10     12  FUP$PMAP
    1   Data  even  none     2      2  FUP$PMAP
    2   Proc  even  none   210    322  FUP$PMAP
    3  RoData even  none     3      3  FUP$PMAP

    ****  Entry defs  ****

                              Check   Calling
                             calling  sequence
  Sect OctLoc Primary Altret sequence   type   Parms  Name
     2      0   yes            yes      Std        1  FUP$PMAP
     2      3                  yes      Std        1  FUP$PMAPINIT
     2     11                  yes      Std        1  FUP$PMAPRQS

  ****  Data defs  ****

 Sect OctLoc  Name                           Sect OctLoc  Name
    1      0  FUP_RQSSTT
PL6.E3A0      #001=FUP$PMAP File=FUP$PMAP.:FUA2TSI                               FRI 11/21/97 11:34 Page:8    

  ****  Entry refs  ****

         Check        Calling
        calling       sequence
Altret sequence SRef   type   Args  Name
 yes     yes           Std       2 XSL$QCLOSE
         yes           Std       2 XSL$HTONL
 yes     yes           Std       7 XSL$QSENDTO
                       nStd      0 X66_AUTO_1
                       nStd      0 X66_ARET
                       Std       0 B_CONSPOOL_D

  ****  Data refs  ****

  Flags:  r = read only, s = secondary
Flgs Name                             Flgs Name                             Flgs Name
     FU_PMAPSOCKET                         FU_PORTNUM                            FU_PROGNAME
     FU_PROGVERS                           B_VECTNIL

  ****  Segment refs  ****

  Flags:  r = read only, s = secondary
Flgs Name                             Flgs Name                             Flgs Name
     ISSID
PL6.E3A0      #001=FUP$PMAP File=FUP$PMAP.:FUA2TSI                               FRI 11/21/97 11:34 Page:9    


        1        1        /*M* Portmapper code - either client or server. */
        2        2        /*T***********************************************************/
        3        3        /*T*                                                         */
        4        4        /*T* Copyright (c) Bull HN Information Systems Inc., 1997    */
        5        5        /*T*                                                         */
        6        6        /*T***********************************************************/
        7        7        /*X* plm=3 */
        8        8        /*P*  NAME: FUP$PMAP
        9        9              Purpose:
       10       10                    The portmapper routines.
       11       11        */
       12       12        /*F*  NAME: FUP$PMAP
       13       13              Purpose:
       14       14                    Does all of the work for portmapper requests.
       15       15        */
       16       16        /*D*  NAME: FUP$PMAP
       17       17              Inputs:
       18       18                    RQSCTX - contains the request, and any relevant data.
       19       19              Outputs:
       20       20                    RQSCTX - contains the results of the operations.
       21       21        */
       22       22
       23       23        FUP$PMAP: PROC( RQSCTX);

     23  2 000000   000000 700200 xent  FUP$PMAP     TSX0  ! X66_AUTO_1
         2 000001   000016 000001                    ZERO    14,1
         2 000002   000005 710000 2                  TRA     s:1814

       24       24
       25       25        %INCLUDE FU_NFSSUBS_C;
       26      120        %INCLUDE FU_NFS_M;
       27      635        %INCLUDE XSL_PERR_C;
       28      690        %INCLUDE XSL_SOCKET_E;
       29      948        %INCLUDE XSL_SOCKET_M;
       30     1696
       31     1697        %FU$RQSCTX( NAME=RQSCTX, STCLASS=PARAM);
PL6.E3A0      #001=FUP$PMAP File=FUP$PMAP.:FUA2TSI                               FRI 11/21/97 11:34 Page:10   
       32     1786
       33     1787    1   DCL FU_PMAPSOCKET SBIN SYMREF;
       34     1788    1   DCL FU_PORTNUM(0:0) UBIN SYMREF;
       35     1789    1   DCL FU_PROGNAME(0:0) UBIN SYMREF;
       36     1790    1   DCL FU_PROGVERS(0:0) UBIN SYMREF;
       37     1791
       38     1792    1   DCL XSL$HTONL ENTRY(2);
       39     1793    1   DCL XSL$QCLOSE ENTRY(2) ALTRET;
       40     1794    1   DCL XSL$QSENDTO ENTRY(7) ALTRET;
       41     1795
       42     1796    1   DCL CONSTRQS(0:9) CONSTANT UBIN INIT(%BITBIN('4003002001'O), %TYPE_CALL,
       43     1797    1     %VERS_RPC, %(PROG_PMAP+PROG_SPREAD), %VERS_PMAP, %PMAPPROC_UNSET,
       44     1798    1     %AUTH_NULL, 0, %AUTH_NULL, 0);   /* constant init value for RQSCTX.CALLHDR  */
       45     1799
       46     1800    1   DCL FUP_RQSSTT STATIC SYMDEF UBIN INIT(0);
       47     1801    1   DCL LCL_ADDR UBIN STATIC;
       48     1802
       49     1803    1   DCL MAP$ PTR;
       50     1804    1   DCL 1 MAP BASED( MAP$) ALIGNED,
       51     1805    1         2 PROG# UBIN,
       52     1806    1         2 VERS# UBIN,
       53     1807    1         2 PROT# UBIN,
       54     1808    1         2 PORT# UBIN;
       55     1809
       56     1810    1   DCL I UBIN;
       57     1811
       58     1812        %EJECT;
PL6.E3A0      #001=FUP$PMAP File=FUP$PMAP.:FUA2TSI                               FRI 11/21/97 11:34 Page:11   
       59     1813    1   FUP$PMAPINIT: ENTRY( RQSCTX);      /* Send the first/next request (UNSET NFS) */

   1813  2 000003   000000 700200 xent  FUP$PMAPINIT TSX0  ! X66_AUTO_1
         2 000004   000016 000001                    ZERO    14,1

       60     1814    1      LCL_ADDR = RQSCTX.FROMADDR.S_ADDR;

   1814  2 000005   200003 470500                    LDP0    @RQSCTX,,AUTO
         2 000006   000010 235100                    LDA     8,,PR0
         2 000007   000001 755000 1                  STA     LCL_ADDR

       61     1815    1      GOTO NXTRQS;

   1815  2 000010   000066 710000 2                  TRA     NXTRQS

       62     1816    1   FUP$PMAPRQS: ENTRY( RQSCTX);

   1816  2 000011   000000 700200 xent  FUP$PMAPRQS  TSX0  ! X66_AUTO_1
         2 000012   000016 000001                    ZERO    14,1

       63     1817    2      DO CASE( RQSCTX.PROC#);

   1817  2 000013   200003 470500                    LDP0    @RQSCTX,,AUTO
         2 000014   000005 235100                    LDA     5,,PR0
         2 000015   000006 115007                    CMPA    6,DL
         2 000016   000020 602005 2                  TNC     s:1817+5,AL
         2 000017   000262 710000 2                  TRA     BAD
         2 000020   000026 710000 2                  TRA     s:1820
         2 000021   000262 710000 2                  TRA     BAD
         2 000022   000262 710000 2                  TRA     BAD
         2 000023   000147 710000 2                  TRA     s:1854
         2 000024   000210 710000 2                  TRA     s:1867
         2 000025   000321 710000 2                  TRA     s:1893

       64     1818
       65     1819    2       CASE( 0);                 /* Must be a reply or timeout in client mode    */

PL6.E3A0      #001=FUP$PMAP File=FUP$PMAP.:FUA2TSI                               FRI 11/21/97 11:34 Page:12   
       66     1820    2         IF RQSCTX.CALLHDR.XID ~= CONSTRQS( 0) + FUP_RQSSTT - 1

   1820  2 000026   000000 236000 0                  LDQ     CONSTRQS
         2 000027   000000 036000 1                  ADLQ    FUP_RQSSTT
         2 000030   000001 136007                    SBLQ    1,DL
         2 000031   000036 604000 2                  TMI     s:1822
         2 000032   000013 116100                    CMPQ    11,,PR0
         2 000033   000036 601000 2                  TNZ     s:1822
         2 000034   000002 235100                    LDA     2,,PR0
         2 000035   000041 601000 2                  TNZ     s:1823

       67     1821    2           OR RQSCTX.LEN = 0          /* timeout - resend the previous message   */
       68     1822    2         THEN FUP_RQSSTT = FUP_RQSSTT - 1;

   1822  2 000036   000000 235000 1                  LDA     FUP_RQSSTT
         2 000037   000001 135007                    SBLA    1,DL
         2 000040   000000 755000 1                  STA     FUP_RQSSTT

       69     1823    3         IF RQSCTX.CALLHDR.TYPE ~= %TYPE_REPLY THEN DO;

   1823  2 000041   000014 235100                    LDA     12,,PR0
         2 000042   000001 115007                    CMPA    1,DL
         2 000043   000046 600000 2                  TZE     s:1827

       70     1824    3            RQSCTX.LEN = 0;                /* ignore it                          */

   1824  2 000044   000002 450100                    STZ     2,,PR0

       71     1825    3            RETURN;

   1825  2 000045   000000 702200 xent               TSX2  ! X66_ARET

       72     1826    3            END;
       73     1827    3         IF FUP_RQSSTT = 4 THEN DO;        /* All done                           */

   1827  2 000046   000000 236000 1                  LDQ     FUP_RQSSTT
         2 000047   000004 116007                    CMPQ    4,DL
PL6.E3A0      #001=FUP$PMAP File=FUP$PMAP.:FUA2TSI                               FRI 11/21/97 11:34 Page:13   
         2 000050   000066 601000 2                  TNZ     NXTRQS

       74     1828    3            RQSCTX.LEN = 0;

   1828  2 000051   000002 450100                    STZ     2,,PR0

       75     1829    3            CALL XSL$QCLOSE( I, FU_PMAPSOCKET);

   1829  2 000052   000000 236000 3                  LDQ     0
         2 000053   200007 756100                    STQ     I+2,,AUTO
         2 000054   200005 631500                    EPPR1   I,,AUTO
         2 000055   200006 451500                    STP1    I+1,,AUTO
         2 000056   200006 630500                    EPPR0   I+1,,AUTO
         2 000057   000020 631400 xsym               EPPR1   B_VECTNIL+16
         2 000060   000000 701000 xent               TSX1    XSL$QCLOSE
         2 000061   000000 011000                    NOP     0

       76     1830    3            FU_PMAPSOCKET = -FU_PMAPSOCKET;

   1830  2 000062   000000 335000 xsym               LCA     FU_PMAPSOCKET
         2 000063   000000 755000 xsym               STA     FU_PMAPSOCKET

       77     1831    3            FUP_RQSSTT = 0;

   1831  2 000064   000000 450000 1                  STZ     FUP_RQSSTT

       78     1832    3            RETURN;

   1832  2 000065   000000 702200 xent               TSX2  ! X66_ARET

   1827  2 000066                       NXTRQS       null
       79     1833    3            END;
       80     1834    2   NXTRQS: ;
       81     1835    2         RQSCTX.CALLHDR = CONSTRQS;

   1835  2 000066   000100 100400                    MLR     fill='000'O
         2 000067   000000 000050 0                  ADSC9   CONSTRQS                 cn=0,n=40
PL6.E3A0      #001=FUP$PMAP File=FUP$PMAP.:FUA2TSI                               FRI 11/21/97 11:34 Page:14   
         2 000070   000013 000060                    ADSC9   11,,PR0                  cn=0,n=48

       82     1836    2         RQSCTX.CALLHDR.XID = RQSCTX.CALLHDR.XID + FUP_RQSSTT;

   1836  2 000071   000013 236100                    LDQ     11,,PR0
         2 000072   000000 036000 1                  ADLQ    FUP_RQSSTT
         2 000073   000013 756100                    STQ     11,,PR0

       83     1837    2         IF MOD( FUP_RQSSTT, 2) ~= 0

   1837  2 000074   000000 236000 1                  LDQ     FUP_RQSSTT
         2 000075   000001 376007                    ANQ     1,DL
         2 000076   000101 600000 2                  TZE     s:1839

       84     1838    2         THEN RQSCTX.CALLHDR.PROC# = %PMAPPROC_SET;

   1838  2 000077   000001 235007                    LDA     1,DL
         2 000100   000020 755100                    STA     16,,PR0

       85     1839    2         I = FUP_RQSSTT/2;                 /* choose NFS or MOUNT socket         */

   1839  2 000101   000000 236000 1                  LDQ     FUP_RQSSTT
         2 000102   000001 772000                    QRL     1
         2 000103   200005 756100                    STQ     I,,AUTO

       86     1840    2         MAP$ = ADDR( RQSCTX.CALLHDR.AUTH_VERF);

   1840  2 000104   200003 236100                    LDQ     @RQSCTX,,AUTO
         2 000105   000025 036003                    ADLQ    21,DU
         2 000106   200004 756100                    STQ     MAP$,,AUTO

       87     1841    2         MAP.PROG# = FU_PROGNAME( I);

   1841  2 000107   200005 720100                    LXL0    I,,AUTO
         2 000110   200004 471500                    LDP1    MAP$,,AUTO
         2 000111   000000 235010 xsym               LDA     FU_PROGNAME,X0
         2 000112   100000 755100                    STA     0,,PR1
PL6.E3A0      #001=FUP$PMAP File=FUP$PMAP.:FUA2TSI                               FRI 11/21/97 11:34 Page:15   

       88     1842    2         MAP.VERS# = FU_PROGVERS( I);

   1842  2 000113   200005 720100                    LXL0    I,,AUTO
         2 000114   000000 235010 xsym               LDA     FU_PROGVERS,X0
         2 000115   100001 755100                    STA     1,,PR1

       89     1843    2         CALL XSL$HTONL( MAP.PORT#, FU_PORTNUM( I));

   1843  2 000116   200005 720100                    LXL0    I,,AUTO
         2 000117   000000 633410 xsym               EPPR3   FU_PORTNUM,X0
         2 000120   200007 453500                    STP3    I+2,,AUTO
         2 000121   000003 036003                    ADLQ    3,DU
         2 000122   200006 756100                    STQ     I+1,,AUTO
         2 000123   200006 630500                    EPPR0   I+1,,AUTO
         2 000124   000020 631400 xsym               EPPR1   B_VECTNIL+16
         2 000125   000000 701000 xent               TSX1    XSL$HTONL
         2 000126   000000 011000                    NOP     0

       90     1844    2         MAP.PROT# = %IPPROTO_UDP;

   1844  2 000127   000021 235007                    LDA     17,DL
         2 000130   200004 470500                    LDP0    MAP$,,AUTO
         2 000131   000002 755100                    STA     2,,PR0

       91     1845    2         RQSCTX.FROMADDR.S_PORT = %PORT_PMAP;

   1845  2 000132   000157 236007                    LDQ     111,DL
         2 000133   200003 471500                    LDP1    @RQSCTX,,AUTO
         2 000134   100007 756100                    STQ     7,,PR1

       92     1846    2         RQSCTX.FROMADDR.S_ADDR = LCL_ADDR;

   1846  2 000135   000001 235000 1                  LDA     LCL_ADDR
         2 000136   100010 755100                    STA     8,,PR1

       93     1847    2         RQSCTX.FROMADDR.SA_FAMILY = %XSL_AF_INET;
PL6.E3A0      #001=FUP$PMAP File=FUP$PMAP.:FUA2TSI                               FRI 11/21/97 11:34 Page:16   

   1847  2 000137   000002 235007                    LDA     2,DL
         2 000140   100006 755100                    STA     6,,PR1

       94     1848    2         RQSCTX.LEN = SIZEC( RQSCTX.CALLHDR) - SIZEC( RQSCTX.CALLHDR.AUTH_VERF) +

   1848  2 000141   000070 235007                    LDA     56,DL
         2 000142   100002 755100                    STA     2,,PR1

       95     1849    2           SIZEC( MAP);
       96     1850    2         FUP_RQSSTT = FUP_RQSSTT + 1;

   1850  2 000143   000000 235000 1                  LDA     FUP_RQSSTT
         2 000144   000001 035007                    ADLA    1,DL
         2 000145   000000 755000 1                  STA     FUP_RQSSTT

       97     1851    2         GOTO OK3;

   1851  2 000146   000273 710000 2                  TRA     OK3

       98     1852
       99     1853    2       CASE( %PMAPPROC_GETPORT);

      100     1854    2         IF RQSCTX.LEN < 12 /* lengthc(MAP.PROG & VERS & PROT) */ THEN GOTO BAD;

   1854  2 000147   000002 235100                    LDA     2,,PR0
         2 000150   000014 115007                    CMPA    12,DL
         2 000151   000262 602000 2                  TNC     BAD

      101     1855    2         MAP$ = RQSCTX.BODY$;

   1855  2 000152   000003 236100                    LDQ     3,,PR0
         2 000153   200004 756100                    STQ     MAP$,,AUTO

      102     1856    3         DO I = 0 TO 2;

   1856  2 000154   200005 450100                    STZ     I,,AUTO
PL6.E3A0      #001=FUP$PMAP File=FUP$PMAP.:FUA2TSI                               FRI 11/21/97 11:34 Page:17   

      103     1857    3            IF MAP.PROG# = FU_PROGNAME( I)

   1857  2 000155   200004 470500                    LDP0    MAP$,,AUTO
         2 000156   200005 720100                    LXL0    I,,AUTO
         2 000157   000000 236100                    LDQ     0,,PR0
         2 000160   000000 116010 xsym               CMPQ    FU_PROGNAME,X0
         2 000161   000202 601000 2                  TNZ     s:1863
         2 000162   000001 236100                    LDQ     1,,PR0
         2 000163   000000 116010 xsym               CMPQ    FU_PROGVERS,X0
         2 000164   000202 601000 2                  TNZ     s:1863
         2 000165   000002 235100                    LDA     2,,PR0
         2 000166   000021 115007                    CMPA    17,DL
         2 000167   000202 601000 2                  TNZ     s:1863

      104     1858    3              AND MAP.VERS# = FU_PROGVERS( I)
      105     1859    4              AND MAP.PROT# = %IPPROTO_UDP THEN DO;

      106     1860    4               CALL XSL$HTONL( RQSCTX.REPLYHDR.NA_RESULT0, FU_PORTNUM( I));

   1860  2 000170   000000 631410 xsym               EPPR1   FU_PORTNUM,X0
         2 000171   200007 451500                    STP1    I+2,,AUTO
         2 000172   200003 236100                    LDQ     @RQSCTX,,AUTO
         2 000173   000021 036003                    ADLQ    17,DU
         2 000174   200006 756100                    STQ     I+1,,AUTO
         2 000175   200006 630500                    EPPR0   I+1,,AUTO
         2 000176   000020 631400 xsym               EPPR1   B_VECTNIL+16
         2 000177   000000 701000 xent               TSX1    XSL$HTONL
         2 000200   000000 011000                    NOP     0

      107     1861    4               GOTO OK;

   1861  2 000201   000264 710000 2                  TRA     OK

      108     1862    4               END;
      109     1863    3            END;

PL6.E3A0      #001=FUP$PMAP File=FUP$PMAP.:FUA2TSI                               FRI 11/21/97 11:34 Page:18   
   1863  2 000202   200005 235100                    LDA     I,,AUTO
         2 000203   000001 035007                    ADLA    1,DL
         2 000204   200005 755100                    STA     I,,AUTO
         2 000205   000003 115007                    CMPA    3,DL
         2 000206   000155 602000 2                  TNC     s:1857

      110     1864    2         GOTO BAD;

   1864  2 000207   000262 710000 2                  TRA     BAD

      111     1865
      112     1866    2       CASE( %PMAPPROC_DUMP);

      113     1867    3         DO I = 0 TO 2;

   1867  2 000210   200005 450100                    STZ     I,,AUTO

      114     1868    3            MAP$ = ADDR( RQSCTX.REPLYHDR.NA_RESULTS( I*5+1));

   1868  2 000211   200005 236100                    LDQ     I,,AUTO
         2 000212   000005 402003                    MPY     5,DU
         2 000213   000022 036003                    ADLQ    18,DU
         2 000214   200003 036100                    ADLQ    @RQSCTX,,AUTO
         2 000215   200004 756100                    STQ     MAP$,,AUTO

      115     1869    3            RQSCTX.REPLYHDR.NA_RESULTS( I*5) = 1;

   1869  2 000216   200005 236100                    LDQ     I,,AUTO
         2 000217   000005 402007                    MPY     5,DL
         2 000220   000001 235007                    LDA     1,DL
         2 000221   200003 470500                    LDP0    @RQSCTX,,AUTO
         2 000222   000021 755106                    STA     17,QL,PR0

      116     1870    3            MAP.PROG# = FU_PROGNAME( I);

   1870  2 000223   200005 720100                    LXL0    I,,AUTO
         2 000224   200004 471500                    LDP1    MAP$,,AUTO
PL6.E3A0      #001=FUP$PMAP File=FUP$PMAP.:FUA2TSI                               FRI 11/21/97 11:34 Page:19   
         2 000225   000000 235010 xsym               LDA     FU_PROGNAME,X0
         2 000226   100000 755100                    STA     0,,PR1

      117     1871    3            MAP.VERS# = FU_PROGVERS( I);

   1871  2 000227   200005 720100                    LXL0    I,,AUTO
         2 000230   000000 235010 xsym               LDA     FU_PROGVERS,X0
         2 000231   100001 755100                    STA     1,,PR1

      118     1872    3            CALL XSL$HTONL( MAP.PORT#, FU_PORTNUM( I));

   1872  2 000232   200005 720100                    LXL0    I,,AUTO
         2 000233   000000 633410 xsym               EPPR3   FU_PORTNUM,X0
         2 000234   200007 453500                    STP3    I+2,,AUTO
         2 000235   200004 236100                    LDQ     MAP$,,AUTO
         2 000236   000003 036003                    ADLQ    3,DU
         2 000237   200006 756100                    STQ     I+1,,AUTO
         2 000240   200006 630500                    EPPR0   I+1,,AUTO
         2 000241   000020 631400 xsym               EPPR1   B_VECTNIL+16
         2 000242   000000 701000 xent               TSX1    XSL$HTONL
         2 000243   000000 011000                    NOP     0

      119     1873    3            MAP.PROT# = %IPPROTO_UDP;

   1873  2 000244   000021 235007                    LDA     17,DL
         2 000245   200004 470500                    LDP0    MAP$,,AUTO
         2 000246   000002 755100                    STA     2,,PR0

      120     1874    3            END;

   1874  2 000247   200005 236100                    LDQ     I,,AUTO
         2 000250   000001 036007                    ADLQ    1,DL
         2 000251   200005 756100                    STQ     I,,AUTO
         2 000252   000003 116007                    CMPQ    3,DL
         2 000253   000211 602000 2                  TNC     s:1868

      121     1875    2         RQSCTX.REPLYHDR.NA_RESULTS( I*5) = 0; /* Terminate the list             */
PL6.E3A0      #001=FUP$PMAP File=FUP$PMAP.:FUA2TSI                               FRI 11/21/97 11:34 Page:20   

   1875  2 000254   000005 402007                    MPY     5,DL
         2 000255   200003 471500                    LDP1    @RQSCTX,,AUTO
         2 000256   100021 450106                    STZ     17,QL,PR1

      122     1876    2         RQSCTX.LEN = 24 /* sizec(RQSCTX.REPLYHDR) before NA_RESULTS */ +64;

   1876  2 000257   000130 235007                    LDA     88,DL
         2 000260   100002 755100                    STA     2,,PR1

      123     1877    2         GOTO OK2;

   1877  2 000261   000267 710000 2                  TRA     OK2

      124     1878
      125     1879    2       CASE( ELSE);

      126     1880    2   BAD:  RQSCTX.REPLYHDR.NA_RESULT0 = 0; /* Boolean false - we dont do SET/UNSET */

   1880  2 000262   200003 470500       BAD          LDP0    @RQSCTX,,AUTO
         2 000263   000021 450100                    STZ     17,,PR0

      127     1881    2   OK:   RQSCTX.LEN = 24+4;

   1881  2 000264   000034 235007       OK           LDA     28,DL
         2 000265   200003 470500                    LDP0    @RQSCTX,,AUTO
         2 000266   000002 755100                    STA     2,,PR0

      128     1882    2   OK2:  RQSCTX.REPLYHDR.AUTH_VERF_FLAVOR = %AUTH_NULL;

   1882  2 000267   200003 470500       OK2          LDP0    @RQSCTX,,AUTO
         2 000270   000016 450100                    STZ     14,,PR0

      129     1883    2         RQSCTX.REPLYHDR.AUTH_VERF_LEN = 0;

   1883  2 000271   000017 450100                    STZ     15,,PR0

PL6.E3A0      #001=FUP$PMAP File=FUP$PMAP.:FUA2TSI                               FRI 11/21/97 11:34 Page:21   
      130     1884    2         RQSCTX.REPLYHDR.NA_ACCEPT_STAT = %SUCCESS;

   1884  2 000272   000020 450100                    STZ     16,,PR0

      131     1885    2   OK3:  CALL XSL$QSENDTO( RQSCTX.LEN, FU_PMAPSOCKET, RQSCTX.REPLYHDR, RQSCTX.LEN,

   1885  2 000273   000001 236000 3     OK3          LDQ     1
         2 000274   200014 756100                    STQ     I+7,,AUTO
         2 000275   200003 236100                    LDQ     @RQSCTX,,AUTO
         2 000276   000006 036003                    ADLQ    6,DU
         2 000277   000002 235000 3                  LDA     2
         2 000300   200012 757100                    STAQ    I+5,,AUTO
         2 000301   200003 236100                    LDQ     @RQSCTX,,AUTO
         2 000302   000002 036003                    ADLQ    2,DU
         2 000303   200011 756100                    STQ     I+4,,AUTO
         2 000304   200003 236100                    LDQ     @RQSCTX,,AUTO
         2 000305   000013 036003                    ADLQ    11,DU
         2 000306   200010 756100                    STQ     I+3,,AUTO
         2 000307   000000 236000 3                  LDQ     0
         2 000310   200007 756100                    STQ     I+2,,AUTO
         2 000311   200003 236100                    LDQ     @RQSCTX,,AUTO
         2 000312   000002 036003                    ADLQ    2,DU
         2 000313   200006 756100                    STQ     I+1,,AUTO
         2 000314   200006 630500                    EPPR0   I+1,,AUTO
         2 000315   000025 631400 xsym               EPPR1   B_VECTNIL+21
         2 000316   000000 701000 xent               TSX1    XSL$QSENDTO
         2 000317   000000 011000                    NOP     0

      132     1886    2           0, RQSCTX.FROMADDR, 8);
      133     1887    2         RETURN;

   1887  2 000320   000000 702200 xent               TSX2  ! X66_ARET

      134     1888
      135     1889    2       CASE( %PMAPPROC_CALLIT);

      136     1890              /* this needs a bit of work - save the return address and XID in context,
PL6.E3A0      #001=FUP$PMAP File=FUP$PMAP.:FUA2TSI                               FRI 11/21/97 11:34 Page:22   
      137     1891                 replace XID with something to get back to the context,
      138     1892                 forward the message to the local port, and await a response */
      139     1893    2         GOTO BAD;

   1893  2 000321   000262 710000 2                  TRA     BAD
      140     1894
      141     1895    2       END;
      142     1896    1   END FUP$PMAP;

PL6.E3A0      #001=FUP$PMAP File=FUP$PMAP.:FUA2TSI                               FRI 11/21/97 11:34 Page:23   
--  Include file information  --

   XSL_SOCKET_M.:LIBRARY  is referenced.
   XSL_SOCKET_E.:LIBRARY  is referenced.
   XSL_PERR_C.:LIBRARY  is referenced.
   FU_NFS_M.:FUA2TOU  is referenced.
   FU_NFSSUBS_C.:FUA2TOU  is referenced.
   B$JIT_C.:E05TOU  was found in the system file and is never referenced.
   CP_6_C.:E05TOU  was found in the system file and is never referenced.
      No diagnostics issued in procedure FUP$PMAP.
PL6.E3A0      #001=FUP$PMAP File=FUP$PMAP.:FUA2TSI                               FRI 11/21/97 11:34 Page:24   

 **** Variables and constants ****

  ****  Section 000 RoData FUP$PMAP

  ****  Scalars and arrays  ****
OctLoc.c.b A Datatyp(siz) R M Lvl/name                 OctLoc.c.b A Datatyp(siz) R M Lvl/name

     0-0-0/w UBIN        r     1 CONSTRQS(0:9)

  ****  Section 001  Data  FUP$PMAP

  ****  Scalars and arrays  ****
OctLoc.c.b A Datatyp(siz) R M Lvl/name                 OctLoc.c.b A Datatyp(siz) R M Lvl/name

     0-0-0/w UBIN        r     1 FUP_RQSSTT                 1-0-0/w UBIN        r     1 LCL_ADDR

  ****  Auto variables  ****

  ****  Scalars and arrays  ****
OctLoc.c.b A Datatyp(siz) R M Lvl/name                 OctLoc.c.b A Datatyp(siz) R M Lvl/name

     3-0-0/w PTR         r     1 @RQSCTX                    5-0-0/w UBIN        r     1 I
     4-0-0/w PTR         r     1 MAP$                      *0-0-0/w STRC(74556) r     1 RQSCTX

  ****  SYMREF variables  ****

  ****  Scalars and arrays  ****
OctLoc.c.b A Datatyp(siz) R M Lvl/name                 OctLoc.c.b A Datatyp(siz) R M Lvl/name

     0-0-0/w SBIN        r     1 FU_PMAPSOCKET
     0-0-0/w UBIN        r     1 FU_PORTNUM(0:0)
     0-0-0/w UBIN        r     1 FU_PROGNAME(0:0)
     0-0-0/w UBIN        r     1 FU_PROGVERS(0:0)

  ****  BASED and DCB variables  ****

  ****  Scalars and arrays  ****
PL6.E3A0      #001=FUP$PMAP File=FUP$PMAP.:FUA2TSI                               FRI 11/21/97 11:34 Page:25   
OctLoc.c.b A Datatyp(siz) R M Lvl/name                 OctLoc.c.b A Datatyp(siz) R M Lvl/name

     0-0-0/w STRC(144)   r     1 MAP


   Procedure FUP$PMAP requires 210 words for executable code.
   Procedure FUP$PMAP requires 14 words of local(AUTO) storage.

    No errors detected in file FUP$PMAP.:FUA2TSI    .
PL6.E3A0      #001=FUP$PMAP File=FUP$PMAP.:FUA2TSI                               FRI 11/21/97 11:34 Page:26   
          *** CROSS REFERENCE LISTING ***
**     DENOTES     IDENTIFIER DEFINITION
<<                 IDENTIFIER'S VALUE SET
>>                 IDENTIFIER'S VALUE USED
<>                 IDENTIFIER SET AND/OR USED
--                 IDENTIFIER REFERENCED
PL6.E3A0      #001=FUP$PMAP File=FUP$PMAP.:FUA2TSI                               FRI 11/21/97 11:34 Page:27   
          MINI XREF LISTING

BAD
      1880**LABEL    1854--GOTO     1864--GOTO     1893--GOTO
CONSTRQS
      1796**DCL      1820>>IF       1835>>ASSIGN
FUP_RQSSTT
      1800**DCL      1820>>IF       1822<<ASSIGN   1822>>ASSIGN   1827>>IF       1831<<ASSIGN   1836>>ASSIGN
      1837>>IF       1839>>ASSIGN   1850<<ASSIGN   1850>>ASSIGN
FU_PMAPSOCKET
      1787**DCL      1829<>CALL     1830<<ASSIGN   1830>>ASSIGN   1885<>CALL
FU_PORTNUM
      1788**DCL      1843<>CALL     1860<>CALL     1872<>CALL
FU_PROGNAME
      1789**DCL      1841>>ASSIGN   1857>>IF       1870>>ASSIGN
FU_PROGVERS
      1790**DCL      1842>>ASSIGN   1857>>IF       1871>>ASSIGN
I
      1810**DCL      1829<>CALL     1839<<ASSIGN   1841>>ASSIGN   1842>>ASSIGN   1843>>CALL     1856<<DOINDEX
      1857>>IF       1857>>IF       1860>>CALL     1867<<DOINDEX  1868>>ASSIGN   1869>>ASSIGN   1870>>ASSIGN
      1871>>ASSIGN   1872>>CALL     1875>>ASSIGN
LCL_ADDR
      1801**DCL      1814<<ASSIGN   1846>>ASSIGN
MAP
      1804**DCL      1848--ASSIGN
MAP.PORT#
      1808**DCL      1843<>CALL     1872<>CALL
MAP.PROG#
      1805**DCL      1841<<ASSIGN   1857>>IF       1870<<ASSIGN
MAP.PROT#
      1807**DCL      1844<<ASSIGN   1857>>IF       1873<<ASSIGN
MAP.VERS#
      1806**DCL      1842<<ASSIGN   1857>>IF       1871<<ASSIGN
MAP$
PL6.E3A0      #001=FUP$PMAP File=FUP$PMAP.:FUA2TSI                               FRI 11/21/97 11:34 Page:28   
      1803**DCL      1804--IMP-PTR  1840<<ASSIGN   1841>>ASSIGN   1842>>ASSIGN   1843>>CALL     1844>>ASSIGN
      1855<<ASSIGN   1857>>IF       1857>>IF       1857>>IF       1868<<ASSIGN   1870>>ASSIGN   1871>>ASSIGN
      1872>>CALL     1873>>ASSIGN
NXTRQS
      1827**LABEL    1815--GOTO
OK
      1881**LABEL    1861--GOTO
OK2
      1882**LABEL    1877--GOTO
OK3
      1885**LABEL    1851--GOTO
RQSCTX
      1711**DCL        23--PROC     1813--ENTRY    1816--ENTRY
RQSCTX.BODY$
      1715**DCL      1855>>ASSIGN
RQSCTX.CALLHDR
      1772**DCL      1777--REDEF    1835<<ASSIGN   1848--ASSIGN
RQSCTX.CALLHDR.AUTH_CRED
      1774**DCL      1776--REDEF
RQSCTX.CALLHDR.AUTH_VERF
      1777**DCL      1840--ASSIGN   1848--ASSIGN
RQSCTX.CALLHDR.PROC#
      1773**DCL      1838<<ASSIGN
RQSCTX.CALLHDR.TYPE
      1772**DCL      1823>>IF
RQSCTX.CALLHDR.XID
      1772**DCL      1772--REDEF    1820>>IF       1836<<ASSIGN   1836>>ASSIGN
RQSCTX.FROMADDR
      1737**DCL      1885<>CALL
RQSCTX.FROMADDR.SA_FAMILY
      1750**DCL      1847<<ASSIGN
RQSCTX.FROMADDR.S_ADDR
      1769**DCL      1814>>ASSIGN   1846<<ASSIGN
RQSCTX.FROMADDR.S_PORT
      1759**DCL      1845<<ASSIGN
RQSCTX.LEN
PL6.E3A0      #001=FUP$PMAP File=FUP$PMAP.:FUA2TSI                               FRI 11/21/97 11:34 Page:29   
      1715**DCL      1820>>IF       1824<<ASSIGN   1828<<ASSIGN   1848<<ASSIGN   1854>>IF       1876<<ASSIGN
      1881<<ASSIGN   1885<>CALL     1885<>CALL
RQSCTX.PROC#
      1716**DCL      1817>>DOCASE
RQSCTX.REPLYHDR
      1777**DCL      1885<>CALL
RQSCTX.REPLYHDR.AUTH_VERF_FLAVOR
      1779**DCL      1882<<ASSIGN
RQSCTX.REPLYHDR.AUTH_VERF_HID
      1781**DCL      1781--REDEF    1781--REDEF
RQSCTX.REPLYHDR.AUTH_VERF_LEN
      1780**DCL      1883<<ASSIGN
RQSCTX.REPLYHDR.NA_ACCEPT_STAT
      1780**DCL      1884<<ASSIGN
RQSCTX.REPLYHDR.NA_RESULT0
      1781**DCL      1860<>CALL     1880<<ASSIGN
RQSCTX.REPLYHDR.NA_RESULTS
      1781**DCL      1868--ASSIGN   1869<<ASSIGN   1875<<ASSIGN
RQSCTX.REPLYHDR.PVERS_HIGH
      1783**DCL      1783--REDEF
RQSCTX.REPLYHDR.PVERS_LOW
      1782**DCL      1782--REDEF    1783--REDEF
RQSCTX.REPLYHDR.REJECT_STAT
      1778**DCL      1778--REDEF    1779--REDEF
RQSCTX.REPLYHDR.VERS_HIGH
      1780**DCL      1780--REDEF    1780--REDEF
RQSCTX.REPLYHDR.VERS_LOW
      1779**DCL      1779--REDEF    1780--REDEF
XSL$HTONL
      1792**DCL-ENT  1843--CALL     1860--CALL     1872--CALL
XSL$QCLOSE
      1793**DCL-ENT  1829--CALL
XSL$QSENDTO
      1794**DCL-ENT  1885--CALL
