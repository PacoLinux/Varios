
PL6.E3A0      #001=ZIO$EVENT File=ZIM$EVENT.:ZIC0TSI                             FRI 09/05/97 12:54 Page:1    
        1        1        /*M* ZIO$EVENT - handler of asynchronous events and exit control.  */
        2        2        /*T***********************************************************/
        3        3        /*T*                                                         */
        4        4        /*T* Copyright (c) Bull HN Information Systems Inc., 1997    */
        5        5        /*T*                                                         */
        6        6        /*T***********************************************************/
        7        7        ZIO$EVENT: PROC ASYNC
        8        8         /* USE($PR5 FOR GLOBAL$) */
        9        9               AVOID($PR5,$PR6,$PR7);
       10       10    1   DCL ZIM$ABORT ENTRY;
       11       11    1   DCL ZIM$FPTCHKR ENTRY;
       12       12    1   DCL ZIM$ERRMSG ENTRY(1);
       13       13    1   DCL ZIM$CHKPT ENTRY(1) ALTRET;
       14       14    1   DCL ZIM$CLEANUP ENTRY ALTRET;
       15       15    1   DCL ZIM$FINALL ENTRY ALTRET;
       16       16    1   DCL ZIO$FLUSH ENTRY(1) ALTRET;
       17       17    1   DCL ZIM$PROL ENTRY ALTRET;
       18       18    1   DCL X66_TRTN ENTRY(1);
       19       19    1   DCL ZIB$FIXPR5 ENTRY;
       20       20    1   DCL ZIB$FIXREGS ENTRY;
       21       21    1   DCL ZIE$STATS ENTRY;
       22       22    1   DCL ZID$ASTATS ENTRY;
       23       23    1   DCL B$ECCB$ PTR SYMREF;
       24       24    1   DCL P$ PTR;
       25       25    1   DCL 1 P REDEF P$,
       26       26    1         2 ADR UBIN(18) UNAL,
       27       27    1         2 * UBIN(18) UNAL;
       28       28    1   DCL B$TCB$ PTR SYMREF;
       29       29    1   DCL B$JIT$ PTR SYMREF;
       30       30    1   DCL ZI_FPTCHKR BIT(1) SYMREF;
       31       31    1   DCL ZI_USER BIT(1) SYMREF;
       32       32    1   DCL DBNO SBIN WORD;
       33       33    1   DCL STK$ PTR;
       34       34    1   DCL PS2$ PTR SYMREF;
       35       35    1   DCL ERROR BIT(36);
       36       36    1   DCL ERR_CODE SBIN ALIGNED;
       37       37    1   DCL 1 DBSTATUS BASED(PS2$),
PL6.E3A0      #001=ZIO$EVENT File=ZIM$EVENT.:ZIC0TSI                             FRI 09/05/97 12:54 Page:2    
       38       38    1         2 STATUS CHAR(7),
       39       39    1         2 * CHAR(1);
       40       40        %INCLUDE B$JIT;
       41      330        %INCLUDE CP_6;
       42      411        %FPT_TRMPRG (STCLASS=CONSTANT,RSTBRK=YES);
       43      440        %FPT_ERR(FPTN=FPT$ERR,STCLASS=AUTO);
       44      455        %FPT_ERR(FPTN=FPT_ERR,STCLASS=SYMREF);
       45      470        %FPT_TRTN(FPTN=FPT$TRTN,STCLASS=BASED);
       46      487        %FPT_WAIT(STCLASS=SYMREF);
       47      501        %FPT_KEYIN(FPTN=FPT$KEYIN,STCLASS=BASED);
       48      520        %B$XCON;
       49      530        %B$EVNT;
       50      543        %B$EXCFR;
       51      561        %B$NWIO;
       52      646        %B$TCB;
       53      649        %B$ECCB;
       54      657        %SUB_EXC;
       55      704        %INCLUDE CP_6_SUBS;
       56     1244        %INCLUDE ZI_ERRORS_C;
       57     1570        %INCLUDE ZI$GLOBAL;
       58     2056        %GLOBALS;
       59     2364        %BUFFERS;
       60     2379        %INCLUDE ZI$USER;
       61     2524        %IA;
       62     2573        %EJECT;
PL6.E3A0      #001=ZIO$EVENT File=ZIM$EVENT.:ZIC0TSI                             FRI 09/05/97 12:54 Page:3    
       63     2574    2       DO INHIBIT; /* Mainly for event and break control */
       64     2575    2           CALL ZIB$FIXPR5;
       65     2576    2           IF B$ECCB$->B$ECCB.XCONF.NOTCB=%YES# THEN
       66     2577    3           DO;
       67     2578    3               GLOBAL.RET.ERROR#=ERR#X#ASL;
       68     2579    3               STK$=B$TCB$->B$TCB.ALT$;
       69     2580    3               GOTO ABORT;
       70     2581    3               END;
       71     2582    2           STK$ = B$TCB$->B$TCB.STK$;
       72     2583        /* case logic associated with processing a exceptional condition  frame */
       73     2584    3           DO CASE ( STK$->B$EXCFR.ECC );
       74     2585        %EJECT;
PL6.E3A0      #001=ZIO$EVENT File=ZIM$EVENT.:ZIC0TSI                             FRI 09/05/97 12:54 Page:4    
       75     2586    3           CASE(%ECC_ERROR#); /* Error faults */
       76     2587         /* Check if ipr. Must be from encode decode */
       77     2588    4               IF STK$->B$EXCFR.SUBC=%SUBC_IPR# THEN DO;
       78     2589        /*                Set error code.  Remove AUTO frame.
       79     2590                          Remove stack frame.  Re-enter at altret sequence */
       80     2591    4                   GLOBAL.RET.ERROR#=EXC#IDI;
       81     2592    4                   GLOBAL.TRTN$->FPT$TRTN.V.IR#=STK$->B$EXCFR.IR;
       82     2593    4                   GLOBAL.TRTN$->FPT$TRTN.V.IRBIT#.MIR=%NO#;
       83     2594    4                   CALL X66_TRTN(GLOBAL.TRTN$->FPT$TRTN);
       84     2595    4                   END;
       85     2596    3               ELSE
       86     2597    4               DO CASE (STK$->B$EXCFR.SUBC);
       87     2598    4               CASE(%SUBC_SEC1#,%SUBC_MEMORY#,%SUBC_MSEG#,%SUBC_MPAGE#,%SUBC_SEC2#);
       88     2599    4                   IF ZI_FPTCHKR THEN
       89     2600    4                       CALL ZIM$FPTCHKR;
       90     2601    4               CASE(ELSE);
       91     2602    4                   GLOBAL.RET.ERROR# = ERR#X#ASL;
       92     2603    4                   END; /* CASE */
       93     2604        %EJECT;
PL6.E3A0      #001=ZIO$EVENT File=ZIM$EVENT.:ZIC0TSI                             FRI 09/05/97 12:54 Page:5    
       94     2605    3           CASE(%ECC_PROG#); /* Program Faults */
       95     2606         /* If derail-Altreted to routine not expecting it */
       96     2607    3               IF STK$->B$EXCFR.SUBC=%SUBC_DRAIL# THEN
       97     2608    3                   GLOBAL.RET.ERROR#=ERR#CM#INTER;
       98     2609    3               ELSE
       99     2610    3                   GLOBAL.RET.ERROR#=ERR#X#ASL;
      100     2611        %EJECT;
PL6.E3A0      #001=ZIO$EVENT File=ZIM$EVENT.:ZIC0TSI                             FRI 09/05/97 12:54 Page:6    
      101     2612    3           CASE ( %ECC_INT# ); /* exceptional condition is break control */
      102     2613        /*     Case logic for break control     */
      103     2614    3               GLOBAL.INHIB.BREAK=%YES#;
      104     2615    3               GLOBAL.INHIB.DUMP=%NO#;
      105     2616    3               CALL M$TRMPRG (FPT_TRMPRG) ALTRET (BRK_RTN);
      106     2617    3   BRK_RTN:
      107     2618    3               RETURN;
      108     2619        %EJECT;
PL6.E3A0      #001=ZIO$EVENT File=ZIM$EVENT.:ZIC0TSI                             FRI 09/05/97 12:54 Page:7    
      109     2620    3           CASE(%ECC_EVENT#); /* Exceptional condition is event */
      110     2621        /*          If event is for no-wait I/O
      111     2622                    and I/O on this buffer was in progress
      112     2623                    and completed successfuly then
      113     2624                       clear status of buffer                    */
      114     2625    3               IF STK$->B$EVNT.EVSC=%EVSC_IO# AND
      115     2626    3                  STK$->B$NWIO.EVID<=GLOBAL.BCB.COUNT AND
      116     2627    3                  GLOBAL.BCB.BUF.STATUS.BUSY(STK$->B$NWIO.EVID)=%YES# AND
      117     2628    3                  STK$->B$NWIO.ERR.CODE=0 THEN
      118     2629    4               DO; /* already inhibited whole routine */
      119     2630    4                   GLOBAL.BCB.BUF.STATUS.MODIFY(STK$->B$NWIO.EVID)=%NO#;
      120     2631    4                   GLOBAL.BCB.BUF.STATUS.BUSY(STK$->B$NWIO.EVID)=%NO#;
      121     2632    4                   PINCRW(GLOBAL.BCB.BUF.BUF$(STK$->B$NWIO.EVID),-3)
      122     2633    4                      ->BLOCK.PSTAMP=STK$->B$NWIO.EVID;
      123     2634    4                   RETURN;
      124     2635    4                   END;
      125     2636    3               ELSE
      126     2637    3                   GLOBAL.RET.ERROR#=ERR#X#ASL;
      127     2638        %EJECT;
PL6.E3A0      #001=ZIO$EVENT File=ZIM$EVENT.:ZIC0TSI                             FRI 09/05/97 12:54 Page:8    
      128     2639    3           CASE(%ECC_XCON#);
      129     2640    3               GLOBAL.PENDING.XCON=%YES#;
      130     2641        /*       If normal exit and
      131     2642                 not due to CTRL-Y QUIT and
      132     2643                 exit control not already in progress and
      133     2644                  not due to timeout and
      134     2645                 not due to link and
      135     2646                 not due to save and
      136     2647                 not due to Control-Y save and
      137     2648                 not due to get then
      138     2649                    flush buffers and exit normaly                 */
      139     2650    3               IF STK$->B$XCON.RNST='0'B AND
      140     2651    3                  B$JIT.CPFLAGS1&%CP_EXIT# AND
      141     2652    3                  ~STK$->B$XCON.XCONF.QUIT AND
      142     2653    3                  STK$->B$XCON.CECCB.PROG AND
      143     2654    3                  ~STK$->B$XCON.CECCB.LIMIT AND
      144     2655    3                  ~STK$->B$XCON.CECCB.LNK AND
      145     2656    3                  ~STK$->B$XCON.CECCB.SAVE AND
      146     2657    3                  ~STK$->B$XCON.CECCB.CPSAVE AND
      147     2658    3                  ~STK$->B$XCON.CECCB.GET THEN
      148     2659    4               DO;
      149     2660        /*       Clear possible left over error code */
      150     2661    4                   GLOBAL.RET.ERROR#=0;
      151     2662    4                   GLOBAL.FCN.CODE=0;
      152     2663    4                   GLOBAL.FCN.DML=%NO#;
      153     2664    4                   CALL ZIM$CHKPT(0) ALTRET(ABORT);
      154     2665    5                   DO DBNO=1 TO DB#MAX;
      155     2666    5                       IF GLOBAL.DB.SSS$(DBNO)~=ADDR(NIL) THEN
      156     2667    6                       DO;
      157     2668    6                           GLOBAL.ACTIVE.DBNO=DBNO;
      158     2669    6                           GLOBAL.ACTIVE.SSS$=GLOBAL.DB.SSS$(DBNO);
      159     2670    6                           GLOBAL.ACTIVE.DBCB$=GLOBAL.DB.DBCB$(DBNO);
      160     2671    6                           CALL ZIB$FIXREGS;
      161     2672    6                           CALL ZIM$FINALL ALTRET(ER_FIN);
      162     2673    6                           END;
      163     2674    5   NEXTDB:             END;
      164     2675    4                   CALL ZIM$CLEANUP;
PL6.E3A0      #001=ZIO$EVENT File=ZIM$EVENT.:ZIC0TSI                             FRI 09/05/97 12:54 Page:9    
      165     2676    4                   CALL M$EXIT;
      166     2677    4                   END;
      167     2678    3               ELSE
      168     2679    3                   IF STK$->B$XCON.ECSC=1 OR ZI_USER THEN
      169     2680    3                       GLOBAL.RET.ERROR#=ERR#X#UNEX;
      170     2681    4                   ELSE DO;
      171     2682        /*                ASL exit */
      172     2683    4                       CALL ZID$ASTATS; /* For possible interupted call */
      173     2684    4                       IF STK$->B$XCON.RNST.MABRT AND ~STK$->B$XCON.RNST.HANGUP THEN
      174     2685        /*                   Not clean.  Set new error code */
      175     2686    4                           GLOBAL.RET.ERROR#=ERR#X#ASL;
      176     2687    4                       ELSE
      177     2688        /*                      Check for continuation conditions */
      178     2689    4                           IF ~STK$->B$XCON.CECCB.PROG AND
      179     2690    4                              ~STK$->B$XCON.CECCB.LNK AND
      180     2691    4                              ~STK$->B$XCON.CECCB.SAVE AND
      181     2692    4                              ~STK$->B$XCON.CECCB.CPSAVE AND
      182     2693    4                              ~STK$->B$XCON.CECCB.GET AND
      183     2694    4                              ~STK$->B$XCON.RNST.MONXXX AND
      184     2695    4                              ~STK$->B$XCON.RNST.MABRT AND
      185     2696    4                              ~STK$->B$XCON.RNST.XXX AND
      186     2697    4                              ~STK$->B$XCON.RNST.ERR THEN
      187     2698        /*                         OK to ignore multiple XCON entry */
      188     2699    4                               RETURN;
      189     2700    4                           ELSE
      190     2701    4                               IF STK$->B$XCON.RNST.ERR OR
      191     2702    4                                  GLOBAL.PENDING.EXIT_DML THEN
      192     2703        /*                            Keep old error code */
      193     2704    4                                   GOTO ABORT;
      194     2705    4                               ELSE
      195     2706    4                                   IF NOT (STK$->B$XCON.CECCB.PROG AND
      196     2707    4                                      GLOBAL.PENDING.ROLL) AND
      197     2708    4                                      (GLOBAL.TJRNL.DCB#~=0 OR
      198     2709    4                                      GLOBAL.CAC>0) THEN
      199     2710        /*                               If user level call to rollback finish call. */
      200     2711        /*                               If Tjrnl stop.  We will roll back */
      201     2712        /*                               If CAC and ~Tjrnl no updaters */
PL6.E3A0      #001=ZIO$EVENT File=ZIM$EVENT.:ZIC0TSI                             FRI 09/05/97 12:54 Page:10   
      202     2713    4                                       GLOBAL.RET.ERROR#=ERR#X#UNEX;
      203     2714    5                                   ELSE DO;
      204     2715        /*                               Only choice: try to finish call */
      205     2716    5                                       GLOBAL.PENDING.EXIT_DML=%YES#;
      206     2717    5                                       GLOBAL.RET.SYSERR#=STK$->B$EXCFR.ERR;
      207     2718    5                                       RETURN;
      208     2719    5                                       END;
      209     2720    4                       END;
      210     2721    3               END; /* CASE */
      211     2722        %EJECT;
PL6.E3A0      #001=ZIO$EVENT File=ZIM$EVENT.:ZIC0TSI                             FRI 09/05/97 12:54 Page:11   
      212     2723    2           GLOBAL.RET.SYSERR#=STK$->B$EXCFR.ERR;
      213     2724    2   ABORT:  CALL ZIM$ABORT;
      214     2725    2           GLOBAL.RET.SYSERR#='0'B;
      215     2726        /*          Call user stats before possible rollback */
      216     2727    2           GLOBAL.FCN.CODE=0;
      217     2728    2           GLOBAL.FCN.DML=%NO#;
      218     2729    2           CALL ZIE$STATS;
      219     2730        /*          No more accounting for user stats */
      220     2731    2           GLOBAL.PENDING.STATS=%NO#;
      221     2732    2           IF STK$->B$XCON.ECSC=0 AND
      222     2733    2              GLOBAL.FCN.DML=%YES# THEN
      223     2734    3           DO; /* ASL domain when abort occured */
      224     2735        /*          For Pederson */
      225     2736    3               CALL BINCHAR(DBSTATUS.STATUS,GLOBAL.RET.ERROR#+
      226     2737    3                  GLOBAL.RET.STCD#*FTL#ERR#INCR);
      227     2738    3               IA.SYSERR=GLOBAL.RET.SYSERR#;
      228     2739    3               END;
      229     2740    2           GLOBAL.RET.ERROR#=0;
      230     2741        /*       Now roll back any updates that made it to physical file */
      231     2742    2           IF GLOBAL.PENDING.ROLL OR GLOBAL.PENDING.RECVRY THEN
      232     2743    2               GOTO CLEAN;
      233     2744    3           IF GLOBAL.TJRNL.DCB#~=0 AND GLOBAL.DB.COUNT~=0 THEN DO;
      234     2745    4               IF STK$->B$XCON.RNST.OPXXX AND GLOBAL.UPDATE.TJRNL>0 THEN DO;
      235     2746    4                   GLOBAL.PRINTBUF.BUFFER=
      236     2747    4                      'IDS rollback in progress-NO more "X" KEYIN on this user.!!!';
      237     2748    4                   CALL M$KEYIN(GLOBAL.KEYIN$->FPT$KEYIN);
      238     2749    4                   END;
      239     2750    3               IF GLOBAL.UPDATE.TJRNL>0 THEN
      240     2751    3                   ERR_CODE=ERR#RL#ATTEMPT; /* TYPE ROLLBACK BE PERFORM MSG */
      241     2752    3               ELSE /* TJRNL IS USED TO LOCK UNPROTECT USERS */
      242     2753    4               DO;
      243     2754    4                   CALL ZIO$FLUSH('1'B) ALTRET(ABORT);
      244     2755    4                   IF GLOBAL.TJRNL.UNCHECK THEN /* AT UN-CLEAN POINT */
      245     2756    4                       ERR_CODE=ERR#RL#LOCKMSG; /* TYPE AREAS BE LOCKED MSG */
      246     2757    4                   ELSE /* TYPE AREAS SHOULD NOT BE LOCKED MSG */
      247     2758    4                       ERR_CODE=ERR#RL#NOLOCK;
      248     2759    4                   END;
PL6.E3A0      #001=ZIO$EVENT File=ZIM$EVENT.:ZIC0TSI                             FRI 09/05/97 12:54 Page:12   
      249     2760    3               CALL ZIM$ERRMSG(ERR_CODE);
      250     2761    3               IF ERR_CODE~=ERR#RL#NOLOCK THEN
      251     2762    3                   CALL ZIM$PROL ALTRET(ER_ROLL);
      252     2763    3               GLOBAL.FCN.CODE=1;
      253     2764    3               CALL ZID$ASTATS;
      254     2765    3               END;
      255     2766    2           ELSE
      256     2767    2               CALL ZIO$FLUSH(%YES#) ALTRET(ABORT);
      257     2768        /*       Save error for JIT release all memory and exit */
      258     2769    2   CLEAN:  ERROR=GLOBAL.PARAN.IDSERR;
      259     2770    2           CALL ZIM$CLEANUP;
      260     2771    2           FPT$ERR=FPT_ERR;
      261     2772    2           FPT$ERR.V_=VECTOR(FPT$ERR.V);
      262     2773    2           FPT$ERR.CODE_=VECTOR(ERROR);
      263     2774    2           CALL M$ERR(FPT$ERR);
      264     2775    2   ER_FIN: IF GLOBAL.RET.ERROR#=EXC#ANR THEN
      265     2776    2               GOTO NEXTDB;
      266     2777    2           GOTO ABORT;
      267     2778    2   ER_ROLL: GLOBAL.RET.ERROR#=ERR#X#ROLL;
      268     2779    2           GLOBAL.PENDING.ROLL_ABORTED='1'B;
      269     2780    2           GOTO ABORT;
      270     2781    2           END; /* Inhibit */
      271     2782    1   END ZIO$EVENT;

PL6.E3A0      #001=ZIO$EVENT File=ZIM$EVENT.:ZIC0TSI                             FRI 09/05/97 12:54 Page:13   
--  Include file information  --

   ZI$USER.:ZIC0TOU  is referenced.
   ZI$GLOBAL.:ZIC0TOU  is referenced.
   ZI_ERRORS_C.:ZIC0TOU  is referenced.
   CP_6_SUBS.:LIB_E05  is referenced.
   CP_6.:LIB_E05  cannot be made into a system file and is referenced.
   B$JIT.:LIB_E05  cannot be made into a system file and is referenced.
   B$JIT_C.:E05TOU  was found in the system file and is referenced.
   CP_6_C.:E05TOU  was found in the system file and is referenced.
      No diagnostics issued in procedure ZIO$EVENT.

   Procedure ZIO$EVENT requires 436 words for executable code.
   Procedure ZIO$EVENT requires 16 words of local(AUTO) storage.

    No errors detected in file ZIM$EVENT.:ZIC0TSI    .

PL6.E3A0      #001=ZIO$EVENT File=ZIM$EVENT.:ZIC0TSI                             FRI 09/05/97 12:54 Page:14   

 Object Unit name= ZIO$EVENT                                  File name= ZIM$EVENT.:ZIC0TOU
 UTS= SEP 05 '97 12:54:09.56 FRI                              Compiler= PL-6/E31         Sev=      00
 SharedLib= :SHARED_SYSTEM                                    Alt SharedLib=


    ****  Control sections  ****

 Sect   Type Bound  Init  Size OctSiz  Section name(segment info)
    0   DCB   even  none     0      0  M$UC
    1  RoData even  UTS     24     30  ZIO$EVENT
    2   Proc  even  none   436    664  ZIO$EVENT
    3  RoData even  none    13     15  ZIO$EVENT

    ****  Entry defs  ****

                              Check   Calling
                             calling  sequence
  Sect OctLoc Primary Altret sequence   type   Parms  Name
     2      0   yes            yes     XAsync      0  ZIO$EVENT
PL6.E3A0      #001=ZIO$EVENT File=ZIM$EVENT.:ZIC0TSI                             FRI 09/05/97 12:54 Page:15   

  ****  Entry refs  ****

         Check        Calling
        calling       sequence
Altret sequence SRef   type   Args  Name
         yes           XStd      0 ZIB$FIXPR5
         yes           XStd      1 X66_TRTN
         yes           XStd      0 ZIB$FIXREGS
         yes           XStd      1 ZIM$ERRMSG
 yes     yes           XStd      0 ZIM$CLEANUP
         yes           XStd      0 ZID$ASTATS
         yes           XStd      0 ZIM$ABORT
 yes     yes           XStd      1 ZIO$FLUSH
 yes     yes           XStd      0 ZIM$PROL
 yes     yes           XStd      1 ZIM$CHKPT
         yes           XStd      0 ZIM$FPTCHKR
         yes           XStd      0 ZIE$STATS
 yes     yes           XStd      0 ZIM$FINALL
                       nStd      0 X66_AAUTO
                       nStd      0 X66_AARET

  ****  Data refs  ****

  Flags:  r = read only, s = secondary
Flgs Name                             Flgs Name                             Flgs Name
     B$ECCB$                               B$TCB$                                B$JIT$
     ZI_FPTCHKR                            ZI_USER                               PS2$
     M$UC                                  FPT_ERR                               FPT_WAIT
r    GLOBAL$                               IA$

  ****  Segment refs  ****

  Flags:  r = read only, s = secondary
Flgs Name                             Flgs Name                             Flgs Name
     ISSID                                 NULLSID
PL6.E3A0      #001=ZIO$EVENT File=ZIM$EVENT.:ZIC0TSI                             FRI 09/05/97 12:54 Page:16   


        1        1        /*M* ZIO$EVENT - handler of asynchronous events and exit control.  */
        2        2        /*T***********************************************************/
        3        3        /*T*                                                         */
        4        4        /*T* Copyright (c) Bull HN Information Systems Inc., 1997    */
        5        5        /*T*                                                         */
        6        6        /*T***********************************************************/
        7        7        ZIO$EVENT: PROC ASYNC

      7  2 000000   000000 700200 xent  ZIO$EVENT    TSX0  ! X66_AAUTO
         2 000001   000020 000000                    ZERO    16,0

        8        8         /* USE($PR5 FOR GLOBAL$) */
        9        9               AVOID($PR5,$PR6,$PR7);
       10       10    1   DCL ZIM$ABORT ENTRY;
       11       11    1   DCL ZIM$FPTCHKR ENTRY;
       12       12    1   DCL ZIM$ERRMSG ENTRY(1);
       13       13    1   DCL ZIM$CHKPT ENTRY(1) ALTRET;
       14       14    1   DCL ZIM$CLEANUP ENTRY ALTRET;
       15       15    1   DCL ZIM$FINALL ENTRY ALTRET;
       16       16    1   DCL ZIO$FLUSH ENTRY(1) ALTRET;
       17       17    1   DCL ZIM$PROL ENTRY ALTRET;
       18       18    1   DCL X66_TRTN ENTRY(1);
       19       19    1   DCL ZIB$FIXPR5 ENTRY;
       20       20    1   DCL ZIB$FIXREGS ENTRY;
       21       21    1   DCL ZIE$STATS ENTRY;
       22       22    1   DCL ZID$ASTATS ENTRY;
       23       23    1   DCL B$ECCB$ PTR SYMREF;
       24       24    1   DCL P$ PTR;
       25       25    1   DCL 1 P REDEF P$,
       26       26    1         2 ADR UBIN(18) UNAL,
       27       27    1         2 * UBIN(18) UNAL;
       28       28    1   DCL B$TCB$ PTR SYMREF;
       29       29    1   DCL B$JIT$ PTR SYMREF;
       30       30    1   DCL ZI_FPTCHKR BIT(1) SYMREF;
       31       31    1   DCL ZI_USER BIT(1) SYMREF;
       32       32    1   DCL DBNO SBIN WORD;
PL6.E3A0      #001=ZIO$EVENT File=ZIM$EVENT.:ZIC0TSI                             FRI 09/05/97 12:54 Page:17   
       33       33    1   DCL STK$ PTR;
       34       34    1   DCL PS2$ PTR SYMREF;
       35       35    1   DCL ERROR BIT(36);
       36       36    1   DCL ERR_CODE SBIN ALIGNED;
       37       37    1   DCL 1 DBSTATUS BASED(PS2$),
       38       38    1         2 STATUS CHAR(7),
       39       39    1         2 * CHAR(1);
       40       40        %INCLUDE B$JIT;
       41      330        %INCLUDE CP_6;
       42      411        %FPT_TRMPRG (STCLASS=CONSTANT,RSTBRK=YES);
       43      440        %FPT_ERR(FPTN=FPT$ERR,STCLASS=AUTO);
       44      455        %FPT_ERR(FPTN=FPT_ERR,STCLASS=SYMREF);
       45      470        %FPT_TRTN(FPTN=FPT$TRTN,STCLASS=BASED);
       46      487        %FPT_WAIT(STCLASS=SYMREF);
       47      501        %FPT_KEYIN(FPTN=FPT$KEYIN,STCLASS=BASED);
       48      520        %B$XCON;
       49      530        %B$EVNT;
       50      543        %B$EXCFR;
       51      561        %B$NWIO;
       52      646        %B$TCB;
       53      649        %B$ECCB;
       54      657        %SUB_EXC;
       55      704        %INCLUDE CP_6_SUBS;
       56     1244        %INCLUDE ZI_ERRORS_C;
       57     1570        %INCLUDE ZI$GLOBAL;
       58     2056        %GLOBALS;
       59     2364        %BUFFERS;
       60     2379        %INCLUDE ZI$USER;
       61     2524        %IA;
       62     2573        %EJECT;
PL6.E3A0      #001=ZIO$EVENT File=ZIM$EVENT.:ZIC0TSI                             FRI 09/05/97 12:54 Page:18   
       63     2574    2       DO INHIBIT; /* Mainly for event and break control */

       64     2575    2           CALL ZIB$FIXPR5;

   2575  2 000002   000000 631600 3                  EPPR1 ! 0
         2 000003   000000 701200 xent               TSX1  ! ZIB$FIXPR5
         2 000004   000000 011200                    NOP   ! 0

       65     2576    2           IF B$ECCB$->B$ECCB.XCONF.NOTCB=%YES# THEN

   2576  2 000005   000000 470600 xsym               LDP0  ! B$ECCB$
         2 000006   000004 236300                    LDQ   ! 4,,PR0
         2 000007   000200 316203                    CANQ  ! 128,DU
         2 000010   000020 600200 2                  TZE   ! s:2582

       66     2577    3           DO;

       67     2578    3               GLOBAL.RET.ERROR#=ERR#X#ASL;

   2578  2 000011   303345 235207                    LDA   ! 100069,DL
         2 000012   000000 471600 xsym               LDP1  ! GLOBAL$
         2 000013   100006 755300                    STA   ! 6,,PR1

       68     2579    3               STK$=B$TCB$->B$TCB.ALT$;

   2579  2 000014   000000 473600 xsym               LDP3  ! B$TCB$
         2 000015   300000 236300                    LDQ   ! 0,,PR3
         2 000016   200005 756300                    STQ   ! STK$,,AUTO

       69     2580    3               GOTO ABORT;

   2580  2 000017   000462 710200 2                  TRA   ! ABORT

       70     2581    3               END;
       71     2582    2           STK$ = B$TCB$->B$TCB.STK$;

   2582  2 000020   000000 471600 xsym               LDP1  ! B$TCB$
PL6.E3A0      #001=ZIO$EVENT File=ZIM$EVENT.:ZIC0TSI                             FRI 09/05/97 12:54 Page:19   
         2 000021   100001 236300                    LDQ   ! 1,,PR1
         2 000022   200005 756300                    STQ   ! STK$,,AUTO

       72     2583        /* case logic associated with processing a exceptional condition  frame */
       73     2584    3           DO CASE ( STK$->B$EXCFR.ECC );

   2584  2 000023   200005 473700                    LDP3  ! STK$,,AUTO
         2 000024   300000 720300                    LXL0  ! 0,,PR3
         2 000025   000010 100203                    CMPX0 ! 8,DU
         2 000026   000030 602210 2                  TNC   ! s:2584+5,X0
         2 000027   000456 710200 2                  TRA   ! s:2723
         2 000030   000456 710200 2                  TRA   ! s:2723
         2 000031   000137 710200 2                  TRA   ! s:2625
         2 000032   000125 710200 2                  TRA   ! s:2614
         2 000033   000202 710200 2                  TRA   ! s:2640
         2 000034   000456 710200 2                  TRA   ! s:2723
         2 000035   000456 710200 2                  TRA   ! s:2723
         2 000036   000112 710200 2                  TRA   ! s:2607
         2 000037   000040 710200 2                  TRA   ! s:2588

       74     2585        %EJECT;
PL6.E3A0      #001=ZIO$EVENT File=ZIM$EVENT.:ZIC0TSI                             FRI 09/05/97 12:54 Page:20   
       75     2586    3           CASE(%ECC_ERROR#); /* Error faults */

       76     2587         /* Check if ipr. Must be from encode decode */
       77     2588    4               IF STK$->B$EXCFR.SUBC=%SUBC_IPR# THEN DO;

   2588  2 000040   300100 721300                    LXL1  ! 64,,PR3
         2 000041   000003 101203                    CMPX1 ! 3,DU
         2 000042   000063 601200 2                  TNZ   ! s:2597

       78     2589        /*                Set error code.  Remove AUTO frame.
       79     2590                          Remove stack frame.  Re-enter at altret sequence */
       80     2591    4                   GLOBAL.RET.ERROR#=EXC#IDI;

   2591  2 000043   012120 235207                    LDA   ! 5200,DL
         2 000044   000000 474600 xsym               LDP4  ! GLOBAL$
         2 000045   400006 755300                    STA   ! 6,,PR4

       81     2592    4                   GLOBAL.TRTN$->FPT$TRTN.V.IR#=STK$->B$EXCFR.IR;

   2592  2 000046   405127 470700                    LDP0  ! 2647,,PR4
         2 000047   300004 720300                    LXL0  ! 4,,PR3
         2 000050   000006 440300                    SXL0  ! 6,,PR0

       82     2593    4                   GLOBAL.TRTN$->FPT$TRTN.V.IRBIT#.MIR=%NO#;

   2593  2 000051   405127 470700                    LDP0  ! 2647,,PR4
         2 000052   000001 236200 3                  LDQ   ! 1
         2 000053   000006 356300                    ANSQ  ! 6,,PR0

       83     2594    4                   CALL X66_TRTN(GLOBAL.TRTN$->FPT$TRTN);

   2594  2 000054   405127 470700                    LDP0  ! 2647,,PR4
         2 000055   200016 450700                    STP0  ! FPT$ERR+6,,AUTO
         2 000056   200016 630700                    EPPR0 ! FPT$ERR+6,,AUTO
         2 000057   000002 631600 3                  EPPR1 ! 2
         2 000060   000000 701200 xent               TSX1  ! X66_TRTN
         2 000061   000000 011200                    NOP   ! 0
PL6.E3A0      #001=ZIO$EVENT File=ZIM$EVENT.:ZIC0TSI                             FRI 09/05/97 12:54 Page:21   

       84     2595    4                   END;

   2595  2 000062   000456 710200 2                  TRA   ! s:2723

       85     2596    3               ELSE
       86     2597    4               DO CASE (STK$->B$EXCFR.SUBC);

   2597  2 000063   000012 101203                    CMPX1 ! 10,DU
         2 000064   000066 602211 2                  TNC   ! s:2597+3,X1
         2 000065   000106 710200 2                  TRA   ! s:2602
         2 000066   000100 710200 2                  TRA   ! s:2599
         2 000067   000106 710200 2                  TRA   ! s:2602
         2 000070   000106 710200 2                  TRA   ! s:2602
         2 000071   000106 710200 2                  TRA   ! s:2602
         2 000072   000100 710200 2                  TRA   ! s:2599
         2 000073   000100 710200 2                  TRA   ! s:2599
         2 000074   000100 710200 2                  TRA   ! s:2599
         2 000075   000106 710200 2                  TRA   ! s:2602
         2 000076   000106 710200 2                  TRA   ! s:2602
         2 000077   000100 710200 2                  TRA   ! s:2599

       87     2598    4               CASE(%SUBC_SEC1#,%SUBC_MEMORY#,%SUBC_MSEG#,%SUBC_MPAGE#,%SUBC_SEC2#);

       88     2599    4                   IF ZI_FPTCHKR THEN

   2599  2 000100   000000 234200 xsym               SZN   ! ZI_FPTCHKR
         2 000101   000456 605200 2                  TPL   ! s:2723

       89     2600    4                       CALL ZIM$FPTCHKR;

   2600  2 000102   000000 631600 3                  EPPR1 ! 0
         2 000103   000000 701200 xent               TSX1  ! ZIM$FPTCHKR
         2 000104   000000 011200                    NOP   ! 0
         2 000105   000456 710200 2                  TRA   ! s:2723

       90     2601    4               CASE(ELSE);
PL6.E3A0      #001=ZIO$EVENT File=ZIM$EVENT.:ZIC0TSI                             FRI 09/05/97 12:54 Page:22   

       91     2602    4                   GLOBAL.RET.ERROR# = ERR#X#ASL;

   2602  2 000106   303345 235207                    LDA   ! 100069,DL
         2 000107   000000 474600 xsym               LDP4  ! GLOBAL$
         2 000110   400006 755300                    STA   ! 6,,PR4

       92     2603    4                   END; /* CASE */

   2603  2 000111   000456 710200 2                  TRA   ! s:2723

       93     2604        %EJECT;
PL6.E3A0      #001=ZIO$EVENT File=ZIM$EVENT.:ZIC0TSI                             FRI 09/05/97 12:54 Page:23   
       94     2605    3           CASE(%ECC_PROG#); /* Program Faults */

       95     2606         /* If derail-Altreted to routine not expecting it */
       96     2607    3               IF STK$->B$EXCFR.SUBC=%SUBC_DRAIL# THEN

   2607  2 000112   300100 721300                    LXL1  ! 64,,PR3
         2 000113   000001 101203                    CMPX1 ! 1,DU
         2 000114   000121 601200 2                  TNZ   ! s:2610

       97     2608    3                   GLOBAL.RET.ERROR#=ERR#CM#INTER;

   2608  2 000115   303241 235207                    LDA   ! 100001,DL
         2 000116   000000 474600 xsym               LDP4  ! GLOBAL$
         2 000117   400006 755300                    STA   ! 6,,PR4
         2 000120   000456 710200 2                  TRA   ! s:2723

       98     2609    3               ELSE
       99     2610    3                   GLOBAL.RET.ERROR#=ERR#X#ASL;

   2610  2 000121   303345 235207                    LDA   ! 100069,DL
         2 000122   000000 474600 xsym               LDP4  ! GLOBAL$
         2 000123   400006 755300                    STA   ! 6,,PR4
         2 000124   000456 710200 2                  TRA   ! s:2723

      100     2611        %EJECT;
PL6.E3A0      #001=ZIO$EVENT File=ZIM$EVENT.:ZIC0TSI                             FRI 09/05/97 12:54 Page:24   
      101     2612    3           CASE ( %ECC_INT# ); /* exceptional condition is break control */

      102     2613        /*     Case logic for break control     */
      103     2614    3               GLOBAL.INHIB.BREAK=%YES#;

   2614  2 000125   000000 474600 xsym               LDP4  ! GLOBAL$
         2 000126   000001 236207                    LDQ   ! 1,DL
         2 000127   400016 256300                    ORSQ  ! 14,,PR4

      104     2615    3               GLOBAL.INHIB.DUMP=%NO#;

   2615  2 000130   000003 236200 3                  LDQ   ! 3
         2 000131   400016 356300                    ANSQ  ! 14,,PR4

      105     2616    3               CALL M$TRMPRG (FPT_TRMPRG) ALTRET (BRK_RTN);

   2616  2 000132   000000 630600 1                  EPPR0 ! FPT_TRMPRG
         2 000133   560004 713600                    CLIMB ! alt,+57348
         2 000134   400400 401760                    pmme    nvectors=2
         2 000135   000136 702200 2                  TSX2  ! BRK_RTN

      106     2617    3   BRK_RTN:
      107     2618    3               RETURN;

   2618  2 000136   000000 702200 xent  BRK_RTN      TSX2  ! X66_AARET

      108     2619        %EJECT;
PL6.E3A0      #001=ZIO$EVENT File=ZIM$EVENT.:ZIC0TSI                             FRI 09/05/97 12:54 Page:25   
      109     2620    3           CASE(%ECC_EVENT#); /* Exceptional condition is event */

      110     2621        /*          If event is for no-wait I/O
      111     2622                    and I/O on this buffer was in progress
      112     2623                    and completed successfuly then
      113     2624                       clear status of buffer                    */
      114     2625    3               IF STK$->B$EVNT.EVSC=%EVSC_IO# AND

   2625  2 000137   300100 721300                    LXL1  ! 64,,PR3
         2 000140   000001 101203                    CMPX1 ! 1,DU
         2 000141   000176 601200 2                  TNZ   ! s:2637
         2 000142   000000 474600 xsym               LDP4  ! GLOBAL$
         2 000143   400177 236300                    LDQ   ! 127,,PR4
         2 000144   300101 116300                    CMPQ  ! 65,,PR3
         2 000145   000176 602200 2                  TNC   ! s:2637
         2 000146   300101 236300                    LDQ   ! 65,,PR3
         2 000147   000005 402207                    MPY   ! 5,DL
         2 000150   400206 236306                    LDQ   ! 134,QL,PR4
         2 000151   400000 316207                    CANQ  ! -131072,DL
         2 000152   000176 600200 2                  TZE   ! s:2637
         2 000153   300102 236300                    LDQ   ! 66,,PR3
         2 000154   377770 316207                    CANQ  ! 131064,DL
         2 000155   000176 601200 2                  TNZ   ! s:2637

      115     2626    3                  STK$->B$NWIO.EVID<=GLOBAL.BCB.COUNT AND
      116     2627    3                  GLOBAL.BCB.BUF.STATUS.BUSY(STK$->B$NWIO.EVID)=%YES# AND
      117     2628    3                  STK$->B$NWIO.ERR.CODE=0 THEN
      118     2629    4               DO; /* already inhibited whole routine */

      119     2630    4                   GLOBAL.BCB.BUF.STATUS.MODIFY(STK$->B$NWIO.EVID)=%NO#;

   2630  2 000156   300101 236300                    LDQ   ! 65,,PR3
         2 000157   000005 402207                    MPY   ! 5,DL
         2 000160   000000 622206                    EAX2  ! 0,QL
         2 000161   000004 236200 3                  LDQ   ! 4
         2 000162   400206 356312                    ANSQ  ! 134,X2,PR4

PL6.E3A0      #001=ZIO$EVENT File=ZIM$EVENT.:ZIC0TSI                             FRI 09/05/97 12:54 Page:26   
      120     2631    4                   GLOBAL.BCB.BUF.STATUS.BUSY(STK$->B$NWIO.EVID)=%NO#;

   2631  2 000163   300101 236300                    LDQ   ! 65,,PR3
         2 000164   000005 402207                    MPY   ! 5,DL
         2 000165   000000 620206                    EAX0  ! 0,QL
         2 000166   000005 236200 3                  LDQ   ! 5
         2 000167   400206 356310                    ANSQ  ! 134,X0,PR4

      121     2632    4                   PINCRW(GLOBAL.BCB.BUF.BUF$(STK$->B$NWIO.EVID),-3)

   2632  2 000170   300101 236300                    LDQ   ! 65,,PR3
         2 000171   000005 402207                    MPY   ! 5,DL
         2 000172   400202 470706                    LDP0  ! 130,QL,PR4
         2 000173   300101 235300                    LDA   ! 65,,PR3
         2 000174   077775 755300                    STA   ! -3,,PR0

      122     2633    4                      ->BLOCK.PSTAMP=STK$->B$NWIO.EVID;
      123     2634    4                   RETURN;

   2634  2 000175   000000 702200 xent               TSX2  ! X66_AARET

      124     2635    4                   END;
      125     2636    3               ELSE
      126     2637    3                   GLOBAL.RET.ERROR#=ERR#X#ASL;

   2637  2 000176   303345 235207                    LDA   ! 100069,DL
         2 000177   000000 474600 xsym               LDP4  ! GLOBAL$
         2 000200   400006 755300                    STA   ! 6,,PR4
         2 000201   000456 710200 2                  TRA   ! s:2723

      127     2638        %EJECT;
PL6.E3A0      #001=ZIO$EVENT File=ZIM$EVENT.:ZIC0TSI                             FRI 09/05/97 12:54 Page:27   
      128     2639    3           CASE(%ECC_XCON#);

      129     2640    3               GLOBAL.PENDING.XCON=%YES#;

   2640  2 000202   000000 474600 xsym               LDP4  ! GLOBAL$
         2 000203   004000 236203                    LDQ   ! 2048,DU
         2 000204   400017 256300                    ORSQ  ! 15,,PR4

      130     2641        /*       If normal exit and
      131     2642                 not due to CTRL-Y QUIT and
      132     2643                 exit control not already in progress and
      133     2644                  not due to timeout and
      134     2645                 not due to link and
      135     2646                 not due to save and
      136     2647                 not due to Control-Y save and
      137     2648                 not due to get then
      138     2649                    flush buffers and exit normaly                 */
      139     2650    3               IF STK$->B$XCON.RNST='0'B AND

   2650  2 000205   300101 236300                    LDQ   ! 65,,PR3
         2 000206   777000 316203                    CANQ  ! -512,DU
         2 000207   000323 601200 2                  TNZ   ! s:2679
         2 000210   000000 470600 xsym               LDP0  ! B$JIT$
         2 000211   000143 236300                    LDQ   ! 99,,PR0
         2 000212   000010 376200 1                  ANQ   ! FPT_TRMPRG+8
         2 000213   000323 600200 2                  TZE   ! s:2679
         2 000214   300101 236300                    LDQ   ! 65,,PR3
         2 000215   000021 736200                    QLS   ! 17
         2 000216   400000 376203                    ANQ   ! -131072,DU
         2 000217   400000 676203                    ERQ   ! -131072,DU
         2 000220   000323 600200 2                  TZE   ! s:2679
         2 000221   300100 234300                    SZN   ! 64,,PR3
         2 000222   000323 605200 2                  TPL   ! s:2679
         2 000223   300100 236300                    LDQ   ! 64,,PR3
         2 000224   000002 736200                    QLS   ! 2
         2 000225   400000 376203                    ANQ   ! -131072,DU
         2 000226   400000 676203                    ERQ   ! -131072,DU
PL6.E3A0      #001=ZIO$EVENT File=ZIM$EVENT.:ZIC0TSI                             FRI 09/05/97 12:54 Page:28   
         2 000227   000323 600200 2                  TZE   ! s:2679
         2 000230   300100 236300                    LDQ   ! 64,,PR3
         2 000231   000005 736200                    QLS   ! 5
         2 000232   400000 376203                    ANQ   ! -131072,DU
         2 000233   400000 676203                    ERQ   ! -131072,DU
         2 000234   000323 600200 2                  TZE   ! s:2679
         2 000235   300100 236300                    LDQ   ! 64,,PR3
         2 000236   000006 736200                    QLS   ! 6
         2 000237   400000 376203                    ANQ   ! -131072,DU
         2 000240   400000 676203                    ERQ   ! -131072,DU
         2 000241   000323 600200 2                  TZE   ! s:2679
         2 000242   300100 236300                    LDQ   ! 64,,PR3
         2 000243   000007 736200                    QLS   ! 7
         2 000244   400000 376203                    ANQ   ! -131072,DU
         2 000245   400000 676203                    ERQ   ! -131072,DU
         2 000246   000323 600200 2                  TZE   ! s:2679
         2 000247   300100 236300                    LDQ   ! 64,,PR3
         2 000250   000010 736200                    QLS   ! 8
         2 000251   400000 376203                    ANQ   ! -131072,DU
         2 000252   400000 676203                    ERQ   ! -131072,DU
         2 000253   000323 600200 2                  TZE   ! s:2679

      140     2651    3                  B$JIT.CPFLAGS1&%CP_EXIT# AND
      141     2652    3                  ~STK$->B$XCON.XCONF.QUIT AND
      142     2653    3                  STK$->B$XCON.CECCB.PROG AND
      143     2654    3                  ~STK$->B$XCON.CECCB.LIMIT AND
      144     2655    3                  ~STK$->B$XCON.CECCB.LNK AND
      145     2656    3                  ~STK$->B$XCON.CECCB.SAVE AND
      146     2657    3                  ~STK$->B$XCON.CECCB.CPSAVE AND
      147     2658    3                  ~STK$->B$XCON.CECCB.GET THEN
      148     2659    4               DO;

      149     2660        /*       Clear possible left over error code */
      150     2661    4                   GLOBAL.RET.ERROR#=0;

   2661  2 000254   400006 450300                    STZ   ! 6,,PR4

PL6.E3A0      #001=ZIO$EVENT File=ZIM$EVENT.:ZIC0TSI                             FRI 09/05/97 12:54 Page:29   
      151     2662    4                   GLOBAL.FCN.CODE=0;

   2662  2 000255   000000 220203                    LDX0  ! 0,DU
         2 000256   400004 440300                    SXL0  ! 4,,PR4

      152     2663    4                   GLOBAL.FCN.DML=%NO#;

   2663  2 000257   000006 236200 3                  LDQ   ! 6
         2 000260   400004 356300                    ANSQ  ! 4,,PR4

      153     2664    4                   CALL ZIM$CHKPT(0) ALTRET(ABORT);

   2664  2 000261   000007 630600 3                  EPPR0 ! 7
         2 000262   000002 631600 3                  EPPR1 ! 2
         2 000263   000000 701200 xent               TSX1  ! ZIM$CHKPT
         2 000264   000462 702200 2                  TSX2  ! ABORT

      154     2665    5                   DO DBNO=1 TO DB#MAX;

   2665  2 000265   000001 235207                    LDA   ! 1,DL
         2 000266   200004 755300                    STA   ! DBNO,,AUTO
         2 000267   000312 710200 2                  TRA   ! NEXTDB+1

      155     2666    5                       IF GLOBAL.DB.SSS$(DBNO)~=ADDR(NIL) THEN

   2666  2 000270   000000 470600 xsym               LDP0  ! GLOBAL$
         2 000271   200004 720300                    LXL0  ! DBNO,,AUTO
         2 000272   000153 236310                    LDQ   ! 107,X0,PR0
         2 000273   000010 116200 3                  CMPQ  ! 8
         2 000274   000311 600200 2                  TZE   ! NEXTDB

      156     2667    6                       DO;

      157     2668    6                           GLOBAL.ACTIVE.DBNO=DBNO;

   2668  2 000275   200004 235300                    LDA   ! DBNO,,AUTO
         2 000276   000002 755300                    STA   ! 2,,PR0
PL6.E3A0      #001=ZIO$EVENT File=ZIM$EVENT.:ZIC0TSI                             FRI 09/05/97 12:54 Page:30   

      158     2669    6                           GLOBAL.ACTIVE.SSS$=GLOBAL.DB.SSS$(DBNO);

   2669  2 000277   000153 236310                    LDQ   ! 107,X0,PR0
         2 000300   000000 756300                    STQ   ! 0,,PR0

      159     2670    6                           GLOBAL.ACTIVE.DBCB$=GLOBAL.DB.DBCB$(DBNO);

   2670  2 000301   000161 236310                    LDQ   ! 113,X0,PR0
         2 000302   000001 756300                    STQ   ! 1,,PR0

      160     2671    6                           CALL ZIB$FIXREGS;

   2671  2 000303   000000 631600 3                  EPPR1 ! 0
         2 000304   000000 701200 xent               TSX1  ! ZIB$FIXREGS
         2 000305   000000 011200                    NOP   ! 0

      161     2672    6                           CALL ZIM$FINALL ALTRET(ER_FIN);

   2672  2 000306   000000 631600 3                  EPPR1 ! 0
         2 000307   000000 701200 xent               TSX1  ! ZIM$FINALL
         2 000310   000650 702200 2                  TSX2  ! ER_FIN

      162     2673    6                           END;

      163     2674    5   NEXTDB:             END;

   2674  2 000311   200004 054300       NEXTDB       AOS   ! DBNO,,AUTO
         2 000312   200004 235300                    LDA   ! DBNO,,AUTO
         2 000313   000005 115207                    CMPA  ! 5,DL
         2 000314   000270 604600 2                  TMOZ  ! s:2666

      164     2675    4                   CALL ZIM$CLEANUP;

   2675  2 000315   000000 631600 3                  EPPR1 ! 0
         2 000316   000000 701200 xent               TSX1  ! ZIM$CLEANUP
         2 000317   000000 011200                    NOP   ! 0
PL6.E3A0      #001=ZIO$EVENT File=ZIM$EVENT.:ZIC0TSI                             FRI 09/05/97 12:54 Page:31   

      165     2676    4                   CALL M$EXIT;

   2676  2 000320   000001 713600                    CLIMB ! exit
         2 000321   000000 401760                    pmme    nvectors=0

      166     2677    4                   END;

   2677  2 000322   000456 710200 2                  TRA   ! s:2723

      167     2678    3               ELSE
      168     2679    3                   IF STK$->B$XCON.ECSC=1 OR ZI_USER THEN

   2679  2 000323   300100 720300                    LXL0  ! 64,,PR3
         2 000324   000001 100203                    CMPX0 ! 1,DU
         2 000325   000330 600200 2                  TZE   ! s:2680
         2 000326   000000 234200 xsym               SZN   ! ZI_USER
         2 000327   000333 605200 2                  TPL   ! s:2683

      169     2680    3                       GLOBAL.RET.ERROR#=ERR#X#UNEX;

   2680  2 000330   210664 235207                    LDA   ! 70068,DL
         2 000331   400006 755300                    STA   ! 6,,PR4
         2 000332   000456 710200 2                  TRA   ! s:2723

      170     2681    4                   ELSE DO;

      171     2682        /*                ASL exit */
      172     2683    4                       CALL ZID$ASTATS; /* For possible interupted call */

   2683  2 000333   000000 631600 3                  EPPR1 ! 0
         2 000334   000000 701200 xent               TSX1  ! ZID$ASTATS
         2 000335   000000 011200                    NOP   ! 0

      173     2684    4                       IF STK$->B$XCON.RNST.MABRT AND ~STK$->B$XCON.RNST.HANGUP THEN

   2684  2 000336   200005 470700                    LDP0  ! STK$,,AUTO
PL6.E3A0      #001=ZIO$EVENT File=ZIM$EVENT.:ZIC0TSI                             FRI 09/05/97 12:54 Page:32   
         2 000337   000101 236300                    LDQ   ! 65,,PR0
         2 000340   010000 316203                    CANQ  ! 4096,DU
         2 000341   000353 600200 2                  TZE   ! s:2689
         2 000342   000101 236300                    LDQ   ! 65,,PR0
         2 000343   000001 736200                    QLS   ! 1
         2 000344   400000 376203                    ANQ   ! -131072,DU
         2 000345   400000 676203                    ERQ   ! -131072,DU
         2 000346   000353 600200 2                  TZE   ! s:2689

      174     2685        /*                   Not clean.  Set new error code */
      175     2686    4                           GLOBAL.RET.ERROR#=ERR#X#ASL;

   2686  2 000347   303345 235207                    LDA   ! 100069,DL
         2 000350   000000 471600 xsym               LDP1  ! GLOBAL$
         2 000351   100006 755300                    STA   ! 6,,PR1
         2 000352   000456 710200 2                  TRA   ! s:2723

      176     2687    4                       ELSE
      177     2688        /*                      Check for continuation conditions */
      178     2689    4                           IF ~STK$->B$XCON.CECCB.PROG AND

   2689  2 000353   000100 236300                    LDQ   ! 64,,PR0
         2 000354   400000 376203                    ANQ   ! -131072,DU
         2 000355   400000 676203                    ERQ   ! -131072,DU
         2 000356   000430 600200 2                  TZE   ! s:2701
         2 000357   000100 236300                    LDQ   ! 64,,PR0
         2 000360   000005 736200                    QLS   ! 5
         2 000361   400000 376203                    ANQ   ! -131072,DU
         2 000362   400000 676203                    ERQ   ! -131072,DU
         2 000363   000430 600200 2                  TZE   ! s:2701
         2 000364   000100 236300                    LDQ   ! 64,,PR0
         2 000365   000006 736200                    QLS   ! 6
         2 000366   400000 376203                    ANQ   ! -131072,DU
         2 000367   400000 676203                    ERQ   ! -131072,DU
         2 000370   000430 600200 2                  TZE   ! s:2701
         2 000371   000100 236300                    LDQ   ! 64,,PR0
         2 000372   000007 736200                    QLS   ! 7
PL6.E3A0      #001=ZIO$EVENT File=ZIM$EVENT.:ZIC0TSI                             FRI 09/05/97 12:54 Page:33   
         2 000373   400000 376203                    ANQ   ! -131072,DU
         2 000374   400000 676203                    ERQ   ! -131072,DU
         2 000375   000430 600200 2                  TZE   ! s:2701
         2 000376   000100 236300                    LDQ   ! 64,,PR0
         2 000377   000010 736200                    QLS   ! 8
         2 000400   400000 376203                    ANQ   ! -131072,DU
         2 000401   400000 676203                    ERQ   ! -131072,DU
         2 000402   000430 600200 2                  TZE   ! s:2701
         2 000403   000101 236300                    LDQ   ! 65,,PR0
         2 000404   000003 736200                    QLS   ! 3
         2 000405   400000 376203                    ANQ   ! -131072,DU
         2 000406   400000 676203                    ERQ   ! -131072,DU
         2 000407   000430 600200 2                  TZE   ! s:2701
         2 000410   000101 236300                    LDQ   ! 65,,PR0
         2 000411   000005 736200                    QLS   ! 5
         2 000412   400000 376203                    ANQ   ! -131072,DU
         2 000413   400000 676203                    ERQ   ! -131072,DU
         2 000414   000430 600200 2                  TZE   ! s:2701
         2 000415   000101 236300                    LDQ   ! 65,,PR0
         2 000416   000007 736200                    QLS   ! 7
         2 000417   400000 376203                    ANQ   ! -131072,DU
         2 000420   400000 676203                    ERQ   ! -131072,DU
         2 000421   000430 600200 2                  TZE   ! s:2701
         2 000422   000101 236300                    LDQ   ! 65,,PR0
         2 000423   000010 736200                    QLS   ! 8
         2 000424   400000 376203                    ANQ   ! -131072,DU
         2 000425   400000 676203                    ERQ   ! -131072,DU
         2 000426   000430 600200 2                  TZE   ! s:2701

      179     2690    4                              ~STK$->B$XCON.CECCB.LNK AND
      180     2691    4                              ~STK$->B$XCON.CECCB.SAVE AND
      181     2692    4                              ~STK$->B$XCON.CECCB.CPSAVE AND
      182     2693    4                              ~STK$->B$XCON.CECCB.GET AND
      183     2694    4                              ~STK$->B$XCON.RNST.MONXXX AND
      184     2695    4                              ~STK$->B$XCON.RNST.MABRT AND
      185     2696    4                              ~STK$->B$XCON.RNST.XXX AND
      186     2697    4                              ~STK$->B$XCON.RNST.ERR THEN
PL6.E3A0      #001=ZIO$EVENT File=ZIM$EVENT.:ZIC0TSI                             FRI 09/05/97 12:54 Page:34   
      187     2698        /*                         OK to ignore multiple XCON entry */
      188     2699    4                               RETURN;

   2699  2 000427   000000 702200 xent               TSX2  ! X66_AARET

      189     2700    4                           ELSE
      190     2701    4                               IF STK$->B$XCON.RNST.ERR OR

   2701  2 000430   000101 430300                    FSZN  ! 65,,PR0
         2 000431   000462 604200 2                  TMI   ! ABORT
         2 000432   000000 471600 xsym               LDP1  ! GLOBAL$
         2 000433   100017 236300                    LDQ   ! 15,,PR1
         2 000434   000400 316203                    CANQ  ! 256,DU
         2 000435   000462 601200 2                  TNZ   ! ABORT

      191     2702    4                                  GLOBAL.PENDING.EXIT_DML THEN
      192     2703        /*                            Keep old error code */
      193     2704    4                                   GOTO ABORT;
      194     2705    4                               ELSE
      195     2706    4                                   IF NOT (STK$->B$XCON.CECCB.PROG AND

   2706  2 000436   000100 234300                    SZN   ! 64,,PR0
         2 000437   000442 605200 2                  TPL   ! s:2706+4
         2 000440   100017 430300                    FSZN  ! 15,,PR1
         2 000441   000451 604200 2                  TMI   ! s:2716
         2 000442   102604 235300                    LDA   ! 1412,,PR1
         2 000443   000446 601200 2                  TNZ   ! s:2713
         2 000444   102614 235300                    LDA   ! 1420,,PR1
         2 000445   000451 600200 2                  TZE   ! s:2716

      196     2707    4                                      GLOBAL.PENDING.ROLL) AND
      197     2708    4                                      (GLOBAL.TJRNL.DCB#~=0 OR
      198     2709    4                                      GLOBAL.CAC>0) THEN
      199     2710        /*                               If user level call to rollback finish call. */
      200     2711        /*                               If Tjrnl stop.  We will roll back */
      201     2712        /*                               If CAC and ~Tjrnl no updaters */
      202     2713    4                                       GLOBAL.RET.ERROR#=ERR#X#UNEX;
PL6.E3A0      #001=ZIO$EVENT File=ZIM$EVENT.:ZIC0TSI                             FRI 09/05/97 12:54 Page:35   

   2713  2 000446   210664 235207                    LDA   ! 70068,DL
         2 000447   100006 755300                    STA   ! 6,,PR1
         2 000450   000456 710200 2                  TRA   ! s:2723

      203     2714    5                                   ELSE DO;

      204     2715        /*                               Only choice: try to finish call */
      205     2716    5                                       GLOBAL.PENDING.EXIT_DML=%YES#;

   2716  2 000451   000400 236203                    LDQ   ! 256,DU
         2 000452   100017 256300                    ORSQ  ! 15,,PR1

      206     2717    5                                       GLOBAL.RET.SYSERR#=STK$->B$EXCFR.ERR;

   2717  2 000453   000102 236300                    LDQ   ! 66,,PR0
         2 000454   100007 756300                    STQ   ! 7,,PR1

      207     2718    5                                       RETURN;

   2718  2 000455   000000 702200 xent               TSX2  ! X66_AARET

      208     2719    5                                       END;
      209     2720    4                       END;
      210     2721    3               END; /* CASE */

      211     2722        %EJECT;
PL6.E3A0      #001=ZIO$EVENT File=ZIM$EVENT.:ZIC0TSI                             FRI 09/05/97 12:54 Page:36   
      212     2723    2           GLOBAL.RET.SYSERR#=STK$->B$EXCFR.ERR;

   2723  2 000456   200005 470700                    LDP0  ! STK$,,AUTO
         2 000457   000102 236300                    LDQ   ! 66,,PR0
         2 000460   000000 471600 xsym               LDP1  ! GLOBAL$
         2 000461   100007 756300                    STQ   ! 7,,PR1

      213     2724    2   ABORT:  CALL ZIM$ABORT;

   2724  2 000462   000000 631600 3     ABORT        EPPR1 ! 0
         2 000463   000000 701200 xent               TSX1  ! ZIM$ABORT
         2 000464   000000 011200                    NOP   ! 0

      214     2725    2           GLOBAL.RET.SYSERR#='0'B;

   2725  2 000465   000000 470600 xsym               LDP0  ! GLOBAL$
         2 000466   000007 450300                    STZ   ! 7,,PR0

      215     2726        /*          Call user stats before possible rollback */
      216     2727    2           GLOBAL.FCN.CODE=0;

   2727  2 000467   000000 220203                    LDX0  ! 0,DU
         2 000470   000004 440300                    SXL0  ! 4,,PR0

      217     2728    2           GLOBAL.FCN.DML=%NO#;

   2728  2 000471   000006 236200 3                  LDQ   ! 6
         2 000472   000004 356300                    ANSQ  ! 4,,PR0

      218     2729    2           CALL ZIE$STATS;

   2729  2 000473   000000 631600 3                  EPPR1 ! 0
         2 000474   000000 701200 xent               TSX1  ! ZIE$STATS
         2 000475   000000 011200                    NOP   ! 0

      219     2730        /*          No more accounting for user stats */
      220     2731    2           GLOBAL.PENDING.STATS=%NO#;
PL6.E3A0      #001=ZIO$EVENT File=ZIM$EVENT.:ZIC0TSI                             FRI 09/05/97 12:54 Page:37   

   2731  2 000476   000000 470600 xsym               LDP0  ! GLOBAL$
         2 000477   000011 236200 3                  LDQ   ! 9
         2 000500   000017 356300                    ANSQ  ! 15,,PR0

      221     2732    2           IF STK$->B$XCON.ECSC=0 AND

   2732  2 000501   200005 471700                    LDP1  ! STK$,,AUTO
         2 000502   100100 720300                    LXL0  ! 64,,PR1
         2 000503   000524 601200 2                  TNZ   ! s:2740
         2 000504   000004 236300                    LDQ   ! 4,,PR0
         2 000505   000001 316203                    CANQ  ! 1,DU
         2 000506   000524 600200 2                  TZE   ! s:2740

      222     2733    2              GLOBAL.FCN.DML=%YES# THEN
      223     2734    3           DO; /* ASL domain when abort occured */

      224     2735        /*          For Pederson */
      225     2736    3               CALL BINCHAR(DBSTATUS.STATUS,GLOBAL.RET.ERROR#+

   2736  2 000507   000014 236300                    LDQ   ! 12,,PR0
         2 000510   777777 376207                    ANQ   ! -1,DL
         2 000511   303240 402207                    MPY   ! 100000,DL
         2 000512   000006 036300                    ADLQ  ! 6,,PR0
         2 000513   000000 235203                    LDA   ! 0,DU
         2 000514   200016 757300                    STAQ  ! FPT$ERR+6,,AUTO
         2 000515   000000 473600 xsym               LDP3  ! PS2$
         2 000516   000100 301700                    BTD   !
         2 000517   200016 000010                    NDSC9   FPT$ERR+6,,AUTO          cn=0,s=lsgnf,sf=0,n=8
         2 000520   300000 030007                    NDSC9   0,,PR3                   cn=0,s=nosgn,sf=0,n=7

      226     2737    3                  GLOBAL.RET.STCD#*FTL#ERR#INCR);
      227     2738    3               IA.SYSERR=GLOBAL.RET.SYSERR#;

   2738  2 000521   000007 236300                    LDQ   ! 7,,PR0
         2 000522   000000 473600 xsym               LDP3  ! IA$
         2 000523   300005 756300                    STQ   ! 5,,PR3
PL6.E3A0      #001=ZIO$EVENT File=ZIM$EVENT.:ZIC0TSI                             FRI 09/05/97 12:54 Page:38   

      228     2739    3               END;

      229     2740    2           GLOBAL.RET.ERROR#=0;

   2740  2 000524   000006 450300                    STZ   ! 6,,PR0

      230     2741        /*       Now roll back any updates that made it to physical file */
      231     2742    2           IF GLOBAL.PENDING.ROLL OR GLOBAL.PENDING.RECVRY THEN

   2742  2 000525   000017 430300                    FSZN  ! 15,,PR0
         2 000526   000622 604200 2                  TMI   ! CLEAN
         2 000527   000017 236300                    LDQ   ! 15,,PR0
         2 000530   010000 316203                    CANQ  ! 4096,DU
         2 000531   000622 601200 2                  TNZ   ! CLEAN

      232     2743    2               GOTO CLEAN;
      233     2744    3           IF GLOBAL.TJRNL.DCB#~=0 AND GLOBAL.DB.COUNT~=0 THEN DO;

   2744  2 000532   002604 235300                    LDA   ! 1412,,PR0
         2 000533   000616 600200 2                  TZE   ! s:2767
         2 000534   000075 235300                    LDA   ! 61,,PR0
         2 000535   000616 600200 2                  TZE   ! s:2767

      234     2745    4               IF STK$->B$XCON.RNST.OPXXX AND GLOBAL.UPDATE.TJRNL>0 THEN DO;

   2745  2 000536   100101 234300                    SZN   ! 65,,PR1
         2 000537   000551 605200 2                  TPL   ! s:2750
         2 000540   002613 220300                    LDX0  ! 1419,,PR0
         2 000541   000551 600200 2                  TZE   ! s:2750

      235     2746    4                   GLOBAL.PRINTBUF.BUFFER=

   2746  2 000542   040100 100600                    MLR   ! fill='040'O
         2 000543   000011 000073 1                  ADSC9   FPT_TRMPRG+9             cn=0,n=59
         2 000544   005025 000204                    ADSC9   2581,,PR0                cn=0,n=132

PL6.E3A0      #001=ZIO$EVENT File=ZIM$EVENT.:ZIC0TSI                             FRI 09/05/97 12:54 Page:39   
      236     2747    4                      'IDS rollback in progress-NO more "X" KEYIN on this user.!!!';
      237     2748    4                   CALL M$KEYIN(GLOBAL.KEYIN$->FPT$KEYIN);

   2748  2 000545   005125 473700                    LDP3  ! 2645,,PR0
         2 000546   300000 630700                    EPPR0 ! 0,,PR3
         2 000547   120000 713600                    CLIMB ! 40960
         2 000550   401400 401760                    pmme    nvectors=4

      238     2749    4                   END;

      239     2750    3               IF GLOBAL.UPDATE.TJRNL>0 THEN

   2750  2 000551   000000 470600 xsym               LDP0  ! GLOBAL$
         2 000552   002613 220300                    LDX0  ! 1419,,PR0
         2 000553   000557 600200 2                  TZE   ! s:2754

      240     2751    3                   ERR_CODE=ERR#RL#ATTEMPT; /* TYPE ROLLBACK BE PERFORM MSG */

   2751  2 000554   210755 235207                    LDA   ! 70125,DL
         2 000555   200007 755300                    STA   ! ERR_CODE,,AUTO
         2 000556   000573 710200 2                  TRA   ! s:2760

      241     2752    3               ELSE /* TJRNL IS USED TO LOCK UNPROTECT USERS */
      242     2753    4               DO;

      243     2754    4                   CALL ZIO$FLUSH('1'B) ALTRET(ABORT);

   2754  2 000557   000013 630600 3                  EPPR0 ! 11
         2 000560   000002 631600 3                  EPPR1 ! 2
         2 000561   000000 701200 xent               TSX1  ! ZIO$FLUSH
         2 000562   000462 702200 2                  TSX2  ! ABORT

      244     2755    4                   IF GLOBAL.TJRNL.UNCHECK THEN /* AT UN-CLEAN POINT */

   2755  2 000563   000000 470600 xsym               LDP0  ! GLOBAL$
         2 000564   002606 234300                    SZN   ! 1414,,PR0
         2 000565   000571 605200 2                  TPL   ! s:2758
PL6.E3A0      #001=ZIO$EVENT File=ZIM$EVENT.:ZIC0TSI                             FRI 09/05/97 12:54 Page:40   

      245     2756    4                       ERR_CODE=ERR#RL#LOCKMSG; /* TYPE AREAS BE LOCKED MSG */

   2756  2 000566   210764 235207                    LDA   ! 70132,DL
         2 000567   200007 755300                    STA   ! ERR_CODE,,AUTO
         2 000570   000573 710200 2                  TRA   ! s:2760

      246     2757    4                   ELSE /* TYPE AREAS SHOULD NOT BE LOCKED MSG */
      247     2758    4                       ERR_CODE=ERR#RL#NOLOCK;

   2758  2 000571   210765 235207                    LDA   ! 70133,DL
         2 000572   200007 755300                    STA   ! ERR_CODE,,AUTO

      248     2759    4                   END;

      249     2760    3               CALL ZIM$ERRMSG(ERR_CODE);

   2760  2 000573   200007 631700                    EPPR1 ! ERR_CODE,,AUTO
         2 000574   200016 451700                    STP1  ! FPT$ERR+6,,AUTO
         2 000575   200016 630700                    EPPR0 ! FPT$ERR+6,,AUTO
         2 000576   000002 631600 3                  EPPR1 ! 2
         2 000577   000000 701200 xent               TSX1  ! ZIM$ERRMSG
         2 000600   000000 011200                    NOP   ! 0

      250     2761    3               IF ERR_CODE~=ERR#RL#NOLOCK THEN

   2761  2 000601   200007 235300                    LDA   ! ERR_CODE,,AUTO
         2 000602   210765 115207                    CMPA  ! 70133,DL
         2 000603   000607 600200 2                  TZE   ! s:2763

      251     2762    3                   CALL ZIM$PROL ALTRET(ER_ROLL);

   2762  2 000604   000000 631600 3                  EPPR1 ! 0
         2 000605   000000 701200 xent               TSX1  ! ZIM$PROL
         2 000606   000655 702200 2                  TSX2  ! ER_ROLL

      252     2763    3               GLOBAL.FCN.CODE=1;
PL6.E3A0      #001=ZIO$EVENT File=ZIM$EVENT.:ZIC0TSI                             FRI 09/05/97 12:54 Page:41   

   2763  2 000607   000001 220203                    LDX0  ! 1,DU
         2 000610   000000 470600 xsym               LDP0  ! GLOBAL$
         2 000611   000004 440300                    SXL0  ! 4,,PR0

      253     2764    3               CALL ZID$ASTATS;

   2764  2 000612   000000 631600 3                  EPPR1 ! 0
         2 000613   000000 701200 xent               TSX1  ! ZID$ASTATS
         2 000614   000000 011200                    NOP   ! 0

      254     2765    3               END;

   2765  2 000615   000622 710200 2                  TRA   ! CLEAN

      255     2766    2           ELSE
      256     2767    2               CALL ZIO$FLUSH(%YES#) ALTRET(ABORT);

   2767  2 000616   000013 630600 3                  EPPR0 ! 11
         2 000617   000002 631600 3                  EPPR1 ! 2
         2 000620   000000 701200 xent               TSX1  ! ZIO$FLUSH
         2 000621   000462 702200 2                  TSX2  ! ABORT

      257     2768        /*       Save error for JIT release all memory and exit */
      258     2769    2   CLEAN:  ERROR=GLOBAL.PARAN.IDSERR;

   2769  2 000622   000000 470600 xsym  CLEAN        LDP0  ! GLOBAL$
         2 000623   000074 236300                    LDQ   ! 60,,PR0
         2 000624   200006 756300                    STQ   ! ERROR,,AUTO

      259     2770    2           CALL ZIM$CLEANUP;

   2770  2 000625   000000 631600 3                  EPPR1 ! 0
         2 000626   000000 701200 xent               TSX1  ! ZIM$CLEANUP
         2 000627   000000 011200                    NOP   ! 0

      260     2771    2           FPT$ERR=FPT_ERR;
PL6.E3A0      #001=ZIO$EVENT File=ZIM$EVENT.:ZIC0TSI                             FRI 09/05/97 12:54 Page:42   

   2771  2 000630   000100 100600                    MLR   ! fill='000'O
         2 000631   000000 000030 xsym               ADSC9   FPT_ERR                  cn=0,n=24
         2 000632   200010 000030                    ADSC9   FPT$ERR,,AUTO            cn=0,n=24

      261     2772    2           FPT$ERR.V_=VECTOR(FPT$ERR.V);

   2772  2 000633   000014 235200 3                  LDA   ! 12
         2 000634   200016 452700                    STP2  ! FPT$ERR+6,,AUTO
         2 000635   200016 236300                    LDQ   ! FPT$ERR+6,,AUTO
         2 000636   000014 036203                    ADLQ  ! 12,DU
         2 000637   200010 757300                    STAQ  ! FPT$ERR,,AUTO

      262     2773    2           FPT$ERR.CODE_=VECTOR(ERROR);

   2773  2 000640   777640 235207                    LDA   ! -96,DL
         2 000641   200016 452700                    STP2  ! FPT$ERR+6,,AUTO
         2 000642   200016 236300                    LDQ   ! FPT$ERR+6,,AUTO
         2 000643   000006 036203                    ADLQ  ! 6,DU
         2 000644   200012 757300                    STAQ  ! FPT$ERR+2,,AUTO

      263     2774    2           CALL M$ERR(FPT$ERR);

   2774  2 000645   200010 630700                    EPPR0 ! FPT$ERR,,AUTO
         2 000646   000002 713600                    CLIMB ! err
         2 000647   400400 401760                    pmme    nvectors=2

      264     2775    2   ER_FIN: IF GLOBAL.RET.ERROR#=EXC#ANR THEN

   2775  2 000650   000000 470600 xsym  ER_FIN       LDP0  ! GLOBAL$
         2 000651   000006 235300                    LDA   ! 6,,PR0
         2 000652   021614 115207                    CMPA  ! 9100,DL
         2 000653   000311 600200 2                  TZE   ! NEXTDB

      265     2776    2               GOTO NEXTDB;
      266     2777    2           GOTO ABORT;

PL6.E3A0      #001=ZIO$EVENT File=ZIM$EVENT.:ZIC0TSI                             FRI 09/05/97 12:54 Page:43   
   2777  2 000654   000462 710200 2                  TRA   ! ABORT

      267     2778    2   ER_ROLL: GLOBAL.RET.ERROR#=ERR#X#ROLL;

   2778  2 000655   303346 235207       ER_ROLL      LDA   ! 100070,DL
         2 000656   000000 470600 xsym               LDP0  ! GLOBAL$
         2 000657   000006 755300                    STA   ! 6,,PR0

      268     2779    2           GLOBAL.PENDING.ROLL_ABORTED='1'B;

   2779  2 000660   000040 236203                    LDQ   ! 32,DU
         2 000661   000017 256300                    ORSQ  ! 15,,PR0

      269     2780    2           GOTO ABORT;

   2780  2 000662   000462 710200 2                  TRA   ! ABORT

      270     2781    2           END; /* Inhibit */

      271     2782    1   END ZIO$EVENT;

   2782  2 000663   000000 702200 xent               TSX2  ! X66_AARET

FPT_TRMPRG
 Sect OctLoc
   1     000   000003 777640   000004 006000   000000 177640   000000 006014    ................
   1     004   000000 000000   000000 000000   004000 000000   000000 000000    ................

(unnamed)
 Sect OctLoc
   1     010   000000 020000   111104 123040   162157 154154   142141 143153    ....IDS rollback
   1     014   040151 156040   160162 157147   162145 163163   055116 117040     in progress-NO
   1     020   155157 162145   040042 130042   040113 105131   111116 040157    more "X" KEYIN o
   1     024   156040 164150   151163 040165   163145 162056   041041 041040    n this user.!!!

(unnamed)
 Sect OctLoc
PL6.E3A0      #001=ZIO$EVENT File=ZIM$EVENT.:ZIC0TSI                             FRI 09/05/97 12:54 Page:44   
   3     000   000000 000000   777777 777737   000001 000000   777777 777775    ................
   3     004   777777 577777   777777 377777   777776 777777   000000 006000    ................
   3     010   000000 006014   757777 777777   400000 000000   000012 006000    ................
   3     014   000001 777640                                                    ....

PL6.E3A0      #001=ZIO$EVENT File=ZIM$EVENT.:ZIC0TSI                             FRI 09/05/97 12:54 Page:45   
--  Include file information  --

   ZI$USER.:ZIC0TOU  is referenced.
   ZI$GLOBAL.:ZIC0TOU  is referenced.
   ZI_ERRORS_C.:ZIC0TOU  is referenced.
   CP_6_SUBS.:LIB_E05  is referenced.
   CP_6.:LIB_E05  cannot be made into a system file and is referenced.
   B$JIT.:LIB_E05  cannot be made into a system file and is referenced.
   B$JIT_C.:E05TOU  was found in the system file and is referenced.
   CP_6_C.:E05TOU  was found in the system file and is referenced.
      No diagnostics issued in procedure ZIO$EVENT.

   Procedure ZIO$EVENT requires 436 words for executable code.
   Procedure ZIO$EVENT requires 16 words of local(AUTO) storage.

    No errors detected in file ZIM$EVENT.:ZIC0TSI    .
PL6.E3A0      #001=ZIO$EVENT File=ZIM$EVENT.:ZIC0TSI                             FRI 09/05/97 12:54 Page:46   
          *** CROSS REFERENCE LISTING ***
**     DENOTES     IDENTIFIER DEFINITION
<<                 IDENTIFIER'S VALUE SET
>>                 IDENTIFIER'S VALUE USED
<>                 IDENTIFIER SET AND/OR USED
--                 IDENTIFIER REFERENCED
PL6.E3A0      #001=ZIO$EVENT File=ZIM$EVENT.:ZIC0TSI                             FRI 09/05/97 12:54 Page:47   
          MINI XREF LISTING

ABORT
      2724**LABEL    2580--GOTO     2664--CALLALT  2704--GOTO     2754--CALLALT  2767--CALLALT  2777--GOTO
      2780--GOTO
B$ECCB.XCONF.NOTCB
       652**DCL      2576>>IF
B$ECCB$
        23**DCL      2576>>IF
B$EVNT.CODE
       532**DCL       532--REDEF     533--REDEF     533--REDEF
B$EVNT.ERR.ERR#
       534**DCL       534--REDEF
B$EVNT.EVID
       533**DCL       533--REDEF     533--REDEF
B$EVNT.EVSC
       533**DCL      2625>>IF
B$EXCFR.ASL
       544**DCL       544--REDEF
B$EXCFR.ECC
       544**DCL      2584>>DOCASE
B$EXCFR.ERR
       558**DCL      2717>>ASSIGN   2723>>ASSIGN
B$EXCFR.ERR.ERR#
       558**DCL       558--REDEF
B$EXCFR.EVID
       557**DCL       557--REDEF     558--REDEF
B$EXCFR.IR
       545**DCL       545--REDEF    2592>>ASSIGN
B$EXCFR.PREVSZ
       544**DCL       544--REDEF
B$EXCFR.SUBC
       556**DCL       556--REDEF     557--REDEF     557--REDEF    2588>>IF       2597>>DOCASE   2607>>IF
B$JIT.CPFLAGS1
PL6.E3A0      #001=ZIO$EVENT File=ZIM$EVENT.:ZIC0TSI                             FRI 09/05/97 12:54 Page:48   
       143**DCL      2650>>IF
B$JIT.CPFLAGS1.SLEAZE
       148**DCL       148--REDEF
B$JIT.ERR.MID
        55**DCL        55--REDEF
B$JIT.JRESPEAK
       216**DCL       217--REDEF
B$JIT.ORIGINATOR_PORT.FROM_CR
       325**DCL       325--REDEF     326--REDEF
B$JIT.PNR
       229**DCL       229--REDEF
B$JIT.TSLINE
       323**DCL       324--REDEF
B$JIT$
        29**DCL        49--IMP-PTR  2650>>IF
B$NWIO.CGPARM.MSGIDXT
       595**DCL       598--REDEF
B$NWIO.CODE
       564**DCL       564--REDEF     565--REDEF     565--REDEF
B$NWIO.ERR.CODE
       566**DCL      2625>>IF
B$NWIO.ERR.ERR#
       566**DCL       566--REDEF
B$NWIO.EVID
       565**DCL       565--REDEF     565--REDEF    2625>>IF       2625>>IF       2630>>ASSIGN   2631>>ASSIGN
      2632>>ASSIGN   2632>>ASSIGN
B$TCB.ALT$
       647**DCL      2579>>ASSIGN
B$TCB.STK$
       647**DCL      2582>>ASSIGN
B$TCB$
        28**DCL      2579>>ASSIGN   2582>>ASSIGN
B$XCON.CECCB.CPSAVE
       522**DCL      2650>>IF       2689>>IF
B$XCON.CECCB.GET
       522**DCL      2650>>IF       2689>>IF
PL6.E3A0      #001=ZIO$EVENT File=ZIM$EVENT.:ZIC0TSI                             FRI 09/05/97 12:54 Page:49   
B$XCON.CECCB.LIMIT
       521**DCL      2650>>IF
B$XCON.CECCB.LNK
       521**DCL      2650>>IF       2689>>IF
B$XCON.CECCB.PROG
       521**DCL      2650>>IF       2689>>IF       2706>>IF
B$XCON.CECCB.SAVE
       522**DCL      2650>>IF       2689>>IF
B$XCON.ECSC
       522**DCL      2679>>IF       2732>>IF
B$XCON.ERR.ERR#
       527**DCL       527--REDEF
B$XCON.LIMIT.MEM
       525**DCL       525--REDEF
B$XCON.RNST
       522**DCL      2650>>IF
B$XCON.RNST.ERR
       523**DCL      2689>>IF       2701>>IF
B$XCON.RNST.HANGUP
       522**DCL      2684>>IF
B$XCON.RNST.MABRT
       523**DCL      2684>>IF       2689>>IF
B$XCON.RNST.MONXXX
       523**DCL      2689>>IF
B$XCON.RNST.OPXXX
       522**DCL      2745>>IF
B$XCON.RNST.XXX
       523**DCL      2689>>IF
B$XCON.XCONF.QUIT
       524**DCL      2650>>IF
BLOCK.PSTAMP
      2369**DCL      2632<<ASSIGN
BRK_RTN
      2618**LABEL    2616--CALLALT
CLEAN
      2769**LABEL    2743--GOTO
PL6.E3A0      #001=ZIO$EVENT File=ZIM$EVENT.:ZIC0TSI                             FRI 09/05/97 12:54 Page:50   
DBNO
        32**DCL      2665<<DOINDEX  2666>>IF       2668>>ASSIGN   2669>>ASSIGN   2670>>ASSIGN
DBSTATUS.STATUS
        38**DCL      2736<<CALLBLT
ERROR
        35**DCL      2769<<ASSIGN   2773--ASSIGN
ERR_CODE
        36**DCL      2751<<ASSIGN   2756<<ASSIGN   2758<<ASSIGN   2760<>CALL     2761>>IF
ER_FIN
      2775**LABEL    2672--CALLALT
ER_ROLL
      2778**LABEL    2762--CALLALT
FPT$ERR
       451**DCL      2771<<ASSIGN   2774<>CALL
FPT$ERR.CODE_
       451**DCL      2773<<ASSIGN
FPT$ERR.V
       451**DCL      2772--ASSIGN
FPT$ERR.V.STEPCC#
       452**DCL       452--REDEF
FPT$ERR.V_
       451**DCL      2772<<ASSIGN
FPT$KEYIN
       512**DCL      2748<>CALL
FPT$TRTN
       481**DCL      2594<>CALL
FPT$TRTN.V.IR#
       482**DCL       483--REDEF    2592<<ASSIGN
FPT$TRTN.V.IRBIT#.MIR
       484**DCL      2593<<ASSIGN
FPT_ERR
       466**DCL      2771>>ASSIGN
FPT_ERR.V.STEPCC#
       467**DCL       467--REDEF
FPT_TRMPRG
       427**DCL      2616<>CALL
PL6.E3A0      #001=ZIO$EVENT File=ZIM$EVENT.:ZIC0TSI                             FRI 09/05/97 12:54 Page:51   
FPT_TRMPRG.V
       434**DCL       429--DCLINIT
FPT_TRMPRG.V.CTLFLG.RSTBRK#
       435**DCL       436--REDEF
GLOBAL.ACTIVE.DBCB$
      2063**DCL      2064--REDEF    2670<<ASSIGN
GLOBAL.ACTIVE.DBNO
      2067**DCL      2668<<ASSIGN
GLOBAL.ACTIVE.SSS$
      2059**DCL      2060--REDEF    2669<<ASSIGN
GLOBAL.BCB.BUF.BUF$
      2170**DCL      2632>>ASSIGN
GLOBAL.BCB.BUF.STATUS.BUSY
      2177**DCL      2625>>IF       2631<<ASSIGN
GLOBAL.BCB.BUF.STATUS.MODIFY
      2178**DCL      2630<<ASSIGN
GLOBAL.BCB.COUNT
      2166**DCL      2625>>IF
GLOBAL.CAC
      2258**DCL      2706>>IF
GLOBAL.DB.COUNT
      2154**DCL      2744>>IF
GLOBAL.DB.DBCB$
      2157**DCL      2670>>ASSIGN
GLOBAL.DB.SSS$
      2156**DCL      2665--DOINDEX  2665--DOINDEX  2666>>IF       2669>>ASSIGN
GLOBAL.FCN.CODE
      2072**DCL      2662<<ASSIGN   2727<<ASSIGN   2763<<ASSIGN
GLOBAL.FCN.DML
      2071**DCL      2663<<ASSIGN   2728<<ASSIGN   2732>>IF
GLOBAL.INHIB.BREAK
      2089**DCL      2614<<ASSIGN
GLOBAL.INHIB.DUMP
      2088**DCL      2615<<ASSIGN
GLOBAL.KEY
      2267**DCL      2270--REDEF
PL6.E3A0      #001=ZIO$EVENT File=ZIM$EVENT.:ZIC0TSI                             FRI 09/05/97 12:54 Page:52   
GLOBAL.KEYIN$
      2345**DCL      2748>>CALL
GLOBAL.PARAN.IDSERR
      2152**DCL      2769>>ASSIGN
GLOBAL.PARAN.TRACE.MODE
      2142**DCL      2149--REDEF
GLOBAL.PENDING.EXIT_DML
      2099**DCL      2701>>IF       2716<<ASSIGN
GLOBAL.PENDING.RECVRY
      2095**DCL      2742>>IF
GLOBAL.PENDING.ROLL
      2098**DCL      2706>>IF       2742>>IF
GLOBAL.PENDING.ROLL_ABORTED
      2102**DCL      2779<<ASSIGN
GLOBAL.PENDING.STATS
      2094**DCL      2731<<ASSIGN
GLOBAL.PENDING.XCON
      2096**DCL      2640<<ASSIGN
GLOBAL.PRINTBUF.BUFFER
      2301**DCL      2302--REDEF    2303--REDEF    2304--REDEF    2746<<ASSIGN
GLOBAL.PRINTBUF.ERR.V
      2306**DCL      2309--REDEF    2310--REDEF    2311--REDEF
GLOBAL.RET.ERROR#
      2077**DCL      2578<<ASSIGN   2591<<ASSIGN   2602<<ASSIGN   2608<<ASSIGN   2610<<ASSIGN   2637<<ASSIGN
      2661<<ASSIGN   2680<<ASSIGN   2686<<ASSIGN   2713<<ASSIGN   2736>>CALLBLT  2740<<ASSIGN   2775>>IF
      2778<<ASSIGN
GLOBAL.RET.STCD#
      2084**DCL      2736>>CALLBLT
GLOBAL.RET.SYSERR#
      2078**DCL      2717<<ASSIGN   2723<<ASSIGN   2725<<ASSIGN   2738>>ASSIGN
GLOBAL.TJRNL.DCB#
      2246**DCL      2706>>IF       2744>>IF
GLOBAL.TJRNL.UNCHECK
      2248**DCL      2755>>IF
GLOBAL.TRTN$
      2347**DCL      2592>>ASSIGN   2593>>ASSIGN   2594>>CALL
PL6.E3A0      #001=ZIO$EVENT File=ZIM$EVENT.:ZIC0TSI                             FRI 09/05/97 12:54 Page:53   
GLOBAL.UPDATE.TJRNL
      2256**DCL      2745>>IF       2750>>IF
GLOBAL$
      2361**DCL      2057--IMP-PTR  2578>>ASSIGN   2591>>ASSIGN   2592>>ASSIGN   2593>>ASSIGN   2594>>CALL
      2602>>ASSIGN   2608>>ASSIGN   2610>>ASSIGN   2614>>ASSIGN   2615>>ASSIGN   2625>>IF       2625>>IF
      2630>>ASSIGN   2631>>ASSIGN   2632>>ASSIGN   2637>>ASSIGN   2640>>ASSIGN   2661>>ASSIGN   2662>>ASSIGN
      2663>>ASSIGN   2666>>IF       2668>>ASSIGN   2669>>ASSIGN   2669>>ASSIGN   2670>>ASSIGN   2670>>ASSIGN
      2680>>ASSIGN   2686>>ASSIGN   2701>>IF       2706>>IF       2706>>IF       2706>>IF       2713>>ASSIGN
      2716>>ASSIGN   2717>>ASSIGN   2723>>ASSIGN   2725>>ASSIGN   2727>>ASSIGN   2728>>ASSIGN   2731>>ASSIGN
      2732>>IF       2736>>CALLBLT  2736>>CALLBLT  2738>>ASSIGN   2740>>ASSIGN   2742>>IF       2742>>IF
      2744>>IF       2744>>IF       2745>>IF       2746>>ASSIGN   2748>>CALL     2750>>IF       2755>>IF
      2763>>ASSIGN   2769>>ASSIGN   2775>>IF       2778>>ASSIGN   2779>>ASSIGN
IA.SNAME
      2549**DCL      2550--REDEF
IA.SSDT
      2561**DCL      2562--REDEF
IA.SSNAME
      2552**DCL      2553--REDEF
IA.SYSERR
      2535**DCL      2738<<ASSIGN
IA$
      2563**DCL      2528--IMP-PTR  2738>>ASSIGN
M$ERR
       351**DCL-ENT  2774--CALL
M$EXIT
       351**DCL-ENT  2676--CALL
M$KEYIN
       344**DCL-ENT  2748--CALL
M$TRMPRG
       364**DCL-ENT  2616--CALL
NEXTDB
      2674**LABEL    2776--GOTO
P$
        24**DCL        25--REDEF
PS2$
        34**DCL        37--IMP-PTR  2736>>CALLBLT
PL6.E3A0      #001=ZIO$EVENT File=ZIM$EVENT.:ZIC0TSI                             FRI 09/05/97 12:54 Page:54   
STK$
        33**DCL      2579<<ASSIGN   2582<<ASSIGN   2584>>DOCASE   2588>>IF       2592>>ASSIGN   2597>>DOCASE
      2607>>IF       2625>>IF       2625>>IF       2625>>IF       2625>>IF       2630>>ASSIGN   2631>>ASSIGN
      2632>>ASSIGN   2632>>ASSIGN   2650>>IF       2650>>IF       2650>>IF       2650>>IF       2650>>IF
      2650>>IF       2650>>IF       2650>>IF       2679>>IF       2684>>IF       2684>>IF       2689>>IF
      2689>>IF       2689>>IF       2689>>IF       2689>>IF       2689>>IF       2689>>IF       2689>>IF
      2689>>IF       2701>>IF       2706>>IF       2717>>ASSIGN   2723>>ASSIGN   2732>>IF       2745>>IF
X66_TRTN
        18**DCL-ENT  2594--CALL
ZIB$FIXPR5
        19**DCL-ENT  2575--CALL
ZIB$FIXREGS
        20**DCL-ENT  2671--CALL
ZID$ASTATS
        22**DCL-ENT  2683--CALL     2764--CALL
ZIE$STATS
        21**DCL-ENT  2729--CALL
ZIM$ABORT
        10**DCL-ENT  2724--CALL
ZIM$CHKPT
        13**DCL-ENT  2664--CALL
ZIM$CLEANUP
        14**DCL-ENT  2675--CALL     2770--CALL
ZIM$ERRMSG
        12**DCL-ENT  2760--CALL
ZIM$FINALL
        15**DCL-ENT  2672--CALL
ZIM$FPTCHKR
        11**DCL-ENT  2600--CALL
ZIM$PROL
        17**DCL-ENT  2762--CALL
ZIO$FLUSH
        16**DCL-ENT  2754--CALL     2767--CALL
ZI_FPTCHKR
        30**DCL      2599>>IF
ZI_USER
PL6.E3A0      #001=ZIO$EVENT File=ZIM$EVENT.:ZIC0TSI                             FRI 09/05/97 12:54 Page:55   
        31**DCL      2679>>IF
