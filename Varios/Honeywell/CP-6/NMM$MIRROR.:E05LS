VERSION E05

PL6.E3A0      #001=NMM$DONT_MIRROR File=NMM$MIRROR.:E05TSI                       WED 07/30/97 03:49 Page:1    
        1        1        /*M* NMM$DONT_MIRROR - Perform MIRROR DONT MIRROR operation.       */
        2        2        /*T***********************************************************/
        3        3        /*T*                                                         */
        4        4        /*T* Copyright (c) Bull HN Information Systems Inc., 1997    */
        5        5        /*T*                                                         */
        6        6        /*T***********************************************************/
        7        7        /*X* DFC=YES, DMC=YES, EDMC=YES                                    */
        8        8        /*F*
        9        9        NAME:           NMM$DONT_MIRROR
       10       10
       11       11        PURSPOSE:       To MIRROR DONT MIRROR operation.
       12       12        */
       13       13        /*D*
       14       14        NAME:           NMM$DONT_MIRROR
       15       15
       16       16        CALL:           CALL NMM$DONT_MIRROR ALTRET ( error ) ;
       17       17
       18       18        PARAMETERS:     None.
       19       19
       20       20        DESCRIPTION:
       21       21
       22       22        The NMM$DONT_MIRROR procedure is used to terminate either
       23       23        the Mirrored Disk operation between two Mirrored Disk devices,
       24       24        or the WAIT state for a Mirrored Disk whose Mirror cannot be
       25       25        found.
       26       26
       27       27        DPxx must be a Mirrored Disk that is OPERational or
       28       28        WAITing.
       29       29
       30       30        The DCT and VIDs for DPxx will be changed to be a
       31       31        nonmirrored disk device.
       32       32
       33       33        The DCT for DPyy will be changed to be a
       34       34        nonmirrored disk device.  The VID for DPyy will be
       35       35        changed to be a failed Mirrored Disk device.
       36       36
       37       37        */
PL6.E3A0      #001=NMM$DONT_MIRROR File=NMM$MIRROR.:E05TSI                       WED 07/30/97 03:49 Page:2    
       38       38        %EJECT ;
PL6.E3A0      #001=NMM$DONT_MIRROR File=NMM$MIRROR.:E05TSI                       WED 07/30/97 03:49 Page:3    
       39       39        NMM$DONT_MIRROR:        PROC            ALTRET ;
       40       40        /*
       41       41                        Includes
       42       42        */
       43       43        %INCLUDE                CP_6 ;
       44     5602        %INCLUDE                FM$GRAN ;
       45     5671        %INCLUDE                NI$TABLES ;
       46     5887        %INCLUDE                NI_DATA_C ;
       47     6000        %INCLUDE                NM_MACRO_M ;
       48     7405        %INCLUDE                NM_PERR_C ;
       49     7482        %INCLUDE                XU_MACRO_C ;
       50    10588        /*
       51    10589                        Entries
       52    10590        */
       53    10591    1   DCL 1 NME$ERRMSG        ENTRY(6) ;
       54    10592    1   DCL 1 NMO$DCT           ENTRY(2) ALTRET ;
       55    10593    1   DCL 1 NMO$DEV           ENTRY(2) ALTRET ;
       56    10594    1   DCL 1 NMU$ABORT         ENTRY(2) ALTRET ;
       57    10595    1   DCL 1 NMU$CHGSTATEMSG   ENTRY(2) ALTRET ;
       58    10596    1   DCL 1 NMU$LOCK          ENTRY(1) ALTRET ;
       59    10597    1   DCL 1 NMU$READ          ENTRY(3) ALTRET ;
       60    10598    1   DCL 1 NMU$SCRUB_VID     ENTRY(2) ;
       61    10599    1   DCL 1 NMU$UNLOCK        ENTRY(1) ALTRET ;
       62    10600    1   DCL 1 NMU$WRITE         ENTRY(3) ALTRET ;
       63    10601    1   DCL 1 NMV$MIRRORED      ENTRY(1) ALTRET ;
       64    10602    1   DCL 1 NMV$STATE         ENTRY(3) ALTRET ;
       65    10603        /*
       66    10604                        Variables
       67    10605        */
       68    10606                                %B$ALT ( NAME =
       69    10607              B$ALT             ,     STCLASS=BASED
       70    10608                                                                        ) ;
       71    10616                                %B$TCB  ( NAME =
       72    10617              B$TCB             , STCLASS = "BASED(B$TCB$)"
       73    10618                                                                        ) ;
       74    10621    1   DCL 1 B$TCB$            PTR SYMREF ;
       75    10622                                %FPT_MIRROR ( FPTN =
PL6.E3A0      #001=NMM$DONT_MIRROR File=NMM$MIRROR.:E05TSI                       WED 07/30/97 03:49 Page:4    
       76    10623              BREAK             , STCLASS = STATIC
       77    10624                                , DCTX = 0
       78    10625                                , FUNCTION = BREAK
       79    10626                                , MDCTX = 0
       80    10627                                , UTS = 0
       81    10628                                                                        ) ;
       82    10651                                %NI$DCT ( NAME =
       83    10652              DCT               , STCLASS = BASED
       84    10653                                                                        ) ;
       85    10701                                %FM$VID ( FM$VID =
       86    10702              FM$VID            , BASED = BASED
       87    10703                                                                        ) ;
       88    10709    1   DCL 1 I                 SBIN WORD ALIGNED AUTO ;
       89    10710                                %NMD_PIT ( FPTN =
       90    10711              NMD_PIT           , STCLASS=SYMREF
       91    10712                                                                        ) ;
       92    11165                                %PARSE$OUT ( NAME =
       93    11166              OUT               , STCLASS ="BASED(XUG_GETCMD.OUT$)"
       94    11167                                                                        ) ;
       95    11212                                %FPT_TIME ( FPTN =
       96    11213              TIME              , STCLASS = CONSTANT
       97    11214                                , DEST = UTS
       98    11215                                , SOURCE = CLOCK
       99    11216                                , TSTAMP = UTS
      100    11217                                                                        ) ;
      101    11236    1   DCL 1 UTS               UBIN WORD ALIGNED STATIC ;
      102    11237                                %XUG_GETCMD ( NAME =
      103    11238              XUG_GETCMD        , STCLASS = SYMREF
      104    11239                                                                        ) ;
      105    11577        %EJECT ;
PL6.E3A0      #001=NMM$DONT_MIRROR File=NMM$MIRROR.:E05TSI                       WED 07/30/97 03:49 Page:5    
      106    11578        /*
      107    11579        Process the devices and options specified on the command.
      108    11580        */
      109    11581    1           CALL NMO$DEV ( 0, OUT.SUBLK$(0) )       ALTRET ( ERROR ) ;
      110    11582        /*
      111    11583        Get UTS for this operation.
      112    11584        */
      113    11585    1           CALL M$TIME ( TIME )                    ALTRET ( ALTERR ) ;
      114    11586        /*
      115    11587        Determine if this is a Mirrored Disk device or not.
      116    11588        */
      117    11589    1           IF  NMD_PIT.DEV.DCT$(0)->DCT.DP.MIRROR.FLAG
      118    11590    2           THEN DO ;
      119    11591        /*
      120    11592        A Mirrored Disk device must be OPERational.
      121    11593        */
      122    11594    2               CALL NMV$STATE ( 0, %NI_MIRROR_OPER )
      123    11595    2                                                   ALTRET ( ERROR ) ;
      124    11596        /*
      125    11597        Get information for other Mirrored Disk device.
      126    11598        */
      127    11599    2               CALL NMO$DCT ( 1, NMD_PIT.DEV.MDCTX(0) )
      128    11600    2                                                   ALTRET ( ERROR ) ;
      129    11601    2               END ;
      130    11602        /*
      131    11603        If this is not a Mirrored Disk device, it must be WAITing.
      132    11604        */
      133    11605    2           ELSE DO ;
      134    11606    2               CALL NMV$STATE ( 0, %NI_MIRROR_WAIT )
      135    11607    2                                                   ALTRET ( ERROR ) ;
      136    11608        /*
      137    11609        Specify that there is no other device.
      138    11610        */
      139    11611    2               NMD_PIT.DEV.DCTX(1) = 0 ;
      140    11612    2               NMD_PIT.DEV.DCT$(1) = ADDR(NIL) ;
      141    11613    2               NMD_PIT.DEV.DVT$(1) = ADDR(NIL) ;
      142    11614    2               END ;
PL6.E3A0      #001=NMM$DONT_MIRROR File=NMM$MIRROR.:E05TSI                       WED 07/30/97 03:49 Page:6    
      143    11615        /*
      144    11616        Read, modify, and rewrite the VID for this device.
      145    11617        CANNOT TOLERATE AN ERROR ON THE REWRITE OF THE VID!!!!
      146    11618        */
      147    11619    1           CALL NMU$READ ( 0, 0, NMD_PIT.DEV.VID_(0) )
      148    11620    1                                                   ALTRET ( ERROR ) ;
      149    11621    1           NMD_PIT.DEV.VID$(0)->FM$VID.MIRROR.STATE(1) = %NI_MIRROR_FAIL ;
      150    11622    1           NMD_PIT.DEV.VID$(0)->FM$VID.MIRROR.UTS      = UTS ;
      151    11623    1           CALL NMU$WRITE ( 0, 0, NMD_PIT.DEV.VID_(0) )
      152    11624    1                                                   ALTRET ( ERROR ) ;
      153    11625        /*
      154    11626        If there is another device (i.e., this device is not WAITing),
      155    11627        read, modify, and rewrite the VID for the other device.
      156    11628        CANNOT TOLERATE AN ERROR ON THE REWRITE OF THE VID!!!!
      157    11629        */
      158    11630    1           IF  NMD_PIT.DEV.DCTX(1) ~= 0
      159    11631    2           THEN DO ;
      160    11632    2               CALL NMU$READ      ( 1, 0, NMD_PIT.DEV.VID_(1) )
      161    11633    2                                                   ALTRET ( ERROR ) ;
      162    11634    2               CALL NMU$SCRUB_VID ( 1, UTS ) ;
      163    11635    2               CALL NMU$WRITE     ( 1, 0, NMD_PIT.DEV.VID_(1) )
      164    11636    2                                                   ALTRET ( ERROR ) ;
      165    11637    2               CALL NMU$CHGSTATEMSG ( 1, %NI_MIRROR_FAIL ) ;
      166    11638    2               END ;
      167    11639        /*
      168    11640        Issue PMME to dissolve the Mirrored Disk pair.
      169    11641        */
      170    11642    1           BREAK.V.DCTX#  = NMD_PIT.DEV.DCTX(0) ;
      171    11643    1           BREAK.V.MDCTX# = NMD_PIT.DEV.DCTX(1) ;
      172    11644    1           BREAK.V.UTS#   = UTS ;
      173    11645    1           CALL M$MIRROR ( BREAK )                 ALTRET ( ALTERR ) ;
      174    11646        /*
      175    11647        Output message detailing new state of the Mirrored Disk device(s).
      176    11648        */
      177    11649    1           CALL NMU$CHGSTATEMSG ( 0, %NI_MIRROR_NONE ) ;
      178    11650    1           IF  NMD_PIT.DEV.DCTX(1) ~= 0
      179    11651    1           THEN
PL6.E3A0      #001=NMM$DONT_MIRROR File=NMM$MIRROR.:E05TSI                       WED 07/30/97 03:49 Page:7    
      180    11652    1               CALL NMU$CHGSTATEMSG ( 1, %NI_MIRROR_NONE ) ;
      181    11653        /*
      182    11654        Return to the calling procedure.
      183    11655        */
      184    11656    1           RETURN ;
      185    11657
      186    11658    1   ALTERR: CALL NME$ERRMSG ( B$TCB.ALT$->B$ALT.ERR ) ;
      187    11659
      188    11660    1   ERROR:  ALTRETURN ;
      189    11661
      190    11662    1           END NMM$DONT_MIRROR ;
      191    11663        %EOD ;

PL6.E3A0      #001=NMM$DONT_MIRROR File=NMM$MIRROR.:E05TSI                       WED 07/30/97 03:49 Page:8    
--  Include file information  --

   XU_MACRO_C.:E05TOU  is referenced.
   NM_PERR_C.:E05TOU  is referenced.
   NM_SUBS_C.:E05TOU  is referenced.
   NM_EQU_E.:E05TOU  is referenced.
   CP_6_SUBS.:E05TOU  is referenced.
   NM_MACRO_M.:E05TOU  is referenced.
   NI_DATA_C.:E05TOU  is referenced.
   NI$TABLES.:E05TOU  is referenced.
   FM$GRAN.:E05TOU  is referenced.
   CP_6_C.:E05TOU  is referenced.
   CP_6.:E05TOU  cannot be made into a system file and is referenced.
      No diagnostics issued in procedure NMM$DONT_MIRROR.

   Procedure NMM$DONT_MIRROR requires 95 words for executable code.
   Procedure NMM$DONT_MIRROR requires 6 words of local(AUTO) storage.

PL6.E3A0      #001=NMM$DONT_MIRROR File=NMM$MIRROR.:E05TSI                       WED 07/30/97 03:49 Page:9    

 Object Unit name= NMM$DONT_MIRROR                            File name= NMM$MIRROR.:E05TOU
 UTS= JUL 30 '97 03:49:12.92 WED                              Compiler= PL-6/E31         Sev=      00
 SharedLib= :SHARED_SYSTEM                                    Alt SharedLib=


    ****  Control sections  ****

 Sect   Type Bound  Init  Size OctSiz  Section name(segment info)
    0   DCB   even  none     0      0  M$UC
    1   Data  even  none     7      7  NMM$DONT_MIRROR
    2  RoData even  UTS     12     14  NMM$DONT_MIRROR
    3   Proc  even  none    95    137  NMM$DONT_MIRROR
    4  RoData even  none    21     25  NMM$DONT_MIRROR

    ****  Entry defs  ****

                              Check   Calling
                             calling  sequence
  Sect OctLoc Primary Altret sequence   type   Parms  Name
     3      0   yes    yes     yes      Std        0  NMM$DONT_MIRROR
PL6.E3A0      #001=NMM$DONT_MIRROR File=NMM$MIRROR.:E05TSI                       WED 07/30/97 03:49 Page:10   

  ****  Entry refs  ****

         Check        Calling
        calling       sequence
Altret sequence SRef   type   Args  Name
 yes     yes           Std       2 NMO$DEV
 yes     yes           Std       2 NMO$DCT
 yes     yes           Std       3 NMU$READ
 yes     yes           Std       3 NMU$WRITE
 yes     yes           Std       2 NMU$CHGSTATEMSG
 yes     yes           Std       3 NMV$STATE
         yes           Std       2 NMU$SCRUB_VID
         yes           Std       6 NME$ERRMSG
                       nStd      0 X66_AUTO_0
                       Std       0 B_CONSPOOL_D
                       nStd      0 X66_ARET
                       nStd      0 X66_AALT

  ****  Data refs  ****

  Flags:  r = read only, s = secondary
Flgs Name                             Flgs Name                             Flgs Name
     M$UC                                  B$TCB$                                NMD_PIT
     XUG_GETCMD                            B_VECTNIL

  ****  Segment refs  ****

  Flags:  r = read only, s = secondary
Flgs Name                             Flgs Name                             Flgs Name
     ISSID                                 NULLSID
PL6.E3A0      #001=NMM$DONT_MIRROR File=NMM$MIRROR.:E05TSI                       WED 07/30/97 03:49 Page:11   


        1        1        /*M* NMM$DONT_MIRROR - Perform MIRROR DONT MIRROR operation.       */
        2        2        /*T***********************************************************/
        3        3        /*T*                                                         */
        4        4        /*T* Copyright (c) Bull HN Information Systems Inc., 1997    */
        5        5        /*T*                                                         */
        6        6        /*T***********************************************************/
        7        7        /*X* DFC=YES, DMC=YES, EDMC=YES                                    */
        8        8        /*F*
        9        9        NAME:           NMM$DONT_MIRROR
       10       10
       11       11        PURSPOSE:       To MIRROR DONT MIRROR operation.
       12       12        */
       13       13        /*D*
       14       14        NAME:           NMM$DONT_MIRROR
       15       15
       16       16        CALL:           CALL NMM$DONT_MIRROR ALTRET ( error ) ;
       17       17
       18       18        PARAMETERS:     None.
       19       19
       20       20        DESCRIPTION:
       21       21
       22       22        The NMM$DONT_MIRROR procedure is used to terminate either
       23       23        the Mirrored Disk operation between two Mirrored Disk devices,
       24       24        or the WAIT state for a Mirrored Disk whose Mirror cannot be
       25       25        found.
       26       26
       27       27        DPxx must be a Mirrored Disk that is OPERational or
       28       28        WAITing.
       29       29
       30       30        The DCT and VIDs for DPxx will be changed to be a
       31       31        nonmirrored disk device.
       32       32
       33       33        The DCT for DPyy will be changed to be a
       34       34        nonmirrored disk device.  The VID for DPyy will be
       35       35        changed to be a failed Mirrored Disk device.
       36       36
PL6.E3A0      #001=NMM$DONT_MIRROR File=NMM$MIRROR.:E05TSI                       WED 07/30/97 03:49 Page:12   
       37       37        */
       38       38        %EJECT ;
PL6.E3A0      #001=NMM$DONT_MIRROR File=NMM$MIRROR.:E05TSI                       WED 07/30/97 03:49 Page:13   
       39       39        NMM$DONT_MIRROR:        PROC            ALTRET ;

     39  3 000000   000000 700200 xent  NMM$DONT_MI* TSX0  ! X66_AUTO_0
         3 000001   000006 000000                    ZERO    6,0

       40       40        /*
       41       41                        Includes
       42       42        */
       43       43        %INCLUDE                CP_6 ;
       44     5602        %INCLUDE                FM$GRAN ;
       45     5671        %INCLUDE                NI$TABLES ;
       46     5887        %INCLUDE                NI_DATA_C ;
       47     6000        %INCLUDE                NM_MACRO_M ;
       48     7405        %INCLUDE                NM_PERR_C ;
       49     7482        %INCLUDE                XU_MACRO_C ;
       50    10588        /*
       51    10589                        Entries
       52    10590        */
       53    10591    1   DCL 1 NME$ERRMSG        ENTRY(6) ;
       54    10592    1   DCL 1 NMO$DCT           ENTRY(2) ALTRET ;
       55    10593    1   DCL 1 NMO$DEV           ENTRY(2) ALTRET ;
       56    10594    1   DCL 1 NMU$ABORT         ENTRY(2) ALTRET ;
       57    10595    1   DCL 1 NMU$CHGSTATEMSG   ENTRY(2) ALTRET ;
       58    10596    1   DCL 1 NMU$LOCK          ENTRY(1) ALTRET ;
       59    10597    1   DCL 1 NMU$READ          ENTRY(3) ALTRET ;
       60    10598    1   DCL 1 NMU$SCRUB_VID     ENTRY(2) ;
       61    10599    1   DCL 1 NMU$UNLOCK        ENTRY(1) ALTRET ;
       62    10600    1   DCL 1 NMU$WRITE         ENTRY(3) ALTRET ;
       63    10601    1   DCL 1 NMV$MIRRORED      ENTRY(1) ALTRET ;
       64    10602    1   DCL 1 NMV$STATE         ENTRY(3) ALTRET ;
       65    10603        /*
       66    10604                        Variables
       67    10605        */
       68    10606                                %B$ALT ( NAME =
       69    10607              B$ALT             ,     STCLASS=BASED
       70    10608                                                                        ) ;
       71    10616                                %B$TCB  ( NAME =
PL6.E3A0      #001=NMM$DONT_MIRROR File=NMM$MIRROR.:E05TSI                       WED 07/30/97 03:49 Page:14   
       72    10617              B$TCB             , STCLASS = "BASED(B$TCB$)"
       73    10618                                                                        ) ;
       74    10621    1   DCL 1 B$TCB$            PTR SYMREF ;
       75    10622                                %FPT_MIRROR ( FPTN =
       76    10623              BREAK             , STCLASS = STATIC
       77    10624                                , DCTX = 0
       78    10625                                , FUNCTION = BREAK
       79    10626                                , MDCTX = 0
       80    10627                                , UTS = 0
       81    10628                                                                        ) ;
       82    10651                                %NI$DCT ( NAME =
       83    10652              DCT               , STCLASS = BASED
       84    10653                                                                        ) ;
       85    10701                                %FM$VID ( FM$VID =
       86    10702              FM$VID            , BASED = BASED
       87    10703                                                                        ) ;
       88    10709    1   DCL 1 I                 SBIN WORD ALIGNED AUTO ;
       89    10710                                %NMD_PIT ( FPTN =
       90    10711              NMD_PIT           , STCLASS=SYMREF
       91    10712                                                                        ) ;
       92    11165                                %PARSE$OUT ( NAME =
       93    11166              OUT               , STCLASS ="BASED(XUG_GETCMD.OUT$)"
       94    11167                                                                        ) ;
       95    11212                                %FPT_TIME ( FPTN =
       96    11213              TIME              , STCLASS = CONSTANT
       97    11214                                , DEST = UTS
       98    11215                                , SOURCE = CLOCK
       99    11216                                , TSTAMP = UTS
      100    11217                                                                        ) ;
      101    11236    1   DCL 1 UTS               UBIN WORD ALIGNED STATIC ;
      102    11237                                %XUG_GETCMD ( NAME =
      103    11238              XUG_GETCMD        , STCLASS = SYMREF
      104    11239                                                                        ) ;
      105    11577        %EJECT ;
PL6.E3A0      #001=NMM$DONT_MIRROR File=NMM$MIRROR.:E05TSI                       WED 07/30/97 03:49 Page:15   
      106    11578        /*
      107    11579        Process the devices and options specified on the command.
      108    11580        */
      109    11581    1           CALL NMO$DEV ( 0, OUT.SUBLK$(0) )       ALTRET ( ERROR ) ;

  11581  3 000002   000001 236000 xsym               LDQ     XUG_GETCMD+1
         3 000003   000003 036003                    ADLQ    3,DU
         3 000004   000000 235000 4                  LDA     0
         3 000005   200004 757100                    STAQ    4,,AUTO
         3 000006   200004 630500                    EPPR0   4,,AUTO
         3 000007   000020 631400 xsym               EPPR1   B_VECTNIL+16
         3 000010   000000 701000 xent               TSX1    NMO$DEV
         3 000011   000136 702000 3                  TSX2    ERROR

      110    11582        /*
      111    11583        Get UTS for this operation.
      112    11584        */
      113    11585    1           CALL M$TIME ( TIME )                    ALTRET ( ALTERR ) ;

  11585  3 000012   000000 630400 2                  EPPR0   TIME
         3 000013   420004 713400                    CLIMB   alt,+8196
         3 000014   402000 401760                    pmme    nvectors=5
         3 000015   000126 702000 3                  TSX2    ALTERR

      114    11586        /*
      115    11587        Determine if this is a Mirrored Disk device or not.
      116    11588        */
      117    11589    1           IF  NMD_PIT.DEV.DCT$(0)->DCT.DP.MIRROR.FLAG

  11589  3 000016   000010 470400 xsym               LDP0    NMD_PIT+8
         3 000017   000036 234100                    SZN     30,,PR0
         3 000020   000032 605000 3                  TPL     s:11606

      118    11590    2           THEN DO ;

      119    11591        /*
      120    11592        A Mirrored Disk device must be OPERational.
PL6.E3A0      #001=NMM$DONT_MIRROR File=NMM$MIRROR.:E05TSI                       WED 07/30/97 03:49 Page:16   
      121    11593        */
      122    11594    2               CALL NMV$STATE ( 0, %NI_MIRROR_OPER )

  11594  3 000021   000001 630400 4                  EPPR0   1
         3 000022   000020 631400 xsym               EPPR1   B_VECTNIL+16
         3 000023   000000 701000 xent               TSX1    NMV$STATE
         3 000024   000136 702000 3                  TSX2    ERROR

      123    11595    2                                                   ALTRET ( ERROR ) ;
      124    11596        /*
      125    11597        Get information for other Mirrored Disk device.
      126    11598        */
      127    11599    2               CALL NMO$DCT ( 1, NMD_PIT.DEV.MDCTX(0) )

  11599  3 000025   000003 630400 4                  EPPR0   3
         3 000026   000020 631400 xsym               EPPR1   B_VECTNIL+16
         3 000027   000000 701000 xent               TSX1    NMO$DCT
         3 000030   000136 702000 3                  TSX2    ERROR

      128    11600    2                                                   ALTRET ( ERROR ) ;
      129    11601    2               END ;

  11601  3 000031   000042 710000 3                  TRA     s:11619

      130    11602        /*
      131    11603        If this is not a Mirrored Disk device, it must be WAITing.
      132    11604        */
      133    11605    2           ELSE DO ;

      134    11606    2               CALL NMV$STATE ( 0, %NI_MIRROR_WAIT )

  11606  3 000032   000005 630400 4                  EPPR0   5
         3 000033   000020 631400 xsym               EPPR1   B_VECTNIL+16
         3 000034   000000 701000 xent               TSX1    NMV$STATE
         3 000035   000136 702000 3                  TSX2    ERROR

      135    11607    2                                                   ALTRET ( ERROR ) ;
PL6.E3A0      #001=NMM$DONT_MIRROR File=NMM$MIRROR.:E05TSI                       WED 07/30/97 03:49 Page:17   
      136    11608        /*
      137    11609        Specify that there is no other device.
      138    11610        */
      139    11611    2               NMD_PIT.DEV.DCTX(1) = 0 ;

  11611  3 000036   000043 450000 xsym               STZ     NMD_PIT+35

      140    11612    2               NMD_PIT.DEV.DCT$(1) = ADDR(NIL) ;

  11612  3 000037   000001 236000 xsym               LDQ     B_VECTNIL+1
         3 000040   000042 756000 xsym               STQ     NMD_PIT+34

      141    11613    2               NMD_PIT.DEV.DVT$(1) = ADDR(NIL) ;

  11613  3 000041   000045 756000 xsym               STQ     NMD_PIT+37

      142    11614    2               END ;

      143    11615        /*
      144    11616        Read, modify, and rewrite the VID for this device.
      145    11617        CANNOT TOLERATE AN ERROR ON THE REWRITE OF THE VID!!!!
      146    11618        */
      147    11619    1           CALL NMU$READ ( 0, 0, NMD_PIT.DEV.VID_(0) )

  11619  3 000042   000007 630400 4                  EPPR0   7
         3 000043   000021 631400 xsym               EPPR1   B_VECTNIL+17
         3 000044   000000 701000 xent               TSX1    NMU$READ
         3 000045   000136 702000 3                  TSX2    ERROR

      148    11620    1                                                   ALTRET ( ERROR ) ;
      149    11621    1           NMD_PIT.DEV.VID$(0)->FM$VID.MIRROR.STATE(1) = %NI_MIRROR_FAIL ;

  11621  3 000046   000032 470400 xsym               LDP0    NMD_PIT+26
         3 000047   000100 236003                    LDQ     64,DU
         3 000050   000045 752120                    STCQ    37,'20'O,PR0

      150    11622    1           NMD_PIT.DEV.VID$(0)->FM$VID.MIRROR.UTS      = UTS ;
PL6.E3A0      #001=NMM$DONT_MIRROR File=NMM$MIRROR.:E05TSI                       WED 07/30/97 03:49 Page:18   

  11622  3 000051   000006 235000 1                  LDA     UTS
         3 000052   000044 755100                    STA     36,,PR0

      151    11623    1           CALL NMU$WRITE ( 0, 0, NMD_PIT.DEV.VID_(0) )

  11623  3 000053   000007 630400 4                  EPPR0   7
         3 000054   000021 631400 xsym               EPPR1   B_VECTNIL+17
         3 000055   000000 701000 xent               TSX1    NMU$WRITE
         3 000056   000136 702000 3                  TSX2    ERROR

      152    11624    1                                                   ALTRET ( ERROR ) ;
      153    11625        /*
      154    11626        If there is another device (i.e., this device is not WAITing),
      155    11627        read, modify, and rewrite the VID for the other device.
      156    11628        CANNOT TOLERATE AN ERROR ON THE REWRITE OF THE VID!!!!
      157    11629        */
      158    11630    1           IF  NMD_PIT.DEV.DCTX(1) ~= 0

  11630  3 000057   000043 235000 xsym               LDA     NMD_PIT+35
         3 000060   000101 600000 3                  TZE     s:11642

      159    11631    2           THEN DO ;

      160    11632    2               CALL NMU$READ      ( 1, 0, NMD_PIT.DEV.VID_(1) )

  11632  3 000061   000012 630400 4                  EPPR0   10
         3 000062   000021 631400 xsym               EPPR1   B_VECTNIL+17
         3 000063   000000 701000 xent               TSX1    NMU$READ
         3 000064   000136 702000 3                  TSX2    ERROR

      161    11633    2                                                   ALTRET ( ERROR ) ;
      162    11634    2               CALL NMU$SCRUB_VID ( 1, UTS ) ;

  11634  3 000065   000015 630400 4                  EPPR0   13
         3 000066   000020 631400 xsym               EPPR1   B_VECTNIL+16
         3 000067   000000 701000 xent               TSX1    NMU$SCRUB_VID
PL6.E3A0      #001=NMM$DONT_MIRROR File=NMM$MIRROR.:E05TSI                       WED 07/30/97 03:49 Page:19   
         3 000070   000000 011000                    NOP     0

      163    11635    2               CALL NMU$WRITE     ( 1, 0, NMD_PIT.DEV.VID_(1) )

  11635  3 000071   000012 630400 4                  EPPR0   10
         3 000072   000021 631400 xsym               EPPR1   B_VECTNIL+17
         3 000073   000000 701000 xent               TSX1    NMU$WRITE
         3 000074   000136 702000 3                  TSX2    ERROR

      164    11636    2                                                   ALTRET ( ERROR ) ;
      165    11637    2               CALL NMU$CHGSTATEMSG ( 1, %NI_MIRROR_FAIL ) ;

  11637  3 000075   000017 630400 4                  EPPR0   15
         3 000076   000020 631400 xsym               EPPR1   B_VECTNIL+16
         3 000077   000000 701000 xent               TSX1    NMU$CHGSTATEMSG
         3 000100   000000 011000                    NOP     0

      166    11638    2               END ;

      167    11639        /*
      168    11640        Issue PMME to dissolve the Mirrored Disk pair.
      169    11641        */
      170    11642    1           BREAK.V.DCTX#  = NMD_PIT.DEV.DCTX(0) ;

  11642  3 000101   000011 720000 xsym               LXL0    NMD_PIT+9
         3 000102   000002 440000 1                  SXL0    BREAK+2

      171    11643    1           BREAK.V.MDCTX# = NMD_PIT.DEV.DCTX(1) ;

  11643  3 000103   000043 721000 xsym               LXL1    NMD_PIT+35
         3 000104   000003 441000 1                  SXL1    BREAK+3

      172    11644    1           BREAK.V.UTS#   = UTS ;

  11644  3 000105   000006 235000 1                  LDA     UTS
         3 000106   000005 755000 1                  STA     BREAK+5

PL6.E3A0      #001=NMM$DONT_MIRROR File=NMM$MIRROR.:E05TSI                       WED 07/30/97 03:49 Page:20   
      173    11645    1           CALL M$MIRROR ( BREAK )                 ALTRET ( ALTERR ) ;

  11645  3 000107   000000 630400 1                  EPPR0   BREAK
         3 000110   470010 713400                    CLIMB   alt,+28680
         3 000111   400000 401760                    pmme    nvectors=1
         3 000112   000126 702000 3                  TSX2    ALTERR

      174    11646        /*
      175    11647        Output message detailing new state of the Mirrored Disk device(s).
      176    11648        */
      177    11649    1           CALL NMU$CHGSTATEMSG ( 0, %NI_MIRROR_NONE ) ;

  11649  3 000113   000021 630400 4                  EPPR0   17
         3 000114   000020 631400 xsym               EPPR1   B_VECTNIL+16
         3 000115   000000 701000 xent               TSX1    NMU$CHGSTATEMSG
         3 000116   000000 011000                    NOP     0

      178    11650    1           IF  NMD_PIT.DEV.DCTX(1) ~= 0

  11650  3 000117   000043 235000 xsym               LDA     NMD_PIT+35
         3 000120   000125 600000 3                  TZE     s:11656

      179    11651    1           THEN
      180    11652    1               CALL NMU$CHGSTATEMSG ( 1, %NI_MIRROR_NONE ) ;

  11652  3 000121   000023 630400 4                  EPPR0   19
         3 000122   000020 631400 xsym               EPPR1   B_VECTNIL+16
         3 000123   000000 701000 xent               TSX1    NMU$CHGSTATEMSG
         3 000124   000000 011000                    NOP     0

      181    11653        /*
      182    11654        Return to the calling procedure.
      183    11655        */
      184    11656    1           RETURN ;

  11656  3 000125   000000 702200 xent               TSX2  ! X66_ARET

PL6.E3A0      #001=NMM$DONT_MIRROR File=NMM$MIRROR.:E05TSI                       WED 07/30/97 03:49 Page:21   
      185    11657
      186    11658    1   ALTERR: CALL NME$ERRMSG ( B$TCB.ALT$->B$ALT.ERR ) ;

  11658  3 000126   000000 470400 xsym  ALTERR       LDP0    B$TCB$
         3 000127   000000 471500                    LDP1    0,,PR0
         3 000130   100102 633500                    EPPR3   66,,PR1
         3 000131   200004 453500                    STP3    4,,AUTO
         3 000132   200004 630500                    EPPR0   4,,AUTO
         3 000133   000017 631400 xsym               EPPR1   B_VECTNIL+15
         3 000134   000000 701000 xent               TSX1    NME$ERRMSG
         3 000135   000000 011000                    NOP     0

      187    11659
      188    11660    1   ERROR:  ALTRETURN ;

  11660  3 000136   000000 702200 xent  ERROR        TSX2  ! X66_AALT
      189    11661
      190    11662    1           END NMM$DONT_MIRROR ;
      191    11663        %EOD ;

PL6.E3A0      #001=NMM$DONT_MIRROR File=NMM$MIRROR.:E05TSI                       WED 07/30/97 03:49 Page:22   
--  Include file information  --

   XU_MACRO_C.:E05TOU  is referenced.
   NM_PERR_C.:E05TOU  is referenced.
   NM_SUBS_C.:E05TOU  is referenced.
   NM_EQU_E.:E05TOU  is referenced.
   CP_6_SUBS.:E05TOU  is referenced.
   NM_MACRO_M.:E05TOU  is referenced.
   NI_DATA_C.:E05TOU  is referenced.
   NI$TABLES.:E05TOU  is referenced.
   FM$GRAN.:E05TOU  is referenced.
   CP_6_C.:E05TOU  is referenced.
   CP_6.:E05TOU  cannot be made into a system file and is referenced.
      No diagnostics issued in procedure NMM$DONT_MIRROR.
PL6.E3A0      #001=NMM$DONT_MIRROR File=NMM$MIRROR.:E05TSI                       WED 07/30/97 03:49 Page:23   

 **** Variables and constants ****

  ****  Section 001  Data  NMM$DONT_MIRROR

  ****  Scalars and arrays  ****
OctLoc.c.b A Datatyp(siz) R M Lvl/name                 OctLoc.c.b A Datatyp(siz) R M Lvl/name

     0-0-0/d STRC(216)   r     1 BREAK                      6-0-0/w UBIN        r     1 UTS

  ****  Section 002 RoData NMM$DONT_MIRROR

  ****  Scalars and arrays  ****
OctLoc.c.b A Datatyp(siz) R M Lvl/name                 OctLoc.c.b A Datatyp(siz) R M Lvl/name

     0-0-0/d STRC(432)   r     1 TIME

  ****  SYMREF variables  ****

  ****  Scalars and arrays  ****
OctLoc.c.b A Datatyp(siz) R M Lvl/name                 OctLoc.c.b A Datatyp(siz) R M Lvl/name

     0-0-0/w PTR         r     1 B$TCB$                     0-0-0/d STRC(8892)  r     1 NMD_PIT
     0-0-0/d STRC(1512)  r     1 XUG_GETCMD

  ****  BASED and DCB variables  ****

  ****  Scalars and arrays  ****
OctLoc.c.b A Datatyp(siz) R M Lvl/name                 OctLoc.c.b A Datatyp(siz) R M Lvl/name

     0-0-0/w STRC(2448)  r     1 B$ALT                      0-0-0/w STRC(144)   r     1 B$TCB
     0-0-0/w STRC(1332)  r     1 DCT                        0-0-0/w STRC(36864) r     1 FM$VID
     0-0-0/w STRC(144)   r     1 OUT


   Procedure NMM$DONT_MIRROR requires 95 words for executable code.
   Procedure NMM$DONT_MIRROR requires 6 words of local(AUTO) storage.
PL6.E3A0      #001=NMM$DONT_MIRROR File=NMM$MIRROR.:E05TSI                       WED 07/30/97 03:49 Page:24   
          *** CROSS REFERENCE LISTING ***
**     DENOTES     IDENTIFIER DEFINITION
<<                 IDENTIFIER'S VALUE SET
>>                 IDENTIFIER'S VALUE USED
<>                 IDENTIFIER SET AND/OR USED
--                 IDENTIFIER REFERENCED
PL6.E3A0      #001=NMM$DONT_MIRROR File=NMM$MIRROR.:E05TSI                       WED 07/30/97 03:49 Page:25   
          MINI XREF LISTING

ALTERR
     11658**LABEL   11585--CALLALT 11645--CALLALT
B$ALT.CODE
     10610**DCL     10610--REDEF   10611--REDEF   10611--REDEF
B$ALT.ERR
     10611**DCL     11658<>CALL
B$ALT.ERR.ERR#
     10612**DCL     10612--REDEF
B$ALT.EVID
     10611**DCL     10611--REDEF   10611--REDEF
B$TCB.ALT$
     10619**DCL     11658>>CALL
B$TCB$
     10621**DCL     10619--IMP-PTR 11658>>CALL
BREAK
     10645**DCL     11645<>CALL
BREAK.V
     10645**DCL     10645--DCLINIT
BREAK.V.DCTX#
     10647**DCL     11642<<ASSIGN
BREAK.V.MDCTX#
     10648**DCL     11643<<ASSIGN
BREAK.V.UTS#
     10649**DCL     11644<<ASSIGN
DCT.DP
     10682**DCL     10689--REDEF   10692--REDEF   10693--REDEF   10695--REDEF   10695--REDEF   10696--REDEF
     10697--REDEF   10697--REDEF
DCT.DP.MIRROR.FLAG
     10684**DCL     11589>>IF
DCT.MPC.IOCHANX
     10690**DCL     10690--REDEF
ERROR
PL6.E3A0      #001=NMM$DONT_MIRROR File=NMM$MIRROR.:E05TSI                       WED 07/30/97 03:49 Page:26   
     11660**LABEL   11581--CALLALT 11594--CALLALT 11599--CALLALT 11606--CALLALT 11619--CALLALT 11623--CALLALT
     11632--CALLALT 11635--CALLALT
FM$VID.DTT
     10706**DCL     10706--REDEF
FM$VID.MIRROR.STATE
     10705**DCL     11621<<ASSIGN
FM$VID.MIRROR.UTS
     10705**DCL     11622<<ASSIGN
M$MIRROR
      5581**DCL-ENT 11645--CALL
M$TIME
      5597**DCL-ENT 11585--CALL
NMD_PIT.DEV.DCT$
     10773**DCL     11589>>IF      11612<<ASSIGN
NMD_PIT.DEV.DCTX
     10778**DCL     11611<<ASSIGN  11630>>IF      11642>>ASSIGN  11643>>ASSIGN  11650>>IF
NMD_PIT.DEV.DVT$
     10788**DCL     11613<<ASSIGN
NMD_PIT.DEV.MDCTX
     10823**DCL     11599<>CALL
NMD_PIT.DEV.VID$
     10875**DCL     11621>>ASSIGN  11622>>ASSIGN
NMD_PIT.DEV.VID_
     10869**DCL     11619<>CALL    11623<>CALL    11632<>CALL    11635<>CALL
NME$ERRMSG
     10591**DCL-ENT 11658--CALL
NMO$DCT
     10592**DCL-ENT 11599--CALL
NMO$DEV
     10593**DCL-ENT 11581--CALL
NMU$CHGSTATEMSG
     10595**DCL-ENT 11637--CALL    11649--CALL    11652--CALL
NMU$READ
     10597**DCL-ENT 11619--CALL    11632--CALL
NMU$SCRUB_VID
     10598**DCL-ENT 11634--CALL
PL6.E3A0      #001=NMM$DONT_MIRROR File=NMM$MIRROR.:E05TSI                       WED 07/30/97 03:49 Page:27   
NMU$WRITE
     10600**DCL-ENT 11623--CALL    11635--CALL
NMV$STATE
     10602**DCL-ENT 11594--CALL    11606--CALL
OUT.SUBLK$
     11206**DCL     11581<>CALL
TIME
     11228**DCL     11585<>CALL
TIME.V
     11232**DCL     11228--DCLINIT
UTS
     11236**DCL     11232--DCLINIT 11622>>ASSIGN  11634<>CALL    11644>>ASSIGN
XUG_GETCMD.OUT$
     11257**DCL     11173--IMP-PTR 11263--REDEF   11581>>CALL

PL6.E3A0      #002=NMM$MIRROR File=NMM$MIRROR.:E05TSI                            WED 07/30/97 03:50 Page:28   
      192        1        /*M* NMM$MIRROR - Procedure to perform MIRROR command.             */
      193        2        /*T***********************************************************/
      194        3        /*T*                                                         */
      195        4        /*T* Copyright (c) Bull HN Information Systems Inc., 1997    */
      196        5        /*T*                                                         */
      197        6        /*T***********************************************************/
      198        7        /*X* DFC=YES, DMC=YES, EDMC=YES                                    */
      199        8        /*F*
      200        9        NAME:           NMM$MIRROR
      201       10
      202       11        PURPOSE:        To perform the MIRROR command.
      203       12        */
      204       13        /*D*
      205       14        NAME:           NMM$MIRROR
      206       15
      207       16        CALL:           CALL NMM$MIRROR ALTRET ( error ) ;
      208       17
      209       18        PARAMETERS:
      210       19        */
      211       20        /*K*
      212       21        error           specifies a statement label to which NMM$MIRROR will
      213       22                make an altreturn if an error is detected.
      214       23        */
      215       24        /*D*
      216       25        DESCRIPTION:
      217       26
      218       27        The NMM$MIRROR procedure is used to perform the MIRROR command.
      219       28
      220       29        DPxx and DPyy must be a nonmirrored disk devices.
      221       30
      222       31        DPxx becomes the primary Mirrored Disk device.  DPyy becomes the
      223       32        secondary Mirrored Disk device.
      224       33
      225       34        DPxx is made operational.
      226       35
      227       36        If both DPxx and DPyy are single volume scratch devices, then
      228       37        DPyy is made OPERATIONAL.  Otherwise, if DPxx is not a single
PL6.E3A0      #002=NMM$MIRROR File=NMM$MIRROR.:E05TSI                            WED 07/30/97 03:50 Page:29   
      229       38        scratch volume, DPyy must be a single scratch volume and is
      230       39        made FAILED.
      231       40
      232       41        If DPyy is FAILED, DPxx is copied over DPyy.  And DPyy is then
      233       42        made operational.
      234       43                                                                           */
      235       44        NMM$MIRROR:     PROC    ALTRET ;
      236       45        /*
      237       46                                Includes
      238       47        */
      239       48        %INCLUDE                CP_6 ;
      240     5607        %INCLUDE                FM$GRAN ;
      241     5676        %INCLUDE                NI_DATA_C ;
      242     5789        %INCLUDE                NM_MACRO_M ;
      243     7194        %INCLUDE                NM_PERR_C ;
      244     7271        %INCLUDE                XU_MACRO_C ;
      245    10377        /*
      246    10378                        Entries
      247    10379        */
      248    10380    1   DCL 1 NMC$KOPY          ENTRY    ALTRET ;
      249    10381    1   DCL 1 NME$ERRMSG        ENTRY(6) ;
      250    10382    1   DCL 1 NMO$DEV           ENTRY(2) ALTRET ;
      251    10383    1   DCL 1 NMO$OPTIONS       ENTRY(2) ALTRET ;
      252    10384    1   DCL 1 NMU$CHGSTATEMSG   ENTRY(2) ALTRET ;
      253    10385    1   DCL 1 NMU$MIRROR_VID    ENTRY(2) ;
      254    10386    1   DCL 1 NMU$READ          ENTRY(3) ALTRET ;
      255    10387    1   DCL 1 NMU$WRITE         ENTRY(3) ALTRET ;
      256    10388    1   DCL 1 NMV$DEV           ENTRY    ALTRET ;
      257    10389    1   DCL 1 NMV$DGT           ENTRY    ALTRET ;
      258    10390    1   DCL 1 NMV$NOTMIRRORED   ENTRY(1) ALTRET ;
      259    10391    1   DCL 1 NMV$NOTPART       ENTRY(1) ALTRET ;
      260    10392    1   DCL 1 NMV$PACKSIZE      ENTRY    ALTRET ;
      261    10393    1   DCL 1 NMV$SCRATCH       ENTRY(1) ALTRET ;
      262    10394    1   DCL 1 NMV$VSN           ENTRY    ALTRET ;
      263    10395        /*
      264    10396                        Variables
      265    10397        */
PL6.E3A0      #002=NMM$MIRROR File=NMM$MIRROR.:E05TSI                            WED 07/30/97 03:50 Page:30   
      266    10398                                %B$ALT ( NAME =
      267    10399              B$ALT             , STCLASS = BASED
      268    10400                                                                        ) ;
      269    10408                                %B$TCB ( NAME =
      270    10409              B$TCB             , STCLASS = "BASED(B$TCB$)"
      271    10410                                                                        ) ;
      272    10413    1   DCL 1 B$TCB$            PTR SYMREF ;
      273    10414                                %FM$VID ( FM$VID =
      274    10415              FM$VID            , BASED = BASED
      275    10416                                                                        ) ;
      276    10422                                %FPT_MIRROR ( FPTN =
      277    10423              MAKE              , STCLASS  = STATIC
      278    10424                                , FUNCTION = MAKE
      279    10425                                , DCTX     = 0
      280    10426                                , DRZERO   = 0
      281    10427                                , MDCTX    = 0
      282    10428                                , MSTATE   = FAIL
      283    10429                                , STATE    = OPER
      284    10430                                , UTS      = 0
      285    10431                                                                        ) ;
      286    10454                                %NMD_PIT ( FPTN =
      287    10455              NMD_PIT           , STCLASS = SYMREF
      288    10456                                                                        ) ;
      289    10909                                %VLP_ERRCODE ( FPTN =
      290    10910              NMM#NOT_SCRATCH   , STCLASS = CONSTANT
      291    10911                                , ERR# = %E$NMD#NOT_SCRATCH
      292    10912                                , FCG  = %NMD#FCG
      293    10913                                , MID  = 'M'
      294    10914                                , MON  = %NO#
      295    10915                                , SEV  = 5
      296    10916                                                                        ) ;
      297    10961                                %PARSE$OUT ( NAME =
      298    10962              OUT               , STCLASS ="BASED(XUG_GETCMD.OUT$)"
      299    10963                                                                        ) ;
      300    11008                                %FPT_TIME ( FPTN =
      301    11009              TIME              , STCLASS = CONSTANT
      302    11010                                , DEST = UTS
PL6.E3A0      #002=NMM$MIRROR File=NMM$MIRROR.:E05TSI                            WED 07/30/97 03:50 Page:31   
      303    11011                                , SOURCE = CLOCK
      304    11012                                , TSTAMP = UTS
      305    11013                                                                        ) ;
      306    11032    1   DCL 1 UTS               UBIN WORD ALIGNED STATIC ;
      307    11033                                %NMD_VID ( FPTN =
      308    11034              VID               , STCLASS = BASED
      309    11035                                                                        ) ;
      310    11052                                %XUG_GETCMD ( NAME =
      311    11053              XUG_GETCMD        , STCLASS = SYMREF
      312    11054                                                                        ) ;
      313    11392        %EJECT ;
PL6.E3A0      #002=NMM$MIRROR File=NMM$MIRROR.:E05TSI                            WED 07/30/97 03:50 Page:32   
      314    11393        /*
      315    11394        Process the devices and options specified on the command.
      316    11395        */
      317    11396    1           CALL NMO$DEV ( 0, OUT.SUBLK$(0) )       ALTRET ( ERROR ) ;
      318    11397    1           CALL NMO$DEV ( 1, OUT.SUBLK$(1) )       ALTRET ( ERROR ) ;
      319    11398    1           CALL NMO$OPTIONS ( 2, OUT.NSUBLKS-1 )   ALTRET ( ERROR ) ;
      320    11399        /*
      321    11400        Verify that the specified devices are not currently mirrored disks
      322    11401        and that they are the same size.  If they are, then read the VIDS,
      323    11402        check the VSNs, DGTs, and that either both devices are scratch
      324    11403        devices or that at least DEV(1) is a scratch device.
      325    11404        */
      326    11405    1           CALL NMV$NOTMIRRORED ( 0 )              ALTRET ( ERROR ) ;
      327    11406    1           CALL NMV$NOTMIRRORED ( 1 )              ALTRET ( ERROR ) ;
      328    11407    1           CALL NMV$NOTPART     ( 0 )              ALTRET ( ERROR ) ;
      329    11408    1           CALL NMV$NOTPART     ( 1 )              ALTRET ( ERROR ) ;
      330    11409    1           CALL NMV$DEV                            ALTRET ( ERROR ) ;
      331    11410    1           CALL NMV$PACKSIZE                       ALTRET ( ERROR ) ;
      332    11411
      333    11412    1           CALL NMU$READ ( 0, 0, NMD_PIT.DEV.VID_(0) )
      334    11413    1                                                   ALTRET ( ERROR ) ;
      335    11414    1           CALL NMU$READ ( 1, 0, NMD_PIT.DEV.VID_(1) )
      336    11415    1                                                   ALTRET ( ERROR ) ;
      337    11416
      338    11417    1           CALL NMV$VSN                            ALTRET ( ERROR ) ;
      339    11418    1           CALL NMV$DGT                            ALTRET ( ERROR ) ;
      340    11419    1           CALL NMV$SCRATCH ( 0 )                  /*  NO ALTRET  */;
      341    11420    1           CALL NMV$SCRATCH ( 1 )
      342    11421    2           WHENALTRETURN DO ;
      343    11422        /*E*
      344    11423        ERROR:  NMM-E$NMD#NOT_SCRATCH-5
      345    11424        MESSAGE:  %U1 is not a scratch device.
      346    11425        DESCRIPTION:  For the specified command, the device must be
      347    11426                      a scratch device (i.e., a single volume scratch
      348    11427                      pack).
      349    11428        */
      350    11429    2               CALL NME$ERRMSG ( NMM#NOT_SCRATCH, ,
PL6.E3A0      #002=NMM$MIRROR File=NMM$MIRROR.:E05TSI                            WED 07/30/97 03:50 Page:33   
      351    11430    2                                 VECTOR(NMD_PIT.DEV.NAME(1)) ) ;
      352    11431    2               GOTO ERROR ;
      353    11432    2               END ;
      354    11433        /*
      355    11434        Get the current UTS for this MIRROR operation.
      356    11435        */
      357    11436    1           CALL M$TIME ( TIME )                    ALTRET ( ALTERR ) ;
      358    11437        /*
      359    11438        Determine the states for the Mirrored Disk devices.
      360    11439        */
      361    11440    1           NMD_PIT.DEV.STATE(0) = %NI_MIRROR_OPER ;
      362    11441    1           IF  NMD_PIT.DEV.FLAGS.SCRATCH(0)
      363    11442    1           THEN
      364    11443    1               NMD_PIT.DEV.STATE(1) = %NI_MIRROR_OPER ;
      365    11444    1           ELSE
      366    11445    1               NMD_PIT.DEV.STATE(1) = %NI_MIRROR_FAIL ;
      367    11446
      368    11447        /*
      369    11448        Update the VID on the primary device if the secondary
      370    11449        device is operational.  (If secondary device is not operational,
      371    11450        the VID on the primary device will be updated only after
      372    11451        the COPY operation has been successfully completed.)
      373    11452        */
      374    11453    1           IF  NMD_PIT.DEV.STATE(1) = %NI_MIRROR_OPER
      375    11454    2           THEN DO ;
      376    11455    2               CALL NMU$MIRROR_VID ( 0, UTS ) ;
      377    11456    2               CALL NMU$WRITE      ( 0, 0, NMD_PIT.DEV.VID_(0) )
      378    11457    2                                                   ALTRET ( ERROR ) ;
      379    11458    2               END ;
      380    11459        /*
      381    11460        Update the VID on the secondary device.
      382    11461        */
      383    11462    1           NMD_PIT.DEV.VID$(1)->VID                    = NMD_PIT.DEV.VID$(0)->VID ;
      384    11463
      385    11464    1           CALL NMU$MIRROR_VID ( 1, UTS ) ;
      386    11465    1           CALL NMU$WRITE      ( 1, 0, NMD_PIT.DEV.VID_(1) )
      387    11466    1                                                   ALTRET ( ERROR ) ;
PL6.E3A0      #002=NMM$MIRROR File=NMM$MIRROR.:E05TSI                            WED 07/30/97 03:50 Page:34   
      388    11467        /*
      389    11468        Initialize FPT values and create a Mirrored Disk pair.
      390    11469        */
      391    11470    1           MAKE.V.DCTX#    = NMD_PIT.DEV.DCTX(0) ;
      392    11471    1           MAKE.V.DRZERO#  = NMD_PIT.DEV.DRZERO(0) ;
      393    11472    1           MAKE.V.MDCTX#   = NMD_PIT.DEV.DCTX(1) ;
      394    11473    1           MAKE.V.MSTATE#  = NMD_PIT.DEV.STATE(1) ;
      395    11474    1           MAKE.V.PRIMARY# = '1'B ;
      396    11475    1           MAKE.V.STATE#   = NMD_PIT.DEV.STATE(0) ;
      397    11476    1           MAKE.V.UTS#     = UTS ;
      398    11477
      399    11478    1           CALL M$MIRROR ( MAKE )                  ALTRET ( ALTERR ) ;
      400    11479        /*
      401    11480        Output messages for the state of each Mirrored Disk device.
      402    11481        */
      403    11482    1           CALL NMU$CHGSTATEMSG ( 0, NMD_PIT.DEV.STATE(0) ) ;
      404    11483    1           CALL NMU$CHGSTATEMSG ( 1, NMD_PIT.DEV.STATE(1) ) ;
      405    11484        /*
      406    11485        If the secondary device is not operational, perform COPY command.
      407    11486        */
      408    11487    1           IF  NMD_PIT.DEV.STATE(1) ~= %NI_MIRROR_OPER
      409    11488    1           THEN
      410    11489    1               CALL NMC$KOPY                       ALTRET ( ERROR ) ;
      411    11490        /*
      412    11491        Return to the calling procedure.
      413    11492        */
      414    11493    1           RETURN ;
      415    11494
      416    11495    1   ALTERR: CALL NME$ERRMSG ( B$TCB.ALT$->B$ALT.ERR ) ;
      417    11496
      418    11497    1   ERROR:  ALTRETURN ;
      419    11498
      420    11499    1           END NMM$MIRROR ;

PL6.E3A0      #002=NMM$MIRROR File=NMM$MIRROR.:E05TSI                            WED 07/30/97 03:50 Page:35   
--  Include file information  --

   XU_MACRO_C.:E05TOU  is referenced.
   NM_PERR_C.:E05TOU  is referenced.
   NM_SUBS_C.:E05TOU  is referenced.
   NM_EQU_E.:E05TOU  is referenced.
   CP_6_SUBS.:E05TOU  is referenced.
   NM_MACRO_M.:E05TOU  is referenced.
   NI_DATA_C.:E05TOU  is referenced.
   FM$GRAN.:E05TOU  is referenced.
   CP_6_C.:E05TOU  is referenced.
   CP_6.:E05TOU  cannot be made into a system file and is referenced.
      No diagnostics issued in procedure NMM$MIRROR.

   Procedure NMM$MIRROR requires 165 words for executable code.
   Procedure NMM$MIRROR requires 8 words of local(AUTO) storage.

    No errors detected in file NMM$MIRROR.:E05TSI    .

PL6.E3A0      #002=NMM$MIRROR File=NMM$MIRROR.:E05TSI                            WED 07/30/97 03:50 Page:36   

 Object Unit name= NMM$MIRROR                                 File name= NMM$MIRROR.:E05TOU
 UTS= JUL 30 '97 03:50:05.56 WED                              Compiler= PL-6/E31         Sev=      00
 SharedLib= :SHARED_SYSTEM                                    Alt SharedLib=


    ****  Control sections  ****

 Sect   Type Bound  Init  Size OctSiz  Section name(segment info)
    0   DCB   even  none     0      0  M$UC
    1   Data  even  none     7      7  NMM$MIRROR
    2  RoData even  UTS     14     16  NMM$MIRROR
    3   Proc  even  none   165    245  NMM$MIRROR
    4  RoData even  none    22     26  NMM$MIRROR

    ****  Entry defs  ****

                              Check   Calling
                             calling  sequence
  Sect OctLoc Primary Altret sequence   type   Parms  Name
     3      0   yes    yes     yes      Std        0  NMM$MIRROR
PL6.E3A0      #002=NMM$MIRROR File=NMM$MIRROR.:E05TSI                            WED 07/30/97 03:50 Page:37   

  ****  Entry refs  ****

         Check        Calling
        calling       sequence
Altret sequence SRef   type   Args  Name
 yes     yes           Std       2 NMO$DEV
 yes     yes           Std       1 NMV$NOTPART
 yes     yes           Std       3 NMU$READ
 yes     yes           Std       0 NMV$VSN
 yes     yes           Std       0 NMC$KOPY
 yes     yes           Std       3 NMU$WRITE
 yes     yes           Std       2 NMU$CHGSTATEMSG
 yes     yes           Std       1 NMV$SCRATCH
 yes     yes           Std       0 NMV$DEV
 yes     yes           Std       0 NMV$PACKSIZE
 yes     yes           Std       2 NMO$OPTIONS
 yes     yes           Std       0 NMV$DGT
 yes     yes           Std       1 NMV$NOTMIRRORED
         yes           Std       2 NMU$MIRROR_VID
         yes           Std       6 NME$ERRMSG
                       nStd      0 X66_AUTO_0
                       Std       0 B_CONSPOOL_D
                       nStd      0 X66_ARET
                       nStd      0 X66_AALT

  ****  Data refs  ****

  Flags:  r = read only, s = secondary
Flgs Name                             Flgs Name                             Flgs Name
     M$UC                                  B$TCB$                                NMD_PIT
     XUG_GETCMD                            B_VECTNIL
PL6.E3A0      #002=NMM$MIRROR File=NMM$MIRROR.:E05TSI                            WED 07/30/97 03:50 Page:38   

  ****  Segment refs  ****

  Flags:  r = read only, s = secondary
Flgs Name                             Flgs Name                             Flgs Name
     ISSID                                 NULLSID
PL6.E3A0      #002=NMM$MIRROR File=NMM$MIRROR.:E05TSI                            WED 07/30/97 03:50 Page:39   


      192        1        /*M* NMM$MIRROR - Procedure to perform MIRROR command.             */
      193        2        /*T***********************************************************/
      194        3        /*T*                                                         */
      195        4        /*T* Copyright (c) Bull HN Information Systems Inc., 1997    */
      196        5        /*T*                                                         */
      197        6        /*T***********************************************************/
      198        7        /*X* DFC=YES, DMC=YES, EDMC=YES                                    */
      199        8        /*F*
      200        9        NAME:           NMM$MIRROR
      201       10
      202       11        PURPOSE:        To perform the MIRROR command.
      203       12        */
      204       13        /*D*
      205       14        NAME:           NMM$MIRROR
      206       15
      207       16        CALL:           CALL NMM$MIRROR ALTRET ( error ) ;
      208       17
      209       18        PARAMETERS:
      210       19        */
      211       20        /*K*
      212       21        error           specifies a statement label to which NMM$MIRROR will
      213       22                make an altreturn if an error is detected.
      214       23        */
      215       24        /*D*
      216       25        DESCRIPTION:
      217       26
      218       27        The NMM$MIRROR procedure is used to perform the MIRROR command.
      219       28
      220       29        DPxx and DPyy must be a nonmirrored disk devices.
      221       30
      222       31        DPxx becomes the primary Mirrored Disk device.  DPyy becomes the
      223       32        secondary Mirrored Disk device.
      224       33
      225       34        DPxx is made operational.
      226       35
      227       36        If both DPxx and DPyy are single volume scratch devices, then
PL6.E3A0      #002=NMM$MIRROR File=NMM$MIRROR.:E05TSI                            WED 07/30/97 03:50 Page:40   
      228       37        DPyy is made OPERATIONAL.  Otherwise, if DPxx is not a single
      229       38        scratch volume, DPyy must be a single scratch volume and is
      230       39        made FAILED.
      231       40
      232       41        If DPyy is FAILED, DPxx is copied over DPyy.  And DPyy is then
      233       42        made operational.
      234       43                                                                           */
      235       44        NMM$MIRROR:     PROC    ALTRET ;

     44  3 000000   000000 700200 xent  NMM$MIRROR   TSX0  ! X66_AUTO_0
         3 000001   000010 000000                    ZERO    8,0

      236       45        /*
      237       46                                Includes
      238       47        */
      239       48        %INCLUDE                CP_6 ;
      240     5607        %INCLUDE                FM$GRAN ;
      241     5676        %INCLUDE                NI_DATA_C ;
      242     5789        %INCLUDE                NM_MACRO_M ;
      243     7194        %INCLUDE                NM_PERR_C ;
      244     7271        %INCLUDE                XU_MACRO_C ;
      245    10377        /*
      246    10378                        Entries
      247    10379        */
      248    10380    1   DCL 1 NMC$KOPY          ENTRY    ALTRET ;
      249    10381    1   DCL 1 NME$ERRMSG        ENTRY(6) ;
      250    10382    1   DCL 1 NMO$DEV           ENTRY(2) ALTRET ;
      251    10383    1   DCL 1 NMO$OPTIONS       ENTRY(2) ALTRET ;
      252    10384    1   DCL 1 NMU$CHGSTATEMSG   ENTRY(2) ALTRET ;
      253    10385    1   DCL 1 NMU$MIRROR_VID    ENTRY(2) ;
      254    10386    1   DCL 1 NMU$READ          ENTRY(3) ALTRET ;
      255    10387    1   DCL 1 NMU$WRITE         ENTRY(3) ALTRET ;
      256    10388    1   DCL 1 NMV$DEV           ENTRY    ALTRET ;
      257    10389    1   DCL 1 NMV$DGT           ENTRY    ALTRET ;
      258    10390    1   DCL 1 NMV$NOTMIRRORED   ENTRY(1) ALTRET ;
      259    10391    1   DCL 1 NMV$NOTPART       ENTRY(1) ALTRET ;
      260    10392    1   DCL 1 NMV$PACKSIZE      ENTRY    ALTRET ;
PL6.E3A0      #002=NMM$MIRROR File=NMM$MIRROR.:E05TSI                            WED 07/30/97 03:50 Page:41   
      261    10393    1   DCL 1 NMV$SCRATCH       ENTRY(1) ALTRET ;
      262    10394    1   DCL 1 NMV$VSN           ENTRY    ALTRET ;
      263    10395        /*
      264    10396                        Variables
      265    10397        */
      266    10398                                %B$ALT ( NAME =
      267    10399              B$ALT             , STCLASS = BASED
      268    10400                                                                        ) ;
      269    10408                                %B$TCB ( NAME =
      270    10409              B$TCB             , STCLASS = "BASED(B$TCB$)"
      271    10410                                                                        ) ;
      272    10413    1   DCL 1 B$TCB$            PTR SYMREF ;
      273    10414                                %FM$VID ( FM$VID =
      274    10415              FM$VID            , BASED = BASED
      275    10416                                                                        ) ;
      276    10422                                %FPT_MIRROR ( FPTN =
      277    10423              MAKE              , STCLASS  = STATIC
      278    10424                                , FUNCTION = MAKE
      279    10425                                , DCTX     = 0
      280    10426                                , DRZERO   = 0
      281    10427                                , MDCTX    = 0
      282    10428                                , MSTATE   = FAIL
      283    10429                                , STATE    = OPER
      284    10430                                , UTS      = 0
      285    10431                                                                        ) ;
      286    10454                                %NMD_PIT ( FPTN =
      287    10455              NMD_PIT           , STCLASS = SYMREF
      288    10456                                                                        ) ;
      289    10909                                %VLP_ERRCODE ( FPTN =
      290    10910              NMM#NOT_SCRATCH   , STCLASS = CONSTANT
      291    10911                                , ERR# = %E$NMD#NOT_SCRATCH
      292    10912                                , FCG  = %NMD#FCG
      293    10913                                , MID  = 'M'
      294    10914                                , MON  = %NO#
      295    10915                                , SEV  = 5
      296    10916                                                                        ) ;
      297    10961                                %PARSE$OUT ( NAME =
PL6.E3A0      #002=NMM$MIRROR File=NMM$MIRROR.:E05TSI                            WED 07/30/97 03:50 Page:42   
      298    10962              OUT               , STCLASS ="BASED(XUG_GETCMD.OUT$)"
      299    10963                                                                        ) ;
      300    11008                                %FPT_TIME ( FPTN =
      301    11009              TIME              , STCLASS = CONSTANT
      302    11010                                , DEST = UTS
      303    11011                                , SOURCE = CLOCK
      304    11012                                , TSTAMP = UTS
      305    11013                                                                        ) ;
      306    11032    1   DCL 1 UTS               UBIN WORD ALIGNED STATIC ;
      307    11033                                %NMD_VID ( FPTN =
      308    11034              VID               , STCLASS = BASED
      309    11035                                                                        ) ;
      310    11052                                %XUG_GETCMD ( NAME =
      311    11053              XUG_GETCMD        , STCLASS = SYMREF
      312    11054                                                                        ) ;
      313    11392        %EJECT ;
PL6.E3A0      #002=NMM$MIRROR File=NMM$MIRROR.:E05TSI                            WED 07/30/97 03:50 Page:43   
      314    11393        /*
      315    11394        Process the devices and options specified on the command.
      316    11395        */
      317    11396    1           CALL NMO$DEV ( 0, OUT.SUBLK$(0) )       ALTRET ( ERROR ) ;

  11396  3 000002   000001 236000 xsym               LDQ     XUG_GETCMD+1
         3 000003   000003 036003                    ADLQ    3,DU
         3 000004   000000 235000 4                  LDA     0
         3 000005   200004 757100                    STAQ    4,,AUTO
         3 000006   200004 630500                    EPPR0   4,,AUTO
         3 000007   000020 631400 xsym               EPPR1   B_VECTNIL+16
         3 000010   000000 701000 xent               TSX1    NMO$DEV
         3 000011   000244 702000 3                  TSX2    ERROR

      318    11397    1           CALL NMO$DEV ( 1, OUT.SUBLK$(1) )       ALTRET ( ERROR ) ;

  11397  3 000012   000001 236000 xsym               LDQ     XUG_GETCMD+1
         3 000013   000004 036003                    ADLQ    4,DU
         3 000014   000001 235000 4                  LDA     1
         3 000015   200004 757100                    STAQ    4,,AUTO
         3 000016   200004 630500                    EPPR0   4,,AUTO
         3 000017   000020 631400 xsym               EPPR1   B_VECTNIL+16
         3 000020   000000 701000 xent               TSX1    NMO$DEV
         3 000021   000244 702000 3                  TSX2    ERROR

      319    11398    1           CALL NMO$OPTIONS ( 2, OUT.NSUBLKS-1 )   ALTRET ( ERROR ) ;

  11398  3 000022   000001 470400 xsym               LDP0    XUG_GETCMD+1
         3 000023   000001 236100                    LDQ     1,,PR0
         3 000024   000022 772000                    QRL     18
         3 000025   000001 136007                    SBLQ    1,DL
         3 000026   200004 756100                    STQ     4,,AUTO
         3 000027   200004 631500                    EPPR1   4,,AUTO
         3 000030   200007 451500                    STP1    7,,AUTO
         3 000031   000002 236000 4                  LDQ     2
         3 000032   200006 756100                    STQ     6,,AUTO
         3 000033   200006 630500                    EPPR0   6,,AUTO
PL6.E3A0      #002=NMM$MIRROR File=NMM$MIRROR.:E05TSI                            WED 07/30/97 03:50 Page:44   
         3 000034   000020 631400 xsym               EPPR1   B_VECTNIL+16
         3 000035   000000 701000 xent               TSX1    NMO$OPTIONS
         3 000036   000244 702000 3                  TSX2    ERROR

      320    11399        /*
      321    11400        Verify that the specified devices are not currently mirrored disks
      322    11401        and that they are the same size.  If they are, then read the VIDS,
      323    11402        check the VSNs, DGTs, and that either both devices are scratch
      324    11403        devices or that at least DEV(1) is a scratch device.
      325    11404        */
      326    11405    1           CALL NMV$NOTMIRRORED ( 0 )              ALTRET ( ERROR ) ;

  11405  3 000037   000000 630400 4                  EPPR0   0
         3 000040   000017 631400 xsym               EPPR1   B_VECTNIL+15
         3 000041   000000 701000 xent               TSX1    NMV$NOTMIRRORED
         3 000042   000244 702000 3                  TSX2    ERROR

      327    11406    1           CALL NMV$NOTMIRRORED ( 1 )              ALTRET ( ERROR ) ;

  11406  3 000043   000001 630400 4                  EPPR0   1
         3 000044   000017 631400 xsym               EPPR1   B_VECTNIL+15
         3 000045   000000 701000 xent               TSX1    NMV$NOTMIRRORED
         3 000046   000244 702000 3                  TSX2    ERROR

      328    11407    1           CALL NMV$NOTPART     ( 0 )              ALTRET ( ERROR ) ;

  11407  3 000047   000000 630400 4                  EPPR0   0
         3 000050   000017 631400 xsym               EPPR1   B_VECTNIL+15
         3 000051   000000 701000 xent               TSX1    NMV$NOTPART
         3 000052   000244 702000 3                  TSX2    ERROR

      329    11408    1           CALL NMV$NOTPART     ( 1 )              ALTRET ( ERROR ) ;

  11408  3 000053   000001 630400 4                  EPPR0   1
         3 000054   000017 631400 xsym               EPPR1   B_VECTNIL+15
         3 000055   000000 701000 xent               TSX1    NMV$NOTPART
         3 000056   000244 702000 3                  TSX2    ERROR
PL6.E3A0      #002=NMM$MIRROR File=NMM$MIRROR.:E05TSI                            WED 07/30/97 03:50 Page:45   

      330    11409    1           CALL NMV$DEV                            ALTRET ( ERROR ) ;

  11409  3 000057   000002 631400 xsym               EPPR1   B_VECTNIL+2
         3 000060   000000 701000 xent               TSX1    NMV$DEV
         3 000061   000244 702000 3                  TSX2    ERROR

      331    11410    1           CALL NMV$PACKSIZE                       ALTRET ( ERROR ) ;

  11410  3 000062   000002 631400 xsym               EPPR1   B_VECTNIL+2
         3 000063   000000 701000 xent               TSX1    NMV$PACKSIZE
         3 000064   000244 702000 3                  TSX2    ERROR

      332    11411
      333    11412    1           CALL NMU$READ ( 0, 0, NMD_PIT.DEV.VID_(0) )

  11412  3 000065   000003 630400 4                  EPPR0   3
         3 000066   000021 631400 xsym               EPPR1   B_VECTNIL+17
         3 000067   000000 701000 xent               TSX1    NMU$READ
         3 000070   000244 702000 3                  TSX2    ERROR

      334    11413    1                                                   ALTRET ( ERROR ) ;
      335    11414    1           CALL NMU$READ ( 1, 0, NMD_PIT.DEV.VID_(1) )

  11414  3 000071   000006 630400 4                  EPPR0   6
         3 000072   000021 631400 xsym               EPPR1   B_VECTNIL+17
         3 000073   000000 701000 xent               TSX1    NMU$READ
         3 000074   000244 702000 3                  TSX2    ERROR

      336    11415    1                                                   ALTRET ( ERROR ) ;
      337    11416
      338    11417    1           CALL NMV$VSN                            ALTRET ( ERROR ) ;

  11417  3 000075   000002 631400 xsym               EPPR1   B_VECTNIL+2
         3 000076   000000 701000 xent               TSX1    NMV$VSN
         3 000077   000244 702000 3                  TSX2    ERROR

PL6.E3A0      #002=NMM$MIRROR File=NMM$MIRROR.:E05TSI                            WED 07/30/97 03:50 Page:46   
      339    11418    1           CALL NMV$DGT                            ALTRET ( ERROR ) ;

  11418  3 000100   000002 631400 xsym               EPPR1   B_VECTNIL+2
         3 000101   000000 701000 xent               TSX1    NMV$DGT
         3 000102   000244 702000 3                  TSX2    ERROR

      340    11419    1           CALL NMV$SCRATCH ( 0 )                  /*  NO ALTRET  */;

  11419  3 000103   000000 630400 4                  EPPR0   0
         3 000104   000017 631400 xsym               EPPR1   B_VECTNIL+15
         3 000105   000000 701000 xent               TSX1    NMV$SCRATCH
         3 000106   000000 011000                    NOP     0

      341    11420    1           CALL NMV$SCRATCH ( 1 )

  11420  3 000107   000001 630400 4                  EPPR0   1
         3 000110   000017 631400 xsym               EPPR1   B_VECTNIL+15
         3 000111   000000 701000 xent               TSX1    NMV$SCRATCH
         3 000112   000114 702000 3                  TSX2    s:11429
         3 000113   000126 710000 3                  TRA     s:11436

      342    11421    2           WHENALTRETURN DO ;

      343    11422        /*E*
      344    11423        ERROR:  NMM-E$NMD#NOT_SCRATCH-5
      345    11424        MESSAGE:  %U1 is not a scratch device.
      346    11425        DESCRIPTION:  For the specified command, the device must be
      347    11426                      a scratch device (i.e., a single volume scratch
      348    11427                      pack).
      349    11428        */
      350    11429    2               CALL NME$ERRMSG ( NMM#NOT_SCRATCH, ,

  11429  3 000114   000014 236000 4                  LDQ     12
         3 000115   200006 756100                    STQ     6,,AUTO
         3 000116   000001 236000 xsym               LDQ     B_VECTNIL+1
         3 000117   000015 235000 4                  LDA     13
         3 000120   200004 757100                    STAQ    4,,AUTO
PL6.E3A0      #002=NMM$MIRROR File=NMM$MIRROR.:E05TSI                            WED 07/30/97 03:50 Page:47   
         3 000121   200004 630500                    EPPR0   4,,AUTO
         3 000122   000021 631400 xsym               EPPR1   B_VECTNIL+17
         3 000123   000000 701000 xent               TSX1    NME$ERRMSG
         3 000124   000000 011000                    NOP     0

      351    11430    2                                 VECTOR(NMD_PIT.DEV.NAME(1)) ) ;
      352    11431    2               GOTO ERROR ;

  11431  3 000125   000244 710000 3                  TRA     ERROR

      353    11432    2               END ;
      354    11433        /*
      355    11434        Get the current UTS for this MIRROR operation.
      356    11435        */
      357    11436    1           CALL M$TIME ( TIME )                    ALTRET ( ALTERR ) ;

  11436  3 000126   000002 630400 2                  EPPR0   TIME
         3 000127   420004 713400                    CLIMB   alt,+8196
         3 000130   402000 401760                    pmme    nvectors=5
         3 000131   000234 702000 3                  TSX2    ALTERR

      358    11437        /*
      359    11438        Determine the states for the Mirrored Disk devices.
      360    11439        */
      361    11440    1           NMD_PIT.DEV.STATE(0) = %NI_MIRROR_OPER ;

  11440  3 000132   000025 450000 xsym               STZ     NMD_PIT+21

      362    11441    1           IF  NMD_PIT.DEV.FLAGS.SCRATCH(0)

  11441  3 000133   000014 236000 xsym               LDQ     NMD_PIT+12
         3 000134   100000 316003                    CANQ    32768,DU
         3 000135   000140 600000 3                  TZE     s:11445

      363    11442    1           THEN
      364    11443    1               NMD_PIT.DEV.STATE(1) = %NI_MIRROR_OPER ;

PL6.E3A0      #002=NMM$MIRROR File=NMM$MIRROR.:E05TSI                            WED 07/30/97 03:50 Page:48   
  11443  3 000136   000057 450000 xsym               STZ     NMD_PIT+47
         3 000137   000142 710000 3                  TRA     s:11453

      365    11444    1           ELSE
      366    11445    1               NMD_PIT.DEV.STATE(1) = %NI_MIRROR_FAIL ;

  11445  3 000140   000001 235007                    LDA     1,DL
         3 000141   000057 755000 xsym               STA     NMD_PIT+47

      367    11446
      368    11447        /*
      369    11448        Update the VID on the primary device if the secondary
      370    11449        device is operational.  (If secondary device is not operational,
      371    11450        the VID on the primary device will be updated only after
      372    11451        the COPY operation has been successfully completed.)
      373    11452        */
      374    11453    1           IF  NMD_PIT.DEV.STATE(1) = %NI_MIRROR_OPER

  11453  3 000142   000057 235000 xsym               LDA     NMD_PIT+47
         3 000143   000154 601000 3                  TNZ     s:11462

      375    11454    2           THEN DO ;

      376    11455    2               CALL NMU$MIRROR_VID ( 0, UTS ) ;

  11455  3 000144   000016 630400 4                  EPPR0   14
         3 000145   000020 631400 xsym               EPPR1   B_VECTNIL+16
         3 000146   000000 701000 xent               TSX1    NMU$MIRROR_VID
         3 000147   000000 011000                    NOP     0

      377    11456    2               CALL NMU$WRITE      ( 0, 0, NMD_PIT.DEV.VID_(0) )

  11456  3 000150   000003 630400 4                  EPPR0   3
         3 000151   000021 631400 xsym               EPPR1   B_VECTNIL+17
         3 000152   000000 701000 xent               TSX1    NMU$WRITE
         3 000153   000244 702000 3                  TSX2    ERROR

PL6.E3A0      #002=NMM$MIRROR File=NMM$MIRROR.:E05TSI                            WED 07/30/97 03:50 Page:49   
      378    11457    2                                                   ALTRET ( ERROR ) ;
      379    11458    2               END ;

      380    11459        /*
      381    11460        Update the VID on the secondary device.
      382    11461        */
      383    11462    1           NMD_PIT.DEV.VID$(1)->VID                    = NMD_PIT.DEV.VID$(0)->VID ;

  11462  3 000154   000032 470400 xsym               LDP0    NMD_PIT+26
         3 000155   010000 220003                    LDX0    4096,DU
         3 000156   000064 471400 xsym               LDP1    NMD_PIT+52
         3 000157   000140 100540                    MLR     fill='000'O
         3 000160   000000 000010                    ADSC9   0,,PR0                   cn=0,n=*X0
         3 000161   100000 000010                    ADSC9   0,,PR1                   cn=0,n=*X0

      384    11463
      385    11464    1           CALL NMU$MIRROR_VID ( 1, UTS ) ;

  11464  3 000162   000020 630400 4                  EPPR0   16
         3 000163   000020 631400 xsym               EPPR1   B_VECTNIL+16
         3 000164   000000 701000 xent               TSX1    NMU$MIRROR_VID
         3 000165   000000 011000                    NOP     0

      386    11465    1           CALL NMU$WRITE      ( 1, 0, NMD_PIT.DEV.VID_(1) )

  11465  3 000166   000006 630400 4                  EPPR0   6
         3 000167   000021 631400 xsym               EPPR1   B_VECTNIL+17
         3 000170   000000 701000 xent               TSX1    NMU$WRITE
         3 000171   000244 702000 3                  TSX2    ERROR

      387    11466    1                                                   ALTRET ( ERROR ) ;
      388    11467        /*
      389    11468        Initialize FPT values and create a Mirrored Disk pair.
      390    11469        */
      391    11470    1           MAKE.V.DCTX#    = NMD_PIT.DEV.DCTX(0) ;

  11470  3 000172   000011 720000 xsym               LXL0    NMD_PIT+9
PL6.E3A0      #002=NMM$MIRROR File=NMM$MIRROR.:E05TSI                            WED 07/30/97 03:50 Page:50   
         3 000173   000002 440000 1                  SXL0    MAKE+2

      392    11471    1           MAKE.V.DRZERO#  = NMD_PIT.DEV.DRZERO(0) ;

  11471  3 000174   000012 235000 xsym               LDA     NMD_PIT+10
         3 000175   000004 755000 1                  STA     MAKE+4

      393    11472    1           MAKE.V.MDCTX#   = NMD_PIT.DEV.DCTX(1) ;

  11472  3 000176   000043 721000 xsym               LXL1    NMD_PIT+35
         3 000177   000003 441000 1                  SXL1    MAKE+3

      394    11473    1           MAKE.V.MSTATE#  = NMD_PIT.DEV.STATE(1) ;

  11473  3 000200   000057 236000 xsym               LDQ     NMD_PIT+47
         3 000201   000030 736000                    QLS     24
         3 000202   000003 752020 1                  STCQ    MAKE+3,'20'O

      395    11474    1           MAKE.V.PRIMARY# = '1'B ;

  11474  3 000203   000040 236003                    LDQ     32,DU
         3 000204   000002 256000 1                  ORSQ    MAKE+2

      396    11475    1           MAKE.V.STATE#   = NMD_PIT.DEV.STATE(0) ;

  11475  3 000205   000025 236000 xsym               LDQ     NMD_PIT+21
         3 000206   000030 736000                    QLS     24
         3 000207   000002 752020 1                  STCQ    MAKE+2,'20'O

      397    11476    1           MAKE.V.UTS#     = UTS ;

  11476  3 000210   000006 236000 1                  LDQ     UTS
         3 000211   000005 756000 1                  STQ     MAKE+5

      398    11477
      399    11478    1           CALL M$MIRROR ( MAKE )                  ALTRET ( ALTERR ) ;

PL6.E3A0      #002=NMM$MIRROR File=NMM$MIRROR.:E05TSI                            WED 07/30/97 03:50 Page:51   
  11478  3 000212   000000 630400 1                  EPPR0   MAKE
         3 000213   470010 713400                    CLIMB   alt,+28680
         3 000214   400000 401760                    pmme    nvectors=1
         3 000215   000234 702000 3                  TSX2    ALTERR

      400    11479        /*
      401    11480        Output messages for the state of each Mirrored Disk device.
      402    11481        */
      403    11482    1           CALL NMU$CHGSTATEMSG ( 0, NMD_PIT.DEV.STATE(0) ) ;

  11482  3 000216   000022 630400 4                  EPPR0   18
         3 000217   000020 631400 xsym               EPPR1   B_VECTNIL+16
         3 000220   000000 701000 xent               TSX1    NMU$CHGSTATEMSG
         3 000221   000000 011000                    NOP     0

      404    11483    1           CALL NMU$CHGSTATEMSG ( 1, NMD_PIT.DEV.STATE(1) ) ;

  11483  3 000222   000024 630400 4                  EPPR0   20
         3 000223   000020 631400 xsym               EPPR1   B_VECTNIL+16
         3 000224   000000 701000 xent               TSX1    NMU$CHGSTATEMSG
         3 000225   000000 011000                    NOP     0

      405    11484        /*
      406    11485        If the secondary device is not operational, perform COPY command.
      407    11486        */
      408    11487    1           IF  NMD_PIT.DEV.STATE(1) ~= %NI_MIRROR_OPER

  11487  3 000226   000057 235000 xsym               LDA     NMD_PIT+47
         3 000227   000233 600000 3                  TZE     s:11493

      409    11488    1           THEN
      410    11489    1               CALL NMC$KOPY                       ALTRET ( ERROR ) ;

  11489  3 000230   000002 631400 xsym               EPPR1   B_VECTNIL+2
         3 000231   000000 701000 xent               TSX1    NMC$KOPY
         3 000232   000244 702000 3                  TSX2    ERROR

PL6.E3A0      #002=NMM$MIRROR File=NMM$MIRROR.:E05TSI                            WED 07/30/97 03:50 Page:52   
      411    11490        /*
      412    11491        Return to the calling procedure.
      413    11492        */
      414    11493    1           RETURN ;

  11493  3 000233   000000 702200 xent               TSX2  ! X66_ARET

      415    11494
      416    11495    1   ALTERR: CALL NME$ERRMSG ( B$TCB.ALT$->B$ALT.ERR ) ;

  11495  3 000234   000000 470400 xsym  ALTERR       LDP0    B$TCB$
         3 000235   000000 471500                    LDP1    0,,PR0
         3 000236   100102 633500                    EPPR3   66,,PR1
         3 000237   200004 453500                    STP3    4,,AUTO
         3 000240   200004 630500                    EPPR0   4,,AUTO
         3 000241   000017 631400 xsym               EPPR1   B_VECTNIL+15
         3 000242   000000 701000 xent               TSX1    NME$ERRMSG
         3 000243   000000 011000                    NOP     0

      417    11496
      418    11497    1   ERROR:  ALTRETURN ;

  11497  3 000244   000000 702200 xent  ERROR        TSX2  ! X66_AALT
      419    11498
      420    11499    1           END NMM$MIRROR ;

PL6.E3A0      #002=NMM$MIRROR File=NMM$MIRROR.:E05TSI                            WED 07/30/97 03:50 Page:53   
--  Include file information  --

   XU_MACRO_C.:E05TOU  is referenced.
   NM_PERR_C.:E05TOU  is referenced.
   NM_SUBS_C.:E05TOU  is referenced.
   NM_EQU_E.:E05TOU  is referenced.
   CP_6_SUBS.:E05TOU  is referenced.
   NM_MACRO_M.:E05TOU  is referenced.
   NI_DATA_C.:E05TOU  is referenced.
   FM$GRAN.:E05TOU  is referenced.
   CP_6_C.:E05TOU  is referenced.
   CP_6.:E05TOU  cannot be made into a system file and is referenced.
      No diagnostics issued in procedure NMM$MIRROR.
PL6.E3A0      #002=NMM$MIRROR File=NMM$MIRROR.:E05TSI                            WED 07/30/97 03:50 Page:54   

 **** Variables and constants ****

  ****  Section 001  Data  NMM$MIRROR

  ****  Scalars and arrays  ****
OctLoc.c.b A Datatyp(siz) R M Lvl/name                 OctLoc.c.b A Datatyp(siz) R M Lvl/name

     0-0-0/d STRC(216)   r     1 MAKE                       6-0-0/w UBIN        r     1 UTS

  ****  Section 002 RoData NMM$MIRROR

  ****  Scalars and arrays  ****
OctLoc.c.b A Datatyp(siz) R M Lvl/name                 OctLoc.c.b A Datatyp(siz) R M Lvl/name

     0-0-0/w STRC        r     1 NMM#NOT_SCRATCH            2-0-0/d STRC(432)   r     1 TIME

  ****  SYMREF variables  ****

  ****  Scalars and arrays  ****
OctLoc.c.b A Datatyp(siz) R M Lvl/name                 OctLoc.c.b A Datatyp(siz) R M Lvl/name

     0-0-0/w PTR         r     1 B$TCB$                     0-0-0/d STRC(8892)  r     1 NMD_PIT
     0-0-0/d STRC(1512)  r     1 XUG_GETCMD

  ****  BASED and DCB variables  ****

  ****  Scalars and arrays  ****
OctLoc.c.b A Datatyp(siz) R M Lvl/name                 OctLoc.c.b A Datatyp(siz) R M Lvl/name

     0-0-0/w STRC(2448)  r     1 B$ALT                      0-0-0/w STRC(144)   r     1 B$TCB
     0-0-0/w STRC(144)   r     1 OUT                        0-0-0/w UBIN        r     1 VID(0:1023)


   Procedure NMM$MIRROR requires 165 words for executable code.
   Procedure NMM$MIRROR requires 8 words of local(AUTO) storage.
PL6.E3A0      #002=NMM$MIRROR File=NMM$MIRROR.:E05TSI                            WED 07/30/97 03:50 Page:55   

    No errors detected in file NMM$MIRROR.:E05TSI    .
PL6.E3A0      #002=NMM$MIRROR File=NMM$MIRROR.:E05TSI                            WED 07/30/97 03:50 Page:56   
          *** CROSS REFERENCE LISTING ***
**     DENOTES     IDENTIFIER DEFINITION
<<                 IDENTIFIER'S VALUE SET
>>                 IDENTIFIER'S VALUE USED
<>                 IDENTIFIER SET AND/OR USED
--                 IDENTIFIER REFERENCED
PL6.E3A0      #002=NMM$MIRROR File=NMM$MIRROR.:E05TSI                            WED 07/30/97 03:50 Page:57   
          MINI XREF LISTING

ALTERR
     11495**LABEL   11436--CALLALT 11478--CALLALT
B$ALT.CODE
     10402**DCL     10402--REDEF   10403--REDEF   10403--REDEF
B$ALT.ERR
     10403**DCL     11495<>CALL
B$ALT.ERR.ERR#
     10404**DCL     10404--REDEF
B$ALT.EVID
     10403**DCL     10403--REDEF   10403--REDEF
B$TCB.ALT$
     10411**DCL     11495>>CALL
B$TCB$
     10413**DCL     10411--IMP-PTR 11495>>CALL
ERROR
     11497**LABEL   11396--CALLALT 11397--CALLALT 11398--CALLALT 11405--CALLALT 11406--CALLALT 11407--CALLALT
     11408--CALLALT 11409--CALLALT 11410--CALLALT 11412--CALLALT 11414--CALLALT 11417--CALLALT 11418--CALLALT
     11431--GOTO    11456--CALLALT 11465--CALLALT 11489--CALLALT
FM$VID.DTT
     10419**DCL     10419--REDEF
M$MIRROR
      5586**DCL-ENT 11478--CALL
M$TIME
      5602**DCL-ENT 11436--CALL
MAKE
     10448**DCL     11478<>CALL
MAKE.V
     10448**DCL     10448--DCLINIT
MAKE.V.DCTX#
     10450**DCL     11470<<ASSIGN
MAKE.V.DRZERO#
     10451**DCL     11471<<ASSIGN
PL6.E3A0      #002=NMM$MIRROR File=NMM$MIRROR.:E05TSI                            WED 07/30/97 03:50 Page:58   
MAKE.V.MDCTX#
     10451**DCL     11472<<ASSIGN
MAKE.V.MSTATE#
     10450**DCL     11473<<ASSIGN
MAKE.V.PRIMARY#
     10449**DCL     11474<<ASSIGN
MAKE.V.STATE#
     10449**DCL     11475<<ASSIGN
MAKE.V.UTS#
     10452**DCL     11476<<ASSIGN
NMC$KOPY
     10380**DCL-ENT 11489--CALL
NMD_PIT.DEV.DCTX
     10522**DCL     11470>>ASSIGN  11472>>ASSIGN
NMD_PIT.DEV.DRZERO
     10527**DCL     11471>>ASSIGN
NMD_PIT.DEV.FLAGS.SCRATCH
     10552**DCL     11441>>IF
NMD_PIT.DEV.NAME
     10572**DCL     11429--CALL
NMD_PIT.DEV.STATE
     10597**DCL     11440<<ASSIGN  11443<<ASSIGN  11445<<ASSIGN  11453>>IF      11473>>ASSIGN  11475>>ASSIGN
     11482<>CALL    11483<>CALL    11487>>IF
NMD_PIT.DEV.VID$
     10619**DCL     11462>>ASSIGN  11462>>ASSIGN
NMD_PIT.DEV.VID_
     10613**DCL     11412<>CALL    11414<>CALL    11456<>CALL    11465<>CALL
NME$ERRMSG
     10381**DCL-ENT 11429--CALL    11495--CALL
NMM#NOT_SCRATCH
     10928**DCL     11429<>CALL
NMO$DEV
     10382**DCL-ENT 11396--CALL    11397--CALL
NMO$OPTIONS
     10383**DCL-ENT 11398--CALL
NMU$CHGSTATEMSG
PL6.E3A0      #002=NMM$MIRROR File=NMM$MIRROR.:E05TSI                            WED 07/30/97 03:50 Page:59   
     10384**DCL-ENT 11482--CALL    11483--CALL
NMU$MIRROR_VID
     10385**DCL-ENT 11455--CALL    11464--CALL
NMU$READ
     10386**DCL-ENT 11412--CALL    11414--CALL
NMU$WRITE
     10387**DCL-ENT 11456--CALL    11465--CALL
NMV$DEV
     10388**DCL-ENT 11409--CALL
NMV$DGT
     10389**DCL-ENT 11418--CALL
NMV$NOTMIRRORED
     10390**DCL-ENT 11405--CALL    11406--CALL
NMV$NOTPART
     10391**DCL-ENT 11407--CALL    11408--CALL
NMV$PACKSIZE
     10392**DCL-ENT 11410--CALL
NMV$SCRATCH
     10393**DCL-ENT 11419--CALL    11420--CALL
NMV$VSN
     10394**DCL-ENT 11417--CALL
OUT.NSUBLKS
     10981**DCL     11398>>CALL
OUT.SUBLK$
     11002**DCL     11396<>CALL    11397<>CALL
TIME
     11024**DCL     11436<>CALL
TIME.V
     11028**DCL     11024--DCLINIT
UTS
     11032**DCL     11028--DCLINIT 11455<>CALL    11464<>CALL    11476>>ASSIGN
VID
     11049**DCL     11462<<ASSIGN  11462>>ASSIGN
XUG_GETCMD.OUT$
     11072**DCL     10969--IMP-PTR 11078--REDEF   11396>>CALL    11397>>CALL    11398>>CALL
