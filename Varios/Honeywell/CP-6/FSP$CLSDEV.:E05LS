VERSION E05

PL6.E3A0      #001=FSP$CLSDEV File=FSP$CLSDEV.:E05TSI                            TUE 07/29/97 17:37 Page:1    
        1        1        /*M* FSP$CLSDEV  CLOSE A DEVICE DCB. */
        2        2        /*T***********************************************************/
        3        3        /*T*                                                         */
        4        4        /*T* Copyright (c) Bull HN Information Systems Inc., 1997    */
        5        5        /*T*                                                         */
        6        6        /*T***********************************************************/
        7        7        /*X* CLM=8,ICP,MOC,DMR */
        8        8        /*P*    NAME: FSP$CLSDEV
        9        9                PURPOSE: Close a Device DCB.
       10       10         */
       11       11        /*F*    NAME: FSP$CLSDEV
       12       12                PURPOSE: Close a Device DCB.
       13       13                DESCRIPTION:  FSP$CLSDEV closes DCB's whose ASN=DEVICE.
       14       14                   The DCB M$UC does not get closed.  It remains open for
       15       15                   the entire job, since it carries information about an
       16       16                   interactive user's terminal.
       17       17                   Tape device DCB's are closed by common tape logic.
       18       18                   The resource devices associated with resource device DCB's
       19       19                   are processed by Resource Management code.
       20       20                   The symbiont file attached to a workstation-assigned DCB
       21       21                   is closed and handed to OUTSYM.
       22       22                   The symbiont file attached to a logical-device-assigned DCB
       23       23                   is closed if this DCB is the only one open to it.
       24       24                   The command file attached to a command-stream DCB is
       25       25                   closed if this DCB is the only one open to it.
       26       26                   An ORG=FPRG DCB is closed by first requesting disconnect
       27       27                   on the path causing the FEP user to be run down. Also the
       28       28                   DCB that is pointed to by CFU$, which is open to the
       29       29                   current run unit is closed and released.
       30       30         */
       31       31        /*D*    NAME: FSP$CLSDEV
       32       32                CALL: CALL FSP$CLSDEV(PN$) ALTRET;
       33       33                      PN$ is the PTR-flavored version of an M$CLOSE FPT.
       34       34                      ALTRET if DCB is M$UC, which cannot be closed.
       35       35                INTERFACE: FMN$CLSDP,FMP$CLSF,FRB$CLS,FTC$CLOSE.
       36       36                ENVIRONMENT: Monitor (for user) LS.
       37       37                INPUT: DCB (B$JIT.DCB$).
PL6.E3A0      #001=FSP$CLSDEV File=FSP$CLSDEV.:E05TSI                            TUE 07/29/97 17:37 Page:2    
       38       38                      Control-command state indicator (B$ROSEG.CR01ID).
       39       39                      Logical device state indicator (B$ROSEG.STREAMID).
       40       40                OUTPUT: DCB marked closed.
       41       41                      State indicators may be changed.
       42       42                DESCRIPTION:
       43       43         */
       44       44        FSP$CLSDEV: PROC(PN$) ALTRET;
       45       45    1   DCL FMN$CLSDP ENTRY(1) ALTRET; /* CLOSE DEVICE DP FOR PIG/VOLINIT    */
       46       46    1   DCL KUW$WRITE ENTRY(3) ALTRET; /* Report event to Prescan.*/
       47       47    1   DCL FSA$FDCB ENTRY(1); /* Free a DCB's ROSEG space */
       48       48    1   DCL FMP$CLSF ENTRY(1);
       49       49    1   DCL FMP$CLSJ ENTRY;
       50       50    1   DCL FRB$CLS ENTRY;
       51       51    1   DCL FMB$IOSPIN ENTRY;
       52       52    1   DCL FMD$RELBUF ENTRY(1);
       53       53    1   DCL FMF$REMOTE ENTRY(1);
       54       54    1   DCL FMM$RELDCBI ENTRY;
       55       55    1   DCL FMH$SYMB_FINISH  ENTRY (3) ALTRET;
       56       56    1   DCL FRF$EVRPT ENTRY(1) ALTRET;
       57       57    1   DCL FSD$C1END ENTRY ALTRET; /* dump after-ended XEQ file.*/
       58       58    1   DCL FSD$JFCLS ENTRY(1); /* Close JF (XEQ file Create) DCB.*/
       59       59    1   DCL FSL$ACCT ENTRY(3); /*Account for symbionts*/
       60       60    1   DCL FSX$TELLOUTSYM ENTRY(3);
       61       61    1   DCL FTC$CLOSE ENTRY(1); /*Open to tape (Device Tape here).*/
       62       62    1   DCL FPC$CLSOD ENTRY (1); /* Open to optical disc as device  */
       63       63    1   DCL KIA$CLSSTR ENTRY(3) ALTRET;
       64       64    1   DCL KIA$DSCU ENTRY(3) ALTRET;
       65       65    1   DCL KIA$FCNOU ENTRY(3) ALTRET;
       66       66    1   DCL KIS$OSI_CLOSE ENTRY(0) ALTRET;
       67       67    1   DCL KCO$CLCG ENTRY(1);
       68       68    1   DCL NKL$RELDCTL ENTRY(1) ALTRET;
       69       69    1   DCL OCZ$SID_UN ENTRY(4) ALTRET;
       70       70    1   DCL SSR$REG ENTRY(3) ALTRET;
       71       71    1   DCL SSS$BLOCK ENTRY;
       72       72    1   DCL SSV$EVENT ENTRY(7);
       73       73        /*** * * * ***/
       74       74    1   DCL B$JIT$ PTR SYMREF READONLY; /* Note B$JIT is BASED(B$JIT$).       */
PL6.E3A0      #001=FSP$CLSDEV File=FSP$CLSDEV.:E05TSI                            TUE 07/29/97 17:37 Page:3    
       75       75    1   DCL B$ROSEG$ PTR SYMREF READONLY;
       76       76    1   DCL B$M$UC$ PTR SYMREF READONLY;
       77       77    1   DCL B$USRT$ PTR SYMREF;
       78       78    1   DCL S$CU$ PTR SYMREF;
       79       79    1   DCL S_CUN UBIN SYMREF;
       80       80    1   DCL J_PRESCAN CHAR(8) SYMREF READONLY;
       81       81        /*** * * * ***/
       82       82        %INCLUDE B$JIT;
       83      685        %INCLUDE CP_6_SUBS;
       84     1225        %INCLUDE HF_LOCK_C;
       85     1239        %INCLUDE K_DATA_R;
       86     1950        %INCLUDE CP_6;
       87     7509        %INCLUDE B$USER;
       88     7725        %FPT_CLOSE(FPTN=PN$,PFMT=PTR,STCLASS=);
       89     7767        %INCLUDE FM$MACROS;
       90     8142        %FM$CFU;
       91     8148        %CODE16;
       92     8156        %INCLUDE F_FMTCODE_C;
       93     8190        %INCLUDE F_ERRORS_C;
       94     8430        %SUB FCG#='0623'O;
       95     8431        %SUB MID#='20'O;
       96     8432        %ERRCODE (NAME=ERR_NOCLSMUC,COD#=%E$NOCLSMUC,SEV#=0);
       97     8436        %ERRCODE (NAME=ERR_EOF,COD#=%E$EOF,SEV#=2);
       98     8440        %MACRO B$ROSEG(BASED=BASED);
       99     8441        %INCLUDE B$ROSEG;
      100     8504        %MEND;
      101     8505        %B$ROSEG(BASED="BASED(B$ROSEG$)");
      102     8565        %INCLUDE F$CP6V_C;
      103     8791        %MACRO F$DCBI(BASED=BASED);
      104     8792        %INCLUDE F$DCB;
      105     8841        %MEND;
      106     8842        %F$DCBI(BASED="BASED(JDCB$)");
      107     8892        %INCLUDE JP_MACRO_C;
      108     9047        %INCLUDE JG_EVID_C;
      109     9272        %INCLUDE FS$FIT;
      110     9315        %FS_OSFN(FPTN=OSFN,STCLASS=BASED);
      111     9329        %INCLUDE B_STRINGS_C;
PL6.E3A0      #001=FSP$CLSDEV File=FSP$CLSDEV.:E05TSI                            TUE 07/29/97 17:37 Page:4    
      112     9458        %FPT_CLOSE(FPTN=CLSSAVE$,PFMT=PTR,VECTOR=ADDR,DISP=SAVE,
      113     9459                STCLASS=CONSTANT);
      114     9501        %FPT_CLOSE(FPTN=CLSSCRATCH$,PFMT=PTR,VECTOR=ADDR,DISP=SCRATCH,
      115     9502                STCLASS=CONSTANT);
      116     9544        %FPT$CLOSE_V;
      117     9553        %SUB_EXC;
      118     9600        %INCLUDE KV$VDO;
      119    10615        %KV_VDO_ALL_E;
      120    10694        %INCLUDE NK_SUBS;
      121    10719        %INCLUDE NK$LDCT;
      122    10821        %INCLUDE NK_LDCT_R;
      123    10830        %INCLUDE SS_SCHED_C;
      124    11063        %NK$LDCT(STCLASS="BASED(LDCT$)");
      125    11109        %K$RWPARM (NAME=RWPARM);
      126    11425    1   DCL LDCT$ PTR;
      127    11426    1   DCL JDCB$ PTR;
      128    11427    1   DCL SDCB$ PTR;
      129    11428    1   DCL I SBIN;
      130    11429    1   DCL J SBIN;
      131    11430    1   DCL DUSR UBIN BYTE;
      132    11431        %JP_CITE (FPTN=JP$CITE,TYP=JOB,STCLASS=AUTO);
      133    11463        %B$COMIO (NAME=COMIO,STCLASS=AUTO,PARONLY=1);
      134    11472        %EJECT;
PL6.E3A0      #001=FSP$CLSDEV File=FSP$CLSDEV.:E05TSI                            TUE 07/29/97 17:37 Page:5    
      135    11473    1           JDCB$=B$JIT.DCB$;
      136    11474    2           DO CASE(F$DCB.IASN);
      137    11475    2            CASE(%STREAM#);
      138    11476        /*D*       When user DCB.IASN=STREAM, the user DCB references
      139    11477                one or more other DCB's for actual I/O.  If other open DCB's
      140    11478                reference the same actual I/O place, no action need be taken
      141    11479                now.  If not, the referenced DCB('s) must be closed now.
      142    11480                   On the input side, the user DCB may reference either the
      143    11481                interactive DCB M$UC or a DCB open to the control command
      144    11482                file.  Interactive M$UC needs no processing; it remains open.
      145    11483                The control command DCB may be either batch M$UC or a "secret"
      146    11484                interactive XEQ-file DCB.  Batch M$UC must be file-closed but
      147    11485                re-marked open; XEQ-file DCB must be closed and its space
      148    11486                freed.  When user DCB.CTLCMDIN is set, it is the controletrol
      149    11487                place, whose DCB address is indicated in B$ROSEG.CR01DCB.
      150    11488                   On the output side, the user DCB may reference either the
      151    11489                interactive DCB M$UC or the "secret" DCB for a Logical Device.
      152    11490                Interactive M$UC needs no processing; it remains open.
      153    11491                Logical Device DCB must have its output accounted for into
      154    11492                *S, then must be closed and its ROSEG space freed.  If a user
      155    11493                DCB references a Logical Device, user DCB.CFU$ points to
      156    11494                the Logical Device DCB.
      157    11495                   Note that a DCB open to special name 'ME' in UPDATE mode
      158    11496                has both input and output references.
      159    11497         */
      160    11498    2              F$DCB.FCD=%NO#; /*Eliminate us from candidate list*/
      161    11499                /*** First process the Input side.*/
      162    11500    3              IF F$DCB.CTLCMDIN THEN DO;
      163    11501    3   C1AGAIN:      SDCB$=PINCRW(B$ROSEG$,B$ROSEG.CR01DCB);
      164    11502    4                 DO CASE(B$ROSEG.CR01ID.NOWIS);
      165    11503    4                  CASE(%CC_FROMXEQEND#); /*off end of XEQ; enter nest*/
      166    11504    4                    CALL FSD$C1END;
      167    11505    4                    GOTO C1AGAIN;
      168    11506    4                  CASE(%CC_FROMJOB#, %CC_FROMXEQ#);
      169    11507    4                    I=B$ROSEG.NUMDCBS;
      170    11508    5                    DO WHILE (I>=%M$MAXNEG#);
      171    11509    5                       IF B$ROSEG.DCBPTR$->B$RODCB$(I)~=ADDR(NIL) THEN
PL6.E3A0      #001=FSP$CLSDEV File=FSP$CLSDEV.:E05TSI                            TUE 07/29/97 17:37 Page:6    
      172    11510    5                          IF B$ROSEG.DCBPTR$->B$RODCB$(I)->F$DCB.FCD AND
      173    11511    5                            B$ROSEG.DCBPTR$->B$RODCB$(I)->F$DCB.CTLCMDIN THEN
      174    11512    5                             GOTO MORE_JCL;
      175    11513    5                       I=I-1;
      176    11514    5                       END;
      177    11515    5                    IF SDCB$->F$DCB.IASN=%FILE# THEN DO;
      178    11516    5                       B$JIT.DCB$=SDCB$;
      179    11517    5                       CALL FMP$CLSF(CLSSAVE$);
      180    11518    5                       SDCB$->F$DCB.IASN=0;
      181    11519    5                       END;
      182    11520    4                    IF SDCB$=B$M$UC$ THEN
      183    11521    4                       SDCB$->F$DCB.FCD=%YES#;
      184    11522    5                    ELSE DO;
      185    11523    5                       CALL FSA$FDCB(PINCRW(B$ROSEG$, B$ROSEG.CR01DCB));
      186    11524    5                       B$ROSEG.CR01DCB=0;
      187    11525    5                       END;
      188    11526    4   MORE_JCL:      END;
      189    11527    3                 IF SDCB$=F$DCB.CFU$ THEN GOTO MORE_STR;
      190    11528    3                 END;
      191    11529                /*** Second, process the Output side.*/
      192    11530    2              SDCB$ = F$DCB.CFU$;
      193    11531    2              IF SDCB$=B$M$UC$
      194    11532    3              THEN DO;
      195    11533    3                 IF SDCB$->F$DCB.MEDIA ~= FMTUC#
      196    11534    3                 THEN GOTO MORE_STR;
      197    11535    3                 IF F$DCB.FCN.CNT(0) ~= 0
      198    11536    4                 THEN DO;
      199    11537    4                    LDCT$ = NK$LDCT$(SDCB$->F$DCB.LDCTX);
      200    11538    4                    IF LDCT$ ~= ADDR(NIL)
      201    11539    5                    THEN DO;
      202    11540                            %LOCK (G=NK$LDCT.LOCK);
      203    11543    5                       CALL KILL_IO;
      204    11544    5                       IF I~=0
      205    11545    5                       THEN SDCB$->F$DCB.FCN.CNT(0) = SDCB$->F$DCB.FCN.CNT(0) - I;
      206    11546                            %UNLOCK (G=NK$LDCT.LOCK);
      207    11549    5                       END;
      208    11550    4                    END;
PL6.E3A0      #001=FSP$CLSDEV File=FSP$CLSDEV.:E05TSI                            TUE 07/29/97 17:37 Page:7    
      209    11551    3   FIND_UC_STR:  ;
      210    11552    3                 J = F$DCB.STR;
      211    11553    3                 I = B$ROSEG.NUMDCBS;
      212    11554    4                 DO WHILE (I>%M$UC#);
      213    11555    4                    IF B$ROSEG.DCBPTR$->B$RODCB$(I)~=ADDR(NIL)
      214    11556    4                    THEN IF B$ROSEG.DCBPTR$->B$RODCB$(I)->F$DCB.FCD
      215    11557    4                         AND (B$ROSEG.DCBPTR$->B$RODCB$(I)->F$DCB.CFU$ = B$M$UC$
      216    11558    4                         AND J = B$ROSEG.DCBPTR$->B$RODCB$(I)->F$DCB.STR
      217    11559    4                         OR J = B$ROSEG.DCBPTR$->B$RODCB$(I)->F$DCB.FPSTR)
      218    11560    4                       THEN
      219    11561    4                          GOTO MORE_STR;
      220    11562    4                    I = I -1;
      221    11563    4                    END;
      222    11564    3                 IF J < 20 /* LDEVed stream */
      223    11565    4                 THEN DO;
      224    11566    4                    CALL KIA$CLSSTR(J,'0'B,'0'B);
      225    11567    4                    B$ROSEG.STREAMID.FLG(J) = 1;
      226    11568    4                    END;
      227    11569    4                 ELSE DO;
      228    11570    4                    CALL KIA$CLSSTR (J,'1'B,'0'B); /* Release stream */
      229    11571    4                    END;
      230    11572    3                 GOTO MORE_STR;
      231    11573    3                 END;
      232    11574    2              I=B$ROSEG.NUMDCBS;
      233    11575    3              DO WHILE (I>=%M$MAXNEG#);
      234    11576    3                 IF B$ROSEG.DCBPTR$->B$RODCB$(I)~=ADDR(NIL) THEN
      235    11577    3                    IF B$ROSEG.DCBPTR$->B$RODCB$(I)->F$DCB.FCD AND
      236    11578    3                      B$ROSEG.DCBPTR$->B$RODCB$(I)->F$DCB.CFU$=SDCB$
      237    11579    4                    THEN DO;
      238    11580    4                       IF SDCB$->F$DCB.ORG = %FPRG#
      239    11581    5                       THEN DO;
      240    11582    5                          LDCT$=NK$LDCT$(SDCB$->F$DCB.LDCTX);
      241    11583    5                          IF B$JIT.DCBNO = NK$LDCT.UDCBNO
      242    11584    5                          THEN
      243    11585    5                             NK$LDCT.UDCBNO = I;
      244    11586    5                          END;
      245    11587    4                       GOTO MORE_STR;
PL6.E3A0      #001=FSP$CLSDEV File=FSP$CLSDEV.:E05TSI                            TUE 07/29/97 17:37 Page:8    
      246    11588    4                       END;
      247    11589    3                 I=I-1;
      248    11590    3                 END;
      249    11591    2              B$JIT.DCB$=SDCB$;
      250    11592    2              J=POFFW(SDCB$,B$ROSEG$);
      251    11593    2              I=0;
      252    11594    3              DO UNTIL(I>15);
      253    11595    3                 IF B$ROSEG.STREAMID.IDENT(I)=J AND
      254    11596    4                   B$ROSEG.STREAMID.FLG(I)=2 THEN /*case1*/ DO;
      255    11597    4                    IF SDCB$->F$DCB.FCD AND NOT B$ROSEG.STREAMID.UC_STR(I)
      256    11598    5                    THEN DO;
      257    11599    5                       CALL FSL$ACCT(SDCB$->F$DCB);
      258    11600    5                       IF SDCB$->F$DCB.FORM$->CODE16.RECNO~=0 OR
      259    11601    5                         SDCB$->F$DCB.FORM$->CODE16.PAGENO~=0 THEN
      260    11602    5                          B$ROSEG.STREAMID.F01(I)=%YES#;
      261    11603    5                       CALL CHARBIN(J,ADDR(SDCB$->F$DCB.NAME)->OSFN.NUM);
      262    11604    5                       B$ROSEG.STREAMID.IDENT(I)=J;
      263    11605    5                       CALL FMH$SYMB_FINISH;
      264    11606    5                       CALL FMP$CLSF(CLSSAVE$);
      265    11607    5                       END;
      266    11608    4                    B$ROSEG.STREAMID.FLG(I)=1;
      267    11609    4                    B$ROSEG.DCBPTR$->B$RODCB$(%M$STR01#-I) = ADDR(NIL);
      268    11610    4                    GOTO GOT_STRM;
      269    11611    4                    END;
      270    11612    3                 I=I+1;
      271    11613    3                 END;
      272    11614    2   GOT_STRM:  ;
      273    11615    2              CALL FSA$FDCB(B$JIT.DCB$);
      274    11616    2   MORE_STR:  ;
      275    11617    2              B$JIT.DCB$=JDCB$;
      276    11618    2            CASE(%DEVICE#);
      277    11619        /*D*       When user DCB.IASN=DEVICE, the DCB either is interactive
      278    11620                M$UC or is the DCB of a resource device.  If it is M$UC, it
      279    11621                is not allowed to be closed.  If it is the DCB of a resource
      280    11622                device, FRB$CLS will close it properly.
      281    11623                If it is the DCB of a resource device for a Network Connection,
      282    11624                ie.  .MEDIA is FMTNC#, then KIS$OSI_CLOSE will handle the
PL6.E3A0      #001=FSP$CLSDEV File=FSP$CLSDEV.:E05TSI                            TUE 07/29/97 17:37 Page:9    
      283    11625                close.
      284    11626                If open to a remote data resource (OSI FTAM, IFMT=FMTREMOTE)
      285    11627                then FMF$REMOTE closes it.
      286    11628         */
      287    11629
      288    11630    2              IF JDCB$=B$M$UC$ THEN GOTO UCNOCLS;
      289    11631
      290    11632    2              IF F$DCB.MEDIA = FMTNC# THEN
      291    11633    3                 CALL KIS$OSI_CLOSE WHENRETURN DO;
      292    11634    3                    RETURN;
      293    11635    3                    END; /*  WHENRETURN  */
      294    11636    3                 WHENALTRETURN DO;
      295    11637    3                    ALTRETURN;
      296    11638    3                    END; /*  WHENALTRETURN  */
      297    11639
      298    11640    3              IF F$DCB.IFMT = FMTREMOTE# THEN DO;
      299    11641    3                 CALL FMF$REMOTE(1);
      300    11642    3                 RETURN;
      301    11643    3                 END;
      302    11644
      303    11645    3              DO I=0 TO 4;
      304    11646    3                 CALL FMD$RELBUF(I);
      305    11647    3                 END;
      306    11648    2              LDCT$ = NK$LDCT$(F$DCB.SETX);
      307    11649    2              IF LDCT$=ADDR(NIL) THEN GOTO FEP_CLOSE;
      308    11650    2              IF NOT NK$LDCT.DFLG.LOCAL THEN GOTO FEP_CLOSE;
      309    11651    2              CALL FMB$IOSPIN;
      310    11652    2              CALL FRB$CLS;
      311    11653    2            CASE(%FILE#);
      312    11654        /*D*       When user DCB.IASN=FILE, the DCB is either non-interactive
      313    11655                M$UC, a workstation-assigned DCB, a control-command
      314    11656                creating DCB, or a TP DCB hooked non-streamed to M$UC.
      315    11657                If it is M$UC, it is not allowed to be closed.
      316    11658                If it is workstation assigned, the DCB is internally hooked
      317    11659                to a symbiont file.  If the file is to be saved on the close,
      318    11660                output in the file is accounted for, the file is closed,
      319    11661                and OUTSYM is told about the file.  If the file is not to be
PL6.E3A0      #001=FSP$CLSDEV File=FSP$CLSDEV.:E05TSI                            TUE 07/29/97 17:37 Page:10   
      320    11662                saved, it is just closed.
      321    11663                If the DCB is creating control commands, it is either JE or
      322    11664                JF.  JE files are closed and PRESCAN is told about them.  JF
      323    11665                files must be hooked up to be this user's control-command
      324    11666                place; FSD$JFCLS does this.
      325    11667                If a TP DCB, KCO$CLCG is called.
      326    11668         */
      327    11669    2              IF JDCB$=B$M$UC$ THEN GOTO UCNOCLS;
      328    11670    3              IF F$DCB.MEDIA=FMTCG# THEN DO;
      329    11671    3                 CALL KCO$CLCG(PN$);
      330    11672    3                 F$DCB.FUN=%CREATE#; /* Restore original FUN */
      331    11673    3                 RETURN;
      332    11674    3                 END;
      333    11675    2              IF PN$.V_=ADDR(NIL) THEN I=0;
      334    11676    2              ELSE I=PN$.V_->FPT$CLOSE_V.DISP;
      335    11677    2              IF F$DCB.IFMT=FMTJCLOUT# THEN
      336    11678        /*            For JE/JF, scratch it unless SAVE specified.*/
      337    11679    2                 IF (I=%SAVE#) AND (F$DCB.CFU$->FM$CFU.NRECS~=0) THEN
      338    11680    2                    IF F$DCB.RES='JF' THEN
      339    11681    2                       CALL FSD$JFCLS(PN$);
      340    11682    3                    ELSE DO; /*JE*/
      341    11683    3                       CALL FMP$CLSF(CLSSAVE$);
      342    11684    3                       CALL CHARBIN(J,SUBSTR(F$DCB.NAME.C,0,6));
      343    11685    3                       JP$CITE.SYSID=J;
      344    11686    3                       JP$CITE.CODE=JPEV_NEWF#;
      345    11687    3                       CALL KUW$WRITE (JP$CITE,LENGTHC(JP$CITE),J_PRESCAN);
      346    11688    3                       END;
      347    11689    2                 ELSE
      348    11690    2                    CALL FMP$CLSF(CLSSCRATCH$);
      349    11691    3              ELSE DO;
      350    11692        /*            For dd@wsn, save it unless SCRATCH specified.*/
      351    11693    3                 IF (I~=%SCRATCH#) AND (F$DCB.FORM$->CODE16.RECNO~=0 OR
      352    11694    4                   F$DCB.FORM$->CODE16.PAGENO~=0) THEN DO;
      353    11695    4                    CALL FSL$ACCT(F$DCB);
      354    11696    4                    B$JIT.DCB$ = JDCB$;
      355    11697    4                    CALL FMP$CLSF(CLSSAVE$);
      356    11698    4                    CALL FSX$TELLOUTSYM(F$DCB);
PL6.E3A0      #001=FSP$CLSDEV File=FSP$CLSDEV.:E05TSI                            TUE 07/29/97 17:37 Page:11   
      357    11699    4                    END;
      358    11700    4                 ELSE DO;
      359    11701        /*               No need to FSL$ACCT the delete; DCB never closed, so
      360    11702                         we haven't ever accounted for it to begin with.*/
      361    11703    4                    IF ADDR(F$DCB.NAME)->OSFN.CNUM~='000' THEN
      362    11704    4                       CALL FSX$TELLOUTSYM(F$DCB,,1);
      363    11705    4                    B$JIT.DCB$ = JDCB$;
      364    11706    4                    CALL FMP$CLSF(CLSSCRATCH$);
      365    11707    4                    END;
      366    11708    3                 IF F$DCB.IFMT=FMTTTY# THEN F$DCB.ORG=%TERMINAL#;
      367    11709    3                 END;
      368    11710    2            CASE (%FPRGIASN#);
      369    11711    2              IF F$DCB.CFU$ ~= ADDR(NIL) AND F$DCB.CFU$->F$DCB.FCD
      370    11712    3              THEN DO;
      371    11713    3                 B$JIT.DCB$ = F$DCB.CFU$;
      372    11714    3                 CALL FMP$CLSJ;
      373    11715    3                 B$JIT.DCBNO = B$JIT.DCB$->F$DCB.DCB#;
      374    11716    3                 CALL FMM$RELDCBI;
      375    11717    3                 B$JIT.DCB$ = JDCB$;
      376    11718    3                 F$DCB.CFU$ = ADDR(NIL);
      377    11719    3                 END;
      378    11720    2              LDCT$=NK$LDCT$(F$DCB.LDCTX);
      379    11721        %EJECT;
PL6.E3A0      #001=FSP$CLSDEV File=FSP$CLSDEV.:E05TSI                            TUE 07/29/97 17:37 Page:12   
      380    11722    2   FEP_CLOSE: ; /* Common code for shutting down a Fep connection */
      381    11723    2              CALL SSS$BLOCK; /* KIA$TERM can't lock the LDCT gate */
      382    11724    3              DO WHILE LDCT$~=ADDR(NIL);
      383    11725                      %LOCK (G=NK$LDCT.LOCK);
      384    11728    3                 IF F$DCB.FCN.CNT(0)~=0 THEN CALL KILL_IO;
      385    11729    3                 IF NK$LDCT.DFLG.FEDN
      386    11730    3                   OR NOT NK$LDCT.DFLG.INPUT /* Aka RAT.CLFLG.MULT */
      387    11731    3                 THEN GOTO FEP_RELDCT;
      388    11732    3                 IF PN$.V_ = ADDR(NIL)
      389    11733    3                 THEN
      390    11734    3                    I = 0;
      391    11735    3                 ELSE
      392    11736    3                    I = PN$.V_->FPT$CLOSE_V.DISP;
      393    11737    3                 RWPARM = K_RWPARM_CON;
      394    11738    3                 NK$LDCT.TH = '0'B;
      395    11739    3                 CALL KIA$FCNOU(NK$LDCT,%KV_VDO_FNC_CLSSSN_RQS,RWPARM);
      396    11740                /* If the DISP = save we wait for a job step to happen in the FPRG */
      397    11741    3                 IF I = %SAVE# AND NOT NK$LDCT.LKFLG.FPSTEP
      398    11742    3                   AND F$DCB.IASN=%FPRGIASN#
      399    11743    4                 THEN DO;
      400    11744    4                    NK$LDCT.LKFLG.WAITINGEXIT = '1'B;
      401    11745    4                    CALL SSR$REG(%SS_CRD,NK$LDCT$(F$DCB.LDCTX))
      402    11746    5                    WHENALTRETURN DO;
      403    11747    5                       B$JIT.JUNK = B$JIT.JUNK | %JJ_BAKIC#;
      404    11748                            %LOCK (G=NK$LDCT.LOCK);
      405    11751    5                       NK$LDCT.LKFLG.WAITINGEXIT = '0'B;
      406    11752                            %UNLOCK (G=NK$LDCT.LOCK);
      407    11755    5                       ALTRETURN;
      408    11756    5                       END;
      409    11757                         %LOCK (G=NK$LDCT.LOCK);
      410    11760    4                    END;
      411    11761    4                 IF F$DCB.RESNT.NUM='CL' THEN DO;
      412    11762    4                    CALL FRF$EVRPT; /* event the AU, if required */
      413    11763    4                    IF I = %CLRES# THEN CALL OCZ$SID_UN
      414    11764    4                         (PN$.V_->FPT$CLOSE_V.CLSYSID,NK$LDCT.USER)
      415    11765    5                       WHENRETURN DO;
      416    11766    5                          NK$LDCT.MSGID = PN$.V_->FPT$CLOSE_V.CLINFO;
PL6.E3A0      #001=FSP$CLSDEV File=FSP$CLSDEV.:E05TSI                            TUE 07/29/97 17:37 Page:13   
      417    11767    5                          NK$LDCT.DCBNO = PN$.V_->FPT$CLOSE_V.CLDCB;
      418    11768    5                          CALL FRF$EVRPT (NK$LDCT);
      419    11769    5                          CALL FRB$CLS;
      420    11770    5                          F$DCB.FCD = '0'B;
      421    11771    5                          RETURN;
      422    11772    5                          END;
      423    11773    4                    END;
      424    11774    3                 RWPARM = K_RWPARM_CON;
      425    11775    3                 CALL KIA$DSCU(NK$LDCT,%KV_VDO_FNC_DSC_RQS,RWPARM)
      426    11776    4                 WHENALTRETURN DO;
      427    11777    4                    NK$LDCT.DFLG.PRLS='1'B;
      428    11778    4                    END;
      429    11779    3   FEP_RELDCT:   ;
      430    11780                      %UNLOCK (G=NK$LDCT.LOCK);
      431    11783    3                 IF (S$CU$->B$U.FLG & %U_DELA) AND F$DCB.IASN=%FPRGIASN#
      432    11784    4                 THEN DO;
      433    11785    4                    COMIO = '0'B;
      434    11786    4                    COMIO.P# = SIZEW(COMIO) - SIZEW(COMIO.P#);
      435    11787    4                    COMIO.FLAGS.DELTA = '1'B;
      436    11788    4                    COMIO.SUBC2 = %SUBC2_CLS_DCB#;
      437    11789    4                    DUSR = S_CUN;
      438    11790    4                    CALL SSV$EVENT(DUSR,%DBWSR,%SUBC_COMIO#,F$DCB.EVENT,0,ADDR(COMIO));
      439    11791    4                    END;
      440    11792    3                 IF F$DCB.IASN=%DEVICE# THEN CALL FRB$CLS;
      441    11793    3                 IF NK$LDCT.USER=B$JIT.USER
      442    11794    3                 THEN CALL NKL$RELDCTL(NK$LDCT$(F$DCB.LDCTX));
      443    11795    3                 IF F$DCB.SETX~=0 AND F$DCB.SETX~=F$DCB.LDCTX
      444    11796    3                 THEN F$DCB.IASN=%DEVICE#;
      445    11797    3                 ELSE F$DCB.SETX=0;
      446    11798    3                 F$DCB.LDCTX=F$DCB.SETX;
      447    11799    3                 LDCT$=NK$LDCT$(F$DCB.LDCTX);
      448    11800    3                 END;
      449    11801    2              IF B$ROSEG.STREAM_VALID(F$DCB.FPSTR) /* Zero is never valid */
      450    11802    3              THEN DO;
      451    11803    3                 F$DCB.STR = F$DCB.FPSTR;
      452    11804    3                 F$DCB.FCD = '0'B;
      453    11805    3                 GOTO FIND_UC_STR; /* delete the stream if it's a temp */
PL6.E3A0      #001=FSP$CLSDEV File=FSP$CLSDEV.:E05TSI                            TUE 07/29/97 17:37 Page:14   
      454    11806    3                 END;
      455    11807    2              IF F$DCB.IASN~=%DEVICE# OR F$DCB.RESNT.NUM~='CL'
      456    11808    2                OR I~=%RELEASE# THEN EXIT;
      457    11809        /* If we get here, try to event the DCB whose open just got refused by the AU */
      458    11810    2              LDCT$ = ADDR(RWPARM); /* Just some big enough space. */
      459    11811    2              CALL OCZ$SID_UN (PN$.V_->FPT$CLOSE_V.CLSYSID, NK$LDCT.USER)
      460    11812    3              WHENRETURN DO;
      461    11813    3                 NK$LDCT.MSGID = PN$.V_->FPT$CLOSE_V.CLINFO;
      462    11814    3                 NK$LDCT.DCBNO = PN$.V_->FPT$CLOSE_V.CLDCB;
      463    11815    3                 NK$LDCT.LDCTX = 0;
      464    11816    3                 CALL FRF$EVRPT (NK$LDCT);
      465    11817    3                 END;
      466    11818    2            CASE(%TAPE#);
      467    11819        /*D*       When user DCB.IASN=TAPE, the DCB is attached to unlabeled
      468    11820                tape.  Common tape logic (FTC$CLOSE) closes the tape.
      469    11821         */
      470    11822    2              CALL FTC$CLOSE(PN$);
      471    11823    2            CASE(%OD#);
      472    11824    2              CALL FPC$CLSOD(PN$); /* Close optical disc device */
      473    11825    2            CASE(%FMDIAG#);
      474    11826        /*D*       When user DCB.IASN=FMDIAG, the DCB is attached to device
      475    11827                pack.  FMN$CLSDP closes the DCB.
      476    11828         */
      477    11829    2              CALL FMN$CLSDP(PN$);
      478    11830    2            CASE(0);
      479    11831        /*D*       When user DCB.IASN=0, the DCB is device NO.  If it is M$UC,
      480    11832                it cannot be closed; otherwise, just mark it closed.
      481    11833         */
      482    11834    2              IF JDCB$=B$M$UC$ THEN GOTO UCNOCLS;
      483    11835    2            END;
      484    11836    1           F$DCB.FCD='0'B;
      485    11837    1           RETURN;
      486    11838    1   UCNOCLS: B$JIT.ERR=ERR_NOCLSMUC;
      487    11839        /*E*    ERROR: FSP-E$NOCLSMUC-0
      488    11840                MESSAGE: M$UC may not be closed.
      489    11841         */
      490    11842    1           ALTRETURN;
PL6.E3A0      #001=FSP$CLSDEV File=FSP$CLSDEV.:E05TSI                            TUE 07/29/97 17:37 Page:15   
      491    11843        %EJECT;
PL6.E3A0      #001=FSP$CLSDEV File=FSP$CLSDEV.:E05TSI                            TUE 07/29/97 17:37 Page:16   
      492    11844        /*I* NAME: KILL_IO
      493    11845             DESCRIPTION: Terminates any Fep io (nowait, of course) for the DCB.
      494    11846        */
      495    11847    1   KILL_IO: PROC;
      496    11848
      497    11849    2           RWPARM = K_RWPARM_CON;
      498    11850    2           RWPARM.MRKTYP = %KV_VDOMRKTYP_ENDACK;
      499    11851    2           RWPARM.STR = NK$LDCT.NOWAIT.STREAM;
      500    11852    2           CALL KIA$FCNOU(NK$LDCT,%KV_VDO_FNC_RQSDAT,RWPARM)
      501    11853    3           WHENRETURN DO;
      502    11854    3              NK$LDCT.LKFLG.WTMRK = '1'B;
      503    11855    3              CALL SSR$REG(%SS_CW,NK$LDCT$(NK$LDCT.LDCTX));
      504    11856                   %LOCK (G=NK$LDCT.LOCK);
      505    11859    3              END;
      506    11860    2           I = F$DCB.FCN.CNT(0);
      507    11861    3           IF I~=0 THEN DO; /* Still a read out standing */
      508    11862    3              NK$LDCT.LKFLG.NOWAIT = '0'B;
      509    11863    3              S$CU$->B$U.MF = S$CU$->B$U.MF - I;
      510    11864    3              S$CU$->B$U.CMF = S$CU$->B$U.CMF - I;
      511    11865    3              F$DCB.FCN.CNT(0) = 0;
      512    11866    3              END;
      513    11867    2   END KILL_IO;
      514    11868    1   END;

PL6.E3A0      #001=FSP$CLSDEV File=FSP$CLSDEV.:E05TSI                            TUE 07/29/97 17:37 Page:17   
--  Include file information  --

   SS_SCHED_C.:E05TOU  is referenced.
   NK_LDCT_R.:E05TOU  cannot be made into a system file and is referenced.
   NK$LDCT.:E05TOU  is referenced.
   NK_SUBS.:E05TOU  is referenced.
   KV$VDO.:E05TOU  is referenced.
   B_STRINGS_C.:E05TOU  is referenced.
   FS$FIT.:E05TOU  is referenced.
   JG_EVID_C.:E05TOU  is referenced.
   JP_MACRO_C.:E05TOU  is referenced.
   F$DCB.:E05TOU  is referenced.
   F$CP6V_C.:E05TOU  is referenced.
   B$ROSEG.:E05TOU  is referenced.
   F_ERRORS_C.:E05TOU  is referenced.
   F_FMTCODE_C.:E05TOU  is referenced.
   FM$MACROS.:E05TOU  is referenced.
   B$USER.:E05TOU  cannot be made into a system file and is referenced.
   CP_6_C.:E05TOU  is referenced.
   CP_6.:E05TOU  cannot be made into a system file and is referenced.
   K$RWPARM.:E05TOU  is referenced.
   K_DATA_R.:E05TOU  cannot be made into a system file and is referenced.
   HF_LOCK_C.:E05TOU  cannot be made into a system file and is referenced.
   CP_6_SUBS.:E05TOU  is referenced.
   B$JIT_C.:E05TOU  is referenced.
   B$JIT.:E05TOU  cannot be made into a system file and is referenced.
      No diagnostics issued in procedure FSP$CLSDEV.

   Procedure FSP$CLSDEV requires 936 words for executable code.
   Procedure FSP$CLSDEV requires 66 words of local(AUTO) storage.

    No errors detected in file FSP$CLSDEV.:E05TSI    .

PL6.E3A0      #001=FSP$CLSDEV File=FSP$CLSDEV.:E05TSI                            TUE 07/29/97 17:37 Page:18   

 Object Unit name= FSP$CLSDEV                                 File name= FSP$CLSDEV.:E05TOU
 UTS= JUL 29 '97 17:37:41.76 TUE                              Compiler= PL-6/E31         Sev=      00
 SharedLib= :SHARED_SYSTEM                                    Alt SharedLib=


    ****  Control sections  ****

 Sect   Type Bound  Init  Size OctSiz  Section name(segment info)
    0   DCB   even  none     0      0  M$UC
    1  RoData even  UTS     42     52  FSP$CLSDEV
    2   Proc  even  none   936   1650  FSP$CLSDEV
    3  RoData even  none    25     31  FSP$CLSDEV

    ****  Entry defs  ****

                              Check   Calling
                             calling  sequence
  Sect OctLoc Primary Altret sequence   type   Parms  Name
     2      0   yes    yes     yes      Std        1  FSP$CLSDEV
PL6.E3A0      #001=FSP$CLSDEV File=FSP$CLSDEV.:E05TSI                            TUE 07/29/97 17:37 Page:19   

  ****  Entry refs  ****

         Check        Calling
        calling       sequence
Altret sequence SRef   type   Args  Name
 yes     yes           Std       0 FSD$C1END
         yes           Std       1 FMP$CLSF
         yes           Std       1 HFC$UNLOCK
 yes     yes           Std       0 KIS$OSI_CLOSE
 yes     yes           Std       3 SSR$REG
         yes           Std       1 FPC$CLSOD
         yes           Std       0 FMB$IOSPIN
         yes           Std       0 FRB$CLS
         yes           Std       1 FMD$RELBUF
         yes           Std       1 FSA$FDCB
 yes     yes           Std       3 FMH$SYMB_FINISH
         yes           Std       1 KCO$CLCG
 yes     yes           Std       1 NKL$RELDCTL
         yes           Std       1 FTC$CLOSE
         yes           Std       3 FSX$TELLOUTSYM
 yes     yes           Std       1 FRF$EVRPT
 yes     yes           Std       1 FMN$CLSDP
         yes           Std       1 FMF$REMOTE
         yes           Std       0 FMP$CLSJ
         yes           Std       7 SSV$EVENT
 yes     yes           Std       3 KIA$FCNOU
 yes     yes           Std       4 OCZ$SID_UN
         yes           Std       1 HFC$LOCK
 yes     yes           Std       3 KIA$CLSSTR
         yes           Std       3 FSL$ACCT
 yes     yes           Std       3 KUW$WRITE
 yes     yes           Std       3 KIA$DSCU
         yes           Std       1 FSD$JFCLS
         yes           Std       0 SSS$BLOCK
         yes           Std       0 FMM$RELDCBI
                       nStd      0 X66_AUTO_1
                       Std       0 B_CONSPOOL_D
PL6.E3A0      #001=FSP$CLSDEV File=FSP$CLSDEV.:E05TSI                            TUE 07/29/97 17:37 Page:20   
                       nStd      0 X66_ARET
                       nStd      0 X66_AALT

  ****  Data refs  ****

  Flags:  r = read only, s = secondary
Flgs Name                             Flgs Name                             Flgs Name
r    B$JIT$                           r    B$ROSEG$                         r    B$M$UC$
     S$CU$                                 S_CUN                            r    J_PRESCAN
r    K_RWPARM_CON                          M$UC                                  N$DCT$$
     B_VECTNIL

  ****  Segment refs  ****

  Flags:  r = read only, s = secondary
Flgs Name                             Flgs Name                             Flgs Name
     ISSID                                 NULLSID
PL6.E3A0      #001=FSP$CLSDEV File=FSP$CLSDEV.:E05TSI                            TUE 07/29/97 17:37 Page:21   


        1        1        /*M* FSP$CLSDEV  CLOSE A DEVICE DCB. */
        2        2        /*T***********************************************************/
        3        3        /*T*                                                         */
        4        4        /*T* Copyright (c) Bull HN Information Systems Inc., 1997    */
        5        5        /*T*                                                         */
        6        6        /*T***********************************************************/
        7        7        /*X* CLM=8,ICP,MOC,DMR */
        8        8        /*P*    NAME: FSP$CLSDEV
        9        9                PURPOSE: Close a Device DCB.
       10       10         */
       11       11        /*F*    NAME: FSP$CLSDEV
       12       12                PURPOSE: Close a Device DCB.
       13       13                DESCRIPTION:  FSP$CLSDEV closes DCB's whose ASN=DEVICE.
       14       14                   The DCB M$UC does not get closed.  It remains open for
       15       15                   the entire job, since it carries information about an
       16       16                   interactive user's terminal.
       17       17                   Tape device DCB's are closed by common tape logic.
       18       18                   The resource devices associated with resource device DCB's
       19       19                   are processed by Resource Management code.
       20       20                   The symbiont file attached to a workstation-assigned DCB
       21       21                   is closed and handed to OUTSYM.
       22       22                   The symbiont file attached to a logical-device-assigned DCB
       23       23                   is closed if this DCB is the only one open to it.
       24       24                   The command file attached to a command-stream DCB is
       25       25                   closed if this DCB is the only one open to it.
       26       26                   An ORG=FPRG DCB is closed by first requesting disconnect
       27       27                   on the path causing the FEP user to be run down. Also the
       28       28                   DCB that is pointed to by CFU$, which is open to the
       29       29                   current run unit is closed and released.
       30       30         */
       31       31        /*D*    NAME: FSP$CLSDEV
       32       32                CALL: CALL FSP$CLSDEV(PN$) ALTRET;
       33       33                      PN$ is the PTR-flavored version of an M$CLOSE FPT.
       34       34                      ALTRET if DCB is M$UC, which cannot be closed.
       35       35                INTERFACE: FMN$CLSDP,FMP$CLSF,FRB$CLS,FTC$CLOSE.
       36       36                ENVIRONMENT: Monitor (for user) LS.
PL6.E3A0      #001=FSP$CLSDEV File=FSP$CLSDEV.:E05TSI                            TUE 07/29/97 17:37 Page:22   
       37       37                INPUT: DCB (B$JIT.DCB$).
       38       38                      Control-command state indicator (B$ROSEG.CR01ID).
       39       39                      Logical device state indicator (B$ROSEG.STREAMID).
       40       40                OUTPUT: DCB marked closed.
       41       41                      State indicators may be changed.
       42       42                DESCRIPTION:
       43       43         */
       44       44        FSP$CLSDEV: PROC(PN$) ALTRET;

     44  2 000000   000000 700200 xent  FSP$CLSDEV   TSX0  ! X66_AUTO_1
         2 000001   000102 000001                    ZERO    66,1

       45       45    1   DCL FMN$CLSDP ENTRY(1) ALTRET; /* CLOSE DEVICE DP FOR PIG/VOLINIT    */
       46       46    1   DCL KUW$WRITE ENTRY(3) ALTRET; /* Report event to Prescan.*/
       47       47    1   DCL FSA$FDCB ENTRY(1); /* Free a DCB's ROSEG space */
       48       48    1   DCL FMP$CLSF ENTRY(1);
       49       49    1   DCL FMP$CLSJ ENTRY;
       50       50    1   DCL FRB$CLS ENTRY;
       51       51    1   DCL FMB$IOSPIN ENTRY;
       52       52    1   DCL FMD$RELBUF ENTRY(1);
       53       53    1   DCL FMF$REMOTE ENTRY(1);
       54       54    1   DCL FMM$RELDCBI ENTRY;
       55       55    1   DCL FMH$SYMB_FINISH  ENTRY (3) ALTRET;
       56       56    1   DCL FRF$EVRPT ENTRY(1) ALTRET;
       57       57    1   DCL FSD$C1END ENTRY ALTRET; /* dump after-ended XEQ file.*/
       58       58    1   DCL FSD$JFCLS ENTRY(1); /* Close JF (XEQ file Create) DCB.*/
       59       59    1   DCL FSL$ACCT ENTRY(3); /*Account for symbionts*/
       60       60    1   DCL FSX$TELLOUTSYM ENTRY(3);
       61       61    1   DCL FTC$CLOSE ENTRY(1); /*Open to tape (Device Tape here).*/
       62       62    1   DCL FPC$CLSOD ENTRY (1); /* Open to optical disc as device  */
       63       63    1   DCL KIA$CLSSTR ENTRY(3) ALTRET;
       64       64    1   DCL KIA$DSCU ENTRY(3) ALTRET;
       65       65    1   DCL KIA$FCNOU ENTRY(3) ALTRET;
       66       66    1   DCL KIS$OSI_CLOSE ENTRY(0) ALTRET;
       67       67    1   DCL KCO$CLCG ENTRY(1);
       68       68    1   DCL NKL$RELDCTL ENTRY(1) ALTRET;
       69       69    1   DCL OCZ$SID_UN ENTRY(4) ALTRET;
PL6.E3A0      #001=FSP$CLSDEV File=FSP$CLSDEV.:E05TSI                            TUE 07/29/97 17:37 Page:23   
       70       70    1   DCL SSR$REG ENTRY(3) ALTRET;
       71       71    1   DCL SSS$BLOCK ENTRY;
       72       72    1   DCL SSV$EVENT ENTRY(7);
       73       73        /*** * * * ***/
       74       74    1   DCL B$JIT$ PTR SYMREF READONLY; /* Note B$JIT is BASED(B$JIT$).       */
       75       75    1   DCL B$ROSEG$ PTR SYMREF READONLY;
       76       76    1   DCL B$M$UC$ PTR SYMREF READONLY;
       77       77    1   DCL B$USRT$ PTR SYMREF;
       78       78    1   DCL S$CU$ PTR SYMREF;
       79       79    1   DCL S_CUN UBIN SYMREF;
       80       80    1   DCL J_PRESCAN CHAR(8) SYMREF READONLY;
       81       81        /*** * * * ***/
       82       82        %INCLUDE B$JIT;
       83      685        %INCLUDE CP_6_SUBS;
       84     1225        %INCLUDE HF_LOCK_C;
       85     1239        %INCLUDE K_DATA_R;
       86     1950        %INCLUDE CP_6;
       87     7509        %INCLUDE B$USER;
       88     7725        %FPT_CLOSE(FPTN=PN$,PFMT=PTR,STCLASS=);
       89     7767        %INCLUDE FM$MACROS;
       90     8142        %FM$CFU;
       91     8148        %CODE16;
       92     8156        %INCLUDE F_FMTCODE_C;
       93     8190        %INCLUDE F_ERRORS_C;
       94     8430        %SUB FCG#='0623'O;
       95     8431        %SUB MID#='20'O;
       96     8432        %ERRCODE (NAME=ERR_NOCLSMUC,COD#=%E$NOCLSMUC,SEV#=0);
       97     8436        %ERRCODE (NAME=ERR_EOF,COD#=%E$EOF,SEV#=2);
       98     8440        %MACRO B$ROSEG(BASED=BASED);
       99     8441        %INCLUDE B$ROSEG;
      100     8504        %MEND;
      101     8505        %B$ROSEG(BASED="BASED(B$ROSEG$)");
      102     8565        %INCLUDE F$CP6V_C;
      103     8791        %MACRO F$DCBI(BASED=BASED);
      104     8792        %INCLUDE F$DCB;
      105     8841        %MEND;
      106     8842        %F$DCBI(BASED="BASED(JDCB$)");
PL6.E3A0      #001=FSP$CLSDEV File=FSP$CLSDEV.:E05TSI                            TUE 07/29/97 17:37 Page:24   
      107     8892        %INCLUDE JP_MACRO_C;
      108     9047        %INCLUDE JG_EVID_C;
      109     9272        %INCLUDE FS$FIT;
      110     9315        %FS_OSFN(FPTN=OSFN,STCLASS=BASED);
      111     9329        %INCLUDE B_STRINGS_C;
      112     9458        %FPT_CLOSE(FPTN=CLSSAVE$,PFMT=PTR,VECTOR=ADDR,DISP=SAVE,
      113     9459                STCLASS=CONSTANT);
      114     9501        %FPT_CLOSE(FPTN=CLSSCRATCH$,PFMT=PTR,VECTOR=ADDR,DISP=SCRATCH,
      115     9502                STCLASS=CONSTANT);
      116     9544        %FPT$CLOSE_V;
      117     9553        %SUB_EXC;
      118     9600        %INCLUDE KV$VDO;
      119    10615        %KV_VDO_ALL_E;
      120    10694        %INCLUDE NK_SUBS;
      121    10719        %INCLUDE NK$LDCT;
      122    10821        %INCLUDE NK_LDCT_R;
      123    10830        %INCLUDE SS_SCHED_C;
      124    11063        %NK$LDCT(STCLASS="BASED(LDCT$)");
      125    11109        %K$RWPARM (NAME=RWPARM);
      126    11425    1   DCL LDCT$ PTR;
      127    11426    1   DCL JDCB$ PTR;
      128    11427    1   DCL SDCB$ PTR;
      129    11428    1   DCL I SBIN;
      130    11429    1   DCL J SBIN;
      131    11430    1   DCL DUSR UBIN BYTE;
      132    11431        %JP_CITE (FPTN=JP$CITE,TYP=JOB,STCLASS=AUTO);
      133    11463        %B$COMIO (NAME=COMIO,STCLASS=AUTO,PARONLY=1);
      134    11472        %EJECT;
PL6.E3A0      #001=FSP$CLSDEV File=FSP$CLSDEV.:E05TSI                            TUE 07/29/97 17:37 Page:25   
      135    11473    1           JDCB$=B$JIT.DCB$;

  11473  2 000002   000000 470400 xsym               LDP0    B$JIT$
         2 000003   000232 236100                    LDQ     154,,PR0
         2 000004   200055 756100                    STQ     JDCB$,,AUTO

      136    11474    2           DO CASE(F$DCB.IASN);

  11474  2 000005   200055 471500                    LDP1    JDCB$,,AUTO
         2 000006   100103 720100                    LXL0    67,,PR1
         2 000007   000777 360003                    ANX0    511,DU
         2 000010   000013 100003                    CMPX0   11,DU
         2 000011   000013 602010 2                  TNC     s:11474+6,X0
         2 000012   001544 710000 2                  TRA     s:11836
         2 000013   001542 710000 2                  TRA     s:11834
         2 000014   000617 710000 2                  TRA     s:11669
         2 000015   001523 710000 2                  TRA     s:11822
         2 000016   000536 710000 2                  TRA     s:11630
         2 000017   001544 710000 2                  TRA     s:11836
         2 000020   000026 710000 2                  TRA     s:11498
         2 000021   001544 710000 2                  TRA     s:11836
         2 000022   001535 710000 2                  TRA     s:11829
         2 000023   001012 710000 2                  TRA     s:11711
         2 000024   001544 710000 2                  TRA     s:11836
         2 000025   001530 710000 2                  TRA     s:11824

      137    11475    2            CASE(%STREAM#);

      138    11476        /*D*       When user DCB.IASN=STREAM, the user DCB references
      139    11477                one or more other DCB's for actual I/O.  If other open DCB's
      140    11478                reference the same actual I/O place, no action need be taken
      141    11479                now.  If not, the referenced DCB('s) must be closed now.
      142    11480                   On the input side, the user DCB may reference either the
      143    11481                interactive DCB M$UC or a DCB open to the control command
      144    11482                file.  Interactive M$UC needs no processing; it remains open.
      145    11483                The control command DCB may be either batch M$UC or a "secret"
      146    11484                interactive XEQ-file DCB.  Batch M$UC must be file-closed but
PL6.E3A0      #001=FSP$CLSDEV File=FSP$CLSDEV.:E05TSI                            TUE 07/29/97 17:37 Page:26   
      147    11485                re-marked open; XEQ-file DCB must be closed and its space
      148    11486                freed.  When user DCB.CTLCMDIN is set, it is the controletrol
      149    11487                place, whose DCB address is indicated in B$ROSEG.CR01DCB.
      150    11488                   On the output side, the user DCB may reference either the
      151    11489                interactive DCB M$UC or the "secret" DCB for a Logical Device.
      152    11490                Interactive M$UC needs no processing; it remains open.
      153    11491                Logical Device DCB must have its output accounted for into
      154    11492                *S, then must be closed and its ROSEG space freed.  If a user
      155    11493                DCB references a Logical Device, user DCB.CFU$ points to
      156    11494                the Logical Device DCB.
      157    11495                   Note that a DCB open to special name 'ME' in UPDATE mode
      158    11496                has both input and output references.
      159    11497         */
      160    11498    2              F$DCB.FCD=%NO#; /*Eliminate us from candidate list*/

  11498  2 000026   000000 236000 3                  LDQ     0
         2 000027   100031 356100                    ANSQ    25,,PR1

      161    11499                /*** First process the Input side.*/
      162    11500    3              IF F$DCB.CTLCMDIN THEN DO;

  11500  2 000030   100103 236100                    LDQ     67,,PR1
         2 000031   004000 316007                    CANQ    2048,DL
         2 000032   000155 600000 2                  TZE     s:11530

      163    11501    3   C1AGAIN:      SDCB$=PINCRW(B$ROSEG$,B$ROSEG.CR01DCB);

  11501  2 000033   000000 470400 xsym  C1AGAIN      LDP0    B$ROSEG$
         2 000034   000115 220100                    LDX0    77,,PR0
         2 000035   000000 636010                    EAQ     0,X0
         2 000036   000000 036000 xsym               ADLQ    B$ROSEG$
         2 000037   200056 756100                    STQ     SDCB$,,AUTO

      164    11502    4                 DO CASE(B$ROSEG.CR01ID.NOWIS);

  11502  2 000040   000114 236100                    LDQ     76,,PR0
         2 000041   000036 772000                    QRL     30
PL6.E3A0      #001=FSP$CLSDEV File=FSP$CLSDEV.:E05TSI                            TUE 07/29/97 17:37 Page:27   
         2 000042   000017 376007                    ANQ     15,DL
         2 000043   000005 116007                    CMPQ    5,DL
         2 000044   000046 602006 2                  TNC     s:11502+6,QL
         2 000045   000151 710000 2                  TRA     MORE_JCL
         2 000046   000151 710000 2                  TRA     MORE_JCL
         2 000047   000057 710000 2                  TRA     s:11507
         2 000050   000057 710000 2                  TRA     s:11507
         2 000051   000151 710000 2                  TRA     MORE_JCL
         2 000052   000053 710000 2                  TRA     s:11504

      165    11503    4                  CASE(%CC_FROMXEQEND#); /*off end of XEQ; enter nest*/

      166    11504    4                    CALL FSD$C1END;

  11504  2 000053   000002 631400 xsym               EPPR1   B_VECTNIL+2
         2 000054   000000 701000 xent               TSX1    FSD$C1END
         2 000055   000000 011000                    NOP     0

      167    11505    4                    GOTO C1AGAIN;

  11505  2 000056   000033 710000 2                  TRA     C1AGAIN

      168    11506    4                  CASE(%CC_FROMJOB#, %CC_FROMXEQ#);

      169    11507    4                    I=B$ROSEG.NUMDCBS;

  11507  2 000057   000002 236100                    LDQ     2,,PR0
         2 000060   000022 772000                    QRL     18
         2 000061   200057 756100                    STQ     I,,AUTO

      170    11508    5                    DO WHILE (I>=%M$MAXNEG#);

  11508  2 000062   000102 710000 2                  TRA     s:11514

      171    11509    5                       IF B$ROSEG.DCBPTR$->B$RODCB$(I)~=ADDR(NIL) THEN

  11509  2 000063   000000 470400 xsym               LDP0    B$ROSEG$
PL6.E3A0      #001=FSP$CLSDEV File=FSP$CLSDEV.:E05TSI                            TUE 07/29/97 17:37 Page:28   
         2 000064   000000 471500                    LDP1    0,,PR0
         2 000065   200057 720100                    LXL0    I,,AUTO
         2 000066   100000 236110                    LDQ     0,X0,PR1
         2 000067   000001 116000 xsym               CMPQ    B_VECTNIL+1
         2 000070   000100 600000 2                  TZE     s:11513

      172    11510    5                          IF B$ROSEG.DCBPTR$->B$RODCB$(I)->F$DCB.FCD AND

  11510  2 000071   100000 473510                    LDP3    0,X0,PR1
         2 000072   300031 236100                    LDQ     25,,PR3
         2 000073   020000 316007                    CANQ    8192,DL
         2 000074   000100 600000 2                  TZE     s:11513
         2 000075   300103 236100                    LDQ     67,,PR3
         2 000076   004000 316007                    CANQ    2048,DL
         2 000077   000151 601000 2                  TNZ     MORE_JCL

      173    11511    5                            B$ROSEG.DCBPTR$->B$RODCB$(I)->F$DCB.CTLCMDIN THEN
      174    11512    5                             GOTO MORE_JCL;
      175    11513    5                       I=I-1;

  11513  2 000100   000001 336007                    LCQ     1,DL
         2 000101   200057 056100                    ASQ     I,,AUTO

      176    11514    5                       END;

  11514  2 000102   200057 235100                    LDA     I,,AUTO
         2 000103   000001 115000 3                  CMPA    1
         2 000104   000063 605000 2                  TPL     s:11509

      177    11515    5                    IF SDCB$->F$DCB.IASN=%FILE# THEN DO;

  11515  2 000105   200056 471500                    LDP1    SDCB$,,AUTO
         2 000106   100103 236100                    LDQ     67,,PR1
         2 000107   000777 376007                    ANQ     511,DL
         2 000110   000001 116007                    CMPQ    1,DL
         2 000111   000124 601000 2                  TNZ     s:11520

PL6.E3A0      #001=FSP$CLSDEV File=FSP$CLSDEV.:E05TSI                            TUE 07/29/97 17:37 Page:29   
      178    11516    5                       B$JIT.DCB$=SDCB$;

  11516  2 000112   200056 236100                    LDQ     SDCB$,,AUTO
         2 000113   000000 473400 xsym               LDP3    B$JIT$
         2 000114   300232 756100                    STQ     154,,PR3

      179    11517    5                       CALL FMP$CLSF(CLSSAVE$);

  11517  2 000115   000002 630400 3                  EPPR0   2
         2 000116   000017 631400 xsym               EPPR1   B_VECTNIL+15
         2 000117   000000 701000 xent               TSX1    FMP$CLSF
         2 000120   000000 011000                    NOP     0

      180    11518    5                       SDCB$->F$DCB.IASN=0;

  11518  2 000121   200056 470500                    LDP0    SDCB$,,AUTO
         2 000122   000000 236003                    LDQ     0,DU
         2 000123   000103 552104                    STBQ    67,'04'O,PR0

      181    11519    5                       END;

      182    11520    4                    IF SDCB$=B$M$UC$ THEN

  11520  2 000124   200056 236100                    LDQ     SDCB$,,AUTO
         2 000125   000000 116000 xsym               CMPQ    B$M$UC$
         2 000126   000133 601000 2                  TNZ     s:11523

      183    11521    4                       SDCB$->F$DCB.FCD=%YES#;

  11521  2 000127   200056 470500                    LDP0    SDCB$,,AUTO
         2 000130   020000 236007                    LDQ     8192,DL
         2 000131   000031 256100                    ORSQ    25,,PR0
         2 000132   000151 710000 2                  TRA     MORE_JCL

      184    11522    5                    ELSE DO;

      185    11523    5                       CALL FSA$FDCB(PINCRW(B$ROSEG$, B$ROSEG.CR01DCB));
PL6.E3A0      #001=FSP$CLSDEV File=FSP$CLSDEV.:E05TSI                            TUE 07/29/97 17:37 Page:30   

  11523  2 000133   000000 470400 xsym               LDP0    B$ROSEG$
         2 000134   000115 220100                    LDX0    77,,PR0
         2 000135   000000 636010                    EAQ     0,X0
         2 000136   000000 036000 xsym               ADLQ    B$ROSEG$
         2 000137   200072 756100                    STQ     COMIO+5,,AUTO
         2 000140   200072 631500                    EPPR1   COMIO+5,,AUTO
         2 000141   200073 451500                    STP1    COMIO+6,,AUTO
         2 000142   200073 630500                    EPPR0   COMIO+6,,AUTO
         2 000143   000017 631400 xsym               EPPR1   B_VECTNIL+15
         2 000144   000000 701000 xent               TSX1    FSA$FDCB
         2 000145   000000 011000                    NOP     0

      186    11524    5                       B$ROSEG.CR01DCB=0;

  11524  2 000146   000000 220003                    LDX0    0,DU
         2 000147   000000 470400 xsym               LDP0    B$ROSEG$
         2 000150   000115 740100                    STX0    77,,PR0

      187    11525    5                       END;

      188    11526    4   MORE_JCL:      END;

  11526  2 000151                       MORE_JCL     null
      189    11527    3                 IF SDCB$=F$DCB.CFU$ THEN GOTO MORE_STR;

  11527  2 000151   200055 470500                    LDP0    JDCB$,,AUTO
         2 000152   200056 236100                    LDQ     SDCB$,,AUTO
         2 000153   000066 116100                    CMPQ    54,,PR0
         2 000154   000532 600000 2                  TZE     MORE_STR

      190    11528    3                 END;

      191    11529                /*** Second, process the Output side.*/
      192    11530    2              SDCB$ = F$DCB.CFU$;

  11530  2 000155   200055 470500                    LDP0    JDCB$,,AUTO
PL6.E3A0      #001=FSP$CLSDEV File=FSP$CLSDEV.:E05TSI                            TUE 07/29/97 17:37 Page:31   
         2 000156   000066 236100                    LDQ     54,,PR0
         2 000157   200056 756100                    STQ     SDCB$,,AUTO

      193    11531    2              IF SDCB$=B$M$UC$

  11531  2 000160   000000 116000 xsym               CMPQ    B$M$UC$
         2 000161   000335 601000 2                  TNZ     s:11574

      194    11532    3              THEN DO;

      195    11533    3                 IF SDCB$->F$DCB.MEDIA ~= FMTUC#

  11533  2 000162   200056 471500                    LDP1    SDCB$,,AUTO
         2 000163   100103 236100                    LDQ     67,,PR1
         2 000164   000777 376003                    ANQ     511,DU
         2 000165   000014 116003                    CMPQ    12,DU
         2 000166   000532 601000 2                  TNZ     MORE_STR

      196    11534    3                 THEN GOTO MORE_STR;
      197    11535    3                 IF F$DCB.FCN.CNT(0) ~= 0

  11535  2 000167   000074 236100                    LDQ     60,,PR0
         2 000170   377000 316003                    CANQ    130560,DU
         2 000171   000232 600000 2                  TZE     FIND_UC_STR

      198    11536    4                 THEN DO;

      199    11537    4                    LDCT$ = NK$LDCT$(SDCB$->F$DCB.LDCTX);

  11537  2 000172   100051 220100                    LDX0    41,,PR1
         2 000173   000000 473400 xsym               LDP3    N$DCT$$
         2 000174   300000 236110                    LDQ     0,X0,PR3
         2 000175   200054 756100                    STQ     LDCT$,,AUTO

      200    11538    4                    IF LDCT$ ~= ADDR(NIL)

  11538  2 000176   000001 116000 xsym               CMPQ    B_VECTNIL+1
PL6.E3A0      #001=FSP$CLSDEV File=FSP$CLSDEV.:E05TSI                            TUE 07/29/97 17:37 Page:32   
         2 000177   000232 600000 2                  TZE     FIND_UC_STR

      201    11539    5                    THEN DO;

      202    11540                            %LOCK (G=NK$LDCT.LOCK);

  11541  2 000200   000020 036003                    ADLQ    16,DU
         2 000201   200072 756100                    STQ     COMIO+5,,AUTO
         2 000202   200072 630500                    EPPR0   COMIO+5,,AUTO
         2 000203   000017 631400 xsym               EPPR1   B_VECTNIL+15
         2 000204   000000 701000 xent               TSX1    HFC$LOCK
         2 000205   000000 011000                    NOP     0

      203    11543    5                       CALL KILL_IO;

  11543  2 000206   001553 701000 2                  TSX1    KILL_IO
         2 000207   000000 011000                    NOP     0

      204    11544    5                       IF I~=0

  11544  2 000210   200057 235100                    LDA     I,,AUTO
         2 000211   000223 600000 2                  TZE     s:11547

      205    11545    5                       THEN SDCB$->F$DCB.FCN.CNT(0) = SDCB$->F$DCB.FCN.CNT(0) - I;

  11545  2 000212   200056 470500                    LDP0    SDCB$,,AUTO
         2 000213   000074 236100                    LDQ     60,,PR0
         2 000214   000033 772000                    QRL     27
         2 000215   000377 376007                    ANQ     255,DL
         2 000216   200057 136100                    SBLQ    I,,AUTO
         2 000217   000033 736000                    QLS     27
         2 000220   000074 676100                    ERQ     60,,PR0
         2 000221   377000 376003                    ANQ     130560,DU
         2 000222   000074 656100                    ERSQ    60,,PR0

      206    11546                            %UNLOCK (G=NK$LDCT.LOCK);

PL6.E3A0      #001=FSP$CLSDEV File=FSP$CLSDEV.:E05TSI                            TUE 07/29/97 17:37 Page:33   
  11547  2 000223   200054 236100                    LDQ     LDCT$,,AUTO
         2 000224   000020 036003                    ADLQ    16,DU
         2 000225   200072 756100                    STQ     COMIO+5,,AUTO
         2 000226   200072 630500                    EPPR0   COMIO+5,,AUTO
         2 000227   000017 631400 xsym               EPPR1   B_VECTNIL+15
         2 000230   000000 701000 xent               TSX1    HFC$UNLOCK
         2 000231   000000 011000                    NOP     0

      207    11549    5                       END;

      208    11550    4                    END;

  11545  2 000232                       FIND_UC_STR  null
      209    11551    3   FIND_UC_STR:  ;
      210    11552    3                 J = F$DCB.STR;

  11552  2 000232   200055 470500                    LDP0    JDCB$,,AUTO
         2 000233   000077 236100                    LDQ     63,,PR0
         2 000234   000777 376007                    ANQ     511,DL
         2 000235   200060 756100                    STQ     J,,AUTO

      211    11553    3                 I = B$ROSEG.NUMDCBS;

  11553  2 000236   000000 471400 xsym               LDP1    B$ROSEG$
         2 000237   100002 236100                    LDQ     2,,PR1
         2 000240   000022 772000                    QRL     18
         2 000241   200057 756100                    STQ     I,,AUTO

      212    11554    4                 DO WHILE (I>%M$UC#);

  11554  2 000242   000003 116007                    CMPQ    3,DL
         2 000243   000277 604400 2                  TMOZ    s:11564

      213    11555    4                    IF B$ROSEG.DCBPTR$->B$RODCB$(I)~=ADDR(NIL)

  11555  2 000244   000000 470400 xsym               LDP0    B$ROSEG$
         2 000245   000000 471500                    LDP1    0,,PR0
PL6.E3A0      #001=FSP$CLSDEV File=FSP$CLSDEV.:E05TSI                            TUE 07/29/97 17:37 Page:34   
         2 000246   200057 720100                    LXL0    I,,AUTO
         2 000247   100000 236110                    LDQ     0,X0,PR1
         2 000250   000001 116000 xsym               CMPQ    B_VECTNIL+1
         2 000251   000272 600000 2                  TZE     s:11562

      214    11556    4                    THEN IF B$ROSEG.DCBPTR$->B$RODCB$(I)->F$DCB.FCD

  11556  2 000252   100000 473510                    LDP3    0,X0,PR1
         2 000253   300031 236100                    LDQ     25,,PR3
         2 000254   020000 316007                    CANQ    8192,DL
         2 000255   000272 600000 2                  TZE     s:11562
         2 000256   300066 236100                    LDQ     54,,PR3
         2 000257   000000 116000 xsym               CMPQ    B$M$UC$
         2 000260   000265 601000 2                  TNZ     s:11556+11
         2 000261   300077 236100                    LDQ     63,,PR3
         2 000262   000777 376007                    ANQ     511,DL
         2 000263   200060 116100                    CMPQ    J,,AUTO
         2 000264   000532 600000 2                  TZE     MORE_STR
         2 000265   300077 236100                    LDQ     63,,PR3
         2 000266   000011 772000                    QRL     9
         2 000267   000777 376007                    ANQ     511,DL
         2 000270   200060 116100                    CMPQ    J,,AUTO
         2 000271   000532 600000 2                  TZE     MORE_STR

      215    11557    4                         AND (B$ROSEG.DCBPTR$->B$RODCB$(I)->F$DCB.CFU$ = B$M$UC$
      216    11558    4                         AND J = B$ROSEG.DCBPTR$->B$RODCB$(I)->F$DCB.STR
      217    11559    4                         OR J = B$ROSEG.DCBPTR$->B$RODCB$(I)->F$DCB.FPSTR)
      218    11560    4                       THEN
      219    11561    4                          GOTO MORE_STR;
      220    11562    4                    I = I -1;

  11562  2 000272   000001 336007                    LCQ     1,DL
         2 000273   200057 056100                    ASQ     I,,AUTO

      221    11563    4                    END;

  11563  2 000274   200057 235100                    LDA     I,,AUTO
PL6.E3A0      #001=FSP$CLSDEV File=FSP$CLSDEV.:E05TSI                            TUE 07/29/97 17:37 Page:35   
         2 000275   000003 115007                    CMPA    3,DL
         2 000276   000244 605400 2                  TPNZ    s:11555

      222    11564    3                 IF J < 20 /* LDEVed stream */

  11564  2 000277   200060 235100                    LDA     J,,AUTO
         2 000300   000024 115007                    CMPA    20,DL
         2 000301   000322 605000 2                  TPL     s:11570

      223    11565    4                 THEN DO;

      224    11566    4                    CALL KIA$CLSSTR(J,'0'B,'0'B);

  11566  2 000302   000003 236000 3                  LDQ     3
         2 000303   200074 756100                    STQ     COMIO+7,,AUTO
         2 000304   200073 756100                    STQ     COMIO+6,,AUTO
         2 000305   200060 630500                    EPPR0   J,,AUTO
         2 000306   200072 450500                    STP0    COMIO+5,,AUTO
         2 000307   200072 630500                    EPPR0   COMIO+5,,AUTO
         2 000310   000021 631400 xsym               EPPR1   B_VECTNIL+17
         2 000311   000000 701000 xent               TSX1    KIA$CLSSTR
         2 000312   000000 011000                    NOP     0

      225    11567    4                    B$ROSEG.STREAMID.FLG(J) = 1;

  11567  2 000313   000000 470400 xsym               LDP0    B$ROSEG$
         2 000314   200060 720100                    LXL0    J,,AUTO
         2 000315   000074 236110                    LDQ     60,X0,PR0
         2 000316   000004 376000 3                  ANQ     4
         2 000317   200000 276003                    ORQ     65536,DU
         2 000320   000074 756110                    STQ     60,X0,PR0

      226    11568    4                    END;

  11568  2 000321   000334 710000 2                  TRA     s:11572

      227    11569    4                 ELSE DO;
PL6.E3A0      #001=FSP$CLSDEV File=FSP$CLSDEV.:E05TSI                            TUE 07/29/97 17:37 Page:36   

      228    11570    4                    CALL KIA$CLSSTR (J,'1'B,'0'B); /* Release stream */

  11570  2 000322   000003 236000 3                  LDQ     3
         2 000323   200074 756100                    STQ     COMIO+7,,AUTO
         2 000324   000005 236000 3                  LDQ     5
         2 000325   200073 756100                    STQ     COMIO+6,,AUTO
         2 000326   200060 630500                    EPPR0   J,,AUTO
         2 000327   200072 450500                    STP0    COMIO+5,,AUTO
         2 000330   200072 630500                    EPPR0   COMIO+5,,AUTO
         2 000331   000021 631400 xsym               EPPR1   B_VECTNIL+17
         2 000332   000000 701000 xent               TSX1    KIA$CLSSTR
         2 000333   000000 011000                    NOP     0

      229    11571    4                    END;

      230    11572    3                 GOTO MORE_STR;

  11572  2 000334   000532 710000 2                  TRA     MORE_STR

      231    11573    3                 END;
      232    11574    2              I=B$ROSEG.NUMDCBS;

  11574  2 000335   000000 471400 xsym               LDP1    B$ROSEG$
         2 000336   100002 236100                    LDQ     2,,PR1
         2 000337   000022 772000                    QRL     18
         2 000340   200057 756100                    STQ     I,,AUTO

      233    11575    3              DO WHILE (I>=%M$MAXNEG#);

  11575  2 000341   000407 710000 2                  TRA     s:11590

      234    11576    3                 IF B$ROSEG.DCBPTR$->B$RODCB$(I)~=ADDR(NIL) THEN

  11576  2 000342   000000 470400 xsym               LDP0    B$ROSEG$
         2 000343   000000 471500                    LDP1    0,,PR0
         2 000344   200057 720100                    LXL0    I,,AUTO
PL6.E3A0      #001=FSP$CLSDEV File=FSP$CLSDEV.:E05TSI                            TUE 07/29/97 17:37 Page:37   
         2 000345   100000 236110                    LDQ     0,X0,PR1
         2 000346   000001 116000 xsym               CMPQ    B_VECTNIL+1
         2 000347   000405 600000 2                  TZE     s:11589

      235    11577    3                    IF B$ROSEG.DCBPTR$->B$RODCB$(I)->F$DCB.FCD AND

  11577  2 000350   100000 473510                    LDP3    0,X0,PR1
         2 000351   300031 236100                    LDQ     25,,PR3
         2 000352   020000 316007                    CANQ    8192,DL
         2 000353   000405 600000 2                  TZE     s:11589
         2 000354   300066 236100                    LDQ     54,,PR3
         2 000355   200056 116100                    CMPQ    SDCB$,,AUTO
         2 000356   000405 601000 2                  TNZ     s:11589

      236    11578    3                      B$ROSEG.DCBPTR$->B$RODCB$(I)->F$DCB.CFU$=SDCB$
      237    11579    4                    THEN DO;

      238    11580    4                       IF SDCB$->F$DCB.ORG = %FPRG#

  11580  2 000357   200056 474500                    LDP4    SDCB$,,AUTO
         2 000360   400032 236100                    LDQ     26,,PR4
         2 000361   777000 376003                    ANQ     -512,DU
         2 000362   012000 116003                    CMPQ    5120,DU
         2 000363   000404 601000 2                  TNZ     s:11587

      239    11581    5                       THEN DO;

      240    11582    5                          LDCT$=NK$LDCT$(SDCB$->F$DCB.LDCTX);

  11582  2 000364   400051 221100                    LDX1    41,,PR4
         2 000365   000000 475400 xsym               LDP5    N$DCT$$
         2 000366   500000 236111                    LDQ     0,X1,PR5
         2 000367   200054 756100                    STQ     LDCT$,,AUTO

      241    11583    5                          IF B$JIT.DCBNO = NK$LDCT.UDCBNO

  11583  2 000370   200054 476500                    LDP6    LDCT$,,AUTO
PL6.E3A0      #001=FSP$CLSDEV File=FSP$CLSDEV.:E05TSI                            TUE 07/29/97 17:37 Page:38   
         2 000371   600016 236100                    LDQ     14,,PR6
         2 000372   000033 772000                    QRL     27
         2 000373   200072 756100                    STQ     COMIO+5,,AUTO
         2 000374   000000 471400 xsym               LDP1    B$JIT$
         2 000375   100022 236100                    LDQ     18,,PR1
         2 000376   000777 376007                    ANQ     511,DL
         2 000377   200072 116100                    CMPQ    COMIO+5,,AUTO
         2 000400   000404 601000 2                  TNZ     s:11587

      242    11584    5                          THEN
      243    11585    5                             NK$LDCT.UDCBNO = I;

  11585  2 000401   200057 236100                    LDQ     I,,AUTO
         2 000402   000033 736000                    QLS     27
         2 000403   600016 552140                    STBQ    14,'40'O,PR6

      244    11586    5                          END;

      245    11587    4                       GOTO MORE_STR;

  11587  2 000404   000532 710000 2                  TRA     MORE_STR

      246    11588    4                       END;
      247    11589    3                 I=I-1;

  11589  2 000405   000001 336007                    LCQ     1,DL
         2 000406   200057 056100                    ASQ     I,,AUTO

      248    11590    3                 END;

  11590  2 000407   200057 235100                    LDA     I,,AUTO
         2 000410   000001 115000 3                  CMPA    1
         2 000411   000342 605000 2                  TPL     s:11576

      249    11591    2              B$JIT.DCB$=SDCB$;

  11591  2 000412   200056 236100                    LDQ     SDCB$,,AUTO
PL6.E3A0      #001=FSP$CLSDEV File=FSP$CLSDEV.:E05TSI                            TUE 07/29/97 17:37 Page:39   
         2 000413   000000 470400 xsym               LDP0    B$JIT$
         2 000414   000232 756100                    STQ     154,,PR0

      250    11592    2              J=POFFW(SDCB$,B$ROSEG$);

  11592  2 000415   000000 235000 xsym               LDA     B$ROSEG$
         2 000416   000022 771000                    ARL     18
         2 000417   200072 755100                    STA     COMIO+5,,AUTO
         2 000420   200056 236100                    LDQ     SDCB$,,AUTO
         2 000421   000022 772000                    QRL     18
         2 000422   200072 136100                    SBLQ    COMIO+5,,AUTO
         2 000423   200060 756100                    STQ     J,,AUTO

      251    11593    2              I=0;

  11593  2 000424   200057 450100                    STZ     I,,AUTO

      252    11594    3              DO UNTIL(I>15);

      253    11595    3                 IF B$ROSEG.STREAMID.IDENT(I)=J AND

  11595  2 000425   000000 470400 xsym               LDP0    B$ROSEG$
         2 000426   200057 720100                    LXL0    I,,AUTO
         2 000427   000074 236110                    LDQ     60,X0,PR0
         2 000430   777777 376007                    ANQ     -1,DL
         2 000431   200060 116100                    CMPQ    J,,AUTO
         2 000432   000517 601000 2                  TNZ     s:11612
         2 000433   000074 236110                    LDQ     60,X0,PR0
         2 000434   600000 376003                    ANQ     -65536,DU
         2 000435   400000 116003                    CMPQ    -131072,DU
         2 000436   000517 601000 2                  TNZ     s:11612

      254    11596    4                   B$ROSEG.STREAMID.FLG(I)=2 THEN /*case1*/ DO;

      255    11597    4                    IF SDCB$->F$DCB.FCD AND NOT B$ROSEG.STREAMID.UC_STR(I)

  11597  2 000437   200056 471500                    LDP1    SDCB$,,AUTO
PL6.E3A0      #001=FSP$CLSDEV File=FSP$CLSDEV.:E05TSI                            TUE 07/29/97 17:37 Page:40   
         2 000440   100031 236100                    LDQ     25,,PR1
         2 000441   020000 316007                    CANQ    8192,DL
         2 000442   000502 600000 2                  TZE     s:11608
         2 000443   000074 236110                    LDQ     60,X0,PR0
         2 000444   000001 316003                    CANQ    1,DU
         2 000445   000502 601000 2                  TNZ     s:11608

      256    11598    5                    THEN DO;

      257    11599    5                       CALL FSL$ACCT(SDCB$->F$DCB);

  11599  2 000446   200056 630500                    EPPR0   SDCB$,,AUTO
         2 000447   000017 631400 xsym               EPPR1   B_VECTNIL+15
         2 000450   000000 701000 xent               TSX1    FSL$ACCT
         2 000451   000000 011000                    NOP     0

      258    11600    5                       IF SDCB$->F$DCB.FORM$->CODE16.RECNO~=0 OR

  11600  2 000452   200056 470500                    LDP0    SDCB$,,AUTO
         2 000453   000050 471500                    LDP1    40,,PR0
         2 000454   100004 235100                    LDA     4,,PR1
         2 000455   000460 601000 2                  TNZ     s:11602
         2 000456   100005 220100                    LDX0    5,,PR1
         2 000457   000464 600000 2                  TZE     s:11603

      259    11601    5                         SDCB$->F$DCB.FORM$->CODE16.PAGENO~=0 THEN
      260    11602    5                          B$ROSEG.STREAMID.F01(I)=%YES#;

  11602  2 000460   000000 473400 xsym               LDP3    B$ROSEG$
         2 000461   200057 720100                    LXL0    I,,AUTO
         2 000462   100000 236003                    LDQ     32768,DU
         2 000463   300074 256110                    ORSQ    60,X0,PR3

      261    11603    5                       CALL CHARBIN(J,ADDR(SDCB$->F$DCB.NAME)->OSFN.NUM);

  11603  2 000464   000100 305500                    DTB
         2 000465   000012 430006                    NDSC9   10,,PR0                  cn=2,s=nosgn,sf=0,n=6
PL6.E3A0      #001=FSP$CLSDEV File=FSP$CLSDEV.:E05TSI                            TUE 07/29/97 17:37 Page:41   
         2 000466   200060 000004                    NDSC9   J,,AUTO                  cn=0,s=lsgnf,sf=0,n=4

      262    11604    5                       B$ROSEG.STREAMID.IDENT(I)=J;

  11604  2 000467   200060 720100                    LXL0    J,,AUTO
         2 000470   000000 471400 xsym               LDP1    B$ROSEG$
         2 000471   200057 721100                    LXL1    I,,AUTO
         2 000472   100074 440111                    SXL0    60,X1,PR1

      263    11605    5                       CALL FMH$SYMB_FINISH;

  11605  2 000473   000002 631400 xsym               EPPR1   B_VECTNIL+2
         2 000474   000000 701000 xent               TSX1    FMH$SYMB_FINISH
         2 000475   000000 011000                    NOP     0

      264    11606    5                       CALL FMP$CLSF(CLSSAVE$);

  11606  2 000476   000002 630400 3                  EPPR0   2
         2 000477   000017 631400 xsym               EPPR1   B_VECTNIL+15
         2 000500   000000 701000 xent               TSX1    FMP$CLSF
         2 000501   000000 011000                    NOP     0

      265    11607    5                       END;

      266    11608    4                    B$ROSEG.STREAMID.FLG(I)=1;

  11608  2 000502   000000 470400 xsym               LDP0    B$ROSEG$
         2 000503   200057 720100                    LXL0    I,,AUTO
         2 000504   000074 236110                    LDQ     60,X0,PR0
         2 000505   000004 376000 3                  ANQ     4
         2 000506   200000 276003                    ORQ     65536,DU
         2 000507   000074 756110                    STQ     60,X0,PR0

      267    11609    4                    B$ROSEG.DCBPTR$->B$RODCB$(%M$STR01#-I) = ADDR(NIL);

  11609  2 000510   000000 471500                    LDP1    0,,PR0
         2 000511   200057 720100                    LXL0    I,,AUTO
PL6.E3A0      #001=FSP$CLSDEV File=FSP$CLSDEV.:E05TSI                            TUE 07/29/97 17:37 Page:42   
         2 000512   777777 620010                    EAX0    -1,X0
         2 000513   777777 660003                    ERX0    -1,DU
         2 000514   000001 236000 xsym               LDQ     B_VECTNIL+1
         2 000515   177774 756110                    STQ     -4,X0,PR1

      268    11610    4                    GOTO GOT_STRM;

  11610  2 000516   000523 710000 2                  TRA     GOT_STRM

      269    11611    4                    END;
      270    11612    3                 I=I+1;

  11612  2 000517   200057 054100                    AOS     I,,AUTO

      271    11613    3                 END;

  11613  2 000520   200057 235100                    LDA     I,,AUTO
         2 000521   000017 115007                    CMPA    15,DL
         2 000522   000425 604400 2                  TMOZ    s:11595

  11609  2 000523                       GOT_STRM     null
      272    11614    2   GOT_STRM:  ;
      273    11615    2              CALL FSA$FDCB(B$JIT.DCB$);

  11615  2 000523   000000 236000 xsym               LDQ     B$JIT$
         2 000524   000232 036003                    ADLQ    154,DU
         2 000525   200072 756100                    STQ     COMIO+5,,AUTO
         2 000526   200072 630500                    EPPR0   COMIO+5,,AUTO
         2 000527   000017 631400 xsym               EPPR1   B_VECTNIL+15
         2 000530   000000 701000 xent               TSX1    FSA$FDCB
         2 000531   000000 011000                    NOP     0

  11609  2 000532                       MORE_STR     null
      274    11616    2   MORE_STR:  ;
      275    11617    2              B$JIT.DCB$=JDCB$;

  11617  2 000532   200055 236100                    LDQ     JDCB$,,AUTO
PL6.E3A0      #001=FSP$CLSDEV File=FSP$CLSDEV.:E05TSI                            TUE 07/29/97 17:37 Page:43   
         2 000533   000000 470400 xsym               LDP0    B$JIT$
         2 000534   000232 756100                    STQ     154,,PR0
         2 000535   001544 710000 2                  TRA     s:11836

      276    11618    2            CASE(%DEVICE#);

      277    11619        /*D*       When user DCB.IASN=DEVICE, the DCB either is interactive
      278    11620                M$UC or is the DCB of a resource device.  If it is M$UC, it
      279    11621                is not allowed to be closed.  If it is the DCB of a resource
      280    11622                device, FRB$CLS will close it properly.
      281    11623                If it is the DCB of a resource device for a Network Connection,
      282    11624                ie.  .MEDIA is FMTNC#, then KIS$OSI_CLOSE will handle the
      283    11625                close.
      284    11626                If open to a remote data resource (OSI FTAM, IFMT=FMTREMOTE)
      285    11627                then FMF$REMOTE closes it.
      286    11628         */
      287    11629
      288    11630    2              IF JDCB$=B$M$UC$ THEN GOTO UCNOCLS;

  11630  2 000536   000000 116000 xsym               CMPQ    B$M$UC$
         2 000537   001550 600000 2                  TZE     UCNOCLS

      289    11631
      290    11632    2              IF F$DCB.MEDIA = FMTNC# THEN

  11632  2 000540   100103 236100                    LDQ     67,,PR1
         2 000541   000777 376003                    ANQ     511,DU
         2 000542   000031 116003                    CMPQ    25,DU
         2 000543   000551 601000 2                  TNZ     s:11640

      291    11633    3                 CALL KIS$OSI_CLOSE WHENRETURN DO;

  11633  2 000544   000002 631400 xsym               EPPR1   B_VECTNIL+2
         2 000545   000000 701000 xent               TSX1    KIS$OSI_CLOSE
         2 000546   000550 702000 2                  TSX2    s:11637

      292    11634    3                    RETURN;
PL6.E3A0      #001=FSP$CLSDEV File=FSP$CLSDEV.:E05TSI                            TUE 07/29/97 17:37 Page:44   

  11634  2 000547   000000 702200 xent               TSX2  ! X66_ARET

      293    11635    3                    END; /*  WHENRETURN  */
      294    11636    3                 WHENALTRETURN DO;

      295    11637    3                    ALTRETURN;

  11637  2 000550   000000 702200 xent               TSX2  ! X66_AALT

      296    11638    3                    END; /*  WHENALTRETURN  */
      297    11639
      298    11640    3              IF F$DCB.IFMT = FMTREMOTE# THEN DO;

  11640  2 000551   100103 236100                    LDQ     67,,PR1
         2 000552   777000 376003                    ANQ     -512,DU
         2 000553   033000 116003                    CMPQ    13824,DU
         2 000554   000562 601000 2                  TNZ     s:11645

      299    11641    3                 CALL FMF$REMOTE(1);

  11641  2 000555   000006 630400 3                  EPPR0   6
         2 000556   000017 631400 xsym               EPPR1   B_VECTNIL+15
         2 000557   000000 701000 xent               TSX1    FMF$REMOTE
         2 000560   000000 011000                    NOP     0

      300    11642    3                 RETURN;

  11642  2 000561   000000 702200 xent               TSX2  ! X66_ARET

      301    11643    3                 END;
      302    11644
      303    11645    3              DO I=0 TO 4;

  11645  2 000562   200057 450100                    STZ     I,,AUTO

      304    11646    3                 CALL FMD$RELBUF(I);
PL6.E3A0      #001=FSP$CLSDEV File=FSP$CLSDEV.:E05TSI                            TUE 07/29/97 17:37 Page:45   

  11646  2 000563   200057 630500                    EPPR0   I,,AUTO
         2 000564   200072 450500                    STP0    COMIO+5,,AUTO
         2 000565   200072 630500                    EPPR0   COMIO+5,,AUTO
         2 000566   000017 631400 xsym               EPPR1   B_VECTNIL+15
         2 000567   000000 701000 xent               TSX1    FMD$RELBUF
         2 000570   000000 011000                    NOP     0

      305    11647    3                 END;

  11647  2 000571   200057 054100                    AOS     I,,AUTO
         2 000572   200057 235100                    LDA     I,,AUTO
         2 000573   000004 115007                    CMPA    4,DL
         2 000574   000563 604400 2                  TMOZ    s:11646

      306    11648    2              LDCT$ = NK$LDCT$(F$DCB.SETX);

  11648  2 000575   200055 470500                    LDP0    JDCB$,,AUTO
         2 000576   000051 720100                    LXL0    41,,PR0
         2 000577   000000 471400 xsym               LDP1    N$DCT$$
         2 000600   100000 236110                    LDQ     0,X0,PR1
         2 000601   200054 756100                    STQ     LDCT$,,AUTO

      307    11649    2              IF LDCT$=ADDR(NIL) THEN GOTO FEP_CLOSE;

  11649  2 000602   000001 116000 xsym               CMPQ    B_VECTNIL+1
         2 000603   001050 600000 2                  TZE     FEP_CLOSE

      308    11650    2              IF NOT NK$LDCT.DFLG.LOCAL THEN GOTO FEP_CLOSE;

  11650  2 000604   200054 473500                    LDP3    LDCT$,,AUTO
         2 000605   300006 236100                    LDQ     6,,PR3
         2 000606   002000 316007                    CANQ    1024,DL
         2 000607   001050 600000 2                  TZE     FEP_CLOSE

      309    11651    2              CALL FMB$IOSPIN;

PL6.E3A0      #001=FSP$CLSDEV File=FSP$CLSDEV.:E05TSI                            TUE 07/29/97 17:37 Page:46   
  11651  2 000610   000002 631400 xsym               EPPR1   B_VECTNIL+2
         2 000611   000000 701000 xent               TSX1    FMB$IOSPIN
         2 000612   000000 011000                    NOP     0

      310    11652    2              CALL FRB$CLS;

  11652  2 000613   000002 631400 xsym               EPPR1   B_VECTNIL+2
         2 000614   000000 701000 xent               TSX1    FRB$CLS
         2 000615   000000 011000                    NOP     0
         2 000616   001544 710000 2                  TRA     s:11836

      311    11653    2            CASE(%FILE#);

      312    11654        /*D*       When user DCB.IASN=FILE, the DCB is either non-interactive
      313    11655                M$UC, a workstation-assigned DCB, a control-command
      314    11656                creating DCB, or a TP DCB hooked non-streamed to M$UC.
      315    11657                If it is M$UC, it is not allowed to be closed.
      316    11658                If it is workstation assigned, the DCB is internally hooked
      317    11659                to a symbiont file.  If the file is to be saved on the close,
      318    11660                output in the file is accounted for, the file is closed,
      319    11661                and OUTSYM is told about the file.  If the file is not to be
      320    11662                saved, it is just closed.
      321    11663                If the DCB is creating control commands, it is either JE or
      322    11664                JF.  JE files are closed and PRESCAN is told about them.  JF
      323    11665                files must be hooked up to be this user's control-command
      324    11666                place; FSD$JFCLS does this.
      325    11667                If a TP DCB, KCO$CLCG is called.
      326    11668         */
      327    11669    2              IF JDCB$=B$M$UC$ THEN GOTO UCNOCLS;

  11669  2 000617   000000 116000 xsym               CMPQ    B$M$UC$
         2 000620   001550 600000 2                  TZE     UCNOCLS

      328    11670    3              IF F$DCB.MEDIA=FMTCG# THEN DO;

  11670  2 000621   100103 236100                    LDQ     67,,PR1
         2 000622   000777 376003                    ANQ     511,DU
PL6.E3A0      #001=FSP$CLSDEV File=FSP$CLSDEV.:E05TSI                            TUE 07/29/97 17:37 Page:47   
         2 000623   000010 116003                    CMPQ    8,DU
         2 000624   000635 601000 2                  TNZ     s:11675

      329    11671    3                 CALL KCO$CLCG(PN$);

  11671  2 000625   200003 630500                    EPPR0   @PN$,,AUTO
         2 000626   000017 631400 xsym               EPPR1   B_VECTNIL+15
         2 000627   000000 701000 xent               TSX1    KCO$CLCG
         2 000630   000000 011000                    NOP     0

      330    11672    3                 F$DCB.FUN=%CREATE#; /* Restore original FUN */

  11672  2 000631   200055 470500                    LDP0    JDCB$,,AUTO
         2 000632   000003 236003                    LDQ     3,DU
         2 000633   000032 552120                    STBQ    26,'20'O,PR0

      331    11673    3                 RETURN;

  11673  2 000634   000000 702200 xent               TSX2  ! X66_ARET

      332    11674    3                 END;
      333    11675    2              IF PN$.V_=ADDR(NIL) THEN I=0;

  11675  2 000635   200003 473500                    LDP3    @PN$,,AUTO
         2 000636   300000 236100                    LDQ     0,,PR3
         2 000637   000001 116000 xsym               CMPQ    B_VECTNIL+1
         2 000640   000643 601000 2                  TNZ     s:11676

  11675  2 000641   200057 450100                    STZ     I,,AUTO
         2 000642   000647 710000 2                  TRA     s:11677

      334    11676    2              ELSE I=PN$.V_->FPT$CLOSE_V.DISP;

  11676  2 000643   300000 474500                    LDP4    0,,PR3
         2 000644   400000 236100                    LDQ     0,,PR4
         2 000645   000777 376007                    ANQ     511,DL
         2 000646   200057 756100                    STQ     I,,AUTO
PL6.E3A0      #001=FSP$CLSDEV File=FSP$CLSDEV.:E05TSI                            TUE 07/29/97 17:37 Page:48   

      335    11677    2              IF F$DCB.IFMT=FMTJCLOUT# THEN

  11677  2 000647   100103 236100                    LDQ     67,,PR1
         2 000650   777000 376003                    ANQ     -512,DU
         2 000651   011000 116003                    CMPQ    4608,DU
         2 000652   000726 601000 2                  TNZ     s:11693

      336    11678        /*            For JE/JF, scratch it unless SAVE specified.*/
      337    11679    2                 IF (I=%SAVE#) AND (F$DCB.CFU$->FM$CFU.NRECS~=0) THEN

  11679  2 000653   200057 235100                    LDA     I,,AUTO
         2 000654   000002 115007                    CMPA    2,DL
         2 000655   000721 601000 2                  TNZ     s:11690
         2 000656   100066 474500                    LDP4    54,,PR1
         2 000657   400001 235100                    LDA     1,,PR4
         2 000660   000721 600000 2                  TZE     s:11690

      338    11680    2                    IF F$DCB.RES='JF' THEN

  11680  2 000661   040000 106500                    CMPC    fill='040'O
         2 000662   100026 000004                    ADSC9   22,,PR1                  cn=0,n=4
         2 000663   000046 000002 1                  ADSC9   CLSSCRATCH$+18           cn=0,n=2
         2 000664   000672 601000 2                  TNZ     s:11683

      339    11681    2                       CALL FSD$JFCLS(PN$);

  11681  2 000665   200003 630500                    EPPR0   @PN$,,AUTO
         2 000666   000017 631400 xsym               EPPR1   B_VECTNIL+15
         2 000667   000000 701000 xent               TSX1    FSD$JFCLS
         2 000670   000000 011000                    NOP     0
         2 000671   001544 710000 2                  TRA     s:11836

      340    11682    3                    ELSE DO; /*JE*/

      341    11683    3                       CALL FMP$CLSF(CLSSAVE$);

PL6.E3A0      #001=FSP$CLSDEV File=FSP$CLSDEV.:E05TSI                            TUE 07/29/97 17:37 Page:49   
  11683  2 000672   000002 630400 3                  EPPR0   2
         2 000673   000017 631400 xsym               EPPR1   B_VECTNIL+15
         2 000674   000000 701000 xent               TSX1    FMP$CLSF
         2 000675   000000 011000                    NOP     0

      342    11684    3                       CALL CHARBIN(J,SUBSTR(F$DCB.NAME.C,0,6));

  11684  2 000676   200055 470500                    LDP0    JDCB$,,AUTO
         2 000677   000100 305500                    DTB
         2 000700   000010 230006                    NDSC9   8,,PR0                   cn=1,s=nosgn,sf=0,n=6
         2 000701   200060 000004                    NDSC9   J,,AUTO                  cn=0,s=lsgnf,sf=0,n=4

      343    11685    3                       JP$CITE.SYSID=J;

  11685  2 000702   200060 720100                    LXL0    J,,AUTO
         2 000703   200062 440100                    SXL0    JP$CITE,,AUTO

      344    11686    3                       JP$CITE.CODE=JPEV_NEWF#;

  11686  2 000704   000001 221003                    LDX1    1,DU
         2 000705   200062 741100                    STX1    JP$CITE,,AUTO

      345    11687    3                       CALL KUW$WRITE (JP$CITE,LENGTHC(JP$CITE),J_PRESCAN);

  11687  2 000706   000010 236000 3                  LDQ     8
         2 000707   200074 756100                    STQ     COMIO+7,,AUTO
         2 000710   000011 236000 3                  LDQ     9
         2 000711   200073 756100                    STQ     COMIO+6,,AUTO
         2 000712   200062 631500                    EPPR1   JP$CITE,,AUTO
         2 000713   200072 451500                    STP1    COMIO+5,,AUTO
         2 000714   200072 630500                    EPPR0   COMIO+5,,AUTO
         2 000715   000021 631400 xsym               EPPR1   B_VECTNIL+17
         2 000716   000000 701000 xent               TSX1    KUW$WRITE
         2 000717   000000 011000                    NOP     0

      346    11688    3                       END;

PL6.E3A0      #001=FSP$CLSDEV File=FSP$CLSDEV.:E05TSI                            TUE 07/29/97 17:37 Page:50   
  11688  2 000720   001544 710000 2                  TRA     s:11836

      347    11689    2                 ELSE
      348    11690    2                    CALL FMP$CLSF(CLSSCRATCH$);

  11690  2 000721   000012 630400 3                  EPPR0   10
         2 000722   000017 631400 xsym               EPPR1   B_VECTNIL+15
         2 000723   000000 701000 xent               TSX1    FMP$CLSF
         2 000724   000000 011000                    NOP     0
         2 000725   001544 710000 2                  TRA     s:11836

      349    11691    3              ELSE DO;

      350    11692        /*            For dd@wsn, save it unless SCRATCH specified.*/
      351    11693    3                 IF (I~=%SCRATCH#) AND (F$DCB.FORM$->CODE16.RECNO~=0 OR

  11693  2 000726   200057 235100                    LDA     I,,AUTO
         2 000727   000001 115007                    CMPA    1,DL
         2 000730   000756 600000 2                  TZE     s:11703
         2 000731   100050 474500                    LDP4    40,,PR1
         2 000732   400004 235100                    LDA     4,,PR4
         2 000733   000736 601000 2                  TNZ     s:11695
         2 000734   400005 221100                    LDX1    5,,PR4
         2 000735   000756 600000 2                  TZE     s:11703

      352    11694    4                   F$DCB.FORM$->CODE16.PAGENO~=0) THEN DO;

      353    11695    4                    CALL FSL$ACCT(F$DCB);

  11695  2 000736   200055 630500                    EPPR0   JDCB$,,AUTO
         2 000737   000017 631400 xsym               EPPR1   B_VECTNIL+15
         2 000740   000000 701000 xent               TSX1    FSL$ACCT
         2 000741   000000 011000                    NOP     0

      354    11696    4                    B$JIT.DCB$ = JDCB$;

  11696  2 000742   200055 236100                    LDQ     JDCB$,,AUTO
PL6.E3A0      #001=FSP$CLSDEV File=FSP$CLSDEV.:E05TSI                            TUE 07/29/97 17:37 Page:51   
         2 000743   000000 470400 xsym               LDP0    B$JIT$
         2 000744   000232 756100                    STQ     154,,PR0

      355    11697    4                    CALL FMP$CLSF(CLSSAVE$);

  11697  2 000745   000002 630400 3                  EPPR0   2
         2 000746   000017 631400 xsym               EPPR1   B_VECTNIL+15
         2 000747   000000 701000 xent               TSX1    FMP$CLSF
         2 000750   000000 011000                    NOP     0

      356    11698    4                    CALL FSX$TELLOUTSYM(F$DCB);

  11698  2 000751   200055 630500                    EPPR0   JDCB$,,AUTO
         2 000752   000017 631400 xsym               EPPR1   B_VECTNIL+15
         2 000753   000000 701000 xent               TSX1    FSX$TELLOUTSYM
         2 000754   000000 011000                    NOP     0

      357    11699    4                    END;

  11699  2 000755   001002 710000 2                  TRA     s:11708

      358    11700    4                 ELSE DO;

      359    11701        /*               No need to FSL$ACCT the delete; DCB never closed, so
      360    11702                         we haven't ever accounted for it to begin with.*/
      361    11703    4                    IF ADDR(F$DCB.NAME)->OSFN.CNUM~='000' THEN

  11703  2 000756   100014 236100                    LDQ     12,,PR1
         2 000757   000047 676000 1                  ERQ     CLSSCRATCH$+19
         2 000760   000013 376000 3                  ANQ     11
         2 000761   000773 600000 2                  TZE     s:11705

      362    11704    4                       CALL FSX$TELLOUTSYM(F$DCB,,1);

  11704  2 000762   000006 236000 3                  LDQ     6
         2 000763   200074 756100                    STQ     COMIO+7,,AUTO
         2 000764   000001 236000 xsym               LDQ     B_VECTNIL+1
PL6.E3A0      #001=FSP$CLSDEV File=FSP$CLSDEV.:E05TSI                            TUE 07/29/97 17:37 Page:52   
         2 000765   200055 235100                    LDA     JDCB$,,AUTO
         2 000766   200072 757100                    STAQ    COMIO+5,,AUTO
         2 000767   200072 630500                    EPPR0   COMIO+5,,AUTO
         2 000770   000021 631400 xsym               EPPR1   B_VECTNIL+17
         2 000771   000000 701000 xent               TSX1    FSX$TELLOUTSYM
         2 000772   000000 011000                    NOP     0

      363    11705    4                    B$JIT.DCB$ = JDCB$;

  11705  2 000773   200055 236100                    LDQ     JDCB$,,AUTO
         2 000774   000000 470400 xsym               LDP0    B$JIT$
         2 000775   000232 756100                    STQ     154,,PR0

      364    11706    4                    CALL FMP$CLSF(CLSSCRATCH$);

  11706  2 000776   000012 630400 3                  EPPR0   10
         2 000777   000017 631400 xsym               EPPR1   B_VECTNIL+15
         2 001000   000000 701000 xent               TSX1    FMP$CLSF
         2 001001   000000 011000                    NOP     0

      365    11707    4                    END;

      366    11708    3                 IF F$DCB.IFMT=FMTTTY# THEN F$DCB.ORG=%TERMINAL#;

  11708  2 001002   200055 470500                    LDP0    JDCB$,,AUTO
         2 001003   000103 236100                    LDQ     67,,PR0
         2 001004   777000 376003                    ANQ     -512,DU
         2 001005   016000 116003                    CMPQ    7168,DU
         2 001006   001544 601000 2                  TNZ     s:11836

  11708  2 001007   010000 236003                    LDQ     4096,DU
         2 001010   000032 552140                    STBQ    26,'40'O,PR0

      367    11709    3                 END;

  11709  2 001011   001544 710000 2                  TRA     s:11836

PL6.E3A0      #001=FSP$CLSDEV File=FSP$CLSDEV.:E05TSI                            TUE 07/29/97 17:37 Page:53   
      368    11710    2            CASE (%FPRGIASN#);

      369    11711    2              IF F$DCB.CFU$ ~= ADDR(NIL) AND F$DCB.CFU$->F$DCB.FCD

  11711  2 001012   100066 236100                    LDQ     54,,PR1
         2 001013   000001 116000 xsym               CMPQ    B_VECTNIL+1
         2 001014   001044 600000 2                  TZE     s:11720
         2 001015   100066 473500                    LDP3    54,,PR1
         2 001016   300031 236100                    LDQ     25,,PR3
         2 001017   020000 316007                    CANQ    8192,DL
         2 001020   001044 600000 2                  TZE     s:11720

      370    11712    3              THEN DO;

      371    11713    3                 B$JIT.DCB$ = F$DCB.CFU$;

  11713  2 001021   100066 236100                    LDQ     54,,PR1
         2 001022   000232 756100                    STQ     154,,PR0

      372    11714    3                 CALL FMP$CLSJ;

  11714  2 001023   000002 631400 xsym               EPPR1   B_VECTNIL+2
         2 001024   000000 701000 xent               TSX1    FMP$CLSJ
         2 001025   000000 011000                    NOP     0

      373    11715    3                 B$JIT.DCBNO = B$JIT.DCB$->F$DCB.DCB#;

  11715  2 001026   000000 470400 xsym               LDP0    B$JIT$
         2 001027   000232 471500                    LDP1    154,,PR0
         2 001030   100060 236100                    LDQ     48,,PR1
         2 001031   000033 772000                    QRL     27
         2 001032   000022 552104                    STBQ    18,'04'O,PR0

      374    11716    3                 CALL FMM$RELDCBI;

  11716  2 001033   000002 631400 xsym               EPPR1   B_VECTNIL+2
         2 001034   000000 701000 xent               TSX1    FMM$RELDCBI
PL6.E3A0      #001=FSP$CLSDEV File=FSP$CLSDEV.:E05TSI                            TUE 07/29/97 17:37 Page:54   
         2 001035   000000 011000                    NOP     0

      375    11717    3                 B$JIT.DCB$ = JDCB$;

  11717  2 001036   200055 236100                    LDQ     JDCB$,,AUTO
         2 001037   000000 470400 xsym               LDP0    B$JIT$
         2 001040   000232 756100                    STQ     154,,PR0

      376    11718    3                 F$DCB.CFU$ = ADDR(NIL);

  11718  2 001041   000001 236000 xsym               LDQ     B_VECTNIL+1
         2 001042   200055 471500                    LDP1    JDCB$,,AUTO
         2 001043   100066 756100                    STQ     54,,PR1

      377    11719    3                 END;

      378    11720    2              LDCT$=NK$LDCT$(F$DCB.LDCTX);

  11720  2 001044   100051 220100                    LDX0    41,,PR1
         2 001045   000000 473400 xsym               LDP3    N$DCT$$
         2 001046   300000 236110                    LDQ     0,X0,PR3
         2 001047   200054 756100                    STQ     LDCT$,,AUTO

  11720  2 001050                       FEP_CLOSE    null
      379    11721        %EJECT;
PL6.E3A0      #001=FSP$CLSDEV File=FSP$CLSDEV.:E05TSI                            TUE 07/29/97 17:37 Page:55   
      380    11722    2   FEP_CLOSE: ; /* Common code for shutting down a Fep connection */
      381    11723    2              CALL SSS$BLOCK; /* KIA$TERM can't lock the LDCT gate */

  11723  2 001050   000002 631400 xsym               EPPR1   B_VECTNIL+2
         2 001051   000000 701000 xent               TSX1    SSS$BLOCK
         2 001052   000000 011000                    NOP     0

      382    11724    3              DO WHILE LDCT$~=ADDR(NIL);

  11724  2 001053   001432 710000 2                  TRA     s:11800

      383    11725                      %LOCK (G=NK$LDCT.LOCK);

  11726  2 001054   200054 236100                    LDQ     LDCT$,,AUTO
         2 001055   000020 036003                    ADLQ    16,DU
         2 001056   200072 756100                    STQ     COMIO+5,,AUTO
         2 001057   200072 630500                    EPPR0   COMIO+5,,AUTO
         2 001060   000017 631400 xsym               EPPR1   B_VECTNIL+15
         2 001061   000000 701000 xent               TSX1    HFC$LOCK
         2 001062   000000 011000                    NOP     0

      384    11728    3                 IF F$DCB.FCN.CNT(0)~=0 THEN CALL KILL_IO;

  11728  2 001063   200055 470500                    LDP0    JDCB$,,AUTO
         2 001064   000074 236100                    LDQ     60,,PR0
         2 001065   377000 316003                    CANQ    130560,DU
         2 001066   001071 600000 2                  TZE     s:11729

  11728  2 001067   001553 701000 2                  TSX1    KILL_IO
         2 001070   000000 011000                    NOP     0

      385    11729    3                 IF NK$LDCT.DFLG.FEDN

  11729  2 001071   200054 470500                    LDP0    LDCT$,,AUTO
         2 001072   000006 236100                    LDQ     6,,PR0
         2 001073   000020 316007                    CANQ    16,DL
         2 001074   001306 601000 2                  TNZ     FEP_RELDCT
PL6.E3A0      #001=FSP$CLSDEV File=FSP$CLSDEV.:E05TSI                            TUE 07/29/97 17:37 Page:56   
         2 001075   400000 316007                    CANQ    -131072,DL
         2 001076   001306 600000 2                  TZE     FEP_RELDCT

      386    11730    3                   OR NOT NK$LDCT.DFLG.INPUT /* Aka RAT.CLFLG.MULT */
      387    11731    3                 THEN GOTO FEP_RELDCT;
      388    11732    3                 IF PN$.V_ = ADDR(NIL)

  11732  2 001077   200003 471500                    LDP1    @PN$,,AUTO
         2 001100   100000 236100                    LDQ     0,,PR1
         2 001101   000001 116000 xsym               CMPQ    B_VECTNIL+1
         2 001102   001105 601000 2                  TNZ     s:11736

      389    11733    3                 THEN
      390    11734    3                    I = 0;

  11734  2 001103   200057 450100                    STZ     I,,AUTO
         2 001104   001111 710000 2                  TRA     s:11737

      391    11735    3                 ELSE
      392    11736    3                    I = PN$.V_->FPT$CLOSE_V.DISP;

  11736  2 001105   100000 473500                    LDP3    0,,PR1
         2 001106   300000 236100                    LDQ     0,,PR3
         2 001107   000777 376007                    ANQ     511,DL
         2 001110   200057 756100                    STQ     I,,AUTO

      393    11737    3                 RWPARM = K_RWPARM_CON;

  11737  2 001111   000100 100400                    MLR     fill='000'O
         2 001112   000000 000234 xsym               ADSC9   K_RWPARM_CON             cn=0,n=156
         2 001113   200004 000234                    ADSC9   RWPARM,,AUTO             cn=0,n=156

      394    11738    3                 NK$LDCT.TH = '0'B;

  11738  2 001114   000100 100400                    MLR     fill='000'O
         2 001115   000002 000001 xsym               ADSC9   B_VECTNIL+2              cn=0,n=1
         2 001116   000016 200007                    ADSC9   14,,PR0                  cn=1,n=7
PL6.E3A0      #001=FSP$CLSDEV File=FSP$CLSDEV.:E05TSI                            TUE 07/29/97 17:37 Page:57   

      395    11739    3                 CALL KIA$FCNOU(NK$LDCT,%KV_VDO_FNC_CLSSSN_RQS,RWPARM);

  11739  2 001117   200004 633500                    EPPR3   RWPARM,,AUTO
         2 001120   200074 453500                    STP3    COMIO+7,,AUTO
         2 001121   000014 236000 3                  LDQ     12
         2 001122   200054 235100                    LDA     LDCT$,,AUTO
         2 001123   200072 757100                    STAQ    COMIO+5,,AUTO
         2 001124   200072 630500                    EPPR0   COMIO+5,,AUTO
         2 001125   000021 631400 xsym               EPPR1   B_VECTNIL+17
         2 001126   000000 701000 xent               TSX1    KIA$FCNOU
         2 001127   000000 011000                    NOP     0

      396    11740                /* If the DISP = save we wait for a job step to happen in the FPRG */
      397    11741    3                 IF I = %SAVE# AND NOT NK$LDCT.LKFLG.FPSTEP

  11741  2 001130   200057 235100                    LDA     I,,AUTO
         2 001131   000002 115007                    CMPA    2,DL
         2 001132   001215 601000 2                  TNZ     s:11761
         2 001133   200054 470500                    LDP0    LDCT$,,AUTO
         2 001134   000011 236100                    LDQ     9,,PR0
         2 001135   000010 316003                    CANQ    8,DU
         2 001136   001215 601000 2                  TNZ     s:11761
         2 001137   200055 471500                    LDP1    JDCB$,,AUTO
         2 001140   100103 236100                    LDQ     67,,PR1
         2 001141   000777 376007                    ANQ     511,DL
         2 001142   000010 116007                    CMPQ    8,DL
         2 001143   001215 601000 2                  TNZ     s:11761

      398    11742    3                   AND F$DCB.IASN=%FPRGIASN#
      399    11743    4                 THEN DO;

      400    11744    4                    NK$LDCT.LKFLG.WAITINGEXIT = '1'B;

  11744  2 001144   010000 236003                    LDQ     4096,DU
         2 001145   000011 256100                    ORSQ    9,,PR0

PL6.E3A0      #001=FSP$CLSDEV File=FSP$CLSDEV.:E05TSI                            TUE 07/29/97 17:37 Page:58   
      401    11745    4                    CALL SSR$REG(%SS_CRD,NK$LDCT$(F$DCB.LDCTX))

  11745  2 001146   100051 220100                    LDX0    41,,PR1
         2 001147   000000 636010                    EAQ     0,X0
         2 001150   000000 036000 xsym               ADLQ    N$DCT$$
         2 001151   000015 235000 3                  LDA     13
         2 001152   200072 757100                    STAQ    COMIO+5,,AUTO
         2 001153   200072 630500                    EPPR0   COMIO+5,,AUTO
         2 001154   000020 631400 xsym               EPPR1   B_VECTNIL+16
         2 001155   000000 701000 xent               TSX1    SSR$REG
         2 001156   001160 702000 2                  TSX2    s:11747
         2 001157   001206 710000 2                  TRA     s:11758

      402    11746    5                    WHENALTRETURN DO;

      403    11747    5                       B$JIT.JUNK = B$JIT.JUNK | %JJ_BAKIC#;

  11747  2 001160   000000 470400 xsym               LDP0    B$JIT$
         2 001161   000315 220100                    LDX0    205,,PR0
         2 001162   001000 260003                    ORX0    512,DU
         2 001163   000315 740100                    STX0    205,,PR0

      404    11748                            %LOCK (G=NK$LDCT.LOCK);

  11749  2 001164   200054 236100                    LDQ     LDCT$,,AUTO
         2 001165   000020 036003                    ADLQ    16,DU
         2 001166   200072 756100                    STQ     COMIO+5,,AUTO
         2 001167   200072 630500                    EPPR0   COMIO+5,,AUTO
         2 001170   000017 631400 xsym               EPPR1   B_VECTNIL+15
         2 001171   000000 701000 xent               TSX1    HFC$LOCK
         2 001172   000000 011000                    NOP     0

      405    11751    5                       NK$LDCT.LKFLG.WAITINGEXIT = '0'B;

  11751  2 001173   200054 470500                    LDP0    LDCT$,,AUTO
         2 001174   000016 236000 3                  LDQ     14
         2 001175   000011 356100                    ANSQ    9,,PR0
PL6.E3A0      #001=FSP$CLSDEV File=FSP$CLSDEV.:E05TSI                            TUE 07/29/97 17:37 Page:59   

      406    11752                            %UNLOCK (G=NK$LDCT.LOCK);

  11753  2 001176   200054 236100                    LDQ     LDCT$,,AUTO
         2 001177   000020 036003                    ADLQ    16,DU
         2 001200   200072 756100                    STQ     COMIO+5,,AUTO
         2 001201   200072 630500                    EPPR0   COMIO+5,,AUTO
         2 001202   000017 631400 xsym               EPPR1   B_VECTNIL+15
         2 001203   000000 701000 xent               TSX1    HFC$UNLOCK
         2 001204   000000 011000                    NOP     0

      407    11755    5                       ALTRETURN;

  11755  2 001205   000000 702200 xent               TSX2  ! X66_AALT

      408    11756    5                       END;
      409    11757                         %LOCK (G=NK$LDCT.LOCK);

  11758  2 001206   200054 236100                    LDQ     LDCT$,,AUTO
         2 001207   000020 036003                    ADLQ    16,DU
         2 001210   200072 756100                    STQ     COMIO+5,,AUTO
         2 001211   200072 630500                    EPPR0   COMIO+5,,AUTO
         2 001212   000017 631400 xsym               EPPR1   B_VECTNIL+15
         2 001213   000000 701000 xent               TSX1    HFC$LOCK
         2 001214   000000 011000                    NOP     0

      410    11760    4                    END;

      411    11761    4                 IF F$DCB.RESNT.NUM='CL' THEN DO;

  11761  2 001215   200055 470500                    LDP0    JDCB$,,AUTO
         2 001216   000026 720100                    LXL0    22,,PR0
         2 001217   000050 100000 1                  CMPX0   CLSSCRATCH$+20
         2 001220   001266 601000 2                  TNZ     s:11774

      412    11762    4                    CALL FRF$EVRPT; /* event the AU, if required */

PL6.E3A0      #001=FSP$CLSDEV File=FSP$CLSDEV.:E05TSI                            TUE 07/29/97 17:37 Page:60   
  11762  2 001221   000002 631400 xsym               EPPR1   B_VECTNIL+2
         2 001222   000000 701000 xent               TSX1    FRF$EVRPT
         2 001223   000000 011000                    NOP     0

      413    11763    4                    IF I = %CLRES# THEN CALL OCZ$SID_UN

  11763  2 001224   200057 235100                    LDA     I,,AUTO
         2 001225   000003 115007                    CMPA    3,DL
         2 001226   001266 601000 2                  TNZ     s:11774

  11763  2 001227   200003 470500                    LDP0    @PN$,,AUTO
         2 001230   000000 471500                    LDP1    0,,PR0
         2 001231   200054 236100                    LDQ     LDCT$,,AUTO
         2 001232   000017 036000 3                  ADLQ    15
         2 001233   200073 756100                    STQ     COMIO+6,,AUTO
         2 001234   100001 633500                    EPPR3   1,,PR1
         2 001235   200072 453500                    STP3    COMIO+5,,AUTO
         2 001236   200072 630500                    EPPR0   COMIO+5,,AUTO
         2 001237   000020 631400 xsym               EPPR1   B_VECTNIL+16
         2 001240   000000 701000 xent               TSX1    OCZ$SID_UN
         2 001241   001266 702000 2                  TSX2    s:11774

      414    11764    4                         (PN$.V_->FPT$CLOSE_V.CLSYSID,NK$LDCT.USER)
      415    11765    5                       WHENRETURN DO;

      416    11766    5                          NK$LDCT.MSGID = PN$.V_->FPT$CLOSE_V.CLINFO;

  11766  2 001242   200003 470500                    LDP0    @PN$,,AUTO
         2 001243   000000 471500                    LDP1    0,,PR0
         2 001244   100002 236100                    LDQ     2,,PR1
         2 001245   777777 376007                    ANQ     -1,DL
         2 001246   200054 473500                    LDP3    LDCT$,,AUTO
         2 001247   300000 756100                    STQ     0,,PR3

      417    11767    5                          NK$LDCT.DCBNO = PN$.V_->FPT$CLOSE_V.CLDCB;

  11767  2 001250   000000 471500                    LDP1    0,,PR0
PL6.E3A0      #001=FSP$CLSDEV File=FSP$CLSDEV.:E05TSI                            TUE 07/29/97 17:37 Page:61   
         2 001251   100001 236100                    LDQ     1,,PR1
         2 001252   300014 552104                    STBQ    12,'04'O,PR3

      418    11768    5                          CALL FRF$EVRPT (NK$LDCT);

  11768  2 001253   200054 630500                    EPPR0   LDCT$,,AUTO
         2 001254   000017 631400 xsym               EPPR1   B_VECTNIL+15
         2 001255   000000 701000 xent               TSX1    FRF$EVRPT
         2 001256   000000 011000                    NOP     0

      419    11769    5                          CALL FRB$CLS;

  11769  2 001257   000002 631400 xsym               EPPR1   B_VECTNIL+2
         2 001260   000000 701000 xent               TSX1    FRB$CLS
         2 001261   000000 011000                    NOP     0

      420    11770    5                          F$DCB.FCD = '0'B;

  11770  2 001262   200055 470500                    LDP0    JDCB$,,AUTO
         2 001263   000000 236000 3                  LDQ     0
         2 001264   000031 356100                    ANSQ    25,,PR0

      421    11771    5                          RETURN;

  11771  2 001265   000000 702200 xent               TSX2  ! X66_ARET

      422    11772    5                          END;
      423    11773    4                    END;

      424    11774    3                 RWPARM = K_RWPARM_CON;

  11774  2 001266   000100 100400                    MLR     fill='000'O
         2 001267   000000 000234 xsym               ADSC9   K_RWPARM_CON             cn=0,n=156
         2 001270   200004 000234                    ADSC9   RWPARM,,AUTO             cn=0,n=156

      425    11775    3                 CALL KIA$DSCU(NK$LDCT,%KV_VDO_FNC_DSC_RQS,RWPARM)

PL6.E3A0      #001=FSP$CLSDEV File=FSP$CLSDEV.:E05TSI                            TUE 07/29/97 17:37 Page:62   
  11775  2 001271   200004 630500                    EPPR0   RWPARM,,AUTO
         2 001272   200074 450500                    STP0    COMIO+7,,AUTO
         2 001273   000020 236000 3                  LDQ     16
         2 001274   200054 235100                    LDA     LDCT$,,AUTO
         2 001275   200072 757100                    STAQ    COMIO+5,,AUTO
         2 001276   200072 630500                    EPPR0   COMIO+5,,AUTO
         2 001277   000021 631400 xsym               EPPR1   B_VECTNIL+17
         2 001300   000000 701000 xent               TSX1    KIA$DSCU
         2 001301   001303 702000 2                  TSX2    s:11777
         2 001302   001306 710000 2                  TRA     FEP_RELDCT

      426    11776    4                 WHENALTRETURN DO;

      427    11777    4                    NK$LDCT.DFLG.PRLS='1'B;

  11777  2 001303   200054 470500                    LDP0    LDCT$,,AUTO
         2 001304   000200 236007                    LDQ     128,DL
         2 001305   000006 256100                    ORSQ    6,,PR0

      428    11778    4                    END;

  11774  2 001306                       FEP_RELDCT   null
      429    11779    3   FEP_RELDCT:   ;
      430    11780                      %UNLOCK (G=NK$LDCT.LOCK);

  11781  2 001306   200054 236100                    LDQ     LDCT$,,AUTO
         2 001307   000020 036003                    ADLQ    16,DU
         2 001310   200072 756100                    STQ     COMIO+5,,AUTO
         2 001311   200072 630500                    EPPR0   COMIO+5,,AUTO
         2 001312   000017 631400 xsym               EPPR1   B_VECTNIL+15
         2 001313   000000 701000 xent               TSX1    HFC$UNLOCK
         2 001314   000000 011000                    NOP     0

      431    11783    3                 IF (S$CU$->B$U.FLG & %U_DELA) AND F$DCB.IASN=%FPRGIASN#

  11783  2 001315   000000 470400 xsym               LDP0    S$CU$
         2 001316   000000 236100                    LDQ     0,,PR0
PL6.E3A0      #001=FSP$CLSDEV File=FSP$CLSDEV.:E05TSI                            TUE 07/29/97 17:37 Page:63   
         2 001317   000051 376000 1                  ANQ     CLSSCRATCH$+21
         2 001320   001364 600000 2                  TZE     s:11792
         2 001321   200055 471500                    LDP1    JDCB$,,AUTO
         2 001322   100103 236100                    LDQ     67,,PR1
         2 001323   000777 376007                    ANQ     511,DL
         2 001324   000010 116007                    CMPQ    8,DL
         2 001325   001364 601000 2                  TNZ     s:11792

      432    11784    4                 THEN DO;

      433    11785    4                    COMIO = '0'B;

  11785  2 001326   000100 100400                    MLR     fill='000'O
         2 001327   000002 000001 xsym               ADSC9   B_VECTNIL+2              cn=0,n=1
         2 001330   200065 000014                    ADSC9   COMIO,,AUTO              cn=0,n=12

      434    11786    4                    COMIO.P# = SIZEW(COMIO) - SIZEW(COMIO.P#);

  11786  2 001331   000002 235007                    LDA     2,DL
         2 001332   200065 755100                    STA     COMIO,,AUTO

      435    11787    4                    COMIO.FLAGS.DELTA = '1'B;

  11787  2 001333   400000 236007                    LDQ     -131072,DL
         2 001334   200066 256100                    ORSQ    COMIO+1,,AUTO

      436    11788    4                    COMIO.SUBC2 = %SUBC2_CLS_DCB#;

  11788  2 001335   000003 236007                    LDQ     3,DL
         2 001336   200066 552104                    STBQ    COMIO+1,'04'O,AUTO

      437    11789    4                    DUSR = S_CUN;

  11789  2 001337   000000 235000 xsym               LDA     S_CUN
         2 001340   000033 735000                    ALS     27
         2 001341   200061 755100                    STA     DUSR,,AUTO

PL6.E3A0      #001=FSP$CLSDEV File=FSP$CLSDEV.:E05TSI                            TUE 07/29/97 17:37 Page:64   
      438    11790    4                   CALL SSV$EVENT(DUSR,%DBWSR,%SUBC_COMIO#,F$DCB.EVENT,0,ADDR(COMIO));

  11790  2 001342   200065 633500                    EPPR3   COMIO,,AUTO
         2 001343   200072 453500                    STP3    COMIO+5,,AUTO
         2 001344   200072 634500                    EPPR4   COMIO+5,,AUTO
         2 001345   200101 454500                    STP4    COMIO+12,,AUTO
         2 001346   000003 236000 3                  LDQ     3
         2 001347   200100 756100                    STQ     COMIO+11,,AUTO
         2 001350   200055 236100                    LDQ     JDCB$,,AUTO
         2 001351   000055 036003                    ADLQ    45,DU
         2 001352   000021 235000 3                  LDA     17
         2 001353   200076 757100                    STAQ    COMIO+9,,AUTO
         2 001354   000022 236000 3                  LDQ     18
         2 001355   200075 756100                    STQ     COMIO+8,,AUTO
         2 001356   200061 635500                    EPPR5   DUSR,,AUTO
         2 001357   200074 455500                    STP5    COMIO+7,,AUTO
         2 001360   200074 630500                    EPPR0   COMIO+7,,AUTO
         2 001361   000024 631400 xsym               EPPR1   B_VECTNIL+20
         2 001362   000000 701000 xent               TSX1    SSV$EVENT
         2 001363   000000 011000                    NOP     0

      439    11791    4                    END;

      440    11792    3                 IF F$DCB.IASN=%DEVICE# THEN CALL FRB$CLS;

  11792  2 001364   200055 470500                    LDP0    JDCB$,,AUTO
         2 001365   000103 236100                    LDQ     67,,PR0
         2 001366   000777 376007                    ANQ     511,DL
         2 001367   000003 116007                    CMPQ    3,DL
         2 001370   001374 601000 2                  TNZ     s:11793

  11792  2 001371   000002 631400 xsym               EPPR1   B_VECTNIL+2
         2 001372   000000 701000 xent               TSX1    FRB$CLS
         2 001373   000000 011000                    NOP     0

      441    11793    3                 IF NK$LDCT.USER=B$JIT.USER

PL6.E3A0      #001=FSP$CLSDEV File=FSP$CLSDEV.:E05TSI                            TUE 07/29/97 17:37 Page:65   
  11793  2 001374   000000 470400 xsym               LDP0    B$JIT$
         2 001375   200054 471500                    LDP1    LDCT$,,AUTO
         2 001376   100007 236100                    LDQ     7,,PR1
         2 001377   000000 676100                    ERQ     0,,PR0
         2 001400   000777 376003                    ANQ     511,DU
         2 001401   001413 601000 2                  TNZ     s:11795

      442    11794    3                 THEN CALL NKL$RELDCTL(NK$LDCT$(F$DCB.LDCTX));

  11794  2 001402   200055 473500                    LDP3    JDCB$,,AUTO
         2 001403   300051 220100                    LDX0    41,,PR3
         2 001404   000000 636010                    EAQ     0,X0
         2 001405   000000 036000 xsym               ADLQ    N$DCT$$
         2 001406   200072 756100                    STQ     COMIO+5,,AUTO
         2 001407   200072 630500                    EPPR0   COMIO+5,,AUTO
         2 001410   000017 631400 xsym               EPPR1   B_VECTNIL+15
         2 001411   000000 701000 xent               TSX1    NKL$RELDCTL
         2 001412   000000 011000                    NOP     0

      443    11795    3                 IF F$DCB.SETX~=0 AND F$DCB.SETX~=F$DCB.LDCTX

  11795  2 001413   200055 470500                    LDP0    JDCB$,,AUTO
         2 001414   000051 720100                    LXL0    41,,PR0
         2 001415   001423 600000 2                  TZE     s:11797
         2 001416   000051 100100                    CMPX0   41,,PR0
         2 001417   001423 600000 2                  TZE     s:11797

      444    11796    3                 THEN F$DCB.IASN=%DEVICE#;

  11796  2 001420   000003 236007                    LDQ     3,DL
         2 001421   000103 552104                    STBQ    67,'04'O,PR0
         2 001422   001425 710000 2                  TRA     s:11798

      445    11797    3                 ELSE F$DCB.SETX=0;

  11797  2 001423   000000 221003                    LDX1    0,DU
         2 001424   000051 441100                    SXL1    41,,PR0
PL6.E3A0      #001=FSP$CLSDEV File=FSP$CLSDEV.:E05TSI                            TUE 07/29/97 17:37 Page:66   

      446    11798    3                 F$DCB.LDCTX=F$DCB.SETX;

  11798  2 001425   000051 720100                    LXL0    41,,PR0
         2 001426   000051 740100                    STX0    41,,PR0

      447    11799    3                 LDCT$=NK$LDCT$(F$DCB.LDCTX);

  11799  2 001427   000000 471400 xsym               LDP1    N$DCT$$
         2 001430   100000 236110                    LDQ     0,X0,PR1
         2 001431   200054 756100                    STQ     LDCT$,,AUTO

      448    11800    3                 END;

  11800  2 001432   200054 236100                    LDQ     LDCT$,,AUTO
         2 001433   000001 116000 xsym               CMPQ    B_VECTNIL+1
         2 001434   001054 601000 2                  TNZ     s:11726

      449    11801    2              IF B$ROSEG.STREAM_VALID(F$DCB.FPSTR) /* Zero is never valid */

  11801  2 001435   200055 470500                    LDP0    JDCB$,,AUTO
         2 001436   000077 236100                    LDQ     63,,PR0
         2 001437   000011 772000                    QRL     9
         2 001440   000777 376007                    ANQ     511,DL
         2 001441   000000 471400 xsym               LDP1    B$ROSEG$
         2 001442   000000 066506                    CMPB    filb='0'B
         2 001443   100117 000001                    BDSC    79,Q,PR1                 by=0,bit=0,n=1
         2 001444   000002 000022 xsym               BDSC    B_VECTNIL+2              by=0,bit=0,n=18
         2 001445   001454 600000 2                  TZE     s:11807

      450    11802    3              THEN DO;

      451    11803    3                 F$DCB.STR = F$DCB.FPSTR;

  11803  2 001446   000077 236100                    LDQ     63,,PR0
         2 001447   000011 772000                    QRL     9
         2 001450   000077 552104                    STBQ    63,'04'O,PR0
PL6.E3A0      #001=FSP$CLSDEV File=FSP$CLSDEV.:E05TSI                            TUE 07/29/97 17:37 Page:67   

      452    11804    3                 F$DCB.FCD = '0'B;

  11804  2 001451   000000 236000 3                  LDQ     0
         2 001452   000031 356100                    ANSQ    25,,PR0

      453    11805    3                 GOTO FIND_UC_STR; /* delete the stream if it's a temp */

  11805  2 001453   000232 710000 2                  TRA     FIND_UC_STR

      454    11806    3                 END;
      455    11807    2              IF F$DCB.IASN~=%DEVICE# OR F$DCB.RESNT.NUM~='CL'

  11807  2 001454   000103 236100                    LDQ     67,,PR0
         2 001455   000777 376007                    ANQ     511,DL
         2 001456   000003 116007                    CMPQ    3,DL
         2 001457   001544 601000 2                  TNZ     s:11836
         2 001460   000026 720100                    LXL0    22,,PR0
         2 001461   000050 100000 1                  CMPX0   CLSSCRATCH$+20
         2 001462   001544 601000 2                  TNZ     s:11836
         2 001463   200057 235100                    LDA     I,,AUTO
         2 001464   000001 115007                    CMPA    1,DL
         2 001465   001544 601000 2                  TNZ     s:11836

      456    11808    2                OR I~=%RELEASE# THEN EXIT;
      457    11809        /* If we get here, try to event the DCB whose open just got refused by the AU */
      458    11810    2              LDCT$ = ADDR(RWPARM); /* Just some big enough space. */

  11810  2 001466   200004 633500                    EPPR3   RWPARM,,AUTO
         2 001467   200054 453500                    STP3    LDCT$,,AUTO

      459    11811    2              CALL OCZ$SID_UN (PN$.V_->FPT$CLOSE_V.CLSYSID, NK$LDCT.USER)

  11811  2 001470   200003 474500                    LDP4    @PN$,,AUTO
         2 001471   400000 475500                    LDP5    0,,PR4
         2 001472   200054 236100                    LDQ     LDCT$,,AUTO
         2 001473   000017 036000 3                  ADLQ    15
PL6.E3A0      #001=FSP$CLSDEV File=FSP$CLSDEV.:E05TSI                            TUE 07/29/97 17:37 Page:68   
         2 001474   200073 756100                    STQ     COMIO+6,,AUTO
         2 001475   500001 636500                    EPPR6   1,,PR5
         2 001476   200072 456500                    STP6    COMIO+5,,AUTO
         2 001477   200072 630500                    EPPR0   COMIO+5,,AUTO
         2 001500   000020 631400 xsym               EPPR1   B_VECTNIL+16
         2 001501   000000 701000 xent               TSX1    OCZ$SID_UN
         2 001502   001522 702000 2                  TSX2    s:11817

      460    11812    3              WHENRETURN DO;

      461    11813    3                 NK$LDCT.MSGID = PN$.V_->FPT$CLOSE_V.CLINFO;

  11813  2 001503   200003 470500                    LDP0    @PN$,,AUTO
         2 001504   000000 471500                    LDP1    0,,PR0
         2 001505   100002 236100                    LDQ     2,,PR1
         2 001506   777777 376007                    ANQ     -1,DL
         2 001507   200054 473500                    LDP3    LDCT$,,AUTO
         2 001510   300000 756100                    STQ     0,,PR3

      462    11814    3                 NK$LDCT.DCBNO = PN$.V_->FPT$CLOSE_V.CLDCB;

  11814  2 001511   000000 471500                    LDP1    0,,PR0
         2 001512   100001 236100                    LDQ     1,,PR1
         2 001513   300014 552104                    STBQ    12,'04'O,PR3

      463    11815    3                 NK$LDCT.LDCTX = 0;

  11815  2 001514   000000 220003                    LDX0    0,DU
         2 001515   300006 740100                    STX0    6,,PR3

      464    11816    3                 CALL FRF$EVRPT (NK$LDCT);

  11816  2 001516   200054 630500                    EPPR0   LDCT$,,AUTO
         2 001517   000017 631400 xsym               EPPR1   B_VECTNIL+15
         2 001520   000000 701000 xent               TSX1    FRF$EVRPT
         2 001521   000000 011000                    NOP     0

PL6.E3A0      #001=FSP$CLSDEV File=FSP$CLSDEV.:E05TSI                            TUE 07/29/97 17:37 Page:69   
      465    11817    3                 END;

  11817  2 001522   001544 710000 2                  TRA     s:11836

      466    11818    2            CASE(%TAPE#);

      467    11819        /*D*       When user DCB.IASN=TAPE, the DCB is attached to unlabeled
      468    11820                tape.  Common tape logic (FTC$CLOSE) closes the tape.
      469    11821         */
      470    11822    2              CALL FTC$CLOSE(PN$);

  11822  2 001523   200003 630500                    EPPR0   @PN$,,AUTO
         2 001524   000017 631400 xsym               EPPR1   B_VECTNIL+15
         2 001525   000000 701000 xent               TSX1    FTC$CLOSE
         2 001526   000000 011000                    NOP     0
         2 001527   001544 710000 2                  TRA     s:11836

      471    11823    2            CASE(%OD#);

      472    11824    2              CALL FPC$CLSOD(PN$); /* Close optical disc device */

  11824  2 001530   200003 630500                    EPPR0   @PN$,,AUTO
         2 001531   000017 631400 xsym               EPPR1   B_VECTNIL+15
         2 001532   000000 701000 xent               TSX1    FPC$CLSOD
         2 001533   000000 011000                    NOP     0
         2 001534   001544 710000 2                  TRA     s:11836

      473    11825    2            CASE(%FMDIAG#);

      474    11826        /*D*       When user DCB.IASN=FMDIAG, the DCB is attached to device
      475    11827                pack.  FMN$CLSDP closes the DCB.
      476    11828         */
      477    11829    2              CALL FMN$CLSDP(PN$);

  11829  2 001535   200003 630500                    EPPR0   @PN$,,AUTO
         2 001536   000017 631400 xsym               EPPR1   B_VECTNIL+15
         2 001537   000000 701000 xent               TSX1    FMN$CLSDP
PL6.E3A0      #001=FSP$CLSDEV File=FSP$CLSDEV.:E05TSI                            TUE 07/29/97 17:37 Page:70   
         2 001540   000000 011000                    NOP     0
         2 001541   001544 710000 2                  TRA     s:11836

      478    11830    2            CASE(0);

      479    11831        /*D*       When user DCB.IASN=0, the DCB is device NO.  If it is M$UC,
      480    11832                it cannot be closed; otherwise, just mark it closed.
      481    11833         */
      482    11834    2              IF JDCB$=B$M$UC$ THEN GOTO UCNOCLS;

  11834  2 001542   000000 116000 xsym               CMPQ    B$M$UC$
         2 001543   001550 600000 2                  TZE     UCNOCLS

      483    11835    2            END;

      484    11836    1           F$DCB.FCD='0'B;

  11836  2 001544   200055 470500                    LDP0    JDCB$,,AUTO
         2 001545   000000 236000 3                  LDQ     0
         2 001546   000031 356100                    ANSQ    25,,PR0

      485    11837    1           RETURN;

  11837  2 001547   000000 702200 xent               TSX2  ! X66_ARET

      486    11838    1   UCNOCLS: B$JIT.ERR=ERR_NOCLSMUC;

  11838  2 001550   000000 236000 1     UCNOCLS      LDQ     ERR_NOCLSMUC
         2 001551   000012 756100                    STQ     10,,PR0

      487    11839        /*E*    ERROR: FSP-E$NOCLSMUC-0
      488    11840                MESSAGE: M$UC may not be closed.
      489    11841         */
      490    11842    1           ALTRETURN;

  11842  2 001552   000000 702200 xent               TSX2  ! X66_AALT

PL6.E3A0      #001=FSP$CLSDEV File=FSP$CLSDEV.:E05TSI                            TUE 07/29/97 17:37 Page:71   
      491    11843        %EJECT;
PL6.E3A0      #001=FSP$CLSDEV File=FSP$CLSDEV.:E05TSI                            TUE 07/29/97 17:37 Page:72   
      492    11844        /*I* NAME: KILL_IO
      493    11845             DESCRIPTION: Terminates any Fep io (nowait, of course) for the DCB.
      494    11846        */
      495    11847    1   KILL_IO: PROC;

  11847  2 001553   200070 741300       KILL_IO      STX1  ! COMIO+3,,AUTO

      496    11848
      497    11849    2           RWPARM = K_RWPARM_CON;

  11849  2 001554   000100 100400                    MLR     fill='000'O
         2 001555   000000 000234 xsym               ADSC9   K_RWPARM_CON             cn=0,n=156
         2 001556   200004 000234                    ADSC9   RWPARM,,AUTO             cn=0,n=156

      498    11850    2           RWPARM.MRKTYP = %KV_VDOMRKTYP_ENDACK;

  11850  2 001557   001000 236007                    LDQ     512,DL
         2 001560   200044 552110                    STBQ    RWPARM+32,'10'O,AUTO

      499    11851    2           RWPARM.STR = NK$LDCT.NOWAIT.STREAM;

  11851  2 001561   200054 470500                    LDP0    LDCT$,,AUTO
         2 001562   000010 236100                    LDQ     8,,PR0
         2 001563   000022 772000                    QRL     18
         2 001564   200044 552104                    STBQ    RWPARM+32,'04'O,AUTO

      500    11852    2           CALL KIA$FCNOU(NK$LDCT,%KV_VDO_FNC_RQSDAT,RWPARM)

  11852  2 001565   200004 631500                    EPPR1   RWPARM,,AUTO
         2 001566   200074 451500                    STP1    COMIO+7,,AUTO
         2 001567   000024 236000 3                  LDQ     20
         2 001570   200054 235100                    LDA     LDCT$,,AUTO
         2 001571   200072 757100                    STAQ    COMIO+5,,AUTO
         2 001572   200072 630500                    EPPR0   COMIO+5,,AUTO
         2 001573   000021 631400 xsym               EPPR1   B_VECTNIL+17
         2 001574   000000 701000 xent               TSX1    KIA$FCNOU
         2 001575   001621 702000 2                  TSX2    s:11860
PL6.E3A0      #001=FSP$CLSDEV File=FSP$CLSDEV.:E05TSI                            TUE 07/29/97 17:37 Page:73   

      501    11853    3           WHENRETURN DO;

      502    11854    3              NK$LDCT.LKFLG.WTMRK = '1'B;

  11854  2 001576   200054 470500                    LDP0    LDCT$,,AUTO
         2 001577   020000 236003                    LDQ     8192,DU
         2 001600   000011 256100                    ORSQ    9,,PR0

      503    11855    3              CALL SSR$REG(%SS_CW,NK$LDCT$(NK$LDCT.LDCTX));

  11855  2 001601   000006 220100                    LDX0    6,,PR0
         2 001602   000000 636010                    EAQ     0,X0
         2 001603   000000 036000 xsym               ADLQ    N$DCT$$
         2 001604   000026 235000 3                  LDA     22
         2 001605   200072 757100                    STAQ    COMIO+5,,AUTO
         2 001606   200072 630500                    EPPR0   COMIO+5,,AUTO
         2 001607   000020 631400 xsym               EPPR1   B_VECTNIL+16
         2 001610   000000 701000 xent               TSX1    SSR$REG
         2 001611   000000 011000                    NOP     0

      504    11856                   %LOCK (G=NK$LDCT.LOCK);

  11857  2 001612   200054 236100                    LDQ     LDCT$,,AUTO
         2 001613   000020 036003                    ADLQ    16,DU
         2 001614   200072 756100                    STQ     COMIO+5,,AUTO
         2 001615   200072 630500                    EPPR0   COMIO+5,,AUTO
         2 001616   000017 631400 xsym               EPPR1   B_VECTNIL+15
         2 001617   000000 701000 xent               TSX1    HFC$LOCK
         2 001620   000000 011000                    NOP     0

      505    11859    3              END;

      506    11860    2           I = F$DCB.FCN.CNT(0);

  11860  2 001621   200055 470500                    LDP0    JDCB$,,AUTO
         2 001622   000074 236100                    LDQ     60,,PR0
PL6.E3A0      #001=FSP$CLSDEV File=FSP$CLSDEV.:E05TSI                            TUE 07/29/97 17:37 Page:74   
         2 001623   000033 772000                    QRL     27
         2 001624   000377 376007                    ANQ     255,DL
         2 001625   200057 756100                    STQ     I,,AUTO

      507    11861    3           IF I~=0 THEN DO; /* Still a read out standing */

  11861  2 001626   001646 600000 2                  TZE     s:11867

      508    11862    3              NK$LDCT.LKFLG.NOWAIT = '0'B;

  11862  2 001627   200054 471500                    LDP1    LDCT$,,AUTO
         2 001630   000027 236000 3                  LDQ     23
         2 001631   100011 356100                    ANSQ    9,,PR1

      509    11863    3              S$CU$->B$U.MF = S$CU$->B$U.MF - I;

  11863  2 001632   000000 473400 xsym               LDP3    S$CU$
         2 001633   300006 236100                    LDQ     6,,PR3
         2 001634   000033 772000                    QRL     27
         2 001635   200057 136100                    SBLQ    I,,AUTO
         2 001636   000033 736000                    QLS     27
         2 001637   300006 552140                    STBQ    6,'40'O,PR3

      510    11864    3              S$CU$->B$U.CMF = S$CU$->B$U.CMF - I;

  11864  2 001640   300007 236100                    LDQ     7,,PR3
         2 001641   000077 376007                    ANQ     63,DL
         2 001642   200057 136100                    SBLQ    I,,AUTO
         2 001643   300007 752101                    STCQ    7,'01'O,PR3

      511    11865    3              F$DCB.FCN.CNT(0) = 0;

  11865  2 001644   000030 236000 3                  LDQ     24
         2 001645   000074 356100                    ANSQ    60,,PR0

      512    11866    3              END;

PL6.E3A0      #001=FSP$CLSDEV File=FSP$CLSDEV.:E05TSI                            TUE 07/29/97 17:37 Page:75   
      513    11867    2   END KILL_IO;

  11867  2 001646   200070 221300                    LDX1  ! COMIO+3,,AUTO
         2 001647   000001 702211                    TSX2  ! 1,X1

ERR_NOCLSMUC
 Sect OctLoc
   1     000   062320 002270                                                    2...

(unnamed)
 Sect OctLoc
   1     001   062320 000062                                                    2..2

CLSSAVE$
 Sect OctLoc
   1     002   000020 006000   000000 006014   000000 006014   000000 006014    ................
   1     006   000000 006014   000000 006014   000000 006014   000000 006014    ................
   1     016*  000000 006014   ****** ******   000000 000002   000000 000040    ...............
   1     022   000220 000000   000000 000000                                    ........

CLSSCRATCH$
 Sect OctLoc
   1     024   000042 006000   000000 006014   000000 006014   000000 006014    ."..............
   1     030   000000 006014   000000 006014   000000 006014   000000 006014    ................
   1     040*  000000 006014   ****** ******   000000 000001   000000 000040    ...............
   1     044   000220 000000   000000 000000                                    ........

(unnamed)
 Sect OctLoc
   1     046   112106 040040   060060 060040   103114 040040   040000 000000    JF  000 CL   ...

(unnamed)
 Sect OctLoc
   3     000   777777 757777   777777 777740   000002 006000   000002 006000    ................
   3     004   177777 777777   000030 006000   000003 006000   000000 000014    ................
   3     010   000000 006000   000007 006000   000024 006000   777777 777000    ................
   3     014   000005 006000   000006 006000   767777 777777   000007 200000    ................
PL6.E3A0      #001=FSP$CLSDEV File=FSP$CLSDEV.:E05TSI                            TUE 07/29/97 17:37 Page:76   
   3     020   000014 006000   000010 006000   000007 006000   000000 000026    ................
   3     024   000023 006000   000000 000047   000025 006000   777776 777777    .......'........
   3     030   400777 777777                                                    ....
      514    11868    1   END;

PL6.E3A0      #001=FSP$CLSDEV File=FSP$CLSDEV.:E05TSI                            TUE 07/29/97 17:37 Page:77   
--  Include file information  --

   SS_SCHED_C.:E05TOU  is referenced.
   NK_LDCT_R.:E05TOU  cannot be made into a system file and is referenced.
   NK$LDCT.:E05TOU  is referenced.
   NK_SUBS.:E05TOU  is referenced.
   KV$VDO.:E05TOU  is referenced.
   B_STRINGS_C.:E05TOU  is referenced.
   FS$FIT.:E05TOU  is referenced.
   JG_EVID_C.:E05TOU  is referenced.
   JP_MACRO_C.:E05TOU  is referenced.
   F$DCB.:E05TOU  is referenced.
   F$CP6V_C.:E05TOU  is referenced.
   B$ROSEG.:E05TOU  is referenced.
   F_ERRORS_C.:E05TOU  is referenced.
   F_FMTCODE_C.:E05TOU  is referenced.
   FM$MACROS.:E05TOU  is referenced.
   B$USER.:E05TOU  cannot be made into a system file and is referenced.
   CP_6_C.:E05TOU  is referenced.
   CP_6.:E05TOU  cannot be made into a system file and is referenced.
   K$RWPARM.:E05TOU  is referenced.
   K_DATA_R.:E05TOU  cannot be made into a system file and is referenced.
   HF_LOCK_C.:E05TOU  cannot be made into a system file and is referenced.
   CP_6_SUBS.:E05TOU  is referenced.
   B$JIT_C.:E05TOU  is referenced.
   B$JIT.:E05TOU  cannot be made into a system file and is referenced.
      No diagnostics issued in procedure FSP$CLSDEV.
PL6.E3A0      #001=FSP$CLSDEV File=FSP$CLSDEV.:E05TSI                            TUE 07/29/97 17:37 Page:78   

 **** Variables and constants ****

  ****  Section 001 RoData FSP$CLSDEV

  ****  Scalars and arrays  ****
OctLoc.c.b A Datatyp(siz) R M Lvl/name                 OctLoc.c.b A Datatyp(siz) R M Lvl/name

     2-0-0/d STRC(648)   r     1 CLSSAVE$                  24-0-0/d STRC(648)   r     1 CLSSCRATCH$
     0-0-0/b STRC        r     1 ERR_NOCLSMUC

  ****  Auto variables  ****

  ****  Scalars and arrays  ****
OctLoc.c.b A Datatyp(siz) R M Lvl/name                 OctLoc.c.b A Datatyp(siz) R M Lvl/name

     3-0-0/w PTR         r     1 @PN$                      65-0-0/w STRC(108)   r     1 COMIO
    61-0-0/w UBIN(9)     r     1 DUSR                      57-0-0/w SBIN        r     1 I
    60-0-0/w SBIN        r     1 J                         55-0-0/w PTR         r     1 JDCB$
    62-0-0/w STRC(108)   r     1 JP$CITE                   54-0-0/w PTR         r     1 LDCT$
    *0-0-0/d STRC(648)   r     1 PN$                        4-0-0/d STRC(1404)  r     1 RWPARM
    56-0-0/w PTR         r     1 SDCB$

  ****  SYMREF variables  ****

  ****  Scalars and arrays  ****
OctLoc.c.b A Datatyp(siz) R M Lvl/name                 OctLoc.c.b A Datatyp(siz) R M Lvl/name

     0-0-0/w PTR         r     1 B$JIT$                     0-0-0/w PTR         r     1 B$M$UC$
     0-0-0/w PTR         r     1 B$ROSEG$                   0-0-0/c CHAR(8)     r     1 J_PRESCAN
     0-0-0/d STRC(1404)  r     1 K_RWPARM_CON               0-0-0/w PTR         r     1 N$DCT$$
     0-0-0/w PTR         r     1 S$CU$                      0-0-0/w UBIN        r     1 S_CUN

  ****  BASED and DCB variables  ****

  ****  Scalars and arrays  ****
OctLoc.c.b A Datatyp(siz) R M Lvl/name                 OctLoc.c.b A Datatyp(siz) R M Lvl/name

PL6.E3A0      #001=FSP$CLSDEV File=FSP$CLSDEV.:E05TSI                            TUE 07/29/97 17:37 Page:79   
     0-0-0/d STRC(8856)  r     1 B$JIT
     0-0-0/w PTR         r     1 B$RODCB$(0:0)
     0-0-0/d STRC(3024)  r     1 B$ROSEG                    0-0-0/d STRC(576)   r     1 B$U
     0-0-0/w STRC(1404)  r     1 CODE16                     0-0-0/d ASTR(3528)  r     1 F$DCB
     0-0-0/w STRC(288)   r     1 FM$CFU                     0-0-0/d STRC(144)   r     1 FPT$CLOSE_V
     0-0-0/d STRC(864)   r     1 NK$LDCT
     0-0-0/w PTR         r     1 NK$LDCT$(0:0)
     0-0-0/w STRC(171)   r     1 OSFN


   Procedure FSP$CLSDEV requires 936 words for executable code.
   Procedure FSP$CLSDEV requires 66 words of local(AUTO) storage.

    No errors detected in file FSP$CLSDEV.:E05TSI    .
PL6.E3A0      #001=FSP$CLSDEV File=FSP$CLSDEV.:E05TSI                            TUE 07/29/97 17:37 Page:80   
          *** CROSS REFERENCE LISTING ***
**     DENOTES     IDENTIFIER DEFINITION
<<                 IDENTIFIER'S VALUE SET
>>                 IDENTIFIER'S VALUE USED
<>                 IDENTIFIER SET AND/OR USED
--                 IDENTIFIER REFERENCED
PL6.E3A0      #001=FSP$CLSDEV File=FSP$CLSDEV.:E05TSI                            TUE 07/29/97 17:37 Page:81   
          MINI XREF LISTING

B$DO.ECCINFO
      7660**DCL      7661--REDEF
B$JIT.CPFLAGS1.SLEAZE
       503**DCL       503--REDEF
B$JIT.DCB$
       577**DCL     11473>>ASSIGN  11516<<ASSIGN  11591<<ASSIGN  11615<>CALL    11617<<ASSIGN  11696<<ASSIGN
     11705<<ASSIGN  11713<<ASSIGN  11715>>ASSIGN  11717<<ASSIGN
B$JIT.DCBNO
       490**DCL     11583>>IF      11715<<ASSIGN
B$JIT.ERR
       409**DCL     11838<<ASSIGN
B$JIT.ERR.MID
       410**DCL       410--REDEF
B$JIT.JRESPEAK
       571**DCL       572--REDEF
B$JIT.JUNK
       609**DCL     11747<<ASSIGN  11747>>ASSIGN
B$JIT.ORIGINATOR_PORT.FROM_CR
       680**DCL       680--REDEF     681--REDEF
B$JIT.PNR
       584**DCL       584--REDEF
B$JIT.TSLINE
       678**DCL       679--REDEF
B$JIT.USER
       409**DCL     11793>>IF
B$JIT$
        74**DCL       404--IMP-PTR 11473>>ASSIGN  11516>>ASSIGN  11583>>IF      11591>>ASSIGN  11615>>CALL
     11617>>ASSIGN  11696>>ASSIGN  11705>>ASSIGN  11713>>ASSIGN  11715>>ASSIGN  11715>>ASSIGN  11717>>ASSIGN
     11747>>ASSIGN  11747>>ASSIGN  11793>>IF      11838>>ASSIGN
B$M$UC$
        76**DCL     11520>>IF      11531>>IF      11556>>IF      11630>>IF      11669>>IF      11834>>IF
B$RODCB$
PL6.E3A0      #001=FSP$CLSDEV File=FSP$CLSDEV.:E05TSI                            TUE 07/29/97 17:37 Page:82   
      8550**DCL     11509>>IF      11510>>IF      11510>>IF      11555>>IF      11556>>IF      11556>>IF
     11556>>IF      11556>>IF      11576>>IF      11577>>IF      11577>>IF      11609<<ASSIGN
B$ROSEG.CR01DCB
      8544**DCL     11501>>ASSIGN  11523>>CALL    11524<<ASSIGN
B$ROSEG.CR01ID.NOWIS
      8539**DCL     11502>>DOCASE
B$ROSEG.DCBPTR$
      8515**DCL     11509>>IF      11510>>IF      11510>>IF      11555>>IF      11556>>IF      11556>>IF
     11556>>IF      11556>>IF      11576>>IF      11577>>IF      11577>>IF      11609>>ASSIGN
B$ROSEG.NUMDCBS
      8517**DCL     11507>>ASSIGN  11553>>ASSIGN  11574>>ASSIGN
B$ROSEG.STREAMID.F01
      8529**DCL     11602<<ASSIGN
B$ROSEG.STREAMID.FLG
      8527**DCL     11567<<ASSIGN  11595>>IF      11608<<ASSIGN
B$ROSEG.STREAMID.IDENT
      8534**DCL     11595>>IF      11604<<ASSIGN
B$ROSEG.STREAMID.UC_STR
      8533**DCL     11597>>IF
B$ROSEG.STREAM_VALID
      8547**DCL     11801>>IF
B$ROSEG$
        75**DCL      8514--IMP-PTR  8550--IMP-PTR  8552--IMP-PTR 11501>>ASSIGN  11501>>ASSIGN  11502>>DOCASE
     11507>>ASSIGN  11509>>IF      11510>>IF      11510>>IF      11523>>CALL    11523>>CALL    11524>>ASSIGN
     11553>>ASSIGN  11555>>IF      11556>>IF      11556>>IF      11556>>IF      11556>>IF      11567>>ASSIGN
     11574>>ASSIGN  11576>>IF      11577>>IF      11577>>IF      11592>>ASSIGN  11595>>IF      11595>>IF
     11597>>IF      11602>>ASSIGN  11604>>ASSIGN  11608>>ASSIGN  11609>>ASSIGN  11801>>IF
B$U.CMF
      7622**DCL     11864<<ASSIGN  11864>>ASSIGN
B$U.FLG
      7526**DCL     11783>>IF
B$U.MF
      7615**DCL     11863<<ASSIGN  11863>>ASSIGN
B$U.MISC
      7639**DCL      7640--REDEF
B$USER.MISC
PL6.E3A0      #001=FSP$CLSDEV File=FSP$CLSDEV.:E05TSI                            TUE 07/29/97 17:37 Page:83   
      7715**DCL      7716--REDEF
C1AGAIN
     11501**LABEL   11505--GOTO
CLSSAVE$
      9482**DCL     11517<>CALL    11606<>CALL    11683<>CALL    11697<>CALL
CLSSAVE$.SN_
      9482**DCL      9482--REDEF
CLSSAVE$.UTL_
      9483**DCL      9483--REDEF
CLSSAVE$.V
      9487**DCL      9482--DCLINIT
CLSSAVE$.V.EXPIRE#
      9497**DCL      9497--REDEF
CLSSAVE$.V.TYPE#
      9495**DCL      9495--REDEF
CLSSAVE$.V.XTNSIZE#
      9492**DCL      9492--REDEF    9494--REDEF
CLSSCRATCH$
      9525**DCL     11690<>CALL    11706<>CALL
CLSSCRATCH$.SN_
      9525**DCL      9525--REDEF
CLSSCRATCH$.UTL_
      9526**DCL      9526--REDEF
CLSSCRATCH$.V
      9530**DCL      9525--DCLINIT
CLSSCRATCH$.V.EXPIRE#
      9540**DCL      9540--REDEF
CLSSCRATCH$.V.TYPE#
      9538**DCL      9538--REDEF
CLSSCRATCH$.V.XTNSIZE#
      9535**DCL      9535--REDEF    9537--REDEF
CODE16.PAGENO
      8149**DCL     11600>>IF      11693>>IF
CODE16.RECNO
      8149**DCL     11600>>IF      11693>>IF
COMIO
PL6.E3A0      #001=FSP$CLSDEV File=FSP$CLSDEV.:E05TSI                            TUE 07/29/97 17:37 Page:84   
     11467**DCL     11785<<ASSIGN  11786--ASSIGN  11790--CALL
COMIO.ARS
     11469**DCL     11469--REDEF
COMIO.FLAGS.DELTA
     11469**DCL     11787<<ASSIGN
COMIO.P#
     11469**DCL     11786<<ASSIGN  11786--ASSIGN
COMIO.SUBC2
     11469**DCL     11788<<ASSIGN
DUSR
     11430**DCL     11789<<ASSIGN  11790<>CALL
ERR_NOCLSMUC
      8433**DCL     11838>>ASSIGN
F$DCB
      8843**DCL     11599<>CALL    11695<>CALL    11698<>CALL    11704<>CALL
F$DCB.ACTPOS
      8868**DCL      8868--REDEF
F$DCB.ARS
      8843**DCL      8843--REDEF
F$DCB.ATTR
      8861**DCL      8862--REDEF
F$DCB.BORROW
      8876**DCL      8876--REDEF    8876--REDEF    8876--REDEF
F$DCB.CFU$
      8877**DCL     11527>>IF      11530>>ASSIGN  11556>>IF      11577>>IF      11679>>IF      11711>>IF
     11711>>IF      11713>>ASSIGN  11718<<ASSIGN
F$DCB.CTLCMDIN
      8884**DCL     11500>>IF      11510>>IF
F$DCB.DCB#
      8870**DCL     11715>>ASSIGN
F$DCB.DCBNAME.L
      8890**DCL      8890--IMP-SIZ 11599>>CALL    11695>>CALL    11698>>CALL    11704>>CALL
F$DCB.EOMCHAR
      8847**DCL      8847--REDEF
F$DCB.EVENT
      8867**DCL     11790<>CALL
PL6.E3A0      #001=FSP$CLSDEV File=FSP$CLSDEV.:E05TSI                            TUE 07/29/97 17:37 Page:85   
F$DCB.FCD
      8856**DCL     11498<<ASSIGN  11510>>IF      11521<<ASSIGN  11556>>IF      11577>>IF      11597>>IF
     11711>>IF      11770<<ASSIGN  11804<<ASSIGN  11836<<ASSIGN
F$DCB.FCN.CNT
      8880**DCL     11535>>IF      11545<<ASSIGN  11545>>ASSIGN  11728>>IF      11860>>ASSIGN  11865<<ASSIGN
F$DCB.FLDID
      8871**DCL      8871--REDEF
F$DCB.FORM$
      8865**DCL      8865--REDEF   11600>>IF      11600>>IF      11693>>IF      11693>>IF
F$DCB.FPSTR
      8881**DCL     11556>>IF      11801>>IF      11803>>ASSIGN
F$DCB.FSECT
      8881**DCL      8881--REDEF
F$DCB.FSN
      8858**DCL      8858--REDEF    8858--REDEF    8859--REDEF
F$DCB.FUN
      8857**DCL     11672<<ASSIGN
F$DCB.HEADER$
      8864**DCL      8864--REDEF
F$DCB.IASN
      8884**DCL     11474>>DOCASE  11515>>IF      11518<<ASSIGN  11741>>IF      11783>>IF      11792>>IF
     11796<<ASSIGN  11807>>IF
F$DCB.IFMT
      8883**DCL     11640>>IF      11677>>IF      11708>>IF
F$DCB.IXTNSIZE
      8862**DCL      8862--REDEF
F$DCB.LASTSTA$
      8852**DCL      8852--REDEF
F$DCB.LDCTX
      8865**DCL     11537>>ASSIGN  11582>>ASSIGN  11720>>ASSIGN  11745>>CALL    11794>>CALL    11795>>IF
     11798<<ASSIGN  11799>>ASSIGN
F$DCB.LVL
      8877**DCL      8877--REDEF
F$DCB.MEDIA
      8883**DCL     11533>>IF      11632>>IF      11670>>IF
F$DCB.NAME
PL6.E3A0      #001=FSP$CLSDEV File=FSP$CLSDEV.:E05TSI                            TUE 07/29/97 17:37 Page:86   
      8852**DCL     11603--CALLBLT 11703--IF
F$DCB.NAME.C
      8852**DCL      8852--REDEF   11684>>CALLBLT
F$DCB.NOEOF
      8873**DCL      8873--REDEF
F$DCB.NRECS
      8863**DCL      8863--REDEF
F$DCB.NRECX
      8882**DCL      8882--REDEF
F$DCB.OHDR
      8874**DCL      8874--REDEF
F$DCB.ORG
      8857**DCL      8857--REDEF   11580>>IF      11708<<ASSIGN
F$DCB.PRECNO
      8880**DCL      8880--REDEF
F$DCB.RCSZ
      8885**DCL      8885--REDEF
F$DCB.RES
      8853**DCL      8853--REDEF   11680>>IF
F$DCB.RESNT.NUM
      8854**DCL     11761>>IF      11807>>IF
F$DCB.SETX
      8865**DCL      8865--REDEF   11648>>ASSIGN  11795>>IF      11795>>IF      11797<<ASSIGN  11798>>ASSIGN
F$DCB.STR
      8881**DCL     11552>>ASSIGN  11556>>IF      11803<<ASSIGN
F$DCB.TAB$
      8864**DCL      8865--REDEF
F$DCB.TDA
      8879**DCL      8879--REDEF
F$DCB.WSN
      8854**DCL      8854--REDEF
FEP_CLOSE
     11720**LABEL   11649--GOTO    11650--GOTO
FEP_RELDCT
     11774**LABEL   11731--GOTO
FIND_UC_STR
PL6.E3A0      #001=FSP$CLSDEV File=FSP$CLSDEV.:E05TSI                            TUE 07/29/97 17:37 Page:87   
     11545**LABEL   11805--GOTO
FM$CFU.ACCTX
      8144**DCL      8144--REDEF
FM$CFU.NRECS
      8144**DCL     11679>>IF
FMB$IOSPIN
        51**DCL-ENT 11651--CALL
FMD$RELBUF
        52**DCL-ENT 11646--CALL
FMF$REMOTE
        53**DCL-ENT 11641--CALL
FMH$SYMB_FINISH
        55**DCL-ENT 11605--CALL
FMM$RELDCBI
        54**DCL-ENT 11716--CALL
FMN$CLSDP
        45**DCL-ENT 11829--CALL
FMP$CLSF
        48**DCL-ENT 11517--CALL    11606--CALL    11683--CALL    11690--CALL    11697--CALL    11706--CALL
FMP$CLSJ
        49**DCL-ENT 11714--CALL
FPC$CLSOD
        62**DCL-ENT 11824--CALL
FPT$CLOSE_V.CLDCB
      9549**DCL     11767>>ASSIGN  11814>>ASSIGN
FPT$CLOSE_V.CLINFO
      9550**DCL     11766>>ASSIGN  11813>>ASSIGN
FPT$CLOSE_V.CLSYSID
      9548**DCL     11763<>CALL    11811<>CALL
FPT$CLOSE_V.DISP
      9546**DCL     11676>>ASSIGN  11736>>ASSIGN
FPT$CLOSE_V.EXPIRE
      9550**DCL      9550--REDEF
FPT$CLOSE_V.TYPE
      9549**DCL      9549--REDEF
FPT$CLOSE_V.XTNSIZE
PL6.E3A0      #001=FSP$CLSDEV File=FSP$CLSDEV.:E05TSI                            TUE 07/29/97 17:37 Page:88   
      9546**DCL      9546--REDEF    9548--REDEF
FRB$CLS
        50**DCL-ENT 11652--CALL    11769--CALL    11792--CALL
FRF$EVRPT
        56**DCL-ENT 11762--CALL    11768--CALL    11816--CALL
FSA$FDCB
        47**DCL-ENT 11523--CALL    11615--CALL
FSD$C1END
        57**DCL-ENT 11504--CALL
FSD$JFCLS
        58**DCL-ENT 11681--CALL
FSL$ACCT
        59**DCL-ENT 11599--CALL    11695--CALL
FSX$TELLOUTSYM
        60**DCL-ENT 11698--CALL    11704--CALL
FTC$CLOSE
        61**DCL-ENT 11822--CALL
GOT_STRM
     11609**LABEL   11610--GOTO
HFC$LOCK
      1238**DCL-ENT 11541--CALL    11726--CALL    11749--CALL    11758--CALL    11857--CALL
HFC$UNLOCK
      1238**DCL-ENT 11547--CALL    11753--CALL    11781--CALL
I
     11428**DCL     11507<<ASSIGN  11508>>DOWHILE 11509>>IF      11510>>IF      11510>>IF      11513<<ASSIGN
     11513>>ASSIGN  11544>>IF      11545>>ASSIGN  11553<<ASSIGN  11554>>DOWHILE 11555>>IF      11556>>IF
     11556>>IF      11556>>IF      11556>>IF      11562<<ASSIGN  11562>>ASSIGN  11574<<ASSIGN  11575>>DOWHILE
     11576>>IF      11577>>IF      11577>>IF      11585>>ASSIGN  11589<<ASSIGN  11589>>ASSIGN  11593<<ASSIGN
     11594>>DOUNTIL 11595>>IF      11595>>IF      11597>>IF      11602>>ASSIGN  11604>>ASSIGN  11608>>ASSIGN
     11609>>ASSIGN  11612<<ASSIGN  11612>>ASSIGN  11645<<DOINDEX 11646<>CALL    11675<<ASSIGN  11676<<ASSIGN
     11679>>IF      11693>>IF      11734<<ASSIGN  11736<<ASSIGN  11741>>IF      11763>>IF      11807>>IF
     11860<<ASSIGN  11861>>IF      11863>>ASSIGN  11864>>ASSIGN
J
     11429**DCL     11552<<ASSIGN  11556>>IF      11556>>IF      11564>>IF      11566<>CALL    11567>>ASSIGN
     11570<>CALL    11592<<ASSIGN  11595>>IF      11603<<CALLBLT 11604>>ASSIGN  11684<<CALLBLT 11685>>ASSIGN
JDCB$
PL6.E3A0      #001=FSP$CLSDEV File=FSP$CLSDEV.:E05TSI                            TUE 07/29/97 17:37 Page:89   
     11426**DCL      8843--IMP-PTR 11473<<ASSIGN  11474>>DOCASE  11498>>ASSIGN  11500>>IF      11527>>IF
     11530>>ASSIGN  11535>>IF      11552>>ASSIGN  11617>>ASSIGN  11630>>IF      11632>>IF      11640>>IF
     11648>>ASSIGN  11669>>IF      11670>>IF      11672>>ASSIGN  11677>>IF      11679>>IF      11680>>IF
     11684>>CALLBLT 11693>>IF      11693>>IF      11695>>CALL    11695>>CALL    11696>>ASSIGN  11698>>CALL
     11698>>CALL    11703>>IF      11704>>CALL    11704>>CALL    11705>>ASSIGN  11708>>IF      11708>>ASSIGN
     11711>>IF      11711>>IF      11713>>ASSIGN  11717>>ASSIGN  11718>>ASSIGN  11720>>ASSIGN  11728>>IF
     11741>>IF      11745>>CALL    11761>>IF      11770>>ASSIGN  11783>>IF      11790>>CALL    11792>>IF
     11794>>CALL    11795>>IF      11795>>IF      11795>>IF      11796>>ASSIGN  11797>>ASSIGN  11798>>ASSIGN
     11798>>ASSIGN  11799>>ASSIGN  11801>>IF      11803>>ASSIGN  11803>>ASSIGN  11804>>ASSIGN  11807>>IF
     11807>>IF      11834>>IF      11836>>ASSIGN  11860>>ASSIGN  11865>>ASSIGN
JP$CITE
     11446**DCL     11687<>CALL    11687--CALL
JP$CITE.CODE
     11451**DCL     11686<<ASSIGN
JP$CITE.SYSID
     11455**DCL     11457--REDEF   11685<<ASSIGN
J_PRESCAN
        80**DCL     11687<>CALL
KCO$CLCG
        67**DCL-ENT 11671--CALL
KIA$CLSSTR
        63**DCL-ENT 11566--CALL    11570--CALL
KIA$DSCU
        64**DCL-ENT 11775--CALL
KIA$FCNOU
        65**DCL-ENT 11739--CALL    11852--CALL
KILL_IO
     11847**PROC    11543--CALL    11728--CALL
KIS$OSI_CLOSE
        66**DCL-ENT 11633--CALL
KUW$WRITE
        46**DCL-ENT 11687--CALL
K_RWPARM_CON
      1654**DCL     11737>>ASSIGN  11774>>ASSIGN  11849>>ASSIGN
K_RWPARM_CON.BLKREC
      1680**DCL      1705--REDEF
PL6.E3A0      #001=FSP$CLSDEV File=FSP$CLSDEV.:E05TSI                            TUE 07/29/97 17:37 Page:90   
K_RWPARM_CON.BLKREC.BLKU#
      1681**DCL      1683--REDEF
K_RWPARM_CON.BLKREC.RECU#
      1693**DCL      1695--REDEF
K_RWPARM_CON.DVE.DVBYTE.VFC
      1720**DCL      1721--REDEF
K_RWPARM_CON.DVE.EOMCHAR
      1728**DCL      1732--REDEF
K_RWPARM_CON.ERR
      1792**DCL      1797--REDEF
K_RWPARM_CON.FC
      1756**DCL      1757--REDEF
K_RWPARM_CON.FLDID
      1938**DCL      1939--REDEF
K_RWPARM_CON.FPT$
      1819**DCL      1826--REDEF
K_RWPARM_CON.KEYTYPE
      1945**DCL      1946--REDEF
K_RWPARM_CON.MSG$
      1655**DCL      1661--REDEF
K_RWPARM_CON.MSGID
      1767**DCL      1772--REDEF
K_RWPARM_CON.MSGIDXT
      1780**DCL      1784--REDEF
K_RWPARM_CON.ORG
      1916**DCL      1917--REDEF
K_RWPARM_CON.THDRSZ
      1860**DCL      1864--REDEF
K_RWPARM_CON.VDOFLGS
      1918**DCL      1929--REDEF
LDCT$
     11425**DCL     11076--IMP-PTR 11537<<ASSIGN  11538>>IF      11541>>CALL    11547>>CALL    11582<<ASSIGN
     11583>>IF      11585>>ASSIGN  11648<<ASSIGN  11649>>IF      11650>>IF      11720<<ASSIGN  11724>>DOWHILE
     11726>>CALL    11729>>IF      11729>>IF      11738>>ASSIGN  11739>>CALL    11741>>IF      11744>>ASSIGN
     11749>>CALL    11751>>ASSIGN  11753>>CALL    11758>>CALL    11763>>CALL    11766>>ASSIGN  11767>>ASSIGN
     11768>>CALL    11775>>CALL    11777>>ASSIGN  11781>>CALL    11793>>IF      11799<<ASSIGN  11810<<ASSIGN
PL6.E3A0      #001=FSP$CLSDEV File=FSP$CLSDEV.:E05TSI                            TUE 07/29/97 17:37 Page:91   
     11811>>CALL    11813>>ASSIGN  11814>>ASSIGN  11815>>ASSIGN  11816>>CALL    11851>>ASSIGN  11852>>CALL
     11854>>ASSIGN  11855>>CALL    11857>>CALL    11862>>ASSIGN
MORE_JCL
     11526**LABEL   11512--GOTO
MORE_STR
     11609**LABEL   11527--GOTO    11534--GOTO    11561--GOTO    11572--GOTO    11587--GOTO
N$DCT$$
     10828**DCL     10828--IMP-PTR 11537>>ASSIGN  11582>>ASSIGN  11648>>ASSIGN  11720>>ASSIGN  11745>>CALL
     11794>>CALL    11799>>ASSIGN  11855>>CALL
NK$LDCT
     11076**DCL     11739<>CALL    11768<>CALL    11775<>CALL    11816<>CALL    11852<>CALL
NK$LDCT.DCBNO
     11100**DCL     11767<<ASSIGN  11814<<ASSIGN
NK$LDCT.DDT$
     11078**DCL     11078--REDEF
NK$LDCT.DFLG.FEDN
     11084**DCL     11729>>IF
NK$LDCT.DFLG.INPUT
     11080**DCL     11729>>IF
NK$LDCT.DFLG.LOCAL
     11082**DCL     11650>>IF
NK$LDCT.DFLG.PRLS
     11083**DCL     11777<<ASSIGN
NK$LDCT.IOQ$
     11077**DCL     11078--REDEF
NK$LDCT.LDCTX
     11079**DCL     11079--REDEF   11815<<ASSIGN  11855>>CALL
NK$LDCT.LKFLG.ABORTED
     11091**DCL     11092--REDEF
NK$LDCT.LKFLG.FPSTEP
     11096**DCL     11741>>IF
NK$LDCT.LKFLG.NOWAIT
     11097**DCL     11862<<ASSIGN
NK$LDCT.LKFLG.WAITINGEXIT
     11093**DCL     11744<<ASSIGN  11751<<ASSIGN
NK$LDCT.LKFLG.WTMRK
PL6.E3A0      #001=FSP$CLSDEV File=FSP$CLSDEV.:E05TSI                            TUE 07/29/97 17:37 Page:92   
     11092**DCL     11854<<ASSIGN
NK$LDCT.LOCK
     11104**DCL     11541<>CALL    11547<>CALL    11726<>CALL    11749<>CALL    11753<>CALL    11758<>CALL
     11781<>CALL    11857<>CALL
NK$LDCT.MSGID
     11076**DCL     11766<<ASSIGN  11813<<ASSIGN
NK$LDCT.NOWAIT.STREAM
     11087**DCL     11851>>ASSIGN
NK$LDCT.RLCID.LDCTX
     11101**DCL     11101--REDEF
NK$LDCT.STA$
     11097**DCL     11098--REDEF
NK$LDCT.SYMB$
     11076**DCL     11076--REDEF   11076--REDEF   11077--REDEF
NK$LDCT.TH
     11102**DCL     11738<<ASSIGN
NK$LDCT.UDCBNO
     11101**DCL     11583>>IF      11585<<ASSIGN
NK$LDCT.USER
     11086**DCL     11763<>CALL    11793>>IF      11811<>CALL
NK$LDCT$
     10828**DCL     11537>>ASSIGN  11582>>ASSIGN  11648>>ASSIGN  11720>>ASSIGN  11745<>CALL    11794<>CALL
     11799>>ASSIGN  11855<>CALL
NKL$RELDCTL
        68**DCL-ENT 11794--CALL
OCZ$SID_UN
        69**DCL-ENT 11763--CALL    11811--CALL
OSFN.CNUM
      9327**DCL     11703>>IF
OSFN.NUM
      9327**DCL     11603>>CALLBLT
PN$
      7748**DCL        44--PROC    11671<>CALL    11681<>CALL    11822<>CALL    11824<>CALL    11829<>CALL
PN$.SN_
      7748**DCL      7748--REDEF
PN$.UTL_
PL6.E3A0      #001=FSP$CLSDEV File=FSP$CLSDEV.:E05TSI                            TUE 07/29/97 17:37 Page:93   
      7749**DCL      7749--REDEF
PN$.V.EXPIRE#
      7763**DCL      7763--REDEF
PN$.V.TYPE#
      7761**DCL      7761--REDEF
PN$.V.XTNSIZE#
      7758**DCL      7758--REDEF    7760--REDEF
PN$.V_
      7748**DCL     11675>>IF      11676>>ASSIGN  11732>>IF      11736>>ASSIGN  11763>>CALL    11766>>ASSIGN
     11767>>ASSIGN  11811>>CALL    11813>>ASSIGN  11814>>ASSIGN
RWPARM
     11130**DCL     11737<<ASSIGN  11739<>CALL    11774<<ASSIGN  11775<>CALL    11810--ASSIGN  11849<<ASSIGN
     11852<>CALL
RWPARM.BLKREC
     11156**DCL     11181--REDEF
RWPARM.BLKREC.BLKU#
     11157**DCL     11159--REDEF
RWPARM.BLKREC.RECU#
     11169**DCL     11171--REDEF
RWPARM.DVE.DVBYTE.VFC
     11196**DCL     11197--REDEF
RWPARM.DVE.EOMCHAR
     11204**DCL     11208--REDEF
RWPARM.ERR
     11268**DCL     11273--REDEF
RWPARM.FC
     11232**DCL     11233--REDEF
RWPARM.FLDID
     11414**DCL     11415--REDEF
RWPARM.FPT$
     11295**DCL     11302--REDEF
RWPARM.KEYTYPE
     11421**DCL     11422--REDEF
RWPARM.MRKTYP
     11406**DCL     11850<<ASSIGN
RWPARM.MSG$
PL6.E3A0      #001=FSP$CLSDEV File=FSP$CLSDEV.:E05TSI                            TUE 07/29/97 17:37 Page:94   
     11131**DCL     11137--REDEF
RWPARM.MSGID
     11243**DCL     11248--REDEF
RWPARM.MSGIDXT
     11256**DCL     11260--REDEF
RWPARM.ORG
     11392**DCL     11393--REDEF
RWPARM.STR
     11407**DCL     11851<<ASSIGN
RWPARM.THDRSZ
     11336**DCL     11340--REDEF
RWPARM.VDOFLGS
     11394**DCL     11405--REDEF
S$CU$
        78**DCL     11783>>IF      11863>>ASSIGN  11863>>ASSIGN  11864>>ASSIGN  11864>>ASSIGN
SDCB$
     11427**DCL     11501<<ASSIGN  11515>>IF      11516>>ASSIGN  11518>>ASSIGN  11520>>IF      11521>>ASSIGN
     11527>>IF      11530<<ASSIGN  11531>>IF      11533>>IF      11537>>ASSIGN  11545>>ASSIGN  11545>>ASSIGN
     11577>>IF      11580>>IF      11582>>ASSIGN  11591>>ASSIGN  11592>>ASSIGN  11597>>IF      11599>>CALL
     11599>>CALL    11600>>IF      11600>>IF      11603>>CALLBLT
SSR$REG
        70**DCL-ENT 11745--CALL    11855--CALL
SSS$BLOCK
        71**DCL-ENT 11723--CALL
SSV$EVENT
        72**DCL-ENT 11790--CALL
S_CUN
        79**DCL     11789>>ASSIGN
UCNOCLS
     11838**LABEL   11630--GOTO    11669--GOTO    11834--GOTO
