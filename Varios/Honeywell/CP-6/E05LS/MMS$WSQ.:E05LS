VERSION E05

PL6.E3A0      #001=MMS$WSQINIT File=MMS$WSQ.:E05TSI                              WED 07/30/97 03:23 Page:1    
        1        1        /*M* MMS$WSQ Communications WSQ management */
        2        2        /*T***********************************************************/
        3        3        /*T*                                                         */
        4        4        /*T* Copyright (c) Bull HN Information Systems Inc., 1997    */
        5        5        /*T*                                                         */
        6        6        /*T***********************************************************/
        7        7        /*X* DMC,PLM=6,IND=0,IDT=2,SDI=2,CTI=0,ENU=0,AND,DCI=4,CSU=2,ECU=4,THI=0,DTI=0,STI=1
                 7        ,IAD=0,PRB */
        8        8        /**/
        9        9        /*P* NAME:         MMS$WSQ
       10       10             PURPOSE:      To manage communications working space quarters
       11       11        */
       12       12        MMS$WSQINIT: PROC(WSQN,PTR$,BSIZE,RPTR$,PTWDS) ALTRET;
       13       13        /**/
       14       14
       15       15
       16       16
       17       17        /**/
       18       18        /* INCLUDES */
       19       19        /**/
       20       20        %INCLUDE FOS_SUBS_C;
       21       37        %INCLUDE S_WSPTD_R;                     /* Workspace page table directory     */
       22       53        %INCLUDE S$WSPTD;
       23       62        %INCLUDE B_SEGIDS_C;                    /* System segid definitions           */
       24      601        %INCLUDE B_MACROS_C;                    /* System macros                      */
       25      712        %INCLUDE HF_DATA_R;
       26      755        %INCLUDE HF_LOCK_C;
       27      769        %INCLUDE MM_DATA_R;                     /* Mm-specific data                   */
       28     1289        %INCLUDE B$MAP;                         /* Based definition of page table     */
       29     1388        %INCLUDE FOS_DATA_R;                    /* Fos data                           */
       30     1398
       31     1399
       32     1400
       33     1401        /**/
       34     1402        /* PARAMETERS */
       35     1403        /**/
       36     1404    1   DCL WSQN UBIN;                     /* Wsq # or # of wsqs, depending on entry  */
PL6.E3A0      #001=MMS$WSQINIT File=MMS$WSQ.:E05TSI                              WED 07/30/97 03:23 Page:2    
       37     1405    1   DCL PTR$ PTR;                           /* PTR: Use depends on entry point    */
       38     1406    1   DCL PTPPNO REDEF PTR$ UBIN;
       39     1407    1   DCL BSIZE SBIN;                         /* # of bytes in user's buffer        */
       40     1408    1   DCL CQPAGE REDEF BSIZE SBIN;            /* ...OR page # to get                */
       41     1409    1   DCL RPTR$ PTR;                     /* Comm wsq-relative ptr to user buffer    */
       42     1410    1   DCL 1 PTWDS ALIGNED,
       43     1411    1         2 WD1,
       44     1412    1           3 PPNO UBIN(18) UNAL,
       45     1413    1           3 * UBIN(18) UNAL,
       46     1414    1         2 WD2,
       47     1415    1           3 PPNO UBIN(18) UNAL,
       48     1416    1           3 * UBIN(18) UNAL;
       49     1417                                                /**/
       50     1418
       51     1419
       52     1420
       53     1421        /**/
       54     1422        /* BASED STRUCTURES */
       55     1423        /**/
       56     1424    1   DCL 1 B$PPTR BASED ALIGNED,
       57     1425    1         2 PG UBIN(8) UNAL,
       58     1426    1         2 BYT UBIN(12) UNAL,
       59     1427    1         2 * UBIN(4) UNAL,
       60     1428    1         2 SEGID UBIN(12) UNAL;
       61     1429
       62     1430
       63     1431
       64     1432        /**/
       65     1433        /* AUTO */
       66     1434        /**/
       67     1435    1   DCL MAPPGS SBIN;
       68     1436    1   DCL CWSQ SBIN;
       69     1437    1   DCL I SBIN;
       70     1438    1   DCL J SBIN;
       71     1439    1   DCL K SBIN;
       72     1440    1   DCL TMP UBIN;
       73     1441    1   DCL WSPTD$ PTR;
PL6.E3A0      #001=MMS$WSQINIT File=MMS$WSQ.:E05TSI                              WED 07/30/97 03:23 Page:3    
       74     1442    1   DCL PPNO SBIN;
       75     1443    1   DCL VBUFPG SBIN;
       76     1444    1   DCL VBUFLEN SBIN;
       77     1445    1   DCL PGT$ PTR;
       78     1446    1   DCL PGTX REDEF PGT$ UBIN;
       79     1447    1   DCL UPGT$ PTR;
       80     1448    1   DCL CSID SBIN;
       81     1449    1   DCL PSID SBIN;
       82     1450    1   DCL PTLOC SBIN;
       83     1451    1   DCL ERR SBIN;
       84     1452    1   DCL DBAS SBIN;
       85     1453    1   DCL BOFFSET SBIN;
       86     1454    1   DCL DWSR SBIN;
       87     1455    1   DCL PREV_SEG_END UBIN;
       88     1456    1   DCL SORT_SEGS(0:FOSS_MAX#) UBIN WORD;
       89     1457
       90     1458
       91     1459
       92     1460        /**/
       93     1461        /* REFS */
       94     1462        /**/
       95     1463    1   DCL HFC$ASSOCCLR  ENTRY(3);
       96     1464    1   DCL MMA$WHERE     ENTRY(4);
       97     1465    1   DCL MMB$FPP       ENTRY(1) ALTRET;
       98     1466    1   DCL MMB$GPP       ENTRY(2) ALTRET;
       99     1467    1   DCL MME$CVM       ENTRY(4) ALTRET;
      100     1468    1   DCL MMF$FIXLS     ENTRY(5);
      101     1469    1   DCL SC_MM30       ENTRY    CONV(2,0);
      102     1470    1   DCL SC_MM31       ENTRY    CONV(2,0);
      103     1471    1   DCL SC_MM32       ENTRY    CONV(2,0);
      104     1472    1   DCL SC_MM33       ENTRY    CONV(2,0);
      105     1473    1   DCL SC_MM34       ENTRY    CONV(2,0);
      106     1474    1   DCL SC_MM35_S     ENTRY    CONV(2,0);
      107     1475    1   DCL SC_MM36       ENTRY    CONV(2,0);
      108     1476    1   DCL SC_MM37       ENTRY    CONV(2,0);
      109     1477    1   DCL SC_MM42       ENTRY    CONV(2,0);
      110     1478        /**/
PL6.E3A0      #001=MMS$WSQINIT File=MMS$WSQ.:E05TSI                              WED 07/30/97 03:23 Page:4    
      111     1479    1   DCL B$CWSQ1$(0:0) PTR SYMREF READONLY;
      112     1480    1   DCL B$CPGT1$(0:0) PTR SYMREF READONLY;
      113     1481    1   DCL B$WINDOW$ PTR SYMREF READONLY;
      114     1482    1   DCL B$LS$ PTR SYMREF READONLY;
      115     1483    1   DCL B$CGPT$ PTR SYMREF READONLY;
      116     1484    1   DCL B$MPT$ PTR SYMREF READONLY;
      117     1485    1   DCL B$UPT$ PTR SYMREF READONLY;
      118     1486    1   DCL B$SLV1PT$ PTR SYMREF READONLY;
      119     1487    1   DCL B$NULL$ PTR SYMREF READONLY;
      120     1488    1   DCL B$CGCTXT$ PTR SYMREF READONLY;
      121     1489    1   DCL B$PPUT$ PTR SYMREF READONLY;
      122     1490    1   DCL B$WSQ0PT$ PTR SYMREF READONLY;
      123     1491    1   DCL B$IPHYMAP$ PTR SYMREF READONLY;
      124     1492    1   DCL S_NSCPU SBIN SYMREF;
      125     1493    1   DCL IT_SCPUWSPTD(0:3) UBIN SYMREF;
      126     1494        /**/
      127     1495        %EJECT;
PL6.E3A0      #001=MMS$WSQINIT File=MMS$WSQ.:E05TSI                              WED 07/30/97 03:23 Page:5    
      128     1496                                                /**/
      129     1497        /*F*   NAME:   MMS$WSQINIT                                         */
      130     1498        /*F*   PURPOSE: To initialize a given number of WSQ's for use by   */
      131     1499        /*,*           communications.                                     */
      132     1500                                                /* Wsqn is # of wsq's to initialize   */
      133     1501                                                /* Altreturn is never taken           */
      134     1502    1         MM_NCWSQ = WSQN;                /* Set # of cwsq's to be used         */
      135     1503    1         MAPPGS = (WSQN+3) / 4;          /* # of map pages required for wsq's  */
      136     1504    1         CWSQ = %B_CWSQ1;                 /* Start with the first cwsq          */
      137     1505    1         CSID = BITBIN(%CWSQ1SID);
      138     1506    1         PSID = BITBIN(%CPGT1SID);
      139     1507    1         PTLOC = %CWSQPTLO * 4096;       /* Byte loc of cwsq1 pgtbl in mon wsq */
      140     1508                                                /**/
      141     1509        /* Get 1 page for each 4 wsq's, map each in turn into the monitor  */
      142     1510        /* 'WINDOW' at fmseglo, enter the page(s) permanently into the     */
      143     1511        /* Monitor's map starting at cwsqptlo. Initialize each map and     */
      144     1512        /* Each linkage seg descriptor for both the cwsq itself and its    */
      145     1513        /* Page table.                                                     */
      146     1514                                                /**/
      147     1515    2           DO I = 1 TO MAPPGS;
      148     1516    2           CALL MMB$GPP(PPNO,%MONWSQ);
      149     1517    2           B$PPUT$->MM$PPUT.COMM(PPNO) = '1'B;   /* Set who page belongs to */
      150     1518    2           CALL MME$CVM(%MONWSQ,%WINDOWLO,PPNO,ERR);
      151     1519                %MAP (P$=B$MPT$,VPNO="%CWSQPTLO+I-1");
      152     1522                %SAC (P$=B$MPT$,VPNO="%CWSQPTLO+I-1",AC="%PGINMEM|%PGWRITE");
      153     1525        /* Fix up the slave page tables to contain the cwsq page tables */
      154     1526    2           PGT$ = B$SLV1PT$;
      155     1527    3             DO J = 1 TO S_NSCPU;
      156     1528    3             PGT$->B$PAGE.WRD(%CWSQPTLO+I-1) = B$MPT$->B$PAGE.WRD(%CWSQPTLO+I-1);
      157     1529    3             PGTX = PGTX + 1;
      158     1530    3             END;
      159     1531        /* Initialize the cwsq page tables to all %FPMC's */
      160     1532    2           PGT$ = B$WINDOW$;             /* Point to 1st page tbl in window    */
      161     1533                                                /**/
      162     1534    3             DO J = 0 TO 3;                /* Do for each pg tbl in the page     */
      163     1535    4               DO K = 0 TO 255;
      164     1536    4               PGT$->B$PAGE.WRD(K) = BITBIN(MM_FPMC);
PL6.E3A0      #001=MMS$WSQINIT File=MMS$WSQ.:E05TSI                              WED 07/30/97 03:23 Page:6    
      165     1537    4               END;
      166     1538    3             CALL MMF$FIXLS(B$LS$,PSID,1,PTLOC,1023);
      167     1539    3             WSPTD$ = PINCRW(B$WINDOW$,1024);
      168     1540        /* Update each slave cpu's wsptd */
      169     1541    4               DO K = 0 TO S_NSCPU;
      170     1542    4               CALL MME$CVM(%MONWSQ,%WINDOWLO+1,IT_SCPUWSPTD(K),ERR);
      171     1543    4               IF HW_WSQ0PT THEN
      172     1544    4                WSPTD$->S$WSPTD.BLKNO(CWSQ)=B$WSQ0PT$->B$MAP.RPN(PPNO) *
      173     1545    4                (1024 / HW_PTB_UNITS);
      174     1546    4               ELSE
      175     1547    4                WSPTD$->S$WSPTD.BLKNO(CWSQ) = PPNO * (1024 / HW_PTB_UNITS);
      176     1548    4               WSPTD$->S$WSPTD.P(CWSQ) = %TRUE;
      177     1549    4               WSPTD$->S$WSPTD.NBLKS(CWSQ) = 16;
      178     1550    4               END;
      179     1551    3             CWSQ = CWSQ + 1;
      180     1552    3             IF CWSQ > WSQN+%B_CWSQ1-1 THEN GOTO EXITLOOPS; /* All done         */
      181     1553    3             CSID = CSID + 1;
      182     1554    3             PSID = PSID + 1;
      183     1555    3             PTLOC = PTLOC + 1024;
      184     1556    3             PGT$ = PINCRW(PGT$,256);
      185     1557    3             END;
      186     1558    2           END;
      187     1559    1   EXITLOOPS:;
      188     1560    1         RETURN;
      189     1561        /**/
      190     1562                                                /**/
      191     1563        %EJECT;
PL6.E3A0      #001=MMS$WSQINIT File=MMS$WSQ.:E05TSI                              WED 07/30/97 03:23 Page:7    
      192     1564    1   MMS$WSQSETUP: ENTRY(WSQN) ALTRET;
      193     1565
      194     1566        /* This entry sets up the page table for a group of four FEI
      195     1567             interfaces.  It returns the physical page of the PT */
      196     1568
      197     1569    1         CWSQ = %B_CWSQ13;                 /* Start with the first cwsq          */
      198     1570    1         CSID = BITBIN(%CWSQ13SID);
      199     1571    1         PSID = BITBIN(%CPGT13SID);
      200     1572    1         PTLOC = (%CWSQPTLO+3) * 4096;       /* Byte loc of cwsq1 pgtbl in mon wsq */
      201     1573                                                /**/
      202     1574        /* Get 1 page for each 4 wsq's, map each in turn into the monitor  */
      203     1575        /* 'WINDOW' at fmseglo */
      204     1576        /* Initialize each map and     */
      205     1577        /* Each linkage seg descriptor for both the cwsq itself and its    */
      206     1578        /* Page table.                                                     */
      207     1579                                                /**/
      208     1580    1         CALL MMB$GPP(PPNO,%MONWSQ);
      209     1581    1         WSQN = PPNO;
      210     1582    1         B$PPUT$->MM$PPUT.COMM(PPNO) = '1'B;   /* Set who page belongs to */
      211     1583    1         CALL MME$CVM(%MONWSQ,%WINDOWLO,PPNO,ERR);
      212     1584              %MAP (P$=B$MPT$,VPNO="%CWSQPTLO+3");
      213     1587              %SAC (P$=B$MPT$,VPNO="%CWSQPTLO+3",AC="%PGINMEM|%PGWRITE");
      214     1590        /* Initialize the cwsq page tables to all %FPMC's */
      215     1591    1         PGT$ = B$WINDOW$;             /* Point to 1st page tbl in window    */
      216     1592                                                /**/
      217     1593    2           DO J = 0 TO 3;                /* Do for each pg tbl in the page     */
      218     1594    3             DO K = 0 TO 255;
      219     1595    3             PGT$->B$PAGE.WRD(K) = BITBIN(MM_FPMC);
      220     1596    3             END;
      221     1597    2           IF HW_WSQ0PT THEN
      222     1598    2            S_WSPTD.BLKNO(CWSQ)=B$WSQ0PT$->B$MAP.RPN(PPNO) * (1024 / HW_PTB_UNITS);
      223     1599    2           ELSE
      224     1600    2            S_WSPTD.BLKNO(CWSQ) = PPNO * (1024 / HW_PTB_UNITS);
      225     1601    2           S_WSPTD.P(CWSQ) = %TRUE;
      226     1602    2           S_WSPTD.NBLKS(CWSQ) = 16;
      227     1603    2           CALL MMF$FIXLS(B$LS$,PSID,1,PTLOC,1023);
      228     1604    2           CWSQ = CWSQ + 1;
PL6.E3A0      #001=MMS$WSQINIT File=MMS$WSQ.:E05TSI                              WED 07/30/97 03:23 Page:8    
      229     1605    2           IF CWSQ > %B_CWSQ16 THEN RETURN; /* All done         */
      230     1606    2           CSID = CSID + 1;
      231     1607    2           PSID = PSID + 1;
      232     1608    2           PTLOC = PTLOC + 1024;
      233     1609    2           PGT$ = PINCRW(PGT$,256);
      234     1610    2           END;
      235     1611    1         RETURN;
      236     1612        %EJECT;
PL6.E3A0      #001=MMS$WSQINIT File=MMS$WSQ.:E05TSI                              WED 07/30/97 03:23 Page:9    
      237     1613    1   MMS$WSQMAP: ENTRY (WSQN) ALTRET;
      238     1614
      239     1615        /* Maps the passed page table page number into the corresponding WSQs */
      240     1616    1         PPNO = WSQN;
      241     1617    1         I = %CWSQPTLO+3;
      242     1618
      243     1619    1         IF PPNO = 0 THEN RETURN;
      244     1620    1         IF HW_WSQ0PT THEN
      245     1621    1          TMP=B$IPHYMAP$->MM$IPHY_MAP(B$MPT$->B$MAP.RPN(I));
      246     1622    1         ELSE
      247     1623    1          TMP=B$MPT$->B$MAP.RPN(I);
      248     1624    1         IF TMP=PPNO THEN RETURN;
      249     1625
      250     1626    1         IF HW_WSQ0PT THEN
      251     1627    1          S_WSPTD.BLKNO(%B_CWSQ13)=B$WSQ0PT$->B$MAP.RPN(PPNO) * (1024 / HW_PTB_UNITS);
      252     1628    1         ELSE
      253     1629    1          S_WSPTD.BLKNO(%B_CWSQ13)=PPNO * (1024 / HW_PTB_UNITS);
      254     1630
      255     1631    1         S_WSPTD(%B_CWSQ14)=S_WSPTD(%B_CWSQ13);
      256     1632    1         S_WSPTD(%B_CWSQ15)=S_WSPTD(%B_CWSQ13);
      257     1633    1         S_WSPTD(%B_CWSQ16)=S_WSPTD(%B_CWSQ13);
      258     1634    1         CALL HFC$ASSOCCLR;
      259     1635    1         RETURN;
      260     1636
      261     1637        %EJECT;
PL6.E3A0      #001=MMS$WSQINIT File=MMS$WSQ.:E05TSI                              WED 07/30/97 03:23 Page:10   
      262     1638                                                /**/
      263     1639        /* NOTE: The communications wsq's are organized as FOLLOWS:        */
      264     1640        /*     The first %B_CQMAX pages are reserved for the input/output   */
      265     1641        /*     Circular queues, whose locations will be kept track of by   */
      266     1642        /*     Their managing routines.  The remaining pages of the 256k   */
      267     1643        /*     Wsq are reserved for dynamically mapping user's buffers.    */
      268     1644                                                /**/
      269     1645        /*F*   NAME:   MMS$GETCQ                                           */
      270     1646        /*F*   PURPOSE: To get a page for a CWSQ's circular queue.         */
      271     1647    1   MMS$GETCQ: ENTRY(WSQN,PTR$,BSIZE)  ALTRET;
      272     1648                                                /* Wsqn = cwsq in question            */
      273     1649                                           /* PTR$ = returned ptr to start of queue   */
      274     1650                                           /* Cqpage = page # in queue area to get    */
      275     1651                                           /* Altreturns if cant get page for queue   */
      276     1652        /*S* SCREECH_CODE: MMS-S$MM33
      277     1653             TYPE:         SCREECH
      278     1654             MESSAGE:      Bad WSQ# or BUF PTR passed to an MMS routine.
      279     1655             REMARKS:      Either the CWSQ number is illegal, or the pointer
      280     1656                           we are supposed to VGET has an illegal WSR in it. */
      281     1657                                                /**/
      282     1658    1         PGT$ = B$CPGT1$ (WSQN - %B_CWSQ1);
      283     1659                                                /**/
      284     1660    1         CALL MMB$GPP(PPNO,%MONWSQ);
      285     1661    1         B$PPUT$->MM$PPUT.COMM(PPNO) = '1'B;   /* Set who page belongs to */
      286     1662              %MAP (P$=PGT$,VPNO=CQPAGE);
      287     1665              %SAC (P$=PGT$,VPNO=CQPAGE,AC="%PGINMEM|%PGWRITE|%PGIOM");
      288     1668    1         MM_NCQPGS  = MM_NCQPGS  + 1;
      289     1669    1         PTR$ = PINCRW(B$CWSQ1$(WSQN-%B_CWSQ1),1024*CQPAGE);
      290     1670    1         RETURN;
      291     1671                                                /**/
      292     1672        %EJECT;
PL6.E3A0      #001=MMS$WSQINIT File=MMS$WSQ.:E05TSI                              WED 07/30/97 03:23 Page:11   
      293     1673                                                /**/
      294     1674        /*F*   NAME:   MMS$VGET                                            */
      295     1675        /*F*   PURPOSE: To map a given buffer into a communications WSQ.   */
      296     1676    1   MMS$VGET: ENTRY(WSQN,PTR$,BSIZE,RPTR$) ALTRET;
      297     1677                                                /* Wsqn = which wsq to use            */
      298     1678                                                /* PTR$ = ptr to buffer to be mapped  */
      299     1679                                                /* Bsize = byte size of buffer        */
      300     1680                                /* RPTR$ = returned ptr to buffer relative
      301     1681                                           to the communications wsq.      */
      302     1682                                           /* Altreturns if no room to map buffer     */
      303     1683    1         IF (WSQN < %B_CWSQ1) OR (WSQN >= MM_NCWSQ+%B_CWSQ1) THEN
      304     1684    1          CALL SC_MM33;
      305     1685                                                /**/
      306     1686        /* Get the base and wsr from the descriptor referenced by 'PTR$'   */
      307     1687        /* And the byte offset out of 'PTR$'.                              */
      308     1688              %LOCK(G=MM_LOCK);
      309     1691    1         CALL SETLEN;
      310     1692    1         PGT$ = B$CPGT1$ (WSQN - %B_CWSQ1);
      311     1693        /* Now look for a hole in the wsq big enough to put our buffer into */
      312     1694    1         I = %B_CQMAX;                    /* Page # of start of buffer area     */
      313     1695    1         J = I + VBUFLEN - 1;            /* Potential ending buf page          */
      314     1696    2           DO WHILE (J < 255);
      315     1697    3             DO K = 0 TO VBUFLEN - 1;      /* See if nxt vbuflen pgs are free    */
      316     1698    3             IF PGT$->B$MAP.RPN(I+K) ~= MM_FPMC.RPN THEN
      317     1699    4               DO;
      318     1700    4               I = I + K + 1;        /* Wont fit HERE: Try again           */
      319     1701    4               J = J + K + 1;
      320     1702    4               GOTO CHKNXT;
      321     1703    4               END;
      322     1704    3             END;
      323     1705        /* If we got here, we found an unallocated gap big enough.         */
      324     1706    2           UPGT$=B$MPT$;
      325     1707    2           IF DWSR = %USERWSR
      326     1708    2           THEN UPGT$=B$UPT$;
      327     1709    2           IF DWSR = %CGWSR
      328     1710    2           THEN UPGT$=B$CGPT$;
      329     1711        /* Before we start messing up page tables, make sure the user's
PL6.E3A0      #001=MMS$WSQINIT File=MMS$WSQ.:E05TSI                              WED 07/30/97 03:23 Page:12   
      330     1712           buffer is useable...                                            */
      331     1713    3             DO K = 0 TO VBUFLEN - 1;
      332     1714    3             IF (UPGT$->B$MAP.RPN(VBUFPG+K) = MM_FPMC.RPN) THEN
      333     1715    4               DO;
      334     1716                    %UNLOCK (G=MM_LOCK);
      335     1719    4               B$NULL$->B$MAP(0) = '0'B; /* Force a trap                   */
      336     1720    4               END;
      337     1721    3             END;
      338     1722    3             DO K = 0 TO VBUFLEN - 1;      /* Map onto the buffer pgs            */
      339     1723    3             PGT$->B$PAGE.WRD(I+K) = UPGT$->B$PAGE.WRD(VBUFPG+K);
      340     1724    3             END;
      341     1725    2           PGT$->B$MAP.VLINK(I) = VBUFLEN; /* Remember size in pg tbl          */
      342     1726                %UNLOCK(G=MM_LOCK);
      343     1729    2           RPTR$ = PINCRC(PTR$,MOD(DBAS,4096));
      344     1730    2           ADDR(RPTR$)->B$PPTR.SEGID = BITBIN(%CWSQ1SID) + (WSQN - %B_CWSQ1);
      345     1731    2           ADDR(RPTR$)->B$PPTR.PG = I;
      346     1732    2           RETURN;
      347     1733    2   CHKNXT: ;
      348     1734    2           END;
      349     1735              %UNLOCK (G=MM_LOCK);
      350     1738    1         ALTRETURN;
      351     1739                                                /**/
      352     1740        %EJECT;
PL6.E3A0      #001=MMS$WSQINIT File=MMS$WSQ.:E05TSI                              WED 07/30/97 03:23 Page:13   
      353     1741                                                /**/
      354     1742        /*F*   NAME:   MMS$VREL                                            */
      355     1743        /*F*   PURPOSE: To unmap a given buffer from a communications WSQ. */
      356     1744    1   MMS$VREL: ENTRY(WSQN,PTR$) ALTRET;
      357     1745                                           /* Wsqn = which wsq contains the buffer    */
      358     1746                                                /* PTR$ = ptr to buffer in comm. Wsq  */
      359     1747                                                /* The altreturn is never taken.      */
      360     1748                                                /**/
      361     1749        /* Get the cwsq-relative starting page # of the buffer             */
      362     1750    1         VBUFPG=ADDR(PTR$)->B$PPTR.PG;
      363     1751        /* Now, get the # of pages in the buffer from the 'VLINK' part of the map */
      364     1752    1         PGT$ = B$CPGT1$ (WSQN - %B_CWSQ1);
      365     1753    1         VBUFLEN = PGT$->B$MAP.VLINK(VBUFPG);
      366     1754                                                /**/
      367     1755                                                /**/
      368     1756    2           DO I = 0 TO VBUFLEN-1;
      369     1757    2           PGT$->B$MAP (VBUFPG+I) = MM_FPMC;
      370     1758    2           END;
      371     1759    1         CALL HFC$ASSOCCLR(WSQN,VBUFPG,VBUFLEN);
      372     1760    1         RETURN;
      373     1761                                                /**/
      374     1762                                                /**/
      375     1763        %EJECT;
PL6.E3A0      #001=MMS$WSQINIT File=MMS$WSQ.:E05TSI                              WED 07/30/97 03:23 Page:14   
      376     1764        /*F*    NAME:   MMS$COMPACT
      377     1765                PURPOSE: To compress all of the segments defined by the
      378     1766                        FOS_SEG$ array in the given WSQ so that there are no
      379     1767                        inter-segment gaps and the lowest segment begins
      380     1768                        at the first available WSQ page.
      381     1769        */
      382     1770    1   MMS$COMPACT: ENTRY(WSQN) ALTRET;
      383     1771                                                /* Note: Altret is never taken        */
      384     1772        /**/
      385     1773        /* Begin by sorting a table of indices into FOS_SEG$ so that they  */
      386     1774        /* will yeild the FOS_SEG$ pointers in ascending order of buffer   */
      387     1775        /* location.                                                       */
      388     1776    2           DO I = 0 TO FOSS_MAX#;
      389     1777    2           SORT_SEGS(I) = I;
      390     1778    2           END;
      391     1779    2           DO I = 0 TO FOSS_MAX# - 1;
      392     1780    3             DO J = 0 TO FOSS_MAX# - 1;
      393     1781    3             IF FOS_SEGPTR.PG(SORT_SEGS(J)) > FOS_SEGPTR.PG(SORT_SEGS(J+1)) THEN
      394     1782    4               DO;
      395     1783    4               K = SORT_SEGS(J);
      396     1784    4               SORT_SEGS(J) = SORT_SEGS(J+1);
      397     1785    4               SORT_SEGS(J+1) = K;
      398     1786    4               END;
      399     1787    3             END;
      400     1788    2           END;
      401     1789        /* Okay - we're sorted.  Now compress the buffers (segments).      */
      402     1790    1         PGT$ = B$CPGT1$ (WSQN - %B_CWSQ1);
      403     1791    1         PREV_SEG_END = %B_CQMAX;
      404     1792    2           DO I = 0 TO FOSS_MAX#;
      405     1793    2           IF FOS_SEG$(SORT_SEGS(I)) ~= ADDR(NIL) THEN
      406     1794    3             DO;
      407     1795    3             VBUFPG = FOS_SEGPTR.PG(SORT_SEGS(I));
      408     1796    3             VBUFLEN = PGT$->B$MAP.VLINK(VBUFPG);
      409     1797    3             IF VBUFPG > PREV_SEG_END + 1 THEN
      410     1798    4               DO;
      411     1799    5                 DO J = 1 TO VBUFLEN;
      412     1800    5                 PGT$->B$MAP(PREV_SEG_END+J) = PGT$->B$MAP(VBUFPG+J-1);
PL6.E3A0      #001=MMS$WSQINIT File=MMS$WSQ.:E05TSI                              WED 07/30/97 03:23 Page:15   
      413     1801    5                 PGT$->B$MAP(VBUFPG+J-1) = MM_FPMC;
      414     1802    5                 END;
      415     1803    4               FOS_SEGPTR.PG(SORT_SEGS(I)) = PREV_SEG_END + 1;
      416     1804    4               END;
      417     1805    3             PREV_SEG_END = PREV_SEG_END + VBUFLEN;
      418     1806    3             END;
      419     1807    2           END;
      420     1808    1         CALL HFC$ASSOCCLR(WSQN,0,16384); /*MAX Dense PT*/
      421     1809    1         RETURN;
      422     1810        /**/
      423     1811        %EJECT;
PL6.E3A0      #001=MMS$WSQINIT File=MMS$WSQ.:E05TSI                              WED 07/30/97 03:23 Page:16   
      424     1812        /**/
      425     1813        /*F*    NAME:   MMS$SETUP_BUF
      426     1814                PURPOSE: To build a pair of page table words and a pointer
      427     1815                        such that if the page table words are placed into
      428     1816                        the two map words reserved in the comgroup context
      429     1817                        area, the returned pointer will access the same buffer
      430     1818                        as that defined by the input parameters PTR$ and
      431     1819                        BSIZE, but via the comgroup context page table.    */
      432     1820        /**/
      433     1821    1   MMS$SETUP_BUF: ENTRY(WSQN,PTR$,BSIZE,RPTR$,PTWDS) ALTRET;
      434     1822                                                /* Wsqn is unused for this entry      */
      435     1823    1         CALL SETLEN;
      436     1824        /**/
      437     1825        /**/
      438     1826    1         UPGT$=B$MPT$;
      439     1827    1         IF DWSR = %USERWSR
      440     1828    1         THEN UPGT$=B$UPT$;
      441     1829    1         PTWDS.WD1 = UPGT$->B$MAP(VBUFPG);
      442     1830    1         IF VBUFLEN = 1 THEN
      443     1831    1          PTWDS.WD2 = MM_FPMC;
      444     1832    1         ELSE PTWDS.WD2 = UPGT$->B$MAP(VBUFPG+1);
      445     1833    1         BOFFSET=MOD(BOFFSET+DBAS,4096);
      446     1834    1         RPTR$ = PINCRC(B$CGCTXT$,BOFFSET);
      447     1835    1         RETURN;
      448     1836        /**/
      449     1837    1   SETLEN:PROC;
      450     1838    2         CALL MMA$WHERE(PTR$,DBAS,BOFFSET,DWSR);
      451     1839    2         VBUFPG = (DBAS + BOFFSET)/4096;
      452     1840    2         VBUFLEN = ((DBAS + BOFFSET + BSIZE - 1)/4096) - VBUFPG + 1;
      453     1841    2   END SETLEN;
      454     1842        /**/
      455     1843        /**/
      456     1844    1   END MMS$WSQINIT;

PL6.E3A0      #001=MMS$WSQINIT File=MMS$WSQ.:E05TSI                              WED 07/30/97 03:23 Page:17   
--  Include file information  --

   FOS_DATA_R.:E05TOU  cannot be made into a system file and is referenced.
   B$MAP.:E05TOU  cannot be made into a system file and is referenced.
   MM_MACRO_M.:E05TOU  is referenced.
   B_STRINGS_C.:E05TOU  is referenced.
   MM$SYSGEN.:E05TOU  is referenced.
   M_INFO_C.:E05TOU  is referenced.
   MM_DATA_R.:E05TOU  cannot be made into a system file and is referenced.
   HF_LOCK_C.:E05TOU  cannot be made into a system file and is referenced.
   HF_DATA_R.:E05TOU  cannot be made into a system file and is referenced.
   B_MACROS_C.:E05TOU  is referenced.
   B_SEGIDS_C.:E05TOU  is referenced.
   S$WSPTD.:E05TOU  cannot be made into a system file and is referenced.
   S_WSPTD_R.:E05TOU  cannot be made into a system file and is referenced.
   FOS_SUBS_C.:E05TOU  is referenced.
      No diagnostics issued in procedure MMS$WSQINIT.

   Procedure MMS$WSQINIT requires 751 words for executable code.
   Procedure MMS$WSQINIT requires 46 words of local(AUTO) storage.

    No errors detected in file MMS$WSQ.:E05TSI    .

PL6.E3A0      #001=MMS$WSQINIT File=MMS$WSQ.:E05TSI                              WED 07/30/97 03:23 Page:18   

 Object Unit name= MMS$WSQINIT                                File name= MMS$WSQ.:E05TOU
 UTS= JUL 30 '97 03:23:50.88 WED                              Compiler= PL-6/E31         Sev=      00
 SharedLib= :SHARED_SYSTEM                                    Alt SharedLib=


    ****  Control sections  ****

 Sect   Type Bound  Init  Size OctSiz  Section name(segment info)
    0   Proc  even  none   751   1357  MMS$WSQINIT
    1  RoData even  none    18     22  MMS$WSQINIT

    ****  Entry defs  ****

                              Check   Calling
                             calling  sequence
  Sect OctLoc Primary Altret sequence   type   Parms  Name
     0      0   yes    yes     yes      Std        5  MMS$WSQINIT
     0    261          yes     yes      Std        1  MMS$WSQSETUP
     0    450          yes     yes      Std        1  MMS$WSQMAP
     0    540          yes     yes      Std        3  MMS$GETCQ
     0    621          yes     yes      Std        4  MMS$VGET
     0   1033          yes     yes      Std        2  MMS$VREL
     0   1103          yes     yes      Std        1  MMS$COMPACT
     0   1260          yes     yes      Std        5  MMS$SETUP_BUF
PL6.E3A0      #001=MMS$WSQINIT File=MMS$WSQ.:E05TSI                              WED 07/30/97 03:23 Page:19   

  ****  Entry refs  ****

         Check        Calling
        calling       sequence
Altret sequence SRef   type   Args  Name
 yes     yes           Std       2 MMB$GPP
 yes     yes           Std       4 MME$CVM
         yes           Std       5 MMF$FIXLS
         yes           Std       3 HFC$ASSOCCLR
         yes           Std       1 HFC$UNLOCK
         yes           Std       1 HFC$LOCK
         yes           Std       4 MMA$WHERE
                       nStd      0 X66_AUTO_5
                       Std       0 B_CONSPOOL_D
                       nStd      0 X66_ARET
                       nStd      0 X66_AALT

  ****  Data refs  ****

  Flags:  r = read only, s = secondary
Flgs Name                             Flgs Name                             Flgs Name
     SC_MM33                               S_WSPTD                               HW_PTB_UNITS
     HW_WSQ0PT                             MM_LOCK                          r    MM_BYP$
     MM_NCWSQ                              MM_NCQPGS                             MM_FPMC
     FOS_SEG$                         r    B$CWSQ1$                         r    B$CPGT1$
r    B$WINDOW$                        r    B$LS$                            r    B$CGPT$
r    B$MPT$                           r    B$UPT$                           r    B$SLV1PT$
r    B$NULL$                          r    B$CGCTXT$                        r    B$PPUT$
r    B$WSQ0PT$                        r    B$IPHYMAP$                            S_NSCPU
     IT_SCPUWSPTD                          B_VECTNIL

  ****  Segment refs  ****

  Flags:  r = read only, s = secondary
Flgs Name                             Flgs Name                             Flgs Name
     ASLENTSID                             ISSID
PL6.E3A0      #001=MMS$WSQINIT File=MMS$WSQ.:E05TSI                              WED 07/30/97 03:23 Page:20   


        1        1        /*M* MMS$WSQ Communications WSQ management */
        2        2        /*T***********************************************************/
        3        3        /*T*                                                         */
        4        4        /*T* Copyright (c) Bull HN Information Systems Inc., 1997    */
        5        5        /*T*                                                         */
        6        6        /*T***********************************************************/
        7        7       /*X* DMC,PLM=6,IND=0,IDT=2,SDI=2,CTI=0,ENU=0,AND,DCI=4,CSU=2,ECU=4,THI=0,DTI=0,STI=1
                 7        ,IAD=0,PRB */
        8        8        /**/
        9        9        /*P* NAME:         MMS$WSQ
       10       10             PURPOSE:      To manage communications working space quarters
       11       11        */
       12       12        MMS$WSQINIT: PROC(WSQN,PTR$,BSIZE,RPTR$,PTWDS) ALTRET;

     12  0 000000   000000 700200 xent  MMS$WSQINIT  TSX0  ! X66_AUTO_5
         0 000001   000056 000005                    ZERO    46,5

       13       13        /**/
       14       14
       15       15
       16       16
       17       17        /**/
       18       18        /* INCLUDES */
       19       19        /**/
       20       20        %INCLUDE FOS_SUBS_C;
       21       37        %INCLUDE S_WSPTD_R;                     /* Workspace page table directory     */
       22       53        %INCLUDE S$WSPTD;
       23       62        %INCLUDE B_SEGIDS_C;                    /* System segid definitions           */
       24      601        %INCLUDE B_MACROS_C;                    /* System macros                      */
       25      712        %INCLUDE HF_DATA_R;
       26      755        %INCLUDE HF_LOCK_C;
       27      769        %INCLUDE MM_DATA_R;                     /* Mm-specific data                   */
       28     1289        %INCLUDE B$MAP;                         /* Based definition of page table     */
       29     1388        %INCLUDE FOS_DATA_R;                    /* Fos data                           */
       30     1398
       31     1399
PL6.E3A0      #001=MMS$WSQINIT File=MMS$WSQ.:E05TSI                              WED 07/30/97 03:23 Page:21   
       32     1400
       33     1401        /**/
       34     1402        /* PARAMETERS */
       35     1403        /**/
       36     1404    1   DCL WSQN UBIN;                     /* Wsq # or # of wsqs, depending on entry  */
       37     1405    1   DCL PTR$ PTR;                           /* PTR: Use depends on entry point    */
       38     1406    1   DCL PTPPNO REDEF PTR$ UBIN;
       39     1407    1   DCL BSIZE SBIN;                         /* # of bytes in user's buffer        */
       40     1408    1   DCL CQPAGE REDEF BSIZE SBIN;            /* ...OR page # to get                */
       41     1409    1   DCL RPTR$ PTR;                     /* Comm wsq-relative ptr to user buffer    */
       42     1410    1   DCL 1 PTWDS ALIGNED,
       43     1411    1         2 WD1,
       44     1412    1           3 PPNO UBIN(18) UNAL,
       45     1413    1           3 * UBIN(18) UNAL,
       46     1414    1         2 WD2,
       47     1415    1           3 PPNO UBIN(18) UNAL,
       48     1416    1           3 * UBIN(18) UNAL;
       49     1417                                                /**/
       50     1418
       51     1419
       52     1420
       53     1421        /**/
       54     1422        /* BASED STRUCTURES */
       55     1423        /**/
       56     1424    1   DCL 1 B$PPTR BASED ALIGNED,
       57     1425    1         2 PG UBIN(8) UNAL,
       58     1426    1         2 BYT UBIN(12) UNAL,
       59     1427    1         2 * UBIN(4) UNAL,
       60     1428    1         2 SEGID UBIN(12) UNAL;
       61     1429
       62     1430
       63     1431
       64     1432        /**/
       65     1433        /* AUTO */
       66     1434        /**/
       67     1435    1   DCL MAPPGS SBIN;
       68     1436    1   DCL CWSQ SBIN;
PL6.E3A0      #001=MMS$WSQINIT File=MMS$WSQ.:E05TSI                              WED 07/30/97 03:23 Page:22   
       69     1437    1   DCL I SBIN;
       70     1438    1   DCL J SBIN;
       71     1439    1   DCL K SBIN;
       72     1440    1   DCL TMP UBIN;
       73     1441    1   DCL WSPTD$ PTR;
       74     1442    1   DCL PPNO SBIN;
       75     1443    1   DCL VBUFPG SBIN;
       76     1444    1   DCL VBUFLEN SBIN;
       77     1445    1   DCL PGT$ PTR;
       78     1446    1   DCL PGTX REDEF PGT$ UBIN;
       79     1447    1   DCL UPGT$ PTR;
       80     1448    1   DCL CSID SBIN;
       81     1449    1   DCL PSID SBIN;
       82     1450    1   DCL PTLOC SBIN;
       83     1451    1   DCL ERR SBIN;
       84     1452    1   DCL DBAS SBIN;
       85     1453    1   DCL BOFFSET SBIN;
       86     1454    1   DCL DWSR SBIN;
       87     1455    1   DCL PREV_SEG_END UBIN;
       88     1456    1   DCL SORT_SEGS(0:FOSS_MAX#) UBIN WORD;
       89     1457
       90     1458
       91     1459
       92     1460        /**/
       93     1461        /* REFS */
       94     1462        /**/
       95     1463    1   DCL HFC$ASSOCCLR  ENTRY(3);
       96     1464    1   DCL MMA$WHERE     ENTRY(4);
       97     1465    1   DCL MMB$FPP       ENTRY(1) ALTRET;
       98     1466    1   DCL MMB$GPP       ENTRY(2) ALTRET;
       99     1467    1   DCL MME$CVM       ENTRY(4) ALTRET;
      100     1468    1   DCL MMF$FIXLS     ENTRY(5);
      101     1469    1   DCL SC_MM30       ENTRY    CONV(2,0);
      102     1470    1   DCL SC_MM31       ENTRY    CONV(2,0);
      103     1471    1   DCL SC_MM32       ENTRY    CONV(2,0);
      104     1472    1   DCL SC_MM33       ENTRY    CONV(2,0);
      105     1473    1   DCL SC_MM34       ENTRY    CONV(2,0);
PL6.E3A0      #001=MMS$WSQINIT File=MMS$WSQ.:E05TSI                              WED 07/30/97 03:23 Page:23   
      106     1474    1   DCL SC_MM35_S     ENTRY    CONV(2,0);
      107     1475    1   DCL SC_MM36       ENTRY    CONV(2,0);
      108     1476    1   DCL SC_MM37       ENTRY    CONV(2,0);
      109     1477    1   DCL SC_MM42       ENTRY    CONV(2,0);
      110     1478        /**/
      111     1479    1   DCL B$CWSQ1$(0:0) PTR SYMREF READONLY;
      112     1480    1   DCL B$CPGT1$(0:0) PTR SYMREF READONLY;
      113     1481    1   DCL B$WINDOW$ PTR SYMREF READONLY;
      114     1482    1   DCL B$LS$ PTR SYMREF READONLY;
      115     1483    1   DCL B$CGPT$ PTR SYMREF READONLY;
      116     1484    1   DCL B$MPT$ PTR SYMREF READONLY;
      117     1485    1   DCL B$UPT$ PTR SYMREF READONLY;
      118     1486    1   DCL B$SLV1PT$ PTR SYMREF READONLY;
      119     1487    1   DCL B$NULL$ PTR SYMREF READONLY;
      120     1488    1   DCL B$CGCTXT$ PTR SYMREF READONLY;
      121     1489    1   DCL B$PPUT$ PTR SYMREF READONLY;
      122     1490    1   DCL B$WSQ0PT$ PTR SYMREF READONLY;
      123     1491    1   DCL B$IPHYMAP$ PTR SYMREF READONLY;
      124     1492    1   DCL S_NSCPU SBIN SYMREF;
      125     1493    1   DCL IT_SCPUWSPTD(0:3) UBIN SYMREF;
      126     1494        /**/
      127     1495        %EJECT;
PL6.E3A0      #001=MMS$WSQINIT File=MMS$WSQ.:E05TSI                              WED 07/30/97 03:23 Page:24   
      128     1496                                                /**/
      129     1497        /*F*   NAME:   MMS$WSQINIT                                         */
      130     1498        /*F*   PURPOSE: To initialize a given number of WSQ's for use by   */
      131     1499        /*,*           communications.                                     */
      132     1500                                                /* Wsqn is # of wsq's to initialize   */
      133     1501                                                /* Altreturn is never taken           */
      134     1502    1         MM_NCWSQ = WSQN;                /* Set # of cwsq's to be used         */

   1502  0 000002   200003 470500                    LDP0    @WSQN,,AUTO
         0 000003   000000 235100                    LDA     0,,PR0
         0 000004   000000 755000 xsym               STA     MM_NCWSQ

      135     1503    1         MAPPGS = (WSQN+3) / 4;          /* # of map pages required for wsq's  */

   1503  0 000005   000000 236100                    LDQ     0,,PR0
         0 000006   000003 036007                    ADLQ    3,DL
         0 000007   000002 772000                    QRL     2
         0 000010   200010 756100                    STQ     MAPPGS,,AUTO

      136     1504    1         CWSQ = %B_CWSQ1;                 /* Start with the first cwsq          */

   1504  0 000011   000015 235007                    LDA     13,DL
         0 000012   200011 755100                    STA     CWSQ,,AUTO

      137     1505    1         CSID = BITBIN(%CWSQ1SID);

   1505  0 000013   006055 235007                    LDA     3117,DL
         0 000014   200024 755100                    STA     CSID,,AUTO

      138     1506    1         PSID = BITBIN(%CPGT1SID);

   1506  0 000015   006075 235007                    LDA     3133,DL
         0 000016   200025 755100                    STA     PSID,,AUTO

      139     1507    1         PTLOC = %CWSQPTLO * 4096;       /* Byte loc of cwsq1 pgtbl in mon wsq */

   1507  0 000017   000000 235000 1                  LDA     0
PL6.E3A0      #001=MMS$WSQINIT File=MMS$WSQ.:E05TSI                              WED 07/30/97 03:23 Page:25   
         0 000020   200026 755100                    STA     PTLOC,,AUTO

      140     1508                                                /**/
      141     1509        /* Get 1 page for each 4 wsq's, map each in turn into the monitor  */
      142     1510        /* 'WINDOW' at fmseglo, enter the page(s) permanently into the     */
      143     1511        /* Monitor's map starting at cwsqptlo. Initialize each map and     */
      144     1512        /* Each linkage seg descriptor for both the cwsq itself and its    */
      145     1513        /* Page table.                                                     */
      146     1514                                                /**/
      147     1515    2           DO I = 1 TO MAPPGS;

   1515  0 000021   000001 235007                    LDA     1,DL
         0 000022   200012 755100                    STA     I,,AUTO
         0 000023   000255 710000 0                  TRA     s:1558+1

      148     1516    2           CALL MMB$GPP(PPNO,%MONWSQ);

   1516  0 000024   000001 236000 1                  LDQ     1
         0 000025   200051 756100                    STQ     SORT_SEGS+13,,AUTO
         0 000026   200017 630500                    EPPR0   PPNO,,AUTO
         0 000027   200050 450500                    STP0    SORT_SEGS+12,,AUTO
         0 000030   200050 630500                    EPPR0   SORT_SEGS+12,,AUTO
         0 000031   000020 631400 xsym               EPPR1   B_VECTNIL+16
         0 000032   000000 701000 xent               TSX1    MMB$GPP
         0 000033   000000 011000                    NOP     0

      149     1517    2           B$PPUT$->MM$PPUT.COMM(PPNO) = '1'B;   /* Set who page belongs to */

   1517  0 000034   000000 470400 xsym               LDP0    B$PPUT$
         0 000035   200017 720100                    LXL0    PPNO,,AUTO
         0 000036   001000 236003                    LDQ     512,DU
         0 000037   000000 256110                    ORSQ    0,X0,PR0

      150     1518    2           CALL MME$CVM(%MONWSQ,%WINDOWLO,PPNO,ERR);

   1518  0 000040   200027 631500                    EPPR1   ERR,,AUTO
         0 000041   200053 451500                    STP1    SORT_SEGS+15,,AUTO
PL6.E3A0      #001=MMS$WSQINIT File=MMS$WSQ.:E05TSI                              WED 07/30/97 03:23 Page:26   
         0 000042   200017 633500                    EPPR3   PPNO,,AUTO
         0 000043   200052 453500                    STP3    SORT_SEGS+14,,AUTO
         0 000044   000004 237000 1                  LDAQ    4
         0 000045   200050 757100                    STAQ    SORT_SEGS+12,,AUTO
         0 000046   200050 630500                    EPPR0   SORT_SEGS+12,,AUTO
         0 000047   000022 631400 xsym               EPPR1   B_VECTNIL+18
         0 000050   000000 701000 xent               TSX1    MME$CVM
         0 000051   000000 011000                    NOP     0

      151     1519                %MAP (P$=B$MPT$,VPNO="%CWSQPTLO+I-1");

   1520  0 000052   000000 234000 xsym               SZN     HW_WSQ0PT
         0 000053   000063 605000 0                  TPL     s:1520+9

   1520  0 000054   000000 470400 xsym               LDP0    B$WSQ0PT$
         0 000055   200017 720100                    LXL0    PPNO,,AUTO
         0 000056   000000 221110                    LDX1    0,X0,PR0
         0 000057   000000 471400 xsym               LDP1    B$MPT$
         0 000060   200012 722100                    LXL2    I,,AUTO
         0 000061   100567 741112                    STX1    375,X2,PR1
         0 000062   000067 710000 0                  TRA     s:1523

   1520  0 000063   200017 720100                    LXL0    PPNO,,AUTO
         0 000064   000000 470400 xsym               LDP0    B$MPT$
         0 000065   200012 721100                    LXL1    I,,AUTO
         0 000066   000567 740111                    STX0    375,X1,PR0

      152     1522                %SAC (P$=B$MPT$,VPNO="%CWSQPTLO+I-1",AC="%PGINMEM|%PGWRITE");

   1523  0 000067   000000 470400 xsym               LDP0    B$MPT$
         0 000070   200012 720100                    LXL0    I,,AUTO
         0 000071   000567 236110                    LDQ     375,X0,PR0
         0 000072   000003 376000 1                  ANQ     3
         0 000073   000060 276007                    ORQ     48,DL
         0 000074   000567 756110                    STQ     375,X0,PR0

      153     1525        /* Fix up the slave page tables to contain the cwsq page tables */
PL6.E3A0      #001=MMS$WSQINIT File=MMS$WSQ.:E05TSI                              WED 07/30/97 03:23 Page:27   
      154     1526    2           PGT$ = B$SLV1PT$;

   1526  0 000075   000000 236000 xsym               LDQ     B$SLV1PT$
         0 000076   200022 756100                    STQ     PGT$,,AUTO

      155     1527    3             DO J = 1 TO S_NSCPU;

   1527  0 000077   000001 235007                    LDA     1,DL
         0 000100   200013 755100                    STA     J,,AUTO
         0 000101   000113 710000 0                  TRA     s:1530+1

      156     1528    3             PGT$->B$PAGE.WRD(%CWSQPTLO+I-1) = B$MPT$->B$PAGE.WRD(%CWSQPTLO+I-1);

   1528  0 000102   000000 470400 xsym               LDP0    B$MPT$
         0 000103   200012 720100                    LXL0    I,,AUTO
         0 000104   200022 471500                    LDP1    PGT$,,AUTO
         0 000105   000567 235110                    LDA     375,X0,PR0
         0 000106   100567 755110                    STA     375,X0,PR1

      157     1529    3             PGTX = PGTX + 1;

   1529  0 000107   200022 236100                    LDQ     PGT$,,AUTO
         0 000110   000001 036007                    ADLQ    1,DL
         0 000111   200022 756100                    STQ     PGT$,,AUTO

      158     1530    3             END;

   1530  0 000112   200013 054100                    AOS     J,,AUTO
         0 000113   200013 236100                    LDQ     J,,AUTO
         0 000114   000000 116000 xsym               CMPQ    S_NSCPU
         0 000115   000102 604400 0                  TMOZ    s:1528

      159     1531        /* Initialize the cwsq page tables to all %FPMC's */
      160     1532    2           PGT$ = B$WINDOW$;             /* Point to 1st page tbl in window    */

   1532  0 000116   000000 236000 xsym               LDQ     B$WINDOW$
         0 000117   200022 756100                    STQ     PGT$,,AUTO
PL6.E3A0      #001=MMS$WSQINIT File=MMS$WSQ.:E05TSI                              WED 07/30/97 03:23 Page:28   

      161     1533                                                /**/
      162     1534    3             DO J = 0 TO 3;                /* Do for each pg tbl in the page     */

   1534  0 000120   200013 450100                    STZ     J,,AUTO

      163     1535    4               DO K = 0 TO 255;

   1535  0 000121   200014 450100                    STZ     K,,AUTO

      164     1536    4               PGT$->B$PAGE.WRD(K) = BITBIN(MM_FPMC);

   1536  0 000122   200022 470500                    LDP0    PGT$,,AUTO
         0 000123   200014 720100                    LXL0    K,,AUTO
         0 000124   000000 235000 xsym               LDA     MM_FPMC
         0 000125   000000 755110                    STA     0,X0,PR0

      165     1537    4               END;

   1537  0 000126   200014 054100                    AOS     K,,AUTO
         0 000127   200014 235100                    LDA     K,,AUTO
         0 000130   000377 115007                    CMPA    255,DL
         0 000131   000122 604400 0                  TMOZ    s:1536

      166     1538    3             CALL MMF$FIXLS(B$LS$,PSID,1,PTLOC,1023);

   1538  0 000132   000007 236000 1                  LDQ     7
         0 000133   200054 756100                    STQ     SORT_SEGS+16,,AUTO
         0 000134   200026 631500                    EPPR1   PTLOC,,AUTO
         0 000135   200053 451500                    STP1    SORT_SEGS+15,,AUTO
         0 000136   000001 236000 1                  LDQ     1
         0 000137   200052 756100                    STQ     SORT_SEGS+14,,AUTO
         0 000140   200025 633500                    EPPR3   PSID,,AUTO
         0 000141   200051 453500                    STP3    SORT_SEGS+13,,AUTO
         0 000142   000010 236000 1                  LDQ     8
         0 000143   200050 756100                    STQ     SORT_SEGS+12,,AUTO
         0 000144   200050 630500                    EPPR0   SORT_SEGS+12,,AUTO
PL6.E3A0      #001=MMS$WSQINIT File=MMS$WSQ.:E05TSI                              WED 07/30/97 03:23 Page:29   
         0 000145   000023 631400 xsym               EPPR1   B_VECTNIL+19
         0 000146   000000 701000 xent               TSX1    MMF$FIXLS
         0 000147   000000 011000                    NOP     0

      167     1539    3             WSPTD$ = PINCRW(B$WINDOW$,1024);

   1539  0 000150   000000 236000 xsym               LDQ     B$WINDOW$
         0 000151   002000 036003                    ADLQ    1024,DU
         0 000152   200016 756100                    STQ     WSPTD$,,AUTO

      168     1540        /* Update each slave cpu's wsptd */
      169     1541    4               DO K = 0 TO S_NSCPU;

   1541  0 000153   200014 450100                    STZ     K,,AUTO
         0 000154   000227 710000 0                  TRA     s:1550+1

      170     1542    4               CALL MME$CVM(%MONWSQ,%WINDOWLO+1,IT_SCPUWSPTD(K),ERR);

   1542  0 000155   200027 630500                    EPPR0   ERR,,AUTO
         0 000156   200053 450500                    STP0    SORT_SEGS+15,,AUTO
         0 000157   200014 720100                    LXL0    K,,AUTO
         0 000160   000000 631410 xsym               EPPR1   IT_SCPUWSPTD,X0
         0 000161   200052 451500                    STP1    SORT_SEGS+14,,AUTO
         0 000162   000012 237000 1                  LDAQ    10
         0 000163   200050 757100                    STAQ    SORT_SEGS+12,,AUTO
         0 000164   200050 630500                    EPPR0   SORT_SEGS+12,,AUTO
         0 000165   000022 631400 xsym               EPPR1   B_VECTNIL+18
         0 000166   000000 701000 xent               TSX1    MME$CVM
         0 000167   000000 011000                    NOP     0

      171     1543    4               IF HW_WSQ0PT THEN

   1543  0 000170   000000 234000 xsym               SZN     HW_WSQ0PT
         0 000171   000207 605000 0                  TPL     s:1547

      172     1544    4                WSPTD$->S$WSPTD.BLKNO(CWSQ)=B$WSQ0PT$->B$MAP.RPN(PPNO) *

PL6.E3A0      #001=MMS$WSQINIT File=MMS$WSQ.:E05TSI                              WED 07/30/97 03:23 Page:30   
   1544  0 000172   002000 236007                    LDQ     1024,DL
         0 000173   000000 506000 xsym               DIV     HW_PTB_UNITS
         0 000174   200050 756100                    STQ     SORT_SEGS+12,,AUTO
         0 000175   000000 470400 xsym               LDP0    B$WSQ0PT$
         0 000176   200017 720100                    LXL0    PPNO,,AUTO
         0 000177   000000 236110                    LDQ     0,X0,PR0
         0 000200   000022 772000                    QRL     18
         0 000201   200050 402100                    MPY     SORT_SEGS+12,,AUTO
         0 000202   000000 621006                    EAX1    0,QL
         0 000203   200016 471500                    LDP1    WSPTD$,,AUTO
         0 000204   200011 722100                    LXL2    CWSQ,,AUTO
         0 000205   100000 741112                    STX1    0,X2,PR1
         0 000206   000216 710000 0                  TRA     s:1548

      173     1545    4                (1024 / HW_PTB_UNITS);
      174     1546    4               ELSE
      175     1547    4                WSPTD$->S$WSPTD.BLKNO(CWSQ) = PPNO * (1024 / HW_PTB_UNITS);

   1547  0 000207   002000 236007                    LDQ     1024,DL
         0 000210   000000 506000 xsym               DIV     HW_PTB_UNITS
         0 000211   200017 402100                    MPY     PPNO,,AUTO
         0 000212   000000 620006                    EAX0    0,QL
         0 000213   200016 470500                    LDP0    WSPTD$,,AUTO
         0 000214   200011 721100                    LXL1    CWSQ,,AUTO
         0 000215   000000 740111                    STX0    0,X1,PR0

      176     1548    4               WSPTD$->S$WSPTD.P(CWSQ) = %TRUE;

   1548  0 000216   200016 470500                    LDP0    WSPTD$,,AUTO
         0 000217   200011 720100                    LXL0    CWSQ,,AUTO
         0 000220   100000 236007                    LDQ     32768,DL
         0 000221   000000 256110                    ORSQ    0,X0,PR0

      177     1549    4               WSPTD$->S$WSPTD.NBLKS(CWSQ) = 16;

   1549  0 000222   000000 236110                    LDQ     0,X0,PR0
         0 000223   000014 376000 1                  ANQ     12
PL6.E3A0      #001=MMS$WSQINIT File=MMS$WSQ.:E05TSI                              WED 07/30/97 03:23 Page:31   
         0 000224   000020 276007                    ORQ     16,DL
         0 000225   000000 756110                    STQ     0,X0,PR0

      178     1550    4               END;

   1550  0 000226   200014 054100                    AOS     K,,AUTO
         0 000227   200014 236100                    LDQ     K,,AUTO
         0 000230   000000 116000 xsym               CMPQ    S_NSCPU
         0 000231   000155 604400 0                  TMOZ    s:1542

      179     1551    3             CWSQ = CWSQ + 1;

   1551  0 000232   200011 054100                    AOS     CWSQ,,AUTO

      180     1552    3             IF CWSQ > WSQN+%B_CWSQ1-1 THEN GOTO EXITLOOPS; /* All done         */

   1552  0 000233   200003 470500                    LDP0    @WSQN,,AUTO
         0 000234   000000 236100                    LDQ     0,,PR0
         0 000235   000014 036007                    ADLQ    12,DL
         0 000236   000241 604000 0                  TMI     s:1553
         0 000237   200011 116100                    CMPQ    CWSQ,,AUTO
         0 000240   000260 604000 0                  TMI     EXITLOOPS

      181     1553    3             CSID = CSID + 1;

   1553  0 000241   200024 054100                    AOS     CSID,,AUTO

      182     1554    3             PSID = PSID + 1;

   1554  0 000242   200025 054100                    AOS     PSID,,AUTO

      183     1555    3             PTLOC = PTLOC + 1024;

   1555  0 000243   002000 236007                    LDQ     1024,DL
         0 000244   200026 056100                    ASQ     PTLOC,,AUTO

      184     1556    3             PGT$ = PINCRW(PGT$,256);
PL6.E3A0      #001=MMS$WSQINIT File=MMS$WSQ.:E05TSI                              WED 07/30/97 03:23 Page:32   

   1556  0 000245   200022 236100                    LDQ     PGT$,,AUTO
         0 000246   000400 036003                    ADLQ    256,DU
         0 000247   200022 756100                    STQ     PGT$,,AUTO

      185     1557    3             END;

   1557  0 000250   200013 054100                    AOS     J,,AUTO
         0 000251   200013 235100                    LDA     J,,AUTO
         0 000252   000003 115007                    CMPA    3,DL
         0 000253   000121 604400 0                  TMOZ    s:1535

      186     1558    2           END;

   1558  0 000254   200012 054100                    AOS     I,,AUTO
         0 000255   200012 236100                    LDQ     I,,AUTO
         0 000256   200010 116100                    CMPQ    MAPPGS,,AUTO
         0 000257   000024 604400 0                  TMOZ    s:1516

   1553  0 000260                       EXITLOOPS    null
      187     1559    1   EXITLOOPS:;
      188     1560    1         RETURN;

   1560  0 000260   000000 702200 xent               TSX2  ! X66_ARET

      189     1561        /**/
      190     1562                                                /**/
      191     1563        %EJECT;
PL6.E3A0      #001=MMS$WSQINIT File=MMS$WSQ.:E05TSI                              WED 07/30/97 03:23 Page:33   
      192     1564    1   MMS$WSQSETUP: ENTRY(WSQN) ALTRET;

   1564  0 000261   000000 700200 xent  MMS$WSQSETUP TSX0  ! X66_AUTO_5
         0 000262   000056 000005                    ZERO    46,5

      193     1565
      194     1566        /* This entry sets up the page table for a group of four FEI
      195     1567             interfaces.  It returns the physical page of the PT */
      196     1568
      197     1569    1         CWSQ = %B_CWSQ13;                 /* Start with the first cwsq          */

   1569  0 000263   000031 235007                    LDA     25,DL
         0 000264   200011 755100                    STA     CWSQ,,AUTO

      198     1570    1         CSID = BITBIN(%CWSQ13SID);

   1570  0 000265   006071 236007                    LDQ     3129,DL
         0 000266   200024 756100                    STQ     CSID,,AUTO

      199     1571    1         PSID = BITBIN(%CPGT13SID);

   1571  0 000267   006111 235007                    LDA     3145,DL
         0 000270   200025 755100                    STA     PSID,,AUTO

      200     1572    1         PTLOC = (%CWSQPTLO+3) * 4096;       /* Byte loc of cwsq1 pgtbl in mon wsq */

   1572  0 000271   000015 235000 1                  LDA     13
         0 000272   200026 755100                    STA     PTLOC,,AUTO

      201     1573                                                /**/
      202     1574        /* Get 1 page for each 4 wsq's, map each in turn into the monitor  */
      203     1575        /* 'WINDOW' at fmseglo */
      204     1576        /* Initialize each map and     */
      205     1577        /* Each linkage seg descriptor for both the cwsq itself and its    */
      206     1578        /* Page table.                                                     */
      207     1579                                                /**/
      208     1580    1         CALL MMB$GPP(PPNO,%MONWSQ);
PL6.E3A0      #001=MMS$WSQINIT File=MMS$WSQ.:E05TSI                              WED 07/30/97 03:23 Page:34   

   1580  0 000273   000001 236000 1                  LDQ     1
         0 000274   200051 756100                    STQ     SORT_SEGS+13,,AUTO
         0 000275   200017 630500                    EPPR0   PPNO,,AUTO
         0 000276   200050 450500                    STP0    SORT_SEGS+12,,AUTO
         0 000277   200050 630500                    EPPR0   SORT_SEGS+12,,AUTO
         0 000300   000020 631400 xsym               EPPR1   B_VECTNIL+16
         0 000301   000000 701000 xent               TSX1    MMB$GPP
         0 000302   000000 011000                    NOP     0

      209     1581    1         WSQN = PPNO;

   1581  0 000303   200017 235100                    LDA     PPNO,,AUTO
         0 000304   200003 470500                    LDP0    @WSQN,,AUTO
         0 000305   000000 755100                    STA     0,,PR0

      210     1582    1         B$PPUT$->MM$PPUT.COMM(PPNO) = '1'B;   /* Set who page belongs to */

   1582  0 000306   000000 471400 xsym               LDP1    B$PPUT$
         0 000307   200017 720100                    LXL0    PPNO,,AUTO
         0 000310   001000 236003                    LDQ     512,DU
         0 000311   100000 256110                    ORSQ    0,X0,PR1

      211     1583    1         CALL MME$CVM(%MONWSQ,%WINDOWLO,PPNO,ERR);

   1583  0 000312   200027 633500                    EPPR3   ERR,,AUTO
         0 000313   200053 453500                    STP3    SORT_SEGS+15,,AUTO
         0 000314   200017 634500                    EPPR4   PPNO,,AUTO
         0 000315   200052 454500                    STP4    SORT_SEGS+14,,AUTO
         0 000316   000004 237000 1                  LDAQ    4
         0 000317   200050 757100                    STAQ    SORT_SEGS+12,,AUTO
         0 000320   200050 630500                    EPPR0   SORT_SEGS+12,,AUTO
         0 000321   000022 631400 xsym               EPPR1   B_VECTNIL+18
         0 000322   000000 701000 xent               TSX1    MME$CVM
         0 000323   000000 011000                    NOP     0

      212     1584              %MAP (P$=B$MPT$,VPNO="%CWSQPTLO+3");
PL6.E3A0      #001=MMS$WSQINIT File=MMS$WSQ.:E05TSI                              WED 07/30/97 03:23 Page:35   

   1585  0 000324   000000 234000 xsym               SZN     HW_WSQ0PT
         0 000325   000334 605000 0                  TPL     s:1585+8

   1585  0 000326   000000 470400 xsym               LDP0    B$WSQ0PT$
         0 000327   200017 720100                    LXL0    PPNO,,AUTO
         0 000330   000000 221110                    LDX1    0,X0,PR0
         0 000331   000000 471400 xsym               LDP1    B$MPT$
         0 000332   100573 741100                    STX1    379,,PR1
         0 000333   000337 710000 0                  TRA     s:1588

   1585  0 000334   200017 720100                    LXL0    PPNO,,AUTO
         0 000335   000000 470400 xsym               LDP0    B$MPT$
         0 000336   000573 740100                    STX0    379,,PR0

      213     1587              %SAC (P$=B$MPT$,VPNO="%CWSQPTLO+3",AC="%PGINMEM|%PGWRITE");

   1588  0 000337   000000 470400 xsym               LDP0    B$MPT$
         0 000340   000060 236007                    LDQ     48,DL
         0 000341   000573 752101                    STCQ    379,'01'O,PR0

      214     1590        /* Initialize the cwsq page tables to all %FPMC's */
      215     1591    1         PGT$ = B$WINDOW$;             /* Point to 1st page tbl in window    */

   1591  0 000342   000000 236000 xsym               LDQ     B$WINDOW$
         0 000343   200022 756100                    STQ     PGT$,,AUTO

      216     1592                                                /**/
      217     1593    2           DO J = 0 TO 3;                /* Do for each pg tbl in the page     */

   1593  0 000344   200013 450100                    STZ     J,,AUTO

      218     1594    3             DO K = 0 TO 255;

   1594  0 000345   200014 450100                    STZ     K,,AUTO

      219     1595    3             PGT$->B$PAGE.WRD(K) = BITBIN(MM_FPMC);
PL6.E3A0      #001=MMS$WSQINIT File=MMS$WSQ.:E05TSI                              WED 07/30/97 03:23 Page:36   

   1595  0 000346   200022 470500                    LDP0    PGT$,,AUTO
         0 000347   200014 720100                    LXL0    K,,AUTO
         0 000350   000000 235000 xsym               LDA     MM_FPMC
         0 000351   000000 755110                    STA     0,X0,PR0

      220     1596    3             END;

   1596  0 000352   200014 054100                    AOS     K,,AUTO
         0 000353   200014 235100                    LDA     K,,AUTO
         0 000354   000377 115007                    CMPA    255,DL
         0 000355   000346 604400 0                  TMOZ    s:1595

      221     1597    2           IF HW_WSQ0PT THEN

   1597  0 000356   000000 234000 xsym               SZN     HW_WSQ0PT
         0 000357   000374 605000 0                  TPL     s:1600

      222     1598    2            S_WSPTD.BLKNO(CWSQ)=B$WSQ0PT$->B$MAP.RPN(PPNO) * (1024 / HW_PTB_UNITS);

   1598  0 000360   002000 236007                    LDQ     1024,DL
         0 000361   000000 506000 xsym               DIV     HW_PTB_UNITS
         0 000362   200050 756100                    STQ     SORT_SEGS+12,,AUTO
         0 000363   000000 471400 xsym               LDP1    B$WSQ0PT$
         0 000364   200017 720100                    LXL0    PPNO,,AUTO
         0 000365   100000 236110                    LDQ     0,X0,PR1
         0 000366   000022 772000                    QRL     18
         0 000367   200050 402100                    MPY     SORT_SEGS+12,,AUTO
         0 000370   000000 621006                    EAX1    0,QL
         0 000371   200011 722100                    LXL2    CWSQ,,AUTO
         0 000372   000000 741012 xsym               STX1    S_WSPTD,X2
         0 000373   000402 710000 0                  TRA     s:1601

      223     1599    2           ELSE
      224     1600    2            S_WSPTD.BLKNO(CWSQ) = PPNO * (1024 / HW_PTB_UNITS);

   1600  0 000374   002000 236007                    LDQ     1024,DL
PL6.E3A0      #001=MMS$WSQINIT File=MMS$WSQ.:E05TSI                              WED 07/30/97 03:23 Page:37   
         0 000375   000000 506000 xsym               DIV     HW_PTB_UNITS
         0 000376   200017 402100                    MPY     PPNO,,AUTO
         0 000377   000000 620006                    EAX0    0,QL
         0 000400   200011 721100                    LXL1    CWSQ,,AUTO
         0 000401   000000 740011 xsym               STX0    S_WSPTD,X1

      225     1601    2           S_WSPTD.P(CWSQ) = %TRUE;

   1601  0 000402   200011 720100                    LXL0    CWSQ,,AUTO
         0 000403   100000 236007                    LDQ     32768,DL
         0 000404   000000 256010 xsym               ORSQ    S_WSPTD,X0

      226     1602    2           S_WSPTD.NBLKS(CWSQ) = 16;

   1602  0 000405   000000 236010 xsym               LDQ     S_WSPTD,X0
         0 000406   000014 376000 1                  ANQ     12
         0 000407   000020 276007                    ORQ     16,DL
         0 000410   000000 756010 xsym               STQ     S_WSPTD,X0

      227     1603    2           CALL MMF$FIXLS(B$LS$,PSID,1,PTLOC,1023);

   1603  0 000411   000007 236000 1                  LDQ     7
         0 000412   200054 756100                    STQ     SORT_SEGS+16,,AUTO
         0 000413   200026 631500                    EPPR1   PTLOC,,AUTO
         0 000414   200053 451500                    STP1    SORT_SEGS+15,,AUTO
         0 000415   000001 236000 1                  LDQ     1
         0 000416   200052 756100                    STQ     SORT_SEGS+14,,AUTO
         0 000417   200025 633500                    EPPR3   PSID,,AUTO
         0 000420   200051 453500                    STP3    SORT_SEGS+13,,AUTO
         0 000421   000010 236000 1                  LDQ     8
         0 000422   200050 756100                    STQ     SORT_SEGS+12,,AUTO
         0 000423   200050 630500                    EPPR0   SORT_SEGS+12,,AUTO
         0 000424   000023 631400 xsym               EPPR1   B_VECTNIL+19
         0 000425   000000 701000 xent               TSX1    MMF$FIXLS
         0 000426   000000 011000                    NOP     0

      228     1604    2           CWSQ = CWSQ + 1;
PL6.E3A0      #001=MMS$WSQINIT File=MMS$WSQ.:E05TSI                              WED 07/30/97 03:23 Page:38   

   1604  0 000427   200011 054100                    AOS     CWSQ,,AUTO

      229     1605    2           IF CWSQ > %B_CWSQ16 THEN RETURN; /* All done         */

   1605  0 000430   200011 235100                    LDA     CWSQ,,AUTO
         0 000431   000034 115007                    CMPA    28,DL
         0 000432   000434 604400 0                  TMOZ    s:1606

   1605  0 000433   000000 702200 xent               TSX2  ! X66_ARET

      230     1606    2           CSID = CSID + 1;

   1606  0 000434   200024 054100                    AOS     CSID,,AUTO

      231     1607    2           PSID = PSID + 1;

   1607  0 000435   200025 054100                    AOS     PSID,,AUTO

      232     1608    2           PTLOC = PTLOC + 1024;

   1608  0 000436   002000 236007                    LDQ     1024,DL
         0 000437   200026 056100                    ASQ     PTLOC,,AUTO

      233     1609    2           PGT$ = PINCRW(PGT$,256);

   1609  0 000440   200022 236100                    LDQ     PGT$,,AUTO
         0 000441   000400 036003                    ADLQ    256,DU
         0 000442   200022 756100                    STQ     PGT$,,AUTO

      234     1610    2           END;

   1610  0 000443   200013 054100                    AOS     J,,AUTO
         0 000444   200013 235100                    LDA     J,,AUTO
         0 000445   000003 115007                    CMPA    3,DL
         0 000446   000345 604400 0                  TMOZ    s:1594

PL6.E3A0      #001=MMS$WSQINIT File=MMS$WSQ.:E05TSI                              WED 07/30/97 03:23 Page:39   
      235     1611    1         RETURN;

   1611  0 000447   000000 702200 xent               TSX2  ! X66_ARET

      236     1612        %EJECT;
PL6.E3A0      #001=MMS$WSQINIT File=MMS$WSQ.:E05TSI                              WED 07/30/97 03:23 Page:40   
      237     1613    1   MMS$WSQMAP: ENTRY (WSQN) ALTRET;

   1613  0 000450   000000 700200 xent  MMS$WSQMAP   TSX0  ! X66_AUTO_5
         0 000451   000056 000005                    ZERO    46,5

      238     1614
      239     1615        /* Maps the passed page table page number into the corresponding WSQs */
      240     1616    1         PPNO = WSQN;

   1616  0 000452   200003 470500                    LDP0    @WSQN,,AUTO
         0 000453   000000 235100                    LDA     0,,PR0
         0 000454   200017 755100                    STA     PPNO,,AUTO

      241     1617    1         I = %CWSQPTLO+3;

   1617  0 000455   000573 236007                    LDQ     379,DL
         0 000456   200012 756100                    STQ     I,,AUTO

      242     1618
      243     1619    1         IF PPNO = 0 THEN RETURN;

   1619  0 000457   000000 115003                    CMPA    0,DU
         0 000460   000462 601000 0                  TNZ     s:1620

   1619  0 000461   000000 702200 xent               TSX2  ! X66_ARET

      244     1620    1         IF HW_WSQ0PT THEN

   1620  0 000462   000000 234000 xsym               SZN     HW_WSQ0PT
         0 000463   000475 605000 0                  TPL     s:1623

      245     1621    1          TMP=B$IPHYMAP$->MM$IPHY_MAP(B$MPT$->B$MAP.RPN(I));

   1621  0 000464   000000 471400 xsym               LDP1    B$MPT$
         0 000465   100000 236106                    LDQ     0,QL,PR1
         0 000466   000022 772000                    QRL     18
         0 000467   000001 736000                    QLS     1
PL6.E3A0      #001=MMS$WSQINIT File=MMS$WSQ.:E05TSI                              WED 07/30/97 03:23 Page:41   
         0 000470   000000 473400 xsym               LDP3    B$IPHYMAP$
         0 000471   000100 101506                    MRL     fill='000'O
         0 000472   300000 000002                    ADSC9   0,Q,PR3                  cn=0,n=2
         0 000473   200015 000004                    ADSC9   TMP,,AUTO                cn=0,n=4
         0 000474   000501 710000 0                  TRA     s:1624

      246     1622    1         ELSE
      247     1623    1          TMP=B$MPT$->B$MAP.RPN(I);

   1623  0 000475   000000 471400 xsym               LDP1    B$MPT$
         0 000476   100000 236106                    LDQ     0,QL,PR1
         0 000477   000022 772000                    QRL     18
         0 000500   200015 756100                    STQ     TMP,,AUTO

      248     1624    1         IF TMP=PPNO THEN RETURN;

   1624  0 000501   200015 236100                    LDQ     TMP,,AUTO
         0 000502   000506 604000 0                  TMI     s:1626
         0 000503   200017 116100                    CMPQ    PPNO,,AUTO
         0 000504   000506 601000 0                  TNZ     s:1626

   1624  0 000505   000000 702200 xent               TSX2  ! X66_ARET

      249     1625
      250     1626    1         IF HW_WSQ0PT THEN

   1626  0 000506   000000 234000 xsym               SZN     HW_WSQ0PT
         0 000507   000523 605000 0                  TPL     s:1629

      251     1627    1          S_WSPTD.BLKNO(%B_CWSQ13)=B$WSQ0PT$->B$MAP.RPN(PPNO) * (1024 / HW_PTB_UNITS);

   1627  0 000510   002000 236007                    LDQ     1024,DL
         0 000511   000000 506000 xsym               DIV     HW_PTB_UNITS
         0 000512   200050 756100                    STQ     SORT_SEGS+12,,AUTO
         0 000513   000000 473400 xsym               LDP3    B$WSQ0PT$
         0 000514   200017 720100                    LXL0    PPNO,,AUTO
         0 000515   300000 236110                    LDQ     0,X0,PR3
PL6.E3A0      #001=MMS$WSQINIT File=MMS$WSQ.:E05TSI                              WED 07/30/97 03:23 Page:42   
         0 000516   000022 772000                    QRL     18
         0 000517   200050 402100                    MPY     SORT_SEGS+12,,AUTO
         0 000520   000000 621006                    EAX1    0,QL
         0 000521   000031 741000 xsym               STX1    S_WSPTD+25
         0 000522   000530 710000 0                  TRA     s:1631

      252     1628    1         ELSE
      253     1629    1          S_WSPTD.BLKNO(%B_CWSQ13)=PPNO * (1024 / HW_PTB_UNITS);

   1629  0 000523   002000 236007                    LDQ     1024,DL
         0 000524   000000 506000 xsym               DIV     HW_PTB_UNITS
         0 000525   200017 402100                    MPY     PPNO,,AUTO
         0 000526   000000 620006                    EAX0    0,QL
         0 000527   000031 740000 xsym               STX0    S_WSPTD+25

      254     1630
      255     1631    1         S_WSPTD(%B_CWSQ14)=S_WSPTD(%B_CWSQ13);

   1631  0 000530   000031 236000 xsym               LDQ     S_WSPTD+25
         0 000531   000032 756000 xsym               STQ     S_WSPTD+26

      256     1632    1         S_WSPTD(%B_CWSQ15)=S_WSPTD(%B_CWSQ13);

   1632  0 000532   000033 756000 xsym               STQ     S_WSPTD+27

      257     1633    1         S_WSPTD(%B_CWSQ16)=S_WSPTD(%B_CWSQ13);

   1633  0 000533   000034 756000 xsym               STQ     S_WSPTD+28

      258     1634    1         CALL HFC$ASSOCCLR;

   1634  0 000534   000002 631400 xsym               EPPR1   B_VECTNIL+2
         0 000535   000000 701000 xent               TSX1    HFC$ASSOCCLR
         0 000536   000000 011000                    NOP     0

      259     1635    1         RETURN;

PL6.E3A0      #001=MMS$WSQINIT File=MMS$WSQ.:E05TSI                              WED 07/30/97 03:23 Page:43   
   1635  0 000537   000000 702200 xent               TSX2  ! X66_ARET

      260     1636
      261     1637        %EJECT;
PL6.E3A0      #001=MMS$WSQINIT File=MMS$WSQ.:E05TSI                              WED 07/30/97 03:23 Page:44   
      262     1638                                                /**/
      263     1639        /* NOTE: The communications wsq's are organized as FOLLOWS:        */
      264     1640        /*     The first %B_CQMAX pages are reserved for the input/output   */
      265     1641        /*     Circular queues, whose locations will be kept track of by   */
      266     1642        /*     Their managing routines.  The remaining pages of the 256k   */
      267     1643        /*     Wsq are reserved for dynamically mapping user's buffers.    */
      268     1644                                                /**/
      269     1645        /*F*   NAME:   MMS$GETCQ                                           */
      270     1646        /*F*   PURPOSE: To get a page for a CWSQ's circular queue.         */
      271     1647    1   MMS$GETCQ: ENTRY(WSQN,PTR$,BSIZE)  ALTRET;

   1647  0 000540   000000 700200 xent  MMS$GETCQ    TSX0  ! X66_AUTO_5
         0 000541   000056 000005                    ZERO    46,5

      272     1648                                                /* Wsqn = cwsq in question            */
      273     1649                                           /* PTR$ = returned ptr to start of queue   */
      274     1650                                           /* Cqpage = page # in queue area to get    */
      275     1651                                           /* Altreturns if cant get page for queue   */
      276     1652        /*S* SCREECH_CODE: MMS-S$MM33
      277     1653             TYPE:         SCREECH
      278     1654             MESSAGE:      Bad WSQ# or BUF PTR passed to an MMS routine.
      279     1655             REMARKS:      Either the CWSQ number is illegal, or the pointer
      280     1656                           we are supposed to VGET has an illegal WSR in it. */
      281     1657                                                /**/
      282     1658    1         PGT$ = B$CPGT1$ (WSQN - %B_CWSQ1);

   1658  0 000542   200003 470500                    LDP0    @WSQN,,AUTO
         0 000543   000000 720100                    LXL0    0,,PR0
         0 000544   777763 236010 xsym               LDQ     B$CPGT1$-13,X0
         0 000545   200022 756100                    STQ     PGT$,,AUTO

      283     1659                                                /**/
      284     1660    1         CALL MMB$GPP(PPNO,%MONWSQ);

   1660  0 000546   000001 236000 1                  LDQ     1
         0 000547   200051 756100                    STQ     SORT_SEGS+13,,AUTO
         0 000550   200017 631500                    EPPR1   PPNO,,AUTO
PL6.E3A0      #001=MMS$WSQINIT File=MMS$WSQ.:E05TSI                              WED 07/30/97 03:23 Page:45   
         0 000551   200050 451500                    STP1    SORT_SEGS+12,,AUTO
         0 000552   200050 630500                    EPPR0   SORT_SEGS+12,,AUTO
         0 000553   000020 631400 xsym               EPPR1   B_VECTNIL+16
         0 000554   000000 701000 xent               TSX1    MMB$GPP
         0 000555   000000 011000                    NOP     0

      285     1661    1         B$PPUT$->MM$PPUT.COMM(PPNO) = '1'B;   /* Set who page belongs to */

   1661  0 000556   000000 470400 xsym               LDP0    B$PPUT$
         0 000557   200017 720100                    LXL0    PPNO,,AUTO
         0 000560   001000 236003                    LDQ     512,DU
         0 000561   000000 256110                    ORSQ    0,X0,PR0

      286     1662              %MAP (P$=PGT$,VPNO=CQPAGE);

   1663  0 000562   000000 234000 xsym               SZN     HW_WSQ0PT
         0 000563   000574 605000 0                  TPL     s:1663+10

   1663  0 000564   200005 471500                    LDP1    @BSIZE,,AUTO
         0 000565   100000 720100                    LXL0    0,,PR1
         0 000566   000000 473400 xsym               LDP3    B$WSQ0PT$
         0 000567   200017 721100                    LXL1    PPNO,,AUTO
         0 000570   300000 222111                    LDX2    0,X1,PR3
         0 000571   200022 474500                    LDP4    PGT$,,AUTO
         0 000572   400000 742110                    STX2    0,X0,PR4
         0 000573   000601 710000 0                  TRA     s:1666

   1663  0 000574   200005 471500                    LDP1    @BSIZE,,AUTO
         0 000575   100000 720100                    LXL0    0,,PR1
         0 000576   200017 721100                    LXL1    PPNO,,AUTO
         0 000577   200022 473500                    LDP3    PGT$,,AUTO
         0 000600   300000 741110                    STX1    0,X0,PR3

      287     1665              %SAC (P$=PGT$,VPNO=CQPAGE,AC="%PGINMEM|%PGWRITE|%PGIOM");

   1666  0 000601   100000 235100                    LDA     0,,PR1
         0 000602   200022 473500                    LDP3    PGT$,,AUTO
PL6.E3A0      #001=MMS$WSQINIT File=MMS$WSQ.:E05TSI                              WED 07/30/97 03:23 Page:46   
         0 000603   300000 236105                    LDQ     0,AL,PR3
         0 000604   000003 376000 1                  ANQ     3
         0 000605   000064 276007                    ORQ     52,DL
         0 000606   300000 756105                    STQ     0,AL,PR3

      288     1668    1         MM_NCQPGS  = MM_NCQPGS  + 1;

   1668  0 000607   000000 054000 xsym               AOS     MM_NCQPGS

      289     1669    1         PTR$ = PINCRW(B$CWSQ1$(WSQN-%B_CWSQ1),1024*CQPAGE);

   1669  0 000610   200003 474500                    LDP4    @WSQN,,AUTO
         0 000611   400000 720100                    LXL0    0,,PR4
         0 000612   100000 236100                    LDQ     0,,PR1
         0 000613   777763 475410 xsym               LDP5    B$CWSQ1$-13,X0
         0 000614   000012 736000                    QLS     10
         0 000615   500000 636506                    EPPR6   0,QL,PR5
         0 000616   200004 477500                    LDP7    @PTR$,,AUTO
         0 000617   700000 456500                    STP6    0,,PR7

      290     1670    1         RETURN;

   1670  0 000620   000000 702200 xent               TSX2  ! X66_ARET

      291     1671                                                /**/
      292     1672        %EJECT;
PL6.E3A0      #001=MMS$WSQINIT File=MMS$WSQ.:E05TSI                              WED 07/30/97 03:23 Page:47   
      293     1673                                                /**/
      294     1674        /*F*   NAME:   MMS$VGET                                            */
      295     1675        /*F*   PURPOSE: To map a given buffer into a communications WSQ.   */
      296     1676    1   MMS$VGET: ENTRY(WSQN,PTR$,BSIZE,RPTR$) ALTRET;

   1676  0 000621   000000 700200 xent  MMS$VGET     TSX0  ! X66_AUTO_5
         0 000622   000056 000005                    ZERO    46,5

      297     1677                                                /* Wsqn = which wsq to use            */
      298     1678                                                /* PTR$ = ptr to buffer to be mapped  */
      299     1679                                                /* Bsize = byte size of buffer        */
      300     1680                                /* RPTR$ = returned ptr to buffer relative
      301     1681                                           to the communications wsq.      */
      302     1682                                           /* Altreturns if no room to map buffer     */
      303     1683    1         IF (WSQN < %B_CWSQ1) OR (WSQN >= MM_NCWSQ+%B_CWSQ1) THEN

   1683  0 000623   200003 470500                    LDP0    @WSQN,,AUTO
         0 000624   000000 235100                    LDA     0,,PR0
         0 000625   000015 115007                    CMPA    13,DL
         0 000626   000635 602000 0                  TNC     s:1684
         0 000627   000000 236000 xsym               LDQ     MM_NCWSQ
         0 000630   000015 036007                    ADLQ    13,DL
         0 000631   000635 604000 0                  TMI     s:1684
         0 000632   000000 116100                    CMPQ    0,,PR0
         0 000633   000635 600000 0                  TZE     s:1684
         0 000634   000637 603000 0                  TRC     s:1689

      304     1684    1          CALL SC_MM33;

   1684  0 000635   000000 713400 xsym               CLIMB   SC_MM33
         0 000636   000000 600000 xsid               climb   nvectors=         0

      305     1685                                                /**/
      306     1686        /* Get the base and wsr from the descriptor referenced by 'PTR$'   */
      307     1687        /* And the byte offset out of 'PTR$'.                              */
      308     1688              %LOCK(G=MM_LOCK);

PL6.E3A0      #001=MMS$WSQINIT File=MMS$WSQ.:E05TSI                              WED 07/30/97 03:23 Page:48   
   1689  0 000637   000016 630400 1                  EPPR0   14
         0 000640   000017 631400 xsym               EPPR1   B_VECTNIL+15
         0 000641   000000 701000 xent               TSX1    HFC$LOCK
         0 000642   000000 011000                    NOP     0

      309     1691    1         CALL SETLEN;

   1691  0 000643   001323 701000 0                  TSX1    SETLEN
         0 000644   000000 011000                    NOP     0

      310     1692    1         PGT$ = B$CPGT1$ (WSQN - %B_CWSQ1);

   1692  0 000645   200003 470500                    LDP0    @WSQN,,AUTO
         0 000646   000000 720100                    LXL0    0,,PR0
         0 000647   777763 236010 xsym               LDQ     B$CPGT1$-13,X0
         0 000650   200022 756100                    STQ     PGT$,,AUTO

      311     1693        /* Now look for a hole in the wsq big enough to put our buffer into */
      312     1694    1         I = %B_CQMAX;                    /* Page # of start of buffer area     */

   1694  0 000651   000010 235007                    LDA     8,DL
         0 000652   200012 755100                    STA     I,,AUTO

      313     1695    1         J = I + VBUFLEN - 1;            /* Potential ending buf page          */

   1695  0 000653   200012 236100                    LDQ     I,,AUTO
         0 000654   200021 036100                    ADLQ    VBUFLEN,,AUTO
         0 000655   000001 136007                    SBLQ    1,DL
         0 000656   200013 756100                    STQ     J,,AUTO

      314     1696    2           DO WHILE (J < 255);

   1696  0 000657   000377 116007                    CMPQ    255,DL
         0 000660   001026 605000 0                  TPL     s:1736

      315     1697    3             DO K = 0 TO VBUFLEN - 1;      /* See if nxt vbuflen pgs are free    */

PL6.E3A0      #001=MMS$WSQINIT File=MMS$WSQ.:E05TSI                              WED 07/30/97 03:23 Page:49   
   1697  0 000661   200014 450100                    STZ     K,,AUTO
         0 000662   000703 710000 0                  TRA     s:1704+1

      316     1698    3             IF PGT$->B$MAP.RPN(I+K) ~= MM_FPMC.RPN THEN

   1698  0 000663   200012 236100                    LDQ     I,,AUTO
         0 000664   200014 036100                    ADLQ    K,,AUTO
         0 000665   200022 470500                    LDP0    PGT$,,AUTO
         0 000666   000000 220106                    LDX0    0,QL,PR0
         0 000667   000000 100000 xsym               CMPX0   MM_FPMC
         0 000670   000702 600000 0                  TZE     s:1704

      317     1699    4               DO;

      318     1700    4               I = I + K + 1;        /* Wont fit HERE: Try again           */

   1700  0 000671   200012 236100                    LDQ     I,,AUTO
         0 000672   200014 036100                    ADLQ    K,,AUTO
         0 000673   000001 036007                    ADLQ    1,DL
         0 000674   200012 756100                    STQ     I,,AUTO

      319     1701    4               J = J + K + 1;

   1701  0 000675   200013 236100                    LDQ     J,,AUTO
         0 000676   200014 036100                    ADLQ    K,,AUTO
         0 000677   000001 036007                    ADLQ    1,DL
         0 000700   200013 756100                    STQ     J,,AUTO

      320     1702    4               GOTO CHKNXT;

   1702  0 000701   001024 710000 0                  TRA     CHKNXT

      321     1703    4               END;
      322     1704    3             END;

   1704  0 000702   200014 054100                    AOS     K,,AUTO
         0 000703   200014 236100                    LDQ     K,,AUTO
PL6.E3A0      #001=MMS$WSQINIT File=MMS$WSQ.:E05TSI                              WED 07/30/97 03:23 Page:50   
         0 000704   200021 116100                    CMPQ    VBUFLEN,,AUTO
         0 000705   000663 604000 0                  TMI     s:1698

      323     1705        /* If we got here, we found an unallocated gap big enough.         */
      324     1706    2           UPGT$=B$MPT$;

   1706  0 000706   000000 236000 xsym               LDQ     B$MPT$
         0 000707   200023 756100                    STQ     UPGT$,,AUTO

      325     1707    2           IF DWSR = %USERWSR

   1707  0 000710   200032 235100                    LDA     DWSR,,AUTO
         0 000711   000007 115007                    CMPA    7,DL
         0 000712   000715 601000 0                  TNZ     s:1709

      326     1708    2           THEN UPGT$=B$UPT$;

   1708  0 000713   000000 236000 xsym               LDQ     B$UPT$
         0 000714   200023 756100                    STQ     UPGT$,,AUTO

      327     1709    2           IF DWSR = %CGWSR

   1709  0 000715   000003 115007                    CMPA    3,DL
         0 000716   000721 601000 0                  TNZ     s:1713

      328     1710    2           THEN UPGT$=B$CGPT$;

   1710  0 000717   000000 236000 xsym               LDQ     B$CGPT$
         0 000720   200023 756100                    STQ     UPGT$,,AUTO

      329     1711        /* Before we start messing up page tables, make sure the user's
      330     1712           buffer is useable...                                            */
      331     1713    3             DO K = 0 TO VBUFLEN - 1;

   1713  0 000721   200014 450100                    STZ     K,,AUTO
         0 000722   000740 710000 0                  TRA     s:1721+1

PL6.E3A0      #001=MMS$WSQINIT File=MMS$WSQ.:E05TSI                              WED 07/30/97 03:23 Page:51   
      332     1714    3             IF (UPGT$->B$MAP.RPN(VBUFPG+K) = MM_FPMC.RPN) THEN

   1714  0 000723   200020 236100                    LDQ     VBUFPG,,AUTO
         0 000724   200014 036100                    ADLQ    K,,AUTO
         0 000725   200023 470500                    LDP0    UPGT$,,AUTO
         0 000726   000000 220106                    LDX0    0,QL,PR0
         0 000727   000000 100000 xsym               CMPX0   MM_FPMC
         0 000730   000737 601000 0                  TNZ     s:1721

      333     1715    4               DO;

      334     1716                    %UNLOCK (G=MM_LOCK);

   1717  0 000731   000016 630400 1                  EPPR0   14
         0 000732   000017 631400 xsym               EPPR1   B_VECTNIL+15
         0 000733   000000 701000 xent               TSX1    HFC$UNLOCK
         0 000734   000000 011000                    NOP     0

      335     1719    4               B$NULL$->B$MAP(0) = '0'B; /* Force a trap                   */

   1719  0 000735   000000 470400 xsym               LDP0    B$NULL$
         0 000736   000000 450100                    STZ     0,,PR0

      336     1720    4               END;

      337     1721    3             END;

   1721  0 000737   200014 054100                    AOS     K,,AUTO
         0 000740   200014 236100                    LDQ     K,,AUTO
         0 000741   200021 116100                    CMPQ    VBUFLEN,,AUTO
         0 000742   000723 604000 0                  TMI     s:1714

      338     1722    3             DO K = 0 TO VBUFLEN - 1;      /* Map onto the buffer pgs            */

   1722  0 000743   200014 450100                    STZ     K,,AUTO
         0 000744   000760 710000 0                  TRA     s:1724+1

PL6.E3A0      #001=MMS$WSQINIT File=MMS$WSQ.:E05TSI                              WED 07/30/97 03:23 Page:52   
      339     1723    3             PGT$->B$PAGE.WRD(I+K) = UPGT$->B$PAGE.WRD(VBUFPG+K);

   1723  0 000745   200012 236100                    LDQ     I,,AUTO
         0 000746   200014 036100                    ADLQ    K,,AUTO
         0 000747   200050 756100                    STQ     SORT_SEGS+12,,AUTO
         0 000750   200020 236100                    LDQ     VBUFPG,,AUTO
         0 000751   200014 036100                    ADLQ    K,,AUTO
         0 000752   200023 470500                    LDP0    UPGT$,,AUTO
         0 000753   200022 471500                    LDP1    PGT$,,AUTO
         0 000754   200050 720100                    LXL0    SORT_SEGS+12,,AUTO
         0 000755   000000 235106                    LDA     0,QL,PR0
         0 000756   100000 755110                    STA     0,X0,PR1

      340     1724    3             END;

   1724  0 000757   200014 054100                    AOS     K,,AUTO
         0 000760   200014 236100                    LDQ     K,,AUTO
         0 000761   200021 116100                    CMPQ    VBUFLEN,,AUTO
         0 000762   000745 604000 0                  TMI     s:1723

      341     1725    2           PGT$->B$MAP.VLINK(I) = VBUFLEN; /* Remember size in pg tbl          */

   1725  0 000763   200022 470500                    LDP0    PGT$,,AUTO
         0 000764   200012 720100                    LXL0    I,,AUTO
         0 000765   200021 236100                    LDQ     VBUFLEN,,AUTO
         0 000766   000010 736000                    QLS     8
         0 000767   000000 676110                    ERQ     0,X0,PR0
         0 000770   777400 376007                    ANQ     -256,DL
         0 000771   000000 656110                    ERSQ    0,X0,PR0

      342     1726                %UNLOCK(G=MM_LOCK);

   1727  0 000772   000016 630400 1                  EPPR0   14
         0 000773   000017 631400 xsym               EPPR1   B_VECTNIL+15
         0 000774   000000 701000 xent               TSX1    HFC$UNLOCK
         0 000775   000000 011000                    NOP     0

PL6.E3A0      #001=MMS$WSQINIT File=MMS$WSQ.:E05TSI                              WED 07/30/97 03:23 Page:53   
      343     1729    2           RPTR$ = PINCRC(PTR$,MOD(DBAS,4096));

   1729  0 000776   200030 236100                    LDQ     DBAS,,AUTO
         0 000777   010000 506007                    DIV     4096,DL
         0 001000   200004 470500                    LDP0    @PTR$,,AUTO
         0 001001   000000 471500                    LDP1    0,,PR0
         0 001002   000044 733000                    LRS     36
         0 001003   000011 402007                    MPY     9,DL
         0 001004   000000 116003                    CMPQ    0,DU
         0 001005   001007 605000 0                  TPL     s:1729+9
         0 001006   000044 036003                    ADLQ    36,DU
         0 001007   100000 503506                    ABD     0,QL,PR1
         0 001010   200006 473500                    LDP3    @RPTR$,,AUTO
         0 001011   300000 451500                    STP1    0,,PR3

      344     1730    2           ADDR(RPTR$)->B$PPTR.SEGID = BITBIN(%CWSQ1SID) + (WSQN - %B_CWSQ1);

   1730  0 001012   200003 474500                    LDP4    @WSQN,,AUTO
         0 001013   400000 236100                    LDQ     0,,PR4
         0 001014   006040 036007                    ADLQ    3104,DL
         0 001015   300000 752103                    STCQ    0,'03'O,PR3

      345     1731    2           ADDR(RPTR$)->B$PPTR.PG = I;

   1731  0 001016   200012 236100                    LDQ     I,,AUTO
         0 001017   000034 736000                    QLS     28
         0 001020   300000 676100                    ERQ     0,,PR3
         0 001021   776000 376003                    ANQ     -1024,DU
         0 001022   300000 656100                    ERSQ    0,,PR3

      346     1732    2           RETURN;

   1732  0 001023   000000 702200 xent               TSX2  ! X66_ARET

   1731  0 001024                       CHKNXT       null
      347     1733    2   CHKNXT: ;
      348     1734    2           END;
PL6.E3A0      #001=MMS$WSQINIT File=MMS$WSQ.:E05TSI                              WED 07/30/97 03:23 Page:54   

   1734  0 001024   000377 116007                    CMPQ    255,DL
         0 001025   000661 604000 0                  TMI     s:1697

      349     1735              %UNLOCK (G=MM_LOCK);

   1736  0 001026   000016 630400 1                  EPPR0   14
         0 001027   000017 631400 xsym               EPPR1   B_VECTNIL+15
         0 001030   000000 701000 xent               TSX1    HFC$UNLOCK
         0 001031   000000 011000                    NOP     0

      350     1738    1         ALTRETURN;

   1738  0 001032   000000 702200 xent               TSX2  ! X66_AALT

      351     1739                                                /**/
      352     1740        %EJECT;
PL6.E3A0      #001=MMS$WSQINIT File=MMS$WSQ.:E05TSI                              WED 07/30/97 03:23 Page:55   
      353     1741                                                /**/
      354     1742        /*F*   NAME:   MMS$VREL                                            */
      355     1743        /*F*   PURPOSE: To unmap a given buffer from a communications WSQ. */
      356     1744    1   MMS$VREL: ENTRY(WSQN,PTR$) ALTRET;

   1744  0 001033   000000 700200 xent  MMS$VREL     TSX0  ! X66_AUTO_5
         0 001034   000056 000005                    ZERO    46,5

      357     1745                                           /* Wsqn = which wsq contains the buffer    */
      358     1746                                                /* PTR$ = ptr to buffer in comm. Wsq  */
      359     1747                                                /* The altreturn is never taken.      */
      360     1748                                                /**/
      361     1749        /* Get the cwsq-relative starting page # of the buffer             */
      362     1750    1         VBUFPG=ADDR(PTR$)->B$PPTR.PG;

   1750  0 001035   200004 470500                    LDP0    @PTR$,,AUTO
         0 001036   000000 236100                    LDQ     0,,PR0
         0 001037   000034 772000                    QRL     28
         0 001040   200020 756100                    STQ     VBUFPG,,AUTO

      363     1751        /* Now, get the # of pages in the buffer from the 'VLINK' part of the map */
      364     1752    1         PGT$ = B$CPGT1$ (WSQN - %B_CWSQ1);

   1752  0 001041   200003 471500                    LDP1    @WSQN,,AUTO
         0 001042   100000 720100                    LXL0    0,,PR1
         0 001043   777763 236010 xsym               LDQ     B$CPGT1$-13,X0
         0 001044   200022 756100                    STQ     PGT$,,AUTO

      365     1753    1         VBUFLEN = PGT$->B$MAP.VLINK(VBUFPG);

   1753  0 001045   200022 473500                    LDP3    PGT$,,AUTO
         0 001046   200020 721100                    LXL1    VBUFPG,,AUTO
         0 001047   300000 236111                    LDQ     0,X1,PR3
         0 001050   000010 772000                    QRL     8
         0 001051   001777 376007                    ANQ     1023,DL
         0 001052   200021 756100                    STQ     VBUFLEN,,AUTO

PL6.E3A0      #001=MMS$WSQINIT File=MMS$WSQ.:E05TSI                              WED 07/30/97 03:23 Page:56   
      366     1754                                                /**/
      367     1755                                                /**/
      368     1756    2           DO I = 0 TO VBUFLEN-1;

   1756  0 001053   200012 450100                    STZ     I,,AUTO
         0 001054   001065 710000 0                  TRA     s:1758+1

      369     1757    2           PGT$->B$MAP (VBUFPG+I) = MM_FPMC;

   1757  0 001055   200020 236100                    LDQ     VBUFPG,,AUTO
         0 001056   200012 036100                    ADLQ    I,,AUTO
         0 001057   200050 756100                    STQ     SORT_SEGS+12,,AUTO
         0 001060   000000 236000 xsym               LDQ     MM_FPMC
         0 001061   200022 470500                    LDP0    PGT$,,AUTO
         0 001062   200050 720100                    LXL0    SORT_SEGS+12,,AUTO
         0 001063   000000 756110                    STQ     0,X0,PR0

      370     1758    2           END;

   1758  0 001064   200012 054100                    AOS     I,,AUTO
         0 001065   200012 236100                    LDQ     I,,AUTO
         0 001066   200021 116100                    CMPQ    VBUFLEN,,AUTO
         0 001067   001055 604000 0                  TMI     s:1757

      371     1759    1         CALL HFC$ASSOCCLR(WSQN,VBUFPG,VBUFLEN);

   1759  0 001070   200021 630500                    EPPR0   VBUFLEN,,AUTO
         0 001071   200052 450500                    STP0    SORT_SEGS+14,,AUTO
         0 001072   200020 631500                    EPPR1   VBUFPG,,AUTO
         0 001073   200051 451500                    STP1    SORT_SEGS+13,,AUTO
         0 001074   200003 236100                    LDQ     @WSQN,,AUTO
         0 001075   200050 756100                    STQ     SORT_SEGS+12,,AUTO
         0 001076   200050 630500                    EPPR0   SORT_SEGS+12,,AUTO
         0 001077   000021 631400 xsym               EPPR1   B_VECTNIL+17
         0 001100   000000 701000 xent               TSX1    HFC$ASSOCCLR
         0 001101   000000 011000                    NOP     0

PL6.E3A0      #001=MMS$WSQINIT File=MMS$WSQ.:E05TSI                              WED 07/30/97 03:23 Page:57   
      372     1760    1         RETURN;

   1760  0 001102   000000 702200 xent               TSX2  ! X66_ARET

      373     1761                                                /**/
      374     1762                                                /**/
      375     1763        %EJECT;
PL6.E3A0      #001=MMS$WSQINIT File=MMS$WSQ.:E05TSI                              WED 07/30/97 03:23 Page:58   
      376     1764        /*F*    NAME:   MMS$COMPACT
      377     1765                PURPOSE: To compress all of the segments defined by the
      378     1766                        FOS_SEG$ array in the given WSQ so that there are no
      379     1767                        inter-segment gaps and the lowest segment begins
      380     1768                        at the first available WSQ page.
      381     1769        */
      382     1770    1   MMS$COMPACT: ENTRY(WSQN) ALTRET;

   1770  0 001103   000000 700200 xent  MMS$COMPACT  TSX0  ! X66_AUTO_5
         0 001104   000056 000005                    ZERO    46,5

      383     1771                                                /* Note: Altret is never taken        */
      384     1772        /**/
      385     1773        /* Begin by sorting a table of indices into FOS_SEG$ so that they  */
      386     1774        /* will yeild the FOS_SEG$ pointers in ascending order of buffer   */
      387     1775        /* location.                                                       */
      388     1776    2           DO I = 0 TO FOSS_MAX#;

   1776  0 001105   200012 450100                    STZ     I,,AUTO

      389     1777    2           SORT_SEGS(I) = I;

   1777  0 001106   200012 235100                    LDA     I,,AUTO
         0 001107   200034 755105                    STA     SORT_SEGS,AL,AUTO

      390     1778    2           END;

   1778  0 001110   200012 054100                    AOS     I,,AUTO
         0 001111   200012 236100                    LDQ     I,,AUTO
         0 001112   000011 116007                    CMPQ    9,DL
         0 001113   001106 604400 0                  TMOZ    s:1777

      391     1779    2           DO I = 0 TO FOSS_MAX# - 1;

   1779  0 001114   200012 450100                    STZ     I,,AUTO
         0 001115   001145 710000 0                  TRA     s:1788+1

PL6.E3A0      #001=MMS$WSQINIT File=MMS$WSQ.:E05TSI                              WED 07/30/97 03:23 Page:59   
      392     1780    3             DO J = 0 TO FOSS_MAX# - 1;

   1780  0 001116   200013 450100                    STZ     J,,AUTO
         0 001117   001141 710000 0                  TRA     s:1787+1

      393     1781    3             IF FOS_SEGPTR.PG(SORT_SEGS(J)) > FOS_SEGPTR.PG(SORT_SEGS(J+1)) THEN

   1781  0 001120   200013 720100                    LXL0    J,,AUTO
         0 001121   200034 721110                    LXL1    SORT_SEGS,X0,AUTO
         0 001122   200035 722110                    LXL2    SORT_SEGS+1,X0,AUTO
         0 001123   000000 236011 xsym               LDQ     FOS_SEG$,X1
         0 001124   000034 772000                    QRL     28
         0 001125   200050 756100                    STQ     SORT_SEGS+12,,AUTO
         0 001126   000000 236012 xsym               LDQ     FOS_SEG$,X2
         0 001127   000034 772000                    QRL     28
         0 001130   200050 116100                    CMPQ    SORT_SEGS+12,,AUTO
         0 001131   001140 605000 0                  TPL     s:1787

      394     1782    4               DO;

      395     1783    4               K = SORT_SEGS(J);

   1783  0 001132   200034 235110                    LDA     SORT_SEGS,X0,AUTO
         0 001133   200014 755100                    STA     K,,AUTO

      396     1784    4               SORT_SEGS(J) = SORT_SEGS(J+1);

   1784  0 001134   200035 235110                    LDA     SORT_SEGS+1,X0,AUTO
         0 001135   200034 755110                    STA     SORT_SEGS,X0,AUTO

      397     1785    4               SORT_SEGS(J+1) = K;

   1785  0 001136   200014 236100                    LDQ     K,,AUTO
         0 001137   200035 756110                    STQ     SORT_SEGS+1,X0,AUTO

      398     1786    4               END;

PL6.E3A0      #001=MMS$WSQINIT File=MMS$WSQ.:E05TSI                              WED 07/30/97 03:23 Page:60   
      399     1787    3             END;

   1787  0 001140   200013 054100                    AOS     J,,AUTO
         0 001141   200013 235100                    LDA     J,,AUTO
         0 001142   000010 115007                    CMPA    8,DL
         0 001143   001120 604400 0                  TMOZ    s:1781

      400     1788    2           END;

   1788  0 001144   200012 054100                    AOS     I,,AUTO
         0 001145   200012 235100                    LDA     I,,AUTO
         0 001146   000010 115007                    CMPA    8,DL
         0 001147   001116 604400 0                  TMOZ    s:1780

      401     1789        /* Okay - we're sorted.  Now compress the buffers (segments).      */
      402     1790    1         PGT$ = B$CPGT1$ (WSQN - %B_CWSQ1);

   1790  0 001150   200003 470500                    LDP0    @WSQN,,AUTO
         0 001151   000000 720100                    LXL0    0,,PR0
         0 001152   777763 236010 xsym               LDQ     B$CPGT1$-13,X0
         0 001153   200022 756100                    STQ     PGT$,,AUTO

      403     1791    1         PREV_SEG_END = %B_CQMAX;

   1791  0 001154   000010 235007                    LDA     8,DL
         0 001155   200033 755100                    STA     PREV_SEG_END,,AUTO

      404     1792    2           DO I = 0 TO FOSS_MAX#;

   1792  0 001156   200012 450100                    STZ     I,,AUTO

      405     1793    2           IF FOS_SEG$(SORT_SEGS(I)) ~= ADDR(NIL) THEN

   1793  0 001157   200012 720100                    LXL0    I,,AUTO
         0 001160   200034 721110                    LXL1    SORT_SEGS,X0,AUTO
         0 001161   000000 236011 xsym               LDQ     FOS_SEG$,X1
         0 001162   000001 116000 xsym               CMPQ    B_VECTNIL+1
PL6.E3A0      #001=MMS$WSQINIT File=MMS$WSQ.:E05TSI                              WED 07/30/97 03:23 Page:61   
         0 001163   001242 600000 0                  TZE     s:1807

      406     1794    3             DO;

      407     1795    3             VBUFPG = FOS_SEGPTR.PG(SORT_SEGS(I));

   1795  0 001164   000000 236011 xsym               LDQ     FOS_SEG$,X1
         0 001165   000034 772000                    QRL     28
         0 001166   200020 756100                    STQ     VBUFPG,,AUTO

      408     1796    3             VBUFLEN = PGT$->B$MAP.VLINK(VBUFPG);

   1796  0 001167   200022 470500                    LDP0    PGT$,,AUTO
         0 001170   000000 236106                    LDQ     0,QL,PR0
         0 001171   000010 772000                    QRL     8
         0 001172   001777 376007                    ANQ     1023,DL
         0 001173   200021 756100                    STQ     VBUFLEN,,AUTO

      409     1797    3             IF VBUFPG > PREV_SEG_END + 1 THEN

   1797  0 001174   200033 236100                    LDQ     PREV_SEG_END,,AUTO
         0 001175   000001 036007                    ADLQ    1,DL
         0 001176   001237 604000 0                  TMI     s:1805
         0 001177   200020 116100                    CMPQ    VBUFPG,,AUTO
         0 001200   001237 605000 0                  TPL     s:1805

      410     1798    4               DO;

      411     1799    5                 DO J = 1 TO VBUFLEN;

   1799  0 001201   000001 235007                    LDA     1,DL
         0 001202   200013 755100                    STA     J,,AUTO
         0 001203   001224 710000 0                  TRA     s:1802+1

      412     1800    5                 PGT$->B$MAP(PREV_SEG_END+J) = PGT$->B$MAP(VBUFPG+J-1);

   1800  0 001204   200033 236100                    LDQ     PREV_SEG_END,,AUTO
PL6.E3A0      #001=MMS$WSQINIT File=MMS$WSQ.:E05TSI                              WED 07/30/97 03:23 Page:62   
         0 001205   200013 036100                    ADLQ    J,,AUTO
         0 001206   200050 756100                    STQ     SORT_SEGS+12,,AUTO
         0 001207   200020 236100                    LDQ     VBUFPG,,AUTO
         0 001210   200013 036100                    ADLQ    J,,AUTO
         0 001211   200022 470500                    LDP0    PGT$,,AUTO
         0 001212   077777 236106                    LDQ     -1,QL,PR0
         0 001213   200050 720100                    LXL0    SORT_SEGS+12,,AUTO
         0 001214   000000 756110                    STQ     0,X0,PR0

      413     1801    5                 PGT$->B$MAP(VBUFPG+J-1) = MM_FPMC;

   1801  0 001215   200020 236100                    LDQ     VBUFPG,,AUTO
         0 001216   200013 036100                    ADLQ    J,,AUTO
         0 001217   200050 756100                    STQ     SORT_SEGS+12,,AUTO
         0 001220   000000 236000 xsym               LDQ     MM_FPMC
         0 001221   200050 720100                    LXL0    SORT_SEGS+12,,AUTO
         0 001222   077777 756110                    STQ     -1,X0,PR0

      414     1802    5                 END;

   1802  0 001223   200013 054100                    AOS     J,,AUTO
         0 001224   200013 236100                    LDQ     J,,AUTO
         0 001225   200021 116100                    CMPQ    VBUFLEN,,AUTO
         0 001226   001204 604400 0                  TMOZ    s:1800

      415     1803    4               FOS_SEGPTR.PG(SORT_SEGS(I)) = PREV_SEG_END + 1;

   1803  0 001227   200012 720100                    LXL0    I,,AUTO
         0 001230   200034 721110                    LXL1    SORT_SEGS,X0,AUTO
         0 001231   200033 236100                    LDQ     PREV_SEG_END,,AUTO
         0 001232   000001 036007                    ADLQ    1,DL
         0 001233   000034 736000                    QLS     28
         0 001234   000000 676011 xsym               ERQ     FOS_SEG$,X1
         0 001235   776000 376003                    ANQ     -1024,DU
         0 001236   000000 656011 xsym               ERSQ    FOS_SEG$,X1

      416     1804    4               END;
PL6.E3A0      #001=MMS$WSQINIT File=MMS$WSQ.:E05TSI                              WED 07/30/97 03:23 Page:63   

      417     1805    3             PREV_SEG_END = PREV_SEG_END + VBUFLEN;

   1805  0 001237   200033 236100                    LDQ     PREV_SEG_END,,AUTO
         0 001240   200021 036100                    ADLQ    VBUFLEN,,AUTO
         0 001241   200033 756100                    STQ     PREV_SEG_END,,AUTO

      418     1806    3             END;

      419     1807    2           END;

   1807  0 001242   200012 054100                    AOS     I,,AUTO
         0 001243   200012 235100                    LDA     I,,AUTO
         0 001244   000011 115007                    CMPA    9,DL
         0 001245   001157 604400 0                  TMOZ    s:1793

      420     1808    1         CALL HFC$ASSOCCLR(WSQN,0,16384); /*MAX Dense PT*/

   1808  0 001246   000020 236000 1                  LDQ     16
         0 001247   200052 756100                    STQ     SORT_SEGS+14,,AUTO
         0 001250   000021 236000 1                  LDQ     17
         0 001251   200003 235100                    LDA     @WSQN,,AUTO
         0 001252   200050 757100                    STAQ    SORT_SEGS+12,,AUTO
         0 001253   200050 630500                    EPPR0   SORT_SEGS+12,,AUTO
         0 001254   000021 631400 xsym               EPPR1   B_VECTNIL+17
         0 001255   000000 701000 xent               TSX1    HFC$ASSOCCLR
         0 001256   000000 011000                    NOP     0

      421     1809    1         RETURN;

   1809  0 001257   000000 702200 xent               TSX2  ! X66_ARET

      422     1810        /**/
      423     1811        %EJECT;
PL6.E3A0      #001=MMS$WSQINIT File=MMS$WSQ.:E05TSI                              WED 07/30/97 03:23 Page:64   
      424     1812        /**/
      425     1813        /*F*    NAME:   MMS$SETUP_BUF
      426     1814                PURPOSE: To build a pair of page table words and a pointer
      427     1815                        such that if the page table words are placed into
      428     1816                        the two map words reserved in the comgroup context
      429     1817                        area, the returned pointer will access the same buffer
      430     1818                        as that defined by the input parameters PTR$ and
      431     1819                        BSIZE, but via the comgroup context page table.    */
      432     1820        /**/
      433     1821    1   MMS$SETUP_BUF: ENTRY(WSQN,PTR$,BSIZE,RPTR$,PTWDS) ALTRET;

   1821  0 001260   000000 700200 xent  MMS$SETUP_B* TSX0  ! X66_AUTO_5
         0 001261   000056 000005                    ZERO    46,5

      434     1822                                                /* Wsqn is unused for this entry      */
      435     1823    1         CALL SETLEN;

   1823  0 001262   001323 701000 0                  TSX1    SETLEN
         0 001263   000000 011000                    NOP     0

      436     1824        /**/
      437     1825        /**/
      438     1826    1         UPGT$=B$MPT$;

   1826  0 001264   000000 236000 xsym               LDQ     B$MPT$
         0 001265   200023 756100                    STQ     UPGT$,,AUTO

      439     1827    1         IF DWSR = %USERWSR

   1827  0 001266   200032 235100                    LDA     DWSR,,AUTO
         0 001267   000007 115007                    CMPA    7,DL
         0 001270   001273 601000 0                  TNZ     s:1829

      440     1828    1         THEN UPGT$=B$UPT$;

   1828  0 001271   000000 236000 xsym               LDQ     B$UPT$
         0 001272   200023 756100                    STQ     UPGT$,,AUTO
PL6.E3A0      #001=MMS$WSQINIT File=MMS$WSQ.:E05TSI                              WED 07/30/97 03:23 Page:65   

      441     1829    1         PTWDS.WD1 = UPGT$->B$MAP(VBUFPG);

   1829  0 001273   200023 470500                    LDP0    UPGT$,,AUTO
         0 001274   200020 720100                    LXL0    VBUFPG,,AUTO
         0 001275   000000 236110                    LDQ     0,X0,PR0
         0 001276   200007 471500                    LDP1    @PTWDS,,AUTO
         0 001277   100000 756100                    STQ     0,,PR1

      442     1830    1         IF VBUFLEN = 1 THEN

   1830  0 001300   200021 235100                    LDA     VBUFLEN,,AUTO
         0 001301   000001 115007                    CMPA    1,DL
         0 001302   001306 601000 0                  TNZ     s:1832

      443     1831    1          PTWDS.WD2 = MM_FPMC;

   1831  0 001303   000000 236000 xsym               LDQ     MM_FPMC
         0 001304   100001 756100                    STQ     1,,PR1
         0 001305   001311 710000 0                  TRA     s:1833

      444     1832    1         ELSE PTWDS.WD2 = UPGT$->B$MAP(VBUFPG+1);

   1832  0 001306   200020 720100                    LXL0    VBUFPG,,AUTO
         0 001307   000001 236110                    LDQ     1,X0,PR0
         0 001310   100001 756100                    STQ     1,,PR1

      445     1833    1         BOFFSET=MOD(BOFFSET+DBAS,4096);

   1833  0 001311   200031 236100                    LDQ     BOFFSET,,AUTO
         0 001312   200030 036100                    ADLQ    DBAS,,AUTO
         0 001313   010000 506007                    DIV     4096,DL
         0 001314   200031 755100                    STA     BOFFSET,,AUTO

      446     1834    1         RPTR$ = PINCRC(B$CGCTXT$,BOFFSET);

   1834  0 001315   200031 236100                    LDQ     BOFFSET,,AUTO
PL6.E3A0      #001=MMS$WSQINIT File=MMS$WSQ.:E05TSI                              WED 07/30/97 03:23 Page:66   
         0 001316   000020 736000                    QLS     16
         0 001317   000000 036000 xsym               ADLQ    B$CGCTXT$
         0 001320   200006 473500                    LDP3    @RPTR$,,AUTO
         0 001321   300000 756100                    STQ     0,,PR3

      447     1835    1         RETURN;

   1835  0 001322   000000 702200 xent               TSX2  ! X66_ARET

      448     1836        /**/
      449     1837    1   SETLEN:PROC;

   1837  0 001323   200046 741300       SETLEN       STX1  ! SORT_SEGS+10,,AUTO

      450     1838    2         CALL MMA$WHERE(PTR$,DBAS,BOFFSET,DWSR);

   1838  0 001324   200032 630500                    EPPR0   DWSR,,AUTO
         0 001325   200053 450500                    STP0    SORT_SEGS+15,,AUTO
         0 001326   200031 631500                    EPPR1   BOFFSET,,AUTO
         0 001327   200052 451500                    STP1    SORT_SEGS+14,,AUTO
         0 001330   200030 633500                    EPPR3   DBAS,,AUTO
         0 001331   200051 453500                    STP3    SORT_SEGS+13,,AUTO
         0 001332   200004 236100                    LDQ     @PTR$,,AUTO
         0 001333   200050 756100                    STQ     SORT_SEGS+12,,AUTO
         0 001334   200050 630500                    EPPR0   SORT_SEGS+12,,AUTO
         0 001335   000022 631400 xsym               EPPR1   B_VECTNIL+18
         0 001336   000000 701000 xent               TSX1    MMA$WHERE
         0 001337   000000 011000                    NOP     0

      451     1839    2         VBUFPG = (DBAS + BOFFSET)/4096;

   1839  0 001340   200030 236100                    LDQ     DBAS,,AUTO
         0 001341   200031 036100                    ADLQ    BOFFSET,,AUTO
         0 001342   010000 506007                    DIV     4096,DL
         0 001343   200020 756100                    STQ     VBUFPG,,AUTO

      452     1840    2         VBUFLEN = ((DBAS + BOFFSET + BSIZE - 1)/4096) - VBUFPG + 1;
PL6.E3A0      #001=MMS$WSQINIT File=MMS$WSQ.:E05TSI                              WED 07/30/97 03:23 Page:67   

   1840  0 001344   200030 236100                    LDQ     DBAS,,AUTO
         0 001345   200031 036100                    ADLQ    BOFFSET,,AUTO
         0 001346   200005 470500                    LDP0    @BSIZE,,AUTO
         0 001347   000000 036100                    ADLQ    0,,PR0
         0 001350   000001 136007                    SBLQ    1,DL
         0 001351   010000 506007                    DIV     4096,DL
         0 001352   200020 136100                    SBLQ    VBUFPG,,AUTO
         0 001353   000001 036007                    ADLQ    1,DL
         0 001354   200021 756100                    STQ     VBUFLEN,,AUTO

      453     1841    2   END SETLEN;

   1841  0 001355   200046 221300                    LDX1  ! SORT_SEGS+10,,AUTO
         0 001356   000001 702211                    TSX2  ! 1,X1

(unnamed)
 Sect OctLoc
   1     000   000005 700000   000003 006000   000000 000063   777777 777700    ...........3....
   1     004   000003 006000   000002 006000   000000 001777   000006 006000    ................
   1     010   000000 006000   000000 000064   000003 006000   000011 006000    .......4........
   1     014   777777 770000   000005 730000   000000 006000   000000 040000    .............. .
   1     020   000017 006000   000002 006000                                    ........
      454     1842        /**/
      455     1843        /**/
      456     1844    1   END MMS$WSQINIT;

PL6.E3A0      #001=MMS$WSQINIT File=MMS$WSQ.:E05TSI                              WED 07/30/97 03:23 Page:68   
--  Include file information  --

   FOS_DATA_R.:E05TOU  cannot be made into a system file and is referenced.
   B$MAP.:E05TOU  cannot be made into a system file and is referenced.
   MM_MACRO_M.:E05TOU  is referenced.
   B_STRINGS_C.:E05TOU  is referenced.
   MM$SYSGEN.:E05TOU  is referenced.
   M_INFO_C.:E05TOU  is referenced.
   MM_DATA_R.:E05TOU  cannot be made into a system file and is referenced.
   HF_LOCK_C.:E05TOU  cannot be made into a system file and is referenced.
   HF_DATA_R.:E05TOU  cannot be made into a system file and is referenced.
   B_MACROS_C.:E05TOU  is referenced.
   B_SEGIDS_C.:E05TOU  is referenced.
   S$WSPTD.:E05TOU  cannot be made into a system file and is referenced.
   S_WSPTD_R.:E05TOU  cannot be made into a system file and is referenced.
   FOS_SUBS_C.:E05TOU  is referenced.
      No diagnostics issued in procedure MMS$WSQINIT.
PL6.E3A0      #001=MMS$WSQINIT File=MMS$WSQ.:E05TSI                              WED 07/30/97 03:23 Page:69   

 **** Variables and constants ****

  ****  Auto variables  ****

  ****  Scalars and arrays  ****
OctLoc.c.b A Datatyp(siz) R M Lvl/name                 OctLoc.c.b A Datatyp(siz) R M Lvl/name

     5-0-0/w PTR         r     1 @BSIZE                     4-0-0/w PTR         r     1 @PTR$
     7-0-0/w PTR         r     1 @PTWDS                     6-0-0/w PTR         r     1 @RPTR$
     3-0-0/w PTR         r     1 @WSQN                     31-0-0/w SBIN        r     1 BOFFSET
    *0-0-0/w SBIN        r     1 BSIZE                     *0-0-0/w SBIN        r     1 CQPAGE
    24-0-0/w SBIN        r     1 CSID                      11-0-0/w SBIN        r     1 CWSQ
    30-0-0/w SBIN        r     1 DBAS                      32-0-0/w SBIN        r     1 DWSR
    27-0-0/w SBIN        r     1 ERR                       12-0-0/w SBIN        r     1 I
    13-0-0/w SBIN        r     1 J                         14-0-0/w SBIN        r     1 K
    10-0-0/w SBIN        r     1 MAPPGS                    22-0-0/w PTR         r     1 PGT$
    22-0-0/w UBIN        r     1 PGTX                      17-0-0/w SBIN        r     1 PPNO
    33-0-0/w UBIN        r     1 PREV_SEG_END              25-0-0/w SBIN        r     1 PSID
    26-0-0/w SBIN        r     1 PTLOC                     *0-0-0/w PTR         r     1 PTR$
    *0-0-0/w STRC(72)    r     1 PTWDS                     *0-0-0/w PTR         r     1 RPTR$
    34-0-0/w UBIN        r     1 SORT_SEGS(0:9)
    15-0-0/w UBIN        r     1 TMP                       23-0-0/w PTR         r     1 UPGT$
    21-0-0/w SBIN        r     1 VBUFLEN                   20-0-0/w SBIN        r     1 VBUFPG
    16-0-0/w PTR         r     1 WSPTD$                    *0-0-0/w UBIN        r     1 WSQN

  ****  SYMREF variables  ****

  ****  Scalars and arrays  ****
OctLoc.c.b A Datatyp(siz) R M Lvl/name                 OctLoc.c.b A Datatyp(siz) R M Lvl/name

     0-0-0/w PTR         r     1 B$CGCTXT$                  0-0-0/w PTR         r     1 B$CGPT$
     0-0-0/w PTR         r     1 B$CPGT1$(0:0)
     0-0-0/w PTR         r     1 B$CWSQ1$(0:0)
     0-0-0/w PTR         r     1 B$IPHYMAP$                 0-0-0/w PTR         r     1 B$LS$
     0-0-0/w PTR         r     1 B$MPT$                     0-0-0/w PTR         r     1 B$NULL$
     0-0-0/w PTR         r     1 B$PPUT$                    0-0-0/w PTR         r     1 B$SLV1PT$
     0-0-0/w PTR         r     1 B$UPT$                     0-0-0/w PTR         r     1 B$WINDOW$
PL6.E3A0      #001=MMS$WSQINIT File=MMS$WSQ.:E05TSI                              WED 07/30/97 03:23 Page:70   
     0-0-0/w PTR         r     1 B$WSQ0PT$
     0-0-0/w PTR         r     1 FOS_SEG$(0:0)
     0-0-0/w STRC        r     1 FOS_SEGPTR(0:0)
     0-0-0/w SBIN        r     1 HW_PTB_UNITS               0-0-0/w BIT         r     1 HW_WSQ0PT
     0-0-0/w UBIN        r     1 IT_SCPUWSPTD(0:3)
     0-0-0/w PTR         r     1 MM_BYP$                    0-0-0/b STRC        r     1 MM_FPMC
     0-0-0/d BIT (72)    r     1 MM_LOCK                    0-0-0/w SBIN        r     1 MM_NCQPGS
     0-0-0/w SBIN        r     1 MM_NCWSQ                   0-0-0/w SBIN        r     1 S_NSCPU
     0-0-0/w STRC        r     1 S_WSPTD(0:28)

  ****  BASED and DCB variables  ****

  ****  Scalars and arrays  ****
OctLoc.c.b A Datatyp(siz) R M Lvl/name                 OctLoc.c.b A Datatyp(siz) R M Lvl/name

     0-0-0/w STRC        r     1 B$MAP(0:1023)              0-0-0/w STRC(36864) r     1 B$PAGE
     0-0-0/w STRC        r     1 B$PPTR
     0-0-0/h UBIN(18)    r     1 MM$IPHY_MAP(0:0)
     0-0-0/w STRC        r     1 MM$PPUT(0:0)
     0-0-0/w STRC        r     1 S$WSPTD(0:28)


   Procedure MMS$WSQINIT requires 751 words for executable code.
   Procedure MMS$WSQINIT requires 46 words of local(AUTO) storage.

    No errors detected in file MMS$WSQ.:E05TSI    .
PL6.E3A0      #001=MMS$WSQINIT File=MMS$WSQ.:E05TSI                              WED 07/30/97 03:23 Page:71   
          *** CROSS REFERENCE LISTING ***
**     DENOTES     IDENTIFIER DEFINITION
<<                 IDENTIFIER'S VALUE SET
>>                 IDENTIFIER'S VALUE USED
<>                 IDENTIFIER SET AND/OR USED
--                 IDENTIFIER REFERENCED
PL6.E3A0      #001=MMS$WSQINIT File=MMS$WSQ.:E05TSI                              WED 07/30/97 03:23 Page:72   
          MINI XREF LISTING

B$CGCTXT$
      1488**DCL      1834>>ASSIGN
B$CGPT$
      1483**DCL      1710>>ASSIGN
B$CPGT1$
      1480**DCL      1658>>ASSIGN   1692>>ASSIGN   1752>>ASSIGN   1790>>ASSIGN
B$CWSQ1$
      1479**DCL      1669>>ASSIGN
B$IPHYMAP$
      1491**DCL      1621>>ASSIGN
B$LS$
      1482**DCL      1538<>CALL     1603<>CALL
B$MAP
      1330**DCL      1719<<ASSIGN   1757<<ASSIGN   1800<<ASSIGN   1800>>ASSIGN   1801<<ASSIGN   1829>>ASSIGN
      1832>>ASSIGN
B$MAP.CTRL
      1335**DCL      1523<<ASSIGN   1588<<ASSIGN   1666<<ASSIGN
B$MAP.RPN
      1331**DCL      1520<<ASSIGN   1520>>ASSIGN   1520<<ASSIGN   1544>>ASSIGN   1585<<ASSIGN   1585>>ASSIGN
      1585<<ASSIGN   1598>>ASSIGN   1621>>ASSIGN   1623>>ASSIGN   1627>>ASSIGN   1663<<ASSIGN   1663>>ASSIGN
      1663<<ASSIGN   1698>>IF       1714>>IF
B$MAP.SCTRL
      1332**DCL      1333--REDEF
B$MAP.VLINK
      1333**DCL      1725<<ASSIGN   1753>>ASSIGN   1796>>ASSIGN
B$MPT$
      1484**DCL      1520>>ASSIGN   1520>>ASSIGN   1523>>ASSIGN   1528>>ASSIGN   1585>>ASSIGN   1585>>ASSIGN
      1588>>ASSIGN   1621>>ASSIGN   1623>>ASSIGN   1706>>ASSIGN   1826>>ASSIGN
B$NULL$
      1487**DCL      1719>>ASSIGN
B$PAGE.WRD
      1382**DCL      1528<<ASSIGN   1528>>ASSIGN   1536<<ASSIGN   1595<<ASSIGN   1723<<ASSIGN   1723>>ASSIGN
PL6.E3A0      #001=MMS$WSQINIT File=MMS$WSQ.:E05TSI                              WED 07/30/97 03:23 Page:73   
B$PPTR.PG
      1425**DCL      1731<<ASSIGN   1750>>ASSIGN
B$PPTR.SEGID
      1428**DCL      1730<<ASSIGN
B$PPUT$
      1489**DCL      1517>>ASSIGN   1582>>ASSIGN   1661>>ASSIGN
B$SLV1PT$
      1486**DCL      1526>>ASSIGN
B$UPT$
      1485**DCL      1708>>ASSIGN   1828>>ASSIGN
B$WINDOW$
      1481**DCL      1532>>ASSIGN   1539>>ASSIGN   1591>>ASSIGN
B$WSQ0PT$
      1490**DCL      1520>>ASSIGN   1544>>ASSIGN   1585>>ASSIGN   1598>>ASSIGN   1627>>ASSIGN   1663>>ASSIGN
BOFFSET
      1453**DCL      1833<<ASSIGN   1833>>ASSIGN   1834>>ASSIGN   1838<>CALL     1839>>ASSIGN   1840>>ASSIGN
BSIZE
      1407**DCL        12--PROC     1408--REDEF    1647--ENTRY    1676--ENTRY    1821--ENTRY    1840>>ASSIGN
CHKNXT
      1731**LABEL    1702--GOTO
CQPAGE
      1408**DCL      1663>>ASSIGN   1663>>ASSIGN   1666>>ASSIGN   1669>>ASSIGN
CSID
      1448**DCL      1505<<ASSIGN   1553<<ASSIGN   1553>>ASSIGN   1570<<ASSIGN   1606<<ASSIGN   1606>>ASSIGN
CWSQ
      1436**DCL      1504<<ASSIGN   1544>>ASSIGN   1547>>ASSIGN   1548>>ASSIGN   1549>>ASSIGN   1551<<ASSIGN
      1551>>ASSIGN   1552>>IF       1569<<ASSIGN   1598>>ASSIGN   1600>>ASSIGN   1601>>ASSIGN   1602>>ASSIGN
      1604<<ASSIGN   1604>>ASSIGN   1605>>IF
DBAS
      1452**DCL      1729>>ASSIGN   1833>>ASSIGN   1838<>CALL     1839>>ASSIGN   1840>>ASSIGN
DWSR
      1454**DCL      1707>>IF       1709>>IF       1827>>IF       1838<>CALL
ERR
      1451**DCL      1518<>CALL     1542<>CALL     1583<>CALL
EXITLOOPS
      1553**LABEL    1552--GOTO
PL6.E3A0      #001=MMS$WSQINIT File=MMS$WSQ.:E05TSI                              WED 07/30/97 03:23 Page:74   
FOS_SEG$
      1396**DCL      1396--REDEF    1793>>IF
FOS_SEGPTR.PG
      1397**DCL      1781>>IF       1781>>IF       1795>>ASSIGN   1803<<ASSIGN
HFC$ASSOCCLR
      1463**DCL-ENT  1634--CALL     1759--CALL     1808--CALL
HFC$LOCK
       768**DCL-ENT  1689--CALL
HFC$UNLOCK
       768**DCL-ENT  1717--CALL     1727--CALL     1736--CALL
HW_PTB_UNITS
       749**DCL      1544>>ASSIGN   1547>>ASSIGN   1598>>ASSIGN   1600>>ASSIGN   1627>>ASSIGN   1629>>ASSIGN
HW_WSQ0PT
       750**DCL      1520>>IF       1543>>IF       1585>>IF       1597>>IF       1620>>IF       1626>>IF
      1663>>IF
I
      1437**DCL      1515<<DOINDEX  1520>>ASSIGN   1520>>ASSIGN   1523>>ASSIGN   1528>>ASSIGN   1528>>ASSIGN
      1617<<ASSIGN   1621>>ASSIGN   1623>>ASSIGN   1694<<ASSIGN   1695>>ASSIGN   1698>>IF       1700<<ASSIGN
      1700>>ASSIGN   1723>>ASSIGN   1725>>ASSIGN   1731>>ASSIGN   1756<<DOINDEX  1757>>ASSIGN   1776<<DOINDEX
      1777>>ASSIGN   1777>>ASSIGN   1779<<DOINDEX  1792<<DOINDEX  1793>>IF       1795>>ASSIGN   1803>>ASSIGN
IT_SCPUWSPTD
      1493**DCL      1542<>CALL
J
      1438**DCL      1527<<DOINDEX  1534<<DOINDEX  1593<<DOINDEX  1695<<ASSIGN   1696>>DOWHILE  1701<<ASSIGN
      1701>>ASSIGN   1780<<DOINDEX  1781>>IF       1781>>IF       1783>>ASSIGN   1784>>ASSIGN   1784>>ASSIGN
      1785>>ASSIGN   1799<<DOINDEX  1800>>ASSIGN   1800>>ASSIGN   1801>>ASSIGN
K
      1439**DCL      1535<<DOINDEX  1536>>ASSIGN   1541<<DOINDEX  1542>>CALL     1594<<DOINDEX  1595>>ASSIGN
      1697<<DOINDEX  1698>>IF       1700>>ASSIGN   1701>>ASSIGN   1713<<DOINDEX  1714>>IF       1722<<DOINDEX
      1723>>ASSIGN   1723>>ASSIGN   1783<<ASSIGN   1785>>ASSIGN
MAPPGS
      1435**DCL      1503<<ASSIGN   1515>>DOINDEX
MM$DESC.BOUND
      1240**DCL      1241--REDEF
MM$DESC.FLGS
      1241**DCL      1241--REDEF
PL6.E3A0      #001=MMS$WSQINIT File=MMS$WSQ.:E05TSI                              WED 07/30/97 03:23 Page:75   
MM$IPHY_MAP
      1386**DCL      1621>>ASSIGN
MM$PPUT.COMM
      1229**DCL      1517<<ASSIGN   1582<<ASSIGN   1661<<ASSIGN
MM$PPUT.USER#
      1229**DCL      1229--REDEF
MMA$WHERE
      1464**DCL-ENT  1838--CALL
MMB$GPP
      1466**DCL-ENT  1516--CALL     1580--CALL     1660--CALL
MME$CVM
      1467**DCL-ENT  1518--CALL     1542--CALL     1583--CALL
MMF$FIXLS
      1468**DCL-ENT  1538--CALL     1603--CALL
MM_BYP$
      1160**DCL      1160--IMP-PTR
MM_FPMC
      1166**DCL      1536>>ASSIGN   1595>>ASSIGN   1757>>ASSIGN   1801>>ASSIGN   1831>>ASSIGN
MM_FPMC.RPN
      1166**DCL      1698>>IF       1714>>IF
MM_LOCK
      1157**DCL      1689<>CALL     1717<>CALL     1727<>CALL     1736<>CALL
MM_NCQPGS
      1165**DCL      1668<<ASSIGN   1668>>ASSIGN
MM_NCWSQ
      1165**DCL      1502<<ASSIGN   1683>>IF
PGT$
      1445**DCL      1446--REDEF    1526<<ASSIGN   1528>>ASSIGN   1532<<ASSIGN   1536>>ASSIGN   1556<<ASSIGN
      1556>>ASSIGN   1591<<ASSIGN   1595>>ASSIGN   1609<<ASSIGN   1609>>ASSIGN   1658<<ASSIGN   1663>>ASSIGN
      1663>>ASSIGN   1666>>ASSIGN   1692<<ASSIGN   1698>>IF       1723>>ASSIGN   1725>>ASSIGN   1752<<ASSIGN
      1753>>ASSIGN   1757>>ASSIGN   1790<<ASSIGN   1796>>ASSIGN   1800>>ASSIGN   1800>>ASSIGN   1801>>ASSIGN
PGTX
      1446**DCL      1529<<ASSIGN   1529>>ASSIGN
PPNO
      1442**DCL      1516<>CALL     1517>>ASSIGN   1518<>CALL     1520>>ASSIGN   1520>>ASSIGN   1544>>ASSIGN
      1547>>ASSIGN   1580<>CALL     1581>>ASSIGN   1582>>ASSIGN   1583<>CALL     1585>>ASSIGN   1585>>ASSIGN
PL6.E3A0      #001=MMS$WSQINIT File=MMS$WSQ.:E05TSI                              WED 07/30/97 03:23 Page:76   
      1598>>ASSIGN   1600>>ASSIGN   1616<<ASSIGN   1619>>IF       1624>>IF       1627>>ASSIGN   1629>>ASSIGN
      1660<>CALL     1661>>ASSIGN   1663>>ASSIGN   1663>>ASSIGN
PREV_SEG_END
      1455**DCL      1791<<ASSIGN   1797>>IF       1800>>ASSIGN   1803>>ASSIGN   1805<<ASSIGN   1805>>ASSIGN
PSID
      1449**DCL      1506<<ASSIGN   1538<>CALL     1554<<ASSIGN   1554>>ASSIGN   1571<<ASSIGN   1603<>CALL
      1607<<ASSIGN   1607>>ASSIGN
PTLOC
      1450**DCL      1507<<ASSIGN   1538<>CALL     1555<<ASSIGN   1555>>ASSIGN   1572<<ASSIGN   1603<>CALL
      1608<<ASSIGN   1608>>ASSIGN
PTR$
      1405**DCL        12--PROC     1406--REDEF    1647--ENTRY    1669<<ASSIGN   1676--ENTRY    1729>>ASSIGN
      1744--ENTRY    1750--ASSIGN   1821--ENTRY    1838<>CALL
PTWDS
      1410**DCL        12--PROC     1821--ENTRY
PTWDS.WD1
      1411**DCL      1829<<ASSIGN
PTWDS.WD2
      1414**DCL      1831<<ASSIGN   1832<<ASSIGN
RPTR$
      1409**DCL        12--PROC     1676--ENTRY    1729<<ASSIGN   1730--ASSIGN   1731--ASSIGN   1821--ENTRY
      1834<<ASSIGN
S$WSPTD.BLKNO
        61**DCL      1544<<ASSIGN   1547<<ASSIGN
S$WSPTD.NBLKS
        61**DCL      1549<<ASSIGN
S$WSPTD.P
        61**DCL      1548<<ASSIGN
SC_MM33
      1472**DCL-ENT  1684--CALL
SETLEN
      1837**PROC     1691--CALL     1823--CALL
SORT_SEGS
      1456**DCL      1777<<ASSIGN   1781>>IF       1781>>IF       1783>>ASSIGN   1784<<ASSIGN   1784>>ASSIGN
      1785<<ASSIGN   1793>>IF       1795>>ASSIGN   1803>>ASSIGN
S_NSCPU
PL6.E3A0      #001=MMS$WSQINIT File=MMS$WSQ.:E05TSI                              WED 07/30/97 03:23 Page:77   
      1492**DCL      1527>>DOINDEX  1541>>DOINDEX
S_WSPTD
        45**DCL      1631<<ASSIGN   1631>>ASSIGN   1632<<ASSIGN   1632>>ASSIGN   1633<<ASSIGN   1633>>ASSIGN
S_WSPTD.BLKNO
        45**DCL      1598<<ASSIGN   1600<<ASSIGN   1627<<ASSIGN   1629<<ASSIGN
S_WSPTD.NBLKS
        45**DCL      1602<<ASSIGN
S_WSPTD.P
        45**DCL      1601<<ASSIGN
TMP
      1440**DCL      1621<<ASSIGN   1623<<ASSIGN   1624>>IF
UPGT$
      1447**DCL      1706<<ASSIGN   1708<<ASSIGN   1710<<ASSIGN   1714>>IF       1723>>ASSIGN   1826<<ASSIGN
      1828<<ASSIGN   1829>>ASSIGN   1832>>ASSIGN
VBUFLEN
      1444**DCL      1695>>ASSIGN   1697>>DOINDEX  1713>>DOINDEX  1722>>DOINDEX  1725>>ASSIGN   1753<<ASSIGN
      1756>>DOINDEX  1759<>CALL     1796<<ASSIGN   1799>>DOINDEX  1805>>ASSIGN   1830>>IF       1840<<ASSIGN
VBUFPG
      1443**DCL      1714>>IF       1723>>ASSIGN   1750<<ASSIGN   1753>>ASSIGN   1757>>ASSIGN   1759<>CALL
      1795<<ASSIGN   1796>>ASSIGN   1797>>IF       1800>>ASSIGN   1801>>ASSIGN   1829>>ASSIGN   1832>>ASSIGN
      1839<<ASSIGN   1840>>ASSIGN
WSPTD$
      1441**DCL      1539<<ASSIGN   1544>>ASSIGN   1547>>ASSIGN   1548>>ASSIGN   1549>>ASSIGN
WSQN
      1404**DCL        12--PROC     1502>>ASSIGN   1503>>ASSIGN   1552>>IF       1564--ENTRY    1581<<ASSIGN
      1613--ENTRY    1616>>ASSIGN   1647--ENTRY    1658>>ASSIGN   1669>>ASSIGN   1676--ENTRY    1683>>IF
      1683>>IF       1692>>ASSIGN   1730>>ASSIGN   1744--ENTRY    1752>>ASSIGN   1759<>CALL     1770--ENTRY
      1790>>ASSIGN   1808<>CALL     1821--ENTRY
