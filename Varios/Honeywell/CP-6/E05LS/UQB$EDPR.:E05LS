VERSION E05

PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:1    
        1        1        /*M* UQB$EDPR  Main ENQ/DEQ logic module               */
        2        2        /*T***********************************************************/
        3        3        /*T*                                                         */
        4        4        /*T* Copyright (c) Bull HN Information Systems Inc., 1997    */
        5        5        /*T*                                                         */
        6        6        /*T***********************************************************/
        7        7        /*X* NSO,MCL=0,MOC,MEC,CLM=12,EXM=12,CRT=6,DMR,PLM=3,IND=3,ENU=0,DCI=3,
        8        8        CSU=3,ECU=3,THI=0,DTI=0,CRM=86 */
        9        9        UQB$EDPR: PROC(ARG1)ALTRET;
       10       10                    /**/
       11       11        %INCLUDE CP_6_SUBS;
       12      551        %INCLUDE UE_CP6;
       13     1242        %INCLUDE UM$CP6V_C;
       14     1429        %INCLUDE UM_CP6;
       15     2281        %B$ECCB;
       16     2289        %B$EVNT;
       17     2302        %INCLUDE B$USER;
       18     2518        %B$USERREFS;
       19     2522        %INCLUDE B$JIT_C;
       20     2836        %B$JIT0;
       21     2925        %U$JIT1X;
       22     2928        %M$JIT2X;
       23     2931        %F$JIT3;
       24     2936        %S$JIT4X;
       25     2939        %J$JIT5;
       26     3027        %A$JIT6;
       27     3037        %INCLUDE B$ROSEG;
       28     3100        %INCLUDE F$DCB;
       29     3149        %INCLUDE P_PMDAT_C;
       30     3269    1   DCL P_RESOURCE$ PTR SYMREF;
       31     3270        %P_RESOURCE;
       32     3384        %INCLUDE HF_LOCK_C;
       33     3398        %INCLUDE SS_SCHED_C;
       34     3631        %INCLUDE UQ$NODES;
       35     3762        %INCLUDE UQ_DATA_R;
       36     3775        %INCLUDE UQ_ERRORS_C;
       37     3797                    /**/
PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:2    
       38     3798        %SUB CANCEL_=0 /* Cancel */;
       39     3799        %SUB RELEASE_=1 /* Release */;
       40     3800        %SUB DELQENTRY_=2 /* Delqentry */;
       41     3801        %EJECT;
PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:3    
       42     3802    1   DCL ARG1 UBIN(36);
       43     3803    1   DCL ARG1B REDEF ARG1 BIT(36)ALIGNED;
       44     3804    1   DCL DOLIST$ REDEF ARG1 PTR ALIGNED;
       45     3805    1   DCL 1 PLUGH BASED ALIGNED,
       46     3806    1         2 ADR BIT(18),
       47     3807    1         2 EVID BIT(18);
       48     3808                    /*** *** *** *** *** *** *** ***/
       49     3809                    /* UQ$ MUST BE AT 4 IN AUTO    */
       50     3810                    /* FOR THE DEBUG CODE AT MENQ  */
       51     3811                    /*** *** *** *** *** *** *** ***/
       52     3812    1   DCL 1 UQ$,
       53     3813    1         2 QNAME,
       54     3814    1           3 * BIT(10),
       55     3815    1           3 KEY UBIN(5)UNAL,
       56     3816    1           3 * BIT(21),
       57     3817    1         2 RNAME$ PTR,
       58     3818    1         2 LENGTH SBIN,
       59     3819    1         2 LENC(0:3)REDEF LENGTH CHAR(1),
       60     3820    1         2 RHASH UBIN,
       61     3821    1         2 RHASHC(0:3)REDEF RHASH CHAR(1),
       62     3822    1         2 DOMAIN# UBIN(18)UNAL,
       63     3823    1         2 DEQ_COMMAND UBIN(18)UNAL,
       64     3824    1         2 MESSAGE$ PTR;
       65     3825    1   DCL UQ$B(0:5)BASED UBIN;
       66     3826    1   DCL 1 RNAME BASED(UQ$.RNAME$),
       67     3827    1         2 LEN CHAR(1),
       68     3828    1         2 TEXT CHAR(UQ$.LENGTH);
       69     3829        %FPT$ENQ_V(FPTN=QV,BASED=);
       70     3833        %SUB U_NULL=0;
       71     3834    1   DCL QID_PRE@ UBIN HALF;
       72     3835    1   DCL QID@ UBIN HALF;
       73     3836    1   DCL RNAME_PRE@ UBIN HALF;
       74     3837    1   DCL RNAME1@ UBIN HALF;
       75     3838    1   DCL RHASH_PRE@ UBIN HALF;
       76     3839    1   DCL RHASH@ UBIN HALF;
       77     3840    1   DCL QENTRY_PRE@ UBIN HALF;
       78     3841    1   DCL QENTRY@ UBIN HALF;
PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:4    
       79     3842    1   DCL NODE@ UBIN HALF;
       80     3843    1   DCL DLKNTRY@ UBIN HALF;
       81     3844        %SUB QENTRY$="PINCRW(U_BASE$,QENTRY@)";
       82     3845        %SUB QENTRY_PRE$="PINCRW(U_BASE$,QENTRY_PRE@)";
       83     3846        %SUB QID$="PINCRW(U_BASE$,QID@)";
       84     3847        %SUB QID_PRE$="PINCRW(U_BASE$,QID_PRE@)";
       85     3848        %SUB RNAME1$="PINCRW(U_BASE$,RNAME1@)";
       86     3849        %SUB RNAME_PRE$="PINCRW(U_BASE$,RNAME_PRE@)";
       87     3850        %SUB RHASH$="PINCRW(U_BASE$,RHASH@)";
       88     3851        %SUB RHASH_PRE$="PINCRW(U_BASE$,RHASH_PRE@)";
       89     3852        %SUB NODE$="PINCRW(U_BASE$,NODE@)";
       90     3853        %SUB DLKNTRY$="PINCRW(U_BASE$,DLKNTRY@)";
       91     3854    1   DCL 1 DOM_USER,
       92     3855    1         2 DOMAIN# UBIN(27)UNAL,
       93     3856    1         2 USER UBIN(9)UNAL;
       94     3857    1   DCL D_U REDEF DOM_USER UBIN;
       95     3858    1   DCL 1 ECCI,
       96     3859    1         2 WORDS UBIN,
       97     3860    1         2 MESSAGE UBIN;
       98     3861    1   DCL ERR SBIN;
       99     3862    1   DCL OCRD REDEF ERR BIT(36);
      100     3863    1   DCL MESSAGE UBIN BASED;
      101     3864    1   DCL PTR$ PTR BASED;
      102     3865    1   DCL 1 CRD,
      103     3866    1         2 ALLOC UBIN(3) UNAL,
      104     3867    1         2 CANCEL_EVENT BIT(1) UNAL,
      105     3868    1         2 SEND_MESSAGE BIT(1) UNAL,
      106     3869    1         2 * BIT(31);
      107     3870    1   DCL 1 CRD_(0:14) CONSTANT, /* Decision table for DEQ actions     */
      108     3871    1         2 ALLOC UBIN(3) UNAL INIT(0,7,0,5,1,0,0,7,0,5,3,0,7,0,0),
      109     3872    1         2 CANCEL_EVENT BIT(1) UNAL INIT('0'B*6,'1'B,'0'B,'1'B,
      110     3873    1           '1'B,'0'B,'1'B,'0'B*3),
      111     3874    1         2 SEND_MESSAGE BIT(1) UNAL INIT('0'B*3,'0'B,'1'B,'1'B,
      112     3875    1           '0'B*3,'0'B,'1'B,'1'B,'0'B,'1'B,'1'B),
      113     3876    1         2 * BIT(31)INIT('0'B*0);
      114     3877        %EJECT;
PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:5    
      115     3878        %FPT_ENQ(FPTN=MENQSHARE,STCLASS=CONSTANT,
      116     3879           WAIT=YES,
      117     3880           NO_DOWNGRADE=YES,
      118     3881           SHARE=ALL,
      119     3882           LIMITED_COM=YES,
      120     3883           WAIT_TIME=-2,
      121     3884           EVENT=0);
      122     3902        %FPT_ENQ(FPTN=MENQNONE,STCLASS=CONSTANT,
      123     3903           WAIT=YES,
      124     3904           NO_DOWNGRADE=NO,
      125     3905           SHARE=NONE,
      126     3906           LIMITED_COM=NO,
      127     3907           WAIT_TIME=-2,
      128     3908           EVENT=0);
      129     3926    1   DCL 1 MRNAME CONSTANT,
      130     3927    1         2 QNAME UBIN,
      131     3928    1         2 RNAME$ PTR INIT(ADDR(MRNAME)),
      132     3929    1         2 LENGTH UBIN INIT(0),
      133     3930    1         2 LENC(0:3)REDEF LENGTH CHAR(1),
      134     3931    1         2 RHASH UBIN INIT(0),
      135     3932    1         2 RHASHC(0:3)REDEF RHASH CHAR(1),
      136     3933    1         2 DOMAIN# UBIN(18)UNAL INIT(1),
      137     3934    1         2 DEQ_COMMAND UBIN(18)UNAL INIT(DELQENTRY_),
      138     3935    1         2 MESSAGE$ PTR INIT(ADDR(NIL));
      139     3936        %FPT_ENQ(FPTN=MENQNONEB,STCLASS=CONSTANT,
      140     3937           WAIT=YES,
      141     3938           NO_DOWNGRADE=NO,
      142     3939           SHARE=NONE,
      143     3940           LIMITED_COM=NO,
      144     3941           EVENT=0);
      145     3959        %FPT_ENQ(FPTN=MENQSHAREB,STCLASS=CONSTANT,
      146     3960           WAIT=YES,
      147     3961           NO_DOWNGRADE=YES,
      148     3962           SHARE=ALL,
      149     3963           LIMITED_COM=YES,
      150     3964           EVENT=0);
      151     3982    1   DCL 1 ERRCODE CONSTANT,
PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:6    
      152     3983    1         2 FCG BIT(12) UNAL INIT('2521'O),
      153     3984    1         2 MID BIT(6) UNAL INIT('02'O),
      154     3985    1         2 CODE UBIN(15) UNAL INIT(0),
      155     3986    1         2 SEV UBIN(3) UNAL INIT(2);
      156     3987        %SUB FCG#='2521'O;
      157     3988        %SUB MID#='02'O;
      158     3989        %ERRCODE(NAME=UQB$E$MISSING_PARAM,COD#=%E$MISSING_PARAM);
      159     3996        %ERRCODE(NAME=UQB$E$BAD_TIME,COD#=%E$BAD_TIME);
      160     4003        %ERRCODE(NAME=UQB$E$NOEADDR,COD#=%E$NOEADDR);
      161     4010        %ERRCODE(NAME=UQB$E$BAD_DCB,COD#=%E$BAD_DCB);
      162     4017        %ERRCODE(NAME=UQB$E$ENQ_LIMIT,COD#=%E$ENQ_LIMIT);
      163     4024        %ERRCODE(NAME=UQB$E$PDOMAIN,COD#=%E$PDOMAIN);
      164     4031        %ERRCODE(NAME=UQB$E$CRD_ERR,COD#=%E$CRD_ERR);
      165     4038        %ERRCODE(NAME=UQB$E$DLOCK,COD#=%E$DLOCK);
      166     4045        %ERRCODE(NAME=UQB$E$UQ_DOWNGRADE,COD#=%E$UQ_DOWNGRADE);
      167     4052        %ERRCODE(NAME=UQB$E$UQ_NOCHANGE,COD#=%E$UQ_NOCHANGE);
      168     4059        %ERRCODE(NAME=UQB$E$BAD_UPGRADE,COD#=%E$BAD_UPGRADE);
      169     4066        %ERRCODE(NAME=UQB$E$NO_UPGRADE,COD#=%E$NO_UPGRADE);
      170     4073    1   DCL B$PS0$ PTR SYMREF READONLY;
      171     4074    1   DCL B$PS1$ PTR SYMREF READONLY;
      172     4075    1   DCL B$PS2$ PTR SYMREF READONLY;
      173     4076        %FPT$ENQ_V;
      174     4080        %FPT$DEQ_V;
      175     4084    1   DCL B$ROSEG$ PTR SYMREF READONLY;
      176     4085        %SUB B$ROSEG=B$ROSEG$->B$ROSEG;
      177     4086    1   DCL B$JIT$ PTR SYMREF READONLY;
      178     4087    1   DCL IRM_SYSID UBIN SYMREF;
      179     4088    1   DCL UQ_ACCESS(0:7)CONSTANT SYMDEF
      180     4089    1     BIT(36)INIT(
      181     4090    1   '777'O*2,   /* ANY OK WITH NO REQUEST             */
      182     4091    1   '740'O,'770'O, /* A=A,AL; AL=A,AL,L,LL               */
      183     4092    1   '640'O,'050'O, /* L=AL;LL=AL,LL                      */
      184     4093    1   '600'O*2);  /* N=0                                */
      185     4094    1   DCL UQ_XLATE(0:7)CONSTANT SYMDEF BIT(36)INIT(
      186     4095    1   '4'O,'2'O,'1'O,'04'O,'02'O,'01'O,'004'O,'002'O);
      187     4096    1   DCL S_CUN SBIN WORD SYMREF;
      188     4097                    /**/
PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:7    
      189     4098    1   DCL HFF$NILERASE ENTRY(1)ALTRET;
      190     4099    1   DCL UQC$CHK ENTRY ALTRET;
      191     4100    1   DCL UQC$FDS ENTRY ALTRET;
      192     4101    1   DCL SSR$REG ENTRY(3) ALTRET;
      193     4102    1   DCL SSR$RUE ENTRY(4);
      194     4103    1   DCL SSV$EVENT ENTRY(7);
      195     4104    1   DCL SSV$XXDO ENTRY(3) ALTRET;
      196     4105    1   DCL SC_FMF98 ENTRY CONV(2,0);
      197     4106    1   DCL SC_FSERR ENTRY CONV(2,0);
      198     4107    1   DCL SC_EQMEM ENTRY CONV(2,0);
      199     4108    1   DCL SC_EQERR_B ENTRY CONV(2,0);
      200     4109                    /**/
      201     4110        %EJECT;
PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:8    
      202     4111                    /* GETNODE AND FREENODE MACROS */
      203     4112        %MACRO GETNODE(NODE=0);
      204     4113           UQ_.FREE_BLOCKS=UQ_.FREE_BLOCKS-1;
      205     4114           NODE=UQ_.NEXT_BLOCK@;
      206     4115           UQ_.NEXT_BLOCK@=PINCRW(U_BASE$,NODE)->AVAIL.NEXT_BLOCK@;
      207     4116        %MEND;
      208     4117                    /**/
      209     4118        %MACRO FREENODE(NODE=0);
      210     4119           PINCRW(U_BASE$,NODE)->AVAIL.TYPE=BINBIT(AVAIL_TYPE,9);
      211     4120           PINCRW(U_BASE$,NODE)->AVAIL.NEXT_BLOCK@=UQ_.NEXT_BLOCK@;
      212     4121           UQ_.NEXT_BLOCK@=NODE;
      213     4122           UQ_.FREE_BLOCKS=UQ_.FREE_BLOCKS+1;
      214     4123        %MEND;
      215     4124        %EJECT;
PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:9    
      216     4125                    /*F*   NAME:   UQB$ENQ_EVENT                                       */
      217     4126                    /*F*   PURPOSE: Scheduler entry called to set an ALLOCATION-PENDING*/
      218     4127                    /*,*           QENTRY to ALLOCATED before eventing a user for a    */
      219     4128                    /*,*           NOWAIT ENQ request which has been satisfied.        */
      220     4129                    /*F*   DESCRIPTION: Allocation of NOWAIT ENQ's is handled this way */
      221     4130                    /*,*           in order to prevent the race condition where a user */
      222     4131                    /*,*           cancels an outstanding NOWAIT ENQ request or re-    */
      223     4132                    /*,*           leases a resource he has an outstanding upgrade     */
      224     4133                    /*,*           request for at the same time that someone else      */
      225     4134                    /*,*           makes it possible for that resource to be allo-     */
      226     4135                    /*,*           cated to him, causing what would appear to be       */
      227     4136                    /*,*           spurious EVENTs for the user.                       */
      228     4137    1   UQB$ENQ_EVENT:ENTRY(ARG1) ALTRET;
      229     4138                    /* DOLIST$ ::= ARG1                                                 */
      230     4139                    /**/
      231     4140           %LOCK(G=U_LOCK);
      232     4143                    /* Get ptr to QENTRY from DOLIST */
      233     4144    1      QENTRY@ = DOLIST$->B$DO.EVID;
      234     4145                    /* Make sure the node looks reasonable */
      235     4146    1      IF ((QENTRY$->NODE.TYPE=QENTRY_TYPE) AND
      236     4147    1        (QENTRY$->QENTRY.STATE=ALLOC_PENDING))
      237     4148    2      THEN DO;
      238     4149                    /* Set event ID in DOLIST */
      239     4150    2         DOLIST$->B$DO.EVID = QENTRY$->QENTRY.EVENT_ID;
      240     4151    2         QENTRY$->QENTRY.STATE=ALLOCATED;
      241     4152    2         IF QENTRY$->QENTRY.UPGRADE
      242     4153    3         THEN DO;
      243     4154                    /* If this is an upgrade request, then change its status now. */
      244     4155    3            QENTRY$->QENTRY.REQUEST=QENTRY$->QENTRY.UPGRADE;
      245     4156    3            QENTRY$->QENTRY.UPGRADE='0'B;
      246     4157    3            RNAME1@ = QENTRY$->QENTRY.RNAME1@;
      247     4158                    /* And see if anyone else can be allocated now that this QENTRY    */
      248     4159                    /* has had its shareability status changed.                        */
      249     4160    3            CALL ALLOCATE;
      250     4161    3            END;
      251     4162    2         END;
      252     4163    2      ELSE DO; /* The DOLIST pointed at a bad node   */
PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:10   
      253     4164                    /*S*   SCREECH_CODE: UQB-S$EQERR                                   */
      254     4165                    /*S*   TYPE:   SCREECH                                             */
      255     4166                    /*S*   MESSAGE:UQB$ENQ_EVENT got an uneventful QENTRY passed,      */
      256     4167                    /*S*           or SSV$XXDO altreturned on a DEQ.                   */
      257     4168    2   ENQ_ERR: ;
      258     4169    2         CALL SC_EQERR_B;
      259     4170    2         END;
      260     4171    1      CALL UNLOCK;
      261     4172    1      RETURN;
      262     4173                    /**/
      263     4174        %EJECT;
PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:11   
      264     4175                    /*F*      NAME: UQB$UENQ
      265     4176                    *        PURPOSE: To request allocation using the parameters in the user
      266     4177                   *        FPT, as reduced by UQA$PMME to the UQ$ control structure (ARG1).
      267     4178                    */
      268     4179    1   UQB$UENQ: ENTRY(ARG1)ALTRET;
      269     4180    1      QV=B$PS0$->FPT$ENQ_V;
      270     4181    1      CALL ARGS ALTRET(BAD_FPT);
      271     4182    2      IF UQ$.RNAME$~=ADDR(NIL) AND QV.SHARE~=0 THEN DO;
      272     4183    3         IF QV.WAIT THEN DO;
      273     4184    3            IF QV.WAIT_TIME<-1 THEN B$JIT.ERR=UQB$E$BAD_TIME;
      274     4185                    /*E* ERROR: UQB-E$BAD_TIME-2
      275     4186                    *    MESSAGE:WAIT_TIME for M$ENQ must be positive or -1.
      276     4187                    */
      277     4188    3            END;
      278     4189    2         ELSE IF NOT ADDR(B$ROSEG.ECCB(7-UQ$.DOMAIN#))->
      279     4190    2              B$ECCB.FLAGS.EVTSET THEN B$JIT.ERR=UQB$E$NOEADDR;
      280     4191                    /*E* ERROR: UQB-E$NOEADDR-2
      281     4192                    *    MESSAGE: Nowait M$ENQ requires event control
      282     4193                    */
      283     4194    3         IF NOT B$JIT.ERR THEN DO;
      284     4195                    /* STORE IN MESSAGE SO IT WONT TRAP WITH GATES LOCKED */
      285     4196    3            IF UQ$.MESSAGE$~=ADDR(NIL) THEN UQ$.MESSAGE$->MESSAGE=ERR;
      286     4197    3            GOTO ENQ;
      287     4198    3            END;
      288     4199    2         END;
      289     4200    1      ELSE B$JIT.ERR=UQB$E$MISSING_PARAM;
      290     4201                    /*E* ERROR: UQB-E$MISSING_PARAM-2
      291     4202                    *    MESSAGE: RNAME and SHARE must be specified for M$ENQ
      292     4203                    */
      293     4204    1   BAD_FPT: ALTRETURN;
      294     4205        %EJECT;
PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:12   
      295     4206                    /*F*      NAME: UQB$MENQS
      296     4207                    *        PURPOSE: To request shared allocation of the monitor reserved
      297     4208                    *        resource (length=0) of the argument QID (CFU$).
      298     4209                    *        DESCRIPTION: This routine will not return until the resource
      299     4210                    *        is allocated. No deadlock detection is performed.
      300     4211                    */
      301     4212    1   UQB$MENQS: ENTRY(ARG1)ALTRET;
      302     4213    1      QV=MENQSHARE.V;
      303     4214    1      GOTO MENQ;
      304     4215        %EJECT;
PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:13   
      305     4216                    /*F*     NAME: UQB$MENQX
      306     4217                   *        PURPOSE: To request exclusive allocation of the monitor reserved
      307     4218                    *        resource (length=0) of the argument QID (CFU$).
      308     4219                    *        DESCRIPTION: This routine will not return until the resource
      309     4220                    *        is allocated. Only upgrade deadlock detection is performed.
      310     4221                    */
      311     4222    1   UQB$MENQX: ENTRY(ARG1)ALTRET;
      312     4223    1      QV=MENQNONE.V;
      313     4224    1      GOTO MENQ;
      314     4225        %EJECT;
PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:14   
      315     4226                    /*F*      NAME: UQB$MENQXB
      316     4227                   *        PURPOSE: To request exclusive allocation of the monitor reserved
      317     4228                    *        resource (length=0) of the argument QID (CFU$), BREAKably.
      318     4229                  *        DESCRIPTION: This routine will return when allocated or altreturn
      319     4230                    *        if interrupted. Only upgrade deadlock detection is performed.
      320     4231                    */
      321     4232    1   UQB$MENQXB: ENTRY(ARG1)ALTRET;
      322     4233    1      QV=MENQNONEB.V;
      323     4234    1      GOTO MENQ;
      324     4235        %EJECT;
PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:15   
      325     4236                    /*F*      NAME: UQB$MENQSB
      326     4237                    *        PURPOSE: To request shared allocation of the monitor reserved
      327     4238                    *        resource (length=0) of the argument QID (CFU$), BREAKably.
      328     4239                  *        DESCRIPTION: This routine will return when allocated or altreturn
      329     4240                    *        if interrupted. Only upgrade deadlock detection is performed.
      330     4241                    */
      331     4242    1   UQB$MENQSB: ENTRY(ARG1)ALTRET;
      332     4243    1      QV=MENQSHAREB.V;
      333     4244    1   MENQ:;
      334     4245    1      UQ$=MRNAME;
      335     4246    1      UQ$.QNAME=ARG1B;
      336     4247    1      ADDR(QV.EVENT)->PLUGH.EVID=PINCRW(ADDR(UQ$),-4)->PLUGH.ADR;
      337     4248        %EJECT;
PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:16   
      338     4249                    /**/
      339     4250                    /**/
      340     4251    1   ENQ: ;
      341     4252           %LOCK(G=U_LOCK); /* Lock the ENQ/DEQ tables            */
      342     4255                    /* Since we don't recover gracefully (like, not at all) from run-  */
      343     4256                    /* ning out of memory while building ENQ tables, anticipate all    */
      344     4257                    /* memory requirements before jumping into the fray.               */
      345     4258    1      D_U=S_CUN+UQ$.DOMAIN#*512;
      346     4259    1      CALL CHECK ALTRET(NOMEM);
      347     4260                    /* Locate/Insert a QID node for this QNAME (CFU) */
      348     4261    1      CALL QID_L ALTRET(QID_F);
      349     4262    1      CALL QID_I ALTRET (NOENQ);
      350     4263    1      GOTO NEWNTRY;
      351     4264    1   QID_F:;
      352     4265                    /* Locate/Insert an RNAME node group for this QID/resource name combo */
      353     4266    1      CALL RNAME_L ALTRET(RNAME_F);
      354     4267    1      CALL RNAME_I ALTRET (NOENQ);
      355     4268    1      GOTO NEWNTRY;
      356     4269    1   RNAME_F:;
      357     4270                    /* Locate/Insert a QENTRY node relating this RNAME/DOMAIN pair */
      358     4271    1      CALL QENTRY_L ALTRET(NOMEM);
      359     4272    1      IF QENTRY@=U_NULL THEN CALL QENTRY_I ALTRET(NOMEM);
      360     4273                    /* If the QENTRY is already allocated, then this is an upgrade of its */
      361     4274                    /* share mode and/or LCFLG status. Record the upgrades and set its */
      362     4275                    /* allocation status to "Updated-queued".                          */
      363     4276    1      ELSE IF QENTRY$->QENTRY.STATE~=ALLOCATED OR QENTRY$->QENTRY.UPGRADE
      364     4277    2         THEN DO;
      365     4278    2            CALL UNLOCK;
      366     4279    2            B$JIT.ERR=UQB$E$BAD_UPGRADE;
      367     4280                    /*E*   ERROR:  UQB-E$BAD_UPGRADE-2                                */
      368     4281                    /*E*   MESSAGE: Resource must be allocated before upgrade attempted.*/
      369     4282    2            ALTRETURN;
      370     4283    2            END;
      371     4284    2         ELSE DO;
      372     4285    2            QENTRY$->QENTRY.UPG_=QV.SHARE*2+BITBIN(QV.LIMITED_COM);
      373     4286    2            IF (UQ_ACCESS(QENTRY$->QENTRY.UPG_)&
      374     4287    2              UQ_ACCESS(QENTRY$->QENTRY.REQ_))=UQ_ACCESS(QENTRY$->QENTRY.REQ_)
PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:17   
      375     4288    3            THEN DO;
      376     4289    3               IF QV.NO_DOWNGRADE
      377     4290    4               THEN IF QENTRY$->QENTRY.REQ_=QENTRY$->QENTRY.UPG_ THEN DO;
      378     4291    4                     B$JIT.ERR=UQB$E$UQ_NOCHANGE;
      379     4292                    /*E* ERROR: UQB-E$UQ_NOCHANGE-2
      380     4293                         MESSAGE: You re-ENQ'd that item with exactly the same options.
      381     4294                    */
      382     4295    4                     GOTO NODWN;
      383     4296    4                     END;
      384     4297    4                  ELSE DO;
      385     4298    4                     B$JIT.ERR=UQB$E$UQ_DOWNGRADE;
      386     4299                    /*E* ERROR: UQB-E$UQ_DOWNGRADE-2
      387     4300                         MESSAGE: Attempted downgrade request
      388     4301                    */
      389     4302    4                     GOTO NODWN;
      390     4303    4                     END;
      391     4304    3               CRD='777'O;
      392     4305    3               QENTRY$->QENTRY.WAIT=QV.WAIT;
      393     4306    3               QENTRY$->QENTRY.EVENT_ID=QV.EVENT;
      394     4307    3               CALL ALLOC;
      395     4308    3               CALL ALLOCATE;
      396     4309    3               CALL UNLOCK;
      397     4310    3               RETURN;
      398     4311    3               END;
      399     4312    3            ELSE IF QV.NO_UPGRADE THEN DO;
      400     4313    3                  B$JIT.ERR=UQB$E$NO_UPGRADE;
      401     4314                    /*E* ERROR: UQB-E$NO_UPGRADE-2
      402     4315                         MESSAGE: Attempted upgrade request.
      403     4316                    */
      404     4317    3                  GOTO NODWN;
      405     4318    3                  END;
      406     4319    3            DO WHILE(QENTRY$->QENTRY.QCHAIN@~=U_NULL); /* MOVE TO TAIL OF ALLOCS*/
      407     4320    3               NODE@=QENTRY$->QENTRY.QCHAIN@;
      408     4321    4               IF NODE$->QENTRY.STATE=ALLOCATED THEN DO;
      409     4322    4                  QENTRY_PRE$->QENTRY.QCHAIN@=NODE@;
      410     4323    4                  QENTRY$->QENTRY.QCHAIN@=NODE$->QENTRY.QCHAIN@;
      411     4324    4                  NODE$->QENTRY.QCHAIN@=QENTRY@;
PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:18   
      412     4325    4                  QENTRY_PRE@=NODE@;
      413     4326    4                  END;
      414     4327    3               ELSE GOTO NEWNTRY;
      415     4328    3               END;
      416     4329    2            END;
      417     4330    1   NEWNTRY:;
      418     4331    1      QENTRY$->QENTRY.WAIT=QV.WAIT;
      419     4332    1      QENTRY$->QENTRY.EVENT_ID=QV.EVENT;
      420     4333                    /* See if this QENTRY is currently allocatable */
      421     4334    1      NODE@=RNAME1$->RNAME1.QCHAIN@;
      422     4335    1      CRD='777'O;
      423     4336    2      DO WHILE(NODE@~=U_NULL);
      424     4337    3         IF NODE@~=QENTRY@ THEN DO;
      425     4338    4            IF NODE$->QENTRY.STATE=ALLOCATED THEN DO;
      426     4339    4               CRD=UQ_ACCESS(NODE$->QENTRY.REQ_)&CRD;
      427     4340    5               IF NODE$->QENTRY.UPGRADE THEN DO;
      428     4341    5                  IF QENTRY$->QENTRY.UPGRADE AND QV.WAIT
      429     4342    5                    AND NODE$->QENTRY.WAIT AND UQ$.DOMAIN#=1
      430     4343    5                    AND NOT UQ_ACCESS(NODE$->QENTRY.UPG_) &
      431     4344    5                    UQ_XLATE(QENTRY$->QENTRY.REQ_) THEN GOTO DLOCK;
      432     4345                    /*E*  ERROR:  UQB-E$DLOCK-2
      433     4346                          MESSAGE:ENQ request would wait forever (deadlock detected).
      434     4347                          MESSAGE1:A wait ENQ request would result in a circular chain of
      435     4348                                   unsatisfied wait ENQ requests.  It was not honored.
      436     4349                    */
      437     4350    5                  CRD=UQ_ACCESS(NODE$->QENTRY.UPG_)&CRD;
      438     4351    5                  END;
      439     4352    4               END;
      440     4353    3            ELSE GOTO NOTNOW;
      441     4354    3            NODE@=NODE$->QENTRY.QCHAIN@;
      442     4355    3            END;
      443     4356    2         ELSE NODE@=0; /* THIS ENTRY MUST BE AT THE END OF ALLOCATEDS  */
      444     4357    2         END;
      445     4358    1      CALL ALLOC ALTRET(NOTNOW);
      446     4359    2      DO WHILE('0'B);
      447     4360    2   NOTNOW:;
      448     4361    3         IF QV.WAIT THEN DO;
PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:19   
      449     4362    3            S$CU$->B$U.ENQ.WAIT=QENTRY@;
      450     4363    3            QENTRY$->QENTRY.DLKFLNK@=0;
      451     4364                    /* Check for deadlock */
      452     4365    4            IF UQ$.DOMAIN#>1 AND QID@~=QENTRY_PRE@ THEN DO;
      453     4366    4               DLKNTRY@=0;
      454     4367    4   RE_CHECK:   RHASH@=QENTRY@; /* SET TAIL OF LISTED QENTRIES (USERS)     */
      455     4368    4               QID@=QENTRY@;
      456     4369    5               DO WHILE(QID@~=U_NULL);
      457     4370    5                  OCRD=UQ_XLATE(QID$->QENTRY.REQ_);
      458     4371    5                  CRD=OCRD;
      459     4372    5                  IF QID$->QENTRY.UPGRADE
      460     4373    5                  THEN CRD=UQ_XLATE(QID$->QENTRY.UPG_);
      461     4374    5                  NODE@=PINCRW(U_BASE$,QID$->QENTRY.RNAME1@)->RNAME1.QCHAIN@;
      462     4375    6                  DO WHILE(NODE@~=U_NULL);
      463     4376    7                     IF NODE$->QENTRY.STATE=ALLOCATED THEN DO;
      464     4377    7                        IF NODE@~=QID@ /* IF THE WAITER WAITS FOR THIS ONE */
      465     4378    7                          AND (NOT UQ_ACCESS(NODE$->QENTRY.REQ_)&CRD
      466     4379    7                          OR NOT UQ_ACCESS(NODE$->QENTRY.UPG_)&OCRD)
      467     4380    8                        THEN IF NODE$->QENTRY.DOM_USER.USER=S_CUN THEN DO;
      468     4381    8                              NODE@=QID@;
      469     4382    9                              DO WHILE(NODE@~=U_NULL);
      470     4383    9                                 RHASH@=NODE$->QENTRY.DLKFLNK@;
      471     4384    9                                 NODE$->QENTRY.DLKFLNK@=0;
      472     4385    9                                 NODE@=RHASH@;
      473     4386    9                                 END;
      474     4387    8                              IF DLKNTRY@~=0 THEN GOTO DLOCK;
      475     4388    8                              DLKNTRY@=QENTRY@; /* FIND THE LEAST B$U.ENQCOUNT */
      476     4389    9                              DO WHILE(QID@~=QENTRY@);
      477     4390    9                                 IF B$USRT$->B$USER.ENQ.COUNT
      478     4391    9                                   (QID$->QENTRY.DOM_USER.USER)
      479     4392    9                                   <B$USRT$->B$USER.ENQ.COUNT(DLKNTRY$->
      480     4393    9                                   QENTRY.DOM_USER.USER) THEN DLKNTRY@=QID@;
      481     4394    9                                 QID@=QID$->QENTRY.DLKBLNK@;
      482     4395    9                                 END;
      483     4396    8                              IF DLKNTRY@=QENTRY@ THEN GOTO DLOCK;
      484     4397    8                              ELSE GOTO RE_CHECK; /* MAKE SURE IT'LL WORK */
      485     4398    8                              END;
PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:20   
      486     4399    8                           ELSE DO;
      487     4400    8                              RHASH_PRE@=B$USRT$->B$USER.ENQ.WAIT(NODE$->
      488     4401    8                                QENTRY.DOM_USER.USER);
      489     4402    8                              IF RHASH_PRE@~=U_NULL AND RHASH_PRE@~=DLKNTRY@
      490     4403    8                                AND RHASH_PRE$->QENTRY.WAIT
      491     4404    9                                AND RHASH_PRE$->QENTRY.DLKFLNK@=0 THEN DO;
      492     4405    9                                 RHASH$->QENTRY.DLKFLNK@=RHASH_PRE@;
      493     4406    9                                 RHASH@=RHASH_PRE@;
      494     4407    9                                 RHASH$->QENTRY.DLKBLNK@=QID@;
      495     4408    9                                 END;
      496     4409    8                              END;
      497     4410    7                        NODE@=NODE$->QENTRY.QCHAIN@;
      498     4411    7                        END;
      499     4412    6                     ELSE NODE@=U_NULL;
      500     4413    6                     END;
      501     4414    5                  RHASH_PRE@=QID$->QENTRY.DLKFLNK@;
      502     4415    5                  QID$->QENTRY.DLKFLNK@=0;
      503     4416    5                  QID@=RHASH_PRE@;
      504     4417    5                  END;
      505     4418    5               IF DLKNTRY@~=0 THEN DO;
      506     4419    5                  DLKNTRY$->QENTRY.WAIT='0'B;
      507     4420    5                  DLKNTRY$->QENTRY.DOM_USER.DOMAIN#=0;
      508     4421    5                  CALL SSR$RUE(%SS_NQR,DLKNTRY$->QENTRY.DOM_USER.USER);
      509     4422    5                  END;
      510     4423    4               END;
      511     4424                    /* ...and unlock the ENQ/DEQ tables while we park, waiting for the */
      512     4425                    /* QENTRY to become allocatable or the WAIT_TIME to elapse.        */
      513     4426    3            CALL UNLOCK;
      514     4427    3            IF QV.WAIT_TIME~=0
      515     4428    4            THEN DO;
      516     4429    4               ERR = %E$BREAK;
      517     4430                    /*E*  ERROR:  UQB-E$BREAK-2
      518     4431                          MESSAGE:  Break or cntl Y occurred while waiting for ENQ.
      519     4432                    */
      520     4433    4               CALL SSR$REG(%SS_NQW,ADDR(NIL),QV.WAIT_TIME)
      521     4434    4                 ALTRET(BREAK);
      522     4435    4               END;
PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:21   
      523     4436    3            ERR = %E$TIMELIMIT; /* He woke up w/o getting DEQ'd       */
      524     4437    3   BREAK:   ;
      525     4438                    /* If we came straight here off of the REG, then this user was     */
      526     4439                    /* woken up by someone else's DEQ, and the QENTRY should now be    */
      527     4440                    /* marked "ALLOCATED". (See UQE$ALLOCATE)                          */
      528     4441                 %LOCK(G=U_LOCK); /* Re-lock the ENQ/DEQ tables*/
      529     4444    3            S$CU$->B$U.ENQ.WAIT=0;
      530     4445    3            IF QENTRY$->QENTRY.STATE=QUEUED OR
      531     4446    3              QENTRY$->QENTRY.UPGRADE
      532     4447    4            THEN DO;
      533     4448                    /* Take care of the case where he timed out on the wait (i.e. he's */
      534     4449                    /* still QUEUED or UQUEUED.                                        */
      535     4450                    /*    If this ENQ was an update request we timed out on, then mark */
      536     4451                    /*      the node allocated but return the user an error code.      */
      537     4452                    /*    If it was a standard ENQ, delete the queue entry and return  */
      538     4453                    /*      an error code.                                             */
      539     4454    5               IF NOT QENTRY$->QENTRY.WAIT THEN DO;
      540     4455    5                  QENTRY$->QENTRY.DOM_USER.DOMAIN#=DOM_USER.DOMAIN#;
      541     4456    5                  ERR=%E$DLOCK;
      542     4457    5                  END;
      543     4458                    /* SOMEBODY ELSE KNOCKED US OUT */
      544     4459    4               QENTRY$->QENTRY.WAIT='0'B;
      545     4460    4               IF QENTRY$->QENTRY.UPGRADE
      546     4461    4               THEN QENTRY$->QENTRY.UPGRADE='0'B;
      547     4462    5               ELSE DO;
      548     4463    5                  CALL QENTRY_L;
      549     4464    5                  CALL QENTRY_DQ;
      550     4465    5                  END;
      551     4466    4               CALL ALLOCATE;
      552     4467    4               CALL UNLOCK;
      553     4468    4               B$JIT.ERR=ERRCODE;
      554     4469    4               B$JIT.ERR.CODE=ERR;
      555     4470    4               IF ERR=%E$BREAK THEN B$JIT.JUNK=B$JIT.JUNK|%JJ_BAKIC#;
      556     4471                    /*E*   ERROR:  UQB-E$TIMELIMIT-2                                  */
      557     4472                    /*E*   MESSAGE: ENQ/DEQ wait time limit exceeded.                  */
      558     4473    4               ALTRETURN;
      559     4474    4               END;
PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:22   
      560     4475                    /* To get here, we must have gotten the QENTRY allocated. */
      561     4476                    /**/
      562     4477                    /* Pass any message back to the user, if he asked for it */
      563     4478    3            IF UQ$.MESSAGE$~=ADDR(NIL)
      564     4479    3            THEN UQ$.MESSAGE$->MESSAGE=RNAME1$->RNAME1.COMM;
      565     4480    3            END;
      566     4481    2         END;
      567     4482    1      CALL UNLOCK;
      568     4483    1      RETURN;
      569     4484                    /**/
      570     4485        %EJECT;
PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:23   
      571     4486                    /*F*      NAME: UQB$TESTNQR
      572     4487                    *         PURPOSE: Entry for testing purposes for simulating wakeup
      573     4488                    *                  from SSR$REG.
      574     4489                    */
      575     4490    1   UQB$TESTNQR: ENTRY ALTRET;
      576     4491    1      QENTRY@=S$CU$->B$U.ENQ.WAIT;
      577     4492    1      RNAME1@=QENTRY$->QENTRY.RNAME1@;
      578     4493    1      D_U=QENTRY$->QENTRY.D_U;
      579     4494    1      ERR=%E$TIMELIMIT;
      580     4495    1      GOTO BREAK;
      581     4496                    /*F*      NAME: UQB$MDEQ
      582     4497                    *         PURPOSE: To release the reserved monitor resource.
      583     4498                    */
      584     4499    1   UQB$MDEQ: ENTRY(ARG1)ALTRET;
      585     4500    1      UQ$=MRNAME;
      586     4501    1      UQ$.QNAME=ARG1B;
      587     4502    1      GOTO DEQ;
      588     4503        %EJECT;
PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:24   
      589     4504                    /*F*      NAME: UQB$UDEQ
      590     4505                    *         PURPOSE: To perform a user M$DEQ request.
      591     4506                    */
      592     4507    1   UQB$UDEQ: ENTRY(ARG1)ALTRET;
      593     4508    1      QV=B$PS0$->FPT$DEQ_V;
      594     4509    1      CALL ARGS ALTRET(BAD_FPT);
      595     4510    1      UQ$.DEQ_COMMAND=2*BITBIN(ADDR(QV)->FPT$DEQ_V.RELRES) +
      596     4511    1        BITBIN( ADDR(QV)->FPT$DEQ_V.CANCEL)-1;
      597     4512    1      IF UQ$.DEQ_COMMAND>DELQENTRY_ THEN RETURN;
      598     4513                    /**/
      599     4514                    /**/
      600     4515    1   DEQ: ;
      601     4516           %LOCK(G=U_LOCK); /* Lock the ENQ/DEQ tables            */
      602     4519    1      D_U=S_CUN+UQ$.DOMAIN#*512;
      603     4520                    /* Find a QID node for the specified QNAME (CFU) */
      604     4521    2      CALL QID_L WHENALTRETURN DO;
      605     4522    2         IF ADDR(RNAME)~=ADDR(NIL)
      606     4523    3         THEN CALL RNAME_L WHENRETURN DO;
      607     4524    3               GOTO NODEQ;
      608     4525    3               END; WHENALTRETURN DO;
      609     4526    3               CALL DEQ_PROC ALTRET(NODEQ);
      610     4527    3               END;
      611     4528    3         ELSE DO; /* Do if 'ALL' specified              */
      612     4529    3   DEQID:   ;
      613     4530    3            RHASH_PRE@=QID@;
      614     4531    3            RHASH@=QID$->QID.XCHAIN@;
      615     4532                    /* Loop through all of the RNAMEs for the CFU */
      616     4533    4            DO WHILE(RHASH@~=U_NULL);
      617     4534    4               RNAME_PRE@ = U_NULL;
      618     4535    4               RNAME1@=RHASH@;
      619     4536    5               DO WHILE (RNAME1@ ~= U_NULL);
      620     4537    5                  QENTRY@=RNAME1$->RNAME1.QCHAIN@;
      621     4538    5                  QENTRY_PRE@=RNAME1@;
      622     4539    5                  IF D_U~=0 OR QENTRY@=U_NULL THEN CALL DEQ_PROC;
      623     4540    6                  ELSE DO WHILE(QENTRY@~=U_NULL);
      624     4541    6                     IF QENTRY$->QENTRY.DOM_USER.USER=S_CUN
      625     4542    6                     THEN CALL DEQ_QID ALTRET(ENQ_ERR);
PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:25   
      626     4543    6                     ELSE QENTRY_PRE@=QENTRY@;
      627     4544    6                     QENTRY@=QENTRY_PRE$->QENTRY.QCHAIN@;
      628     4545    6                     END;
      629     4546    5                  UQ$.LENGTH=1; /* RELEASE ALL BUT MONITOR RNAME NODES */
      630     4547    5                  RNAME_PRE@ = RNAME1@;
      631     4548    5                  IF RNAME1@=U_NULL THEN RNAME1@=RHASH@;
      632     4549    5                  ELSE RNAME1@ = RNAME1$->RNAME1.RCHAIN@;
      633     4550    5                  END;
      634     4551    4               IF RHASH@~=U_NULL THEN RHASH_PRE@=RHASH@;
      635     4552    4               RHASH@=RHASH_PRE$->RNAME1.XCHAIN@;
      636     4553    4               END;
      637     4554    3            END;
      638     4555                    /* DELQIDX SHOULD DELETE THE QID ENTRY     */
      639     4556    3         IF D_U=0 AND UQ$.DOMAIN#=0 AND QID@~=UQ_.NEXT_BLOCK@ THEN DO;
      640     4557    3            CALL UNLOCK;
      641     4558    3            CALL SC_FSERR;
      642     4559    3            END;
      643     4560    2         IF UQ$.DOMAIN#>3 THEN B$JIT.ERR='0'B;
      644     4561    2         CALL UNLOCK;
      645     4562    2         RETURN;
      646     4563    2         END;
      647     4564    1   NODEQ:;
      648     4565    1      CALL UNLOCK; /* Unlock the ENQ/DEQ tables          */
      649     4566    1      IF UQ$.RNAME$=ADDR(NIL) OR UQ$.LENGTH~=0 THEN B$JIT.ERR=UQB$E$CRD_ERR;
      650     4567                    /*E*   ERROR:  UQB-E$CRD_ERR-2                                    */
      651     4568                    /*E*   MESSAGE: Type of DEQ incompatible with state.               */
      652     4569    1      ELSE CALL SC_FMF98;
      653     4570                    /*S*   SCREECH_CODE: UQB-S$FSERR
      654     4571                    *      TYPE:  SUA
      655     4572                    *      MESSAGE: File management ENQ altreturn.
      656     4573                    */
      657     4574    1      ALTRETURN;
      658     4575        %EJECT;
PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:26   
      659     4576                    /*F*   NAME:   UQB$DELUSER                                         */
      660     4577              /*F*   PURPOSE: To clean up any remaining QENTRY nodes associated with   */
      661     4578              /*,*           the current user at termination. The existence thereof is */
      662     4579              /*,*           an indication that a DCB did not get closed, so a dump is */
      663     4580              /*,*           always produced.                                          */
      664     4581    1   UQB$DELUSER:ENTRY ALTRET;
      665     4582                    /**/
      666     4583    1      D_U=1;
      667     4584    1      IF UQ_.GDS_LOCK=S_CUN THEN UQ_.GDS_LOCK=0;
      668     4585    1      NODE@=UQ_.NEXT_PAGE@;
      669     4586    1      QENTRY@=SIZEW(UQ_);
      670     4587    2      DO WHILE(QENTRY@<NODE@);
      671     4588    2         IF QENTRY$->NODE.TYPE=QENTRY_TYPE
      672     4589    3           AND QENTRY$->QENTRY.DOM_USER.USER=S_CUN THEN DO;
      673     4590    3            IF D_U~=0 AND B$JIT.SYSID~=IRM_SYSID THEN CALL SC_FMF98;
      674     4591    3            D_U=0; /* ONLY ONCE */
      675     4592    3            QID@=PINCRW(U_BASE$,QENTRY$->QENTRY.RNAME1@)->RNAME1.RHEAD@;
      676     4593    3            CALL UQB$DELQID(QID$->QID.NAME); /* DEQALL */
      677     4594    3            RNAME1@=QID$->QID.XCHAIN@;
      678     4595    3            IF RNAME1@=U_NULL OR RNAME1$->RNAME1.XCHAIN@=U_NULL
      679     4596    3              AND RNAME1$->RNAME1.QCHAIN@=U_NULL AND RNAME1$->RNAME1.RCHAIN@=U_NULL
      680     4597    3            THEN CALL UQB$DELQIDX(QID$->QID.NAME);
      681     4598    3            END;
      682     4599    2         QENTRY@=QENTRY@+BLKSZE;
      683     4600    2         END;
      684     4601    1      RETURN;
      685     4602        %EJECT;
PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:27   
      686     4603                    /*F*   NAME:   UQB$DELQID                                          */
      687     4604            /*F*   ENTRY: UQB$DELQIDX                                                     */
      688     4605                    /*F*   PURPOSE: To delete the association, if any, between the     */
      689     4606                    /*,*           RNAMEs existing for the resource group specified by */
      690     4607                    /*,*           QNAME and the current user.                         */
      691     4608                   /*F*   DESCRIPTION: If entered at DELQIDX, then the QID and all assoc- */
      692     4609                    /*,*           iated RNAMEs owned solely by the current user are   */
      693     4610                    /*,*           also deleted. If all RNAME nodes     for the spec-  */
      694     4611                    /*,*           ified QNAME aren't owned by the current user, then a */
      695     4612                    /*,*           a screech will be caused.                           */
      696     4613    1   UQB$DELQID: ENTRY(ARG1) ALTRET;
      697     4614                    /**/
      698     4615    1      UQ$=MRNAME;
      699     4616    1      D_U=S_CUN+512; /* First DEQ any monitor ENQs */
      700     4617    1      IF B$JIT.DCB$->F$DCB.WSR~=0
      701     4618    1      THEN UQ$.DOMAIN#=B$JIT.DCB$->F$DCB.WSR;
      702     4619    2      IF ADDR(ARG1)=ADDR(B$JIT.DCB$->F$DCB.CFU$) THEN DO;
      703     4620    3         DO ERR=%M$MAXNEG# TO B$ROSEG.NUMDCBS;
      704     4621    3            IF DCBADDR(ERR)~=ADDR(NIL) AND DCBADDR(ERR)~=B$JIT.DCB$
      705     4622    3            THEN IF DCBADDR(ERR)->F$DCB.FCD
      706     4623    3                 AND DCBADDR(ERR)->F$DCB.CFU$=DOLIST$ THEN GOTO DEQID0;
      707     4624                    /* DOLIST$ is a redef of ARG1 */
      708     4625    3            END;
      709     4626    2         D_U = 0; /* DEQALL if this is the last DCB for this user */
      710     4627    2         END;
      711     4628    1   DEQID0:;
      712     4629    1      UQ$.QNAME=ARG1B;
      713     4630           %LOCK(G=U_LOCK);
      714     4633    2      IF D_U~=0 THEN DO;
      715     4634                    /* First DEQ any monitor ENQs */
      716     4635    3         CALL QID_L WHENALTRETURN DO;
      717     4636    4            CALL RNAME_L WHENALTRETURN DO;
      718     4637    4               CALL DEQ_PROC;
      719     4638    4               END;
      720     4639    3            END;
      721     4640    2         D_U=S_CUN+UQ$.DOMAIN#*512; /* Then only openers ones */
      722     4641    2         END;
PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:28   
      723     4642    1      UQ$.RNAME$=ADDR(NIL);
      724     4643    1      CALL QID_L ALTRET(DEQID);
      725     4644    1      CALL UNLOCK;
      726     4645    1      RETURN;
      727     4646    1   UQB$DELQIDX: ENTRY(ARG1) ALTRET;
      728     4647                    /* RELEASE LAST TIME..GET RID OF ALL ENTRIES    */
      729     4648    1      UQ$=MRNAME;
      730     4649    1      UQ$.LENGTH=1; /* EVEN MONITOR RESERVED RESOURCE     */
      731     4650    1      UQ$.DOMAIN#=0; /* INDICATE DELQIDX                   */
      732     4651    1      D_U=0;   /* SET FLAG FOR DELQID                */
      733     4652    1      GOTO DEQID0;
      734     4653        %EJECT;
PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:29   
      735     4654                    /* Altreturns */
      736     4655    1   NOENQ: ;    /* Hit the user ENQ limit. Release the RNAME entry. */
      737     4656    1      CALL RNAME_D;
      738     4657    1   NOMEM: ;    /* Out of ENQ/DEQ table space (DS# full)   */
      739     4658    1      CALL UNLOCK;
      740     4659    1      IF UQ$.DOMAIN#=1 THEN CALL SC_EQMEM; /* MONITOR NEVER ALTRETS              */
      741     4660                    /*S*    SCREECH_CODE: UQB-S$MMERR
      742     4661                    *       TYPE: SUA
      743     4662                    *       MESSAGE: File management needs more ENQ space.
      744     4663                    *                Check the TIGR ENQ command.
      745     4664                    */
      746     4665    1      ALTRETURN;
      747     4666    1   DLOCK: ;    /* Deadlock detected                  */
      748     4667    1      S$CU$->B$U.ENQ.WAIT=0;
      749     4668    1      QENTRY$->QENTRY.WAIT='0'B;
      750     4669    1      UQ$.DOMAIN#=0; /* DONT SCREECH FOR MONITOR DEADLOCK  */
      751     4670    1      B$JIT.ERR=UQB$E$DLOCK;
      752     4671    1   NODWN:;
      753     4672    1      IF QENTRY$->QENTRY.UPGRADE THEN QENTRY$->QENTRY.UPGRADE='0'B;
      754     4673    1      ELSE CALL QENTRY_DQ;
      755     4674    1      CALL UNLOCK;
      756     4675    1      IF UQ$.DOMAIN#=1 THEN CALL SC_FSERR; /* MONITOR NEVER ALTRETS              */
      757     4676    1      ALTRETURN;
      758     4677        %EJECT;
PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:30   
      759     4678                    /* Perform the DEQ processing, once an RNAME and a DOMAIN node have */
      760     4679                    /* been selected.                                                   */
      761     4680    1   DEQ_PROC: PROC ALTRET;
      762     4681                    /**/
      763     4682                    /* Then find the QENTRY which relates them */
      764     4683    2      CALL QENTRY_L;
      765     4684    2      IF QENTRY@ ~= U_NULL
      766     4685    3      THEN DO;
      767     4686    3         IF ADDR(QV)->FPT$DEQ_V.SELECTIVE AND ADDR(RNAME)=ADDR(NIL)
      768     4687    3           AND ADDR(QV)->FPT$DEQ_V.SELECT_ID~=QENTRY$->QENTRY.EVENT_ID
      769     4688    3         THEN RETURN;
      770     4689                    /* Get the decision table entry for this combination of allocation */
      771     4690                    /* status and DEQ options.                                         */
      772     4691    3   DEQID: ;
      773     4692    3         ERR=QENTRY$->QENTRY.STATE*2;
      774     4693    3         IF QENTRY$->QENTRY.UPGRADE THEN ERR=5-ERR;
      775     4694    3         CRD=CRD_(3*ERR+UQ$.DEQ_COMMAND);
      776     4695                    /* If the new allocation status from the decision table shows that */
      777     4696                    /* a valid transition can be made, then process it.                */
      778     4697    3         IF CRD.ALLOC<=5
      779     4698    4         THEN DO;
      780     4699    4            IF CRD.CANCEL_EVENT
      781     4700    5            THEN DO;
      782     4701                    /* If a possible outstanding event should be cancelled, then do it.*/
      783     4702    5               CALL SSV$XXDO(QENTRY$->QENTRY.DOM_USER.USER,
      784     4703    5                 %EVSC_ENQ#,QENTRY$)
      785     4704    5                 ALTRET(BOMB);
      786     4705    5               END;
      787     4706                    /* If a message can be associated with the RNAME for the next user */
      788     4707                    /* to examine, and a message was specified, then pass it.          */
      789     4708    4            IF CRD.SEND_MESSAGE
      790     4709    4            THEN IF UQ$.MESSAGE$~=ADDR(NIL)
      791     4710    4               THEN RNAME1$->RNAME1.COMM=UQ$.MESSAGE$->MESSAGE;
      792     4711                    /* If the new allocation status is null, then the QENTRY should be */
      793     4712                    /* deleted, otherwise it should be set to the new allocation status*/
      794     4713    4            IF CRD.ALLOC=0 THEN CALL QENTRY_DQ;
      795     4714    5            ELSE DO;
PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:31   
      796     4715    5               QENTRY$->QENTRY.STATE=CRD.ALLOC/2;
      797     4716    5               QENTRY$->QENTRY.UPGRADE='0'B;
      798     4717    5               END;
      799     4718                    /* See if we can allocate this RNAME to anybody else now. */
      800     4719    4            CALL ALLOCATE;
      801     4720                    /* If this is a release where we're supposed to delete all possible*/
      802     4721                    /* nodes, then do so.                                              */
      803     4722    4   DERNAME: IF UQ$.LENGTH~=0 AND RNAME1$->RNAME1.QCHAIN@=U_NULL
      804     4723                    /* If no other QENTRYs are hooked to this RNAME, delete it. */
      805     4724    4            THEN CALL RNAME_D;
      806     4725    4            RETURN;
      807     4726    4            END;
      808     4727    3         END;
      809     4728    2      ELSE IF D_U=0 THEN GOTO DERNAME;
      810     4729    2      ALTRETURN;
      811     4730    2   DEQ_QID: ENTRY ALTRET;
      812     4731    2      GOTO DEQID;
      813     4732    2   BOMB:;
      814     4733    2      CALL SC_EQERR_B;
      815     4734    2   END DEQ_PROC;
      816     4735                    /**/
      817     4736        %EJECT;
PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:32   
      818     4737    1   LID_SUBROUTINES: PROC ALTRET;
      819     4738    2   DCL PRE@ UBIN HALF;
      820     4739        %SUB PRE$="PINCRW(U_BASE$,PRE@)";
      821     4740                    /* Locate/Insert/Delete a specified QID (CFU) node                 */
      822     4741                    /* NOTE: The QID chains are kept in sorted, ascending order by     */
      823     4742                    /*       QNAME (CFU pointer) value.                                */
      824     4743    2   QID_L: ENTRY ALTRET;
      825     4744                    /* Get head of QID chain for that hashed CFU pointer value */
      826     4745    2      QID_PRE@=UQ$.QNAME.KEY-1/* 1=POFFW(ADDR(QID.HCHAIN@),ADDR(QID)) */;
      827     4746    2      QID@=QID_PRE$->QID.HCHAIN@;
      828     4747                    /* Search the QID chain for this QNAME until we either find it or  */
      829     4748                    /* pass the position where it should have been.                    */
      830     4749    3      DO WHILE(QID@~=U_NULL);
      831     4750    3         IF QID$->QID.NAME~=UQ$.QNAME
      832     4751    3         THEN IF QID$->QID.NAME>UQ$.QNAME THEN QID@=U_NULL;
      833     4752    4            ELSE DO;
      834     4753    4               QID_PRE@=QID@;
      835     4754    4               QID@=QID$->QID.HCHAIN@;
      836     4755    4               END;
      837     4756    3         ELSE ALTRETURN;
      838     4757    3         END;
      839     4758    2      RETURN;
      840     4759                    /* Process Locate & Insert requests... */
      841     4760        %EJECT;
PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:33   
      842     4761                    /* Locate/Insert a specified RNAME (resource element)              */
      843     4762                    /* NOTE:  The RNAME chains are kept in sorted, ascending order     */
      844     4763                    /*        based on the ASCII values and lengths of the resource    */
      845     4764                    /*        element names.                                           */
      846     4765    2   RNAME_L: ENTRY ALTRET;
      847     4766                    /**/
      848     4767                    /* Get offset to 1st RNAME node for this QID HASH */
      849     4768    2      RNAME_PRE@=U_NULL;
      850     4769    2      RHASH_PRE@=QID@;
      851     4770    2      RHASH@=QID$->QID.XCHAIN@;
      852     4771    3      DO WHILE(RHASH@~=U_NULL);
      853     4772    3         ERR=RHASH$->RNAME1.RHASH-UQ$.RHASH;
      854     4773    3         IF ERR>0 THEN RHASH@=U_NULL;
      855     4774    4         ELSE IF ERR<0 THEN DO;
      856     4775    4               RHASH_PRE@=RHASH@;
      857     4776    4               RHASH@=RHASH$->RNAME1.XCHAIN@;
      858     4777    4               END;
      859     4778    4            ELSE DO;
      860     4779                    /* Search the RNAME chain for the specified resource until we      */
      861     4780                    /* either find it or pass the position where it should have been.  */
      862     4781    4               RNAME1@=RHASH@;
      863     4782    5               DO WHILE(RNAME1@~=U_NULL);
      864     4783    5                  PRE@=RNAME1$->RNAME1.NCHAIN@;
      865     4784    5                  IF PRE@=U_NULL THEN IF UQ$.LENGTH=0 THEN ALTRETURN;
      866     4785    5                     ELSE GOTO RNAME_NXT;
      867     4786                    /* Compare the specified resource element name w/ this node's text */
      868     4787    5                  ELSE IF UQ$.LENGTH~=PRE$->RNAME2.COUNT THEN
      869     4788    5                        IF UQ$.LENGTH<PRE$->RNAME2.COUNT THEN GOTO RNAME_NO;
      870     4789    5                        ELSE GOTO RNAME_NXT;
      871     4790    5                     ELSE IF UQ$.LENGTH<=12 THEN
      872     4791    5                           IF RNAME.TEXT~=PRE$->RNAME2.TEXT
      873     4792    5                           THEN IF RNAME.TEXT<PRE$->RNAME2.TEXT THEN GOTO RNAME_NO;
      874     4793    5                              ELSE GOTO RNAME_NXT;
      875     4794    5                           ELSE ALTRETURN;
      876     4795    5                        ELSE IF SUBSTR(RNAME.TEXT,0,12)<=PRE$->RNAME2.TEXT
      877     4796    6                           THEN IF SUBSTR(RNAME.TEXT,0,12)=PRE$->RNAME2.TEXT THEN DO;
      878     4797    6                                 PRE@=PRE$->RNAME2.NCHAIN@;
PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:34   
      879     4798    6                                 ERR=12;
      880     4799    7                                 DO WHILE(ERR+13<UQ$.LENGTH);
      881     4800    7                                    IF PRE$->RNAME3.TEXT~=SUBSTR(RNAME.TEXT,ERR,13)
      882     4801    7                                    THEN IF SUBSTR(RNAME.TEXT,ERR,13)>PRE$->RNAME3.TEXT
      883     4802    7                                       THEN GOTO RNAME_NXT;
      884     4803    7                                       ELSE GOTO RNAME_NO;
      885     4804    7                                    ERR=ERR+13;
      886     4805    7                                    PRE@=PRE$->RNAME3.NCHAIN@;
      887     4806    7                                    END;
      888     4807    6                                 IF SUBSTR(RNAME.TEXT,ERR)<=PRE$->RNAME3.TEXT
      889     4808    6                                 THEN IF SUBSTR(RNAME.TEXT,ERR)=PRE$->RNAME3.TEXT
      890     4809    6                                    THEN ALTRETURN;
      891     4810    6                                    ELSE GOTO RNAME_NO;
      892     4811    6                                 END;
      893     4812    5                              ELSE GOTO RNAME_NO;
      894     4813    5   RNAME_NXT:     ;
      895     4814    5                  RNAME_PRE@=RNAME1@;
      896     4815    5                  RNAME1@=RNAME1$->RNAME1.RCHAIN@;
      897     4816    5                  END;
      898     4817    4               RETURN;
      899     4818    4               END;
      900     4819    3         END;
      901     4820    2   RNAME_NO:;
      902     4821    2      RNAME1@=U_NULL;
      903     4822    2      RETURN;
      904     4823                    /**/
      905     4824        %EJECT;
PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:35   
      906     4825    2   RNAME_D: ENTRY ALTRET;
      907     4826                   /* Delete the resource name entry at RNAME$, predecessor at RNAME_PRE$ */
      908     4827                    /* Save link to RNAME2 & RNAME3 node list */
      909     4828    2      IF RNAME1@~=RHASH@ THEN RNAME_PRE$->RNAME1.RCHAIN@=RNAME1$->RNAME1.RCHAIN@;
      910     4829    2      ELSE IF RNAME1$->RNAME1.RCHAIN@=U_NULL
      911     4830    3         THEN DO;
      912     4831    3            RHASH_PRE$->RNAME1.XCHAIN@=RNAME1$->RNAME1.XCHAIN@;
      913     4832    3            RHASH@=U_NULL;
      914     4833    3            END;
      915     4834    3         ELSE DO;
      916     4835    3            RHASH@=RNAME1$->RNAME1.RCHAIN@;
      917     4836    3            RHASH_PRE$->RNAME1.XCHAIN@=RHASH@;
      918     4837    3            RHASH$->RNAME1.XCHAIN@=RNAME1$->RNAME1.XCHAIN@;
      919     4838    3            END;
      920     4839                    /* Free all RNAME nodes linked to deleted node */
      921     4840    3      DO WHILE(RNAME1@~=U_NULL);
      922     4841    3         NODE@=RNAME1@;
      923     4842    3         RNAME1@=NODE$->NNODE.NCHAIN@;
      924     4843              %FREENODE(NODE=NODE@);
      925     4849    3         END;
      926     4850    2      RNAME1@ = RNAME_PRE@;
      927     4851                    /* If no other RNAMEs are hooked to this QID, delete it too. */
      928     4852    2      IF QID$->QID.XCHAIN@=U_NULL
      929     4853    3      THEN DO;
      930     4854    3         QID_PRE$->QID.HCHAIN@=QID$->QID.HCHAIN@;
      931     4855              %FREENODE(NODE=QID@);
      932     4861    3         END;
      933     4862    2      RETURN;
      934     4863        %EJECT;
PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:36   
      935     4864                    /* Locate/Insert a QENTRY attribute node for the given DOMAIN/     */
      936     4865                    /* RNAME combination.                                              */
      937     4866                    /* Note that PRE$ will be set to the predecessor of the QENTRY     */
      938     4867                    /* on the QCHAIN (resource name link).                             */
      939     4868    2   QENTRY_L: ENTRY ALTRET;
      940     4869                    /* Init predecessor pointer to point at RNAME node */
      941     4870    2      QENTRY_PRE@=RNAME1@;
      942     4871                    /* Get link from RNAME to QENTRY */
      943     4872    2      QENTRY@=RNAME1$->RNAME1.QCHAIN@;
      944     4873                    /* Examine QENTRYs until we find one pointing at the right DOMAIN  */
      945     4874                    /* block or we run out of QENTRYs for this RNAME.                  */
      946     4875    3      DO WHILE(QENTRY@~=U_NULL);
      947     4876    3         IF QENTRY$->QENTRY.D_U=D_U THEN RETURN;
      948     4877    3         IF QENTRY$->QENTRY.DOM_USER.USER=S_CUN
      949     4878    4         THEN DO;
      950     4879                    /* If the QENTRY associates the RNAME with a domain of the user    */
      951     4880                    /* other than the specified one, then return an error.             */
      952     4881    4            B$JIT.ERR=UQB$E$PDOMAIN;
      953     4882                    /*E*   ERROR:  UQB-E$PDOMAIN-2                                    */
      954     4883                    /*E*   MESSAGE: ENQ/DEQ user domain conflict.                      */
      955     4884            /*,*   MESSAGE1: A resource has been ENQued by a different domain of the user */
      956     4885    4            QENTRY@=U_NULL;
      957     4886    4            ALTRETURN;
      958     4887    4            END;
      959     4888    3         QENTRY_PRE@=QENTRY@;
      960     4889    3         QENTRY@=QENTRY$->QENTRY.QCHAIN@;
      961     4890    3         END;
      962     4891    2      RETURN;
      963     4892                    /**/
      964     4893        %EJECT;
PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:37   
      965     4894    2   QID_I: ENTRY ALTRET;
      966     4895                    /* Add a new QID, RNAME, and QENTRY node. */
      967     4896           %GETNODE(NODE=QID@);
      968     4901    2      QID$->QID=U_QID_INIT;
      969     4902    2      QID$->QID.NAME=UQ$.QNAME;
      970     4903    2      QID$->QID.HCHAIN@=QID_PRE$->QID.HCHAIN@;
      971     4904    2      QID_PRE$->QID.HCHAIN@=QID@;
      972     4905    2      RHASH_PRE@=QID@;
      973     4906    2      RNAME_PRE@=U_NULL;
      974     4907    2      RHASH@=U_NULL;
      975     4908                    /* Drop into RNAME_I code */
      976     4909        %EJECT;
PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:38   
      977     4910    2   RNAME_I: ENTRY ALTRET;
      978     4911                    /**/
      979     4912                    /* Add a new RNAME and QENTRY node. */
      980     4913           %GETNODE(NODE=RNAME1@);
      981     4918    2      RNAME1$->RNAME1=U_RNAME1_INIT;
      982     4919    2      RNAME1$->RNAME1.RHASH=UQ$.RHASH;
      983     4920    3      IF RNAME_PRE@~=U_NULL THEN DO; /* NOT FIRST IN HASH GROUP            */
      984     4921    3         RNAME1$->RNAME1.RCHAIN@=RNAME_PRE$->RNAME1.RCHAIN@;
      985     4922    3         RNAME_PRE$->RNAME1.RCHAIN@=RNAME1@;
      986     4923    3         END;
      987     4924    3      ELSE DO;
      988     4925    4         IF RHASH@=U_NULL THEN DO;
      989     4926    4            RNAME1$->RNAME1.XCHAIN@=RHASH_PRE$->RNAME1.XCHAIN@;
      990     4927    4            RHASH_PRE$->RNAME1.XCHAIN@=RNAME1@;
      991     4928    4            END;
      992     4929    4         ELSE DO;
      993     4930    4            RNAME1$->RNAME1.RCHAIN@=RHASH@;
      994     4931    4            RNAME1$->RNAME1.XCHAIN@=RHASH$->RNAME1.XCHAIN@;
      995     4932    4            RHASH_PRE$->RNAME1.XCHAIN@=RNAME1@;
      996     4933    4            END;
      997     4934    3         RHASH@=RNAME1@;
      998     4935    3         END;
      999     4936    2      RNAME1$->RNAME1.RHEAD@=QID@;
     1000     4937    3      IF UQ$.LENGTH~=0 THEN DO;
     1001     4938              %GETNODE(NODE=NODE@);
     1002     4943    3         NODE$->AVAIL.TYPE=BINBIT(RNAME2_TYPE,9);
     1003     4944    3         NODE$->RNAME2.COUNT=UQ$.LENGTH;
     1004     4945    3         NODE$->RNAME2.TEXT=RNAME.TEXT;
     1005     4946    3         RNAME1$->RNAME1.NCHAIN@=NODE@;
     1006     4947    3         ERR=12;
     1007     4948    4         DO WHILE(ERR<UQ$.LENGTH);
     1008     4949    4            PRE@=NODE@;
     1009     4950                 %GETNODE(NODE=NODE@);
     1010     4955    4            NODE$->AVAIL.TYPE=BINBIT(RNAME3_TYPE,9);
     1011     4956    4            NODE$->RNAME3.TEXT=SUBSTR(RNAME.TEXT,ERR);
     1012     4957    4            PRE$->RNAME2.NCHAIN@=NODE@;
     1013     4958    4            ERR=ERR+13;
PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:39   
     1014     4959    4            END;
     1015     4960    3         NODE$->RNAME1.NCHAIN@=U_NULL;
     1016     4961    3         END;
     1017     4962    2      QENTRY_PRE@=RNAME1@;
     1018     4963        %EJECT;
PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:40   
     1019     4964    2   QENTRY_I: ENTRY ALTRET;
     1020     4965                    /* Otherwise get a block and create a new QENTRY associating the   */
     1021     4966                    /* specified RNAME and DOMAIN.                                     */
     1022     4967    3      IF D_U>1023 THEN IF S$CU$->B$U.ENQ.COUNT>=B$JIT.MAXENQ THEN DO;
     1023     4968                    /*E*   ERROR:  UQB-E$ENQ_LIMIT-2                                 */
     1024     4969                    /*E*    MESSAGE: System limit on number of ENQ's per user exceeded.*/
     1025     4970    3            B$JIT.ERR=UQB$E$ENQ_LIMIT;
     1026     4971    3            ALTRETURN;
     1027     4972    3            END;
     1028     4973    2         ELSE S$CU$->B$U.ENQ.COUNT=S$CU$->B$U.ENQ.COUNT+1;
     1029     4974           %GETNODE(NODE=QENTRY@);
     1030     4979    2      QENTRY$->QENTRY=U_QENTRY_INIT;
     1031     4980    2      QENTRY$->QENTRY.D_U=D_U;
     1032     4981    2      QENTRY$->QENTRY.REQ_=QV.SHARE*2+BITBIN(QV.LIMITED_COM);
     1033     4982                    /* Set link to RNAME node associated with this QENTRY */
     1034     4983    2      QENTRY$->QENTRY.RNAME1@=RNAME1@;
     1035     4984    2      QENTRY_PRE$->QENTRY.QCHAIN@=QENTRY@;
     1036     4985    2      RETURN;
     1037     4986                    /**/
     1038     4987        %EJECT;
PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:41   
     1039     4988                    /**/
     1040     4989                    /**/
     1041     4990                    /* Delete a QENTRY defined by its predecessor on the QCHAIN        */
     1042     4991                    /* (linked by resource name).                                      */
     1043     4992    2   QENTRY_DQ: ENTRY ALTRET;
     1044     4993                    /* Get index to next node on the QCHAIN */
     1045     4994                    /* Set predecessor on the QCHAIN to point at it */
     1046     4995    2      QENTRY_PRE$->QENTRY.QCHAIN@=QENTRY$->QENTRY.QCHAIN@;
     1047     4996                    /* Finally, free the node. */
     1048     4997    2      IF QENTRY$->QENTRY.D_U>1023 THEN
     1049     4998    2         S$CU$->B$U.ENQ.COUNT=S$CU$->B$U.ENQ.COUNT-1;
     1050     4999           %FREENODE(NODE=QENTRY@);
     1051     5005    2      RETURN;
     1052     5006        %EJECT;
PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:42   
     1053     5007    2   ALLOCATE: ENTRY ALTRET;
     1054     5008                   /* Attempt to allocate the next user queued for the resource at RNAME$ */
     1055     5009    2   ALLOC1: NODE@=RNAME1$->RNAME1.QCHAIN@;
     1056     5010    2      QENTRY@=U_NULL;
     1057     5011    2      CRD='777'O;
     1058     5012    3      DO WHILE(NODE@~=U_NULL);
     1059     5013    4         DO CASE(NODE$->QENTRY.STATE);
     1060     5014    4         CASE(ALLOCATED);
     1061     5015    4            IF NODE$->QENTRY.UPGRADE AND QENTRY@=U_NULL THEN QENTRY@=NODE@;
     1062     5016    4            ELSE CRD=UQ_ACCESS(NODE$->QENTRY.REQ_)&CRD;
     1063     5017    4            NODE@=NODE$->QENTRY.QCHAIN@;
     1064     5018    4         CASE(ALLOC_PENDING);
     1065     5019    4            CRD=UQ_ACCESS(NODE$->QENTRY.REQ_)&
     1066     5020    4              UQ_ACCESS(NODE$->QENTRY.UPG_)&CRD;
     1067     5021    4            NODE@=NODE$->QENTRY.QCHAIN@;
     1068     5022    4         CASE(ELSE);
     1069     5023    4            IF QENTRY@=U_NULL THEN QENTRY@=NODE@;
     1070     5024    4            NODE@=U_NULL;
     1071     5025    4         END;
     1072     5026    3         END;
     1073     5027    2      IF QENTRY@=U_NULL THEN ALTRETURN;
     1074     5028        %EJECT;
PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:43   
     1075     5029    2   ALLOC: ENTRY ALTRET;
     1076     5030                  /* If CRD (containing current acceptable newcomer XLATE bits) indicates */
     1077     5031                  /* that the QENTRY at QENTRY$ can be allocated, do so. Otherwise ALTRET */
     1078     5032    2      NODE@=QENTRY$->QENTRY.UPG_;
     1079     5033    2      IF NODE@=0 THEN NODE@=QENTRY$->QENTRY.REQ_;
     1080     5034    2      IF NOT UQ_XLATE(NODE@)&CRD OR QENTRY$->QENTRY.DOM_USER.DOMAIN#=0
     1081     5035    2      THEN ALTRETURN;
     1082     5036    3      IF QENTRY$->QENTRY.WAIT THEN DO;
     1083     5037    3         IF NOT QENTRY$->QENTRY.UPGRADE
     1084     5038    3         THEN QENTRY$->QENTRY.STATE=ALLOCATED;
     1085     5039    4         ELSE DO;
     1086     5040    4            QENTRY$->QENTRY.REQ_=QENTRY$->QENTRY.UPG_;
     1087     5041    4            QENTRY$->QENTRY.UPG_=0;
     1088     5042    4            END;
     1089     5043    3         IF QENTRY$->QENTRY.DOM_USER.USER~=S_CUN
     1090     5044    3         THEN CALL SSR$RUE(%SS_NQR,QENTRY$->QENTRY.DOM_USER.USER);
     1091     5045    3         ELSE IF UQ$.MESSAGE$~=ADDR(NIL)
     1092     5046    3            THEN UQ$.MESSAGE$->MESSAGE=RNAME1$->RNAME1.COMM;
     1093     5047    3         QENTRY$->QENTRY.WAIT='0'B;
     1094     5048    3         END;
     1095     5049    3      ELSE DO;
     1096     5050                    /* DO NOWAIT TYPE WAKEUP */
     1097     5051    3         ERR=QENTRY$->QENTRY.DOM_USER.DOMAIN#;
     1098     5052    3         ECCI.WORDS=1;
     1099     5053    3         ECCI.MESSAGE=RNAME1$->RNAME1.COMM;
     1100     5054    3         QENTRY$->QENTRY.STATE=ALLOC_PENDING;
     1101     5055    3         CALL SSV$EVENT(QENTRY$->QENTRY.DOM_USER.USER,ERR,%EVSC_ENQ#,
     1102     5056    3           QENTRY$,0,ADDR(ECCI),ENTADDR(UQB$ENQ_EVENT));
     1103     5057    3         END;
     1104     5058    2      IF QENTRY$->QENTRY.DOM_USER.USER=S_CUN THEN RETURN;
     1105     5059    2      GOTO ALLOC1; /* KEEP TRYING UNTIL NOTHING HAPPENS  */
     1106     5060        %EJECT;
PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:44   
     1107     5061                    /**/
     1108     5062                    /* Entry point for unlocking the ENQ/DEQ tables.                   */
     1109     5063                    /**/
     1110     5064    2   UNLOCK: ENTRY ALTRET;
     1111     5065           %SET_COUNTER(ITEM=ENQ,
     1112     5066           VALUE="UQ_.TOT_BLOCKS.N-UQ_.FREE_BLOCKS");
     1113     5075           %UNLOCK(G=U_LOCK);
     1114     5078    2      RETURN;
     1115     5079                    /**/
     1116     5080        %EJECT;
PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:45   
     1117     5081    2   ARGS: ENTRY ALTRET;
     1118     5082    2      UQ$='0'B;
     1119     5083    2      UQ$.DOMAIN#=ARG1;
     1120     5084                    /* GET RNAME$ */
     1121     5085    2      UQ$.RNAME$=ADDR(NIL);
     1122     5086    2      CALL HFF$NILERASE(1) ALTRET(NOPS1);
     1123     5087    2      UQ$.LENC(3)=B$PS1$->RNAME.LEN;
     1124     5088    3      IF UQ$.LENGTH~=0 THEN DO;
     1125     5089    3         UQ$.RNAME$=B$PS1$;
     1126     5090    3         UQ$.RHASHC(3)=SUBSTR(RNAME.TEXT,UQ$.LENGTH-1,1);
     1127     5091    3         UQ$.RHASH=MOD(UQ$.RHASH,64)/2;
     1128     5092    3         END;
     1129     5093    2   NOPS1:;
     1130     5094    2      IF UQ$.LENGTH=0 THEN UQ$.LENGTH=1;
     1131     5095                    /* GET MESSAGE$ */
     1132     5096    2      UQ$.MESSAGE$=ADDR(NIL);
     1133     5097    2      CALL HFF$NILERASE(2)ALTRET(NOPS2);
     1134     5098    2      UQ$.MESSAGE$=B$PS2$;
     1135     5099    2      ERR=UQ$.MESSAGE$->MESSAGE;
     1136     5100    2   NOPS2:;
     1137     5101                    /* NOW CHECK QNAME (DCB.CFU$) */
     1138     5102    3      IF QV.DCB#<=B$ROSEG.NUMDCBS THEN DO;
     1139     5103    3         IF DCBADDR(QV.DCB#)~=ADDR(NIL)
     1140     5104    3         THEN IF DCBADDR(QV.DCB#)->F$DCB.ASN=1
     1141     5105    3              AND (NOT DCBADDR(QV.DCB#)->F$DCB.FFLG.EXEC
     1142     5106    3              OR DCBADDR(QV.DCB#)->F$DCB.WSR=UQ$.DOMAIN#)
     1143     5107    4              AND DCBADDR(QV.DCB#)->F$DCB.FCD THEN DO;
     1144     5108    4               ADDR(UQ$.QNAME)->PTR$=DCBADDR(QV.DCB#)->F$DCB.CFU$;
     1145     5109    4               RETURN;
     1146     5110    4               END;
     1147     5111    3         END;
     1148     5112    2      B$JIT.ERR=UQB$E$BAD_DCB;
     1149     5113                    /*E* ERROR: UQB-E$BAD_DCB-2
     1150     5114                    *    MESSAGE:The M$ENQ or M$DEQ DCB must have access to a file.
     1151     5115                    *    MESSAGE1:The DCB used as a parameter for M$ENQ or M$DEQ
     1152     5116                    *             must exist, must be open to a file (ASN=FILE),
     1153     5117                    *             and must be by the same domain if DCB.FFLG.EXEC.
PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:46   
     1154     5118                    */
     1155     5119    2      ALTRETURN;
     1156     5120                    /**/
     1157     5121    2   END LID_SUBROUTINES;
     1158     5122        %EJECT;
PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:47   
     1159     5123                    /**/
     1160     5124    1   CHECK: PROC ALTRET;
     1161     5125    3      DO WHILE('1'B);
     1162     5126    3         IF UQ$.LENGTH=0 THEN IF UQ_.FREE_BLOCKS>=4 THEN RETURN;ELSE;
     1163     5127    3         ELSE IF (UQ$.LENGTH+4+20*13)/13-UQ_.FREE_BLOCKS<=0 THEN RETURN;
     1164     5128                    /* RESERVE 16 BLOCKS FOR THE MONITOR  */
     1165     5129    3         CALL UQC$CHK ALTRET(NOMEM);
     1166     5130    3         END;
     1167     5131    2   NOMEM: ALTRETURN;
     1168     5132    2   END CHECK;
     1169     5133                    /**/
     1170     5134    1   END UQB$EDPR;

PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:48   
--  Include file information  --

   UQ_ERRORS_C.:E05TOU  is referenced.
   UQ_DATA_R.:E05TOU  cannot be made into a system file and is referenced.
   UQ$NODES.:E05TOU  cannot be made into a system file and is referenced.
   SS_SCHED_C.:E05TOU  is referenced.
   HF_LOCK_C.:E05TOU  cannot be made into a system file and is referenced.
   P_PMDAT_C.:E05TOU  is referenced.
   F$DCB.:E05TOU  cannot be made into a system file and is referenced.
   B$ROSEG.:E05TOU  cannot be made into a system file and is referenced.
   B$JIT_C.:E05TOU  is referenced.
   B$USER.:E05TOU  cannot be made into a system file and is referenced.
   UM_CP6.:E05TOU  is referenced.
   UM$CP6V_C.:E05TOU  is referenced.
   UE_CP6.:E05TOU  is referenced.
   CP_6_SUBS.:E05TOU  is referenced.
      No diagnostics issued in procedure UQB$EDPR.

   Procedure UQB$EDPR requires 1772 words for executable code.
   Procedure UQB$EDPR requires 46 words of local(AUTO) storage.

    No errors detected in file UQB$EDPR.:E05TSI    .

PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:49   

 Object Unit name= UQB$EDPR                                   File name= UQB$EDPR.:E05TOU
 UTS= JUL 30 '97 07:02:33.28 WED                              Compiler= PL-6/E31         Sev=      00
 SharedLib= :SHARED_SYSTEM                                    Alt SharedLib=


    ****  Control sections  ****

 Sect   Type Bound  Init  Size OctSiz  Section name(segment info)
    0  RoData even  UTS     91    133  UQB$EDPR
    1   Proc  even  none  1772   3354  UQB$EDPR
    2  RoData even  none    14     16  UQB$EDPR

    ****  Entry defs  ****

                              Check   Calling
                             calling  sequence
  Sect OctLoc Primary Altret sequence   type   Parms  Name
     1      0   yes    yes     yes      Std        1  UQB$EDPR
     1      3          yes     yes      Std        1  UQB$ENQ_EVENT
     1     57          yes     yes      Std        1  UQB$UENQ
     1    136          yes     yes      Std        1  UQB$MENQS
     1    144          yes     yes      Std        1  UQB$MENQX
     1    152          yes     yes      Std        1  UQB$MENQXB
     1    160          yes     yes      Std        1  UQB$MENQSB
     1   1052          yes     yes      Std        0  UQB$TESTNQR
     1   1070          yes     yes      Std        1  UQB$MDEQ
     1   1101          yes     yes      Std        1  UQB$UDEQ
     1   1313          yes     yes      Std        0  UQB$DELUSER
     1   1427          yes     yes      Std        1  UQB$DELQID
     1   1544          yes     yes      Std        1  UQB$DELQIDX

  ****  Data defs  ****

 Sect OctLoc  Name                           Sect OctLoc  Name
    0    113  UQ_ACCESS                          0    123  UQ_XLATE
PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:50   

  ****  Entry refs  ****

         Check        Calling
        calling       sequence
Altret sequence SRef   type   Args  Name
         yes           Std       1 HFC$LOCK
 yes     yes           Std       3 SSR$REG
         yes           Std       4 SSR$RUE
 yes     yes           Std       3 SSV$XXDO
         yes           Std       7 SSV$EVENT
         yes           Std       1 HFC$UNLOCK
 yes     yes           Std       1 HFF$NILERASE
 yes     yes           Std       0 UQC$CHK
 yes     yes           Std       1 UQB$ENQ_EVENT
                       nStd      0 X66_AUTO_1
                       Std       0 B_CONSPOOL_D
                       nStd      0 X66_ARET
                       nStd      0 X66_AALT

  ****  Data refs  ****

  Flags:  r = read only, s = secondary
Flgs Name                             Flgs Name                             Flgs Name
     SC_EQERR_B                            SC_FSERR                              SC_EQMEM
     SC_FMF98                              S$CU$                                 B$USRT$
     P_RESOURCE$                      r    U_QID_INIT                       r    U_RNAME1_INIT
r    U_QENTRY_INIT                    r    U_BASE                                U_LOCK
r    B$PS0$                           r    B$PS1$                           r    B$PS2$
r    B$ROSEG$                         r    B$JIT$                                IRM_SYSID
     S_CUN                                 B_VECTNIL
PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:51   

  ****  Segment refs  ****

  Flags:  r = read only, s = secondary
Flgs Name                             Flgs Name                             Flgs Name
     ISSID                                 NULLSID                               ASLENTSID
     ROSID
PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:52   


        1        1        /*M* UQB$EDPR  Main ENQ/DEQ logic module               */
        2        2        /*T***********************************************************/
        3        3        /*T*                                                         */
        4        4        /*T* Copyright (c) Bull HN Information Systems Inc., 1997    */
        5        5        /*T*                                                         */
        6        6        /*T***********************************************************/
        7        7        /*X* NSO,MCL=0,MOC,MEC,CLM=12,EXM=12,CRT=6,DMR,PLM=3,IND=3,ENU=0,DCI=3,
        8        8        CSU=3,ECU=3,THI=0,DTI=0,CRM=86 */
        9        9        UQB$EDPR: PROC(ARG1)ALTRET;

      9  1 000000   000000 700200 xent  UQB$EDPR     TSX0  ! X66_AUTO_1
         1 000001   000056 000001                    ZERO    46,1
         1 000002   000005 710000 1                  TRA     s:4141

       10       10                    /**/
       11       11        %INCLUDE CP_6_SUBS;
       12      551        %INCLUDE UE_CP6;
       13     1242        %INCLUDE UM$CP6V_C;
       14     1429        %INCLUDE UM_CP6;
       15     2281        %B$ECCB;
       16     2289        %B$EVNT;
       17     2302        %INCLUDE B$USER;
       18     2518        %B$USERREFS;
       19     2522        %INCLUDE B$JIT_C;
       20     2836        %B$JIT0;
       21     2925        %U$JIT1X;
       22     2928        %M$JIT2X;
       23     2931        %F$JIT3;
       24     2936        %S$JIT4X;
       25     2939        %J$JIT5;
       26     3027        %A$JIT6;
       27     3037        %INCLUDE B$ROSEG;
       28     3100        %INCLUDE F$DCB;
       29     3149        %INCLUDE P_PMDAT_C;
       30     3269    1   DCL P_RESOURCE$ PTR SYMREF;
       31     3270        %P_RESOURCE;
PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:53   
       32     3384        %INCLUDE HF_LOCK_C;
       33     3398        %INCLUDE SS_SCHED_C;
       34     3631        %INCLUDE UQ$NODES;
       35     3762        %INCLUDE UQ_DATA_R;
       36     3775        %INCLUDE UQ_ERRORS_C;
       37     3797                    /**/
       38     3798        %SUB CANCEL_=0 /* Cancel */;
       39     3799        %SUB RELEASE_=1 /* Release */;
       40     3800        %SUB DELQENTRY_=2 /* Delqentry */;
       41     3801        %EJECT;
PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:54   
       42     3802    1   DCL ARG1 UBIN(36);
       43     3803    1   DCL ARG1B REDEF ARG1 BIT(36)ALIGNED;
       44     3804    1   DCL DOLIST$ REDEF ARG1 PTR ALIGNED;
       45     3805    1   DCL 1 PLUGH BASED ALIGNED,
       46     3806    1         2 ADR BIT(18),
       47     3807    1         2 EVID BIT(18);
       48     3808                    /*** *** *** *** *** *** *** ***/
       49     3809                    /* UQ$ MUST BE AT 4 IN AUTO    */
       50     3810                    /* FOR THE DEBUG CODE AT MENQ  */
       51     3811                    /*** *** *** *** *** *** *** ***/
       52     3812    1   DCL 1 UQ$,
       53     3813    1         2 QNAME,
       54     3814    1           3 * BIT(10),
       55     3815    1           3 KEY UBIN(5)UNAL,
       56     3816    1           3 * BIT(21),
       57     3817    1         2 RNAME$ PTR,
       58     3818    1         2 LENGTH SBIN,
       59     3819    1         2 LENC(0:3)REDEF LENGTH CHAR(1),
       60     3820    1         2 RHASH UBIN,
       61     3821    1         2 RHASHC(0:3)REDEF RHASH CHAR(1),
       62     3822    1         2 DOMAIN# UBIN(18)UNAL,
       63     3823    1         2 DEQ_COMMAND UBIN(18)UNAL,
       64     3824    1         2 MESSAGE$ PTR;
       65     3825    1   DCL UQ$B(0:5)BASED UBIN;
       66     3826    1   DCL 1 RNAME BASED(UQ$.RNAME$),
       67     3827    1         2 LEN CHAR(1),
       68     3828    1         2 TEXT CHAR(UQ$.LENGTH);
       69     3829        %FPT$ENQ_V(FPTN=QV,BASED=);
       70     3833        %SUB U_NULL=0;
       71     3834    1   DCL QID_PRE@ UBIN HALF;
       72     3835    1   DCL QID@ UBIN HALF;
       73     3836    1   DCL RNAME_PRE@ UBIN HALF;
       74     3837    1   DCL RNAME1@ UBIN HALF;
       75     3838    1   DCL RHASH_PRE@ UBIN HALF;
       76     3839    1   DCL RHASH@ UBIN HALF;
       77     3840    1   DCL QENTRY_PRE@ UBIN HALF;
       78     3841    1   DCL QENTRY@ UBIN HALF;
PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:55   
       79     3842    1   DCL NODE@ UBIN HALF;
       80     3843    1   DCL DLKNTRY@ UBIN HALF;
       81     3844        %SUB QENTRY$="PINCRW(U_BASE$,QENTRY@)";
       82     3845        %SUB QENTRY_PRE$="PINCRW(U_BASE$,QENTRY_PRE@)";
       83     3846        %SUB QID$="PINCRW(U_BASE$,QID@)";
       84     3847        %SUB QID_PRE$="PINCRW(U_BASE$,QID_PRE@)";
       85     3848        %SUB RNAME1$="PINCRW(U_BASE$,RNAME1@)";
       86     3849        %SUB RNAME_PRE$="PINCRW(U_BASE$,RNAME_PRE@)";
       87     3850        %SUB RHASH$="PINCRW(U_BASE$,RHASH@)";
       88     3851        %SUB RHASH_PRE$="PINCRW(U_BASE$,RHASH_PRE@)";
       89     3852        %SUB NODE$="PINCRW(U_BASE$,NODE@)";
       90     3853        %SUB DLKNTRY$="PINCRW(U_BASE$,DLKNTRY@)";
       91     3854    1   DCL 1 DOM_USER,
       92     3855    1         2 DOMAIN# UBIN(27)UNAL,
       93     3856    1         2 USER UBIN(9)UNAL;
       94     3857    1   DCL D_U REDEF DOM_USER UBIN;
       95     3858    1   DCL 1 ECCI,
       96     3859    1         2 WORDS UBIN,
       97     3860    1         2 MESSAGE UBIN;
       98     3861    1   DCL ERR SBIN;
       99     3862    1   DCL OCRD REDEF ERR BIT(36);
      100     3863    1   DCL MESSAGE UBIN BASED;
      101     3864    1   DCL PTR$ PTR BASED;
      102     3865    1   DCL 1 CRD,
      103     3866    1         2 ALLOC UBIN(3) UNAL,
      104     3867    1         2 CANCEL_EVENT BIT(1) UNAL,
      105     3868    1         2 SEND_MESSAGE BIT(1) UNAL,
      106     3869    1         2 * BIT(31);
      107     3870    1   DCL 1 CRD_(0:14) CONSTANT, /* Decision table for DEQ actions     */
      108     3871    1         2 ALLOC UBIN(3) UNAL INIT(0,7,0,5,1,0,0,7,0,5,3,0,7,0,0),
      109     3872    1         2 CANCEL_EVENT BIT(1) UNAL INIT('0'B*6,'1'B,'0'B,'1'B,
      110     3873    1           '1'B,'0'B,'1'B,'0'B*3),
      111     3874    1         2 SEND_MESSAGE BIT(1) UNAL INIT('0'B*3,'0'B,'1'B,'1'B,
      112     3875    1           '0'B*3,'0'B,'1'B,'1'B,'0'B,'1'B,'1'B),
      113     3876    1         2 * BIT(31)INIT('0'B*0);
      114     3877        %EJECT;
PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:56   
      115     3878        %FPT_ENQ(FPTN=MENQSHARE,STCLASS=CONSTANT,
      116     3879           WAIT=YES,
      117     3880           NO_DOWNGRADE=YES,
      118     3881           SHARE=ALL,
      119     3882           LIMITED_COM=YES,
      120     3883           WAIT_TIME=-2,
      121     3884           EVENT=0);
      122     3902        %FPT_ENQ(FPTN=MENQNONE,STCLASS=CONSTANT,
      123     3903           WAIT=YES,
      124     3904           NO_DOWNGRADE=NO,
      125     3905           SHARE=NONE,
      126     3906           LIMITED_COM=NO,
      127     3907           WAIT_TIME=-2,
      128     3908           EVENT=0);
      129     3926    1   DCL 1 MRNAME CONSTANT,
      130     3927    1         2 QNAME UBIN,
      131     3928    1         2 RNAME$ PTR INIT(ADDR(MRNAME)),
      132     3929    1         2 LENGTH UBIN INIT(0),
      133     3930    1         2 LENC(0:3)REDEF LENGTH CHAR(1),
      134     3931    1         2 RHASH UBIN INIT(0),
      135     3932    1         2 RHASHC(0:3)REDEF RHASH CHAR(1),
      136     3933    1         2 DOMAIN# UBIN(18)UNAL INIT(1),
      137     3934    1         2 DEQ_COMMAND UBIN(18)UNAL INIT(DELQENTRY_),
      138     3935    1         2 MESSAGE$ PTR INIT(ADDR(NIL));
      139     3936        %FPT_ENQ(FPTN=MENQNONEB,STCLASS=CONSTANT,
      140     3937           WAIT=YES,
      141     3938           NO_DOWNGRADE=NO,
      142     3939           SHARE=NONE,
      143     3940           LIMITED_COM=NO,
      144     3941           EVENT=0);
      145     3959        %FPT_ENQ(FPTN=MENQSHAREB,STCLASS=CONSTANT,
      146     3960           WAIT=YES,
      147     3961           NO_DOWNGRADE=YES,
      148     3962           SHARE=ALL,
      149     3963           LIMITED_COM=YES,
      150     3964           EVENT=0);
      151     3982    1   DCL 1 ERRCODE CONSTANT,
PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:57   
      152     3983    1         2 FCG BIT(12) UNAL INIT('2521'O),
      153     3984    1         2 MID BIT(6) UNAL INIT('02'O),
      154     3985    1         2 CODE UBIN(15) UNAL INIT(0),
      155     3986    1         2 SEV UBIN(3) UNAL INIT(2);
      156     3987        %SUB FCG#='2521'O;
      157     3988        %SUB MID#='02'O;
      158     3989        %ERRCODE(NAME=UQB$E$MISSING_PARAM,COD#=%E$MISSING_PARAM);
      159     3996        %ERRCODE(NAME=UQB$E$BAD_TIME,COD#=%E$BAD_TIME);
      160     4003        %ERRCODE(NAME=UQB$E$NOEADDR,COD#=%E$NOEADDR);
      161     4010        %ERRCODE(NAME=UQB$E$BAD_DCB,COD#=%E$BAD_DCB);
      162     4017        %ERRCODE(NAME=UQB$E$ENQ_LIMIT,COD#=%E$ENQ_LIMIT);
      163     4024        %ERRCODE(NAME=UQB$E$PDOMAIN,COD#=%E$PDOMAIN);
      164     4031        %ERRCODE(NAME=UQB$E$CRD_ERR,COD#=%E$CRD_ERR);
      165     4038        %ERRCODE(NAME=UQB$E$DLOCK,COD#=%E$DLOCK);
      166     4045        %ERRCODE(NAME=UQB$E$UQ_DOWNGRADE,COD#=%E$UQ_DOWNGRADE);
      167     4052        %ERRCODE(NAME=UQB$E$UQ_NOCHANGE,COD#=%E$UQ_NOCHANGE);
      168     4059        %ERRCODE(NAME=UQB$E$BAD_UPGRADE,COD#=%E$BAD_UPGRADE);
      169     4066        %ERRCODE(NAME=UQB$E$NO_UPGRADE,COD#=%E$NO_UPGRADE);
      170     4073    1   DCL B$PS0$ PTR SYMREF READONLY;
      171     4074    1   DCL B$PS1$ PTR SYMREF READONLY;
      172     4075    1   DCL B$PS2$ PTR SYMREF READONLY;
      173     4076        %FPT$ENQ_V;
      174     4080        %FPT$DEQ_V;
      175     4084    1   DCL B$ROSEG$ PTR SYMREF READONLY;
      176     4085        %SUB B$ROSEG=B$ROSEG$->B$ROSEG;
      177     4086    1   DCL B$JIT$ PTR SYMREF READONLY;
      178     4087    1   DCL IRM_SYSID UBIN SYMREF;
      179     4088    1   DCL UQ_ACCESS(0:7)CONSTANT SYMDEF
      180     4089    1     BIT(36)INIT(
      181     4090    1   '777'O*2,   /* ANY OK WITH NO REQUEST             */
      182     4091    1   '740'O,'770'O, /* A=A,AL; AL=A,AL,L,LL               */
      183     4092    1   '640'O,'050'O, /* L=AL;LL=AL,LL                      */
      184     4093    1   '600'O*2);  /* N=0                                */
      185     4094    1   DCL UQ_XLATE(0:7)CONSTANT SYMDEF BIT(36)INIT(
      186     4095    1   '4'O,'2'O,'1'O,'04'O,'02'O,'01'O,'004'O,'002'O);
      187     4096    1   DCL S_CUN SBIN WORD SYMREF;
      188     4097                    /**/
PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:58   
      189     4098    1   DCL HFF$NILERASE ENTRY(1)ALTRET;
      190     4099    1   DCL UQC$CHK ENTRY ALTRET;
      191     4100    1   DCL UQC$FDS ENTRY ALTRET;
      192     4101    1   DCL SSR$REG ENTRY(3) ALTRET;
      193     4102    1   DCL SSR$RUE ENTRY(4);
      194     4103    1   DCL SSV$EVENT ENTRY(7);
      195     4104    1   DCL SSV$XXDO ENTRY(3) ALTRET;
      196     4105    1   DCL SC_FMF98 ENTRY CONV(2,0);
      197     4106    1   DCL SC_FSERR ENTRY CONV(2,0);
      198     4107    1   DCL SC_EQMEM ENTRY CONV(2,0);
      199     4108    1   DCL SC_EQERR_B ENTRY CONV(2,0);
      200     4109                    /**/
      201     4110        %EJECT;
PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:59   
      202     4111                    /* GETNODE AND FREENODE MACROS */
      203     4112        %MACRO GETNODE(NODE=0);
      204     4113           UQ_.FREE_BLOCKS=UQ_.FREE_BLOCKS-1;
      205     4114           NODE=UQ_.NEXT_BLOCK@;
      206     4115           UQ_.NEXT_BLOCK@=PINCRW(U_BASE$,NODE)->AVAIL.NEXT_BLOCK@;
      207     4116        %MEND;
      208     4117                    /**/
      209     4118        %MACRO FREENODE(NODE=0);
      210     4119           PINCRW(U_BASE$,NODE)->AVAIL.TYPE=BINBIT(AVAIL_TYPE,9);
      211     4120           PINCRW(U_BASE$,NODE)->AVAIL.NEXT_BLOCK@=UQ_.NEXT_BLOCK@;
      212     4121           UQ_.NEXT_BLOCK@=NODE;
      213     4122           UQ_.FREE_BLOCKS=UQ_.FREE_BLOCKS+1;
      214     4123        %MEND;
      215     4124        %EJECT;
PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:60   
      216     4125                    /*F*   NAME:   UQB$ENQ_EVENT                                       */
      217     4126                    /*F*   PURPOSE: Scheduler entry called to set an ALLOCATION-PENDING*/
      218     4127                    /*,*           QENTRY to ALLOCATED before eventing a user for a    */
      219     4128                    /*,*           NOWAIT ENQ request which has been satisfied.        */
      220     4129                    /*F*   DESCRIPTION: Allocation of NOWAIT ENQ's is handled this way */
      221     4130                    /*,*           in order to prevent the race condition where a user */
      222     4131                    /*,*           cancels an outstanding NOWAIT ENQ request or re-    */
      223     4132                    /*,*           leases a resource he has an outstanding upgrade     */
      224     4133                    /*,*           request for at the same time that someone else      */
      225     4134                    /*,*           makes it possible for that resource to be allo-     */
      226     4135                    /*,*           cated to him, causing what would appear to be       */
      227     4136                    /*,*           spurious EVENTs for the user.                       */
      228     4137    1   UQB$ENQ_EVENT:ENTRY(ARG1) ALTRET;

   4137  1 000003   000000 700200 xent  UQB$ENQ_EVE* TSX0  ! X66_AUTO_1
         1 000004   000056 000001                    ZERO    46,1

      229     4138                    /* DOLIST$ ::= ARG1                                                 */
      230     4139                    /**/
      231     4140           %LOCK(G=U_LOCK);

   4141  1 000005   000000 630400 2                  EPPR0   0
         1 000006   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 000007   000000 701000 xent               TSX1    HFC$LOCK
         1 000010   000000 011000                    NOP     0

      232     4143                    /* Get ptr to QENTRY from DOLIST */
      233     4144    1      QENTRY@ = DOLIST$->B$DO.EVID;

   4144  1 000011   200003 470500                    LDP0    @ARG1,,AUTO
         1 000012   000000 471500                    LDP1    0,,PR0
         1 000013   100003 720100                    LXL0    3,,PR1
         1 000014   200025 740100                    STX0    QENTRY@,,AUTO

      234     4145                    /* Make sure the node looks reasonable */
      235     4146    1      IF ((QENTRY$->NODE.TYPE=QENTRY_TYPE) AND

PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:61   
   4146  1 000015   000000 473400 xsym               LDP3    U_BASE
         1 000016   300000 236110                    LDQ     0,X0,PR3
         1 000017   777000 376003                    ANQ     -512,DU
         1 000020   050000 116003                    CMPQ    20480,DU
         1 000021   000052 601000 1                  TNZ     ENQ_ERR
         1 000022   300000 236110                    LDQ     0,X0,PR3
         1 000023   000700 376003                    ANQ     448,DU
         1 000024   000100 116003                    CMPQ    64,DU
         1 000025   000052 601000 1                  TNZ     ENQ_ERR

      236     4147    1        (QENTRY$->QENTRY.STATE=ALLOC_PENDING))
      237     4148    2      THEN DO;

      238     4149                    /* Set event ID in DOLIST */
      239     4150    2         DOLIST$->B$DO.EVID = QENTRY$->QENTRY.EVENT_ID;

   4150  1 000026   300003 235110                    LDA     3,X0,PR3
         1 000027   100003 755100                    STA     3,,PR1

      240     4151    2         QENTRY$->QENTRY.STATE=ALLOCATED;

   4151  1 000030   300000 236110                    LDQ     0,X0,PR3
         1 000031   000001 376000 2                  ANQ     1
         1 000032   000200 276003                    ORQ     128,DU
         1 000033   300000 756110                    STQ     0,X0,PR3

      241     4152    2         IF QENTRY$->QENTRY.UPGRADE

   4152  1 000034   300000 236110                    LDQ     0,X0,PR3
         1 000035   000007 316003                    CANQ    7,DU
         1 000036   000054 600000 1                  TZE     s:4171

      242     4153    3         THEN DO;

      243     4154                    /* If this is an upgrade request, then change its status now. */
      244     4155    3            QENTRY$->QENTRY.REQUEST=QENTRY$->QENTRY.UPGRADE;

PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:62   
   4155  1 000037   000003 736000                    QLS     3
         1 000040   300000 676110                    ERQ     0,X0,PR3
         1 000041   000070 376003                    ANQ     56,DU
         1 000042   300000 656110                    ERSQ    0,X0,PR3

      245     4156    3            QENTRY$->QENTRY.UPGRADE='0'B;

   4156  1 000043   000002 236000 2                  LDQ     2
         1 000044   300000 356110                    ANSQ    0,X0,PR3

      246     4157    3            RNAME1@ = QENTRY$->QENTRY.RNAME1@;

   4157  1 000045   300001 721110                    LXL1    1,X0,PR3
         1 000046   200021 741100                    STX1    RNAME1@,,AUTO

      247     4158                    /* And see if anyone else can be allocated now that this QENTRY    */
      248     4159                    /* has had its shareability status changed.                        */
      249     4160    3            CALL ALLOCATE;

   4160  1 000047   002677 701000 1                  TSX1    ALLOCATE
         1 000050   000000 011000                    NOP     0

      250     4161    3            END;

      251     4162    2         END;

   4162  1 000051   000054 710000 1                  TRA     s:4171

      252     4163    2      ELSE DO; /* The DOLIST pointed at a bad node   */

   4157  1 000052                       ENQ_ERR      null
      253     4164                    /*S*   SCREECH_CODE: UQB-S$EQERR                                   */
      254     4165                    /*S*   TYPE:   SCREECH                                             */
      255     4166                    /*S*   MESSAGE:UQB$ENQ_EVENT got an uneventful QENTRY passed,      */
      256     4167                    /*S*           or SSV$XXDO altreturned on a DEQ.                   */
      257     4168    2   ENQ_ERR: ;
      258     4169    2         CALL SC_EQERR_B;
PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:63   

   4169  1 000052   000000 713400 xsym               CLIMB   SC_EQERR_B
         1 000053   000000 600000 xsid               climb   nvectors=         0

      259     4170    2         END;

      260     4171    1      CALL UNLOCK;

   4171  1 000054   003157 701000 1                  TSX1    UNLOCK
         1 000055   000000 011000                    NOP     0

      261     4172    1      RETURN;

   4172  1 000056   000000 702200 xent               TSX2  ! X66_ARET

      262     4173                    /**/
      263     4174        %EJECT;
PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:64   
      264     4175                    /*F*      NAME: UQB$UENQ
      265     4176                    *       PURPOSE: To request allocation using the parameters in the user
      266     4177                   *       FPT, as reduced by UQA$PMME to the UQ$ control structure (ARG1).
      267     4178                    */
      268     4179    1   UQB$UENQ: ENTRY(ARG1)ALTRET;

   4179  1 000057   000000 700200 xent  UQB$UENQ     TSX0  ! X66_AUTO_1
         1 000060   000056 000001                    ZERO    46,1

      269     4180    1      QV=B$PS0$->FPT$ENQ_V;

   4180  1 000061   000000 470400 xsym               LDP0    B$PS0$
         1 000062   000100 100500                    MLR     fill='000'O
         1 000063   000000 000020                    ADSC9   0,,PR0                   cn=0,n=16
         1 000064   200012 000020                    ADSC9   QV,,AUTO                 cn=0,n=16

      270     4181    1      CALL ARGS ALTRET(BAD_FPT);

   4181  1 000065   003203 701000 1                  TSX1    ARGS
         1 000066   000135 702000 1                  TSX2    BAD_FPT

      271     4182    2      IF UQ$.RNAME$~=ADDR(NIL) AND QV.SHARE~=0 THEN DO;

   4182  1 000067   200005 236100                    LDQ     UQ$+1,,AUTO
         1 000070   000001 116000 xsym               CMPQ    B_VECTNIL+1
         1 000071   000132 600000 1                  TZE     s:4200
         1 000072   200012 236100                    LDQ     QV,,AUTO
         1 000073   140000 316007                    CANQ    49152,DL
         1 000074   000132 600000 1                  TZE     s:4200

      272     4183    3         IF QV.WAIT THEN DO;

   4183  1 000075   400000 316007                    CANQ    -131072,DL
         1 000076   000106 600000 1                  TZE     s:4189

      273     4184    3            IF QV.WAIT_TIME<-1 THEN B$JIT.ERR=UQB$E$BAD_TIME;

PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:65   
   4184  1 000077   200013 235100                    LDA     QV+1,,AUTO
         1 000100   000027 115000 xsym               CMPA    B_VECTNIL+23
         1 000101   000120 605000 1                  TPL     s:4194

   4184  1 000102   000100 236000 0                  LDQ     UQB$E$BAD_TIME
         1 000103   000000 470400 xsym               LDP0    B$JIT$
         1 000104   000012 756100                    STQ     10,,PR0

      274     4185                    /*E* ERROR: UQB-E$BAD_TIME-2
      275     4186                    *    MESSAGE:WAIT_TIME for M$ENQ must be positive or -1.
      276     4187                    */
      277     4188    3            END;

   4188  1 000105   000120 710000 1                  TRA     s:4194

      278     4189    2         ELSE IF NOT ADDR(B$ROSEG.ECCB(7-UQ$.DOMAIN#))->

   4189  1 000106   200010 236100                    LDQ     UQ$+4,,AUTO
         1 000107   000022 772000                    QRL     18
         1 000110   000003 402000 2                  MPY     3
         1 000111   000000 470400 xsym               LDP0    B$ROSEG$
         1 000112   000102 236106                    LDQ     66,QL,PR0
         1 000113   200000 316003                    CANQ    65536,DU
         1 000114   000120 601000 1                  TNZ     s:4194

      279     4190    2              B$ECCB.FLAGS.EVTSET THEN B$JIT.ERR=UQB$E$NOEADDR;

   4190  1 000115   000101 236000 0                  LDQ     UQB$E$NOEADDR
         1 000116   000000 471400 xsym               LDP1    B$JIT$
         1 000117   100012 756100                    STQ     10,,PR1

      280     4191                    /*E* ERROR: UQB-E$NOEADDR-2
      281     4192                    *    MESSAGE: Nowait M$ENQ requires event control
      282     4193                    */
      283     4194    3         IF NOT B$JIT.ERR THEN DO;

   4194  1 000120   000000 470400 xsym               LDP0    B$JIT$
PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:66   
         1 000121   000012 235100                    LDA     10,,PR0
         1 000122   000135 601000 1                  TNZ     BAD_FPT

      284     4195                    /* STORE IN MESSAGE SO IT WONT TRAP WITH GATES LOCKED */
      285     4196    3            IF UQ$.MESSAGE$~=ADDR(NIL) THEN UQ$.MESSAGE$->MESSAGE=ERR;

   4196  1 000123   200011 236100                    LDQ     UQ$+5,,AUTO
         1 000124   000001 116000 xsym               CMPQ    B_VECTNIL+1
         1 000125   000131 600000 1                  TZE     s:4197

   4196  1 000126   200033 235100                    LDA     ERR,,AUTO
         1 000127   200011 471500                    LDP1    UQ$+5,,AUTO
         1 000130   100000 755100                    STA     0,,PR1

      286     4197    3            GOTO ENQ;

   4197  1 000131   000175 710000 1                  TRA     ENQ

      287     4198    3            END;
      288     4199    2         END;
      289     4200    1      ELSE B$JIT.ERR=UQB$E$MISSING_PARAM;

   4200  1 000132   000077 236000 0                  LDQ     UQB$E$MISSING_PARAM
         1 000133   000000 470400 xsym               LDP0    B$JIT$
         1 000134   000012 756100                    STQ     10,,PR0

      290     4201                    /*E* ERROR: UQB-E$MISSING_PARAM-2
      291     4202                    *    MESSAGE: RNAME and SHARE must be specified for M$ENQ
      292     4203                    */
      293     4204    1   BAD_FPT: ALTRETURN;

   4204  1 000135   000000 702200 xent  BAD_FPT      TSX2  ! X66_AALT

      294     4205        %EJECT;
PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:67   
      295     4206                    /*F*      NAME: UQB$MENQS
      296     4207                    *        PURPOSE: To request shared allocation of the monitor reserved
      297     4208                    *        resource (length=0) of the argument QID (CFU$).
      298     4209                    *        DESCRIPTION: This routine will not return until the resource
      299     4210                    *        is allocated. No deadlock detection is performed.
      300     4211                    */
      301     4212    1   UQB$MENQS: ENTRY(ARG1)ALTRET;

   4212  1 000136   000000 700200 xent  UQB$MENQS    TSX0  ! X66_AUTO_1
         1 000137   000056 000001                    ZERO    46,1

      302     4213    1      QV=MENQSHARE.V;

   4213  1 000140   000100 100400                    MLR     fill='000'O
         1 000141   000026 000020 0                  ADSC9   MENQSHARE+6              cn=0,n=16
         1 000142   200012 000020                    ADSC9   QV,,AUTO                 cn=0,n=16

      303     4214    1      GOTO MENQ;

   4214  1 000143   000165 710000 1                  TRA     MENQ

      304     4215        %EJECT;
PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:68   
      305     4216                    /*F*     NAME: UQB$MENQX
      306     4217                   *       PURPOSE: To request exclusive allocation of the monitor reserved
      307     4218                    *        resource (length=0) of the argument QID (CFU$).
      308     4219                    *        DESCRIPTION: This routine will not return until the resource
      309     4220                    *        is allocated. Only upgrade deadlock detection is performed.
      310     4221                    */
      311     4222    1   UQB$MENQX: ENTRY(ARG1)ALTRET;

   4222  1 000144   000000 700200 xent  UQB$MENQX    TSX0  ! X66_AUTO_1
         1 000145   000056 000001                    ZERO    46,1

      312     4223    1      QV=MENQNONE.V;

   4223  1 000146   000100 100400                    MLR     fill='000'O
         1 000147   000040 000020 0                  ADSC9   MENQNONE+6               cn=0,n=16
         1 000150   200012 000020                    ADSC9   QV,,AUTO                 cn=0,n=16

      313     4224    1      GOTO MENQ;

   4224  1 000151   000165 710000 1                  TRA     MENQ

      314     4225        %EJECT;
PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:69   
      315     4226                    /*F*      NAME: UQB$MENQXB
      316     4227                   *       PURPOSE: To request exclusive allocation of the monitor reserved
      317     4228                    *        resource (length=0) of the argument QID (CFU$), BREAKably.
      318     4229                  *       DESCRIPTION: This routine will return when allocated or altreturn
      319     4230                    *        if interrupted. Only upgrade deadlock detection is performed.
      320     4231                    */
      321     4232    1   UQB$MENQXB: ENTRY(ARG1)ALTRET;

   4232  1 000152   000000 700200 xent  UQB$MENQXB   TSX0  ! X66_AUTO_1
         1 000153   000056 000001                    ZERO    46,1

      322     4233    1      QV=MENQNONEB.V;

   4233  1 000154   000100 100400                    MLR     fill='000'O
         1 000155   000060 000020 0                  ADSC9   MENQNONEB+6              cn=0,n=16
         1 000156   200012 000020                    ADSC9   QV,,AUTO                 cn=0,n=16

      323     4234    1      GOTO MENQ;

   4234  1 000157   000165 710000 1                  TRA     MENQ

      324     4235        %EJECT;
PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:70   
      325     4236                    /*F*      NAME: UQB$MENQSB
      326     4237                    *        PURPOSE: To request shared allocation of the monitor reserved
      327     4238                    *        resource (length=0) of the argument QID (CFU$), BREAKably.
      328     4239                  *       DESCRIPTION: This routine will return when allocated or altreturn
      329     4240                    *        if interrupted. Only upgrade deadlock detection is performed.
      330     4241                    */
      331     4242    1   UQB$MENQSB: ENTRY(ARG1)ALTRET;

   4242  1 000160   000000 700200 xent  UQB$MENQSB   TSX0  ! X66_AUTO_1
         1 000161   000056 000001                    ZERO    46,1

      332     4243    1      QV=MENQSHAREB.V;

   4243  1 000162   000100 100400                    MLR     fill='000'O
         1 000163   000072 000020 0                  ADSC9   MENQSHAREB+6             cn=0,n=16
         1 000164   200012 000020                    ADSC9   QV,,AUTO                 cn=0,n=16

   4243  1 000165                       MENQ         null
      333     4244    1   MENQ:;
      334     4245    1      UQ$=MRNAME;

   4245  1 000165   000100 100400                    MLR     fill='000'O
         1 000166   000044 000030 0                  ADSC9   MRNAME                   cn=0,n=24
         1 000167   200004 000030                    ADSC9   UQ$,,AUTO                cn=0,n=24

      335     4246    1      UQ$.QNAME=ARG1B;

   4246  1 000170   200003 470500                    LDP0    @ARG1,,AUTO
         1 000171   000000 236100                    LDQ     0,,PR0
         1 000172   200004 756100                    STQ     UQ$,,AUTO

      336     4247    1      ADDR(QV.EVENT)->PLUGH.EVID=PINCRW(ADDR(UQ$),-4)->PLUGH.ADR;

   4247  1 000173   200000 220100                    LDX0    0,,AUTO
         1 000174   200014 440100                    SXL0    QV+2,,AUTO

   4247  1 000175                       ENQ          null
PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:71   
      337     4248        %EJECT;
PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:72   
      338     4249                    /**/
      339     4250                    /**/
      340     4251    1   ENQ: ;
      341     4252           %LOCK(G=U_LOCK); /* Lock the ENQ/DEQ tables            */

   4253  1 000175   000000 630400 2                  EPPR0   0
         1 000176   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 000177   000000 701000 xent               TSX1    HFC$LOCK
         1 000200   000000 011000                    NOP     0

      342     4255                    /* Since we don't recover gracefully (like, not at all) from run-  */
      343     4256                    /* ning out of memory while building ENQ tables, anticipate all    */
      344     4257                    /* memory requirements before jumping into the fray.               */
      345     4258    1      D_U=S_CUN+UQ$.DOMAIN#*512;

   4258  1 000201   200010 236100                    LDQ     UQ$+4,,AUTO
         1 000202   777777 376003                    ANQ     -1,DU
         1 000203   000011 772000                    QRL     9
         1 000204   000000 036000 xsym               ADLQ    S_CUN
         1 000205   200030 756100                    STQ     DOM_USER,,AUTO

      346     4259    1      CALL CHECK ALTRET(NOMEM);

   4259  1 000206   003325 701000 1                  TSX1    CHECK
         1 000207   001561 702000 1                  TSX2    NOMEM

      347     4260                    /* Locate/Insert a QID node for this QNAME (CFU) */
      348     4261    1      CALL QID_L ALTRET(QID_F);

   4261  1 000210   002006 701000 1                  TSX1    QID_L
         1 000211   000215 702000 1                  TSX2    QID_F

      349     4262    1      CALL QID_I ALTRET (NOENQ);

   4262  1 000212   002370 701000 1                  TSX1    QID_I
         1 000213   001557 702000 1                  TSX2    NOENQ

PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:73   
      350     4263    1      GOTO NEWNTRY;

   4263  1 000214   000372 710000 1                  TRA     NEWNTRY

   4258  1 000215                       QID_F        null
      351     4264    1   QID_F:;
      352     4265                   /* Locate/Insert an RNAME node group for this QID/resource name combo */
      353     4266    1      CALL RNAME_L ALTRET(RNAME_F);

   4266  1 000215   002044 701000 1                  TSX1    RNAME_L
         1 000216   000222 702000 1                  TSX2    RNAME_F

      354     4267    1      CALL RNAME_I ALTRET (NOENQ);

   4267  1 000217   002421 701000 1                  TSX1    RNAME_I
         1 000220   001557 702000 1                  TSX2    NOENQ

      355     4268    1      GOTO NEWNTRY;

   4268  1 000221   000372 710000 1                  TRA     NEWNTRY

   4268  1 000222                       RNAME_F      null
      356     4269    1   RNAME_F:;
      357     4270                    /* Locate/Insert a QENTRY node relating this RNAME/DOMAIN pair */
      358     4271    1      CALL QENTRY_L ALTRET(NOMEM);

   4271  1 000222   002330 701000 1                  TSX1    QENTRY_L
         1 000223   001561 702000 1                  TSX2    NOMEM

      359     4272    1      IF QENTRY@=U_NULL THEN CALL QENTRY_I ALTRET(NOMEM);

   4272  1 000224   200025 220100                    LDX0    QENTRY@,,AUTO
         1 000225   000231 601000 1                  TNZ     s:4276

   4272  1 000226   002570 701000 1                  TSX1    QENTRY_I
         1 000227   001561 702000 1                  TSX2    NOMEM
         1 000230   000372 710000 1                  TRA     NEWNTRY
PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:74   

      360     4273                   /* If the QENTRY is already allocated, then this is an upgrade of its */
      361     4274                    /* share mode and/or LCFLG status. Record the upgrades and set its */
      362     4275                    /* allocation status to "Updated-queued".                          */
      363     4276    1      ELSE IF QENTRY$->QENTRY.STATE~=ALLOCATED OR QENTRY$->QENTRY.UPGRADE

   4276  1 000231   000000 470400 xsym               LDP0    U_BASE
         1 000232   000000 236110                    LDQ     0,X0,PR0
         1 000233   000700 376003                    ANQ     448,DU
         1 000234   000200 116003                    CMPQ    128,DU
         1 000235   000241 601000 1                  TNZ     s:4278
         1 000236   000000 236110                    LDQ     0,X0,PR0
         1 000237   000007 316003                    CANQ    7,DU
         1 000240   000247 600000 1                  TZE     s:4285

      364     4277    2         THEN DO;

      365     4278    2            CALL UNLOCK;

   4278  1 000241   003157 701000 1                  TSX1    UNLOCK
         1 000242   000000 011000                    NOP     0

      366     4279    2            B$JIT.ERR=UQB$E$BAD_UPGRADE;

   4279  1 000243   000111 236000 0                  LDQ     UQB$E$BAD_UPGRADE
         1 000244   000000 470400 xsym               LDP0    B$JIT$
         1 000245   000012 756100                    STQ     10,,PR0

      367     4280                    /*E*   ERROR:  UQB-E$BAD_UPGRADE-2                                */
      368     4281                    /*E*   MESSAGE: Resource must be allocated before upgrade attempted.*/
      369     4282    2            ALTRETURN;

   4282  1 000246   000000 702200 xent               TSX2  ! X66_AALT

      370     4283    2            END;
      371     4284    2         ELSE DO;

PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:75   
      372     4285    2            QENTRY$->QENTRY.UPG_=QV.SHARE*2+BITBIN(QV.LIMITED_COM);

   4285  1 000247   200012 236100                    LDQ     QV,,AUTO
         1 000250   000015 772000                    QRL     13
         1 000251   000001 376007                    ANQ     1,DL
         1 000252   200042 756100                    STQ     PRE@+1,,AUTO
         1 000253   200012 236100                    LDQ     QV,,AUTO
         1 000254   000015 772000                    QRL     13
         1 000255   000006 376007                    ANQ     6,DL
         1 000256   200042 036100                    ADLQ    PRE@+1,,AUTO
         1 000257   000022 736000                    QLS     18
         1 000260   000000 676110                    ERQ     0,X0,PR0
         1 000261   000007 376003                    ANQ     7,DU
         1 000262   000000 656110                    ERSQ    0,X0,PR0

      373     4286    2            IF (UQ_ACCESS(QENTRY$->QENTRY.UPG_)&

   4286  1 000263   000000 221110                    LDX1    0,X0,PR0
         1 000264   000007 361003                    ANX1    7,DU
         1 000265   000000 236110                    LDQ     0,X0,PR0
         1 000266   000025 772000                    QRL     21
         1 000267   000007 376007                    ANQ     7,DL
         1 000270   000000 622006                    EAX2    0,QL
         1 000271   000113 236011 0                  LDQ     UQ_ACCESS,X1
         1 000272   000113 376012 0                  ANQ     UQ_ACCESS,X2
         1 000273   000113 116012 0                  CMPQ    UQ_ACCESS,X2
         1 000274   000340 601000 1                  TNZ     s:4312

      374     4287    2              UQ_ACCESS(QENTRY$->QENTRY.REQ_))=UQ_ACCESS(QENTRY$->QENTRY.REQ_)
      375     4288    3            THEN DO;

      376     4289    3               IF QV.NO_DOWNGRADE

   4289  1 000275   200012 236100                    LDQ     QV,,AUTO
         1 000276   200000 316007                    CANQ    65536,DL
         1 000277   000321 600000 1                  TZE     s:4304

PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:76   
      377     4290    4               THEN IF QENTRY$->QENTRY.REQ_=QENTRY$->QENTRY.UPG_ THEN DO;

   4290  1 000300   000000 236110                    LDQ     0,X0,PR0
         1 000301   000022 772000                    QRL     18
         1 000302   000007 376007                    ANQ     7,DL
         1 000303   200042 756100                    STQ     PRE@+1,,AUTO
         1 000304   000000 236110                    LDQ     0,X0,PR0
         1 000305   000025 772000                    QRL     21
         1 000306   000007 376007                    ANQ     7,DL
         1 000307   200042 116100                    CMPQ    PRE@+1,,AUTO
         1 000310   000315 601000 1                  TNZ     s:4298

      378     4291    4                     B$JIT.ERR=UQB$E$UQ_NOCHANGE;

   4291  1 000311   000110 236000 0                  LDQ     UQB$E$UQ_NOCHANGE
         1 000312   000000 471400 xsym               LDP1    B$JIT$
         1 000313   100012 756100                    STQ     10,,PR1

      379     4292                    /*E* ERROR: UQB-E$UQ_NOCHANGE-2
      380     4293                         MESSAGE: You re-ENQ'd that item with exactly the same options.
      381     4294                    */
      382     4295    4                     GOTO NODWN;

   4295  1 000314   001603 710000 1                  TRA     NODWN

      383     4296    4                     END;
      384     4297    4                  ELSE DO;

      385     4298    4                     B$JIT.ERR=UQB$E$UQ_DOWNGRADE;

   4298  1 000315   000107 236000 0                  LDQ     UQB$E$UQ_DOWNGRADE
         1 000316   000000 471400 xsym               LDP1    B$JIT$
         1 000317   100012 756100                    STQ     10,,PR1

      386     4299                    /*E* ERROR: UQB-E$UQ_DOWNGRADE-2
      387     4300                         MESSAGE: Attempted downgrade request
      388     4301                    */
PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:77   
      389     4302    4                     GOTO NODWN;

   4302  1 000320   001603 710000 1                  TRA     NODWN

      390     4303    4                     END;
      391     4304    3               CRD='777'O;

   4304  1 000321   777000 236003                    LDQ     -512,DU
         1 000322   200034 756100                    STQ     CRD,,AUTO

      392     4305    3               QENTRY$->QENTRY.WAIT=QV.WAIT;

   4305  1 000323   200012 236100                    LDQ     QV,,AUTO
         1 000324   000000 676110                    ERQ     0,X0,PR0
         1 000325   400000 376007                    ANQ     -131072,DL
         1 000326   000000 656110                    ERSQ    0,X0,PR0

      393     4306    3               QENTRY$->QENTRY.EVENT_ID=QV.EVENT;

   4306  1 000327   200014 235100                    LDA     QV+2,,AUTO
         1 000330   000003 755110                    STA     3,X0,PR0

      394     4307    3               CALL ALLOC;

   4307  1 000331   002775 701000 1                  TSX1    ALLOC
         1 000332   000000 011000                    NOP     0

      395     4308    3               CALL ALLOCATE;

   4308  1 000333   002677 701000 1                  TSX1    ALLOCATE
         1 000334   000000 011000                    NOP     0

      396     4309    3               CALL UNLOCK;

   4309  1 000335   003157 701000 1                  TSX1    UNLOCK
         1 000336   000000 011000                    NOP     0

PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:78   
      397     4310    3               RETURN;

   4310  1 000337   000000 702200 xent               TSX2  ! X66_ARET

      398     4311    3               END;
      399     4312    3            ELSE IF QV.NO_UPGRADE THEN DO;

   4312  1 000340   200012 236100                    LDQ     QV,,AUTO
         1 000341   010000 316007                    CANQ    4096,DL
         1 000342   000347 600000 1                  TZE     s:4319

      400     4313    3                  B$JIT.ERR=UQB$E$NO_UPGRADE;

   4313  1 000343   000112 236000 0                  LDQ     UQB$E$NO_UPGRADE
         1 000344   000000 471400 xsym               LDP1    B$JIT$
         1 000345   100012 756100                    STQ     10,,PR1

      401     4314                    /*E* ERROR: UQB-E$NO_UPGRADE-2
      402     4315                         MESSAGE: Attempted upgrade request.
      403     4316                    */
      404     4317    3                  GOTO NODWN;

   4317  1 000346   001603 710000 1                  TRA     NODWN

      405     4318    3                  END;
      406     4319    3            DO WHILE(QENTRY$->QENTRY.QCHAIN@~=U_NULL); /* MOVE TO TAIL OF ALLOCS*/

   4319  1 000347   000001 223110                    LDX3    1,X0,PR0
         1 000350   000372 600000 1                  TZE     NEWNTRY

      407     4320    3               NODE@=QENTRY$->QENTRY.QCHAIN@;

   4320  1 000351   000000 470400 xsym               LDP0    U_BASE
         1 000352   200025 220100                    LDX0    QENTRY@,,AUTO
         1 000353   000001 221110                    LDX1    1,X0,PR0
         1 000354   200026 741100                    STX1    NODE@,,AUTO

PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:79   
      408     4321    4               IF NODE$->QENTRY.STATE=ALLOCATED THEN DO;

   4321  1 000355   000000 236111                    LDQ     0,X1,PR0
         1 000356   000700 376003                    ANQ     448,DU
         1 000357   000200 116003                    CMPQ    128,DU
         1 000360   000372 601000 1                  TNZ     NEWNTRY

      409     4322    4                  QENTRY_PRE$->QENTRY.QCHAIN@=NODE@;

   4322  1 000361   200024 222100                    LDX2    QENTRY_PRE@,,AUTO
         1 000362   000001 741112                    STX1    1,X2,PR0

      410     4323    4                  QENTRY$->QENTRY.QCHAIN@=NODE$->QENTRY.QCHAIN@;

   4323  1 000363   000001 223111                    LDX3    1,X1,PR0
         1 000364   000001 743110                    STX3    1,X0,PR0

      411     4324    4                  NODE$->QENTRY.QCHAIN@=QENTRY@;

   4324  1 000365   000001 740111                    STX0    1,X1,PR0

      412     4325    4                  QENTRY_PRE@=NODE@;

   4325  1 000366   200024 741100                    STX1    QENTRY_PRE@,,AUTO

      413     4326    4                  END;

   4326  1 000367   000370 710000 1                  TRA     s:4328

      414     4327    3               ELSE GOTO NEWNTRY;
      415     4328    3               END;

   4328  1 000370   000001 222110                    LDX2    1,X0,PR0
         1 000371   000351 601000 1                  TNZ     s:4320

      416     4329    2            END;

PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:80   
      417     4330    1   NEWNTRY:;

   4330  1 000372                       NEWNTRY      null
      418     4331    1      QENTRY$->QENTRY.WAIT=QV.WAIT;

   4331  1 000372   000000 470400 xsym               LDP0    U_BASE
         1 000373   200025 220100                    LDX0    QENTRY@,,AUTO
         1 000374   200012 236100                    LDQ     QV,,AUTO
         1 000375   000000 676110                    ERQ     0,X0,PR0
         1 000376   400000 376007                    ANQ     -131072,DL
         1 000377   000000 656110                    ERSQ    0,X0,PR0

      419     4332    1      QENTRY$->QENTRY.EVENT_ID=QV.EVENT;

   4332  1 000400   200014 235100                    LDA     QV+2,,AUTO
         1 000401   000003 755110                    STA     3,X0,PR0

      420     4333                    /* See if this QENTRY is currently allocatable */
      421     4334    1      NODE@=RNAME1$->RNAME1.QCHAIN@;

   4334  1 000402   200021 221100                    LDX1    RNAME1@,,AUTO
         1 000403   000001 222111                    LDX2    1,X1,PR0
         1 000404   200026 742100                    STX2    NODE@,,AUTO

      422     4335    1      CRD='777'O;

   4335  1 000405   777000 236003                    LDQ     -512,DU
         1 000406   200034 756100                    STQ     CRD,,AUTO

      423     4336    2      DO WHILE(NODE@~=U_NULL);

   4336  1 000407   000000 102003                    CMPX2   0,DU
         1 000410   000474 600000 1                  TZE     s:4358

      424     4337    3         IF NODE@~=QENTRY@ THEN DO;

   4337  1 000411   200026 220100                    LDX0    NODE@,,AUTO
PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:81   
         1 000412   200025 100100                    CMPX0   QENTRY@,,AUTO
         1 000413   000471 600000 1                  TZE     s:4356

      425     4338    4            IF NODE$->QENTRY.STATE=ALLOCATED THEN DO;

   4338  1 000414   000000 470400 xsym               LDP0    U_BASE
         1 000415   000000 236110                    LDQ     0,X0,PR0
         1 000416   000700 376003                    ANQ     448,DU
         1 000417   000200 116003                    CMPQ    128,DU
         1 000420   000477 601000 1                  TNZ     NOTNOW

      426     4339    4               CRD=UQ_ACCESS(NODE$->QENTRY.REQ_)&CRD;

   4339  1 000421   000000 236110                    LDQ     0,X0,PR0
         1 000422   000025 772000                    QRL     21
         1 000423   000007 376007                    ANQ     7,DL
         1 000424   000113 236006 0                  LDQ     UQ_ACCESS,QL
         1 000425   200034 376100                    ANQ     CRD,,AUTO
         1 000426   200034 756100                    STQ     CRD,,AUTO

      427     4340    5               IF NODE$->QENTRY.UPGRADE THEN DO;

   4340  1 000427   000000 236110                    LDQ     0,X0,PR0
         1 000430   000007 316003                    CANQ    7,DU
         1 000431   000466 600000 1                  TZE     s:4354

      428     4341    5                  IF QENTRY$->QENTRY.UPGRADE AND QV.WAIT

   4341  1 000432   200025 221100                    LDX1    QENTRY@,,AUTO
         1 000433   000000 236111                    LDQ     0,X1,PR0
         1 000434   000007 316003                    CANQ    7,DU
         1 000435   000460 600000 1                  TZE     s:4350
         1 000436   200012 236100                    LDQ     QV,,AUTO
         1 000437   400000 316007                    CANQ    -131072,DL
         1 000440   000460 600000 1                  TZE     s:4350
         1 000441   000000 236110                    LDQ     0,X0,PR0
         1 000442   400000 316007                    CANQ    -131072,DL
PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:82   
         1 000443   000460 600000 1                  TZE     s:4350
         1 000444   200010 222100                    LDX2    UQ$+4,,AUTO
         1 000445   000001 102003                    CMPX2   1,DU
         1 000446   000460 601000 1                  TNZ     s:4350
         1 000447   000000 223110                    LDX3    0,X0,PR0
         1 000450   000007 363003                    ANX3    7,DU
         1 000451   000000 236111                    LDQ     0,X1,PR0
         1 000452   000025 772000                    QRL     21
         1 000453   000007 376007                    ANQ     7,DL
         1 000454   000000 624006                    EAX4    0,QL
         1 000455   000113 236013 0                  LDQ     UQ_ACCESS,X3
         1 000456   000123 376014 0                  ANQ     UQ_XLATE,X4
         1 000457   001571 600000 1                  TZE     DLOCK

      429     4342    5                    AND NODE$->QENTRY.WAIT AND UQ$.DOMAIN#=1
      430     4343    5                    AND NOT UQ_ACCESS(NODE$->QENTRY.UPG_) &
      431     4344    5                    UQ_XLATE(QENTRY$->QENTRY.REQ_) THEN GOTO DLOCK;
      432     4345                    /*E*  ERROR:  UQB-E$DLOCK-2
      433     4346                          MESSAGE:ENQ request would wait forever (deadlock detected).
      434     4347                          MESSAGE1:A wait ENQ request would result in a circular chain of
      435     4348                                   unsatisfied wait ENQ requests.  It was not honored.
      436     4349                    */
      437     4350    5                  CRD=UQ_ACCESS(NODE$->QENTRY.UPG_)&CRD;

   4350  1 000460   000000 222110                    LDX2    0,X0,PR0
         1 000461   000007 362003                    ANX2    7,DU
         1 000462   000113 236012 0                  LDQ     UQ_ACCESS,X2
         1 000463   200034 376100                    ANQ     CRD,,AUTO
         1 000464   200034 756100                    STQ     CRD,,AUTO

      438     4351    5                  END;

      439     4352    4               END;

   4352  1 000465   000466 710000 1                  TRA     s:4354

      440     4353    3            ELSE GOTO NOTNOW;
PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:83   
      441     4354    3            NODE@=NODE$->QENTRY.QCHAIN@;

   4354  1 000466   000001 221110                    LDX1    1,X0,PR0
         1 000467   200026 741100                    STX1    NODE@,,AUTO

      442     4355    3            END;

   4355  1 000470   000473 710000 1                  TRA     s:4357

      443     4356    2         ELSE NODE@=0; /* THIS ENTRY MUST BE AT THE END OF ALLOCATEDS  */

   4356  1 000471   000000 221003                    LDX1    0,DU
         1 000472   200026 741100                    STX1    NODE@,,AUTO

      444     4357    2         END;

   4357  1 000473   000411 601000 1                  TNZ     s:4337

      445     4358    1      CALL ALLOC ALTRET(NOTNOW);

   4358  1 000474   002775 701000 1                  TSX1    ALLOC
         1 000475   000477 702000 1                  TSX2    NOTNOW

      446     4359    2      DO WHILE('0'B);

   4359  1 000476   001047 710000 1                  TRA     s:4482

   4358  1 000477                       NOTNOW       null
      447     4360    2   NOTNOW:;
      448     4361    3         IF QV.WAIT THEN DO;

   4361  1 000477   200012 236100                    LDQ     QV,,AUTO
         1 000500   400000 316007                    CANQ    -131072,DL
         1 000501   001047 600000 1                  TZE     s:4482

      449     4362    3            S$CU$->B$U.ENQ.WAIT=QENTRY@;

PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:84   
   4362  1 000502   200025 220100                    LDX0    QENTRY@,,AUTO
         1 000503   000000 470400 xsym               LDP0    S$CU$
         1 000504   000016 440100                    SXL0    14,,PR0

      450     4363    3            QENTRY$->QENTRY.DLKFLNK@=0;

   4363  1 000505   000000 221003                    LDX1    0,DU
         1 000506   000000 471400 xsym               LDP1    U_BASE
         1 000507   100002 741110                    STX1    2,X0,PR1

      451     4364                    /* Check for deadlock */
      452     4365    4            IF UQ$.DOMAIN#>1 AND QID@~=QENTRY_PRE@ THEN DO;

   4365  1 000510   200010 222100                    LDX2    UQ$+4,,AUTO
         1 000511   000002 102003                    CMPX2   2,DU
         1 000512   000727 602000 1                  TNC     s:4426
         1 000513   200017 223100                    LDX3    QID@,,AUTO
         1 000514   200024 103100                    CMPX3   QENTRY_PRE@,,AUTO
         1 000515   000727 600000 1                  TZE     s:4426

      453     4366    4               DLKNTRY@=0;

   4366  1 000516   200027 741100                    STX1    DLKNTRY@,,AUTO

      454     4367    4   RE_CHECK:   RHASH@=QENTRY@; /* SET TAIL OF LISTED QENTRIES (USERS)     */

   4367  1 000517   200025 220100       RE_CHECK     LDX0    QENTRY@,,AUTO
         1 000520   200023 740100                    STX0    RHASH@,,AUTO

      455     4368    4               QID@=QENTRY@;

   4368  1 000521   200017 740100                    STX0    QID@,,AUTO

      456     4369    5               DO WHILE(QID@~=U_NULL);

   4369  1 000522   000706 600000 1                  TZE     s:4418

PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:85   
      457     4370    5                  OCRD=UQ_XLATE(QID$->QENTRY.REQ_);

   4370  1 000523   000000 470400 xsym               LDP0    U_BASE
         1 000524   200017 220100                    LDX0    QID@,,AUTO
         1 000525   000000 236110                    LDQ     0,X0,PR0
         1 000526   000025 772000                    QRL     21
         1 000527   000007 376007                    ANQ     7,DL
         1 000530   000123 236006 0                  LDQ     UQ_XLATE,QL
         1 000531   200033 756100                    STQ     ERR,,AUTO

      458     4371    5                  CRD=OCRD;

   4371  1 000532   200034 756100                    STQ     CRD,,AUTO

      459     4372    5                  IF QID$->QENTRY.UPGRADE

   4372  1 000533   000000 236110                    LDQ     0,X0,PR0
         1 000534   000007 316003                    CANQ    7,DU
         1 000535   000542 600000 1                  TZE     s:4374

      460     4373    5                  THEN CRD=UQ_XLATE(QID$->QENTRY.UPG_);

   4373  1 000536   000000 221110                    LDX1    0,X0,PR0
         1 000537   000007 361003                    ANX1    7,DU
         1 000540   000123 236011 0                  LDQ     UQ_XLATE,X1
         1 000541   200034 756100                    STQ     CRD,,AUTO

      461     4374    5                  NODE@=PINCRW(U_BASE$,QID$->QENTRY.RNAME1@)->RNAME1.QCHAIN@;

   4374  1 000542   000001 721110                    LXL1    1,X0,PR0
         1 000543   000001 222111                    LDX2    1,X1,PR0
         1 000544   200026 742100                    STX2    NODE@,,AUTO

      462     4375    6                  DO WHILE(NODE@~=U_NULL);

   4375  1 000545   000676 600000 1                  TZE     s:4414

PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:86   
      463     4376    7                     IF NODE$->QENTRY.STATE=ALLOCATED THEN DO;

   4376  1 000546   000000 470400 xsym               LDP0    U_BASE
         1 000547   200026 220100                    LDX0    NODE@,,AUTO
         1 000550   000000 236110                    LDQ     0,X0,PR0
         1 000551   000700 376003                    ANQ     448,DU
         1 000552   000200 116003                    CMPQ    128,DU
         1 000553   000673 601000 1                  TNZ     s:4412

      464     4377    7                        IF NODE@~=QID@ /* IF THE WAITER WAITS FOR THIS ONE */

   4377  1 000554   200017 100100                    CMPX0   QID@,,AUTO
         1 000555   000670 600000 1                  TZE     s:4410
         1 000556   000000 236110                    LDQ     0,X0,PR0
         1 000557   000025 772000                    QRL     21
         1 000560   000007 376007                    ANQ     7,DL
         1 000561   000113 236006 0                  LDQ     UQ_ACCESS,QL
         1 000562   200034 376100                    ANQ     CRD,,AUTO
         1 000563   000571 600000 1                  TZE     s:4380
         1 000564   000000 221110                    LDX1    0,X0,PR0
         1 000565   000007 361003                    ANX1    7,DU
         1 000566   000113 236011 0                  LDQ     UQ_ACCESS,X1
         1 000567   200033 376100                    ANQ     ERR,,AUTO
         1 000570   000670 601000 1                  TNZ     s:4410

      465     4378    7                          AND (NOT UQ_ACCESS(NODE$->QENTRY.REQ_)&CRD
      466     4379    7                          OR NOT UQ_ACCESS(NODE$->QENTRY.UPG_)&OCRD)
      467     4380    8                        THEN IF NODE$->QENTRY.DOM_USER.USER=S_CUN THEN DO;

   4380  1 000571   000000 236110                    LDQ     0,X0,PR0
         1 000572   000777 376007                    ANQ     511,DL
         1 000573   000000 116000 xsym               CMPQ    S_CUN
         1 000574   000647 601000 1                  TNZ     s:4400

      468     4381    8                              NODE@=QID@;

   4381  1 000575   200017 221100                    LDX1    QID@,,AUTO
PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:87   
         1 000576   200026 741100                    STX1    NODE@,,AUTO

      469     4382    9                              DO WHILE(NODE@~=U_NULL);

   4382  1 000577   000611 600000 1                  TZE     s:4387

      470     4383    9                                 RHASH@=NODE$->QENTRY.DLKFLNK@;

   4383  1 000600   000000 470400 xsym               LDP0    U_BASE
         1 000601   200026 220100                    LDX0    NODE@,,AUTO
         1 000602   000002 221110                    LDX1    2,X0,PR0
         1 000603   200023 741100                    STX1    RHASH@,,AUTO

      471     4384    9                                 NODE$->QENTRY.DLKFLNK@=0;

   4384  1 000604   000000 222003                    LDX2    0,DU
         1 000605   000002 742110                    STX2    2,X0,PR0

      472     4385    9                                 NODE@=RHASH@;

   4385  1 000606   200026 741100                    STX1    NODE@,,AUTO

      473     4386    9                                 END;

   4386  1 000607   000000 101003                    CMPX1   0,DU
         1 000610   000600 601000 1                  TNZ     s:4383

      474     4387    8                              IF DLKNTRY@~=0 THEN GOTO DLOCK;

   4387  1 000611   200027 220100                    LDX0    DLKNTRY@,,AUTO
         1 000612   001571 601000 1                  TNZ     DLOCK

      475     4388    8                              DLKNTRY@=QENTRY@; /* FIND THE LEAST B$U.ENQCOUNT */

   4388  1 000613   200025 222100                    LDX2    QENTRY@,,AUTO
         1 000614   200027 742100                    STX2    DLKNTRY@,,AUTO

PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:88   
      476     4389    9                              DO WHILE(QID@~=QENTRY@);

   4389  1 000615   200017 220100                    LDX0    QID@,,AUTO
         1 000616   200025 100100                    CMPX0   QENTRY@,,AUTO
         1 000617   000643 600000 1                  TZE     s:4396

      477     4390    9                                 IF B$USRT$->B$USER.ENQ.COUNT

   4390  1 000620   000000 470400 xsym               LDP0    U_BASE
         1 000621   200017 220100                    LDX0    QID@,,AUTO
         1 000622   000000 236110                    LDQ     0,X0,PR0
         1 000623   000004 736000                    QLS     4
         1 000624   017760 376007                    ANQ     8176,DL
         1 000625   200027 221100                    LDX1    DLKNTRY@,,AUTO
         1 000626   000000 622006                    EAX2    0,QL
         1 000627   000000 236111                    LDQ     0,X1,PR0
         1 000630   000004 736000                    QLS     4
         1 000631   017760 376007                    ANQ     8176,DL
         1 000632   000000 471400 xsym               LDP1    B$USRT$
         1 000633   100016 223112                    LDX3    14,X2,PR1
         1 000634   100016 103106                    CMPX3   14,QL,PR1
         1 000635   000637 603000 1                  TRC     s:4394

      478     4391    9                                   (QID$->QENTRY.DOM_USER.USER)
      479     4392    9                                   <B$USRT$->B$USER.ENQ.COUNT(DLKNTRY$->
      480     4393    9                                   QENTRY.DOM_USER.USER) THEN DLKNTRY@=QID@;

   4393  1 000636   200027 740100                    STX0    DLKNTRY@,,AUTO

      481     4394    9                                 QID@=QID$->QENTRY.DLKBLNK@;

   4394  1 000637   000002 721110                    LXL1    2,X0,PR0
         1 000640   200017 741100                    STX1    QID@,,AUTO

      482     4395    9                                 END;

   4395  1 000641   200025 101100                    CMPX1   QENTRY@,,AUTO
PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:89   
         1 000642   000620 601000 1                  TNZ     s:4390

      483     4396    8                              IF DLKNTRY@=QENTRY@ THEN GOTO DLOCK;

   4396  1 000643   200027 220100                    LDX0    DLKNTRY@,,AUTO
         1 000644   200025 100100                    CMPX0   QENTRY@,,AUTO
         1 000645   001571 600000 1                  TZE     DLOCK

      484     4397    8                              ELSE GOTO RE_CHECK; /* MAKE SURE IT'LL WORK */

   4397  1 000646   000517 710000 1                  TRA     RE_CHECK

      485     4398    8                              END;
      486     4399    8                           ELSE DO;

      487     4400    8                              RHASH_PRE@=B$USRT$->B$USER.ENQ.WAIT(NODE$->

   4400  1 000647   000004 736000                    QLS     4
         1 000650   000000 471400 xsym               LDP1    B$USRT$
         1 000651   100016 721106                    LXL1    14,QL,PR1
         1 000652   200022 741100                    STX1    RHASH_PRE@,,AUTO

      488     4401    8                                QENTRY.DOM_USER.USER);
      489     4402    8                              IF RHASH_PRE@~=U_NULL AND RHASH_PRE@~=DLKNTRY@

   4402  1 000653   000670 600000 1                  TZE     s:4410
         1 000654   200027 101100                    CMPX1   DLKNTRY@,,AUTO
         1 000655   000670 600000 1                  TZE     s:4410
         1 000656   000000 236111                    LDQ     0,X1,PR0
         1 000657   400000 316007                    CANQ    -131072,DL
         1 000660   000670 600000 1                  TZE     s:4410
         1 000661   000002 222111                    LDX2    2,X1,PR0
         1 000662   000670 601000 1                  TNZ     s:4410

      490     4403    8                                AND RHASH_PRE$->QENTRY.WAIT
      491     4404    9                                AND RHASH_PRE$->QENTRY.DLKFLNK@=0 THEN DO;

PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:90   
      492     4405    9                                 RHASH$->QENTRY.DLKFLNK@=RHASH_PRE@;

   4405  1 000663   200023 223100                    LDX3    RHASH@,,AUTO
         1 000664   000002 741113                    STX1    2,X3,PR0

      493     4406    9                                 RHASH@=RHASH_PRE@;

   4406  1 000665   200023 741100                    STX1    RHASH@,,AUTO

      494     4407    9                                 RHASH$->QENTRY.DLKBLNK@=QID@;

   4407  1 000666   200017 222100                    LDX2    QID@,,AUTO
         1 000667   000002 442111                    SXL2    2,X1,PR0

      495     4408    9                                 END;

      496     4409    8                              END;

      497     4410    7                        NODE@=NODE$->QENTRY.QCHAIN@;

   4410  1 000670   000001 221110                    LDX1    1,X0,PR0
         1 000671   200026 741100                    STX1    NODE@,,AUTO

      498     4411    7                        END;

   4411  1 000672   000675 710000 1                  TRA     s:4413

      499     4412    6                     ELSE NODE@=U_NULL;

   4412  1 000673   000000 221003                    LDX1    0,DU
         1 000674   200026 741100                    STX1    NODE@,,AUTO

      500     4413    6                     END;

   4413  1 000675   000546 601000 1                  TNZ     s:4376

      501     4414    5                  RHASH_PRE@=QID$->QENTRY.DLKFLNK@;
PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:91   

   4414  1 000676   200017 220100                    LDX0    QID@,,AUTO
         1 000677   000002 221110                    LDX1    2,X0,PR0
         1 000700   200022 741100                    STX1    RHASH_PRE@,,AUTO

      502     4415    5                  QID$->QENTRY.DLKFLNK@=0;

   4415  1 000701   000000 222003                    LDX2    0,DU
         1 000702   000002 742110                    STX2    2,X0,PR0

      503     4416    5                  QID@=RHASH_PRE@;

   4416  1 000703   200017 741100                    STX1    QID@,,AUTO

      504     4417    5                  END;

   4417  1 000704   000000 101003                    CMPX1   0,DU
         1 000705   000523 601000 1                  TNZ     s:4370

      505     4418    5               IF DLKNTRY@~=0 THEN DO;

   4418  1 000706   200027 220100                    LDX0    DLKNTRY@,,AUTO
         1 000707   000727 600000 1                  TZE     s:4426

      506     4419    5                  DLKNTRY$->QENTRY.WAIT='0'B;

   4419  1 000710   000000 470400 xsym               LDP0    U_BASE
         1 000711   000004 236000 2                  LDQ     4
         1 000712   000000 356110                    ANSQ    0,X0,PR0

      507     4420    5                  DLKNTRY$->QENTRY.DOM_USER.DOMAIN#=0;

   4420  1 000713   000005 236000 2                  LDQ     5
         1 000714   000000 356110                    ANSQ    0,X0,PR0

      508     4421    5                  CALL SSR$RUE(%SS_NQR,DLKNTRY$->QENTRY.DOM_USER.USER);

PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:92   
   4421  1 000715   200027 236100                    LDQ     DLKNTRY@,,AUTO
         1 000716   777777 376003                    ANQ     -1,DU
         1 000717   600000 036007                    ADLQ    -65536,DL
         1 000720   000000 036000 xsym               ADLQ    U_BASE
         1 000721   000007 235000 2                  LDA     7
         1 000722   200042 757100                    STAQ    PRE@+1,,AUTO
         1 000723   200042 630500                    EPPR0   PRE@+1,,AUTO
         1 000724   000020 631400 xsym               EPPR1   B_VECTNIL+16
         1 000725   000000 701000 xent               TSX1    SSR$RUE
         1 000726   000000 011000                    NOP     0

      509     4422    5                  END;

      510     4423    4               END;

      511     4424                    /* ...and unlock the ENQ/DEQ tables while we park, waiting for the */
      512     4425                    /* QENTRY to become allocatable or the WAIT_TIME to elapse.        */
      513     4426    3            CALL UNLOCK;

   4426  1 000727   003157 701000 1                  TSX1    UNLOCK
         1 000730   000000 011000                    NOP     0

      514     4427    3            IF QV.WAIT_TIME~=0

   4427  1 000731   200013 235100                    LDA     QV+1,,AUTO
         1 000732   000751 600000 1                  TZE     s:4436

      515     4428    4            THEN DO;

      516     4429    4               ERR = %E$BREAK;

   4429  1 000733   001451 236007                    LDQ     809,DL
         1 000734   200033 756100                    STQ     ERR,,AUTO

      517     4430                    /*E*  ERROR:  UQB-E$BREAK-2
      518     4431                          MESSAGE:  Break or cntl Y occurred while waiting for ENQ.
      519     4432                    */
PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:93   
      520     4433    4               CALL SSR$REG(%SS_NQW,ADDR(NIL),QV.WAIT_TIME)

   4433  1 000735   000001 236000 xsym               LDQ     B_VECTNIL+1
         1 000736   200042 756100                    STQ     PRE@+1,,AUTO
         1 000737   200013 630500                    EPPR0   QV+1,,AUTO
         1 000740   200045 450500                    STP0    PRE@+4,,AUTO
         1 000741   200042 631500                    EPPR1   PRE@+1,,AUTO
         1 000742   200044 451500                    STP1    PRE@+3,,AUTO
         1 000743   000011 236000 2                  LDQ     9
         1 000744   200043 756100                    STQ     PRE@+2,,AUTO
         1 000745   200043 630500                    EPPR0   PRE@+2,,AUTO
         1 000746   000021 631400 xsym               EPPR1   B_VECTNIL+17
         1 000747   000000 701000 xent               TSX1    SSR$REG
         1 000750   000753 702000 1                  TSX2    BREAK

      521     4434    4                 ALTRET(BREAK);
      522     4435    4               END;

      523     4436    3            ERR = %E$TIMELIMIT; /* He woke up w/o getting DEQ'd       */

   4436  1 000751   001442 235007                    LDA     802,DL
         1 000752   200033 755100                    STA     ERR,,AUTO

   4436  1 000753                       BREAK        null
      524     4437    3   BREAK:   ;
      525     4438                    /* If we came straight here off of the REG, then this user was     */
      526     4439                    /* woken up by someone else's DEQ, and the QENTRY should now be    */
      527     4440                    /* marked "ALLOCATED". (See UQE$ALLOCATE)                          */
      528     4441                 %LOCK(G=U_LOCK); /* Re-lock the ENQ/DEQ tables*/

   4442  1 000753   000000 630400 2                  EPPR0   0
         1 000754   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 000755   000000 701000 xent               TSX1    HFC$LOCK
         1 000756   000000 011000                    NOP     0

      529     4444    3            S$CU$->B$U.ENQ.WAIT=0;

PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:94   
   4444  1 000757   000000 220003                    LDX0    0,DU
         1 000760   000000 470400 xsym               LDP0    S$CU$
         1 000761   000016 440100                    SXL0    14,,PR0

      530     4445    3            IF QENTRY$->QENTRY.STATE=QUEUED OR

   4445  1 000762   000000 471400 xsym               LDP1    U_BASE
         1 000763   200025 221100                    LDX1    QENTRY@,,AUTO
         1 000764   100000 236111                    LDQ     0,X1,PR1
         1 000765   000700 316003                    CANQ    448,DU
         1 000766   000771 600000 1                  TZE     s:4454
         1 000767   000007 316003                    CANQ    7,DU
         1 000770   001040 600000 1                  TZE     s:4478

      531     4446    3              QENTRY$->QENTRY.UPGRADE
      532     4447    4            THEN DO;

      533     4448                    /* Take care of the case where he timed out on the wait (i.e. he's */
      534     4449                    /* still QUEUED or UQUEUED.                                        */
      535     4450                    /*    If this ENQ was an update request we timed out on, then mark */
      536     4451                    /*      the node allocated but return the user an error code.      */
      537     4452                    /*    If it was a standard ENQ, delete the queue entry and return  */
      538     4453                    /*      an error code.                                             */
      539     4454    5               IF NOT QENTRY$->QENTRY.WAIT THEN DO;

   4454  1 000771   400000 316007                    CANQ    -131072,DL
         1 000772   001001 601000 1                  TNZ     s:4459

      540     4455    5                  QENTRY$->QENTRY.DOM_USER.DOMAIN#=DOM_USER.DOMAIN#;

   4455  1 000773   200030 236100                    LDQ     DOM_USER,,AUTO
         1 000774   100000 676111                    ERQ     0,X1,PR1
         1 000775   007000 376007                    ANQ     3584,DL
         1 000776   100000 656111                    ERSQ    0,X1,PR1

      541     4456    5                  ERR=%E$DLOCK;

PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:95   
   4456  1 000777   001441 235007                    LDA     801,DL
         1 001000   200033 755100                    STA     ERR,,AUTO

      542     4457    5                  END;

      543     4458                    /* SOMEBODY ELSE KNOCKED US OUT */
      544     4459    4               QENTRY$->QENTRY.WAIT='0'B;

   4459  1 001001   000004 236000 2                  LDQ     4
         1 001002   100000 356111                    ANSQ    0,X1,PR1

      545     4460    4               IF QENTRY$->QENTRY.UPGRADE

   4460  1 001003   100000 236111                    LDQ     0,X1,PR1
         1 001004   000007 316003                    CANQ    7,DU
         1 001005   001011 600000 1                  TZE     s:4463

      546     4461    4               THEN QENTRY$->QENTRY.UPGRADE='0'B;

   4461  1 001006   000002 236000 2                  LDQ     2
         1 001007   100000 356111                    ANSQ    0,X1,PR1
         1 001010   001015 710000 1                  TRA     s:4466

      547     4462    5               ELSE DO;

      548     4463    5                  CALL QENTRY_L;

   4463  1 001011   002330 701000 1                  TSX1    QENTRY_L
         1 001012   000000 011000                    NOP     0

      549     4464    5                  CALL QENTRY_DQ;

   4464  1 001013   002652 701000 1                  TSX1    QENTRY_DQ
         1 001014   000000 011000                    NOP     0

      550     4465    5                  END;

PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:96   
      551     4466    4               CALL ALLOCATE;

   4466  1 001015   002677 701000 1                  TSX1    ALLOCATE
         1 001016   000000 011000                    NOP     0

      552     4467    4               CALL UNLOCK;

   4467  1 001017   003157 701000 1                  TSX1    UNLOCK
         1 001020   000000 011000                    NOP     0

      553     4468    4               B$JIT.ERR=ERRCODE;

   4468  1 001021   000076 236000 0                  LDQ     ERRCODE
         1 001022   000000 470400 xsym               LDP0    B$JIT$
         1 001023   000012 756100                    STQ     10,,PR0

      554     4469    4               B$JIT.ERR.CODE=ERR;

   4469  1 001024   200033 236100                    LDQ     ERR,,AUTO
         1 001025   000003 736000                    QLS     3
         1 001026   000012 676100                    ERQ     10,,PR0
         1 001027   377770 376007                    ANQ     131064,DL
         1 001030   000012 656100                    ERSQ    10,,PR0

      555     4470    4               IF ERR=%E$BREAK THEN B$JIT.JUNK=B$JIT.JUNK|%JJ_BAKIC#;

   4470  1 001031   200033 235100                    LDA     ERR,,AUTO
         1 001032   001451 115007                    CMPA    809,DL
         1 001033   001037 601000 1                  TNZ     s:4473

   4470  1 001034   000315 220100                    LDX0    205,,PR0
         1 001035   001000 260003                    ORX0    512,DU
         1 001036   000315 740100                    STX0    205,,PR0

      556     4471                    /*E*   ERROR:  UQB-E$TIMELIMIT-2                                  */
      557     4472                    /*E*   MESSAGE: ENQ/DEQ wait time limit exceeded.                  */
      558     4473    4               ALTRETURN;
PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:97   

   4473  1 001037   000000 702200 xent               TSX2  ! X66_AALT

      559     4474    4               END;
      560     4475                    /* To get here, we must have gotten the QENTRY allocated. */
      561     4476                    /**/
      562     4477                    /* Pass any message back to the user, if he asked for it */
      563     4478    3            IF UQ$.MESSAGE$~=ADDR(NIL)

   4478  1 001040   200011 236100                    LDQ     UQ$+5,,AUTO
         1 001041   000001 116000 xsym               CMPQ    B_VECTNIL+1
         1 001042   001047 600000 1                  TZE     s:4482

      564     4479    3            THEN UQ$.MESSAGE$->MESSAGE=RNAME1$->RNAME1.COMM;

   4479  1 001043   200021 222100                    LDX2    RNAME1@,,AUTO
         1 001044   200011 473500                    LDP3    UQ$+5,,AUTO
         1 001045   100002 235112                    LDA     2,X2,PR1
         1 001046   300000 755100                    STA     0,,PR3

      565     4480    3            END;

      566     4481    2         END;

      567     4482    1      CALL UNLOCK;

   4482  1 001047   003157 701000 1                  TSX1    UNLOCK
         1 001050   000000 011000                    NOP     0

      568     4483    1      RETURN;

   4483  1 001051   000000 702200 xent               TSX2  ! X66_ARET

      569     4484                    /**/
      570     4485        %EJECT;
PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:98   
      571     4486                    /*F*      NAME: UQB$TESTNQR
      572     4487                    *         PURPOSE: Entry for testing purposes for simulating wakeup
      573     4488                    *                  from SSR$REG.
      574     4489                    */
      575     4490    1   UQB$TESTNQR: ENTRY ALTRET;

   4490  1 001052   000000 700200 xent  UQB$TESTNQR  TSX0  ! X66_AUTO_1
         1 001053   000056 000001                    ZERO    46,1

      576     4491    1      QENTRY@=S$CU$->B$U.ENQ.WAIT;

   4491  1 001054   000000 470400 xsym               LDP0    S$CU$
         1 001055   000016 720100                    LXL0    14,,PR0
         1 001056   200025 740100                    STX0    QENTRY@,,AUTO

      577     4492    1      RNAME1@=QENTRY$->QENTRY.RNAME1@;

   4492  1 001057   000000 471400 xsym               LDP1    U_BASE
         1 001060   100001 721110                    LXL1    1,X0,PR1
         1 001061   200021 741100                    STX1    RNAME1@,,AUTO

      578     4493    1      D_U=QENTRY$->QENTRY.D_U;

   4493  1 001062   100000 236110                    LDQ     0,X0,PR1
         1 001063   007777 376007                    ANQ     4095,DL
         1 001064   200030 756100                    STQ     DOM_USER,,AUTO

      579     4494    1      ERR=%E$TIMELIMIT;

   4494  1 001065   001442 235007                    LDA     802,DL
         1 001066   200033 755100                    STA     ERR,,AUTO

      580     4495    1      GOTO BREAK;

   4495  1 001067   000753 710000 1                  TRA     BREAK

      581     4496                    /*F*      NAME: UQB$MDEQ
PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:99   
      582     4497                    *         PURPOSE: To release the reserved monitor resource.
      583     4498                    */
      584     4499    1   UQB$MDEQ: ENTRY(ARG1)ALTRET;

   4499  1 001070   000000 700200 xent  UQB$MDEQ     TSX0  ! X66_AUTO_1
         1 001071   000056 000001                    ZERO    46,1

      585     4500    1      UQ$=MRNAME;

   4500  1 001072   000100 100400                    MLR     fill='000'O
         1 001073   000044 000030 0                  ADSC9   MRNAME                   cn=0,n=24
         1 001074   200004 000030                    ADSC9   UQ$,,AUTO                cn=0,n=24

      586     4501    1      UQ$.QNAME=ARG1B;

   4501  1 001075   200003 470500                    LDP0    @ARG1,,AUTO
         1 001076   000000 236100                    LDQ     0,,PR0
         1 001077   200004 756100                    STQ     UQ$,,AUTO

      587     4502    1      GOTO DEQ;

   4502  1 001100   001131 710000 1                  TRA     DEQ

      588     4503        %EJECT;
PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:100  
      589     4504                    /*F*      NAME: UQB$UDEQ
      590     4505                    *         PURPOSE: To perform a user M$DEQ request.
      591     4506                    */
      592     4507    1   UQB$UDEQ: ENTRY(ARG1)ALTRET;

   4507  1 001101   000000 700200 xent  UQB$UDEQ     TSX0  ! X66_AUTO_1
         1 001102   000056 000001                    ZERO    46,1

      593     4508    1      QV=B$PS0$->FPT$DEQ_V;

   4508  1 001103   000000 470400 xsym               LDP0    B$PS0$
         1 001104   000100 100500                    MLR     fill='000'O
         1 001105   000000 000010                    ADSC9   0,,PR0                   cn=0,n=8
         1 001106   200012 000020                    ADSC9   QV,,AUTO                 cn=0,n=16

      594     4509    1      CALL ARGS ALTRET(BAD_FPT);

   4509  1 001107   003203 701000 1                  TSX1    ARGS
         1 001110   000135 702000 1                  TSX2    BAD_FPT

      595     4510    1      UQ$.DEQ_COMMAND=2*BITBIN(ADDR(QV)->FPT$DEQ_V.RELRES) +

   4510  1 001111   200012 236100                    LDQ     QV,,AUTO
         1 001112   000021 772000                    QRL     17
         1 001113   000001 376007                    ANQ     1,DL
         1 001114   200042 756100                    STQ     PRE@+1,,AUTO
         1 001115   200012 236100                    LDQ     QV,,AUTO
         1 001116   000020 772000                    QRL     16
         1 001117   000001 376007                    ANQ     1,DL
         1 001120   200043 756100                    STQ     PRE@+2,,AUTO
         1 001121   200042 236100                    LDQ     PRE@+1,,AUTO
         1 001122   000001 736000                    QLS     1
         1 001123   200043 036100                    ADLQ    PRE@+2,,AUTO
         1 001124   777777 620006                    EAX0    -1,QL
         1 001125   200010 440100                    SXL0    UQ$+4,,AUTO

      596     4511    1        BITBIN( ADDR(QV)->FPT$DEQ_V.CANCEL)-1;
PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:101  
      597     4512    1      IF UQ$.DEQ_COMMAND>DELQENTRY_ THEN RETURN;

   4512  1 001126   000003 100003                    CMPX0   3,DU
         1 001127   001131 602000 1                  TNC     DEQ

   4512  1 001130   000000 702200 xent               TSX2  ! X66_ARET

   4512  1 001131                       DEQ          null
      598     4513                    /**/
      599     4514                    /**/
      600     4515    1   DEQ: ;
      601     4516           %LOCK(G=U_LOCK); /* Lock the ENQ/DEQ tables            */

   4517  1 001131   000000 630400 2                  EPPR0   0
         1 001132   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 001133   000000 701000 xent               TSX1    HFC$LOCK
         1 001134   000000 011000                    NOP     0

      602     4519    1      D_U=S_CUN+UQ$.DOMAIN#*512;

   4519  1 001135   200010 236100                    LDQ     UQ$+4,,AUTO
         1 001136   777777 376003                    ANQ     -1,DU
         1 001137   000011 772000                    QRL     9
         1 001140   000000 036000 xsym               ADLQ    S_CUN
         1 001141   200030 756100                    STQ     DOM_USER,,AUTO

      603     4520                    /* Find a QID node for the specified QNAME (CFU) */
      604     4521    2      CALL QID_L WHENALTRETURN DO;

   4521  1 001142   002006 701000 1                  TSX1    QID_L
         1 001143   001145 702000 1                  TSX2    s:4522
         1 001144   001275 710000 1                  TRA     NODEQ

      605     4522    2         IF ADDR(RNAME)~=ADDR(NIL)

   4522  1 001145   200005 236100                    LDQ     UQ$+1,,AUTO
         1 001146   000001 116000 xsym               CMPQ    B_VECTNIL+1
PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:102  
         1 001147   001156 600000 1                  TZE     DEQID

      606     4523    3         THEN CALL RNAME_L WHENRETURN DO;

   4523  1 001150   002044 701000 1                  TSX1    RNAME_L
         1 001151   001153 702000 1                  TSX2    s:4526

      607     4524    3               GOTO NODEQ;

   4524  1 001152   001275 710000 1                  TRA     NODEQ

      608     4525    3               END; WHENALTRETURN DO;

      609     4526    3               CALL DEQ_PROC ALTRET(NODEQ);

   4526  1 001153   001624 701000 1                  TSX1    DEQ_PROC
         1 001154   001275 702000 1                  TSX2    NODEQ

      610     4527    3               END;

   4527  1 001155   001251 710000 1                  TRA     s:4556

      611     4528    3         ELSE DO; /* Do if 'ALL' specified              */

   4525  1 001156                       DEQID        null
      612     4529    3   DEQID:   ;
      613     4530    3            RHASH_PRE@=QID@;

   4530  1 001156   200017 220100                    LDX0    QID@,,AUTO
         1 001157   200022 740100                    STX0    RHASH_PRE@,,AUTO

      614     4531    3            RHASH@=QID$->QID.XCHAIN@;

   4531  1 001160   000000 470400 xsym               LDP0    U_BASE
         1 001161   000000 721110                    LXL1    0,X0,PR0
         1 001162   200023 741100                    STX1    RHASH@,,AUTO

PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:103  
      615     4532                    /* Loop through all of the RNAMEs for the CFU */
      616     4533    4            DO WHILE(RHASH@~=U_NULL);

   4533  1 001163   001251 600000 1                  TZE     s:4556

      617     4534    4               RNAME_PRE@ = U_NULL;

   4534  1 001164   000000 220003                    LDX0    0,DU
         1 001165   200020 740100                    STX0    RNAME_PRE@,,AUTO

      618     4535    4               RNAME1@=RHASH@;

   4535  1 001166   200023 221100                    LDX1    RHASH@,,AUTO
         1 001167   200021 741100                    STX1    RNAME1@,,AUTO

      619     4536    5               DO WHILE (RNAME1@ ~= U_NULL);

   4536  1 001170   001241 600000 1                  TZE     s:4551

      620     4537    5                  QENTRY@=RNAME1$->RNAME1.QCHAIN@;

   4537  1 001171   000000 470400 xsym               LDP0    U_BASE
         1 001172   200021 220100                    LDX0    RNAME1@,,AUTO
         1 001173   000001 221110                    LDX1    1,X0,PR0
         1 001174   200025 741100                    STX1    QENTRY@,,AUTO

      621     4538    5                  QENTRY_PRE@=RNAME1@;

   4538  1 001175   200024 740100                    STX0    QENTRY_PRE@,,AUTO

      622     4539    5                  IF D_U~=0 OR QENTRY@=U_NULL THEN CALL DEQ_PROC;

   4539  1 001176   200030 235100                    LDA     DOM_USER,,AUTO
         1 001177   001202 601000 1                  TNZ     s:4539+4
         1 001200   000000 101003                    CMPX1   0,DU
         1 001201   001205 601000 1                  TNZ     s:4540

PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:104  
   4539  1 001202   001624 701000 1                  TSX1    DEQ_PROC
         1 001203   000000 011000                    NOP     0
         1 001204   001225 710000 1                  TRA     s:4546

      623     4540    6                  ELSE DO WHILE(QENTRY@~=U_NULL);

   4540  1 001205   001225 600000 1                  TZE     s:4546

      624     4541    6                     IF QENTRY$->QENTRY.DOM_USER.USER=S_CUN

   4541  1 001206   000000 470400 xsym               LDP0    U_BASE
         1 001207   200025 220100                    LDX0    QENTRY@,,AUTO
         1 001210   000000 236110                    LDQ     0,X0,PR0
         1 001211   000777 376007                    ANQ     511,DL
         1 001212   000000 116000 xsym               CMPQ    S_CUN
         1 001213   001217 601000 1                  TNZ     s:4543

      625     4542    6                     THEN CALL DEQ_QID ALTRET(ENQ_ERR);

   4542  1 001214   001776 701000 1                  TSX1    DEQ_QID
         1 001215   000052 702000 1                  TSX2    ENQ_ERR
         1 001216   001220 710000 1                  TRA     s:4544

      626     4543    6                     ELSE QENTRY_PRE@=QENTRY@;

   4543  1 001217   200024 740100                    STX0    QENTRY_PRE@,,AUTO

      627     4544    6                     QENTRY@=QENTRY_PRE$->QENTRY.QCHAIN@;

   4544  1 001220   000000 470400 xsym               LDP0    U_BASE
         1 001221   200024 220100                    LDX0    QENTRY_PRE@,,AUTO
         1 001222   000001 221110                    LDX1    1,X0,PR0
         1 001223   200025 741100                    STX1    QENTRY@,,AUTO

      628     4545    6                     END;

   4545  1 001224   001206 601000 1                  TNZ     s:4541
PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:105  

      629     4546    5                  UQ$.LENGTH=1; /* RELEASE ALL BUT MONITOR RNAME NODES */

   4546  1 001225   000001 235007                    LDA     1,DL
         1 001226   200006 755100                    STA     UQ$+2,,AUTO

      630     4547    5                  RNAME_PRE@ = RNAME1@;

   4547  1 001227   200021 220100                    LDX0    RNAME1@,,AUTO
         1 001230   200020 740100                    STX0    RNAME_PRE@,,AUTO

      631     4548    5                  IF RNAME1@=U_NULL THEN RNAME1@=RHASH@;

   4548  1 001231   001235 601000 1                  TNZ     s:4549

   4548  1 001232   200023 221100                    LDX1    RHASH@,,AUTO
         1 001233   200021 741100                    STX1    RNAME1@,,AUTO
         1 001234   001240 710000 1                  TRA     s:4550

      632     4549    5                  ELSE RNAME1@ = RNAME1$->RNAME1.RCHAIN@;

   4549  1 001235   000000 470400 xsym               LDP0    U_BASE
         1 001236   000001 721110                    LXL1    1,X0,PR0
         1 001237   200021 741100                    STX1    RNAME1@,,AUTO

      633     4550    5                  END;

   4550  1 001240   001171 601000 1                  TNZ     s:4537

      634     4551    4               IF RHASH@~=U_NULL THEN RHASH_PRE@=RHASH@;

   4551  1 001241   200023 222100                    LDX2    RHASH@,,AUTO
         1 001242   001244 600000 1                  TZE     s:4552

   4551  1 001243   200022 742100                    STX2    RHASH_PRE@,,AUTO

      635     4552    4               RHASH@=RHASH_PRE$->RNAME1.XCHAIN@;
PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:106  

   4552  1 001244   000000 470400 xsym               LDP0    U_BASE
         1 001245   200022 223100                    LDX3    RHASH_PRE@,,AUTO
         1 001246   000000 724113                    LXL4    0,X3,PR0
         1 001247   200023 744100                    STX4    RHASH@,,AUTO

      636     4553    4               END;

   4553  1 001250   001164 601000 1                  TNZ     s:4534

      637     4554    3            END;

      638     4555                    /* DELQIDX SHOULD DELETE THE QID ENTRY     */
      639     4556    3         IF D_U=0 AND UQ$.DOMAIN#=0 AND QID@~=UQ_.NEXT_BLOCK@ THEN DO;

   4556  1 001251   200030 235100                    LDA     DOM_USER,,AUTO
         1 001252   001265 601000 1                  TNZ     s:4560
         1 001253   200010 220100                    LDX0    UQ$+4,,AUTO
         1 001254   001265 601000 1                  TNZ     s:4560
         1 001255   000000 470400 xsym               LDP0    U_BASE
         1 001256   000043 721100                    LXL1    35,,PR0
         1 001257   200017 101100                    CMPX1   QID@,,AUTO
         1 001260   001265 600000 1                  TZE     s:4560

      640     4557    3            CALL UNLOCK;

   4557  1 001261   003157 701000 1                  TSX1    UNLOCK
         1 001262   000000 011000                    NOP     0

      641     4558    3            CALL SC_FSERR;

   4558  1 001263   000000 713400 xsym               CLIMB   SC_FSERR
         1 001264   000000 600000 xsid               climb   nvectors=         0

      642     4559    3            END;

      643     4560    2         IF UQ$.DOMAIN#>3 THEN B$JIT.ERR='0'B;
PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:107  

   4560  1 001265   200010 220100                    LDX0    UQ$+4,,AUTO
         1 001266   000004 100003                    CMPX0   4,DU
         1 001267   001272 602000 1                  TNC     s:4561

   4560  1 001270   000000 470400 xsym               LDP0    B$JIT$
         1 001271   000012 450100                    STZ     10,,PR0

      644     4561    2         CALL UNLOCK;

   4561  1 001272   003157 701000 1                  TSX1    UNLOCK
         1 001273   000000 011000                    NOP     0

      645     4562    2         RETURN;

   4562  1 001274   000000 702200 xent               TSX2  ! X66_ARET

   4557  1 001275                       NODEQ        null
      646     4563    2         END;
      647     4564    1   NODEQ:;
      648     4565    1      CALL UNLOCK; /* Unlock the ENQ/DEQ tables          */

   4565  1 001275   003157 701000 1                  TSX1    UNLOCK
         1 001276   000000 011000                    NOP     0

      649     4566    1      IF UQ$.RNAME$=ADDR(NIL) OR UQ$.LENGTH~=0 THEN B$JIT.ERR=UQB$E$CRD_ERR;

   4566  1 001277   200005 236100                    LDQ     UQ$+1,,AUTO
         1 001300   000001 116000 xsym               CMPQ    B_VECTNIL+1
         1 001301   001304 600000 1                  TZE     s:4566+5
         1 001302   200006 235100                    LDA     UQ$+2,,AUTO
         1 001303   001310 600000 1                  TZE     s:4569

   4566  1 001304   000105 236000 0                  LDQ     UQB$E$CRD_ERR
         1 001305   000000 470400 xsym               LDP0    B$JIT$
         1 001306   000012 756100                    STQ     10,,PR0
         1 001307   001312 710000 1                  TRA     s:4574
PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:108  

      650     4567                    /*E*   ERROR:  UQB-E$CRD_ERR-2                                    */
      651     4568                    /*E*   MESSAGE: Type of DEQ incompatible with state.               */
      652     4569    1      ELSE CALL SC_FMF98;

   4569  1 001310   000000 713400 xsym               CLIMB   SC_FMF98
         1 001311   000000 600000 xsid               climb   nvectors=         0

      653     4570                    /*S*   SCREECH_CODE: UQB-S$FSERR
      654     4571                    *      TYPE:  SUA
      655     4572                    *      MESSAGE: File management ENQ altreturn.
      656     4573                    */
      657     4574    1      ALTRETURN;

   4574  1 001312   000000 702200 xent               TSX2  ! X66_AALT

      658     4575        %EJECT;
PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:109  
      659     4576                    /*F*   NAME:   UQB$DELUSER                                         */
      660     4577              /*F*   PURPOSE: To clean up any remaining QENTRY nodes associated with   */
      661     4578              /*,*           the current user at termination. The existence thereof is */
      662     4579              /*,*           an indication that a DCB did not get closed, so a dump is */
      663     4580              /*,*           always produced.                                          */
      664     4581    1   UQB$DELUSER:ENTRY ALTRET;

   4581  1 001313   000000 700200 xent  UQB$DELUSER  TSX0  ! X66_AUTO_1
         1 001314   000056 000001                    ZERO    46,1

      665     4582                    /**/
      666     4583    1      D_U=1;

   4583  1 001315   000001 235007                    LDA     1,DL
         1 001316   200030 755100                    STA     DOM_USER,,AUTO

      667     4584    1      IF UQ_.GDS_LOCK=S_CUN THEN UQ_.GDS_LOCK=0;

   4584  1 001317   000000 470400 xsym               LDP0    U_BASE
         1 001320   000040 236100                    LDQ     32,,PR0
         1 001321   001325 604000 1                  TMI     s:4585
         1 001322   000000 116000 xsym               CMPQ    S_CUN
         1 001323   001325 601000 1                  TNZ     s:4585

   4584  1 001324   000040 450100                    STZ     32,,PR0

      668     4585    1      NODE@=UQ_.NEXT_PAGE@;

   4585  1 001325   000041 720100                    LXL0    33,,PR0
         1 001326   200026 740100                    STX0    NODE@,,AUTO

      669     4586    1      QENTRY@=SIZEW(UQ_);

   4586  1 001327   000044 221003                    LDX1    36,DU
         1 001330   200025 741100                    STX1    QENTRY@,,AUTO

      670     4587    2      DO WHILE(QENTRY@<NODE@);
PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:110  

   4587  1 001331   200026 101100                    CMPX1   NODE@,,AUTO
         1 001332   001426 603000 1                  TRC     s:4601

      671     4588    2         IF QENTRY$->NODE.TYPE=QENTRY_TYPE

   4588  1 001333   000000 470400 xsym               LDP0    U_BASE
         1 001334   200025 220100                    LDX0    QENTRY@,,AUTO
         1 001335   000000 236110                    LDQ     0,X0,PR0
         1 001336   777000 376003                    ANQ     -512,DU
         1 001337   050000 116003                    CMPQ    20480,DU
         1 001340   001421 601000 1                  TNZ     s:4599
         1 001341   000000 236110                    LDQ     0,X0,PR0
         1 001342   000777 376007                    ANQ     511,DL
         1 001343   000000 116000 xsym               CMPQ    S_CUN
         1 001344   001421 601000 1                  TNZ     s:4599

      672     4589    3           AND QENTRY$->QENTRY.DOM_USER.USER=S_CUN THEN DO;

      673     4590    3            IF D_U~=0 AND B$JIT.SYSID~=IRM_SYSID THEN CALL SC_FMF98;

   4590  1 001345   200030 235100                    LDA     DOM_USER,,AUTO
         1 001346   001356 600000 1                  TZE     s:4591
         1 001347   000000 471400 xsym               LDP1    B$JIT$
         1 001350   100000 236100                    LDQ     0,,PR1
         1 001351   777777 376007                    ANQ     -1,DL
         1 001352   000000 116000 xsym               CMPQ    IRM_SYSID
         1 001353   001356 600000 1                  TZE     s:4591

   4590  1 001354   000000 713400 xsym               CLIMB   SC_FMF98
         1 001355   000000 600000 xsid               climb   nvectors=         0

      674     4591    3            D_U=0; /* ONLY ONCE */

   4591  1 001356   200030 450100                    STZ     DOM_USER,,AUTO

      675     4592    3            QID@=PINCRW(U_BASE$,QENTRY$->QENTRY.RNAME1@)->RNAME1.RHEAD@;
PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:111  

   4592  1 001357   000000 470400 xsym               LDP0    U_BASE
         1 001360   200025 220100                    LDX0    QENTRY@,,AUTO
         1 001361   000001 721110                    LXL1    1,X0,PR0
         1 001362   000003 222111                    LDX2    3,X1,PR0
         1 001363   200017 742100                    STX2    QID@,,AUTO

      676     4593    3            CALL UQB$DELQID(QID$->QID.NAME); /* DEQALL */

   4593  1 001364   200017 236100                    LDQ     QID@,,AUTO
         1 001365   777777 376003                    ANQ     -1,DU
         1 001366   000003 036003                    ADLQ    3,DU
         1 001367   000000 036000 xsym               ADLQ    U_BASE
         1 001370   200042 756100                    STQ     PRE@+1,,AUTO
         1 001371   200042 630500                    EPPR0   PRE@+1,,AUTO
         1 001372   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 001373   001427 701000 1                  TSX1    s:4613
         1 001374   000000 011000                    NOP     0

      677     4594    3            RNAME1@=QID$->QID.XCHAIN@;

   4594  1 001375   000000 470400 xsym               LDP0    U_BASE
         1 001376   200017 220100                    LDX0    QID@,,AUTO
         1 001377   000000 721110                    LXL1    0,X0,PR0
         1 001400   200021 741100                    STX1    RNAME1@,,AUTO

      678     4595    3            IF RNAME1@=U_NULL OR RNAME1$->RNAME1.XCHAIN@=U_NULL

   4595  1 001401   001410 600000 1                  TZE     s:4597
         1 001402   000000 722111                    LXL2    0,X1,PR0
         1 001403   001421 601000 1                  TNZ     s:4599
         1 001404   000001 223111                    LDX3    1,X1,PR0
         1 001405   001421 601000 1                  TNZ     s:4599
         1 001406   000001 724111                    LXL4    1,X1,PR0
         1 001407   001421 601000 1                  TNZ     s:4599

      679     4596    3              AND RNAME1$->RNAME1.QCHAIN@=U_NULL AND RNAME1$->RNAME1.RCHAIN@=U_NULL
PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:112  
      680     4597    3            THEN CALL UQB$DELQIDX(QID$->QID.NAME);

   4597  1 001410   200017 236100                    LDQ     QID@,,AUTO
         1 001411   777777 376003                    ANQ     -1,DU
         1 001412   000003 036003                    ADLQ    3,DU
         1 001413   000000 036000 xsym               ADLQ    U_BASE
         1 001414   200042 756100                    STQ     PRE@+1,,AUTO
         1 001415   200042 630500                    EPPR0   PRE@+1,,AUTO
         1 001416   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 001417   001544 701000 1                  TSX1    s:4646
         1 001420   000000 011000                    NOP     0

      681     4598    3            END;

      682     4599    2         QENTRY@=QENTRY@+BLKSZE;

   4599  1 001421   200025 220100                    LDX0    QENTRY@,,AUTO
         1 001422   000004 621010                    EAX1    4,X0
         1 001423   200025 741100                    STX1    QENTRY@,,AUTO

      683     4600    2         END;

   4600  1 001424   200026 101100                    CMPX1   NODE@,,AUTO
         1 001425   001333 602000 1                  TNC     s:4588

      684     4601    1      RETURN;

   4601  1 001426   000000 702200 xent               TSX2  ! X66_ARET

      685     4602        %EJECT;
PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:113  
      686     4603                    /*F*   NAME:   UQB$DELQID                                          */
      687     4604            /*F*   ENTRY: UQB$DELQIDX                                                    */
      688     4605                    /*F*   PURPOSE: To delete the association, if any, between the     */
      689     4606                    /*,*           RNAMEs existing for the resource group specified by */
      690     4607                    /*,*           QNAME and the current user.                         */
      691     4608                   /*F*  DESCRIPTION: If entered at DELQIDX, then the QID and all assoc- */
      692     4609                    /*,*           iated RNAMEs owned solely by the current user are   */
      693     4610                    /*,*           also deleted. If all RNAME nodes     for the spec-  */
      694     4611                    /*,*           ified QNAME aren't owned by the current user, then a */
      695     4612                    /*,*           a screech will be caused.                           */
      696     4613    1   UQB$DELQID: ENTRY(ARG1) ALTRET;

   4613  1 001427   000000 700200 xent  UQB$DELQID   TSX0  ! X66_AUTO_1
         1 001430   000056 000001                    ZERO    46,1

      697     4614                    /**/
      698     4615    1      UQ$=MRNAME;

   4615  1 001431   000100 100400                    MLR     fill='000'O
         1 001432   000044 000030 0                  ADSC9   MRNAME                   cn=0,n=24
         1 001433   200004 000030                    ADSC9   UQ$,,AUTO                cn=0,n=24

      699     4616    1      D_U=S_CUN+512; /* First DEQ any monitor ENQs */

   4616  1 001434   000000 235000 xsym               LDA     S_CUN
         1 001435   001000 035007                    ADLA    512,DL
         1 001436   200030 755100                    STA     DOM_USER,,AUTO

      700     4617    1      IF B$JIT.DCB$->F$DCB.WSR~=0

   4617  1 001437   000000 470400 xsym               LDP0    B$JIT$
         1 001440   000232 471500                    LDP1    154,,PR0
         1 001441   100040 236100                    LDQ     32,,PR1
         1 001442   000777 316003                    CANQ    511,DU
         1 001443   001447 600000 1                  TZE     s:4619

      701     4618    1      THEN UQ$.DOMAIN#=B$JIT.DCB$->F$DCB.WSR;
PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:114  

   4618  1 001444   100040 220100                    LDX0    32,,PR1
         1 001445   000777 360003                    ANX0    511,DU
         1 001446   200010 740100                    STX0    UQ$+4,,AUTO

      702     4619    2      IF ADDR(ARG1)=ADDR(B$JIT.DCB$->F$DCB.CFU$) THEN DO;

   4619  1 001447   200042 451500                    STP1    PRE@+1,,AUTO
         1 001450   200042 236100                    LDQ     PRE@+1,,AUTO
         1 001451   000066 036003                    ADLQ    54,DU
         1 001452   200003 116100                    CMPQ    @ARG1,,AUTO
         1 001453   001507 601000 1                  TNZ     DEQID0

      703     4620    3         DO ERR=%M$MAXNEG# TO B$ROSEG.NUMDCBS;

   4620  1 001454   000040 336007                    LCQ     32,DL
         1 001455   200033 756100                    STQ     ERR,,AUTO
         1 001456   001501 710000 1                  TRA     s:4625+1

      704     4621    3            IF DCBADDR(ERR)~=ADDR(NIL) AND DCBADDR(ERR)~=B$JIT.DCB$

   4621  1 001457   000012 470400 2                  LDP0    10
         1 001460   000000 471500                    LDP1    0,,PR0
         1 001461   200033 720100                    LXL0    ERR,,AUTO
         1 001462   100000 236110                    LDQ     0,X0,PR1
         1 001463   000001 116000 xsym               CMPQ    B_VECTNIL+1
         1 001464   001500 600000 1                  TZE     s:4625
         1 001465   000000 473400 xsym               LDP3    B$JIT$
         1 001466   300232 116100                    CMPQ    154,,PR3
         1 001467   001500 600000 1                  TZE     s:4625

      705     4622    3            THEN IF DCBADDR(ERR)->F$DCB.FCD

   4622  1 001470   100000 474510                    LDP4    0,X0,PR1
         1 001471   400031 236100                    LDQ     25,,PR4
         1 001472   020000 316007                    CANQ    8192,DL
         1 001473   001500 600000 1                  TZE     s:4625
PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:115  
         1 001474   200003 475500                    LDP5    @ARG1,,AUTO
         1 001475   400066 236100                    LDQ     54,,PR4
         1 001476   500000 116100                    CMPQ    0,,PR5
         1 001477   001507 600000 1                  TZE     DEQID0

      706     4623    3                 AND DCBADDR(ERR)->F$DCB.CFU$=DOLIST$ THEN GOTO DEQID0;
      707     4624                    /* DOLIST$ is a redef of ARG1 */
      708     4625    3            END;

   4625  1 001500   200033 054100                    AOS     ERR,,AUTO
         1 001501   000000 470400 xsym               LDP0    B$ROSEG$
         1 001502   000002 236100                    LDQ     2,,PR0
         1 001503   000022 772000                    QRL     18
         1 001504   200033 116100                    CMPQ    ERR,,AUTO
         1 001505   001457 605000 1                  TPL     s:4621

      709     4626    2         D_U = 0; /* DEQALL if this is the last DCB for this user */

   4626  1 001506   200030 450100                    STZ     DOM_USER,,AUTO

      710     4627    2         END;

   4622  1 001507                       DEQID0       null
      711     4628    1   DEQID0:;
      712     4629    1      UQ$.QNAME=ARG1B;

   4629  1 001507   200003 470500                    LDP0    @ARG1,,AUTO
         1 001510   000000 236100                    LDQ     0,,PR0
         1 001511   200004 756100                    STQ     UQ$,,AUTO

      713     4630           %LOCK(G=U_LOCK);

   4631  1 001512   000000 630400 2                  EPPR0   0
         1 001513   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 001514   000000 701000 xent               TSX1    HFC$LOCK
         1 001515   000000 011000                    NOP     0

PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:116  
      714     4633    2      IF D_U~=0 THEN DO;

   4633  1 001516   200030 235100                    LDA     DOM_USER,,AUTO
         1 001517   001535 600000 1                  TZE     s:4642

      715     4634                    /* First DEQ any monitor ENQs */
      716     4635    3         CALL QID_L WHENALTRETURN DO;

   4635  1 001520   002006 701000 1                  TSX1    QID_L
         1 001521   001523 702000 1                  TSX2    s:4636
         1 001522   001530 710000 1                  TRA     s:4640

      717     4636    4            CALL RNAME_L WHENALTRETURN DO;

   4636  1 001523   002044 701000 1                  TSX1    RNAME_L
         1 001524   001526 702000 1                  TSX2    s:4637
         1 001525   001530 710000 1                  TRA     s:4640

      718     4637    4               CALL DEQ_PROC;

   4637  1 001526   001624 701000 1                  TSX1    DEQ_PROC
         1 001527   000000 011000                    NOP     0

      719     4638    4               END;

      720     4639    3            END;

      721     4640    2         D_U=S_CUN+UQ$.DOMAIN#*512; /* Then only openers ones */

   4640  1 001530   200010 236100                    LDQ     UQ$+4,,AUTO
         1 001531   777777 376003                    ANQ     -1,DU
         1 001532   000011 772000                    QRL     9
         1 001533   000000 036000 xsym               ADLQ    S_CUN
         1 001534   200030 756100                    STQ     DOM_USER,,AUTO

      722     4641    2         END;

PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:117  
      723     4642    1      UQ$.RNAME$=ADDR(NIL);

   4642  1 001535   000001 236000 xsym               LDQ     B_VECTNIL+1
         1 001536   200005 756100                    STQ     UQ$+1,,AUTO

      724     4643    1      CALL QID_L ALTRET(DEQID);

   4643  1 001537   002006 701000 1                  TSX1    QID_L
         1 001540   001156 702000 1                  TSX2    DEQID

      725     4644    1      CALL UNLOCK;

   4644  1 001541   003157 701000 1                  TSX1    UNLOCK
         1 001542   000000 011000                    NOP     0

      726     4645    1      RETURN;

   4645  1 001543   000000 702200 xent               TSX2  ! X66_ARET

      727     4646    1   UQB$DELQIDX: ENTRY(ARG1) ALTRET;

   4646  1 001544   000000 700200 xent  UQB$DELQIDX  TSX0  ! X66_AUTO_1
         1 001545   000056 000001                    ZERO    46,1

      728     4647                    /* RELEASE LAST TIME..GET RID OF ALL ENTRIES    */
      729     4648    1      UQ$=MRNAME;

   4648  1 001546   000100 100400                    MLR     fill='000'O
         1 001547   000044 000030 0                  ADSC9   MRNAME                   cn=0,n=24
         1 001550   200004 000030                    ADSC9   UQ$,,AUTO                cn=0,n=24

      730     4649    1      UQ$.LENGTH=1; /* EVEN MONITOR RESERVED RESOURCE     */

   4649  1 001551   000001 235007                    LDA     1,DL
         1 001552   200006 755100                    STA     UQ$+2,,AUTO

      731     4650    1      UQ$.DOMAIN#=0; /* INDICATE DELQIDX                   */
PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:118  

   4650  1 001553   000000 220003                    LDX0    0,DU
         1 001554   200010 740100                    STX0    UQ$+4,,AUTO

      732     4651    1      D_U=0;   /* SET FLAG FOR DELQID                */

   4651  1 001555   200030 450100                    STZ     DOM_USER,,AUTO

      733     4652    1      GOTO DEQID0;

   4652  1 001556   001507 710000 1                  TRA     DEQID0

   4651  1 001557                       NOENQ        null
      734     4653        %EJECT;
PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:119  
      735     4654                    /* Altreturns */
      736     4655    1   NOENQ: ;    /* Hit the user ENQ limit. Release the RNAME entry. */
      737     4656    1      CALL RNAME_D;

   4656  1 001557   002244 701000 1                  TSX1    RNAME_D
         1 001560   000000 011000                    NOP     0

   4651  1 001561                       NOMEM        null
      738     4657    1   NOMEM: ;    /* Out of ENQ/DEQ table space (DS# full)   */
      739     4658    1      CALL UNLOCK;

   4658  1 001561   003157 701000 1                  TSX1    UNLOCK
         1 001562   000000 011000                    NOP     0

      740     4659    1      IF UQ$.DOMAIN#=1 THEN CALL SC_EQMEM; /* MONITOR NEVER ALTRETS              */

   4659  1 001563   200010 220100                    LDX0    UQ$+4,,AUTO
         1 001564   000001 100003                    CMPX0   1,DU
         1 001565   001570 601000 1                  TNZ     s:4665

   4659  1 001566   000000 713400 xsym               CLIMB   SC_EQMEM
         1 001567   000000 600000 xsid               climb   nvectors=         0

      741     4660                    /*S*    SCREECH_CODE: UQB-S$MMERR
      742     4661                    *       TYPE: SUA
      743     4662                    *       MESSAGE: File management needs more ENQ space.
      744     4663                    *                Check the TIGR ENQ command.
      745     4664                    */
      746     4665    1      ALTRETURN;

   4665  1 001570   000000 702200 xent               TSX2  ! X66_AALT

   4659  1 001571                       DLOCK        null
      747     4666    1   DLOCK: ;    /* Deadlock detected                  */
      748     4667    1      S$CU$->B$U.ENQ.WAIT=0;

   4667  1 001571   000000 220003                    LDX0    0,DU
PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:120  
         1 001572   000000 471400 xsym               LDP1    S$CU$
         1 001573   100016 440100                    SXL0    14,,PR1

      749     4668    1      QENTRY$->QENTRY.WAIT='0'B;

   4668  1 001574   200025 221100                    LDX1    QENTRY@,,AUTO
         1 001575   000004 236000 2                  LDQ     4
         1 001576   000000 356111                    ANSQ    0,X1,PR0

      750     4669    1      UQ$.DOMAIN#=0; /* DONT SCREECH FOR MONITOR DEADLOCK  */

   4669  1 001577   200010 740100                    STX0    UQ$+4,,AUTO

      751     4670    1      B$JIT.ERR=UQB$E$DLOCK;

   4670  1 001600   000106 236000 0                  LDQ     UQB$E$DLOCK
         1 001601   000000 471400 xsym               LDP1    B$JIT$
         1 001602   100012 756100                    STQ     10,,PR1

   4670  1 001603                       NODWN        null
      752     4671    1   NODWN:;
      753     4672    1      IF QENTRY$->QENTRY.UPGRADE THEN QENTRY$->QENTRY.UPGRADE='0'B;

   4672  1 001603   200025 220100                    LDX0    QENTRY@,,AUTO
         1 001604   000000 236110                    LDQ     0,X0,PR0
         1 001605   000007 316003                    CANQ    7,DU
         1 001606   001612 600000 1                  TZE     s:4673

   4672  1 001607   000002 236000 2                  LDQ     2
         1 001610   000000 356110                    ANSQ    0,X0,PR0
         1 001611   001614 710000 1                  TRA     s:4674

      754     4673    1      ELSE CALL QENTRY_DQ;

   4673  1 001612   002652 701000 1                  TSX1    QENTRY_DQ
         1 001613   000000 011000                    NOP     0

PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:121  
      755     4674    1      CALL UNLOCK;

   4674  1 001614   003157 701000 1                  TSX1    UNLOCK
         1 001615   000000 011000                    NOP     0

      756     4675    1      IF UQ$.DOMAIN#=1 THEN CALL SC_FSERR; /* MONITOR NEVER ALTRETS              */

   4675  1 001616   200010 220100                    LDX0    UQ$+4,,AUTO
         1 001617   000001 100003                    CMPX0   1,DU
         1 001620   001623 601000 1                  TNZ     s:4676

   4675  1 001621   000000 713400 xsym               CLIMB   SC_FSERR
         1 001622   000000 600000 xsid               climb   nvectors=         0

      757     4676    1      ALTRETURN;

   4676  1 001623   000000 702200 xent               TSX2  ! X66_AALT

      758     4677        %EJECT;
PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:122  
      759     4678                    /* Perform the DEQ processing, once an RNAME and a DOMAIN node have */
      760     4679                    /* been selected.                                                   */
      761     4680    1   DEQ_PROC: PROC ALTRET;

   4680  1 001624   200036 741300       DEQ_PROC     STX1  ! CRD+2,,AUTO

      762     4681                    /**/
      763     4682                    /* Then find the QENTRY which relates them */
      764     4683    2      CALL QENTRY_L;

   4683  1 001625   002330 701000 1                  TSX1    QENTRY_L
         1 001626   000000 011000                    NOP     0

      765     4684    2      IF QENTRY@ ~= U_NULL

   4684  1 001627   200025 220100                    LDX0    QENTRY@,,AUTO
         1 001630   001772 600000 1                  TZE     s:4728

      766     4685    3      THEN DO;

      767     4686    3         IF ADDR(QV)->FPT$DEQ_V.SELECTIVE AND ADDR(RNAME)=ADDR(NIL)

   4686  1 001631   200012 236100                    LDQ     QV,,AUTO
         1 001632   100000 316007                    CANQ    32768,DL
         1 001633   001646 600000 1                  TZE     DEQID
         1 001634   200005 236100                    LDQ     UQ$+1,,AUTO
         1 001635   000001 116000 xsym               CMPQ    B_VECTNIL+1
         1 001636   001646 601000 1                  TNZ     DEQID
         1 001637   000000 470400 xsym               LDP0    U_BASE
         1 001640   200013 236100                    LDQ     QV+1,,AUTO
         1 001641   000022 772000                    QRL     18
         1 001642   000003 116110                    CMPQ    3,X0,PR0
         1 001643   001646 600000 1                  TZE     DEQID

      768     4687    3           AND ADDR(QV)->FPT$DEQ_V.SELECT_ID~=QENTRY$->QENTRY.EVENT_ID
      769     4688    3         THEN RETURN;

PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:123  
   4688  1 001644   200036 221300                    LDX1  ! CRD+2,,AUTO
         1 001645   000001 702211                    TSX2  ! 1,X1

   4688  1 001646                       DEQID        null
      770     4689                    /* Get the decision table entry for this combination of allocation */
      771     4690                    /* status and DEQ options.                                         */
      772     4691    3   DEQID: ;
      773     4692    3         ERR=QENTRY$->QENTRY.STATE*2;

   4692  1 001646   000000 470400 xsym               LDP0    U_BASE
         1 001647   200025 220100                    LDX0    QENTRY@,,AUTO
         1 001650   000000 236110                    LDQ     0,X0,PR0
         1 001651   000027 772000                    QRL     23
         1 001652   000016 376007                    ANQ     14,DL
         1 001653   200033 756100                    STQ     ERR,,AUTO

      774     4693    3         IF QENTRY$->QENTRY.UPGRADE THEN ERR=5-ERR;

   4693  1 001654   000000 236110                    LDQ     0,X0,PR0
         1 001655   000007 316003                    CANQ    7,DU
         1 001656   001662 600000 1                  TZE     s:4694

   4693  1 001657   000005 235007                    LDA     5,DL
         1 001660   200033 135100                    SBLA    ERR,,AUTO
         1 001661   200033 755100                    STA     ERR,,AUTO

      775     4694    3         CRD=CRD_(3*ERR+UQ$.DEQ_COMMAND);

   4694  1 001662   200010 236100                    LDQ     UQ$+4,,AUTO
         1 001663   777777 376007                    ANQ     -1,DL
         1 001664   200042 756100                    STQ     PRE@+1,,AUTO
         1 001665   200033 236100                    LDQ     ERR,,AUTO
         1 001666   000003 402007                    MPY     3,DL
         1 001667   200042 036100                    ADLQ    PRE@+1,,AUTO
         1 001670   000000 236006 0                  LDQ     CRD_,QL
         1 001671   200034 756100                    STQ     CRD,,AUTO

PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:124  
      776     4695                    /* If the new allocation status from the decision table shows that */
      777     4696                    /* a valid transition can be made, then process it.                */
      778     4697    3         IF CRD.ALLOC<=5

   4697  1 001672   200034 236100                    LDQ     CRD,,AUTO
         1 001673   700000 376003                    ANQ     -32768,DU
         1 001674   600000 116003                    CMPQ    -65536,DU
         1 001675   001774 603000 1                  TRC     s:4729

      779     4698    4         THEN DO;

      780     4699    4            IF CRD.CANCEL_EVENT

   4699  1 001676   200034 236100                    LDQ     CRD,,AUTO
         1 001677   040000 316003                    CANQ    16384,DU
         1 001700   001722 600000 1                  TZE     s:4708

      781     4700    5            THEN DO;

      782     4701                    /* If a possible outstanding event should be cancelled, then do it.*/
      783     4702    5               CALL SSV$XXDO(QENTRY$->QENTRY.DOM_USER.USER,

   4702  1 001701   200025 236100                    LDQ     QENTRY@,,AUTO
         1 001702   777777 376003                    ANQ     -1,DU
         1 001703   000000 036000 xsym               ADLQ    U_BASE
         1 001704   200042 756100                    STQ     PRE@+1,,AUTO
         1 001705   200042 631500                    EPPR1   PRE@+1,,AUTO
         1 001706   200045 451500                    STP1    PRE@+4,,AUTO
         1 001707   000013 236000 2                  LDQ     11
         1 001710   200044 756100                    STQ     PRE@+3,,AUTO
         1 001711   200025 236100                    LDQ     QENTRY@,,AUTO
         1 001712   777777 376003                    ANQ     -1,DU
         1 001713   600000 036007                    ADLQ    -65536,DL
         1 001714   000000 036000 xsym               ADLQ    U_BASE
         1 001715   200043 756100                    STQ     PRE@+2,,AUTO
         1 001716   200043 630500                    EPPR0   PRE@+2,,AUTO
         1 001717   000021 631400 xsym               EPPR1   B_VECTNIL+17
PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:125  
         1 001720   000000 701000 xent               TSX1    SSV$XXDO
         1 001721   002000 702000 1                  TSX2    BOMB

      784     4703    5                 %EVSC_ENQ#,QENTRY$)
      785     4704    5                 ALTRET(BOMB);
      786     4705    5               END;

      787     4706                    /* If a message can be associated with the RNAME for the next user */
      788     4707                    /* to examine, and a message was specified, then pass it.          */
      789     4708    4            IF CRD.SEND_MESSAGE

   4708  1 001722   200034 236100                    LDQ     CRD,,AUTO
         1 001723   020000 316003                    CANQ    8192,DU
         1 001724   001735 600000 1                  TZE     s:4713

      790     4709    4            THEN IF UQ$.MESSAGE$~=ADDR(NIL)

   4709  1 001725   200011 236100                    LDQ     UQ$+5,,AUTO
         1 001726   000001 116000 xsym               CMPQ    B_VECTNIL+1
         1 001727   001735 600000 1                  TZE     s:4713

      791     4710    4               THEN RNAME1$->RNAME1.COMM=UQ$.MESSAGE$->MESSAGE;

   4710  1 001730   200011 470500                    LDP0    UQ$+5,,AUTO
         1 001731   000000 471400 xsym               LDP1    U_BASE
         1 001732   200021 220100                    LDX0    RNAME1@,,AUTO
         1 001733   000000 235100                    LDA     0,,PR0
         1 001734   100002 755110                    STA     2,X0,PR1

      792     4711                    /* If the new allocation status is null, then the QENTRY should be */
      793     4712                    /* deleted, otherwise it should be set to the new allocation status*/
      794     4713    4            IF CRD.ALLOC=0 THEN CALL QENTRY_DQ;

   4713  1 001735   200034 236100                    LDQ     CRD,,AUTO
         1 001736   700000 316003                    CANQ    -32768,DU
         1 001737   001743 601000 1                  TNZ     s:4715

PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:126  
   4713  1 001740   002652 701000 1                  TSX1    QENTRY_DQ
         1 001741   000000 011000                    NOP     0
         1 001742   001756 710000 1                  TRA     s:4719

      795     4714    5            ELSE DO;

      796     4715    5               QENTRY$->QENTRY.STATE=CRD.ALLOC/2;

   4715  1 001743   200034 236100                    LDQ     CRD,,AUTO
         1 001744   000041 772000                    QRL     33
         1 001745   000001 772000                    QRL     1
         1 001746   000000 470400 xsym               LDP0    U_BASE
         1 001747   200025 220100                    LDX0    QENTRY@,,AUTO
         1 001750   000030 736000                    QLS     24
         1 001751   000000 676110                    ERQ     0,X0,PR0
         1 001752   000700 376003                    ANQ     448,DU
         1 001753   000000 656110                    ERSQ    0,X0,PR0

      797     4716    5               QENTRY$->QENTRY.UPGRADE='0'B;

   4716  1 001754   000002 236000 2                  LDQ     2
         1 001755   000000 356110                    ANSQ    0,X0,PR0

      798     4717    5               END;

      799     4718                    /* See if we can allocate this RNAME to anybody else now. */
      800     4719    4            CALL ALLOCATE;

   4719  1 001756   002677 701000 1                  TSX1    ALLOCATE
         1 001757   000000 011000                    NOP     0

      801     4720                    /* If this is a release where we're supposed to delete all possible*/
      802     4721                    /* nodes, then do so.                                              */
      803     4722    4   DERNAME: IF UQ$.LENGTH~=0 AND RNAME1$->RNAME1.QCHAIN@=U_NULL

   4722  1 001760   200006 235100       DERNAME      LDA     UQ$+2,,AUTO
         1 001761   001770 600000 1                  TZE     s:4725
PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:127  
         1 001762   000000 470400 xsym               LDP0    U_BASE
         1 001763   200021 220100                    LDX0    RNAME1@,,AUTO
         1 001764   000001 221110                    LDX1    1,X0,PR0
         1 001765   001770 601000 1                  TNZ     s:4725

      804     4723                    /* If no other QENTRYs are hooked to this RNAME, delete it. */
      805     4724    4            THEN CALL RNAME_D;

   4724  1 001766   002244 701000 1                  TSX1    RNAME_D
         1 001767   000000 011000                    NOP     0

      806     4725    4            RETURN;

   4725  1 001770   200036 221300                    LDX1  ! CRD+2,,AUTO
         1 001771   000001 702211                    TSX2  ! 1,X1

      807     4726    4            END;
      808     4727    3         END;
      809     4728    2      ELSE IF D_U=0 THEN GOTO DERNAME;

   4728  1 001772   200030 235100                    LDA     DOM_USER,,AUTO
         1 001773   001760 600000 1                  TZE     DERNAME

      810     4729    2      ALTRETURN;

   4729  1 001774   200036 221300                    LDX1  ! CRD+2,,AUTO
         1 001775   000000 702211                    TSX2  ! 0,X1

      811     4730    2   DEQ_QID: ENTRY ALTRET;

   4730  1 001776   200036 741300       DEQ_QID      STX1  ! CRD+2,,AUTO

      812     4731    2      GOTO DEQID;

   4731  1 001777   001646 710000 1                  TRA     DEQID

   4727  1 002000                       BOMB         null
PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:128  
      813     4732    2   BOMB:;
      814     4733    2      CALL SC_EQERR_B;

   4733  1 002000   000000 713400 xsym               CLIMB   SC_EQERR_B
         1 002001   000000 600000 xsid               climb   nvectors=         0

      815     4734    2   END DEQ_PROC;

   4734  1 002002   200036 221300                    LDX1  ! CRD+2,,AUTO
         1 002003   000001 702211                    TSX2  ! 1,X1

      816     4735                    /**/
      817     4736        %EJECT;
PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:129  
      818     4737    1   LID_SUBROUTINES: PROC ALTRET;

   4737  1 002004   200040 741300       LID_SUBROUT* STX1  ! CRD+4,,AUTO
         1 002005   002007 710000 1                  TRA     s:4745

      819     4738    2   DCL PRE@ UBIN HALF;
      820     4739        %SUB PRE$="PINCRW(U_BASE$,PRE@)";
      821     4740                    /* Locate/Insert/Delete a specified QID (CFU) node                 */
      822     4741                    /* NOTE: The QID chains are kept in sorted, ascending order by     */
      823     4742                    /*       QNAME (CFU pointer) value.                                */
      824     4743    2   QID_L: ENTRY ALTRET;

   4743  1 002006   200040 741300       QID_L        STX1  ! CRD+4,,AUTO

      825     4744                    /* Get head of QID chain for that hashed CFU pointer value */
      826     4745    2      QID_PRE@=UQ$.QNAME.KEY-1/* 1=POFFW(ADDR(QID.HCHAIN@),ADDR(QID)) */;

   4745  1 002007   200004 236100                    LDQ     UQ$,,AUTO
         1 002010   000025 772000                    QRL     21
         1 002011   000037 376007                    ANQ     31,DL
         1 002012   777777 620006                    EAX0    -1,QL
         1 002013   200016 740100                    STX0    QID_PRE@,,AUTO

      827     4746    2      QID@=QID_PRE$->QID.HCHAIN@;

   4746  1 002014   000000 470400 xsym               LDP0    U_BASE
         1 002015   000001 222110                    LDX2    1,X0,PR0
         1 002016   200017 742100                    STX2    QID@,,AUTO

      828     4747                    /* Search the QID chain for this QNAME until we either find it or  */
      829     4748                    /* pass the position where it should have been.                    */
      830     4749    3      DO WHILE(QID@~=U_NULL);

   4749  1 002017   002042 600000 1                  TZE     s:4758

      831     4750    3         IF QID$->QID.NAME~=UQ$.QNAME

PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:130  
   4750  1 002020   000000 470400 xsym               LDP0    U_BASE
         1 002021   200017 220100                    LDX0    QID@,,AUTO
         1 002022   000003 236110                    LDQ     3,X0,PR0
         1 002023   200004 116100                    CMPQ    UQ$,,AUTO
         1 002024   002037 600000 1                  TZE     s:4756

      832     4751    3         THEN IF QID$->QID.NAME>UQ$.QNAME THEN QID@=U_NULL;

   4751  1 002025   200004 236100                    LDQ     UQ$,,AUTO
         1 002026   000003 116110                    CMPQ    3,X0,PR0
         1 002027   002033 603000 1                  TRC     s:4753

   4751  1 002030   000000 221003                    LDX1    0,DU
         1 002031   200017 741100                    STX1    QID@,,AUTO
         1 002032   002041 710000 1                  TRA     s:4757

      833     4752    4            ELSE DO;

      834     4753    4               QID_PRE@=QID@;

   4753  1 002033   200016 740100                    STX0    QID_PRE@,,AUTO

      835     4754    4               QID@=QID$->QID.HCHAIN@;

   4754  1 002034   000001 221110                    LDX1    1,X0,PR0
         1 002035   200017 741100                    STX1    QID@,,AUTO

      836     4755    4               END;

   4755  1 002036   002041 710000 1                  TRA     s:4757

      837     4756    3         ELSE ALTRETURN;

   4756  1 002037   200040 221300                    LDX1  ! CRD+4,,AUTO
         1 002040   000000 702211                    TSX2  ! 0,X1

      838     4757    3         END;
PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:131  

   4757  1 002041   002020 601000 1                  TNZ     s:4750

      839     4758    2      RETURN;

   4758  1 002042   200040 221300                    LDX1  ! CRD+4,,AUTO
         1 002043   000001 702211                    TSX2  ! 1,X1

      840     4759                    /* Process Locate & Insert requests... */
      841     4760        %EJECT;
PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:132  
      842     4761                    /* Locate/Insert a specified RNAME (resource element)              */
      843     4762                    /* NOTE:  The RNAME chains are kept in sorted, ascending order     */
      844     4763                    /*        based on the ASCII values and lengths of the resource    */
      845     4764                    /*        element names.                                           */
      846     4765    2   RNAME_L: ENTRY ALTRET;

   4765  1 002044   200040 741300       RNAME_L      STX1  ! CRD+4,,AUTO

      847     4766                    /**/
      848     4767                    /* Get offset to 1st RNAME node for this QID HASH */
      849     4768    2      RNAME_PRE@=U_NULL;

   4768  1 002045   000000 220003                    LDX0    0,DU
         1 002046   200020 740100                    STX0    RNAME_PRE@,,AUTO

      850     4769    2      RHASH_PRE@=QID@;

   4769  1 002047   200017 222100                    LDX2    QID@,,AUTO
         1 002050   200022 742100                    STX2    RHASH_PRE@,,AUTO

      851     4770    2      RHASH@=QID$->QID.XCHAIN@;

   4770  1 002051   000000 470400 xsym               LDP0    U_BASE
         1 002052   000000 723112                    LXL3    0,X2,PR0
         1 002053   200023 743100                    STX3    RHASH@,,AUTO

      852     4771    3      DO WHILE(RHASH@~=U_NULL);

   4771  1 002054   002240 600000 1                  TZE     RNAME_NO

      853     4772    3         ERR=RHASH$->RNAME1.RHASH-UQ$.RHASH;

   4772  1 002055   000000 470400 xsym               LDP0    U_BASE
         1 002056   200023 220100                    LDX0    RHASH@,,AUTO
         1 002057   000000 236110                    LDQ     0,X0,PR0
         1 002060   000022 772000                    QRL     18
         1 002061   000077 376007                    ANQ     63,DL
PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:133  
         1 002062   200007 136100                    SBLQ    UQ$+3,,AUTO
         1 002063   200033 756100                    STQ     ERR,,AUTO

      854     4773    3         IF ERR>0 THEN RHASH@=U_NULL;

   4773  1 002064   002070 604400 1                  TMOZ    s:4774

   4773  1 002065   000000 221003                    LDX1    0,DU
         1 002066   200023 741100                    STX1    RHASH@,,AUTO
         1 002067   002237 710000 1                  TRA     s:4819

      855     4774    4         ELSE IF ERR<0 THEN DO;

   4774  1 002070   002075 605000 1                  TPL     s:4781

      856     4775    4               RHASH_PRE@=RHASH@;

   4775  1 002071   200022 740100                    STX0    RHASH_PRE@,,AUTO

      857     4776    4               RHASH@=RHASH$->RNAME1.XCHAIN@;

   4776  1 002072   000000 721110                    LXL1    0,X0,PR0
         1 002073   200023 741100                    STX1    RHASH@,,AUTO

      858     4777    4               END;

   4777  1 002074   002237 710000 1                  TRA     s:4819

      859     4778    4            ELSE DO;

      860     4779                    /* Search the RNAME chain for the specified resource until we      */
      861     4780                    /* either find it or pass the position where it should have been.  */
      862     4781    4               RNAME1@=RHASH@;

   4781  1 002075   200021 740100                    STX0    RNAME1@,,AUTO

      863     4782    5               DO WHILE(RNAME1@~=U_NULL);
PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:134  

   4782  1 002076   000000 100003                    CMPX0   0,DU
         1 002077   002235 600000 1                  TZE     s:4817

      864     4783    5                  PRE@=RNAME1$->RNAME1.NCHAIN@;

   4783  1 002100   000000 470400 xsym               LDP0    U_BASE
         1 002101   200021 220100                    LDX0    RNAME1@,,AUTO
         1 002102   000003 721110                    LXL1    3,X0,PR0
         1 002103   200041 741100                    STX1    PRE@,,AUTO

      865     4784    5                  IF PRE@=U_NULL THEN IF UQ$.LENGTH=0 THEN ALTRETURN;

   4784  1 002104   002111 601000 1                  TNZ     s:4787

   4784  1 002105   200006 235100                    LDA     UQ$+2,,AUTO
         1 002106   002230 601000 1                  TNZ     RNAME_NXT

   4784  1 002107   200040 221300                    LDX1  ! CRD+4,,AUTO
         1 002110   000000 702211                    TSX2  ! 0,X1

      866     4785    5                     ELSE GOTO RNAME_NXT;
      867     4786                    /* Compare the specified resource element name w/ this node's text */
      868     4787    5                  ELSE IF UQ$.LENGTH~=PRE$->RNAME2.COUNT THEN

   4787  1 002111   000000 236111                    LDQ     0,X1,PR0
         1 002112   000022 772000                    QRL     18
         1 002113   000777 376007                    ANQ     511,DL
         1 002114   200006 116100                    CMPQ    UQ$+2,,AUTO
         1 002115   002120 600000 1                  TZE     s:4790

      869     4788    5                        IF UQ$.LENGTH<PRE$->RNAME2.COUNT THEN GOTO RNAME_NO;

   4788  1 002116   002240 605400 1                  TPNZ    RNAME_NO

      870     4789    5                        ELSE GOTO RNAME_NXT;

PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:135  
   4789  1 002117   002230 710000 1                  TRA     RNAME_NXT

      871     4790    5                     ELSE IF UQ$.LENGTH<=12 THEN

   4790  1 002120   200006 235100                    LDA     UQ$+2,,AUTO
         1 002121   000014 115007                    CMPA    12,DL
         1 002122   002140 605400 1                  TPNZ    s:4795

      872     4791    5                           IF RNAME.TEXT~=PRE$->RNAME2.TEXT

   4791  1 002123   200041 235100                    LDA     PRE@,,AUTO
         1 002124   777777 375003                    ANA     -1,DU
         1 002125   000020 771000                    ARL     16
         1 002126   200005 471500                    LDP1    UQ$+1,,AUTO
         1 002127   200006 722100                    LXL2    UQ$+2,,AUTO
         1 002130   040105 106540                    CMPC    fill='040'O
         1 002131   100000 200012                    ADSC9   0,,PR1                   cn=1,n=*X2
         1 002132   000000 400014                    ADSC9   0,A,PR0                  cn=2,n=12
         1 002133   002136 600000 1                  TZE     s:4794

      873     4792    5                           THEN IF RNAME.TEXT<PRE$->RNAME2.TEXT THEN GOTO RNAME_NO;

   4792  1 002134   002240 602000 1                  TNC     RNAME_NO

      874     4793    5                              ELSE GOTO RNAME_NXT;

   4793  1 002135   002230 710000 1                  TRA     RNAME_NXT

      875     4794    5                           ELSE ALTRETURN;

   4794  1 002136   200040 221300                    LDX1  ! CRD+4,,AUTO
         1 002137   000000 702211                    TSX2  ! 0,X1

      876     4795    5                        ELSE IF SUBSTR(RNAME.TEXT,0,12)<=PRE$->RNAME2.TEXT

   4795  1 002140   200041 235100                    LDA     PRE@,,AUTO
         1 002141   777777 375003                    ANA     -1,DU
PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:136  
         1 002142   000020 771000                    ARL     16
         1 002143   200005 471500                    LDP1    UQ$+1,,AUTO
         1 002144   040100 106505                    CMPC    fill='040'O
         1 002145   000000 400014                    ADSC9   0,A,PR0                  cn=2,n=12
         1 002146   100000 200014                    ADSC9   0,,PR1                   cn=1,n=12
         1 002147   002230 602000 1                  TNC     RNAME_NXT

      877     4796    6                           THEN IF SUBSTR(RNAME.TEXT,0,12)=PRE$->RNAME2.TEXT THEN DO;

   4796  1 002150   002240 601000 1                  TNZ     RNAME_NO

      878     4797    6                                 PRE@=PRE$->RNAME2.NCHAIN@;

   4797  1 002151   000003 722111                    LXL2    3,X1,PR0
         1 002152   200041 742100                    STX2    PRE@,,AUTO

      879     4798    6                                 ERR=12;

   4798  1 002153   000014 235007                    LDA     12,DL
         1 002154   200033 755100                    STA     ERR,,AUTO

      880     4799    7                                 DO WHILE(ERR+13<UQ$.LENGTH);

   4799  1 002155   002177 710000 1                  TRA     s:4806

      881     4800    7                                    IF PRE$->RNAME3.TEXT~=SUBSTR(RNAME.TEXT,ERR,13)

   4800  1 002156   200041 235100                    LDA     PRE@,,AUTO
         1 002157   777777 375003                    ANA     -1,DU
         1 002160   000020 771000                    ARL     16
         1 002161   000000 470400 xsym               LDP0    U_BASE
         1 002162   200005 471500                    LDP1    UQ$+1,,AUTO
         1 002163   200033 236100                    LDQ     ERR,,AUTO
         1 002164   040106 106505                    CMPC    fill='040'O
         1 002165   000000 200015                    ADSC9   0,A,PR0                  cn=1,n=13
         1 002166   100000 200015                    ADSC9   0,Q,PR1                  cn=1,n=13
         1 002167   002172 600000 1                  TZE     s:4804
PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:137  

      882     4801    7                                   THEN IF SUBSTR(RNAME.TEXT,ERR,13)>PRE$->RNAME3.TEXT

   4801  1 002170   002230 602000 1                  TNC     RNAME_NXT

      883     4802    7                                       THEN GOTO RNAME_NXT;
      884     4803    7                                       ELSE GOTO RNAME_NO;

   4803  1 002171   002240 710000 1                  TRA     RNAME_NO

      885     4804    7                                    ERR=ERR+13;

   4804  1 002172   000015 236007                    LDQ     13,DL
         1 002173   200033 056100                    ASQ     ERR,,AUTO

      886     4805    7                                    PRE@=PRE$->RNAME3.NCHAIN@;

   4805  1 002174   200041 220100                    LDX0    PRE@,,AUTO
         1 002175   000003 721110                    LXL1    3,X0,PR0
         1 002176   200041 741100                    STX1    PRE@,,AUTO

      887     4806    7                                    END;

   4806  1 002177   200033 236100                    LDQ     ERR,,AUTO
         1 002200   000015 036007                    ADLQ    13,DL
         1 002201   200006 116100                    CMPQ    UQ$+2,,AUTO
         1 002202   002156 604000 1                  TMI     s:4800

      888     4807    6                                 IF SUBSTR(RNAME.TEXT,ERR)<=PRE$->RNAME3.TEXT

   4807  1 002203   200006 236100                    LDQ     UQ$+2,,AUTO
         1 002204   200033 136100                    SBLQ    ERR,,AUTO
         1 002205   200041 235100                    LDA     PRE@,,AUTO
         1 002206   777777 375003                    ANA     -1,DU
         1 002207   000020 771000                    ARL     16
         1 002210   000000 620006                    EAX0    0,QL
         1 002211   200033 236100                    LDQ     ERR,,AUTO
PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:138  
         1 002212   040146 106505                    CMPC    fill='040'O
         1 002213   000000 200015                    ADSC9   0,A,PR0                  cn=1,n=13
         1 002214   100000 200010                    ADSC9   0,Q,PR1                  cn=1,n=*X0
         1 002215   002230 602000 1                  TNC     RNAME_NXT

      889     4808    6                                 THEN IF SUBSTR(RNAME.TEXT,ERR)=PRE$->RNAME3.TEXT

   4808  1 002216   200006 236100                    LDQ     UQ$+2,,AUTO
         1 002217   200033 136100                    SBLQ    ERR,,AUTO
         1 002220   000000 620006                    EAX0    0,QL
         1 002221   200033 236100                    LDQ     ERR,,AUTO
         1 002222   040105 106546                    CMPC    fill='040'O
         1 002223   100000 200010                    ADSC9   0,Q,PR1                  cn=1,n=*X0
         1 002224   000000 200015                    ADSC9   0,A,PR0                  cn=1,n=13
         1 002225   002240 601000 1                  TNZ     RNAME_NO

      890     4809    6                                    THEN ALTRETURN;

   4809  1 002226   200040 221300                    LDX1  ! CRD+4,,AUTO
         1 002227   000000 702211                    TSX2  ! 0,X1

      891     4810    6                                    ELSE GOTO RNAME_NO;

   4810  1 002230                       RNAME_NXT    null
      892     4811    6                                 END;
      893     4812    5                              ELSE GOTO RNAME_NO;
      894     4813    5   RNAME_NXT:     ;
      895     4814    5                  RNAME_PRE@=RNAME1@;

   4814  1 002230   200021 220100                    LDX0    RNAME1@,,AUTO
         1 002231   200020 740100                    STX0    RNAME_PRE@,,AUTO

      896     4815    5                  RNAME1@=RNAME1$->RNAME1.RCHAIN@;

   4815  1 002232   000001 721110                    LXL1    1,X0,PR0
         1 002233   200021 741100                    STX1    RNAME1@,,AUTO

PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:139  
      897     4816    5                  END;

   4816  1 002234   002100 601000 1                  TNZ     s:4783

      898     4817    4               RETURN;

   4817  1 002235   200040 221300                    LDX1  ! CRD+4,,AUTO
         1 002236   000001 702211                    TSX2  ! 1,X1

      899     4818    4               END;
      900     4819    3         END;

   4819  1 002237   002055 601000 1                  TNZ     s:4772

   4815  1 002240                       RNAME_NO     null
      901     4820    2   RNAME_NO:;
      902     4821    2      RNAME1@=U_NULL;

   4821  1 002240   000000 220003                    LDX0    0,DU
         1 002241   200021 740100                    STX0    RNAME1@,,AUTO

      903     4822    2      RETURN;

   4822  1 002242   200040 221300                    LDX1  ! CRD+4,,AUTO
         1 002243   000001 702211                    TSX2  ! 1,X1

      904     4823                    /**/
      905     4824        %EJECT;
PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:140  
      906     4825    2   RNAME_D: ENTRY ALTRET;

   4825  1 002244   200040 741300       RNAME_D      STX1  ! CRD+4,,AUTO

      907     4826                  /* Delete the resource name entry at RNAME$, predecessor at RNAME_PRE$ */
      908     4827                    /* Save link to RNAME2 & RNAME3 node list */
      909     4828    2      IF RNAME1@~=RHASH@ THEN RNAME_PRE$->RNAME1.RCHAIN@=RNAME1$->RNAME1.RCHAIN@;

   4828  1 002245   200021 220100                    LDX0    RNAME1@,,AUTO
         1 002246   200023 100100                    CMPX0   RHASH@,,AUTO
         1 002247   002255 600000 1                  TZE     s:4829

   4828  1 002250   000000 470400 xsym               LDP0    U_BASE
         1 002251   000001 722110                    LXL2    1,X0,PR0
         1 002252   200020 223100                    LDX3    RNAME_PRE@,,AUTO
         1 002253   000001 442113                    SXL2    1,X3,PR0
         1 002254   002273 710000 1                  TRA     s:4840

      910     4829    2      ELSE IF RNAME1$->RNAME1.RCHAIN@=U_NULL

   4829  1 002255   000000 470400 xsym               LDP0    U_BASE
         1 002256   000001 722110                    LXL2    1,X0,PR0
         1 002257   002266 601000 1                  TNZ     s:4835

      911     4830    3         THEN DO;

      912     4831    3            RHASH_PRE$->RNAME1.XCHAIN@=RNAME1$->RNAME1.XCHAIN@;

   4831  1 002260   000000 723110                    LXL3    0,X0,PR0
         1 002261   200022 224100                    LDX4    RHASH_PRE@,,AUTO
         1 002262   000000 443114                    SXL3    0,X4,PR0

      913     4832    3            RHASH@=U_NULL;

   4832  1 002263   000000 221003                    LDX1    0,DU
         1 002264   200023 741100                    STX1    RHASH@,,AUTO

PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:141  
      914     4833    3            END;

   4833  1 002265   002273 710000 1                  TRA     s:4840

      915     4834    3         ELSE DO;

      916     4835    3            RHASH@=RNAME1$->RNAME1.RCHAIN@;

   4835  1 002266   200023 742100                    STX2    RHASH@,,AUTO

      917     4836    3            RHASH_PRE$->RNAME1.XCHAIN@=RHASH@;

   4836  1 002267   200022 223100                    LDX3    RHASH_PRE@,,AUTO
         1 002270   000000 442113                    SXL2    0,X3,PR0

      918     4837    3            RHASH$->RNAME1.XCHAIN@=RNAME1$->RNAME1.XCHAIN@;

   4837  1 002271   000000 721110                    LXL1    0,X0,PR0
         1 002272   000000 441112                    SXL1    0,X2,PR0

      919     4838    3            END;

      920     4839                    /* Free all RNAME nodes linked to deleted node */
      921     4840    3      DO WHILE(RNAME1@~=U_NULL);

   4840  1 002273   000000 100003                    CMPX0   0,DU
         1 002274   002311 600000 1                  TZE     s:4850

      922     4841    3         NODE@=RNAME1@;

   4841  1 002275   200021 220100                    LDX0    RNAME1@,,AUTO
         1 002276   200026 740100                    STX0    NODE@,,AUTO

      923     4842    3         RNAME1@=NODE$->NNODE.NCHAIN@;

   4842  1 002277   000000 470400 xsym               LDP0    U_BASE
         1 002300   000003 721110                    LXL1    3,X0,PR0
PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:142  
         1 002301   200021 741100                    STX1    RNAME1@,,AUTO

      924     4843              %FREENODE(NODE=NODE@);

   4844  1 002302   000000 450110                    STZ     0,X0,PR0

   4845  1 002303   000043 722100                    LXL2    35,,PR0
         1 002304   000003 442110                    SXL2    3,X0,PR0

   4846  1 002305   000043 440100                    SXL0    35,,PR0

   4847  1 002306   000042 054100                    AOS     34,,PR0

      925     4849    3         END;

   4849  1 002307   000000 101003                    CMPX1   0,DU
         1 002310   002275 601000 1                  TNZ     s:4841

      926     4850    2      RNAME1@ = RNAME_PRE@;

   4850  1 002311   200020 220100                    LDX0    RNAME_PRE@,,AUTO
         1 002312   200021 740100                    STX0    RNAME1@,,AUTO

      927     4851                    /* If no other RNAMEs are hooked to this QID, delete it too. */
      928     4852    2      IF QID$->QID.XCHAIN@=U_NULL

   4852  1 002313   200017 221100                    LDX1    QID@,,AUTO
         1 002314   000000 722111                    LXL2    0,X1,PR0
         1 002315   002326 601000 1                  TNZ     s:4862

      929     4853    3      THEN DO;

      930     4854    3         QID_PRE$->QID.HCHAIN@=QID$->QID.HCHAIN@;

   4854  1 002316   000001 223111                    LDX3    1,X1,PR0
         1 002317   200016 224100                    LDX4    QID_PRE@,,AUTO
         1 002320   000001 743114                    STX3    1,X4,PR0
PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:143  

      931     4855              %FREENODE(NODE=QID@);

   4856  1 002321   000000 450111                    STZ     0,X1,PR0

   4857  1 002322   000043 722100                    LXL2    35,,PR0
         1 002323   000003 442111                    SXL2    3,X1,PR0

   4858  1 002324   000043 441100                    SXL1    35,,PR0

   4859  1 002325   000042 054100                    AOS     34,,PR0

      932     4861    3         END;

      933     4862    2      RETURN;

   4862  1 002326   200040 221300                    LDX1  ! CRD+4,,AUTO
         1 002327   000001 702211                    TSX2  ! 1,X1

      934     4863        %EJECT;
PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:144  
      935     4864                    /* Locate/Insert a QENTRY attribute node for the given DOMAIN/     */
      936     4865                    /* RNAME combination.                                              */
      937     4866                    /* Note that PRE$ will be set to the predecessor of the QENTRY     */
      938     4867                    /* on the QCHAIN (resource name link).                             */
      939     4868    2   QENTRY_L: ENTRY ALTRET;

   4868  1 002330   200040 741300       QENTRY_L     STX1  ! CRD+4,,AUTO

      940     4869                    /* Init predecessor pointer to point at RNAME node */
      941     4870    2      QENTRY_PRE@=RNAME1@;

   4870  1 002331   200021 220100                    LDX0    RNAME1@,,AUTO
         1 002332   200024 740100                    STX0    QENTRY_PRE@,,AUTO

      942     4871                    /* Get link from RNAME to QENTRY */
      943     4872    2      QENTRY@=RNAME1$->RNAME1.QCHAIN@;

   4872  1 002333   000000 470400 xsym               LDP0    U_BASE
         1 002334   000001 222110                    LDX2    1,X0,PR0
         1 002335   200025 742100                    STX2    QENTRY@,,AUTO

      944     4873                    /* Examine QENTRYs until we find one pointing at the right DOMAIN  */
      945     4874                    /* block or we run out of QENTRYs for this RNAME.                  */
      946     4875    3      DO WHILE(QENTRY@~=U_NULL);

   4875  1 002336   002366 600000 1                  TZE     s:4891

      947     4876    3         IF QENTRY$->QENTRY.D_U=D_U THEN RETURN;

   4876  1 002337   000000 470400 xsym               LDP0    U_BASE
         1 002340   200025 220100                    LDX0    QENTRY@,,AUTO
         1 002341   000000 236110                    LDQ     0,X0,PR0
         1 002342   007777 376007                    ANQ     4095,DL
         1 002343   200030 116100                    CMPQ    DOM_USER,,AUTO
         1 002344   002347 601000 1                  TNZ     s:4877

   4876  1 002345   200040 221300                    LDX1  ! CRD+4,,AUTO
PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:145  
         1 002346   000001 702211                    TSX2  ! 1,X1

      948     4877    3         IF QENTRY$->QENTRY.DOM_USER.USER=S_CUN

   4877  1 002347   000000 236110                    LDQ     0,X0,PR0
         1 002350   000777 376007                    ANQ     511,DL
         1 002351   000000 116000 xsym               CMPQ    S_CUN
         1 002352   002362 601000 1                  TNZ     s:4888

      949     4878    4         THEN DO;

      950     4879                    /* If the QENTRY associates the RNAME with a domain of the user    */
      951     4880                    /* other than the specified one, then return an error.             */
      952     4881    4            B$JIT.ERR=UQB$E$PDOMAIN;

   4881  1 002353   000104 236000 0                  LDQ     UQB$E$PDOMAIN
         1 002354   000000 471400 xsym               LDP1    B$JIT$
         1 002355   100012 756100                    STQ     10,,PR1

      953     4882                    /*E*   ERROR:  UQB-E$PDOMAIN-2                                    */
      954     4883                    /*E*   MESSAGE: ENQ/DEQ user domain conflict.                      */
      955     4884            /*,*  MESSAGE1: A resource has been ENQued by a different domain of the user */
      956     4885    4            QENTRY@=U_NULL;

   4885  1 002356   000000 221003                    LDX1    0,DU
         1 002357   200025 741100                    STX1    QENTRY@,,AUTO

      957     4886    4            ALTRETURN;

   4886  1 002360   200040 221300                    LDX1  ! CRD+4,,AUTO
         1 002361   000000 702211                    TSX2  ! 0,X1

      958     4887    4            END;
      959     4888    3         QENTRY_PRE@=QENTRY@;

   4888  1 002362   200024 740100                    STX0    QENTRY_PRE@,,AUTO

PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:146  
      960     4889    3         QENTRY@=QENTRY$->QENTRY.QCHAIN@;

   4889  1 002363   000001 221110                    LDX1    1,X0,PR0
         1 002364   200025 741100                    STX1    QENTRY@,,AUTO

      961     4890    3         END;

   4890  1 002365   002337 601000 1                  TNZ     s:4876

      962     4891    2      RETURN;

   4891  1 002366   200040 221300                    LDX1  ! CRD+4,,AUTO
         1 002367   000001 702211                    TSX2  ! 1,X1

      963     4892                    /**/
      964     4893        %EJECT;
PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:147  
      965     4894    2   QID_I: ENTRY ALTRET;

   4894  1 002370   200040 741300       QID_I        STX1  ! CRD+4,,AUTO

      966     4895                    /* Add a new QID, RNAME, and QENTRY node. */
      967     4896           %GETNODE(NODE=QID@);

   4897  1 002371   000000 470400 xsym               LDP0    U_BASE
         1 002372   000001 336007                    LCQ     1,DL
         1 002373   000042 056100                    ASQ     34,,PR0

   4898  1 002374   000043 720100                    LXL0    35,,PR0
         1 002375   200017 740100                    STX0    QID@,,AUTO

   4899  1 002376   000003 722110                    LXL2    3,X0,PR0
         1 002377   000043 442100                    SXL2    35,,PR0

      968     4901    2      QID$->QID=U_QID_INIT;

   4901  1 002400   200017 235100                    LDA     QID@,,AUTO
         1 002401   777777 375003                    ANA     -1,DU
         1 002402   000020 771000                    ARL     16
         1 002403   000105 100400                    MLR     fill='000'O
         1 002404   000000 000004 xsym               ADSC9   U_QID_INIT               cn=0,n=4
         1 002405   000000 000020                    ADSC9   0,A,PR0                  cn=0,n=16

      969     4902    2      QID$->QID.NAME=UQ$.QNAME;

   4902  1 002406   200004 236100                    LDQ     UQ$,,AUTO
         1 002407   000003 756110                    STQ     3,X0,PR0

      970     4903    2      QID$->QID.HCHAIN@=QID_PRE$->QID.HCHAIN@;

   4903  1 002410   200016 221100                    LDX1    QID_PRE@,,AUTO
         1 002411   000001 222111                    LDX2    1,X1,PR0
         1 002412   000001 742110                    STX2    1,X0,PR0

PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:148  
      971     4904    2      QID_PRE$->QID.HCHAIN@=QID@;

   4904  1 002413   000001 740111                    STX0    1,X1,PR0

      972     4905    2      RHASH_PRE@=QID@;

   4905  1 002414   200022 740100                    STX0    RHASH_PRE@,,AUTO

      973     4906    2      RNAME_PRE@=U_NULL;

   4906  1 002415   000000 222003                    LDX2    0,DU
         1 002416   200020 742100                    STX2    RNAME_PRE@,,AUTO

      974     4907    2      RHASH@=U_NULL;

   4907  1 002417   200023 742100                    STX2    RHASH@,,AUTO
         1 002420   002422 710000 1                  TRA     s:4914

      975     4908                    /* Drop into RNAME_I code */
      976     4909        %EJECT;
PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:149  
      977     4910    2   RNAME_I: ENTRY ALTRET;

   4910  1 002421   200040 741300       RNAME_I      STX1  ! CRD+4,,AUTO

      978     4911                    /**/
      979     4912                    /* Add a new RNAME and QENTRY node. */
      980     4913           %GETNODE(NODE=RNAME1@);

   4914  1 002422   000000 470400 xsym               LDP0    U_BASE
         1 002423   000001 336007                    LCQ     1,DL
         1 002424   000042 056100                    ASQ     34,,PR0

   4915  1 002425   000043 720100                    LXL0    35,,PR0
         1 002426   200021 740100                    STX0    RNAME1@,,AUTO

   4916  1 002427   000003 721110                    LXL1    3,X0,PR0
         1 002430   000043 441100                    SXL1    35,,PR0

      981     4918    2      RNAME1$->RNAME1=U_RNAME1_INIT;

   4918  1 002431   200021 235100                    LDA     RNAME1@,,AUTO
         1 002432   777777 375003                    ANA     -1,DU
         1 002433   000020 771000                    ARL     16
         1 002434   000105 100400                    MLR     fill='000'O
         1 002435   000000 000004 xsym               ADSC9   U_RNAME1_INIT            cn=0,n=4
         1 002436   000000 000020                    ADSC9   0,A,PR0                  cn=0,n=16

      982     4919    2      RNAME1$->RNAME1.RHASH=UQ$.RHASH;

   4919  1 002437   200007 236100                    LDQ     UQ$+3,,AUTO
         1 002440   000022 736000                    QLS     18
         1 002441   000000 676110                    ERQ     0,X0,PR0
         1 002442   000077 376003                    ANQ     63,DU
         1 002443   000000 656110                    ERSQ    0,X0,PR0

      983     4920    3      IF RNAME_PRE@~=U_NULL THEN DO; /* NOT FIRST IN HASH GROUP            */

PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:150  
   4920  1 002444   200020 221100                    LDX1    RNAME_PRE@,,AUTO
         1 002445   002452 600000 1                  TZE     s:4925

      984     4921    3         RNAME1$->RNAME1.RCHAIN@=RNAME_PRE$->RNAME1.RCHAIN@;

   4921  1 002446   000001 722111                    LXL2    1,X1,PR0
         1 002447   000001 442110                    SXL2    1,X0,PR0

      985     4922    3         RNAME_PRE$->RNAME1.RCHAIN@=RNAME1@;

   4922  1 002450   000001 440111                    SXL0    1,X1,PR0

      986     4923    3         END;

   4923  1 002451   002467 710000 1                  TRA     s:4936

      987     4924    3      ELSE DO;

      988     4925    4         IF RHASH@=U_NULL THEN DO;

   4925  1 002452   200023 222100                    LDX2    RHASH@,,AUTO
         1 002453   002461 601000 1                  TNZ     s:4930

      989     4926    4            RNAME1$->RNAME1.XCHAIN@=RHASH_PRE$->RNAME1.XCHAIN@;

   4926  1 002454   200022 223100                    LDX3    RHASH_PRE@,,AUTO
         1 002455   000000 724113                    LXL4    0,X3,PR0
         1 002456   000000 444110                    SXL4    0,X0,PR0

      990     4927    4            RHASH_PRE$->RNAME1.XCHAIN@=RNAME1@;

   4927  1 002457   000000 440113                    SXL0    0,X3,PR0

      991     4928    4            END;

   4928  1 002460   002466 710000 1                  TRA     s:4934

PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:151  
      992     4929    4         ELSE DO;

      993     4930    4            RNAME1$->RNAME1.RCHAIN@=RHASH@;

   4930  1 002461   000001 442110                    SXL2    1,X0,PR0

      994     4931    4            RNAME1$->RNAME1.XCHAIN@=RHASH$->RNAME1.XCHAIN@;

   4931  1 002462   000000 723112                    LXL3    0,X2,PR0
         1 002463   000000 443110                    SXL3    0,X0,PR0

      995     4932    4            RHASH_PRE$->RNAME1.XCHAIN@=RNAME1@;

   4932  1 002464   200022 224100                    LDX4    RHASH_PRE@,,AUTO
         1 002465   000000 440114                    SXL0    0,X4,PR0

      996     4933    4            END;

      997     4934    3         RHASH@=RNAME1@;

   4934  1 002466   200023 740100                    STX0    RHASH@,,AUTO

      998     4935    3         END;

      999     4936    2      RNAME1$->RNAME1.RHEAD@=QID@;

   4936  1 002467   200017 222100                    LDX2    QID@,,AUTO
         1 002470   000003 742110                    STX2    3,X0,PR0

     1000     4937    3      IF UQ$.LENGTH~=0 THEN DO;

   4937  1 002471   200006 236100                    LDQ     UQ$+2,,AUTO
         1 002472   002565 600000 1                  TZE     s:4962

     1001     4938              %GETNODE(NODE=NODE@);

   4939  1 002473   000001 336007                    LCQ     1,DL
PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:152  
         1 002474   000042 056100                    ASQ     34,,PR0

   4940  1 002475   000043 723100                    LXL3    35,,PR0
         1 002476   200026 743100                    STX3    NODE@,,AUTO

   4941  1 002477   000003 724113                    LXL4    3,X3,PR0
         1 002500   000043 444100                    SXL4    35,,PR0

     1002     4943    3         NODE$->AVAIL.TYPE=BINBIT(RNAME2_TYPE,9);

   4943  1 002501   041000 236003                    LDQ     16896,DU
         1 002502   000000 756113                    STQ     0,X3,PR0

     1003     4944    3         NODE$->RNAME2.COUNT=UQ$.LENGTH;

   4944  1 002503   200006 236100                    LDQ     UQ$+2,,AUTO
         1 002504   000022 736000                    QLS     18
         1 002505   000000 676113                    ERQ     0,X3,PR0
         1 002506   000777 376003                    ANQ     511,DU
         1 002507   000000 656113                    ERSQ    0,X3,PR0

     1004     4945    3         NODE$->RNAME2.TEXT=RNAME.TEXT;

   4945  1 002510   200026 236100                    LDQ     NODE@,,AUTO
         1 002511   777777 376003                    ANQ     -1,DU
         1 002512   000020 772000                    QRL     16
         1 002513   200005 471500                    LDP1    UQ$+1,,AUTO
         1 002514   200006 724100                    LXL4    UQ$+2,,AUTO
         1 002515   040106 100540                    MLR     fill='040'O
         1 002516   100000 200014                    ADSC9   0,,PR1                   cn=1,n=*X4
         1 002517   000000 400014                    ADSC9   0,Q,PR0                  cn=2,n=12

     1005     4946    3         RNAME1$->RNAME1.NCHAIN@=NODE@;

   4946  1 002520   000003 443110                    SXL3    3,X0,PR0

     1006     4947    3         ERR=12;
PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:153  

   4947  1 002521   000014 235007                    LDA     12,DL
         1 002522   200033 755100                    STA     ERR,,AUTO

     1007     4948    4         DO WHILE(ERR<UQ$.LENGTH);

   4948  1 002523   200033 236100                    LDQ     ERR,,AUTO
         1 002524   200006 116100                    CMPQ    UQ$+2,,AUTO
         1 002525   002562 605000 1                  TPL     s:4960

     1008     4949    4            PRE@=NODE@;

   4949  1 002526   200026 220100                    LDX0    NODE@,,AUTO
         1 002527   200041 740100                    STX0    PRE@,,AUTO

     1009     4950                 %GETNODE(NODE=NODE@);

   4951  1 002530   000000 470400 xsym               LDP0    U_BASE
         1 002531   000001 336007                    LCQ     1,DL
         1 002532   000042 056100                    ASQ     34,,PR0

   4952  1 002533   000043 721100                    LXL1    35,,PR0
         1 002534   200026 741100                    STX1    NODE@,,AUTO

   4953  1 002535   000003 722111                    LXL2    3,X1,PR0
         1 002536   000043 442100                    SXL2    35,,PR0

     1010     4955    4            NODE$->AVAIL.TYPE=BINBIT(RNAME3_TYPE,9);

   4955  1 002537   042000 236003                    LDQ     17408,DU
         1 002540   000000 756111                    STQ     0,X1,PR0

     1011     4956    4            NODE$->RNAME3.TEXT=SUBSTR(RNAME.TEXT,ERR);

   4956  1 002541   200006 236100                    LDQ     UQ$+2,,AUTO
         1 002542   200033 136100                    SBLQ    ERR,,AUTO
         1 002543   200026 235100                    LDA     NODE@,,AUTO
PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:154  
         1 002544   777777 375003                    ANA     -1,DU
         1 002545   000020 771000                    ARL     16
         1 002546   200005 471500                    LDP1    UQ$+1,,AUTO
         1 002547   000000 622006                    EAX2    0,QL
         1 002550   200033 236100                    LDQ     ERR,,AUTO
         1 002551   040105 100546                    MLR     fill='040'O
         1 002552   100000 200012                    ADSC9   0,Q,PR1                  cn=1,n=*X2
         1 002553   000000 200015                    ADSC9   0,A,PR0                  cn=1,n=13

     1012     4957    4            PRE$->RNAME2.NCHAIN@=NODE@;

   4957  1 002554   000003 441110                    SXL1    3,X0,PR0

     1013     4958    4            ERR=ERR+13;

   4958  1 002555   000015 236007                    LDQ     13,DL
         1 002556   200033 056100                    ASQ     ERR,,AUTO

     1014     4959    4            END;

   4959  1 002557   200033 236100                    LDQ     ERR,,AUTO
         1 002560   200006 116100                    CMPQ    UQ$+2,,AUTO
         1 002561   002526 604000 1                  TMI     s:4949

     1015     4960    3         NODE$->RNAME1.NCHAIN@=U_NULL;

   4960  1 002562   000000 220003                    LDX0    0,DU
         1 002563   200026 221100                    LDX1    NODE@,,AUTO
         1 002564   000003 440111                    SXL0    3,X1,PR0

     1016     4961    3         END;

     1017     4962    2      QENTRY_PRE@=RNAME1@;

   4962  1 002565   200021 220100                    LDX0    RNAME1@,,AUTO
         1 002566   200024 740100                    STX0    QENTRY_PRE@,,AUTO
         1 002567   002571 710000 1                  TRA     s:4967
PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:155  

     1018     4963        %EJECT;
PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:156  
     1019     4964    2   QENTRY_I: ENTRY ALTRET;

   4964  1 002570   200040 741300       QENTRY_I     STX1  ! CRD+4,,AUTO

     1020     4965                    /* Otherwise get a block and create a new QENTRY associating the   */
     1021     4966                    /* specified RNAME and DOMAIN.                                     */
     1022     4967    3      IF D_U>1023 THEN IF S$CU$->B$U.ENQ.COUNT>=B$JIT.MAXENQ THEN DO;

   4967  1 002571   200030 235100                    LDA     DOM_USER,,AUTO
         1 002572   002000 115007                    CMPA    1024,DL
         1 002573   002607 602000 1                  TNC     s:4975

   4967  1 002574   000000 470400 xsym               LDP0    S$CU$
         1 002575   000016 220100                    LDX0    14,,PR0
         1 002576   000000 471400 xsym               LDP1    B$JIT$
         1 002577   100363 100100                    CMPX0   243,,PR1
         1 002600   002605 602000 1                  TNC     s:4973

     1023     4968                    /*E*   ERROR:  UQB-E$ENQ_LIMIT-2                                 */
     1024     4969                    /*E*    MESSAGE: System limit on number of ENQ's per user exceeded.*/
     1025     4970    3            B$JIT.ERR=UQB$E$ENQ_LIMIT;

   4970  1 002601   000103 236000 0                  LDQ     UQB$E$ENQ_LIMIT
         1 002602   100012 756100                    STQ     10,,PR1

     1026     4971    3            ALTRETURN;

   4971  1 002603   200040 221300                    LDX1  ! CRD+4,,AUTO
         1 002604   000000 702211                    TSX2  ! 0,X1

     1027     4972    3            END;
     1028     4973    2         ELSE S$CU$->B$U.ENQ.COUNT=S$CU$->B$U.ENQ.COUNT+1;

   4973  1 002605   000001 621010                    EAX1    1,X0
         1 002606   000016 741100                    STX1    14,,PR0

     1029     4974           %GETNODE(NODE=QENTRY@);
PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:157  

   4975  1 002607   000000 470400 xsym               LDP0    U_BASE
         1 002610   000001 336007                    LCQ     1,DL
         1 002611   000042 056100                    ASQ     34,,PR0

   4976  1 002612   000043 720100                    LXL0    35,,PR0
         1 002613   200025 740100                    STX0    QENTRY@,,AUTO

   4977  1 002614   000003 721110                    LXL1    3,X0,PR0
         1 002615   000043 441100                    SXL1    35,,PR0

     1030     4979    2      QENTRY$->QENTRY=U_QENTRY_INIT;

   4979  1 002616   200025 235100                    LDA     QENTRY@,,AUTO
         1 002617   777777 375003                    ANA     -1,DU
         1 002620   000020 771000                    ARL     16
         1 002621   000105 100400                    MLR     fill='000'O
         1 002622   000000 000004 xsym               ADSC9   U_QENTRY_INIT            cn=0,n=4
         1 002623   000000 000020                    ADSC9   0,A,PR0                  cn=0,n=16

     1031     4980    2      QENTRY$->QENTRY.D_U=D_U;

   4980  1 002624   200030 236100                    LDQ     DOM_USER,,AUTO
         1 002625   000000 676110                    ERQ     0,X0,PR0
         1 002626   007777 376007                    ANQ     4095,DL
         1 002627   000000 656110                    ERSQ    0,X0,PR0

     1032     4981    2      QENTRY$->QENTRY.REQ_=QV.SHARE*2+BITBIN(QV.LIMITED_COM);

   4981  1 002630   200012 236100                    LDQ     QV,,AUTO
         1 002631   000015 772000                    QRL     13
         1 002632   000001 376007                    ANQ     1,DL
         1 002633   200042 756100                    STQ     PRE@+1,,AUTO
         1 002634   200012 236100                    LDQ     QV,,AUTO
         1 002635   000015 772000                    QRL     13
         1 002636   000006 376007                    ANQ     6,DL
         1 002637   200042 036100                    ADLQ    PRE@+1,,AUTO
PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:158  
         1 002640   000025 736000                    QLS     21
         1 002641   000000 676110                    ERQ     0,X0,PR0
         1 002642   000070 376003                    ANQ     56,DU
         1 002643   000000 656110                    ERSQ    0,X0,PR0

     1033     4982                    /* Set link to RNAME node associated with this QENTRY */
     1034     4983    2      QENTRY$->QENTRY.RNAME1@=RNAME1@;

   4983  1 002644   200021 221100                    LDX1    RNAME1@,,AUTO
         1 002645   000001 441110                    SXL1    1,X0,PR0

     1035     4984    2      QENTRY_PRE$->QENTRY.QCHAIN@=QENTRY@;

   4984  1 002646   200024 222100                    LDX2    QENTRY_PRE@,,AUTO
         1 002647   000001 740112                    STX0    1,X2,PR0

     1036     4985    2      RETURN;

   4985  1 002650   200040 221300                    LDX1  ! CRD+4,,AUTO
         1 002651   000001 702211                    TSX2  ! 1,X1

     1037     4986                    /**/
     1038     4987        %EJECT;
PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:159  
     1039     4988                    /**/
     1040     4989                    /**/
     1041     4990                    /* Delete a QENTRY defined by its predecessor on the QCHAIN        */
     1042     4991                    /* (linked by resource name).                                      */
     1043     4992    2   QENTRY_DQ: ENTRY ALTRET;

   4992  1 002652   200040 741300       QENTRY_DQ    STX1  ! CRD+4,,AUTO

     1044     4993                    /* Get index to next node on the QCHAIN */
     1045     4994                    /* Set predecessor on the QCHAIN to point at it */
     1046     4995    2      QENTRY_PRE$->QENTRY.QCHAIN@=QENTRY$->QENTRY.QCHAIN@;

   4995  1 002653   000000 470400 xsym               LDP0    U_BASE
         1 002654   200025 220100                    LDX0    QENTRY@,,AUTO
         1 002655   000001 222110                    LDX2    1,X0,PR0
         1 002656   200024 223100                    LDX3    QENTRY_PRE@,,AUTO
         1 002657   000001 742113                    STX2    1,X3,PR0

     1047     4996                    /* Finally, free the node. */
     1048     4997    2      IF QENTRY$->QENTRY.D_U>1023 THEN

   4997  1 002660   000000 236110                    LDQ     0,X0,PR0
         1 002661   007777 376007                    ANQ     4095,DL
         1 002662   002000 116007                    CMPQ    1024,DL
         1 002663   002670 602000 1                  TNC     s:5000

     1049     4998    2         S$CU$->B$U.ENQ.COUNT=S$CU$->B$U.ENQ.COUNT-1;

   4998  1 002664   000000 471400 xsym               LDP1    S$CU$
         1 002665   100016 221100                    LDX1    14,,PR1
         1 002666   777777 624011                    EAX4    -1,X1
         1 002667   100016 744100                    STX4    14,,PR1

     1050     4999           %FREENODE(NODE=QENTRY@);

   5000  1 002670   000000 450110                    STZ     0,X0,PR0

PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:160  
   5001  1 002671   000043 721100                    LXL1    35,,PR0
         1 002672   000003 441110                    SXL1    3,X0,PR0

   5002  1 002673   000043 440100                    SXL0    35,,PR0

   5003  1 002674   000042 054100                    AOS     34,,PR0

     1051     5005    2      RETURN;

   5005  1 002675   200040 221300                    LDX1  ! CRD+4,,AUTO
         1 002676   000001 702211                    TSX2  ! 1,X1

     1052     5006        %EJECT;
PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:161  
     1053     5007    2   ALLOCATE: ENTRY ALTRET;

   5007  1 002677   200040 741300       ALLOCATE     STX1  ! CRD+4,,AUTO

     1054     5008                  /* Attempt to allocate the next user queued for the resource at RNAME$ */
     1055     5009    2   ALLOC1: NODE@=RNAME1$->RNAME1.QCHAIN@;

   5009  1 002700   000000 470400 xsym  ALLOC1       LDP0    U_BASE
         1 002701   200021 220100                    LDX0    RNAME1@,,AUTO
         1 002702   000001 221110                    LDX1    1,X0,PR0
         1 002703   200026 741100                    STX1    NODE@,,AUTO

     1056     5010    2      QENTRY@=U_NULL;

   5010  1 002704   000000 222003                    LDX2    0,DU
         1 002705   200025 742100                    STX2    QENTRY@,,AUTO

     1057     5011    2      CRD='777'O;

   5011  1 002706   777000 236003                    LDQ     -512,DU
         1 002707   200034 756100                    STQ     CRD,,AUTO

     1058     5012    3      DO WHILE(NODE@~=U_NULL);

   5012  1 002710   000000 101003                    CMPX1   0,DU
         1 002711   002770 600000 1                  TZE     s:5027

     1059     5013    4         DO CASE(NODE$->QENTRY.STATE);

   5013  1 002712   000000 470400 xsym               LDP0    U_BASE
         1 002713   200026 220100                    LDX0    NODE@,,AUTO
         1 002714   000000 236110                    LDQ     0,X0,PR0
         1 002715   000030 772000                    QRL     24
         1 002716   000007 376007                    ANQ     7,DL
         1 002717   000003 116007                    CMPQ    3,DL
         1 002720   002722 602006 1                  TNC     s:5013+8,QL
         1 002721   002761 710000 1                  TRA     s:5023
PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:162  
         1 002722   002761 710000 1                  TRA     s:5023
         1 002723   002745 710000 1                  TRA     s:5019
         1 002724   002725 710000 1                  TRA     s:5015

     1060     5014    4         CASE(ALLOCATED);

     1061     5015    4            IF NODE$->QENTRY.UPGRADE AND QENTRY@=U_NULL THEN QENTRY@=NODE@;

   5015  1 002725   000000 236110                    LDQ     0,X0,PR0
         1 002726   000007 316003                    CANQ    7,DU
         1 002727   002734 600000 1                  TZE     s:5016
         1 002730   200025 221100                    LDX1    QENTRY@,,AUTO
         1 002731   002734 601000 1                  TNZ     s:5016

   5015  1 002732   200025 740100                    STX0    QENTRY@,,AUTO
         1 002733   002742 710000 1                  TRA     s:5017

     1062     5016    4            ELSE CRD=UQ_ACCESS(NODE$->QENTRY.REQ_)&CRD;

   5016  1 002734   000000 236110                    LDQ     0,X0,PR0
         1 002735   000025 772000                    QRL     21
         1 002736   000007 376007                    ANQ     7,DL
         1 002737   000113 236006 0                  LDQ     UQ_ACCESS,QL
         1 002740   200034 376100                    ANQ     CRD,,AUTO
         1 002741   200034 756100                    STQ     CRD,,AUTO

     1063     5017    4            NODE@=NODE$->QENTRY.QCHAIN@;

   5017  1 002742   000001 221110                    LDX1    1,X0,PR0
         1 002743   200026 741100                    STX1    NODE@,,AUTO
         1 002744   002766 710000 1                  TRA     s:5026

     1064     5018    4         CASE(ALLOC_PENDING);

     1065     5019    4            CRD=UQ_ACCESS(NODE$->QENTRY.REQ_)&

   5019  1 002745   000000 236110                    LDQ     0,X0,PR0
PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:163  
         1 002746   000025 772000                    QRL     21
         1 002747   000007 376007                    ANQ     7,DL
         1 002750   000000 221110                    LDX1    0,X0,PR0
         1 002751   000007 361003                    ANX1    7,DU
         1 002752   000113 236006 0                  LDQ     UQ_ACCESS,QL
         1 002753   000113 376011 0                  ANQ     UQ_ACCESS,X1
         1 002754   200034 376100                    ANQ     CRD,,AUTO
         1 002755   200034 756100                    STQ     CRD,,AUTO

     1066     5020    4              UQ_ACCESS(NODE$->QENTRY.UPG_)&CRD;
     1067     5021    4            NODE@=NODE$->QENTRY.QCHAIN@;

   5021  1 002756   000001 222110                    LDX2    1,X0,PR0
         1 002757   200026 742100                    STX2    NODE@,,AUTO
         1 002760   002766 710000 1                  TRA     s:5026

     1068     5022    4         CASE(ELSE);

     1069     5023    4            IF QENTRY@=U_NULL THEN QENTRY@=NODE@;

   5023  1 002761   200025 221100                    LDX1    QENTRY@,,AUTO
         1 002762   002764 601000 1                  TNZ     s:5024

   5023  1 002763   200025 740100                    STX0    QENTRY@,,AUTO

     1070     5024    4            NODE@=U_NULL;

   5024  1 002764   000000 221003                    LDX1    0,DU
         1 002765   200026 741100                    STX1    NODE@,,AUTO

     1071     5025    4         END;

     1072     5026    3         END;

   5026  1 002766   200026 220100                    LDX0    NODE@,,AUTO
         1 002767   002712 601000 1                  TNZ     s:5013

PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:164  
     1073     5027    2      IF QENTRY@=U_NULL THEN ALTRETURN;

   5027  1 002770   200025 220100                    LDX0    QENTRY@,,AUTO
         1 002771   002774 601000 1                  TNZ     s:5027+4

   5027  1 002772   200040 221300                    LDX1  ! CRD+4,,AUTO
         1 002773   000000 702211                    TSX2  ! 0,X1
         1 002774   002776 710000 1                  TRA     s:5032

     1074     5028        %EJECT;
PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:165  
     1075     5029    2   ALLOC: ENTRY ALTRET;

   5029  1 002775   200040 741300       ALLOC        STX1  ! CRD+4,,AUTO

     1076     5030                 /* If CRD (containing current acceptable newcomer XLATE bits) indicates */
     1077     5031                 /* that the QENTRY at QENTRY$ can be allocated, do so. Otherwise ALTRET */
     1078     5032    2      NODE@=QENTRY$->QENTRY.UPG_;

   5032  1 002776   000000 470400 xsym               LDP0    U_BASE
         1 002777   200025 220100                    LDX0    QENTRY@,,AUTO
         1 003000   000000 221110                    LDX1    0,X0,PR0
         1 003001   000007 361003                    ANX1    7,DU
         1 003002   200026 741100                    STX1    NODE@,,AUTO

     1079     5033    2      IF NODE@=0 THEN NODE@=QENTRY$->QENTRY.REQ_;

   5033  1 003003   003011 601000 1                  TNZ     s:5034

   5033  1 003004   000000 236110                    LDQ     0,X0,PR0
         1 003005   000025 772000                    QRL     21
         1 003006   000007 376007                    ANQ     7,DL
         1 003007   000000 622006                    EAX2    0,QL
         1 003010   200026 742100                    STX2    NODE@,,AUTO

     1080     5034    2      IF NOT UQ_XLATE(NODE@)&CRD OR QENTRY$->QENTRY.DOM_USER.DOMAIN#=0

   5034  1 003011   200026 222100                    LDX2    NODE@,,AUTO
         1 003012   000123 236012 0                  LDQ     UQ_XLATE,X2
         1 003013   200034 376100                    ANQ     CRD,,AUTO
         1 003014   003020 600000 1                  TZE     s:5035
         1 003015   000000 236110                    LDQ     0,X0,PR0
         1 003016   007000 316007                    CANQ    3584,DL
         1 003017   003022 601000 1                  TNZ     s:5036

     1081     5035    2      THEN ALTRETURN;

   5035  1 003020   200040 221300                    LDX1  ! CRD+4,,AUTO
PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:166  
         1 003021   000000 702211                    TSX2  ! 0,X1

     1082     5036    3      IF QENTRY$->QENTRY.WAIT THEN DO;

   5036  1 003022   400000 316007                    CANQ    -131072,DL
         1 003023   003073 600000 1                  TZE     s:5051

     1083     5037    3         IF NOT QENTRY$->QENTRY.UPGRADE

   5037  1 003024   000007 316003                    CANQ    7,DU
         1 003025   003032 601000 1                  TNZ     s:5040

     1084     5038    3         THEN QENTRY$->QENTRY.STATE=ALLOCATED;

   5038  1 003026   000001 376000 2                  ANQ     1
         1 003027   000200 276003                    ORQ     128,DU
         1 003030   000000 756110                    STQ     0,X0,PR0
         1 003031   003040 710000 1                  TRA     s:5043

     1085     5039    4         ELSE DO;

     1086     5040    4            QENTRY$->QENTRY.REQ_=QENTRY$->QENTRY.UPG_;

   5040  1 003032   000003 736000                    QLS     3
         1 003033   000000 676110                    ERQ     0,X0,PR0
         1 003034   000070 376003                    ANQ     56,DU
         1 003035   000000 656110                    ERSQ    0,X0,PR0

     1087     5041    4            QENTRY$->QENTRY.UPG_=0;

   5041  1 003036   000002 236000 2                  LDQ     2
         1 003037   000000 356110                    ANSQ    0,X0,PR0

     1088     5042    4            END;

     1089     5043    3         IF QENTRY$->QENTRY.DOM_USER.USER~=S_CUN

PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:167  
   5043  1 003040   000000 236110                    LDQ     0,X0,PR0
         1 003041   000777 376007                    ANQ     511,DL
         1 003042   000000 116000 xsym               CMPQ    S_CUN
         1 003043   003057 600000 1                  TZE     s:5045

     1090     5044    3         THEN CALL SSR$RUE(%SS_NQR,QENTRY$->QENTRY.DOM_USER.USER);

   5044  1 003044   200025 236100                    LDQ     QENTRY@,,AUTO
         1 003045   777777 376003                    ANQ     -1,DU
         1 003046   600000 036007                    ADLQ    -65536,DL
         1 003047   000000 036000 xsym               ADLQ    U_BASE
         1 003050   000007 235000 2                  LDA     7
         1 003051   200042 757100                    STAQ    PRE@+1,,AUTO
         1 003052   200042 630500                    EPPR0   PRE@+1,,AUTO
         1 003053   000020 631400 xsym               EPPR1   B_VECTNIL+16
         1 003054   000000 701000 xent               TSX1    SSR$RUE
         1 003055   000000 011000                    NOP     0
         1 003056   003066 710000 1                  TRA     s:5047

     1091     5045    3         ELSE IF UQ$.MESSAGE$~=ADDR(NIL)

   5045  1 003057   200011 236100                    LDQ     UQ$+5,,AUTO
         1 003060   000001 116000 xsym               CMPQ    B_VECTNIL+1
         1 003061   003066 600000 1                  TZE     s:5047

     1092     5046    3            THEN UQ$.MESSAGE$->MESSAGE=RNAME1$->RNAME1.COMM;

   5046  1 003062   200021 221100                    LDX1    RNAME1@,,AUTO
         1 003063   200011 471500                    LDP1    UQ$+5,,AUTO
         1 003064   000002 235111                    LDA     2,X1,PR0
         1 003065   100000 755100                    STA     0,,PR1

     1093     5047    3         QENTRY$->QENTRY.WAIT='0'B;

   5047  1 003066   000000 470400 xsym               LDP0    U_BASE
         1 003067   200025 220100                    LDX0    QENTRY@,,AUTO
         1 003070   000004 236000 2                  LDQ     4
PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:168  
         1 003071   000000 356110                    ANSQ    0,X0,PR0

     1094     5048    3         END;

   5048  1 003072   003146 710000 1                  TRA     s:5058

     1095     5049    3      ELSE DO;

     1096     5050                    /* DO NOWAIT TYPE WAKEUP */
     1097     5051    3         ERR=QENTRY$->QENTRY.DOM_USER.DOMAIN#;

   5051  1 003073   000000 236110                    LDQ     0,X0,PR0
         1 003074   000011 772000                    QRL     9
         1 003075   000007 376007                    ANQ     7,DL
         1 003076   200033 756100                    STQ     ERR,,AUTO

     1098     5052    3         ECCI.WORDS=1;

   5052  1 003077   000001 235007                    LDA     1,DL
         1 003100   200031 755100                    STA     ECCI,,AUTO

     1099     5053    3         ECCI.MESSAGE=RNAME1$->RNAME1.COMM;

   5053  1 003101   200021 221100                    LDX1    RNAME1@,,AUTO
         1 003102   000002 235111                    LDA     2,X1,PR0
         1 003103   200032 755100                    STA     ECCI+1,,AUTO

     1100     5054    3         QENTRY$->QENTRY.STATE=ALLOC_PENDING;

   5054  1 003104   000000 236110                    LDQ     0,X0,PR0
         1 003105   000001 376000 2                  ANQ     1
         1 003106   000100 276003                    ORQ     64,DU
         1 003107   000000 756110                    STQ     0,X0,PR0

     1101     5055    3         CALL SSV$EVENT(QENTRY$->QENTRY.DOM_USER.USER,ERR,%EVSC_ENQ#,

   5055  1 003110   000003 636000 1                  EAQ     s:4137
PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:169  
         1 003111   200043 756100                    STQ     PRE@+2,,AUTO
         1 003112   200025 236100                    LDQ     QENTRY@,,AUTO
         1 003113   777777 376003                    ANQ     -1,DU
         1 003114   000000 036000 xsym               ADLQ    U_BASE
         1 003115   200042 756100                    STQ     PRE@+1,,AUTO
         1 003116   200031 631500                    EPPR1   ECCI,,AUTO
         1 003117   200044 451500                    STP1    PRE@+3,,AUTO
         1 003120   200043 236100                    LDQ     PRE@+2,,AUTO
         1 003121   200045 756100                    STQ     PRE@+4,,AUTO
         1 003122   200045 633500                    EPPR3   PRE@+4,,AUTO
         1 003123   200054 453500                    STP3    PRE@+11,,AUTO
         1 003124   200044 634500                    EPPR4   PRE@+3,,AUTO
         1 003125   200053 454500                    STP4    PRE@+10,,AUTO
         1 003126   000013 236000 2                  LDQ     11
         1 003127   200052 756100                    STQ     PRE@+9,,AUTO
         1 003130   200042 635500                    EPPR5   PRE@+1,,AUTO
         1 003131   200051 455500                    STP5    PRE@+8,,AUTO
         1 003132   200050 756100                    STQ     PRE@+7,,AUTO
         1 003133   200033 636500                    EPPR6   ERR,,AUTO
         1 003134   200047 456500                    STP6    PRE@+6,,AUTO
         1 003135   200025 236100                    LDQ     QENTRY@,,AUTO
         1 003136   777777 376003                    ANQ     -1,DU
         1 003137   600000 036007                    ADLQ    -65536,DL
         1 003140   000000 036000 xsym               ADLQ    U_BASE
         1 003141   200046 756100                    STQ     PRE@+5,,AUTO
         1 003142   200046 630500                    EPPR0   PRE@+5,,AUTO
         1 003143   000025 631400 xsym               EPPR1   B_VECTNIL+21
         1 003144   000000 701000 xent               TSX1    SSV$EVENT
         1 003145   000000 011000                    NOP     0

     1102     5056    3           QENTRY$,0,ADDR(ECCI),ENTADDR(UQB$ENQ_EVENT));
     1103     5057    3         END;

     1104     5058    2      IF QENTRY$->QENTRY.DOM_USER.USER=S_CUN THEN RETURN;

   5058  1 003146   000000 470400 xsym               LDP0    U_BASE
         1 003147   200025 220100                    LDX0    QENTRY@,,AUTO
PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:170  
         1 003150   000000 236110                    LDQ     0,X0,PR0
         1 003151   000777 376007                    ANQ     511,DL
         1 003152   000000 116000 xsym               CMPQ    S_CUN
         1 003153   003156 601000 1                  TNZ     s:5059

   5058  1 003154   200040 221300                    LDX1  ! CRD+4,,AUTO
         1 003155   000001 702211                    TSX2  ! 1,X1

     1105     5059    2      GOTO ALLOC1; /* KEEP TRYING UNTIL NOTHING HAPPENS  */

   5059  1 003156   002700 710000 1                  TRA     ALLOC1

     1106     5060        %EJECT;
PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:171  
     1107     5061                    /**/
     1108     5062                    /* Entry point for unlocking the ENQ/DEQ tables.                   */
     1109     5063                    /**/
     1110     5064    2   UNLOCK: ENTRY ALTRET;

   5064  1 003157   200040 741300       UNLOCK       STX1  ! CRD+4,,AUTO

     1111     5065           %SET_COUNTER(ITEM=ENQ,
     1112     5066           VALUE="UQ_.TOT_BLOCKS.N-UQ_.FREE_BLOCKS");

   5067  1 003160   000000 470400 xsym               LDP0    U_BASE
         1 003161   000041 236100                    LDQ     33,,PR0
         1 003162   000002 772000                    QRL     2
         1 003163   000042 136100                    SBLQ    34,,PR0
         1 003164   000000 471400 xsym               LDP1    P_RESOURCE$
         1 003165   100063 756100                    STQ     51,,PR1

   5068  1 003166   100064 116100                    CMPQ    52,,PR1
         1 003167   003172 602000 1                  TNC     s:5071
         1 003170   003172 600000 1                  TZE     s:5071

   5070  1 003171   100064 756100                    STQ     52,,PR1

   5071  1 003172   100065 116100                    CMPQ    53,,PR1
         1 003173   003175 603000 1                  TRC     s:5076

   5073  1 003174   100065 756100                    STQ     53,,PR1

     1113     5075           %UNLOCK(G=U_LOCK);

   5076  1 003175   000000 630400 2                  EPPR0   0
         1 003176   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 003177   000000 701000 xent               TSX1    HFC$UNLOCK
         1 003200   000000 011000                    NOP     0

     1114     5078    2      RETURN;

PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:172  
   5078  1 003201   200040 221300                    LDX1  ! CRD+4,,AUTO
         1 003202   000001 702211                    TSX2  ! 1,X1

     1115     5079                    /**/
     1116     5080        %EJECT;
PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:173  
     1117     5081    2   ARGS: ENTRY ALTRET;

   5081  1 003203   200040 741300       ARGS         STX1  ! CRD+4,,AUTO

     1118     5082    2      UQ$='0'B;

   5082  1 003204   000100 100400                    MLR     fill='000'O
         1 003205   000002 000001 xsym               ADSC9   B_VECTNIL+2              cn=0,n=1
         1 003206   200004 000030                    ADSC9   UQ$,,AUTO                cn=0,n=24

     1119     5083    2      UQ$.DOMAIN#=ARG1;

   5083  1 003207   200003 470500                    LDP0    @ARG1,,AUTO
         1 003210   000000 720100                    LXL0    0,,PR0
         1 003211   200010 740100                    STX0    UQ$+4,,AUTO

     1120     5084                    /* GET RNAME$ */
     1121     5085    2      UQ$.RNAME$=ADDR(NIL);

   5085  1 003212   000001 236000 xsym               LDQ     B_VECTNIL+1
         1 003213   200005 756100                    STQ     UQ$+1,,AUTO

     1122     5086    2      CALL HFF$NILERASE(1) ALTRET(NOPS1);

   5086  1 003214   000014 630400 2                  EPPR0   12
         1 003215   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 003216   000000 701000 xent               TSX1    HFF$NILERASE
         1 003217   003240 702000 1                  TSX2    NOPS1

     1123     5087    2      UQ$.LENC(3)=B$PS1$->RNAME.LEN;

   5087  1 003220   000000 470400 xsym               LDP0    B$PS1$
         1 003221   040100 100500                    MLR     fill='040'O
         1 003222   000000 000001                    ADSC9   0,,PR0                   cn=0,n=1
         1 003223   200006 600001                    ADSC9   UQ$+2,,AUTO              cn=3,n=1

     1124     5088    3      IF UQ$.LENGTH~=0 THEN DO;
PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:174  

   5088  1 003224   200006 235100                    LDA     UQ$+2,,AUTO
         1 003225   003240 600000 1                  TZE     NOPS1

     1125     5089    3         UQ$.RNAME$=B$PS1$;

   5089  1 003226   000000 236000 xsym               LDQ     B$PS1$
         1 003227   200005 756100                    STQ     UQ$+1,,AUTO

     1126     5090    3         UQ$.RHASHC(3)=SUBSTR(RNAME.TEXT,UQ$.LENGTH-1,1);

   5090  1 003230   200005 471500                    LDP1    UQ$+1,,AUTO
         1 003231   040100 100505                    MLR     fill='040'O
         1 003232   100000 000001                    ADSC9   0,A,PR1                  cn=0,n=1
         1 003233   200007 600001                    ADSC9   UQ$+3,,AUTO              cn=3,n=1

     1127     5091    3         UQ$.RHASH=MOD(UQ$.RHASH,64)/2;

   5091  1 003234   200007 236100                    LDQ     UQ$+3,,AUTO
         1 003235   000077 376007                    ANQ     63,DL
         1 003236   000001 772000                    QRL     1
         1 003237   200007 756100                    STQ     UQ$+3,,AUTO

     1128     5092    3         END;

   5092  1 003240                       NOPS1        null
     1129     5093    2   NOPS1:;
     1130     5094    2      IF UQ$.LENGTH=0 THEN UQ$.LENGTH=1;

   5094  1 003240   200006 235100                    LDA     UQ$+2,,AUTO
         1 003241   003244 601000 1                  TNZ     s:5096

   5094  1 003242   000001 236007                    LDQ     1,DL
         1 003243   200006 756100                    STQ     UQ$+2,,AUTO

     1131     5095                    /* GET MESSAGE$ */
     1132     5096    2      UQ$.MESSAGE$=ADDR(NIL);
PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:175  

   5096  1 003244   000001 236000 xsym               LDQ     B_VECTNIL+1
         1 003245   200011 756100                    STQ     UQ$+5,,AUTO

     1133     5097    2      CALL HFF$NILERASE(2)ALTRET(NOPS2);

   5097  1 003246   000015 630400 2                  EPPR0   13
         1 003247   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 003250   000000 701000 xent               TSX1    HFF$NILERASE
         1 003251   003257 702000 1                  TSX2    NOPS2

     1134     5098    2      UQ$.MESSAGE$=B$PS2$;

   5098  1 003252   000000 236000 xsym               LDQ     B$PS2$
         1 003253   200011 756100                    STQ     UQ$+5,,AUTO

     1135     5099    2      ERR=UQ$.MESSAGE$->MESSAGE;

   5099  1 003254   200011 470500                    LDP0    UQ$+5,,AUTO
         1 003255   000000 235100                    LDA     0,,PR0
         1 003256   200033 755100                    STA     ERR,,AUTO

   5099  1 003257                       NOPS2        null
     1136     5100    2   NOPS2:;
     1137     5101                    /* NOW CHECK QNAME (DCB.CFU$) */
     1138     5102    3      IF QV.DCB#<=B$ROSEG.NUMDCBS THEN DO;

   5102  1 003257   000000 470400 xsym               LDP0    B$ROSEG$
         1 003260   000002 220100                    LDX0    2,,PR0
         1 003261   200012 100100                    CMPX0   QV,,AUTO
         1 003262   003320 602000 1                  TNC     s:5112

     1139     5103    3         IF DCBADDR(QV.DCB#)~=ADDR(NIL)

   5103  1 003263   000012 471400 2                  LDP1    10
         1 003264   100000 473500                    LDP3    0,,PR1
         1 003265   200012 221100                    LDX1    QV,,AUTO
PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:176  
         1 003266   300000 236111                    LDQ     0,X1,PR3
         1 003267   000001 116000 xsym               CMPQ    B_VECTNIL+1
         1 003270   003320 600000 1                  TZE     s:5112

     1140     5104    3         THEN IF DCBADDR(QV.DCB#)->F$DCB.ASN=1

   5104  1 003271   300000 474511                    LDP4    0,X1,PR3
         1 003272   400032 236100                    LDQ     26,,PR4
         1 003273   777000 376007                    ANQ     -512,DL
         1 003274   001000 116007                    CMPQ    512,DL
         1 003275   003320 601000 1                  TNZ     s:5112
         1 003276   400004 236100                    LDQ     4,,PR4
         1 003277   002000 316003                    CANQ    1024,DU
         1 003300   003311 600000 1                  TZE     s:5104+16
         1 003301   200010 235100                    LDA     UQ$+4,,AUTO
         1 003302   000022 771000                    ARL     18
         1 003303   200042 755100                    STA     PRE@+1,,AUTO
         1 003304   400040 236100                    LDQ     32,,PR4
         1 003305   000022 772000                    QRL     18
         1 003306   000777 376007                    ANQ     511,DL
         1 003307   200042 116100                    CMPQ    PRE@+1,,AUTO
         1 003310   003320 601000 1                  TNZ     s:5112
         1 003311   400031 236100                    LDQ     25,,PR4
         1 003312   020000 316007                    CANQ    8192,DL
         1 003313   003320 600000 1                  TZE     s:5112

     1141     5105    3              AND (NOT DCBADDR(QV.DCB#)->F$DCB.FFLG.EXEC
     1142     5106    3              OR DCBADDR(QV.DCB#)->F$DCB.WSR=UQ$.DOMAIN#)
     1143     5107    4              AND DCBADDR(QV.DCB#)->F$DCB.FCD THEN DO;

     1144     5108    4               ADDR(UQ$.QNAME)->PTR$=DCBADDR(QV.DCB#)->F$DCB.CFU$;

   5108  1 003314   400066 236100                    LDQ     54,,PR4
         1 003315   200004 756100                    STQ     UQ$,,AUTO

     1145     5109    4               RETURN;

PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:177  
   5109  1 003316   200040 221300                    LDX1  ! CRD+4,,AUTO
         1 003317   000001 702211                    TSX2  ! 1,X1

     1146     5110    4               END;
     1147     5111    3         END;
     1148     5112    2      B$JIT.ERR=UQB$E$BAD_DCB;

   5112  1 003320   000102 236000 0                  LDQ     UQB$E$BAD_DCB
         1 003321   000000 471400 xsym               LDP1    B$JIT$
         1 003322   100012 756100                    STQ     10,,PR1

     1149     5113                    /*E* ERROR: UQB-E$BAD_DCB-2
     1150     5114                    *    MESSAGE:The M$ENQ or M$DEQ DCB must have access to a file.
     1151     5115                    *    MESSAGE1:The DCB used as a parameter for M$ENQ or M$DEQ
     1152     5116                    *             must exist, must be open to a file (ASN=FILE),
     1153     5117                    *             and must be by the same domain if DCB.FFLG.EXEC.
     1154     5118                    */
     1155     5119    2      ALTRETURN;

   5119  1 003323   200040 221300                    LDX1  ! CRD+4,,AUTO
         1 003324   000000 702211                    TSX2  ! 0,X1

     1156     5120                    /**/
     1157     5121    2   END LID_SUBROUTINES;
     1158     5122        %EJECT;
PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:178  
     1159     5123                    /**/
     1160     5124    1   CHECK: PROC ALTRET;

   5124  1 003325   200036 741300       CHECK        STX1  ! CRD+2,,AUTO

     1161     5125    3      DO WHILE('1'B);

     1162     5126    3         IF UQ$.LENGTH=0 THEN IF UQ_.FREE_BLOCKS>=4 THEN RETURN;ELSE;

   5126  1 003326   200006 235100                    LDA     UQ$+2,,AUTO
         1 003327   003336 601000 1                  TNZ     s:5127

   5126  1 003330   000000 470400 xsym               LDP0    U_BASE
         1 003331   000042 235100                    LDA     34,,PR0
         1 003332   000004 115007                    CMPA    4,DL
         1 003333   003346 604000 1                  TMI     s:5129

   5126  1 003334   200036 221300                    LDX1  ! CRD+2,,AUTO
         1 003335   000001 702211                    TSX2  ! 1,X1

     1163     5127    3         ELSE IF (UQ$.LENGTH+4+20*13)/13-UQ_.FREE_BLOCKS<=0 THEN RETURN;

   5127  1 003336   200006 236100                    LDQ     UQ$+2,,AUTO
         1 003337   000410 036007                    ADLQ    264,DL
         1 003340   000015 506007                    DIV     13,DL
         1 003341   000000 470400 xsym               LDP0    U_BASE
         1 003342   000042 136100                    SBLQ    34,,PR0
         1 003343   003346 605400 1                  TPNZ    s:5129

   5127  1 003344   200036 221300                    LDX1  ! CRD+2,,AUTO
         1 003345   000001 702211                    TSX2  ! 1,X1

     1164     5128                    /* RESERVE 16 BLOCKS FOR THE MONITOR  */
     1165     5129    3         CALL UQC$CHK ALTRET(NOMEM);

   5129  1 003346   000002 631400 xsym               EPPR1   B_VECTNIL+2
         1 003347   000000 701000 xent               TSX1    UQC$CHK
PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:179  
         1 003350   003352 702000 1                  TSX2    NOMEM

     1166     5130    3         END;

   5130  1 003351   003326 710000 1                  TRA     s:5126

     1167     5131    2   NOMEM: ALTRETURN;

   5131  1 003352   200036 221300       NOMEM        LDX1  ! CRD+2,,AUTO
         1 003353   000000 702211                    TSX2  ! 0,X1

CRD_
 Sect OctLoc
   0     000   000000 000000   700000 000000   000000 000000   500000 000000    ................
   0     004   120000 000000   020000 000000   040000 000000   700000 000000    P....... .......
   0     010   040000 000000   540000 000000   320000 000000   060000 000000     ...........0...
   0     014   700000 000000   020000 000000   020000 000000                    ............

(unnamed)
 Sect OctLoc
   0     017   0***** ******                                                    ....

MENQSHARE
 Sect OctLoc
   0     020   000003 777640   000026 006000   000000 177640   000000 006014    ................
   0     024   000000 177640   000000 006014   000000 660000   777777 777776    ................
   0     030   000000 000000   000000 000000                                    ........

MENQNONE
 Sect OctLoc
   0     032   000003 777640   000040 006000   000000 177640   000000 006014    ..... ..........
   0     036   000000 177640   000000 006014   000000 540000   777777 777776    ................
   0     042   000000 000000   000000 000000                                    ........

MRNAME
 Sect OctLoc
   0     044   ****** ******   000044 006000   000000 000000   000000 000000    .....$..........
PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:180  
   0     050   000001 000002   000000 006014                                    ........

MENQNONEB
 Sect OctLoc
   0     052   000003 777640   000060 006000   000000 177640   000000 006014    .....0..........
   0     056   000000 177640   000000 006014   000000 540000   777777 777777    ................
   0     062   000000 000000   000000 000000                                    ........

MENQSHAREB
 Sect OctLoc
   0     064   000003 777640   000072 006000   000000 177640   000000 006014    .....:..........
   0     070   000000 177640   000000 006014   000000 660000   777777 777777    ................
   0     074   000000 000000   000000 000000                                    ........

ERRCODE
 Sect OctLoc
   0     076   252102 000002                                                    .B..

UQB$E$MISSING_PARAM
 Sect OctLoc
   0     077   252102 014462                                                    .B..

UQB$E$BAD_TIME
 Sect OctLoc
   0     100   252102 014502                                                    .B..

UQB$E$NOEADDR
 Sect OctLoc
   0     101   252102 014432                                                    .B..

UQB$E$BAD_DCB
 Sect OctLoc
   0     102   252102 014472                                                    .B..

UQB$E$ENQ_LIMIT
 Sect OctLoc
   0     103   252102 014542                                                    .B..
PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:181  

UQB$E$PDOMAIN
 Sect OctLoc
   0     104   252102 014452                                                    .B..

UQB$E$CRD_ERR
 Sect OctLoc
   0     105   252102 014442                                                    .B..

UQB$E$DLOCK
 Sect OctLoc
   0     106   252102 014412                                                    .B..

UQB$E$UQ_DOWNGRADE
 Sect OctLoc
   0     107   252102 014562                                                    .B..

UQB$E$UQ_NOCHANGE
 Sect OctLoc
   0     110   252102 014552                                                    .B..

UQB$E$BAD_UPGRADE
 Sect OctLoc
   0     111   252102 014522                                                    .B..

UQB$E$NO_UPGRADE
 Sect OctLoc
   0     112   252102 014572                                                    .B..

UQ_ACCESS
 Sect OctLoc
   0     113   777000 000000   777000 000000   740000 000000   770000 000000    ................
   0     117   640000 000000   050000 000000   600000 000000   600000 000000    ....(...........

UQ_XLATE
 Sect OctLoc
   0     123   400000 000000   200000 000000   100000 000000   040000 000000    ........@... ...
PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:182  
   0     127   020000 000000   010000 000000   004000 000000   002000 000000    ................

(unnamed)
 Sect OctLoc
   2     000   000000 006000   777077 777777   777770 777777   777777 777772    .....?..........
   2     004   777777 377777   777777 770777   000000 000103   000006 006000    ...........C....
   2     010   000000 000102   000010 006000   000000 006003   000002 006000    ...B............
   2     014   000003 006000   000004 006000                                    ........
     1168     5132    2   END CHECK;
     1169     5133                    /**/
     1170     5134    1   END UQB$EDPR;

PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:183  
--  Include file information  --

   UQ_ERRORS_C.:E05TOU  is referenced.
   UQ_DATA_R.:E05TOU  cannot be made into a system file and is referenced.
   UQ$NODES.:E05TOU  cannot be made into a system file and is referenced.
   SS_SCHED_C.:E05TOU  is referenced.
   HF_LOCK_C.:E05TOU  cannot be made into a system file and is referenced.
   P_PMDAT_C.:E05TOU  is referenced.
   F$DCB.:E05TOU  cannot be made into a system file and is referenced.
   B$ROSEG.:E05TOU  cannot be made into a system file and is referenced.
   B$JIT_C.:E05TOU  is referenced.
   B$USER.:E05TOU  cannot be made into a system file and is referenced.
   UM_CP6.:E05TOU  is referenced.
   UM$CP6V_C.:E05TOU  is referenced.
   UE_CP6.:E05TOU  is referenced.
   CP_6_SUBS.:E05TOU  is referenced.
      No diagnostics issued in procedure UQB$EDPR.
PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:184  

 **** Variables and constants ****

  ****  Section 000 RoData UQB$EDPR

  ****  Scalars and arrays  ****
OctLoc.c.b A Datatyp(siz) R M Lvl/name                 OctLoc.c.b A Datatyp(siz) R M Lvl/name

     0-0-0/b STRC        r     1 CRD_(0:14)                76-0-0/b STRC        r     1 ERRCODE
    32-0-0/d STRC(360)   r     1 MENQNONE                  52-0-0/d STRC(360)   r     1 MENQNONEB
    20-0-0/d STRC(360)   r     1 MENQSHARE                 64-0-0/d STRC(360)   r     1 MENQSHAREB
    44-0-0/w STRC(216)   r     1 MRNAME                   102-0-0/b STRC        r     1 UQB$E$BAD_DCB
   100-0-0/b STRC        r     1 UQB$E$BAD_TIME           111-0-0/b STRC        r     1 UQB$E$BAD_UPGRADE
   105-0-0/b STRC        r     1 UQB$E$CRD_ERR            106-0-0/b STRC        r     1 UQB$E$DLOCK
   103-0-0/b STRC        r     1 UQB$E$ENQ_LIMIT           77-0-0/b STRC        r     1 UQB$E$MISSING_PARAM
   101-0-0/b STRC        r     1 UQB$E$NOEADDR            112-0-0/b STRC        r     1 UQB$E$NO_UPGRADE
   104-0-0/b STRC        r     1 UQB$E$PDOMAIN            107-0-0/b STRC        r     1 UQB$E$UQ_DOWNGRADE
   110-0-0/b STRC        r     1 UQB$E$UQ_NOCHANGE
   113-0-0/b BIT         r     1 UQ_ACCESS(0:7)
   123-0-0/b BIT         r     1 UQ_XLATE(0:7)

  ****  Auto variables  ****

  ****  Scalars and arrays  ****
OctLoc.c.b A Datatyp(siz) R M Lvl/name                 OctLoc.c.b A Datatyp(siz) R M Lvl/name

     3-0-0/w PTR         r     1 @ARG1                     *0-0-0/w UBIN        r     1 ARG1
    *0-0-0/w BIT         r     1 ARG1B                     34-0-0/b STRC        r     1 CRD
    27-0-0/w UBIN(18)    r     1 DLKNTRY@                  *0-0-0/w PTR         r     1 DOLIST$
    30-0-0/b STRC        r     1 DOM_USER                  30-0-0/w UBIN        r     1 D_U
    31-0-0/w STRC(72)    r     1 ECCI                      33-0-0/w SBIN        r     1 ERR
    26-0-0/w UBIN(18)    r     1 NODE@                     33-0-0/w BIT         r     1 OCRD
    41-0-0/w UBIN(18)    r     1 PRE@                      25-0-0/w UBIN(18)    r     1 QENTRY@
    24-0-0/w UBIN(18)    r     1 QENTRY_PRE@               17-0-0/w UBIN(18)    r     1 QID@
    16-0-0/w UBIN(18)    r     1 QID_PRE@                  12-0-0/d STRC(144)   r     1 QV
    23-0-0/w UBIN(18)    r     1 RHASH@                    22-0-0/w UBIN(18)    r     1 RHASH_PRE@
    21-0-0/w UBIN(18)    r     1 RNAME1@                   20-0-0/w UBIN(18)    r     1 RNAME_PRE@
     4-0-0/w STRC(216)   r     1 UQ$
PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:185  

  ****  SYMREF variables  ****

  ****  Scalars and arrays  ****
OctLoc.c.b A Datatyp(siz) R M Lvl/name                 OctLoc.c.b A Datatyp(siz) R M Lvl/name

     0-0-0/w PTR         r     1 B$JIT$                     0-0-0/w PTR         r     1 B$PS0$
     0-0-0/w PTR         r     1 B$PS1$                     0-0-0/w PTR         r     1 B$PS2$
     0-0-0/w PTR         r     1 B$ROSEG$                   0-0-0/w PTR         r     1 B$USRT$
     0-0-0/w UBIN        r     1 IRM_SYSID                  0-0-0/w PTR         r     1 P_RESOURCE$
     0-0-0/w PTR         r     1 S$CU$                      0-0-0/w SBIN        r     1 S_CUN
     0-0-0/b STRC        r     1 U_BASE                     0-0-0/w PTR         r     1 U_BASE$
     0-0-0/d BIT (72)    r     1 U_LOCK                     0-0-0/b STRC        r     1 U_QENTRY_INIT
     0-0-0/b STRC        r     1 U_QID_INIT                 0-0-0/b STRC        r     1 U_RNAME1_INIT

  ****  BASED and DCB variables  ****

  ****  Scalars and arrays  ****
OctLoc.c.b A Datatyp(siz) R M Lvl/name                 OctLoc.c.b A Datatyp(siz) R M Lvl/name

     0-0-0/w STRC(144)   r     1 AVAIL                      0-0-0/d STRC(396)   r     1 B$DO
     0-0-0/w STRC(180)   r     1 B$ECCB                     0-0-0/d STRC(8856)  r     1 B$JIT
     0-0-0/d STRC(3024)  r     1 B$ROSEG                    0-0-0/d STRC(576)   r     1 B$U
     0-0-0/w STRC(576)   r     1 B$USER(0:0)                0-0-0/d ASTR(3528)  r     1 F$DCB
     0-0-0/d STRC(72)    r     1 FPT$DEQ_V                  0-0-0/d STRC(144)   r     1 FPT$ENQ_V
     0-0-0/w UBIN        r     1 MESSAGE                    0-0-0/w STRC(144)   r     1 NNODE
     0-0-0/w STRC(144)   r     1 NODE                       0-0-0/w STRC        r     1 PLUGH
     0-0-0/w PTR         r     1 PTR$                       0-0-0/w STRC(2268)  r     1 P_RESOURCE
     0-0-0/w STRC(144)   r     1 QENTRY                     0-0-0/w STRC(144)   r     1 QID
     0-0-0/c ASTR(9)     r     1 RNAME                      0-0-0/w STRC(144)   r     1 RNAME1
     0-0-0/w STRC(144)   r     1 RNAME2                     0-0-0/w STRC(144)   r     1 RNAME3
     0-0-0/w STRC(1296)  r     1 UQ_


   Procedure UQB$EDPR requires 1772 words for executable code.
   Procedure UQB$EDPR requires 46 words of local(AUTO) storage.
PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:186  

    No errors detected in file UQB$EDPR.:E05TSI    .
PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:187  
          *** CROSS REFERENCE LISTING ***
**     DENOTES     IDENTIFIER DEFINITION
<<                 IDENTIFIER'S VALUE SET
>>                 IDENTIFIER'S VALUE USED
<>                 IDENTIFIER SET AND/OR USED
--                 IDENTIFIER REFERENCED
PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:188  
          MINI XREF LISTING

ALLOC IN PROCEDURE LID_SUBROUTINES
      5029**ENTRY    4307--CALL     4358--CALL
ALLOC1 IN PROCEDURE LID_SUBROUTINES
      5009**LABEL    5059--GOTO
ALLOCATE IN PROCEDURE LID_SUBROUTINES
      5007**ENTRY    4160--CALL     4308--CALL     4466--CALL     4719--CALL
ARG1
      3802**DCL         9--PROC     3803--REDEF    3804--REDEF    4137--ENTRY    4179--ENTRY    4212--ENTRY
      4222--ENTRY    4232--ENTRY    4242--ENTRY    4499--ENTRY    4507--ENTRY    4613--ENTRY    4619--IF
      4646--ENTRY    5083>>ASSIGN
ARG1B
      3803**DCL      4246>>ASSIGN   4501>>ASSIGN   4629>>ASSIGN
ARGS IN PROCEDURE LID_SUBROUTINES
      5081**ENTRY    4181--CALL     4509--CALL
AVAIL.NEXT_BLOCK@
      3670**DCL      4845<<ASSIGN   4857<<ASSIGN   4899>>ASSIGN   4916>>ASSIGN   4941>>ASSIGN   4953>>ASSIGN
      4977>>ASSIGN   5001<<ASSIGN
AVAIL.TYPE
      3667**DCL      4844<<ASSIGN   4856<<ASSIGN   4943<<ASSIGN   4955<<ASSIGN   5000<<ASSIGN
B$DO.ECCINFO
      2453**DCL      2454--REDEF
B$DO.EVID
      2447**DCL      4144>>ASSIGN   4150<<ASSIGN
B$ECCB.FLAGS.EVTSET
      2283**DCL      4189>>IF
B$EVNT.CODE
      2291**DCL      2291--REDEF    2292--REDEF    2292--REDEF
B$EVNT.ERR.ERR#
      2293**DCL      2293--REDEF
B$EVNT.EVID
      2292**DCL      2292--REDEF    2292--REDEF
B$JIT.DCB$
PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:189  
      2932**DCL      4617>>IF       4618>>ASSIGN   4619>>IF       4621>>IF
B$JIT.ERR
      2842**DCL      4184<<ASSIGN   4190<<ASSIGN   4194>>IF       4200<<ASSIGN   4279<<ASSIGN   4291<<ASSIGN
      4298<<ASSIGN   4313<<ASSIGN   4468<<ASSIGN   4560<<ASSIGN   4566<<ASSIGN   4670<<ASSIGN   4881<<ASSIGN
      4970<<ASSIGN   5112<<ASSIGN
B$JIT.ERR.CODE
      2843**DCL      4469<<ASSIGN
B$JIT.ERR.MID
      2843**DCL      2843--REDEF
B$JIT.JUNK
      2961**DCL      4470<<ASSIGN   4470>>ASSIGN
B$JIT.MAXENQ
      3034**DCL      4967>>IF
B$JIT.ORIGINATOR_PORT.FROM_CR
      3032**DCL      3032--REDEF    3033--REDEF
B$JIT.SYSID
      2842**DCL      4590>>IF
B$JIT.TSLINE
      3030**DCL      3031--REDEF
B$JIT$
      4086**DCL      2837--IMP-PTR  4184>>ASSIGN   4190>>ASSIGN   4194>>IF       4200>>ASSIGN   4279>>ASSIGN
      4291>>ASSIGN   4298>>ASSIGN   4313>>ASSIGN   4468>>ASSIGN   4469>>ASSIGN   4470>>ASSIGN   4470>>ASSIGN
      4560>>ASSIGN   4566>>ASSIGN   4590>>IF       4617>>IF       4618>>ASSIGN   4619>>IF       4621>>IF
      4670>>ASSIGN   4881>>ASSIGN   4967>>IF       4970>>ASSIGN   5112>>ASSIGN
B$PS0$
      4073**DCL      4180>>ASSIGN   4508>>ASSIGN
B$PS1$
      4074**DCL      5087>>ASSIGN   5089>>ASSIGN
B$PS2$
      4075**DCL      5098>>ASSIGN
B$ROSEG.ECCB
      3054**DCL      4189--IF
B$ROSEG.NUMDCBS
      3050**DCL      4620>>DOINDEX  5102>>IF
B$ROSEG$
      4084**DCL      4189>>IF       4620>>DOINDEX  5102>>IF
PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:190  
B$U.ENQ.COUNT
      2430**DCL      4967>>IF       4973<<ASSIGN   4973>>ASSIGN   4998<<ASSIGN   4998>>ASSIGN
B$U.ENQ.WAIT
      2431**DCL      4362<<ASSIGN   4444<<ASSIGN   4491>>ASSIGN   4667<<ASSIGN
B$U.MISC
      2432**DCL      2433--REDEF
B$USER.ENQ.COUNT
      2506**DCL      4390>>IF       4390>>IF
B$USER.ENQ.WAIT
      2507**DCL      4400>>ASSIGN
B$USER.MISC
      2508**DCL      2509--REDEF
B$USRT$
      2520**DCL      4390>>IF       4390>>IF       4400>>ASSIGN
BAD_FPT
      4204**LABEL    4181--CALLALT  4509--CALLALT
BOMB IN PROCEDURE DEQ_PROC
      4727**LABEL    4702--CALLALT
BREAK
      4436**LABEL    4433--CALLALT  4495--GOTO
CHECK
      5124**PROC     4259--CALL
CRD
      3865**DCL      4304<<ASSIGN   4335<<ASSIGN   4339<<ASSIGN   4339>>ASSIGN   4350<<ASSIGN   4350>>ASSIGN
      4371<<ASSIGN   4373<<ASSIGN   4377>>IF       4694<<ASSIGN   5011<<ASSIGN   5016<<ASSIGN   5016>>ASSIGN
      5019<<ASSIGN   5019>>ASSIGN   5034>>IF
CRD.ALLOC
      3866**DCL      4697>>IF       4713>>IF       4715>>ASSIGN
CRD.CANCEL_EVENT
      3867**DCL      4699>>IF
CRD.SEND_MESSAGE
      3868**DCL      4708>>IF
CRD_
      3870**DCL      4694>>ASSIGN
DEQ
      4512**LABEL    4502--GOTO
PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:191  
DEQID
      4525**LABEL    4643--CALLALT
DEQID IN PROCEDURE DEQ_PROC
      4688**LABEL    4731--GOTO
DEQID0
      4622**LABEL    4623--GOTO     4652--GOTO
DEQ_PROC
      4680**PROC     4526--CALL     4539--CALL     4637--CALL
DEQ_QID IN PROCEDURE DEQ_PROC
      4730**ENTRY    4542--CALL
DERNAME IN PROCEDURE DEQ_PROC
      4722**LABEL    4728--GOTO
DLKNTRY@
      3843**DCL      4366<<ASSIGN   4387>>IF       4388<<ASSIGN   4390>>IF       4393<<ASSIGN   4396>>IF
      4402>>IF       4418>>IF       4419>>ASSIGN   4420>>ASSIGN   4421>>CALL
DLOCK
      4659**LABEL    4344--GOTO     4387--GOTO     4396--GOTO
DOLIST$
      3804**DCL      4144>>ASSIGN   4150>>ASSIGN   4622>>IF
DOM_USER
      3854**DCL      3857--REDEF
DOM_USER.DOMAIN#
      3855**DCL      4455>>ASSIGN
D_U
      3857**DCL      4258<<ASSIGN   4493<<ASSIGN   4519<<ASSIGN   4539>>IF       4556>>IF       4583<<ASSIGN
      4590>>IF       4591<<ASSIGN   4616<<ASSIGN   4626<<ASSIGN   4633>>IF       4640<<ASSIGN   4651<<ASSIGN
      4728>>IF       4876>>IF       4967>>IF       4980>>ASSIGN
ECCI
      3858**DCL      5055--CALL
ECCI.MESSAGE
      3860**DCL      5053<<ASSIGN
ECCI.WORDS
      3859**DCL      5052<<ASSIGN
ENQ
      4247**LABEL    4197--GOTO
ENQ_ERR
PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:192  
      4157**LABEL    4542--CALLALT
ERR
      3861**DCL      3862--REDEF    4196>>ASSIGN   4429<<ASSIGN   4436<<ASSIGN   4456<<ASSIGN   4469>>ASSIGN
      4470>>IF       4494<<ASSIGN   4620<<DOINDEX  4621--IF       4621--IF       4622--IF       4622--IF
      4692<<ASSIGN   4693<<ASSIGN   4693>>ASSIGN   4694>>ASSIGN   4772<<ASSIGN   4773>>IF       4774>>IF
      4798<<ASSIGN   4799>>DOWHILE  4800>>IF       4801>>IF       4804<<ASSIGN   4804>>ASSIGN   4807>>IF
      4808>>IF       4947<<ASSIGN   4948>>DOWHILE  4956>>ASSIGN   4958<<ASSIGN   4958>>ASSIGN   5051<<ASSIGN
      5055<>CALL     5099<<ASSIGN
ERRCODE
      3982**DCL      4468>>ASSIGN
F$DCB.ACTPOS
      3126**DCL      3126--REDEF
F$DCB.ARS
      3101**DCL      3101--REDEF
F$DCB.ASN
      3116**DCL      5104>>IF
F$DCB.ATTR
      3119**DCL      3120--REDEF
F$DCB.BORROW
      3134**DCL      3134--REDEF    3134--REDEF    3134--REDEF
F$DCB.CFU$
      3135**DCL      4619--IF       4622>>IF       5108>>ASSIGN
F$DCB.DCBNAME.L
      3148**DCL      3148--IMP-SIZ
F$DCB.EOMCHAR
      3105**DCL      3105--REDEF
F$DCB.FCD
      3114**DCL      4622>>IF       5104>>IF
F$DCB.FFLG.EXEC
      3106**DCL      5104>>IF
F$DCB.FLDID
      3129**DCL      3129--REDEF
F$DCB.FORM$
      3123**DCL      3123--REDEF
F$DCB.FSECT
      3139**DCL      3139--REDEF
PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:193  
F$DCB.FSN
      3116**DCL      3116--REDEF    3116--REDEF    3117--REDEF
F$DCB.HEADER$
      3122**DCL      3122--REDEF
F$DCB.IXTNSIZE
      3120**DCL      3120--REDEF
F$DCB.LASTSTA$
      3110**DCL      3110--REDEF
F$DCB.LVL
      3135**DCL      3135--REDEF
F$DCB.NAME.C
      3110**DCL      3110--REDEF
F$DCB.NOEOF
      3131**DCL      3131--REDEF
F$DCB.NRECS
      3121**DCL      3121--REDEF
F$DCB.NRECX
      3140**DCL      3140--REDEF
F$DCB.OHDR
      3132**DCL      3132--REDEF
F$DCB.ORG
      3115**DCL      3115--REDEF
F$DCB.PRECNO
      3138**DCL      3138--REDEF
F$DCB.RCSZ
      3143**DCL      3143--REDEF
F$DCB.RES
      3111**DCL      3111--REDEF
F$DCB.SETX
      3123**DCL      3123--REDEF
F$DCB.TAB$
      3122**DCL      3123--REDEF
F$DCB.TDA
      3137**DCL      3137--REDEF
F$DCB.WSN
      3112**DCL      3112--REDEF
PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:194  
F$DCB.WSR
      3118**DCL      4617>>IF       4618>>ASSIGN   5104>>IF
FPT$DEQ_V
      4081**DCL      4508>>ASSIGN
FPT$DEQ_V.CANCEL
      4081**DCL      4510>>ASSIGN
FPT$DEQ_V.RELRES
      4081**DCL      4510>>ASSIGN
FPT$DEQ_V.SELECTIVE
      4081**DCL      4686>>IF
FPT$DEQ_V.SELECT_ID
      4081**DCL      4686>>IF
FPT$ENQ_V
      4077**DCL      4180>>ASSIGN
HFC$LOCK
      3397**DCL-ENT  4141--CALL     4253--CALL     4442--CALL     4517--CALL     4631--CALL
HFC$UNLOCK
      3397**DCL-ENT  5076--CALL
HFF$NILERASE
      4098**DCL-ENT  5086--CALL     5097--CALL
IRM_SYSID
      4087**DCL      4590>>IF
MENQ
      4243**LABEL    4214--GOTO     4224--GOTO     4234--GOTO
MENQNONE.V
      3920**DCL      3919--DCLINIT  4223>>ASSIGN
MENQNONEB.V
      3953**DCL      3952--DCLINIT  4233>>ASSIGN
MENQSHARE.V
      3896**DCL      3895--DCLINIT  4213>>ASSIGN
MENQSHAREB.V
      3976**DCL      3975--DCLINIT  4243>>ASSIGN
MESSAGE
      3863**DCL      4196<<ASSIGN   4479<<ASSIGN   4710>>ASSIGN   5046<<ASSIGN   5099>>ASSIGN
MRNAME
      3926**DCL      3928--DCLINIT  4245>>ASSIGN   4500>>ASSIGN   4615>>ASSIGN   4648>>ASSIGN
PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:195  
MRNAME.LENGTH
      3929**DCL      3930--REDEF
MRNAME.RHASH
      3931**DCL      3932--REDEF
NEWNTRY
      4330**LABEL    4263--GOTO     4268--GOTO     4327--GOTO
NNODE.NCHAIN@
      3660**DCL      4842>>ASSIGN
NODE.TYPE
      3643**DCL      4146>>IF       4588>>IF
NODE@
      3842**DCL      4320<<ASSIGN   4321>>IF       4322>>ASSIGN   4323>>ASSIGN   4324>>ASSIGN   4325>>ASSIGN
      4334<<ASSIGN   4336>>DOWHILE  4337>>IF       4338>>IF       4339>>ASSIGN   4340>>IF       4341>>IF
      4341>>IF       4350>>ASSIGN   4354<<ASSIGN   4354>>ASSIGN   4356<<ASSIGN   4374<<ASSIGN   4375>>DOWHILE
      4376>>IF       4377>>IF       4377>>IF       4377>>IF       4380>>IF       4381<<ASSIGN   4382>>DOWHILE
      4383>>ASSIGN   4384>>ASSIGN   4385<<ASSIGN   4400>>ASSIGN   4410<<ASSIGN   4410>>ASSIGN   4412<<ASSIGN
      4585<<ASSIGN   4587>>DOWHILE  4841<<ASSIGN   4842>>ASSIGN   4844>>ASSIGN   4845>>ASSIGN   4846>>ASSIGN
      4940<<ASSIGN   4941>>ASSIGN   4943>>ASSIGN   4944>>ASSIGN   4945>>ASSIGN   4946>>ASSIGN   4949>>ASSIGN
      4952<<ASSIGN   4953>>ASSIGN   4955>>ASSIGN   4956>>ASSIGN   4957>>ASSIGN   4960>>ASSIGN   5009<<ASSIGN
      5012>>DOWHILE  5013>>DOCASE   5015>>IF       5015>>ASSIGN   5016>>ASSIGN   5017<<ASSIGN   5017>>ASSIGN
      5019>>ASSIGN   5019>>ASSIGN   5021<<ASSIGN   5021>>ASSIGN   5023>>ASSIGN   5024<<ASSIGN   5032<<ASSIGN
      5033>>IF       5033<<ASSIGN   5034>>IF
NODEQ
      4557**LABEL    4524--GOTO     4526--CALLALT
NODWN
      4670**LABEL    4295--GOTO     4302--GOTO     4317--GOTO
NOENQ
      4651**LABEL    4262--CALLALT  4267--CALLALT
NOMEM
      4651**LABEL    4259--CALLALT  4271--CALLALT  4272--CALLALT
NOMEM IN PROCEDURE CHECK
      5131**LABEL    5129--CALLALT
NOPS1 IN PROCEDURE LID_SUBROUTINES
      5092**LABEL    5086--CALLALT
NOPS2 IN PROCEDURE LID_SUBROUTINES
      5099**LABEL    5097--CALLALT
PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:196  
NOTNOW
      4358**LABEL    4353--GOTO     4358--CALLALT
OCRD
      3862**DCL      4370<<ASSIGN   4371>>ASSIGN   4377>>IF
PLUGH.ADR
      3806**DCL      4247>>ASSIGN
PLUGH.EVID
      3807**DCL      4247<<ASSIGN
PRE@ IN PROCEDURE LID_SUBROUTINES
      4738**DCL      4783<<ASSIGN   4784>>IF       4787>>IF       4788>>IF       4791>>IF       4792>>IF
      4795>>IF       4796>>IF       4797<<ASSIGN   4797>>ASSIGN   4800>>IF       4801>>IF       4805<<ASSIGN
      4805>>ASSIGN   4807>>IF       4808>>IF       4949<<ASSIGN   4957>>ASSIGN
PTR$
      3864**DCL      5108<<ASSIGN
P_RESOURCE.RES
      3304**DCL      3371--REDEF
P_RESOURCE.RES.ENQ.CURRENT
      3346**DCL      5067<<ASSIGN   5068>>IF       5070>>ASSIGN   5071>>IF       5073>>ASSIGN
P_RESOURCE.RES.ENQ.MIN
      3348**DCL      5071>>IF       5073<<ASSIGN
P_RESOURCE.RES.ENQ.PEAK
      3347**DCL      5068>>IF       5070<<ASSIGN
P_RESOURCE$
      3269**DCL      3272--IMP-PTR  5067>>ASSIGN   5068>>IF       5068>>IF       5070>>ASSIGN   5070>>ASSIGN
      5071>>IF       5071>>IF       5073>>ASSIGN   5073>>ASSIGN
QENTRY
      3714**DCL      4979<<ASSIGN
QENTRY.DLKBLNK@
      3740**DCL      4394>>ASSIGN   4407<<ASSIGN
QENTRY.DLKFLNK@
      3739**DCL      4363<<ASSIGN   4383>>ASSIGN   4384<<ASSIGN   4402>>IF       4405<<ASSIGN   4414>>ASSIGN
      4415<<ASSIGN
QENTRY.DOM_USER
      3733**DCL      3736--REDEF
QENTRY.DOM_USER.DOMAIN#
      3734**DCL      4420<<ASSIGN   4455<<ASSIGN   5034>>IF       5051>>ASSIGN
PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:197  
QENTRY.DOM_USER.USER
      3735**DCL      4380>>IF       4390>>IF       4390>>IF       4400>>ASSIGN   4421<>CALL     4541>>IF
      4588>>IF       4702<>CALL     4877>>IF       5043>>IF       5044<>CALL     5055<>CALL     5058>>IF
QENTRY.D_U
      3736**DCL      4493>>ASSIGN   4876>>IF       4980<<ASSIGN   4997>>IF
QENTRY.EVENT_ID
      3741**DCL      4150>>ASSIGN   4306<<ASSIGN   4332<<ASSIGN   4686>>IF
QENTRY.QCHAIN@
      3737**DCL      4319>>DOWHILE  4320>>ASSIGN   4322<<ASSIGN   4323<<ASSIGN   4323>>ASSIGN   4324<<ASSIGN
      4354>>ASSIGN   4410>>ASSIGN   4544>>ASSIGN   4889>>ASSIGN   4984<<ASSIGN   4995<<ASSIGN   4995>>ASSIGN
      5017>>ASSIGN   5021>>ASSIGN
QENTRY.REQUEST
      3720**DCL      3723--REDEF    4155<<ASSIGN
QENTRY.REQ_
      3723**DCL      4286>>IF       4286>>IF       4290>>IF       4339>>ASSIGN   4341>>IF       4370>>ASSIGN
      4377>>IF       4981<<ASSIGN   5016>>ASSIGN   5019>>ASSIGN   5033>>ASSIGN   5040<<ASSIGN
QENTRY.RNAME1@
      3738**DCL      4157>>ASSIGN   4374>>ASSIGN   4492>>ASSIGN   4592>>ASSIGN   4983<<ASSIGN
QENTRY.STATE
      3716**DCL      4146>>IF       4151<<ASSIGN   4276>>IF       4321>>IF       4338>>IF       4376>>IF
      4445>>IF       4692>>ASSIGN   4715<<ASSIGN   5013>>DOCASE   5038<<ASSIGN   5054<<ASSIGN
QENTRY.UPGRADE
      3724**DCL      3727--REDEF    4152>>IF       4155>>ASSIGN   4156<<ASSIGN   4276>>IF       4340>>IF
      4341>>IF       4372>>IF       4445>>IF       4460>>IF       4461<<ASSIGN   4672>>IF       4672<<ASSIGN
      4693>>IF       4716<<ASSIGN   5015>>IF       5037>>IF
QENTRY.UPG_
      3727**DCL      4285<<ASSIGN   4286>>IF       4290>>IF       4341>>IF       4350>>ASSIGN   4373>>ASSIGN
      4377>>IF       5019>>ASSIGN   5032>>ASSIGN   5040>>ASSIGN   5041<<ASSIGN
QENTRY.WAIT
      3728**DCL      4305<<ASSIGN   4331<<ASSIGN   4341>>IF       4402>>IF       4419<<ASSIGN   4454>>IF
      4459<<ASSIGN   4668<<ASSIGN   5036>>IF       5047<<ASSIGN
QENTRY@
      3841**DCL      4144<<ASSIGN   4146>>IF       4146>>IF       4150>>ASSIGN   4151>>ASSIGN   4152>>IF
      4155>>ASSIGN   4155>>ASSIGN   4156>>ASSIGN   4157>>ASSIGN   4272>>IF       4276>>IF       4276>>IF
      4285>>ASSIGN   4286>>IF       4286>>IF       4286>>IF       4290>>IF       4290>>IF       4305>>ASSIGN
      4306>>ASSIGN   4319>>DOWHILE  4320>>ASSIGN   4323>>ASSIGN   4324>>ASSIGN   4331>>ASSIGN   4332>>ASSIGN
PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:198  
      4337>>IF       4341>>IF       4341>>IF       4362>>ASSIGN   4363>>ASSIGN   4367>>ASSIGN   4368>>ASSIGN
      4388>>ASSIGN   4389>>DOWHILE  4396>>IF       4445>>IF       4445>>IF       4454>>IF       4455>>ASSIGN
      4459>>ASSIGN   4460>>IF       4461>>ASSIGN   4491<<ASSIGN   4492>>ASSIGN   4493>>ASSIGN   4537<<ASSIGN
      4539>>IF       4540>>DOWHILE  4541>>IF       4543>>ASSIGN   4544<<ASSIGN   4586<<ASSIGN   4587>>DOWHILE
      4588>>IF       4588>>IF       4592>>ASSIGN   4599<<ASSIGN   4599>>ASSIGN   4668>>ASSIGN   4672>>IF
      4672>>ASSIGN   4684>>IF       4686>>IF       4692>>ASSIGN   4693>>IF       4702>>CALL     4702>>CALL
      4715>>ASSIGN   4716>>ASSIGN   4872<<ASSIGN   4875>>DOWHILE  4876>>IF       4877>>IF       4885<<ASSIGN
      4888>>ASSIGN   4889<<ASSIGN   4889>>ASSIGN   4976<<ASSIGN   4977>>ASSIGN   4979>>ASSIGN   4980>>ASSIGN
      4981>>ASSIGN   4983>>ASSIGN   4984>>ASSIGN   4995>>ASSIGN   4997>>IF       5000>>ASSIGN   5001>>ASSIGN
      5002>>ASSIGN   5010<<ASSIGN   5015>>IF       5015<<ASSIGN   5023>>IF       5023<<ASSIGN   5027>>IF
      5032>>ASSIGN   5033>>ASSIGN   5034>>IF       5036>>IF       5037>>IF       5038>>ASSIGN   5040>>ASSIGN
      5040>>ASSIGN   5041>>ASSIGN   5043>>IF       5044>>CALL     5047>>ASSIGN   5051>>ASSIGN   5054>>ASSIGN
      5055>>CALL     5055>>CALL     5058>>IF
QENTRY_DQ IN PROCEDURE LID_SUBROUTINES
      4992**ENTRY    4464--CALL     4673--CALL     4713--CALL
QENTRY_I IN PROCEDURE LID_SUBROUTINES
      4964**ENTRY    4272--CALL
QENTRY_L IN PROCEDURE LID_SUBROUTINES
      4868**ENTRY    4271--CALL     4463--CALL     4683--CALL
QENTRY_PRE@
      3840**DCL      4322>>ASSIGN   4325<<ASSIGN   4365>>IF       4538<<ASSIGN   4543<<ASSIGN   4544>>ASSIGN
      4870<<ASSIGN   4888<<ASSIGN   4962<<ASSIGN   4984>>ASSIGN   4995>>ASSIGN
QID
      3674**DCL      4901<<ASSIGN
QID.HCHAIN@
      3678**DCL      4746>>ASSIGN   4754>>ASSIGN   4854<<ASSIGN   4854>>ASSIGN   4903<<ASSIGN   4903>>ASSIGN
      4904<<ASSIGN
QID.NAME
      3681**DCL      4593<>CALL     4597<>CALL     4750>>IF       4751>>IF       4902<<ASSIGN
QID.XCHAIN@
      3677**DCL      4531>>ASSIGN   4594>>ASSIGN   4770>>ASSIGN   4852>>IF
QID@
      3835**DCL      4365>>IF       4368<<ASSIGN   4369>>DOWHILE  4370>>ASSIGN   4372>>IF       4373>>ASSIGN
      4374>>ASSIGN   4377>>IF       4381>>ASSIGN   4389>>DOWHILE  4390>>IF       4393>>ASSIGN   4394<<ASSIGN
      4394>>ASSIGN   4407>>ASSIGN   4414>>ASSIGN   4415>>ASSIGN   4416<<ASSIGN   4530>>ASSIGN   4531>>ASSIGN
      4556>>IF       4592<<ASSIGN   4593>>CALL     4594>>ASSIGN   4597>>CALL     4746<<ASSIGN   4749>>DOWHILE
PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:199  
      4750>>IF       4751>>IF       4751<<ASSIGN   4753>>ASSIGN   4754<<ASSIGN   4754>>ASSIGN   4769>>ASSIGN
      4770>>ASSIGN   4852>>IF       4854>>ASSIGN   4856>>ASSIGN   4857>>ASSIGN   4858>>ASSIGN   4898<<ASSIGN
      4899>>ASSIGN   4901>>ASSIGN   4902>>ASSIGN   4903>>ASSIGN   4904>>ASSIGN   4905>>ASSIGN   4936>>ASSIGN
QID_F
      4258**LABEL    4261--CALLALT
QID_I IN PROCEDURE LID_SUBROUTINES
      4894**ENTRY    4262--CALL
QID_L IN PROCEDURE LID_SUBROUTINES
      4743**ENTRY    4261--CALL     4521--CALL     4635--CALL     4643--CALL
QID_PRE@
      3834**DCL      4745<<ASSIGN   4746>>ASSIGN   4753<<ASSIGN   4854>>ASSIGN   4903>>ASSIGN   4904>>ASSIGN
QV
      3830**DCL      4180<<ASSIGN   4213<<ASSIGN   4223<<ASSIGN   4233<<ASSIGN   4243<<ASSIGN   4508<<ASSIGN
      4510--ASSIGN   4510--ASSIGN   4686--IF       4686--IF
QV.DCB#
      3830**DCL      5102>>IF       5103--IF       5104--IF       5104--IF       5104--IF       5104--IF
      5108--ASSIGN
QV.EVENT
      3831**DCL      4247--ASSIGN   4306>>ASSIGN   4332>>ASSIGN
QV.LIMITED_COM
      3830**DCL      4285>>ASSIGN   4981>>ASSIGN
QV.NO_DOWNGRADE
      3830**DCL      4289>>IF
QV.NO_UPGRADE
      3830**DCL      4312>>IF
QV.SHARE
      3830**DCL      4182>>IF       4285>>ASSIGN   4981>>ASSIGN
QV.WAIT
      3830**DCL      4183>>IF       4305>>ASSIGN   4331>>ASSIGN   4341>>IF       4361>>IF
QV.WAIT_TIME
      3831**DCL      4184>>IF       4427>>IF       4433<>CALL
RE_CHECK
      4367**LABEL    4397--GOTO
RHASH@
      3839**DCL      4367<<ASSIGN   4383<<ASSIGN   4385>>ASSIGN   4405>>ASSIGN   4406<<ASSIGN   4407>>ASSIGN
      4531<<ASSIGN   4533>>DOWHILE  4535>>ASSIGN   4548>>ASSIGN   4551>>IF       4551>>ASSIGN   4552<<ASSIGN
PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:200  
      4770<<ASSIGN   4771>>DOWHILE  4772>>ASSIGN   4773<<ASSIGN   4775>>ASSIGN   4776<<ASSIGN   4776>>ASSIGN
      4781>>ASSIGN   4828>>IF       4832<<ASSIGN   4835<<ASSIGN   4836>>ASSIGN   4837>>ASSIGN   4907<<ASSIGN
      4925>>IF       4930>>ASSIGN   4931>>ASSIGN   4934<<ASSIGN
RHASH_PRE@
      3838**DCL      4400<<ASSIGN   4402>>IF       4402>>IF       4402>>IF       4402>>IF       4405>>ASSIGN
      4406>>ASSIGN   4414<<ASSIGN   4416>>ASSIGN   4530<<ASSIGN   4551<<ASSIGN   4552>>ASSIGN   4769<<ASSIGN
      4775<<ASSIGN   4831>>ASSIGN   4836>>ASSIGN   4905<<ASSIGN   4926>>ASSIGN   4927>>ASSIGN   4932>>ASSIGN
RNAME
      3826**DCL      4522--IF       4686--IF
RNAME.LEN
      3827**DCL      5087>>ASSIGN
RNAME.TEXT
      3828**DCL      4791>>IF       4792>>IF       4795>>IF       4796>>IF       4800>>IF       4801>>IF
      4807>>IF       4808>>IF       4945>>ASSIGN   4956>>ASSIGN   5090>>ASSIGN
RNAME1
      3685**DCL      4918<<ASSIGN
RNAME1.COMM
      3693**DCL      4479>>ASSIGN   4710<<ASSIGN   5046>>ASSIGN   5053>>ASSIGN
RNAME1.NCHAIN@
      3695**DCL      4783>>ASSIGN   4946<<ASSIGN   4960<<ASSIGN
RNAME1.QCHAIN@
      3691**DCL      4334>>ASSIGN   4374>>ASSIGN   4537>>ASSIGN   4595>>IF       4722>>IF       4872>>ASSIGN
      5009>>ASSIGN
RNAME1.RCHAIN@
      3692**DCL      4549>>ASSIGN   4595>>IF       4815>>ASSIGN   4828<<ASSIGN   4828>>ASSIGN   4829>>IF
      4835>>ASSIGN   4921<<ASSIGN   4921>>ASSIGN   4922<<ASSIGN   4930<<ASSIGN
RNAME1.RHASH
      3689**DCL      4772>>ASSIGN   4919<<ASSIGN
RNAME1.RHEAD@
      3694**DCL      4592>>ASSIGN   4936<<ASSIGN
RNAME1.XCHAIN@
      3690**DCL      4552>>ASSIGN   4595>>IF       4776>>ASSIGN   4831<<ASSIGN   4831>>ASSIGN   4836<<ASSIGN
      4837<<ASSIGN   4837>>ASSIGN   4926<<ASSIGN   4926>>ASSIGN   4927<<ASSIGN   4931<<ASSIGN   4931>>ASSIGN
      4932<<ASSIGN
RNAME1@
      3837**DCL      4157<<ASSIGN   4334>>ASSIGN   4479>>ASSIGN   4492<<ASSIGN   4535<<ASSIGN   4536>>DOWHILE
PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:201  
      4537>>ASSIGN   4538>>ASSIGN   4547>>ASSIGN   4548>>IF       4548<<ASSIGN   4549<<ASSIGN   4549>>ASSIGN
      4594<<ASSIGN   4595>>IF       4595>>IF       4595>>IF       4595>>IF       4710>>ASSIGN   4722>>IF
      4781<<ASSIGN   4782>>DOWHILE  4783>>ASSIGN   4814>>ASSIGN   4815<<ASSIGN   4815>>ASSIGN   4821<<ASSIGN
      4828>>IF       4828>>ASSIGN   4829>>IF       4831>>ASSIGN   4835>>ASSIGN   4837>>ASSIGN   4840>>DOWHILE
      4841>>ASSIGN   4842<<ASSIGN   4850<<ASSIGN   4870>>ASSIGN   4872>>ASSIGN   4915<<ASSIGN   4916>>ASSIGN
      4918>>ASSIGN   4919>>ASSIGN   4921>>ASSIGN   4922>>ASSIGN   4926>>ASSIGN   4927>>ASSIGN   4930>>ASSIGN
      4931>>ASSIGN   4932>>ASSIGN   4934>>ASSIGN   4936>>ASSIGN   4946>>ASSIGN   4962>>ASSIGN   4983>>ASSIGN
      5009>>ASSIGN   5046>>ASSIGN   5053>>ASSIGN
RNAME2.COUNT
      3701**DCL      4787>>IF       4788>>IF       4944<<ASSIGN
RNAME2.NCHAIN@
      3703**DCL      4797>>ASSIGN   4957<<ASSIGN
RNAME2.TEXT
      3702**DCL      4791>>IF       4792>>IF       4795>>IF       4796>>IF       4945<<ASSIGN
RNAME3.NCHAIN@
      3710**DCL      4805>>ASSIGN
RNAME3.TEXT
      3709**DCL      4800>>IF       4801>>IF       4807>>IF       4808>>IF       4956<<ASSIGN
RNAME_D IN PROCEDURE LID_SUBROUTINES
      4825**ENTRY    4656--CALL     4724--CALL
RNAME_F
      4268**LABEL    4266--CALLALT
RNAME_I IN PROCEDURE LID_SUBROUTINES
      4910**ENTRY    4267--CALL
RNAME_L IN PROCEDURE LID_SUBROUTINES
      4765**ENTRY    4266--CALL     4523--CALL     4636--CALL
RNAME_NO IN PROCEDURE LID_SUBROUTINES
      4815**LABEL    4788--GOTO     4792--GOTO     4803--GOTO     4810--GOTO     4812--GOTO
RNAME_NXT IN PROCEDURE LID_SUBROUTINES
      4810**LABEL    4785--GOTO     4789--GOTO     4793--GOTO     4802--GOTO
RNAME_PRE@
      3836**DCL      4534<<ASSIGN   4547<<ASSIGN   4768<<ASSIGN   4814<<ASSIGN   4828>>ASSIGN   4850>>ASSIGN
      4906<<ASSIGN   4920>>IF       4921>>ASSIGN   4922>>ASSIGN
S$CU$
      2519**DCL      4362>>ASSIGN   4444>>ASSIGN   4491>>ASSIGN   4667>>ASSIGN   4967>>IF       4973>>ASSIGN
      4973>>ASSIGN   4998>>ASSIGN   4998>>ASSIGN
PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:202  
SC_EQERR_B
      4108**DCL-ENT  4169--CALL     4733--CALL
SC_EQMEM
      4107**DCL-ENT  4659--CALL
SC_FMF98
      4105**DCL-ENT  4569--CALL     4590--CALL
SC_FSERR
      4106**DCL-ENT  4558--CALL     4675--CALL
SSR$REG
      4101**DCL-ENT  4433--CALL
SSR$RUE
      4102**DCL-ENT  4421--CALL     5044--CALL
SSV$EVENT
      4103**DCL-ENT  5055--CALL
SSV$XXDO
      4104**DCL-ENT  4702--CALL
S_CUN
      4096**DCL      4258>>ASSIGN   4380>>IF       4519>>ASSIGN   4541>>IF       4584>>IF       4588>>IF
      4616>>ASSIGN   4640>>ASSIGN   4877>>IF       5043>>IF       5058>>IF
UNLOCK IN PROCEDURE LID_SUBROUTINES
      5064**ENTRY    4171--CALL     4278--CALL     4309--CALL     4426--CALL     4467--CALL     4482--CALL
      4557--CALL     4561--CALL     4565--CALL     4644--CALL     4658--CALL     4674--CALL
UQ$
      3812**DCL      4245<<ASSIGN   4247--ASSIGN   4500<<ASSIGN   4615<<ASSIGN   4648<<ASSIGN   5082<<ASSIGN
UQ$.DEQ_COMMAND
      3823**DCL      4510<<ASSIGN   4512>>IF       4694>>ASSIGN
UQ$.DOMAIN#
      3822**DCL      4189>>IF       4258>>ASSIGN   4341>>IF       4365>>IF       4519>>ASSIGN   4556>>IF
      4560>>IF       4618<<ASSIGN   4640>>ASSIGN   4650<<ASSIGN   4659>>IF       4669<<ASSIGN   4675>>IF
      5083<<ASSIGN   5104>>IF
UQ$.LENC
      3819**DCL      5087<<ASSIGN
UQ$.LENGTH
      3818**DCL      3819--REDEF    3828--IMP-SIZ  4546<<ASSIGN   4566>>IF       4649<<ASSIGN   4722>>IF
      4784>>IF       4787>>IF       4788>>IF       4790>>IF       4791>>IF       4792>>IF       4795>>IF
      4796>>IF       4799>>DOWHILE  4800>>IF       4801>>IF       4807>>IF       4808>>IF       4937>>IF
PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:203  
      4944>>ASSIGN   4945>>ASSIGN   4948>>DOWHILE  4956>>ASSIGN   5088>>IF       5090>>ASSIGN   5090>>ASSIGN
      5094>>IF       5094<<ASSIGN   5126>>IF       5127>>IF
UQ$.MESSAGE$
      3824**DCL      4196>>IF       4196>>ASSIGN   4478>>IF       4479>>ASSIGN   4709>>IF       4710>>ASSIGN
      5045>>IF       5046>>ASSIGN   5096<<ASSIGN   5098<<ASSIGN   5099>>ASSIGN
UQ$.QNAME
      3813**DCL      4246<<ASSIGN   4501<<ASSIGN   4629<<ASSIGN   4750>>IF       4751>>IF       4902>>ASSIGN
      5108--ASSIGN
UQ$.QNAME.KEY
      3815**DCL      4745>>ASSIGN
UQ$.RHASH
      3820**DCL      3821--REDEF    4772>>ASSIGN   4919>>ASSIGN   5091<<ASSIGN   5091>>ASSIGN
UQ$.RHASHC
      3821**DCL      5090<<ASSIGN
UQ$.RNAME$
      3817**DCL      3826--IMP-PTR  4182>>IF       4522>>IF       4566>>IF       4642<<ASSIGN   4686>>IF
      4791>>IF       4792>>IF       4795>>IF       4796>>IF       4800>>IF       4801>>IF       4807>>IF
      4808>>IF       4945>>ASSIGN   4956>>ASSIGN   5085<<ASSIGN   5089<<ASSIGN   5090>>ASSIGN
UQB$DELQID
      4613**ENTRY    4593--CALL
UQB$DELQIDX
      4646**ENTRY    4597--CALL
UQB$E$BAD_DCB
      4011**DCL      5112>>ASSIGN
UQB$E$BAD_TIME
      3997**DCL      4184>>ASSIGN
UQB$E$BAD_UPGRADE
      4060**DCL      4279>>ASSIGN
UQB$E$CRD_ERR
      4032**DCL      4566>>ASSIGN
UQB$E$DLOCK
      4039**DCL      4670>>ASSIGN
UQB$E$ENQ_LIMIT
      4018**DCL      4970>>ASSIGN
UQB$E$MISSING_PARAM
      3990**DCL      4200>>ASSIGN
PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:204  
UQB$E$NOEADDR
      4004**DCL      4190>>ASSIGN
UQB$E$NO_UPGRADE
      4067**DCL      4313>>ASSIGN
UQB$E$PDOMAIN
      4025**DCL      4881>>ASSIGN
UQB$E$UQ_DOWNGRADE
      4046**DCL      4298>>ASSIGN
UQB$E$UQ_NOCHANGE
      4053**DCL      4291>>ASSIGN
UQB$ENQ_EVENT
      4137**ENTRY    5055--CALL
UQC$CHK
      4099**DCL-ENT  5129--CALL
UQ_
      3745**DCL      4586--ASSIGN
UQ_.FREE_BLOCKS
      3752**DCL      4847<<ASSIGN   4847>>ASSIGN   4859<<ASSIGN   4859>>ASSIGN   4897<<ASSIGN   4897>>ASSIGN
      4914<<ASSIGN   4914>>ASSIGN   4939<<ASSIGN   4939>>ASSIGN   4951<<ASSIGN   4951>>ASSIGN   4975<<ASSIGN
      4975>>ASSIGN   5003<<ASSIGN   5003>>ASSIGN   5067>>ASSIGN   5126>>IF       5127>>IF
UQ_.GDS_LOCK
      3747**DCL      4584>>IF       4584<<ASSIGN
UQ_.NEXT_BLOCK@
      3754**DCL      4556>>IF       4845>>ASSIGN   4846<<ASSIGN   4857>>ASSIGN   4858<<ASSIGN   4898>>ASSIGN
      4899<<ASSIGN   4915>>ASSIGN   4916<<ASSIGN   4940>>ASSIGN   4941<<ASSIGN   4952>>ASSIGN   4953<<ASSIGN
      4976>>ASSIGN   4977<<ASSIGN   5001>>ASSIGN   5002<<ASSIGN
UQ_.NEXT_PAGE@
      3748**DCL      3749--REDEF    4585>>ASSIGN
UQ_.TOT_BLOCKS.N
      3750**DCL      5067>>ASSIGN
UQ_ACCESS
      4088**DCL      4286>>IF       4286>>IF       4286>>IF       4339>>ASSIGN   4341>>IF       4350>>ASSIGN
      4377>>IF       4377>>IF       5016>>ASSIGN   5019>>ASSIGN   5019>>ASSIGN
UQ_XLATE
      4094**DCL      4341>>IF       4370>>ASSIGN   4373>>ASSIGN   5034>>IF
U_BASE
PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:205  
      3773**DCL      3774--REDEF
U_BASE$
      3774**DCL      3745--IMP-PTR  4146>>IF       4146>>IF       4150>>ASSIGN   4151>>ASSIGN   4152>>IF
      4155>>ASSIGN   4155>>ASSIGN   4156>>ASSIGN   4157>>ASSIGN   4276>>IF       4276>>IF       4285>>ASSIGN
      4286>>IF       4286>>IF       4286>>IF       4290>>IF       4290>>IF       4305>>ASSIGN   4306>>ASSIGN
      4319>>DOWHILE  4320>>ASSIGN   4321>>IF       4322>>ASSIGN   4323>>ASSIGN   4323>>ASSIGN   4324>>ASSIGN
      4331>>ASSIGN   4332>>ASSIGN   4334>>ASSIGN   4338>>IF       4339>>ASSIGN   4340>>IF       4341>>IF
      4341>>IF       4341>>IF       4341>>IF       4350>>ASSIGN   4354>>ASSIGN   4363>>ASSIGN   4370>>ASSIGN
      4372>>IF       4373>>ASSIGN   4374>>ASSIGN   4374>>ASSIGN   4376>>IF       4377>>IF       4377>>IF
      4380>>IF       4383>>ASSIGN   4384>>ASSIGN   4390>>IF       4390>>IF       4394>>ASSIGN   4400>>ASSIGN
      4402>>IF       4402>>IF       4405>>ASSIGN   4407>>ASSIGN   4410>>ASSIGN   4414>>ASSIGN   4415>>ASSIGN
      4419>>ASSIGN   4420>>ASSIGN   4421>>CALL     4445>>IF       4445>>IF       4454>>IF       4455>>ASSIGN
      4459>>ASSIGN   4460>>IF       4461>>ASSIGN   4479>>ASSIGN   4492>>ASSIGN   4493>>ASSIGN   4531>>ASSIGN
      4537>>ASSIGN   4541>>IF       4544>>ASSIGN   4549>>ASSIGN   4552>>ASSIGN   4556>>IF       4584>>IF
      4584>>ASSIGN   4585>>ASSIGN   4588>>IF       4588>>IF       4592>>ASSIGN   4592>>ASSIGN   4593>>CALL
      4594>>ASSIGN   4595>>IF       4595>>IF       4595>>IF       4597>>CALL     4668>>ASSIGN   4672>>IF
      4672>>ASSIGN   4686>>IF       4692>>ASSIGN   4693>>IF       4702>>CALL     4702>>CALL     4710>>ASSIGN
      4715>>ASSIGN   4716>>ASSIGN   4722>>IF       4746>>ASSIGN   4750>>IF       4751>>IF       4754>>ASSIGN
      4770>>ASSIGN   4772>>ASSIGN   4776>>ASSIGN   4783>>ASSIGN   4787>>IF       4788>>IF       4791>>IF
      4792>>IF       4795>>IF       4796>>IF       4797>>ASSIGN   4800>>IF       4801>>IF       4805>>ASSIGN
      4807>>IF       4808>>IF       4815>>ASSIGN   4828>>ASSIGN   4828>>ASSIGN   4829>>IF       4831>>ASSIGN
      4831>>ASSIGN   4835>>ASSIGN   4836>>ASSIGN   4837>>ASSIGN   4837>>ASSIGN   4842>>ASSIGN   4844>>ASSIGN
      4845>>ASSIGN   4845>>ASSIGN   4846>>ASSIGN   4847>>ASSIGN   4847>>ASSIGN   4852>>IF       4854>>ASSIGN
      4854>>ASSIGN   4856>>ASSIGN   4857>>ASSIGN   4857>>ASSIGN   4858>>ASSIGN   4859>>ASSIGN   4859>>ASSIGN
      4872>>ASSIGN   4876>>IF       4877>>IF       4889>>ASSIGN   4897>>ASSIGN   4897>>ASSIGN   4898>>ASSIGN
      4899>>ASSIGN   4899>>ASSIGN   4901>>ASSIGN   4902>>ASSIGN   4903>>ASSIGN   4903>>ASSIGN   4904>>ASSIGN
      4914>>ASSIGN   4914>>ASSIGN   4915>>ASSIGN   4916>>ASSIGN   4916>>ASSIGN   4918>>ASSIGN   4919>>ASSIGN
      4921>>ASSIGN   4921>>ASSIGN   4922>>ASSIGN   4926>>ASSIGN   4926>>ASSIGN   4927>>ASSIGN   4930>>ASSIGN
      4931>>ASSIGN   4931>>ASSIGN   4932>>ASSIGN   4936>>ASSIGN   4939>>ASSIGN   4939>>ASSIGN   4940>>ASSIGN
      4941>>ASSIGN   4941>>ASSIGN   4943>>ASSIGN   4944>>ASSIGN   4945>>ASSIGN   4946>>ASSIGN   4951>>ASSIGN
      4951>>ASSIGN   4952>>ASSIGN   4953>>ASSIGN   4953>>ASSIGN   4955>>ASSIGN   4956>>ASSIGN   4957>>ASSIGN
      4960>>ASSIGN   4975>>ASSIGN   4975>>ASSIGN   4976>>ASSIGN   4977>>ASSIGN   4977>>ASSIGN   4979>>ASSIGN
      4980>>ASSIGN   4981>>ASSIGN   4983>>ASSIGN   4984>>ASSIGN   4995>>ASSIGN   4995>>ASSIGN   4997>>IF
      5000>>ASSIGN   5001>>ASSIGN   5001>>ASSIGN   5002>>ASSIGN   5003>>ASSIGN   5003>>ASSIGN   5009>>ASSIGN
      5013>>DOCASE   5015>>IF       5016>>ASSIGN   5017>>ASSIGN   5019>>ASSIGN   5019>>ASSIGN   5021>>ASSIGN
      5032>>ASSIGN   5033>>ASSIGN   5034>>IF       5036>>IF       5037>>IF       5038>>ASSIGN   5040>>ASSIGN
PL6.E3A0      #001=UQB$EDPR File=UQB$EDPR.:E05TSI                                WED 07/30/97 07:02 Page:206  
      5040>>ASSIGN   5041>>ASSIGN   5043>>IF       5044>>CALL     5046>>ASSIGN   5047>>ASSIGN   5051>>ASSIGN
      5053>>ASSIGN   5054>>ASSIGN   5055>>CALL     5055>>CALL     5058>>IF       5067>>ASSIGN   5067>>ASSIGN
      5126>>IF       5127>>IF
U_LOCK
      3774**DCL      4141<>CALL     4253<>CALL     4442<>CALL     4517<>CALL     4631<>CALL     5076<>CALL
U_QENTRY_INIT
      3772**DCL      4979>>ASSIGN
U_QID_INIT
      3770**DCL      4901>>ASSIGN
U_RNAME1_INIT
      3771**DCL      4918>>ASSIGN
