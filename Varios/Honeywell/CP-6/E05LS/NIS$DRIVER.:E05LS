VERSION E05

PL6.E3A0      #001=NIS$MASK File=NIS$DRIVER.:E05TSI                              WED 07/30/97 03:36 Page:1    
        1        1        /*M* NIS$DRIVER - START I/O ROUTINES */
        2        2        /*T***********************************************************/
        3        3        /*T*                                                         */
        4        4        /*T* Copyright (c) Bull HN Information Systems Inc., 1997    */
        5        5        /*T*                                                         */
        6        6        /*T***********************************************************/
        7        7        /*X* DMR */
        8        8        /*F*    NAME:    NIS$DRIVE
        9        9                DESCRIPTION:   Contains entry points for NIS$DRIVER and NIS$MASK.
       10       10                                                                           */
       11       11        /*D*    NAME:    NIS$MASK
       12       12                CALL:    CALL NIS$MASK(DQH,IMXCONTYP)
       13       13                INPUT:   DQH
       14       14                         IMXCONTYP - IMX CCW (selects type of connect)
       15       15                ENVIRONMENT:   SQH is locked.
       16       16                DESCRIPTION:   For non-IMX IO processors, NIS$MASK sets the
       17       17                               PCW.MASK, calls NIM$CONNECT, and resets the mask bit.
       18       18                               For the IMX, the appropriate type of connect is set up
       19       19                               and NIM$IMXCONNECT is called.
       20       20
       21       21                               Masking may also be performed via an M$TDIO request.  In
       22       22                               the case of non-IMX IO processors, TDP sets the PCW.MASK
       23       23                               and calls NIS$DRIVE via a device scheduler, using a
       24       24                               lost interrupt generated by NII to signal the end of
       25       25                               that operation (since masks and RSOs do not generate
       26       26                               an interrupt).  In the case of an IMX, TDIO passes the
       27       27                               appropriate connect type in IMXMBX.IOSTATUS(0) and
       28       28                               sets REQ.IMX_TDIO_MASK when calling NIS$DRIVE.  When
       29       29                               NIS$DRIVE detects this, control is transferred to
       30       30                               NIS$MASK, but MASKING is not set so that a lost
       31       31                               interrupt will be generated via the NII mechanism.
       32       32                                                                           */
       33       33        NIS$MASK: PROC (DQH, IMXCONTYP);
       34       34        /*
       35       35                Includes
       36       36        */
       37       37        %INCLUDE                HF_LOCK_C ;
PL6.E3A0      #001=NIS$MASK File=NIS$DRIVER.:E05TSI                              WED 07/30/97 03:36 Page:2    
       38       51        %INCLUDE                HF_DATA_R ;
       39       94        %INCLUDE                NI_DATA_C ;
       40      207        %INCLUDE                NI_DATA_R ;
       41      644        %INCLUDE                PM$NI ;
       42      668        /*
       43      669                Parameters
       44      670        */
       45      671        %NI$DQH                 ( NAME=DQH, STCLASS=PARAM ) ;
       46      694    1   DCL 1 IMXCONTYP         UBIN ALIGNED PARAM ;
       47      695        /*
       48      696                Entries
       49      697        */
       50      698    1   DCL 1 NIM$CONNECT       ENTRY ;
       51      699    1   DCL 1 NIM$IMXCONNECT    ENTRY ;
       52      700    1   DCL 1 PMN$COLLECT       ENTRY(3) ;
       53      701    1   DCL 1 SC_NISBADIOQ      ENTRY CONV(2,0) ;
       54      702        /*
       55      703                Symrefs
       56      704        */
       57      705    1   DCL 1 B$REAL$           PTR SYMREF;
       58      706        /*
       59      707                Auto
       60      708        */
       61      709    1   DCL 1 CON$              PTR ALIGNED AUTO ;
       62      710                                %NI$MBX ( NAME =
       63      711              CONNMBX           , STCLASS = AUTO
       64      712                                                                        ) ;
       65      731    1   DCL 1 IMX_CCW           UBIN WORD ALIGNED AUTO ;
       66      732    1   DCL 1 IOM$              PTR ALIGNED AUTO ;
       67      733    1   DCL 1 IOS$              PTR ALIGNED AUTO ;
       68      734    1   DCL 1 MASKING           BIT(1) ALIGNED AUTO ;
       69      735    1   DCL 1 MBX$              PTR ALIGNED AUTO ;
       70      736    1   DCL 1 REQ$              PTR ALIGNED AUTO ;
       71      737    1   DCL 1 TEMP$             PTR ALIGNED AUTO ;
       72      738        /*
       73      739                Based
       74      740        */
PL6.E3A0      #001=NIS$MASK File=NIS$DRIVER.:E05TSI                              WED 07/30/97 03:36 Page:3    
       75      741        %NI$CONNECT             ( NAME=NI$CONNECT,     STCLASS="BASED(NI$CONNECT$)" ) ;
       76      753        %NI$DCT                 ( NAME=DCT,            STCLASS=BASED ) ;
       77      801        %NI$IOM                 ( NAME=IOM,            STCLASS="BASED(IOM$)" ) ;
       78      806        %NI$IOSTAT              ( NAME=IOSTAT,         STCLASS=BASED ) ;
       79      815        %NI$MBX                 ( NAME=MBX,            STCLASS="BASED(MBX$)" ) ;
       80      834        %NI$IMXMBX              ( NAME=NI$IMXMBX,      STCLASS=BASED ) ;
       81      855        %NI$MBX                 ( NAME="NI$MBX(0:63)", STCLASS=BASED ) ;
       82      874        %NI$REQ                 ( NAME=NI$REQ,         STCLASS="BASED(IOS$)" ) ;
       83      899    1   DCL 1 PTRB              BASED ALIGNED,
       84      900    1         2 ADDRESS         UBIN(18) UNAL,
       85      901    1         2 *               BIT(18) UNAL ;
       86      902        %N$REQ                  ( NAME=REQ,            STCLASS="BASED(REQ$)" ) ;
       87      960        /*
       88      961                Constants
       89      962        */
       90      963        %SUB CNNCT_LPW_INIT='000000020001'O;
       91      964        %EJECT;
PL6.E3A0      #001=NIS$MASK File=NIS$DRIVER.:E05TSI                              WED 07/30/97 03:36 Page:4    
       92      965
       93      966    1           MASKING='1'B;
       94      967    1           IMX_CCW=IMXCONTYP;
       95      968    1           IOM$=NI$IOM$(DQH.IOCHAN.IOM);
       96      969    2           IF HW_IMX THEN DO;
       97      970    2   TDIO_MASK: ;
       98      971                   %LOCK ( G#=NI$CONNECT.GATE ) ;
       99      974    2              NI_IMX_CCW=IMX_CCW;
      100      975    2              GOTO IMX_CONT;
      101      976    2              END;
      102      977    2           ELSE DO;
      103      978    2              REQ$=DQH.IO$;
      104      979    2              IOS$=REQ.IOS$;
      105      980    2              IF IMXCONTYP=BITBIN(%IMX_CCW_RSO) THEN /* RESETTING CONTROLLER */
      106      981    2                 NI$REQ.PCW.MASK='7'O;
      107      982    2              ELSE
      108      983    2                 NI$REQ.PCW.MASK.M='1'B;
      109      984    2              GOTO CONT;
      110      985    2              END;
      111      986        %EJECT;
PL6.E3A0      #001=NIS$MASK File=NIS$DRIVER.:E05TSI                              WED 07/30/97 03:36 Page:5    
      112      987        /*D*    NAME:    NIS$DRIVER
      113      988                CALL:    CALL NIS$DRIVER(DQH)
      114      989                ENVIRONMENT:   SQH is locked.
      115      990                DESCRIPTION:   NIS$DRIVER issues the I/O connect for the
      116      991                               request pointed to by DQH.IO$.
      117      992                                                                           */
      118      993    1   NIS$DRIVER: ENTRY(DQH);
      119      994
      120      995    1           MASKING='0'B;
      121      996    1           DQH.PM.CONNCT=DQH.PM.CONNCT+1;
      122      997    1           REQ$=DQH.IO$;
      123      998    1           IF NOT REQ.IOQFLG.INUSE OR NOT REQ.IOQFLG.IOQUED THEN
      124      999        /*S* SCREECH_CODE:  NIS-S$BADIOQ-7
      125     1000             TYPE:          SCREECH
      126     1001             MESSAGE:       Incorrect IOQ processing within IO system.
      127     1002             DESCRIPTION:   The IO system detected an incorrect processing
      128     1003                            sequence on an IOQ packet.  To have an IO
      129     1004                            started, an IOQ packet must be in use and
      130     1005                            must have been scheduled for an IO.
      131     1006        */
      132     1007    1              CALL SC_NISBADIOQ ;
      133     1008    1           REQ.DCT$->DCT.PM.CONNCT=REQ.DCT$->DCT.PM.CONNCT+1;
      134     1009    1           IF DQH.MPC$~=ADDR(NIL) THEN
      135     1010    1              DQH.MPC$->DCT.PM.CONNCT=DQH.MPC$->DCT.PM.CONNCT+1;
      136     1011    1           IOS$=REQ.IOS$;
      137     1012    1           IOM$=NI$IOM$(DQH.IOCHAN.IOM);
      138     1013    2           IF HW_IMX THEN DO;
      139     1014    2              DQH.MBX$=PINCRW(IOS$,%IMX_MBX_OFFSET);
      140     1015    3              IF REQ.IMX_TDIO_MASK THEN DO;
      141     1016    3                 IMX_CCW=BITBIN(DQH.MBX$->NI$IMXMBX.IOSTATUS(0));
      142     1017    3                 GOTO TDIO_MASK;
      143     1018    3                 END;
      144     1019    2              DQH.IOSTATUS$=PINCRW(IOS$,%IMX_STATUS_OFFSET);
      145     1020    2              DQH.IOSTATUS$->IOSTAT='0'B;
      146     1021                   %LOCK ( G#=NI$CONNECT.GATE ) ;
      147     1024    2              IF REQ.PTP~=0 THEN           /* PAGED STANDARD CHANNEL CONNECT */
      148     1025    2                 NI_IMX_CCW=BITBIN(%IMX_CCW_STD|%IMX_CCW_PAGED);
PL6.E3A0      #001=NIS$MASK File=NIS$DRIVER.:E05TSI                              WED 07/30/97 03:36 Page:6    
      149     1026    2              ELSE                         /* NON-PAGED STANDARD CHANNEL CONNECT */
      150     1027    2                 NI_IMX_CCW=BITBIN(%IMX_CCW_STD|%IMX_CCW_NONPAGED);
      151     1028    2   IMX_CONT:  DQH.MBX$->NI$IMXMBX.CLW.SYNC='0'B;
      152     1029    2              NI_IMX_CCW=NI_IMX_CCW+DQH.IOCHANX;
      153     1030    2              NI_CONADDR=DQH.MBXADDR;
      154     1031    2              CALL NIM$IMXCONNECT /* (NI_CONADDR, NI_IMX_CCW) */;
      155     1032    2              END;
      156     1033    2           ELSE DO;
      157     1034    2              DQH.IOSTATUS$->IOSTAT.STATUS='0'B;
      158     1035    2              DQH.IOSTATUS$->IOSTAT.EXTST='0'B;
      159     1036    2   CONT:      MBX$=DQH.MBX$;               /* PAYLOAD CHANNEL */
      160     1037    2              NI$REQ.PCW.CHANNEL=DQH.IOCHAN.CHANNEL;
      161     1038    2              MBX=NI_MBX_INIT;
      162     1039        /*
      163     1040                   MBX.SCW.ADDRESS=POFFW(ADDR(DQH.IOSTATUS$->IOSTAT.STATUS),B$REAL$);
      164     1041                   MBX.LPW.ADDRESS=POFFW(ADDR(NI$REQ.DCW),B$REAL$);
      165     1042
      166     1043                   following three lines replace this - speed up code
      167     1044                   we can do this because IOSTAT and IOS live in low real memory
      168     1045                   (also - IOSTAT.STATUS must be at beginning of IOSTAT block)
      169     1046        */
      170     1047    2              MBX.SCW.ADDRESS=ADDR(DQH.IOSTATUS$)->PTRB.ADDRESS;
      171     1048    2              TEMP$=ADDR(NI$REQ.DCW);
      172     1049    2              MBX.LPW.ADDRESS=ADDR(TEMP$)->PTRB.ADDRESS;
      173     1050
      174     1051    2              MBX.LPW.CONTROL.REL=REQ.IOFLG.LPW23;
      175     1052    2              MBX.LPWX=REQ.LPWX;
      176     1053    2              CON$ = ADDR(IOM.MBX$->NI$MBX(2)) ; /* Connect Channel */
      177     1054                   %LOCK ( G#=NI$CONNECT.GATE ) ;
      178     1057    2              CONNMBX = CON$->MBX ;
      179     1058    2              CONNMBX.LPW = CNNCT_LPW_INIT ; /* #40703 */
      180     1059    3              DO  WHILE  ( CONNMBX.LPW.TALLY ~= 0 ) ;
      181     1060    3                 CONNMBX = CON$->MBX ;
      182     1061    3                 END ;
      183     1062    2              CONNMBX.LPW = CNNCT_LPW_INIT ;
      184     1063        /*
      185     1064                   The following line of code:
PL6.E3A0      #001=NIS$MASK File=NIS$DRIVER.:E05TSI                              WED 07/30/97 03:36 Page:7    
      186     1065
      187     1066                   CONNMBX.LPW.ADDRESS = POFFW ( ADDR(NI$REQ.PCW), B$REAL$ ) ;
      188     1067
      189     1068                   has been replaced by the following two lines of code.  This
      190     1069                   was done as a speed/performance improvement.  This can be
      191     1070                   done because on the IOM/IOP systems, the PCW lives in low
      192     1071                   real memory.
      193     1072                                                                            */
      194     1073    2              TEMP$ = ADDR(NI$REQ.PCW) ;
      195     1074    2              CONNMBX.LPW.ADDRESS = ADDR(TEMP$)->PTRB.ADDRESS ;
      196     1075    2              CONNMBX.DCW = '1'B ;         /*  Done to keep IOM happy  */
      197     1076    2              CON$->MBX   = CONNMBX ;      /* #40703 */
      198     1077    2              CON$->MBX.DCW       = '1'B ; /*  Done to keep IOM happy  */
      199     1078    2              NI_CONADDR          = IOM.ADDRESS ;
      200     1079    2              CALL NIM$CONNECT /* (NI_CONADDR) */;
      201     1080    2              IF  MASKING
      202     1081    2                OR H_S1000_FLG
      203     1082    2              THEN
      204     1083    3              DO  WHILE ( CONNMBX.LPW.TALLY ~= 0 ) ;
      205     1084    3                 CONNMBX = CON$->MBX ;
      206     1085    3                 END ;
      207     1086    2              IF  MASKING
      208     1087    2              THEN
      209     1088    2                 NI$REQ.PCW.MASK = '0'O ;
      210     1089    2              END ;
      211     1090    1           IOM.LASTCON=DQH.IOCHAN.CHANNEL;
      212     1091    1           IOM.CONNCT=IOM.CONNCT+1;
      213     1092                %UNLOCK ( G#=NI$CONNECT.GATE ) ;
      214     1095    1           IF MASKING THEN
      215     1096    1              RETURN;
      216     1097    1           DQH.STATE=%BUSY;
      217     1098    1           DQH.TIMOUT=REQ.TIMOUT;
      218     1099    1           IF DQH.PM.MODE~=%PM_BUSY THEN CALL PMN$COLLECT(DQH.PM,%PM_BUSY);
      219     1100    1           RETURN;
      220     1101    1   END NIS$MASK;
      221     1102        %EOD;

PL6.E3A0      #001=NIS$MASK File=NIS$DRIVER.:E05TSI                              WED 07/30/97 03:36 Page:8    
--  Include file information  --

   PM$NI.:E05TOU  is referenced.
   NI$TABLES.:E05TOU  is referenced.
   N$REQ.:E05TOU  is referenced.
   NI_DATA_R.:E05TOU  cannot be made into a system file and is referenced.
   NI_DATA_C.:E05TOU  is referenced.
   HF_DATA_R.:E05TOU  cannot be made into a system file and is referenced.
   HF_LOCK_C.:E05TOU  cannot be made into a system file and is referenced.
      No diagnostics issued in procedure NIS$MASK.

   Procedure NIS$MASK requires 247 words for executable code.
   Procedure NIS$MASK requires 20 words of local(AUTO) storage.

PL6.E3A0      #001=NIS$MASK File=NIS$DRIVER.:E05TSI                              WED 07/30/97 03:36 Page:9    

 Object Unit name= NIS$MASK                                   File name= NIS$DRIVER.:E05TOU
 UTS= JUL 30 '97 03:36:33.44 WED                              Compiler= PL-6/E31         Sev=      00
 SharedLib= :SHARED_SYSTEM                                    Alt SharedLib=


    ****  Control sections  ****

 Sect   Type Bound  Init  Size OctSiz  Section name(segment info)
    0  RoData even  UTS      4      4  NIS$MASK
    1   Proc  even  none   247    367  NIS$MASK
    2  RoData even  none     3      3  NIS$MASK

    ****  Entry defs  ****

                              Check   Calling
                             calling  sequence
  Sect OctLoc Primary Altret sequence   type   Parms  Name
     1      0   yes            yes      Std        2  NIS$MASK
     1     46                  yes      Std        1  NIS$DRIVER

  ****  Entry refs  ****

         Check        Calling
        calling       sequence
Altret sequence SRef   type   Args  Name
         yes           Std       1 HFC$LOCK
         yes           Std       0 NIM$IMXCONNECT
         yes           Std       0 NIM$CONNECT
         yes           Std       1 HFC$UNLOCK
         yes           Std       3 PMN$COLLECT
                       Std       0 B_CONSPOOL_D
                       nStd      0 X66_AUTO_2
                       nStd      0 X66_ARET
PL6.E3A0      #001=NIS$MASK File=NIS$DRIVER.:E05TSI                              WED 07/30/97 03:36 Page:10   

  ****  Data refs  ****

  Flags:  r = read only, s = secondary
Flgs Name                             Flgs Name                             Flgs Name
     SC_NISBADIOQ                          H_S1000_FLG                           HW_IMX
     N$DCT$$                               N$FQ$                                 NI$CONNECT$
     NI$FQ$                                NI$IBUF$                              NI$IOM$
     NI$RP$                                NI_CONADDR                            NI_IMX_CCW
     NI_MBX_INIT                           B_VECTNIL

  ****  Segment refs  ****

  Flags:  r = read only, s = secondary
Flgs Name                             Flgs Name                             Flgs Name
     ASLENTSID                             ISSID
PL6.E3A0      #001=NIS$MASK File=NIS$DRIVER.:E05TSI                              WED 07/30/97 03:36 Page:11   


        1        1        /*M* NIS$DRIVER - START I/O ROUTINES */
        2        2        /*T***********************************************************/
        3        3        /*T*                                                         */
        4        4        /*T* Copyright (c) Bull HN Information Systems Inc., 1997    */
        5        5        /*T*                                                         */
        6        6        /*T***********************************************************/
        7        7        /*X* DMR */
        8        8        /*F*    NAME:    NIS$DRIVE
        9        9                DESCRIPTION:   Contains entry points for NIS$DRIVER and NIS$MASK.
       10       10                                                                           */
       11       11        /*D*    NAME:    NIS$MASK
       12       12                CALL:    CALL NIS$MASK(DQH,IMXCONTYP)
       13       13                INPUT:   DQH
       14       14                         IMXCONTYP - IMX CCW (selects type of connect)
       15       15                ENVIRONMENT:   SQH is locked.
       16       16                DESCRIPTION:   For non-IMX IO processors, NIS$MASK sets the
       17       17                               PCW.MASK, calls NIM$CONNECT, and resets the mask bit.
       18       18                               For the IMX, the appropriate type of connect is set up
       19       19                               and NIM$IMXCONNECT is called.
       20       20
       21       21                               Masking may also be performed via an M$TDIO request.  In
       22       22                               the case of non-IMX IO processors, TDP sets the PCW.MASK
       23       23                               and calls NIS$DRIVE via a device scheduler, using a
       24       24                               lost interrupt generated by NII to signal the end of
       25       25                               that operation (since masks and RSOs do not generate
       26       26                               an interrupt).  In the case of an IMX, TDIO passes the
       27       27                               appropriate connect type in IMXMBX.IOSTATUS(0) and
       28       28                               sets REQ.IMX_TDIO_MASK when calling NIS$DRIVE.  When
       29       29                               NIS$DRIVE detects this, control is transferred to
       30       30                               NIS$MASK, but MASKING is not set so that a lost
       31       31                               interrupt will be generated via the NII mechanism.
       32       32                                                                           */
       33       33        NIS$MASK: PROC (DQH, IMXCONTYP);

     33  1 000000   000000 700200 xent  NIS$MASK     TSX0  ! X66_AUTO_2
         1 000001   000024 000002                    ZERO    20,2
PL6.E3A0      #001=NIS$MASK File=NIS$DRIVER.:E05TSI                              WED 07/30/97 03:36 Page:12   

       34       34        /*
       35       35                Includes
       36       36        */
       37       37        %INCLUDE                HF_LOCK_C ;
       38       51        %INCLUDE                HF_DATA_R ;
       39       94        %INCLUDE                NI_DATA_C ;
       40      207        %INCLUDE                NI_DATA_R ;
       41      644        %INCLUDE                PM$NI ;
       42      668        /*
       43      669                Parameters
       44      670        */
       45      671        %NI$DQH                 ( NAME=DQH, STCLASS=PARAM ) ;
       46      694    1   DCL 1 IMXCONTYP         UBIN ALIGNED PARAM ;
       47      695        /*
       48      696                Entries
       49      697        */
       50      698    1   DCL 1 NIM$CONNECT       ENTRY ;
       51      699    1   DCL 1 NIM$IMXCONNECT    ENTRY ;
       52      700    1   DCL 1 PMN$COLLECT       ENTRY(3) ;
       53      701    1   DCL 1 SC_NISBADIOQ      ENTRY CONV(2,0) ;
       54      702        /*
       55      703                Symrefs
       56      704        */
       57      705    1   DCL 1 B$REAL$           PTR SYMREF;
       58      706        /*
       59      707                Auto
       60      708        */
       61      709    1   DCL 1 CON$              PTR ALIGNED AUTO ;
       62      710                                %NI$MBX ( NAME =
       63      711              CONNMBX           , STCLASS = AUTO
       64      712                                                                        ) ;
       65      731    1   DCL 1 IMX_CCW           UBIN WORD ALIGNED AUTO ;
       66      732    1   DCL 1 IOM$              PTR ALIGNED AUTO ;
       67      733    1   DCL 1 IOS$              PTR ALIGNED AUTO ;
       68      734    1   DCL 1 MASKING           BIT(1) ALIGNED AUTO ;
       69      735    1   DCL 1 MBX$              PTR ALIGNED AUTO ;
PL6.E3A0      #001=NIS$MASK File=NIS$DRIVER.:E05TSI                              WED 07/30/97 03:36 Page:13   
       70      736    1   DCL 1 REQ$              PTR ALIGNED AUTO ;
       71      737    1   DCL 1 TEMP$             PTR ALIGNED AUTO ;
       72      738        /*
       73      739                Based
       74      740        */
       75      741        %NI$CONNECT             ( NAME=NI$CONNECT,     STCLASS="BASED(NI$CONNECT$)" ) ;
       76      753        %NI$DCT                 ( NAME=DCT,            STCLASS=BASED ) ;
       77      801        %NI$IOM                 ( NAME=IOM,            STCLASS="BASED(IOM$)" ) ;
       78      806        %NI$IOSTAT              ( NAME=IOSTAT,         STCLASS=BASED ) ;
       79      815        %NI$MBX                 ( NAME=MBX,            STCLASS="BASED(MBX$)" ) ;
       80      834        %NI$IMXMBX              ( NAME=NI$IMXMBX,      STCLASS=BASED ) ;
       81      855        %NI$MBX                 ( NAME="NI$MBX(0:63)", STCLASS=BASED ) ;
       82      874        %NI$REQ                 ( NAME=NI$REQ,         STCLASS="BASED(IOS$)" ) ;
       83      899    1   DCL 1 PTRB              BASED ALIGNED,
       84      900    1         2 ADDRESS         UBIN(18) UNAL,
       85      901    1         2 *               BIT(18) UNAL ;
       86      902        %N$REQ                  ( NAME=REQ,            STCLASS="BASED(REQ$)" ) ;
       87      960        /*
       88      961                Constants
       89      962        */
       90      963        %SUB CNNCT_LPW_INIT='000000020001'O;
       91      964        %EJECT;
PL6.E3A0      #001=NIS$MASK File=NIS$DRIVER.:E05TSI                              WED 07/30/97 03:36 Page:14   
       92      965
       93      966    1           MASKING='1'B;

    966  1 000002   400000 236003                    LDQ     -131072,DU
         1 000003   200015 756100                    STQ     MASKING,,AUTO

       94      967    1           IMX_CCW=IMXCONTYP;

    967  1 000004   200004 470500                    LDP0    @IMXCONTYP,,AUTO
         1 000005   000000 235100                    LDA     0,,PR0
         1 000006   200012 755100                    STA     IMX_CCW,,AUTO

       95      968    1           IOM$=NI$IOM$(DQH.IOCHAN.IOM);

    968  1 000007   200003 471500                    LDP1    @DQH,,AUTO
         1 000010   100001 236100                    LDQ     1,,PR1
         1 000011   000031 772000                    QRL     25
         1 000012   000003 376007                    ANQ     3,DL
         1 000013   000000 236006 xsym               LDQ     NI$IOM$,QL
         1 000014   200013 756100                    STQ     IOM$,,AUTO

       96      969    2           IF HW_IMX THEN DO;

    969  1 000015   000000 234000 xsym               SZN     HW_IMX
         1 000016   000026 605000 1                  TPL     s:978

    957  1 000017                       TDIO_MASK    null
       97      970    2   TDIO_MASK: ;
       98      971                   %LOCK ( G#=NI$CONNECT.GATE ) ;

    972  1 000017   000000 630400 xsym               EPPR0   NI$CONNECT$
         1 000020   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 000021   000000 701000 xent               TSX1    HFC$LOCK
         1 000022   000000 011000                    NOP     0

       99      974    2              NI_IMX_CCW=IMX_CCW;

PL6.E3A0      #001=NIS$MASK File=NIS$DRIVER.:E05TSI                              WED 07/30/97 03:36 Page:15   
    974  1 000023   200012 235100                    LDA     IMX_CCW,,AUTO
         1 000024   000000 755000 xsym               STA     NI_IMX_CCW

      100      975    2              GOTO IMX_CONT;

    975  1 000025   000146 710000 1                  TRA     IMX_CONT

      101      976    2              END;
      102      977    2           ELSE DO;

      103      978    2              REQ$=DQH.IO$;

    978  1 000026   100014 236100                    LDQ     12,,PR1
         1 000027   200017 756100                    STQ     REQ$,,AUTO

      104      979    2              IOS$=REQ.IOS$;

    979  1 000030   200017 473500                    LDP3    REQ$,,AUTO
         1 000031   300012 236100                    LDQ     10,,PR3
         1 000032   200014 756100                    STQ     IOS$,,AUTO

      105      980    2              IF IMXCONTYP=BITBIN(%IMX_CCW_RSO) THEN /* RESETTING CONTROLLER */

    980  1 000033   000000 236100                    LDQ     0,,PR0
         1 000034   000000 116000 0                  CMPQ    0
         1 000035   000042 601000 1                  TNZ     s:983

      106      981    2                 NI$REQ.PCW.MASK='7'O;

    981  1 000036   200014 474500                    LDP4    IOS$,,AUTO
         1 000037   070000 236007                    LDQ     28672,DL
         1 000040   400012 256100                    ORSQ    10,,PR4
         1 000041   000045 710000 1                  TRA     s:984

      107      982    2              ELSE
      108      983    2                 NI$REQ.PCW.MASK.M='1'B;

PL6.E3A0      #001=NIS$MASK File=NIS$DRIVER.:E05TSI                              WED 07/30/97 03:36 Page:16   
    983  1 000042   200014 474500                    LDP4    IOS$,,AUTO
         1 000043   040000 236007                    LDQ     16384,DL
         1 000044   400012 256100                    ORSQ    10,,PR4

      109      984    2              GOTO CONT;

    984  1 000045   000175 710000 1                  TRA     CONT

      110      985    2              END;
      111      986        %EJECT;
PL6.E3A0      #001=NIS$MASK File=NIS$DRIVER.:E05TSI                              WED 07/30/97 03:36 Page:17   
      112      987        /*D*    NAME:    NIS$DRIVER
      113      988                CALL:    CALL NIS$DRIVER(DQH)
      114      989                ENVIRONMENT:   SQH is locked.
      115      990                DESCRIPTION:   NIS$DRIVER issues the I/O connect for the
      116      991                               request pointed to by DQH.IO$.
      117      992                                                                           */
      118      993    1   NIS$DRIVER: ENTRY(DQH);

    993  1 000046   000000 700200 xent  NIS$DRIVER   TSX0  ! X66_AUTO_2
         1 000047   000024 000002                    ZERO    20,2

      119      994
      120      995    1           MASKING='0'B;

    995  1 000050   200015 450100                    STZ     MASKING,,AUTO

      121      996    1           DQH.PM.CONNCT=DQH.PM.CONNCT+1;

    996  1 000051   200003 470500                    LDP0    @DQH,,AUTO
         1 000052   000003 054100                    AOS     3,,PR0

      122      997    1           REQ$=DQH.IO$;

    997  1 000053   000014 236100                    LDQ     12,,PR0
         1 000054   200017 756100                    STQ     REQ$,,AUTO

      123      998    1           IF NOT REQ.IOQFLG.INUSE OR NOT REQ.IOQFLG.IOQUED THEN

    998  1 000055   200017 471500                    LDP1    REQ$,,AUTO
         1 000056   100033 234100                    SZN     27,,PR1
         1 000057   000063 605000 1                  TPL     s:1007
         1 000060   100033 236100                    LDQ     27,,PR1
         1 000061   200000 316003                    CANQ    65536,DU
         1 000062   000065 601000 1                  TNZ     s:1008

      124      999        /*S* SCREECH_CODE:  NIS-S$BADIOQ-7
      125     1000             TYPE:          SCREECH
PL6.E3A0      #001=NIS$MASK File=NIS$DRIVER.:E05TSI                              WED 07/30/97 03:36 Page:18   
      126     1001             MESSAGE:       Incorrect IOQ processing within IO system.
      127     1002             DESCRIPTION:   The IO system detected an incorrect processing
      128     1003                            sequence on an IOQ packet.  To have an IO
      129     1004                            started, an IOQ packet must be in use and
      130     1005                            must have been scheduled for an IO.
      131     1006        */
      132     1007    1              CALL SC_NISBADIOQ ;

   1007  1 000063   000000 713400 xsym               CLIMB   SC_NISBADIOQ
         1 000064   000000 600000 xsid               climb   nvectors=         0

      133     1008    1           REQ.DCT$->DCT.PM.CONNCT=REQ.DCT$->DCT.PM.CONNCT+1;

   1008  1 000065   200017 470500                    LDP0    REQ$,,AUTO
         1 000066   000002 471500                    LDP1    2,,PR0
         1 000067   100011 054100                    AOS     9,,PR1

      134     1009    1           IF DQH.MPC$~=ADDR(NIL) THEN

   1009  1 000070   200003 471500                    LDP1    @DQH,,AUTO
         1 000071   100015 236100                    LDQ     13,,PR1
         1 000072   000001 116000 xsym               CMPQ    B_VECTNIL+1
         1 000073   000076 600000 1                  TZE     s:1011

      135     1010    1              DQH.MPC$->DCT.PM.CONNCT=DQH.MPC$->DCT.PM.CONNCT+1;

   1010  1 000074   100015 473500                    LDP3    13,,PR1
         1 000075   300011 054100                    AOS     9,,PR3

      136     1011    1           IOS$=REQ.IOS$;

   1011  1 000076   000012 236100                    LDQ     10,,PR0
         1 000077   200014 756100                    STQ     IOS$,,AUTO

      137     1012    1           IOM$=NI$IOM$(DQH.IOCHAN.IOM);

   1012  1 000100   100001 236100                    LDQ     1,,PR1
PL6.E3A0      #001=NIS$MASK File=NIS$DRIVER.:E05TSI                              WED 07/30/97 03:36 Page:19   
         1 000101   000031 772000                    QRL     25
         1 000102   000003 376007                    ANQ     3,DL
         1 000103   000000 236006 xsym               LDQ     NI$IOM$,QL
         1 000104   200013 756100                    STQ     IOM$,,AUTO

      138     1013    2           IF HW_IMX THEN DO;

   1013  1 000105   000000 234000 xsym               SZN     HW_IMX
         1 000106   000165 605000 1                  TPL     s:1034

      139     1014    2              DQH.MBX$=PINCRW(IOS$,%IMX_MBX_OFFSET);

   1014  1 000107   200014 236100                    LDQ     IOS$,,AUTO
         1 000110   000010 036003                    ADLQ    8,DU
         1 000111   100021 756100                    STQ     17,,PR1

      140     1015    3              IF REQ.IMX_TDIO_MASK THEN DO;

   1015  1 000112   000031 236100                    LDQ     25,,PR0
         1 000113   020000 316007                    CANQ    8192,DL
         1 000114   000121 600000 1                  TZE     s:1019

      141     1016    3                 IMX_CCW=BITBIN(DQH.MBX$->NI$IMXMBX.IOSTATUS(0));

   1016  1 000115   100021 473500                    LDP3    17,,PR1
         1 000116   300010 235100                    LDA     8,,PR3
         1 000117   200012 755100                    STA     IMX_CCW,,AUTO

      142     1017    3                 GOTO TDIO_MASK;

   1017  1 000120   000017 710000 1                  TRA     TDIO_MASK

      143     1018    3                 END;
      144     1019    2              DQH.IOSTATUS$=PINCRW(IOS$,%IMX_STATUS_OFFSET);

   1019  1 000121   200014 236100                    LDQ     IOS$,,AUTO
         1 000122   000020 036003                    ADLQ    16,DU
PL6.E3A0      #001=NIS$MASK File=NIS$DRIVER.:E05TSI                              WED 07/30/97 03:36 Page:20   
         1 000123   100016 756100                    STQ     14,,PR1

      145     1020    2              DQH.IOSTATUS$->IOSTAT='0'B;

   1020  1 000124   100016 473500                    LDP3    14,,PR1
         1 000125   000100 100400                    MLR     fill='000'O
         1 000126   000002 000001 xsym               ADSC9   B_VECTNIL+2              cn=0,n=1
         1 000127   300000 000100                    ADSC9   0,,PR3                   cn=0,n=64

      146     1021                   %LOCK ( G#=NI$CONNECT.GATE ) ;

   1022  1 000130   000000 630400 xsym               EPPR0   NI$CONNECT$
         1 000131   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 000132   000000 701000 xent               TSX1    HFC$LOCK
         1 000133   000000 011000                    NOP     0

      147     1024    2              IF REQ.PTP~=0 THEN           /* PAGED STANDARD CHANNEL CONNECT */

   1024  1 000134   200017 470500                    LDP0    REQ$,,AUTO
         1 000135   000007 235100                    LDA     7,,PR0
         1 000136   000143 600000 1                  TZE     s:1027

      148     1025    2                 NI_IMX_CCW=BITBIN(%IMX_CCW_STD|%IMX_CCW_PAGED);

   1025  1 000137   000001 236000 0                  LDQ     1
         1 000140   000002 276000 xsym               ORQ     B_VECTNIL+2
         1 000141   000000 756000 xsym               STQ     NI_IMX_CCW
         1 000142   000146 710000 1                  TRA     IMX_CONT

      149     1026    2              ELSE                         /* NON-PAGED STANDARD CHANNEL CONNECT */
      150     1027    2                 NI_IMX_CCW=BITBIN(%IMX_CCW_STD|%IMX_CCW_NONPAGED);

   1027  1 000143   000001 236000 0                  LDQ     1
         1 000144   000002 276000 0                  ORQ     2
         1 000145   000000 756000 xsym               STQ     NI_IMX_CCW

      151     1028    2   IMX_CONT:  DQH.MBX$->NI$IMXMBX.CLW.SYNC='0'B;
PL6.E3A0      #001=NIS$MASK File=NIS$DRIVER.:E05TSI                              WED 07/30/97 03:36 Page:21   

   1028  1 000146   200003 470500       IMX_CONT     LDP0    @DQH,,AUTO
         1 000147   000021 471500                    LDP1    17,,PR0
         1 000150   000000 236000 2                  LDQ     0
         1 000151   100006 356100                    ANSQ    6,,PR1

      152     1029    2              NI_IMX_CCW=NI_IMX_CCW+DQH.IOCHANX;

   1029  1 000152   000001 236100                    LDQ     1,,PR0
         1 000153   000022 772000                    QRL     18
         1 000154   000777 376007                    ANQ     511,DL
         1 000155   000000 036000 xsym               ADLQ    NI_IMX_CCW
         1 000156   000000 756000 xsym               STQ     NI_IMX_CCW

      153     1030    2              NI_CONADDR=DQH.MBXADDR;

   1030  1 000157   000021 235100                    LDA     17,,PR0
         1 000160   000000 755000 xsym               STA     NI_CONADDR

      154     1031    2              CALL NIM$IMXCONNECT /* (NI_CONADDR, NI_IMX_CCW) */;

   1031  1 000161   000002 631400 xsym               EPPR1   B_VECTNIL+2
         1 000162   000000 701000 xent               TSX1    NIM$IMXCONNECT
         1 000163   000000 011000                    NOP     0

      155     1032    2              END;

   1032  1 000164   000325 710000 1                  TRA     s:1090

      156     1033    2           ELSE DO;

      157     1034    2              DQH.IOSTATUS$->IOSTAT.STATUS='0'B;

   1034  1 000165   100016 473500                    LDP3    14,,PR1
         1 000166   000000 235003                    LDA     0,DU
         1 000167   000000 236003                    LDQ     0,DU
         1 000170   300000 757100                    STAQ    0,,PR3
PL6.E3A0      #001=NIS$MASK File=NIS$DRIVER.:E05TSI                              WED 07/30/97 03:36 Page:22   

      158     1035    2              DQH.IOSTATUS$->IOSTAT.EXTST='0'B;

   1035  1 000171   100016 473500                    LDP3    14,,PR1
         1 000172   000100 100400                    MLR     fill='000'O
         1 000173   000002 000001 xsym               ADSC9   B_VECTNIL+2              cn=0,n=1
         1 000174   300010 000040                    ADSC9   8,,PR3                   cn=0,n=32

      159     1036    2   CONT:      MBX$=DQH.MBX$;               /* PAYLOAD CHANNEL */

   1036  1 000175   100021 236100       CONT         LDQ     17,,PR1
         1 000176   200016 756100                    STQ     MBX$,,AUTO

      160     1037    2              NI$REQ.PCW.CHANNEL=DQH.IOCHAN.CHANNEL;

   1037  1 000177   200014 470500                    LDP0    IOS$,,AUTO
         1 000200   100001 236100                    LDQ     1,,PR1
         1 000201   000177 376003                    ANQ     127,DU
         1 000202   000011 736000                    QLS     9
         1 000203   000013 552140                    STBQ    11,'40'O,PR0

      161     1038    2              MBX=NI_MBX_INIT;

   1038  1 000204   200016 473500                    LDP3    MBX$,,AUTO
         1 000205   000100 100400                    MLR     fill='000'O
         1 000206   000000 000020 xsym               ADSC9   NI_MBX_INIT              cn=0,n=16
         1 000207   300000 000020                    ADSC9   0,,PR3                   cn=0,n=16

      162     1039        /*
      163     1040                   MBX.SCW.ADDRESS=POFFW(ADDR(DQH.IOSTATUS$->IOSTAT.STATUS),B$REAL$);
      164     1041                   MBX.LPW.ADDRESS=POFFW(ADDR(NI$REQ.DCW),B$REAL$);
      165     1042
      166     1043                   following three lines replace this - speed up code
      167     1044                   we can do this because IOSTAT and IOS live in low real memory
      168     1045                   (also - IOSTAT.STATUS must be at beginning of IOSTAT block)
      169     1046        */
      170     1047    2              MBX.SCW.ADDRESS=ADDR(DQH.IOSTATUS$)->PTRB.ADDRESS;
PL6.E3A0      #001=NIS$MASK File=NIS$DRIVER.:E05TSI                              WED 07/30/97 03:36 Page:23   

   1047  1 000210   100016 220100                    LDX0    14,,PR1
         1 000211   300002 740100                    STX0    2,,PR3

      171     1048    2              TEMP$=ADDR(NI$REQ.DCW);

   1048  1 000212   200014 236100                    LDQ     IOS$,,AUTO
         1 000213   000002 036003                    ADLQ    2,DU
         1 000214   200020 756100                    STQ     TEMP$,,AUTO

      172     1049    2              MBX.LPW.ADDRESS=ADDR(TEMP$)->PTRB.ADDRESS;

   1049  1 000215   200020 220100                    LDX0    TEMP$,,AUTO
         1 000216   300000 740100                    STX0    0,,PR3

      173     1050
      174     1051    2              MBX.LPW.CONTROL.REL=REQ.IOFLG.LPW23;

   1051  1 000217   200017 474500                    LDP4    REQ$,,AUTO
         1 000220   400004 236100                    LDQ     4,,PR4
         1 000221   000001 772000                    QRL     1
         1 000222   300000 676100                    ERQ     0,,PR3
         1 000223   010000 376007                    ANQ     4096,DL
         1 000224   300000 656100                    ERSQ    0,,PR3

      175     1052    2              MBX.LPWX=REQ.LPWX;

   1052  1 000225   400011 236100                    LDQ     9,,PR4
         1 000226   300001 756100                    STQ     1,,PR3

      176     1053    2              CON$ = ADDR(IOM.MBX$->NI$MBX(2)) ; /* Connect Channel */

   1053  1 000227   200013 475500                    LDP5    IOM$,,AUTO
         1 000230   500002 476500                    LDP6    2,,PR5
         1 000231   600010 637500                    EPPR7   8,,PR6
         1 000232   200005 457500                    STP7    CON$,,AUTO

PL6.E3A0      #001=NIS$MASK File=NIS$DRIVER.:E05TSI                              WED 07/30/97 03:36 Page:24   
      177     1054                   %LOCK ( G#=NI$CONNECT.GATE ) ;

   1055  1 000233   000000 630400 xsym               EPPR0   NI$CONNECT$
         1 000234   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 000235   000000 701000 xent               TSX1    HFC$LOCK
         1 000236   000000 011000                    NOP     0

      178     1057    2              CONNMBX = CON$->MBX ;

   1057  1 000237   200005 470500                    LDP0    CON$,,AUTO
         1 000240   000100 100500                    MLR     fill='000'O
         1 000241   000000 000020                    ADSC9   0,,PR0                   cn=0,n=16
         1 000242   200006 000020                    ADSC9   CONNMBX,,AUTO            cn=0,n=16

      179     1058    2              CONNMBX.LPW = CNNCT_LPW_INIT ; /* #40703 */

   1058  1 000243   000003 236000 0                  LDQ     3
         1 000244   200006 756100                    STQ     CONNMBX,,AUTO

      180     1059    3              DO  WHILE  ( CONNMBX.LPW.TALLY ~= 0 ) ;

   1059  1 000245   007777 316007                    CANQ    4095,DL
         1 000246   000256 600000 1                  TZE     s:1062

      181     1060    3                 CONNMBX = CON$->MBX ;

   1060  1 000247   200005 470500                    LDP0    CON$,,AUTO
         1 000250   000100 100500                    MLR     fill='000'O
         1 000251   000000 000020                    ADSC9   0,,PR0                   cn=0,n=16
         1 000252   200006 000020                    ADSC9   CONNMBX,,AUTO            cn=0,n=16

      182     1061    3                 END ;

   1061  1 000253   200006 236100                    LDQ     CONNMBX,,AUTO
         1 000254   007777 316007                    CANQ    4095,DL
         1 000255   000247 601000 1                  TNZ     s:1060

PL6.E3A0      #001=NIS$MASK File=NIS$DRIVER.:E05TSI                              WED 07/30/97 03:36 Page:25   
      183     1062    2              CONNMBX.LPW = CNNCT_LPW_INIT ;

   1062  1 000256   000003 236000 0                  LDQ     3
         1 000257   200006 756100                    STQ     CONNMBX,,AUTO

      184     1063        /*
      185     1064                   The following line of code:
      186     1065
      187     1066                   CONNMBX.LPW.ADDRESS = POFFW ( ADDR(NI$REQ.PCW), B$REAL$ ) ;
      188     1067
      189     1068                   has been replaced by the following two lines of code.  This
      190     1069                   was done as a speed/performance improvement.  This can be
      191     1070                   done because on the IOM/IOP systems, the PCW lives in low
      192     1071                   real memory.
      193     1072                                                                            */
      194     1073    2              TEMP$ = ADDR(NI$REQ.PCW) ;

   1073  1 000260   200014 236100                    LDQ     IOS$,,AUTO
         1 000261   000012 036003                    ADLQ    10,DU
         1 000262   200020 756100                    STQ     TEMP$,,AUTO

      195     1074    2              CONNMBX.LPW.ADDRESS = ADDR(TEMP$)->PTRB.ADDRESS ;

   1074  1 000263   200020 220100                    LDX0    TEMP$,,AUTO
         1 000264   200006 740100                    STX0    CONNMBX,,AUTO

      196     1075    2              CONNMBX.DCW = '1'B ;         /*  Done to keep IOM happy  */

   1075  1 000265   400000 236003                    LDQ     -131072,DU
         1 000266   200011 756100                    STQ     CONNMBX+3,,AUTO

      197     1076    2              CON$->MBX   = CONNMBX ;      /* #40703 */

   1076  1 000267   000100 100500                    MLR     fill='000'O
         1 000270   200006 000020                    ADSC9   CONNMBX,,AUTO            cn=0,n=16
         1 000271   000000 000020                    ADSC9   0,,PR0                   cn=0,n=16

PL6.E3A0      #001=NIS$MASK File=NIS$DRIVER.:E05TSI                              WED 07/30/97 03:36 Page:26   
      198     1077    2              CON$->MBX.DCW       = '1'B ; /*  Done to keep IOM happy  */

   1077  1 000272   000003 756100                    STQ     3,,PR0

      199     1078    2              NI_CONADDR          = IOM.ADDRESS ;

   1078  1 000273   200013 471500                    LDP1    IOM$,,AUTO
         1 000274   100003 236100                    LDQ     3,,PR1
         1 000275   000007 376007                    ANQ     7,DL
         1 000276   000000 756000 xsym               STQ     NI_CONADDR

      200     1079    2              CALL NIM$CONNECT /* (NI_CONADDR) */;

   1079  1 000277   000002 631400 xsym               EPPR1   B_VECTNIL+2
         1 000300   000000 701000 xent               TSX1    NIM$CONNECT
         1 000301   000000 011000                    NOP     0

      201     1080    2              IF  MASKING

   1080  1 000302   200015 234100                    SZN     MASKING,,AUTO
         1 000303   000306 604000 1                  TMI     s:1083
         1 000304   000000 234000 xsym               SZN     H_S1000_FLG
         1 000305   000320 605000 1                  TPL     s:1086

      202     1081    2                OR H_S1000_FLG
      203     1082    2              THEN
      204     1083    3              DO  WHILE ( CONNMBX.LPW.TALLY ~= 0 ) ;

   1083  1 000306   200006 236100                    LDQ     CONNMBX,,AUTO
         1 000307   007777 316007                    CANQ    4095,DL
         1 000310   000320 600000 1                  TZE     s:1086

      205     1084    3                 CONNMBX = CON$->MBX ;

   1084  1 000311   200005 470500                    LDP0    CON$,,AUTO
         1 000312   000100 100500                    MLR     fill='000'O
         1 000313   000000 000020                    ADSC9   0,,PR0                   cn=0,n=16
PL6.E3A0      #001=NIS$MASK File=NIS$DRIVER.:E05TSI                              WED 07/30/97 03:36 Page:27   
         1 000314   200006 000020                    ADSC9   CONNMBX,,AUTO            cn=0,n=16

      206     1085    3                 END ;

   1085  1 000315   200006 236100                    LDQ     CONNMBX,,AUTO
         1 000316   007777 316007                    CANQ    4095,DL
         1 000317   000311 601000 1                  TNZ     s:1084

      207     1086    2              IF  MASKING

   1086  1 000320   200015 234100                    SZN     MASKING,,AUTO
         1 000321   000325 605000 1                  TPL     s:1090

      208     1087    2              THEN
      209     1088    2                 NI$REQ.PCW.MASK = '0'O ;

   1088  1 000322   200014 470500                    LDP0    IOS$,,AUTO
         1 000323   000001 236000 2                  LDQ     1
         1 000324   000012 356100                    ANSQ    10,,PR0

      210     1089    2              END ;

      211     1090    1           IOM.LASTCON=DQH.IOCHAN.CHANNEL;

   1090  1 000325   200003 470500                    LDP0    @DQH,,AUTO
         1 000326   200013 471500                    LDP1    IOM$,,AUTO
         1 000327   000001 236100                    LDQ     1,,PR0
         1 000330   000177 376003                    ANQ     127,DU
         1 000331   000011 736000                    QLS     9
         1 000332   100003 552140                    STBQ    3,'40'O,PR1

      212     1091    1           IOM.CONNCT=IOM.CONNCT+1;

   1091  1 000333   100005 054100                    AOS     5,,PR1

      213     1092                %UNLOCK ( G#=NI$CONNECT.GATE ) ;

PL6.E3A0      #001=NIS$MASK File=NIS$DRIVER.:E05TSI                              WED 07/30/97 03:36 Page:28   
   1093  1 000334   000000 630400 xsym               EPPR0   NI$CONNECT$
         1 000335   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 000336   000000 701000 xent               TSX1    HFC$UNLOCK
         1 000337   000000 011000                    NOP     0

      214     1095    1           IF MASKING THEN

   1095  1 000340   200015 234100                    SZN     MASKING,,AUTO
         1 000341   000343 605000 1                  TPL     s:1097

      215     1096    1              RETURN;

   1096  1 000342   000000 702200 xent               TSX2  ! X66_ARET

      216     1097    1           DQH.STATE=%BUSY;

   1097  1 000343   200003 470500                    LDP0    @DQH,,AUTO
         1 000344   000005 236007                    LDQ     5,DL
         1 000345   000001 752101                    STCQ    1,'01'O,PR0

      217     1098    1           DQH.TIMOUT=REQ.TIMOUT;

   1098  1 000346   200017 471500                    LDP1    REQ$,,AUTO
         1 000347   100003 236100                    LDQ     3,,PR1
         1 000350   000006 772000                    QRL     6
         1 000351   000001 752104                    STCQ    1,'04'O,PR0

      218     1099    1           IF DQH.PM.MODE~=%PM_BUSY THEN CALL PMN$COLLECT(DQH.PM,%PM_BUSY);

   1099  1 000352   000002 235100                    LDA     2,,PR0
         1 000353   000002 115007                    CMPA    2,DL
         1 000354   000366 600000 1                  TZE     s:1100

   1099  1 000355   000002 236000 2                  LDQ     2
         1 000356   200023 756100                    STQ     TEMP$+3,,AUTO
         1 000357   200003 236100                    LDQ     @DQH,,AUTO
         1 000360   000002 036003                    ADLQ    2,DU
PL6.E3A0      #001=NIS$MASK File=NIS$DRIVER.:E05TSI                              WED 07/30/97 03:36 Page:29   
         1 000361   200022 756100                    STQ     TEMP$+2,,AUTO
         1 000362   200022 630500                    EPPR0   TEMP$+2,,AUTO
         1 000363   000020 631400 xsym               EPPR1   B_VECTNIL+16
         1 000364   000000 701000 xent               TSX1    PMN$COLLECT
         1 000365   000000 011000                    NOP     0

      219     1100    1           RETURN;

   1100  1 000366   000000 702200 xent               TSX2  ! X66_ARET

(unnamed)
 Sect OctLoc
   0     000   630000 000000   600000 000000   100000 000000   000000 020001    ........@.......

(unnamed)
 Sect OctLoc
   2     000   777777 777377   777777 707777   000004 006000                    ............
      220     1101    1   END NIS$MASK;
      221     1102        %EOD;

PL6.E3A0      #001=NIS$MASK File=NIS$DRIVER.:E05TSI                              WED 07/30/97 03:36 Page:30   
--  Include file information  --

   PM$NI.:E05TOU  is referenced.
   NI$TABLES.:E05TOU  is referenced.
   N$REQ.:E05TOU  is referenced.
   NI_DATA_R.:E05TOU  cannot be made into a system file and is referenced.
   NI_DATA_C.:E05TOU  is referenced.
   HF_DATA_R.:E05TOU  cannot be made into a system file and is referenced.
   HF_LOCK_C.:E05TOU  cannot be made into a system file and is referenced.
      No diagnostics issued in procedure NIS$MASK.
PL6.E3A0      #001=NIS$MASK File=NIS$DRIVER.:E05TSI                              WED 07/30/97 03:36 Page:31   

 **** Variables and constants ****

  ****  Auto variables  ****

  ****  Scalars and arrays  ****
OctLoc.c.b A Datatyp(siz) R M Lvl/name                 OctLoc.c.b A Datatyp(siz) R M Lvl/name

     3-0-0/w PTR         r     1 @DQH                       4-0-0/w PTR         r     1 @IMXCONTYP
     5-0-0/w PTR         r     1 CON$                       6-0-0/d STRC(144)   r     1 CONNMBX
    *0-0-0/w STRC(648)   r     1 DQH                       *0-0-0/w UBIN        r     1 IMXCONTYP
    12-0-0/w UBIN        r     1 IMX_CCW                   13-0-0/w PTR         r     1 IOM$
    14-0-0/w PTR         r     1 IOS$                      15-0-0/w BIT         r     1 MASKING
    16-0-0/w PTR         r     1 MBX$                      17-0-0/w PTR         r     1 REQ$
    20-0-0/w PTR         r     1 TEMP$

  ****  SYMREF variables  ****

  ****  Scalars and arrays  ****
OctLoc.c.b A Datatyp(siz) R M Lvl/name                 OctLoc.c.b A Datatyp(siz) R M Lvl/name

     0-0-0/w BIT         r     1 HW_IMX                     0-0-0/w BIT         r     1 H_S1000_FLG
     0-0-0/w PTR         r     1 N$DCT$$                    0-0-0/w PTR         r     1 N$FQ$
     0-0-0/w PTR         r     1 NI$CONNECT$                0-0-0/w PTR         r     1 NI$FQ$
     0-0-0/w PTR         r     1 NI$IBUF$
     0-0-0/w PTR         r     1 NI$IOM$(0:3)
     0-0-0/w PTR         r     1 NI$RP$                     0-0-0/w UBIN        r     1 NI_CONADDR
     0-0-0/w UBIN        r     1 NI_IMX_CCW                 0-0-0/d STRC(144)   r     1 NI_MBX_INIT

  ****  BASED and DCB variables  ****

  ****  Scalars and arrays  ****
OctLoc.c.b A Datatyp(siz) R M Lvl/name                 OctLoc.c.b A Datatyp(siz) R M Lvl/name

     0-0-0/w STRC(1332)  r     1 DCT                        0-0-0/w STRC(252)   r     1 IOM
     0-0-0/d STRC(576)   r     1 IOSTAT                     0-0-0/d STRC(144)   r     1 MBX
     0-0-0/w STRC(144)   r     1 NI$CONNECT                 0-0-0/d STRC(864)   r     1 NI$IMXMBX
     0-0-0/d STRC(144)   r     1 NI$MBX(0:63)               0-0-0/d STRC(504)   r     1 NI$REQ
PL6.E3A0      #001=NIS$MASK File=NIS$DRIVER.:E05TSI                              WED 07/30/97 03:36 Page:32   
     0-0-0/w STRC        r     1 PTRB                       0-0-0/d STRC(1080)  r     1 REQ


   Procedure NIS$MASK requires 247 words for executable code.
   Procedure NIS$MASK requires 20 words of local(AUTO) storage.
PL6.E3A0      #001=NIS$MASK File=NIS$DRIVER.:E05TSI                              WED 07/30/97 03:36 Page:33   
          *** CROSS REFERENCE LISTING ***
**     DENOTES     IDENTIFIER DEFINITION
<<                 IDENTIFIER'S VALUE SET
>>                 IDENTIFIER'S VALUE USED
<>                 IDENTIFIER SET AND/OR USED
--                 IDENTIFIER REFERENCED
PL6.E3A0      #001=NIS$MASK File=NIS$DRIVER.:E05TSI                              WED 07/30/97 03:36 Page:34   
          MINI XREF LISTING

CON$
       709**DCL      1053<<ASSIGN   1057>>ASSIGN   1060>>ASSIGN   1076>>ASSIGN   1077>>ASSIGN   1084>>ASSIGN
CONNMBX
       723**DCL      1057<<ASSIGN   1060<<ASSIGN   1076>>ASSIGN   1084<<ASSIGN
CONNMBX.DCW
       727**DCL      1075<<ASSIGN
CONNMBX.DCW.CONTROL.AE
       728**DCL       728--REDEF
CONNMBX.LPW
       723**DCL      1058<<ASSIGN   1062<<ASSIGN
CONNMBX.LPW.ADDRESS
       723**DCL      1074<<ASSIGN
CONNMBX.LPW.CONTROL.AE
       724**DCL       724--REDEF
CONNMBX.LPW.TALLY
       725**DCL      1059>>DOWHILE  1083>>DOWHILE
CONT
      1036**LABEL     984--GOTO
DCT.DP
       782**DCL       789--REDEF     792--REDEF     793--REDEF     795--REDEF     795--REDEF     796--REDEF
       797--REDEF     797--REDEF
DCT.MPC.IOCHANX
       790**DCL       790--REDEF
DCT.PM.CONNCT
       773**DCL      1008<<ASSIGN   1008>>ASSIGN   1010<<ASSIGN   1010>>ASSIGN
DQH
       680**DCL        33--PROC      993--ENTRY
DQH.IO$
       687**DCL       978>>ASSIGN    997>>ASSIGN
DQH.IOCHAN.CHANNEL
       683**DCL      1037>>ASSIGN   1090>>ASSIGN
DQH.IOCHAN.IOM
PL6.E3A0      #001=NIS$MASK File=NIS$DRIVER.:E05TSI                              WED 07/30/97 03:36 Page:35   
       683**DCL       968>>ASSIGN   1012>>ASSIGN
DQH.IOCHANX
       682**DCL       683--REDEF    1029>>ASSIGN
DQH.IOSTATUS$
       687**DCL      1019<<ASSIGN   1020>>ASSIGN   1034>>ASSIGN   1035>>ASSIGN   1047--ASSIGN
DQH.MBX$
       691**DCL       692--REDEF    1014<<ASSIGN   1016>>ASSIGN   1028>>ASSIGN   1036>>ASSIGN
DQH.MBXADDR
       692**DCL      1030>>ASSIGN
DQH.MPC$
       687**DCL      1009>>IF       1010>>ASSIGN   1010>>ASSIGN
DQH.PM
       684**DCL      1099<>CALL
DQH.PM.CONNCT
       685**DCL       996<<ASSIGN    996>>ASSIGN
DQH.PM.MODE
       684**DCL      1099>>IF
DQH.STATE
       684**DCL      1097<<ASSIGN
DQH.TIMOUT
       683**DCL      1098<<ASSIGN
HFC$LOCK
        50**DCL-ENT   972--CALL     1022--CALL     1055--CALL
HFC$UNLOCK
        50**DCL-ENT  1093--CALL
HW_IMX
        93**DCL       969>>IF       1013>>IF
H_S1000_FLG
        63**DCL      1080>>IF
IMXCONTYP
       694**DCL        33--PROC      967>>ASSIGN    980>>IF
IMX_CCW
       731**DCL       967<<ASSIGN    974>>ASSIGN   1016<<ASSIGN
IMX_CONT
      1028**LABEL     975--GOTO
IOM.ADDRESS
PL6.E3A0      #001=NIS$MASK File=NIS$DRIVER.:E05TSI                              WED 07/30/97 03:36 Page:36   
       803**DCL      1078>>ASSIGN
IOM.CONNCT
       804**DCL      1091<<ASSIGN   1091>>ASSIGN
IOM.LASTCON
       802**DCL      1090<<ASSIGN
IOM.MBX$
       802**DCL      1053>>ASSIGN
IOM$
       732**DCL       802--IMP-PTR   968<<ASSIGN   1012<<ASSIGN   1053>>ASSIGN   1078>>ASSIGN   1090>>ASSIGN
      1091>>ASSIGN   1091>>ASSIGN
IOS$
       733**DCL       883--IMP-PTR   979<<ASSIGN    981>>ASSIGN    983>>ASSIGN   1011<<ASSIGN   1014>>ASSIGN
      1019>>ASSIGN   1037>>ASSIGN   1048>>ASSIGN   1073>>ASSIGN   1088>>ASSIGN
IOSTAT
       807**DCL      1020<<ASSIGN
IOSTAT.AESDCW
       812**DCL       812--REDEF
IOSTAT.EXTST
       813**DCL      1035<<ASSIGN
IOSTAT.STATUS
       807**DCL      1034<<ASSIGN
MASKING
       734**DCL       966<<ASSIGN    995<<ASSIGN   1080>>IF       1086>>IF       1095>>IF
MBX
       826**DCL      1038<<ASSIGN   1057>>ASSIGN   1060>>ASSIGN   1076<<ASSIGN   1084>>ASSIGN
MBX.DCW
       830**DCL      1077<<ASSIGN
MBX.DCW.CONTROL.AE
       831**DCL       831--REDEF
MBX.LPW.ADDRESS
       826**DCL      1049<<ASSIGN
MBX.LPW.CONTROL.AE
       827**DCL       827--REDEF
MBX.LPW.CONTROL.REL
       827**DCL      1051<<ASSIGN
MBX.LPWX
PL6.E3A0      #001=NIS$MASK File=NIS$DRIVER.:E05TSI                              WED 07/30/97 03:36 Page:37   
       828**DCL      1052<<ASSIGN
MBX.SCW.ADDRESS
       829**DCL      1047<<ASSIGN
MBX$
       735**DCL       826--IMP-PTR  1036<<ASSIGN   1038>>ASSIGN   1047>>ASSIGN   1049>>ASSIGN   1051>>ASSIGN
      1052>>ASSIGN
N$DCT$$
       505**DCL       639--IMP-PTR
N$FQ$
       505**DCL       640--IMP-PTR
N$REQ_INIT.BUFADDR
       524**DCL       525--REDEF     525--REDEF
N$REQ_INIT.DLA.DRELADDR
       516**DCL       516--REDEF
N$REQ_INIT.DVE.EOMCHAR
       553**DCL       554--REDEF
N$REQ_INIT.EAINFO
       547**DCL       547--REDEF
N$REQ_INIT.EAINFOX
       547**DCL       548--REDEF
N$REQ_INIT.EVNTINFO
       548**DCL       548--REDEF
N$REQ_INIT.STATUS
       529**DCL       535--REDEF
NI$CONNECT.GATE
       750**DCL       972<>CALL     1022<>CALL     1055<>CALL     1093<>CALL
NI$CONNECT$
       564**DCL       750--IMP-PTR   972>>CALL     1022>>CALL     1055>>CALL     1093>>CALL
NI$FQ$
       565**DCL       641--IMP-PTR
NI$IBUF$
       565**DCL       641--IMP-PTR
NI$IMXMBX.CLW.SYNC
       847**DCL      1028<<ASSIGN
NI$IMXMBX.IOSTATUS
       853**DCL      1016>>ASSIGN
PL6.E3A0      #001=NIS$MASK File=NIS$DRIVER.:E05TSI                              WED 07/30/97 03:36 Page:38   
NI$IMXMBX.PAGED_BASE
       843**DCL       844--REDEF     844--REDEF
NI$IMXMBX.SIZE
       845**DCL       845--REDEF
NI$IMXMBX_INIT.PAGED_BASE
       575**DCL       576--REDEF     576--REDEF
NI$IMXMBX_INIT.SIZE
       577**DCL       577--REDEF
NI$IOM$
       587**DCL       968>>ASSIGN   1012>>ASSIGN
NI$MBX
       866**DCL      1053--ASSIGN
NI$MBX.DCW.CONTROL.AE
       871**DCL       871--REDEF
NI$MBX.LPW.CONTROL.AE
       867**DCL       867--REDEF
NI$REQ.DCW
       885**DCL       888--REDEF    1048--ASSIGN
NI$REQ.DCW.TALLY
       886**DCL       886--REDEF
NI$REQ.IDCW.EXTA
       888**DCL       888--REDEF
NI$REQ.PCW
       890**DCL       894--REDEF    1073--ASSIGN
NI$REQ.PCW.CHANNEL
       893**DCL      1037<<ASSIGN
NI$REQ.PCW.MASK
       891**DCL       981<<ASSIGN   1088<<ASSIGN
NI$REQ.PCW.MASK.M
       891**DCL       983<<ASSIGN
NI$REQ.SEEK
       895**DCL       896--REDEF     897--REDEF
NI$REQ_INIT.DCW
       599**DCL       602--REDEF
NI$REQ_INIT.DCW.TALLY
       600**DCL       600--REDEF
PL6.E3A0      #001=NIS$MASK File=NIS$DRIVER.:E05TSI                              WED 07/30/97 03:36 Page:39   
NI$REQ_INIT.IDCW.EXTA
       602**DCL       602--REDEF
NI$REQ_INIT.PCW
       604**DCL       608--REDEF
NI$REQ_INIT.SEEK
       609**DCL       610--REDEF     611--REDEF
NI$RP$
       613**DCL       643--IMP-PTR
NIM$CONNECT
       698**DCL-ENT  1079--CALL
NIM$IMXCONNECT
       699**DCL-ENT  1031--CALL
NI_CONADDR
       614**DCL      1030<<ASSIGN   1078<<ASSIGN
NI_IMX_CCW
       615**DCL       974<<ASSIGN   1025<<ASSIGN   1027<<ASSIGN   1029<<ASSIGN   1029>>ASSIGN
NI_MBX_INIT
       630**DCL      1038>>ASSIGN
NI_MBX_INIT.DCW.CONTROL.AE
       635**DCL       635--REDEF
NI_MBX_INIT.LPW.CONTROL.AE
       631**DCL       631--REDEF
PMN$COLLECT
       700**DCL-ENT  1099--CALL
PTRB.ADDRESS
       900**DCL      1047>>ASSIGN   1049>>ASSIGN   1074>>ASSIGN
REQ.BUFADDR
       920**DCL       921--REDEF     921--REDEF
REQ.DCT$
       912**DCL      1008>>ASSIGN   1008>>ASSIGN
REQ.DLA.DRELADDR
       912**DCL       912--REDEF
REQ.DVE.EOMCHAR
       949**DCL       950--REDEF
REQ.EAINFO
       943**DCL       943--REDEF
PL6.E3A0      #001=NIS$MASK File=NIS$DRIVER.:E05TSI                              WED 07/30/97 03:36 Page:40   
REQ.EAINFOX
       943**DCL       944--REDEF
REQ.EVNTINFO
       944**DCL       944--REDEF
REQ.IMX_TDIO_MASK
       951**DCL      1015>>IF
REQ.IOFLG.LPW23
       915**DCL      1051>>ASSIGN
REQ.IOQFLG.INUSE
       954**DCL       998>>IF
REQ.IOQFLG.IOQUED
       954**DCL       998>>IF
REQ.IOS$
       924**DCL       979>>ASSIGN   1011>>ASSIGN
REQ.LPWX
       923**DCL      1052>>ASSIGN
REQ.PTP
       922**DCL      1024>>IF
REQ.STATUS
       925**DCL       931--REDEF
REQ.TIMOUT
       913**DCL      1098>>ASSIGN
REQ$
       736**DCL       911--IMP-PTR   978<<ASSIGN    979>>ASSIGN    997<<ASSIGN    998>>IF        998>>IF
      1008>>ASSIGN   1008>>ASSIGN   1011>>ASSIGN   1015>>IF       1024>>IF       1051>>ASSIGN   1052>>ASSIGN
      1098>>ASSIGN
SC_NISBADIOQ
       701**DCL-ENT  1007--CALL
TDIO_MASK
       957**LABEL    1017--GOTO
TEMP$
       737**DCL      1048<<ASSIGN   1049--ASSIGN   1073<<ASSIGN   1074--ASSIGN

PL6.E3A0      #002=NIS$SCRACC File=NIS$DRIVER.:E05TSI                            WED 07/30/97 03:37 Page:41   
      222        1        /*T***********************************************************/
      223        2        /*T*                                                         */
      224        3        /*T* Copyright (c) Bull HN Information Systems Inc., 1997    */
      225        4        /*T*                                                         */
      226        5        /*T***********************************************************/
      227        6        /*D*    NAME:    NIS$SCRACC
      228        7                CALL:    CALL NIS$SCRACC(DQH)
      229        8                ENVIRONMENT:   NI_CNNCTGATE is locked.
      230        9                DESCRIPTION:   Issues connect to wraparound channel to perform
      231       10                               scratchpad access.
      232       11
      233       12                               In this case DQH.IO$ is the head pointer of the queue
      234       13                               of scratchpad accesses.  DCWs 0 and 1 of the IOS
      235       14                               packet are used for temporary storage to transfer
      236       15                               fault status info.
      237       16                                                                           */
      238       17        NIS$SCRACC: PROC(DQH);
      239       18        /*
      240       19                Includes
      241       20        */
      242       21        %INCLUDE                HF_DATA_R ;
      243       64        %INCLUDE                NI_DATA_C ;
      244      177        %INCLUDE                NI_DATA_R ;
      245      614        /*
      246      615                Parameters
      247      616        */
      248      617        %NI$DQH                 ( NAME=DQH, STCLASS=PARAM ) ;
      249      640        /*
      250      641                Entries
      251      642        */
      252      643    1   DCL 1 NIM$CONNECT       ENTRY ;
      253      644        /*
      254      645                Symrefs
      255      646        */
      256      647    1   DCL 1 B$REAL$           PTR SYMREF ;
      257      648        /*
      258      649                Auto
PL6.E3A0      #002=NIS$SCRACC File=NIS$DRIVER.:E05TSI                            WED 07/30/97 03:37 Page:42   
      259      650        */
      260      651    1   DCL 1 IOM$              PTR ALIGNED AUTO ;
      261      652    1   DCL 1 IOS$              PTR ALIGNED AUTO ;
      262      653    1   DCL 1 LPW               UBIN ALIGNED AUTO ;
      263      654    1   DCL 1 MBX$              PTR ALIGNED AUTO ;
      264      655        /*
      265      656                Based
      266      657        */
      267      658        %NI$IOM                 ( NAME=IOM,         STCLASS="BASED(IOM$)" ) ;
      268      663        %NI$REQ                 ( NAME=IOS,         STCLASS="BASED(IOS$)" ) ;
      269      688        %NI$MBX                 ( NAME="MBX(0:63)", STCLASS="BASED(MBX$)" ) ;
      270      707        /*
      271      708                Constants
      272      709        */
      273      710        %EQU K256=%BITBIN('1000000'O);
      274      711        %EJECT;
PL6.E3A0      #002=NIS$SCRACC File=NIS$DRIVER.:E05TSI                            WED 07/30/97 03:37 Page:43   
      275      712    1           IF HW_IMX THEN RETURN;  /*N* WE SHOULD NEVER GET HERE FOR IMX */
      276      713    1           IOS$=DQH.IO$->IOS.FL$;
      277      714    1           IOM$=NI$IOM$(DQH.IOCHAN.IOM);
      278      715    1           MBX$=IOM.MBX$;
      279      716    1           MBX.DCW(7)=BINBIT(POFFW(ADDR(IOS.DCW(1)),B$REAL$)*%K256+1,36);
      280      717    1           LPW=POFFW(ADDR(IOS.PCW),B$REAL$)*%K256+%BITBIN('020001'O);
      281      718    2           DO WHILE(MBX.LPW.TALLY(2)~=0);
      282      719    2              END;
      283      720    1           MBX.LPW(2)=BINBIT(LPW,36);
      284      721    1           NI_CONADDR=IOM.ADDRESS;
      285      722    1           CALL NIM$CONNECT;
      286      723    1           DQH.STATE=%BUSY;
      287      724    1           DQH.TIMOUT=2;
      288      725    1           RETURN;
      289      726    1   END NIS$SCRACC;
      290      727        %EOD;

PL6.E3A0      #002=NIS$SCRACC File=NIS$DRIVER.:E05TSI                            WED 07/30/97 03:37 Page:44   
--  Include file information  --

   NI$TABLES.:E05TOU  is referenced.
   N$REQ.:E05TOU  is referenced.
   NI_DATA_R.:E05TOU  cannot be made into a system file and is referenced.
   NI_DATA_C.:E05TOU  is referenced.
   HF_DATA_R.:E05TOU  cannot be made into a system file and is referenced.
      No diagnostics issued in procedure NIS$SCRACC.

   Procedure NIS$SCRACC requires 59 words for executable code.
   Procedure NIS$SCRACC requires 10 words of local(AUTO) storage.

PL6.E3A0      #002=NIS$SCRACC File=NIS$DRIVER.:E05TSI                            WED 07/30/97 03:37 Page:45   

 Object Unit name= NIS$SCRACC                                 File name= NIS$DRIVER.:E05TOU
 UTS= JUL 30 '97 03:37:17.68 WED                              Compiler= PL-6/E31         Sev=      00
 SharedLib= :SHARED_SYSTEM                                    Alt SharedLib=


    ****  Control sections  ****

 Sect   Type Bound  Init  Size OctSiz  Section name(segment info)
    0   Proc  even  none    59     73  NIS$SCRACC

    ****  Entry defs  ****

                              Check   Calling
                             calling  sequence
  Sect OctLoc Primary Altret sequence   type   Parms  Name
     0      0   yes            yes      Std        1  NIS$SCRACC

  ****  Entry refs  ****

         Check        Calling
        calling       sequence
Altret sequence SRef   type   Args  Name
         yes           Std       0 NIM$CONNECT
                       nStd      0 X66_AUTO_1
                       nStd      0 X66_ARET
                       Std       0 B_CONSPOOL_D

  ****  Data refs  ****

  Flags:  r = read only, s = secondary
Flgs Name                             Flgs Name                             Flgs Name
     HW_IMX                                N$DCT$$                               N$FQ$
     NI$FQ$                                NI$IBUF$                              NI$IOM$
     NI$RP$                                NI_CONADDR                            B$REAL$
     B_VECTNIL
PL6.E3A0      #002=NIS$SCRACC File=NIS$DRIVER.:E05TSI                            WED 07/30/97 03:37 Page:46   


      222        1        /*T***********************************************************/
      223        2        /*T*                                                         */
      224        3        /*T* Copyright (c) Bull HN Information Systems Inc., 1997    */
      225        4        /*T*                                                         */
      226        5        /*T***********************************************************/
      227        6        /*D*    NAME:    NIS$SCRACC
      228        7                CALL:    CALL NIS$SCRACC(DQH)
      229        8                ENVIRONMENT:   NI_CNNCTGATE is locked.
      230        9                DESCRIPTION:   Issues connect to wraparound channel to perform
      231       10                               scratchpad access.
      232       11
      233       12                               In this case DQH.IO$ is the head pointer of the queue
      234       13                               of scratchpad accesses.  DCWs 0 and 1 of the IOS
      235       14                               packet are used for temporary storage to transfer
      236       15                               fault status info.
      237       16                                                                           */
      238       17        NIS$SCRACC: PROC(DQH);

     17  0 000000   000000 700200 xent  NIS$SCRACC   TSX0  ! X66_AUTO_1
         0 000001   000012 000001                    ZERO    10,1

      239       18        /*
      240       19                Includes
      241       20        */
      242       21        %INCLUDE                HF_DATA_R ;
      243       64        %INCLUDE                NI_DATA_C ;
      244      177        %INCLUDE                NI_DATA_R ;
      245      614        /*
      246      615                Parameters
      247      616        */
      248      617        %NI$DQH                 ( NAME=DQH, STCLASS=PARAM ) ;
      249      640        /*
      250      641                Entries
      251      642        */
      252      643    1   DCL 1 NIM$CONNECT       ENTRY ;
      253      644        /*
PL6.E3A0      #002=NIS$SCRACC File=NIS$DRIVER.:E05TSI                            WED 07/30/97 03:37 Page:47   
      254      645                Symrefs
      255      646        */
      256      647    1   DCL 1 B$REAL$           PTR SYMREF ;
      257      648        /*
      258      649                Auto
      259      650        */
      260      651    1   DCL 1 IOM$              PTR ALIGNED AUTO ;
      261      652    1   DCL 1 IOS$              PTR ALIGNED AUTO ;
      262      653    1   DCL 1 LPW               UBIN ALIGNED AUTO ;
      263      654    1   DCL 1 MBX$              PTR ALIGNED AUTO ;
      264      655        /*
      265      656                Based
      266      657        */
      267      658        %NI$IOM                 ( NAME=IOM,         STCLASS="BASED(IOM$)" ) ;
      268      663        %NI$REQ                 ( NAME=IOS,         STCLASS="BASED(IOS$)" ) ;
      269      688        %NI$MBX                 ( NAME="MBX(0:63)", STCLASS="BASED(MBX$)" ) ;
      270      707        /*
      271      708                Constants
      272      709        */
      273      710        %EQU K256=%BITBIN('1000000'O);
      274      711        %EJECT;
PL6.E3A0      #002=NIS$SCRACC File=NIS$DRIVER.:E05TSI                            WED 07/30/97 03:37 Page:48   
      275      712    1           IF HW_IMX THEN RETURN;  /*N* WE SHOULD NEVER GET HERE FOR IMX */

    712  0 000002   000000 234000 xsym               SZN     HW_IMX
         0 000003   000005 605000 0                  TPL     s:713

    712  0 000004   000000 702200 xent               TSX2  ! X66_ARET

      276      713    1           IOS$=DQH.IO$->IOS.FL$;

    713  0 000005   200003 470500                    LDP0    @DQH,,AUTO
         0 000006   000014 471500                    LDP1    12,,PR0
         0 000007   100000 236100                    LDQ     0,,PR1
         0 000010   200005 756100                    STQ     IOS$,,AUTO

      277      714    1           IOM$=NI$IOM$(DQH.IOCHAN.IOM);

    714  0 000011   000001 236100                    LDQ     1,,PR0
         0 000012   000031 772000                    QRL     25
         0 000013   000003 376007                    ANQ     3,DL
         0 000014   000000 236006 xsym               LDQ     NI$IOM$,QL
         0 000015   200004 756100                    STQ     IOM$,,AUTO

      278      715    1           MBX$=IOM.MBX$;

    715  0 000016   200004 473500                    LDP3    IOM$,,AUTO
         0 000017   300002 236100                    LDQ     2,,PR3
         0 000020   200007 756100                    STQ     MBX$,,AUTO

      279      716    1           MBX.DCW(7)=BINBIT(POFFW(ADDR(IOS.DCW(1)),B$REAL$)*%K256+1,36);

    716  0 000021   200005 236100                    LDQ     IOS$,,AUTO
         0 000022   000003 036003                    ADLQ    3,DU
         0 000023   000022 772000                    QRL     18
         0 000024   000000 235000 xsym               LDA     B$REAL$
         0 000025   000022 771000                    ARL     18
         0 000026   200010 755100                    STA     MBX$+1,,AUTO
         0 000027   200010 136100                    SBLQ    MBX$+1,,AUTO
PL6.E3A0      #002=NIS$SCRACC File=NIS$DRIVER.:E05TSI                            WED 07/30/97 03:37 Page:49   
         0 000030   000022 736000                    QLS     18
         0 000031   000001 036007                    ADLQ    1,DL
         0 000032   200007 474500                    LDP4    MBX$,,AUTO
         0 000033   400037 756100                    STQ     31,,PR4

      280      717    1           LPW=POFFW(ADDR(IOS.PCW),B$REAL$)*%K256+%BITBIN('020001'O);

    717  0 000034   200005 236100                    LDQ     IOS$,,AUTO
         0 000035   000012 036003                    ADLQ    10,DU
         0 000036   000022 772000                    QRL     18
         0 000037   200010 755100                    STA     MBX$+1,,AUTO
         0 000040   200010 136100                    SBLQ    MBX$+1,,AUTO
         0 000041   000022 736000                    QLS     18
         0 000042   020001 036007                    ADLQ    8193,DL
         0 000043   200006 756100                    STQ     LPW,,AUTO

      281      718    2           DO WHILE(MBX.LPW.TALLY(2)~=0);

    718  0 000044   400010 236100                    LDQ     8,,PR4
         0 000045   007777 316007                    CANQ    4095,DL
         0 000046   000053 600000 0                  TZE     s:720

      282      719    2              END;

    719  0 000047   200007 470500                    LDP0    MBX$,,AUTO
         0 000050   000010 236100                    LDQ     8,,PR0
         0 000051   007777 316007                    CANQ    4095,DL
         0 000052   000047 601000 0                  TNZ     s:719

      283      720    1           MBX.LPW(2)=BINBIT(LPW,36);

    720  0 000053   200006 236100                    LDQ     LPW,,AUTO
         0 000054   200007 470500                    LDP0    MBX$,,AUTO
         0 000055   000010 756100                    STQ     8,,PR0

      284      721    1           NI_CONADDR=IOM.ADDRESS;

PL6.E3A0      #002=NIS$SCRACC File=NIS$DRIVER.:E05TSI                            WED 07/30/97 03:37 Page:50   
    721  0 000056   200004 471500                    LDP1    IOM$,,AUTO
         0 000057   100003 236100                    LDQ     3,,PR1
         0 000060   000007 376007                    ANQ     7,DL
         0 000061   000000 756000 xsym               STQ     NI_CONADDR

      285      722    1           CALL NIM$CONNECT;

    722  0 000062   000002 631400 xsym               EPPR1   B_VECTNIL+2
         0 000063   000000 701000 xent               TSX1    NIM$CONNECT
         0 000064   000000 011000                    NOP     0

      286      723    1           DQH.STATE=%BUSY;

    723  0 000065   200003 470500                    LDP0    @DQH,,AUTO
         0 000066   000005 236007                    LDQ     5,DL
         0 000067   000001 752101                    STCQ    1,'01'O,PR0

      287      724    1           DQH.TIMOUT=2;

    724  0 000070   020000 236007                    LDQ     8192,DL
         0 000071   000001 752104                    STCQ    1,'04'O,PR0

      288      725    1           RETURN;

    725  0 000072   000000 702200 xent               TSX2  ! X66_ARET
      289      726    1   END NIS$SCRACC;
      290      727        %EOD;

PL6.E3A0      #002=NIS$SCRACC File=NIS$DRIVER.:E05TSI                            WED 07/30/97 03:37 Page:51   
--  Include file information  --

   NI$TABLES.:E05TOU  is referenced.
   N$REQ.:E05TOU  is referenced.
   NI_DATA_R.:E05TOU  cannot be made into a system file and is referenced.
   NI_DATA_C.:E05TOU  is referenced.
   HF_DATA_R.:E05TOU  cannot be made into a system file and is referenced.
      No diagnostics issued in procedure NIS$SCRACC.
PL6.E3A0      #002=NIS$SCRACC File=NIS$DRIVER.:E05TSI                            WED 07/30/97 03:37 Page:52   

 **** Variables and constants ****

  ****  Auto variables  ****

  ****  Scalars and arrays  ****
OctLoc.c.b A Datatyp(siz) R M Lvl/name                 OctLoc.c.b A Datatyp(siz) R M Lvl/name

     3-0-0/w PTR         r     1 @DQH                      *0-0-0/w STRC(648)   r     1 DQH
     4-0-0/w PTR         r     1 IOM$                       5-0-0/w PTR         r     1 IOS$
     6-0-0/w UBIN        r     1 LPW                        7-0-0/w PTR         r     1 MBX$

  ****  SYMREF variables  ****

  ****  Scalars and arrays  ****
OctLoc.c.b A Datatyp(siz) R M Lvl/name                 OctLoc.c.b A Datatyp(siz) R M Lvl/name

     0-0-0/w PTR         r     1 B$REAL$                    0-0-0/w BIT         r     1 HW_IMX
     0-0-0/w PTR         r     1 N$DCT$$                    0-0-0/w PTR         r     1 N$FQ$
     0-0-0/w PTR         r     1 NI$FQ$                     0-0-0/w PTR         r     1 NI$IBUF$
     0-0-0/w PTR         r     1 NI$IOM$(0:3)
     0-0-0/w PTR         r     1 NI$RP$                     0-0-0/w UBIN        r     1 NI_CONADDR

  ****  BASED and DCB variables  ****

  ****  Scalars and arrays  ****
OctLoc.c.b A Datatyp(siz) R M Lvl/name                 OctLoc.c.b A Datatyp(siz) R M Lvl/name

     0-0-0/w STRC(252)   r     1 IOM                        0-0-0/d STRC(504)   r     1 IOS
     0-0-0/d STRC(144)   r     1 MBX(0:63)


   Procedure NIS$SCRACC requires 59 words for executable code.
   Procedure NIS$SCRACC requires 10 words of local(AUTO) storage.
PL6.E3A0      #002=NIS$SCRACC File=NIS$DRIVER.:E05TSI                            WED 07/30/97 03:37 Page:53   
          *** CROSS REFERENCE LISTING ***
**     DENOTES     IDENTIFIER DEFINITION
<<                 IDENTIFIER'S VALUE SET
>>                 IDENTIFIER'S VALUE USED
<>                 IDENTIFIER SET AND/OR USED
--                 IDENTIFIER REFERENCED
PL6.E3A0      #002=NIS$SCRACC File=NIS$DRIVER.:E05TSI                            WED 07/30/97 03:37 Page:54   
          MINI XREF LISTING

B$REAL$
       647**DCL       716>>ASSIGN    717>>ASSIGN
DQH
       626**DCL        17--PROC
DQH.IO$
       633**DCL       713>>ASSIGN
DQH.IOCHAN.IOM
       629**DCL       714>>ASSIGN
DQH.IOCHANX
       628**DCL       629--REDEF
DQH.MBX$
       637**DCL       638--REDEF
DQH.STATE
       630**DCL       723<<ASSIGN
DQH.TIMOUT
       629**DCL       724<<ASSIGN
HW_IMX
        63**DCL       712>>IF
IOM.ADDRESS
       660**DCL       721>>ASSIGN
IOM.MBX$
       659**DCL       715>>ASSIGN
IOM$
       651**DCL       659--IMP-PTR   714<<ASSIGN    715>>ASSIGN    721>>ASSIGN
IOS.DCW
       674**DCL       677--REDEF     716--ASSIGN
IOS.DCW.TALLY
       675**DCL       675--REDEF
IOS.FL$
       672**DCL       713>>ASSIGN
IOS.IDCW.EXTA
       677**DCL       677--REDEF
PL6.E3A0      #002=NIS$SCRACC File=NIS$DRIVER.:E05TSI                            WED 07/30/97 03:37 Page:55   
IOS.PCW
       679**DCL       683--REDEF     717--ASSIGN
IOS.SEEK
       684**DCL       685--REDEF     686--REDEF
IOS$
       652**DCL       672--IMP-PTR   713<<ASSIGN    716>>ASSIGN    717>>ASSIGN
LPW
       653**DCL       717<<ASSIGN    720>>ASSIGN
MBX.DCW
       703**DCL       716<<ASSIGN
MBX.DCW.CONTROL.AE
       704**DCL       704--REDEF
MBX.LPW
       699**DCL       720<<ASSIGN
MBX.LPW.CONTROL.AE
       700**DCL       700--REDEF
MBX.LPW.TALLY
       701**DCL       718>>DOWHILE
MBX$
       654**DCL       699--IMP-PTR   715<<ASSIGN    716>>ASSIGN    718>>DOWHILE   720>>ASSIGN
N$DCT$$
       475**DCL       609--IMP-PTR
N$FQ$
       475**DCL       610--IMP-PTR
N$REQ_INIT.BUFADDR
       494**DCL       495--REDEF     495--REDEF
N$REQ_INIT.DLA.DRELADDR
       486**DCL       486--REDEF
N$REQ_INIT.DVE.EOMCHAR
       523**DCL       524--REDEF
N$REQ_INIT.EAINFO
       517**DCL       517--REDEF
N$REQ_INIT.EAINFOX
       517**DCL       518--REDEF
N$REQ_INIT.EVNTINFO
       518**DCL       518--REDEF
PL6.E3A0      #002=NIS$SCRACC File=NIS$DRIVER.:E05TSI                            WED 07/30/97 03:37 Page:56   
N$REQ_INIT.STATUS
       499**DCL       505--REDEF
NI$FQ$
       535**DCL       611--IMP-PTR
NI$IBUF$
       535**DCL       611--IMP-PTR
NI$IMXMBX_INIT.PAGED_BASE
       545**DCL       546--REDEF     546--REDEF
NI$IMXMBX_INIT.SIZE
       547**DCL       547--REDEF
NI$IOM$
       557**DCL       714>>ASSIGN
NI$REQ_INIT.DCW
       569**DCL       572--REDEF
NI$REQ_INIT.DCW.TALLY
       570**DCL       570--REDEF
NI$REQ_INIT.IDCW.EXTA
       572**DCL       572--REDEF
NI$REQ_INIT.PCW
       574**DCL       578--REDEF
NI$REQ_INIT.SEEK
       579**DCL       580--REDEF     581--REDEF
NI$RP$
       583**DCL       613--IMP-PTR
NIM$CONNECT
       643**DCL-ENT   722--CALL
NI_CONADDR
       584**DCL       721<<ASSIGN
NI_MBX_INIT.DCW.CONTROL.AE
       605**DCL       605--REDEF
NI_MBX_INIT.LPW.CONTROL.AE
       601**DCL       601--REDEF

PL6.E3A0      #003=NIS$DCCON File=NIS$DRIVER.:E05TSI                             WED 07/30/97 03:37 Page:57   
      291        1        /*T***********************************************************/
      292        2        /*T*                                                         */
      293        3        /*T* Copyright (c) Bull HN Information Systems Inc., 1997    */
      294        4        /*T*                                                         */
      295        5        /*T***********************************************************/
      296        6        /*D*    NAME:    NIS$DCCON
      297        7                CALL:    CALL NIS$DCCON(CHANNEL,MASK,WSQN)
      298        8                INPUT:   CHANNEL - (LOGICAL IOM#)*128 + CHANNEL NUMBER
      299        9                         MASK - BITS 21-23 OF PCW
      300       10                         WSQN - ENTRY IN THE WSPTD
      301       11                DESCRIPTION:   Issues connect to direct channel.
      302       12                                                                           */
      303       13        NIS$DCCON: PROC(CHANNEL,MASK,WSQN);
      304       14        /*
      305       15                Includes
      306       16        */
      307       17        %INCLUDE                B_STRINGS_C ;
      308      146        %INCLUDE                HF_LOCK_C ;
      309      160        %INCLUDE                HF_DATA_R ;
      310      203        %INCLUDE                NI_DATA_C ;
      311      316        %INCLUDE                NI_DATA_R ;
      312      753        %INCLUDE                S_WSPTD_R ;
      313      769        /*
      314      770                Parameters
      315      771        */
      316      772    1   DCL 1 CHANNEL           CALIGNED PARAM,
      317      773    1         2 IOM             UBIN(2) UNAL,
      318      774    1         2 CHAN            UBIN(7) UNAL ;
      319      775    1   DCL MASK                BIT(3) ALIGNED PARAM ;
      320      776    1   DCL WSQN                UBIN PARAM ;
      321      777        /*
      322      778                Entries
      323      779        */
      324      780    1   DCL 1 NIM$CONNECT       ENTRY ;
      325      781    1   DCL 1 NIM$IMXCONNECT    ENTRY ;
      326      782        /*
      327      783                Auto
PL6.E3A0      #003=NIS$DCCON File=NIS$DRIVER.:E05TSI                             WED 07/30/97 03:37 Page:58   
      328      784        */
      329      785    1   DCL 1 CON$              PTR ALIGNED AUTO ;
      330      786    1   DCL 1 DQH$              PTR ALIGNED AUTO ;
      331      787    1   DCL 1 IOM$              PTR ALIGNED AUTO ;
      332      788    1   DCL 1 MBX$              PTR ALIGNED AUTO ;
      333      789    1   DCL 1 MBXP              REDEF MBX$,
      334      790    1         2 ADDRESS         UBIN(18) UNAL,
      335      791    1         2 *               UBIN(18) UNAL;
      336      792    1   DCL 1 PCW               DALIGNED AUTO,
      337      793    1         2 *               BIT(21),
      338      794    1         2 MASK            BIT(3),
      339      795    1         2 *               BIT(12),
      340      796    1         2 CHANNEL         UBIN(9) UNAL,
      341      797    1         2 PTP             UBIN(18) UNAL,
      342      798    1         2 CONT            BIT(2),
      343      799    1         2 *               BIT(7);
      344      800    1   DCL 1 PTP               UBIN ALIGNED AUTO ;
      345      801        /*
      346      802                Based
      347      803        */
      348      804    1   DCL 1 DCMBX             BASED DALIGNED,
      349      805    1         2 LPW,             /* USED ONLY BY THE IOP TO LOCATE PTAW AT ADDRESS-1 */
      350      806    1           3 ADDRESS       UBIN(18) UNAL,
      351      807    1           3 *             UBIN(18) UNAL,
      352      808    1         2 IOP_PTAW,
      353      809    1           3 *             BIT(7) UNAL,
      354      810    1           3 PTA           UBIN(20) UNAL,
      355      811    1           3 *             BIT(2) UNAL,
      356      812    1           3 PHYSADDR      BIT(1) UNAL,
      357      813    1           3 *             BIT(6) UNAL,
      358      814    1         2 PCW             BIT(72) DALIGNED;
      359      815        %NI$CHT                 ( NAME="CHT(0:%(N_MAXCHANS-1))", STCLASS="BASED(NI$CHT$)" )
               815            ;
      360      818        %NI$CONNECT             ( NAME=NI$CONNECT,     STCLASS="BASED(NI$CONNECT$)" ) ;
      361      830        %NI$DQH                 ( NAME=DQH,            STCLASS="BASED(DQH$)" ) ;
      362      853        %NI$IMXMBX              ( NAME=IMXMBX,         STCLASS="BASED(MBX$)" ) ;
      363      874        %NI$IOM                 ( NAME=IOM,            STCLASS="BASED(IOM$)" ) ;
PL6.E3A0      #003=NIS$DCCON File=NIS$DRIVER.:E05TSI                             WED 07/30/97 03:37 Page:59   
      364      879        %NI$MBX                 ( NAME=MBX,            STCLASS="BASED(MBX$)" ) ;
      365      898        %NI$MBX                 ( NAME="NI$MBX(0:63)", STCLASS=BASED ) ;
      366      917        /*
      367      918                Constants
      368      919        */
      369      920        %EQU CNNCT_LPW_INIT='000000020001'O;
      370      921        %EQU IMX_CLW_INIT='000000000020'O;      /* TERMINATE LEVEL = 2 */
      371      922        %EJECT;
PL6.E3A0      #003=NIS$DCCON File=NIS$DRIVER.:E05TSI                             WED 07/30/97 03:37 Page:60   
      372      923    2           DO INHIBIT;
      373      924    2              DQH$=CHT.DQH$(BITBIN(CHANNEL));
      374      925    2              DQH.PM.CONNCT=DQH.PM.CONNCT+1;
      375      926    2              IOM$=NI$IOM$(CHANNEL.IOM);
      376      927    2              PTP=S_WSPTD.BLKNO(WSQN)*(HW_PTB_UNITS/HW_IOPTP_UNITS);
      377      928                  /* EACH CWSQ PT REQUIRES 256 WORDS;  CWSQ1 STARTS ON PT BOUNDARY   */
      378      929    2              PTP=PTP+MOD((WSQN-%B_CWSQ1),4)*256/HW_IOPTP_UNITS;
      379      930    2              MBX$=DQH.MBX$;
      380      931    3              IF HW_IMX THEN DO;
      381      932                      %LOCK ( G#=NI$CONNECT.GATE ) ;
      382      935    4                 DO CASE(BITBIN(MASK));
      383      936    4                  CASE(0);                 /* DO A STANDARD CONNECT */
      384      937    4                    NI_IMX_CCW=BITBIN(%IMX_CCW_NDIC);
      385      938    4                  CASE(2);            /* INITIALIZE CHANNEL AS A DIRECT CHANNEL */
      386      939    4                    IMXMBX='0'B;
      387      940    4                    IMXMBX.CLW=%IMX_CLW_INIT;
      388      941    4                    IMXMBX.PAGED_NDIC.PTWADDR(0)=PTP; /*N* WHAT IF PTP = 0?   */
      389      942    4                    IMXMBX.PAGED_NDIC.VALID(0)='1'B;
      390      943    4                    IMXMBX.NDIC_SIZE.PAGES(0)=255;
      391      944    4                    NI_IMX_CCW=BITBIN(%IMX_CCW_INIT_NDIC|%IMX_CCW_PAGED);
      392      945    4                  CASE(7);                 /* PUT THE FEP IN TEST MODE */
      393      946    4                    NI_IMX_CCW=BITBIN(%IMX_CCW_RSO);
      394      947                            /* IMX REQUIRES CHANNEL TO BE INITIALIZED FOLLOWING THIS
      395      948                               BEFORE STANDARD CONNECT CAN BE ISSUED AGAIN;  MCA
      396      949                               ABORT ALL WILL RESULT UNLESS FIRMWARE HAS BEEN FIXED */
      397      950    4                  CASE(ELSE);              /* MASK THE CHANNEL */
      398      951    4                    NI_IMX_CCW=BITBIN(%IMX_CCW_MASK_CHAN);
      399      952    4                  END;
      400      953    3                 NI_IMX_CCW=NI_IMX_CCW+DQH.IOCHANX;
      401      954    3                 NI_CONADDR=DQH.MBXADDR;
      402      955    3                 CALL NIM$IMXCONNECT /* (NI_CONADDR, NI_IMX_CCW) */ ;
      403      956    3                 END;
      404      957    3              ELSE DO;
      405      958    3                 PCW='0000007'O;
      406      959    3                 PCW.CHANNEL=CHANNEL.CHAN;
      407      960    4                 IF PTP~=0 THEN DO;
      408      961    4                    IF HW_IOP THEN
PL6.E3A0      #003=NIS$DCCON File=NIS$DRIVER.:E05TSI                             WED 07/30/97 03:37 Page:61   
      409      962    4                       MBX$->DCMBX.IOP_PTAW=BINBIT(PTP,27)|%IOP_PTA1_INIT;
               962                                /* PHYSADDR */
      410      963    4                    ELSE
      411      964    4                       PCW.PTP=PTP;
      412      965    4                    PCW.CONT='11'B;
      413      966    4                    END;
      414      967    3                 PCW.MASK=MASK;
      415      968    3                 MBX$->DCMBX.PCW=PCW;
      416      969    3                 MBX$->DCMBX.LPW='0'O;
      417      970    3                 MBX$->DCMBX.LPW.ADDRESS=MBXP.ADDRESS+2; /* USED BY IOP ONLY        */
      418      971                      %LOCK ( G#=NI$CONNECT.GATE ) ;
      419      974    3                 CON$=ADDR(IOM.MBX$->NI$MBX(2)); /* CONNECT CHANNEL */
      420      975    4                 DO WHILE(CON$->MBX.LPW.TALLY~=0);
      421      976    4                    END;
      422      977    3                 CON$->MBX.LPW=%CNNCT_LPW_INIT;
      423      978    3                 CON$->MBX.LPW.ADDRESS=MBXP.ADDRESS+2;
      424      979    3                 NI_CONADDR=IOM.ADDRESS;
      425      980    3                 CALL NIM$CONNECT;
      426      981    3                 END;
      427      982    2              IOM.LASTCON=CHANNEL.CHAN;
      428      983    2              IOM.CONNCT=IOM.CONNCT+1;
      429      984                   %UNLOCK ( G#=NI$CONNECT.GATE ) ;
      430      987    2              RETURN;
      431      988    2              END;
      432      989    1   END NIS$DCCON;

PL6.E3A0      #003=NIS$DCCON File=NIS$DRIVER.:E05TSI                             WED 07/30/97 03:37 Page:62   
--  Include file information  --

   S_WSPTD_R.:E05TOU  cannot be made into a system file and is referenced.
   NI$TABLES.:E05TOU  is referenced.
   N$REQ.:E05TOU  is referenced.
   NI_DATA_R.:E05TOU  cannot be made into a system file and is referenced.
   NI_DATA_C.:E05TOU  is referenced.
   HF_DATA_R.:E05TOU  cannot be made into a system file and is referenced.
   HF_LOCK_C.:E05TOU  cannot be made into a system file and is referenced.
   B_STRINGS_C.:E05TOU  is referenced.
      No diagnostics issued in procedure NIS$DCCON.

   Procedure NIS$DCCON requires 185 words for executable code.
   Procedure NIS$DCCON requires 16 words of local(AUTO) storage.

    No errors detected in file NIS$DRIVER.:E05TSI    .

PL6.E3A0      #003=NIS$DCCON File=NIS$DRIVER.:E05TSI                             WED 07/30/97 03:37 Page:63   

 Object Unit name= NIS$DCCON                                  File name= NIS$DRIVER.:E05TOU
 UTS= JUL 30 '97 03:37:38.80 WED                              Compiler= PL-6/E31         Sev=      00
 SharedLib= :SHARED_SYSTEM                                    Alt SharedLib=


    ****  Control sections  ****

 Sect   Type Bound  Init  Size OctSiz  Section name(segment info)
    0  RoData even  UTS      8     10  NIS$DCCON
    1   Proc  even  none   185    271  NIS$DCCON
    2  RoData even  none     2      2  NIS$DCCON

    ****  Entry defs  ****

                              Check   Calling
                             calling  sequence
  Sect OctLoc Primary Altret sequence   type   Parms  Name
     1      0   yes            yes      Std        3  NIS$DCCON

  ****  Entry refs  ****

         Check        Calling
        calling       sequence
Altret sequence SRef   type   Args  Name
         yes           Std       1 HFC$LOCK
         yes           Std       0 NIM$IMXCONNECT
         yes           Std       0 NIM$CONNECT
         yes           Std       1 HFC$UNLOCK
                       Std       0 B_CONSPOOL_D
                       nStd      0 X66_AUTO_3
                       nStd      0 X66_ARET
PL6.E3A0      #003=NIS$DCCON File=NIS$DRIVER.:E05TSI                             WED 07/30/97 03:37 Page:64   

  ****  Data refs  ****

  Flags:  r = read only, s = secondary
Flgs Name                             Flgs Name                             Flgs Name
     HW_PTB_UNITS                          HW_IOPTP_UNITS                        HW_IOP
     HW_IMX                                N$DCT$$                               N$FQ$
     NI$CHT$                               NI$CONNECT$                           NI$FQ$
     NI$IBUF$                              NI$IOM$                               NI$RP$
     NI_CONADDR                            NI_IMX_CCW                            S_WSPTD
     B_VECTNIL
PL6.E3A0      #003=NIS$DCCON File=NIS$DRIVER.:E05TSI                             WED 07/30/97 03:37 Page:65   


      291        1        /*T***********************************************************/
      292        2        /*T*                                                         */
      293        3        /*T* Copyright (c) Bull HN Information Systems Inc., 1997    */
      294        4        /*T*                                                         */
      295        5        /*T***********************************************************/
      296        6        /*D*    NAME:    NIS$DCCON
      297        7                CALL:    CALL NIS$DCCON(CHANNEL,MASK,WSQN)
      298        8                INPUT:   CHANNEL - (LOGICAL IOM#)*128 + CHANNEL NUMBER
      299        9                         MASK - BITS 21-23 OF PCW
      300       10                         WSQN - ENTRY IN THE WSPTD
      301       11                DESCRIPTION:   Issues connect to direct channel.
      302       12                                                                           */
      303       13        NIS$DCCON: PROC(CHANNEL,MASK,WSQN);

     13  1 000000   000000 700200 xent  NIS$DCCON    TSX0  ! X66_AUTO_3
         1 000001   000020 000003                    ZERO    16,3

      304       14        /*
      305       15                Includes
      306       16        */
      307       17        %INCLUDE                B_STRINGS_C ;
      308      146        %INCLUDE                HF_LOCK_C ;
      309      160        %INCLUDE                HF_DATA_R ;
      310      203        %INCLUDE                NI_DATA_C ;
      311      316        %INCLUDE                NI_DATA_R ;
      312      753        %INCLUDE                S_WSPTD_R ;
      313      769        /*
      314      770                Parameters
      315      771        */
      316      772    1   DCL 1 CHANNEL           CALIGNED PARAM,
      317      773    1         2 IOM             UBIN(2) UNAL,
      318      774    1         2 CHAN            UBIN(7) UNAL ;
      319      775    1   DCL MASK                BIT(3) ALIGNED PARAM ;
      320      776    1   DCL WSQN                UBIN PARAM ;
      321      777        /*
      322      778                Entries
PL6.E3A0      #003=NIS$DCCON File=NIS$DRIVER.:E05TSI                             WED 07/30/97 03:37 Page:66   
      323      779        */
      324      780    1   DCL 1 NIM$CONNECT       ENTRY ;
      325      781    1   DCL 1 NIM$IMXCONNECT    ENTRY ;
      326      782        /*
      327      783                Auto
      328      784        */
      329      785    1   DCL 1 CON$              PTR ALIGNED AUTO ;
      330      786    1   DCL 1 DQH$              PTR ALIGNED AUTO ;
      331      787    1   DCL 1 IOM$              PTR ALIGNED AUTO ;
      332      788    1   DCL 1 MBX$              PTR ALIGNED AUTO ;
      333      789    1   DCL 1 MBXP              REDEF MBX$,
      334      790    1         2 ADDRESS         UBIN(18) UNAL,
      335      791    1         2 *               UBIN(18) UNAL;
      336      792    1   DCL 1 PCW               DALIGNED AUTO,
      337      793    1         2 *               BIT(21),
      338      794    1         2 MASK            BIT(3),
      339      795    1         2 *               BIT(12),
      340      796    1         2 CHANNEL         UBIN(9) UNAL,
      341      797    1         2 PTP             UBIN(18) UNAL,
      342      798    1         2 CONT            BIT(2),
      343      799    1         2 *               BIT(7);
      344      800    1   DCL 1 PTP               UBIN ALIGNED AUTO ;
      345      801        /*
      346      802                Based
      347      803        */
      348      804    1   DCL 1 DCMBX             BASED DALIGNED,
      349      805    1         2 LPW,             /* USED ONLY BY THE IOP TO LOCATE PTAW AT ADDRESS-1 */
      350      806    1           3 ADDRESS       UBIN(18) UNAL,
      351      807    1           3 *             UBIN(18) UNAL,
      352      808    1         2 IOP_PTAW,
      353      809    1           3 *             BIT(7) UNAL,
      354      810    1           3 PTA           UBIN(20) UNAL,
      355      811    1           3 *             BIT(2) UNAL,
      356      812    1           3 PHYSADDR      BIT(1) UNAL,
      357      813    1           3 *             BIT(6) UNAL,
      358      814    1         2 PCW             BIT(72) DALIGNED;
      359      815        %NI$CHT                 ( NAME="CHT(0:%(N_MAXCHANS-1))", STCLASS="BASED(NI$CHT$)" )
PL6.E3A0      #003=NIS$DCCON File=NIS$DRIVER.:E05TSI                             WED 07/30/97 03:37 Page:67   
               815            ;
      360      818        %NI$CONNECT             ( NAME=NI$CONNECT,     STCLASS="BASED(NI$CONNECT$)" ) ;
      361      830        %NI$DQH                 ( NAME=DQH,            STCLASS="BASED(DQH$)" ) ;
      362      853        %NI$IMXMBX              ( NAME=IMXMBX,         STCLASS="BASED(MBX$)" ) ;
      363      874        %NI$IOM                 ( NAME=IOM,            STCLASS="BASED(IOM$)" ) ;
      364      879        %NI$MBX                 ( NAME=MBX,            STCLASS="BASED(MBX$)" ) ;
      365      898        %NI$MBX                 ( NAME="NI$MBX(0:63)", STCLASS=BASED ) ;
      366      917        /*
      367      918                Constants
      368      919        */
      369      920        %EQU CNNCT_LPW_INIT='000000020001'O;
      370      921        %EQU IMX_CLW_INIT='000000000020'O;      /* TERMINATE LEVEL = 2 */
      371      922        %EJECT;
PL6.E3A0      #003=NIS$DCCON File=NIS$DRIVER.:E05TSI                             WED 07/30/97 03:37 Page:68   
      372      923    2           DO INHIBIT;

      373      924    2              DQH$=CHT.DQH$(BITBIN(CHANNEL));

    924  1 000002   200003 470700                    LDP0  ! @CHANNEL,,AUTO
         1 000003   000100 101700                    MRL   ! fill='000'O
         1 000004   000000 000001                    ADSC9   0,,PR0                   cn=0,n=1
         1 000005   200016 000004                    ADSC9   PTP+2,,AUTO              cn=0,n=4
         1 000006   200016 236300                    LDQ   ! PTP+2,,AUTO
         1 000007   000001 736200                    QLS   ! 1
         1 000010   000000 471600 xsym               LDP1  ! NI$CHT$
         1 000011   100000 236306                    LDQ   ! 0,QL,PR1
         1 000012   200007 756300                    STQ   ! DQH$,,AUTO

      374      925    2              DQH.PM.CONNCT=DQH.PM.CONNCT+1;

    925  1 000013   200007 473700                    LDP3  ! DQH$,,AUTO
         1 000014   300003 054300                    AOS   ! 3,,PR3

      375      926    2              IOM$=NI$IOM$(CHANNEL.IOM);

    926  1 000015   003100 061700                    CSR   ! bolr='003'O
         1 000016   000000 000002                    BDSC    0,,PR0                   by=0,bit=0,n=2
         1 000017   200016 000022                    BDSC    PTP+2,,AUTO              by=0,bit=0,n=18
         1 000020   200016 220300                    LDX0  ! PTP+2,,AUTO
         1 000021   000000 236210 xsym               LDQ   ! NI$IOM$,X0
         1 000022   200010 756300                    STQ   ! IOM$,,AUTO

      376      927    2              PTP=S_WSPTD.BLKNO(WSQN)*(HW_PTB_UNITS/HW_IOPTP_UNITS);

    927  1 000023   000000 236200 xsym               LDQ   ! HW_PTB_UNITS
         1 000024   000000 506200 xsym               DIV   ! HW_IOPTP_UNITS
         1 000025   200005 474700                    LDP4  ! @WSQN,,AUTO
         1 000026   400000 720300                    LXL0  ! 0,,PR4
         1 000027   200016 756300                    STQ   ! PTP+2,,AUTO
         1 000030   000000 236210 xsym               LDQ   ! S_WSPTD,X0
         1 000031   000022 772200                    QRL   ! 18
PL6.E3A0      #003=NIS$DCCON File=NIS$DRIVER.:E05TSI                             WED 07/30/97 03:37 Page:69   
         1 000032   200017 756300                    STQ   ! PTP+3,,AUTO
         1 000033   200016 236300                    LDQ   ! PTP+2,,AUTO
         1 000034   200017 402300                    MPY   ! PTP+3,,AUTO
         1 000035   200014 756300                    STQ   ! PTP,,AUTO

      377      928                  /* EACH CWSQ PT REQUIRES 256 WORDS;  CWSQ1 STARTS ON PT BOUNDARY   */
      378      929    2              PTP=PTP+MOD((WSQN-%B_CWSQ1),4)*256/HW_IOPTP_UNITS;

    929  1 000036   400000 236300                    LDQ   ! 0,,PR4
         1 000037   000015 136207                    SBLQ  ! 13,DL
         1 000040   000004 506207                    DIV   ! 4,DL
         1 000041   200016 755300                    STA   ! PTP+2,,AUTO
         1 000042   200016 236300                    LDQ   ! PTP+2,,AUTO
         1 000043   000010 736200                    QLS   ! 8
         1 000044   000055 605200 1                  TPL   ! s:929+15
         1 000045   000000 235200 xsym               LDA   ! HW_IOPTP_UNITS
         1 000046   000001 405207                    CMG   ! 1,DL
         1 000047   000056 600200 1                  TZE   ! s:929+16
         1 000050   000000 235203                    LDA   ! 0,DU
         1 000051   000001 737200                    LLS   ! 1
         1 000052   000000 507200 xsym               DVF   ! HW_IOPTP_UNITS
         1 000053   000044 733200                    LRS   ! 36
         1 000054   000056 710200 1                  TRA   ! s:929+16
         1 000055   000000 506200 xsym               DIV   ! HW_IOPTP_UNITS
         1 000056   200014 036300                    ADLQ  ! PTP,,AUTO
         1 000057   200014 756300                    STQ   ! PTP,,AUTO

      379      930    2              MBX$=DQH.MBX$;

    930  1 000060   300021 236300                    LDQ   ! 17,,PR3
         1 000061   200011 756300                    STQ   ! MBX$,,AUTO

      380      931    3              IF HW_IMX THEN DO;

    931  1 000062   000000 234200 xsym               SZN   ! HW_IMX
         1 000063   000157 605200 1                  TPL   ! s:958

PL6.E3A0      #003=NIS$DCCON File=NIS$DRIVER.:E05TSI                             WED 07/30/97 03:37 Page:70   
      381      932                      %LOCK ( G#=NI$CONNECT.GATE ) ;

    933  1 000064   000000 630600 xsym               EPPR0 ! NI$CONNECT$
         1 000065   000017 631600 xsym               EPPR1 ! B_VECTNIL+15
         1 000066   000000 701200 xent               TSX1  ! HFC$LOCK
         1 000067   000000 011200                    NOP   ! 0

      382      935    4                 DO CASE(BITBIN(MASK));

    935  1 000070   200004 470700                    LDP0  ! @MASK,,AUTO
         1 000071   000000 236300                    LDQ   ! 0,,PR0
         1 000072   000041 772200                    QRL   ! 33
         1 000073   000010 116207                    CMPQ  ! 8,DL
         1 000074   000076 602206 1                  TNC   ! s:935+6,QL
         1 000075   000141 710200 1                  TRA   ! s:951
         1 000076   000106 710200 1                  TRA   ! s:937
         1 000077   000141 710200 1                  TRA   ! s:951
         1 000100   000111 710200 1                  TRA   ! s:939
         1 000101   000141 710200 1                  TRA   ! s:951
         1 000102   000141 710200 1                  TRA   ! s:951
         1 000103   000141 710200 1                  TRA   ! s:951
         1 000104   000141 710200 1                  TRA   ! s:951
         1 000105   000136 710200 1                  TRA   ! s:946

      383      936    4                  CASE(0);                 /* DO A STANDARD CONNECT */

      384      937    4                    NI_IMX_CCW=BITBIN(%IMX_CCW_NDIC);

    937  1 000106   000000 235200 0                  LDA   ! 0
         1 000107   000000 755200 xsym               STA   ! NI_IMX_CCW
         1 000110   000143 710200 1                  TRA   ! s:953

      385      938    4                  CASE(2);            /* INITIALIZE CHANNEL AS A DIRECT CHANNEL */

      386      939    4                    IMXMBX='0'B;

    939  1 000111   200011 471700                    LDP1  ! MBX$,,AUTO
PL6.E3A0      #003=NIS$DCCON File=NIS$DRIVER.:E05TSI                             WED 07/30/97 03:37 Page:71   
         1 000112   000100 100600                    MLR   ! fill='000'O
         1 000113   000002 000001 xsym               ADSC9   B_VECTNIL+2              cn=0,n=1
         1 000114   100000 000140                    ADSC9   0,,PR1                   cn=0,n=96

      387      940    4                    IMXMBX.CLW=%IMX_CLW_INIT;

    940  1 000115   000001 236200 0                  LDQ   ! 1
         1 000116   100006 756300                    STQ   ! 6,,PR1

      388      941    4                    IMXMBX.PAGED_NDIC.PTWADDR(0)=PTP; /*N* WHAT IF PTP = 0?   */

    941  1 000117   200014 236300                    LDQ   ! PTP,,AUTO
         1 000120   000012 736200                    QLS   ! 10
         1 000121   100000 676300                    ERQ   ! 0,,PR1
         1 000122   000000 376200 2                  ANQ   ! 0
         1 000123   100000 656300                    ERSQ  ! 0,,PR1

      389      942    4                    IMXMBX.PAGED_NDIC.VALID(0)='1'B;

    942  1 000124   000400 236207                    LDQ   ! 256,DL
         1 000125   100000 256300                    ORSQ  ! 0,,PR1

      390      943    4                    IMXMBX.NDIC_SIZE.PAGES(0)=255;

    943  1 000126   100004 236300                    LDQ   ! 4,,PR1
         1 000127   000001 376200 2                  ANQ   ! 1
         1 000130   001774 276203                    ORQ   ! 1020,DU
         1 000131   100004 756300                    STQ   ! 4,,PR1

      391      944    4                    NI_IMX_CCW=BITBIN(%IMX_CCW_INIT_NDIC|%IMX_CCW_PAGED);

    944  1 000132   000002 236200 0                  LDQ   ! 2
         1 000133   000002 276200 xsym               ORQ   ! B_VECTNIL+2
         1 000134   000000 756200 xsym               STQ   ! NI_IMX_CCW
         1 000135   000143 710200 1                  TRA   ! s:953

      392      945    4                  CASE(7);                 /* PUT THE FEP IN TEST MODE */
PL6.E3A0      #003=NIS$DCCON File=NIS$DRIVER.:E05TSI                             WED 07/30/97 03:37 Page:72   

      393      946    4                    NI_IMX_CCW=BITBIN(%IMX_CCW_RSO);

    946  1 000136   000003 235200 0                  LDA   ! 3
         1 000137   000000 755200 xsym               STA   ! NI_IMX_CCW
         1 000140   000143 710200 1                  TRA   ! s:953

      394      947                            /* IMX REQUIRES CHANNEL TO BE INITIALIZED FOLLOWING THIS
      395      948                               BEFORE STANDARD CONNECT CAN BE ISSUED AGAIN;  MCA
      396      949                               ABORT ALL WILL RESULT UNLESS FIRMWARE HAS BEEN FIXED */
      397      950    4                  CASE(ELSE);              /* MASK THE CHANNEL */

      398      951    4                    NI_IMX_CCW=BITBIN(%IMX_CCW_MASK_CHAN);

    951  1 000141   000004 235200 0                  LDA   ! 4
         1 000142   000000 755200 xsym               STA   ! NI_IMX_CCW

      399      952    4                  END;

      400      953    3                 NI_IMX_CCW=NI_IMX_CCW+DQH.IOCHANX;

    953  1 000143   200007 471700                    LDP1  ! DQH$,,AUTO
         1 000144   100001 236300                    LDQ   ! 1,,PR1
         1 000145   000022 772200                    QRL   ! 18
         1 000146   000777 376207                    ANQ   ! 511,DL
         1 000147   000000 036200 xsym               ADLQ  ! NI_IMX_CCW
         1 000150   000000 756200 xsym               STQ   ! NI_IMX_CCW

      401      954    3                 NI_CONADDR=DQH.MBXADDR;

    954  1 000151   100021 235300                    LDA   ! 17,,PR1
         1 000152   000000 755200 xsym               STA   ! NI_CONADDR

      402      955    3                 CALL NIM$IMXCONNECT /* (NI_CONADDR, NI_IMX_CCW) */ ;

    955  1 000153   000002 631600 xsym               EPPR1 ! B_VECTNIL+2
         1 000154   000000 701200 xent               TSX1  ! NIM$IMXCONNECT
PL6.E3A0      #003=NIS$DCCON File=NIS$DRIVER.:E05TSI                             WED 07/30/97 03:37 Page:73   
         1 000155   000000 011200                    NOP   ! 0

      403      956    3                 END;

    956  1 000156   000255 710200 1                  TRA   ! s:982

      404      957    3              ELSE DO;

      405      958    3                 PCW='0000007'O;

    958  1 000157   003100 060600                    CSL   ! bolr='003'O
         1 000160   000005 000025 0                  BDSC    5                        by=0,bit=0,n=21
         1 000161   200012 000110                    BDSC    PCW,,AUTO                by=0,bit=0,n=72

      406      959    3                 PCW.CHANNEL=CHANNEL.CHAN;

    959  1 000162   003100 061700                    CSR   ! bolr='003'O
         1 000163   000000 020007                    BDSC    0,,PR0                   by=0,bit=2,n=7
         1 000164   200013 000011                    BDSC    PCW+1,,AUTO              by=0,bit=0,n=9

      407      960    4                 IF PTP~=0 THEN DO;

    960  1 000165   200014 235300                    LDA   ! PTP,,AUTO
         1 000166   000204 600200 1                  TZE   ! s:967

      408      961    4                    IF HW_IOP THEN

    961  1 000167   000000 234200 xsym               SZN   ! HW_IOP
         1 000170   000177 605200 1                  TPL   ! s:964

      409      962    4                       MBX$->DCMBX.IOP_PTAW=BINBIT(PTP,27)|%IOP_PTA1_INIT;
               962                                /* PHYSADDR */

    962  1 000171   200014 236300                    LDQ   ! PTP,,AUTO
         1 000172   000011 736200                    QLS   ! 9
         1 000173   000006 276200 0                  ORQ   ! 6
         1 000174   200011 475700                    LDP5  ! MBX$,,AUTO
PL6.E3A0      #003=NIS$DCCON File=NIS$DRIVER.:E05TSI                             WED 07/30/97 03:37 Page:74   
         1 000175   500001 756300                    STQ   ! 1,,PR5
         1 000176   000202 710200 1                  TRA   ! s:965

      410      963    4                    ELSE
      411      964    4                       PCW.PTP=PTP;

    964  1 000177   200014 236300                    LDQ   ! PTP,,AUTO
         1 000200   000011 736200                    QLS   ! 9
         1 000201   200013 552330                    STBQ  ! PCW+1,'30'O,AUTO

      412      965    4                    PCW.CONT='11'B;

    965  1 000202   000600 236207                    LDQ   ! 384,DL
         1 000203   200013 256300                    ORSQ  ! PCW+1,,AUTO

      413      966    4                    END;

      414      967    3                 PCW.MASK=MASK;

    967  1 000204   200004 475700                    LDP5  ! @MASK,,AUTO
         1 000205   500000 236300                    LDQ   ! 0,,PR5
         1 000206   000025 772200                    QRL   ! 21
         1 000207   200012 676300                    ERQ   ! PCW,,AUTO
         1 000210   070000 376207                    ANQ   ! 28672,DL
         1 000211   200012 656300                    ERSQ  ! PCW,,AUTO

      415      968    3                 MBX$->DCMBX.PCW=PCW;

    968  1 000212   200012 237300                    LDAQ  ! PCW,,AUTO
         1 000213   200011 476700                    LDP6  ! MBX$,,AUTO
         1 000214   600002 757300                    STAQ  ! 2,,PR6

      416      969    3                 MBX$->DCMBX.LPW='0'O;

    969  1 000215   600000 450300                    STZ   ! 0,,PR6

      417      970    3                 MBX$->DCMBX.LPW.ADDRESS=MBXP.ADDRESS+2; /* USED BY IOP ONLY        */
PL6.E3A0      #003=NIS$DCCON File=NIS$DRIVER.:E05TSI                             WED 07/30/97 03:37 Page:75   

    970  1 000216   200011 220300                    LDX0  ! MBX$,,AUTO
         1 000217   000002 621210                    EAX1  ! 2,X0
         1 000220   600000 741300                    STX1  ! 0,,PR6

      418      971                      %LOCK ( G#=NI$CONNECT.GATE ) ;

    972  1 000221   000000 630600 xsym               EPPR0 ! NI$CONNECT$
         1 000222   000017 631600 xsym               EPPR1 ! B_VECTNIL+15
         1 000223   000000 701200 xent               TSX1  ! HFC$LOCK
         1 000224   000000 011200                    NOP   ! 0

      419      974    3                 CON$=ADDR(IOM.MBX$->NI$MBX(2)); /* CONNECT CHANNEL */

    974  1 000225   200010 470700                    LDP0  ! IOM$,,AUTO
         1 000226   000002 471700                    LDP1  ! 2,,PR0
         1 000227   100010 633700                    EPPR3 ! 8,,PR1
         1 000230   200006 453700                    STP3  ! CON$,,AUTO

      420      975    4                 DO WHILE(CON$->MBX.LPW.TALLY~=0);

    975  1 000231   300000 236300                    LDQ   ! 0,,PR3
         1 000232   007777 316207                    CANQ  ! 4095,DL
         1 000233   000240 600200 1                  TZE   ! s:977

      421      976    4                    END;

    976  1 000234   200006 470700                    LDP0  ! CON$,,AUTO
         1 000235   000000 236300                    LDQ   ! 0,,PR0
         1 000236   007777 316207                    CANQ  ! 4095,DL
         1 000237   000234 601200 1                  TNZ   ! s:976

      422      977    3                 CON$->MBX.LPW=%CNNCT_LPW_INIT;

    977  1 000240   000007 236200 0                  LDQ   ! 7
         1 000241   200006 470700                    LDP0  ! CON$,,AUTO
         1 000242   000000 756300                    STQ   ! 0,,PR0
PL6.E3A0      #003=NIS$DCCON File=NIS$DRIVER.:E05TSI                             WED 07/30/97 03:37 Page:76   

      423      978    3                 CON$->MBX.LPW.ADDRESS=MBXP.ADDRESS+2;

    978  1 000243   200011 220300                    LDX0  ! MBX$,,AUTO
         1 000244   000002 621210                    EAX1  ! 2,X0
         1 000245   000000 741300                    STX1  ! 0,,PR0

      424      979    3                 NI_CONADDR=IOM.ADDRESS;

    979  1 000246   200010 471700                    LDP1  ! IOM$,,AUTO
         1 000247   100003 236300                    LDQ   ! 3,,PR1
         1 000250   000007 376207                    ANQ   ! 7,DL
         1 000251   000000 756200 xsym               STQ   ! NI_CONADDR

      425      980    3                 CALL NIM$CONNECT;

    980  1 000252   000002 631600 xsym               EPPR1 ! B_VECTNIL+2
         1 000253   000000 701200 xent               TSX1  ! NIM$CONNECT
         1 000254   000000 011200                    NOP   ! 0

      426      981    3                 END;

      427      982    2              IOM.LASTCON=CHANNEL.CHAN;

    982  1 000255   200003 470700                    LDP0  ! @CHANNEL,,AUTO
         1 000256   200010 471700                    LDP1  ! IOM$,,AUTO
         1 000257   003100 061700                    CSR   ! bolr='003'O
         1 000260   000000 020007                    BDSC    0,,PR0                   by=0,bit=2,n=7
         1 000261   100003 000011                    BDSC    3,,PR1                   by=0,bit=0,n=9

      428      983    2              IOM.CONNCT=IOM.CONNCT+1;

    983  1 000262   100005 054300                    AOS   ! 5,,PR1

      429      984                   %UNLOCK ( G#=NI$CONNECT.GATE ) ;

    985  1 000263   000000 630600 xsym               EPPR0 ! NI$CONNECT$
PL6.E3A0      #003=NIS$DCCON File=NIS$DRIVER.:E05TSI                             WED 07/30/97 03:37 Page:77   
         1 000264   000017 631600 xsym               EPPR1 ! B_VECTNIL+15
         1 000265   000000 701200 xent               TSX1  ! HFC$UNLOCK
         1 000266   000000 011200                    NOP   ! 0

      430      987    2              RETURN;

    987  1 000267   000000 702200 xent               TSX2  ! X66_ARET

      431      988    2              END;

      432      989    1   END NIS$DCCON;

    989  1 000270   000000 702200 xent               TSX2  ! X66_ARET

(unnamed)
 Sect OctLoc
   0     000   200000 000000   000000 000020   640000 000000   630000 000000    ................
   0     004   604000 000000   000000 700000   000000 000100   000000 020001    ...........@....

(unnamed)
 Sect OctLoc
   2     000   777777 776000   000003 777777                                    ........

PL6.E3A0      #003=NIS$DCCON File=NIS$DRIVER.:E05TSI                             WED 07/30/97 03:37 Page:78   
--  Include file information  --

   S_WSPTD_R.:E05TOU  cannot be made into a system file and is referenced.
   NI$TABLES.:E05TOU  is referenced.
   N$REQ.:E05TOU  is referenced.
   NI_DATA_R.:E05TOU  cannot be made into a system file and is referenced.
   NI_DATA_C.:E05TOU  is referenced.
   HF_DATA_R.:E05TOU  cannot be made into a system file and is referenced.
   HF_LOCK_C.:E05TOU  cannot be made into a system file and is referenced.
   B_STRINGS_C.:E05TOU  is referenced.
      No diagnostics issued in procedure NIS$DCCON.
PL6.E3A0      #003=NIS$DCCON File=NIS$DRIVER.:E05TSI                             WED 07/30/97 03:37 Page:79   

 **** Variables and constants ****

  ****  Auto variables  ****

  ****  Scalars and arrays  ****
OctLoc.c.b A Datatyp(siz) R M Lvl/name                 OctLoc.c.b A Datatyp(siz) R M Lvl/name

     3-0-0/w PTR         r     1 @CHANNEL                   4-0-0/w PTR         r     1 @MASK
     5-0-0/w PTR         r     1 @WSQN                     *0-0-0/c STRC(9)     r     1 CHANNEL
     6-0-0/w PTR         r     1 CON$                       7-0-0/w PTR         r     1 DQH$
    10-0-0/w PTR         r     1 IOM$                      *0-0-0/w BIT (3)     r     1 MASK
    11-0-0/w PTR         r     1 MBX$                      11-0-0/w STRC        r     1 MBXP
    12-0-0/d STRC(72)    r     1 PCW                       14-0-0/w UBIN        r     1 PTP
    *0-0-0/w UBIN        r     1 WSQN

  ****  SYMREF variables  ****

  ****  Scalars and arrays  ****
OctLoc.c.b A Datatyp(siz) R M Lvl/name                 OctLoc.c.b A Datatyp(siz) R M Lvl/name

     0-0-0/w BIT         r     1 HW_IMX                     0-0-0/w BIT         r     1 HW_IOP
     0-0-0/w SBIN        r     1 HW_IOPTP_UNITS             0-0-0/w SBIN        r     1 HW_PTB_UNITS
     0-0-0/w PTR         r     1 N$DCT$$                    0-0-0/w PTR         r     1 N$FQ$
     0-0-0/w PTR         r     1 NI$CHT$                    0-0-0/w PTR         r     1 NI$CONNECT$
     0-0-0/w PTR         r     1 NI$FQ$                     0-0-0/w PTR         r     1 NI$IBUF$
     0-0-0/w PTR         r     1 NI$IOM$(0:3)
     0-0-0/w PTR         r     1 NI$RP$                     0-0-0/w UBIN        r     1 NI_CONADDR
     0-0-0/w UBIN        r     1 NI_IMX_CCW                 0-0-0/w STRC        r     1 S_WSPTD(0:28)

  ****  BASED and DCB variables  ****

  ****  Scalars and arrays  ****
OctLoc.c.b A Datatyp(siz) R M Lvl/name                 OctLoc.c.b A Datatyp(siz) R M Lvl/name

     0-0-0/w STRC(72)    r     1 CHT(0:127)                 0-0-0/d STRC(144)   r     1 DCMBX
     0-0-0/w STRC(648)   r     1 DQH                        0-0-0/d STRC(864)   r     1 IMXMBX
     0-0-0/w STRC(252)   r     1 IOM                        0-0-0/d STRC(144)   r     1 MBX
PL6.E3A0      #003=NIS$DCCON File=NIS$DRIVER.:E05TSI                             WED 07/30/97 03:37 Page:80   
     0-0-0/w STRC(144)   r     1 NI$CONNECT                 0-0-0/d STRC(144)   r     1 NI$MBX(0:63)


   Procedure NIS$DCCON requires 185 words for executable code.
   Procedure NIS$DCCON requires 16 words of local(AUTO) storage.

    No errors detected in file NIS$DRIVER.:E05TSI    .
PL6.E3A0      #003=NIS$DCCON File=NIS$DRIVER.:E05TSI                             WED 07/30/97 03:37 Page:81   
          *** CROSS REFERENCE LISTING ***
**     DENOTES     IDENTIFIER DEFINITION
<<                 IDENTIFIER'S VALUE SET
>>                 IDENTIFIER'S VALUE USED
<>                 IDENTIFIER SET AND/OR USED
--                 IDENTIFIER REFERENCED
PL6.E3A0      #003=NIS$DCCON File=NIS$DRIVER.:E05TSI                             WED 07/30/97 03:37 Page:82   
          MINI XREF LISTING

CHANNEL
       772**DCL        13--PROC      924>>ASSIGN
CHANNEL.CHAN
       774**DCL       959>>ASSIGN    982>>ASSIGN
CHANNEL.IOM
       773**DCL       926>>ASSIGN
CHT.DQH$
       816**DCL       924>>ASSIGN
CON$
       785**DCL       974<<ASSIGN    975>>DOWHILE   977>>ASSIGN    978>>ASSIGN
DCMBX.IOP_PTAW
       808**DCL       962<<ASSIGN
DCMBX.LPW
       805**DCL       969<<ASSIGN
DCMBX.LPW.ADDRESS
       806**DCL       970<<ASSIGN
DCMBX.PCW
       814**DCL       968<<ASSIGN
DQH.IOCHANX
       841**DCL       842--REDEF     953>>ASSIGN
DQH.MBX$
       850**DCL       851--REDEF     930>>ASSIGN
DQH.MBXADDR
       851**DCL       954>>ASSIGN
DQH.PM.CONNCT
       844**DCL       925<<ASSIGN    925>>ASSIGN
DQH$
       786**DCL       839--IMP-PTR   924<<ASSIGN    925>>ASSIGN    925>>ASSIGN    930>>ASSIGN    953>>ASSIGN
       954>>ASSIGN
HFC$LOCK
       159**DCL-ENT   933--CALL      972--CALL
HFC$UNLOCK
PL6.E3A0      #003=NIS$DCCON File=NIS$DRIVER.:E05TSI                             WED 07/30/97 03:37 Page:83   
       159**DCL-ENT   985--CALL
HW_IMX
       202**DCL       931>>IF
HW_IOP
       199**DCL       961>>IF
HW_IOPTP_UNITS
       197**DCL       927>>ASSIGN    929>>ASSIGN
HW_PTB_UNITS
       197**DCL       927>>ASSIGN
IMXMBX
       862**DCL       939<<ASSIGN
IMXMBX.CLW
       865**DCL       940<<ASSIGN
IMXMBX.NDIC_SIZE.PAGES
       865**DCL       943<<ASSIGN
IMXMBX.PAGED_BASE
       862**DCL       863--REDEF     863--REDEF
IMXMBX.PAGED_NDIC.PTWADDR
       864**DCL       941<<ASSIGN
IMXMBX.PAGED_NDIC.VALID
       864**DCL       942<<ASSIGN
IMXMBX.SIZE
       864**DCL       864--REDEF
IOM.ADDRESS
       876**DCL       979>>ASSIGN
IOM.CONNCT
       877**DCL       983<<ASSIGN    983>>ASSIGN
IOM.LASTCON
       875**DCL       982<<ASSIGN
IOM.MBX$
       875**DCL       974>>ASSIGN
IOM$
       787**DCL       875--IMP-PTR   926<<ASSIGN    974>>ASSIGN    979>>ASSIGN    982>>ASSIGN    983>>ASSIGN
       983>>ASSIGN
MASK
       775**DCL        13--PROC      935>>DOCASE    967>>ASSIGN
PL6.E3A0      #003=NIS$DCCON File=NIS$DRIVER.:E05TSI                             WED 07/30/97 03:37 Page:84   
MBX.DCW.CONTROL.AE
       895**DCL       895--REDEF
MBX.LPW
       890**DCL       977<<ASSIGN
MBX.LPW.ADDRESS
       890**DCL       978<<ASSIGN
MBX.LPW.CONTROL.AE
       891**DCL       891--REDEF
MBX.LPW.TALLY
       892**DCL       975>>DOWHILE
MBX$
       788**DCL       789--REDEF     862--IMP-PTR   890--IMP-PTR   930<<ASSIGN    939>>ASSIGN    940>>ASSIGN
       941>>ASSIGN    942>>ASSIGN    943>>ASSIGN    962>>ASSIGN    968>>ASSIGN    969>>ASSIGN    970>>ASSIGN
MBXP.ADDRESS
       790**DCL       970>>ASSIGN    978>>ASSIGN
N$DCT$$
       614**DCL       748--IMP-PTR
N$FQ$
       614**DCL       749--IMP-PTR
N$REQ_INIT.BUFADDR
       633**DCL       634--REDEF     634--REDEF
N$REQ_INIT.DLA.DRELADDR
       625**DCL       625--REDEF
N$REQ_INIT.DVE.EOMCHAR
       662**DCL       663--REDEF
N$REQ_INIT.EAINFO
       656**DCL       656--REDEF
N$REQ_INIT.EAINFOX
       656**DCL       657--REDEF
N$REQ_INIT.EVNTINFO
       657**DCL       657--REDEF
N$REQ_INIT.STATUS
       638**DCL       644--REDEF
NI$CHT$
       673**DCL       816--IMP-PTR   924>>ASSIGN
NI$CONNECT.GATE
PL6.E3A0      #003=NIS$DCCON File=NIS$DRIVER.:E05TSI                             WED 07/30/97 03:37 Page:85   
       827**DCL       933<>CALL      972<>CALL      985<>CALL
NI$CONNECT$
       673**DCL       827--IMP-PTR   933>>CALL      972>>CALL      985>>CALL
NI$FQ$
       674**DCL       750--IMP-PTR
NI$IBUF$
       674**DCL       750--IMP-PTR
NI$IMXMBX_INIT.PAGED_BASE
       684**DCL       685--REDEF     685--REDEF
NI$IMXMBX_INIT.SIZE
       686**DCL       686--REDEF
NI$IOM$
       696**DCL       926>>ASSIGN
NI$MBX
       909**DCL       974--ASSIGN
NI$MBX.DCW.CONTROL.AE
       914**DCL       914--REDEF
NI$MBX.LPW.CONTROL.AE
       910**DCL       910--REDEF
NI$REQ_INIT.DCW
       708**DCL       711--REDEF
NI$REQ_INIT.DCW.TALLY
       709**DCL       709--REDEF
NI$REQ_INIT.IDCW.EXTA
       711**DCL       711--REDEF
NI$REQ_INIT.PCW
       713**DCL       717--REDEF
NI$REQ_INIT.SEEK
       718**DCL       719--REDEF     720--REDEF
NI$RP$
       722**DCL       752--IMP-PTR
NIM$CONNECT
       780**DCL-ENT   980--CALL
NIM$IMXCONNECT
       781**DCL-ENT   955--CALL
NI_CONADDR
PL6.E3A0      #003=NIS$DCCON File=NIS$DRIVER.:E05TSI                             WED 07/30/97 03:37 Page:86   
       723**DCL       954<<ASSIGN    979<<ASSIGN
NI_IMX_CCW
       724**DCL       937<<ASSIGN    944<<ASSIGN    946<<ASSIGN    951<<ASSIGN    953<<ASSIGN    953>>ASSIGN
NI_MBX_INIT.DCW.CONTROL.AE
       744**DCL       744--REDEF
NI_MBX_INIT.LPW.CONTROL.AE
       740**DCL       740--REDEF
PCW
       792**DCL       958<<ASSIGN    968>>ASSIGN
PCW.CHANNEL
       796**DCL       959<<ASSIGN
PCW.CONT
       798**DCL       965<<ASSIGN
PCW.MASK
       794**DCL       967<<ASSIGN
PCW.PTP
       797**DCL       964<<ASSIGN
PTP
       800**DCL       927<<ASSIGN    929<<ASSIGN    929>>ASSIGN    941>>ASSIGN    960>>IF        962>>ASSIGN
       964>>ASSIGN
S_WSPTD.BLKNO
       761**DCL       927>>ASSIGN
WSQN
       776**DCL        13--PROC      927>>ASSIGN    929>>ASSIGN
