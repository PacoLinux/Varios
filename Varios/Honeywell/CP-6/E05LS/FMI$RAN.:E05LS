VERSION E05

PL6.E3A0      #001=FMI$RAN File=FMI$RAN.:E05TSI                                  TUE 07/29/97 16:49 Page:1    
        1        1        /*M*   FMI$RAN - Random and block access disk file PMME processing */
        2        2        /*T***********************************************************/
        3        3        /*T*                                                         */
        4        4        /*T* Copyright (c) Bull HN Information Systems Inc., 1997    */
        5        5        /*T*                                                         */
        6        6        /*T***********************************************************/
        7        7        /**/
        8        8        /*X* */
        9        9        /**/
       10       10        /**/
       11       11        FMI$RAN: PROC(FPTCODE) ALTRET;
       12       12        /* PARAMETERS */
       13       13    1   DCL FPTCODE UBIN(36);
       14       14        /* LOCAL AUTOMATIC STORAGE */
       15       15    1   DCL JDCB$ PTR;
       16       16    1   DCL CFU$ PTR;
       17       17    1   DCL G$ PTR;
       18       18    1   DCL P$ PTR;
       19       19    1   DCL GBYTES UBIN;
       20       20    1   DCL DA UBIN;
       21       21    1   DCL BLKSIZ SBIN;
       22       22    1   DCL N SBIN;
       23       23    1   DCL I SBIN;
       24       24    1   DCL BUFDISP UBIN;
       25       25    1   DCL BUFSIZ UBIN;
       26       26    1   DCL UGRANS UBIN;
       27       27    1   DCL FC UBIN;
       28       28    1   DCL UB$ PTR;
       29       29    1   DCL VPNO SBIN;
       30       30    1   DCL 1 WSRS DALIGNED,
       31       31    1         2 R(0:7) UBIN(9) UNAL;
       32       32    1   DCL 1 DESC,
       33       33    1         2 * BIT(29),
       34       34    1         2 WSR UBIN(3) UNAL,
       35       35    1         2 * BIT(4),
       36       36    1         2 BASE SBIN;
       37       37    1   DCL WSQ SBIN;
PL6.E3A0      #001=FMI$RAN File=FMI$RAN.:E05TSI                                  TUE 07/29/97 16:49 Page:2    
       38       38    1   DCL 1 STAMP,
       39       39    1         2 HASH UBIN(27) UNAL,
       40       40    1         2 GMOD UBIN(9) UNAL;
       41       41    1   DCL Q$ PTR;
       42       42    1   DCL TEMP_CHAR CHAR(1) CALIGNED;
       43       43        /* BASED STRUCTURES */
       44       44    1   DCL CHAR1 CHAR(1) UNAL BASED;
       45       45    1   DCL CHAR4 CHAR(4) BASED;
       46       46    1   DCL CLEAR CHAR(GBYTES) BASED;
       47       47    1   DCL WRDS(0:1023) SBIN BASED ALIGNED;
       48       48    1   DCL 1 CLR BASED ALIGNED,
       49       49    1         2 * SBIN,
       50       50    1         2 X CHAR(4092);
       51       51        /* EXTERNAL DATA */
       52       52    1   DCL B$JIT$ PTR SYMREF;
       53       53    1   DCL B$PS0$ PTR SYMREF READONLY;
       54       54    1   DCL B$PS1$ PTR SYMREF READONLY;
       55       55    1   DCL B$PS2$ PTR SYMREF READONLY;
       56       56    1   DCL FM$BUF$(0:0) PTR SYMREF;
       57       57        /* INCLUDE FILES */
       58       58        %INCLUDE F$JIT_C;
       59      488        %MACRO F$DCB (BASED="BASED(JDCB$)");
       60      489        %INCLUDE F$DCB;
       61      538        %MEND;
       62      539        %INCLUDE HF_LOCK_C;
       63      553        %INCLUDE FM$MACROS;
       64      928        %INCLUDE FM_DATA_R;
       65      942        %INCLUDE F_CODE_R;
       66      952        %INCLUDE F_FPTCODE_C;
       67      988        %INCLUDE F_ERRORS_C;
       68     1228        %INCLUDE F$CP6V_C;
       69     1454        %INCLUDE N_FC_C;
       70     1491        %INCLUDE N$REQ;
       71     1565        %INCLUDE B$USER;
       72     1781        %B$USERREFS;
       73     1785        %INCLUDE CP_6_SUBS;
       74     2325        %INCLUDE FM$RANEA;
PL6.E3A0      #001=FMI$RAN File=FMI$RAN.:E05TSI                                  TUE 07/29/97 16:49 Page:3    
       75     2335        %INCLUDE UM$CP6V_C;
       76     2522        /* EXTERNAL ROUTINES */
       77     2523    1   DCL FAG$GEXT ENTRY ALTRET;
       78     2524    1   DCL FMB$LOGERR ENTRY(11);
       79     2525    1   DCL FMB$QUEUE ENTRY(9) ALTRET;
       80     2526    1   DCL FMB$IOSPIN ENTRY;
       81     2527    1   DCL FMC$CLR1 ENTRY(1);
       82     2528    1   DCL FMC$GET ENTRY(4) ALTRET;
       83     2529    1   DCL FMD$FLSHBUF ENTRY(1);
       84     2530    1   DCL FMD$GETBUF ENTRY(3);
       85     2531    1   DCL FMD$RECTRAN ENTRY(8) ALTRET;
       86     2532    1   DCL FMD$RELBUF ENTRY(1);
       87     2533    1   DCL FMI$EA ENTRY(1);
       88     2534    1   DCL FMO$LOCCODT ENTRY(2) ALTRET;
       89     2535    1   DCL HFC$STWS ENTRY(1);
       90     2536    1   DCL HFF$NILERASE ENTRY(1) ALTRET;
       91     2537    1   DCL HFF$RET_PS_DESC ENTRY(2) ALTRET;
       92     2538    1   DCL HFF$WRITE1 ENTRY(1) ALTRET;
       93     2539    1   DCL MMC$CP_IOM ENTRY(3);
       94     2540    1   DCL MMC$ONLY_IOM ENTRY(3);
       95     2541    1   DCL NIQ$GET ENTRY(1) ALTRET;
       96     2542    1   DCL NIQ$REL ENTRY(1) ALTRET;
       97     2543    1   DCL NIQ$RELS ENTRY(1) ALTRET;
       98     2544    1   DCL SSS$SYSTIME ENTRY(1);
       99     2545    1   DCL UQB$MDEQ ENTRY(1) ALTRET;
      100     2546    1   DCL UQB$MENQXB ENTRY(1) ALTRET;
      101     2547        /* CONSTANT STORAGE */
      102     2548        %SUB FCG#='0615'O;
      103     2549        %SUB MID#='11'O;
      104     2550        %ERRCODE (NAME=ERREOF,COD#=%E$EOF);
      105     2554        %ERRCODE (NAME=ERRBOF,COD#=%E$BOF);
      106     2558        %ERRCODE (NAME=ERRBADBLK,COD#=%E$RANBADBLK);
      107     2562        %ERRCODE (NAME=ERRLD,COD#=%E$LD);
      108     2566        %ERRCODE (NAME=ERRRANBOUND,COD#=%E$RANBOUND);
      109     2570        %ERRCODE (NAME=ERRMTRAP,COD#=%E$MTRAP);
      110     2574        %ERRCODE (NAME=ERRDI,COD#=%E$DI);
      111     2578        %ERRCODE (NAME=ERRWRDEL,COD#=%E$WRDEL);
PL6.E3A0      #001=FMI$RAN File=FMI$RAN.:E05TSI                                  TUE 07/29/97 16:49 Page:4    
      112     2582        %ERRCODE (NAME=ERRBADVECT2,COD#= 422 );
      113     2586        /* FPTS */
      114     2587        %FPT$READ_V (BASED="BASED(B$PS0$)");
      115     2594        %FPT$WRITE_V (BASED="BASED(B$PS0$)");
      116     2600        %FPT$PFIL_V (BASED="BASED(B$PS0$)");
      117     2603        %FPT$EXTEND_V (BASED="BASED(B$PS0$)");
      118     2606        %FPT$PRECORD_V (BASED="BASED(B$PS0$)");
      119     2611        %FPT$DELREC_V (BASED="BASED(B$PS0$)");
      120     2615        /* BASED STRUCTURES */
      121     2616        %FM$GRAN;
      122     2620        %FM$SET(BASED="BASED(F$CFU$)");
      123     2625        %FM$VOL(BASED="BASED(F$CFU$)");
      124     2631        %F$DCB;
      125     2681        %FM$CFU (BASED="BASED(CFU$)");
      126     2687        %FM$RANEA (BASED="BASED(P$)");
      127     2690        %FM$VID;
      128     2696        %N$REQ (NAME=N$REQ,STCLASS=BASED);
      129     2754    1   DCL XLATE926(0:31)BIT(36)CONSTANT INIT(
      130     2755    1   '020020020020'O*8,'020077076013'O,'053074032073'O, /* ctl !"# $%&'            */
      131     2756    1   '035055054060'O,'073052033061'O,'000001002003'O, /* ()*+,-./0123              */
      132     2757    1   '004005006007'O,'010012015056'O,'036075016016'O, /* 456789:;<=>?              */
      133     2758    1   '014021022023'O,'024025026027'O,'030031041042'O, /* @ABCDEFGHIJK              */
      134     2759    1   '043044045046'O,'047050051062'O,'062064065066'O, /* LMNOPQRSTUVW              */
      135     2760    1   '067070071012'O,'037034040072'O,        /* XYZ[\]^_                           */
      136     2761    1   '020021022023'O,'024025026027'O,'030031041042'O, /* `abcdefghijk              */
      137     2762    1   '043044045046'O,'047050051062'O,'062064065066'O, /* lmnopqrstuvw              */
      138     2763    1   '067070071012'O,'037034040020'O);       /* xyz{|}~del                         */
      139     2764        %VLR$SITEINFO_V(FPTN=B_SITEINFO,BASED=SYMREF);
      140     2769    1   DCL CHARS CHAR(N) BASED UNAL;
      141     2770        /**/
      142     2771    1           JDCB$=B$JIT.DCB$;               /* POINTER TO CURRENT DCB             */
      143     2772    1           CFU$=F$DCB.CFU$;                /* CURRENT CFU                        */
      144     2773    1           B$JIT.ERR='0'B;                 /* CLEAR ERROR CODE IN JIT            */
      145     2774        /**/
      146     2775    1           IF F$DCB.ASN=%DEVICE# THEN
      147     2776    1              UGRANS=FM$SET$->FM$SET.NXTSDA(F$DCB.SETX)-FM_SRZERO; /* DEV PACK   */
      148     2777    1           ELSE
PL6.E3A0      #001=FMI$RAN File=FMI$RAN.:E05TSI                                  TUE 07/29/97 16:49 Page:5    
      149     2778    1              UGRANS=FM$CFU.UGRANS;        /* FILE                               */
      150     2779        /**/
      151     2780    2           DO CASE(FPTCODE);
      152     2781    2            CASE(ELSE);                    /* DO NOTHING FOR OTHER PMMES         */
      153     2782        /**********************/
      154     2783        /******  OTHERS  ******/
      155     2784        /**********************/
      156     2785    2              RETURN;
      157     2786    2            CASE(FPTPFILEOF);
      158     2787        /**********************/
      159     2788        /*** FILE EXTENTION ***/
      160     2789        /*********************/
      161     2790    2              GOTO PFILEOF;
      162     2791    2            CASE(FPTREW);
      163     2792        /**********************/
      164     2793        /******  M$REW  *******/
      165     2794        /**********************/
      166     2795    2   REW:       JDCB$->F$DCB.CRECNO=0;       /* POSITION TO BOF                    */
      167     2796    2              RETURN;
      168     2797    2            CASE(FPTPFIL);
      169     2798        /*********************/
      170     2799        /*****  M$PFIL  ******/
      171     2800        /*********************/
      172     2801    2              IF FPT$PFIL_V.BOF THEN
      173     2802    2                 GOTO REW;
      174     2803    3              ELSE DO;
      175     2804    3   PFILEOF:      F$DCB.CRECNO=UGRANS;
      176     2805    3                 RETURN;
      177     2806    3                 END;
      178     2807        /**/
      179     2808    2            CASE(FPTPREC);
      180     2809        /********************/
      181     2810        /***  M$PRECORD  ****/
      182     2811        /********************/
      183     2812    2              FC=1;
      184     2813    2              IF FPT$PRECORD_V.BOF THEN
      185     2814    2                 F$DCB.CRECNO=0;
PL6.E3A0      #001=FMI$RAN File=FMI$RAN.:E05TSI                                  TUE 07/29/97 16:49 Page:6    
      186     2815    2              ELSE IF FPT$PRECORD_V.EOF THEN
      187     2816    2                    F$DCB.CRECNO=UGRANS;
      188     2817    2                 ELSE IF FPT$PRECORD_V.KEYS THEN
      189     2818    2                       ADDR(F$DCB.CRECNO)->CHAR4=B$PS1$->CHAR4; /* Move user key */
      190     2819    3                    ELSE DO;               /* Position by N                      */
      191     2820    3   PREC2:              FC=0;
      192     2821    3                       BLKSIZ=F$DCB.CRECNO; /* REMEMBER OLD POSITION             */
      193     2822    3                       F$DCB.CRECNO=F$DCB.CRECNO+FPT$PRECORD_V.N;
      194     2823    3                       END;
      195     2824    3              IF F$DCB.CRECNO<0 OR F$DCB.CRECNO>UGRANS THEN DO;
      196     2825    4                 IF F$DCB.CRECNO<0 THEN DO;
      197     2826    4                    F$DCB.CRECNO=0;        /* HIT BOF                            */
      198     2827    4                    B$JIT.ERR=ERRBOF;
      199     2828    4                    END;
      200     2829        /*E*   ERROR:    FMI-E$BOF-2
      201     2830        *      DESCRIPTION:  An M$PRECORD by number of records attempted to
      202     2831        *        position beyond the beginning of the file.
      203     2832        */
      204     2833    4                 IF F$DCB.CRECNO>UGRANS THEN DO;
      205     2834    4                    F$DCB.CRECNO=UGRANS;
      206     2835    4                    B$JIT.ERR=ERREOF;
      207     2836    4                    END;
      208     2837    3                 IF FPT$PRECORD_V.KEYS THEN /* IF POSITIONED BY EXPLICIT         */
      209     2838    3                    B$JIT.ERR=ERRBADBLK;   /* KEY, GIVE DIFFERENT ERROR          */
      210     2839    3                 END;
      211     2840        /**/
      212     2841    3              IF FC=0 THEN DO;             /* Positioning by N                   */
      213     2842    3                 F$DCB.ARS=F$DCB.CRECNO-BLKSIZ; /* CALC # RECS SKIPPED           */
      214     2843    3                 IF F$DCB.ARS<0 THEN
      215     2844    3                    F$DCB.ARS=-F$DCB.ARS;
      216     2845    3                 END;
      217     2846    2              ELSE
      218     2847    2                 GOTO PREC2;          /*  Make another pass for position by N    */
      219     2848        /**/
      220     2849    2              IF FPT$PRECORD_V.KEYR THEN
      221     2850    2                 B$PS1$->CHAR4=ADDR(F$DCB.CRECNO)->CHAR4; /* Return key to user  */
      222     2851    2              GOTO SETEOP;
PL6.E3A0      #001=FMI$RAN File=FMI$RAN.:E05TSI                                  TUE 07/29/97 16:49 Page:7    
      223     2852        /**/
      224     2853    2            CASE(FPTDELREC);
      225     2854        /**********************/
      226     2855        /***  M$DELREC  *****/
      227     2856        /**********************/
      228     2857    2              F$DCB.ARS=0;
      229     2858    2              IF F$DCB.ASN=%FILE# AND FPT$DELREC_V.DELALL THEN
      230     2859    2                 VPNO=0;
      231     2860    3              ELSE DO;
      232     2861    3                 CALL HFF$NILERASE(1) ALTRET(DELERR); /* MUST HAVE KEY           */
      233     2862    3                 ADDR(VPNO)->CHAR4=B$PS1$->CHAR4; /* GET FIRST KEY               */
      234     2863    3                 END;
      235     2864    2              IF F$DCB.ASN=%DEVICE# THEN
      236     2865    2                 IF VPNO>=FM_SRZERO THEN
      237     2866    2                    VPNO=VPNO-FM_SRZERO;
      238     2867    2              WSQ=VPNO;                    /* ASSUME ONLY ONE GRAN               */
      239     2868    2              IF F$DCB.ASN=%FILE# AND FPT$DELREC_V.DELALL THEN
      240     2869    2                 WSQ=UGRANS-1;
      241     2870    3              ELSE DO;
      242     2871    3                 CALL HFF$NILERASE(2) ALTRET(DELR20);
      243     2872    3                 ADDR(WSQ)->CHAR4=B$PS2$->CHAR4; /* GET END KEY                  */
      244     2873    3                 END;
      245     2874    2              IF F$DCB.ASN=%DEVICE# THEN
      246     2875    2                 IF WSQ>=FM_SRZERO THEN
      247     2876    2                    WSQ=WSQ-FM_SRZERO;
      248     2877    2              IF WSQ>UGRANS-1 THEN
      249     2878    2                 WSQ=UGRANS-1;             /* LIMIT TO TOTAL SIZE                */
      250     2879    2              IF VPNO<0 THEN
      251     2880    2                 IF WSQ<0 THEN
      252     2881    2                    GOTO SETEOP;           /* BEGINNING AND END ARE ILLEGAL      */
      253     2882    2                 ELSE
      254     2883    2                    VPNO=0;
      255     2884    2              GOTO DELR30;
      256     2885        /**/
      257     2886    2   DELR20:    IF VPNO<0 THEN
      258     2887    2                 GOTO BADBLK;         /* ILLEGAL BLOCK # FOR SINGLE BLOCK DELETE */
      259     2888        /**/
PL6.E3A0      #001=FMI$RAN File=FMI$RAN.:E05TSI                                  TUE 07/29/97 16:49 Page:8    
      260     2889    2   DELR30:    N=WSQ-VPNO+1;                /* # GRANS TO TRASH                   */
      261     2890    2              F$DCB.ARS=N;
      262     2891    2              IF F$DCB.ASN=%DEVICE# THEN
      263     2892    2                 DA=VPNO+FM_SRZERO;
      264     2893    2              ELSE
      265     2894    2                 DA=VPNO+FM_FRZERO;
      266     2895    3              DO WHILE(N>0);
      267     2896    3                 IF N>4 THEN
      268     2897    3                    BLKSIZ=4*4096;         /* CAN ONLY DO 4 GRANS AT A TIME      */
      269     2898    3                 ELSE
      270     2899    3                    BLKSIZ=N*4096;
      271     2900    3                 CALL FMB$QUEUE(ADDR(NIL),0,BLKSIZ,DA,%N_WRZERO,0,ENTADDR(NIL),0);
      272     2901    3                 IF F$DCB.ACS = %BLOCK# AND F$DCB.FUN ~= %CREATE# THEN
      273     2902    3                    CALL FMC$CLR1(DA);
      274     2903    3                 DA=DA+4;
      275     2904    3                 N=N-4;
      276     2905    3                 END;
      277     2906    2              GOTO SETEOP;
      278     2907        /**/
      279     2908    2   DELERR:    B$JIT.ERR=ERRWRDEL;
      280     2909    2              GOTO SETEOP;
      281     2910        /*E*    ERROR:  FMI-E$WRDEL-2
      282     2911        *       MESSAGE: M$DELREC to random or IDS file %%FN %requires a key
      283     2912        */
      284     2913        /**/
      285     2914    2            CASE(FPTREAD);
      286     2915        /********************/
      287     2916        /****  M$READ  ******/
      288     2917        /********************/
      289     2918    2              IF FPT$READ_V.KEYS THEN
      290     2919    2                 ADDR(F$DCB.CRECNO)->CHAR4=B$PS1$->CHAR4; /* Move key to DCB     */
      291     2920    2              ELSE
      292     2921    2                 IF FPT$READ_V.KEYR THEN
      293     2922    2                    B$PS1$->CHAR4=ADDR(F$DCB.CRECNO)->CHAR4;
      294     2923        /**/
      295     2924    2            CASE(FPTWRITE);
      296     2925        /********************/
PL6.E3A0      #001=FMI$RAN File=FMI$RAN.:E05TSI                                  TUE 07/29/97 16:49 Page:9    
      297     2926        /*****  M$WRITE  ****/
      298     2927        /********************/
      299     2928    2              CALL HFF$NILERASE(1) ALTRET(RWCOM); /* GO IF NO KEY                */
      300     2929    2              ADDR(F$DCB.CRECNO)->CHAR4=B$PS1$->CHAR4;
      301     2930        /**/
      302     2931    2            END;
      303     2932        /**/
      304     2933        /***************************/
      305     2934        /****  M$READ, M$WRITE  ****/
      306     2935        /***************************/
      307     2936    1   RWCOM:  F$DCB.EOP=0;                    /* CLEAR IN CASE OF ERROR             */
      308     2937        /**/
      309     2938    1           IF FPT$READ_V.FULL OR F$DCB.ASN=%DEVICE# OR F$DCB.ACS=%BLOCK# THEN
      310     2939    1              BLKSIZ=1024*4;               /* 1024 WORD BLOCKS                   */
      311     2940    1           ELSE
      312     2941    1              BLKSIZ=1023*4;               /* 1023 WORD BLOCKS                   */
      313     2942        /**/
      314     2943        /**/
      315     2944    1           IF (FPTCODE=FPTREAD) AND
      316     2945    1             ((FPT$READ_V.FULL) OR (F$DCB.ACS=%UBLOCK#)) AND
      317     2946    2             (MOD (F$DCB.UBYTES,BLKSIZ) > 0) THEN DO; /* bad buffer size         */
      318     2947    2              B$JIT$->B$JIT.ERR = ERRBADVECT2;
      319     2948    2              GOTO SCHEDDO ;
      320     2949    2              END;
      321     2950        /*E*    ERROR:  FMI-E$BADVECT2-2
      322     2951                MESSAGE: Buffer must be a multiple of 1024(1023 if not FULL).
      323     2952                DESCRIPTION:  The buffer the user specified is not big enough
      324     2953                              to fit a Full granule into it.
      325     2954        */
      326     2955        /**/
      327     2956    1           IF F$DCB.ASN=%DEVICE# THEN
      328     2957    1              IF F$DCB.CRECNO>=FM_SRZERO THEN /* REMOVE SET-REL BASE             */
      329     2958    1                 F$DCB.CRECNO=F$DCB.CRECNO-FM_SRZERO;
      330     2959    1           IF F$DCB.CRECNO < 0 THEN        /* Negative block number.             */
      331     2960    1              GOTO BADBLK;
      332     2961    1           IF F$DCB.CRECNO+((F$DCB.UBYTES+BLKSIZ-1)/BLKSIZ)>UGRANS
      333     2962    1           THEN        /* AT LEAST PART OF TRANSFER EXTENDS BEYOND END OF FILE   */
PL6.E3A0      #001=FMI$RAN File=FMI$RAN.:E05TSI                                  TUE 07/29/97 16:49 Page:10   
      334     2963    2           DO;
      335     2964    2              IF F$DCB.CRECNO>UGRANS
      336     2965    2              THEN                         /* START OF TRANSFER IS BEYOND END    */
      337     2966    3              DO;
      338     2967    3   BADBLK:       B$JIT$->B$JIT.ERR=ERRBADBLK;
      339     2968    3                 F$DCB.CRECNO=UGRANS;
      340     2969    3                 GOTO SCHEDDO;
      341     2970    3                 END;
      342     2971        /*E*   ERROR:  FMI-E$RANBADBLK-2
      343     2972        *       MESSAGE:  Illegal block number% for file %FN%
      344     2973        *       MESSAGE1: The specified block # is negative or greater than
      345     2974         size of the file
      346     2975        *      DESCRIPTION:  The block number specified for a random file is
      347     2976        *        beyond the end of the file.
      348     2977        */
      349     2978    2              IF F$DCB.CRECNO=UGRANS THEN  /* RIGHT AT END - MAY BE OK           */
      350     2979    3                 IF FPTCODE=FPTREAD AND NOT FPT$READ_V.KEYS THEN DO;
      351     2980    3                    B$JIT.ERR=ERREOF;      /* EOF IF READ W/O KEY AT END         */
      352     2981    3                    GOTO SCHEDDO;
      353     2982    3                    END;
      354     2983        /*E*   ERROR:    FMI-E$EOF-2
      355     2984        *      DESCRIPTION:  An M$READ without a key to a random file was
      356     2985        *        given when the current position was at EOF.
      357     2986        */
      358     2987    2                 ELSE
      359     2988    2                    GOTO BADBLK;
      360     2989    3              ELSE DO;                /* START IS WITHIN FILE, END IS OUTSIDE    */
      361     2990    3                 F$DCB.UBYTES=(UGRANS-F$DCB.CRECNO)*BLKSIZ;
      362     2991    3                 IF FPTCODE=FPTWRITE
      363     2992    3                 THEN                      /* SET LOST DATA IF WRITE             */
      364     2993    3                    B$JIT$->B$JIT.ERR=ERRLD;
      365     2994    3                 END;
      366     2995    2              END;
      367     2996        /*E*   ERROR:    FMI-E$LD-2
      368     2997        *       MESSAGE1: One of the following conditions occurred:
      369     2998        *        1 - A read or write began at a legal block number but crossed
      370     2999        *            beyond the end of the file.
PL6.E3A0      #001=FMI$RAN File=FMI$RAN.:E05TSI                                  TUE 07/29/97 16:49 Page:11   
      371     3000        *        2 - A read without a key specified a byte count not a multiple
      372     3001        *            of the block size.
      373     3002        *        3 - A read without a key specified zero bytes.
      374     3003        */
      375     3004        /**/
      376     3005    2           IF F$DCB.UBYTES=0 THEN DO;      /* NO BYTES TO MOVE                   */
      377     3006    2              IF FPTCODE=FPTREAD THEN
      378     3007    2                 B$JIT.ERR=ERRLD;          /* Lost data if read zero bytes       */
      379     3008    2              ELSE
      380     3009    2                 B$JIT.ERR=ERRRANBOUND;
      381     3010    2              GOTO SCHEDDO;
      382     3011    2              END;
      383     3012        /**/
      384     3013    2           IF BLKSIZ=1024*4 THEN DO;       /* FULL XFER                          */
      385     3014    2              CALL HFF$RET_PS_DESC(B$PS2$,DESC) ALTRET(MEMERR);
      386     3015    2              IF MOD(DESC.BASE,4)~=0 OR
      387     3016    3                MOD(F$DCB.UBYTES,4)~=0 THEN DO;
      388     3017    3                 B$JIT.ERR=ERRRANBOUND;
      389     3018    3                 GOTO SCHEDDO;
      390     3019    3                 END;
      391     3020    2              CALL HFF$WRITE1(2) ALTRET(MEMERR); /* CHECK ACCESS                 */
      392     3021    2              END;
      393     3022        /*E*   ERROR:    FMI-E$RANBOUND-2
      394     3023        *       MESSAGE:  Buffer% for file %FN% must be word aligned
      395     3024        *       MESSAGE1: Buffer must be on word boundary and byte count
      396     3025         must be non-zero word multiple
      397     3026        *      DESCRIPTION:  RANDOM and IDS reads and writes with FULL=YES
      398     3027        *        and all block access reads and writes must have a word-
      399     3028        *        aligned buffer and must be for an integral number of words. */
      400     3029        /**/
      401     3030    1           IF F$DCB.ASN=%DEVICE# THEN GOTO DEVPACK;
      402     3031    1           STAMP.HASH=F$DCB.HASH;
      403     3032    1           IF F$DCB.ACS = %UBLOCK# THEN
      404     3033    1              GOTO READ_UBLOCK;
      405     3034    1           IF BLKSIZ=1024*4 AND NOT FPT$READ_V.SEED AND NOT F$DCB.SEED AND
      406     3035    1             (FM$CFU.AFIT=1 OR F$DCB.CRECNO~=0 OR F$DCB.ACS=%BLOCK#) AND
      407     3036    1             (FPTCODE~=FPTWRITE OR MOD(F$DCB.UBYTES,4096)=0)
PL6.E3A0      #001=FMI$RAN File=FMI$RAN.:E05TSI                                  TUE 07/29/97 16:49 Page:12   
      408     3037    1           THEN GOTO DIRIO;                /* Can do direct I/O                  */
      409     3038    1           N=(F$DCB.UBYTES+4095)/4096;     /* TOTAL # GRANS TO READ              */
      410     3039    1           IF N>4 THEN N=4;                /* BUFFER SIZE                        */
      411     3040    1           IF F$DCB.BFR.BUFX(0)~=0 AND F$DCB.BFR1.SIZ(0)<N THEN
      412     3041    1              CALL FMD$RELBUF(0);
      413     3042    1           CALL FMD$GETBUF(0,N,G$);
      414     3043    1           IF F$DCB.ORG = %RANDOM# OR F$DCB.ORG = %IDS# THEN
      415     3044    1              F$DCB.BFR1.FLAGS.ONE_WORD_HEADER (0) = '1'B;
      416     3045    2           DO WHILE(JDCB$->F$DCB.UBYTES>0);
      417     3046    2              DA=JDCB$->F$DCB.CRECNO+FM_FRZERO; /* DA FOR THIS BLOCK             */
      418     3047    2              STAMP.GMOD=DA;
      419     3048    2              BUFSIZ=(F$DCB.UBYTES+4095)/4096; /* # pages to xfer                */
      420     3049    2              IF BUFSIZ>4 THEN
      421     3050    2                 BUFSIZ=4;                 /* Limit to 4 pages at a time         */
      422     3051    2              BUFDISP=0;
      423     3052    2              Q$=ADDR(NIL);
      424     3053    3              IF FPTCODE=FPTWRITE THEN DO; /* Write                              */
      425     3054    3                 CFU$->FM$CFU.FMOD='1'B;   /* SET FILE MODIFIED                  */
      426     3055    3                 JDCB$->F$DCB.BFR.DA(0)=DA;
      427     3056    4                 DO WHILE(BUFDISP<BUFSIZ);
      428     3057    4                    JDCB$->F$DCB.GDISP=0;
      429     3058    4                    GBYTES=BLKSIZ;         /* AVAILABLE SPACE IN BYTES           */
      430     3059    5                    IF BLKSIZ=1024*4 THEN DO; /* User has stamp                  */
      431     3060    5                       P$=G$;
      432     3061    5                       IF FPT$WRITE_V.SEED
      433     3062    6                         OR F$DCB.SEED THEN DO; /* Don't encrypt stamp           */
      434     3063    6                          GBYTES=GBYTES-4;
      435     3064    6                          IF F$DCB.UBYTES<4 THEN
      436     3065    6                             F$DCB.UBYTES=0;
      437     3066    7                          ELSE DO;         /* SKIP OVER STAMP IN USER BUFFER     */
      438     3067    7                             F$DCB.UBYTES=F$DCB.UBYTES-4;
      439     3068    7                             F$DCB.UB$=PINCRC(F$DCB.UB$,4);
      440     3069    7                             P$=PINCRW(P$,1);
      441     3070    7                             END;
      442     3071    6                          END;
      443     3072    5                       END;
      444     3073    4                    ELSE
PL6.E3A0      #001=FMI$RAN File=FMI$RAN.:E05TSI                                  TUE 07/29/97 16:49 Page:13   
      445     3074    4                       P$=PINCRW(G$,1);
      446     3075    4                    IF (FPT$WRITE_V.SEED OR F$DCB.SEED) AND F$DCB.ORG=%IDS# AND
      447     3076    5                      F$DCB.ACS~=%BLOCK# THEN DO; /* DON'T ENCRYPT TIME          */
      448     3077    5                       GBYTES=GBYTES-4;    /* DECR SIZE LEFT IN BUFFER           */
      449     3078    5                       IF F$DCB.UBYTES<4 THEN
      450     3079    5                          N=F$DCB.UBYTES;
      451     3080    5                       ELSE
      452     3081    5                          N=4;             /* SIZE OF TIME WORD                  */
      453     3082    5                       P$->CHARS=F$DCB.UB$->CHARS; /* MOVE TIME FROM USER        */
      454     3083    5                       P$=PINCRW(P$,1);
      455     3084    5                       F$DCB.UBYTES=F$DCB.UBYTES-N;
      456     3085    5                       F$DCB.UB$=PINCRC(F$DCB.UB$,4);
      457     3086    5                       END;
      458     3087    4                    VPNO = GBYTES;         /* Space left for user stuff*/
      459     3088    4                    CALL FMD$RECTRAN(P$,GBYTES,0,1,1,FPT$WRITE_V.SEED);
      460     3089    5                    IF GBYTES<VPNO THEN DO; /* Clobber rest                      */
      461     3090    5                       P$=PINCRC(P$,GBYTES); /* POINT TO NEXT BYTE               */
      462     3091    5                       GBYTES=VPNO-GBYTES; /* Bytes remaining                    */
      463     3092    5                       P$->CLEAR=' ';      /* BLANK IT                           */
      464     3093    5                       END;
      465     3094    4                    G$->FM$GRAN.STAMP.HASH=JDCB$->F$DCB.HASH;
      466     3095    4                    G$->FM$GRAN.STAMP.GMOD=DA+BUFDISP;
      467     3096    4                    IF JDCB$->F$DCB.ORG=%IDS# AND JDCB$->F$DCB.ACS~=%BLOCK#
      468     3097    4                    THEN    /* IDS TYPE IFLE - CHECK IF TIME STAMP IS WANTED     */
      469     3098    4                       IF NOT FPT$WRITE_V.NOTIME THEN /* Put time in             */
      470     3099    4                          CALL SSS$SYSTIME(G$->WRDS(1));
      471     3100    4                    G$=PINCRW(G$,1024);    /* POINT TO NEXT PAGE                 */
      472     3101    4                    BUFDISP=BUFDISP+1;
      473     3102    4                    END;
      474     3103    3                 G$=FM$BUF$(F$DCB.BFR.BUFX(0)); /* Re-establish buffer ptr       */
      475     3104    3                 CALL FMB$QUEUE(G$,0,BUFSIZ*4096,DA,%N_WRBIN,1,ENTADDR(NIL),0);
      476     3105    4                 IF F$DCB.ACS = %BLOCK# AND F$DCB.FUN ~= %CREATE# THEN DO;
      477     3106    5                    DO I=0 TO BUFSIZ-1;
      478     3107    5                       CALL FMC$CLR1(DA+I);
      479     3108    5                       END;
      480     3109    4                    END;
      481     3110    3                 END;
PL6.E3A0      #001=FMI$RAN File=FMI$RAN.:E05TSI                                  TUE 07/29/97 16:49 Page:14   
      482     3111    2              ELSE                         /* READ                               */
      483     3112    3              DO;
      484     3113    3                 CALL FMB$QUEUE(G$,0,BUFSIZ*4096,DA,%N_RDBIN,1,ENTADDR(NIL),0,Q$);
      485     3114    4                 DO WHILE(BUFDISP<BUFSIZ);
      486     3115    4                    JDCB$->F$DCB.GDISP=0;
      487     3116    5                    IF G$->FM$GRAN.STAMP~=STAMP THEN DO; /* BAD BLOCK            */
      488     3117                            /* Log an error if block acs and this file's org
      489     3118                               doesn't allow unwritten granules in ugrans. */
      490     3119    5                       IF (F$DCB.ACS=%BLOCK# OR F$DCB.ACS=%UBLOCK#) AND
      491     3120    5                         F$DCB.ORG ~= %RANDOM# AND F$DCB.ORG ~= %IDS#
      492     3121    5                         AND F$DCB.ORG ~= %CG# AND F$DCB.ORG ~= %RELATIVE# THEN
      493     3122    5                          CALL FMB$LOGERR(%E$MI,5,8,DA+BUFDISP,G$,0,1,2,
      494     3123    5                            STAMP,,Q$);
      495     3124    5                       G$->CLR.X=' ';      /* ZAP THE GRAN                       */
      496     3125    5                       G$->WRDS(0)=-1;     /* MARK HEADER BAD FOR EFT            */
      497     3126    5                       B$JIT.ERR=ERRDI;
      498     3127    5                       END;
      499     3128    4                    ELSE
      500     3129    4                       G$->WRDS(0)=F$DCB.CRECNO+BUFDISP;
      501     3130        /*E*   ERROR:    FMI-E$DI-2
      502     3131        *       MESSAGE: An attempt was made to read one or more blocks
      503     3132        that were never written% in file %FN%
      504     3133        *      DESCRIPTION:  One or more of the granules read by this M$READ
      505     3134        *        was never written. */
      506     3135    4                    GBYTES=BLKSIZ;         /* # DATA BYTES IN THIS PAGE          */
      507     3136    5                    IF BLKSIZ=1024*4 THEN DO;
      508     3137    5                       P$=G$;              /* USER WANTS STAMP                   */
      509     3138    5                       IF FPT$READ_V.SEED
      510     3139    6                         OR F$DCB.SEED THEN DO; /* DON'T DECRYPT STAMP           */
      511     3140    6                          IF F$DCB.UBYTES<4 THEN
      512     3141    6                             N=F$DCB.UBYTES;
      513     3142    6                          ELSE
      514     3143    6                             N=4;          /* STAMP IS 4 BYTES LONG              */
      515     3144    6                          CALL MOV2USR;    /* MOVE STAMP W/O DECRYPTION          */
      516     3145    6                          GBYTES=GBYTES-4;
      517     3146    6                          END;
      518     3147    5                       END;
PL6.E3A0      #001=FMI$RAN File=FMI$RAN.:E05TSI                                  TUE 07/29/97 16:49 Page:15   
      519     3148    4                    ELSE
      520     3149    4                       P$=PINCRW(G$,1);    /* DOESN'T WANT STAMP                 */
      521     3150    4                    IF (FPT$READ_V.SEED OR F$DCB.SEED) AND F$DCB.ORG=%IDS#
      522     3151    5                      AND F$DCB.ACS~=%BLOCK# THEN DO; /* DON'T DECRYPT TIME      */
      523     3152    5                       GBYTES=GBYTES-4;
      524     3153    5                       IF F$DCB.UBYTES<4 THEN
      525     3154    5                          N=F$DCB.UBYTES;
      526     3155    5                       ELSE
      527     3156    5                          N=4;
      528     3157    5                       CALL MOV2USR;       /* MOVE N BYTES                       */
      529     3158    5                       END;
      530     3159    4                    CALL FMD$RECTRAN(P$,GBYTES,0,0,1,FPT$READ_V.SEED);
      531     3160    4                    IF GBYTES>0 THEN       /* DIDN'T XFER ALL                    */
      532     3161    4                       IF NOT FPT$READ_V.KEYS AND NOT B$JIT.ERR THEN
      533     3162    4                          B$JIT.ERR=ERRLD; /* READ NON-MULT OF BLOCK W/O KEY     */
      534     3163    4                    BUFDISP=BUFDISP+1;
      535     3164    4                    G$=PINCRW(G$,1024);
      536     3165    4                    STAMP.GMOD=STAMP.GMOD+1;
      537     3166    4                    END;
      538     3167    3                 END;
      539     3168    2              F$DCB.CRECNO=F$DCB.CRECNO+BUFSIZ;
      540     3169    2              F$DCB.BFR.BUFUP(0)='0'B;
      541     3170    2              G$=FM$BUF$(F$DCB.BFR.BUFX(0)); /* Re-establish buffer ptr          */
      542     3171    3              IF Q$~=ADDR(NIL) THEN DO;
      543     3172    3                 CALL NIQ$REL(Q$);
      544     3173    3                 Q$=ADDR(NIL);
      545     3174    3                 END;
      546     3175    2              END;
      547     3176        /**/
      548     3177    1           GOTO SCHEDDO;
      549     3178        /**/
      550     3179        /**/
      551     3180        /* READ AND WRITE DIRECT TO USER BUFFER */
      552     3181        /**/
      553     3182    1   DIRIO:  IF FPTCODE=FPTREAD THEN
      554     3183    1              IF MOD(F$DCB.UBYTES,4096)~=0 AND NOT FPT$READ_V.KEYS THEN
      555     3184    1                 B$JIT.ERR=ERRLD;     /* READING OTHER THAN GRAN MULT W/O KEY    */
PL6.E3A0      #001=FMI$RAN File=FMI$RAN.:E05TSI                                  TUE 07/29/97 16:49 Page:16   
      556     3185    1           DA=F$DCB.CRECNO+FM_FRZERO;      /* DISK ADDRESS                       */
      557     3186    1           STAMP.GMOD=DA;
      558     3187    1           F$DCB.CRECNO=F$DCB.CRECNO+((F$DCB.UBYTES+BLKSIZ-1)/BLKSIZ);
      559     3188    1           N=(F$DCB.UBYTES+4095)/4096;     /* # GRANULES                         */
      560     3189    1           UB$=F$DCB.UB$;                  /* POINTER TO START OF BUFFER         */
      561     3190    2           DO CASE(FPTCODE);
      562     3191    2            CASE(FPTREAD);
      563     3192                            /* MAKE SURE ALL PAGES IN BUFFER ARE READ ACCESSIBLE -    */
      564     3193                                      /* CAN'T CALL MMC$ONLY_IOM TWICE FOR SAME PAGE  */
      565     3194    3              DO WHILE(N>0);
      566     3195    3                 WSQ=UB$->WRDS(0);
      567     3196    3                 UB$=PINCRW(UB$,1024);
      568     3197    3                 N=N-1;
      569     3198    3                 END;
      570     3199    2              TEMP_CHAR=PINCRC(F$DCB.UB$,F$DCB.UBYTES-1)->CHAR1;
      571     3200    2              WSQ=ASCBIN(TEMP_CHAR);
      572     3201    2              N=DESC.WSR;
      573     3202    2              CALL HFC$STWS(WSRS);
      574     3203    2              WSQ=WSRS.R(N);               /* WSQ of caller                      */
      575     3204    2              VPNO=DESC.BASE/4096;         /* VIRT PAGE OF BEGINNING             */
      576     3205    2              N=(DESC.BASE+F$DCB.UBYTES-1+4095)/4096-VPNO;
      577     3206    2              CALL MMC$ONLY_IOM(WSQ,VPNO,N); /* REMOVE CPU ACCESS                */
      578     3207    2              F$DCB.ARS=F$DCB.UBYTES;
      579     3208    2              CALL NIQ$GET(P$);            /* Get Q packet to use as buffer      */
      580     3209    3              IF P$->N$REQ.IOFLG.IOS THEN DO;
      581     3210    3                 CALL NIQ$RELS(P$->N$REQ.IOS$);
      582     3211    3                 P$->N$REQ.IOFLG.IOS='0'B;
      583     3212    3                 END;
      584     3213    2              FM$RANEA.CNT=1;              /* # I/Os outstanding                 */
      585     3214    2              FM$RANEA.STAMP=STAMP;
      586     3215    2              FM$RANEA.BLKNO=DA-FM_FRZERO;
      587     3216    2              FM$RANEA.VPNO=VPNO;
      588     3217    2              FM$RANEA.PGS=N;
      589     3218                   /* Let FMI$EA log an error if acs is block (e.g. EFT) on a
      590     3219                      file which can't have unwritten granules in UGRANS and
      591     3220                      which has a bad granule stamp.                       */
      592     3221    2              IF (F$DCB.ACS=%BLOCK# OR F$DCB.ACS=%UBLOCK#) AND
PL6.E3A0      #001=FMI$RAN File=FMI$RAN.:E05TSI                                  TUE 07/29/97 16:49 Page:17   
      593     3222    2                F$DCB.ORG ~= %RANDOM# AND F$DCB.ORG ~= %IDS# AND
      594     3223    2                F$DCB.ORG ~= %CG# AND F$DCB.ORG ~= %RELATIVE# THEN
      595     3224    2                 FM$RANEA.TYP=1;
      596     3225    2              ELSE
      597     3226    2                 FM$RANEA.TYP=0;
      598     3227    2              CALL FMB$QUEUE(F$DCB.UB$,0,F$DCB.UBYTES,DA,%N_RDBIN+1024,0,ENTADDR(FMI$EA
              3227                       ),P$);
      599     3228                   %LOCK (G#=F_DCBLOCK);
      600     3231    2              FM$RANEA.CNT=FM$RANEA.CNT-1;
      601     3232    3              IF FM$RANEA.CNT=0 THEN DO;
      602     3233                      %UNLOCK (G#=F_DCBLOCK);
      603     3236    3                 CALL MMC$CP_IOM(WSQ,VPNO,N);
      604     3237    3                 P$->N$REQ='0'B;
      605     3238    3                 P$->N$REQ.ERR$=ADDR(NIL);
      606     3239    3                 P$->N$REQ.IOQFLG.INUSE = '1'B;
      607     3240    3                 CALL NIQ$REL(P$);
      608     3241    3                 END;
      609     3242    3              ELSE DO;
      610     3243                      %UNLOCK (G#=F_DCBLOCK);
      611     3246    3                 END;
      612     3247    2            CASE(FPTWRITE);
      613     3248    3              DO WHILE(N>0);
      614     3249    3                 UB$->WRDS(0)=BITBIN(STAMP); /* SET STAMP                        */
      615     3250    3                 IF F$DCB.ORG=%IDS# AND F$DCB.ACS~=%BLOCK# THEN
      616     3251    3                    IF NOT FPT$WRITE_V.NOTIME THEN
      617     3252    3                       CALL SSS$SYSTIME(UB$->WRDS(1)); /* TIME STAMP             */
      618     3253    3                 STAMP.GMOD=STAMP.GMOD+1;  /* INCR STAMP                         */
      619     3254    3                 UB$=PINCRW(UB$,1024);
      620     3255    3                 N=N-1;
      621     3256    3                 END;
      622     3257    2              FM$CFU.FMOD='1'B;            /* SET WRITE OCCURRED                 */
      623     3258    2              CALL FMB$QUEUE(F$DCB.UB$,0,F$DCB.UBYTES,DA,%N_WRBIN,0,ENTADDR(NIL),0);
      624     3259    2              IF F$DCB.ACS = %BLOCK# AND F$DCB.FUN ~= %CREATE# THEN
      625     3260    2                 CALL FMC$CLR1(DA);
      626     3261    2            END;
      627     3262    1   SCHEDDO: ;
      628     3263    1           IF S$CU$->B$U.FLG.DBRK THEN
PL6.E3A0      #001=FMI$RAN File=FMI$RAN.:E05TSI                                  TUE 07/29/97 16:49 Page:18   
      629     3264    1              CALL FMB$IOSPIN;             /* FORCE I/O TO COMPLETE              */
      630     3265        /**/
      631     3266    1   SETEOP: F$DCB.EOP=FM_EOP(FPTCODE);      /* SET EOP                            */
      632     3267    1           IF B$JIT.ERR='0'B THEN RETURN;
      633     3268    1   ERR:    ALTRETURN;
      634     3269        /**/
      635     3270        /**/
      636     3271        /* DEVICE PACK READ AND WRITE */
      637     3272        /**/
      638     3273        /**/
      639     3274    2   DEVPACK: DO CASE(FPTCODE);
      640     3275    2            CASE(FPTREAD);
      641     3276    2              CALL HFF$WRITE1(2) ALTRET(MEMERR); /* CHECK BUFFER                 */
      642     3277    2              FC=%N_RDBIN+512;             /* Indicate reading into user buffer  */
      643     3278    2              F$DCB.ARS=F$DCB.UBYTES;
      644     3279    2            CASE(FPTWRITE);
      645     3280    2              CALL HFF$NILERASE(2) ALTRET(MEMERR); /* CHECK BUFFER               */
      646     3281    2              FC=%N_WRBIN;
      647     3282    2            END;
      648     3283    1           DA=F$DCB.CRECNO+FM_SRZERO;
      649     3284    1           F$DCB.CRECNO=F$DCB.CRECNO+((F$DCB.UBYTES+4095)/4096);
      650     3285    1           IF MOD(F$DCB.UBYTES,4096)~=0 THEN
      651     3286    1              B$JIT.ERR=ERRLD;             /* Not gran size multiple             */
      652     3287    2           IF FC=%N_WRBIN THEN DO;         /* TIME STAMP VIDS                    */
      653     3288    2              WSQ=DA;
      654     3289    2              N=FM$SET.DCTX(F$DCB.SETX);
      655     3290    3              DO WHILE(WSQ>FM$VOL.NXTSDA(N));
      656     3291    3                 WSQ=WSQ-FM$VOL.NXTSDA(N)+FM_SRZERO;
      657     3292    3                 N=FM$VOL.VOLL(N);
      658     3293    3                 END;
      659     3294    3              IF WSQ=FM_SRZERO THEN DO;
      660     3295    3                 CALL SSS$SYSTIME(F$DCB.UB$->FM$VID.INITTIME);
      661     3296    3                 CALL XLATE_9_TO_6(STAMP,XLATE926,B_SITEINFO.SITE_ID);
      662     3297    3                 F$DCB.UB$->FM$VID.INSTID=STAMP;
      663     3298    3                 END;
      664     3299    2              END;
      665     3300    1           CALL FMB$QUEUE(F$DCB.UB$,0,F$DCB.UBYTES,DA,FC,0,ENTADDR(NIL),0);
PL6.E3A0      #001=FMI$RAN File=FMI$RAN.:E05TSI                                  TUE 07/29/97 16:49 Page:19   
      666     3301    1           IF FC = %N_WRBIN THEN
      667     3302    1              CALL FMC$CLR1(DA);
      668     3303    1           GOTO SCHEDDO;
      669     3304        /**/
      670     3305    1   MEMERR: B$JIT.ERR=ERRMTRAP;
      671     3306    1           GOTO SCHEDDO;
      672     3307        /*E*   ERROR:   FMI-E$MTRAP-2
      673     3308        *       DESCRIPTION:  Buffer has wrong access.
      674     3309        */
      675     3310        /*
      676     3311           Handle UBLOCK reads (UBLOCK writes are handled in FMH$CONSEC).
      677     3312        */
      678     3313    1   READ_UBLOCK: ;
      679     3314    1           IF F$DCB.BFR.BUFX(0) ~= 0 AND F$DCB.BFR1.SIZ(0) ~= 1 THEN
      680     3315    1              CALL FMD$RELBUF(0);          /* Release any old buffer 0.          */
      681     3316    1           VPNO = (F$DCB.UBYTES + 4095) / 4096; /* # grans.                      */
      682     3317    1           DA = F$DCB.CRECNO + FM_FRZERO;  /* Starting DA.                       */
      683     3318    2           DO I = 1 TO VPNO;               /* For each gran.                     */
      684     3319    2              STAMP.GMOD = DA;             /* Set gmod.                          */
      685     3320    3              CALL FMC$GET(G$,0,DA,FC) WHENALTRETURN DO; /* Get the granule.     */
      686     3321    3                 CALL FMB$LOGERR(%E$MI,1,8,DA);
      687     3322    3                 B$JIT.ERR = ERRDI;
      688     3323    3                 END;
      689     3324    3              IF FC = 0 THEN DO;           /* Couldn't get it through the cache. */
      690     3325    3                 IF F$DCB.BFR.BUFX(0) = 0 THEN
      691     3326    3                    CALL FMD$GETBUF(0,1,G$);
      692     3327    3                 ELSE
      693     3328    3                    G$ = FM$BUF$(F$DCB.BFR.BUFX(0));
      694     3329    3                 CALL FMB$QUEUE(G$,0,4096,DA,%N_RDBIN,1,ENTADDR(NIL),0);
      695     3330    3                 END;
      696     3331    2              ELSE               /* Got it through the cache, get the buffer.    */
      697     3332    2                 G$ = FM$BUF$(F$DCB.BFR.BUFX(0));
      698     3333
      699     3334    3              IF G$->FM$GRAN.STAMP ~= STAMP THEN DO;
      700     3335    3                 IF F$DCB.ORG ~= %RELATIVE# AND F$DCB.ORG ~= %RANDOM# AND
      701     3336    3                   F$DCB.ORG ~= %IDS# AND F$DCB.ORG ~= %CG# THEN
      702     3337    3                    CALL FMB$LOGERR(%E$MI,5,8,DA,G$,0,1,2,STAMP);
PL6.E3A0      #001=FMI$RAN File=FMI$RAN.:E05TSI                                  TUE 07/29/97 16:49 Page:20   
      703     3338    3                 G$->CLR.X = ' ';          /* Zap the granule.                   */
      704     3339    3                 G$->WRDS(0) = -1;
      705     3340    3                 B$JIT.ERR = ERRDI;
      706     3341    3                 END;
      707     3342    2              IF BLKSIZ = 1024*4 THEN      /* FULL=YES?                          */
      708     3343    2                 P$ = G$;                  /* Yes, give the user everything.     */
      709     3344    2              ELSE
      710     3345    2                 P$ = PINCRW(G$,1);        /* FULL=NO, skip the stamp.           */
      711     3346    2              GBYTES = BLKSIZ;             /* # bytes to transfer.               */
      712     3347    3              IF I = 1 AND F$DCB.CRECNO = 0 AND FM$CFU.AFIT = 0 THEN DO;
      713     3348                                                /* THIS IS THE FIT, SCRUB OWNER       */
      714     3349    3                 N = MINIMUM(G$->FM$GRAN.FCEX*4+BLKSIZ-4096,F$DCB.UBYTES);
      715     3350    3                 CALL MOV2USR;             /* MOVE THE FIT FIRST                 */
      716     3351    3                 GBYTES = GBYTES - N;
      717     3352    3                 P$ = PINCRW(G$,5);
      718     3353    4                 CALL FMO$LOCCODT(P$,4) WHENRETURN DO;
      719     3354    4                    IF BLKSIZ = 1023*4 THEN
      720     3355    4                       P$ = PINCRW(P$,-1);
      721     3356    4                    N = MINIMUM(12+POFFC(P$,G$),F$DCB.ARS);
      722     3357    4                    P$ = PINCRC(F$DCB.UB$,N-F$DCB.ARS);
      723     3358    4                    N = MINIMUM(20,F$DCB.ARS-N);
      724     3359    4                    IF N > 0 THEN
      725     3360    4                       P$->CHARS = ' ';
      726     3361    4                    END;
      727     3362    3                 P$ = PINCRW(G$,G$->FM$GRAN.FCEX);
      728     3363    3                 END;
      729     3364    2              N = GBYTES;                  /* # bytes left to move.              */
      730     3365    2              CALL MOV2USR;           /* Move the data to the user's buffer.     */
      731     3366    2              DA = DA + 1;                 /* Next granule.                      */
      732     3367    2              F$DCB.BFR.BUFUP(0) = '0'B;
      733     3368    2              CALL FMD$RELBUF(0);
      734     3369    2              END;
      735     3370    1           F$DCB.CRECNO = F$DCB.CRECNO + VPNO;
      736     3371    1           GOTO SCHEDDO;
      737     3372
      738     3373        /**/
      739     3374        /**/
PL6.E3A0      #001=FMI$RAN File=FMI$RAN.:E05TSI                                  TUE 07/29/97 16:49 Page:21   
      740     3375        /* PROC TO MOVE BYTES FROM MON BUFFER TO USER WITHOUT DECRYPTION */
      741     3376    1   MOV2USR: PROC;
      742     3377    3           IF N>0 THEN DO;
      743     3378    3              F$DCB.UB$->CHARS=P$->CHARS;  /* MOVE N BYTES                       */
      744     3379    3              F$DCB.UB$=PINCRC(F$DCB.UB$,N);
      745     3380    3              F$DCB.UBYTES=F$DCB.UBYTES-N;
      746     3381    3              F$DCB.ARS=F$DCB.ARS+N;
      747     3382    3              END;
      748     3383    2           P$=PINCRW(P$,1);
      749     3384    2           RETURN;
      750     3385    2   END MOV2USR;
      751     3386        /**/
      752     3387    1   END FMI$RAN;
      753     3388        %EOD;

PL6.E3A0      #001=FMI$RAN File=FMI$RAN.:E05TSI                                  TUE 07/29/97 16:49 Page:22   
--  Include file information  --

   UM$CP6V_C.:E05TOU  is referenced.
   FM$RANEA.:E05TOU  is referenced.
   CP_6_SUBS.:E05TOU  is referenced.
   B$USER.:E05TOU  cannot be made into a system file and is referenced.
   N$REQ.:E05TOU  is referenced.
   N_FC_C.:E05TOU  is referenced.
   F$CP6V_C.:E05TOU  is referenced.
   F_ERRORS_C.:E05TOU  is referenced.
   F_FPTCODE_C.:E05TOU  is referenced.
   F_CODE_R.:E05TOU  cannot be made into a system file and is referenced.
   FM_DATA_R.:E05TOU  cannot be made into a system file and is referenced.
   FM$MACROS.:E05TOU  is referenced.
   HF_LOCK_C.:E05TOU  cannot be made into a system file and is referenced.
   F$DCB.:E05TOU  is referenced.
   B$JIT_C.:E05TOU  is referenced.
   F$JIT_C.:E05TOU  cannot be made into a system file and is referenced.
      No diagnostics issued in procedure FMI$RAN.

   Procedure FMI$RAN requires 1659 words for executable code.
   Procedure FMI$RAN requires 42 words of local(AUTO) storage.

PL6.E3A0      #001=FMI$RAN File=FMI$RAN.:E05TSI                                  TUE 07/29/97 16:49 Page:23   

 Object Unit name= FMI$RAN                                    File name= FMI$RAN.:E05TOU
 UTS= JUL 29 '97 16:49:48.28 TUE                              Compiler= PL-6/E31         Sev=      00
 SharedLib= :SHARED_SYSTEM                                    Alt SharedLib=


    ****  Control sections  ****

 Sect   Type Bound  Init  Size OctSiz  Section name(segment info)
    0  RoData even  UTS     41     51  FMI$RAN
    1   Proc  even  none  1659   3173  FMI$RAN
    2  RoData even  none    40     50  FMI$RAN

    ****  Entry defs  ****

                              Check   Calling
                             calling  sequence
  Sect OctLoc Primary Altret sequence   type   Parms  Name
     1      0   yes    yes     yes      Std        1  FMI$RAN
PL6.E3A0      #001=FMI$RAN File=FMI$RAN.:E05TSI                                  TUE 07/29/97 16:49 Page:24   

  ****  Entry refs  ****

         Check        Calling
        calling       sequence
Altret sequence SRef   type   Args  Name
 yes     yes           Std       1 HFF$NILERASE
 yes     yes           Std       9 FMB$QUEUE
 yes     yes           Std       8 FMD$RECTRAN
         yes           Std       0 FMB$IOSPIN
 yes     yes           Std       1 HFF$WRITE1
         yes           Std       1 FMD$RELBUF
         yes           Std       1 HFC$UNLOCK
         yes           Std       1 SSS$SYSTIME
 yes     yes           Std       1 NIQ$RELS
 yes     yes           Std       1 NIQ$REL
         yes           Std       1 FMI$EA
 yes     yes           Std       2 FMO$LOCCODT
         yes           Std       1 FMC$CLR1
 yes     yes           Std       2 HFF$RET_PS_DESC
         yes           Std       3 FMD$GETBUF
         yes           Std      11 FMB$LOGERR
 yes     yes           Std       1 NIQ$GET
         yes           Std       1 HFC$STWS
         yes           Std       3 MMC$CP_IOM
 yes     yes           Std       4 FMC$GET
         yes           Std       3 MMC$ONLY_IOM
         yes           Std       1 HFC$LOCK
                       nStd      0 X66_AUTO_1
                       Std       0 B_CONSPOOL_D
                       nStd      0 X66_ARET
                       nStd      0 X66_AALT
PL6.E3A0      #001=FMI$RAN File=FMI$RAN.:E05TSI                                  TUE 07/29/97 16:49 Page:25   

  ****  Data refs  ****

  Flags:  r = read only, s = secondary
Flgs Name                             Flgs Name                             Flgs Name
     B$JIT$                           r    B$PS0$                           r    B$PS1$
r    B$PS2$                                FM$BUF$                          r    FM_FRZERO
r    FM_SRZERO                        r    FM_EOP                                F_DCBLOCK
r    F$CFU$                           r    FM$SET$                               S$CU$
     B_SITEINFO                            B_VECTNIL

  ****  Segment refs  ****

  Flags:  r = read only, s = secondary
Flgs Name                             Flgs Name                             Flgs Name
     ISSID
PL6.E3A0      #001=FMI$RAN File=FMI$RAN.:E05TSI                                  TUE 07/29/97 16:49 Page:26   


        1        1        /*M*   FMI$RAN - Random and block access disk file PMME processing */
        2        2        /*T***********************************************************/
        3        3        /*T*                                                         */
        4        4        /*T* Copyright (c) Bull HN Information Systems Inc., 1997    */
        5        5        /*T*                                                         */
        6        6        /*T***********************************************************/
        7        7        /**/
        8        8        /*X* */
        9        9        /**/
       10       10        /**/
       11       11        FMI$RAN: PROC(FPTCODE) ALTRET;

     11  1 000000   000000 700200 xent  FMI$RAN      TSX0  ! X66_AUTO_1
         1 000001   000052 000001                    ZERO    42,1

       12       12        /* PARAMETERS */
       13       13    1   DCL FPTCODE UBIN(36);
       14       14        /* LOCAL AUTOMATIC STORAGE */
       15       15    1   DCL JDCB$ PTR;
       16       16    1   DCL CFU$ PTR;
       17       17    1   DCL G$ PTR;
       18       18    1   DCL P$ PTR;
       19       19    1   DCL GBYTES UBIN;
       20       20    1   DCL DA UBIN;
       21       21    1   DCL BLKSIZ SBIN;
       22       22    1   DCL N SBIN;
       23       23    1   DCL I SBIN;
       24       24    1   DCL BUFDISP UBIN;
       25       25    1   DCL BUFSIZ UBIN;
       26       26    1   DCL UGRANS UBIN;
       27       27    1   DCL FC UBIN;
       28       28    1   DCL UB$ PTR;
       29       29    1   DCL VPNO SBIN;
       30       30    1   DCL 1 WSRS DALIGNED,
       31       31    1         2 R(0:7) UBIN(9) UNAL;
       32       32    1   DCL 1 DESC,
PL6.E3A0      #001=FMI$RAN File=FMI$RAN.:E05TSI                                  TUE 07/29/97 16:49 Page:27   
       33       33    1         2 * BIT(29),
       34       34    1         2 WSR UBIN(3) UNAL,
       35       35    1         2 * BIT(4),
       36       36    1         2 BASE SBIN;
       37       37    1   DCL WSQ SBIN;
       38       38    1   DCL 1 STAMP,
       39       39    1         2 HASH UBIN(27) UNAL,
       40       40    1         2 GMOD UBIN(9) UNAL;
       41       41    1   DCL Q$ PTR;
       42       42    1   DCL TEMP_CHAR CHAR(1) CALIGNED;
       43       43        /* BASED STRUCTURES */
       44       44    1   DCL CHAR1 CHAR(1) UNAL BASED;
       45       45    1   DCL CHAR4 CHAR(4) BASED;
       46       46    1   DCL CLEAR CHAR(GBYTES) BASED;
       47       47    1   DCL WRDS(0:1023) SBIN BASED ALIGNED;
       48       48    1   DCL 1 CLR BASED ALIGNED,
       49       49    1         2 * SBIN,
       50       50    1         2 X CHAR(4092);
       51       51        /* EXTERNAL DATA */
       52       52    1   DCL B$JIT$ PTR SYMREF;
       53       53    1   DCL B$PS0$ PTR SYMREF READONLY;
       54       54    1   DCL B$PS1$ PTR SYMREF READONLY;
       55       55    1   DCL B$PS2$ PTR SYMREF READONLY;
       56       56    1   DCL FM$BUF$(0:0) PTR SYMREF;
       57       57        /* INCLUDE FILES */
       58       58        %INCLUDE F$JIT_C;
       59      488        %MACRO F$DCB (BASED="BASED(JDCB$)");
       60      489        %INCLUDE F$DCB;
       61      538        %MEND;
       62      539        %INCLUDE HF_LOCK_C;
       63      553        %INCLUDE FM$MACROS;
       64      928        %INCLUDE FM_DATA_R;
       65      942        %INCLUDE F_CODE_R;
       66      952        %INCLUDE F_FPTCODE_C;
       67      988        %INCLUDE F_ERRORS_C;
       68     1228        %INCLUDE F$CP6V_C;
       69     1454        %INCLUDE N_FC_C;
PL6.E3A0      #001=FMI$RAN File=FMI$RAN.:E05TSI                                  TUE 07/29/97 16:49 Page:28   
       70     1491        %INCLUDE N$REQ;
       71     1565        %INCLUDE B$USER;
       72     1781        %B$USERREFS;
       73     1785        %INCLUDE CP_6_SUBS;
       74     2325        %INCLUDE FM$RANEA;
       75     2335        %INCLUDE UM$CP6V_C;
       76     2522        /* EXTERNAL ROUTINES */
       77     2523    1   DCL FAG$GEXT ENTRY ALTRET;
       78     2524    1   DCL FMB$LOGERR ENTRY(11);
       79     2525    1   DCL FMB$QUEUE ENTRY(9) ALTRET;
       80     2526    1   DCL FMB$IOSPIN ENTRY;
       81     2527    1   DCL FMC$CLR1 ENTRY(1);
       82     2528    1   DCL FMC$GET ENTRY(4) ALTRET;
       83     2529    1   DCL FMD$FLSHBUF ENTRY(1);
       84     2530    1   DCL FMD$GETBUF ENTRY(3);
       85     2531    1   DCL FMD$RECTRAN ENTRY(8) ALTRET;
       86     2532    1   DCL FMD$RELBUF ENTRY(1);
       87     2533    1   DCL FMI$EA ENTRY(1);
       88     2534    1   DCL FMO$LOCCODT ENTRY(2) ALTRET;
       89     2535    1   DCL HFC$STWS ENTRY(1);
       90     2536    1   DCL HFF$NILERASE ENTRY(1) ALTRET;
       91     2537    1   DCL HFF$RET_PS_DESC ENTRY(2) ALTRET;
       92     2538    1   DCL HFF$WRITE1 ENTRY(1) ALTRET;
       93     2539    1   DCL MMC$CP_IOM ENTRY(3);
       94     2540    1   DCL MMC$ONLY_IOM ENTRY(3);
       95     2541    1   DCL NIQ$GET ENTRY(1) ALTRET;
       96     2542    1   DCL NIQ$REL ENTRY(1) ALTRET;
       97     2543    1   DCL NIQ$RELS ENTRY(1) ALTRET;
       98     2544    1   DCL SSS$SYSTIME ENTRY(1);
       99     2545    1   DCL UQB$MDEQ ENTRY(1) ALTRET;
      100     2546    1   DCL UQB$MENQXB ENTRY(1) ALTRET;
      101     2547        /* CONSTANT STORAGE */
      102     2548        %SUB FCG#='0615'O;
      103     2549        %SUB MID#='11'O;
      104     2550        %ERRCODE (NAME=ERREOF,COD#=%E$EOF);
      105     2554        %ERRCODE (NAME=ERRBOF,COD#=%E$BOF);
      106     2558        %ERRCODE (NAME=ERRBADBLK,COD#=%E$RANBADBLK);
PL6.E3A0      #001=FMI$RAN File=FMI$RAN.:E05TSI                                  TUE 07/29/97 16:49 Page:29   
      107     2562        %ERRCODE (NAME=ERRLD,COD#=%E$LD);
      108     2566        %ERRCODE (NAME=ERRRANBOUND,COD#=%E$RANBOUND);
      109     2570        %ERRCODE (NAME=ERRMTRAP,COD#=%E$MTRAP);
      110     2574        %ERRCODE (NAME=ERRDI,COD#=%E$DI);
      111     2578        %ERRCODE (NAME=ERRWRDEL,COD#=%E$WRDEL);
      112     2582        %ERRCODE (NAME=ERRBADVECT2,COD#= 422 );
      113     2586        /* FPTS */
      114     2587        %FPT$READ_V (BASED="BASED(B$PS0$)");
      115     2594        %FPT$WRITE_V (BASED="BASED(B$PS0$)");
      116     2600        %FPT$PFIL_V (BASED="BASED(B$PS0$)");
      117     2603        %FPT$EXTEND_V (BASED="BASED(B$PS0$)");
      118     2606        %FPT$PRECORD_V (BASED="BASED(B$PS0$)");
      119     2611        %FPT$DELREC_V (BASED="BASED(B$PS0$)");
      120     2615        /* BASED STRUCTURES */
      121     2616        %FM$GRAN;
      122     2620        %FM$SET(BASED="BASED(F$CFU$)");
      123     2625        %FM$VOL(BASED="BASED(F$CFU$)");
      124     2631        %F$DCB;
      125     2681        %FM$CFU (BASED="BASED(CFU$)");
      126     2687        %FM$RANEA (BASED="BASED(P$)");
      127     2690        %FM$VID;
      128     2696        %N$REQ (NAME=N$REQ,STCLASS=BASED);
      129     2754    1   DCL XLATE926(0:31)BIT(36)CONSTANT INIT(
      130     2755    1   '020020020020'O*8,'020077076013'O,'053074032073'O, /* ctl !"# $%&'            */
      131     2756    1   '035055054060'O,'073052033061'O,'000001002003'O, /* ()*+,-./0123              */
      132     2757    1   '004005006007'O,'010012015056'O,'036075016016'O, /* 456789:;<=>?              */
      133     2758    1   '014021022023'O,'024025026027'O,'030031041042'O, /* @ABCDEFGHIJK              */
      134     2759    1   '043044045046'O,'047050051062'O,'062064065066'O, /* LMNOPQRSTUVW              */
      135     2760    1   '067070071012'O,'037034040072'O,        /* XYZ[\]^_                           */
      136     2761    1   '020021022023'O,'024025026027'O,'030031041042'O, /* `abcdefghijk              */
      137     2762    1   '043044045046'O,'047050051062'O,'062064065066'O, /* lmnopqrstuvw              */
      138     2763    1   '067070071012'O,'037034040020'O);       /* xyz{|}~del                         */
      139     2764        %VLR$SITEINFO_V(FPTN=B_SITEINFO,BASED=SYMREF);
      140     2769    1   DCL CHARS CHAR(N) BASED UNAL;
      141     2770        /**/
      142     2771    1           JDCB$=B$JIT.DCB$;               /* POINTER TO CURRENT DCB             */

PL6.E3A0      #001=FMI$RAN File=FMI$RAN.:E05TSI                                  TUE 07/29/97 16:49 Page:30   
   2771  1 000002   000000 470400 xsym               LDP0    B$JIT$
         1 000003   000232 236100                    LDQ     154,,PR0
         1 000004   200004 756100                    STQ     JDCB$,,AUTO

      143     2772    1           CFU$=F$DCB.CFU$;                /* CURRENT CFU                        */

   2772  1 000005   200004 471500                    LDP1    JDCB$,,AUTO
         1 000006   100066 236100                    LDQ     54,,PR1
         1 000007   200005 756100                    STQ     CFU$,,AUTO

      144     2773    1           B$JIT.ERR='0'B;                 /* CLEAR ERROR CODE IN JIT            */

   2773  1 000010   000012 450100                    STZ     10,,PR0

      145     2774        /**/
      146     2775    1           IF F$DCB.ASN=%DEVICE# THEN

   2775  1 000011   100032 236100                    LDQ     26,,PR1
         1 000012   777000 376007                    ANQ     -512,DL
         1 000013   003000 116007                    CMPQ    1536,DL
         1 000014   000026 601000 1                  TNZ     s:2778

      147     2776    1              UGRANS=FM$SET$->FM$SET.NXTSDA(F$DCB.SETX)-FM_SRZERO; /* DEV PACK   */

   2776  1 000015   100051 236100                    LDQ     41,,PR1
         1 000016   000003 736000                    QLS     3
         1 000017   000000 376000 2                  ANQ     0
         1 000020   000000 473400 xsym               LDP3    FM$SET$
         1 000021   300003 236106                    LDQ     3,QL,PR3
         1 000022   000032 376000 xsym               ANQ     B_VECTNIL+26
         1 000023   000000 136000 xsym               SBLQ    FM_SRZERO
         1 000024   200017 756100                    STQ     UGRANS,,AUTO
         1 000025   000032 710000 1                  TRA     s:2780

      148     2777    1           ELSE
      149     2778    1              UGRANS=FM$CFU.UGRANS;        /* FILE                               */

PL6.E3A0      #001=FMI$RAN File=FMI$RAN.:E05TSI                                  TUE 07/29/97 16:49 Page:31   
   2778  1 000026   200005 473500                    LDP3    CFU$,,AUTO
         1 000027   300004 236100                    LDQ     4,,PR3
         1 000030   000032 376000 xsym               ANQ     B_VECTNIL+26
         1 000031   200017 756100                    STQ     UGRANS,,AUTO

      150     2779        /**/
      151     2780    2           DO CASE(FPTCODE);

   2780  1 000032   200003 473500                    LDP3    @FPTCODE,,AUTO
         1 000033   300000 235100                    LDA     0,,PR3
         1 000034   000011 115007                    CMPA    9,DL
         1 000035   000037 602005 1                  TNC     s:2780+5,AL
         1 000036   000050 710000 1                  TRA     s:2785
         1 000037   000424 710000 1                  TRA     s:2918
         1 000040   000444 710000 1                  TRA     s:2928
         1 000041   000177 710000 1                  TRA     s:2857
         1 000042   000064 710000 1                  TRA     s:2812
         1 000043   000055 710000 1                  TRA     s:2801
         1 000044   000050 710000 1                  TRA     s:2785
         1 000045   000052 710000 1                  TRA     REW
         1 000046   000050 710000 1                  TRA     s:2785
         1 000047   000051 710000 1                  TRA     s:2790

      152     2781    2            CASE(ELSE);                    /* DO NOTHING FOR OTHER PMMES         */

      153     2782        /**********************/
      154     2783        /******  OTHERS  ******/
      155     2784        /**********************/
      156     2785    2              RETURN;

   2785  1 000050   000000 702200 xent               TSX2  ! X66_ARET

      157     2786    2            CASE(FPTPFILEOF);

      158     2787        /**********************/
      159     2788        /*** FILE EXTENTION ***/
      160     2789        /*********************/
PL6.E3A0      #001=FMI$RAN File=FMI$RAN.:E05TSI                                  TUE 07/29/97 16:49 Page:32   
      161     2790    2              GOTO PFILEOF;

   2790  1 000051   000061 710000 1                  TRA     PFILEOF

      162     2791    2            CASE(FPTREW);

      163     2792        /**********************/
      164     2793        /******  M$REW  *******/
      165     2794        /**********************/
      166     2795    2   REW:       JDCB$->F$DCB.CRECNO=0;       /* POSITION TO BOF                    */

   2795  1 000052   200004 470500       REW          LDP0    JDCB$,,AUTO
         1 000053   000071 450100                    STZ     57,,PR0

      167     2796    2              RETURN;

   2796  1 000054   000000 702200 xent               TSX2  ! X66_ARET

      168     2797    2            CASE(FPTPFIL);

      169     2798        /*********************/
      170     2799        /*****  M$PFIL  ******/
      171     2800        /*********************/
      172     2801    2              IF FPT$PFIL_V.BOF THEN

   2801  1 000055   000000 474400 xsym               LDP4    B$PS0$
         1 000056   400000 236100                    LDQ     0,,PR4
         1 000057   400000 316007                    CANQ    -131072,DL
         1 000060   000052 601000 1                  TNZ     REW

      173     2802    2                 GOTO REW;
      174     2803    3              ELSE DO;

      175     2804    3   PFILEOF:      F$DCB.CRECNO=UGRANS;

   2804  1 000061   200017 236100       PFILEOF      LDQ     UGRANS,,AUTO
         1 000062   100071 756100                    STQ     57,,PR1
PL6.E3A0      #001=FMI$RAN File=FMI$RAN.:E05TSI                                  TUE 07/29/97 16:49 Page:33   

      176     2805    3                 RETURN;

   2805  1 000063   000000 702200 xent               TSX2  ! X66_ARET

      177     2806    3                 END;
      178     2807        /**/
      179     2808    2            CASE(FPTPREC);

      180     2809        /********************/
      181     2810        /***  M$PRECORD  ****/
      182     2811        /********************/
      183     2812    2              FC=1;

   2812  1 000064   000001 235007                    LDA     1,DL
         1 000065   200020 755100                    STA     FC,,AUTO

      184     2813    2              IF FPT$PRECORD_V.BOF THEN

   2813  1 000066   000000 474400 xsym               LDP4    B$PS0$
         1 000067   400000 236100                    LDQ     0,,PR4
         1 000070   020000 316007                    CANQ    8192,DL
         1 000071   000074 600000 1                  TZE     s:2815

      185     2814    2                 F$DCB.CRECNO=0;

   2814  1 000072   100071 450100                    STZ     57,,PR1
         1 000073   000120 710000 1                  TRA     s:2824

      186     2815    2              ELSE IF FPT$PRECORD_V.EOF THEN

   2815  1 000074   010000 316007                    CANQ    4096,DL
         1 000075   000101 600000 1                  TZE     s:2817

      187     2816    2                    F$DCB.CRECNO=UGRANS;

   2816  1 000076   200017 235100                    LDA     UGRANS,,AUTO
PL6.E3A0      #001=FMI$RAN File=FMI$RAN.:E05TSI                                  TUE 07/29/97 16:49 Page:34   
         1 000077   100071 755100                    STA     57,,PR1
         1 000100   000120 710000 1                  TRA     s:2824

      188     2817    2                 ELSE IF FPT$PRECORD_V.KEYS THEN

   2817  1 000101   400000 316007                    CANQ    -131072,DL
         1 000102   000110 600000 1                  TZE     PREC2

      189     2818    2                       ADDR(F$DCB.CRECNO)->CHAR4=B$PS1$->CHAR4; /* Move user key */

   2818  1 000103   000000 475400 xsym               LDP5    B$PS1$
         1 000104   040100 100500                    MLR     fill='040'O
         1 000105   500000 000004                    ADSC9   0,,PR5                   cn=0,n=4
         1 000106   100071 000004                    ADSC9   57,,PR1                  cn=0,n=4
         1 000107   000120 710000 1                  TRA     s:2824

      190     2819    3                    ELSE DO;               /* Position by N                      */

      191     2820    3   PREC2:              FC=0;

   2820  1 000110   200020 450100       PREC2        STZ     FC,,AUTO

      192     2821    3                       BLKSIZ=F$DCB.CRECNO; /* REMEMBER OLD POSITION             */

   2821  1 000111   200004 470500                    LDP0    JDCB$,,AUTO
         1 000112   000071 235100                    LDA     57,,PR0
         1 000113   200012 755100                    STA     BLKSIZ,,AUTO

      193     2822    3                       F$DCB.CRECNO=F$DCB.CRECNO+FPT$PRECORD_V.N;

   2822  1 000114   000000 471400 xsym               LDP1    B$PS0$
         1 000115   000071 236100                    LDQ     57,,PR0
         1 000116   100001 036100                    ADLQ    1,,PR1
         1 000117   000071 756100                    STQ     57,,PR0

      194     2823    3                       END;

PL6.E3A0      #001=FMI$RAN File=FMI$RAN.:E05TSI                                  TUE 07/29/97 16:49 Page:35   
      195     2824    3              IF F$DCB.CRECNO<0 OR F$DCB.CRECNO>UGRANS THEN DO;

   2824  1 000120   200004 470500                    LDP0    JDCB$,,AUTO
         1 000121   000071 235100                    LDA     57,,PR0
         1 000122   000127 604000 1                  TMI     s:2825
         1 000123   200017 236100                    LDQ     UGRANS,,AUTO
         1 000124   000154 604000 1                  TMI     s:2841
         1 000125   000071 116100                    CMPQ    57,,PR0
         1 000126   000154 605000 1                  TPL     s:2841

      196     2825    4                 IF F$DCB.CRECNO<0 THEN DO;

   2825  1 000127   000000 115003                    CMPA    0,DU
         1 000130   000135 605000 1                  TPL     s:2833

      197     2826    4                    F$DCB.CRECNO=0;        /* HIT BOF                            */

   2826  1 000131   000071 450100                    STZ     57,,PR0

      198     2827    4                    B$JIT.ERR=ERRBOF;

   2827  1 000132   000001 236000 0                  LDQ     ERRBOF
         1 000133   000000 471400 xsym               LDP1    B$JIT$
         1 000134   100012 756100                    STQ     10,,PR1

      199     2828    4                    END;

      200     2829        /*E*   ERROR:    FMI-E$BOF-2
      201     2830        *      DESCRIPTION:  An M$PRECORD by number of records attempted to
      202     2831        *        position beyond the beginning of the file.
      203     2832        */
      204     2833    4                 IF F$DCB.CRECNO>UGRANS THEN DO;

   2833  1 000135   200017 236100                    LDQ     UGRANS,,AUTO
         1 000136   000145 604000 1                  TMI     s:2837
         1 000137   000071 116100                    CMPQ    57,,PR0
         1 000140   000145 605000 1                  TPL     s:2837
PL6.E3A0      #001=FMI$RAN File=FMI$RAN.:E05TSI                                  TUE 07/29/97 16:49 Page:36   

      205     2834    4                    F$DCB.CRECNO=UGRANS;

   2834  1 000141   000071 756100                    STQ     57,,PR0

      206     2835    4                    B$JIT.ERR=ERREOF;

   2835  1 000142   000000 236000 0                  LDQ     ERREOF
         1 000143   000000 471400 xsym               LDP1    B$JIT$
         1 000144   100012 756100                    STQ     10,,PR1

      207     2836    4                    END;

      208     2837    3                 IF FPT$PRECORD_V.KEYS THEN /* IF POSITIONED BY EXPLICIT         */

   2837  1 000145   000000 471400 xsym               LDP1    B$PS0$
         1 000146   100000 236100                    LDQ     0,,PR1
         1 000147   400000 316007                    CANQ    -131072,DL
         1 000150   000154 600000 1                  TZE     s:2841

      209     2838    3                    B$JIT.ERR=ERRBADBLK;   /* KEY, GIVE DIFFERENT ERROR          */

   2838  1 000151   000002 236000 0                  LDQ     ERRBADBLK
         1 000152   000000 473400 xsym               LDP3    B$JIT$
         1 000153   300012 756100                    STQ     10,,PR3

      210     2839    3                 END;

      211     2840        /**/
      212     2841    3              IF FC=0 THEN DO;             /* Positioning by N                   */

   2841  1 000154   200020 235100                    LDA     FC,,AUTO
         1 000155   000110 601000 1                  TNZ     PREC2

      213     2842    3                 F$DCB.ARS=F$DCB.CRECNO-BLKSIZ; /* CALC # RECS SKIPPED           */

   2842  1 000156   000071 236100                    LDQ     57,,PR0
PL6.E3A0      #001=FMI$RAN File=FMI$RAN.:E05TSI                                  TUE 07/29/97 16:49 Page:37   
         1 000157   200012 136100                    SBLQ    BLKSIZ,,AUTO
         1 000160   000000 756100                    STQ     0,,PR0

      214     2843    3                 IF F$DCB.ARS<0 THEN

   2843  1 000161   000166 605000 1                  TPL     s:2849

      215     2844    3                    F$DCB.ARS=-F$DCB.ARS;

   2844  1 000162   000000 235100                    LDA     0,,PR0
         1 000163   000000 531000                    NEG     0
         1 000164   000000 755100                    STA     0,,PR0

      216     2845    3                 END;

   2845  1 000165   000166 710000 1                  TRA     s:2849

      217     2846    2              ELSE
      218     2847    2                 GOTO PREC2;          /*  Make another pass for position by N    */
      219     2848        /**/
      220     2849    2              IF FPT$PRECORD_V.KEYR THEN

   2849  1 000166   000000 471400 xsym               LDP1    B$PS0$
         1 000167   100000 236100                    LDQ     0,,PR1
         1 000170   200000 316007                    CANQ    65536,DL
         1 000171   000176 600000 1                  TZE     s:2851

      221     2850    2                 B$PS1$->CHAR4=ADDR(F$DCB.CRECNO)->CHAR4; /* Return key to user  */

   2850  1 000172   000000 473400 xsym               LDP3    B$PS1$
         1 000173   040100 100500                    MLR     fill='040'O
         1 000174   000071 000004                    ADSC9   57,,PR0                  cn=0,n=4
         1 000175   300000 000004                    ADSC9   0,,PR3                   cn=0,n=4

      222     2851    2              GOTO SETEOP;

   2851  1 000176   002325 710000 1                  TRA     SETEOP
PL6.E3A0      #001=FMI$RAN File=FMI$RAN.:E05TSI                                  TUE 07/29/97 16:49 Page:38   

      223     2852        /**/
      224     2853    2            CASE(FPTDELREC);

      225     2854        /**********************/
      226     2855        /***  M$DELREC  *****/
      227     2856        /**********************/
      228     2857    2              F$DCB.ARS=0;

   2857  1 000177   100000 450100                    STZ     0,,PR1

      229     2858    2              IF F$DCB.ASN=%FILE# AND FPT$DELREC_V.DELALL THEN

   2858  1 000200   100032 236100                    LDQ     26,,PR1
         1 000201   777000 376007                    ANQ     -512,DL
         1 000202   001000 116007                    CMPQ    512,DL
         1 000203   000212 601000 1                  TNZ     s:2861
         1 000204   000000 470400 xsym               LDP0    B$PS0$
         1 000205   000001 236100                    LDQ     1,,PR0
         1 000206   100000 316007                    CANQ    32768,DL
         1 000207   000212 600000 1                  TZE     s:2861

      230     2859    2                 VPNO=0;

   2859  1 000210   200022 450100                    STZ     VPNO,,AUTO
         1 000211   000222 710000 1                  TRA     s:2864

      231     2860    3              ELSE DO;

      232     2861    3                 CALL HFF$NILERASE(1) ALTRET(DELERR); /* MUST HAVE KEY           */

   2861  1 000212   000001 630400 2                  EPPR0   1
         1 000213   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 000214   000000 701000 xent               TSX1    HFF$NILERASE
         1 000215   000420 702000 1                  TSX2    DELERR

      233     2862    3                 ADDR(VPNO)->CHAR4=B$PS1$->CHAR4; /* GET FIRST KEY               */
PL6.E3A0      #001=FMI$RAN File=FMI$RAN.:E05TSI                                  TUE 07/29/97 16:49 Page:39   

   2862  1 000216   000000 470400 xsym               LDP0    B$PS1$
         1 000217   040100 100500                    MLR     fill='040'O
         1 000220   000000 000004                    ADSC9   0,,PR0                   cn=0,n=4
         1 000221   200022 000004                    ADSC9   VPNO,,AUTO               cn=0,n=4

      234     2863    3                 END;

      235     2864    2              IF F$DCB.ASN=%DEVICE# THEN

   2864  1 000222   200004 470500                    LDP0    JDCB$,,AUTO
         1 000223   000032 236100                    LDQ     26,,PR0
         1 000224   777000 376007                    ANQ     -512,DL
         1 000225   003000 116007                    CMPQ    1536,DL
         1 000226   000235 601000 1                  TNZ     s:2867

      236     2865    2                 IF VPNO>=FM_SRZERO THEN

   2865  1 000227   200022 236100                    LDQ     VPNO,,AUTO
         1 000230   000235 604000 1                  TMI     s:2867
         1 000231   000000 116000 xsym               CMPQ    FM_SRZERO
         1 000232   000235 602000 1                  TNC     s:2867

      237     2866    2                    VPNO=VPNO-FM_SRZERO;

   2866  1 000233   000000 136000 xsym               SBLQ    FM_SRZERO
         1 000234   200022 756100                    STQ     VPNO,,AUTO

      238     2867    2              WSQ=VPNO;                    /* ASSUME ONLY ONE GRAN               */

   2867  1 000235   200022 235100                    LDA     VPNO,,AUTO
         1 000236   200030 755100                    STA     WSQ,,AUTO

      239     2868    2              IF F$DCB.ASN=%FILE# AND FPT$DELREC_V.DELALL THEN

   2868  1 000237   000032 236100                    LDQ     26,,PR0
         1 000240   777000 376007                    ANQ     -512,DL
PL6.E3A0      #001=FMI$RAN File=FMI$RAN.:E05TSI                                  TUE 07/29/97 16:49 Page:40   
         1 000241   001000 116007                    CMPQ    512,DL
         1 000242   000253 601000 1                  TNZ     s:2871
         1 000243   000000 471400 xsym               LDP1    B$PS0$
         1 000244   100001 236100                    LDQ     1,,PR1
         1 000245   100000 316007                    CANQ    32768,DL
         1 000246   000253 600000 1                  TZE     s:2871

      240     2869    2                 WSQ=UGRANS-1;

   2869  1 000247   200017 235100                    LDA     UGRANS,,AUTO
         1 000250   000001 135007                    SBLA    1,DL
         1 000251   200030 755100                    STA     WSQ,,AUTO
         1 000252   000263 710000 1                  TRA     s:2874

      241     2870    3              ELSE DO;

      242     2871    3                 CALL HFF$NILERASE(2) ALTRET(DELR20);

   2871  1 000253   000002 630400 2                  EPPR0   2
         1 000254   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 000255   000000 701000 xent               TSX1    HFF$NILERASE
         1 000256   000313 702000 1                  TSX2    DELR20

      243     2872    3                 ADDR(WSQ)->CHAR4=B$PS2$->CHAR4; /* GET END KEY                  */

   2872  1 000257   000000 470400 xsym               LDP0    B$PS2$
         1 000260   040100 100500                    MLR     fill='040'O
         1 000261   000000 000004                    ADSC9   0,,PR0                   cn=0,n=4
         1 000262   200030 000004                    ADSC9   WSQ,,AUTO                cn=0,n=4

      244     2873    3                 END;

      245     2874    2              IF F$DCB.ASN=%DEVICE# THEN

   2874  1 000263   200004 470500                    LDP0    JDCB$,,AUTO
         1 000264   000032 236100                    LDQ     26,,PR0
         1 000265   777000 376007                    ANQ     -512,DL
PL6.E3A0      #001=FMI$RAN File=FMI$RAN.:E05TSI                                  TUE 07/29/97 16:49 Page:41   
         1 000266   003000 116007                    CMPQ    1536,DL
         1 000267   000276 601000 1                  TNZ     s:2877

      246     2875    2                 IF WSQ>=FM_SRZERO THEN

   2875  1 000270   200030 236100                    LDQ     WSQ,,AUTO
         1 000271   000276 604000 1                  TMI     s:2877
         1 000272   000000 116000 xsym               CMPQ    FM_SRZERO
         1 000273   000276 602000 1                  TNC     s:2877

      247     2876    2                    WSQ=WSQ-FM_SRZERO;

   2876  1 000274   000000 136000 xsym               SBLQ    FM_SRZERO
         1 000275   200030 756100                    STQ     WSQ,,AUTO

      248     2877    2              IF WSQ>UGRANS-1 THEN

   2877  1 000276   200030 236100                    LDQ     WSQ,,AUTO
         1 000277   000305 604000 1                  TMI     s:2879
         1 000300   200017 116100                    CMPQ    UGRANS,,AUTO
         1 000301   000305 602000 1                  TNC     s:2879

      249     2878    2                 WSQ=UGRANS-1;             /* LIMIT TO TOTAL SIZE                */

   2878  1 000302   200017 235100                    LDA     UGRANS,,AUTO
         1 000303   000001 135007                    SBLA    1,DL
         1 000304   200030 755100                    STA     WSQ,,AUTO

      250     2879    2              IF VPNO<0 THEN

   2879  1 000305   200022 235100                    LDA     VPNO,,AUTO
         1 000306   000312 605000 1                  TPL     s:2884

      251     2880    2                 IF WSQ<0 THEN

   2880  1 000307   200030 236100                    LDQ     WSQ,,AUTO
         1 000310   002325 604000 1                  TMI     SETEOP
PL6.E3A0      #001=FMI$RAN File=FMI$RAN.:E05TSI                                  TUE 07/29/97 16:49 Page:42   

      252     2881    2                    GOTO SETEOP;           /* BEGINNING AND END ARE ILLEGAL      */
      253     2882    2                 ELSE
      254     2883    2                    VPNO=0;

   2883  1 000311   200022 450100                    STZ     VPNO,,AUTO

      255     2884    2              GOTO DELR30;

   2884  1 000312   000315 710000 1                  TRA     DELR30

      256     2885        /**/
      257     2886    2   DELR20:    IF VPNO<0 THEN

   2886  1 000313   200022 235100       DELR20       LDA     VPNO,,AUTO
         1 000314   000566 604000 1                  TMI     BADBLK

      258     2887    2                 GOTO BADBLK;         /* ILLEGAL BLOCK # FOR SINGLE BLOCK DELETE */
      259     2888        /**/
      260     2889    2   DELR30:    N=WSQ-VPNO+1;                /* # GRANS TO TRASH                   */

   2889  1 000315   200030 236100       DELR30       LDQ     WSQ,,AUTO
         1 000316   200022 136100                    SBLQ    VPNO,,AUTO
         1 000317   000001 036007                    ADLQ    1,DL
         1 000320   200013 756100                    STQ     N,,AUTO

      261     2890    2              F$DCB.ARS=N;

   2890  1 000321   200004 470500                    LDP0    JDCB$,,AUTO
         1 000322   000000 756100                    STQ     0,,PR0

      262     2891    2              IF F$DCB.ASN=%DEVICE# THEN

   2891  1 000323   000032 236100                    LDQ     26,,PR0
         1 000324   777000 376007                    ANQ     -512,DL
         1 000325   003000 116007                    CMPQ    1536,DL
         1 000326   000333 601000 1                  TNZ     s:2894
PL6.E3A0      #001=FMI$RAN File=FMI$RAN.:E05TSI                                  TUE 07/29/97 16:49 Page:43   

      263     2892    2                 DA=VPNO+FM_SRZERO;

   2892  1 000327   200022 236100                    LDQ     VPNO,,AUTO
         1 000330   000000 036000 xsym               ADLQ    FM_SRZERO
         1 000331   200011 756100                    STQ     DA,,AUTO
         1 000332   000336 710000 1                  TRA     s:2895

      264     2893    2              ELSE
      265     2894    2                 DA=VPNO+FM_FRZERO;

   2894  1 000333   200022 236100                    LDQ     VPNO,,AUTO
         1 000334   000000 036000 xsym               ADLQ    FM_FRZERO
         1 000335   200011 756100                    STQ     DA,,AUTO

      266     2895    3              DO WHILE(N>0);

   2895  1 000336   200013 235100                    LDA     N,,AUTO
         1 000337   000417 604400 1                  TMOZ    s:2906

      267     2896    3                 IF N>4 THEN

   2896  1 000340   200013 235100                    LDA     N,,AUTO
         1 000341   000004 115007                    CMPA    4,DL
         1 000342   000346 604400 1                  TMOZ    s:2899

      268     2897    3                    BLKSIZ=4*4096;         /* CAN ONLY DO 4 GRANS AT A TIME      */

   2897  1 000343   040000 236007                    LDQ     16384,DL
         1 000344   200012 756100                    STQ     BLKSIZ,,AUTO
         1 000345   000350 710000 1                  TRA     s:2900

      269     2898    3                 ELSE
      270     2899    3                    BLKSIZ=N*4096;

   2899  1 000346   000014 735000                    ALS     12
         1 000347   200012 755100                    STA     BLKSIZ,,AUTO
PL6.E3A0      #001=FMI$RAN File=FMI$RAN.:E05TSI                                  TUE 07/29/97 16:49 Page:44   

      271     2900    3                 CALL FMB$QUEUE(ADDR(NIL),0,BLKSIZ,DA,%N_WRZERO,0,ENTADDR(NIL),0);

   2900  1 000350   000001 236000 xsym               LDQ     B_VECTNIL+1
         1 000351   200036 756100                    STQ     TEMP_CHAR+3,,AUTO
         1 000352   000004 237000 2                  LDAQ    4
         1 000353   200046 757100                    STAQ    TEMP_CHAR+11,,AUTO
         1 000354   000006 237000 2                  LDAQ    6
         1 000355   200044 757100                    STAQ    TEMP_CHAR+9,,AUTO
         1 000356   200011 630500                    EPPR0   DA,,AUTO
         1 000357   200043 450500                    STP0    TEMP_CHAR+8,,AUTO
         1 000360   200012 631500                    EPPR1   BLKSIZ,,AUTO
         1 000361   200042 451500                    STP1    TEMP_CHAR+7,,AUTO
         1 000362   000004 236000 2                  LDQ     4
         1 000363   200041 756100                    STQ     TEMP_CHAR+6,,AUTO
         1 000364   200036 633500                    EPPR3   TEMP_CHAR+3,,AUTO
         1 000365   200040 453500                    STP3    TEMP_CHAR+5,,AUTO
         1 000366   200040 630500                    EPPR0   TEMP_CHAR+5,,AUTO
         1 000367   000026 631400 xsym               EPPR1   B_VECTNIL+22
         1 000370   000000 701000 xent               TSX1    FMB$QUEUE
         1 000371   000000 011000                    NOP     0

      272     2901    3                 IF F$DCB.ACS = %BLOCK# AND F$DCB.FUN ~= %CREATE# THEN

   2901  1 000372   200004 470500                    LDP0    JDCB$,,AUTO
         1 000373   000036 236100                    LDQ     30,,PR0
         1 000374   000777 376007                    ANQ     511,DL
         1 000375   000003 116007                    CMPQ    3,DL
         1 000376   000411 601000 1                  TNZ     s:2903
         1 000377   000032 236100                    LDQ     26,,PR0
         1 000400   000777 376003                    ANQ     511,DU
         1 000401   000003 116003                    CMPQ    3,DU
         1 000402   000411 600000 1                  TZE     s:2903

      273     2902    3                    CALL FMC$CLR1(DA);

   2902  1 000403   200011 631500                    EPPR1   DA,,AUTO
PL6.E3A0      #001=FMI$RAN File=FMI$RAN.:E05TSI                                  TUE 07/29/97 16:49 Page:45   
         1 000404   200036 451500                    STP1    TEMP_CHAR+3,,AUTO
         1 000405   200036 630500                    EPPR0   TEMP_CHAR+3,,AUTO
         1 000406   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 000407   000000 701000 xent               TSX1    FMC$CLR1
         1 000410   000000 011000                    NOP     0

      274     2903    3                 DA=DA+4;

   2903  1 000411   200011 235100                    LDA     DA,,AUTO
         1 000412   000004 035007                    ADLA    4,DL
         1 000413   200011 755100                    STA     DA,,AUTO

      275     2904    3                 N=N-4;

   2904  1 000414   000004 336007                    LCQ     4,DL
         1 000415   200013 056100                    ASQ     N,,AUTO

      276     2905    3                 END;

   2905  1 000416   000340 605400 1                  TPNZ    s:2896

      277     2906    2              GOTO SETEOP;

   2906  1 000417   002325 710000 1                  TRA     SETEOP

      278     2907        /**/
      279     2908    2   DELERR:    B$JIT.ERR=ERRWRDEL;

   2908  1 000420   000007 236000 0     DELERR       LDQ     ERRWRDEL
         1 000421   000000 470400 xsym               LDP0    B$JIT$
         1 000422   000012 756100                    STQ     10,,PR0

      280     2909    2              GOTO SETEOP;

   2909  1 000423   002325 710000 1                  TRA     SETEOP

      281     2910        /*E*    ERROR:  FMI-E$WRDEL-2
PL6.E3A0      #001=FMI$RAN File=FMI$RAN.:E05TSI                                  TUE 07/29/97 16:49 Page:46   
      282     2911        *       MESSAGE: M$DELREC to random or IDS file %%FN %requires a key
      283     2912        */
      284     2913        /**/
      285     2914    2            CASE(FPTREAD);

      286     2915        /********************/
      287     2916        /****  M$READ  ******/
      288     2917        /********************/
      289     2918    2              IF FPT$READ_V.KEYS THEN

   2918  1 000424   000000 474400 xsym               LDP4    B$PS0$
         1 000425   400000 236100                    LDQ     0,,PR4
         1 000426   200000 316007                    CANQ    65536,DL
         1 000427   000435 600000 1                  TZE     s:2921

      290     2919    2                 ADDR(F$DCB.CRECNO)->CHAR4=B$PS1$->CHAR4; /* Move key to DCB     */

   2919  1 000430   000000 475400 xsym               LDP5    B$PS1$
         1 000431   040100 100500                    MLR     fill='040'O
         1 000432   500000 000004                    ADSC9   0,,PR5                   cn=0,n=4
         1 000433   100071 000004                    ADSC9   57,,PR1                  cn=0,n=4
         1 000434   000455 710000 1                  TRA     RWCOM

      291     2920    2              ELSE
      292     2921    2                 IF FPT$READ_V.KEYR THEN

   2921  1 000435   100000 316007                    CANQ    32768,DL
         1 000436   000455 600000 1                  TZE     RWCOM

      293     2922    2                    B$PS1$->CHAR4=ADDR(F$DCB.CRECNO)->CHAR4;

   2922  1 000437   000000 475400 xsym               LDP5    B$PS1$
         1 000440   040100 100500                    MLR     fill='040'O
         1 000441   100071 000004                    ADSC9   57,,PR1                  cn=0,n=4
         1 000442   500000 000004                    ADSC9   0,,PR5                   cn=0,n=4
         1 000443   000455 710000 1                  TRA     RWCOM

PL6.E3A0      #001=FMI$RAN File=FMI$RAN.:E05TSI                                  TUE 07/29/97 16:49 Page:47   
      294     2923        /**/
      295     2924    2            CASE(FPTWRITE);

      296     2925        /********************/
      297     2926        /*****  M$WRITE  ****/
      298     2927        /********************/
      299     2928    2              CALL HFF$NILERASE(1) ALTRET(RWCOM); /* GO IF NO KEY                */

   2928  1 000444   000001 630400 2                  EPPR0   1
         1 000445   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 000446   000000 701000 xent               TSX1    HFF$NILERASE
         1 000447   000455 702000 1                  TSX2    RWCOM

      300     2929    2              ADDR(F$DCB.CRECNO)->CHAR4=B$PS1$->CHAR4;

   2929  1 000450   000000 470400 xsym               LDP0    B$PS1$
         1 000451   200004 471500                    LDP1    JDCB$,,AUTO
         1 000452   040100 100500                    MLR     fill='040'O
         1 000453   000000 000004                    ADSC9   0,,PR0                   cn=0,n=4
         1 000454   100071 000004                    ADSC9   57,,PR1                  cn=0,n=4

      301     2930        /**/
      302     2931    2            END;

      303     2932        /**/
      304     2933        /***************************/
      305     2934        /****  M$READ, M$WRITE  ****/
      306     2935        /***************************/
      307     2936    1   RWCOM:  F$DCB.EOP=0;                    /* CLEAR IN CASE OF ERROR             */

   2936  1 000455   200004 470500       RWCOM        LDP0    JDCB$,,AUTO
         1 000456   000010 236000 2                  LDQ     8
         1 000457   000064 356100                    ANSQ    52,,PR0

      308     2937        /**/
      309     2938    1           IF FPT$READ_V.FULL OR F$DCB.ASN=%DEVICE# OR F$DCB.ACS=%BLOCK# THEN

PL6.E3A0      #001=FMI$RAN File=FMI$RAN.:E05TSI                                  TUE 07/29/97 16:49 Page:48   
   2938  1 000460   000000 471400 xsym               LDP1    B$PS0$
         1 000461   100000 236100                    LDQ     0,,PR1
         1 000462   010000 316007                    CANQ    4096,DL
         1 000463   000474 601000 1                  TNZ     s:2939
         1 000464   000032 236100                    LDQ     26,,PR0
         1 000465   777000 376007                    ANQ     -512,DL
         1 000466   003000 116007                    CMPQ    1536,DL
         1 000467   000474 600000 1                  TZE     s:2939
         1 000470   000036 236100                    LDQ     30,,PR0
         1 000471   000777 376007                    ANQ     511,DL
         1 000472   000003 116007                    CMPQ    3,DL
         1 000473   000477 601000 1                  TNZ     s:2941

      310     2939    1              BLKSIZ=1024*4;               /* 1024 WORD BLOCKS                   */

   2939  1 000474   010000 235007                    LDA     4096,DL
         1 000475   200012 755100                    STA     BLKSIZ,,AUTO
         1 000476   000501 710000 1                  TRA     s:2944

      311     2940    1           ELSE
      312     2941    1              BLKSIZ=1023*4;               /* 1023 WORD BLOCKS                   */

   2941  1 000477   007774 235007                    LDA     4092,DL
         1 000500   200012 755100                    STA     BLKSIZ,,AUTO

      313     2942        /**/
      314     2943        /**/
      315     2944    1           IF (FPTCODE=FPTREAD) AND

   2944  1 000501   200003 473500                    LDP3    @FPTCODE,,AUTO
         1 000502   300000 235100                    LDA     0,,PR3
         1 000503   000535 601000 1                  TNZ     s:2956
         1 000504   100000 236100                    LDQ     0,,PR1
         1 000505   010000 316007                    CANQ    4096,DL
         1 000506   000513 601000 1                  TNZ     s:2944+10
         1 000507   000036 236100                    LDQ     30,,PR0
         1 000510   000777 376007                    ANQ     511,DL
PL6.E3A0      #001=FMI$RAN File=FMI$RAN.:E05TSI                                  TUE 07/29/97 16:49 Page:49   
         1 000511   000014 116007                    CMPQ    12,DL
         1 000512   000535 601000 1                  TNZ     s:2956
         1 000513   000076 236100                    LDQ     62,,PR0
         1 000514   000525 605000 1                  TPL     s:2944+20
         1 000515   200012 235100                    LDA     BLKSIZ,,AUTO
         1 000516   000001 405007                    CMG     1,DL
         1 000517   000523 600000 1                  TZE     s:2944+18
         1 000520   000000 235003                    LDA     0,DU
         1 000521   000001 737000                    LLS     1
         1 000522   200012 507100                    DVF     BLKSIZ,,AUTO
         1 000523   000044 737000                    LLS     36
         1 000524   000526 710000 1                  TRA     s:2944+21
         1 000525   200012 506100                    DIV     BLKSIZ,,AUTO
         1 000526   000044 733000                    LRS     36
         1 000527   000000 116003                    CMPQ    0,DU
         1 000530   000535 604400 1                  TMOZ    s:2956

      316     2945    1             ((FPT$READ_V.FULL) OR (F$DCB.ACS=%UBLOCK#)) AND
      317     2946    2             (MOD (F$DCB.UBYTES,BLKSIZ) > 0) THEN DO; /* bad buffer size         */

      318     2947    2              B$JIT$->B$JIT.ERR = ERRBADVECT2;

   2947  1 000531   000010 236000 0                  LDQ     ERRBADVECT2
         1 000532   000000 474400 xsym               LDP4    B$JIT$
         1 000533   400012 756100                    STQ     10,,PR4

      319     2948    2              GOTO SCHEDDO ;

   2948  1 000534   002316 710000 1                  TRA     SCHEDDO

      320     2949    2              END;
      321     2950        /*E*    ERROR:  FMI-E$BADVECT2-2
      322     2951                MESSAGE: Buffer must be a multiple of 1024(1023 if not FULL).
      323     2952                DESCRIPTION:  The buffer the user specified is not big enough
      324     2953                              to fit a Full granule into it.
      325     2954        */
      326     2955        /**/
PL6.E3A0      #001=FMI$RAN File=FMI$RAN.:E05TSI                                  TUE 07/29/97 16:49 Page:50   
      327     2956    1           IF F$DCB.ASN=%DEVICE# THEN

   2956  1 000535   000032 236100                    LDQ     26,,PR0
         1 000536   777000 376007                    ANQ     -512,DL
         1 000537   003000 116007                    CMPQ    1536,DL
         1 000540   000547 601000 1                  TNZ     s:2959

      328     2957    1              IF F$DCB.CRECNO>=FM_SRZERO THEN /* REMOVE SET-REL BASE             */

   2957  1 000541   000071 236100                    LDQ     57,,PR0
         1 000542   000547 604000 1                  TMI     s:2959
         1 000543   000000 116000 xsym               CMPQ    FM_SRZERO
         1 000544   000547 602000 1                  TNC     s:2959

      329     2958    1                 F$DCB.CRECNO=F$DCB.CRECNO-FM_SRZERO;

   2958  1 000545   000000 136000 xsym               SBLQ    FM_SRZERO
         1 000546   000071 756100                    STQ     57,,PR0

      330     2959    1           IF F$DCB.CRECNO < 0 THEN        /* Negative block number.             */

   2959  1 000547   000071 235100                    LDA     57,,PR0
         1 000550   000566 604000 1                  TMI     BADBLK

      331     2960    1              GOTO BADBLK;
      332     2961    1           IF F$DCB.CRECNO+((F$DCB.UBYTES+BLKSIZ-1)/BLKSIZ)>UGRANS

   2961  1 000551   000076 236100                    LDQ     62,,PR0
         1 000552   200012 036100                    ADLQ    BLKSIZ,,AUTO
         1 000553   000001 136007                    SBLQ    1,DL
         1 000554   200012 506100                    DIV     BLKSIZ,,AUTO
         1 000555   000071 036100                    ADLQ    57,,PR0
         1 000556   000623 604000 1                  TMI     s:3005
         1 000557   200017 116100                    CMPQ    UGRANS,,AUTO
         1 000560   000623 602000 1                  TNC     s:3005
         1 000561   000623 600000 1                  TZE     s:3005

PL6.E3A0      #001=FMI$RAN File=FMI$RAN.:E05TSI                                  TUE 07/29/97 16:49 Page:51   
      333     2962    1           THEN        /* AT LEAST PART OF TRANSFER EXTENDS BEYOND END OF FILE   */
      334     2963    2           DO;

      335     2964    2              IF F$DCB.CRECNO>UGRANS

   2964  1 000562   200017 236100                    LDQ     UGRANS,,AUTO
         1 000563   000575 604000 1                  TMI     s:2978
         1 000564   000071 116100                    CMPQ    57,,PR0
         1 000565   000575 605000 1                  TPL     s:2978

      336     2965    2              THEN                         /* START OF TRANSFER IS BEYOND END    */
      337     2966    3              DO;

      338     2967    3   BADBLK:       B$JIT$->B$JIT.ERR=ERRBADBLK;

   2967  1 000566   000002 236000 0     BADBLK       LDQ     ERRBADBLK
         1 000567   000000 470400 xsym               LDP0    B$JIT$
         1 000570   000012 756100                    STQ     10,,PR0

      339     2968    3                 F$DCB.CRECNO=UGRANS;

   2968  1 000571   200017 235100                    LDA     UGRANS,,AUTO
         1 000572   200004 471500                    LDP1    JDCB$,,AUTO
         1 000573   100071 755100                    STA     57,,PR1

      340     2969    3                 GOTO SCHEDDO;

   2969  1 000574   002316 710000 1                  TRA     SCHEDDO

      341     2970    3                 END;
      342     2971        /*E*   ERROR:  FMI-E$RANBADBLK-2
      343     2972        *       MESSAGE:  Illegal block number% for file %FN%
      344     2973        *       MESSAGE1: The specified block # is negative or greater than
      345     2974         size of the file
      346     2975        *      DESCRIPTION:  The block number specified for a random file is
      347     2976        *        beyond the end of the file.
      348     2977        */
PL6.E3A0      #001=FMI$RAN File=FMI$RAN.:E05TSI                                  TUE 07/29/97 16:49 Page:52   
      349     2978    2              IF F$DCB.CRECNO=UGRANS THEN  /* RIGHT AT END - MAY BE OK           */

   2978  1 000575   000000 116003                    CMPQ    0,DU
         1 000576   000612 604000 1                  TMI     s:2990
         1 000577   000071 116100                    CMPQ    57,,PR0
         1 000600   000612 601000 1                  TNZ     s:2990

      350     2979    3                 IF FPTCODE=FPTREAD AND NOT FPT$READ_V.KEYS THEN DO;

   2979  1 000601   300000 235100                    LDA     0,,PR3
         1 000602   000566 601000 1                  TNZ     BADBLK
         1 000603   100000 236100                    LDQ     0,,PR1
         1 000604   200000 316007                    CANQ    65536,DL
         1 000605   000566 601000 1                  TNZ     BADBLK

      351     2980    3                    B$JIT.ERR=ERREOF;      /* EOF IF READ W/O KEY AT END         */

   2980  1 000606   000000 236000 0                  LDQ     ERREOF
         1 000607   000000 474400 xsym               LDP4    B$JIT$
         1 000610   400012 756100                    STQ     10,,PR4

      352     2981    3                    GOTO SCHEDDO;

   2981  1 000611   002316 710000 1                  TRA     SCHEDDO

      353     2982    3                    END;
      354     2983        /*E*   ERROR:    FMI-E$EOF-2
      355     2984        *      DESCRIPTION:  An M$READ without a key to a random file was
      356     2985        *        given when the current position was at EOF.
      357     2986        */
      358     2987    2                 ELSE
      359     2988    2                    GOTO BADBLK;
      360     2989    3              ELSE DO;                /* START IS WITHIN FILE, END IS OUTSIDE    */

      361     2990    3                 F$DCB.UBYTES=(UGRANS-F$DCB.CRECNO)*BLKSIZ;

   2990  1 000612   000071 136100                    SBLQ    57,,PR0
PL6.E3A0      #001=FMI$RAN File=FMI$RAN.:E05TSI                                  TUE 07/29/97 16:49 Page:53   
         1 000613   200012 402100                    MPY     BLKSIZ,,AUTO
         1 000614   000076 756100                    STQ     62,,PR0

      362     2991    3                 IF FPTCODE=FPTWRITE

   2991  1 000615   300000 235100                    LDA     0,,PR3
         1 000616   000001 115007                    CMPA    1,DL
         1 000617   000623 601000 1                  TNZ     s:3005

      363     2992    3                 THEN                      /* SET LOST DATA IF WRITE             */
      364     2993    3                    B$JIT$->B$JIT.ERR=ERRLD;

   2993  1 000620   000003 236000 0                  LDQ     ERRLD
         1 000621   000000 474400 xsym               LDP4    B$JIT$
         1 000622   400012 756100                    STQ     10,,PR4

      365     2994    3                 END;

      366     2995    2              END;

      367     2996        /*E*   ERROR:    FMI-E$LD-2
      368     2997        *       MESSAGE1: One of the following conditions occurred:
      369     2998        *        1 - A read or write began at a legal block number but crossed
      370     2999        *            beyond the end of the file.
      371     3000        *        2 - A read without a key specified a byte count not a multiple
      372     3001        *            of the block size.
      373     3002        *        3 - A read without a key specified zero bytes.
      374     3003        */
      375     3004        /**/
      376     3005    2           IF F$DCB.UBYTES=0 THEN DO;      /* NO BYTES TO MOVE                   */

   3005  1 000623   000076 235100                    LDA     62,,PR0
         1 000624   000637 601000 1                  TNZ     s:3013

      377     3006    2              IF FPTCODE=FPTREAD THEN

   3006  1 000625   300000 235100                    LDA     0,,PR3
PL6.E3A0      #001=FMI$RAN File=FMI$RAN.:E05TSI                                  TUE 07/29/97 16:49 Page:54   
         1 000626   000633 601000 1                  TNZ     s:3009

      378     3007    2                 B$JIT.ERR=ERRLD;          /* Lost data if read zero bytes       */

   3007  1 000627   000003 236000 0                  LDQ     ERRLD
         1 000630   000000 474400 xsym               LDP4    B$JIT$
         1 000631   400012 756100                    STQ     10,,PR4
         1 000632   000636 710000 1                  TRA     s:3010

      379     3008    2              ELSE
      380     3009    2                 B$JIT.ERR=ERRRANBOUND;

   3009  1 000633   000004 236000 0                  LDQ     ERRRANBOUND
         1 000634   000000 474400 xsym               LDP4    B$JIT$
         1 000635   400012 756100                    STQ     10,,PR4

      381     3010    2              GOTO SCHEDDO;

   3010  1 000636   002316 710000 1                  TRA     SCHEDDO

      382     3011    2              END;
      383     3012        /**/
      384     3013    2           IF BLKSIZ=1024*4 THEN DO;       /* FULL XFER                          */

   3013  1 000637   200012 236100                    LDQ     BLKSIZ,,AUTO
         1 000640   010000 116007                    CMPQ    4096,DL
         1 000641   000673 601000 1                  TNZ     s:3030

      385     3014    2              CALL HFF$RET_PS_DESC(B$PS2$,DESC) ALTRET(MEMERR);

   3014  1 000642   200026 634500                    EPPR4   DESC,,AUTO
         1 000643   200037 454500                    STP4    TEMP_CHAR+4,,AUTO
         1 000644   000011 236000 2                  LDQ     9
         1 000645   200036 756100                    STQ     TEMP_CHAR+3,,AUTO
         1 000646   200036 630500                    EPPR0   TEMP_CHAR+3,,AUTO
         1 000647   000020 631400 xsym               EPPR1   B_VECTNIL+16
         1 000650   000000 701000 xent               TSX1    HFF$RET_PS_DESC
PL6.E3A0      #001=FMI$RAN File=FMI$RAN.:E05TSI                                  TUE 07/29/97 16:49 Page:55   
         1 000651   002537 702000 1                  TSX2    MEMERR

      386     3015    2              IF MOD(DESC.BASE,4)~=0 OR

   3015  1 000652   200027 236100                    LDQ     DESC+1,,AUTO
         1 000653   000004 506007                    DIV     4,DL
         1 000654   000044 733000                    LRS     36
         1 000655   000000 116003                    CMPQ    0,DU
         1 000656   000663 601000 1                  TNZ     s:3017
         1 000657   200004 470500                    LDP0    JDCB$,,AUTO
         1 000660   000076 236100                    LDQ     62,,PR0
         1 000661   000003 376007                    ANQ     3,DL
         1 000662   000667 600000 1                  TZE     s:3020

      387     3016    3                MOD(F$DCB.UBYTES,4)~=0 THEN DO;

      388     3017    3                 B$JIT.ERR=ERRRANBOUND;

   3017  1 000663   000004 236000 0                  LDQ     ERRRANBOUND
         1 000664   000000 470400 xsym               LDP0    B$JIT$
         1 000665   000012 756100                    STQ     10,,PR0

      389     3018    3                 GOTO SCHEDDO;

   3018  1 000666   002316 710000 1                  TRA     SCHEDDO

      390     3019    3                 END;
      391     3020    2              CALL HFF$WRITE1(2) ALTRET(MEMERR); /* CHECK ACCESS                 */

   3020  1 000667   000002 630400 2                  EPPR0   2
         1 000670   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 000671   000000 701000 xent               TSX1    HFF$WRITE1
         1 000672   002537 702000 1                  TSX2    MEMERR

      392     3021    2              END;

      393     3022        /*E*   ERROR:    FMI-E$RANBOUND-2
PL6.E3A0      #001=FMI$RAN File=FMI$RAN.:E05TSI                                  TUE 07/29/97 16:49 Page:56   
      394     3023        *       MESSAGE:  Buffer% for file %FN% must be word aligned
      395     3024        *       MESSAGE1: Buffer must be on word boundary and byte count
      396     3025         must be non-zero word multiple
      397     3026        *      DESCRIPTION:  RANDOM and IDS reads and writes with FULL=YES
      398     3027        *        and all block access reads and writes must have a word-
      399     3028        *        aligned buffer and must be for an integral number of words. */
      400     3029        /**/
      401     3030    1           IF F$DCB.ASN=%DEVICE# THEN GOTO DEVPACK;

   3030  1 000673   200004 470500                    LDP0    JDCB$,,AUTO
         1 000674   000032 236100                    LDQ     26,,PR0
         1 000675   777000 376007                    ANQ     -512,DL
         1 000676   003000 116007                    CMPQ    1536,DL
         1 000677   002342 600000 1                  TZE     DEVPACK

      402     3031    1           STAMP.HASH=F$DCB.HASH;

   3031  1 000700   000073 236100                    LDQ     59,,PR0
         1 000701   200031 552170                    STBQ    STAMP,'70'O,AUTO

      403     3032    1           IF F$DCB.ACS = %UBLOCK# THEN

   3032  1 000702   000036 236100                    LDQ     30,,PR0
         1 000703   000777 376007                    ANQ     511,DL
         1 000704   000014 116007                    CMPQ    12,DL
         1 000705   002543 600000 1                  TZE     READ_UBLOCK

      404     3033    1              GOTO READ_UBLOCK;
      405     3034    1           IF BLKSIZ=1024*4 AND NOT FPT$READ_V.SEED AND NOT F$DCB.SEED AND

   3034  1 000706   200012 235100                    LDA     BLKSIZ,,AUTO
         1 000707   010000 115007                    CMPA    4096,DL
         1 000710   000740 601000 1                  TNZ     s:3038
         1 000711   000000 471400 xsym               LDP1    B$PS0$
         1 000712   100002 235100                    LDA     2,,PR1
         1 000713   000740 601000 1                  TNZ     s:3038
         1 000714   000062 235100                    LDA     50,,PR0
PL6.E3A0      #001=FMI$RAN File=FMI$RAN.:E05TSI                                  TUE 07/29/97 16:49 Page:57   
         1 000715   000740 601000 1                  TNZ     s:3038
         1 000716   200005 473500                    LDP3    CFU$,,AUTO
         1 000717   300000 236100                    LDQ     0,,PR3
         1 000720   001000 376003                    ANQ     512,DU
         1 000721   001000 116003                    CMPQ    512,DU
         1 000722   000731 600000 1                  TZE     s:3034+19
         1 000723   000071 235100                    LDA     57,,PR0
         1 000724   000731 601000 1                  TNZ     s:3034+19
         1 000725   000036 236100                    LDQ     30,,PR0
         1 000726   000777 376007                    ANQ     511,DL
         1 000727   000003 116007                    CMPQ    3,DL
         1 000730   000740 601000 1                  TNZ     s:3038
         1 000731   200003 474500                    LDP4    @FPTCODE,,AUTO
         1 000732   400000 235100                    LDA     0,,PR4
         1 000733   000001 115007                    CMPA    1,DL
         1 000734   001661 601000 1                  TNZ     DIRIO
         1 000735   000076 236100                    LDQ     62,,PR0
         1 000736   007777 376007                    ANQ     4095,DL
         1 000737   001661 600000 1                  TZE     DIRIO

      406     3035    1             (FM$CFU.AFIT=1 OR F$DCB.CRECNO~=0 OR F$DCB.ACS=%BLOCK#) AND
      407     3036    1             (FPTCODE~=FPTWRITE OR MOD(F$DCB.UBYTES,4096)=0)
      408     3037    1           THEN GOTO DIRIO;                /* Can do direct I/O                  */
      409     3038    1           N=(F$DCB.UBYTES+4095)/4096;     /* TOTAL # GRANS TO READ              */

   3038  1 000740   000076 236100                    LDQ     62,,PR0
         1 000741   007777 036007                    ADLQ    4095,DL
         1 000742   000014 772000                    QRL     12
         1 000743   200013 756100                    STQ     N,,AUTO

      410     3039    1           IF N>4 THEN N=4;                /* BUFFER SIZE                        */

   3039  1 000744   000004 116007                    CMPQ    4,DL
         1 000745   000750 604400 1                  TMOZ    s:3040

   3039  1 000746   000004 235007                    LDA     4,DL
         1 000747   200013 755100                    STA     N,,AUTO
PL6.E3A0      #001=FMI$RAN File=FMI$RAN.:E05TSI                                  TUE 07/29/97 16:49 Page:58   

      411     3040    1           IF F$DCB.BFR.BUFX(0)~=0 AND F$DCB.BFR1.SIZ(0)<N THEN

   3040  1 000750   000115 236100                    LDQ     77,,PR0
         1 000751   037000 316003                    CANQ    15872,DU
         1 000752   000764 600000 1                  TZE     s:3042
         1 000753   000122 236100                    LDQ     82,,PR0
         1 000754   000022 772000                    QRL     18
         1 000755   000777 376007                    ANQ     511,DL
         1 000756   200013 116100                    CMPQ    N,,AUTO
         1 000757   000764 605000 1                  TPL     s:3042

      412     3041    1              CALL FMD$RELBUF(0);

   3041  1 000760   000004 630400 2                  EPPR0   4
         1 000761   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 000762   000000 701000 xent               TSX1    FMD$RELBUF
         1 000763   000000 011000                    NOP     0

      413     3042    1           CALL FMD$GETBUF(0,N,G$);

   3042  1 000764   200006 630500                    EPPR0   G$,,AUTO
         1 000765   200040 450500                    STP0    TEMP_CHAR+5,,AUTO
         1 000766   200013 631500                    EPPR1   N,,AUTO
         1 000767   200037 451500                    STP1    TEMP_CHAR+4,,AUTO
         1 000770   000004 236000 2                  LDQ     4
         1 000771   200036 756100                    STQ     TEMP_CHAR+3,,AUTO
         1 000772   200036 630500                    EPPR0   TEMP_CHAR+3,,AUTO
         1 000773   000021 631400 xsym               EPPR1   B_VECTNIL+17
         1 000774   000000 701000 xent               TSX1    FMD$GETBUF
         1 000775   000000 011000                    NOP     0

      414     3043    1           IF F$DCB.ORG = %RANDOM# OR F$DCB.ORG = %IDS# THEN

   3043  1 000776   200004 470500                    LDP0    JDCB$,,AUTO
         1 000777   000032 236100                    LDQ     26,,PR0
         1 001000   777000 376003                    ANQ     -512,DU
PL6.E3A0      #001=FMI$RAN File=FMI$RAN.:E05TSI                                  TUE 07/29/97 16:49 Page:59   
         1 001001   003000 116003                    CMPQ    1536,DU
         1 001002   001005 600000 1                  TZE     s:3044
         1 001003   007000 116003                    CMPQ    3584,DU
         1 001004   001007 601000 1                  TNZ     s:3045

      415     3044    1              F$DCB.BFR1.FLAGS.ONE_WORD_HEADER (0) = '1'B;

   3044  1 001005   400000 236003                    LDQ     -131072,DU
         1 001006   000122 256100                    ORSQ    82,,PR0

      416     3045    2           DO WHILE(JDCB$->F$DCB.UBYTES>0);

   3045  1 001007   000076 235100                    LDA     62,,PR0
         1 001010   001660 600000 1                  TZE     s:3177

      417     3046    2              DA=JDCB$->F$DCB.CRECNO+FM_FRZERO; /* DA FOR THIS BLOCK             */

   3046  1 001011   200004 470500                    LDP0    JDCB$,,AUTO
         1 001012   000071 236100                    LDQ     57,,PR0
         1 001013   000000 036000 xsym               ADLQ    FM_FRZERO
         1 001014   200011 756100                    STQ     DA,,AUTO

      418     3047    2              STAMP.GMOD=DA;

   3047  1 001015   200031 552104                    STBQ    STAMP,'04'O,AUTO

      419     3048    2              BUFSIZ=(F$DCB.UBYTES+4095)/4096; /* # pages to xfer                */

   3048  1 001016   000076 236100                    LDQ     62,,PR0
         1 001017   007777 036007                    ADLQ    4095,DL
         1 001020   000014 772000                    QRL     12
         1 001021   200016 756100                    STQ     BUFSIZ,,AUTO

      420     3049    2              IF BUFSIZ>4 THEN

   3049  1 001022   000005 116007                    CMPQ    5,DL
         1 001023   001026 602000 1                  TNC     s:3051
PL6.E3A0      #001=FMI$RAN File=FMI$RAN.:E05TSI                                  TUE 07/29/97 16:49 Page:60   

      421     3050    2                 BUFSIZ=4;                 /* Limit to 4 pages at a time         */

   3050  1 001024   000004 235007                    LDA     4,DL
         1 001025   200016 755100                    STA     BUFSIZ,,AUTO

      422     3051    2              BUFDISP=0;

   3051  1 001026   200015 450100                    STZ     BUFDISP,,AUTO

      423     3052    2              Q$=ADDR(NIL);

   3052  1 001027   000001 236000 xsym               LDQ     B_VECTNIL+1
         1 001030   200032 756100                    STQ     Q$,,AUTO

      424     3053    3              IF FPTCODE=FPTWRITE THEN DO; /* Write                              */

   3053  1 001031   200003 471500                    LDP1    @FPTCODE,,AUTO
         1 001032   100000 235100                    LDA     0,,PR1
         1 001033   000001 115007                    CMPA    1,DL
         1 001034   001343 601000 1                  TNZ     s:3113

      425     3054    3                 CFU$->FM$CFU.FMOD='1'B;   /* SET FILE MODIFIED                  */

   3054  1 001035   200005 473500                    LDP3    CFU$,,AUTO
         1 001036   004000 236003                    LDQ     2048,DU
         1 001037   300000 256100                    ORSQ    0,,PR3

      426     3055    3                 JDCB$->F$DCB.BFR.DA(0)=DA;

   3055  1 001040   200011 236100                    LDQ     DA,,AUTO
         1 001041   000115 552134                    STBQ    77,'34'O,PR0

      427     3056    4                 DO WHILE(BUFDISP<BUFSIZ);

   3056  1 001042   200015 236100                    LDQ     BUFDISP,,AUTO
         1 001043   200016 116100                    CMPQ    BUFSIZ,,AUTO
PL6.E3A0      #001=FMI$RAN File=FMI$RAN.:E05TSI                                  TUE 07/29/97 16:49 Page:61   
         1 001044   001260 603000 1                  TRC     s:3103

      428     3057    4                    JDCB$->F$DCB.GDISP=0;

   3057  1 001045   200004 470500                    LDP0    JDCB$,,AUTO
         1 001046   000101 450100                    STZ     65,,PR0

      429     3058    4                    GBYTES=BLKSIZ;         /* AVAILABLE SPACE IN BYTES           */

   3058  1 001047   200012 235100                    LDA     BLKSIZ,,AUTO
         1 001050   200010 755100                    STA     GBYTES,,AUTO

      430     3059    5                    IF BLKSIZ=1024*4 THEN DO; /* User has stamp                  */

   3059  1 001051   010000 115007                    CMPA    4096,DL
         1 001052   001103 601000 1                  TNZ     s:3074

      431     3060    5                       P$=G$;

   3060  1 001053   200006 236100                    LDQ     G$,,AUTO
         1 001054   200007 756100                    STQ     P$,,AUTO

      432     3061    5                       IF FPT$WRITE_V.SEED

   3061  1 001055   000000 471400 xsym               LDP1    B$PS0$
         1 001056   100002 235100                    LDA     2,,PR1
         1 001057   001062 601000 1                  TNZ     s:3063
         1 001060   000062 235100                    LDA     50,,PR0
         1 001061   001106 600000 1                  TZE     s:3075

      433     3062    6                         OR F$DCB.SEED THEN DO; /* Don't encrypt stamp           */

      434     3063    6                          GBYTES=GBYTES-4;

   3063  1 001062   200010 235100                    LDA     GBYTES,,AUTO
         1 001063   000004 135007                    SBLA    4,DL
         1 001064   200010 755100                    STA     GBYTES,,AUTO
PL6.E3A0      #001=FMI$RAN File=FMI$RAN.:E05TSI                                  TUE 07/29/97 16:49 Page:62   

      435     3064    6                          IF F$DCB.UBYTES<4 THEN

   3064  1 001065   000076 235100                    LDA     62,,PR0
         1 001066   000004 115007                    CMPA    4,DL
         1 001067   001072 603000 1                  TRC     s:3067

      436     3065    6                             F$DCB.UBYTES=0;

   3065  1 001070   000076 450100                    STZ     62,,PR0
         1 001071   001106 710000 1                  TRA     s:3075

      437     3066    7                          ELSE DO;         /* SKIP OVER STAMP IN USER BUFFER     */

      438     3067    7                             F$DCB.UBYTES=F$DCB.UBYTES-4;

   3067  1 001072   000004 135007                    SBLA    4,DL
         1 001073   000076 755100                    STA     62,,PR0

      439     3068    7                             F$DCB.UB$=PINCRC(F$DCB.UB$,4);

   3068  1 001074   000075 236100                    LDQ     61,,PR0
         1 001075   000001 036003                    ADLQ    1,DU
         1 001076   000075 756100                    STQ     61,,PR0

      440     3069    7                             P$=PINCRW(P$,1);

   3069  1 001077   200007 236100                    LDQ     P$,,AUTO
         1 001100   000001 036003                    ADLQ    1,DU
         1 001101   200007 756100                    STQ     P$,,AUTO

      441     3070    7                             END;

      442     3071    6                          END;

      443     3072    5                       END;

PL6.E3A0      #001=FMI$RAN File=FMI$RAN.:E05TSI                                  TUE 07/29/97 16:49 Page:63   
   3072  1 001102   001106 710000 1                  TRA     s:3075

      444     3073    4                    ELSE
      445     3074    4                       P$=PINCRW(G$,1);

   3074  1 001103   200006 236100                    LDQ     G$,,AUTO
         1 001104   000001 036003                    ADLQ    1,DU
         1 001105   200007 756100                    STQ     P$,,AUTO

      446     3075    4                    IF (FPT$WRITE_V.SEED OR F$DCB.SEED) AND F$DCB.ORG=%IDS# AND

   3075  1 001106   000000 471400 xsym               LDP1    B$PS0$
         1 001107   100002 235100                    LDA     2,,PR1
         1 001110   001113 601000 1                  TNZ     s:3075+5
         1 001111   000062 235100                    LDA     50,,PR0
         1 001112   001155 600000 1                  TZE     s:3087
         1 001113   000032 236100                    LDQ     26,,PR0
         1 001114   777000 376003                    ANQ     -512,DU
         1 001115   007000 116003                    CMPQ    3584,DU
         1 001116   001155 601000 1                  TNZ     s:3087
         1 001117   000036 236100                    LDQ     30,,PR0
         1 001120   000777 376007                    ANQ     511,DL
         1 001121   000003 116007                    CMPQ    3,DL
         1 001122   001155 600000 1                  TZE     s:3087

      447     3076    5                      F$DCB.ACS~=%BLOCK# THEN DO; /* DON'T ENCRYPT TIME          */

      448     3077    5                       GBYTES=GBYTES-4;    /* DECR SIZE LEFT IN BUFFER           */

   3077  1 001123   200010 235100                    LDA     GBYTES,,AUTO
         1 001124   000004 135007                    SBLA    4,DL
         1 001125   200010 755100                    STA     GBYTES,,AUTO

      449     3078    5                       IF F$DCB.UBYTES<4 THEN

   3078  1 001126   000076 235100                    LDA     62,,PR0
         1 001127   000004 115007                    CMPA    4,DL
PL6.E3A0      #001=FMI$RAN File=FMI$RAN.:E05TSI                                  TUE 07/29/97 16:49 Page:64   
         1 001130   001133 603000 1                  TRC     s:3081

      450     3079    5                          N=F$DCB.UBYTES;

   3079  1 001131   200013 755100                    STA     N,,AUTO
         1 001132   001135 710000 1                  TRA     s:3082

      451     3080    5                       ELSE
      452     3081    5                          N=4;             /* SIZE OF TIME WORD                  */

   3081  1 001133   000004 235007                    LDA     4,DL
         1 001134   200013 755100                    STA     N,,AUTO

      453     3082    5                       P$->CHARS=F$DCB.UB$->CHARS; /* MOVE TIME FROM USER        */

   3082  1 001135   000075 473500                    LDP3    61,,PR0
         1 001136   000000 620005                    EAX0    0,AL
         1 001137   200007 474500                    LDP4    P$,,AUTO
         1 001140   200013 721100                    LXL1    N,,AUTO
         1 001141   040140 100540                    MLR     fill='040'O
         1 001142   300000 000010                    ADSC9   0,,PR3                   cn=0,n=*X0
         1 001143   400000 000011                    ADSC9   0,,PR4                   cn=0,n=*X1

      454     3083    5                       P$=PINCRW(P$,1);

   3083  1 001144   200007 236100                    LDQ     P$,,AUTO
         1 001145   000001 036003                    ADLQ    1,DU
         1 001146   200007 756100                    STQ     P$,,AUTO

      455     3084    5                       F$DCB.UBYTES=F$DCB.UBYTES-N;

   3084  1 001147   000076 236100                    LDQ     62,,PR0
         1 001150   200013 136100                    SBLQ    N,,AUTO
         1 001151   000076 756100                    STQ     62,,PR0

      456     3085    5                       F$DCB.UB$=PINCRC(F$DCB.UB$,4);

PL6.E3A0      #001=FMI$RAN File=FMI$RAN.:E05TSI                                  TUE 07/29/97 16:49 Page:65   
   3085  1 001152   000075 236100                    LDQ     61,,PR0
         1 001153   000001 036003                    ADLQ    1,DU
         1 001154   000075 756100                    STQ     61,,PR0

      457     3086    5                       END;

      458     3087    4                    VPNO = GBYTES;         /* Space left for user stuff*/

   3087  1 001155   200010 235100                    LDA     GBYTES,,AUTO
         1 001156   200022 755100                    STA     VPNO,,AUTO

      459     3088    4                    CALL FMD$RECTRAN(P$,GBYTES,0,1,1,FPT$WRITE_V.SEED);

   3088  1 001157   000000 236000 xsym               LDQ     B$PS0$
         1 001160   000002 036003                    ADLQ    2,DU
         1 001161   000001 235000 2                  LDA     1
         1 001162   200042 757100                    STAQ    TEMP_CHAR+7,,AUTO
         1 001163   000012 237000 2                  LDAQ    10
         1 001164   200040 757100                    STAQ    TEMP_CHAR+5,,AUTO
         1 001165   200010 633500                    EPPR3   GBYTES,,AUTO
         1 001166   200037 453500                    STP3    TEMP_CHAR+4,,AUTO
         1 001167   200007 634500                    EPPR4   P$,,AUTO
         1 001170   200036 454500                    STP4    TEMP_CHAR+3,,AUTO
         1 001171   200036 630500                    EPPR0   TEMP_CHAR+3,,AUTO
         1 001172   000024 631400 xsym               EPPR1   B_VECTNIL+20
         1 001173   000000 701000 xent               TSX1    FMD$RECTRAN
         1 001174   000000 011000                    NOP     0

      460     3089    5                    IF GBYTES<VPNO THEN DO; /* Clobber rest                      */

   3089  1 001175   200010 236100                    LDQ     GBYTES,,AUTO
         1 001176   001214 604000 1                  TMI     s:3094
         1 001177   200022 116100                    CMPQ    VPNO,,AUTO
         1 001200   001214 605000 1                  TPL     s:3094

      461     3090    5                       P$=PINCRC(P$,GBYTES); /* POINT TO NEXT BYTE               */

PL6.E3A0      #001=FMI$RAN File=FMI$RAN.:E05TSI                                  TUE 07/29/97 16:49 Page:66   
   3090  1 001201   000020 736000                    QLS     16
         1 001202   200007 036100                    ADLQ    P$,,AUTO
         1 001203   200007 756100                    STQ     P$,,AUTO

      462     3091    5                       GBYTES=VPNO-GBYTES; /* Bytes remaining                    */

   3091  1 001204   200022 236100                    LDQ     VPNO,,AUTO
         1 001205   200010 136100                    SBLQ    GBYTES,,AUTO
         1 001206   200010 756100                    STQ     GBYTES,,AUTO

      463     3092    5                       P$->CLEAR=' ';      /* BLANK IT                           */

   3092  1 001207   200007 470500                    LDP0    P$,,AUTO
         1 001210   000000 620006                    EAX0    0,QL
         1 001211   040140 100400                    MLR     fill='040'O
         1 001212   000035 000001 xsym               ADSC9   B_VECTNIL+29             cn=0,n=1
         1 001213   000000 000010                    ADSC9   0,,PR0                   cn=0,n=*X0

      464     3093    5                       END;

      465     3094    4                    G$->FM$GRAN.STAMP.HASH=JDCB$->F$DCB.HASH;

   3094  1 001214   200004 470500                    LDP0    JDCB$,,AUTO
         1 001215   200006 471500                    LDP1    G$,,AUTO
         1 001216   000073 236100                    LDQ     59,,PR0
         1 001217   100000 552170                    STBQ    0,'70'O,PR1

      466     3095    4                    G$->FM$GRAN.STAMP.GMOD=DA+BUFDISP;

   3095  1 001220   200011 236100                    LDQ     DA,,AUTO
         1 001221   200015 036100                    ADLQ    BUFDISP,,AUTO
         1 001222   200006 471500                    LDP1    G$,,AUTO
         1 001223   100000 552104                    STBQ    0,'04'O,PR1

      467     3096    4                    IF JDCB$->F$DCB.ORG=%IDS# AND JDCB$->F$DCB.ACS~=%BLOCK#

   3096  1 001224   000032 236100                    LDQ     26,,PR0
PL6.E3A0      #001=FMI$RAN File=FMI$RAN.:E05TSI                                  TUE 07/29/97 16:49 Page:67   
         1 001225   777000 376003                    ANQ     -512,DU
         1 001226   007000 116003                    CMPQ    3584,DU
         1 001227   001247 601000 1                  TNZ     s:3100
         1 001230   000036 236100                    LDQ     30,,PR0
         1 001231   000777 376007                    ANQ     511,DL
         1 001232   000003 116007                    CMPQ    3,DL
         1 001233   001247 600000 1                  TZE     s:3100

      468     3097    4                    THEN    /* IDS TYPE IFLE - CHECK IF TIME STAMP IS WANTED     */
      469     3098    4                       IF NOT FPT$WRITE_V.NOTIME THEN /* Put time in             */

   3098  1 001234   000000 471400 xsym               LDP1    B$PS0$
         1 001235   100000 236100                    LDQ     0,,PR1
         1 001236   000040 316007                    CANQ    32,DL
         1 001237   001247 601000 1                  TNZ     s:3100

      470     3099    4                          CALL SSS$SYSTIME(G$->WRDS(1));

   3099  1 001240   200006 236100                    LDQ     G$,,AUTO
         1 001241   000001 036003                    ADLQ    1,DU
         1 001242   200036 756100                    STQ     TEMP_CHAR+3,,AUTO
         1 001243   200036 630500                    EPPR0   TEMP_CHAR+3,,AUTO
         1 001244   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 001245   000000 701000 xent               TSX1    SSS$SYSTIME
         1 001246   000000 011000                    NOP     0

      471     3100    4                    G$=PINCRW(G$,1024);    /* POINT TO NEXT PAGE                 */

   3100  1 001247   200006 236100                    LDQ     G$,,AUTO
         1 001250   002000 036003                    ADLQ    1024,DU
         1 001251   200006 756100                    STQ     G$,,AUTO

      472     3101    4                    BUFDISP=BUFDISP+1;

   3101  1 001252   200015 235100                    LDA     BUFDISP,,AUTO
         1 001253   000001 035007                    ADLA    1,DL
         1 001254   200015 755100                    STA     BUFDISP,,AUTO
PL6.E3A0      #001=FMI$RAN File=FMI$RAN.:E05TSI                                  TUE 07/29/97 16:49 Page:68   

      473     3102    4                    END;

   3102  1 001255   200015 236100                    LDQ     BUFDISP,,AUTO
         1 001256   200016 116100                    CMPQ    BUFSIZ,,AUTO
         1 001257   001045 602000 1                  TNC     s:3057

      474     3103    3                 G$=FM$BUF$(F$DCB.BFR.BUFX(0)); /* Re-establish buffer ptr       */

   3103  1 001260   200004 470500                    LDP0    JDCB$,,AUTO
         1 001261   000115 236100                    LDQ     77,,PR0
         1 001262   000033 772000                    QRL     27
         1 001263   000037 376007                    ANQ     31,DL
         1 001264   000000 236006 xsym               LDQ     FM$BUF$,QL
         1 001265   200006 756100                    STQ     G$,,AUTO

      475     3104    3                 CALL FMB$QUEUE(G$,0,BUFSIZ*4096,DA,%N_WRBIN,1,ENTADDR(NIL),0);

   3104  1 001266   200016 235100                    LDA     BUFSIZ,,AUTO
         1 001267   000014 735000                    ALS     12
         1 001270   200036 755100                    STA     TEMP_CHAR+3,,AUTO
         1 001271   000004 237000 2                  LDAQ    4
         1 001272   200046 757100                    STAQ    TEMP_CHAR+11,,AUTO
         1 001273   000014 237000 2                  LDAQ    12
         1 001274   200044 757100                    STAQ    TEMP_CHAR+9,,AUTO
         1 001275   200011 631500                    EPPR1   DA,,AUTO
         1 001276   200043 451500                    STP1    TEMP_CHAR+8,,AUTO
         1 001277   200036 633500                    EPPR3   TEMP_CHAR+3,,AUTO
         1 001300   200042 453500                    STP3    TEMP_CHAR+7,,AUTO
         1 001301   000004 236000 2                  LDQ     4
         1 001302   200041 756100                    STQ     TEMP_CHAR+6,,AUTO
         1 001303   200006 634500                    EPPR4   G$,,AUTO
         1 001304   200040 454500                    STP4    TEMP_CHAR+5,,AUTO
         1 001305   200040 630500                    EPPR0   TEMP_CHAR+5,,AUTO
         1 001306   000026 631400 xsym               EPPR1   B_VECTNIL+22
         1 001307   000000 701000 xent               TSX1    FMB$QUEUE
         1 001310   000000 011000                    NOP     0
PL6.E3A0      #001=FMI$RAN File=FMI$RAN.:E05TSI                                  TUE 07/29/97 16:49 Page:69   

      476     3105    4                 IF F$DCB.ACS = %BLOCK# AND F$DCB.FUN ~= %CREATE# THEN DO;

   3105  1 001311   200004 470500                    LDP0    JDCB$,,AUTO
         1 001312   000036 236100                    LDQ     30,,PR0
         1 001313   000777 376007                    ANQ     511,DL
         1 001314   000003 116007                    CMPQ    3,DL
         1 001315   001627 601000 1                  TNZ     s:3168
         1 001316   000032 236100                    LDQ     26,,PR0
         1 001317   000777 376003                    ANQ     511,DU
         1 001320   000003 116003                    CMPQ    3,DU
         1 001321   001627 600000 1                  TZE     s:3168

      477     3106    5                    DO I=0 TO BUFSIZ-1;

   3106  1 001322   200014 450100                    STZ     I,,AUTO
         1 001323   001336 710000 1                  TRA     s:3108+1

      478     3107    5                       CALL FMC$CLR1(DA+I);

   3107  1 001324   200011 236100                    LDQ     DA,,AUTO
         1 001325   200014 036100                    ADLQ    I,,AUTO
         1 001326   200036 756100                    STQ     TEMP_CHAR+3,,AUTO
         1 001327   200036 630500                    EPPR0   TEMP_CHAR+3,,AUTO
         1 001330   200037 450500                    STP0    TEMP_CHAR+4,,AUTO
         1 001331   200037 630500                    EPPR0   TEMP_CHAR+4,,AUTO
         1 001332   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 001333   000000 701000 xent               TSX1    FMC$CLR1
         1 001334   000000 011000                    NOP     0

      479     3108    5                       END;

   3108  1 001335   200014 054100                    AOS     I,,AUTO
         1 001336   200014 236100                    LDQ     I,,AUTO
         1 001337   001324 604000 1                  TMI     s:3107
         1 001340   200016 116100                    CMPQ    BUFSIZ,,AUTO
         1 001341   001324 602000 1                  TNC     s:3107
PL6.E3A0      #001=FMI$RAN File=FMI$RAN.:E05TSI                                  TUE 07/29/97 16:49 Page:70   

      480     3109    4                    END;

      481     3110    3                 END;

   3110  1 001342   001627 710000 1                  TRA     s:3168

      482     3111    2              ELSE                         /* READ                               */
      483     3112    3              DO;

      484     3113    3                 CALL FMB$QUEUE(G$,0,BUFSIZ*4096,DA,%N_RDBIN,1,ENTADDR(NIL),0,Q$);

   3113  1 001343   200016 235100                    LDA     BUFSIZ,,AUTO
         1 001344   000014 735000                    ALS     12
         1 001345   200036 755100                    STA     TEMP_CHAR+3,,AUTO
         1 001346   200032 633500                    EPPR3   Q$,,AUTO
         1 001347   200047 453500                    STP3    TEMP_CHAR+12,,AUTO
         1 001350   000004 236000 2                  LDQ     4
         1 001351   200046 756100                    STQ     TEMP_CHAR+11,,AUTO
         1 001352   000020 237000 2                  LDAQ    16
         1 001353   200044 757100                    STAQ    TEMP_CHAR+9,,AUTO
         1 001354   000002 236000 2                  LDQ     2
         1 001355   200043 756100                    STQ     TEMP_CHAR+8,,AUTO
         1 001356   200011 634500                    EPPR4   DA,,AUTO
         1 001357   200042 454500                    STP4    TEMP_CHAR+7,,AUTO
         1 001360   200036 635500                    EPPR5   TEMP_CHAR+3,,AUTO
         1 001361   200041 455500                    STP5    TEMP_CHAR+6,,AUTO
         1 001362   000004 236000 2                  LDQ     4
         1 001363   200040 756100                    STQ     TEMP_CHAR+5,,AUTO
         1 001364   200006 636500                    EPPR6   G$,,AUTO
         1 001365   200037 456500                    STP6    TEMP_CHAR+4,,AUTO
         1 001366   200037 630500                    EPPR0   TEMP_CHAR+4,,AUTO
         1 001367   000016 631400 2                  EPPR1   14
         1 001370   000000 701000 xent               TSX1    FMB$QUEUE
         1 001371   000000 011000                    NOP     0

      485     3114    4                 DO WHILE(BUFDISP<BUFSIZ);
PL6.E3A0      #001=FMI$RAN File=FMI$RAN.:E05TSI                                  TUE 07/29/97 16:49 Page:71   

   3114  1 001372   200015 236100                    LDQ     BUFDISP,,AUTO
         1 001373   200016 116100                    CMPQ    BUFSIZ,,AUTO
         1 001374   001627 603000 1                  TRC     s:3168

      486     3115    4                    JDCB$->F$DCB.GDISP=0;

   3115  1 001375   200004 470500                    LDP0    JDCB$,,AUTO
         1 001376   000101 450100                    STZ     65,,PR0

      487     3116    5                    IF G$->FM$GRAN.STAMP~=STAMP THEN DO; /* BAD BLOCK            */

   3116  1 001377   200006 471500                    LDP1    G$,,AUTO
         1 001400   100000 236100                    LDQ     0,,PR1
         1 001401   200031 116100                    CMPQ    STAMP,,AUTO
         1 001402   001467 600000 1                  TZE     s:3129

      488     3117                            /* Log an error if block acs and this file's org
      489     3118                               doesn't allow unwritten granules in ugrans. */
      490     3119    5                       IF (F$DCB.ACS=%BLOCK# OR F$DCB.ACS=%UBLOCK#) AND

   3119  1 001403   000036 236100                    LDQ     30,,PR0
         1 001404   000777 376007                    ANQ     511,DL
         1 001405   000003 116007                    CMPQ    3,DL
         1 001406   001411 600000 1                  TZE     s:3119+6
         1 001407   000014 116007                    CMPQ    12,DL
         1 001410   001454 601000 1                  TNZ     s:3124
         1 001411   000032 236100                    LDQ     26,,PR0
         1 001412   777000 376003                    ANQ     -512,DU
         1 001413   003000 116003                    CMPQ    1536,DU
         1 001414   001454 600000 1                  TZE     s:3124
         1 001415   007000 116003                    CMPQ    3584,DU
         1 001416   001454 600000 1                  TZE     s:3124
         1 001417   013000 116003                    CMPQ    5632,DU
         1 001420   001454 600000 1                  TZE     s:3124
         1 001421   005000 116003                    CMPQ    2560,DU
         1 001422   001454 600000 1                  TZE     s:3124
PL6.E3A0      #001=FMI$RAN File=FMI$RAN.:E05TSI                                  TUE 07/29/97 16:49 Page:72   

      491     3120    5                         F$DCB.ORG ~= %RANDOM# AND F$DCB.ORG ~= %IDS#
      492     3121    5                         AND F$DCB.ORG ~= %CG# AND F$DCB.ORG ~= %RELATIVE# THEN
      493     3122    5                          CALL FMB$LOGERR(%E$MI,5,8,DA+BUFDISP,G$,0,1,2,

   3122  1 001423   200011 236100                    LDQ     DA,,AUTO
         1 001424   200015 036100                    ADLQ    BUFDISP,,AUTO
         1 001425   200036 756100                    STQ     TEMP_CHAR+3,,AUTO
         1 001426   200032 633500                    EPPR3   Q$,,AUTO
         1 001427   200051 453500                    STP3    TEMP_CHAR+14,,AUTO
         1 001430   000001 236000 xsym               LDQ     B_VECTNIL+1
         1 001431   200050 756100                    STQ     TEMP_CHAR+13,,AUTO
         1 001432   200031 634500                    EPPR4   STAMP,,AUTO
         1 001433   200047 454500                    STP4    TEMP_CHAR+12,,AUTO
         1 001434   000002 236000 2                  LDQ     2
         1 001435   200046 756100                    STQ     TEMP_CHAR+11,,AUTO
         1 001436   000012 237000 2                  LDAQ    10
         1 001437   200044 757100                    STAQ    TEMP_CHAR+9,,AUTO
         1 001440   200006 635500                    EPPR5   G$,,AUTO
         1 001441   200043 455500                    STP5    TEMP_CHAR+8,,AUTO
         1 001442   200036 636500                    EPPR6   TEMP_CHAR+3,,AUTO
         1 001443   200042 456500                    STP6    TEMP_CHAR+7,,AUTO
         1 001444   000024 237000 2                  LDAQ    20
         1 001445   200040 757100                    STAQ    TEMP_CHAR+5,,AUTO
         1 001446   000023 236000 2                  LDQ     19
         1 001447   200037 756100                    STQ     TEMP_CHAR+4,,AUTO
         1 001450   200037 630500                    EPPR0   TEMP_CHAR+4,,AUTO
         1 001451   000017 631400 2                  EPPR1   15
         1 001452   000000 701000 xent               TSX1    FMB$LOGERR
         1 001453   000000 011000                    NOP     0

      494     3123    5                            STAMP,,Q$);
      495     3124    5                       G$->CLR.X=' ';      /* ZAP THE GRAN                       */

   3124  1 001454   200006 470500                    LDP0    G$,,AUTO
         1 001455   040100 100400                    MLR     fill='040'O
         1 001456   000035 000001 xsym               ADSC9   B_VECTNIL+29             cn=0,n=1
PL6.E3A0      #001=FMI$RAN File=FMI$RAN.:E05TSI                                  TUE 07/29/97 16:49 Page:73   
         1 001457   000001 007774                    ADSC9   1,,PR0                   cn=0,n=4092

      496     3125    5                       G$->WRDS(0)=-1;     /* MARK HEADER BAD FOR EFT            */

   3125  1 001460   000001 335007                    LCA     1,DL
         1 001461   200006 470500                    LDP0    G$,,AUTO
         1 001462   000000 755100                    STA     0,,PR0

      497     3126    5                       B$JIT.ERR=ERRDI;

   3126  1 001463   000006 236000 0                  LDQ     ERRDI
         1 001464   000000 470400 xsym               LDP0    B$JIT$
         1 001465   000012 756100                    STQ     10,,PR0

      498     3127    5                       END;

   3127  1 001466   001472 710000 1                  TRA     s:3135

      499     3128    4                    ELSE
      500     3129    4                       G$->WRDS(0)=F$DCB.CRECNO+BUFDISP;

   3129  1 001467   000071 236100                    LDQ     57,,PR0
         1 001470   200015 036100                    ADLQ    BUFDISP,,AUTO
         1 001471   100000 756100                    STQ     0,,PR1

      501     3130        /*E*   ERROR:    FMI-E$DI-2
      502     3131        *       MESSAGE: An attempt was made to read one or more blocks
      503     3132        that were never written% in file %FN%
      504     3133        *      DESCRIPTION:  One or more of the granules read by this M$READ
      505     3134        *        was never written. */
      506     3135    4                    GBYTES=BLKSIZ;         /* # DATA BYTES IN THIS PAGE          */

   3135  1 001472   200012 235100                    LDA     BLKSIZ,,AUTO
         1 001473   200010 755100                    STA     GBYTES,,AUTO

      507     3136    5                    IF BLKSIZ=1024*4 THEN DO;

PL6.E3A0      #001=FMI$RAN File=FMI$RAN.:E05TSI                                  TUE 07/29/97 16:49 Page:74   
   3136  1 001474   010000 115007                    CMPA    4096,DL
         1 001475   001524 601000 1                  TNZ     s:3149

      508     3137    5                       P$=G$;              /* USER WANTS STAMP                   */

   3137  1 001476   200006 236100                    LDQ     G$,,AUTO
         1 001477   200007 756100                    STQ     P$,,AUTO

      509     3138    5                       IF FPT$READ_V.SEED

   3138  1 001500   000000 470400 xsym               LDP0    B$PS0$
         1 001501   000002 235100                    LDA     2,,PR0
         1 001502   001506 601000 1                  TNZ     s:3140
         1 001503   200004 471500                    LDP1    JDCB$,,AUTO
         1 001504   100062 235100                    LDA     50,,PR1
         1 001505   001527 600000 1                  TZE     s:3150

      510     3139    6                         OR F$DCB.SEED THEN DO; /* DON'T DECRYPT STAMP           */

      511     3140    6                          IF F$DCB.UBYTES<4 THEN

   3140  1 001506   200004 471500                    LDP1    JDCB$,,AUTO
         1 001507   100076 235100                    LDA     62,,PR1
         1 001510   000004 115007                    CMPA    4,DL
         1 001511   001514 603000 1                  TRC     s:3143

      512     3141    6                             N=F$DCB.UBYTES;

   3141  1 001512   200013 755100                    STA     N,,AUTO
         1 001513   001516 710000 1                  TRA     s:3144

      513     3142    6                          ELSE
      514     3143    6                             N=4;          /* STAMP IS 4 BYTES LONG              */

   3143  1 001514   000004 235007                    LDA     4,DL
         1 001515   200013 755100                    STA     N,,AUTO

PL6.E3A0      #001=FMI$RAN File=FMI$RAN.:E05TSI                                  TUE 07/29/97 16:49 Page:75   
      515     3144    6                          CALL MOV2USR;    /* MOVE STAMP W/O DECRYPTION          */

   3144  1 001516   003135 701000 1                  TSX1    MOV2USR
         1 001517   000000 011000                    NOP     0

      516     3145    6                          GBYTES=GBYTES-4;

   3145  1 001520   200010 235100                    LDA     GBYTES,,AUTO
         1 001521   000004 135007                    SBLA    4,DL
         1 001522   200010 755100                    STA     GBYTES,,AUTO

      517     3146    6                          END;

      518     3147    5                       END;

   3147  1 001523   001527 710000 1                  TRA     s:3150

      519     3148    4                    ELSE
      520     3149    4                       P$=PINCRW(G$,1);    /* DOESN'T WANT STAMP                 */

   3149  1 001524   200006 236100                    LDQ     G$,,AUTO
         1 001525   000001 036003                    ADLQ    1,DU
         1 001526   200007 756100                    STQ     P$,,AUTO

      521     3150    4                    IF (FPT$READ_V.SEED OR F$DCB.SEED) AND F$DCB.ORG=%IDS#

   3150  1 001527   000000 470400 xsym               LDP0    B$PS0$
         1 001530   000002 235100                    LDA     2,,PR0
         1 001531   001535 601000 1                  TNZ     s:3150+6
         1 001532   200004 471500                    LDP1    JDCB$,,AUTO
         1 001533   100062 235100                    LDA     50,,PR1
         1 001534   001562 600000 1                  TZE     s:3159
         1 001535   200004 471500                    LDP1    JDCB$,,AUTO
         1 001536   100032 236100                    LDQ     26,,PR1
         1 001537   777000 376003                    ANQ     -512,DU
         1 001540   007000 116003                    CMPQ    3584,DU
         1 001541   001562 601000 1                  TNZ     s:3159
PL6.E3A0      #001=FMI$RAN File=FMI$RAN.:E05TSI                                  TUE 07/29/97 16:49 Page:76   
         1 001542   100036 236100                    LDQ     30,,PR1
         1 001543   000777 376007                    ANQ     511,DL
         1 001544   000003 116007                    CMPQ    3,DL
         1 001545   001562 600000 1                  TZE     s:3159

      522     3151    5                      AND F$DCB.ACS~=%BLOCK# THEN DO; /* DON'T DECRYPT TIME      */

      523     3152    5                       GBYTES=GBYTES-4;

   3152  1 001546   200010 235100                    LDA     GBYTES,,AUTO
         1 001547   000004 135007                    SBLA    4,DL
         1 001550   200010 755100                    STA     GBYTES,,AUTO

      524     3153    5                       IF F$DCB.UBYTES<4 THEN

   3153  1 001551   100076 235100                    LDA     62,,PR1
         1 001552   000004 115007                    CMPA    4,DL
         1 001553   001556 603000 1                  TRC     s:3156

      525     3154    5                          N=F$DCB.UBYTES;

   3154  1 001554   200013 755100                    STA     N,,AUTO
         1 001555   001560 710000 1                  TRA     s:3157

      526     3155    5                       ELSE
      527     3156    5                          N=4;

   3156  1 001556   000004 235007                    LDA     4,DL
         1 001557   200013 755100                    STA     N,,AUTO

      528     3157    5                       CALL MOV2USR;       /* MOVE N BYTES                       */

   3157  1 001560   003135 701000 1                  TSX1    MOV2USR
         1 001561   000000 011000                    NOP     0

      529     3158    5                       END;

PL6.E3A0      #001=FMI$RAN File=FMI$RAN.:E05TSI                                  TUE 07/29/97 16:49 Page:77   
      530     3159    4                    CALL FMD$RECTRAN(P$,GBYTES,0,0,1,FPT$READ_V.SEED);

   3159  1 001562   000000 236000 xsym               LDQ     B$PS0$
         1 001563   000002 036003                    ADLQ    2,DU
         1 001564   000001 235000 2                  LDA     1
         1 001565   200042 757100                    STAQ    TEMP_CHAR+7,,AUTO
         1 001566   000004 237000 2                  LDAQ    4
         1 001567   200040 757100                    STAQ    TEMP_CHAR+5,,AUTO
         1 001570   200010 630500                    EPPR0   GBYTES,,AUTO
         1 001571   200037 450500                    STP0    TEMP_CHAR+4,,AUTO
         1 001572   200007 631500                    EPPR1   P$,,AUTO
         1 001573   200036 451500                    STP1    TEMP_CHAR+3,,AUTO
         1 001574   200036 630500                    EPPR0   TEMP_CHAR+3,,AUTO
         1 001575   000024 631400 xsym               EPPR1   B_VECTNIL+20
         1 001576   000000 701000 xent               TSX1    FMD$RECTRAN
         1 001577   000000 011000                    NOP     0

      531     3160    4                    IF GBYTES>0 THEN       /* DIDN'T XFER ALL                    */

   3160  1 001600   200010 235100                    LDA     GBYTES,,AUTO
         1 001601   001613 600000 1                  TZE     s:3163

      532     3161    4                       IF NOT FPT$READ_V.KEYS AND NOT B$JIT.ERR THEN

   3161  1 001602   000000 470400 xsym               LDP0    B$PS0$
         1 001603   000000 236100                    LDQ     0,,PR0
         1 001604   200000 316007                    CANQ    65536,DL
         1 001605   001613 601000 1                  TNZ     s:3163
         1 001606   000000 471400 xsym               LDP1    B$JIT$
         1 001607   100012 235100                    LDA     10,,PR1
         1 001610   001613 601000 1                  TNZ     s:3163

      533     3162    4                          B$JIT.ERR=ERRLD; /* READ NON-MULT OF BLOCK W/O KEY     */

   3162  1 001611   000003 236000 0                  LDQ     ERRLD
         1 001612   100012 756100                    STQ     10,,PR1

PL6.E3A0      #001=FMI$RAN File=FMI$RAN.:E05TSI                                  TUE 07/29/97 16:49 Page:78   
      534     3163    4                    BUFDISP=BUFDISP+1;

   3163  1 001613   200015 235100                    LDA     BUFDISP,,AUTO
         1 001614   000001 035007                    ADLA    1,DL
         1 001615   200015 755100                    STA     BUFDISP,,AUTO

      535     3164    4                    G$=PINCRW(G$,1024);

   3164  1 001616   200006 236100                    LDQ     G$,,AUTO
         1 001617   002000 036003                    ADLQ    1024,DU
         1 001620   200006 756100                    STQ     G$,,AUTO

      536     3165    4                    STAMP.GMOD=STAMP.GMOD+1;

   3165  1 001621   200031 236100                    LDQ     STAMP,,AUTO
         1 001622   000001 036007                    ADLQ    1,DL
         1 001623   200031 552104                    STBQ    STAMP,'04'O,AUTO

      537     3166    4                    END;

   3166  1 001624   200015 236100                    LDQ     BUFDISP,,AUTO
         1 001625   200016 116100                    CMPQ    BUFSIZ,,AUTO
         1 001626   001375 602000 1                  TNC     s:3115

      538     3167    3                 END;

      539     3168    2              F$DCB.CRECNO=F$DCB.CRECNO+BUFSIZ;

   3168  1 001627   200004 470500                    LDP0    JDCB$,,AUTO
         1 001630   000071 236100                    LDQ     57,,PR0
         1 001631   200016 036100                    ADLQ    BUFSIZ,,AUTO
         1 001632   000071 756100                    STQ     57,,PR0

      540     3169    2              F$DCB.BFR.BUFUP(0)='0'B;

   3169  1 001633   000031 236000 xsym               LDQ     B_VECTNIL+25
         1 001634   000115 356100                    ANSQ    77,,PR0
PL6.E3A0      #001=FMI$RAN File=FMI$RAN.:E05TSI                                  TUE 07/29/97 16:49 Page:79   

      541     3170    2              G$=FM$BUF$(F$DCB.BFR.BUFX(0)); /* Re-establish buffer ptr          */

   3170  1 001635   000115 236100                    LDQ     77,,PR0
         1 001636   000033 772000                    QRL     27
         1 001637   000037 376007                    ANQ     31,DL
         1 001640   000000 236006 xsym               LDQ     FM$BUF$,QL
         1 001641   200006 756100                    STQ     G$,,AUTO

      542     3171    3              IF Q$~=ADDR(NIL) THEN DO;

   3171  1 001642   200032 236100                    LDQ     Q$,,AUTO
         1 001643   000001 116000 xsym               CMPQ    B_VECTNIL+1
         1 001644   001655 600000 1                  TZE     s:3175

      543     3172    3                 CALL NIQ$REL(Q$);

   3172  1 001645   200032 631500                    EPPR1   Q$,,AUTO
         1 001646   200036 451500                    STP1    TEMP_CHAR+3,,AUTO
         1 001647   200036 630500                    EPPR0   TEMP_CHAR+3,,AUTO
         1 001650   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 001651   000000 701000 xent               TSX1    NIQ$REL
         1 001652   000000 011000                    NOP     0

      544     3173    3                 Q$=ADDR(NIL);

   3173  1 001653   000001 236000 xsym               LDQ     B_VECTNIL+1
         1 001654   200032 756100                    STQ     Q$,,AUTO

      545     3174    3                 END;

      546     3175    2              END;

   3175  1 001655   200004 470500                    LDP0    JDCB$,,AUTO
         1 001656   000076 235100                    LDA     62,,PR0
         1 001657   001011 601000 1                  TNZ     s:3046

PL6.E3A0      #001=FMI$RAN File=FMI$RAN.:E05TSI                                  TUE 07/29/97 16:49 Page:80   
      547     3176        /**/
      548     3177    1           GOTO SCHEDDO;

   3177  1 001660   002316 710000 1                  TRA     SCHEDDO

      549     3178        /**/
      550     3179        /**/
      551     3180        /* READ AND WRITE DIRECT TO USER BUFFER */
      552     3181        /**/
      553     3182    1   DIRIO:  IF FPTCODE=FPTREAD THEN

   3182  1 001661   000000 115003       DIRIO        CMPA    0,DU
         1 001662   001674 601000 1                  TNZ     s:3185

      554     3183    1              IF MOD(F$DCB.UBYTES,4096)~=0 AND NOT FPT$READ_V.KEYS THEN

   3183  1 001663   000076 236100                    LDQ     62,,PR0
         1 001664   007777 376007                    ANQ     4095,DL
         1 001665   001674 600000 1                  TZE     s:3185
         1 001666   100000 236100                    LDQ     0,,PR1
         1 001667   200000 316007                    CANQ    65536,DL
         1 001670   001674 601000 1                  TNZ     s:3185

      555     3184    1                 B$JIT.ERR=ERRLD;     /* READING OTHER THAN GRAN MULT W/O KEY    */

   3184  1 001671   000003 236000 0                  LDQ     ERRLD
         1 001672   000000 475400 xsym               LDP5    B$JIT$
         1 001673   500012 756100                    STQ     10,,PR5

      556     3185    1           DA=F$DCB.CRECNO+FM_FRZERO;      /* DISK ADDRESS                       */

   3185  1 001674   000071 236100                    LDQ     57,,PR0
         1 001675   000000 036000 xsym               ADLQ    FM_FRZERO
         1 001676   200011 756100                    STQ     DA,,AUTO

      557     3186    1           STAMP.GMOD=DA;

PL6.E3A0      #001=FMI$RAN File=FMI$RAN.:E05TSI                                  TUE 07/29/97 16:49 Page:81   
   3186  1 001677   200031 552104                    STBQ    STAMP,'04'O,AUTO

      558     3187    1           F$DCB.CRECNO=F$DCB.CRECNO+((F$DCB.UBYTES+BLKSIZ-1)/BLKSIZ);

   3187  1 001700   000076 236100                    LDQ     62,,PR0
         1 001701   200012 036100                    ADLQ    BLKSIZ,,AUTO
         1 001702   000001 136007                    SBLQ    1,DL
         1 001703   200012 506100                    DIV     BLKSIZ,,AUTO
         1 001704   000071 036100                    ADLQ    57,,PR0
         1 001705   000071 756100                    STQ     57,,PR0

      559     3188    1           N=(F$DCB.UBYTES+4095)/4096;     /* # GRANULES                         */

   3188  1 001706   000076 236100                    LDQ     62,,PR0
         1 001707   007777 036007                    ADLQ    4095,DL
         1 001710   000014 772000                    QRL     12
         1 001711   200013 756100                    STQ     N,,AUTO

      560     3189    1           UB$=F$DCB.UB$;                  /* POINTER TO START OF BUFFER         */

   3189  1 001712   000075 236100                    LDQ     61,,PR0
         1 001713   200021 756100                    STQ     UB$,,AUTO

      561     3190    2           DO CASE(FPTCODE);

   3190  1 001714   400000 235100                    LDA     0,,PR4
         1 001715   000002 115007                    CMPA    2,DL
         1 001716   001720 602005 1                  TNC     s:3190+4,AL
         1 001717   002316 710000 1                  TRA     SCHEDDO
         1 001720   001722 710000 1                  TRA     s:3194
         1 001721   002210 710000 1                  TRA     s:3248

      562     3191    2            CASE(FPTREAD);

      563     3192                            /* MAKE SURE ALL PAGES IN BUFFER ARE READ ACCESSIBLE -    */
      564     3193                                      /* CAN'T CALL MMC$ONLY_IOM TWICE FOR SAME PAGE  */
      565     3194    3              DO WHILE(N>0);
PL6.E3A0      #001=FMI$RAN File=FMI$RAN.:E05TSI                                  TUE 07/29/97 16:49 Page:82   

   3194  1 001722   200013 235100                    LDA     N,,AUTO
         1 001723   001735 604400 1                  TMOZ    s:3199

      566     3195    3                 WSQ=UB$->WRDS(0);

   3195  1 001724   200021 470500                    LDP0    UB$,,AUTO
         1 001725   000000 235100                    LDA     0,,PR0
         1 001726   200030 755100                    STA     WSQ,,AUTO

      567     3196    3                 UB$=PINCRW(UB$,1024);

   3196  1 001727   200021 236100                    LDQ     UB$,,AUTO
         1 001730   002000 036003                    ADLQ    1024,DU
         1 001731   200021 756100                    STQ     UB$,,AUTO

      568     3197    3                 N=N-1;

   3197  1 001732   000001 336007                    LCQ     1,DL
         1 001733   200013 056100                    ASQ     N,,AUTO

      569     3198    3                 END;

   3198  1 001734   001724 605400 1                  TPNZ    s:3195

      570     3199    2              TEMP_CHAR=PINCRC(F$DCB.UB$,F$DCB.UBYTES-1)->CHAR1;

   3199  1 001735   200004 470500                    LDP0    JDCB$,,AUTO
         1 001736   000076 236100                    LDQ     62,,PR0
         1 001737   000075 471500                    LDP1    61,,PR0
         1 001740   040100 100506                    MLR     fill='040'O
         1 001741   177777 600001                    ADSC9   -1,Q,PR1                 cn=3,n=1
         1 001742   200033 000001                    ADSC9   TEMP_CHAR,,AUTO          cn=0,n=1

      571     3200    2              WSQ=ASCBIN(TEMP_CHAR);

   3200  1 001743   200033 236100                    LDQ     TEMP_CHAR,,AUTO
PL6.E3A0      #001=FMI$RAN File=FMI$RAN.:E05TSI                                  TUE 07/29/97 16:49 Page:83   
         1 001744   000033 772000                    QRL     27
         1 001745   200030 756100                    STQ     WSQ,,AUTO

      572     3201    2              N=DESC.WSR;

   3201  1 001746   200026 236100                    LDQ     DESC,,AUTO
         1 001747   000004 772000                    QRL     4
         1 001750   000007 376007                    ANQ     7,DL
         1 001751   200013 756100                    STQ     N,,AUTO

      573     3202    2              CALL HFC$STWS(WSRS);

   3202  1 001752   200024 633500                    EPPR3   WSRS,,AUTO
         1 001753   200036 453500                    STP3    TEMP_CHAR+3,,AUTO
         1 001754   200036 630500                    EPPR0   TEMP_CHAR+3,,AUTO
         1 001755   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 001756   000000 701000 xent               TSX1    HFC$STWS
         1 001757   000000 011000                    NOP     0

      574     3203    2              WSQ=WSRS.R(N);               /* WSQ of caller                      */

   3203  1 001760   200013 235100                    LDA     N,,AUTO
         1 001761   000100 101505                    MRL     fill='000'O
         1 001762   200024 000001                    ADSC9   WSRS,A,AUTO              cn=0,n=1
         1 001763   200030 000004                    ADSC9   WSQ,,AUTO                cn=0,n=4

      575     3204    2              VPNO=DESC.BASE/4096;         /* VIRT PAGE OF BEGINNING             */

   3204  1 001764   200027 236100                    LDQ     DESC+1,,AUTO
         1 001765   010000 506007                    DIV     4096,DL
         1 001766   200022 756100                    STQ     VPNO,,AUTO

      576     3205    2              N=(DESC.BASE+F$DCB.UBYTES-1+4095)/4096-VPNO;

   3205  1 001767   200004 470500                    LDP0    JDCB$,,AUTO
         1 001770   200027 236100                    LDQ     DESC+1,,AUTO
         1 001771   000076 036100                    ADLQ    62,,PR0
PL6.E3A0      #001=FMI$RAN File=FMI$RAN.:E05TSI                                  TUE 07/29/97 16:49 Page:84   
         1 001772   007776 036007                    ADLQ    4094,DL
         1 001773   010000 506007                    DIV     4096,DL
         1 001774   200022 136100                    SBLQ    VPNO,,AUTO
         1 001775   200013 756100                    STQ     N,,AUTO

      577     3206    2              CALL MMC$ONLY_IOM(WSQ,VPNO,N); /* REMOVE CPU ACCESS                */

   3206  1 001776   200013 631500                    EPPR1   N,,AUTO
         1 001777   200040 451500                    STP1    TEMP_CHAR+5,,AUTO
         1 002000   200022 633500                    EPPR3   VPNO,,AUTO
         1 002001   200037 453500                    STP3    TEMP_CHAR+4,,AUTO
         1 002002   200030 634500                    EPPR4   WSQ,,AUTO
         1 002003   200036 454500                    STP4    TEMP_CHAR+3,,AUTO
         1 002004   200036 630500                    EPPR0   TEMP_CHAR+3,,AUTO
         1 002005   000021 631400 xsym               EPPR1   B_VECTNIL+17
         1 002006   000000 701000 xent               TSX1    MMC$ONLY_IOM
         1 002007   000000 011000                    NOP     0

      578     3207    2              F$DCB.ARS=F$DCB.UBYTES;

   3207  1 002010   200004 470500                    LDP0    JDCB$,,AUTO
         1 002011   000076 235100                    LDA     62,,PR0
         1 002012   000000 755100                    STA     0,,PR0

      579     3208    2              CALL NIQ$GET(P$);            /* Get Q packet to use as buffer      */

   3208  1 002013   200007 631500                    EPPR1   P$,,AUTO
         1 002014   200036 451500                    STP1    TEMP_CHAR+3,,AUTO
         1 002015   200036 630500                    EPPR0   TEMP_CHAR+3,,AUTO
         1 002016   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 002017   000000 701000 xent               TSX1    NIQ$GET
         1 002020   000000 011000                    NOP     0

      580     3209    3              IF P$->N$REQ.IOFLG.IOS THEN DO;

   3209  1 002021   200007 470500                    LDP0    P$,,AUTO
         1 002022   000004 236100                    LDQ     4,,PR0
PL6.E3A0      #001=FMI$RAN File=FMI$RAN.:E05TSI                                  TUE 07/29/97 16:49 Page:85   
         1 002023   040000 316007                    CANQ    16384,DL
         1 002024   002037 600000 1                  TZE     s:3213

      581     3210    3                 CALL NIQ$RELS(P$->N$REQ.IOS$);

   3210  1 002025   200007 236100                    LDQ     P$,,AUTO
         1 002026   000012 036003                    ADLQ    10,DU
         1 002027   200036 756100                    STQ     TEMP_CHAR+3,,AUTO
         1 002030   200036 630500                    EPPR0   TEMP_CHAR+3,,AUTO
         1 002031   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 002032   000000 701000 xent               TSX1    NIQ$RELS
         1 002033   000000 011000                    NOP     0

      582     3211    3                 P$->N$REQ.IOFLG.IOS='0'B;

   3211  1 002034   200007 470500                    LDP0    P$,,AUTO
         1 002035   000026 236000 2                  LDQ     22
         1 002036   000004 356100                    ANSQ    4,,PR0

      583     3212    3                 END;

      584     3213    2              FM$RANEA.CNT=1;              /* # I/Os outstanding                 */

   3213  1 002037   000001 235007                    LDA     1,DL
         1 002040   200007 470500                    LDP0    P$,,AUTO
         1 002041   000001 755100                    STA     1,,PR0

      585     3214    2              FM$RANEA.STAMP=STAMP;

   3214  1 002042   200031 236100                    LDQ     STAMP,,AUTO
         1 002043   200007 470500                    LDP0    P$,,AUTO
         1 002044   000002 756100                    STQ     2,,PR0

      586     3215    2              FM$RANEA.BLKNO=DA-FM_FRZERO;

   3215  1 002045   200011 236100                    LDQ     DA,,AUTO
         1 002046   000000 136000 xsym               SBLQ    FM_FRZERO
PL6.E3A0      #001=FMI$RAN File=FMI$RAN.:E05TSI                                  TUE 07/29/97 16:49 Page:86   
         1 002047   200007 470500                    LDP0    P$,,AUTO
         1 002050   000003 756100                    STQ     3,,PR0

      587     3216    2              FM$RANEA.VPNO=VPNO;

   3216  1 002051   200022 236100                    LDQ     VPNO,,AUTO
         1 002052   200007 470500                    LDP0    P$,,AUTO
         1 002053   000004 756100                    STQ     4,,PR0

      588     3217    2              FM$RANEA.PGS=N;

   3217  1 002054   200013 236100                    LDQ     N,,AUTO
         1 002055   200007 470500                    LDP0    P$,,AUTO
         1 002056   000005 756100                    STQ     5,,PR0

      589     3218                   /* Let FMI$EA log an error if acs is block (e.g. EFT) on a
      590     3219                      file which can't have unwritten granules in UGRANS and
      591     3220                      which has a bad granule stamp.                       */
      592     3221    2              IF (F$DCB.ACS=%BLOCK# OR F$DCB.ACS=%UBLOCK#) AND

   3221  1 002057   200004 470500                    LDP0    JDCB$,,AUTO
         1 002060   000036 236100                    LDQ     30,,PR0
         1 002061   000777 376007                    ANQ     511,DL
         1 002062   000003 116007                    CMPQ    3,DL
         1 002063   002066 600000 1                  TZE     s:3221+7
         1 002064   000014 116007                    CMPQ    12,DL
         1 002065   002103 601000 1                  TNZ     s:3226
         1 002066   000032 236100                    LDQ     26,,PR0
         1 002067   777000 376003                    ANQ     -512,DU
         1 002070   003000 116003                    CMPQ    1536,DU
         1 002071   002103 600000 1                  TZE     s:3226
         1 002072   007000 116003                    CMPQ    3584,DU
         1 002073   002103 600000 1                  TZE     s:3226
         1 002074   013000 116003                    CMPQ    5632,DU
         1 002075   002103 600000 1                  TZE     s:3226
         1 002076   005000 116003                    CMPQ    2560,DU
         1 002077   002103 600000 1                  TZE     s:3226
PL6.E3A0      #001=FMI$RAN File=FMI$RAN.:E05TSI                                  TUE 07/29/97 16:49 Page:87   

      593     3222    2                F$DCB.ORG ~= %RANDOM# AND F$DCB.ORG ~= %IDS# AND
      594     3223    2                F$DCB.ORG ~= %CG# AND F$DCB.ORG ~= %RELATIVE# THEN
      595     3224    2                 FM$RANEA.TYP=1;

   3224  1 002100   200007 471500                    LDP1    P$,,AUTO
         1 002101   100006 755100                    STA     6,,PR1
         1 002102   002105 710000 1                  TRA     s:3227

      596     3225    2              ELSE
      597     3226    2                 FM$RANEA.TYP=0;

   3226  1 002103   200007 471500                    LDP1    P$,,AUTO
         1 002104   100006 450100                    STZ     6,,PR1

      598     3227    2             CALL FMB$QUEUE(F$DCB.UB$,0,F$DCB.UBYTES,DA,%N_RDBIN+1024,0,ENTADDR(FMI$EA
              3227                       ),P$);

   3227  1 002105   000000 636000 xent               EAQ     FMI$EA
         1 002106   200036 756100                    STQ     TEMP_CHAR+3,,AUTO
         1 002107   200007 631500                    EPPR1   P$,,AUTO
         1 002110   200047 451500                    STP1    TEMP_CHAR+12,,AUTO
         1 002111   200036 633500                    EPPR3   TEMP_CHAR+3,,AUTO
         1 002112   200046 453500                    STP3    TEMP_CHAR+11,,AUTO
         1 002113   000030 237000 2                  LDAQ    24
         1 002114   200044 757100                    STAQ    TEMP_CHAR+9,,AUTO
         1 002115   200011 634500                    EPPR4   DA,,AUTO
         1 002116   200043 454500                    STP4    TEMP_CHAR+8,,AUTO
         1 002117   200004 236100                    LDQ     JDCB$,,AUTO
         1 002120   000076 036003                    ADLQ    62,DU
         1 002121   200042 756100                    STQ     TEMP_CHAR+7,,AUTO
         1 002122   000004 236000 2                  LDQ     4
         1 002123   200041 756100                    STQ     TEMP_CHAR+6,,AUTO
         1 002124   200004 236100                    LDQ     JDCB$,,AUTO
         1 002125   000075 036003                    ADLQ    61,DU
         1 002126   200040 756100                    STQ     TEMP_CHAR+5,,AUTO
         1 002127   200040 630500                    EPPR0   TEMP_CHAR+5,,AUTO
PL6.E3A0      #001=FMI$RAN File=FMI$RAN.:E05TSI                                  TUE 07/29/97 16:49 Page:88   
         1 002130   000026 631400 xsym               EPPR1   B_VECTNIL+22
         1 002131   000000 701000 xent               TSX1    FMB$QUEUE
         1 002132   000000 011000                    NOP     0

      599     3228                   %LOCK (G#=F_DCBLOCK);

   3229  1 002133   000032 630400 2                  EPPR0   26
         1 002134   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 002135   000000 701000 xent               TSX1    HFC$LOCK
         1 002136   000000 011000                    NOP     0

      600     3231    2              FM$RANEA.CNT=FM$RANEA.CNT-1;

   3231  1 002137   200007 470500                    LDP0    P$,,AUTO
         1 002140   000001 336007                    LCQ     1,DL
         1 002141   000001 056100                    ASQ     1,,PR0

      601     3232    3              IF FM$RANEA.CNT=0 THEN DO;

   3232  1 002142   200007 470500                    LDP0    P$,,AUTO
         1 002143   000001 235100                    LDA     1,,PR0
         1 002144   002203 601000 1                  TNZ     s:3244

      602     3233                      %UNLOCK (G#=F_DCBLOCK);

   3234  1 002145   000032 630400 2                  EPPR0   26
         1 002146   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 002147   000000 701000 xent               TSX1    HFC$UNLOCK
         1 002150   000000 011000                    NOP     0

      603     3236    3                 CALL MMC$CP_IOM(WSQ,VPNO,N);

   3236  1 002151   200013 630500                    EPPR0   N,,AUTO
         1 002152   200040 450500                    STP0    TEMP_CHAR+5,,AUTO
         1 002153   200022 631500                    EPPR1   VPNO,,AUTO
         1 002154   200037 451500                    STP1    TEMP_CHAR+4,,AUTO
         1 002155   200030 633500                    EPPR3   WSQ,,AUTO
PL6.E3A0      #001=FMI$RAN File=FMI$RAN.:E05TSI                                  TUE 07/29/97 16:49 Page:89   
         1 002156   200036 453500                    STP3    TEMP_CHAR+3,,AUTO
         1 002157   200036 630500                    EPPR0   TEMP_CHAR+3,,AUTO
         1 002160   000021 631400 xsym               EPPR1   B_VECTNIL+17
         1 002161   000000 701000 xent               TSX1    MMC$CP_IOM
         1 002162   000000 011000                    NOP     0

      604     3237    3                 P$->N$REQ='0'B;

   3237  1 002163   200007 470500                    LDP0    P$,,AUTO
         1 002164   000100 100400                    MLR     fill='000'O
         1 002165   000002 000001 xsym               ADSC9   B_VECTNIL+2              cn=0,n=1
         1 002166   000000 000170                    ADSC9   0,,PR0                   cn=0,n=120

      605     3238    3                 P$->N$REQ.ERR$=ADDR(NIL);

   3238  1 002167   000001 236000 xsym               LDQ     B_VECTNIL+1
         1 002170   200007 470500                    LDP0    P$,,AUTO
         1 002171   000017 756100                    STQ     15,,PR0

      606     3239    3                 P$->N$REQ.IOQFLG.INUSE = '1'B;

   3239  1 002172   400000 236003                    LDQ     -131072,DU
         1 002173   000033 256100                    ORSQ    27,,PR0

      607     3240    3                 CALL NIQ$REL(P$);

   3240  1 002174   200007 631500                    EPPR1   P$,,AUTO
         1 002175   200036 451500                    STP1    TEMP_CHAR+3,,AUTO
         1 002176   200036 630500                    EPPR0   TEMP_CHAR+3,,AUTO
         1 002177   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 002200   000000 701000 xent               TSX1    NIQ$REL
         1 002201   000000 011000                    NOP     0

      608     3241    3                 END;

   3241  1 002202   002316 710000 1                  TRA     SCHEDDO

PL6.E3A0      #001=FMI$RAN File=FMI$RAN.:E05TSI                                  TUE 07/29/97 16:49 Page:90   
      609     3242    3              ELSE DO;

      610     3243                      %UNLOCK (G#=F_DCBLOCK);

   3244  1 002203   000032 630400 2                  EPPR0   26
         1 002204   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 002205   000000 701000 xent               TSX1    HFC$UNLOCK
         1 002206   000000 011000                    NOP     0

      611     3246    3                 END;

   3246  1 002207   002316 710000 1                  TRA     SCHEDDO

      612     3247    2            CASE(FPTWRITE);

      613     3248    3              DO WHILE(N>0);

   3248  1 002210   200013 235100                    LDA     N,,AUTO
         1 002211   002252 604400 1                  TMOZ    s:3257

      614     3249    3                 UB$->WRDS(0)=BITBIN(STAMP); /* SET STAMP                        */

   3249  1 002212   200031 235100                    LDA     STAMP,,AUTO
         1 002213   200021 470500                    LDP0    UB$,,AUTO
         1 002214   000000 755100                    STA     0,,PR0

      615     3250    3                 IF F$DCB.ORG=%IDS# AND F$DCB.ACS~=%BLOCK# THEN

   3250  1 002215   200004 471500                    LDP1    JDCB$,,AUTO
         1 002216   100032 236100                    LDQ     26,,PR1
         1 002217   777000 376003                    ANQ     -512,DU
         1 002220   007000 116003                    CMPQ    3584,DU
         1 002221   002241 601000 1                  TNZ     s:3253
         1 002222   100036 236100                    LDQ     30,,PR1
         1 002223   000777 376007                    ANQ     511,DL
         1 002224   000003 116007                    CMPQ    3,DL
         1 002225   002241 600000 1                  TZE     s:3253
PL6.E3A0      #001=FMI$RAN File=FMI$RAN.:E05TSI                                  TUE 07/29/97 16:49 Page:91   

      616     3251    3                    IF NOT FPT$WRITE_V.NOTIME THEN

   3251  1 002226   000000 473400 xsym               LDP3    B$PS0$
         1 002227   300000 236100                    LDQ     0,,PR3
         1 002230   000040 316007                    CANQ    32,DL
         1 002231   002241 601000 1                  TNZ     s:3253

      617     3252    3                       CALL SSS$SYSTIME(UB$->WRDS(1)); /* TIME STAMP             */

   3252  1 002232   200021 236100                    LDQ     UB$,,AUTO
         1 002233   000001 036003                    ADLQ    1,DU
         1 002234   200036 756100                    STQ     TEMP_CHAR+3,,AUTO
         1 002235   200036 630500                    EPPR0   TEMP_CHAR+3,,AUTO
         1 002236   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 002237   000000 701000 xent               TSX1    SSS$SYSTIME
         1 002240   000000 011000                    NOP     0

      618     3253    3                 STAMP.GMOD=STAMP.GMOD+1;  /* INCR STAMP                         */

   3253  1 002241   200031 236100                    LDQ     STAMP,,AUTO
         1 002242   000001 036007                    ADLQ    1,DL
         1 002243   200031 552104                    STBQ    STAMP,'04'O,AUTO

      619     3254    3                 UB$=PINCRW(UB$,1024);

   3254  1 002244   200021 236100                    LDQ     UB$,,AUTO
         1 002245   002000 036003                    ADLQ    1024,DU
         1 002246   200021 756100                    STQ     UB$,,AUTO

      620     3255    3                 N=N-1;

   3255  1 002247   000001 336007                    LCQ     1,DL
         1 002250   200013 056100                    ASQ     N,,AUTO

      621     3256    3                 END;

PL6.E3A0      #001=FMI$RAN File=FMI$RAN.:E05TSI                                  TUE 07/29/97 16:49 Page:92   
   3256  1 002251   002212 605400 1                  TPNZ    s:3249

      622     3257    2              FM$CFU.FMOD='1'B;            /* SET WRITE OCCURRED                 */

   3257  1 002252   200005 470500                    LDP0    CFU$,,AUTO
         1 002253   004000 236003                    LDQ     2048,DU
         1 002254   000000 256100                    ORSQ    0,,PR0

      623     3258    2              CALL FMB$QUEUE(F$DCB.UB$,0,F$DCB.UBYTES,DA,%N_WRBIN,0,ENTADDR(NIL),0);

   3258  1 002255   000004 237000 2                  LDAQ    4
         1 002256   200044 757100                    STAQ    TEMP_CHAR+9,,AUTO
         1 002257   000034 237000 2                  LDAQ    28
         1 002260   200042 757100                    STAQ    TEMP_CHAR+7,,AUTO
         1 002261   200011 631500                    EPPR1   DA,,AUTO
         1 002262   200041 451500                    STP1    TEMP_CHAR+6,,AUTO
         1 002263   200004 236100                    LDQ     JDCB$,,AUTO
         1 002264   000076 036003                    ADLQ    62,DU
         1 002265   200040 756100                    STQ     TEMP_CHAR+5,,AUTO
         1 002266   000004 236000 2                  LDQ     4
         1 002267   200037 756100                    STQ     TEMP_CHAR+4,,AUTO
         1 002270   200004 236100                    LDQ     JDCB$,,AUTO
         1 002271   000075 036003                    ADLQ    61,DU
         1 002272   200036 756100                    STQ     TEMP_CHAR+3,,AUTO
         1 002273   200036 630500                    EPPR0   TEMP_CHAR+3,,AUTO
         1 002274   000026 631400 xsym               EPPR1   B_VECTNIL+22
         1 002275   000000 701000 xent               TSX1    FMB$QUEUE
         1 002276   000000 011000                    NOP     0

      624     3259    2              IF F$DCB.ACS = %BLOCK# AND F$DCB.FUN ~= %CREATE# THEN

   3259  1 002277   200004 470500                    LDP0    JDCB$,,AUTO
         1 002300   000036 236100                    LDQ     30,,PR0
         1 002301   000777 376007                    ANQ     511,DL
         1 002302   000003 116007                    CMPQ    3,DL
         1 002303   002316 601000 1                  TNZ     SCHEDDO
         1 002304   000032 236100                    LDQ     26,,PR0
PL6.E3A0      #001=FMI$RAN File=FMI$RAN.:E05TSI                                  TUE 07/29/97 16:49 Page:93   
         1 002305   000777 376003                    ANQ     511,DU
         1 002306   000003 116003                    CMPQ    3,DU
         1 002307   002316 600000 1                  TZE     SCHEDDO

      625     3260    2                 CALL FMC$CLR1(DA);

   3260  1 002310   200011 631500                    EPPR1   DA,,AUTO
         1 002311   200036 451500                    STP1    TEMP_CHAR+3,,AUTO
         1 002312   200036 630500                    EPPR0   TEMP_CHAR+3,,AUTO
         1 002313   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 002314   000000 701000 xent               TSX1    FMC$CLR1
         1 002315   000000 011000                    NOP     0

      626     3261    2            END;

      627     3262    1   SCHEDDO: ;

   3262  1 002316                       SCHEDDO      null
      628     3263    1           IF S$CU$->B$U.FLG.DBRK THEN

   3263  1 002316   000000 470400 xsym               LDP0    S$CU$
         1 002317   000000 236100                    LDQ     0,,PR0
         1 002320   010000 316007                    CANQ    4096,DL
         1 002321   002325 600000 1                  TZE     SETEOP

      629     3264    1              CALL FMB$IOSPIN;             /* FORCE I/O TO COMPLETE              */

   3264  1 002322   000002 631400 xsym               EPPR1   B_VECTNIL+2
         1 002323   000000 701000 xent               TSX1    FMB$IOSPIN
         1 002324   000000 011000                    NOP     0

      630     3265        /**/
      631     3266    1   SETEOP: F$DCB.EOP=FM_EOP(FPTCODE);      /* SET EOP                            */

   3266  1 002325   200003 470500       SETEOP       LDP0    @FPTCODE,,AUTO
         1 002326   000000 720100                    LXL0    0,,PR0
         1 002327   200004 471500                    LDP1    JDCB$,,AUTO
PL6.E3A0      #001=FMI$RAN File=FMI$RAN.:E05TSI                                  TUE 07/29/97 16:49 Page:94   
         1 002330   000000 236010 xsym               LDQ     FM_EOP,X0
         1 002331   000033 736000                    QLS     27
         1 002332   100064 676100                    ERQ     52,,PR1
         1 002333   003000 376003                    ANQ     1536,DU
         1 002334   100064 656100                    ERSQ    52,,PR1

      632     3267    1           IF B$JIT.ERR='0'B THEN RETURN;

   3267  1 002335   000000 473400 xsym               LDP3    B$JIT$
         1 002336   300012 235100                    LDA     10,,PR3
         1 002337   002341 601000 1                  TNZ     ERR

   3267  1 002340   000000 702200 xent               TSX2  ! X66_ARET

      633     3268    1   ERR:    ALTRETURN;

   3268  1 002341   000000 702200 xent  ERR          TSX2  ! X66_AALT

      634     3269        /**/
      635     3270        /**/
      636     3271        /* DEVICE PACK READ AND WRITE */
      637     3272        /**/
      638     3273        /**/
      639     3274    2   DEVPACK: DO CASE(FPTCODE);

   3274  1 002342   200003 471500       DEVPACK      LDP1    @FPTCODE,,AUTO
         1 002343   100000 235100                    LDA     0,,PR1
         1 002344   000002 115007                    CMPA    2,DL
         1 002345   002347 602005 1                  TNC     DEVPACK+5,AL
         1 002346   002371 710000 1                  TRA     s:3283
         1 002347   002351 710000 1                  TRA     s:3276
         1 002350   002363 710000 1                  TRA     s:3280

      640     3275    2            CASE(FPTREAD);

      641     3276    2              CALL HFF$WRITE1(2) ALTRET(MEMERR); /* CHECK BUFFER                 */

PL6.E3A0      #001=FMI$RAN File=FMI$RAN.:E05TSI                                  TUE 07/29/97 16:49 Page:95   
   3276  1 002351   000002 630400 2                  EPPR0   2
         1 002352   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 002353   000000 701000 xent               TSX1    HFF$WRITE1
         1 002354   002537 702000 1                  TSX2    MEMERR

      642     3277    2              FC=%N_RDBIN+512;             /* Indicate reading into user buffer  */

   3277  1 002355   001002 235007                    LDA     514,DL
         1 002356   200020 755100                    STA     FC,,AUTO

      643     3278    2              F$DCB.ARS=F$DCB.UBYTES;

   3278  1 002357   200004 470500                    LDP0    JDCB$,,AUTO
         1 002360   000076 235100                    LDA     62,,PR0
         1 002361   000000 755100                    STA     0,,PR0
         1 002362   002371 710000 1                  TRA     s:3283

      644     3279    2            CASE(FPTWRITE);

      645     3280    2              CALL HFF$NILERASE(2) ALTRET(MEMERR); /* CHECK BUFFER               */

   3280  1 002363   000002 630400 2                  EPPR0   2
         1 002364   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 002365   000000 701000 xent               TSX1    HFF$NILERASE
         1 002366   002537 702000 1                  TSX2    MEMERR

      646     3281    2              FC=%N_WRBIN;

   3281  1 002367   000003 235007                    LDA     3,DL
         1 002370   200020 755100                    STA     FC,,AUTO

      647     3282    2            END;

      648     3283    1           DA=F$DCB.CRECNO+FM_SRZERO;

   3283  1 002371   200004 470500                    LDP0    JDCB$,,AUTO
         1 002372   000071 236100                    LDQ     57,,PR0
PL6.E3A0      #001=FMI$RAN File=FMI$RAN.:E05TSI                                  TUE 07/29/97 16:49 Page:96   
         1 002373   000000 036000 xsym               ADLQ    FM_SRZERO
         1 002374   200011 756100                    STQ     DA,,AUTO

      649     3284    1           F$DCB.CRECNO=F$DCB.CRECNO+((F$DCB.UBYTES+4095)/4096);

   3284  1 002375   000076 236100                    LDQ     62,,PR0
         1 002376   007777 036007                    ADLQ    4095,DL
         1 002377   000014 772000                    QRL     12
         1 002400   000071 036100                    ADLQ    57,,PR0
         1 002401   000071 756100                    STQ     57,,PR0

      650     3285    1           IF MOD(F$DCB.UBYTES,4096)~=0 THEN

   3285  1 002402   000076 236100                    LDQ     62,,PR0
         1 002403   007777 376007                    ANQ     4095,DL
         1 002404   002410 600000 1                  TZE     s:3287

      651     3286    1              B$JIT.ERR=ERRLD;             /* Not gran size multiple             */

   3286  1 002405   000003 236000 0                  LDQ     ERRLD
         1 002406   000000 471400 xsym               LDP1    B$JIT$
         1 002407   100012 756100                    STQ     10,,PR1

      652     3287    2           IF FC=%N_WRBIN THEN DO;         /* TIME STAMP VIDS                    */

   3287  1 002410   200020 235100                    LDA     FC,,AUTO
         1 002411   000003 115007                    CMPA    3,DL
         1 002412   002501 601000 1                  TNZ     s:3300

      653     3288    2              WSQ=DA;

   3288  1 002413   200011 236100                    LDQ     DA,,AUTO
         1 002414   200030 756100                    STQ     WSQ,,AUTO

      654     3289    2              N=FM$SET.DCTX(F$DCB.SETX);

   3289  1 002415   000051 236100                    LDQ     41,,PR0
PL6.E3A0      #001=FMI$RAN File=FMI$RAN.:E05TSI                                  TUE 07/29/97 16:49 Page:97   
         1 002416   000003 736000                    QLS     3
         1 002417   000000 376000 2                  ANQ     0
         1 002420   000000 471400 xsym               LDP1    F$CFU$
         1 002421   100000 236106                    LDQ     0,QL,PR1
         1 002422   000022 772000                    QRL     18
         1 002423   200013 756100                    STQ     N,,AUTO

      655     3290    3              DO WHILE(WSQ>FM$VOL.NXTSDA(N));

   3290  1 002424   200013 235100                    LDA     N,,AUTO
         1 002425   000003 735000                    ALS     3
         1 002426   100003 236105                    LDQ     3,AL,PR1
         1 002427   000032 376000 xsym               ANQ     B_VECTNIL+26
         1 002430   200030 116100                    CMPQ    WSQ,,AUTO
         1 002431   002455 605000 1                  TPL     s:3294

      656     3291    3                 WSQ=WSQ-FM$VOL.NXTSDA(N)+FM_SRZERO;

   3291  1 002432   200013 235100                    LDA     N,,AUTO
         1 002433   000003 735000                    ALS     3
         1 002434   000000 470400 xsym               LDP0    F$CFU$
         1 002435   000003 236105                    LDQ     3,AL,PR0
         1 002436   000032 376000 xsym               ANQ     B_VECTNIL+26
         1 002437   200036 756100                    STQ     TEMP_CHAR+3,,AUTO
         1 002440   200030 236100                    LDQ     WSQ,,AUTO
         1 002441   200036 136100                    SBLQ    TEMP_CHAR+3,,AUTO
         1 002442   000000 036000 xsym               ADLQ    FM_SRZERO
         1 002443   200030 756100                    STQ     WSQ,,AUTO

      657     3292    3                 N=FM$VOL.VOLL(N);

   3292  1 002444   000005 236105                    LDQ     5,AL,PR0
         1 002445   000022 772000                    QRL     18
         1 002446   200013 756100                    STQ     N,,AUTO

      658     3293    3                 END;

PL6.E3A0      #001=FMI$RAN File=FMI$RAN.:E05TSI                                  TUE 07/29/97 16:49 Page:98   
   3293  1 002447   200013 235100                    LDA     N,,AUTO
         1 002450   000003 735000                    ALS     3
         1 002451   000003 236105                    LDQ     3,AL,PR0
         1 002452   000032 376000 xsym               ANQ     B_VECTNIL+26
         1 002453   200030 116100                    CMPQ    WSQ,,AUTO
         1 002454   002432 604000 1                  TMI     s:3291

      659     3294    3              IF WSQ=FM_SRZERO THEN DO;

   3294  1 002455   200030 236100                    LDQ     WSQ,,AUTO
         1 002456   002501 604000 1                  TMI     s:3300
         1 002457   000000 116000 xsym               CMPQ    FM_SRZERO
         1 002460   002501 601000 1                  TNZ     s:3300

      660     3295    3                 CALL SSS$SYSTIME(F$DCB.UB$->FM$VID.INITTIME);

   3295  1 002461   200004 470500                    LDP0    JDCB$,,AUTO
         1 002462   000075 471500                    LDP1    61,,PR0
         1 002463   100007 633500                    EPPR3   7,,PR1
         1 002464   200036 453500                    STP3    TEMP_CHAR+3,,AUTO
         1 002465   200036 630500                    EPPR0   TEMP_CHAR+3,,AUTO
         1 002466   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 002467   000000 701000 xent               TSX1    SSS$SYSTIME
         1 002470   000000 011000                    NOP     0

      661     3296    3                 CALL XLATE_9_TO_6(STAMP,XLATE926,B_SITEINFO.SITE_ID);

   3296  1 002471   040100 160400                    MVT     fill='040'O
         1 002472   000066 000006 xsym               ADSC9   B_SITEINFO+54            cn=0,n=6
         1 002473   200031 020006                    ADSC6   STAMP,,AUTO              cn=0,n=6
         1 002474   000011 000000 0                  ARG     XLATE926

      662     3297    3                 F$DCB.UB$->FM$VID.INSTID=STAMP;

   3297  1 002475   200004 470500                    LDP0    JDCB$,,AUTO
         1 002476   000075 471500                    LDP1    61,,PR0
         1 002477   200031 236100                    LDQ     STAMP,,AUTO
PL6.E3A0      #001=FMI$RAN File=FMI$RAN.:E05TSI                                  TUE 07/29/97 16:49 Page:99   
         1 002500   100001 756100                    STQ     1,,PR1

      663     3298    3                 END;

      664     3299    2              END;

      665     3300    1           CALL FMB$QUEUE(F$DCB.UB$,0,F$DCB.UBYTES,DA,FC,0,ENTADDR(NIL),0);

   3300  1 002501   000004 237000 2                  LDAQ    4
         1 002502   200044 757100                    STAQ    TEMP_CHAR+9,,AUTO
         1 002503   000004 236000 2                  LDQ     4
         1 002504   200043 756100                    STQ     TEMP_CHAR+8,,AUTO
         1 002505   200020 630500                    EPPR0   FC,,AUTO
         1 002506   200042 450500                    STP0    TEMP_CHAR+7,,AUTO
         1 002507   200011 631500                    EPPR1   DA,,AUTO
         1 002510   200041 451500                    STP1    TEMP_CHAR+6,,AUTO
         1 002511   200004 236100                    LDQ     JDCB$,,AUTO
         1 002512   000076 036003                    ADLQ    62,DU
         1 002513   200040 756100                    STQ     TEMP_CHAR+5,,AUTO
         1 002514   000004 236000 2                  LDQ     4
         1 002515   200037 756100                    STQ     TEMP_CHAR+4,,AUTO
         1 002516   200004 236100                    LDQ     JDCB$,,AUTO
         1 002517   000075 036003                    ADLQ    61,DU
         1 002520   200036 756100                    STQ     TEMP_CHAR+3,,AUTO
         1 002521   200036 630500                    EPPR0   TEMP_CHAR+3,,AUTO
         1 002522   000026 631400 xsym               EPPR1   B_VECTNIL+22
         1 002523   000000 701000 xent               TSX1    FMB$QUEUE
         1 002524   000000 011000                    NOP     0

      666     3301    1           IF FC = %N_WRBIN THEN

   3301  1 002525   200020 235100                    LDA     FC,,AUTO
         1 002526   000003 115007                    CMPA    3,DL
         1 002527   002536 601000 1                  TNZ     s:3303

      667     3302    1              CALL FMC$CLR1(DA);

PL6.E3A0      #001=FMI$RAN File=FMI$RAN.:E05TSI                                  TUE 07/29/97 16:49 Page:100  
   3302  1 002530   200011 630500                    EPPR0   DA,,AUTO
         1 002531   200036 450500                    STP0    TEMP_CHAR+3,,AUTO
         1 002532   200036 630500                    EPPR0   TEMP_CHAR+3,,AUTO
         1 002533   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 002534   000000 701000 xent               TSX1    FMC$CLR1
         1 002535   000000 011000                    NOP     0

      668     3303    1           GOTO SCHEDDO;

   3303  1 002536   002316 710000 1                  TRA     SCHEDDO

      669     3304        /**/
      670     3305    1   MEMERR: B$JIT.ERR=ERRMTRAP;

   3305  1 002537   000005 236000 0     MEMERR       LDQ     ERRMTRAP
         1 002540   000000 470400 xsym               LDP0    B$JIT$
         1 002541   000012 756100                    STQ     10,,PR0

      671     3306    1           GOTO SCHEDDO;

   3306  1 002542   002316 710000 1                  TRA     SCHEDDO

   3301  1 002543                       READ_UBLOCK  null
      672     3307        /*E*   ERROR:   FMI-E$MTRAP-2
      673     3308        *       DESCRIPTION:  Buffer has wrong access.
      674     3309        */
      675     3310        /*
      676     3311           Handle UBLOCK reads (UBLOCK writes are handled in FMH$CONSEC).
      677     3312        */
      678     3313    1   READ_UBLOCK: ;
      679     3314    1           IF F$DCB.BFR.BUFX(0) ~= 0 AND F$DCB.BFR1.SIZ(0) ~= 1 THEN

   3314  1 002543   000115 236100                    LDQ     77,,PR0
         1 002544   037000 316003                    CANQ    15872,DU
         1 002545   002556 600000 1                  TZE     s:3316
         1 002546   000122 236100                    LDQ     82,,PR0
         1 002547   000777 376003                    ANQ     511,DU
PL6.E3A0      #001=FMI$RAN File=FMI$RAN.:E05TSI                                  TUE 07/29/97 16:49 Page:101  
         1 002550   000001 116003                    CMPQ    1,DU
         1 002551   002556 600000 1                  TZE     s:3316

      680     3315    1              CALL FMD$RELBUF(0);          /* Release any old buffer 0.          */

   3315  1 002552   000004 630400 2                  EPPR0   4
         1 002553   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 002554   000000 701000 xent               TSX1    FMD$RELBUF
         1 002555   000000 011000                    NOP     0

      681     3316    1           VPNO = (F$DCB.UBYTES + 4095) / 4096; /* # grans.                      */

   3316  1 002556   200004 470500                    LDP0    JDCB$,,AUTO
         1 002557   000076 236100                    LDQ     62,,PR0
         1 002560   007777 036007                    ADLQ    4095,DL
         1 002561   000014 772000                    QRL     12
         1 002562   200022 756100                    STQ     VPNO,,AUTO

      682     3317    1           DA = F$DCB.CRECNO + FM_FRZERO;  /* Starting DA.                       */

   3317  1 002563   000071 236100                    LDQ     57,,PR0
         1 002564   000000 036000 xsym               ADLQ    FM_FRZERO
         1 002565   200011 756100                    STQ     DA,,AUTO

      683     3318    2           DO I = 1 TO VPNO;               /* For each gran.                     */

   3318  1 002566   000001 235007                    LDA     1,DL
         1 002567   200014 755100                    STA     I,,AUTO
         1 002570   003125 710000 1                  TRA     s:3369+1

      684     3319    2              STAMP.GMOD = DA;             /* Set gmod.                          */

   3319  1 002571   200011 236100                    LDQ     DA,,AUTO
         1 002572   200031 552104                    STBQ    STAMP,'04'O,AUTO

      685     3320    3              CALL FMC$GET(G$,0,DA,FC) WHENALTRETURN DO; /* Get the granule.     */

PL6.E3A0      #001=FMI$RAN File=FMI$RAN.:E05TSI                                  TUE 07/29/97 16:49 Page:102  
   3320  1 002573   200020 630500                    EPPR0   FC,,AUTO
         1 002574   200041 450500                    STP0    TEMP_CHAR+6,,AUTO
         1 002575   200011 631500                    EPPR1   DA,,AUTO
         1 002576   200040 451500                    STP1    TEMP_CHAR+5,,AUTO
         1 002577   000004 236000 2                  LDQ     4
         1 002600   200037 756100                    STQ     TEMP_CHAR+4,,AUTO
         1 002601   200006 633500                    EPPR3   G$,,AUTO
         1 002602   200036 453500                    STP3    TEMP_CHAR+3,,AUTO
         1 002603   200036 630500                    EPPR0   TEMP_CHAR+3,,AUTO
         1 002604   000022 631400 xsym               EPPR1   B_VECTNIL+18
         1 002605   000000 701000 xent               TSX1    FMC$GET
         1 002606   002610 702000 1                  TSX2    s:3321
         1 002607   002625 710000 1                  TRA     s:3324

      686     3321    3                 CALL FMB$LOGERR(%E$MI,1,8,DA);

   3321  1 002610   200011 630500                    EPPR0   DA,,AUTO
         1 002611   200041 450500                    STP0    TEMP_CHAR+6,,AUTO
         1 002612   000025 236000 2                  LDQ     21
         1 002613   200040 756100                    STQ     TEMP_CHAR+5,,AUTO
         1 002614   000036 237000 2                  LDAQ    30
         1 002615   200036 757100                    STAQ    TEMP_CHAR+3,,AUTO
         1 002616   200036 630500                    EPPR0   TEMP_CHAR+3,,AUTO
         1 002617   000022 631400 xsym               EPPR1   B_VECTNIL+18
         1 002620   000000 701000 xent               TSX1    FMB$LOGERR
         1 002621   000000 011000                    NOP     0

      687     3322    3                 B$JIT.ERR = ERRDI;

   3322  1 002622   000006 236000 0                  LDQ     ERRDI
         1 002623   000000 470400 xsym               LDP0    B$JIT$
         1 002624   000012 756100                    STQ     10,,PR0

      688     3323    3                 END;

      689     3324    3              IF FC = 0 THEN DO;           /* Couldn't get it through the cache. */

PL6.E3A0      #001=FMI$RAN File=FMI$RAN.:E05TSI                                  TUE 07/29/97 16:49 Page:103  
   3324  1 002625   200020 235100                    LDA     FC,,AUTO
         1 002626   002672 601000 1                  TNZ     s:3332

      690     3325    3                 IF F$DCB.BFR.BUFX(0) = 0 THEN

   3325  1 002627   200004 470500                    LDP0    JDCB$,,AUTO
         1 002630   000115 236100                    LDQ     77,,PR0
         1 002631   037000 316003                    CANQ    15872,DU
         1 002632   002644 601000 1                  TNZ     s:3328

      691     3326    3                    CALL FMD$GETBUF(0,1,G$);

   3326  1 002633   200006 631500                    EPPR1   G$,,AUTO
         1 002634   200040 451500                    STP1    TEMP_CHAR+5,,AUTO
         1 002635   000012 237000 2                  LDAQ    10
         1 002636   200036 757100                    STAQ    TEMP_CHAR+3,,AUTO
         1 002637   200036 630500                    EPPR0   TEMP_CHAR+3,,AUTO
         1 002640   000021 631400 xsym               EPPR1   B_VECTNIL+17
         1 002641   000000 701000 xent               TSX1    FMD$GETBUF
         1 002642   000000 011000                    NOP     0
         1 002643   002651 710000 1                  TRA     s:3329

      692     3327    3                 ELSE
      693     3328    3                    G$ = FM$BUF$(F$DCB.BFR.BUFX(0));

   3328  1 002644   000115 236100                    LDQ     77,,PR0
         1 002645   000033 772000                    QRL     27
         1 002646   000037 376007                    ANQ     31,DL
         1 002647   000000 236006 xsym               LDQ     FM$BUF$,QL
         1 002650   200006 756100                    STQ     G$,,AUTO

      694     3329    3                 CALL FMB$QUEUE(G$,0,4096,DA,%N_RDBIN,1,ENTADDR(NIL),0);

   3329  1 002651   000004 237000 2                  LDAQ    4
         1 002652   200044 757100                    STAQ    TEMP_CHAR+9,,AUTO
         1 002653   000002 237000 2                  LDAQ    2
         1 002654   200042 757100                    STAQ    TEMP_CHAR+7,,AUTO
PL6.E3A0      #001=FMI$RAN File=FMI$RAN.:E05TSI                                  TUE 07/29/97 16:49 Page:104  
         1 002655   200011 630500                    EPPR0   DA,,AUTO
         1 002656   200041 450500                    STP0    TEMP_CHAR+6,,AUTO
         1 002657   000041 236000 2                  LDQ     33
         1 002660   200040 756100                    STQ     TEMP_CHAR+5,,AUTO
         1 002661   000004 236000 2                  LDQ     4
         1 002662   200037 756100                    STQ     TEMP_CHAR+4,,AUTO
         1 002663   200006 631500                    EPPR1   G$,,AUTO
         1 002664   200036 451500                    STP1    TEMP_CHAR+3,,AUTO
         1 002665   200036 630500                    EPPR0   TEMP_CHAR+3,,AUTO
         1 002666   000026 631400 xsym               EPPR1   B_VECTNIL+22
         1 002667   000000 701000 xent               TSX1    FMB$QUEUE
         1 002670   000000 011000                    NOP     0

      695     3330    3                 END;

   3330  1 002671   002700 710000 1                  TRA     s:3334

      696     3331    2              ELSE               /* Got it through the cache, get the buffer.    */
      697     3332    2                 G$ = FM$BUF$(F$DCB.BFR.BUFX(0));

   3332  1 002672   200004 470500                    LDP0    JDCB$,,AUTO
         1 002673   000115 236100                    LDQ     77,,PR0
         1 002674   000033 772000                    QRL     27
         1 002675   000037 376007                    ANQ     31,DL
         1 002676   000000 236006 xsym               LDQ     FM$BUF$,QL
         1 002677   200006 756100                    STQ     G$,,AUTO

      698     3333
      699     3334    3              IF G$->FM$GRAN.STAMP ~= STAMP THEN DO;

   3334  1 002700   200006 470500                    LDP0    G$,,AUTO
         1 002701   000000 236100                    LDQ     0,,PR0
         1 002702   200031 116100                    CMPQ    STAMP,,AUTO
         1 002703   002753 600000 1                  TZE     s:3342

      700     3335    3                 IF F$DCB.ORG ~= %RELATIVE# AND F$DCB.ORG ~= %RANDOM# AND

PL6.E3A0      #001=FMI$RAN File=FMI$RAN.:E05TSI                                  TUE 07/29/97 16:49 Page:105  
   3335  1 002704   200004 471500                    LDP1    JDCB$,,AUTO
         1 002705   100032 236100                    LDQ     26,,PR1
         1 002706   777000 376003                    ANQ     -512,DU
         1 002707   005000 116003                    CMPQ    2560,DU
         1 002710   002741 600000 1                  TZE     s:3338
         1 002711   003000 116003                    CMPQ    1536,DU
         1 002712   002741 600000 1                  TZE     s:3338
         1 002713   007000 116003                    CMPQ    3584,DU
         1 002714   002741 600000 1                  TZE     s:3338
         1 002715   013000 116003                    CMPQ    5632,DU
         1 002716   002741 600000 1                  TZE     s:3338

      701     3336    3                   F$DCB.ORG ~= %IDS# AND F$DCB.ORG ~= %CG# THEN
      702     3337    3                    CALL FMB$LOGERR(%E$MI,5,8,DA,G$,0,1,2,STAMP);

   3337  1 002717   200031 633500                    EPPR3   STAMP,,AUTO
         1 002720   200046 453500                    STP3    TEMP_CHAR+11,,AUTO
         1 002721   000042 237000 2                  LDAQ    34
         1 002722   200044 757100                    STAQ    TEMP_CHAR+9,,AUTO
         1 002723   000004 236000 2                  LDQ     4
         1 002724   200043 756100                    STQ     TEMP_CHAR+8,,AUTO
         1 002725   200006 634500                    EPPR4   G$,,AUTO
         1 002726   200042 454500                    STP4    TEMP_CHAR+7,,AUTO
         1 002727   200011 635500                    EPPR5   DA,,AUTO
         1 002730   200041 455500                    STP5    TEMP_CHAR+6,,AUTO
         1 002731   000025 236000 2                  LDQ     21
         1 002732   200040 756100                    STQ     TEMP_CHAR+5,,AUTO
         1 002733   000044 237000 2                  LDAQ    36
         1 002734   200036 757100                    STAQ    TEMP_CHAR+3,,AUTO
         1 002735   200036 630500                    EPPR0   TEMP_CHAR+3,,AUTO
         1 002736   000016 631400 2                  EPPR1   14
         1 002737   000000 701000 xent               TSX1    FMB$LOGERR
         1 002740   000000 011000                    NOP     0

      703     3338    3                 G$->CLR.X = ' ';          /* Zap the granule.                   */

   3338  1 002741   200006 470500                    LDP0    G$,,AUTO
PL6.E3A0      #001=FMI$RAN File=FMI$RAN.:E05TSI                                  TUE 07/29/97 16:49 Page:106  
         1 002742   040100 100400                    MLR     fill='040'O
         1 002743   000035 000001 xsym               ADSC9   B_VECTNIL+29             cn=0,n=1
         1 002744   000001 007774                    ADSC9   1,,PR0                   cn=0,n=4092

      704     3339    3                 G$->WRDS(0) = -1;

   3339  1 002745   000001 335007                    LCA     1,DL
         1 002746   200006 470500                    LDP0    G$,,AUTO
         1 002747   000000 755100                    STA     0,,PR0

      705     3340    3                 B$JIT.ERR = ERRDI;

   3340  1 002750   000006 236000 0                  LDQ     ERRDI
         1 002751   000000 470400 xsym               LDP0    B$JIT$
         1 002752   000012 756100                    STQ     10,,PR0

      706     3341    3                 END;

      707     3342    2              IF BLKSIZ = 1024*4 THEN      /* FULL=YES?                          */

   3342  1 002753   200012 235100                    LDA     BLKSIZ,,AUTO
         1 002754   010000 115007                    CMPA    4096,DL
         1 002755   002761 601000 1                  TNZ     s:3345

      708     3343    2                 P$ = G$;                  /* Yes, give the user everything.     */

   3343  1 002756   200006 236100                    LDQ     G$,,AUTO
         1 002757   200007 756100                    STQ     P$,,AUTO
         1 002760   002764 710000 1                  TRA     s:3346

      709     3344    2              ELSE
      710     3345    2                 P$ = PINCRW(G$,1);        /* FULL=NO, skip the stamp.           */

   3345  1 002761   200006 236100                    LDQ     G$,,AUTO
         1 002762   000001 036003                    ADLQ    1,DU
         1 002763   200007 756100                    STQ     P$,,AUTO

PL6.E3A0      #001=FMI$RAN File=FMI$RAN.:E05TSI                                  TUE 07/29/97 16:49 Page:107  
      711     3346    2              GBYTES = BLKSIZ;             /* # bytes to transfer.               */

   3346  1 002764   200010 755100                    STA     GBYTES,,AUTO

      712     3347    3              IF I = 1 AND F$DCB.CRECNO = 0 AND FM$CFU.AFIT = 0 THEN DO;

   3347  1 002765   200014 235100                    LDA     I,,AUTO
         1 002766   000001 115007                    CMPA    1,DL
         1 002767   003106 601000 1                  TNZ     s:3364
         1 002770   200004 470500                    LDP0    JDCB$,,AUTO
         1 002771   000071 235100                    LDA     57,,PR0
         1 002772   003106 601000 1                  TNZ     s:3364
         1 002773   200005 471500                    LDP1    CFU$,,AUTO
         1 002774   100000 236100                    LDQ     0,,PR1
         1 002775   001000 316003                    CANQ    512,DU
         1 002776   003106 601000 1                  TNZ     s:3364

      713     3348                                                /* THIS IS THE FIT, SCRUB OWNER       */
      714     3349    3                 N = MINIMUM(G$->FM$GRAN.FCEX*4+BLKSIZ-4096,F$DCB.UBYTES);

   3349  1 002777   200006 473500                    LDP3    G$,,AUTO
         1 003000   300002 236100                    LDQ     2,,PR3
         1 003001   000020 772000                    QRL     16
         1 003002   000046 376000 2                  ANQ     38
         1 003003   200012 036100                    ADLQ    BLKSIZ,,AUTO
         1 003004   010000 136007                    SBLQ    4096,DL
         1 003005   003012 604000 1                  TMI     s:3349+11
         1 003006   000076 116100                    CMPQ    62,,PR0
         1 003007   003012 602000 1                  TNC     s:3349+11
         1 003010   003012 600000 1                  TZE     s:3349+11
         1 003011   000076 236100                    LDQ     62,,PR0
         1 003012   200013 756100                    STQ     N,,AUTO

      715     3350    3                 CALL MOV2USR;             /* MOVE THE FIT FIRST                 */

   3350  1 003013   003135 701000 1                  TSX1    MOV2USR
         1 003014   000000 011000                    NOP     0
PL6.E3A0      #001=FMI$RAN File=FMI$RAN.:E05TSI                                  TUE 07/29/97 16:49 Page:108  

      716     3351    3                 GBYTES = GBYTES - N;

   3351  1 003015   200010 236100                    LDQ     GBYTES,,AUTO
         1 003016   200013 136100                    SBLQ    N,,AUTO
         1 003017   200010 756100                    STQ     GBYTES,,AUTO

      717     3352    3                 P$ = PINCRW(G$,5);

   3352  1 003020   200006 236100                    LDQ     G$,,AUTO
         1 003021   000005 036003                    ADLQ    5,DU
         1 003022   200007 756100                    STQ     P$,,AUTO

      718     3353    4                 CALL FMO$LOCCODT(P$,4) WHENRETURN DO;

   3353  1 003023   000047 236000 2                  LDQ     39
         1 003024   200037 756100                    STQ     TEMP_CHAR+4,,AUTO
         1 003025   200007 630500                    EPPR0   P$,,AUTO
         1 003026   200036 450500                    STP0    TEMP_CHAR+3,,AUTO
         1 003027   200036 630500                    EPPR0   TEMP_CHAR+3,,AUTO
         1 003030   000020 631400 xsym               EPPR1   B_VECTNIL+16
         1 003031   000000 701000 xent               TSX1    FMO$LOCCODT
         1 003032   003101 702000 1                  TSX2    s:3362

      719     3354    4                    IF BLKSIZ = 1023*4 THEN

   3354  1 003033   200012 235100                    LDA     BLKSIZ,,AUTO
         1 003034   007774 115007                    CMPA    4092,DL
         1 003035   003041 601000 1                  TNZ     s:3356

      720     3355    4                       P$ = PINCRW(P$,-1);

   3355  1 003036   200007 236100                    LDQ     P$,,AUTO
         1 003037   777777 036003                    ADLQ    -1,DU
         1 003040   200007 756100                    STQ     P$,,AUTO

      721     3356    4                    N = MINIMUM(12+POFFC(P$,G$),F$DCB.ARS);
PL6.E3A0      #001=FMI$RAN File=FMI$RAN.:E05TSI                                  TUE 07/29/97 16:49 Page:109  

   3356  1 003041   200006 236100                    LDQ     G$,,AUTO
         1 003042   000020 772000                    QRL     16
         1 003043   200036 756100                    STQ     TEMP_CHAR+3,,AUTO
         1 003044   200007 236100                    LDQ     P$,,AUTO
         1 003045   000020 772000                    QRL     16
         1 003046   200036 136100                    SBLQ    TEMP_CHAR+3,,AUTO
         1 003047   000014 036007                    ADLQ    12,DL
         1 003050   200004 470500                    LDP0    JDCB$,,AUTO
         1 003051   000000 116100                    CMPQ    0,,PR0
         1 003052   003054 604400 1                  TMOZ    s:3356+11
         1 003053   000000 236100                    LDQ     0,,PR0
         1 003054   200013 756100                    STQ     N,,AUTO

      722     3357    4                    P$ = PINCRC(F$DCB.UB$,N-F$DCB.ARS);

   3357  1 003055   000000 136100                    SBLQ    0,,PR0
         1 003056   000075 471500                    LDP1    61,,PR0
         1 003057   000011 402007                    MPY     9,DL
         1 003060   000000 116003                    CMPQ    0,DU
         1 003061   003063 605000 1                  TPL     s:3357+6
         1 003062   000044 036003                    ADLQ    36,DU
         1 003063   100000 503506                    ABD     0,QL,PR1
         1 003064   200007 451500                    STP1    P$,,AUTO

      723     3358    4                    N = MINIMUM(20,F$DCB.ARS-N);

   3358  1 003065   000000 236100                    LDQ     0,,PR0
         1 003066   200013 136100                    SBLQ    N,,AUTO
         1 003067   000024 116007                    CMPQ    20,DL
         1 003070   003072 604400 1                  TMOZ    s:3358+5
         1 003071   000024 236007                    LDQ     20,DL
         1 003072   200013 756100                    STQ     N,,AUTO

      724     3359    4                    IF N > 0 THEN

   3359  1 003073   000000 116003                    CMPQ    0,DU
PL6.E3A0      #001=FMI$RAN File=FMI$RAN.:E05TSI                                  TUE 07/29/97 16:49 Page:110  
         1 003074   003101 604400 1                  TMOZ    s:3362

      725     3360    4                       P$->CHARS = ' ';

   3360  1 003075   000000 620006                    EAX0    0,QL
         1 003076   040140 100400                    MLR     fill='040'O
         1 003077   000035 000001 xsym               ADSC9   B_VECTNIL+29             cn=0,n=1
         1 003100   100000 000010                    ADSC9   0,,PR1                   cn=0,n=*X0

      726     3361    4                    END;

      727     3362    3                 P$ = PINCRW(G$,G$->FM$GRAN.FCEX);

   3362  1 003101   200006 470500                    LDP0    G$,,AUTO
         1 003102   000002 220100                    LDX0    2,,PR0
         1 003103   000000 636010                    EAQ     0,X0
         1 003104   200006 036100                    ADLQ    G$,,AUTO
         1 003105   200007 756100                    STQ     P$,,AUTO

      728     3363    3                 END;

      729     3364    2              N = GBYTES;                  /* # bytes left to move.              */

   3364  1 003106   200010 235100                    LDA     GBYTES,,AUTO
         1 003107   200013 755100                    STA     N,,AUTO

      730     3365    2              CALL MOV2USR;           /* Move the data to the user's buffer.     */

   3365  1 003110   003135 701000 1                  TSX1    MOV2USR
         1 003111   000000 011000                    NOP     0

      731     3366    2              DA = DA + 1;                 /* Next granule.                      */

   3366  1 003112   200011 235100                    LDA     DA,,AUTO
         1 003113   000001 035007                    ADLA    1,DL
         1 003114   200011 755100                    STA     DA,,AUTO

PL6.E3A0      #001=FMI$RAN File=FMI$RAN.:E05TSI                                  TUE 07/29/97 16:49 Page:111  
      732     3367    2              F$DCB.BFR.BUFUP(0) = '0'B;

   3367  1 003115   200004 470500                    LDP0    JDCB$,,AUTO
         1 003116   000031 236000 xsym               LDQ     B_VECTNIL+25
         1 003117   000115 356100                    ANSQ    77,,PR0

      733     3368    2              CALL FMD$RELBUF(0);

   3368  1 003120   000004 630400 2                  EPPR0   4
         1 003121   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 003122   000000 701000 xent               TSX1    FMD$RELBUF
         1 003123   000000 011000                    NOP     0

      734     3369    2              END;

   3369  1 003124   200014 054100                    AOS     I,,AUTO
         1 003125   200014 236100                    LDQ     I,,AUTO
         1 003126   200022 116100                    CMPQ    VPNO,,AUTO
         1 003127   002571 604400 1                  TMOZ    s:3319

      735     3370    1           F$DCB.CRECNO = F$DCB.CRECNO + VPNO;

   3370  1 003130   200004 470500                    LDP0    JDCB$,,AUTO
         1 003131   000071 236100                    LDQ     57,,PR0
         1 003132   200022 036100                    ADLQ    VPNO,,AUTO
         1 003133   000071 756100                    STQ     57,,PR0

      736     3371    1           GOTO SCHEDDO;

   3371  1 003134   002316 710000 1                  TRA     SCHEDDO

      737     3372
      738     3373        /**/
      739     3374        /**/
      740     3375        /* PROC TO MOVE BYTES FROM MON BUFFER TO USER WITHOUT DECRYPTION */
      741     3376    1   MOV2USR: PROC;

PL6.E3A0      #001=FMI$RAN File=FMI$RAN.:E05TSI                                  TUE 07/29/97 16:49 Page:112  
   3376  1 003135   200034 741300       MOV2USR      STX1  ! TEMP_CHAR+1,,AUTO

      742     3377    3           IF N>0 THEN DO;

   3377  1 003136   200013 235100                    LDA     N,,AUTO
         1 003137   003166 604400 1                  TMOZ    s:3383

      743     3378    3              F$DCB.UB$->CHARS=P$->CHARS;  /* MOVE N BYTES                       */

   3378  1 003140   200004 470500                    LDP0    JDCB$,,AUTO
         1 003141   000075 471500                    LDP1    61,,PR0
         1 003142   200007 473500                    LDP3    P$,,AUTO
         1 003143   000000 620005                    EAX0    0,AL
         1 003144   200013 722100                    LXL2    N,,AUTO
         1 003145   040140 100540                    MLR     fill='040'O
         1 003146   300000 000010                    ADSC9   0,,PR3                   cn=0,n=*X0
         1 003147   100000 000012                    ADSC9   0,,PR1                   cn=0,n=*X2

      744     3379    3              F$DCB.UB$=PINCRC(F$DCB.UB$,N);

   3379  1 003150   000075 471500                    LDP1    61,,PR0
         1 003151   200013 236100                    LDQ     N,,AUTO
         1 003152   000011 402007                    MPY     9,DL
         1 003153   000000 116003                    CMPQ    0,DU
         1 003154   003156 605000 1                  TPL     s:3379+6
         1 003155   000044 036003                    ADLQ    36,DU
         1 003156   100000 503506                    ABD     0,QL,PR1
         1 003157   000075 451500                    STP1    61,,PR0

      745     3380    3              F$DCB.UBYTES=F$DCB.UBYTES-N;

   3380  1 003160   000076 236100                    LDQ     62,,PR0
         1 003161   200013 136100                    SBLQ    N,,AUTO
         1 003162   000076 756100                    STQ     62,,PR0

      746     3381    3              F$DCB.ARS=F$DCB.ARS+N;

PL6.E3A0      #001=FMI$RAN File=FMI$RAN.:E05TSI                                  TUE 07/29/97 16:49 Page:113  
   3381  1 003163   000000 236100                    LDQ     0,,PR0
         1 003164   200013 036100                    ADLQ    N,,AUTO
         1 003165   000000 756100                    STQ     0,,PR0

      747     3382    3              END;

      748     3383    2           P$=PINCRW(P$,1);

   3383  1 003166   200007 236100                    LDQ     P$,,AUTO
         1 003167   000001 036003                    ADLQ    1,DU
         1 003170   200007 756100                    STQ     P$,,AUTO

      749     3384    2           RETURN;

   3384  1 003171   200034 221300                    LDX1  ! TEMP_CHAR+1,,AUTO
         1 003172   000001 702211                    TSX2  ! 1,X1

ERREOF
 Sect OctLoc
   0     000   061511 000062                                                    1..2

ERRBOF
 Sect OctLoc
   0     001   061511 000042                                                    1.."

ERRBADBLK
 Sect OctLoc
   0     002   061511 001072                                                    1..:

ERRLD
 Sect OctLoc
   0     003   061511 000072                                                    1..:

ERRRANBOUND
 Sect OctLoc
   0     004   061511 001152                                                    1..j

PL6.E3A0      #001=FMI$RAN File=FMI$RAN.:E05TSI                                  TUE 07/29/97 16:49 Page:114  
ERRMTRAP
 Sect OctLoc
   0     005   061511 000132                                                    1..Z

ERRDI
 Sect OctLoc
   0     006   061511 000112                                                    1..J

ERRWRDEL
 Sect OctLoc
   0     007   061511 001032                                                    1...

ERRBADVECT2
 Sect OctLoc
   0     010   061511 006462                                                    1...

XLATE926
 Sect OctLoc
   0     011   020020 020020   020020 020020   020020 020020   020020 020020    ................
   0     021*  020077 076013   053074 032073   035055 054060   073052 033061    .?>.+<.;.-,0;*.1
   0     025   000001 002003   004005 006007   010012 015056   036075 016016    .............=..
   0     031   014021 022023   024025 026027   030031 041042   043044 045046    ..........!"#$%&
   0     035   047050 051062   062064 065066   067070 071012   037034 040072    '()22456789... :
   0     041   020021 022023   024025 026027   030031 041042   043044 045046    ..........!"#$%&
   0     045   047050 051062   062064 065066   067070 071012   037034 040020    '()22456789... .

(unnamed)
 Sect OctLoc
   2     000   000007 777770   000003 006000   000004 006000   000003 006000    ................
   2     004   000002 006000   000002 006000   000015 006000   000002 006000    ................
   2     010   774777 777777   000000 006000   000002 006000   000003 006000    ................
   2     014   000005 006000   000003 006000   000011 000000   000013 000000    ................
   2     020   000003 006000   000002 006000   000000 000047   000022 006000    ...........'....
   2     024   000007 006000   000012 006000   777777 737777   000000 002002    ................
   2     030   000027 006000   000002 006000   000000 006000   000000 000000    ................
   2     034   000005 006000   000002 006000   000022 006000   000003 006000    ................
   2     040   000000 010000   000040 006000   000003 006000   000004 006000    ..... ..........
PL6.E3A0      #001=FMI$RAN File=FMI$RAN.:E05TSI                                  TUE 07/29/97 16:49 Page:115  
   2     044   000022 006000   000007 006000   000003 777774   000006 006000    ................
      750     3385    2   END MOV2USR;
      751     3386        /**/
      752     3387    1   END FMI$RAN;
      753     3388        %EOD;

PL6.E3A0      #001=FMI$RAN File=FMI$RAN.:E05TSI                                  TUE 07/29/97 16:49 Page:116  
--  Include file information  --

   UM$CP6V_C.:E05TOU  is referenced.
   FM$RANEA.:E05TOU  is referenced.
   CP_6_SUBS.:E05TOU  is referenced.
   B$USER.:E05TOU  cannot be made into a system file and is referenced.
   N$REQ.:E05TOU  is referenced.
   N_FC_C.:E05TOU  is referenced.
   F$CP6V_C.:E05TOU  is referenced.
   F_ERRORS_C.:E05TOU  is referenced.
   F_FPTCODE_C.:E05TOU  is referenced.
   F_CODE_R.:E05TOU  cannot be made into a system file and is referenced.
   FM_DATA_R.:E05TOU  cannot be made into a system file and is referenced.
   FM$MACROS.:E05TOU  is referenced.
   HF_LOCK_C.:E05TOU  cannot be made into a system file and is referenced.
   F$DCB.:E05TOU  is referenced.
   B$JIT_C.:E05TOU  is referenced.
   F$JIT_C.:E05TOU  cannot be made into a system file and is referenced.
      No diagnostics issued in procedure FMI$RAN.
PL6.E3A0      #001=FMI$RAN File=FMI$RAN.:E05TSI                                  TUE 07/29/97 16:49 Page:117  

 **** Variables and constants ****

  ****  Section 000 RoData FMI$RAN

  ****  Scalars and arrays  ****
OctLoc.c.b A Datatyp(siz) R M Lvl/name                 OctLoc.c.b A Datatyp(siz) R M Lvl/name

     2-0-0/b STRC        r     1 ERRBADBLK                 10-0-0/b STRC        r     1 ERRBADVECT2
     1-0-0/b STRC        r     1 ERRBOF                     6-0-0/b STRC        r     1 ERRDI
     0-0-0/b STRC        r     1 ERREOF                     3-0-0/b STRC        r     1 ERRLD
     5-0-0/b STRC        r     1 ERRMTRAP                   4-0-0/b STRC        r     1 ERRRANBOUND
     7-0-0/b STRC        r     1 ERRWRDEL
    11-0-0/b BIT         r     1 XLATE926(0:31)

  ****  Auto variables  ****

  ****  Scalars and arrays  ****
OctLoc.c.b A Datatyp(siz) R M Lvl/name                 OctLoc.c.b A Datatyp(siz) R M Lvl/name

     3-0-0/w PTR         r     1 @FPTCODE                  12-0-0/w SBIN        r     1 BLKSIZ
    15-0-0/w UBIN        r     1 BUFDISP                   16-0-0/w UBIN        r     1 BUFSIZ
     5-0-0/w PTR         r     1 CFU$                      11-0-0/w UBIN        r     1 DA
    26-0-0/w STRC(72)    r     1 DESC                      20-0-0/w UBIN        r     1 FC
    *0-0-0/w UBIN        r     1 FPTCODE                    6-0-0/w PTR         r     1 G$
    10-0-0/w UBIN        r     1 GBYTES                    14-0-0/w SBIN        r     1 I
     4-0-0/w PTR         r     1 JDCB$                     13-0-0/w SBIN        r     1 N
     7-0-0/w PTR         r     1 P$                        32-0-0/w PTR         r     1 Q$
    31-0-0/b STRC        r     1 STAMP                     33-0-0/c CHAR        r     1 TEMP_CHAR
    21-0-0/w PTR         r     1 UB$                       17-0-0/w UBIN        r     1 UGRANS
    22-0-0/w SBIN        r     1 VPNO                      30-0-0/w SBIN        r     1 WSQ
    24-0-0/d STRC(72)    r     1 WSRS

  ****  SYMREF variables  ****

  ****  Scalars and arrays  ****
OctLoc.c.b A Datatyp(siz) R M Lvl/name                 OctLoc.c.b A Datatyp(siz) R M Lvl/name

PL6.E3A0      #001=FMI$RAN File=FMI$RAN.:E05TSI                                  TUE 07/29/97 16:49 Page:118  
     0-0-0/w PTR         r     1 B$JIT$                     0-0-0/w PTR         r     1 B$PS0$
     0-0-0/w PTR         r     1 B$PS1$                     0-0-0/w PTR         r     1 B$PS2$
     0-0-0/d STRC(2232)  r     1 B_SITEINFO                 0-0-0/w PTR         r     1 F$CFU$
     0-0-0/w PTR         r     1 FM$BUF$(0:0)
     0-0-0/w PTR         r     1 FM$SET$                    0-0-0/w UBIN        r     1 FM_EOP(0:8)
     0-0-0/w UBIN        r     1 FM_FRZERO                  0-0-0/w UBIN        r     1 FM_SRZERO
     0-0-0/b BIT (72)    r     1 F_DCBLOCK                  0-0-0/w PTR         r     1 S$CU$

  ****  BASED and DCB variables  ****

  ****  Scalars and arrays  ****
OctLoc.c.b A Datatyp(siz) R M Lvl/name                 OctLoc.c.b A Datatyp(siz) R M Lvl/name

     0-0-0/d STRC(8856)  r     1 B$JIT                      0-0-0/d STRC(576)   r     1 B$U
     0-0-0/c CHAR        r     1 CHAR1                      0-0-0/c CHAR(4)     r     1 CHAR4
     0-0-0/c ACHR        r     1 CHARS                      0-0-0/c ACHR        r     1 CLEAR
     0-0-0/w STRC(36864) r     1 CLR                        0-0-0/d ASTR(3528)  r     1 F$DCB
     0-0-0/w STRC(288)   r     1 FM$CFU                     0-0-0/w STRC(180)   r     1 FM$GRAN
     0-0-0/w STRC(252)   r     1 FM$RANEA                   0-0-0/w STRC(288)   r     1 FM$SET(0:0)
     0-0-0/w STRC(36864) r     1 FM$VID                     0-0-0/w STRC(288)   r     1 FM$VOL(0:0)
     0-0-0/d STRC(72)    r     1 FPT$DELREC_V               0-0-0/d STRC(72)    r     1 FPT$PFIL_V
     0-0-0/d STRC(108)   r     1 FPT$PRECORD_V              0-0-0/d STRC(216)   r     1 FPT$READ_V
     0-0-0/d STRC(144)   r     1 FPT$WRITE_V                0-0-0/d STRC(1080)  r     1 N$REQ
     0-0-0/w SBIN        r     1 WRDS(0:1023)


   Procedure FMI$RAN requires 1659 words for executable code.
   Procedure FMI$RAN requires 42 words of local(AUTO) storage.
PL6.E3A0      #001=FMI$RAN File=FMI$RAN.:E05TSI                                  TUE 07/29/97 16:49 Page:119  
          *** CROSS REFERENCE LISTING ***
**     DENOTES     IDENTIFIER DEFINITION
<<                 IDENTIFIER'S VALUE SET
>>                 IDENTIFIER'S VALUE USED
<>                 IDENTIFIER SET AND/OR USED
--                 IDENTIFIER REFERENCED
PL6.E3A0      #001=FMI$RAN File=FMI$RAN.:E05TSI                                  TUE 07/29/97 16:49 Page:120  
          MINI XREF LISTING

B$DO.ECCINFO
      1716**DCL      1717--REDEF
B$JIT.DCB$
       475**DCL      2771>>ASSIGN
B$JIT.ERR
       385**DCL      2773<<ASSIGN   2827<<ASSIGN   2835<<ASSIGN   2838<<ASSIGN   2908<<ASSIGN   2947<<ASSIGN
      2967<<ASSIGN   2980<<ASSIGN   2993<<ASSIGN   3007<<ASSIGN   3009<<ASSIGN   3017<<ASSIGN   3126<<ASSIGN
      3161>>IF       3162<<ASSIGN   3184<<ASSIGN   3267>>IF       3286<<ASSIGN   3305<<ASSIGN   3322<<ASSIGN
      3340<<ASSIGN
B$JIT.ERR.MID
       386**DCL       386--REDEF
B$JIT$
        52**DCL       380--IMP-PTR  2771>>ASSIGN   2773>>ASSIGN   2827>>ASSIGN   2835>>ASSIGN   2838>>ASSIGN
      2908>>ASSIGN   2947>>ASSIGN   2967>>ASSIGN   2980>>ASSIGN   2993>>ASSIGN   3007>>ASSIGN   3009>>ASSIGN
      3017>>ASSIGN   3126>>ASSIGN   3161>>IF       3162>>ASSIGN   3184>>ASSIGN   3267>>IF       3286>>ASSIGN
      3305>>ASSIGN   3322>>ASSIGN   3340>>ASSIGN
B$PS0$
        53**DCL      2588--IMP-PTR  2595--IMP-PTR  2601--IMP-PTR  2604--IMP-PTR  2607--IMP-PTR  2612--IMP-PTR
      2801>>IF       2813>>IF       2815>>IF       2817>>IF       2822>>ASSIGN   2837>>IF       2849>>IF
      2858>>IF       2868>>IF       2918>>IF       2921>>IF       2938>>IF       2944>>IF       2979>>IF
      3034>>IF       3061>>IF       3075>>IF       3088>>CALL     3098>>IF       3138>>IF       3150>>IF
      3159>>CALL     3161>>IF       3183>>IF       3251>>IF
B$PS1$
        54**DCL      2818>>ASSIGN   2850>>ASSIGN   2862>>ASSIGN   2919>>ASSIGN   2922>>ASSIGN   2929>>ASSIGN
B$PS2$
        55**DCL      2872>>ASSIGN   3014<>CALL
B$U.FLG.DBRK
      1613**DCL      3263>>IF
B$U.MISC
      1695**DCL      1696--REDEF
B$USER.MISC
      1771**DCL      1772--REDEF
PL6.E3A0      #001=FMI$RAN File=FMI$RAN.:E05TSI                                  TUE 07/29/97 16:49 Page:121  
BADBLK
      2967**LABEL    2887--GOTO     2960--GOTO     2988--GOTO
BLKSIZ
        21**DCL      2821<<ASSIGN   2842>>ASSIGN   2897<<ASSIGN   2899<<ASSIGN   2900<>CALL     2939<<ASSIGN
      2941<<ASSIGN   2944>>IF       2961>>IF       2961>>IF       2990>>ASSIGN   3013>>IF       3034>>IF
      3058>>ASSIGN   3059>>IF       3135>>ASSIGN   3136>>IF       3187>>ASSIGN   3187>>ASSIGN   3342>>IF
      3346>>ASSIGN   3349>>ASSIGN   3354>>IF
BUFDISP
        24**DCL      3051<<ASSIGN   3056>>DOWHILE  3095>>ASSIGN   3101<<ASSIGN   3101>>ASSIGN   3114>>DOWHILE
      3122>>CALL     3129>>ASSIGN   3163<<ASSIGN   3163>>ASSIGN
BUFSIZ
        25**DCL      3048<<ASSIGN   3049>>IF       3050<<ASSIGN   3056>>DOWHILE  3104>>CALL     3106>>DOINDEX
      3113>>CALL     3114>>DOWHILE  3168>>ASSIGN
B_SITEINFO.SITE_ID
      2766**DCL      3296>>CALLBLT
CFU$
        16**DCL      2682--IMP-PTR  2772<<ASSIGN   2778>>ASSIGN   3034>>IF       3054>>ASSIGN   3257>>ASSIGN
      3347>>IF
CHAR1
        44**DCL      3199>>ASSIGN
CHAR4
        45**DCL      2818<<ASSIGN   2818>>ASSIGN   2850<<ASSIGN   2850>>ASSIGN   2862<<ASSIGN   2862>>ASSIGN
      2872<<ASSIGN   2872>>ASSIGN   2919<<ASSIGN   2919>>ASSIGN   2922<<ASSIGN   2922>>ASSIGN   2929<<ASSIGN
      2929>>ASSIGN
CHARS
      2769**DCL      3082<<ASSIGN   3082>>ASSIGN   3360<<ASSIGN   3378<<ASSIGN   3378>>ASSIGN
CLEAR
        46**DCL      3092<<ASSIGN
CLR.X
        50**DCL      3124<<ASSIGN   3338<<ASSIGN
DA
        20**DCL      2892<<ASSIGN   2894<<ASSIGN   2900<>CALL     2902<>CALL     2903<<ASSIGN   2903>>ASSIGN
      3046<<ASSIGN   3047>>ASSIGN   3055>>ASSIGN   3095>>ASSIGN   3104<>CALL     3107>>CALL     3113<>CALL
      3122>>CALL     3185<<ASSIGN   3186>>ASSIGN   3215>>ASSIGN   3227<>CALL     3258<>CALL     3260<>CALL
      3283<<ASSIGN   3288>>ASSIGN   3300<>CALL     3302<>CALL     3317<<ASSIGN   3319>>ASSIGN   3320<>CALL
      3321<>CALL     3329<>CALL     3337<>CALL     3366<<ASSIGN   3366>>ASSIGN
PL6.E3A0      #001=FMI$RAN File=FMI$RAN.:E05TSI                                  TUE 07/29/97 16:49 Page:122  
DELERR
      2908**LABEL    2861--CALLALT
DELR20
      2886**LABEL    2871--CALLALT
DELR30
      2889**LABEL    2884--GOTO
DESC
        32**DCL      3014<>CALL
DESC.BASE
        36**DCL      3015>>IF       3204>>ASSIGN   3205>>ASSIGN
DESC.WSR
        34**DCL      3201>>ASSIGN
DEVPACK
      3274**LABEL    3030--GOTO
DIRIO
      3182**LABEL    3037--GOTO
ERRBADBLK
      2559**DCL      2838>>ASSIGN   2967>>ASSIGN
ERRBADVECT2
      2583**DCL      2947>>ASSIGN
ERRBOF
      2555**DCL      2827>>ASSIGN
ERRDI
      2575**DCL      3126>>ASSIGN   3322>>ASSIGN   3340>>ASSIGN
ERREOF
      2551**DCL      2835>>ASSIGN   2980>>ASSIGN
ERRLD
      2563**DCL      2993>>ASSIGN   3007>>ASSIGN   3162>>ASSIGN   3184>>ASSIGN   3286>>ASSIGN
ERRMTRAP
      2571**DCL      3305>>ASSIGN
ERRRANBOUND
      2567**DCL      3009>>ASSIGN   3017>>ASSIGN
ERRWRDEL
      2579**DCL      2908>>ASSIGN
F$CFU$
       939**DCL      2621--IMP-PTR  2626--IMP-PTR  3289>>ASSIGN   3290>>DOWHILE  3291>>ASSIGN   3292>>ASSIGN
PL6.E3A0      #001=FMI$RAN File=FMI$RAN.:E05TSI                                  TUE 07/29/97 16:49 Page:123  
F$DCB.ACS
      2649**DCL      2901>>IF       2938>>IF       2944>>IF       3032>>IF       3034>>IF       3075>>IF
      3096>>IF       3105>>IF       3119>>IF       3119>>IF       3150>>IF       3221>>IF       3221>>IF
      3250>>IF       3259>>IF
F$DCB.ACTPOS
      2657**DCL      2657--REDEF
F$DCB.ARS
      2632**DCL      2632--REDEF    2842<<ASSIGN   2843>>IF       2844<<ASSIGN   2844>>ASSIGN   2857<<ASSIGN
      2890<<ASSIGN   3207<<ASSIGN   3278<<ASSIGN   3356>>ASSIGN   3357>>ASSIGN   3358>>ASSIGN   3381<<ASSIGN
      3381>>ASSIGN
F$DCB.ASN
      2647**DCL      2775>>IF       2858>>IF       2864>>IF       2868>>IF       2874>>IF       2891>>IF
      2938>>IF       2956>>IF       3030>>IF
F$DCB.ATTR
      2650**DCL      2651--REDEF
F$DCB.BFR.BUFUP
      2676**DCL      3169<<ASSIGN   3367<<ASSIGN
F$DCB.BFR.BUFX
      2677**DCL      3040>>IF       3103>>ASSIGN   3170>>ASSIGN   3314>>IF       3325>>IF       3328>>ASSIGN
      3332>>ASSIGN
F$DCB.BFR.DA
      2677**DCL      3055<<ASSIGN
F$DCB.BFR1.FLAGS.ONE_WORD_HEADER
      2677**DCL      3044<<ASSIGN
F$DCB.BFR1.SIZ
      2677**DCL      3040>>IF       3314>>IF
F$DCB.BORROW
      2665**DCL      2665--REDEF    2665--REDEF    2665--REDEF
F$DCB.CFU$
      2666**DCL      2772>>ASSIGN
F$DCB.CRECNO
      2669**DCL      2795<<ASSIGN   2804<<ASSIGN   2814<<ASSIGN   2816<<ASSIGN   2818--ASSIGN   2821>>ASSIGN
      2822<<ASSIGN   2822>>ASSIGN   2824>>IF       2824>>IF       2825>>IF       2826<<ASSIGN   2833>>IF
      2834<<ASSIGN   2842>>ASSIGN   2850--ASSIGN   2919--ASSIGN   2922--ASSIGN   2929--ASSIGN   2957>>IF
      2958<<ASSIGN   2958>>ASSIGN   2959>>IF       2961>>IF       2964>>IF       2968<<ASSIGN   2978>>IF
      2990>>ASSIGN   3034>>IF       3046>>ASSIGN   3129>>ASSIGN   3168<<ASSIGN   3168>>ASSIGN   3185>>ASSIGN
PL6.E3A0      #001=FMI$RAN File=FMI$RAN.:E05TSI                                  TUE 07/29/97 16:49 Page:124  
      3187<<ASSIGN   3187>>ASSIGN   3283>>ASSIGN   3284<<ASSIGN   3284>>ASSIGN   3317>>ASSIGN   3347>>IF
      3370<<ASSIGN   3370>>ASSIGN
F$DCB.DCBNAME.L
      2679**DCL      2679--IMP-SIZ
F$DCB.EOMCHAR
      2636**DCL      2636--REDEF
F$DCB.EOP
      2661**DCL      2936<<ASSIGN   3266<<ASSIGN
F$DCB.FLDID
      2660**DCL      2660--REDEF
F$DCB.FORM$
      2654**DCL      2654--REDEF
F$DCB.FSECT
      2670**DCL      2670--REDEF
F$DCB.FSN
      2647**DCL      2647--REDEF    2647--REDEF    2648--REDEF
F$DCB.FUN
      2646**DCL      2901>>IF       3105>>IF       3259>>IF
F$DCB.GDISP
      2671**DCL      3057<<ASSIGN   3115<<ASSIGN
F$DCB.HASH
      2669**DCL      3031>>ASSIGN   3094>>ASSIGN
F$DCB.HEADER$
      2653**DCL      2653--REDEF
F$DCB.IXTNSIZE
      2651**DCL      2651--REDEF
F$DCB.LASTSTA$
      2641**DCL      2641--REDEF
F$DCB.LVL
      2666**DCL      2666--REDEF
F$DCB.NAME.C
      2641**DCL      2641--REDEF
F$DCB.NOEOF
      2662**DCL      2662--REDEF
F$DCB.NRECS
      2652**DCL      2652--REDEF
PL6.E3A0      #001=FMI$RAN File=FMI$RAN.:E05TSI                                  TUE 07/29/97 16:49 Page:125  
F$DCB.NRECX
      2671**DCL      2671--REDEF
F$DCB.OHDR
      2663**DCL      2663--REDEF
F$DCB.ORG
      2646**DCL      2646--REDEF    3043>>IF       3043>>IF       3075>>IF       3096>>IF       3119>>IF
      3119>>IF       3119>>IF       3119>>IF       3150>>IF       3221>>IF       3221>>IF       3221>>IF
      3221>>IF       3250>>IF       3335>>IF       3335>>IF       3335>>IF       3335>>IF
F$DCB.PRECNO
      2669**DCL      2669--REDEF
F$DCB.RCSZ
      2674**DCL      2674--REDEF
F$DCB.RES
      2642**DCL      2642--REDEF
F$DCB.SEED
      2660**DCL      3034>>IF       3061>>IF       3075>>IF       3138>>IF       3150>>IF
F$DCB.SETX
      2654**DCL      2654--REDEF    2776>>ASSIGN   3289>>ASSIGN
F$DCB.TAB$
      2653**DCL      2654--REDEF
F$DCB.TDA
      2668**DCL      2668--REDEF
F$DCB.UB$
      2670**DCL      3068<<ASSIGN   3068>>ASSIGN   3082>>ASSIGN   3085<<ASSIGN   3085>>ASSIGN   3189>>ASSIGN
      3199>>ASSIGN   3227<>CALL     3258<>CALL     3295>>CALL     3297>>ASSIGN   3300<>CALL     3357>>ASSIGN
      3378>>ASSIGN   3379<<ASSIGN   3379>>ASSIGN
F$DCB.UBYTES
      2670**DCL      2944>>IF       2961>>IF       2990<<ASSIGN   3005>>IF       3015>>IF       3034>>IF
      3038>>ASSIGN   3045>>DOWHILE  3048>>ASSIGN   3064>>IF       3065<<ASSIGN   3067<<ASSIGN   3067>>ASSIGN
      3078>>IF       3079>>ASSIGN   3084<<ASSIGN   3084>>ASSIGN   3140>>IF       3141>>ASSIGN   3153>>IF
      3154>>ASSIGN   3183>>IF       3187>>ASSIGN   3188>>ASSIGN   3199>>ASSIGN   3205>>ASSIGN   3207>>ASSIGN
      3227<>CALL     3258<>CALL     3278>>ASSIGN   3284>>ASSIGN   3285>>IF       3300<>CALL     3316>>ASSIGN
      3349>>ASSIGN   3380<<ASSIGN   3380>>ASSIGN
F$DCB.WSN
      2643**DCL      2643--REDEF
FC
PL6.E3A0      #001=FMI$RAN File=FMI$RAN.:E05TSI                                  TUE 07/29/97 16:49 Page:126  
        27**DCL      2812<<ASSIGN   2820<<ASSIGN   2841>>IF       3277<<ASSIGN   3281<<ASSIGN   3287>>IF
      3300<>CALL     3301>>IF       3320<>CALL     3324>>IF
FM$BUF$
        56**DCL      3103>>ASSIGN   3170>>ASSIGN   3328>>ASSIGN   3332>>ASSIGN
FM$CFU.ACCTX
      2683**DCL      2683--REDEF
FM$CFU.AFIT
      2682**DCL      3034>>IF       3347>>IF
FM$CFU.FMOD
      2682**DCL      3054<<ASSIGN   3257<<ASSIGN
FM$CFU.UGRANS
      2684**DCL      2778>>ASSIGN
FM$GRAN.FCEX
      2618**DCL      3349>>ASSIGN   3362>>ASSIGN
FM$GRAN.STAMP
      2617**DCL      3116>>IF       3334>>IF
FM$GRAN.STAMP.GMOD
      2617**DCL      3095<<ASSIGN
FM$GRAN.STAMP.HASH
      2617**DCL      3094<<ASSIGN
FM$RANEA.BLKNO
      2688**DCL      3215<<ASSIGN
FM$RANEA.CNT
      2688**DCL      3213<<ASSIGN   3231<<ASSIGN   3231>>ASSIGN   3232>>IF
FM$RANEA.PGS
      2688**DCL      3217<<ASSIGN
FM$RANEA.STAMP
      2688**DCL      3214<<ASSIGN
FM$RANEA.TYP
      2688**DCL      3224<<ASSIGN   3226<<ASSIGN
FM$RANEA.VPNO
      2688**DCL      3216<<ASSIGN
FM$SET.DCTX
      2621**DCL      3289>>ASSIGN
FM$SET.NXTSDA
      2623**DCL      2776>>ASSIGN
PL6.E3A0      #001=FMI$RAN File=FMI$RAN.:E05TSI                                  TUE 07/29/97 16:49 Page:127  
FM$SET.USERLIST
      2622**DCL      2622--REDEF
FM$SET$
       940**DCL      2776>>ASSIGN
FM$VID.DTT
      2693**DCL      2693--REDEF
FM$VID.INITTIME
      2692**DCL      3295<>CALL
FM$VID.INSTID
      2691**DCL      3297<<ASSIGN
FM$VOL.NXTSDA
      2628**DCL      3290>>DOWHILE  3291>>ASSIGN
FM$VOL.USERLIST
      2627**DCL      2628--REDEF
FM$VOL.VOLL
      2628**DCL      3292>>ASSIGN
FMB$IOSPIN
      2526**DCL-ENT  3264--CALL
FMB$LOGERR
      2524**DCL-ENT  3122--CALL     3321--CALL     3337--CALL
FMB$QUEUE
      2525**DCL-ENT  2900--CALL     3104--CALL     3113--CALL     3227--CALL     3258--CALL     3300--CALL
      3329--CALL
FMC$CLR1
      2527**DCL-ENT  2902--CALL     3107--CALL     3260--CALL     3302--CALL
FMC$GET
      2528**DCL-ENT  3320--CALL
FMD$GETBUF
      2530**DCL-ENT  3042--CALL     3326--CALL
FMD$RECTRAN
      2531**DCL-ENT  3088--CALL     3159--CALL
FMD$RELBUF
      2532**DCL-ENT  3041--CALL     3315--CALL     3368--CALL
FMI$EA
      2533**DCL-ENT  3227--CALL
FMO$LOCCODT
PL6.E3A0      #001=FMI$RAN File=FMI$RAN.:E05TSI                                  TUE 07/29/97 16:49 Page:128  
      2534**DCL-ENT  3353--CALL
FM_EOP
       937**DCL      3266>>ASSIGN
FM_FRZERO
       936**DCL      2894>>ASSIGN   3046>>ASSIGN   3185>>ASSIGN   3215>>ASSIGN   3317>>ASSIGN
FM_SRZERO
       936**DCL      2776>>ASSIGN   2865>>IF       2866>>ASSIGN   2875>>IF       2876>>ASSIGN   2892>>ASSIGN
      2957>>IF       2958>>ASSIGN   3283>>ASSIGN   3291>>ASSIGN   3294>>IF
FPT$DELREC_V.DELALL
      2612**DCL      2858>>IF       2868>>IF
FPT$PFIL_V.BOF
      2601**DCL      2801>>IF
FPT$PRECORD_V.BOF
      2607**DCL      2813>>IF
FPT$PRECORD_V.EOF
      2607**DCL      2815>>IF
FPT$PRECORD_V.KEYR
      2607**DCL      2849>>IF
FPT$PRECORD_V.KEYS
      2607**DCL      2817>>IF       2837>>IF
FPT$PRECORD_V.N
      2608**DCL      2822>>ASSIGN
FPT$READ_V.DVBYTE.REREAD
      2590**DCL      2591--REDEF
FPT$READ_V.FULL
      2588**DCL      2938>>IF       2944>>IF
FPT$READ_V.INDX
      2590**DCL      2590--REDEF
FPT$READ_V.KEYR
      2588**DCL      2921>>IF
FPT$READ_V.KEYS
      2588**DCL      2918>>IF       2979>>IF       3161>>IF       3183>>IF
FPT$READ_V.SEED
      2590**DCL      3034>>IF       3138>>IF       3150>>IF       3159<>CALL
FPT$WRITE_V.DVBYTE.VFC
      2597**DCL      2597--REDEF
PL6.E3A0      #001=FMI$RAN File=FMI$RAN.:E05TSI                                  TUE 07/29/97 16:49 Page:129  
FPT$WRITE_V.NOTIME
      2596**DCL      3098>>IF       3251>>IF
FPT$WRITE_V.SEED
      2596**DCL      3061>>IF       3075>>IF       3088<>CALL
FPTCODE
        13**DCL        11--PROC     2780>>DOCASE   2944>>IF       2979>>IF       2991>>IF       3006>>IF
      3034>>IF       3053>>IF       3182>>IF       3190>>DOCASE   3266>>ASSIGN   3274>>DOCASE
F_DCBLOCK
       938**DCL      3229<>CALL     3234<>CALL     3244<>CALL
G$
        17**DCL      3042<>CALL     3060>>ASSIGN   3074>>ASSIGN   3094>>ASSIGN   3095>>ASSIGN   3099>>CALL
      3100<<ASSIGN   3100>>ASSIGN   3103<<ASSIGN   3104<>CALL     3113<>CALL     3116>>IF       3122<>CALL
      3124>>ASSIGN   3125>>ASSIGN   3129>>ASSIGN   3137>>ASSIGN   3149>>ASSIGN   3164<<ASSIGN   3164>>ASSIGN
      3170<<ASSIGN   3320<>CALL     3326<>CALL     3328<<ASSIGN   3329<>CALL     3332<<ASSIGN   3334>>IF
      3337<>CALL     3338>>ASSIGN   3339>>ASSIGN   3343>>ASSIGN   3345>>ASSIGN   3349>>ASSIGN   3352>>ASSIGN
      3356>>ASSIGN   3362>>ASSIGN   3362>>ASSIGN
GBYTES
        19**DCL        46--IMP-SIZ  3058<<ASSIGN   3063<<ASSIGN   3063>>ASSIGN   3077<<ASSIGN   3077>>ASSIGN
      3087>>ASSIGN   3088<>CALL     3089>>IF       3090>>ASSIGN   3091<<ASSIGN   3091>>ASSIGN   3092>>ASSIGN
      3135<<ASSIGN   3145<<ASSIGN   3145>>ASSIGN   3152<<ASSIGN   3152>>ASSIGN   3159<>CALL     3160>>IF
      3346<<ASSIGN   3351<<ASSIGN   3351>>ASSIGN   3364>>ASSIGN
HFC$LOCK
       552**DCL-ENT  3229--CALL
HFC$STWS
      2535**DCL-ENT  3202--CALL
HFC$UNLOCK
       552**DCL-ENT  3234--CALL     3244--CALL
HFF$NILERASE
      2536**DCL-ENT  2861--CALL     2871--CALL     2928--CALL     3280--CALL
HFF$RET_PS_DESC
      2537**DCL-ENT  3014--CALL
HFF$WRITE1
      2538**DCL-ENT  3020--CALL     3276--CALL
I
        23**DCL      3106<<DOINDEX  3107>>CALL     3318<<DOINDEX  3347>>IF
JDCB$
PL6.E3A0      #001=FMI$RAN File=FMI$RAN.:E05TSI                                  TUE 07/29/97 16:49 Page:130  
        15**DCL      2632--IMP-PTR  2771<<ASSIGN   2772>>ASSIGN   2775>>IF       2776>>ASSIGN   2795>>ASSIGN
      2804>>ASSIGN   2814>>ASSIGN   2816>>ASSIGN   2818>>ASSIGN   2821>>ASSIGN   2822>>ASSIGN   2822>>ASSIGN
      2824>>IF       2824>>IF       2825>>IF       2826>>ASSIGN   2833>>IF       2834>>ASSIGN   2842>>ASSIGN
      2842>>ASSIGN   2843>>IF       2844>>ASSIGN   2844>>ASSIGN   2850>>ASSIGN   2857>>ASSIGN   2858>>IF
      2864>>IF       2868>>IF       2874>>IF       2890>>ASSIGN   2891>>IF       2901>>IF       2901>>IF
      2919>>ASSIGN   2922>>ASSIGN   2929>>ASSIGN   2936>>ASSIGN   2938>>IF       2938>>IF       2944>>IF
      2944>>IF       2956>>IF       2957>>IF       2958>>ASSIGN   2958>>ASSIGN   2959>>IF       2961>>IF
      2961>>IF       2964>>IF       2968>>ASSIGN   2978>>IF       2990>>ASSIGN   2990>>ASSIGN   3005>>IF
      3015>>IF       3030>>IF       3031>>ASSIGN   3032>>IF       3034>>IF       3034>>IF       3034>>IF
      3034>>IF       3038>>ASSIGN   3040>>IF       3040>>IF       3043>>IF       3043>>IF       3044>>ASSIGN
      3045>>DOWHILE  3046>>ASSIGN   3048>>ASSIGN   3055>>ASSIGN   3057>>ASSIGN   3061>>IF       3064>>IF
      3065>>ASSIGN   3067>>ASSIGN   3067>>ASSIGN   3068>>ASSIGN   3068>>ASSIGN   3075>>IF       3075>>IF
      3075>>IF       3078>>IF       3079>>ASSIGN   3082>>ASSIGN   3084>>ASSIGN   3084>>ASSIGN   3085>>ASSIGN
      3085>>ASSIGN   3094>>ASSIGN   3096>>IF       3096>>IF       3103>>ASSIGN   3105>>IF       3105>>IF
      3115>>ASSIGN   3119>>IF       3119>>IF       3119>>IF       3119>>IF       3119>>IF       3119>>IF
      3129>>ASSIGN   3138>>IF       3140>>IF       3141>>ASSIGN   3150>>IF       3150>>IF       3150>>IF
      3153>>IF       3154>>ASSIGN   3168>>ASSIGN   3168>>ASSIGN   3169>>ASSIGN   3170>>ASSIGN   3183>>IF
      3185>>ASSIGN   3187>>ASSIGN   3187>>ASSIGN   3187>>ASSIGN   3188>>ASSIGN   3189>>ASSIGN   3199>>ASSIGN
      3199>>ASSIGN   3205>>ASSIGN   3207>>ASSIGN   3207>>ASSIGN   3221>>IF       3221>>IF       3221>>IF
      3221>>IF       3221>>IF       3221>>IF       3227>>CALL     3227>>CALL     3250>>IF       3250>>IF
      3258>>CALL     3258>>CALL     3259>>IF       3259>>IF       3266>>ASSIGN   3278>>ASSIGN   3278>>ASSIGN
      3283>>ASSIGN   3284>>ASSIGN   3284>>ASSIGN   3284>>ASSIGN   3285>>IF       3289>>ASSIGN   3295>>CALL
      3297>>ASSIGN   3300>>CALL     3300>>CALL     3314>>IF       3314>>IF       3316>>ASSIGN   3317>>ASSIGN
      3325>>IF       3328>>ASSIGN   3332>>ASSIGN   3335>>IF       3335>>IF       3335>>IF       3335>>IF
      3347>>IF       3349>>ASSIGN   3356>>ASSIGN   3357>>ASSIGN   3357>>ASSIGN   3358>>ASSIGN   3367>>ASSIGN
      3370>>ASSIGN   3370>>ASSIGN   3378>>ASSIGN   3379>>ASSIGN   3379>>ASSIGN   3380>>ASSIGN   3380>>ASSIGN
      3381>>ASSIGN   3381>>ASSIGN
MEMERR
      3305**LABEL    3014--CALLALT  3020--CALLALT  3276--CALLALT  3280--CALLALT
MMC$CP_IOM
      2539**DCL-ENT  3236--CALL
MMC$ONLY_IOM
      2540**DCL-ENT  3206--CALL
MOV2USR
      3376**PROC     3144--CALL     3157--CALL     3350--CALL     3365--CALL
N
PL6.E3A0      #001=FMI$RAN File=FMI$RAN.:E05TSI                                  TUE 07/29/97 16:49 Page:131  
        22**DCL      2769--IMP-SIZ  2889<<ASSIGN   2890>>ASSIGN   2895>>DOWHILE  2896>>IF       2899>>ASSIGN
      2904<<ASSIGN   2904>>ASSIGN   3038<<ASSIGN   3039>>IF       3039<<ASSIGN   3040>>IF       3042<>CALL
      3079<<ASSIGN   3081<<ASSIGN   3082>>ASSIGN   3082>>ASSIGN   3084>>ASSIGN   3141<<ASSIGN   3143<<ASSIGN
      3154<<ASSIGN   3156<<ASSIGN   3188<<ASSIGN   3194>>DOWHILE  3197<<ASSIGN   3197>>ASSIGN   3201<<ASSIGN
      3203>>ASSIGN   3205<<ASSIGN   3206<>CALL     3217>>ASSIGN   3236<>CALL     3248>>DOWHILE  3255<<ASSIGN
      3255>>ASSIGN   3289<<ASSIGN   3290>>DOWHILE  3291>>ASSIGN   3292<<ASSIGN   3292>>ASSIGN   3349<<ASSIGN
      3351>>ASSIGN   3356<<ASSIGN   3357>>ASSIGN   3358<<ASSIGN   3358>>ASSIGN   3359>>IF       3360>>ASSIGN
      3364<<ASSIGN   3377>>IF       3378>>ASSIGN   3378>>ASSIGN   3379>>ASSIGN   3380>>ASSIGN   3381>>ASSIGN
N$REQ
      2705**DCL      3237<<ASSIGN
N$REQ.BUFADDR
      2714**DCL      2715--REDEF    2715--REDEF
N$REQ.DLA.DRELADDR
      2706**DCL      2706--REDEF
N$REQ.DVE.EOMCHAR
      2743**DCL      2744--REDEF
N$REQ.EAINFO
      2737**DCL      2737--REDEF
N$REQ.EAINFOX
      2737**DCL      2738--REDEF
N$REQ.ERR$
      2727**DCL      3238<<ASSIGN
N$REQ.EVNTINFO
      2738**DCL      2738--REDEF
N$REQ.IOFLG.IOS
      2709**DCL      3209>>IF       3211<<ASSIGN
N$REQ.IOQFLG.INUSE
      2748**DCL      3239<<ASSIGN
N$REQ.IOS$
      2718**DCL      3210<>CALL
N$REQ.STATUS
      2719**DCL      2725--REDEF
NIQ$GET
      2541**DCL-ENT  3208--CALL
NIQ$REL
      2542**DCL-ENT  3172--CALL     3240--CALL
PL6.E3A0      #001=FMI$RAN File=FMI$RAN.:E05TSI                                  TUE 07/29/97 16:49 Page:132  
NIQ$RELS
      2543**DCL-ENT  3210--CALL
P$
        18**DCL      2688--IMP-PTR  3060<<ASSIGN   3069<<ASSIGN   3069>>ASSIGN   3074<<ASSIGN   3082>>ASSIGN
      3083<<ASSIGN   3083>>ASSIGN   3088<>CALL     3090<<ASSIGN   3090>>ASSIGN   3092>>ASSIGN   3137<<ASSIGN
      3149<<ASSIGN   3159<>CALL     3208<>CALL     3209>>IF       3210>>CALL     3211>>ASSIGN   3213>>ASSIGN
      3214>>ASSIGN   3215>>ASSIGN   3216>>ASSIGN   3217>>ASSIGN   3224>>ASSIGN   3226>>ASSIGN   3227<>CALL
      3231>>ASSIGN   3231>>ASSIGN   3232>>IF       3237>>ASSIGN   3238>>ASSIGN   3239>>ASSIGN   3240<>CALL
      3343<<ASSIGN   3345<<ASSIGN   3352<<ASSIGN   3353<>CALL     3355<<ASSIGN   3355>>ASSIGN   3356>>ASSIGN
      3357<<ASSIGN   3360>>ASSIGN   3362<<ASSIGN   3378>>ASSIGN   3383<<ASSIGN   3383>>ASSIGN
PFILEOF
      2804**LABEL    2790--GOTO
PREC2
      2820**LABEL    2847--GOTO
Q$
        41**DCL      3052<<ASSIGN   3113<>CALL     3122<>CALL     3171>>IF       3172<>CALL     3173<<ASSIGN
READ_UBLOCK
      3301**LABEL    3033--GOTO
REW
      2795**LABEL    2802--GOTO
RWCOM
      2936**LABEL    2928--CALLALT
S$CU$
      1782**DCL      3263>>IF
SCHEDDO
      3262**LABEL    2948--GOTO     2969--GOTO     2981--GOTO     3010--GOTO     3018--GOTO     3177--GOTO
      3303--GOTO     3306--GOTO     3371--GOTO
SETEOP
      3266**LABEL    2851--GOTO     2881--GOTO     2906--GOTO     2909--GOTO
SSS$SYSTIME
      2544**DCL-ENT  3099--CALL     3252--CALL     3295--CALL
STAMP
        38**DCL      3116>>IF       3122<>CALL     3214>>ASSIGN   3249>>ASSIGN   3296<<CALLBLT  3297>>ASSIGN
      3334>>IF       3337<>CALL
STAMP.GMOD
        40**DCL      3047<<ASSIGN   3165<<ASSIGN   3165>>ASSIGN   3186<<ASSIGN   3253<<ASSIGN   3253>>ASSIGN
PL6.E3A0      #001=FMI$RAN File=FMI$RAN.:E05TSI                                  TUE 07/29/97 16:49 Page:133  
      3319<<ASSIGN
STAMP.HASH
        39**DCL      3031<<ASSIGN
TEMP_CHAR
        42**DCL      3199<<ASSIGN   3200>>ASSIGN
UB$
        28**DCL      3189<<ASSIGN   3195>>ASSIGN   3196<<ASSIGN   3196>>ASSIGN   3249>>ASSIGN   3252>>CALL
      3254<<ASSIGN   3254>>ASSIGN
UGRANS
        26**DCL      2776<<ASSIGN   2778<<ASSIGN   2804>>ASSIGN   2816>>ASSIGN   2824>>IF       2833>>IF
      2834>>ASSIGN   2869>>ASSIGN   2877>>IF       2878>>ASSIGN   2961>>IF       2964>>IF       2968>>ASSIGN
      2978>>IF       2990>>ASSIGN
VPNO
        29**DCL      2859<<ASSIGN   2862--ASSIGN   2865>>IF       2866<<ASSIGN   2866>>ASSIGN   2867>>ASSIGN
      2879>>IF       2883<<ASSIGN   2886>>IF       2889>>ASSIGN   2892>>ASSIGN   2894>>ASSIGN   3087<<ASSIGN
      3089>>IF       3091>>ASSIGN   3204<<ASSIGN   3205>>ASSIGN   3206<>CALL     3216>>ASSIGN   3236<>CALL
      3316<<ASSIGN   3318>>DOINDEX  3370>>ASSIGN
WRDS
        47**DCL      3099<>CALL     3125<<ASSIGN   3129<<ASSIGN   3195>>ASSIGN   3249<<ASSIGN   3252<>CALL
      3339<<ASSIGN
WSQ
        37**DCL      2867<<ASSIGN   2869<<ASSIGN   2872--ASSIGN   2875>>IF       2876<<ASSIGN   2876>>ASSIGN
      2877>>IF       2878<<ASSIGN   2880>>IF       2889>>ASSIGN   3195<<ASSIGN   3200<<ASSIGN   3203<<ASSIGN
      3206<>CALL     3236<>CALL     3288<<ASSIGN   3290>>DOWHILE  3291<<ASSIGN   3291>>ASSIGN   3294>>IF
WSRS
        30**DCL      3202<>CALL
WSRS.R
        31**DCL      3203>>ASSIGN
XLATE926
      2754**DCL      3296>>CALLBLT
PL6.E3A0      #001=FMI$RAN File=FMI$RAN.:E05TSI                                  TUE 07/29/97 16:49 Page:134  
              *** CROSS REFERENCE LISTING ***
    **     DENOTES     IDENTIFIER DEFINITION
    <<                 IDENTIFIER'S VALUE SET
    >>                 IDENTIFIER'S VALUE USED
    <>                 IDENTIFIER SET AND/OR USED
    --                 IDENTIFIER REFERENCED
PL6.E3A0      #001=FMI$RAN File=FMI$RAN.:E05TSI                                  TUE 07/29/97 16:49 Page:135  
              MINI UREF LISTING

B$DOCONT    1729**DCL
B$USRT$    1783**DCL
ERR    3268**LABEL
FAG$GEXT    2523**DCL-ENT
FMD$FLSHBUF    2529**DCL-ENT
FMI$RAN      11**PROC
FM_CFUWAIT     939**DCL
FM_CFUWGRB     939**DCL
FM_FRMAX     936**DCL
FM_GCT     940**DCL
FM_GIP     940**DCL
FM_GPSDA     937**DCL
FM_HASH     938**DCL
FM_MADSDA     937**DCL
FM_PADSDA     937**DCL
FM_SRMAX     936**DCL
FM_SYSACCTX     940**DCL
FM_SYSSETX     940**DCL
FM_TRUNC     938**DCL
FM_WSQ     938**DCL
FPT$EXTEND_V    2604**DCL
F_CODE     950**DCL
F_CWLK     939**DCL
F_CWUSER     939**DCL
F_SEV     950**DCL
F_TYCBITS     950**DCL
F_TYCMAX     950**DCL
UQB$MDEQ    2545**DCL-ENT
UQB$MENQXB    2546**DCL-ENT

PL6.E3A0      #002=FMI$INIT File=FMI$RAN.:E05TSI                                 TUE 07/29/97 16:50 Page:136  
      754        1        /*T***********************************************************/
      755        2        /*T*                                                         */
      756        3        /*T* Copyright (c) Bull HN Information Systems Inc., 1997    */
      757        4        /*T*                                                         */
      758        5        /*T***********************************************************/
      759        6        /*F*   NAME:   FMI$INIT
      760        7        *      PURPOSE:  To initialize a newly opened RANDOM file DCB                */
      761        8                                                /*                                    */
      762        9                                                /*                                    */
      763       10                                                /*                                    */
      764       11        /*D*   NAME:   FMI$INIT
      765       12        *      CALL:   CALL FMI$INIT;
      766       13        *       OUTPUT: Various DCB fields initialized
      767       14        *      DESCRIPTION:                                                          */
      768       15                                                /*                                    */
      769       16        FMI$INIT: PROC ALTRET;
      770       17        /* LOCAL AUTOMATIC STORAGE */
      771       18    1   DCL JDCB$ PTR;
      772       19    1   DCL CFU$ PTR;
      773       20    1   DCL TEMP_DCB PTR;
      774       21    1   DCL 1 TEMP_DCB_R REDEF TEMP_DCB,
      775       22    1         2 ADDR_BITS UBIN(18) UNAL,
      776       23    1         2 LS   UBIN(18) UNAL;
      777       24    1   DCL DSACC UBIN;
      778       25    1   DCL DSSID UBIN;
      779       26    1   DCL HEADPP# UBIN;
      780       27    1   DCL DSWSQ UBIN;
      781       28        /* EXTERNAL DATA */
      782       29    1   DCL B$JIT$ PTR SYMREF;
      783       30    1   DCL B$IS$ PTR SYMREF;
      784       31    1   DCL LS0UBIN REDEF B$IS$ UBIN;
      785       32    1   DCL MM_SHAREDSUSE SBIN SYMREF;
      786       33        /* EXTERNAL ROUTINES */
      787       34    1   DCL FMG$INIT ENTRY ALTRET;
      788       35    1   DCL FMH$INIT ENTRY;
      789       36    1   DCL FMI$DSREAD ENTRY(1);
      790       37    1   DCL FMI$DSWRITE ENTRY(1);
PL6.E3A0      #002=FMI$INIT File=FMI$RAN.:E05TSI                                 TUE 07/29/97 16:50 Page:137  
      791       38    1   DCL MMH$MAP_DS ENTRY(8)ALTRET;
      792       39    1   DCL MMH$SHARE_DS ENTRY(8)ALTRET;
      793       40    1   DCL MMH$FDS ENTRY(4)ALTRET;
      794       41    1   DCL MMJ$FPPCHAIN ENTRY(3);
      795       42    1   DCL MMV$CLOSE ENTRY ALTRET;
      796       43    1   DCL UQB$MENQX ENTRY(1) ALTRET;
      797       44    1   DCL UQB$MDEQ ENTRY(1) ALTRET;
      798       45        /* INCLUDE FILES */
      799       46        %INCLUDE B_STRINGS_C;
      800      175        %INCLUDE F$JIT_C;
      801      605        %MACRO F$DCB (BASED="BASED(JDCB$)");
      802      606        %INCLUDE F$DCB;
      803      655        %MEND;
      804      656        %INCLUDE FM$MACROS;
      805     1031        %INCLUDE CP_6_SUBS;
      806     1571        %INCLUDE FM_DATA_R;
      807     1585        %INCLUDE F_ERRORS_C;
      808     1825        %INCLUDE M_INFO_C;
      809     1965        /* CONSTANT DATA */
      810     1966        %SUB FCG#='0615'O;
      811     1967        %SUB MID#='11'O;
      812     1968        %ERRCODE (NAME=ERRCGFILE,COD#=%E$CGFILE);
      813     1972        %ERRCODE (NAME=ERRNOSHRDS,COD#=%E$NOSHRDS);
      814     1976        %ERRCODE(NAME=ERRSHRDS2BIG,COD#=%E$SHRDS2BIG);
      815     1980        %ERRCODE(NAME=ERRNOACCESS,COD#=%E$READ);
      816     1984        %ERRCODE(NAME=ERRNOCODE,COD#=0);
      817     1988        /* BASED STRUCTURES */
      818     1989        %FM$CFU(BASED="BASED(CFU$)");
      819     1995        %FM$CFUR(BASED="BASED(CFU$)");
      820     1998        %F$DCB;
      821     2048                                                /*                                    */
      822     2049    1           JDCB$=B$JIT.DCB$;
      823     2050        /**/
      824     2051    1           IF F$DCB.ORG=%CG# AND F$DCB.ASN=%FILE# THEN
      825     2052    1              IF NOT B$JIT.PRIV.ACTIVE&%PR_FMDIAG# AND
      826     2053    1                (F$DCB.FUN~=%IN# OR NOT(F$DCB.FFLG&(%FFLG_AU#|%FFLG_AURD#))) THEN
      827     2054    1                 IF F$DCB.FFLG.REATTR THEN
PL6.E3A0      #002=FMI$INIT File=FMI$RAN.:E05TSI                                 TUE 07/29/97 16:50 Page:138  
      828     2055    1                    F$DCB.FFLG=F$DCB.FFLG&(%FFLG_NOLIST#|%FFLG_REATTR#|
      829     2056    1                      %FFLG_DELF#|%FFLG_EXEC#);
      830     2057    2                 ELSE DO;
      831     2058    2                    B$JIT.ERR=ERRCGFILE;
      832     2059    2                    ALTRETURN;
      833     2060    2                    END;
      834     2061        /*E*    ERROR: -E$CGFILE-2
      835     2062                MESSAGE: You are not allowed to open comgroup% %UF% as a file
      836     2063        */
      837     2064        /**/
      838     2065                /* Make sure F$DCB.KEYL is set correctly for IREL files when
      839     2066                   opened by XSA$FSF.                                     */
      840     2067    1           IF F$DCB.ORG=%IREL# AND F$DCB.ACS=%UBLOCK# THEN
      841     2068    1              GOTO FMG_INIT;
      842     2069                /* Otherwise, make sure files are fixed up if they weren't
      843     2070                   closed properly before.                             */
      844     2071    1           IF F$DCB.RA THEN
      845     2072    2           DO CASE(F$DCB.ORG);
      846     2073    2            CASE(%CONSEC#,%UR#,%SYMB#,%TERMINAL#);
      847     2074    2              CALL FMH$INIT;
      848     2075    2            CASE(%KEYED#,%INDEXED#,%IREL#);
      849     2076    2   FMG_INIT:  CALL FMG$INIT;
      850     2077    2            END;
      851     2078        /**/
      852     2079                /*
      853     2080                   If we're creating a file with ACS=BLOCK, and hence IFPARAM,
      854     2081                   FMO$BLDFIT already set CRECNO 'cause he knew what kind of
      855     2082                   fit we started with. I.e., granule 0 may have already been
      856     2083                   written if a FIT became an AFIT when we got extents during
      857     2084                   open. Otherwise, set CRECNO here.
      858     2085                */
      859     2086    1           IF NOT(F$DCB.IASN=%FILE# AND F$DCB.ACS=%BLOCK# AND
      860     2087    1             (F$DCB.CFU$->FM$CFU.FUN=%CREATE# OR
      861     2088    1             (F$DCB.CFU$->FM$CFU.FUN=%UPDATE# AND F$DCB.CTG AND
      862     2089    1             F$DCB.FUN=%CREATE#))) THEN
      863     2090    1              F$DCB.CRECNO=0;              /* Current block number               */
      864     2091    2           IF F$DCB.IASN=%FILE# THEN DO;
PL6.E3A0      #002=FMI$INIT File=FMI$RAN.:E05TSI                                 TUE 07/29/97 16:50 Page:139  
      865     2092    2              IF F$DCB.ACS=%BLOCK# AND F$DCB.CFU$->FM$CFU.AFIT=0 THEN
      866     2093    2                 F$DCB.CRECNO=1;           /* BLOCK ACCESS WITH AFIT             */
      867     2094    2              F$DCB.GTYP=FMGTFILE;
      868     2095    2              IF F$DCB.ORG~=%RANDOM# THEN RETURN;
      869     2096    2              IF F$DCB.WSR~=7 THEN DSWSQ=F$DCB.WSR;
      870     2097    2              ELSE DSWSQ=%USERWSQ;
      871     2098    2              DSSID=LS0UBIN+F$DCB.ACS;
      872     2099    2              CFU$=F$DCB.CFU$;
      873     2100    3              IF NOT F$DCB.ENQF THEN DO;
      874     2101    3                 F$DCB.ENQF='1'B;
      875     2102    3                 CALL UQB$MENQX(CFU$);
      876     2103    3                 END;
      877     2104    3              IF FM$CFUR.HEADPP#~=0 THEN DO; /* ALREADY OPEN SHRDS               */
      878     2105    3                 IF F$DCB.ACS<=%JRNL# THEN GOTO SHRDSERR;
      879     2106        /*E*      ERROR: FMI-E$NOSHRDS-E
      880     2107        *         MESSAGE:Shared data segment file %FN must be shared alike.
      881     2108        *         MESSAGE1:All users of %UF must share it in a data segment, or
      882     2109        *         they must all share it normally.
      883     2110        */
      884     2111    3                 IF NOT F$DCB.FFLG.READ THEN GOTO NOACCESS;
      885     2112    3                 F$DCB.NRECS=FM$CFU.NRECS;
      886     2113    3                 IF F$DCB.FFLG&%(FFLG_WNEW#|FFLG_UPD#) THEN DSACC=BITBIN(%MM_DSWRITE#);
      887     2114    3                 ELSE DSACC=BITBIN(%MM_DSREAD#);
      888     2115        /*E*      ERROR: FMI-E$READ-E
      889     2116        *         MESSAGE:DS sharing %of %FN% denied because you can't do anything.
      890     2117        *         MESSAGE1:To share a file %(%UF) % in a data segment, you must be
      891     2118        *         able to read the information therein.
      892     2119        */
      893     2120    3                 HEADPP#=FM$CFUR.HEADPP#;
      894     2121    3                 CALL MMH$MAP_DS(DSWSQ,DSSID,FM$CFU.NRECS*1024-1,B$JIT.ERR,
      895     2122    3                   DSACC,HEADPP#,,FM$CFU.NRECS) ALTRET(MMERR);
      896     2123    3                 IF DSACC=BITBIN(%MM_DSWRITE#) THEN FM$CFU.FMOD='1'B;
      897     2124    3                 RETURN;
      898     2125    3                 END;
      899     2126    3              ELSE IF F$DCB.ACS<=%JRNL# THEN DO;
      900     2127                                      /* Indicate that the mode is now established    */
      901     2128    3                    FM$CFUR.TAILPP#=1;
PL6.E3A0      #002=FMI$INIT File=FMI$RAN.:E05TSI                                 TUE 07/29/97 16:50 Page:140  
      902     2129    3                    RETURN;
      903     2130    3                    END;
      904     2131    2              IF FM$CFUR.TAILPP#~=0 THEN GOTO SHRDSERR;
      905     2132    2              FM$CFU.NRECS=FM$CFU.UGRANS-1;
      906     2133    2              IF FM$CFU.UGRANS=0 THEN FM$CFU.NRECS=F$DCB.XTNSIZE;
      907     2134    2              IF FM$CFU.NRECS>256 OR FM$CFU.NRECS=0 THEN GOTO SHRDS2BIG;
      908     2135        /*E*      ERROR: FMI-E$SHRDS2BIG-E
      909     2136        *         MESSAGE:File %%FN %shared in a data segment must fit there.
      910     2137        *         MESSAGE1:File %FN is > 257k or < 2k, so it cannot be DS shared.
      911     2138        */
      912     2139    2              IF NOT F$DCB.FFLG.READ THEN GOTO NOACCESS;
      913     2140    2              IF F$DCB.FFLG&%(FFLG_WNEW#|FFLG_UPD#) THEN DSACC=BITBIN(%MM_DSWRITE#);
      914     2141    2              ELSE DSACC=BITBIN(%MM_DSREAD#);
      915     2142    2              HEADPP#=0;
      916     2143    2              CALL MMH$SHARE_DS(DSWSQ,DSSID,FM$CFU.NRECS*1024-1,B$JIT.ERR,
      917     2144    2                DSACC,HEADPP#,FM$CFUR.HEADPP#,FM$CFU.NRECS)
      918     2145    2                ALTRET(MMERR);
      919     2146    2              FM$CFUR.HEADPP#=HEADPP#;
      920     2147    2              F$DCB.NRECS=FM$CFU.NRECS;
      921     2148    2              MM_SHAREDSUSE=MM_SHAREDSUSE+FM$CFU.NRECS;
      922     2149    2              IF FM$CFU.UGRANS~=0 THEN CALL FMI$DSREAD(DSWSQ);
      923     2150    2              IF DSACC=BITBIN(%MM_DSWRITE#) THEN FM$CFU.FMOD='1'B;
      924     2151    2              END;
      925     2152    1           RETURN;
      926     2153        /**/
      927     2154    1   SHRDSERR: B$JIT.ERR=ERRNOSHRDS;
      928     2155    1           ALTRETURN;
      929     2156        /**/
      930     2157    1   SHRDS2BIG: B$JIT.ERR=ERRSHRDS2BIG;
      931     2158    1           ALTRETURN;
      932     2159        /**/
      933     2160    1   NOACCESS: B$JIT.ERR=ERRNOACCESS;
      934     2161    1           ALTRETURN;
      935     2162        /**/
      936     2163    1   MMERR:  ;
      937     2164    1           B$JIT.ERR=BINBIT(BITBIN(B$JIT.ERR),33)|ERRNOCODE;
      938     2165    1           ALTRETURN;
PL6.E3A0      #002=FMI$INIT File=FMI$RAN.:E05TSI                                 TUE 07/29/97 16:50 Page:141  
      939     2166        %EJECT;
PL6.E3A0      #002=FMI$INIT File=FMI$RAN.:E05TSI                                 TUE 07/29/97 16:50 Page:142  
      940     2167        /*F*   NAME:   FMI$DSREL
      941     2168        *      PURPOSE: Release a shared data segment at close time.
      942     2169        *      INTERFACE: MMH$FDS - free the data segment.
      943     2170        *                 FMI$DSWRITE - save the data in the segment.
      944     2171        *                 MMJ$FPPCHAIN - free the physical pages.
      945     2172        *      DESCRIPTION: If this is not the last user, just release the segment.
      946     2173        *        Otherwise, if any user could have stored in it, write the segment
      947     2174        *        to the file before freeing it and releasing the page chain.
      948     2175        */
      949     2176    1   FMI$DSREL: ENTRY ALTRET;
      950     2177    1           JDCB$=B$JIT.DCB$;
      951     2178    1           CFU$=F$DCB.CFU$;
      952     2179    1           TEMP_DCB = F$DCB.LASTSTA$;
      953     2180    1           TEMP_DCB_R.ADDR_BITS = 0;
      954     2181    1           IF F$DCB.IORG = %KEYED# AND TEMP_DCB ~=ADDR(NIL)
      955     2182    2           THEN DO;
      956     2183    2              CALL MMV$CLOSE;
      957     2184    2              RETURN;
      958     2185    2              END;
      959     2186    1           IF F$DCB.ORG~=%RANDOM# OR FM$CFUR.HEADPP#=0 OR F$DCB.FFLG='0'B THEN
      960     2187    1              RETURN;
      961     2188    1           CALL UQB$MENQX (CFU$);
      962     2189    1           DSSID=LS0UBIN+F$DCB.ACS;
      963     2190    1           DSWSQ=F$DCB.WSR;
      964     2191    1           IF DSWSQ=7 THEN DSWSQ=%USERWSQ;
      965     2192    1           DSACC=0;
      966     2193    1           HEADPP#=FM$CFUR.HEADPP#;
      967     2194    1           CALL MMH$MAP_DS(DSWSQ,DSSID,FM$CFU.NRECS*1024-1,DSACC,,
      968     2195    1             HEADPP#,,FM$CFU.NRECS);
      969     2196    1           IF DSACC~=0 THEN RETURN;
      970     2197    2           IF FM$CFU.USECNT=1 THEN DO;
      971     2198    2              IF FM$CFU.FMOD AND FM$CFU.UGRANS~=0 AND FM$CFU.NAMEX~=0
      972     2199    2              THEN CALL FMI$DSWRITE(DSWSQ);
      973     2200    2              FM$CFUR.HEADPP#=0;
      974     2201    2              FM$CFUR.TAILPP#=0;
      975     2202    2              CALL MMJ$FPPCHAIN(HEADPP#,FM$CFUR.HEADPP#,FM$CFU.NRECS);
      976     2203    2              MM_SHAREDSUSE=MM_SHAREDSUSE-FM$CFU.NRECS;
PL6.E3A0      #002=FMI$INIT File=FMI$RAN.:E05TSI                                 TUE 07/29/97 16:50 Page:143  
      977     2204    2              END;
      978     2205    1           CALL MMH$FDS(DSWSQ,DSSID,262144,DSACC);
      979     2206    1           IF FM$CFU.UGRANS=0 AND FM$CFU.USECNT=1 THEN ALTRETURN;
      980     2207    1           RETURN;
      981     2208    1   END FMI$INIT;
      982     2209        %EOD;

PL6.E3A0      #002=FMI$INIT File=FMI$RAN.:E05TSI                                 TUE 07/29/97 16:50 Page:144  
--  Include file information  --

   M_INFO_C.:E05TOU  is referenced.
   F_ERRORS_C.:E05TOU  is referenced.
   FM_DATA_R.:E05TOU  cannot be made into a system file and is referenced.
   CP_6_SUBS.:E05TOU  is referenced.
   FM$MACROS.:E05TOU  is referenced.
   F$DCB.:E05TOU  is referenced.
   B$JIT_C.:E05TOU  is referenced.
   F$JIT_C.:E05TOU  cannot be made into a system file and is referenced.
   B_STRINGS_C.:E05TOU  is referenced.
      No diagnostics issued in procedure FMI$INIT.

   Procedure FMI$INIT requires 452 words for executable code.
   Procedure FMI$INIT requires 20 words of local(AUTO) storage.

PL6.E3A0      #002=FMI$INIT File=FMI$RAN.:E05TSI                                 TUE 07/29/97 16:50 Page:145  

 Object Unit name= FMI$INIT                                   File name= FMI$RAN.:E05TOU
 UTS= JUL 29 '97 16:50:42.56 TUE                              Compiler= PL-6/E31         Sev=      00
 SharedLib= :SHARED_SYSTEM                                    Alt SharedLib=


    ****  Control sections  ****

 Sect   Type Bound  Init  Size OctSiz  Section name(segment info)
    0  RoData even  UTS      6      6  FMI$INIT
    1   Proc  even  none   452    704  FMI$INIT
    2  RoData even  none     2      2  FMI$INIT

    ****  Entry defs  ****

                              Check   Calling
                             calling  sequence
  Sect OctLoc Primary Altret sequence   type   Parms  Name
     1      0   yes    yes     yes      Std        0  FMI$INIT
     1    465          yes     yes      Std        0  FMI$DSREL
PL6.E3A0      #002=FMI$INIT File=FMI$RAN.:E05TSI                                 TUE 07/29/97 16:50 Page:146  

  ****  Entry refs  ****

         Check        Calling
        calling       sequence
Altret sequence SRef   type   Args  Name
         yes           Std       0 FMH$INIT
 yes     yes           Std       0 FMG$INIT
         yes           Std       3 MMJ$FPPCHAIN
 yes     yes           Std       4 MMH$FDS
 yes     yes           Std       1 UQB$MENQX
 yes     yes           Std       8 MMH$MAP_DS
 yes     yes           Std       8 MMH$SHARE_DS
         yes           Std       1 FMI$DSREAD
         yes           Std       1 FMI$DSWRITE
 yes     yes           Std       0 MMV$CLOSE
                       nStd      0 X66_AUTO_0
                       nStd      0 X66_AALT
                       Std       0 B_CONSPOOL_D
                       nStd      0 X66_ARET

  ****  Data refs  ****

  Flags:  r = read only, s = secondary
Flgs Name                             Flgs Name                             Flgs Name
     B$JIT$                                B$IS$                                 MM_SHAREDSUSE
     B_VECTNIL

  ****  Segment refs  ****

  Flags:  r = read only, s = secondary
Flgs Name                             Flgs Name                             Flgs Name
     ISSID
PL6.E3A0      #002=FMI$INIT File=FMI$RAN.:E05TSI                                 TUE 07/29/97 16:50 Page:147  


      754        1        /*T***********************************************************/
      755        2        /*T*                                                         */
      756        3        /*T* Copyright (c) Bull HN Information Systems Inc., 1997    */
      757        4        /*T*                                                         */
      758        5        /*T***********************************************************/
      759        6        /*F*   NAME:   FMI$INIT
      760        7        *      PURPOSE:  To initialize a newly opened RANDOM file DCB                */
      761        8                                                /*                                    */
      762        9                                                /*                                    */
      763       10                                                /*                                    */
      764       11        /*D*   NAME:   FMI$INIT
      765       12        *      CALL:   CALL FMI$INIT;
      766       13        *       OUTPUT: Various DCB fields initialized
      767       14        *      DESCRIPTION:                                                          */
      768       15                                                /*                                    */
      769       16        FMI$INIT: PROC ALTRET;

     16  1 000000   000000 700200 xent  FMI$INIT     TSX0  ! X66_AUTO_0
         1 000001   000024 000000                    ZERO    20,0

      770       17        /* LOCAL AUTOMATIC STORAGE */
      771       18    1   DCL JDCB$ PTR;
      772       19    1   DCL CFU$ PTR;
      773       20    1   DCL TEMP_DCB PTR;
      774       21    1   DCL 1 TEMP_DCB_R REDEF TEMP_DCB,
      775       22    1         2 ADDR_BITS UBIN(18) UNAL,
      776       23    1         2 LS   UBIN(18) UNAL;
      777       24    1   DCL DSACC UBIN;
      778       25    1   DCL DSSID UBIN;
      779       26    1   DCL HEADPP# UBIN;
      780       27    1   DCL DSWSQ UBIN;
      781       28        /* EXTERNAL DATA */
      782       29    1   DCL B$JIT$ PTR SYMREF;
      783       30    1   DCL B$IS$ PTR SYMREF;
      784       31    1   DCL LS0UBIN REDEF B$IS$ UBIN;
      785       32    1   DCL MM_SHAREDSUSE SBIN SYMREF;
PL6.E3A0      #002=FMI$INIT File=FMI$RAN.:E05TSI                                 TUE 07/29/97 16:50 Page:148  
      786       33        /* EXTERNAL ROUTINES */
      787       34    1   DCL FMG$INIT ENTRY ALTRET;
      788       35    1   DCL FMH$INIT ENTRY;
      789       36    1   DCL FMI$DSREAD ENTRY(1);
      790       37    1   DCL FMI$DSWRITE ENTRY(1);
      791       38    1   DCL MMH$MAP_DS ENTRY(8)ALTRET;
      792       39    1   DCL MMH$SHARE_DS ENTRY(8)ALTRET;
      793       40    1   DCL MMH$FDS ENTRY(4)ALTRET;
      794       41    1   DCL MMJ$FPPCHAIN ENTRY(3);
      795       42    1   DCL MMV$CLOSE ENTRY ALTRET;
      796       43    1   DCL UQB$MENQX ENTRY(1) ALTRET;
      797       44    1   DCL UQB$MDEQ ENTRY(1) ALTRET;
      798       45        /* INCLUDE FILES */
      799       46        %INCLUDE B_STRINGS_C;
      800      175        %INCLUDE F$JIT_C;
      801      605        %MACRO F$DCB (BASED="BASED(JDCB$)");
      802      606        %INCLUDE F$DCB;
      803      655        %MEND;
      804      656        %INCLUDE FM$MACROS;
      805     1031        %INCLUDE CP_6_SUBS;
      806     1571        %INCLUDE FM_DATA_R;
      807     1585        %INCLUDE F_ERRORS_C;
      808     1825        %INCLUDE M_INFO_C;
      809     1965        /* CONSTANT DATA */
      810     1966        %SUB FCG#='0615'O;
      811     1967        %SUB MID#='11'O;
      812     1968        %ERRCODE (NAME=ERRCGFILE,COD#=%E$CGFILE);
      813     1972        %ERRCODE (NAME=ERRNOSHRDS,COD#=%E$NOSHRDS);
      814     1976        %ERRCODE(NAME=ERRSHRDS2BIG,COD#=%E$SHRDS2BIG);
      815     1980        %ERRCODE(NAME=ERRNOACCESS,COD#=%E$READ);
      816     1984        %ERRCODE(NAME=ERRNOCODE,COD#=0);
      817     1988        /* BASED STRUCTURES */
      818     1989        %FM$CFU(BASED="BASED(CFU$)");
      819     1995        %FM$CFUR(BASED="BASED(CFU$)");
      820     1998        %F$DCB;
      821     2048                                                /*                                    */
      822     2049    1           JDCB$=B$JIT.DCB$;
PL6.E3A0      #002=FMI$INIT File=FMI$RAN.:E05TSI                                 TUE 07/29/97 16:50 Page:149  

   2049  1 000002   000000 470400 xsym               LDP0    B$JIT$
         1 000003   000232 236100                    LDQ     154,,PR0
         1 000004   200003 756100                    STQ     JDCB$,,AUTO

      823     2050        /**/
      824     2051    1           IF F$DCB.ORG=%CG# AND F$DCB.ASN=%FILE# THEN

   2051  1 000005   200003 471500                    LDP1    JDCB$,,AUTO
         1 000006   100032 236100                    LDQ     26,,PR1
         1 000007   777000 376003                    ANQ     -512,DU
         1 000010   013000 116003                    CMPQ    5632,DU
         1 000011   000042 601000 1                  TNZ     s:2067
         1 000012   100032 236100                    LDQ     26,,PR1
         1 000013   777000 376007                    ANQ     -512,DL
         1 000014   001000 116007                    CMPQ    512,DL
         1 000015   000042 601000 1                  TNZ     s:2067

      825     2052    1              IF NOT B$JIT.PRIV.ACTIVE&%PR_FMDIAG# AND

   2052  1 000016   000013 236100                    LDQ     11,,PR0
         1 000017   000005 376000 0                  ANQ     ERRNOCODE+1
         1 000020   000042 601000 1                  TNZ     s:2067
         1 000021   100032 236100                    LDQ     26,,PR1
         1 000022   000777 376003                    ANQ     511,DU
         1 000023   000002 116003                    CMPQ    2,DU
         1 000024   000030 601000 1                  TNZ     s:2054
         1 000025   100004 220100                    LDX0    4,,PR1
         1 000026   000600 360003                    ANX0    384,DU
         1 000027   000042 601000 1                  TNZ     s:2067

      826     2053    1                (F$DCB.FUN~=%IN# OR NOT(F$DCB.FFLG&(%FFLG_AU#|%FFLG_AURD#))) THEN
      827     2054    1                 IF F$DCB.FFLG.REATTR THEN

   2054  1 000030   100004 236100                    LDQ     4,,PR1
         1 000031   004000 316003                    CANQ    2048,DU
         1 000032   000037 600000 1                  TZE     s:2058
PL6.E3A0      #002=FMI$INIT File=FMI$RAN.:E05TSI                                 TUE 07/29/97 16:50 Page:150  

      828     2055    1                    F$DCB.FFLG=F$DCB.FFLG&(%FFLG_NOLIST#|%FFLG_REATTR#|

   2055  1 000033   100004 220100                    LDX0    4,,PR1
         1 000034   036000 360003                    ANX0    15360,DU
         1 000035   100004 740100                    STX0    4,,PR1
         1 000036   000042 710000 1                  TRA     s:2067

      829     2056    1                      %FFLG_DELF#|%FFLG_EXEC#);
      830     2057    2                 ELSE DO;

      831     2058    2                    B$JIT.ERR=ERRCGFILE;

   2058  1 000037   000000 236000 0                  LDQ     ERRCGFILE
         1 000040   000012 756100                    STQ     10,,PR0

      832     2059    2                    ALTRETURN;

   2059  1 000041   000000 702200 xent               TSX2  ! X66_AALT

      833     2060    2                    END;
      834     2061        /*E*    ERROR: -E$CGFILE-2
      835     2062                MESSAGE: You are not allowed to open comgroup% %UF% as a file
      836     2063        */
      837     2064        /**/
      838     2065                /* Make sure F$DCB.KEYL is set correctly for IREL files when
      839     2066                   opened by XSA$FSF.                                     */
      840     2067    1           IF F$DCB.ORG=%IREL# AND F$DCB.ACS=%UBLOCK# THEN

   2067  1 000042   100032 236100                    LDQ     26,,PR1
         1 000043   777000 376003                    ANQ     -512,DU
         1 000044   015000 116003                    CMPQ    6656,DU
         1 000045   000052 601000 1                  TNZ     s:2071
         1 000046   100036 236100                    LDQ     30,,PR1
         1 000047   000777 376007                    ANQ     511,DL
         1 000050   000014 116007                    CMPQ    12,DL
         1 000051   000104 600000 1                  TZE     FMG_INIT
PL6.E3A0      #002=FMI$INIT File=FMI$RAN.:E05TSI                                 TUE 07/29/97 16:50 Page:151  

      841     2068    1              GOTO FMG_INIT;
      842     2069                /* Otherwise, make sure files are fixed up if they weren't
      843     2070                   closed properly before.                             */
      844     2071    1           IF F$DCB.RA THEN

   2071  1 000052   100064 236100                    LDQ     52,,PR1
         1 000053   020000 316007                    CANQ    8192,DL
         1 000054   000107 600000 1                  TZE     s:2086

      845     2072    2           DO CASE(F$DCB.ORG);

   2072  1 000055   100032 236100                    LDQ     26,,PR1
         1 000056   000033 772000                    QRL     27
         1 000057   000016 116007                    CMPQ    14,DL
         1 000060   000062 602006 1                  TNC     s:2072+5,QL
         1 000061   000107 710000 1                  TRA     s:2086
         1 000062   000107 710000 1                  TRA     s:2086
         1 000063   000100 710000 1                  TRA     s:2074
         1 000064   000104 710000 1                  TRA     FMG_INIT
         1 000065   000107 710000 1                  TRA     s:2086
         1 000066   000100 710000 1                  TRA     s:2074
         1 000067   000107 710000 1                  TRA     s:2086
         1 000070   000104 710000 1                  TRA     FMG_INIT
         1 000071   000107 710000 1                  TRA     s:2086
         1 000072   000100 710000 1                  TRA     s:2074
         1 000073   000100 710000 1                  TRA     s:2074
         1 000074   000107 710000 1                  TRA     s:2086
         1 000075   000107 710000 1                  TRA     s:2086
         1 000076   000107 710000 1                  TRA     s:2086
         1 000077   000104 710000 1                  TRA     FMG_INIT

      846     2073    2            CASE(%CONSEC#,%UR#,%SYMB#,%TERMINAL#);

      847     2074    2              CALL FMH$INIT;

   2074  1 000100   000002 631400 xsym               EPPR1   B_VECTNIL+2
PL6.E3A0      #002=FMI$INIT File=FMI$RAN.:E05TSI                                 TUE 07/29/97 16:50 Page:152  
         1 000101   000000 701000 xent               TSX1    FMH$INIT
         1 000102   000000 011000                    NOP     0
         1 000103   000107 710000 1                  TRA     s:2086

      848     2075    2            CASE(%KEYED#,%INDEXED#,%IREL#);

      849     2076    2   FMG_INIT:  CALL FMG$INIT;

   2076  1 000104   000002 631400 xsym  FMG_INIT     EPPR1   B_VECTNIL+2
         1 000105   000000 701000 xent               TSX1    FMG$INIT
         1 000106   000000 011000                    NOP     0

      850     2077    2            END;

      851     2078        /**/
      852     2079                /*
      853     2080                   If we're creating a file with ACS=BLOCK, and hence IFPARAM,
      854     2081                   FMO$BLDFIT already set CRECNO 'cause he knew what kind of
      855     2082                   fit we started with. I.e., granule 0 may have already been
      856     2083                   written if a FIT became an AFIT when we got extents during
      857     2084                   open. Otherwise, set CRECNO here.
      858     2085                */
      859     2086    1           IF NOT(F$DCB.IASN=%FILE# AND F$DCB.ACS=%BLOCK# AND

   2086  1 000107   200003 470500                    LDP0    JDCB$,,AUTO
         1 000110   000103 236100                    LDQ     67,,PR0
         1 000111   000777 376007                    ANQ     511,DL
         1 000112   000001 116007                    CMPQ    1,DL
         1 000113   000136 601000 1                  TNZ     s:2090
         1 000114   000036 236100                    LDQ     30,,PR0
         1 000115   000777 376007                    ANQ     511,DL
         1 000116   000003 116007                    CMPQ    3,DL
         1 000117   000136 601000 1                  TNZ     s:2090
         1 000120   000066 471500                    LDP1    54,,PR0
         1 000121   100000 236100                    LDQ     0,,PR1
         1 000122   700000 376003                    ANQ     -32768,DU
         1 000123   300000 116003                    CMPQ    98304,DU
PL6.E3A0      #002=FMI$INIT File=FMI$RAN.:E05TSI                                 TUE 07/29/97 16:50 Page:153  
         1 000124   000137 600000 1                  TZE     s:2091
         1 000125   100000 116003                    CMPQ    32768,DU
         1 000126   000136 601000 1                  TNZ     s:2090
         1 000127   000031 236100                    LDQ     25,,PR0
         1 000130   004000 316007                    CANQ    2048,DL
         1 000131   000136 600000 1                  TZE     s:2090
         1 000132   000032 236100                    LDQ     26,,PR0
         1 000133   000777 376003                    ANQ     511,DU
         1 000134   000003 116003                    CMPQ    3,DU
         1 000135   000137 600000 1                  TZE     s:2091

      860     2087    1             (F$DCB.CFU$->FM$CFU.FUN=%CREATE# OR
      861     2088    1             (F$DCB.CFU$->FM$CFU.FUN=%UPDATE# AND F$DCB.CTG AND
      862     2089    1             F$DCB.FUN=%CREATE#))) THEN
      863     2090    1              F$DCB.CRECNO=0;              /* Current block number               */

   2090  1 000136   000071 450100                    STZ     57,,PR0

      864     2091    2           IF F$DCB.IASN=%FILE# THEN DO;

   2091  1 000137   000103 236100                    LDQ     67,,PR0
         1 000140   000777 376007                    ANQ     511,DL
         1 000141   000001 116007                    CMPQ    1,DL
         1 000142   000442 601000 1                  TNZ     s:2152

      865     2092    2              IF F$DCB.ACS=%BLOCK# AND F$DCB.CFU$->FM$CFU.AFIT=0 THEN

   2092  1 000143   000036 236100                    LDQ     30,,PR0
         1 000144   000777 376007                    ANQ     511,DL
         1 000145   000003 116007                    CMPQ    3,DL
         1 000146   000155 601000 1                  TNZ     s:2094
         1 000147   000066 471500                    LDP1    54,,PR0
         1 000150   100000 236100                    LDQ     0,,PR1
         1 000151   001000 316003                    CANQ    512,DU
         1 000152   000155 601000 1                  TNZ     s:2094

      866     2093    2                 F$DCB.CRECNO=1;           /* BLOCK ACCESS WITH AFIT             */
PL6.E3A0      #002=FMI$INIT File=FMI$RAN.:E05TSI                                 TUE 07/29/97 16:50 Page:154  

   2093  1 000153   000001 235007                    LDA     1,DL
         1 000154   000071 755100                    STA     57,,PR0

      867     2094    2              F$DCB.GTYP=FMGTFILE;

   2094  1 000155   000064 236100                    LDQ     52,,PR0
         1 000156   000000 376000 2                  ANQ     0
         1 000157   030000 276003                    ORQ     12288,DU
         1 000160   000064 756100                    STQ     52,,PR0

      868     2095    2              IF F$DCB.ORG~=%RANDOM# THEN RETURN;

   2095  1 000161   000032 236100                    LDQ     26,,PR0
         1 000162   777000 376003                    ANQ     -512,DU
         1 000163   003000 116003                    CMPQ    1536,DU
         1 000164   000166 600000 1                  TZE     s:2096

   2095  1 000165   000000 702200 xent               TSX2  ! X66_ARET

      869     2096    2              IF F$DCB.WSR~=7 THEN DSWSQ=F$DCB.WSR;

   2096  1 000166   000040 236100                    LDQ     32,,PR0
         1 000167   000777 376003                    ANQ     511,DU
         1 000170   000007 116003                    CMPQ    7,DU
         1 000171   000177 600000 1                  TZE     s:2097

   2096  1 000172   000040 236100                    LDQ     32,,PR0
         1 000173   000022 772000                    QRL     18
         1 000174   000777 376007                    ANQ     511,DL
         1 000175   200011 756100                    STQ     DSWSQ,,AUTO
         1 000176   000201 710000 1                  TRA     s:2098

      870     2097    2              ELSE DSWSQ=%USERWSQ;

   2097  1 000177   000010 235007                    LDA     8,DL
         1 000200   200011 755100                    STA     DSWSQ,,AUTO
PL6.E3A0      #002=FMI$INIT File=FMI$RAN.:E05TSI                                 TUE 07/29/97 16:50 Page:155  

      871     2098    2              DSSID=LS0UBIN+F$DCB.ACS;

   2098  1 000201   000036 236100                    LDQ     30,,PR0
         1 000202   000777 376007                    ANQ     511,DL
         1 000203   000000 036000 xsym               ADLQ    B$IS$
         1 000204   200007 756100                    STQ     DSSID,,AUTO

      872     2099    2              CFU$=F$DCB.CFU$;

   2099  1 000205   000066 236100                    LDQ     54,,PR0
         1 000206   200004 756100                    STQ     CFU$,,AUTO

      873     2100    3              IF NOT F$DCB.ENQF THEN DO;

   2100  1 000207   000064 236100                    LDQ     52,,PR0
         1 000210   000200 316007                    CANQ    128,DL
         1 000211   000222 601000 1                  TNZ     s:2104

      874     2101    3                 F$DCB.ENQF='1'B;

   2101  1 000212   000200 236007                    LDQ     128,DL
         1 000213   000064 256100                    ORSQ    52,,PR0

      875     2102    3                 CALL UQB$MENQX(CFU$);

   2102  1 000214   200004 631500                    EPPR1   CFU$,,AUTO
         1 000215   200012 451500                    STP1    DSWSQ+1,,AUTO
         1 000216   200012 630500                    EPPR0   DSWSQ+1,,AUTO
         1 000217   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 000220   000000 701000 xent               TSX1    UQB$MENQX
         1 000221   000000 011000                    NOP     0

      876     2103    3                 END;

      877     2104    3              IF FM$CFUR.HEADPP#~=0 THEN DO; /* ALREADY OPEN SHRDS               */

PL6.E3A0      #002=FMI$INIT File=FMI$RAN.:E05TSI                                 TUE 07/29/97 16:50 Page:156  
   2104  1 000222   200004 470500                    LDP0    CFU$,,AUTO
         1 000223   000005 220100                    LDX0    5,,PR0
         1 000224   000311 600000 1                  TZE     s:2126

      878     2105    3                 IF F$DCB.ACS<=%JRNL# THEN GOTO SHRDSERR;

   2105  1 000225   200003 471500                    LDP1    JDCB$,,AUTO
         1 000226   100036 236100                    LDQ     30,,PR1
         1 000227   000777 376007                    ANQ     511,DL
         1 000230   000005 116007                    CMPQ    5,DL
         1 000231   000443 602000 1                  TNC     SHRDSERR

      879     2106        /*E*      ERROR: FMI-E$NOSHRDS-E
      880     2107        *         MESSAGE:Shared data segment file %FN must be shared alike.
      881     2108        *         MESSAGE1:All users of %UF must share it in a data segment, or
      882     2109        *         they must all share it normally.
      883     2110        */
      884     2111    3                 IF NOT F$DCB.FFLG.READ THEN GOTO NOACCESS;

   2111  1 000232   100004 234100                    SZN     4,,PR1
         1 000233   000453 605000 1                  TPL     NOACCESS

      885     2112    3                 F$DCB.NRECS=FM$CFU.NRECS;

   2112  1 000234   000001 235100                    LDA     1,,PR0
         1 000235   100042 755100                    STA     34,,PR1

      886     2113    3                IF F$DCB.FFLG&%(FFLG_WNEW#|FFLG_UPD#) THEN DSACC=BITBIN(%MM_DSWRITE#);

   2113  1 000236   100004 220100                    LDX0    4,,PR1
         1 000237   140000 360003                    ANX0    49152,DU
         1 000240   000244 600000 1                  TZE     s:2114

   2113  1 000241   000600 235007                    LDA     384,DL
         1 000242   200006 755100                    STA     DSACC,,AUTO
         1 000243   000246 710000 1                  TRA     s:2120

PL6.E3A0      #002=FMI$INIT File=FMI$RAN.:E05TSI                                 TUE 07/29/97 16:50 Page:157  
      887     2114    3                 ELSE DSACC=BITBIN(%MM_DSREAD#);

   2114  1 000244   000400 235007                    LDA     256,DL
         1 000245   200006 755100                    STA     DSACC,,AUTO

      888     2115        /*E*      ERROR: FMI-E$READ-E
      889     2116        *         MESSAGE:DS sharing %of %FN% denied because you can't do anything.
      890     2117        *         MESSAGE1:To share a file %(%UF) % in a data segment, you must be
      891     2118        *         able to read the information therein.
      892     2119        */
      893     2120    3                 HEADPP#=FM$CFUR.HEADPP#;

   2120  1 000246   000005 236100                    LDQ     5,,PR0
         1 000247   000022 772000                    QRL     18
         1 000250   200010 756100                    STQ     HEADPP#,,AUTO

      894     2121    3                 CALL MMH$MAP_DS(DSWSQ,DSSID,FM$CFU.NRECS*1024-1,B$JIT.ERR,

   2121  1 000251   000001 235100                    LDA     1,,PR0
         1 000252   000012 735000                    ALS     10
         1 000253   000001 135007                    SBLA    1,DL
         1 000254   200012 755100                    STA     DSWSQ+1,,AUTO
         1 000255   200004 236100                    LDQ     CFU$,,AUTO
         1 000256   000001 036003                    ADLQ    1,DU
         1 000257   000001 235000 xsym               LDA     B_VECTNIL+1
         1 000260   200022 757100                    STAQ    DSWSQ+9,,AUTO
         1 000261   200010 633500                    EPPR3   HEADPP#,,AUTO
         1 000262   200021 453500                    STP3    DSWSQ+8,,AUTO
         1 000263   200006 634500                    EPPR4   DSACC,,AUTO
         1 000264   200020 454500                    STP4    DSWSQ+7,,AUTO
         1 000265   000000 236000 xsym               LDQ     B$JIT$
         1 000266   000012 036003                    ADLQ    10,DU
         1 000267   200017 756100                    STQ     DSWSQ+6,,AUTO
         1 000270   200012 635500                    EPPR5   DSWSQ+1,,AUTO
         1 000271   200016 455500                    STP5    DSWSQ+5,,AUTO
         1 000272   200007 636500                    EPPR6   DSSID,,AUTO
         1 000273   200015 456500                    STP6    DSWSQ+4,,AUTO
PL6.E3A0      #002=FMI$INIT File=FMI$RAN.:E05TSI                                 TUE 07/29/97 16:50 Page:158  
         1 000274   200011 637500                    EPPR7   DSWSQ,,AUTO
         1 000275   200014 457500                    STP7    DSWSQ+3,,AUTO
         1 000276   200014 630500                    EPPR0   DSWSQ+3,,AUTO
         1 000277   000026 631400 xsym               EPPR1   B_VECTNIL+22
         1 000300   000000 701000 xent               TSX1    MMH$MAP_DS
         1 000301   000457 702000 1                  TSX2    MMERR

      895     2122    3                   DSACC,HEADPP#,,FM$CFU.NRECS) ALTRET(MMERR);
      896     2123    3                 IF DSACC=BITBIN(%MM_DSWRITE#) THEN FM$CFU.FMOD='1'B;

   2123  1 000302   200006 235100                    LDA     DSACC,,AUTO
         1 000303   000600 115007                    CMPA    384,DL
         1 000304   000310 601000 1                  TNZ     s:2124

   2123  1 000305   200004 470500                    LDP0    CFU$,,AUTO
         1 000306   004000 236003                    LDQ     2048,DU
         1 000307   000000 256100                    ORSQ    0,,PR0

      897     2124    3                 RETURN;

   2124  1 000310   000000 702200 xent               TSX2  ! X66_ARET

      898     2125    3                 END;
      899     2126    3              ELSE IF F$DCB.ACS<=%JRNL# THEN DO;

   2126  1 000311   200003 471500                    LDP1    JDCB$,,AUTO
         1 000312   100036 236100                    LDQ     30,,PR1
         1 000313   000777 376007                    ANQ     511,DL
         1 000314   000005 116007                    CMPQ    5,DL
         1 000315   000321 603000 1                  TRC     s:2131

      900     2127                                      /* Indicate that the mode is now established    */
      901     2128    3                    FM$CFUR.TAILPP#=1;

   2128  1 000316   000001 221003                    LDX1    1,DU
         1 000317   000005 441100                    SXL1    5,,PR0

PL6.E3A0      #002=FMI$INIT File=FMI$RAN.:E05TSI                                 TUE 07/29/97 16:50 Page:159  
      902     2129    3                    RETURN;

   2129  1 000320   000000 702200 xent               TSX2  ! X66_ARET

      903     2130    3                    END;
      904     2131    2              IF FM$CFUR.TAILPP#~=0 THEN GOTO SHRDSERR;

   2131  1 000321   000005 721100                    LXL1    5,,PR0
         1 000322   000443 601000 1                  TNZ     SHRDSERR

      905     2132    2              FM$CFU.NRECS=FM$CFU.UGRANS-1;

   2132  1 000323   000004 236100                    LDQ     4,,PR0
         1 000324   000032 376000 xsym               ANQ     B_VECTNIL+26
         1 000325   000001 136007                    SBLQ    1,DL
         1 000326   000001 756100                    STQ     1,,PR0

      906     2133    2              IF FM$CFU.UGRANS=0 THEN FM$CFU.NRECS=F$DCB.XTNSIZE;

   2133  1 000327   200004 470500                    LDP0    CFU$,,AUTO
         1 000330   000004 236100                    LDQ     4,,PR0
         1 000331   000032 316000 xsym               CANQ    B_VECTNIL+26
         1 000332   000336 601000 1                  TNZ     s:2134

   2133  1 000333   100037 236100                    LDQ     31,,PR1
         1 000334   000022 772000                    QRL     18
         1 000335   000001 756100                    STQ     1,,PR0

      907     2134    2              IF FM$CFU.NRECS>256 OR FM$CFU.NRECS=0 THEN GOTO SHRDS2BIG;

   2134  1 000336   200004 470500                    LDP0    CFU$,,AUTO
         1 000337   000001 235100                    LDA     1,,PR0
         1 000340   000400 115007                    CMPA    256,DL
         1 000341   000447 605400 1                  TPNZ    SHRDS2BIG
         1 000342   000000 115003                    CMPA    0,DU
         1 000343   000447 600000 1                  TZE     SHRDS2BIG

PL6.E3A0      #002=FMI$INIT File=FMI$RAN.:E05TSI                                 TUE 07/29/97 16:50 Page:160  
      908     2135        /*E*      ERROR: FMI-E$SHRDS2BIG-E
      909     2136        *         MESSAGE:File %%FN %shared in a data segment must fit there.
      910     2137        *         MESSAGE1:File %FN is > 257k or < 2k, so it cannot be DS shared.
      911     2138        */
      912     2139    2              IF NOT F$DCB.FFLG.READ THEN GOTO NOACCESS;

   2139  1 000344   100004 234100                    SZN     4,,PR1
         1 000345   000453 605000 1                  TPL     NOACCESS

      913     2140    2              IF F$DCB.FFLG&%(FFLG_WNEW#|FFLG_UPD#) THEN DSACC=BITBIN(%MM_DSWRITE#);

   2140  1 000346   100004 220100                    LDX0    4,,PR1
         1 000347   140000 360003                    ANX0    49152,DU
         1 000350   000354 600000 1                  TZE     s:2141

   2140  1 000351   000600 236007                    LDQ     384,DL
         1 000352   200006 756100                    STQ     DSACC,,AUTO
         1 000353   000356 710000 1                  TRA     s:2142

      914     2141    2              ELSE DSACC=BITBIN(%MM_DSREAD#);

   2141  1 000354   000400 236007                    LDQ     256,DL
         1 000355   200006 756100                    STQ     DSACC,,AUTO

      915     2142    2              HEADPP#=0;

   2142  1 000356   200010 450100                    STZ     HEADPP#,,AUTO

      916     2143    2              CALL MMH$SHARE_DS(DSWSQ,DSSID,FM$CFU.NRECS*1024-1,B$JIT.ERR,

   2143  1 000357   000001 235100                    LDA     1,,PR0
         1 000360   000012 735000                    ALS     10
         1 000361   000001 135007                    SBLA    1,DL
         1 000362   200012 755100                    STA     DSWSQ+1,,AUTO
         1 000363   200004 236100                    LDQ     CFU$,,AUTO
         1 000364   000001 036003                    ADLQ    1,DU
         1 000365   200023 756100                    STQ     DSWSQ+10,,AUTO
PL6.E3A0      #002=FMI$INIT File=FMI$RAN.:E05TSI                                 TUE 07/29/97 16:50 Page:161  
         1 000366   200004 236100                    LDQ     CFU$,,AUTO
         1 000367   000005 036003                    ADLQ    5,DU
         1 000370   200022 756100                    STQ     DSWSQ+9,,AUTO
         1 000371   200010 633500                    EPPR3   HEADPP#,,AUTO
         1 000372   200021 453500                    STP3    DSWSQ+8,,AUTO
         1 000373   200006 634500                    EPPR4   DSACC,,AUTO
         1 000374   200020 454500                    STP4    DSWSQ+7,,AUTO
         1 000375   000000 236000 xsym               LDQ     B$JIT$
         1 000376   000012 036003                    ADLQ    10,DU
         1 000377   200017 756100                    STQ     DSWSQ+6,,AUTO
         1 000400   200012 635500                    EPPR5   DSWSQ+1,,AUTO
         1 000401   200016 455500                    STP5    DSWSQ+5,,AUTO
         1 000402   200007 636500                    EPPR6   DSSID,,AUTO
         1 000403   200015 456500                    STP6    DSWSQ+4,,AUTO
         1 000404   200011 637500                    EPPR7   DSWSQ,,AUTO
         1 000405   200014 457500                    STP7    DSWSQ+3,,AUTO
         1 000406   200014 630500                    EPPR0   DSWSQ+3,,AUTO
         1 000407   000026 631400 xsym               EPPR1   B_VECTNIL+22
         1 000410   000000 701000 xent               TSX1    MMH$SHARE_DS
         1 000411   000457 702000 1                  TSX2    MMERR

      917     2144    2                DSACC,HEADPP#,FM$CFUR.HEADPP#,FM$CFU.NRECS)
      918     2145    2                ALTRET(MMERR);
      919     2146    2              FM$CFUR.HEADPP#=HEADPP#;

   2146  1 000412   200010 720100                    LXL0    HEADPP#,,AUTO
         1 000413   200004 470500                    LDP0    CFU$,,AUTO
         1 000414   000005 740100                    STX0    5,,PR0

      920     2147    2              F$DCB.NRECS=FM$CFU.NRECS;

   2147  1 000415   200003 471500                    LDP1    JDCB$,,AUTO
         1 000416   000001 235100                    LDA     1,,PR0
         1 000417   100042 755100                    STA     34,,PR1

      921     2148    2              MM_SHAREDSUSE=MM_SHAREDSUSE+FM$CFU.NRECS;

PL6.E3A0      #002=FMI$INIT File=FMI$RAN.:E05TSI                                 TUE 07/29/97 16:50 Page:162  
   2148  1 000420   000000 236000 xsym               LDQ     MM_SHAREDSUSE
         1 000421   000001 036100                    ADLQ    1,,PR0
         1 000422   000000 756000 xsym               STQ     MM_SHAREDSUSE

      922     2149    2              IF FM$CFU.UGRANS~=0 THEN CALL FMI$DSREAD(DSWSQ);

   2149  1 000423   000004 236100                    LDQ     4,,PR0
         1 000424   000032 316000 xsym               CANQ    B_VECTNIL+26
         1 000425   000434 600000 1                  TZE     s:2150

   2149  1 000426   200011 633500                    EPPR3   DSWSQ,,AUTO
         1 000427   200012 453500                    STP3    DSWSQ+1,,AUTO
         1 000430   200012 630500                    EPPR0   DSWSQ+1,,AUTO
         1 000431   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 000432   000000 701000 xent               TSX1    FMI$DSREAD
         1 000433   000000 011000                    NOP     0

      923     2150    2              IF DSACC=BITBIN(%MM_DSWRITE#) THEN FM$CFU.FMOD='1'B;

   2150  1 000434   200006 235100                    LDA     DSACC,,AUTO
         1 000435   000600 115007                    CMPA    384,DL
         1 000436   000442 601000 1                  TNZ     s:2152

   2150  1 000437   200004 470500                    LDP0    CFU$,,AUTO
         1 000440   004000 236003                    LDQ     2048,DU
         1 000441   000000 256100                    ORSQ    0,,PR0

      924     2151    2              END;

      925     2152    1           RETURN;

   2152  1 000442   000000 702200 xent               TSX2  ! X66_ARET

      926     2153        /**/
      927     2154    1   SHRDSERR: B$JIT.ERR=ERRNOSHRDS;

   2154  1 000443   000001 236000 0     SHRDSERR     LDQ     ERRNOSHRDS
PL6.E3A0      #002=FMI$INIT File=FMI$RAN.:E05TSI                                 TUE 07/29/97 16:50 Page:163  
         1 000444   000000 473400 xsym               LDP3    B$JIT$
         1 000445   300012 756100                    STQ     10,,PR3

      928     2155    1           ALTRETURN;

   2155  1 000446   000000 702200 xent               TSX2  ! X66_AALT

      929     2156        /**/
      930     2157    1   SHRDS2BIG: B$JIT.ERR=ERRSHRDS2BIG;

   2157  1 000447   000002 236000 0     SHRDS2BIG    LDQ     ERRSHRDS2BIG
         1 000450   000000 473400 xsym               LDP3    B$JIT$
         1 000451   300012 756100                    STQ     10,,PR3

      931     2158    1           ALTRETURN;

   2158  1 000452   000000 702200 xent               TSX2  ! X66_AALT

      932     2159        /**/
      933     2160    1   NOACCESS: B$JIT.ERR=ERRNOACCESS;

   2160  1 000453   000003 236000 0     NOACCESS     LDQ     ERRNOACCESS
         1 000454   000000 473400 xsym               LDP3    B$JIT$
         1 000455   300012 756100                    STQ     10,,PR3

      934     2161    1           ALTRETURN;

   2161  1 000456   000000 702200 xent               TSX2  ! X66_AALT

   2150  1 000457                       MMERR        null
      935     2162        /**/
      936     2163    1   MMERR:  ;
      937     2164    1           B$JIT.ERR=BINBIT(BITBIN(B$JIT.ERR),33)|ERRNOCODE;

   2164  1 000457   000000 470400 xsym               LDP0    B$JIT$
         1 000460   000012 236100                    LDQ     10,,PR0
         1 000461   000003 736000                    QLS     3
PL6.E3A0      #002=FMI$INIT File=FMI$RAN.:E05TSI                                 TUE 07/29/97 16:50 Page:164  
         1 000462   000004 276000 0                  ORQ     ERRNOCODE
         1 000463   000012 756100                    STQ     10,,PR0

      938     2165    1           ALTRETURN;

   2165  1 000464   000000 702200 xent               TSX2  ! X66_AALT

      939     2166        %EJECT;
PL6.E3A0      #002=FMI$INIT File=FMI$RAN.:E05TSI                                 TUE 07/29/97 16:50 Page:165  
      940     2167        /*F*   NAME:   FMI$DSREL
      941     2168        *      PURPOSE: Release a shared data segment at close time.
      942     2169        *      INTERFACE: MMH$FDS - free the data segment.
      943     2170        *                 FMI$DSWRITE - save the data in the segment.
      944     2171        *                 MMJ$FPPCHAIN - free the physical pages.
      945     2172        *      DESCRIPTION: If this is not the last user, just release the segment.
      946     2173        *        Otherwise, if any user could have stored in it, write the segment
      947     2174        *        to the file before freeing it and releasing the page chain.
      948     2175        */
      949     2176    1   FMI$DSREL: ENTRY ALTRET;

   2176  1 000465   000000 700200 xent  FMI$DSREL    TSX0  ! X66_AUTO_0
         1 000466   000024 000000                    ZERO    20,0

      950     2177    1           JDCB$=B$JIT.DCB$;

   2177  1 000467   000000 470400 xsym               LDP0    B$JIT$
         1 000470   000232 236100                    LDQ     154,,PR0
         1 000471   200003 756100                    STQ     JDCB$,,AUTO

      951     2178    1           CFU$=F$DCB.CFU$;

   2178  1 000472   200003 471500                    LDP1    JDCB$,,AUTO
         1 000473   100066 236100                    LDQ     54,,PR1
         1 000474   200004 756100                    STQ     CFU$,,AUTO

      952     2179    1           TEMP_DCB = F$DCB.LASTSTA$;

   2179  1 000475   100007 236100                    LDQ     7,,PR1
         1 000476   200005 756100                    STQ     TEMP_DCB,,AUTO

      953     2180    1           TEMP_DCB_R.ADDR_BITS = 0;

   2180  1 000477   000000 220003                    LDX0    0,DU
         1 000500   200005 740100                    STX0    TEMP_DCB,,AUTO

      954     2181    1           IF F$DCB.IORG = %KEYED# AND TEMP_DCB ~=ADDR(NIL)
PL6.E3A0      #002=FMI$INIT File=FMI$RAN.:E05TSI                                 TUE 07/29/97 16:50 Page:166  

   2181  1 000501   100070 236100                    LDQ     56,,PR1
         1 000502   077000 376003                    ANQ     32256,DU
         1 000503   002000 116003                    CMPQ    1024,DU
         1 000504   000514 601000 1                  TNZ     s:2186
         1 000505   200005 236100                    LDQ     TEMP_DCB,,AUTO
         1 000506   000001 116000 xsym               CMPQ    B_VECTNIL+1
         1 000507   000514 600000 1                  TZE     s:2186

      955     2182    2           THEN DO;

      956     2183    2              CALL MMV$CLOSE;

   2183  1 000510   000002 631400 xsym               EPPR1   B_VECTNIL+2
         1 000511   000000 701000 xent               TSX1    MMV$CLOSE
         1 000512   000000 011000                    NOP     0

      957     2184    2              RETURN;

   2184  1 000513   000000 702200 xent               TSX2  ! X66_ARET

      958     2185    2              END;
      959     2186    1           IF F$DCB.ORG~=%RANDOM# OR FM$CFUR.HEADPP#=0 OR F$DCB.FFLG='0'B THEN

   2186  1 000514   100032 236100                    LDQ     26,,PR1
         1 000515   777000 376003                    ANQ     -512,DU
         1 000516   003000 116003                    CMPQ    1536,DU
         1 000517   000525 601000 1                  TNZ     s:2187
         1 000520   200004 473500                    LDP3    CFU$,,AUTO
         1 000521   300005 221100                    LDX1    5,,PR3
         1 000522   000525 600000 1                  TZE     s:2187
         1 000523   100004 222100                    LDX2    4,,PR1
         1 000524   000526 601000 1                  TNZ     s:2188

      960     2187    1              RETURN;

   2187  1 000525   000000 702200 xent               TSX2  ! X66_ARET
PL6.E3A0      #002=FMI$INIT File=FMI$RAN.:E05TSI                                 TUE 07/29/97 16:50 Page:167  

      961     2188    1           CALL UQB$MENQX (CFU$);

   2188  1 000526   200004 634500                    EPPR4   CFU$,,AUTO
         1 000527   200012 454500                    STP4    DSWSQ+1,,AUTO
         1 000530   200012 630500                    EPPR0   DSWSQ+1,,AUTO
         1 000531   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 000532   000000 701000 xent               TSX1    UQB$MENQX
         1 000533   000000 011000                    NOP     0

      962     2189    1           DSSID=LS0UBIN+F$DCB.ACS;

   2189  1 000534   200003 470500                    LDP0    JDCB$,,AUTO
         1 000535   000036 236100                    LDQ     30,,PR0
         1 000536   000777 376007                    ANQ     511,DL
         1 000537   000000 036000 xsym               ADLQ    B$IS$
         1 000540   200007 756100                    STQ     DSSID,,AUTO

      963     2190    1           DSWSQ=F$DCB.WSR;

   2190  1 000541   000040 236100                    LDQ     32,,PR0
         1 000542   000022 772000                    QRL     18
         1 000543   000777 376007                    ANQ     511,DL
         1 000544   200011 756100                    STQ     DSWSQ,,AUTO

      964     2191    1           IF DSWSQ=7 THEN DSWSQ=%USERWSQ;

   2191  1 000545   000007 116007                    CMPQ    7,DL
         1 000546   000551 601000 1                  TNZ     s:2192

   2191  1 000547   000010 235007                    LDA     8,DL
         1 000550   200011 755100                    STA     DSWSQ,,AUTO

      965     2192    1           DSACC=0;

   2192  1 000551   200006 450100                    STZ     DSACC,,AUTO

PL6.E3A0      #002=FMI$INIT File=FMI$RAN.:E05TSI                                 TUE 07/29/97 16:50 Page:168  
      966     2193    1           HEADPP#=FM$CFUR.HEADPP#;

   2193  1 000552   200004 471500                    LDP1    CFU$,,AUTO
         1 000553   100005 236100                    LDQ     5,,PR1
         1 000554   000022 772000                    QRL     18
         1 000555   200010 756100                    STQ     HEADPP#,,AUTO

      967     2194    1           CALL MMH$MAP_DS(DSWSQ,DSSID,FM$CFU.NRECS*1024-1,DSACC,,

   2194  1 000556   100001 235100                    LDA     1,,PR1
         1 000557   000012 735000                    ALS     10
         1 000560   000001 135007                    SBLA    1,DL
         1 000561   200012 755100                    STA     DSWSQ+1,,AUTO
         1 000562   200004 236100                    LDQ     CFU$,,AUTO
         1 000563   000001 036003                    ADLQ    1,DU
         1 000564   000001 235000 xsym               LDA     B_VECTNIL+1
         1 000565   200022 757100                    STAQ    DSWSQ+9,,AUTO
         1 000566   200010 633500                    EPPR3   HEADPP#,,AUTO
         1 000567   200021 453500                    STP3    DSWSQ+8,,AUTO
         1 000570   000001 236000 xsym               LDQ     B_VECTNIL+1
         1 000571   200020 756100                    STQ     DSWSQ+7,,AUTO
         1 000572   200006 634500                    EPPR4   DSACC,,AUTO
         1 000573   200017 454500                    STP4    DSWSQ+6,,AUTO
         1 000574   200012 635500                    EPPR5   DSWSQ+1,,AUTO
         1 000575   200016 455500                    STP5    DSWSQ+5,,AUTO
         1 000576   200007 636500                    EPPR6   DSSID,,AUTO
         1 000577   200015 456500                    STP6    DSWSQ+4,,AUTO
         1 000600   200011 637500                    EPPR7   DSWSQ,,AUTO
         1 000601   200014 457500                    STP7    DSWSQ+3,,AUTO
         1 000602   200014 630500                    EPPR0   DSWSQ+3,,AUTO
         1 000603   000026 631400 xsym               EPPR1   B_VECTNIL+22
         1 000604   000000 701000 xent               TSX1    MMH$MAP_DS
         1 000605   000000 011000                    NOP     0

      968     2195    1             HEADPP#,,FM$CFU.NRECS);
      969     2196    1           IF DSACC~=0 THEN RETURN;

PL6.E3A0      #002=FMI$INIT File=FMI$RAN.:E05TSI                                 TUE 07/29/97 16:50 Page:169  
   2196  1 000606   200006 235100                    LDA     DSACC,,AUTO
         1 000607   000611 600000 1                  TZE     s:2197

   2196  1 000610   000000 702200 xent               TSX2  ! X66_ARET

      970     2197    2           IF FM$CFU.USECNT=1 THEN DO;

   2197  1 000611   200004 470500                    LDP0    CFU$,,AUTO
         1 000612   000003 720100                    LXL0    3,,PR0
         1 000613   000001 100003                    CMPX0   1,DU
         1 000614   000657 601000 1                  TNZ     s:2205

      971     2198    2              IF FM$CFU.FMOD AND FM$CFU.UGRANS~=0 AND FM$CFU.NAMEX~=0

   2198  1 000615   000000 236100                    LDQ     0,,PR0
         1 000616   004000 316003                    CANQ    2048,DU
         1 000617   000633 600000 1                  TZE     s:2200
         1 000620   000004 236100                    LDQ     4,,PR0
         1 000621   000032 316000 xsym               CANQ    B_VECTNIL+26
         1 000622   000633 600000 1                  TZE     s:2200
         1 000623   000002 721100                    LXL1    2,,PR0
         1 000624   000633 600000 1                  TZE     s:2200

      972     2199    2              THEN CALL FMI$DSWRITE(DSWSQ);

   2199  1 000625   200011 631500                    EPPR1   DSWSQ,,AUTO
         1 000626   200012 451500                    STP1    DSWSQ+1,,AUTO
         1 000627   200012 630500                    EPPR0   DSWSQ+1,,AUTO
         1 000630   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 000631   000000 701000 xent               TSX1    FMI$DSWRITE
         1 000632   000000 011000                    NOP     0

      973     2200    2              FM$CFUR.HEADPP#=0;

   2200  1 000633   000000 220003                    LDX0    0,DU
         1 000634   200004 470500                    LDP0    CFU$,,AUTO
         1 000635   000005 740100                    STX0    5,,PR0
PL6.E3A0      #002=FMI$INIT File=FMI$RAN.:E05TSI                                 TUE 07/29/97 16:50 Page:170  

      974     2201    2              FM$CFUR.TAILPP#=0;

   2201  1 000636   000005 440100                    SXL0    5,,PR0

      975     2202    2              CALL MMJ$FPPCHAIN(HEADPP#,FM$CFUR.HEADPP#,FM$CFU.NRECS);

   2202  1 000637   200004 236100                    LDQ     CFU$,,AUTO
         1 000640   000001 036003                    ADLQ    1,DU
         1 000641   200014 756100                    STQ     DSWSQ+3,,AUTO
         1 000642   200004 236100                    LDQ     CFU$,,AUTO
         1 000643   000005 036003                    ADLQ    5,DU
         1 000644   200013 756100                    STQ     DSWSQ+2,,AUTO
         1 000645   200010 631500                    EPPR1   HEADPP#,,AUTO
         1 000646   200012 451500                    STP1    DSWSQ+1,,AUTO
         1 000647   200012 630500                    EPPR0   DSWSQ+1,,AUTO
         1 000650   000021 631400 xsym               EPPR1   B_VECTNIL+17
         1 000651   000000 701000 xent               TSX1    MMJ$FPPCHAIN
         1 000652   000000 011000                    NOP     0

      976     2203    2              MM_SHAREDSUSE=MM_SHAREDSUSE-FM$CFU.NRECS;

   2203  1 000653   200004 470500                    LDP0    CFU$,,AUTO
         1 000654   000000 236000 xsym               LDQ     MM_SHAREDSUSE
         1 000655   000001 136100                    SBLQ    1,,PR0
         1 000656   000000 756000 xsym               STQ     MM_SHAREDSUSE

      977     2204    2              END;

      978     2205    1           CALL MMH$FDS(DSWSQ,DSSID,262144,DSACC);

   2205  1 000657   200006 631500                    EPPR1   DSACC,,AUTO
         1 000660   200015 451500                    STP1    DSWSQ+4,,AUTO
         1 000661   000001 236000 2                  LDQ     1
         1 000662   200014 756100                    STQ     DSWSQ+3,,AUTO
         1 000663   200007 633500                    EPPR3   DSSID,,AUTO
         1 000664   200013 453500                    STP3    DSWSQ+2,,AUTO
PL6.E3A0      #002=FMI$INIT File=FMI$RAN.:E05TSI                                 TUE 07/29/97 16:50 Page:171  
         1 000665   200011 634500                    EPPR4   DSWSQ,,AUTO
         1 000666   200012 454500                    STP4    DSWSQ+1,,AUTO
         1 000667   200012 630500                    EPPR0   DSWSQ+1,,AUTO
         1 000670   000022 631400 xsym               EPPR1   B_VECTNIL+18
         1 000671   000000 701000 xent               TSX1    MMH$FDS
         1 000672   000000 011000                    NOP     0

      979     2206    1           IF FM$CFU.UGRANS=0 AND FM$CFU.USECNT=1 THEN ALTRETURN;

   2206  1 000673   200004 470500                    LDP0    CFU$,,AUTO
         1 000674   000004 236100                    LDQ     4,,PR0
         1 000675   000032 316000 xsym               CANQ    B_VECTNIL+26
         1 000676   000703 601000 1                  TNZ     s:2207
         1 000677   000003 720100                    LXL0    3,,PR0
         1 000700   000001 100003                    CMPX0   1,DU
         1 000701   000703 601000 1                  TNZ     s:2207

   2206  1 000702   000000 702200 xent               TSX2  ! X66_AALT

      980     2207    1           RETURN;

   2207  1 000703   000000 702200 xent               TSX2  ! X66_ARET

ERRCGFILE
 Sect OctLoc
   0     000   061511 001772                                                    1...

ERRNOSHRDS
 Sect OctLoc
   0     001   061511 001742                                                    1...

ERRSHRDS2BIG
 Sect OctLoc
   0     002   061511 002002                                                    1...

ERRNOACCESS
 Sect OctLoc
PL6.E3A0      #002=FMI$INIT File=FMI$RAN.:E05TSI                                 TUE 07/29/97 16:50 Page:172  
   0     003   061511 000702                                                    1...

ERRNOCODE
 Sect OctLoc
   0     004   061511 000002                                                    1...

(unnamed)
 Sect OctLoc
   0     005   040000 000000                                                     ...

(unnamed)
 Sect OctLoc
   2     000   743777 777777   000017 006000                                    ........
      981     2208    1   END FMI$INIT;
      982     2209        %EOD;

PL6.E3A0      #002=FMI$INIT File=FMI$RAN.:E05TSI                                 TUE 07/29/97 16:50 Page:173  
--  Include file information  --

   M_INFO_C.:E05TOU  is referenced.
   F_ERRORS_C.:E05TOU  is referenced.
   FM_DATA_R.:E05TOU  cannot be made into a system file and is referenced.
   CP_6_SUBS.:E05TOU  is referenced.
   FM$MACROS.:E05TOU  is referenced.
   F$DCB.:E05TOU  is referenced.
   B$JIT_C.:E05TOU  is referenced.
   F$JIT_C.:E05TOU  cannot be made into a system file and is referenced.
   B_STRINGS_C.:E05TOU  is referenced.
      No diagnostics issued in procedure FMI$INIT.
PL6.E3A0      #002=FMI$INIT File=FMI$RAN.:E05TSI                                 TUE 07/29/97 16:50 Page:174  

 **** Variables and constants ****

  ****  Section 000 RoData FMI$INIT

  ****  Scalars and arrays  ****
OctLoc.c.b A Datatyp(siz) R M Lvl/name                 OctLoc.c.b A Datatyp(siz) R M Lvl/name

     0-0-0/b STRC        r     1 ERRCGFILE                  3-0-0/b STRC        r     1 ERRNOACCESS
     4-0-0/b STRC        r     1 ERRNOCODE                  1-0-0/b STRC        r     1 ERRNOSHRDS
     2-0-0/b STRC        r     1 ERRSHRDS2BIG

  ****  Auto variables  ****

  ****  Scalars and arrays  ****
OctLoc.c.b A Datatyp(siz) R M Lvl/name                 OctLoc.c.b A Datatyp(siz) R M Lvl/name

     4-0-0/w PTR         r     1 CFU$                       6-0-0/w UBIN        r     1 DSACC
     7-0-0/w UBIN        r     1 DSSID                     11-0-0/w UBIN        r     1 DSWSQ
    10-0-0/w UBIN        r     1 HEADPP#                    3-0-0/w PTR         r     1 JDCB$
     5-0-0/w PTR         r     1 TEMP_DCB                   5-0-0/w STRC        r     1 TEMP_DCB_R

  ****  SYMREF variables  ****

  ****  Scalars and arrays  ****
OctLoc.c.b A Datatyp(siz) R M Lvl/name                 OctLoc.c.b A Datatyp(siz) R M Lvl/name

     0-0-0/w PTR         r     1 B$IS$                      0-0-0/w PTR         r     1 B$JIT$
     0-0-0/w UBIN        r     1 LS0UBIN                    0-0-0/w SBIN        r     1 MM_SHAREDSUSE

  ****  BASED and DCB variables  ****

  ****  Scalars and arrays  ****
OctLoc.c.b A Datatyp(siz) R M Lvl/name                 OctLoc.c.b A Datatyp(siz) R M Lvl/name

     0-0-0/d STRC(8856)  r     1 B$JIT                      0-0-0/d ASTR(3528)  r     1 F$DCB
     0-0-0/w STRC(288)   r     1 FM$CFU                     0-0-0/w STRC(288)   r     1 FM$CFUR

PL6.E3A0      #002=FMI$INIT File=FMI$RAN.:E05TSI                                 TUE 07/29/97 16:50 Page:175  

   Procedure FMI$INIT requires 452 words for executable code.
   Procedure FMI$INIT requires 20 words of local(AUTO) storage.
PL6.E3A0      #002=FMI$INIT File=FMI$RAN.:E05TSI                                 TUE 07/29/97 16:50 Page:176  
          *** CROSS REFERENCE LISTING ***
**     DENOTES     IDENTIFIER DEFINITION
<<                 IDENTIFIER'S VALUE SET
>>                 IDENTIFIER'S VALUE USED
<>                 IDENTIFIER SET AND/OR USED
--                 IDENTIFIER REFERENCED
PL6.E3A0      #002=FMI$INIT File=FMI$RAN.:E05TSI                                 TUE 07/29/97 16:50 Page:177  
          MINI XREF LISTING

B$IS$
        30**DCL        31--REDEF
B$JIT.DCB$
       592**DCL      2049>>ASSIGN   2177>>ASSIGN
B$JIT.ERR
       502**DCL      2058<<ASSIGN   2121<>CALL     2143<>CALL     2154<<ASSIGN   2157<<ASSIGN   2160<<ASSIGN
      2164<<ASSIGN   2164>>ASSIGN
B$JIT.ERR.MID
       503**DCL       503--REDEF
B$JIT.PRIV.ACTIVE
       503**DCL      2052>>IF
B$JIT$
        29**DCL       497--IMP-PTR  2049>>ASSIGN   2052>>IF       2058>>ASSIGN   2121>>CALL     2143>>CALL
      2154>>ASSIGN   2157>>ASSIGN   2160>>ASSIGN   2164>>ASSIGN   2164>>ASSIGN   2177>>ASSIGN
CFU$
        19**DCL      1990--IMP-PTR  1996--IMP-PTR  2099<<ASSIGN   2102<>CALL     2104>>IF       2112>>ASSIGN
      2120>>ASSIGN   2121>>CALL     2121>>CALL     2123>>ASSIGN   2128>>ASSIGN   2131>>IF       2132>>ASSIGN
      2132>>ASSIGN   2133>>IF       2133>>ASSIGN   2134>>IF       2134>>IF       2143>>CALL     2143>>CALL
      2143>>CALL     2146>>ASSIGN   2147>>ASSIGN   2148>>ASSIGN   2149>>IF       2150>>ASSIGN   2178<<ASSIGN
      2186>>IF       2188<>CALL     2193>>ASSIGN   2194>>CALL     2194>>CALL     2197>>IF       2198>>IF
      2198>>IF       2198>>IF       2200>>ASSIGN   2201>>ASSIGN   2202>>CALL     2202>>CALL     2203>>ASSIGN
      2206>>IF       2206>>IF
DSACC
        24**DCL      2113<<ASSIGN   2114<<ASSIGN   2121<>CALL     2123>>IF       2140<<ASSIGN   2141<<ASSIGN
      2143<>CALL     2150>>IF       2192<<ASSIGN   2194<>CALL     2196>>IF       2205<>CALL
DSSID
        25**DCL      2098<<ASSIGN   2121<>CALL     2143<>CALL     2189<<ASSIGN   2194<>CALL     2205<>CALL
DSWSQ
        27**DCL      2096<<ASSIGN   2097<<ASSIGN   2121<>CALL     2143<>CALL     2149<>CALL     2190<<ASSIGN
      2191>>IF       2191<<ASSIGN   2194<>CALL     2199<>CALL     2205<>CALL
ERRCGFILE
      1969**DCL      2058>>ASSIGN
PL6.E3A0      #002=FMI$INIT File=FMI$RAN.:E05TSI                                 TUE 07/29/97 16:50 Page:178  
ERRNOACCESS
      1981**DCL      2160>>ASSIGN
ERRNOCODE
      1985**DCL      2164>>ASSIGN
ERRNOSHRDS
      1973**DCL      2154>>ASSIGN
ERRSHRDS2BIG
      1977**DCL      2157>>ASSIGN
F$DCB.ACS
      2016**DCL      2067>>IF       2086>>IF       2092>>IF       2098>>ASSIGN   2105>>IF       2126>>IF
      2189>>ASSIGN
F$DCB.ACTPOS
      2024**DCL      2024--REDEF
F$DCB.ARS
      1999**DCL      1999--REDEF
F$DCB.ASN
      2014**DCL      2051>>IF
F$DCB.ATTR
      2017**DCL      2018--REDEF
F$DCB.BORROW
      2032**DCL      2032--REDEF    2032--REDEF    2032--REDEF
F$DCB.CFU$
      2033**DCL      2086>>IF       2086>>IF       2092>>IF       2099>>ASSIGN   2178>>ASSIGN
F$DCB.CRECNO
      2036**DCL      2090<<ASSIGN   2093<<ASSIGN
F$DCB.CTG
      2012**DCL      2086>>IF
F$DCB.DCBNAME.L
      2046**DCL      2046--IMP-SIZ
F$DCB.ENQF
      2031**DCL      2100>>IF       2101<<ASSIGN
F$DCB.EOMCHAR
      2003**DCL      2003--REDEF
F$DCB.FFLG
      2003**DCL      2052>>IF       2055<<ASSIGN   2055>>ASSIGN   2113>>IF       2140>>IF       2186>>IF
F$DCB.FFLG.READ
PL6.E3A0      #002=FMI$INIT File=FMI$RAN.:E05TSI                                 TUE 07/29/97 16:50 Page:179  
      2004**DCL      2111>>IF       2139>>IF
F$DCB.FFLG.REATTR
      2004**DCL      2054>>IF
F$DCB.FLDID
      2027**DCL      2027--REDEF
F$DCB.FORM$
      2021**DCL      2021--REDEF
F$DCB.FSECT
      2037**DCL      2037--REDEF
F$DCB.FSN
      2014**DCL      2014--REDEF    2014--REDEF    2015--REDEF
F$DCB.FUN
      2013**DCL      2052>>IF       2086>>IF
F$DCB.GTYP
      2028**DCL      2094<<ASSIGN
F$DCB.HEADER$
      2020**DCL      2020--REDEF
F$DCB.IASN
      2040**DCL      2086>>IF       2091>>IF
F$DCB.IORG
      2035**DCL      2181>>IF
F$DCB.IXTNSIZE
      2018**DCL      2018--REDEF
F$DCB.LASTSTA$
      2008**DCL      2008--REDEF    2179>>ASSIGN
F$DCB.LVL
      2033**DCL      2033--REDEF
F$DCB.NAME.C
      2008**DCL      2008--REDEF
F$DCB.NOEOF
      2029**DCL      2029--REDEF
F$DCB.NRECS
      2019**DCL      2019--REDEF    2112<<ASSIGN   2147<<ASSIGN
F$DCB.NRECX
      2038**DCL      2038--REDEF
F$DCB.OHDR
PL6.E3A0      #002=FMI$INIT File=FMI$RAN.:E05TSI                                 TUE 07/29/97 16:50 Page:180  
      2030**DCL      2030--REDEF
F$DCB.ORG
      2013**DCL      2013--REDEF    2051>>IF       2067>>IF       2072>>DOCASE   2095>>IF       2186>>IF
F$DCB.PRECNO
      2036**DCL      2036--REDEF
F$DCB.RA
      2030**DCL      2071>>IF
F$DCB.RCSZ
      2041**DCL      2041--REDEF
F$DCB.RES
      2009**DCL      2009--REDEF
F$DCB.SETX
      2021**DCL      2021--REDEF
F$DCB.TAB$
      2020**DCL      2021--REDEF
F$DCB.TDA
      2035**DCL      2035--REDEF
F$DCB.WSN
      2010**DCL      2010--REDEF
F$DCB.WSR
      2016**DCL      2096>>IF       2096>>ASSIGN   2190>>ASSIGN
F$DCB.XTNSIZE
      2016**DCL      2133>>ASSIGN
FM$CFU.ACCTX
      1991**DCL      1991--REDEF
FM$CFU.AFIT
      1990**DCL      2092>>IF
FM$CFU.FMOD
      1990**DCL      2123<<ASSIGN   2150<<ASSIGN   2198>>IF
FM$CFU.FUN
      1990**DCL      2086>>IF       2086>>IF
FM$CFU.NAMEX
      1991**DCL      2198>>IF
FM$CFU.NRECS
      1991**DCL      2112>>ASSIGN   2121>>CALL     2121<>CALL     2132<<ASSIGN   2133<<ASSIGN   2134>>IF
      2134>>IF       2143>>CALL     2143<>CALL     2147>>ASSIGN   2148>>ASSIGN   2194>>CALL     2194<>CALL
PL6.E3A0      #002=FMI$INIT File=FMI$RAN.:E05TSI                                 TUE 07/29/97 16:50 Page:181  
      2202<>CALL     2203>>ASSIGN
FM$CFU.UGRANS
      1992**DCL      2132>>ASSIGN   2133>>IF       2149>>IF       2198>>IF       2206>>IF
FM$CFU.USECNT
      1992**DCL      2197>>IF       2206>>IF
FM$CFUR.HEADPP#
      1996**DCL      2104>>IF       2120>>ASSIGN   2143<>CALL     2146<<ASSIGN   2186>>IF       2193>>ASSIGN
      2200<<ASSIGN   2202<>CALL
FM$CFUR.TAILPP#
      1996**DCL      2128<<ASSIGN   2131>>IF       2201<<ASSIGN
FMG$INIT
        34**DCL-ENT  2076--CALL
FMG_INIT
      2076**LABEL    2068--GOTO
FMH$INIT
        35**DCL-ENT  2074--CALL
FMI$DSREAD
        36**DCL-ENT  2149--CALL
FMI$DSWRITE
        37**DCL-ENT  2199--CALL
HEADPP#
        26**DCL      2120<<ASSIGN   2121<>CALL     2142<<ASSIGN   2143<>CALL     2146>>ASSIGN   2193<<ASSIGN
      2194<>CALL     2202<>CALL
JDCB$
        18**DCL      1999--IMP-PTR  2049<<ASSIGN   2051>>IF       2051>>IF       2052>>IF       2052>>IF
      2054>>IF       2055>>ASSIGN   2055>>ASSIGN   2067>>IF       2067>>IF       2071>>IF       2072>>DOCASE
      2086>>IF       2086>>IF       2086>>IF       2086>>IF       2086>>IF       2086>>IF       2090>>ASSIGN
      2091>>IF       2092>>IF       2092>>IF       2093>>ASSIGN   2094>>ASSIGN   2095>>IF       2096>>IF
      2096>>ASSIGN   2098>>ASSIGN   2099>>ASSIGN   2100>>IF       2101>>ASSIGN   2105>>IF       2111>>IF
      2112>>ASSIGN   2113>>IF       2126>>IF       2133>>ASSIGN   2139>>IF       2140>>IF       2147>>ASSIGN
      2177<<ASSIGN   2178>>ASSIGN   2179>>ASSIGN   2181>>IF       2186>>IF       2186>>IF       2189>>ASSIGN
      2190>>ASSIGN
LS0UBIN
        31**DCL      2098>>ASSIGN   2189>>ASSIGN
MMERR
      2150**LABEL    2121--CALLALT  2143--CALLALT
PL6.E3A0      #002=FMI$INIT File=FMI$RAN.:E05TSI                                 TUE 07/29/97 16:50 Page:182  
MMH$FDS
        40**DCL-ENT  2205--CALL
MMH$MAP_DS
        38**DCL-ENT  2121--CALL     2194--CALL
MMH$SHARE_DS
        39**DCL-ENT  2143--CALL
MMJ$FPPCHAIN
        41**DCL-ENT  2202--CALL
MMV$CLOSE
        42**DCL-ENT  2183--CALL
MM_SHAREDSUSE
        32**DCL      2148<<ASSIGN   2148>>ASSIGN   2203<<ASSIGN   2203>>ASSIGN
NOACCESS
      2160**LABEL    2111--GOTO     2139--GOTO
SHRDS2BIG
      2157**LABEL    2134--GOTO
SHRDSERR
      2154**LABEL    2105--GOTO     2131--GOTO
TEMP_DCB
        20**DCL        21--REDEF    2179<<ASSIGN   2181>>IF
TEMP_DCB_R.ADDR_BITS
        22**DCL      2180<<ASSIGN
UQB$MENQX
        43**DCL-ENT  2102--CALL     2188--CALL
PL6.E3A0      #002=FMI$INIT File=FMI$RAN.:E05TSI                                 TUE 07/29/97 16:50 Page:183  
              *** CROSS REFERENCE LISTING ***
    **     DENOTES     IDENTIFIER DEFINITION
    <<                 IDENTIFIER'S VALUE SET
    >>                 IDENTIFIER'S VALUE USED
    <>                 IDENTIFIER SET AND/OR USED
    --                 IDENTIFIER REFERENCED
PL6.E3A0      #002=FMI$INIT File=FMI$RAN.:E05TSI                                 TUE 07/29/97 16:50 Page:184  
              MINI UREF LISTING

F$CFU$    1582**DCL
FM$SET$    1583**DCL
FMI$DSREL    2176**ENTRY
FMI$INIT      16**PROC
FM_CFUWAIT    1582**DCL
FM_CFUWGRB    1582**DCL
FM_EOP    1580**DCL
FM_FRMAX    1579**DCL
FM_FRZERO    1579**DCL
FM_GCT    1583**DCL
FM_GIP    1583**DCL
FM_GPSDA    1580**DCL
FM_HASH    1581**DCL
FM_MADSDA    1580**DCL
FM_PADSDA    1580**DCL
FM_SRMAX    1579**DCL
FM_SRZERO    1579**DCL
FM_SYSACCTX    1583**DCL
FM_SYSSETX    1583**DCL
FM_TRUNC    1581**DCL
FM_WSQ    1581**DCL
F_CWLK    1582**DCL
F_CWUSER    1582**DCL
F_DCBLOCK    1581**DCL
UQB$MDEQ      44**DCL-ENT

PL6.E3A0      #003=FMI$EA File=FMI$RAN.:E05TSI                                   TUE 07/29/97 16:51 Page:185  
      983        1        /*T***********************************************************/
      984        2        /*T*                                                         */
      985        3        /*T* Copyright (c) Bull HN Information Systems Inc., 1997    */
      986        4        /*T*                                                         */
      987        5        /*T***********************************************************/
      988        6        /*F*   NAME:   FMI$EA
      989        7        *      PURPOSE:  End-action routine for no-wait reads */
      990        8        /**/
      991        9        /**/
      992       10        /**/
      993       11        /*D*   NAME:   FMI$EA
      994       12        *      CALL:   CALL FMI$EA(Q$);
      995       13        *                Called by IOQ as an end-action routine
      996       14        *      INPUT:  Q$ - PTR to queue packet
      997       15        *              End-action info is stamp word for first granule
      998       16        *      OUTPUT: TYC.DI set in queue packet if any stamp is wrong
      999       17        *      DESCRIPTION:  The user page table pointer from the queue
     1000       18        *        packet is placed in WSQ 8 and HFC$ASSOCCLR called to
     1001       19        *        clear the page table cache.  MMC$CP_IOM is called to
     1002       20        *        restore CPU access to the buffer pages.  The stamp in
     1003       21        *        each granule header is checked, and if any are wrong
     1004       22        *        the entire granule in core is clobbered, and a -1 is
     1005       23        *        placed in word zero.  */
     1006       24        /**/
     1007       25        FMI$EA: PROC(N$REQ);
     1008       26        /* PARAMETERS */
     1009       27        %INCLUDE N$REQ;
     1010      101        %N$REQ (STCLASS="");
     1011      159        /* EXTERNAL ROUTINES */
     1012      160    1   DCL FMB$LOGERR ENTRY(11);
     1013      161    1   DCL FMB$QUEUE ENTRY(9) ALTRET;
     1014      162    1   DCL FMD$FLSHBUF ENTRY(1);
     1015      163    1   DCL FMD$GETBUF ENTRY(3);
     1016      164    1   DCL FMD$RELBUF ENTRY(1);
     1017      165    1   DCL HFC$ASSOCCLR ENTRY(3);
     1018      166    1   DCL MM0$FINDLS ENTRY(2);
     1019      167    1   DCL M$MREAD ENTRY(1)ALTRET;
PL6.E3A0      #003=FMI$EA File=FMI$RAN.:E05TSI                                   TUE 07/29/97 16:51 Page:186  
     1020      168    1   DCL M$MWRITE ENTRY(1)ALTRET;
     1021      169    1   DCL MMC$CP_IOM ENTRY(3);
     1022      170    1   DCL MMC$ONLY_IOM ENTRY(3);
     1023      171    1   DCL NIQ$REL ENTRY(1) ALTRET;
     1024      172        /* EXTERNAL DATA */
     1025      173    1   DCL B$LS$ PTR SYMREF;
     1026      174    1   DCL B$MISC$ PTR SYMREF;
     1027      175    1   DCL B$MISC2$ PTR SYMREF;
     1028      176    1   DCL B$JIT$ PTR SYMREF;
     1029      177    1   DCL FM_FRZERO UBIN SYMREF;
     1030      178    1   DCL F_DCBLOCK SBIN SYMREF;
     1031      179        /* LOCAL AUTOMATIC STORAGE */
     1032      180    1   DCL VPNO SBIN;
     1033      181    1   DCL N SBIN;
     1034      182    1   DCL 1 STAMP,
     1035      183    1         2 HASH UBIN(27) UNAL,
     1036      184    1         2 GMOD UBIN(9) UNAL;
     1037      185    1   DCL P$ PTR;
     1038      186    1   DCL SIZ UBIN;
     1039      187    1   DCL BLKNO SBIN;
     1040      188    1   DCL B$ PTR;
     1041      189    1   DCL B$UBIN REDEF B$ UBIN;
     1042      190    1   DCL PGS UBIN;
     1043      191    1   DCL SAVSTMP BIT(36);
     1044      192    1   DCL SAVBUF(0:2) UBIN;
     1045      193    1   DCL JDCB$ PTR;
     1046      194    1   DCL SAVDA UBIN;
     1047      195    1   DCL CFU$ REDEF SAVDA PTR;
     1048      196        /* INCLUDE FILES */
     1049      197        %INCLUDE B$USER;
     1050      413        %INCLUDE B_STRINGS_C;
     1051      542        %B$USERREFS;
     1052      546        %INCLUDE F_CP6;
     1053     1571        %INCLUDE CP_6_SUBS;
     1054     2111        %INCLUDE F$JIT_C;
     1055     2541        %INCLUDE FM$MACROS;
     1056     2916        %INCLUDE N_FC_C;
PL6.E3A0      #003=FMI$EA File=FMI$RAN.:E05TSI                                   TUE 07/29/97 16:51 Page:187  
     1057     2953        %INCLUDE S_WSPTD_R;
     1058     2969        %INCLUDE HF_LOCK_C;
     1059     2983        %INCLUDE HF_DATA_R;
     1060     3026        %INCLUDE B_MLSMAC_C;
     1061     3968        %INCLUDE F_ERRORS_C;
     1062     4208        %INCLUDE FM$RANEA;
     1063     4218        /* CONSTANT STORAGE */
     1064     4219    1   DCL 1 DESCINIT CONSTANT ALIGNED,
     1065     4220    1         2 BOUND UBIN(20) UNAL INIT(0),
     1066     4221    1         2 FLGS BIT(3) UNAL INIT('7'O),
     1067     4222    1         2 WSQ UBIN(9) UNAL INIT(%IOENDWSQ),
     1068     4223    1         2 TYP UBIN(4) UNAL INIT(2);
     1069     4224    1   DCL X1 CONSTANT SBIN INIT(-1);
     1070     4225    1   DCL X REDEF X1 CHAR(4);
     1071     4226        %FPT_READ(FPTN=CREAD,STCLASS=CONSTANT,FULL=YES);
     1072     4265        %FPT_READ(FPTN=AREAD,STCLASS=);
     1073     4304        %MACRO F$DCB(BASED="BASED(JDCB$)");
     1074     4305        %INCLUDE F$DCB;
     1075     4354        %MEND;
     1076     4355        %F$DCB;
     1077     4405        /* BASED STRUCTURES */
     1078     4406        %B_MLS (FPTN=B$MLNK,STCLASS=BASED);
     1079     5221        %FM$RANEA (BASED="BASED(B$)");
     1080     5224        %N$REQ(NAME=REALREQ,STCLASS=BASED);
     1081     5282    1   DCL ZAP CHAR(SIZ) BASED ALIGNED;
     1082     5283    1   DCL WRD UBIN BASED ALIGNED;
     1083     5284    1   DCL WRDS3(0:2) UBIN BASED ALIGNED;
     1084     5285    1   DCL LS#N(0:0)BASED DALIGNED BIT(72);
     1085     5286    1   DCL 1 PAGES(0:0) BASED(B$MISC2$) ALIGNED,
     1086     5287    1         2 W0 UBIN,
     1087     5288    1         2 * CHAR(4092);
     1088     5289    1   DCL 1 RANGRAN BASED(B$)ALIGNED,
     1089     5290    1         2 STAMP BIT(36),
     1090     5291    1         2 WDS(0:1022)UBIN;
     1091     5292        %FM$CFU(BASED="BASED(CFU$)");
     1092     5298        /**/
     1093     5299    1           SAVSTMP='0'B;
PL6.E3A0      #003=FMI$EA File=FMI$RAN.:E05TSI                                   TUE 07/29/97 16:51 Page:188  
     1094     5300    1           B$UBIN=N$REQ.EAINFO;            /* Ptr to other Q packet              */
     1095     5301    1           VPNO=FM$RANEA.VPNO;
     1096     5302    1           PGS=FM$RANEA.PGS;
     1097     5303    1           STAMP=FM$RANEA.STAMP;
     1098     5304    1           STAMP.GMOD=STAMP.GMOD+N$REQ.EAINFOX;
     1099     5305    1           BLKNO=FM$RANEA.BLKNO+N$REQ.EAINFOX;
     1100     5306                                                /****  LOCK DISABLES  ****/
     1101     5307                %LOCK (G#=F_DCBLOCK);
     1102     5310    1           S_WSPTD.BLKNO(%IOENDWSQ)=B$USRT$->B$USER.PT(N$REQ.USER#);
              5310                    /* Page table ptr */
     1103     5311    1           CALL HFC$ASSOCCLR (%IOENDWSQ,0,16384); /*MAX Dense PT*/
     1104     5312    1           CALL MMC$CP_IOM(%IOENDWSQ,VPNO,PGS); /* Restore CPU access to pages   */
     1105     5313    1           S_WSPTD.BLKNO(%IOENDWSQ)=N$REQ.PTP / (HW_PTB_UNITS/HW_IOPTP_UNITS);
     1106     5314    1           CALL HFC$ASSOCCLR (%IOENDWSQ,0,16384); /*MAX Dense PT*/
     1107     5315        /**/
     1108     5316    1           B$LS$->B$MLNK.MISC=DESCINIT;    /* BUILD WSQ %IOENDWSQ DESCRIPTOR     */
     1109     5317    1           B$LS$->B$MLNK.MISC.BOUND=N$REQ.BUFSIZE-1;
     1110     5318    1           B$LS$->B$MLNK.MISC.BASE=BITBIN(N$REQ.BUFVIRT)+
     1111     5319    1             MOD(N$REQ.PTP,HW_PTB_UNITS/HW_IOPTP_UNITS)*HW_IOPTP_UNITS*4096;
     1112     5320    1           P$=B$MISC$;                     /* POINT THRU DESCRIPTOR JUST BUILT   */
     1113     5321    1           N=N$REQ.BUFSIZE;                /* BUFFER SIZE IN BYTES               */
     1114     5322    2           DO WHILE(N>0);
     1115     5323    3              IF P$->WRD~=BITBIN(STAMP) THEN DO;
     1116     5324    4                 IF NOT SAVSTMP AND FM$RANEA.TYP~=0 THEN DO; /* First error      */
     1117     5325    4                    SAVSTMP=STAMP;
     1118     5326    4                    SAVBUF=P$->WRDS3;
     1119     5327    4                    SAVDA=BITBIN(N$REQ.DLA)+(BLKNO-FM$RANEA.BLKNO-
     1120     5328    4                      N$REQ.EAINFOX)*16;
     1121     5329    4                    END;
     1122     5330    3                 SIZ=4096;
     1123     5331    3                 IF N<4096 THEN SIZ=N;
     1124     5332    3                 P$->ZAP=X;                /* CLEAR BUFFER                       */
     1125     5333    3                 N$REQ.TYC.DI='1'B;
     1126     5334    3                 N$REQ.TYC.EGV='1'B;
     1127     5335    3                 END;
     1128     5336    2              ELSE
     1129     5337    2                 P$->WRD=BLKNO;
PL6.E3A0      #003=FMI$EA File=FMI$RAN.:E05TSI                                   TUE 07/29/97 16:51 Page:189  
     1130     5338    2              P$=PINCRW(P$,1024);
     1131     5339    2              STAMP.GMOD=STAMP.GMOD+1;
     1132     5340    2              BLKNO=BLKNO+1;
     1133     5341    2              N=N-4096;
     1134     5342    2              END;
     1135     5343        /**/
     1136     5344    1           FM$RANEA.CNT=FM$RANEA.CNT-1;    /* Decr count of I/Os                 */
     1137     5345    2           IF FM$RANEA.CNT=0 THEN DO;      /* All done                           */
     1138     5346                   %UNLOCK (G#=F_DCBLOCK);
     1139     5349    2              B$->REALREQ='0'B;
     1140     5350    2              B$->REALREQ.ERR$=ADDR(NIL);
     1141     5351    2              B$->REALREQ.IOQFLG.INUSE = '1'B;
     1142     5352    2              CALL NIQ$REL(B$);
     1143     5353    2              N$REQ.OPFLG.CLR='1'B;        /* Prepare to clear cache             */
     1144     5354    2              END;
     1145     5355    2           ELSE DO;
     1146     5356    2              S_WSPTD.BLKNO(%IOENDWSQ)=B$USRT$->B$USER.PT(N$REQ.USER#);
              5356                       /* Page tbl ptr */
     1147     5357    2              CALL HFC$ASSOCCLR (%IOENDWSQ,0,16384); /*MAX Dense PT*/
     1148     5358    2              CALL MMC$ONLY_IOM(%IOENDWSQ,VPNO,PGS);
     1149     5359                   %UNLOCK (G#=F_DCBLOCK);
     1150     5362    2              END;
     1151     5363                                                /****  UNLOCK ENABLES  ****/
     1152     5364        /**/
     1153     5365    1           IF SAVSTMP THEN
     1154     5366    1              CALL FMB$LOGERR(%E$MI,5,8,SAVDA,ADDR(SAVBUF),0,1,2,SAVSTMP,1,ADDR(N$REQ))
              5366                       ;
     1155     5367    1           RETURN;
     1156     5368        %EJECT;
PL6.E3A0      #003=FMI$EA File=FMI$RAN.:E05TSI                                   TUE 07/29/97 16:51 Page:190  
     1157     5369        /*F*   NAME:   FMI$DSREAD
     1158     5370        *      PURPOSE:Read a random file into the user data segment.
     1159     5371        *      INPUT:  The parameter is the requesting WSQ (4,5,6,9).
     1160     5372        *      INTERFACE: MM0$FINDLS, FMD$FLSHBUF, FMD$GETBUF, M$MREAD
     1161     5373        *      DESCRIPTION: The first granule has the first word of each other granule,
     1162     5374        *        so it is read into BUF0 first. Then a descriptor framing the data
     1163     5375        *        segment is formed in B$MISC$. The FFLG in the DCB is saved and set
     1164     5376        *        to FFLG_READ so that M$MREAD will work, even if file is open
     1165     5377        *        by an execute vehicle.
     1166     5378        *      ENTRY:   FMI$DSWRITE
     1167     5379        *      PURPOSE: Undo the work of FMI$DSREAD
     1168     5380        *      DESCRIPTION: All is as in FMI$DSREAD except that M$MWRITE is used
     1169     5381        *      and, of course, the order of events is slightly different.
     1170     5382        */
     1171     5383    1   FMI$DSREAD: ENTRY(N$REQ);
     1172     5384    1           CALL SETUPDS;
     1173     5385    1           F$DCB.FFLG.EXEC='0'B;
     1174     5386    1           CALL FMB$QUEUE(B$,0,4096,FM_FRZERO,%N_RDBIN,2,ENTADDR(NIL),0);
     1175     5387    1           IF RANGRAN.STAMP~=BINBIT(F$DCB.HASH,27) THEN RANGRAN='0'B;
     1176     5388    1   COMMONRW:;
     1177     5389    1           CALL RESETMISC;
     1178     5390    1           IF F$DCB.FFLG=%FFLG_WNEW# THEN CALL M$MWRITE(AREAD)ALTRET(HERE);
     1179     5391    1           ELSE CALL M$MREAD(AREAD)ALTRET(HERE);
     1180     5392    1   HERE:   CALL RESETMISC;                 /* RANEA ALSO USED IT                 */
     1181     5393    2           DO PGS=0 TO FM$CFU.NRECS-1;
     1182     5394    2              IF PAGES.W0(PGS)~=BITBIN('777777777777'O) THEN
     1183     5395    2                 PAGES.W0(PGS)=RANGRAN.WDS(PGS);
     1184     5396    2              END;
     1185     5397    1           F$DCB.FFLG=SAVSTMP;
     1186     5398    1           B$JIT.ERR='0'B;
     1187     5399    1           CALL FMD$RELBUF(2);
     1188     5400    1           RETURN;
     1189     5401        %EJECT;
PL6.E3A0      #003=FMI$EA File=FMI$RAN.:E05TSI                                   TUE 07/29/97 16:51 Page:191  
     1190     5402    1   FMI$DSWRITE: ENTRY(N$REQ);
     1191     5403    1           CALL SETUPDS;
     1192     5404    1           F$DCB.FFLG=%FFLG_WNEW#;
     1193     5405    1           RANGRAN=BINBIT(F$DCB.HASH,27);
     1194     5406    2           DO PGS=0 TO FM$CFU.NRECS-1;
     1195     5407    2              RANGRAN.WDS(PGS)=PAGES.W0(PGS);
     1196     5408    2              END;
     1197     5409    1           N = FM_FRZERO;
     1198     5410    1           CALL FMB$QUEUE(B$,0,4096,N,%N_WRBIN,2,ENTADDR(NIL),0);
     1199     5411    1           GOTO COMMONRW;
     1200     5412        %EJECT;
PL6.E3A0      #003=FMI$EA File=FMI$RAN.:E05TSI                                   TUE 07/29/97 16:51 Page:192  
     1201     5413        /*I*   NAME:   SETUPDS
     1202     5414        *      PURPOSE: Sets up the auto frame and B$MISC for %DSREAD and %DSWRITE.
     1203     5415        */
     1204     5416    1   SETUPDS: PROC;
     1205     5417    2           JDCB$=B$JIT.DCB$;
     1206     5418    2           CFU$=F$DCB.CFU$;
     1207     5419    2           SAVSTMP=F$DCB.FFLG;
     1208     5420    2           CALL FMD$FLSHBUF(2);
     1209     5421    2           CALL FMD$GETBUF(2,1,B$);
     1210     5422    2           F$DCB.CRECNO=1;
     1211     5423    2           AREAD=CREAD;
     1212     5424    2           AREAD.V_=VECTOR(AREAD.V);
     1213     5425    3           DO WHILE(DCBADDR(AREAD.V.DCB#)~=JDCB$);
     1214     5426    3              AREAD.V.DCB#=AREAD.V.DCB#+1;
     1215     5427    3              END;
     1216     5428    2   RESETMISC: ENTRY;
     1217     5429    2           CALL MM0$FINDLS(ADDR(N$REQ)->WRD,P$);
     1218     5430    2           B$LS$->B$MLNK.MISC2=P$->LS#N(F$DCB.ACS);
     1219     5431    2           B$LS$->B$MLNK.MISC2.FLGS=B$LS$->B$MLNK.MISC2.FLGS|'2'O; /* WRITE      */
     1220     5432    2           AREAD.BUF_.BOUND=B$LS$->B$MLNK.MISC2.BOUND;
     1221     5433    2           AREAD.BUF_.BUF$=B$MISC2$;
     1222     5434    2           RETURN;
     1223     5435    2   END SETUPDS;
     1224     5436    1   END FMI$EA;

PL6.E3A0      #003=FMI$EA File=FMI$RAN.:E05TSI                                   TUE 07/29/97 16:51 Page:193  
--  Include file information  --

   F$DCB.:E05TOU  is referenced.
   FM$RANEA.:E05TOU  is referenced.
   F_ERRORS_C.:E05TOU  is referenced.
   B_MLSMAC_C.:E05TOU  is referenced.
   HF_DATA_R.:E05TOU  cannot be made into a system file and is referenced.
   HF_LOCK_C.:E05TOU  cannot be made into a system file and is referenced.
   S_WSPTD_R.:E05TOU  cannot be made into a system file and is referenced.
   N_FC_C.:E05TOU  is referenced.
   FM$MACROS.:E05TOU  is referenced.
   B$JIT_C.:E05TOU  is referenced.
   F$JIT_C.:E05TOU  cannot be made into a system file and is referenced.
   CP_6_SUBS.:E05TOU  is referenced.
   F_CP6.:E05TOU  is referenced.
   B_STRINGS_C.:E05TOU  is referenced.
   B$USER.:E05TOU  cannot be made into a system file and is referenced.
   N$REQ.:E05TOU  is referenced.
      No diagnostics issued in procedure FMI$EA.

   Procedure FMI$EA requires 426 words for executable code.
   Procedure FMI$EA requires 48 words of local(AUTO) storage.

    No errors detected in file FMI$RAN.:E05TSI    .

PL6.E3A0      #003=FMI$EA File=FMI$RAN.:E05TSI                                   TUE 07/29/97 16:51 Page:194  

 Object Unit name= FMI$EA                                     File name= FMI$RAN.:E05TOU
 UTS= JUL 29 '97 16:51:06.56 TUE                              Compiler= PL-6/E31         Sev=      00
 SharedLib= :SHARED_SYSTEM                                    Alt SharedLib=


    ****  Control sections  ****

 Sect   Type Bound  Init  Size OctSiz  Section name(segment info)
    0  RoData even  UTS     16     20  FMI$EA
    1   Proc  even  none   426    652  FMI$EA
    2  RoData even  none    28     34  FMI$EA

    ****  Entry defs  ****

                              Check   Calling
                             calling  sequence
  Sect OctLoc Primary Altret sequence   type   Parms  Name
     1      0   yes            yes      Std        1  FMI$EA
     1    331                  yes      Std        1  FMI$DSREAD
     1    454                  yes      Std        1  FMI$DSWRITE
PL6.E3A0      #003=FMI$EA File=FMI$RAN.:E05TSI                                   TUE 07/29/97 16:51 Page:195  

  ****  Entry refs  ****

         Check        Calling
        calling       sequence
Altret sequence SRef   type   Args  Name
         yes           Std       1 HFC$LOCK
         yes           Std       3 HFC$ASSOCCLR
         yes           Std       1 HFC$UNLOCK
 yes     yes           Std       9 FMB$QUEUE
         yes           Std       1 FMD$RELBUF
 yes     yes           Std       1 M$MWRITE
         yes           Std       3 MMC$CP_IOM
 yes     yes           Std       1 NIQ$REL
         yes           Std      11 FMB$LOGERR
 yes     yes           Std       1 M$MREAD
         yes           Std       3 MMC$ONLY_IOM
         yes           Std       1 FMD$FLSHBUF
         yes           Std       2 MM0$FINDLS
         yes           Std       3 FMD$GETBUF
                       Std       0 B_CONSPOOL_D
                       nStd      0 X66_AUTO_1
                       nStd      0 X66_ARET

  ****  Data refs  ****

  Flags:  r = read only, s = secondary
Flgs Name                             Flgs Name                             Flgs Name
     B$LS$                                 B$MISC$                               B$MISC2$
     B$JIT$                                FM_FRZERO                             F_DCBLOCK
     B$USRT$                               S_WSPTD                               HW_PTB_UNITS
     HW_IOPTP_UNITS                        B_VECTNIL
PL6.E3A0      #003=FMI$EA File=FMI$RAN.:E05TSI                                   TUE 07/29/97 16:51 Page:196  

  ****  Segment refs  ****

  Flags:  r = read only, s = secondary
Flgs Name                             Flgs Name                             Flgs Name
     ISSID                                 NULLSID                               ROSID
PL6.E3A0      #003=FMI$EA File=FMI$RAN.:E05TSI                                   TUE 07/29/97 16:51 Page:197  


      983        1        /*T***********************************************************/
      984        2        /*T*                                                         */
      985        3        /*T* Copyright (c) Bull HN Information Systems Inc., 1997    */
      986        4        /*T*                                                         */
      987        5        /*T***********************************************************/
      988        6        /*F*   NAME:   FMI$EA
      989        7        *      PURPOSE:  End-action routine for no-wait reads */
      990        8        /**/
      991        9        /**/
      992       10        /**/
      993       11        /*D*   NAME:   FMI$EA
      994       12        *      CALL:   CALL FMI$EA(Q$);
      995       13        *                Called by IOQ as an end-action routine
      996       14        *      INPUT:  Q$ - PTR to queue packet
      997       15        *              End-action info is stamp word for first granule
      998       16        *      OUTPUT: TYC.DI set in queue packet if any stamp is wrong
      999       17        *      DESCRIPTION:  The user page table pointer from the queue
     1000       18        *        packet is placed in WSQ 8 and HFC$ASSOCCLR called to
     1001       19        *        clear the page table cache.  MMC$CP_IOM is called to
     1002       20        *        restore CPU access to the buffer pages.  The stamp in
     1003       21        *        each granule header is checked, and if any are wrong
     1004       22        *        the entire granule in core is clobbered, and a -1 is
     1005       23        *        placed in word zero.  */
     1006       24        /**/
     1007       25        FMI$EA: PROC(N$REQ);

     25  1 000000   000000 700200 xent  FMI$EA       TSX0  ! X66_AUTO_1
         1 000001   000060 000001                    ZERO    48,1

     1008       26        /* PARAMETERS */
     1009       27        %INCLUDE N$REQ;
     1010      101        %N$REQ (STCLASS="");
     1011      159        /* EXTERNAL ROUTINES */
     1012      160    1   DCL FMB$LOGERR ENTRY(11);
     1013      161    1   DCL FMB$QUEUE ENTRY(9) ALTRET;
     1014      162    1   DCL FMD$FLSHBUF ENTRY(1);
PL6.E3A0      #003=FMI$EA File=FMI$RAN.:E05TSI                                   TUE 07/29/97 16:51 Page:198  
     1015      163    1   DCL FMD$GETBUF ENTRY(3);
     1016      164    1   DCL FMD$RELBUF ENTRY(1);
     1017      165    1   DCL HFC$ASSOCCLR ENTRY(3);
     1018      166    1   DCL MM0$FINDLS ENTRY(2);
     1019      167    1   DCL M$MREAD ENTRY(1)ALTRET;
     1020      168    1   DCL M$MWRITE ENTRY(1)ALTRET;
     1021      169    1   DCL MMC$CP_IOM ENTRY(3);
     1022      170    1   DCL MMC$ONLY_IOM ENTRY(3);
     1023      171    1   DCL NIQ$REL ENTRY(1) ALTRET;
     1024      172        /* EXTERNAL DATA */
     1025      173    1   DCL B$LS$ PTR SYMREF;
     1026      174    1   DCL B$MISC$ PTR SYMREF;
     1027      175    1   DCL B$MISC2$ PTR SYMREF;
     1028      176    1   DCL B$JIT$ PTR SYMREF;
     1029      177    1   DCL FM_FRZERO UBIN SYMREF;
     1030      178    1   DCL F_DCBLOCK SBIN SYMREF;
     1031      179        /* LOCAL AUTOMATIC STORAGE */
     1032      180    1   DCL VPNO SBIN;
     1033      181    1   DCL N SBIN;
     1034      182    1   DCL 1 STAMP,
     1035      183    1         2 HASH UBIN(27) UNAL,
     1036      184    1         2 GMOD UBIN(9) UNAL;
     1037      185    1   DCL P$ PTR;
     1038      186    1   DCL SIZ UBIN;
     1039      187    1   DCL BLKNO SBIN;
     1040      188    1   DCL B$ PTR;
     1041      189    1   DCL B$UBIN REDEF B$ UBIN;
     1042      190    1   DCL PGS UBIN;
     1043      191    1   DCL SAVSTMP BIT(36);
     1044      192    1   DCL SAVBUF(0:2) UBIN;
     1045      193    1   DCL JDCB$ PTR;
     1046      194    1   DCL SAVDA UBIN;
     1047      195    1   DCL CFU$ REDEF SAVDA PTR;
     1048      196        /* INCLUDE FILES */
     1049      197        %INCLUDE B$USER;
     1050      413        %INCLUDE B_STRINGS_C;
     1051      542        %B$USERREFS;
PL6.E3A0      #003=FMI$EA File=FMI$RAN.:E05TSI                                   TUE 07/29/97 16:51 Page:199  
     1052      546        %INCLUDE F_CP6;
     1053     1571        %INCLUDE CP_6_SUBS;
     1054     2111        %INCLUDE F$JIT_C;
     1055     2541        %INCLUDE FM$MACROS;
     1056     2916        %INCLUDE N_FC_C;
     1057     2953        %INCLUDE S_WSPTD_R;
     1058     2969        %INCLUDE HF_LOCK_C;
     1059     2983        %INCLUDE HF_DATA_R;
     1060     3026        %INCLUDE B_MLSMAC_C;
     1061     3968        %INCLUDE F_ERRORS_C;
     1062     4208        %INCLUDE FM$RANEA;
     1063     4218        /* CONSTANT STORAGE */
     1064     4219    1   DCL 1 DESCINIT CONSTANT ALIGNED,
     1065     4220    1         2 BOUND UBIN(20) UNAL INIT(0),
     1066     4221    1         2 FLGS BIT(3) UNAL INIT('7'O),
     1067     4222    1         2 WSQ UBIN(9) UNAL INIT(%IOENDWSQ),
     1068     4223    1         2 TYP UBIN(4) UNAL INIT(2);
     1069     4224    1   DCL X1 CONSTANT SBIN INIT(-1);
     1070     4225    1   DCL X REDEF X1 CHAR(4);
     1071     4226        %FPT_READ(FPTN=CREAD,STCLASS=CONSTANT,FULL=YES);
     1072     4265        %FPT_READ(FPTN=AREAD,STCLASS=);
     1073     4304        %MACRO F$DCB(BASED="BASED(JDCB$)");
     1074     4305        %INCLUDE F$DCB;
     1075     4354        %MEND;
     1076     4355        %F$DCB;
     1077     4405        /* BASED STRUCTURES */
     1078     4406        %B_MLS (FPTN=B$MLNK,STCLASS=BASED);
     1079     5221        %FM$RANEA (BASED="BASED(B$)");
     1080     5224        %N$REQ(NAME=REALREQ,STCLASS=BASED);
     1081     5282    1   DCL ZAP CHAR(SIZ) BASED ALIGNED;
     1082     5283    1   DCL WRD UBIN BASED ALIGNED;
     1083     5284    1   DCL WRDS3(0:2) UBIN BASED ALIGNED;
     1084     5285    1   DCL LS#N(0:0)BASED DALIGNED BIT(72);
     1085     5286    1   DCL 1 PAGES(0:0) BASED(B$MISC2$) ALIGNED,
     1086     5287    1         2 W0 UBIN,
     1087     5288    1         2 * CHAR(4092);
     1088     5289    1   DCL 1 RANGRAN BASED(B$)ALIGNED,
PL6.E3A0      #003=FMI$EA File=FMI$RAN.:E05TSI                                   TUE 07/29/97 16:51 Page:200  
     1089     5290    1         2 STAMP BIT(36),
     1090     5291    1         2 WDS(0:1022)UBIN;
     1091     5292        %FM$CFU(BASED="BASED(CFU$)");
     1092     5298        /**/
     1093     5299    1           SAVSTMP='0'B;

   5299  1 000002   200014 450100                    STZ     SAVSTMP,,AUTO

     1094     5300    1           B$UBIN=N$REQ.EAINFO;            /* Ptr to other Q packet              */

   5300  1 000003   200003 470500                    LDP0    @N$REQ,,AUTO
         1 000004   000024 235100                    LDA     20,,PR0
         1 000005   200012 755100                    STA     B$,,AUTO

     1095     5301    1           VPNO=FM$RANEA.VPNO;

   5301  1 000006   200012 471500                    LDP1    B$,,AUTO
         1 000007   100004 235100                    LDA     4,,PR1
         1 000010   200004 755100                    STA     VPNO,,AUTO

     1096     5302    1           PGS=FM$RANEA.PGS;

   5302  1 000011   100005 235100                    LDA     5,,PR1
         1 000012   200013 755100                    STA     PGS,,AUTO

     1097     5303    1           STAMP=FM$RANEA.STAMP;

   5303  1 000013   100002 236100                    LDQ     2,,PR1
         1 000014   200006 756100                    STQ     STAMP,,AUTO

     1098     5304    1           STAMP.GMOD=STAMP.GMOD+N$REQ.EAINFOX;

   5304  1 000015   200006 236100                    LDQ     STAMP,,AUTO
         1 000016   000777 376007                    ANQ     511,DL
         1 000017   000025 036100                    ADLQ    21,,PR0
         1 000020   200006 552104                    STBQ    STAMP,'04'O,AUTO

PL6.E3A0      #003=FMI$EA File=FMI$RAN.:E05TSI                                   TUE 07/29/97 16:51 Page:201  
     1099     5305    1           BLKNO=FM$RANEA.BLKNO+N$REQ.EAINFOX;

   5305  1 000021   100003 236100                    LDQ     3,,PR1
         1 000022   000025 036100                    ADLQ    21,,PR0
         1 000023   200011 756100                    STQ     BLKNO,,AUTO

     1100     5306                                                /****  LOCK DISABLES  ****/
     1101     5307                %LOCK (G#=F_DCBLOCK);

   5308  1 000024   000000 630400 2                  EPPR0   0
         1 000025   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 000026   000000 701000 xent               TSX1    HFC$LOCK
         1 000027   000000 011000                    NOP     0

     1102     5310    1           S_WSPTD.BLKNO(%IOENDWSQ)=B$USRT$->B$USER.PT(N$REQ.USER#);
              5310                    /* Page table ptr */

   5310  1 000030   200003 470500                    LDP0    @N$REQ,,AUTO
         1 000031   000027 236100                    LDQ     23,,PR0
         1 000032   000004 736000                    QLS     4
         1 000033   017760 376007                    ANQ     8176,DL
         1 000034   000000 471400 xsym               LDP1    B$USRT$
         1 000035   100014 220106                    LDX0    12,QL,PR1
         1 000036   000007 740000 xsym               STX0    S_WSPTD+7

     1103     5311    1           CALL HFC$ASSOCCLR (%IOENDWSQ,0,16384); /*MAX Dense PT*/

   5311  1 000037   000002 630400 2                  EPPR0   2
         1 000040   000021 631400 xsym               EPPR1   B_VECTNIL+17
         1 000041   000000 701000 xent               TSX1    HFC$ASSOCCLR
         1 000042   000000 011000                    NOP     0

     1104     5312    1           CALL MMC$CP_IOM(%IOENDWSQ,VPNO,PGS); /* Restore CPU access to pages   */

   5312  1 000043   200013 630500                    EPPR0   PGS,,AUTO
         1 000044   200044 450500                    STP0    AREAD+18,,AUTO
         1 000045   200004 631500                    EPPR1   VPNO,,AUTO
PL6.E3A0      #003=FMI$EA File=FMI$RAN.:E05TSI                                   TUE 07/29/97 16:51 Page:202  
         1 000046   200043 451500                    STP1    AREAD+17,,AUTO
         1 000047   000002 236000 2                  LDQ     2
         1 000050   200042 756100                    STQ     AREAD+16,,AUTO
         1 000051   200042 630500                    EPPR0   AREAD+16,,AUTO
         1 000052   000021 631400 xsym               EPPR1   B_VECTNIL+17
         1 000053   000000 701000 xent               TSX1    MMC$CP_IOM
         1 000054   000000 011000                    NOP     0

     1105     5313    1           S_WSPTD.BLKNO(%IOENDWSQ)=N$REQ.PTP / (HW_PTB_UNITS/HW_IOPTP_UNITS);

   5313  1 000055   000000 236000 xsym               LDQ     HW_PTB_UNITS
         1 000056   000000 506000 xsym               DIV     HW_IOPTP_UNITS
         1 000057   200042 756100                    STQ     AREAD+16,,AUTO
         1 000060   200003 470500                    LDP0    @N$REQ,,AUTO
         1 000061   000007 236100                    LDQ     7,,PR0
         1 000062   200042 506100                    DIV     AREAD+16,,AUTO
         1 000063   000000 620006                    EAX0    0,QL
         1 000064   000007 740000 xsym               STX0    S_WSPTD+7

     1106     5314    1           CALL HFC$ASSOCCLR (%IOENDWSQ,0,16384); /*MAX Dense PT*/

   5314  1 000065   000002 630400 2                  EPPR0   2
         1 000066   000021 631400 xsym               EPPR1   B_VECTNIL+17
         1 000067   000000 701000 xent               TSX1    HFC$ASSOCCLR
         1 000070   000000 011000                    NOP     0

     1107     5315        /**/
     1108     5316    1           B$LS$->B$MLNK.MISC=DESCINIT;    /* BUILD WSQ %IOENDWSQ DESCRIPTOR     */

   5316  1 000071   000000 235000 0                  LDA     DESCINIT
         1 000072   000000 236003                    LDQ     0,DU
         1 000073   000000 470400 xsym               LDP0    B$LS$
         1 000074   000130 757100                    STAQ    88,,PR0

     1109     5317    1           B$LS$->B$MLNK.MISC.BOUND=N$REQ.BUFSIZE-1;

   5317  1 000075   200003 471500                    LDP1    @N$REQ,,AUTO
PL6.E3A0      #003=FMI$EA File=FMI$RAN.:E05TSI                                   TUE 07/29/97 16:51 Page:203  
         1 000076   100004 236100                    LDQ     4,,PR1
         1 000077   000020 772000                    QRL     16
         1 000100   000001 136007                    SBLQ    1,DL
         1 000101   000020 736000                    QLS     16
         1 000102   000130 676100                    ERQ     88,,PR0
         1 000103   000034 376000 xsym               ANQ     B_VECTNIL+28
         1 000104   000130 656100                    ERSQ    88,,PR0

     1110     5318    1           B$LS$->B$MLNK.MISC.BASE=BITBIN(N$REQ.BUFVIRT)+

   5318  1 000105   000000 236000 xsym               LDQ     HW_PTB_UNITS
         1 000106   000000 506000 xsym               DIV     HW_IOPTP_UNITS
         1 000107   200042 756100                    STQ     AREAD+16,,AUTO
         1 000110   100007 236100                    LDQ     7,,PR1
         1 000111   200042 506100                    DIV     AREAD+16,,AUTO
         1 000112   000044 733000                    LRS     36
         1 000113   000000 402000 xsym               MPY     HW_IOPTP_UNITS
         1 000114   000014 736000                    QLS     12
         1 000115   100006 036100                    ADLQ    6,,PR1
         1 000116   000131 756100                    STQ     89,,PR0

     1111     5319    1             MOD(N$REQ.PTP,HW_PTB_UNITS/HW_IOPTP_UNITS)*HW_IOPTP_UNITS*4096;
     1112     5320    1           P$=B$MISC$;                     /* POINT THRU DESCRIPTOR JUST BUILT   */

   5320  1 000117   000000 236000 xsym               LDQ     B$MISC$
         1 000120   200007 756100                    STQ     P$,,AUTO

     1113     5321    1           N=N$REQ.BUFSIZE;                /* BUFFER SIZE IN BYTES               */

   5321  1 000121   100004 236100                    LDQ     4,,PR1
         1 000122   000020 772000                    QRL     16
         1 000123   200005 756100                    STQ     N,,AUTO

     1114     5322    2           DO WHILE(N>0);

   5322  1 000124   000206 604400 1                  TMOZ    s:5344

PL6.E3A0      #003=FMI$EA File=FMI$RAN.:E05TSI                                   TUE 07/29/97 16:51 Page:204  
     1115     5323    3              IF P$->WRD~=BITBIN(STAMP) THEN DO;

   5323  1 000125   200007 470500                    LDP0    P$,,AUTO
         1 000126   000000 236100                    LDQ     0,,PR0
         1 000127   200006 116100                    CMPQ    STAMP,,AUTO
         1 000130   000172 600000 1                  TZE     s:5337

     1116     5324    4                 IF NOT SAVSTMP AND FM$RANEA.TYP~=0 THEN DO; /* First error      */

   5324  1 000131   200014 235100                    LDA     SAVSTMP,,AUTO
         1 000132   000152 601000 1                  TNZ     s:5330
         1 000133   200012 471500                    LDP1    B$,,AUTO
         1 000134   100006 235100                    LDA     6,,PR1
         1 000135   000152 600000 1                  TZE     s:5330

     1117     5325    4                    SAVSTMP=STAMP;

   5325  1 000136   200006 236100                    LDQ     STAMP,,AUTO
         1 000137   200014 756100                    STQ     SAVSTMP,,AUTO

     1118     5326    4                    SAVBUF=P$->WRDS3;

   5326  1 000140   000100 100500                    MLR     fill='000'O
         1 000141   000000 000014                    ADSC9   0,,PR0                   cn=0,n=12
         1 000142   200015 000014                    ADSC9   SAVBUF,,AUTO             cn=0,n=12

     1119     5327    4                    SAVDA=BITBIN(N$REQ.DLA)+(BLKNO-FM$RANEA.BLKNO-

   5327  1 000143   200011 236100                    LDQ     BLKNO,,AUTO
         1 000144   100003 136100                    SBLQ    3,,PR1
         1 000145   200003 473500                    LDP3    @N$REQ,,AUTO
         1 000146   300025 136100                    SBLQ    21,,PR3
         1 000147   000004 736000                    QLS     4
         1 000150   300001 036100                    ADLQ    1,,PR3
         1 000151   200021 756100                    STQ     SAVDA,,AUTO

     1120     5328    4                      N$REQ.EAINFOX)*16;
PL6.E3A0      #003=FMI$EA File=FMI$RAN.:E05TSI                                   TUE 07/29/97 16:51 Page:205  
     1121     5329    4                    END;

     1122     5330    3                 SIZ=4096;

   5330  1 000152   010000 235007                    LDA     4096,DL
         1 000153   200010 755100                    STA     SIZ,,AUTO

     1123     5331    3                 IF N<4096 THEN SIZ=N;

   5331  1 000154   200005 236100                    LDQ     N,,AUTO
         1 000155   010000 116007                    CMPQ    4096,DL
         1 000156   000160 605000 1                  TPL     s:5332

   5331  1 000157   200010 756100                    STQ     SIZ,,AUTO

     1124     5332    3                 P$->ZAP=X;                /* CLEAR BUFFER                       */

   5332  1 000160   200010 720100                    LXL0    SIZ,,AUTO
         1 000161   040140 100400                    MLR     fill='040'O
         1 000162   000001 000004 0                  ADSC9   X1                       cn=0,n=4
         1 000163   000000 000010                    ADSC9   0,,PR0                   cn=0,n=*X0

     1125     5333    3                 N$REQ.TYC.DI='1'B;

   5333  1 000164   200003 470500                    LDP0    @N$REQ,,AUTO
         1 000165   000400 236003                    LDQ     256,DU
         1 000166   000021 256100                    ORSQ    17,,PR0

     1126     5334    3                 N$REQ.TYC.EGV='1'B;

   5334  1 000167   400000 236003                    LDQ     -131072,DU
         1 000170   000021 256100                    ORSQ    17,,PR0

     1127     5335    3                 END;

   5335  1 000171   000174 710000 1                  TRA     s:5338

PL6.E3A0      #003=FMI$EA File=FMI$RAN.:E05TSI                                   TUE 07/29/97 16:51 Page:206  
     1128     5336    2              ELSE
     1129     5337    2                 P$->WRD=BLKNO;

   5337  1 000172   200011 235100                    LDA     BLKNO,,AUTO
         1 000173   000000 755100                    STA     0,,PR0

     1130     5338    2              P$=PINCRW(P$,1024);

   5338  1 000174   200007 236100                    LDQ     P$,,AUTO
         1 000175   002000 036003                    ADLQ    1024,DU
         1 000176   200007 756100                    STQ     P$,,AUTO

     1131     5339    2              STAMP.GMOD=STAMP.GMOD+1;

   5339  1 000177   200006 236100                    LDQ     STAMP,,AUTO
         1 000200   000001 036007                    ADLQ    1,DL
         1 000201   200006 552104                    STBQ    STAMP,'04'O,AUTO

     1132     5340    2              BLKNO=BLKNO+1;

   5340  1 000202   200011 054100                    AOS     BLKNO,,AUTO

     1133     5341    2              N=N-4096;

   5341  1 000203   010000 336007                    LCQ     4096,DL
         1 000204   200005 056100                    ASQ     N,,AUTO

     1134     5342    2              END;

   5342  1 000205   000125 605400 1                  TPNZ    s:5323

     1135     5343        /**/
     1136     5344    1           FM$RANEA.CNT=FM$RANEA.CNT-1;    /* Decr count of I/Os                 */

   5344  1 000206   200012 470500                    LDP0    B$,,AUTO
         1 000207   000001 336007                    LCQ     1,DL
         1 000210   000001 056100                    ASQ     1,,PR0
PL6.E3A0      #003=FMI$EA File=FMI$RAN.:E05TSI                                   TUE 07/29/97 16:51 Page:207  

     1137     5345    2           IF FM$RANEA.CNT=0 THEN DO;      /* All done                           */

   5345  1 000211   200012 470500                    LDP0    B$,,AUTO
         1 000212   000001 235100                    LDA     1,,PR0
         1 000213   000243 601000 1                  TNZ     s:5356

     1138     5346                   %UNLOCK (G#=F_DCBLOCK);

   5347  1 000214   000000 630400 2                  EPPR0   0
         1 000215   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 000216   000000 701000 xent               TSX1    HFC$UNLOCK
         1 000217   000000 011000                    NOP     0

     1139     5349    2              B$->REALREQ='0'B;

   5349  1 000220   200012 470500                    LDP0    B$,,AUTO
         1 000221   000100 100400                    MLR     fill='000'O
         1 000222   000002 000001 xsym               ADSC9   B_VECTNIL+2              cn=0,n=1
         1 000223   000000 000170                    ADSC9   0,,PR0                   cn=0,n=120

     1140     5350    2              B$->REALREQ.ERR$=ADDR(NIL);

   5350  1 000224   000001 236000 xsym               LDQ     B_VECTNIL+1
         1 000225   200012 470500                    LDP0    B$,,AUTO
         1 000226   000017 756100                    STQ     15,,PR0

     1141     5351    2              B$->REALREQ.IOQFLG.INUSE = '1'B;

   5351  1 000227   400000 236003                    LDQ     -131072,DU
         1 000230   000033 256100                    ORSQ    27,,PR0

     1142     5352    2              CALL NIQ$REL(B$);

   5352  1 000231   200012 631500                    EPPR1   B$,,AUTO
         1 000232   200042 451500                    STP1    AREAD+16,,AUTO
         1 000233   200042 630500                    EPPR0   AREAD+16,,AUTO
PL6.E3A0      #003=FMI$EA File=FMI$RAN.:E05TSI                                   TUE 07/29/97 16:51 Page:208  
         1 000234   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 000235   000000 701000 xent               TSX1    NIQ$REL
         1 000236   000000 011000                    NOP     0

     1143     5353    2              N$REQ.OPFLG.CLR='1'B;        /* Prepare to clear cache             */

   5353  1 000237   200003 470500                    LDP0    @N$REQ,,AUTO
         1 000240   000001 236007                    LDQ     1,DL
         1 000241   000004 256100                    ORSQ    4,,PR0

     1144     5354    2              END;

   5354  1 000242   000274 710000 1                  TRA     s:5365

     1145     5355    2           ELSE DO;

     1146     5356    2              S_WSPTD.BLKNO(%IOENDWSQ)=B$USRT$->B$USER.PT(N$REQ.USER#);
              5356                       /* Page tbl ptr */

   5356  1 000243   200003 471500                    LDP1    @N$REQ,,AUTO
         1 000244   100027 236100                    LDQ     23,,PR1
         1 000245   000004 736000                    QLS     4
         1 000246   017760 376007                    ANQ     8176,DL
         1 000247   000000 473400 xsym               LDP3    B$USRT$
         1 000250   300014 220106                    LDX0    12,QL,PR3
         1 000251   000007 740000 xsym               STX0    S_WSPTD+7

     1147     5357    2              CALL HFC$ASSOCCLR (%IOENDWSQ,0,16384); /*MAX Dense PT*/

   5357  1 000252   000002 630400 2                  EPPR0   2
         1 000253   000021 631400 xsym               EPPR1   B_VECTNIL+17
         1 000254   000000 701000 xent               TSX1    HFC$ASSOCCLR
         1 000255   000000 011000                    NOP     0

     1148     5358    2              CALL MMC$ONLY_IOM(%IOENDWSQ,VPNO,PGS);

   5358  1 000256   200013 630500                    EPPR0   PGS,,AUTO
PL6.E3A0      #003=FMI$EA File=FMI$RAN.:E05TSI                                   TUE 07/29/97 16:51 Page:209  
         1 000257   200044 450500                    STP0    AREAD+18,,AUTO
         1 000260   200004 631500                    EPPR1   VPNO,,AUTO
         1 000261   200043 451500                    STP1    AREAD+17,,AUTO
         1 000262   000002 236000 2                  LDQ     2
         1 000263   200042 756100                    STQ     AREAD+16,,AUTO
         1 000264   200042 630500                    EPPR0   AREAD+16,,AUTO
         1 000265   000021 631400 xsym               EPPR1   B_VECTNIL+17
         1 000266   000000 701000 xent               TSX1    MMC$ONLY_IOM
         1 000267   000000 011000                    NOP     0

     1149     5359                   %UNLOCK (G#=F_DCBLOCK);

   5360  1 000270   000000 630400 2                  EPPR0   0
         1 000271   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 000272   000000 701000 xent               TSX1    HFC$UNLOCK
         1 000273   000000 011000                    NOP     0

     1150     5362    2              END;

     1151     5363                                                /****  UNLOCK ENABLES  ****/
     1152     5364        /**/
     1153     5365    1           IF SAVSTMP THEN

   5365  1 000274   200014 235100                    LDA     SAVSTMP,,AUTO
         1 000275   000330 600000 1                  TZE     s:5367

     1154     5366    1             CALL FMB$LOGERR(%E$MI,5,8,SAVDA,ADDR(SAVBUF),0,1,2,SAVSTMP,1,ADDR(N$REQ))
              5366                       ;

   5366  1 000276   200015 630500                    EPPR0   SAVBUF,,AUTO
         1 000277   200042 450500                    STP0    AREAD+16,,AUTO
         1 000300   200003 236100                    LDQ     @N$REQ,,AUTO
         1 000301   200043 756100                    STQ     AREAD+17,,AUTO
         1 000302   200043 631500                    EPPR1   AREAD+17,,AUTO
         1 000303   200056 451500                    STP1    AREAD+28,,AUTO
         1 000304   000007 236000 2                  LDQ     7
         1 000305   200055 756100                    STQ     AREAD+27,,AUTO
PL6.E3A0      #003=FMI$EA File=FMI$RAN.:E05TSI                                   TUE 07/29/97 16:51 Page:210  
         1 000306   200014 633500                    EPPR3   SAVSTMP,,AUTO
         1 000307   200054 453500                    STP3    AREAD+26,,AUTO
         1 000310   000010 237000 2                  LDAQ    8
         1 000311   200052 757100                    STAQ    AREAD+24,,AUTO
         1 000312   000003 236000 2                  LDQ     3
         1 000313   200051 756100                    STQ     AREAD+23,,AUTO
         1 000314   200042 634500                    EPPR4   AREAD+16,,AUTO
         1 000315   200050 454500                    STP4    AREAD+22,,AUTO
         1 000316   200021 635500                    EPPR5   SAVDA,,AUTO
         1 000317   200047 455500                    STP5    AREAD+21,,AUTO
         1 000320   000012 236000 2                  LDQ     10
         1 000321   200046 756100                    STQ     AREAD+20,,AUTO
         1 000322   000014 237000 2                  LDAQ    12
         1 000323   200044 757100                    STAQ    AREAD+18,,AUTO
         1 000324   200044 630500                    EPPR0   AREAD+18,,AUTO
         1 000325   000005 631400 2                  EPPR1   5
         1 000326   000000 701000 xent               TSX1    FMB$LOGERR
         1 000327   000000 011000                    NOP     0

     1155     5367    1           RETURN;

   5367  1 000330   000000 702200 xent               TSX2  ! X66_ARET

     1156     5368        %EJECT;
PL6.E3A0      #003=FMI$EA File=FMI$RAN.:E05TSI                                   TUE 07/29/97 16:51 Page:211  
     1157     5369        /*F*   NAME:   FMI$DSREAD
     1158     5370        *      PURPOSE:Read a random file into the user data segment.
     1159     5371        *      INPUT:  The parameter is the requesting WSQ (4,5,6,9).
     1160     5372        *      INTERFACE: MM0$FINDLS, FMD$FLSHBUF, FMD$GETBUF, M$MREAD
     1161     5373        *      DESCRIPTION: The first granule has the first word of each other granule,
     1162     5374        *        so it is read into BUF0 first. Then a descriptor framing the data
     1163     5375        *        segment is formed in B$MISC$. The FFLG in the DCB is saved and set
     1164     5376        *        to FFLG_READ so that M$MREAD will work, even if file is open
     1165     5377        *        by an execute vehicle.
     1166     5378        *      ENTRY:   FMI$DSWRITE
     1167     5379        *      PURPOSE: Undo the work of FMI$DSREAD
     1168     5380        *      DESCRIPTION: All is as in FMI$DSREAD except that M$MWRITE is used
     1169     5381        *      and, of course, the order of events is slightly different.
     1170     5382        */
     1171     5383    1   FMI$DSREAD: ENTRY(N$REQ);

   5383  1 000331   000000 700200 xent  FMI$DSREAD   TSX0  ! X66_AUTO_1
         1 000332   000060 000001                    ZERO    48,1

     1172     5384    1           CALL SETUPDS;

   5384  1 000333   000534 701000 1                  TSX1    SETUPDS
         1 000334   000000 011000                    NOP     0

     1173     5385    1           F$DCB.FFLG.EXEC='0'B;

   5385  1 000335   200020 470500                    LDP0    JDCB$,,AUTO
         1 000336   000016 236000 2                  LDQ     14
         1 000337   000004 356100                    ANSQ    4,,PR0

     1174     5386    1           CALL FMB$QUEUE(B$,0,4096,FM_FRZERO,%N_RDBIN,2,ENTADDR(NIL),0);

   5386  1 000340   000020 237000 2                  LDAQ    16
         1 000341   200050 757100                    STAQ    AREAD+22,,AUTO
         1 000342   000022 237000 2                  LDAQ    18
         1 000343   200046 757100                    STAQ    AREAD+20,,AUTO
         1 000344   000024 237000 2                  LDAQ    20
PL6.E3A0      #003=FMI$EA File=FMI$RAN.:E05TSI                                   TUE 07/29/97 16:51 Page:212  
         1 000345   200044 757100                    STAQ    AREAD+18,,AUTO
         1 000346   000003 236000 2                  LDQ     3
         1 000347   200043 756100                    STQ     AREAD+17,,AUTO
         1 000350   200012 631500                    EPPR1   B$,,AUTO
         1 000351   200042 451500                    STP1    AREAD+16,,AUTO
         1 000352   200042 630500                    EPPR0   AREAD+16,,AUTO
         1 000353   000026 631400 xsym               EPPR1   B_VECTNIL+22
         1 000354   000000 701000 xent               TSX1    FMB$QUEUE
         1 000355   000000 011000                    NOP     0

     1175     5387    1           IF RANGRAN.STAMP~=BINBIT(F$DCB.HASH,27) THEN RANGRAN='0'B;

   5387  1 000356   200012 470500                    LDP0    B$,,AUTO
         1 000357   200020 471500                    LDP1    JDCB$,,AUTO
         1 000360   000100 106500                    CMPC    fill='000'O
         1 000361   000000 000004                    ADSC9   0,,PR0                   cn=0,n=4
         1 000362   100073 000003                    ADSC9   59,,PR1                  cn=0,n=3
         1 000363   000370 600000 1                  TZE     COMMONRW

   5387  1 000364   010000 220003                    LDX0    4096,DU
         1 000365   000140 100400                    MLR     fill='000'O
         1 000366   000002 000001 xsym               ADSC9   B_VECTNIL+2              cn=0,n=1
         1 000367   000000 000010                    ADSC9   0,,PR0                   cn=0,n=*X0

   5387  1 000370                       COMMONRW     null
     1176     5388    1   COMMONRW:;
     1177     5389    1           CALL RESETMISC;

   5389  1 000370   000610 701000 1                  TSX1    RESETMISC
         1 000371   000000 011000                    NOP     0

     1178     5390    1           IF F$DCB.FFLG=%FFLG_WNEW# THEN CALL M$MWRITE(AREAD)ALTRET(HERE);

   5390  1 000372   200020 470500                    LDP0    JDCB$,,AUTO
         1 000373   000004 220100                    LDX0    4,,PR0
         1 000374   100000 100003                    CMPX0   32768,DU
         1 000375   000405 601000 1                  TNZ     s:5391
PL6.E3A0      #003=FMI$EA File=FMI$RAN.:E05TSI                                   TUE 07/29/97 16:51 Page:213  

   5390  1 000376   200022 631500                    EPPR1   AREAD,,AUTO
         1 000377   200042 451500                    STP1    AREAD+16,,AUTO
         1 000400   200042 630500                    EPPR0   AREAD+16,,AUTO
         1 000401   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 000402   000000 701000 xent               TSX1    M$MWRITE
         1 000403   000413 702000 1                  TSX2    HERE
         1 000404   000413 710000 1                  TRA     HERE

     1179     5391    1           ELSE CALL M$MREAD(AREAD)ALTRET(HERE);

   5391  1 000405   200022 631500                    EPPR1   AREAD,,AUTO
         1 000406   200042 451500                    STP1    AREAD+16,,AUTO
         1 000407   200042 630500                    EPPR0   AREAD+16,,AUTO
         1 000410   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 000411   000000 701000 xent               TSX1    M$MREAD
         1 000412   000413 702000 1                  TSX2    HERE

     1180     5392    1   HERE:   CALL RESETMISC;                 /* RANEA ALSO USED IT                 */

   5392  1 000413   000610 701000 1     HERE         TSX1    RESETMISC
         1 000414   000000 011000                    NOP     0

     1181     5393    2           DO PGS=0 TO FM$CFU.NRECS-1;

   5393  1 000415   200013 450100                    STZ     PGS,,AUTO
         1 000416   000435 710000 1                  TRA     s:5396+3

     1182     5394    2              IF PAGES.W0(PGS)~=BITBIN('777777777777'O) THEN

   5394  1 000417   200013 235100                    LDA     PGS,,AUTO
         1 000420   000012 735000                    ALS     10
         1 000421   000000 470400 xsym               LDP0    B$MISC2$
         1 000422   000000 236105                    LDQ     0,AL,PR0
         1 000423   000027 116000 xsym               CMPQ    B_VECTNIL+23
         1 000424   000432 600000 1                  TZE     s:5396

PL6.E3A0      #003=FMI$EA File=FMI$RAN.:E05TSI                                   TUE 07/29/97 16:51 Page:214  
     1183     5395    2                 PAGES.W0(PGS)=RANGRAN.WDS(PGS);

   5395  1 000425   200012 471500                    LDP1    B$,,AUTO
         1 000426   200013 720100                    LXL0    PGS,,AUTO
         1 000427   000000 621005                    EAX1    0,AL
         1 000430   100001 235110                    LDA     1,X0,PR1
         1 000431   000000 755111                    STA     0,X1,PR0

     1184     5396    2              END;

   5396  1 000432   200013 235100                    LDA     PGS,,AUTO
         1 000433   000001 035007                    ADLA    1,DL
         1 000434   200013 755100                    STA     PGS,,AUTO
         1 000435   200021 470500                    LDP0    SAVDA,,AUTO
         1 000436   200013 236100                    LDQ     PGS,,AUTO
         1 000437   000442 604000 1                  TMI     s:5397
         1 000440   000001 116100                    CMPQ    1,,PR0
         1 000441   000417 604000 1                  TMI     s:5394

     1185     5397    1           F$DCB.FFLG=SAVSTMP;

   5397  1 000442   200014 220100                    LDX0    SAVSTMP,,AUTO
         1 000443   200020 471500                    LDP1    JDCB$,,AUTO
         1 000444   100004 740100                    STX0    4,,PR1

     1186     5398    1           B$JIT.ERR='0'B;

   5398  1 000445   000000 470400 xsym               LDP0    B$JIT$
         1 000446   000012 450100                    STZ     10,,PR0

     1187     5399    1           CALL FMD$RELBUF(2);

   5399  1 000447   000011 630400 2                  EPPR0   9
         1 000450   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 000451   000000 701000 xent               TSX1    FMD$RELBUF
         1 000452   000000 011000                    NOP     0

PL6.E3A0      #003=FMI$EA File=FMI$RAN.:E05TSI                                   TUE 07/29/97 16:51 Page:215  
     1188     5400    1           RETURN;

   5400  1 000453   000000 702200 xent               TSX2  ! X66_ARET

     1189     5401        %EJECT;
PL6.E3A0      #003=FMI$EA File=FMI$RAN.:E05TSI                                   TUE 07/29/97 16:51 Page:216  
     1190     5402    1   FMI$DSWRITE: ENTRY(N$REQ);

   5402  1 000454   000000 700200 xent  FMI$DSWRITE  TSX0  ! X66_AUTO_1
         1 000455   000060 000001                    ZERO    48,1

     1191     5403    1           CALL SETUPDS;

   5403  1 000456   000534 701000 1                  TSX1    SETUPDS
         1 000457   000000 011000                    NOP     0

     1192     5404    1           F$DCB.FFLG=%FFLG_WNEW#;

   5404  1 000460   100000 220003                    LDX0    32768,DU
         1 000461   200020 470500                    LDP0    JDCB$,,AUTO
         1 000462   000004 740100                    STX0    4,,PR0

     1193     5405    1           RANGRAN=BINBIT(F$DCB.HASH,27);

   5405  1 000463   200012 471500                    LDP1    B$,,AUTO
         1 000464   010000 221003                    LDX1    4096,DU
         1 000465   000140 100500                    MLR     fill='000'O
         1 000466   000073 000003                    ADSC9   59,,PR0                  cn=0,n=3
         1 000467   100000 000011                    ADSC9   0,,PR1                   cn=0,n=*X1

     1194     5406    2           DO PGS=0 TO FM$CFU.NRECS-1;

   5406  1 000470   200013 450100                    STZ     PGS,,AUTO
         1 000471   000504 710000 1                  TRA     s:5408+3

     1195     5407    2              RANGRAN.WDS(PGS)=PAGES.W0(PGS);

   5407  1 000472   200013 235100                    LDA     PGS,,AUTO
         1 000473   000012 735000                    ALS     10
         1 000474   000000 470400 xsym               LDP0    B$MISC2$
         1 000475   200012 471500                    LDP1    B$,,AUTO
         1 000476   200013 720100                    LXL0    PGS,,AUTO
         1 000477   000000 235105                    LDA     0,AL,PR0
PL6.E3A0      #003=FMI$EA File=FMI$RAN.:E05TSI                                   TUE 07/29/97 16:51 Page:217  
         1 000500   100001 755110                    STA     1,X0,PR1

     1196     5408    2              END;

   5408  1 000501   200013 235100                    LDA     PGS,,AUTO
         1 000502   000001 035007                    ADLA    1,DL
         1 000503   200013 755100                    STA     PGS,,AUTO
         1 000504   200021 470500                    LDP0    SAVDA,,AUTO
         1 000505   200013 236100                    LDQ     PGS,,AUTO
         1 000506   000511 604000 1                  TMI     s:5409
         1 000507   000001 116100                    CMPQ    1,,PR0
         1 000510   000472 604000 1                  TMI     s:5407

     1197     5409    1           N = FM_FRZERO;

   5409  1 000511   000000 235000 xsym               LDA     FM_FRZERO
         1 000512   200005 755100                    STA     N,,AUTO

     1198     5410    1           CALL FMB$QUEUE(B$,0,4096,N,%N_WRBIN,2,ENTADDR(NIL),0);

   5410  1 000513   000020 237000 2                  LDAQ    16
         1 000514   200050 757100                    STAQ    AREAD+22,,AUTO
         1 000515   000026 237000 2                  LDAQ    22
         1 000516   200046 757100                    STAQ    AREAD+20,,AUTO
         1 000517   200005 631500                    EPPR1   N,,AUTO
         1 000520   200045 451500                    STP1    AREAD+19,,AUTO
         1 000521   000024 236000 2                  LDQ     20
         1 000522   200044 756100                    STQ     AREAD+18,,AUTO
         1 000523   000003 236000 2                  LDQ     3
         1 000524   200043 756100                    STQ     AREAD+17,,AUTO
         1 000525   200012 633500                    EPPR3   B$,,AUTO
         1 000526   200042 453500                    STP3    AREAD+16,,AUTO
         1 000527   200042 630500                    EPPR0   AREAD+16,,AUTO
         1 000530   000026 631400 xsym               EPPR1   B_VECTNIL+22
         1 000531   000000 701000 xent               TSX1    FMB$QUEUE
         1 000532   000000 011000                    NOP     0

PL6.E3A0      #003=FMI$EA File=FMI$RAN.:E05TSI                                   TUE 07/29/97 16:51 Page:218  
     1199     5411    1           GOTO COMMONRW;

   5411  1 000533   000370 710000 1                  TRA     COMMONRW

     1200     5412        %EJECT;
PL6.E3A0      #003=FMI$EA File=FMI$RAN.:E05TSI                                   TUE 07/29/97 16:51 Page:219  
     1201     5413        /*I*   NAME:   SETUPDS
     1202     5414        *      PURPOSE: Sets up the auto frame and B$MISC for %DSREAD and %DSWRITE.
     1203     5415        */
     1204     5416    1   SETUPDS: PROC;

   5416  1 000534   200040 741300       SETUPDS      STX1  ! AREAD+14,,AUTO

     1205     5417    2           JDCB$=B$JIT.DCB$;

   5417  1 000535   000000 470400 xsym               LDP0    B$JIT$
         1 000536   000232 236100                    LDQ     154,,PR0
         1 000537   200020 756100                    STQ     JDCB$,,AUTO

     1206     5418    2           CFU$=F$DCB.CFU$;

   5418  1 000540   200020 471500                    LDP1    JDCB$,,AUTO
         1 000541   100066 236100                    LDQ     54,,PR1
         1 000542   200021 756100                    STQ     SAVDA,,AUTO

     1207     5419    2           SAVSTMP=F$DCB.FFLG;

   5419  1 000543   100004 236100                    LDQ     4,,PR1
         1 000544   777777 376003                    ANQ     -1,DU
         1 000545   200014 756100                    STQ     SAVSTMP,,AUTO

     1208     5420    2           CALL FMD$FLSHBUF(2);

   5420  1 000546   000011 630400 2                  EPPR0   9
         1 000547   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 000550   000000 701000 xent               TSX1    FMD$FLSHBUF
         1 000551   000000 011000                    NOP     0

     1209     5421    2           CALL FMD$GETBUF(2,1,B$);

   5421  1 000552   200012 630500                    EPPR0   B$,,AUTO
         1 000553   200044 450500                    STP0    AREAD+18,,AUTO
         1 000554   000030 237000 2                  LDAQ    24
PL6.E3A0      #003=FMI$EA File=FMI$RAN.:E05TSI                                   TUE 07/29/97 16:51 Page:220  
         1 000555   200042 757100                    STAQ    AREAD+16,,AUTO
         1 000556   200042 630500                    EPPR0   AREAD+16,,AUTO
         1 000557   000021 631400 xsym               EPPR1   B_VECTNIL+17
         1 000560   000000 701000 xent               TSX1    FMD$GETBUF
         1 000561   000000 011000                    NOP     0

     1210     5422    2           F$DCB.CRECNO=1;

   5422  1 000562   000001 235007                    LDA     1,DL
         1 000563   200020 470500                    LDP0    JDCB$,,AUTO
         1 000564   000071 755100                    STA     57,,PR0

     1211     5423    2           AREAD=CREAD;

   5423  1 000565   000100 100400                    MLR     fill='000'O
         1 000566   000002 000070 0                  ADSC9   CREAD                    cn=0,n=56
         1 000567   200022 000070                    ADSC9   AREAD,,AUTO              cn=0,n=56

     1212     5424    2           AREAD.V_=VECTOR(AREAD.V);

   5424  1 000570   000032 235000 2                  LDA     26
         1 000571   200042 452500                    STP2    AREAD+16,,AUTO
         1 000572   200042 236100                    LDQ     AREAD+16,,AUTO
         1 000573   000032 036003                    ADLQ    26,DU
         1 000574   200022 757100                    STAQ    AREAD,,AUTO

     1213     5425    3           DO WHILE(DCBADDR(AREAD.V.DCB#)~=JDCB$);

   5425  1 000575   000601 710000 1                  TRA     s:5427

     1214     5426    3              AREAD.V.DCB#=AREAD.V.DCB#+1;

   5426  1 000576   200032 220100                    LDX0    AREAD+8,,AUTO
         1 000577   000001 621010                    EAX1    1,X0
         1 000600   200032 741100                    STX1    AREAD+8,,AUTO

     1215     5427    3              END;
PL6.E3A0      #003=FMI$EA File=FMI$RAN.:E05TSI                                   TUE 07/29/97 16:51 Page:221  

   5427  1 000601   000033 470400 2                  LDP0    27
         1 000602   000000 471500                    LDP1    0,,PR0
         1 000603   200032 220100                    LDX0    AREAD+8,,AUTO
         1 000604   100000 236110                    LDQ     0,X0,PR1
         1 000605   200020 116100                    CMPQ    JDCB$,,AUTO
         1 000606   000576 601000 1                  TNZ     s:5426
         1 000607   000611 710000 1                  TRA     s:5429

     1216     5428    2   RESETMISC: ENTRY;

   5428  1 000610   200040 741300       RESETMISC    STX1  ! AREAD+14,,AUTO

     1217     5429    2           CALL MM0$FINDLS(ADDR(N$REQ)->WRD,P$);

   5429  1 000611   200007 630500                    EPPR0   P$,,AUTO
         1 000612   200043 450500                    STP0    AREAD+17,,AUTO
         1 000613   200003 236100                    LDQ     @N$REQ,,AUTO
         1 000614   200042 756100                    STQ     AREAD+16,,AUTO
         1 000615   200042 630500                    EPPR0   AREAD+16,,AUTO
         1 000616   000020 631400 xsym               EPPR1   B_VECTNIL+16
         1 000617   000000 701000 xent               TSX1    MM0$FINDLS
         1 000620   000000 011000                    NOP     0

     1218     5430    2           B$LS$->B$MLNK.MISC2=P$->LS#N(F$DCB.ACS);

   5430  1 000621   200020 470500                    LDP0    JDCB$,,AUTO
         1 000622   000036 720100                    LXL0    30,,PR0
         1 000623   000777 360003                    ANX0    511,DU
         1 000624   000000 635010                    EAA     0,X0
         1 000625   000021 771000                    ARL     17
         1 000626   200007 471500                    LDP1    P$,,AUTO
         1 000627   100000 237105                    LDAQ    0,AL,PR1
         1 000630   000000 473400 xsym               LDP3    B$LS$
         1 000631   300260 757100                    STAQ    176,,PR3

     1219     5431    2           B$LS$->B$MLNK.MISC2.FLGS=B$LS$->B$MLNK.MISC2.FLGS|'2'O; /* WRITE      */
PL6.E3A0      #003=FMI$EA File=FMI$RAN.:E05TSI                                   TUE 07/29/97 16:51 Page:222  

   5431  1 000632   300260 236100                    LDQ     176,,PR3
         1 000633   000024 736000                    QLS     20
         1 000634   700000 376003                    ANQ     -32768,DU
         1 000635   200000 276003                    ORQ     65536,DU
         1 000636   000024 772000                    QRL     20
         1 000637   300260 676100                    ERQ     176,,PR3
         1 000640   160000 376007                    ANQ     57344,DL
         1 000641   300260 656100                    ERSQ    176,,PR3

     1220     5432    2           AREAD.BUF_.BOUND=B$LS$->B$MLNK.MISC2.BOUND;

   5432  1 000642   300260 236100                    LDQ     176,,PR3
         1 000643   200026 676100                    ERQ     AREAD+4,,AUTO
         1 000644   000034 376000 xsym               ANQ     B_VECTNIL+28
         1 000645   200026 656100                    ERSQ    AREAD+4,,AUTO

     1221     5433    2           AREAD.BUF_.BUF$=B$MISC2$;

   5433  1 000646   000000 236000 xsym               LDQ     B$MISC2$
         1 000647   200027 756100                    STQ     AREAD+5,,AUTO

     1222     5434    2           RETURN;

   5434  1 000650   200040 221300                    LDX1  ! AREAD+14,,AUTO
         1 000651   000001 702211                    TSX2  ! 1,X1

DESCINIT
 Sect OctLoc
   0     000   000000 160162                                                    ..pr

X1
 Sect OctLoc
   0     001   777777 777777                                                    ....

CREAD
 Sect OctLoc
PL6.E3A0      #003=FMI$EA File=FMI$RAN.:E05TSI                                   TUE 07/29/97 16:51 Page:223  
   0     002   000005 777640   000012 006000   000000 177640   000000 006014    ................
   0     006   000000 177640   000000 006014   000000 177640   000000 006014    ................
   0     012   000000 410000   000000 000000   000000 000000   000000 000000    ................
   0     016   000000 000000   000000 000000                                    ........

(unnamed)
 Sect OctLoc
   2     000   000000 006000   000000 040000   000011 006000   000002 006000    ...... .........
   2     004   000001 006000   000013 000000   000000 000047   000003 006000    ...........'....
   2     010   000003 006000   000004 006000   000012 006000   000000 000000    ................
   2     014   000006 006000   000007 006000   775777 777777   000000 010000    ................
   2     020   000002 006000   000002 006000   000004 006000   000004 006000    ................
   2     024   000017 006000   000000 006000   000005 006000   000004 006000    ................
   2     030   000004 006000   000003 006000   000005 777640   000000 006003    ................
     1223     5435    2   END SETUPDS;
     1224     5436    1   END FMI$EA;

PL6.E3A0      #003=FMI$EA File=FMI$RAN.:E05TSI                                   TUE 07/29/97 16:51 Page:224  
--  Include file information  --

   F$DCB.:E05TOU  is referenced.
   FM$RANEA.:E05TOU  is referenced.
   F_ERRORS_C.:E05TOU  is referenced.
   B_MLSMAC_C.:E05TOU  is referenced.
   HF_DATA_R.:E05TOU  cannot be made into a system file and is referenced.
   HF_LOCK_C.:E05TOU  cannot be made into a system file and is referenced.
   S_WSPTD_R.:E05TOU  cannot be made into a system file and is referenced.
   N_FC_C.:E05TOU  is referenced.
   FM$MACROS.:E05TOU  is referenced.
   B$JIT_C.:E05TOU  is referenced.
   F$JIT_C.:E05TOU  cannot be made into a system file and is referenced.
   CP_6_SUBS.:E05TOU  is referenced.
   F_CP6.:E05TOU  is referenced.
   B_STRINGS_C.:E05TOU  is referenced.
   B$USER.:E05TOU  cannot be made into a system file and is referenced.
   N$REQ.:E05TOU  is referenced.
      No diagnostics issued in procedure FMI$EA.
PL6.E3A0      #003=FMI$EA File=FMI$RAN.:E05TSI                                   TUE 07/29/97 16:51 Page:225  

 **** Variables and constants ****

  ****  Section 000 RoData FMI$EA

  ****  Scalars and arrays  ****
OctLoc.c.b A Datatyp(siz) R M Lvl/name                 OctLoc.c.b A Datatyp(siz) R M Lvl/name

     2-0-0/d STRC(504)   r     1 CREAD                      0-0-0/w STRC        r     1 DESCINIT
     1-0-0/w CHAR(4)     r     1 X                          1-0-0/w SBIN        r     1 X1

  ****  Auto variables  ****

  ****  Scalars and arrays  ****
OctLoc.c.b A Datatyp(siz) R M Lvl/name                 OctLoc.c.b A Datatyp(siz) R M Lvl/name

     3-0-0/w PTR         r     1 @N$REQ                    22-0-0/d STRC(504)   r     1 AREAD
    12-0-0/w PTR         r     1 B$                        12-0-0/w UBIN        r     1 B$UBIN
    11-0-0/w SBIN        r     1 BLKNO                     21-0-0/w PTR         r     1 CFU$
    20-0-0/w PTR         r     1 JDCB$                      5-0-0/w SBIN        r     1 N
    *0-0-0/d STRC(1080)  r     1 N$REQ                      7-0-0/w PTR         r     1 P$
    13-0-0/w UBIN        r     1 PGS                       15-0-0/w UBIN        r     1 SAVBUF(0:2)
    21-0-0/w UBIN        r     1 SAVDA                     14-0-0/b BIT         r     1 SAVSTMP
    10-0-0/w UBIN        r     1 SIZ                        6-0-0/b STRC        r     1 STAMP
     4-0-0/w SBIN        r     1 VPNO

  ****  SYMREF variables  ****

  ****  Scalars and arrays  ****
OctLoc.c.b A Datatyp(siz) R M Lvl/name                 OctLoc.c.b A Datatyp(siz) R M Lvl/name

     0-0-0/w PTR         r     1 B$JIT$                     0-0-0/w PTR         r     1 B$LS$
     0-0-0/w PTR         r     1 B$MISC$                    0-0-0/w PTR         r     1 B$MISC2$
     0-0-0/w PTR         r     1 B$USRT$                    0-0-0/w UBIN        r     1 FM_FRZERO
     0-0-0/w SBIN        r     1 F_DCBLOCK                  0-0-0/w SBIN        r     1 HW_IOPTP_UNITS
     0-0-0/w SBIN        r     1 HW_PTB_UNITS               0-0-0/w STRC        r     1 S_WSPTD(0:28)

  ****  BASED and DCB variables  ****
PL6.E3A0      #003=FMI$EA File=FMI$RAN.:E05TSI                                   TUE 07/29/97 16:51 Page:226  

  ****  Scalars and arrays  ****
OctLoc.c.b A Datatyp(siz) R M Lvl/name                 OctLoc.c.b A Datatyp(siz) R M Lvl/name

     0-0-0/d STRC(8856)  r     1 B$JIT                      0-0-0/d STRC(10368) r     1 B$MLNK
     0-0-0/w STRC(576)   r     1 B$USER(0:0)                0-0-0/d ASTR(3528)  r     1 F$DCB
     0-0-0/w STRC(288)   r     1 FM$CFU                     0-0-0/w STRC(252)   r     1 FM$RANEA
     0-0-0/d BIT (72)    r     1 LS#N(0:0)                  0-0-0/w STRC(36864) r     1 PAGES(0:0)
     0-0-0/w STRC(36864) r     1 RANGRAN                    0-0-0/d STRC(1080)  r     1 REALREQ
     0-0-0/w UBIN        r     1 WRD                        0-0-0/w UBIN        r     1 WRDS3(0:2)
     0-0-0/w ACHR        r     1 ZAP


   Procedure FMI$EA requires 426 words for executable code.
   Procedure FMI$EA requires 48 words of local(AUTO) storage.

    No errors detected in file FMI$RAN.:E05TSI    .
PL6.E3A0      #003=FMI$EA File=FMI$RAN.:E05TSI                                   TUE 07/29/97 16:51 Page:227  
          *** CROSS REFERENCE LISTING ***
**     DENOTES     IDENTIFIER DEFINITION
<<                 IDENTIFIER'S VALUE SET
>>                 IDENTIFIER'S VALUE USED
<>                 IDENTIFIER SET AND/OR USED
--                 IDENTIFIER REFERENCED
PL6.E3A0      #003=FMI$EA File=FMI$RAN.:E05TSI                                   TUE 07/29/97 16:51 Page:228  
          MINI XREF LISTING

AREAD
      4282**DCL      5390<>CALL     5391<>CALL     5423<<ASSIGN
AREAD.BUF_.BOUND
      4284**DCL      5432<<ASSIGN
AREAD.BUF_.BUF$
      4285**DCL      5433<<ASSIGN
AREAD.STATION_
      4285**DCL      4286--REDEF
AREAD.V
      4286**DCL      5424--ASSIGN
AREAD.V.DCB#
      4286**DCL      5425--DOWHILE  5426<<ASSIGN   5426>>ASSIGN
AREAD.V.DVBYTE.REREAD#
      4297**DCL      4297--REDEF
AREAD.V.INDX#
      4295**DCL      4295--REDEF
AREAD.V_
      4282**DCL      5424<<ASSIGN
B$
       188**DCL       189--REDEF    5222--IMP-PTR  5289--IMP-PTR  5301>>ASSIGN   5302>>ASSIGN   5303>>ASSIGN
      5305>>ASSIGN   5324>>IF       5327>>ASSIGN   5344>>ASSIGN   5344>>ASSIGN   5345>>IF       5349>>ASSIGN
      5350>>ASSIGN   5351>>ASSIGN   5352<>CALL     5386<>CALL     5387>>IF       5387>>ASSIGN   5395>>ASSIGN
      5405>>ASSIGN   5407>>ASSIGN   5410<>CALL     5421<>CALL
B$DO.ECCINFO
       348**DCL       349--REDEF
B$JIT.DCB$
      2528**DCL      5417>>ASSIGN
B$JIT.ERR
      2438**DCL      5398<<ASSIGN
B$JIT.ERR.MID
      2439**DCL      2439--REDEF
B$JIT$
PL6.E3A0      #003=FMI$EA File=FMI$RAN.:E05TSI                                   TUE 07/29/97 16:51 Page:229  
       176**DCL      2433--IMP-PTR  5398>>ASSIGN   5417>>ASSIGN
B$LS$
       173**DCL      5316>>ASSIGN   5317>>ASSIGN   5318>>ASSIGN   5430>>ASSIGN   5431>>ASSIGN   5431>>ASSIGN
      5432>>ASSIGN
B$MISC$
       174**DCL      5320>>ASSIGN
B$MISC2$
       175**DCL      5286--IMP-PTR  5394>>IF       5395>>ASSIGN   5407>>ASSIGN   5433>>ASSIGN
B$MLNK.MISC
      4718**DCL      5316<<ASSIGN
B$MLNK.MISC.BASE
      4723**DCL      5318<<ASSIGN
B$MLNK.MISC.BOUND
      4719**DCL      5317<<ASSIGN
B$MLNK.MISC2
      4986**DCL      5430<<ASSIGN
B$MLNK.MISC2.BOUND
      4987**DCL      5432>>ASSIGN
B$MLNK.MISC2.FLGS
      4988**DCL      5431<<ASSIGN   5431>>ASSIGN
B$U.MISC
       327**DCL       328--REDEF
B$UBIN
       189**DCL      5300<<ASSIGN
B$USER.MISC
       403**DCL       404--REDEF
B$USER.PT
       397**DCL      5310>>ASSIGN   5356>>ASSIGN
B$USRT$
       544**DCL      5310>>ASSIGN   5356>>ASSIGN
BLKNO
       187**DCL      5305<<ASSIGN   5327>>ASSIGN   5337>>ASSIGN   5340<<ASSIGN   5340>>ASSIGN
CFU$
       195**DCL      5293--IMP-PTR  5393>>DOINDEX  5406>>DOINDEX  5418<<ASSIGN
COMMONRW
      5387**LABEL    5411--GOTO
PL6.E3A0      #003=FMI$EA File=FMI$RAN.:E05TSI                                   TUE 07/29/97 16:51 Page:230  
CREAD
      4243**DCL      5423>>ASSIGN
CREAD.STATION_
      4246**DCL      4247--REDEF
CREAD.V
      4247**DCL      4243--DCLINIT
CREAD.V.DVBYTE.REREAD#
      4258**DCL      4258--REDEF
CREAD.V.INDX#
      4256**DCL      4256--REDEF
DESCINIT
      4219**DCL      5316>>ASSIGN
F$DCB.ACS
      4373**DCL      5430>>ASSIGN
F$DCB.ACTPOS
      4381**DCL      4381--REDEF
F$DCB.ARS
      4356**DCL      4356--REDEF
F$DCB.ATTR
      4374**DCL      4375--REDEF
F$DCB.BORROW
      4389**DCL      4389--REDEF    4389--REDEF    4389--REDEF
F$DCB.CFU$
      4390**DCL      5418>>ASSIGN
F$DCB.CRECNO
      4393**DCL      5422<<ASSIGN
F$DCB.DCBNAME.L
      4403**DCL      4403--IMP-SIZ
F$DCB.EOMCHAR
      4360**DCL      4360--REDEF
F$DCB.FFLG
      4360**DCL      5390>>IF       5397<<ASSIGN   5404<<ASSIGN   5419>>ASSIGN
F$DCB.FFLG.EXEC
      4361**DCL      5385<<ASSIGN
F$DCB.FLDID
      4384**DCL      4384--REDEF
PL6.E3A0      #003=FMI$EA File=FMI$RAN.:E05TSI                                   TUE 07/29/97 16:51 Page:231  
F$DCB.FORM$
      4378**DCL      4378--REDEF
F$DCB.FSECT
      4394**DCL      4394--REDEF
F$DCB.FSN
      4371**DCL      4371--REDEF    4371--REDEF    4372--REDEF
F$DCB.HASH
      4393**DCL      5387>>IF       5405>>ASSIGN
F$DCB.HEADER$
      4377**DCL      4377--REDEF
F$DCB.IXTNSIZE
      4375**DCL      4375--REDEF
F$DCB.LASTSTA$
      4365**DCL      4365--REDEF
F$DCB.LVL
      4390**DCL      4390--REDEF
F$DCB.NAME.C
      4365**DCL      4365--REDEF
F$DCB.NOEOF
      4386**DCL      4386--REDEF
F$DCB.NRECS
      4376**DCL      4376--REDEF
F$DCB.NRECX
      4395**DCL      4395--REDEF
F$DCB.OHDR
      4387**DCL      4387--REDEF
F$DCB.ORG
      4370**DCL      4370--REDEF
F$DCB.PRECNO
      4393**DCL      4393--REDEF
F$DCB.RCSZ
      4398**DCL      4398--REDEF
F$DCB.RES
      4366**DCL      4366--REDEF
F$DCB.SETX
      4378**DCL      4378--REDEF
PL6.E3A0      #003=FMI$EA File=FMI$RAN.:E05TSI                                   TUE 07/29/97 16:51 Page:232  
F$DCB.TAB$
      4377**DCL      4378--REDEF
F$DCB.TDA
      4392**DCL      4392--REDEF
F$DCB.WSN
      4367**DCL      4367--REDEF
FM$CFU.ACCTX
      5294**DCL      5294--REDEF
FM$CFU.NRECS
      5294**DCL      5393>>DOINDEX  5406>>DOINDEX
FM$RANEA.BLKNO
      5222**DCL      5305>>ASSIGN   5327>>ASSIGN
FM$RANEA.CNT
      5222**DCL      5344<<ASSIGN   5344>>ASSIGN   5345>>IF
FM$RANEA.PGS
      5222**DCL      5302>>ASSIGN
FM$RANEA.STAMP
      5222**DCL      5303>>ASSIGN
FM$RANEA.TYP
      5222**DCL      5324>>IF
FM$RANEA.VPNO
      5222**DCL      5301>>ASSIGN
FMB$LOGERR
       160**DCL-ENT  5366--CALL
FMB$QUEUE
       161**DCL-ENT  5386--CALL     5410--CALL
FMD$FLSHBUF
       162**DCL-ENT  5420--CALL
FMD$GETBUF
       163**DCL-ENT  5421--CALL
FMD$RELBUF
       164**DCL-ENT  5399--CALL
FM_FRZERO
       177**DCL      5386<>CALL     5409>>ASSIGN
F_DCBLOCK
       178**DCL      5308<>CALL     5347<>CALL     5360<>CALL
PL6.E3A0      #003=FMI$EA File=FMI$RAN.:E05TSI                                   TUE 07/29/97 16:51 Page:233  
HERE
      5392**LABEL    5390--CALLALT  5391--CALLALT
HFC$ASSOCCLR
       165**DCL-ENT  5311--CALL     5314--CALL     5357--CALL
HFC$LOCK
      2982**DCL-ENT  5308--CALL
HFC$UNLOCK
      2982**DCL-ENT  5347--CALL     5360--CALL
HW_IOPTP_UNITS
      3020**DCL      5313>>ASSIGN   5318>>ASSIGN   5318>>ASSIGN
HW_PTB_UNITS
      3020**DCL      5313>>ASSIGN   5318>>ASSIGN
JDCB$
       193**DCL      4356--IMP-PTR  5385>>ASSIGN   5387>>IF       5390>>IF       5397>>ASSIGN   5404>>ASSIGN
      5405>>ASSIGN   5417<<ASSIGN   5418>>ASSIGN   5419>>ASSIGN   5422>>ASSIGN   5425>>DOWHILE  5430>>ASSIGN
LS#N
      5285**DCL      5430>>ASSIGN
M$MREAD
       167**DCL-ENT  5391--CALL
M$MWRITE
       168**DCL-ENT  5390--CALL
MM0$FINDLS
       166**DCL-ENT  5429--CALL
MMC$CP_IOM
       169**DCL-ENT  5312--CALL
MMC$ONLY_IOM
       170**DCL-ENT  5358--CALL
N
       181**DCL      5321<<ASSIGN   5322>>DOWHILE  5331>>IF       5331>>ASSIGN   5341<<ASSIGN   5341>>ASSIGN
      5409<<ASSIGN   5410<>CALL
N$REQ
       110**DCL        25--PROC     5366--CALL     5383--ENTRY    5402--ENTRY    5429--CALL
N$REQ.BUFADDR
       119**DCL       120--REDEF     120--REDEF
N$REQ.BUFSIZE
       113**DCL      5317>>ASSIGN   5321>>ASSIGN
PL6.E3A0      #003=FMI$EA File=FMI$RAN.:E05TSI                                   TUE 07/29/97 16:51 Page:234  
N$REQ.BUFVIRT
       120**DCL      5318>>ASSIGN
N$REQ.DLA
       110**DCL      5327>>ASSIGN
N$REQ.DLA.DRELADDR
       111**DCL       111--REDEF
N$REQ.DVE.EOMCHAR
       148**DCL       149--REDEF
N$REQ.EAINFO
       142**DCL       142--REDEF    5300>>ASSIGN
N$REQ.EAINFOX
       142**DCL       143--REDEF    5304>>ASSIGN   5305>>ASSIGN   5327>>ASSIGN
N$REQ.EVNTINFO
       143**DCL       143--REDEF
N$REQ.OPFLG.CLR
       119**DCL      5353<<ASSIGN
N$REQ.PTP
       121**DCL      5313>>ASSIGN   5318>>ASSIGN
N$REQ.STATUS
       124**DCL       130--REDEF
N$REQ.TYC.DI
       135**DCL      5333<<ASSIGN
N$REQ.TYC.EGV
       132**DCL      5334<<ASSIGN
N$REQ.USER#
       144**DCL      5310>>ASSIGN   5356>>ASSIGN
NIQ$REL
       171**DCL-ENT  5352--CALL
P$
       185**DCL      5320<<ASSIGN   5323>>IF       5326>>ASSIGN   5332>>ASSIGN   5337>>ASSIGN   5338<<ASSIGN
      5338>>ASSIGN   5429<>CALL     5430>>ASSIGN
PAGES.W0
      5287**DCL      5394>>IF       5395<<ASSIGN   5407>>ASSIGN
PGS
       190**DCL      5302<<ASSIGN   5312<>CALL     5358<>CALL     5393<<DOINDEX  5394>>IF       5395>>ASSIGN
      5395>>ASSIGN   5406<<DOINDEX  5407>>ASSIGN   5407>>ASSIGN
PL6.E3A0      #003=FMI$EA File=FMI$RAN.:E05TSI                                   TUE 07/29/97 16:51 Page:235  
RANGRAN
      5289**DCL      5387<<ASSIGN   5405<<ASSIGN
RANGRAN.STAMP
      5290**DCL      5387>>IF
RANGRAN.WDS
      5291**DCL      5395>>ASSIGN   5407<<ASSIGN
REALREQ
      5233**DCL      5349<<ASSIGN
REALREQ.BUFADDR
      5242**DCL      5243--REDEF    5243--REDEF
REALREQ.DLA.DRELADDR
      5234**DCL      5234--REDEF
REALREQ.DVE.EOMCHAR
      5271**DCL      5272--REDEF
REALREQ.EAINFO
      5265**DCL      5265--REDEF
REALREQ.EAINFOX
      5265**DCL      5266--REDEF
REALREQ.ERR$
      5255**DCL      5350<<ASSIGN
REALREQ.EVNTINFO
      5266**DCL      5266--REDEF
REALREQ.IOQFLG.INUSE
      5276**DCL      5351<<ASSIGN
REALREQ.STATUS
      5247**DCL      5253--REDEF
RESETMISC IN PROCEDURE SETUPDS
      5428**ENTRY    5389--CALL     5392--CALL
SAVBUF
       192**DCL      5326<<ASSIGN   5366--CALL
SAVDA
       194**DCL       195--REDEF    5327<<ASSIGN   5366<>CALL
SAVSTMP
       191**DCL      5299<<ASSIGN   5324>>IF       5325<<ASSIGN   5365>>IF       5366<>CALL     5397>>ASSIGN
      5419<<ASSIGN
SETUPDS
PL6.E3A0      #003=FMI$EA File=FMI$RAN.:E05TSI                                   TUE 07/29/97 16:51 Page:236  
      5416**PROC     5384--CALL     5403--CALL
SIZ
       186**DCL      5282--IMP-SIZ  5330<<ASSIGN   5331<<ASSIGN   5332>>ASSIGN
STAMP
       182**DCL      5303<<ASSIGN   5323>>IF       5325>>ASSIGN
STAMP.GMOD
       184**DCL      5304<<ASSIGN   5304>>ASSIGN   5339<<ASSIGN   5339>>ASSIGN
S_WSPTD.BLKNO
      2961**DCL      5310<<ASSIGN   5313<<ASSIGN   5356<<ASSIGN
VPNO
       180**DCL      5301<<ASSIGN   5312<>CALL     5358<>CALL
WRD
      5283**DCL      5323>>IF       5337<<ASSIGN   5429<>CALL
WRDS3
      5284**DCL      5326>>ASSIGN
X
      4225**DCL      5332>>ASSIGN
X1
      4224**DCL      4225--REDEF
ZAP
      5282**DCL      5332<<ASSIGN
PL6.E3A0      #003=FMI$EA File=FMI$RAN.:E05TSI                                   TUE 07/29/97 16:51 Page:237  
              *** CROSS REFERENCE LISTING ***
    **     DENOTES     IDENTIFIER DEFINITION
    <<                 IDENTIFIER'S VALUE SET
    >>                 IDENTIFIER'S VALUE USED
    <>                 IDENTIFIER SET AND/OR USED
    --                 IDENTIFIER REFERENCED
PL6.E3A0      #003=FMI$EA File=FMI$RAN.:E05TSI                                   TUE 07/29/97 16:51 Page:238  
              MINI UREF LISTING

B$DOCONT     361**DCL
EPU_MASK    3019**DCL
FMI$DSREAD    5383**ENTRY
FMI$DSWRITE    5402**ENTRY
FMI$EA      25**PROC
HW_CHANS    3024**DCL
HW_EDAC    3024**DCL
HW_EI    3023**DCL
HW_ES    3023**DCL
HW_EXT_STATUS    3022**DCL
HW_FLTIC_OK    3024**DCL
HW_FRAG_PT    3022**DCL
HW_IMX    3025**DCL
HW_IOP    3022**DCL
HW_LOAD_FW    3021**DCL
HW_NORM_CLOCK    3024**DCL
HW_PERF    3019**DCL
HW_PERF_SUB    3019**DCL
HW_PROG_SCU    3023**DCL
HW_SECT_PT    3021**DCL
HW_SMART_CACHE    3023**DCL
HW_TIME_LEGAL    3021**DCL
HW_TYPE    3020**DCL
HW_WSQ0PT    3021**DCL
H_CNCTEVBF    3009**DCL
H_CNCTEVGATE    3009**DCL
H_CNCTEVX    3009**DCL
H_CNNCTMLBX    2991**DCL
H_CODE    3002**DCL
H_CPUGATE    2991**DCL
H_CPU_BF    3001**DCL
H_CPU_CONFIG    2997**DCL
PL6.E3A0      #003=FMI$EA File=FMI$RAN.:E05TSI                                   TUE 07/29/97 16:51 Page:239  
H_DPS8000_CI_TABLE    3016**DCL
H_DPS8000_CONFIG_NAME    3016**DCL
H_DPS8000_CPU_CONF_REG    3012**DCL
H_DPS8000_SCU_CONF_REG    3013**DCL
H_DPS8000_SCU_INFO    3014**DCL
H_DSMASK    2993**DCL
H_DUMMY    3006**DCL
H_EDACHIST    3010**DCL
H_EDACUTS    3010**DCL
H_ENMASK    2993**DCL
H_EXTFLTREG_MASK    3011**DCL
H_FAIL_NUM    2996**DCL
H_FAIL_PARK    2996**DCL
H_FAIL_PORT    2996**DCL
H_FLTCNT    2991**DCL
H_FLTREG    3011**DCL
H_FLTREG_MASK    3010**DCL
H_HRMODE    3007**DCL
H_HRMODE_MASK    3007**DCL
H_INTMASK    2992**DCL
H_LUFREG    3007**DCL
H_LUFREG_MASK    3008**DCL
H_MAKE_IN_PROGRESS    3004**DCL
H_MAXPORT#    3002**DCL
H_MAXSU#    2994**DCL
H_MAX_PERF    3018**DCL
H_MEMOK    2994**DCL
H_MIXED_FLT    3005**DCL
H_MIXED_INT    3004**DCL
H_MIXED_MP    3004**DCL
H_MIXED_RMIR    3006**DCL
H_MIXED_SSS    3005**DCL
H_MIXED_SSX    3005**DCL
H_MIXED_TRO    3005**DCL
H_MODE    3003**DCL
H_NURSE    2997**DCL
PL6.E3A0      #003=FMI$EA File=FMI$RAN.:E05TSI                                   TUE 07/29/97 16:51 Page:240  
H_NURSE_PARK    2997**DCL
H_PERF    3018**DCL
H_PERF_DATA    3011**DCL
H_PORT#    3003**DCL
H_PORTMASK    3002**DCL
H_PORT_FIRST_ADDR    3001**DCL
H_RELIEF    2997**DCL
H_RELOAD_CACHE    3008**DCL
H_RELOAD_MODE    3008**DCL
H_RLF_GATE    2995**DCL
H_RPM_CONNECT_TABLE    3017**DCL
H_RPM_FLG    2995**DCL
H_RSW1    3006**DCL
H_RSW2    3006**DCL
H_S1000_CONFIG    2995**DCL
H_S1000_FLG    2995**DCL
H_SAVE_SS    3004**DCL
H_SCU_BF    3001**DCL
H_SCU_CONFIG    2998**DCL
H_SNAP    3003**DCL
H_SPROC#    3003**DCL
H_STOREUNIT    2993**DCL
H_SYSID    3003**DCL
H_TIME    2992**DCL
H_TIME_CORR    3019**DCL
H_XDELTA    2992**DCL
S$CU$     543**DCL
S_DPR2    2965**DCL
S_FLT_IS    2963**DCL
S_FLT_IS_START    2962**DCL
S_INT_SS    2963**DCL
S_OPTION_REG    2962**DCL
S_PDBR    2961**DCL
S_PGTABLE    2964**DCL
S_PTWAM    2964**DCL
S_RETRY    2963**DCL
PL6.E3A0      #003=FMI$EA File=FMI$RAN.:E05TSI                                   TUE 07/29/97 16:51 Page:241  
S_RLF_SSR    2966**DCL
S_RVA    2968**DCL
S_SSR_EXIT1    2966**DCL
S_SSR_EXIT2    2967**DCL
S_SSR_EXIT3    2967**DCL
S_SSR_EXIT4    2967**DCL
S_SSR_EXIT5    2968**DCL
S_SSR_EXIT6    2968**DCL
S_THIS_PERF    2963**DCL
S_THIS_PTYPE    2962**DCL
S_TRO_SS    2964**DCL
S_WSR    2962**DCL
S_X1    2966**DCL
S_XASR    2965**DCL
S_XPR2    2966**DCL
S_XPSR    2965**DCL
S_XSSR    2965**DCL
S_XX    2966**DCL
