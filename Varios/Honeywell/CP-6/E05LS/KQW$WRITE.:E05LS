VERSION E05

PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:1    
        1        1        /*M* KQW$WRITE IOQ write to COMGROUP */
        2        2        /*T***********************************************************/
        3        3        /*T*                                                         */
        4        4        /*T* Copyright (c) Bull HN Information Systems Inc., 1997    */
        5        5        /*T*                                                         */
        6        6        /*T***********************************************************/
        7        7        /*X* DMC,PLM=6,IND=0,IDT=2,SDI=2,CTI=0,ENU=0,AND,DCI=4,CSU=2,ECU=4,THI=0,DTI=0,STI=1
                 7        ,IAD=0,PRB */
        8        8        /**/
        9        9        /*P* NAME:         KQW$WRITE
       10       10             PURPOSE:      To provide COMGROUP WRITE functions for entities
       11       11                           which come through IOQ (i.e. DCBs, and monitor
       12       12                           stations such as MONKEY).
       13       13             DESCRIPTION:  Contains all routines to implement write of COMGROUP
       14       14                           via NIO$QUE.  Is the complement of KQR$READ, which
       15       15                           handles read thru IOQ.
       16       16
       17       17                           Also contains entry points for other entities
       18       18                           which need the same logic.  For example, writes
       19       19                           into the queue from terminals finish at KQW$SEND,
       20       20                           (after starting in KQP$PUT).
       21       21        */
       22       22        /*F* NAME:         KQW$WRITE
       23       23             PURPOSE:      To receive write NIO$QUE requests for DCTs
       24       24                           whose RESCOD is CGDCB.
       25       25             DESCRIPTION:  NIO$QUE calls here for write functions issued
       26       26                           for a DCT with RESCOD CGDCB (this includes true
       27       27                           user DCBs, as well as monitor stations such as
       28       28                           MONKEY).
       29       29
       30       30                           If the user has a continued write in progress,
       31       31                           then skip directly to place this chunk in the
       32       32                           comgroup.
       33       33
       34       34                           Otherwise (start of a new message), an MBLK is
       35       35                           obtained and initialized with the parameters of
       36       36                           the message, the parameters being validated as
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:2    
       37       37                           we do so.  When this has been done, a MSGID is
       38       38                           obtained for the message (either a new one if
       39       39                           the write is not latched, or, if it is, an ID
       40       40                           is generated from the ID of the current latched
       41       41                           read), and a time stamp is inserted into the
       42       42                           MBLK.  Then, if any of the following are true:
       43       43                            - this write says CONTINUE
       44       44                            - this write is latched
       45       45                            - the message type begins '*'
       46       46                            - the message is to be journaled
       47       47
       48       48                           we go dump the data into the comgroup.
       49       49
       50       50                           If none are true, we can write the data directly
       51       51                           into the reader's buffer if there is a reader and
       52       52                           he isn't reading latched.  We try to find such
       53       53                           a guy, and send the data directly to him, and if
       54       54                           this fails, go put the data into the comgroup.
       55       55
       56       56                           Putting the data into the comgroup means finding
       57       57                           a DBLK and dumping the buffer into it.  If this
       58       58                           is the next chunk of a previous write, then the
       59       59                           DBLK used previously must be flinked at this one.
       60       60                           Then, if this write specified CONT, we're done.
       61       61                           Else, if it specified latch it is inserted into
       62       62                           the LWRITES$ list in the latched RBLK (at the
       63       63                           end), else (not latched) it is dispatched to its
       64       64                           destination.  This latter means finding a reader
       65       65                           for it, or, if none, inserting it into the MLH
       66       66                           in the appropriate station (directed write) or
       67       67                           Q-tree (write to queue) node.  Either way the
       68       68                           write is I/O COMPed before we exit.
       69       69        */
       70       70        /**/
       71       71        KQW$WRITE: PROC (N$WREQ) ALTRET;
       72       72        /**/
       73       73
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:3    
       74       74
       75       75
       76       76        /**/
       77       77        /* INCLUDES */
       78       78        /**/
       79       79        %INCLUDE KQ_SUBS_C;
       80      379        %INCLUDE KQ_MAC_C;
       81     2929        %INCLUDE HF_LOCK_C;
       82     2943        %INCLUDE KQ_DATA_R;
       83     3775        %INCLUDE NK$LDCT;
       84     3877        %INCLUDE N$REQ;
       85     3951        %INCLUDE NK_SUBS;
       86     3976        %INCLUDE NK_LDCT_R;
       87     3985        %INCLUDE KC_CP6;
       88     4545        %INCLUDE CP_6_SUBS;
       89     5085        %INCLUDE B_STRINGS_C;
       90     5214        %INCLUDE N_FC_C;
       91     5251        %INCLUDE NK_VFC_C;
       92     5325        %INCLUDE JG_GHOSTS_C;
       93     5415        %INCLUDE KC$CP6V_C;
       94     5535        %INCLUDE EL$TABLES;
       95     5858        %INCLUDE SS_SCHED_C;
       96     6091
       97     6092
       98     6093
       99     6094        /**/
      100     6095        /* PARAMETERS */
      101     6096        /**/
      102     6097        %N$REQ (NAME=N$WREQ,STCLASS="");
      103     6155
      104     6156
      105     6157
      106     6158        /**/
      107     6159        /* BASED STRUCTURES */
      108     6160        /**/
      109     6161    1   DCL B$$PTR PTR BASED ALIGNED;
      110     6162        %NK$LDCT;
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:4    
      111     6208        %N$REQ;
      112     6266        %KQ_CG   (FPTN=KQ$CG  ,STCLASS="BASED(CG$)");
      113     7005        %KQ_STA  (FPTN=KQ$STA ,STCLASS="BASED(STA$)");
      114     7344        %KQ_RBLK (FPTN=KQ$RBLK,STCLASS="BASED(RBLK$)");
      115     7530        %KQ_MBLK (FPTN=KQ$MBLK,STCLASS="BASED(MBLK$)");
      116     7800        %KQ_THDR (FPTN=KQ$THDR,STCLASS=BASED);
      117     7838        %KQ_DBLK (FPTN=KQ$DBLK,STCLASS="BASED(DBLK$)");
      118     7891        %KQ_MTYP (FPTN=KQ$MTYP,STCLASS="BASED(MTYP$)");
      119     7965        %KQ_QTN  (FPTN=KQ$QTN ,STCLASS="BASED(QTN$)");
      120     8438        %KQ_RBLK (FPTN=KQ$RBLKT,STCLASS="BASED(RBLK$)",TERM=1);
      121     8624        %KQ$DPTR;
      122     8651        %VLP$STATION_V (FPTN=VLP$STATION);
      123     8663    1   DCL B$$UBIN UBIN WORD BASED ALIGNED;
      124     8664    1   DCL B$$HALF UBIN HALF BASED HALIGNED;
      125     8665    1   DCL B$$KEY1 CHAR(KEY1L) BASED ALIGNED;
      126     8666    1   DCL B$$KEY2 CHAR(KEY2L) BASED ALIGNED;
      127     8667    1   DCL B$$DSTA CHAR(DSTAL) BASED ALIGNED;
      128     8668    1   DCL B$$CHAR CHAR(1) BASED CALIGNED;
      129     8669    1   DCL B$$CHAR8 CHAR(8) BASED CALIGNED;
      130     8670    1   DCL B$$BUFCHARS CHAR(BUFSZ) BASED CALIGNED;
      131     8671    1   DCL 1 B$$MIDEXT BASED ALIGNED,
      132     8672    1         2 EXTS (0:5) UBIN(6) UNAL;
      133     8673    1   DCL 1 B$$PRIO BASED HALIGNED,
      134     8674    1         2 HI UBIN BYTE UNAL,
      135     8675    1         2 LO UBIN BYTE UNAL;
      136     8676    1   DCL 1 B$$XFPTW BASED DALIGNED,
      137     8677    1         2 * (0:1) UBIN;
      138     8678
      139     8679
      140     8680
      141     8681        /**/
      142     8682        /* AUTO */
      143     8683        /**/
      144     8684    1   DCL LDCT$ PTR;
      145     8685    1   DCL STA$ PTR;
      146     8686    1   DCL RBLK$ PTR;
      147     8687    1   DCL MBLK$ PTR;
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:5    
      148     8688    1   DCL CG$ PTR;
      149     8689    1   DCL VLP$ PTR;
      150     8690    1   DCL KEY1L UBIN;
      151     8691    1   DCL KEY2L UBIN;
      152     8692    1   DCL P$ PTR;
      153     8693    1   DCL WAS BIT(36);
      154     8694        %VLP$STATION_V (FPTN=VLP_STATION,BASED=AUTO);
      155     8706    1   DCL DBLK$ PTR;
      156     8707    1   DCL DBLK$R REDEF DBLK$ UBIN;
      157     8708    1   DCL BUFSZ UBIN;
      158     8709    1   DCL DDA UBIN;
      159     8710    1   DCL OSTAPRIO REDEF DDA UBIN;
      160     8711    1   DCL OSTA CHAR(8);
      161     8712    1   DCL QTN$ PTR;
      162     8713    1   DCL TYC BIT(36);
      163     8714    1   DCL MTYP$ PTR;
      164     8715    1   DCL DSTA$ PTR;
      165     8716    1   DCL WRQ$ PTR;
      166     8717    1   DCL MYMBLK$ PTR;
      167     8718    1   DCL NEWDDA UBIN;
      168     8719    1   DCL RCVR REDEF NEWDDA UBIN;
      169     8720    1   DCL DSTAL UBIN;
      170     8721    1   DCL TACTCNT UBIN HALF;
      171     8722    1   DCL DEST SBIN WORD;
      172     8723    1   DCL VFC UBIN;
      173     8724    1   DCL I UBIN;
      174     8725
      175     8726
      176     8727
      177     8728        /**/
      178     8729        /* REFS */
      179     8730        /**/
      180     8731    1   DCL HFC$ASSOCCLR  ENTRY(3);
      181     8732    1   DCL HFF$TRAPALT   ENTRY    ALTRET;
      182     8733    1   DCL KQB$SRCH      ENTRY(3) ALTRET;
      183     8734    1   DCL KQD$DEFERGO   ENTRY(3) ALTRET;
      184     8735    1   DCL KQD$DEFERWAIT ENTRY(3) ALTRET;
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:6    
      185     8736    1   DCL KQD$DELETE    ENTRY(2) ALTRET;
      186     8737    1   DCL KQD$ERRLOG    ENTRY(1) ALTRET;
      187     8738    1   DCL KQD$FETCH     ENTRY(3) ALTRET;
      188     8739    1   DCL KQD$FETCHR    ENTRY(3) ALTRET;
      189     8740    1   DCL KQD$GET       ENTRY(3) ALTRET;
      190     8741    1   DCL KQD$GETR      ENTRY(3) ALTRET;
      191     8742    1   DCL KQD$UNLOCK    ENTRY(2) ALTRET;
      192     8743    1   DCL KQD$UPDATED   ENTRY(2) ALTRET;
      193     8744    1   DCL KQG$GOTMSG    ENTRY(1) ALTRET;
      194     8745    1   DCL KQG$GOTMWB    ENTRY(1) ALTRET;
      195     8746    1   DCL KQL$DELAYDQ   ENTRY(2) ALTRET;
      196     8747    1   DCL KQL$INSERT    ENTRY(3) ALTRET;
      197     8748    1   DCL KQL$INSERTF   ENTRY(3) ALTRET;
      198     8749    1   DCL KQL$QDELAYM   ENTRY(2) ALTRET;
      199     8750    1   DCL KQM$GETBK     ENTRY(3) ALTRET;
      200     8751    1   DCL KQM$GETBR     ENTRY(3) ALTRET;
      201     8752    1   DCL KQM$GETMBLK   ENTRY(3) ALTRET;
      202     8753    1   DCL KQM$RELB      ENTRY(3) ALTRET;
      203     8754    1   DCL KQM$RELMBLK   ENTRY(2) ALTRET;
      204     8755    1   DCL KQP$UNLOCK    ENTRY(1) ALTRET;
      205     8756    1   DCL KQQ$DEQUEUE   ENTRY(2) ALTRET;
      206     8757    1   DCL KQQ$DQEOFTIME ENTRY(2) ALTRET;
      207     8758    1   DCL KQR$COMP      ENTRY(1) ALTRET;
      208     8759    1   DCL KQR$GOTMSG    ENTRY(1) ALTRET;
      209     8760    1   DCL KQT$GETSTA    ENTRY(3) ALTRET;
      210     8761    1   DCL KQT$GETTYP    ENTRY(3) ALTRET;
      211     8762    1   DCL KQU$DELETE    ENTRY(1) ALTRET;
      212     8763    1   DCL KQU$DELMSG    ENTRY(2) ALTRET;
      213     8764    1   DCL KQX$LDASR     ENTRY(1);
      214     8765    1   DCL KQZ$LOG       ENTRY(8) ALTRET;
      215     8766    1   DCL NIO$COMPCW    ENTRY(1);
      216     8767    1   DCL NIO$COMPCNS   ENTRY(1);
      217     8768    1   DCL SC_CGNOTIMP   ENTRY    CONV(2,0);
      218     8769    1   DCL SSR$REG       ENTRY(3) ALTRET;
      219     8770
      220     8771    1   DCL S_TIMR UBIN WORD SYMREF;
      221     8772    1   DCL S_CUN  UBIN WORD SYMREF;
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:7    
      222     8773    1   DCL B$CGPT$ PTR SYMREF;
      223     8774        %EL$CGERR (NAME=KQ_ERRLOG_BFR,STCLASS=SYMREF,N=50);
      224     8778
      225     8779
      226     8780
      227     8781        /**/
      228     8782        /* SUBS */
      229     8783        /**/
      230     8784        %SUB KQ$QTREE="CG$->KQ$CG.QUEUE.QTREE$->KQ$THDR";
      231     8785        %SUB KQ$TTREE="CG$->KQ$CG.TTREE";
      232     8786        %SUB KQ$STREE="CG$->KQ$CG.STREE";
      233     8787        %SUB KQ$QUEUE="CG$->KQ$CG.QUEUE";
      234     8788        %EJECT;
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:8    
      235     8789
      236     8790        /**
      237     8791         **
      238     8792         **
      239     8793         **           IF THE PREVIOUS WRITE WAS CONTINUED, GO DIRECTLY
      240     8794         **           TO STASH THIS CHUNK IN THE COMGROUP.  OTHERWISE,
      241     8795         **           GET AN MBLK, STUFF THE PARAMS INTO IT WHILE VALIDATING
      242     8796         **           THEM, AND THEN TRY TO WRITE THE DATA DIRECTLY TO A
      243     8797         **           READER.
      244     8798         **
      245     8799         **
      246     8800         **/
      247     8801
      248     8802    1         WRQ$=ADDR(N$WREQ);
      249     8803    1         LDCT$=NK$LDCT$(WRQ$->N$REQ.DLA.DCTX);
      250     8804    1         IF NOT LDCT$->NK$LDCT.LKFLG.ACTIVE THEN
      251     8805    2           DO;
      252     8806    2           WRQ$->N$REQ.TYC=%TYC_DACT;
      253     8807    2           GOTO BADCOMP;
      254     8808    2           END;
      255     8809    1         STA$=LDCT$->NK$LDCT.STA$;
      256     8810    1         CG$=LDCT$->NK$LDCT.CG$;
      257     8811    1         CALL KQX$LDASR (CG$->KQ$CG);
      258     8812    1         CG$->KQ$CG.STATS.WRITES=CG$->KQ$CG.STATS.WRITES+1;
      259     8813    1         DEST=0;
      260     8814    1         VLP$=WRQ$->N$REQ.STATION.LSTA$;
      261     8815    1         WAS=CG$->KQ$CG.AUCTL.WAS&VLP$->VLP$STATION.CTL.WAS;
      262     8816    1         IF STA$->KQ$STA.MBLK$ ~= ADDR(NIL) THEN
      263     8817    2           DO;
      264     8818    2           P$=ADDR(NIL);
      265     8819    2           MBLK$=STA$->KQ$STA.MBLK$;
      266     8820    3             DO WHILE (MBLK$ ~= ADDR(NIL));
      267     8821    3             IF MBLK$->KQ$MBLK.DCB$ = WRQ$->N$REQ.DCB$ THEN
      268     8822    4               DO;  /* Adding to prev continued msg */
      269     8823    4               MTYP$=ADDR(NIL);
      270     8824    4               MYMBLK$=MBLK$;
      271     8825    4               IF P$ = ADDR(NIL) THEN STA$->KQ$STA.MBLK$=MBLK$->KQ$MBLK.LNK$;
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:9    
      272     8826    4               ELSE P$->KQ$MBLK.LNK$=MBLK$->KQ$MBLK.LNK$;
      273     8827    4               IF WRQ$->N$REQ.DVE.DVBYTE.CONT = '0'B THEN
      274     8828    4                IF NOT MBLK$->KQ$MBLK.FORCECONT THEN
      275     8829    4                 MBLK$->KQ$MBLK.DVE.DVBYTE=MBLK$->KQ$MBLK.DVE.DVBYTE&(~%DVBYTE_CONT#);
      276     8830    4               IF CG$->KQ$CG.QISS THEN
      277     8831    5                 DO;
      278     8832    5                 IF VLP$->VLP$STATION.MSGTYP ~= MBLK$->KQ$MBLK.KEY2 THEN GOTO BWCCWRV;
      279     8833    5                 END;
      280     8834    4               ELSE IF VLP$->VLP$STATION.MSGTYP ~= MBLK$->KQ$MBLK.KEY1 THEN GOTO
              8834                        BWCCWRV;
      281     8835    4               BUFSZ=WRQ$->N$REQ.BUFSIZE;
      282     8836    4               VFC=0;
      283     8837    4               IF BUFSZ > KQ_MCMAX# THEN BUFSZ=KQ_MCMAX#;
      284     8838    4               GOTO WRITECG;
      285     8839    4               END;
      286     8840    3             P$=MBLK$;
      287     8841    3             MBLK$=MBLK$->KQ$MBLK.LNK$;
      288     8842    3             END;
      289     8843    2           END;
      290     8844        /**/
      291     8845            /*********************************************
      292     8846             *                                           *
      293     8847             *         Brand new write here              *
      294     8848             *                                           *
      295     8849             *********************************************/
      296     8850    1         CALL GETMBLK ALTRET(BWCTYC);
      297     8851    1         MBLK$->KQ$MBLK.LATCH=VLP$->VLP$STATION.CTL.LATCH;
      298     8852    1         MBLK$->KQ$MBLK.DVE=WRQ$->N$REQ.DVE;
      299     8853    1         VFC=BITBIN(WRQ$->N$REQ.DVE.DVBYTE.VFC);
      300     8854    1         BUFSZ=VFC+WRQ$->N$REQ.BUFSIZE;
      301     8855    1         IF BUFSZ > KQ_MCMAX# THEN
      302     8856    2           DO;
      303     8857    2           BUFSZ=KQ_MCMAX#;
      304     8858    2           WRQ$->N$REQ.BUFSIZE=KQ_MCMAX#; /* For KQG$GOTMWB */
      305     8859    2           END;
      306     8860    1         IF VLP$->VLP$STATION.CTL.ANYDCB THEN
      307     8861    2           DO;
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:10   
      308     8862    2           DSTAL=8;
      309     8863    2           MBLK$->KQ$MBLK.DSTA=' ';
      310     8864    2           END;
      311     8865    1         ELSE
      312     8866    2           DO;
      313     8867    2           MBLK$->KQ$MBLK.DSTA=VLP$->VLP$STATION.STATION;
      314     8868    2           CALL INDEX (DSTAL,'?',MBLK$->KQ$MBLK.DSTA);
      315     8869    2           END;
      316     8870              %LOCK (G=KQ$TTREE.GATE);
      317     8873    1         IF MBLK$->KQ$MBLK.LATCH THEN
      318     8874    2           DO;
      319     8875                                /* WRITE WITH LATCH */
      320     8876    2           RBLK$=STA$->KQ$STA.RBLK$;
      321     8877    2           IF RBLK$ = ADDR(NIL) THEN GOTO BWCLWRV;
      322     8878    2           IF RBLK$->KQ$RBLK.STATE ~= KQRS_COMP#
      323     8879    2           OR RBLK$->KQ$RBLK.CS = '0'B
      324     8880    2           OR RBLK$->KQ$RBLK.LATCH = '0'B
      325     8881    2           OR DSTAL ~= 8 THEN GOTO BWCLWRV;
      326     8882    2           IF CG$->KQ$CG.AUCTL.BIGMXT THEN
      327     8883    3             DO;
      328     8884    3             MBLK$->KQ$MBLK.MID.PRIMARY=RBLK$->KQ$RBLK.MBLK$->KQ$MBLK.MID.PRIMARY;
      329     8885    3             MBLK$->KQ$MBLK.MID.XT=CG$->KQ$CG.MSGIDXT;
      330     8886    3             CG$->KQ$CG.MSGIDXT=CG$->KQ$CG.MSGIDXT+1;
      331     8887    3             RBLK$->KQ$RBLK.MIDEXTV=RBLK$->KQ$RBLK.MIDEXTV+1;
      332     8888    3             END;
      333     8889    2           ELSE
      334     8890    3             DO;
      335     8891    3             IF RBLK$->KQ$RBLK.MIDEXTV >= 62 THEN GOTO BWCLWRV;
      336     8892    3             RBLK$->KQ$RBLK.MIDEXTV=RBLK$->KQ$RBLK.MIDEXTV+1;
      337     8893    3             MBLK$->KQ$MBLK.MID=RBLK$->KQ$RBLK.MBLK$->KQ$MBLK.MID;
      338     8894    3             ADDR(MBLK$->KQ$MBLK.MID.XT)->B$$MIDEXT.EXTS(RBLK$->KQ$RBLK.MIDEXTX)=
      339     8895    3             RBLK$->KQ$RBLK.MIDEXTV;
      340     8896    3             END;
      341     8897    2           END;
      342     8898    1         ELSE
      343     8899    2           DO;
      344     8900    2           MBLK$->KQ$MBLK.MID.PRIMARY=CG$->KQ$CG.MSGID;
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:11   
      345     8901    2           CG$->KQ$CG.MSGID=CG$->KQ$CG.MSGID+1;
      346     8902    2           END;
      347     8903    1         IF KQ_LOG.DSIO THEN
      348     8904    1          CALL KQZ$LOG (CG$->KQ$CG,%KQLOG_WRITE,0,
      349     8905    1          MBLK$->KQ$MBLK.MID.PRIMARY,
      350     8906    1          ADDR(MBLK$->KQ$MBLK.MID.PRIMARY)->B$$HALF,
      351     8907    1          SUBSTR(STA$->KQ$STA.BTN.KEY,0,4),
      352     8908    1          SUBSTR(STA$->KQ$STA.BTN.KEY,4,4));
      353     8909    1         IF VLP$->VLP$STATION.MSGTYP = ' ' THEN MBLK$->KQ$MBLK.KEY1=CG$->KQ$CG.AUCTL.
              8909                  DMTYP;
      354     8910    1         ELSE
      355     8911    1          MBLK$->KQ$MBLK.KEY1=VLP$->VLP$STATION.MSGTYP;
      356     8912    1         CALL KQB$SRCH (KQ$TTREE,MBLK$->KQ$MBLK.KEY1,MTYP$) ALTRET(WR0);
      357     8913    1         GOTO WR4;
      358     8914    1   WR0:  ;
      359     8915    1         IF SUBSTR (MBLK$->KQ$MBLK.KEY1,0,1) = '*' THEN
      360     8916    2           DO;
      361     8917    2           IF MBLK$->KQ$MBLK.DSTA = ' '
      362     8918    3           THEN DO;   /* Direct it to the AU if one exists                    */
      363     8919                  %LOCK (G=KQ$STREE.GATE);
      364     8922    3             IF CG$->KQ$CG.AUSTA$~=ADDR(NIL)
      365     8923    3             THEN MBLK$->KQ$MBLK.DSTA=CG$->KQ$CG.AUSTA$->KQ$STA.BTN.KEY;
      366     8924                  %UNLOCK (G=KQ$STREE.GATE);
      367     8927    3             IF MBLK$->KQ$MBLK.DSTA=' ' THEN GOTO BWCKEYT;
      368     8928    3             END;
      369     8929                                               /* STAR messages may be DIRECTED only */
      370     8930    2           MBLK$->KQ$MBLK.STAR='1'B;
      371     8931    2           MTYP$=ADDR(KQ_IMTYP);
      372     8932    2           GOTO WR1;
      373     8933    2           END;
      374     8934    1         IF CG$->KQ$CG.AUCTL.XTYPLGL = '0'B THEN
      375     8935    1          GOTO BWCKEYT;
      376     8936    1         MTYP$=STA$;
      377     8937    1         CALL KQT$GETTYP (CG$->KQ$CG,MTYP$,MBLK$->KQ$MBLK.KEY1) ALTRET(BWCFULL);
      378     8938    1   WR4:  ;   /*  VALID MESSAGE TYPE */
      379     8939    1         MTYP$->KQ$MTYP.NUMWRITES = MTYP$->KQ$MTYP.NUMWRITES + 1;
      380     8940    1   WR1:  ;
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:12   
      381     8941    1         IF (MBLK$->KQ$MBLK.LATCH) THEN
      382     8942    2           DO;
      383     8943                  /* Find the TTREE node of the MSGTYP
      384     8944                     of the READ we are latching to. */
      385     8945    2           QTN$ = RBLK$->KQ$RBLK.QTN$;  /* short cut for default CG and TPA */
      386     8946
      387     8947    2           IF QTN$ = ADDR(NIL) OR (CG$->KQ$CG.QISS)
      388     8948    2           THEN /* The READ we are LATCHing to came from the
      389     8949                            STA's MLH. We must find the TTREE NODE. */
      390     8950    2            CALL KQB$SRCH(KQ$TTREE,
      391     8951    2            PINCRW(RBLK$->KQ$RBLK.MBLK$,
      392     8952    2            2+2*BITBIN(CG$->KQ$CG.QISS))->B$$CHAR8,
      393     8953    2            QTN$) ALTRET (WR5); /* This will ALTRET if * msg */
      394     8954
      395     8955                  /* Check to see if we still have room to do latch writes */
      396     8956    2           IF (RBLK$->KQ$RBLK.MIDEXTV > QTN$->KQ$MTYP.MAXLATCH)
      397     8957    2           THEN GOTO BWCLWRV;   /* Can't latch anymore WRITES to a
      398     8958                                             READ of this type            */
      399     8959    2           END; /* IF LATCH DO */
      400     8960    1   WR5:  ;
      401     8961    1         TACTCNT=KQ$TTREE.ACTCNT;
      402     8962    1         IF CG$->KQ$CG.AUCTL.CARRYOSTA
      403     8963    1         AND MBLK$->KQ$MBLK.LATCH
      404     8964    1         AND MBLK$->KQ$MBLK.DSTA=' '
      405     8965    1         THEN IF CG$->KQ$CG.QISS
      406     8966    2          THEN DO;
      407     8967    2            OSTA = RBLK$->KQ$RBLK.MBLK$->KQ$MBLK.KEY1;
      408     8968    2            OSTAPRIO = ADDR(RBLK$->KQ$RBLK.MBLK$->KQ$MBLK.PRIO)->B$$PRIO.HI;
      409     8969    2            END;
      410     8970    2          ELSE DO;
      411     8971    2            OSTA = RBLK$->KQ$RBLK.MBLK$->KQ$MBLK.KEY2;
      412     8972    2            OSTAPRIO = ADDR(RBLK$->KQ$RBLK.MBLK$->KQ$MBLK.PRIO)->B$$PRIO.LO;
      413     8973    2            END;
      414     8974    2         ELSE DO;
      415     8975    2           OSTA = STA$->KQ$STA.BTN.KEY;
      416     8976    2           OSTAPRIO = STA$->KQ$STA.MPRIO;
      417     8977    2           END;
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:13   
      418     8978    1         IF CG$->KQ$CG.QISS THEN
      419     8979    2           DO;
      420     8980    2           ADDR(MBLK$->KQ$MBLK.PRIO)->B$$PRIO.HI=OSTAPRIO;
      421     8981    2           ADDR(MBLK$->KQ$MBLK.PRIO)->B$$PRIO.LO=MTYP$->KQ$MTYP.MPRIO;
      422     8982    2           MBLK$->KQ$MBLK.KEY2=MBLK$->KQ$MBLK.KEY1;
      423     8983    2           MBLK$->KQ$MBLK.KEY1=OSTA;
      424     8984    2           END;
      425     8985    1         ELSE
      426     8986    2           DO;
      427     8987    2           ADDR(MBLK$->KQ$MBLK.PRIO)->B$$PRIO.HI=MTYP$->KQ$MTYP.MPRIO;
      428     8988    2           ADDR(MBLK$->KQ$MBLK.PRIO)->B$$PRIO.LO=OSTAPRIO;
      429     8989    2           MBLK$->KQ$MBLK.KEY2=OSTA;
      430     8990    2           END;
      431     8991    1         MBLK$->KQ$MBLK.JOURNAL=MTYP$->KQ$MTYP.JOURNAL;
      432     8992    1         IF  MTYP$->KQ$MTYP.ONEREPORT
      433     8993    1         AND MBLK$->KQ$MBLK.LATCH THEN
      434     8994    2           DO;
      435     8995    2           MBLK$->KQ$MBLK.FORCECONT='1'B;
      436     8996    2           MBLK$->KQ$MBLK.DVE.DVBYTE=MBLK$->KQ$MBLK.DVE.DVBYTE | %DVBYTE_CONT#;
      437     8997    2           END;
      438     8998              %UNLOCK (G=KQ$TTREE.GATE);
      439     9001    1         MBLK$->KQ$MBLK.FC=WRQ$->N$REQ.FC;
      440     9002    1         MBLK$->KQ$MBLK.LNK$=ADDR(NIL);
      441     9003    1         IF DSTAL ~= 8 THEN
      442     9004    2           DO;
      443     9005    2           CALL WRWILD ALTRET(BWCTYC);
      444     9006    2           GOTO WRITECOMP;
      445     9007    2           END;
      446     9008    1         ELSE
      447     9009    1          IF MBLK$->KQ$MBLK.DVE.DVBYTE&%DVBYTE_CONT#
      448     9010    1          OR MBLK$->KQ$MBLK.LATCH
      449     9011    1          OR MBLK$->KQ$MBLK.JOURNAL
      450     9012    1          OR MBLK$->KQ$MBLK.STAR THEN GOTO WRITECG;
      451     9013        %EJECT;
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:14   
      452     9014        /***
      453     9015         ***
      454     9016         ***
      455     9017         ***               TRY TO GIVE THIS WRITE DIRECTLY TO A READER
      456     9018         ***
      457     9019         ***
      458     9020         ***/
      459     9021
      460     9022    1         IF MBLK$->KQ$MBLK.DSTA ~= ' ' THEN
      461     9023    2           DO;
      462     9024    2           CALL CHKSTAL ALTRET(BWCTYC);
      463     9025    2           IF NOT CG$->KQ$CG.AUCTL.DRML THEN
      464     9026    3             DO;
      465     9027                                /**********************************
      466     9028                                 *                                *
      467     9029                                 *       DIRECTED WRITE           *
      468     9030                                 *                                *
      469     9031                                 **********************************/
      470     9032    3             RBLK$=DSTA$->KQ$STA.RBLK$;
      471     9033    3             IF RBLK$ ~= ADDR(NIL) THEN
      472     9034    3              IF  RBLK$->KQ$RBLK.STATE = KQRS_PEND#
      473     9035    3              AND RBLK$->KQ$RBLK.LATCH = '0'B
      474     9036    3              AND DSTA$->KQ$STA.MLH.BUSY = '0'B THEN
      475     9037    4                DO;
      476     9038    4                KEY1L=RBLK$->KQ$RBLK.KEY1L;
      477     9039    4                KEY2L=RBLK$->KQ$RBLK.KEY2L;
      478     9040    4                IF  ADDR(RBLK$->KQ$RBLK.KEY1)->B$$KEY1 = ADDR(MBLK$->KQ$MBLK.KEY1)->
              9040                         B$$KEY1
      479     9041    4                AND ADDR(RBLK$->KQ$RBLK.KEY2)->B$$KEY2 = ADDR(MBLK$->KQ$MBLK.KEY2)->
              9041                         B$$KEY2
      480     9042    4                AND ((RBLK$->KQ$RBLK.MID.PRIMARY = 0) OR
      481     9043    4                (RBLK$->KQ$RBLK.MID.PRIMARY = MBLK$->KQ$MBLK.MID.PRIMARY)) THEN
      482     9044    5                  DO;
      483     9045    5                  IF DSTA$->KQ$STA.LDCT$->NK$LDCT.RESCOD = NK_CGDCB THEN
      484     9046    6                    DO;
      485     9047    6                    CALL XFERD ALTRET(WRITECOMP);
      486     9048    6   WR3:             IF DEST = 0 THEN GOTO BWCBUF;
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:15   
      487     9049    6                    IF DEST = 3 THEN GOTO BWDELMSG;
      488     9050    6                    END;
      489     9051    5                  ELSE
      490     9052    5                   IF  DSTA$->KQ$STA.LDCT$->NK$LDCT.RLCID.NODE ~= 0
      491     9053    5                   AND WRQ$->N$REQ.FC ~= %N_WRASC
      492     9054    5                   AND CG$->KQ$CG.AUCTL.SECURE = '0'B THEN
      493     9055    6                     DO;
      494     9056    6                     CALL SETWCOMP;
      495     9057    6                     DSTA$->KQ$STA.LOCKCNT=DSTA$->KQ$STA.LOCKCNT+1;
      496     9058    6                     RBLK$->KQ$RBLKT.IOQ$=WRQ$;
      497     9059    7                     CALL MOVMXT (MYMBLK$) WHENALTRETURN DO;
      498     9060    7                       DSTA$->KQ$STA.LOCKCNT = DSTA$->KQ$STA.LOCKCNT-1;
      499     9061    7                       GOTO BWDELMSG;
      500     9062    7                       END;
      501     9063    6                     CALL KQG$GOTMWB (DSTA$->KQ$STA.LDCT$->NK$LDCT) ALTRET(WR2);
      502     9064    6                     IF WRQ$->N$REQ.TYC THEN GOTO BADCOMP;
      503     9065    6                     WRQ$->N$REQ.STATION.LSTA$=ADDR(VLP_STATION);
      504     9066    6                     GOTO WRITECOMP;
      505     9067    6   WR2:              MYMBLK$=MBLK$;
      506     9068    6                     GOTO WRITECG;
      507     9069    6                     END;
      508     9070    5                  END;
      509     9071    4                END;
      510     9072    3             DEST=1;
      511     9073    3             END;
      512     9074    3           ELSE DO;
      513     9075                  %UNLOCK(G=DSTA$->KQ$STA.GATE);
      514     9078    3             END;
      515     9079    2           END;
      516     9080    1         ELSE IF NOT CG$->KQ$CG.AUCTL.QRML THEN
      517     9081    2            DO;
      518     9082                                /**********************************
      519     9083                                 *                                *
      520     9084                                 *       WRITE TO QUEUE           *
      521     9085                                 *                                *
      522     9086                                 **********************************/
      523     9087                 %LOCK (G=KQ$QTREE.GATE);
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:16   
      524     9090    2            IF CG$->KQ$CG.QISS THEN QTN$=STA$;
      525     9091    2            ELSE
      526     9092    3              DO;
      527     9093    3              IF TACTCNT ~= KQ$TTREE.ACTCNT THEN
      528     9094    3               CALL KQB$SRCH (KQ$TTREE,MBLK$->KQ$MBLK.KEY1,QTN$) ALTRET(BWCKEYT);
      529     9095    3              ELSE QTN$=MTYP$;
      530     9096    3              END;
      531     9097    2            P$=ADDR(QTN$->KQ$QTN.READS$);
      532     9098    2            RBLK$=P$->B$$PTR;
      533     9099    3              DO WHILE (RBLK$ ~= ADDR(NIL));
      534     9100    3              KEY2L=RBLK$->KQ$RBLK.KEY2L;
      535     9101    3              IF ADDR(RBLK$->KQ$RBLK.KEY2)->B$$KEY2 = ADDR(MBLK$->KQ$MBLK.KEY2)->
              9101                       B$$KEY2
      536     9102    3              AND ((RBLK$->KQ$RBLK.MID.PRIMARY = 0) OR
      537     9103    3              (RBLK$->KQ$RBLK.MID.PRIMARY = MBLK$->KQ$MBLK.MID.PRIMARY)) THEN
      538     9104    4                DO;
      539     9105    4                IF RBLK$->KQ$RBLK.LATCH THEN GOTO WR11;
      540     9106    4                DSTA$=RBLK$->KQ$RBLK.STA$;
      541     9107                     %LOCK (G=DSTA$->KQ$STA.GATE);
      542     9110    4                IF RBLK$->KQ$RBLK.STATE = KQRS_PEND# THEN
      543     9111    5                  DO;
      544     9112    5   WRITENOWQ:     ;
      545     9113    5                  CALL XFERQ ALTRET(WRITECOMP);
      546     9114    5                  GOTO WR3;
      547     9115    5                  END;
      548     9116                     %UNLOCK (G=DSTA$->KQ$STA.GATE);
      549     9119    4                END;
      550     9120    3              P$=ADDR(RBLK$->KQ$RBLK.QRLNK$);
      551     9121    3              RBLK$=P$->B$$PTR;
      552     9122    3              END;
      553     9123                           /* COULD NOT FIND A GOOD READ ON THIS Q-TREE NODE.
      554     9124                              LOOK IN WILD-CARDED READS */
      555     9125    2            P$=ADDR(KQ$QUEUE.WCRL$);
      556     9126    2            RBLK$=P$->B$$PTR;
      557     9127    3              DO WHILE (RBLK$ ~= ADDR(NIL));
      558     9128    3              KEY1L=RBLK$->KQ$RBLK.KEY1L;
      559     9129    3              KEY2L=RBLK$->KQ$RBLK.KEY2L;
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:17   
      560     9130    3              IF  ADDR(RBLK$->KQ$RBLK.KEY1)->B$$KEY1 = ADDR(MBLK$->KQ$MBLK.KEY1)->
              9130                       B$$KEY1
      561     9131    3              AND ADDR(RBLK$->KQ$RBLK.KEY2)->B$$KEY2 = ADDR(MBLK$->KQ$MBLK.KEY2)->
              9131                       B$$KEY2 THEN
      562     9132    4                DO;
      563     9133    4                IF RBLK$->KQ$RBLK.LATCH THEN GOTO WR11;
      564     9134    4                DSTA$=RBLK$->KQ$RBLK.STA$;
      565     9135                     %LOCK (G=DSTA$->KQ$STA.GATE);
      566     9138    4                IF RBLK$->KQ$RBLK.STATE = KQRS_PEND# THEN
      567     9139    4                 GOTO WRITENOWQ;
      568     9140                     %UNLOCK (G=DSTA$->KQ$STA.GATE);
      569     9143    4                END;
      570     9144    3              P$=ADDR(RBLK$->KQ$RBLK.QRLNK$);
      571     9145    3              RBLK$=P$->B$$PTR;
      572     9146    3              END;
      573     9147    2   WR11:    ;
      574     9148    2            DEST=-1;
      575     9149    2            END;
      576     9150        %EJECT;
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:18   
      577     9151        /***
      578     9152         ***
      579     9153         ***
      580     9154         ***          WRITE THE DATA INTO THE COMGROUP, THEN GO
      581     9155         ***          FIND A PLACE TO GIVE IT TO, UNLESS IT'S LATCHED
      582     9156         ***          OR CONTINUED.
      583     9157         ***
      584     9158         ***
      585     9159         ***/
      586     9160                      /* If DEST=1, then this is a directed write, and
      587     9161                           the destination station gate is still locked,
      588     9162                           with DSTA$ pointing to it.
      589     9163                         If DEST=-1, then this is a write to the queue,
      590     9164                           which is still locked, with QTN$ pointing to
      591     9165                           the node.
      592     9166                         If DEST=0, then we know nothing about the destination
      593     9167                           of the write. */
      594     9168    1   WRITECG:;
      595     9169    1         IF BUFSZ ~= 0 THEN
      596     9170    2           DO;
      597     9171    2           CALL GETDBLK ALTRET(BWCTYC);
      598     9172    2           CALL FILLDBLK ALTRET(BWCTYC);
      599     9173    2           IF MBLK$->KQ$MBLK.DDA = 0 THEN MBLK$->KQ$MBLK.DDA=NEWDDA;
      600     9174    2           ELSE
      601     9175    3             DO;
      602     9176    3   WRITECG0: ;
      603     9177    3             DBLK$R=MBLK$->KQ$MBLK.STAMP;
      604     9178    3             DDA=MBLK$->KQ$MBLK.PREVDDA;
      605     9179    3             IF DEST ~= 0 THEN
      606     9180    3              CALL KQD$FETCH (CG$->KQ$CG,DBLK$,DDA) ALTRET(NOFETCH);
      607     9181    3             ELSE CALL KQD$FETCHR (CG$->KQ$CG,DBLK$,DDA) ALTRET(NOFETCH1);
      608     9182    3   WRITECG1: ;
      609     9183    3             DBLK$->KQ$DBLK.FLNKDA=NEWDDA;
      610     9184    3             CALL KQD$UPDATED (CG$->KQ$CG,DBLK$);
      611     9185    3             END;
      612     9186    2           MBLK$->KQ$MBLK.PREVDDA=NEWDDA;
      613     9187    2           END;
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:19   
      614     9188    1         CALL SETWCOMP;
      615     9189    1         IF NOT MBLK$->KQ$MBLK.DVE.DVBYTE&%DVBYTE_CONT# THEN
      616     9190    2           DO;
      617     9191    2           MBLK$->KQ$MBLK.LNK$=ADDR(NIL);
      618     9192    2           IF MBLK$->KQ$MBLK.LATCH THEN
      619     9193    3             DO;
      620     9194    3             CALL CHKSTA ALTRET(BWCTYC);
      621     9195    3             MBLK$->KQ$MBLK.DCB$=WRQ$->N$REQ.DCB$;
      622     9196    3             RBLK$=STA$->KQ$STA.RBLK$;
      623     9197    4               DO INHIBIT;
      624     9198    4               IF RBLK$->KQ$RBLK.LWRITES$ = ADDR(NIL) THEN
      625     9199    4                RBLK$->KQ$RBLK.LWRITES$=MBLK$;
      626     9200    4               ELSE
      627     9201    4                RBLK$->KQ$RBLK.LWTL$->KQ$MBLK.LNK$=MBLK$;
      628     9202    4               RBLK$->KQ$RBLK.LWTL$=MBLK$;
      629     9203    4               END;
      630     9204    3             END;
      631     9205    2           ELSE
      632     9206    3             DO;
      633     9207    3             MBLK$->KQ$MBLK.TYC='0'B;
      634     9208    3             IF DEST > 0 THEN CALL SENDMSGD (MYMBLK$);
      635     9209    3             ELSE IF DEST < 0 THEN CALL SENDMSGQ (MYMBLK$);
      636     9210    3              ELSE
      637     9211    4                DO;
      638     9212    4                WAS=CG$->KQ$CG.AUCTL.WAS;
      639     9213    4                CALL SENDMSG (MYMBLK$) ALTRET(BWCTYC);
      640     9214    4                END;
      641     9215    3             END;
      642     9216    2           END;
      643     9217    1         ELSE
      644     9218    2           DO;
      645     9219    2           MBLK$->KQ$MBLK.DCB$=WRQ$->N$REQ.DCB$;
      646     9220    2           MBLK$->KQ$MBLK.LNK$=STA$->KQ$STA.MBLK$;
      647     9221    2           STA$->KQ$STA.MBLK$=MBLK$;
      648     9222    2           END;
      649     9223    1   WRITECOMP:;
      650     9224    1         STA$->KQ$STA.WRITES=STA$->KQ$STA.WRITES+1;
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:20   
      651     9225    1         CALL NIO$COMPCW (WRQ$->N$REQ);
      652     9226    1         RETURN;
      653     9227        /**/
      654     9228    1   NOFETCH:;
      655     9229    1         CALL DESTUL;
      656     9230    1         IF DBLK$ = ADDR(NIL) THEN
      657     9231    2           DO;
      658     9232    2   NOFETCH0:;
      659     9233    3             DO CASE (DDA);
      660     9234
      661     9235    3               CASE (%KQDE_NDFRBLK);
      662     9236    3                 GOTO WRITECG0;
      663     9237
      664     9238    3               CASE (%KQDE_STMP,%KQDE_STATE,%KQDE_BDDA);
      665     9239    3                 WRQ$->N$REQ.TYC=%TYC_DI;
      666     9240    3                 GOTO NOFETCH2;
      667     9241
      668     9242    3               CASE (%KQDE_IOERR);
      669     9243    3                 WRQ$->N$REQ.TYC=%TYC_IOERR;
      670     9244    3   NOFETCH2:     ;
      671     9245                      %LOCK (G=KQ_ERRLOG_GATE);
      672     9248    3                 KQ_ERRLOG_BFR.CODE=%KQELOG_KQW_CWFTCH;
      673     9249    3                 KQ_ERRLOG_BFR.SIZ=2+SIZEW(KQ$MBLK);
      674     9250    3                 P$=ADDR(KQ_ERRLOG_BFR.INFO);
      675     9251    3                 KQ_ERRLOG_BFR.INFO='0'B;
      676     9252    3                 P$->B$$CHAR8=STA$->KQ$STA.BTN.KEY;
      677     9253    3                 P$=PINCRW(P$,2);
      678     9254    3                 P$->KQ$MBLK=MBLK$->KQ$MBLK;
      679     9255    3                 CALL KQD$ERRLOG (CG$->KQ$CG);
      680     9256    3                 GOTO BWDELMSG;
      681     9257
      682     9258    3               CASE (ELSE);
      683     9259    3                 CALL SC_CGNOTIMP;
      684     9260        /*S* SCREECH_CODE: KQW-S$CGNOTIMP
      685     9261             TYPE:         SCREECH
      686     9262             MESSAGE:      Unimplemented comgroup condition encountered
      687     9263             DESCRIPTION:  An unknown or unimplemented comgroup condition
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:21   
      688     9264                           has been encountered.  This is almost always
      689     9265                           an unknown condition that should not happen. */
      690     9266
      691     9267    3             END;
      692     9268    2           END;
      693     9269
      694     9270    1         DDA=MBLK$->KQ$MBLK.PREVDDA;
      695     9271    1         CALL KQD$DEFERWAIT (CG$->KQ$CG,DBLK$,DDA) ALTRET(NOFETCH1);
      696     9272    1         GOTO WRITECG1;
      697     9273    1   NOFETCH1:;
      698     9274    1         IF DDA ~= %KQDE_CREG THEN GOTO NOFETCH0;
      699     9275    1         CALL SC_CGNOTIMP; /* Must be MONKEY somehow doing a */
      700     9276                                /* continued write, which is illegal */
      701     9277        /**/
      702     9278        /**/
      703     9279    1   BWCCWRV:;
      704     9280    1         WRQ$->N$REQ.TYC=%TYC_CGCWRV;
      705     9281    1         GOTO BADCOMP;
      706     9282    1   BWCLWRV:;
      707     9283              %UNLOCK (G=KQ$TTREE.GATE);
      708     9286    1         WRQ$->N$REQ.TYC=%TYC_CGLWRV;
      709     9287    1         GOTO BWDELMSG;
      710     9288    1   BWCFULL:;
      711     9289    1         WRQ$->N$REQ.TYC=%TYC_CGFULL;
      712     9290    1         GOTO BWDELMSG;
      713     9291    1   BWCBUF:;
      714     9292    1         WRQ$->N$REQ.TYC=%TYC_MTRAP;
      715     9293    1   BWC1: ;
      716     9294    1         CALL DESTUL;
      717     9295    1   BWDELMSG:;
      718     9296    1         IF MYMBLK$ ~= ADDR(NIL) THEN
      719     9297    2           DO;
      720     9298    2           IF (MTYP$ ~= ADDR(NIL)) AND (MTYP$ ~= ADDR(KQ_IMTYP))
      721     9299    3           THEN DO;
      722     9300    3             IF (CG$->KQ$CG.QISS)
      723     9301                      /* use of OSTA here to represent MSGTYP to save AUTO */
      724     9302    3             THEN OSTA=MYMBLK$->KQ$MBLK.KEY2 ;
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:22   
      725     9303    3             ELSE OSTA=MYMBLK$->KQ$MBLK.KEY1 ;
      726     9304    3             CALL KQB$SRCH (KQ$TTREE,OSTA,MTYP$)
      727     9305    4             WHENRETURN DO;
      728     9306    4               MTYP$->KQ$MTYP.NUMWRITES = MTYP$->KQ$MTYP.NUMWRITES - 1;
      729     9307    4               END;
      730     9308    3             END;
      731     9309    2           CALL KQU$DELMSG (CG$->KQ$CG,MYMBLK$->KQ$MBLK);
      732     9310    2           END;
      733     9311    1         GOTO BADCOMP;
      734     9312    1   BWCKEYT:;
      735     9313              %UNLOCK (G=KQ$TTREE.GATE);
      736     9316    1   BWCKEY:;
      737     9317    1         WRQ$->N$REQ.TYC=%TYC_CGKEYV;
      738     9318    1         GOTO BWDELMSG;
      739     9319    1   BWCTYC:;
      740     9320    1         WRQ$->N$REQ.TYC=TYC;
      741     9321    1         GOTO BWDELMSG;
      742     9322    1   BADCOMP: ;
      743     9323    1         CALL NIO$COMPCNS (WRQ$->N$REQ);
      744     9324    1         RETURN;
      745     9325    1   DESTUL: PROC;
      746     9326    2         IF DEST > 0 THEN
      747     9327    3           DO;
      748     9328                %UNLOCK (G=DSTA$->KQ$STA.GATE);
      749     9331    3           END;
      750     9332    2         ELSE IF DEST < 0 THEN
      751     9333    3            DO;
      752     9334                 %UNLOCK (G=KQ$QTREE.GATE);
      753     9337    3            END;
      754     9338    2         DEST=0;
      755     9339    2         RETURN;
      756     9340    2   END DESTUL;
      757     9341        %EJECT;
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:23   
      758     9342        /**/
      759     9343        /*F* NAME:         KQW$SEND
      760     9344             PURPOSE:      To dispatch an output message on behalf of a station
      761     9345             CALL:         KQW$SEND (KQ$STA)
      762     9346             DESCRIPTION:  The message to be sent is pointed to by KQ$STA.MBLK$,
      763     9347                           and already has all its data in the comgroup, has
      764     9348                           a MID allocated, etc.
      765     9349                           If the message cannot be delivered, due to illegal
      766     9350                           due to illegal msg type or destination station, it is
      767     9351                           simply discarded, and we ALTRET.
      768     9352        */
      769     9353    1   KQW$SEND: ENTRY (N$WREQ) ALTRET;
      770     9354        /**/
      771     9355    1         STA$=ADDR(N$WREQ);
      772     9356    1         CG$=STA$->KQ$STA.CG$;
      773     9357    1         WAS=CG$->KQ$CG.AUCTL.WAS;
      774     9358    1   SEND0:;
      775     9359    1         MTYP$=ADDR(NIL);
      776     9360    1         STA$->KQ$STA.MBLK$->KQ$MBLK.LNK$=ADDR(NIL);
      777     9361    1         CALL SENDMSG (STA$->KQ$STA.MBLK$) ALTRET(ALTRT);
      778     9362    1   RTN:  ;
      779     9363    1         RETURN;
      780     9364    1   ALTRT:;
      781     9365    1         ALTRETURN;
      782     9366        /**/
      783     9367        /*F* NAME:         KQW$SENDNA
      784     9368             PURPOSE:      To dispatch an output message on behalf of a station
      785     9369             DESCRIPTION:  Just like KQW$SEND but always dumps the message
      786     9370                           if the recipient is not there, regardless of
      787     9371                           KQ$CG.AUCTL.WAS.
      788     9372        */
      789     9373    1   KQW$SENDNA: ENTRY (N$WREQ) ALTRET;
      790     9374        /**/
      791     9375    1         WAS='0'B;
      792     9376    1   SEND00:;
      793     9377    1         STA$=ADDR(N$WREQ);
      794     9378    1         CG$=STA$->KQ$STA.CG$;
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:24   
      795     9379    1         GOTO SEND0;
      796     9380        /**/
      797     9381        /*F* NAME:         KQW$SENDAUP
      798     9382             PURPOSE:      To dispatch an output message on behalf of a station
      799     9383             DESCRIPTION:  Like KQW$SEND but forces AUP (but not WAS)
      800     9384        */
      801     9385    1   KQW$SENDAUP: ENTRY (N$WREQ) ALTRET;
      802     9386        /**/
      803     9387    1         STA$=ADDR(N$WREQ);
      804     9388    1         CG$=STA$->KQ$STA.CG$;
      805     9389    1         WAS='01'B|CG$->KQ$CG.AUCTL.WAS;
      806     9390    1         GOTO SEND0;
      807     9391        %EJECT;
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:25   
      808     9392        /**/
      809     9393        /*F* NAME:         KQW$XMITSELF
      810     9394             PURPOSE:      To send delayed messages to a station
      811     9395             CALL:         KQW$XMITSELF (STA$) ALTRET(DONE)
      812     9396             INPUT:        Station gate locked
      813     9397             OUTPUT:       Station gate locked
      814     9398                           STA$->KQ$MLH.DELAYDQ$, a KQ$DPTR for non-message item
      815     9399                                              (RETURN only)
      816     9400             DESCRIPTION:  ALTRETs when the delay list is empty.
      817     9401                           RETURNs when a non-message delay item is
      818     9402                           found.
      819     9403
      820     9404                           Each message found is written to the station,
      821     9405                           either satisfying a read, or being merged into
      822     9406                           the MBLK list.
      823     9407        */
      824     9408    1   KQW$XMITSELF: ENTRY (N$WREQ) ALTRET; /* !!Doesn't ALTRET!! */
      825     9409        /**/
      826     9410    1         STA$=ADDR(N$WREQ)->B$$PTR;
      827     9411    1         CG$=STA$->KQ$STA.CG$;
      828     9412    1         DSTA$=STA$;
      829     9413    2           DO FOREVER;
      830     9414    2           CALL KQL$DELAYDQ (STA$->KQ$STA.MLH.DELAY$,STA$->KQ$STA.MLH.DELAYDQ$) ALTRET(
              9414                    ALTRT);
      831     9415    2           IF ADDR(STA$->KQ$STA.MLH.DELAYDQ$)->KQ$DPTR.X.FLGS
      832     9416    2           OR ADDR(STA$->KQ$STA.MLH.DELAYDQ$)->KQ$DPTR.X.CODE ~= KQRA_MBLK#
      833     9417    2           THEN RETURN;
      834     9418    2           ADDR(STA$->KQ$STA.MLH.DELAYDQ$)->KQ$DPTR.X='0'B;
      835     9419    2           CALL SENDMSGD1 (STA$->KQ$STA.MLH.DELAYDQ$) ALTRET(XMS1);
      836     9420                %LOCK (G=STA$->KQ$STA.GATE);
      837     9423    2   XMS1:   END;
      838     9424        /**/
      839     9425        /*F* NAME:         KQW$XMITQ
      840     9426             PURPOSE:      To send the queue's delayed list
      841     9427                           into the queue
      842     9428             CALL:         KQW$XMITQ (CG$) ALTRET(DONE)
      843     9429             INPUT:        Q-tree gate locked
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:26   
      844     9430             OUTPUT:       Q-tree gate locked
      845     9431             DESCRIPTION:  Just like KQW$XMITSELF but for the anonymous
      846     9432                           queue.
      847     9433        */
      848     9434    1   KQW$XMITQ: ENTRY (N$WREQ) ALTRET; /* !!Doesn't ALTRET!! */
      849     9435        /**/
      850     9436    1         RCVR=0;
      851     9437    1   XMITQCMN:;
      852     9438    1         CG$=ADDR(N$WREQ)->B$$PTR;
      853     9439    2           DO FOREVER;
      854     9440    2           CALL KQL$DELAYDQ (KQ$QUEUE.DELAY$,KQ$QUEUE.DELAYDQ$) ALTRET(ALTRT);
      855     9441    2           IF ADDR(KQ$QUEUE.DELAYDQ$)->KQ$DPTR.X.CODE ~= KQRA_MBLK#
      856     9442    3           THEN DO;
      857     9443    3             IF RCVR = 1
      858     9444    4             THEN DO;
      859     9445    4               KQ$QUEUE.DELAYDQ$=ADDR(NIL);
      860     9446    4               GOTO XMITQ2;
      861     9447    4               END;
      862     9448    3             RETURN;
      863     9449    3             END;
      864     9450    2           ADDR(KQ$QUEUE.DELAYDQ$)->KQ$DPTR.X='0'B;
      865     9451    2           CALL KQB$SRCH (KQ$QTREE,KQ$QUEUE.DELAYDQ$->KQ$MBLK.KEY1,QTN$) ALTRET(XMITQ0)
              9451                    ;
      866     9452    2           CALL SENDMSGQ1 (KQ$QUEUE.DELAYDQ$);
      867     9453    2           GOTO XMITQ1;
      868     9454    2   XMITQ0: ;
      869     9455    2           CG$->KQ$CG.STATS.CCMQ=CG$->KQ$CG.STATS.CCMQ-1;
      870     9456                %UNLOCK (G=KQ$QTREE.GATE);
      871     9459    2           CALL KQU$DELMSG (CG$->KQ$CG,P$->KQ$MBLK);
      872     9460    2   XMITQ1: ;
      873     9461                %LOCK (G=KQ$QTREE.GATE);
      874     9464    2   XMITQ2: END;
      875     9465        /**/
      876     9466        /*F* NAME:         KQW$XMITQR
      877     9467             PURPOSE:      To send the queue's delay list into the queue
      878     9468                           during comgroup reopen
      879     9469             DESCRIPTION:  Just like KQW$XMITQ but ignores station read
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:27   
      880     9470                           requests found on the delay list. */
      881     9471    1   KQW$XMITQR: ENTRY (N$WREQ) ALTRET;
      882     9472        /**/
      883     9473    1         RCVR=1;
      884     9474    1         GOTO XMITQCMN;
      885     9475        %EJECT;
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:28   
      886     9476        /**/
      887     9477        /*F* NAME:         KQW$HOLD
      888     9478             PURPOSE:      To put a message in 'hold'
      889     9479             CALL:         KQW$HOLD (KQ$STA)
      890     9480             INPUT:        Message is in KQ$STA.MBLK$
      891     9481             DESCRIPTION:  If KQ$CG.HOLDSTA$ is ADDR(NIL), deletes the
      892     9482                           msg; else writes it to that station, ignoring
      893     9483                           WAS and AUP.
      894     9484        */
      895     9485    1   KQW$HOLD: ENTRY (N$WREQ) ALTRET; /* !!Doesn't ALTRET!! */
      896     9486        /**/
      897     9487    1         STA$=ADDR(N$WREQ);
      898     9488    1         CG$=STA$->KQ$STA.CG$;
      899     9489    1         P$=ADDR(CG$->KQ$CG.HOLDSTA$);
      900     9490    1         MYMBLK$=STA$->KQ$STA.MBLK$;
      901     9491    1         STA$->KQ$STA.MBLK$=ADDR(NIL);
      902     9492    1   HOLD0:;
      903     9493              %LOCK (G=KQ$STREE.GATE);
      904     9496    1         DSTA$=P$->B$$PTR;
      905     9497    1         IF DSTA$ = ADDR(NIL) THEN
      906     9498    2           DO;
      907     9499                %UNLOCK (G=KQ$STREE.GATE);
      908     9502    2           CALL KQU$DELMSG (CG$->KQ$CG,MYMBLK$->KQ$MBLK);
      909     9503    2           RETURN;
      910     9504    2           END;
      911     9505              %LOCK (G=DSTA$->KQ$STA.GATE);
      912     9508              %UNLOCK (G=KQ$STREE.GATE);
      913     9511    1         CALL SENDMSGD (MYMBLK$);
      914     9512    1         RETURN;
      915     9513        /**/
      916     9514        /*F* NAME:         KQW$JNLD
      917     9515             PURPOSE:      To send a journal delete message to the
      918     9516                           JOURNAL station
      919     9517             CALL:         KQW$JNLD (KQ$STA)
      920     9518             INPUT:        Message is in KQ$STA.MBLK$
      921     9519                           KQ$STA.GATE is locked.
      922     9520             DESCRIPTION:  If KQ$CG.HOLDSTA$ is ADDR(NIL), deletes the
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:29   
      923     9521                           message; else writes it to that station,
      924     9522                           ignoring WAS and AUP.
      925     9523        */
      926     9524    1   KQW$JNLD: ENTRY (N$WREQ) ALTRET; /* !!Doesn't ALTRET!! */
      927     9525        /**/
      928     9526    1         STA$=ADDR(N$WREQ);
      929     9527    1         CG$=STA$->KQ$STA.CG$;
      930     9528    1         P$=ADDR(CG$->KQ$CG.JRNLSTA$);
      931     9529    1         MYMBLK$=STA$->KQ$STA.MBLK$;
      932     9530    1         STA$->KQ$STA.MBLK$=ADDR(NIL);
      933     9531              %UNLOCK (G=STA$->KQ$STA.GATE);
      934     9534    1         GOTO HOLD0;
      935     9535        /**/
      936     9536        /*F* NAME:         KQW$TELLAU
      937     9537             PURPOSE:      To send a message to the AU
      938     9538             CALL:         KQW$TELLAU (KQ$CG.GORGOSTA$->KQ$STA)
      939     9539             INPUT:        GORGOSTA gate locked
      940     9540                           GORGOSTA.MBLK$ is the message to send
      941     9541             DESCRIPTION:  If the destination is '*GORGO' then
      942     9542                           a SENDF is simulated, else a SENDNA is
      943     9543                           simulated.
      944     9544        */
      945     9545    1   KQW$TELLAU: ENTRY (N$WREQ) ALTRET;
      946     9546        /**/
      947     9547    1         STA$=ADDR(N$WREQ);
      948     9548    1         CG$=STA$->KQ$STA.CG$;
      949     9549    1         MYMBLK$=STA$->KQ$STA.MBLK$;
      950     9550    1         STA$->KQ$STA.MBLK$=ADDR(NIL);
      951     9551              %UNLOCK (G=STA$->KQ$STA.GATE);
      952     9554    1         MTYP$=ADDR(NIL);
      953     9555    1         MYMBLK$->KQ$MBLK.LNK$=ADDR(NIL);
      954     9556    1         IF MYMBLK$->KQ$MBLK.DSTA = '*GORGO' THEN
      955     9557    1          WAS='11'B;
      956     9558    1         ELSE WAS='0'B;
      957     9559    1         CALL SENDMSG (MYMBLK$) ALTRET(ALTRT);
      958     9560    1         RETURN;
      959     9561        %EJECT;
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:30   
      960     9562        /**/
      961     9563        /*********************************************************************************
      962     9564        *                                                                                *
      963     9565        *   SSS   U   U  BBBB   RRRR    OOO   U   U  TTTTT   III   N   N  EEEEE   SSS    *
      964     9566        *  S   S  U   U  B   B  R   R  O O O  U   U    T      I    N   N  E      S   S   *
      965     9567        *  S      U   U  B   B  R   R  O O O  U   U    T      I    NN  N  E      S       *
      966     9568        *   SSS   U   U  BBBB   RRRR   O  OO  U   U    T      I    N N N  EEEE    SSS    *
      967     9569        *      S  U   U  B   B  R R    O   O  U   U    T      I    N  NN  E          S   *
      968     9570        *  S   S  U   U  B   B  R  R   O   O  U   U    T      I    N   N  E      S   S   *
      969     9571        *   SSS    UUU   BBBB   R   R   OOO    UUU     T     III   N   N  EEEEE   SSS    *
      970     9572        *                                                                                *
      971     9573        *********************************************************************************/
      972     9574
      973     9575        /****************************************************************
      974     9576        *****************************************************************/
      975     9577        /*D* NAME:         GETMBLK
      976     9578             PURPOSE:      To get an MBLK
      977     9579             DESCRIPTION:  Gets an MBLK as MBLK$ and sets up MYMBLK$.
      978     9580                           If none, ALTRETs with correct TYC.
      979     9581        */
      980     9582    1   GETMBLK: PROC ALTRET;
      981     9583        /**/
      982     9584    2   DCL T$ PTR;
      983     9585        /**/
      984     9586    2         CALL KQM$GETMBLK (CG$->KQ$CG,T$,DDA) ALTRET(W0);
      985     9587    2         GOTO W1;
      986     9588    2   W0:   IF STA$->KQ$STA.MONDCB THEN
      987     9589    3           DO;
      988     9590    3           IF S_CUN = 0 OR S_TIMR = 2 THEN GOTO BWCFULL;
      989     9591    3           I=SIZEW(KQ$MBLK);
      990     9592    3           CALL KQM$GETBK (CG$->KQ$CG,T$,I) ALTRET(MD1);
      991     9593    3           I=SIZEW(KQ$MBLK);
      992     9594    3           CALL KQM$RELB (CG$->KQ$CG,T$,I);
      993     9595    3   MD1:    CALL SSR$REG (%SS_SL,,1);
      994     9596    3           CALL KQM$GETMBLK (CG$->KQ$CG,T$,I) ALTRET(BWCFULL);
      995     9597    3           GOTO W1;
      996     9598    3           END;
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:31   
      997     9599    2         I=KQMR_MBLK#;
      998     9600    2         T$=STA$;
      999     9601    2         CALL KQM$GETBR (CG$->KQ$CG,T$,I) ALTRET(BWCFULL);
     1000     9602    2   W1:   MYMBLK$=T$;
     1001     9603    2         MBLK$=T$;
     1002     9604    2         RETURN;
     1003     9605    2   BWCFULL:;
     1004     9606    2         MYMBLK$=ADDR(NIL);
     1005     9607    2         TYC=%TYC_CGFULL;
     1006     9608    2         ALTRETURN;
     1007     9609    2   END GETMBLK;
     1008     9610        /****************************************************************
     1009     9611        *****************************************************************/
     1010     9612        /*D* NAME:         FILLDBLK
     1011     9613             PURPOSE:      To place the msg data in the DBLK
     1012     9614             DESCRIPTION:  DBLK$ points to the DBLK, BUFSZ is the buffer size.
     1013     9615                           VFC is 0 unless VFC char is in MBLK$->KQ$MBLK.DVE.VFC,
     1014     9616                           in which case VFC is 1 and BUFSZ includes it.
     1015     9617                           ALTRETs with TYC set if no good.
     1016     9618        */
     1017     9619    1   FILLDBLK: PROC ALTRET;
     1018     9620    2         CALL HFF$TRAPALT ALTRET(BWCBUFU);
     1019     9621    2         IF VFC ~= 0 THEN
     1020     9622    3           DO;
     1021     9623    3           BUFSZ=BUFSZ-1;
     1022     9624    3           PINCRC(DBLK$,SIZEC(KQ$DBLK))->B$$CHAR=MBLK$->KQ$MBLK.DVE.VFC;
     1023     9625    3           PINCRC(DBLK$,SIZEC(KQ$DBLK)+1)->B$$BUFCHARS=WRQ$->N$REQ.BUF$->B$$BUFCHARS;
     1024     9626    3           BUFSZ=BUFSZ+1;
     1025     9627    3           END;
     1026     9628    2         ELSE
     1027     9629    2          PINCRW(DBLK$,LENGTHW(KQ$DBLK))->B$$BUFCHARS=WRQ$->N$REQ.BUF$->B$$BUFCHARS;
     1028     9630    2         CALL HFF$TRAPALT;
     1029     9631    2         MBLK$->KQ$MBLK.MSGSIZE=MBLK$->KQ$MBLK.MSGSIZE+BUFSZ;
     1030     9632    2         CALL KQD$UNLOCK (CG$->KQ$CG,DBLK$);
     1031     9633    2         RETURN;
     1032     9634    2   BWCBUFU:;
     1033     9635    2         CALL HFF$TRAPALT;
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:32   
     1034     9636    2         CALL KQD$UNLOCK (CG$->KQ$CG,DBLK$);
     1035     9637    2         CALL DESTUL;
     1036     9638    2         TYC=%TYC_MTRAP;
     1037     9639    2         ALTRETURN;
     1038     9640    2   END FILLDBLK;
     1039     9641        /****************************************************************
     1040     9642        *****************************************************************/
     1041     9643        /*D* NAME:         GETDBLK
     1042     9644             PURPOSE:      To allocate a data block for this WRITE
     1043     9645             DESCRIPTION:  If successful, returns DBLK$ pointing to the
     1044     9646                           locked-in data block, in which STAMP and
     1045     9647                           DSIZE have already been set up.  NEWDDA is the
     1046     9648                           DDA.  Else ALTRETs with TYC set appropriately.
     1047     9649
     1048     9650                           Entered with BUFSZ = size of DBLK to allocate,
     1049     9651                           and DEST indicating destination lock if any.
     1050     9652
     1051     9653                           Returns with DEST possibly updated.
     1052     9654
     1053     9655                           REGS the user 'till a DBLK is available.  Returns
     1054     9656                           %TYC_CGFULL to MONKEY if no DBLK is available.
     1055     9657        */
     1056     9658    1   GETDBLK: PROC ALTRET;
     1057     9659        /**/
     1058     9660    2   DCL REDUND UBIN;
     1059     9661        /**/
     1060     9662    2         NEWDDA=BUFSZ;
     1061     9663    2         REDUND=0;
     1062     9664    2         IF KQ_DEBUG ~= 0
     1063     9665    2         OR CG$->KQ$CG.AUCTL.REDUNDANT THEN
     1064     9666    3           DO;
     1065     9667    3           REDUND=1;
     1066     9668    3           NEWDDA=NEWDDA+SIZEC(KQ$MBLK);
     1067     9669    3           END;
     1068     9670    2         IF DEST ~= 0 THEN
     1069     9671    3           DO;
     1070     9672    3           CALL KQD$GET (CG$->KQ$CG,DBLK$,NEWDDA) ALTRET(NOGET);
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:33   
     1071     9673    3           GOTO GET0;
     1072     9674    3   NOGET:  ;
     1073     9675    3           CALL DESTUL;
     1074     9676    3           NEWDDA=BUFSZ;
     1075     9677    3           IF REDUND ~= 0 THEN NEWDDA=NEWDDA+SIZEC(KQ$MBLK);
     1076     9678    3           IF DBLK$ = ADDR(NIL) THEN GOTO NOGET0;
     1077     9679    3           IF  STA$->KQ$STA.MONDCB
     1078     9680    3           AND (S_CUN = 0 OR S_TIMR = 2) THEN
     1079     9681    4             DO;
     1080     9682    4             CALL KQD$DEFERGO (CG$->KQ$CG,DBLK$,ENTADDR(NIL));
     1081     9683    4             GOTO NOGET2;
     1082     9684    4             END;
     1083     9685    3           CALL KQD$DEFERWAIT (CG$->KQ$CG,DBLK$,NEWDDA) ALTRET(NOGET1);
     1084     9686    3           END;
     1085     9687        /**/
     1086     9688        /**/
     1087     9689    2         ELSE
     1088     9690    2   NOGET0: CALL KQD$GETR (CG$->KQ$CG,DBLK$,NEWDDA) ALTRET(NOGET1);
     1089     9691    2   GET0: ;
     1090     9692    2         IF REDUND ~= 0 THEN
     1091     9693    3           DO;
     1092     9694    3           PINCRW(DBLK$,DBLK$->KQ$DBLK.SIZW-LENGTHW(KQ$MBLK))->KQ$MBLK=MBLK$->KQ$MBLK;
     1093     9695    3           DBLK$->KQ$DBLK.MBLK='1'B;
     1094     9696    3           DBLK$->KQ$DBLK.DSIZE=BUFSZ;
     1095     9697    3           END;
     1096     9698    2         DBLK$->KQ$DBLK.STAMP=MBLK$->KQ$MBLK.STAMP;
     1097     9699    2         RETURN;
     1098     9700        /**/
     1099     9701    2   NOGET1:;
     1100     9702    2         IF NEWDDA ~= %KQDE_CREG THEN
     1101     9703    2          IF NEWDDA ~= %KQDE_NSPC THEN
     1102     9704    2           CALL SC_CGNOTIMP;
     1103     9705    2   NOGET2:;
     1104     9706    2         TYC=%TYC_CGFULL;
     1105     9707    2         ALTRETURN;
     1106     9708    2   END GETDBLK;
     1107     9709        /****************************************************************
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:34   
     1108     9710        *****************************************************************/
     1109     9711        /*D* NAME:         CHKSTAL
     1110     9712             PURPOSE:      To find a station and lock it
     1111     9713             DESCRIPTION:  MBLK$->KQ$MBLK.DSTA is the station to find.
     1112     9714                           If it exists, then if it is connected and activated
     1113     9715                           DSTA$ is returned pointing to it, else if WAS is
     1114     9716                           zero, ALTRET.  Else (it doesn't exist) if XSTALGL
     1115     9717                           or WAS are zero, ALTRET, else get a station block
     1116     9718                           and insert it in the tree, returning DSTA$ pointing
     1117     9719                           to the new node (ALTRETs if no mem).
     1118     9720
     1119     9721                           ALTRETs return TYC as the error.
     1120     9722
     1121     9723        */
     1122     9724    1   CHKSTAL: PROC ALTRET;
     1123     9725        /**/
     1124     9726    2   DCL T$ PTR;
     1125     9727    2   DCL LOCK BIT(1) ALIGNED;
     1126     9728        /**/
     1127     9729    2         LOCK='1'B;
     1128     9730    2         GOTO CMN;
     1129     9731        /**/
     1130     9732        /* NAME:        CHKSTA
     1131     9733           PURPOSE:     To find a station
     1132     9734           DESCRIPTION: Same as CHKSTAL but returns with the station's
     1133     9735                        gate unlocked.
     1134     9736        */
     1135     9737    2   CHKSTA: ENTRY ALTRET;
     1136     9738    2         LOCK='0'B;
     1137     9739    2   CMN:  ;
     1138     9740              %LOCK (G=KQ$STREE.GATE);
     1139     9743    2         CALL KQB$SRCH (KQ$STREE,MBLK$->KQ$MBLK.DSTA,T$) ALTRET(NOSTA);
     1140     9744    2         DSTA$=T$;
     1141     9745    2   CHK0: ;
     1142     9746              %LOCK (G=DSTA$->KQ$STA.GATE);
     1143     9749    2         IF DSTA$->KQ$STA.AUP THEN
     1144     9750    2          IF NOT ((WAS & '01'B) OR MBLK$->KQ$MBLK.STAR) THEN GOTO CHK1;
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:35   
     1145     9751    2         IF DSTA$->KQ$STA.LDCT$ ~= ADDR(NIL) THEN
     1146     9752    2          IF DSTA$->KQ$STA.LDCT$->NK$LDCT.LKFLG.ACTIVE THEN GOTO CHKDUN;
     1147     9753    2         IF NOT (WAS & '10'B) THEN
     1148     9754    3           DO;
     1149     9755    3   CHK1:   ;
     1150     9756                %UNLOCK (G=DSTA$->KQ$STA.GATE);
     1151     9759    3           GOTO CHKFAIL;
     1152     9760    3           END;
     1153     9761    2   CHKDUN:;
     1154     9762    2         IF NOT LOCK THEN
     1155     9763               %UNLOCK (G=DSTA$->KQ$STA.GATE);
     1156     9766              %UNLOCK (G=KQ$STREE.GATE);
     1157     9769    2         RETURN;
     1158     9770    2   NOSTA:;
     1159     9771    2         IF CG$->KQ$CG.AUCTL.XSTALGL = '0'B THEN
     1160     9772    3           DO;
     1161     9773    3   CGKEYV: ;
     1162     9774                %UNLOCK (G=KQ$STREE.GATE);
     1163     9777    3           TYC=%TYC_CGKEYV;
     1164     9778    3           ALTRETURN;
     1165     9779    3           END;
     1166     9780    2         IF NOT (WAS & '10'B) THEN
     1167     9781    3           DO;
     1168     9782    3   CHKFAIL:;
     1169     9783                %UNLOCK (G=KQ$STREE.GATE);
     1170     9786    3           TYC=%TYC_DISC;
     1171     9787    3           ALTRETURN;
     1172     9788    3           END;
     1173     9789    2         T$=STA$;
     1174     9790    2         CALL KQT$GETSTA (CG$->KQ$CG,T$,MBLK$->KQ$MBLK.DSTA) ALTRET(NOMEM);
     1175     9791    2         DSTA$=T$;
     1176     9792    2         GOTO CHK0;
     1177     9793    2   NOMEM:;
     1178     9794    2         TYC=%TYC_CGFULL;
     1179     9795    2         ALTRETURN;
     1180     9796    2   END CHKSTAL;
     1181     9797        /****************************************************************
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:36   
     1182     9798        *****************************************************************/
     1183     9799        /*D* NAME:         XFERD
     1184     9800             PURPOSE:      To transfer a write into the reader's buffer
     1185     9801             DESCRIPTION:  Enter with DSTA$ pointing to the reader's KQ$STA,
     1186     9802                           and with its gate locked.  RBLK$ points to the
     1187     9803                           reader's read, MBLK$ points to the writer's write.
     1188     9804
     1189     9805                           If the writer's buffer is bad, RETURNs with
     1190     9806                           everything unlocked and DEST=0.
     1191     9807
     1192     9808                           If the reader's buffer is
     1193     9809                           too small, RETURNs with DSTA still locked
     1194     9810                           and DEST=2.
     1195     9811
     1196     9812                           Else ALTRETs
     1197     9813                           with the data transfered, the read COMPed,
     1198     9814                           and SETWCOMP called.
     1199     9815
     1200     9816                           Used only if the data is being xferred directly
     1201     9817                           from the writer's buffer.
     1202     9818        */
     1203     9819    1   XFERD: PROC ALTRET;
     1204     9820        /**/
     1205     9821    2   DCL QLOCK UBIN;
     1206     9822    2   DCL RRQ$ PTR;
     1207     9823        /**/
     1208     9824    2         QLOCK=0;
     1209     9825    2         GOTO XFER;
     1210     9826        /*D* NAME:         XFERQ
     1211     9827             PURPOSE:      To transfer a write into the reader's buffer
     1212     9828             DESCRIPTION:  Same as XFERD but the read was found in the
     1213     9829                           queue.  P$ points to the link word which must
     1214     9830                           be set to the RBLK's link if we complete the
     1215     9831                           xfer (this removes the read from the queue).
     1216     9832                           Also, this routine is entered with the queue
     1217     9833                           locked.
     1218     9834        */
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:37   
     1219     9835    2   XFERQ: ENTRY ALTRET;
     1220     9836    2         QLOCK=1;
     1221     9837    2   XFER: ;
     1222     9838    2         RRQ$=DSTA$->KQ$STA.LDCT$->NK$LDCT.IOQ$;
     1223     9839    2         RRQ$->N$REQ.TYC='0'B;
     1224     9840    2         MBLK$->KQ$MBLK.MSGSIZE=BUFSZ;
     1225     9841    2         IF BUFSZ > RBLK$->KQ$RBLK.BUFSIZE THEN
     1226     9842    3           DO;
     1227     9843    3           DEST=2;
     1228     9844    3           GOTO UNLOCKQ;
     1229     9845    3           END;
     1230     9846              %LOCK (G=KQ_XFGATE);
     1231     9849    2         B$CGPT$->B$$XFPTW=RBLK$->KQ$RBLK.PTW;
     1232     9850    2         CALL HFC$ASSOCCLR (%CGWSQ,0,2);
     1233     9851    2         CALL HFF$TRAPALT ALTRET(BADWBUF);
     1234     9852    2         IF VFC ~= 0 THEN
     1235     9853    3           DO;
     1236     9854    3           BUFSZ=BUFSZ-1;
     1237     9855    3           RBLK$->KQ$RBLK.BUF$->B$$CHAR=MBLK$->KQ$MBLK.DVE.VFC;
     1238     9856    3           PINCRC(RBLK$->KQ$RBLK.BUF$,1)->B$$BUFCHARS=WRQ$->N$REQ.BUF$->B$$BUFCHARS;
     1239     9857    3           BUFSZ=BUFSZ+1;
     1240     9858    3           END;
     1241     9859    2         ELSE
     1242     9860    2          RBLK$->KQ$RBLK.BUF$->B$$BUFCHARS=WRQ$->N$REQ.BUF$->B$$BUFCHARS;
     1243     9861    2         B$CGPT$->B$$XFPTW='0'B;
     1244     9862    2         CALL HFC$ASSOCCLR (%CGWSQ,0,2);
     1245     9863    2         CALL HFF$TRAPALT;
     1246     9864              %UNLOCK (G=KQ_XFGATE);
     1247     9867    2         RRQ$->N$REQ.ARSIZE=BUFSZ;
     1248     9868    2         IF QLOCK ~= 0 THEN
     1249     9869    2          CALL MOVMCQ (MYMBLK$) ALTRET(BAD_VFC);
     1250     9870    2         ELSE
     1251     9871    2          CALL MOVMC (MYMBLK$) ALTRET(BAD_VFC);
     1252     9872    2         CALL SETWCOMP;
     1253     9873    2         CALL KQR$COMP (RRQ$->N$REQ);
     1254     9874    2         ALTRETURN;
     1255     9875    2   BADWBUF:;
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:38   
     1256     9876    2         CALL HFF$TRAPALT;
     1257     9877              %UNLOCK (G=KQ_XFGATE);
     1258     9880
     1259     9881    3           DO WHILE ('0'B);
     1260     9882    3   BAD_VFC:;
     1261     9883    3           DEST = 3;
     1262     9884    3           END;
     1263     9885
     1264     9886              %UNLOCK (G=DSTA$->KQ$STA.GATE);
     1265     9889    2   UNLOCKQ:;
     1266     9890    2         IF QLOCK ~= 0 THEN
     1267     9891    3           DO;
     1268     9892                %UNLOCK (G=KQ$QTREE.GATE);
     1269     9895    3           END;
     1270     9896    2         RETURN;
     1271     9897    2   END XFERD;
     1272     9898        /********************************************************
     1273     9899        *********************************************************/
     1274     9900        /**/
     1275     9901        /*D* NAME:         CHECKVFC
     1276     9902             PURPOSE:      To determine if this MBLK contains
     1277     9903                           a VFC char,  Only valid for terminals.
     1278     9904                           If so and this is a DCB or an FPRG, It
     1279     9905                           ALTRETURNs.
     1280     9906        */
     1281     9907
     1282     9908
     1283     9909    1   CHECKVFC: PROC ALTRET;
     1284     9910    2         IF (MBLK$->KQ$MBLK.DVE.VFC >  %VFC_SLPP) OR
     1285     9911    2         (MBLK$->KQ$MBLK.DVE.VFC <  %VFC_OTB)
     1286     9912    2         THEN RETURN;
     1287     9913              /*  It is a SET VFC MBLK check to see if it is a DCB */
     1288     9914
     1289     9915              /* If there is no LDCT$, the station is *GORGO and the message
     1290     9916                 should be removed.                                         */
     1291     9917    2         IF (DSTA$->KQ$STA.LDCT$ = ADDR(NIL)) THEN GOTO ALT;
     1292     9918
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:39   
     1293     9919              /* If the read is from a CGTRM or KEYIN  let it pass */
     1294     9920    2         IF (DSTA$->KQ$STA.LDCT$->NK$LDCT.USER = JG_KEYIN#) OR
     1295     9921    2         (DSTA$->KQ$STA.LDCT$->NK$LDCT.RESCOD = NK_CGTRM)
     1296     9922    2         THEN RETURN;
     1297     9923
     1298     9924              /* Funny message is bound for a DCB or an FPRG, ALTRETURN. */
     1299     9925    2   ALT:  ALTRETURN;
     1300     9926    2   END CHECKVFC;
     1301     9927        %EJECT;
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:40   
     1302     9928        /****************************************************************
     1303     9929        *****************************************************************/
     1304     9930        /*D* NAME:         MOVMCQ
     1305     9931             PURPOSE:      To move a msg
     1306     9932                           to a reading station.
     1307     9933             DESCRIPTION:  DSTA$ is the destination
     1308     9934                           (the reader).  RBLK$ is the reading RBLK,
     1309     9935                           M$ is the pointer to the MBLK.
     1310     9936
     1311     9937                           The MBLK is moved to be pointed to by the
     1312     9938                           RBLK.  M$ is set to point to the MBLK's old link.
     1313     9939                           The RBLK's state is set to KQRS_XFDN#.
     1314     9940
     1315     9941                           The reader's station is locked, and it is
     1316     9942                           unlocked after we're done.  All this is done
     1317     9943                           inhibited to prevent losing the MBLK during a
     1318     9944                           crash (i.e. if another CPU screeches, it's
     1319     9945                           interrupt won't jerk us out).
     1320     9946
     1321     9947                           The RBLK was originally found in the queue, and
     1322     9948                           P$ points the link which must be set to the
     1323     9949                           RBLK's link in order to remove it from the
     1324     9950                           queue.  The queue is unlocked after we're all
     1325     9951                           done.  The RBLK does not specify LATCH.
     1326     9952        */
     1327     9953    1   MOVMCQ: PROC (M$) ALTRET;
     1328     9954        /**/
     1329     9955    2   DCL M$ PTR;
     1330     9956    2   DCL RBSTATE UBIN;
     1331     9957        /**/
     1332     9958    2         RBSTATE=KQRS_XFDN#;
     1333     9959    2         GOTO MOVMQ;
     1334     9960        /*D* NAME:         MOVMXQ
     1335     9961             PURPOSE:      To move a message from the writing station
     1336     9962                           to a reading station.
     1337     9963             DESCRIPTION:  Just like MOVMCQ except the state is to be
     1338     9964                           set to KQRS_XFIP#, and the RBLK may specify
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:41   
     1339     9965                           LATCH, in which case QTN$ points to the Q-tree
     1340     9966                           node which must have CNACT incremented.
     1341     9967        */
     1342     9968    2   MOVMXQ: ENTRY (M$) ALTRET;
     1343     9969    3           DO INHIBIT;
     1344     9970    3           RBSTATE=KQRS_XFIP#;
     1345     9971    3   MOVMQ:  ;
     1346     9972    3           MBLK$=M$;
     1347     9973    3           CALL CHECKVFC ALTRET(ALT);
     1348     9974    3           P$->B$$PTR=RBLK$->KQ$RBLK.QRLNK$;
     1349     9975    3           RBLK$->KQ$RBLK.QRLNK$=ADDR(NIL); /* alias LWRITES$ */
     1350     9976    3           M$=MBLK$->KQ$MBLK.LNK$;
     1351     9977    3           IF RBLK$->KQ$RBLK.MBLK$~=ADDR(NIL) THEN
     1352     9978    3            RBLK$->KQ$RBLK.MBLK$->KQ$MBLK.RBLK = '0'B;
     1353     9979    3           RBLK$->KQ$RBLK.MBLK$=MBLK$;
     1354     9980    3           MBLK$->KQ$MBLK.RBLK = '1'B;
     1355     9981    3           MBLK$->KQ$MBLK.LNK$=ADDR(NIL);
     1356     9982    3           IF RBLK$->KQ$RBLK.LATCH THEN
     1357     9983    4             DO;
     1358     9984    4             RBLK$->KQ$RBLK.FROMQ='1'B;
     1359     9985    4             RBLK$->KQ$RBLK.QTN$=QTN$;
     1360     9986    4             QTN$->KQ$QTN.CNACT=QTN$->KQ$QTN.CNACT+1;
     1361     9987    4             END;
     1362     9988    3           RBLK$->KQ$RBLK.STATE=RBSTATE;
     1363     9989                %UNLOCK (G=DSTA$->KQ$STA.GATE);
     1364     9992                %UNLOCK (G=KQ$QTREE.GATE);
     1365     9995    3           CALL KQQ$DQEOFTIME(KQ$CG,RBLK$);
     1366     9996    3           RBLK$->KQ$RBLK.NCDDA=MBLK$->KQ$MBLK.DDA;
     1367     9997    3           RETURN;
     1368     9998    3   ALT:    ALTRETURN;
     1369     9999    3           END;
     1370    10000    2   END MOVMCQ;
     1371    10001        /*D* NAME:         MOVMC
     1372    10002             PURPOSE:      To move a message from the writing station
     1373    10003                           to a reading station.
     1374    10004             DESCRIPTION:  Just like MOVMCQ except the read was not found
     1375    10005                           in the queue, so we must call DEQUEUE to remove
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:42   
     1376    10006                           it if it was.  This means unlocking the reading station
     1377    10007                           first, since the queue isn't already locked, and
     1378    10008                           one CANNOT lock a station and then the queue
     1379    10009                           (because we sometimes do the opposite).
     1380    10010        */
     1381    10011    1   MOVMC: PROC (M$) ALTRET;
     1382    10012        /**/
     1383    10013    2   DCL M$ PTR;
     1384    10014    2   DCL RBSTATE UBIN;
     1385    10015        /**/
     1386    10016    2         RBSTATE=KQRS_XFDN#;
     1387    10017    2         GOTO MOVM;
     1388    10018        /*D* NAME:         MOVMX
     1389    10019             PURPOSE:      To move a message from the writing station
     1390    10020                           to a reading station.
     1391    10021             DESCRIPTION:  Just like MOVMC but state is to be set to KQRS_XFIP#.
     1392    10022        */
     1393    10023    2   MOVMX: ENTRY (M$) ALTRET;
     1394    10024        /**/
     1395    10025    3           DO INHIBIT;
     1396    10026    3           RBSTATE=KQRS_XFIP#;
     1397    10027    3   MOVM:   ;
     1398    10028    3           MBLK$=M$;
     1399    10029    3           CALL CHECKVFC ALTRET(ALT);
     1400    10030    3           M$=MBLK$->KQ$MBLK.LNK$;
     1401    10031    3           IF RBLK$->KQ$RBLK.MBLK$~=ADDR(NIL) THEN
     1402    10032    3            RBLK$->KQ$RBLK.MBLK$->KQ$MBLK.RBLK = '0'B;
     1403    10033    3           RBLK$->KQ$RBLK.MBLK$=MBLK$;
     1404    10034    3           MBLK$->KQ$MBLK.RBLK = '1'B;
     1405    10035    3           MBLK$->KQ$MBLK.LNK$=ADDR(NIL);
     1406    10036    3           RBLK$->KQ$RBLK.STATE=RBSTATE;
     1407    10037                %UNLOCK (G=DSTA$->KQ$STA.GATE);
     1408    10040    3           IF NOT DSTA$->KQ$STA.TERM THEN
     1409    10041    4             DO;
     1410    10042    4             CALL KQQ$DEQUEUE (CG$->KQ$CG,RBLK$);
     1411    10043    4             CALL KQQ$DQEOFTIME(KQ$CG,RBLK$);
     1412    10044    4             END;
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:43   
     1413    10045    3           RBLK$->KQ$RBLK.NCDDA=MBLK$->KQ$MBLK.DDA;
     1414    10046    3           RETURN;
     1415    10047    3   ALT:    ALTRETURN;
     1416    10048    3           END;
     1417    10049        /*D* NAME:         MOVMXT
     1418    10050             PURPOSE:      To move a message from writer to reader
     1419    10051             DESCRIPTION:  Just like MOVMX except the reader is a terminal
     1420    10052                           Also sets SECURE in the RBLK if req'd.
     1421    10053        */
     1422    10054    2   MOVMXT: ENTRY (M$) ALTRET;
     1423    10055    3           DO INHIBIT;
     1424    10056    3           RBSTATE=KQRS_XFIP#;
     1425    10057    3           GOTO MOVM;
     1426    10058    3           END;
     1427    10059    2   END MOVMC;
     1428    10060        /****************************************************************
     1429    10061        *****************************************************************/
     1430    10062        /*D* NAME:         SETWCOMP
     1431    10063             PURPOSE:      To set up for calling NIO$COMPCW for a write
     1432    10064             DESCRIPTION:  MBLK$ points to the writing MBLK,
     1433    10065                           and WRQ$ points to the writer's request packet.
     1434    10066
     1435    10067                           Fills in the appropriate VLP_STATION, and passes
     1436    10068                           it thru to I/O comp.
     1437    10069        */
     1438    10070    1   SETWCOMP: PROC;
     1439    10071    2         WRQ$->N$REQ.STATION.LSTA$=ADDR(VLP_STATION);
     1440    10072    2         VLP_STATION.CTL=VLP$->VLP$STATION.CTL;
     1441    10073    2         VLP_STATION.MSGID=MBLK$->KQ$MBLK.MID.PRIMARY;
     1442    10074    2         VLP_STATION.MSGIDXT=BINBIT(MBLK$->KQ$MBLK.MID.XT,36);
     1443    10075    2         IF CG$->KQ$CG.QISS THEN
     1444    10076    2          VLP_STATION.MSGTYP=MBLK$->KQ$MBLK.KEY2;
     1445    10077    2         ELSE VLP_STATION.MSGTYP=MBLK$->KQ$MBLK.KEY1;
     1446    10078    2         VLP_STATION.STATION=MBLK$->KQ$MBLK.DSTA;
     1447    10079    2         RETURN;
     1448    10080    2   END SETWCOMP;
     1449    10081        /****************************************************************
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:44   
     1450    10082        *****************************************************************/
     1451    10083        /*D* NAME:         SENDMSG
     1452    10084             PURPOSE:      To send a message whose data is in DBLKs, to its
     1453    10085                           destination.
     1454    10086
     1455    10087                           STA$ points to the station doing the sending, and
     1456    10088                           M$ points to the msg.
     1457    10089
     1458    10090                           If MTYP$ ~= ADDR(NIL) then MTYP$ points to the
     1459    10091                           T-tree node for the message's type, and TACTCNT
     1460    10092                           is the T-tree ACTCNT from when this was established.
     1461    10093
     1462    10094                           If the message is to be journaled, sends it
     1463    10095                           to the journal station.
     1464    10096
     1465    10097                           If a reader is
     1466    10098                           available to take the message, then it is given to
     1467    10099                           him via KQR$GOTMSG or KQG$GOTMSG (DCB or terminal
     1468    10100                           reader), and DSTA$ is returned pointing to the
     1469    10101                           accepting station.  Otherwise, the message is
     1470    10102                           inserted in the appropriate list and left there for
     1471    10103                           receipt later, and we return with DSTA$ pointing
     1472    10104                           to the receiving station (if directed write) or
     1473    10105                           ADDR(NIL) (if write into the queue).  For a directed
     1474    10106                           write whose destination is not there and WAS is
     1475    10107                           illegal, or the MSGTYP is not in the T-tree, the
     1476    10108                           message is deleted & we ALTRET with TYC = DISC/CGKEYV.
     1477    10109
     1478    10110                           M$ is set to the LNK$ of the MBLK it points to.
     1479    10111
     1480    10112                           In checking the destination on a directed write,
     1481    10113                           WAS is used instead of KQ$CG.AUCTL.WAS.  This is
     1482    10114                           because entry from KQW$SEND needs to disallow
     1483    10115                           write-to-absent station for terminals.
     1484    10116
     1485    10117        */
     1486    10118    1   SENDMSG: PROC (M$) ALTRET;
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:45   
     1487    10119        /**/
     1488    10120    2   DCL M$ PTR;
     1489    10121        /**/
     1490    10122    2         MBLK$=M$;
     1491    10123        /**/
     1492    10124    2         IF  MBLK$->KQ$MBLK.JOURNAL = '1'B
     1493    10125    2         AND MBLK$->KQ$MBLK.JRNLD = '0'B
     1494    10126    2         AND CG$->KQ$CG.AUCTL.JOURNAL THEN
     1495    10127    3           DO;
     1496    10128                %LOCK (G=KQ$STREE.GATE);
     1497    10131    3           IF CG$->KQ$CG.JRNLSTA$ ~= ADDR(NIL) THEN
     1498    10132    4             DO;
     1499    10133    4             DSTA$=CG$->KQ$CG.JRNLSTA$;
     1500    10134                  %LOCK (G=DSTA$->KQ$STA.GATE);
     1501    10137                  %UNLOCK (G=KQ$STREE.GATE);
     1502    10140    4             IF  STA$->KQ$STA.TERM
     1503    10141    4             AND STA$->KQ$STA.JRNLW THEN
     1504    10142    4              STA$->KQ$STA.JMSGID=MBLK$->KQ$MBLK.MID.PRIMARY;
     1505    10143    4             GOTO SENDD1;
     1506    10144    4             END;
     1507    10145                %UNLOCK (G=KQ$STREE.GATE);
     1508    10148    3           END;
     1509    10149        /**/
     1510    10150    2         IF MBLK$->KQ$MBLK.DSTA ~= ' ' THEN
     1511    10151    3           DO;
     1512    10152                                /**********************************
     1513    10153                                 *                                *
     1514    10154                                 *       DIRECTED WRITE           *
     1515    10155                                 *                                *
     1516    10156                                 **********************************/
     1517    10157    3           CALL CHKSTAL ALTRET(NOSTA);
     1518    10158    3   SENDD:  ;
     1519    10159    3           IF MBLK$->KQ$MBLK.STAR THEN
     1520    10160    3            IF MBLK$->KQ$MBLK.PRIO < %KQ_AUEP# THEN
     1521    10161    3             IF DSTA$->KQ$STA.DSID > MBLK$->KQ$MBLK.MID.PRIMARY THEN
     1522    10162    3              IF SUBSTR(DSTA$->KQ$STA.BTN.KEY,0,1) ~= '*' THEN
     1523    10163    3               GOTO NOSEND;
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:46   
     1524    10164    3   SENDD1: ;
     1525    10165    3           RBLK$=DSTA$->KQ$STA.RBLK$;
     1526    10166    3           IF RBLK$ ~= ADDR(NIL) THEN
     1527    10167    3            IF RBLK$->KQ$RBLK.STATE = KQRS_PEND# AND DSTA$->KQ$STA.MLH.BUSY='0'B THEN
     1528    10168    4              DO;
     1529    10169                           /* Give events to AU regardless of the keys
     1530    10170                              specified on his read. */
     1531    10171    4              IF MBLK$->KQ$MBLK.PRIO >= %KQ_AUEP# THEN
     1532    10172    4               IF NOT RBLK$->KQ$RBLK.HONK THEN GOTO SENDAU;
     1533    10173    4              KEY1L=RBLK$->KQ$RBLK.KEY1L;
     1534    10174    4              KEY2L=RBLK$->KQ$RBLK.KEY2L;
     1535    10175    4              IF  ADDR(RBLK$->KQ$RBLK.KEY1)->B$$KEY1 = ADDR(MBLK$->KQ$MBLK.KEY1)->
             10175                       B$$KEY1
     1536    10176    4              AND ADDR(RBLK$->KQ$RBLK.KEY2)->B$$KEY2 = ADDR(MBLK$->KQ$MBLK.KEY2)->
             10176                       B$$KEY2
     1537    10177    4              AND ((RBLK$->KQ$RBLK.MID.PRIMARY = 0) OR
     1538    10178    4              (RBLK$->KQ$RBLK.MID.PRIMARY = MBLK$->KQ$MBLK.MID.PRIMARY)) THEN
     1539    10179    5                DO;
     1540    10180    5                IF DSTA$->KQ$STA.LDCT$->NK$LDCT.RESCOD = NK_CGDCB THEN
     1541    10181    6   SENDD2:        DO INHIBIT;
     1542    10182    6   SENDAU:        CALL MOVMX (M$) ALTRET(NOSEND);
     1543    10183    6   SENDDCB:       CALL KQR$GOTMSG (DSTA$->KQ$STA.LDCT$->NK$LDCT.IOQ$->N$REQ);
     1544    10184    6                  RETURN;
     1545    10185    6                  END;
     1546    10186    5                ELSE
     1547    10187    5                 IF RBLK$->KQ$RBLK.MID.PRIMARY = 0
     1548    10188    5                 OR RBLK$->KQ$RBLK.MID.PRIMARY = MBLK$->KQ$MBLK.MID.PRIMARY THEN
     1549    10189    6   SENDD3:         DO INHIBIT;
     1550    10190    6                   DSTA$->KQ$STA.LOCKCNT=DSTA$->KQ$STA.LOCKCNT+1;
     1551    10191    7                   CALL MOVMXT (M$) WHENALTRETURN DO;
     1552    10192    7                     DSTA$->KQ$STA.LOCKCNT = DSTA$->KQ$STA.LOCKCNT-1;
     1553    10193    7                     GOTO NOSEND;
     1554    10194    7                     END;
     1555    10195    6                   CALL KQG$GOTMSG (DSTA$->KQ$STA.LDCT$->NK$LDCT);
     1556    10196    6                   RETURN;
     1557    10197    6                   END;
     1558    10198    5                END;
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:47   
     1559    10199    4              END;
     1560    10200    3           CALL KQL$INSERT (CG$->KQ$CG,DSTA$->KQ$STA.MLH,M$);
     1561    10201                %UNLOCK (G=DSTA$->KQ$STA.GATE);
     1562    10204    3           RETURN;
     1563    10205    3           END;
     1564    10206                                /**********************************
     1565    10207                                 *                                *
     1566    10208                                 *       WRITE TO QUEUE           *
     1567    10209                                 *                                *
     1568    10210                                 **********************************/
     1569    10211              %LOCK (G=KQ$QTREE.GATE);
     1570    10214    2         IF CG$->KQ$CG.QISS THEN
     1571    10215    2          IF STA$->KQ$STA.BTN.KEY = '*FWCG' THEN
     1572    10216    2           CALL KQB$SRCH (KQ$STREE,MBLK$->KQ$MBLK.KEY1,QTN$) ALTRET(NOSTA);
     1573    10217    2          ELSE
     1574    10218    2           QTN$ = STA$;    /* ASSIGN IT TO THIS STATION */
     1575    10219    2         ELSE
     1576    10220    3           DO;
     1577    10221    3           IF  MTYP$ ~= ADDR(NIL)
     1578    10222    3           AND TACTCNT = KQ$TTREE.ACTCNT THEN
     1579    10223    3            QTN$=MTYP$;
     1580    10224    3           ELSE
     1581    10225    3            CALL KQB$SRCH (KQ$TTREE,MBLK$->KQ$MBLK.KEY1,QTN$) ALTRET(NOTYP);
     1582    10226    3           END;
     1583    10227    2   SENDQ:;
     1584    10228    2         IF KQ$QUEUE.BUSY THEN
     1585    10229    3           DO INHIBIT;
     1586    10230    3           CALL KQL$QDELAYM (CG$->KQ$CG,M$);
     1587    10231    3           CG$->KQ$CG.STATS.CCMQ=CG$->KQ$CG.STATS.CCMQ+1;
     1588    10232    3           GOTO SENDQXIT;
     1589    10233    3           END;
     1590    10234    2   SENDQ1:;
     1591    10235    2         IF QTN$->KQ$QTN.CNACT < QTN$->KQ$QTN.MXACT THEN
     1592    10236    3           DO;
     1593    10237    3           P$=ADDR(QTN$->KQ$QTN.READS$);
     1594    10238    3           RBLK$=P$->B$$PTR;
     1595    10239    4             DO WHILE (RBLK$ ~= ADDR(NIL));
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:48   
     1596    10240    4             KEY2L=RBLK$->KQ$RBLK.KEY2L;
     1597    10241    4             IF ADDR(RBLK$->KQ$RBLK.KEY2)->B$$KEY2 = ADDR(MBLK$->KQ$MBLK.KEY2)->B$$KEY2
     1598    10242    4             AND ((RBLK$->KQ$RBLK.MID.PRIMARY = 0) OR
     1599    10243    5             (RBLK$->KQ$RBLK.MID.PRIMARY = MBLK$->KQ$MBLK.MID.PRIMARY)) THEN DO;
     1600    10244    5               CALL SENDIT ALTRET(SENDDCB);
     1601    10245    5               IF DEST=3 THEN GOTO NOSEND;
     1602    10246    5               END;
     1603    10247    4             P$=ADDR(RBLK$->KQ$RBLK.QRLNK$);
     1604    10248    4             RBLK$=P$->B$$PTR;
     1605    10249    4             END;
     1606    10250    3           P$=ADDR(KQ$QUEUE.WCRL$);
     1607    10251    3           RBLK$=P$->B$$PTR;
     1608    10252    4             DO WHILE (RBLK$ ~= ADDR(NIL));
     1609    10253    4             KEY1L=RBLK$->KQ$RBLK.KEY1L;
     1610    10254    4             KEY2L=RBLK$->KQ$RBLK.KEY2L;
     1611    10255    4             IF  ADDR(RBLK$->KQ$RBLK.KEY1)->B$$KEY1 = ADDR(MBLK$->KQ$MBLK.KEY1)->
             10255                      B$$KEY1
     1612    10256    4             AND ADDR(RBLK$->KQ$RBLK.KEY2)->B$$KEY2 = ADDR(MBLK$->KQ$MBLK.KEY2)->
             10256                      B$$KEY2
     1613    10257    4             AND ((RBLK$->KQ$RBLK.MID.PRIMARY = 0) OR
     1614    10258    5             (RBLK$->KQ$RBLK.MID.PRIMARY = MBLK$->KQ$MBLK.MID.PRIMARY)) THEN DO;
     1615    10259    5               CALL SENDIT ALTRET(SENDDCB);
     1616    10260    5               IF DEST=3 THEN GOTO NOSEND;
     1617    10261    5               END;
     1618    10262    4             P$=ADDR(RBLK$->KQ$RBLK.QRLNK$);
     1619    10263    4             RBLK$=P$->B$$PTR;
     1620    10264    4             END;
     1621    10265    3           END;
     1622    10266    2         CALL KQL$INSERT (CG$->KQ$CG,QTN$->KQ$QTN.MLH,M$);
     1623    10267    2   SENDQXIT:;
     1624    10268    2         DSTA$=ADDR(NIL);
     1625    10269              %UNLOCK (G=KQ$QTREE.GATE);
     1626    10272    2         RETURN;
     1627    10273    2   NOTYP:;
     1628    10274              %UNLOCK (G=KQ$QTREE.GATE);
     1629    10277    2         TYC=%TYC_CGKEYV;
     1630    10278    2         GOTO DUMPALT;
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:49   
     1631    10279    2   NOSTA: ;
     1632    10280    2         TYC=%TYC_DISC;
     1633    10281    2   DUMPALT:;
     1634    10282    2         M$=MBLK$->KQ$MBLK.LNK$;
     1635    10283    2         CALL KQU$DELMSG (CG$->KQ$CG,MBLK$->KQ$MBLK);
     1636    10284    2         ALTRETURN;
     1637    10285    2   NOSEND:;
     1638    10286    2         M$=MBLK$->KQ$MBLK.LNK$;
     1639    10287              %UNLOCK (G=DSTA$->KQ$STA.GATE);
     1640    10290    2         CALL KQU$DELMSG (CG$->KQ$CG,MBLK$->KQ$MBLK);
     1641    10291    2         RETURN;
     1642    10292    2   SENDIT: PROC ALTRET;
     1643    10293    3         DSTA$=RBLK$->KQ$RBLK.STA$;
     1644    10294    3         DEST = 0;
     1645    10295              %LOCK (G=DSTA$->KQ$STA.GATE);
     1646    10298    3         IF RBLK$->KQ$RBLK.STATE = KQRS_PEND# THEN
     1647    10299    4           DO;
     1648    10300    4           CALL MOVMXQ (M$) ALTRET(BADVFC);
     1649    10301    4           ALTRETURN;
     1650    10302    4           END;
     1651    10303              %UNLOCK (G=DSTA$->KQ$STA.GATE);
     1652    10306
     1653    10307    4           DO WHILE ('0'B);
     1654    10308    4   BADVFC: ; DEST = 3;
     1655    10309                %UNLOCK(G=KQ$QTREE.GATE);
     1656    10312    4           END;
     1657    10313
     1658    10314    3         RETURN;
     1659    10315    3   END SENDIT;
     1660    10316        /**/
     1661    10317        /*D* NAME:         SENDMSGD
     1662    10318             PURPOSE:      To send a directed message
     1663    10319             DESCRIPTION:  Like SENDMSG, but this is a directed write.
     1664    10320                           DSTA$ points to the destination station, which
     1665    10321                           is locked.
     1666    10322
     1667    10323                           The destination station gate will not be unlocked
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:50   
     1668    10324                           until the msg has been safely disposed of.
     1669    10325        */
     1670    10326    2   SENDMSGD: ENTRY (M$) ALTRET; /* !!Doesn't ALTRET!! */
     1671    10327        /**/
     1672    10328    2         MBLK$=M$;
     1673    10329    2         GOTO SENDD;
     1674    10330        /**/
     1675    10331        /*D* NAME:         SENDMSGD1
     1676    10332             PURPOSE:      To re-send a directed message
     1677    10333             DESCRIPTION:  Like SENDMSGD but the message is being re-written.
     1678    10334                           Thus it is already represented in the MLH and
     1679    10335                           must be counted out before the write takes place.
     1680    10336                           Also, the * test must be somewhat different.
     1681    10337                           Also, KQ$STA.MLH.BUSY is set so we must not check
     1682    10338                           for it.
     1683    10339
     1684    10340                           ALTRETs if gate not unlocked.
     1685    10341        */
     1686    10342    2   SENDMSGD1: ENTRY (M$) ALTRET;
     1687    10343        /**/
     1688    10344    2         MBLK$=M$;
     1689    10345    2         IF MBLK$->KQ$MBLK.STAR THEN
     1690    10346    2          IF MBLK$->KQ$MBLK.PRIO < %KQ_AUEP# THEN
     1691    10347    2           IF DSTA$->KQ$STA.DSID > MBLK$->KQ$MBLK.MID.PRIMARY THEN
     1692    10348    3             DO;
     1693    10349    3             CG$->KQ$CG.STATS.CCMS=CG$->KQ$CG.STATS.CCMS-1;
     1694    10350    3             STA$->KQ$STA.MLH.COUNT=STA$->KQ$STA.MLH.COUNT-1;
     1695    10351    3             GOTO NOSEND;
     1696    10352    3             END;
     1697    10353    2         RBLK$=DSTA$->KQ$STA.RBLK$;
     1698    10354    2         IF RBLK$ ~= ADDR(NIL) THEN
     1699    10355    2          IF RBLK$->KQ$RBLK.STATE = KQRS_PEND# THEN
     1700    10356    3            DO;
     1701    10357    3            IF MBLK$->KQ$MBLK.PRIO >= %KQ_AUEP# THEN
     1702    10358    3             IF NOT RBLK$->KQ$RBLK.HONK THEN GOTO SENDAU;
     1703    10359    3            KEY1L=RBLK$->KQ$RBLK.KEY1L;
     1704    10360    3            KEY2L=RBLK$->KQ$RBLK.KEY2L;
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:51   
     1705    10361    3            IF  ADDR(RBLK$->KQ$RBLK.KEY1)->B$$KEY1 = ADDR(MBLK$->KQ$MBLK.KEY1)->B$$KEY1
     1706    10362    3            AND ADDR(RBLK$->KQ$RBLK.KEY2)->B$$KEY2 = ADDR(MBLK$->KQ$MBLK.KEY2)->B$$KEY2
             10362                     THEN
     1707    10363    3             IF RBLK$->KQ$RBLK.MID.PRIMARY = 0
     1708    10364    3             OR RBLK$->KQ$RBLK.MID.PRIMARY = MBLK$->KQ$MBLK.MID.PRIMARY THEN
     1709    10365    4               DO;
     1710    10366    4               CG$->KQ$CG.STATS.CCMS=CG$->KQ$CG.STATS.CCMS-1;
     1711    10367    4               STA$->KQ$STA.MLH.COUNT=STA$->KQ$STA.MLH.COUNT-1;
     1712    10368    4               IF DSTA$->KQ$STA.LDCT$->NK$LDCT.RESCOD = NK_CGDCB THEN
     1713    10369    4                GOTO SENDD2;
     1714    10370    4               GOTO SENDD3;
     1715    10371    4               END;
     1716    10372    3            END;
     1717    10373    2         CALL KQL$INSERTF (CG$->KQ$CG,DSTA$->KQ$STA.MLH,M$);
     1718    10374    2         ALTRETURN;
     1719    10375        /**/
     1720    10376        /*D* NAME:         SENDMSGQ
     1721    10377             PURPOSE:      To send a message to the queue
     1722    10378             DESCRIPTION:  Like SENDMSG, but this is a write to the queue.
     1723    10379                           QTN$ points to the Q-tree node, and the queue
     1724    10380                           is locked.
     1725    10381
     1726    10382                           The queue is not unlocked until the msg has been
     1727    10383                           safely disposed of.
     1728    10384        */
     1729    10385    2   SENDMSGQ: ENTRY (M$) ALTRET; /* !!Doesn't ALTRET!! */
     1730    10386        /**/
     1731    10387    2         MBLK$=M$;
     1732    10388    2         GOTO SENDQ;
     1733    10389        /**/
     1734    10390        /*D* NAME:         SENDMSGQ1
     1735    10391             PURPOSE:      To re-send a message to the queue
     1736    10392             DESCRIPTION:  Like SENDMSGQ but the message is already in the
     1737    10393                           queue and must therefore be counted out.  Also,
     1738    10394                           QUEUE.BUSY is set so we must skip the check for
     1739    10395                           it.
     1740    10396        */
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:52   
     1741    10397    2   SENDMSGQ1: ENTRY (M$) ALTRET; /* !!Doesn't ALTRET!! */
     1742    10398        /**/
     1743    10399    2         CG$->KQ$CG.STATS.CCMQ=CG$->KQ$CG.STATS.CCMQ-1;
     1744    10400    2         MBLK$=M$;
     1745    10401    2         GOTO SENDQ1;
     1746    10402    2   END SENDMSG;
     1747    10403        /****************************************************************
     1748    10404        *****************************************************************/
     1749    10405        /*D* NAME:         WRWILD
     1750    10406             PURPOSE:      To handle wild-carded write
     1751    10407             INPUT:        MBLK$ points to the mblk all set up with
     1752    10408                                keys & such.
     1753    10409                           DSTAL is the length of the wild-carded destination
     1754    10410                                specification.
     1755    10411             DESCRIPTION:  Makes as many copies of the message as required
     1756    10412                           and sends them to the correct people.  ALTRETs
     1757    10413                           with TYC set if any errors are encountered.
     1758    10414        */
     1759    10415    1   WRWILD: PROC ALTRET;
     1760    10416        /**/
     1761    10417    2   DCL KEY BIT(72);
     1762    10418    2   DCL NXTSTA$ PTR;
     1763    10419    2   DCL M$ PTR;
     1764    10420    2   DCL FOUND SBIN;
     1765    10421        /**/
     1766    10422    2         IF MBLK$->KQ$MBLK.LATCH THEN
     1767    10423    3           DO;
     1768    10424    3           TYC=%TYC_CGLWRV;
     1769    10425    3           ALTRETURN;
     1770    10426    3           END;
     1771    10427    2         ELSE IF MBLK$->KQ$MBLK.DVE.DVBYTE&%DVBYTE_CONT# THEN
     1772    10428    3            DO;
     1773    10429    3            TYC=%TYC_CGCWRV;
     1774    10430    3            ALTRETURN;
     1775    10431    3            END;
     1776    10432    2         KEY='0'B;
     1777    10433    2         FOUND=0;
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:53   
     1778    10434    2         ADDR(KEY)->B$$DSTA=ADDR(MBLK$->KQ$MBLK.DSTA)->B$$DSTA;
     1779    10435              %LOCK (G=KQ$STREE.GATE);
     1780    10438    2         CALL KQB$SRCH (KQ$STREE,KEY,NXTSTA$);
     1781    10439    2         CALL GETNXT ALTRET(DONE);
     1782    10440    2         DSTA$=NXTSTA$;
     1783    10441        /**/
     1784    10442    2   WW0:  ;
     1785    10443    2         M$=MYMBLK$;
     1786    10444    2         CALL GETMBLK ALTRET(WW1);
     1787    10445    2         GOTO WW2;
     1788    10446    2   WW1:  ;
     1789    10447    2         MYMBLK$=M$;
     1790    10448    2         GOTO ERRX;
     1791    10449    2   WW2:  ;
     1792    10450    2         MYMBLK$=M$;
     1793    10451    2         M$=MBLK$;
     1794    10452    2         DDA=MBLK$->KQ$MBLK.STAMP;
     1795    10453    2         MBLK$->KQ$MBLK=MYMBLK$->KQ$MBLK;
     1796    10454    2         MBLK$->KQ$MBLK.STAMP=DDA;
     1797    10455              %LOCK (G=KQ$TTREE.GATE);
     1798    10458    2         MBLK$->KQ$MBLK.MID.PRIMARY=CG$->KQ$CG.MSGID;
     1799    10459    2         CG$->KQ$CG.MSGID=CG$->KQ$CG.MSGID+1;
     1800    10460              %UNLOCK (G=KQ$TTREE.GATE);
     1801    10463    2         IF BUFSZ ~= 0 THEN
     1802    10464    3           DO;
     1803    10465    3           CALL GETDBLK ALTRET(ERRX);
     1804    10466    3           MBLK$->KQ$MBLK.DDA=NEWDDA;
     1805    10467    3           CALL FILLDBLK ALTRET(ERRX);
     1806    10468    3           END;
     1807    10469    2         MBLK$->KQ$MBLK.DSTA=DSTA$->KQ$STA.BTN.KEY;
     1808    10470              %LOCK (G=KQ$STREE.GATE);
     1809    10473    2         NXTSTA$=DSTA$->KQ$STA.BTN.FLINK$;
     1810    10474    2         CALL GETNXT;
     1811    10475              %LOCK (G=DSTA$->KQ$STA.GATE);
     1812    10478    2         CALL SENDMSGD (M$);
     1813    10479    2         CALL KQP$UNLOCK (DSTA$->KQ$STA);
     1814    10480    2         DSTA$=NXTSTA$;
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:54   
     1815    10481    2         IF DSTA$ ~= ADDR(NIL) THEN GOTO WW0;
     1816    10482    2   DONE: ;
     1817    10483    2         CALL KQM$RELMBLK (CG$->KQ$CG,MYMBLK$);
     1818    10484    2         RETURN;
     1819    10485    2   ERRX: ;
     1820    10486    2         CALL KQP$UNLOCK (DSTA$->KQ$STA);
     1821    10487    2         ALTRETURN;
     1822    10488        /**/
     1823    10489        /**/
     1824    10490                           /* Find the next station & lock it */
     1825    10491    2   GETNXT: PROC ALTRET;
     1826    10492    4           DO WHILE (NXTSTA$ ~= ADDR(NIL));
     1827    10493    4           IF  ADDR(KEY)->B$$DSTA = ADDR(NXTSTA$->KQ$STA.BTN.KEY)->B$$DSTA
     1828    10494    4           AND NOT NXTSTA$->KQ$STA.AUP
     1829    10495    4           AND SUBSTR (NXTSTA$->KQ$STA.BTN.KEY,0,1) ~= '*' THEN
     1830    10496    5             DO;
     1831    10497                  %LOCK (G=NXTSTA$->KQ$STA.GATE);
     1832    10500    5             IF NOT WAS THEN
     1833    10501    6               DO;
     1834    10502    6               IF NXTSTA$->KQ$STA.LDCT$ = ADDR(NIL) THEN GOTO G4;
     1835    10503    6               IF NXTSTA$->KQ$STA.LDCT$->NK$LDCT.LKFLG.ACTIVE = '0'B THEN
     1836    10504    6                GOTO G4;
     1837    10505    6               END;
     1838    10506        /**/
     1839    10507    5             IF NXTSTA$->KQ$STA.LDCT$ ~= ADDR(NIL) THEN
     1840    10508    6               DO;  /* PRESENT */
     1841    10509    6               IF NXTSTA$->KQ$STA.TERM THEN
     1842    10510    7                 DO;
     1843    10511    7                 IF NOT VLP$->VLP$STATION.CTL.ALLTRMS THEN
     1844    10512    7                  IF  NOT VLP$->VLP$STATION.CTL.ALLDCBS
     1845    10513    7                  AND NOT VLP$->VLP$STATION.CTL.ALLABSENT THEN
     1846    10514    8                    DO;
     1847    10515    8                    IF FOUND ~= 0 THEN
     1848    10516    9   UDONE:             DO;
     1849    10517                           %UNLOCK (G=NXTSTA$->KQ$STA.GATE);
     1850    10520    9                      NXTSTA$=ADDR(NIL);
     1851    10521    9                      GOTO G5;
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:55   
     1852    10522    9                      END;
     1853    10523    8                    END;
     1854    10524    7                  ELSE GOTO G4;
     1855    10525    7                 END;
     1856    10526    6               ELSE /* DCB */
     1857    10527    7                 DO;
     1858    10528    7                 IF NOT VLP$->VLP$STATION.CTL.ALLDCBS THEN
     1859    10529    7                  IF  NOT VLP$->VLP$STATION.CTL.ALLTRMS
     1860    10530    7                  AND NOT VLP$->VLP$STATION.CTL.ALLABSENT THEN
     1861    10531    8                    DO;
     1862    10532    8                    IF FOUND ~= 0 THEN GOTO UDONE;
     1863    10533    8                    END;
     1864    10534    7                  ELSE GOTO G4;
     1865    10535    7                 END;
     1866    10536    6               END; /* PRESENT */
     1867    10537    5             ELSE   /* ABSENT  */
     1868    10538    6               DO;
     1869    10539    6               IF NOT VLP$->VLP$STATION.CTL.ALLABSENT THEN
     1870    10540    6                IF  NOT VLP$->VLP$STATION.CTL.ALLTRMS
     1871    10541    6                AND NOT VLP$->VLP$STATION.CTL.ALLDCBS THEN
     1872    10542    7                  DO;
     1873    10543    7                  IF FOUND ~= 0 THEN GOTO UDONE;
     1874    10544    7                  END;
     1875    10545    6                ELSE GOTO G4;
     1876    10546    6               END; /* ABSENT */
     1877    10547        /**/
     1878    10548    5             FOUND=FOUND+1;
     1879    10549    5             NXTSTA$->KQ$STA.LOCKCNT=NXTSTA$->KQ$STA.LOCKCNT+1;
     1880    10550                  %UNLOCK (G=NXTSTA$->KQ$STA.GATE);
     1881    10553                  %UNLOCK (G=KQ$STREE.GATE);
     1882    10556    5             RETURN;
     1883    10557    5   G4:       ;
     1884    10558                  %UNLOCK (G=NXTSTA$->KQ$STA.GATE);
     1885    10561    5             END;
     1886    10562    4           NXTSTA$=NXTSTA$->KQ$STA.BTN.FLINK$;
     1887    10563    4           END;
     1888    10564    3   G5:   ;
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:56   
     1889    10565              %UNLOCK (G=KQ$STREE.GATE);
     1890    10568    3         ALTRETURN;
     1891    10569    3   END GETNXT;
     1892    10570    2   END WRWILD;
     1893    10571    1   END KQW$WRITE;

PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:57   
--  Include file information  --

   SS_SCHED_C.:E05TOU  is referenced.
   EL$TABLES.:E05TOU  is referenced.
   KC$CP6V_C.:E05TOU  is referenced.
   JG_GHOSTS_C.:E05TOU  is referenced.
   NK_VFC_C.:E05TOU  is referenced.
   N_FC_C.:E05TOU  is referenced.
   B_STRINGS_C.:E05TOU  is referenced.
   CP_6_SUBS.:E05TOU  is referenced.
   KC_CP6.:E05TOU  is referenced.
   NK_LDCT_R.:E05TOU  cannot be made into a system file and is referenced.
   NK_SUBS.:E05TOU  is referenced.
   N$REQ.:E05TOU  is referenced.
   NK$LDCT.:E05TOU  is referenced.
   KQ_DATA_R.:E05TOU  cannot be made into a system file and is referenced.
   HF_LOCK_C.:E05TOU  cannot be made into a system file and is referenced.
   KQ_MAC_C.:E05TOU  is referenced.
   KQ_SUBS_C.:E05TOU  is referenced.
      No diagnostics issued in procedure KQW$WRITE.

   Procedure KQW$WRITE requires 2920 words for executable code.
   Procedure KQW$WRITE requires 64 words of local(AUTO) storage.

    No errors detected in file KQW$WRITE.:E05TSI    .

PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:58   

 Object Unit name= KQW$WRITE                                  File name= KQW$WRITE.:E05TOU
 UTS= JUL 30 '97 01:38:45.28 WED                              Compiler= PL-6/E31         Sev=      00
 SharedLib= :SHARED_SYSTEM                                    Alt SharedLib=


    ****  Control sections  ****

 Sect   Type Bound  Init  Size OctSiz  Section name(segment info)
    0  RoData even  UTS     12     14  KQW$WRITE
    1   Proc  even  none  2920   5550  KQW$WRITE
    2  RoData even  none    16     20  KQW$WRITE

    ****  Entry defs  ****

                              Check   Calling
                             calling  sequence
  Sect OctLoc Primary Altret sequence   type   Parms  Name
     1      0   yes    yes     yes      Std        1  KQW$WRITE
     1   2067          yes     yes      Std        1  KQW$SEND
     1   2117          yes     yes      Std        1  KQW$SENDNA
     1   2130          yes     yes      Std        1  KQW$SENDAUP
     1   2146          yes     yes      Std        1  KQW$XMITSELF
     1   2222          yes     yes      Std        1  KQW$XMITQ
     1   2331          yes     yes      Std        1  KQW$XMITQR
     1   2336          yes     yes      Std        1  KQW$HOLD
     1   2430          yes     yes      Std        1  KQW$JNLD
     1   2455          yes     yes      Std        1  KQW$TELLAU
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:59   

  ****  Entry refs  ****

         Check        Calling
        calling       sequence
Altret sequence SRef   type   Args  Name
         yes           Std       1 KQX$LDASR
 yes     yes           Std       8 KQZ$LOG
 yes     yes           Std       3 KQD$DEFERWAIT
         yes           Std       1 HFC$UNLOCK
 yes     yes           Std       3 KQD$FETCHR
         yes           Std       1 HFC$LOCK
 yes     yes           Std       3 KQB$SRCH
 yes     yes           Std       3 KQT$GETTYP
 yes     yes           Std       1 KQD$ERRLOG
 yes     yes           Std       1 KQG$GOTMWB
 yes     yes           Std       2 KQD$UPDATED
 yes     yes           Std       2 KQU$DELMSG
         yes           Std       1 NIO$COMPCNS
 yes     yes           Std       3 KQD$FETCH
 yes     yes           Std       2 KQL$DELAYDQ
         yes           Std       1 NIO$COMPCW
 yes     yes           Std       3 KQM$GETMBLK
 yes     yes           Std       3 SSR$REG
 yes     yes           Std       3 KQM$GETBK
 yes     yes           Std       3 KQM$RELB
 yes     yes           Std       3 KQM$GETBR
 yes     yes           Std       0 HFF$TRAPALT
 yes     yes           Std       2 KQD$UNLOCK
 yes     yes           Std       3 KQD$GET
 yes     yes           Std       3 KQD$GETR
 yes     yes           Std       3 KQD$DEFERGO
 yes     yes           Std       3 KQT$GETSTA
         yes           Std       3 HFC$ASSOCCLR
 yes     yes           Std       1 KQR$COMP
 yes     yes           Std       2 KQQ$DQEOFTIME
 yes     yes           Std       2 KQQ$DEQUEUE
 yes     yes           Std       1 KQR$GOTMSG
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:60   
 yes     yes           Std       1 KQG$GOTMSG
 yes     yes           Std       2 KQL$QDELAYM
 yes     yes           Std       3 KQL$INSERTF
 yes     yes           Std       3 KQL$INSERT
 yes     yes           Std       1 KQP$UNLOCK
 yes     yes           Std       2 KQM$RELMBLK
                       Std       0 B_CONSPOOL_D
                       nStd      0 X66_AUTO_1
                       nStd      0 X66_ARET
                       nStd      0 X66_AALT

  ****  Data refs  ****

  Flags:  r = read only, s = secondary
Flgs Name                             Flgs Name                             Flgs Name
     SC_CGNOTIMP                           KQ_DEBUG                              KQ_XFGATE
     KQ_LOG                                KQ_ERRLOG_GATE                        KQ_IMTYP
     N$DCT$$                               S_TIMR                                S_CUN
     B$CGPT$                               KQ_ERRLOG_BFR                         B_VECTNIL

  ****  Segment refs  ****

  Flags:  r = read only, s = secondary
Flgs Name                             Flgs Name                             Flgs Name
     ASLENTSID                             ISSID
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:61   


        1        1        /*M* KQW$WRITE IOQ write to COMGROUP */
        2        2        /*T***********************************************************/
        3        3        /*T*                                                         */
        4        4        /*T* Copyright (c) Bull HN Information Systems Inc., 1997    */
        5        5        /*T*                                                         */
        6        6        /*T***********************************************************/
        7        7       /*X* DMC,PLM=6,IND=0,IDT=2,SDI=2,CTI=0,ENU=0,AND,DCI=4,CSU=2,ECU=4,THI=0,DTI=0,STI=1
                 7        ,IAD=0,PRB */
        8        8        /**/
        9        9        /*P* NAME:         KQW$WRITE
       10       10             PURPOSE:      To provide COMGROUP WRITE functions for entities
       11       11                           which come through IOQ (i.e. DCBs, and monitor
       12       12                           stations such as MONKEY).
       13       13             DESCRIPTION:  Contains all routines to implement write of COMGROUP
       14       14                           via NIO$QUE.  Is the complement of KQR$READ, which
       15       15                           handles read thru IOQ.
       16       16
       17       17                           Also contains entry points for other entities
       18       18                           which need the same logic.  For example, writes
       19       19                           into the queue from terminals finish at KQW$SEND,
       20       20                           (after starting in KQP$PUT).
       21       21        */
       22       22        /*F* NAME:         KQW$WRITE
       23       23             PURPOSE:      To receive write NIO$QUE requests for DCTs
       24       24                           whose RESCOD is CGDCB.
       25       25             DESCRIPTION:  NIO$QUE calls here for write functions issued
       26       26                           for a DCT with RESCOD CGDCB (this includes true
       27       27                           user DCBs, as well as monitor stations such as
       28       28                           MONKEY).
       29       29
       30       30                           If the user has a continued write in progress,
       31       31                           then skip directly to place this chunk in the
       32       32                           comgroup.
       33       33
       34       34                           Otherwise (start of a new message), an MBLK is
       35       35                           obtained and initialized with the parameters of
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:62   
       36       36                           the message, the parameters being validated as
       37       37                           we do so.  When this has been done, a MSGID is
       38       38                           obtained for the message (either a new one if
       39       39                           the write is not latched, or, if it is, an ID
       40       40                           is generated from the ID of the current latched
       41       41                           read), and a time stamp is inserted into the
       42       42                           MBLK.  Then, if any of the following are true:
       43       43                            - this write says CONTINUE
       44       44                            - this write is latched
       45       45                            - the message type begins '*'
       46       46                            - the message is to be journaled
       47       47
       48       48                           we go dump the data into the comgroup.
       49       49
       50       50                           If none are true, we can write the data directly
       51       51                           into the reader's buffer if there is a reader and
       52       52                           he isn't reading latched.  We try to find such
       53       53                           a guy, and send the data directly to him, and if
       54       54                           this fails, go put the data into the comgroup.
       55       55
       56       56                           Putting the data into the comgroup means finding
       57       57                           a DBLK and dumping the buffer into it.  If this
       58       58                           is the next chunk of a previous write, then the
       59       59                           DBLK used previously must be flinked at this one.
       60       60                           Then, if this write specified CONT, we're done.
       61       61                           Else, if it specified latch it is inserted into
       62       62                           the LWRITES$ list in the latched RBLK (at the
       63       63                           end), else (not latched) it is dispatched to its
       64       64                           destination.  This latter means finding a reader
       65       65                           for it, or, if none, inserting it into the MLH
       66       66                           in the appropriate station (directed write) or
       67       67                           Q-tree (write to queue) node.  Either way the
       68       68                           write is I/O COMPed before we exit.
       69       69        */
       70       70        /**/
       71       71        KQW$WRITE: PROC (N$WREQ) ALTRET;

PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:63   
     71  1 000000   000000 700200 xent  KQW$WRITE    TSX0  ! X66_AUTO_1
         1 000001   000100 000001                    ZERO    64,1

       72       72        /**/
       73       73
       74       74
       75       75
       76       76        /**/
       77       77        /* INCLUDES */
       78       78        /**/
       79       79        %INCLUDE KQ_SUBS_C;
       80      379        %INCLUDE KQ_MAC_C;
       81     2929        %INCLUDE HF_LOCK_C;
       82     2943        %INCLUDE KQ_DATA_R;
       83     3775        %INCLUDE NK$LDCT;
       84     3877        %INCLUDE N$REQ;
       85     3951        %INCLUDE NK_SUBS;
       86     3976        %INCLUDE NK_LDCT_R;
       87     3985        %INCLUDE KC_CP6;
       88     4545        %INCLUDE CP_6_SUBS;
       89     5085        %INCLUDE B_STRINGS_C;
       90     5214        %INCLUDE N_FC_C;
       91     5251        %INCLUDE NK_VFC_C;
       92     5325        %INCLUDE JG_GHOSTS_C;
       93     5415        %INCLUDE KC$CP6V_C;
       94     5535        %INCLUDE EL$TABLES;
       95     5858        %INCLUDE SS_SCHED_C;
       96     6091
       97     6092
       98     6093
       99     6094        /**/
      100     6095        /* PARAMETERS */
      101     6096        /**/
      102     6097        %N$REQ (NAME=N$WREQ,STCLASS="");
      103     6155
      104     6156
      105     6157
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:64   
      106     6158        /**/
      107     6159        /* BASED STRUCTURES */
      108     6160        /**/
      109     6161    1   DCL B$$PTR PTR BASED ALIGNED;
      110     6162        %NK$LDCT;
      111     6208        %N$REQ;
      112     6266        %KQ_CG   (FPTN=KQ$CG  ,STCLASS="BASED(CG$)");
      113     7005        %KQ_STA  (FPTN=KQ$STA ,STCLASS="BASED(STA$)");
      114     7344        %KQ_RBLK (FPTN=KQ$RBLK,STCLASS="BASED(RBLK$)");
      115     7530        %KQ_MBLK (FPTN=KQ$MBLK,STCLASS="BASED(MBLK$)");
      116     7800        %KQ_THDR (FPTN=KQ$THDR,STCLASS=BASED);
      117     7838        %KQ_DBLK (FPTN=KQ$DBLK,STCLASS="BASED(DBLK$)");
      118     7891        %KQ_MTYP (FPTN=KQ$MTYP,STCLASS="BASED(MTYP$)");
      119     7965        %KQ_QTN  (FPTN=KQ$QTN ,STCLASS="BASED(QTN$)");
      120     8438        %KQ_RBLK (FPTN=KQ$RBLKT,STCLASS="BASED(RBLK$)",TERM=1);
      121     8624        %KQ$DPTR;
      122     8651        %VLP$STATION_V (FPTN=VLP$STATION);
      123     8663    1   DCL B$$UBIN UBIN WORD BASED ALIGNED;
      124     8664    1   DCL B$$HALF UBIN HALF BASED HALIGNED;
      125     8665    1   DCL B$$KEY1 CHAR(KEY1L) BASED ALIGNED;
      126     8666    1   DCL B$$KEY2 CHAR(KEY2L) BASED ALIGNED;
      127     8667    1   DCL B$$DSTA CHAR(DSTAL) BASED ALIGNED;
      128     8668    1   DCL B$$CHAR CHAR(1) BASED CALIGNED;
      129     8669    1   DCL B$$CHAR8 CHAR(8) BASED CALIGNED;
      130     8670    1   DCL B$$BUFCHARS CHAR(BUFSZ) BASED CALIGNED;
      131     8671    1   DCL 1 B$$MIDEXT BASED ALIGNED,
      132     8672    1         2 EXTS (0:5) UBIN(6) UNAL;
      133     8673    1   DCL 1 B$$PRIO BASED HALIGNED,
      134     8674    1         2 HI UBIN BYTE UNAL,
      135     8675    1         2 LO UBIN BYTE UNAL;
      136     8676    1   DCL 1 B$$XFPTW BASED DALIGNED,
      137     8677    1         2 * (0:1) UBIN;
      138     8678
      139     8679
      140     8680
      141     8681        /**/
      142     8682        /* AUTO */
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:65   
      143     8683        /**/
      144     8684    1   DCL LDCT$ PTR;
      145     8685    1   DCL STA$ PTR;
      146     8686    1   DCL RBLK$ PTR;
      147     8687    1   DCL MBLK$ PTR;
      148     8688    1   DCL CG$ PTR;
      149     8689    1   DCL VLP$ PTR;
      150     8690    1   DCL KEY1L UBIN;
      151     8691    1   DCL KEY2L UBIN;
      152     8692    1   DCL P$ PTR;
      153     8693    1   DCL WAS BIT(36);
      154     8694        %VLP$STATION_V (FPTN=VLP_STATION,BASED=AUTO);
      155     8706    1   DCL DBLK$ PTR;
      156     8707    1   DCL DBLK$R REDEF DBLK$ UBIN;
      157     8708    1   DCL BUFSZ UBIN;
      158     8709    1   DCL DDA UBIN;
      159     8710    1   DCL OSTAPRIO REDEF DDA UBIN;
      160     8711    1   DCL OSTA CHAR(8);
      161     8712    1   DCL QTN$ PTR;
      162     8713    1   DCL TYC BIT(36);
      163     8714    1   DCL MTYP$ PTR;
      164     8715    1   DCL DSTA$ PTR;
      165     8716    1   DCL WRQ$ PTR;
      166     8717    1   DCL MYMBLK$ PTR;
      167     8718    1   DCL NEWDDA UBIN;
      168     8719    1   DCL RCVR REDEF NEWDDA UBIN;
      169     8720    1   DCL DSTAL UBIN;
      170     8721    1   DCL TACTCNT UBIN HALF;
      171     8722    1   DCL DEST SBIN WORD;
      172     8723    1   DCL VFC UBIN;
      173     8724    1   DCL I UBIN;
      174     8725
      175     8726
      176     8727
      177     8728        /**/
      178     8729        /* REFS */
      179     8730        /**/
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:66   
      180     8731    1   DCL HFC$ASSOCCLR  ENTRY(3);
      181     8732    1   DCL HFF$TRAPALT   ENTRY    ALTRET;
      182     8733    1   DCL KQB$SRCH      ENTRY(3) ALTRET;
      183     8734    1   DCL KQD$DEFERGO   ENTRY(3) ALTRET;
      184     8735    1   DCL KQD$DEFERWAIT ENTRY(3) ALTRET;
      185     8736    1   DCL KQD$DELETE    ENTRY(2) ALTRET;
      186     8737    1   DCL KQD$ERRLOG    ENTRY(1) ALTRET;
      187     8738    1   DCL KQD$FETCH     ENTRY(3) ALTRET;
      188     8739    1   DCL KQD$FETCHR    ENTRY(3) ALTRET;
      189     8740    1   DCL KQD$GET       ENTRY(3) ALTRET;
      190     8741    1   DCL KQD$GETR      ENTRY(3) ALTRET;
      191     8742    1   DCL KQD$UNLOCK    ENTRY(2) ALTRET;
      192     8743    1   DCL KQD$UPDATED   ENTRY(2) ALTRET;
      193     8744    1   DCL KQG$GOTMSG    ENTRY(1) ALTRET;
      194     8745    1   DCL KQG$GOTMWB    ENTRY(1) ALTRET;
      195     8746    1   DCL KQL$DELAYDQ   ENTRY(2) ALTRET;
      196     8747    1   DCL KQL$INSERT    ENTRY(3) ALTRET;
      197     8748    1   DCL KQL$INSERTF   ENTRY(3) ALTRET;
      198     8749    1   DCL KQL$QDELAYM   ENTRY(2) ALTRET;
      199     8750    1   DCL KQM$GETBK     ENTRY(3) ALTRET;
      200     8751    1   DCL KQM$GETBR     ENTRY(3) ALTRET;
      201     8752    1   DCL KQM$GETMBLK   ENTRY(3) ALTRET;
      202     8753    1   DCL KQM$RELB      ENTRY(3) ALTRET;
      203     8754    1   DCL KQM$RELMBLK   ENTRY(2) ALTRET;
      204     8755    1   DCL KQP$UNLOCK    ENTRY(1) ALTRET;
      205     8756    1   DCL KQQ$DEQUEUE   ENTRY(2) ALTRET;
      206     8757    1   DCL KQQ$DQEOFTIME ENTRY(2) ALTRET;
      207     8758    1   DCL KQR$COMP      ENTRY(1) ALTRET;
      208     8759    1   DCL KQR$GOTMSG    ENTRY(1) ALTRET;
      209     8760    1   DCL KQT$GETSTA    ENTRY(3) ALTRET;
      210     8761    1   DCL KQT$GETTYP    ENTRY(3) ALTRET;
      211     8762    1   DCL KQU$DELETE    ENTRY(1) ALTRET;
      212     8763    1   DCL KQU$DELMSG    ENTRY(2) ALTRET;
      213     8764    1   DCL KQX$LDASR     ENTRY(1);
      214     8765    1   DCL KQZ$LOG       ENTRY(8) ALTRET;
      215     8766    1   DCL NIO$COMPCW    ENTRY(1);
      216     8767    1   DCL NIO$COMPCNS   ENTRY(1);
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:67   
      217     8768    1   DCL SC_CGNOTIMP   ENTRY    CONV(2,0);
      218     8769    1   DCL SSR$REG       ENTRY(3) ALTRET;
      219     8770
      220     8771    1   DCL S_TIMR UBIN WORD SYMREF;
      221     8772    1   DCL S_CUN  UBIN WORD SYMREF;
      222     8773    1   DCL B$CGPT$ PTR SYMREF;
      223     8774        %EL$CGERR (NAME=KQ_ERRLOG_BFR,STCLASS=SYMREF,N=50);
      224     8778
      225     8779
      226     8780
      227     8781        /**/
      228     8782        /* SUBS */
      229     8783        /**/
      230     8784        %SUB KQ$QTREE="CG$->KQ$CG.QUEUE.QTREE$->KQ$THDR";
      231     8785        %SUB KQ$TTREE="CG$->KQ$CG.TTREE";
      232     8786        %SUB KQ$STREE="CG$->KQ$CG.STREE";
      233     8787        %SUB KQ$QUEUE="CG$->KQ$CG.QUEUE";
      234     8788        %EJECT;
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:68   
      235     8789
      236     8790        /**
      237     8791         **
      238     8792         **
      239     8793         **           IF THE PREVIOUS WRITE WAS CONTINUED, GO DIRECTLY
      240     8794         **           TO STASH THIS CHUNK IN THE COMGROUP.  OTHERWISE,
      241     8795         **           GET AN MBLK, STUFF THE PARAMS INTO IT WHILE VALIDATING
      242     8796         **           THEM, AND THEN TRY TO WRITE THE DATA DIRECTLY TO A
      243     8797         **           READER.
      244     8798         **
      245     8799         **
      246     8800         **/
      247     8801
      248     8802    1         WRQ$=ADDR(N$WREQ);

   8802  1 000002   200003 236100                    LDQ     @N$WREQ,,AUTO
         1 000003   200037 756100                    STQ     WRQ$,,AUTO

      249     8803    1         LDCT$=NK$LDCT$(WRQ$->N$REQ.DLA.DCTX);

   8803  1 000004   200037 470500                    LDP0    WRQ$,,AUTO
         1 000005   000001 236100                    LDQ     1,,PR0
         1 000006   000025 772000                    QRL     21
         1 000007   000000 471400 xsym               LDP1    N$DCT$$
         1 000010   100000 236106                    LDQ     0,QL,PR1
         1 000011   200004 756100                    STQ     LDCT$,,AUTO

      250     8804    1         IF NOT LDCT$->NK$LDCT.LKFLG.ACTIVE THEN

   8804  1 000012   200004 473500                    LDP3    LDCT$,,AUTO
         1 000013   300011 236100                    LDQ     9,,PR3
         1 000014   000040 316003                    CANQ    32,DU
         1 000015   000021 601000 1                  TNZ     s:8809

      251     8805    2           DO;

      252     8806    2           WRQ$->N$REQ.TYC=%TYC_DACT;
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:69   

   8806  1 000016   000000 236000 0                  LDQ     0
         1 000017   000021 756100                    STQ     17,,PR0

      253     8807    2           GOTO BADCOMP;

   8807  1 000020   002034 710000 1                  TRA     BADCOMP

      254     8808    2           END;
      255     8809    1         STA$=LDCT$->NK$LDCT.STA$;

   8809  1 000021   300012 236100                    LDQ     10,,PR3
         1 000022   200005 756100                    STQ     STA$,,AUTO

      256     8810    1         CG$=LDCT$->NK$LDCT.CG$;

   8810  1 000023   300027 236100                    LDQ     23,,PR3
         1 000024   200010 756100                    STQ     CG$,,AUTO

      257     8811    1         CALL KQX$LDASR (CG$->KQ$CG);

   8811  1 000025   200010 630500                    EPPR0   CG$,,AUTO
         1 000026   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 000027   000000 701000 xent               TSX1    KQX$LDASR
         1 000030   000000 011000                    NOP     0

      258     8812    1         CG$->KQ$CG.STATS.WRITES=CG$->KQ$CG.STATS.WRITES+1;

   8812  1 000031   200010 470500                    LDP0    CG$,,AUTO
         1 000032   000166 054100                    AOS     118,,PR0

      259     8813    1         DEST=0;

   8813  1 000033   200044 450100                    STZ     DEST,,AUTO

      260     8814    1         VLP$=WRQ$->N$REQ.STATION.LSTA$;

PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:70   
   8814  1 000034   200037 471500                    LDP1    WRQ$,,AUTO
         1 000035   100013 236100                    LDQ     11,,PR1
         1 000036   200011 756100                    STQ     VLP$,,AUTO

      261     8815    1         WAS=CG$->KQ$CG.AUCTL.WAS&VLP$->VLP$STATION.CTL.WAS;

   8815  1 000037   200011 473500                    LDP3    VLP$,,AUTO
         1 000040   300004 236100                    LDQ     4,,PR3
         1 000041   000010 736000                    QLS     8
         1 000042   400000 376003                    ANQ     -131072,DU
         1 000043   200070 756100                    STQ     RBSTATE+4,,AUTO
         1 000044   000133 236100                    LDQ     91,,PR0
         1 000045   000040 736000                    QLS     32
         1 000046   400000 376003                    ANQ     -131072,DU
         1 000047   200070 376100                    ANQ     RBSTATE+4,,AUTO
         1 000050   200015 756100                    STQ     WAS,,AUTO

      262     8816    1         IF STA$->KQ$STA.MBLK$ ~= ADDR(NIL) THEN

   8816  1 000051   200005 474500                    LDP4    STA$,,AUTO
         1 000052   400012 236100                    LDQ     10,,PR4
         1 000053   000001 116000 xsym               CMPQ    B_VECTNIL+1
         1 000054   000155 600000 1                  TZE     s:8850

      263     8817    2           DO;

      264     8818    2           P$=ADDR(NIL);

   8818  1 000055   000001 236000 xsym               LDQ     B_VECTNIL+1
         1 000056   200014 756100                    STQ     P$,,AUTO

      265     8819    2           MBLK$=STA$->KQ$STA.MBLK$;

   8819  1 000057   400012 236100                    LDQ     10,,PR4
         1 000060   200007 756100                    STQ     MBLK$,,AUTO

      266     8820    3             DO WHILE (MBLK$ ~= ADDR(NIL));
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:71   

   8820  1 000061   000153 710000 1                  TRA     s:8842

      267     8821    3             IF MBLK$->KQ$MBLK.DCB$ = WRQ$->N$REQ.DCB$ THEN

   8821  1 000062   200007 470500                    LDP0    MBLK$,,AUTO
         1 000063   200037 471500                    LDP1    WRQ$,,AUTO
         1 000064   000013 236100                    LDQ     11,,PR0
         1 000065   100022 116100                    CMPQ    18,,PR1
         1 000066   000147 601000 1                  TNZ     s:8840

      268     8822    4               DO;  /* Adding to prev continued msg */

      269     8823    4               MTYP$=ADDR(NIL);

   8823  1 000067   000001 236000 xsym               LDQ     B_VECTNIL+1
         1 000070   200035 756100                    STQ     MTYP$,,AUTO

      270     8824    4               MYMBLK$=MBLK$;

   8824  1 000071   200007 236100                    LDQ     MBLK$,,AUTO
         1 000072   200040 756100                    STQ     MYMBLK$,,AUTO

      271     8825    4               IF P$ = ADDR(NIL) THEN STA$->KQ$STA.MBLK$=MBLK$->KQ$MBLK.LNK$;

   8825  1 000073   200014 236100                    LDQ     P$,,AUTO
         1 000074   000001 116000 xsym               CMPQ    B_VECTNIL+1
         1 000075   000102 601000 1                  TNZ     s:8826

   8825  1 000076   000000 236100                    LDQ     0,,PR0
         1 000077   200005 473500                    LDP3    STA$,,AUTO
         1 000100   300012 756100                    STQ     10,,PR3
         1 000101   000105 710000 1                  TRA     s:8827

      272     8826    4               ELSE P$->KQ$MBLK.LNK$=MBLK$->KQ$MBLK.LNK$;

   8826  1 000102   000000 236100                    LDQ     0,,PR0
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:72   
         1 000103   200014 473500                    LDP3    P$,,AUTO
         1 000104   300000 756100                    STQ     0,,PR3

      273     8827    4               IF WRQ$->N$REQ.DVE.DVBYTE.CONT = '0'B THEN

   8827  1 000105   100031 430100                    FSZN    25,,PR1
         1 000106   000120 604000 1                  TMI     s:8830

      274     8828    4                IF NOT MBLK$->KQ$MBLK.FORCECONT THEN

   8828  1 000107   000010 236100                    LDQ     8,,PR0
         1 000110   000200 316007                    CANQ    128,DL
         1 000111   000120 601000 1                  TNZ     s:8830

      275     8829    4                 MBLK$->KQ$MBLK.DVE.DVBYTE=MBLK$->KQ$MBLK.DVE.DVBYTE&(~%DVBYTE_CONT#);

   8829  1 000112   000010 236100                    LDQ     8,,PR0
         1 000113   000011 736000                    QLS     9
         1 000114   777000 376003                    ANQ     -512,DU
         1 000115   776000 376003                    ANQ     -1024,DU
         1 000116   000011 772000                    QRL     9
         1 000117   000010 552120                    STBQ    8,'20'O,PR0

      276     8830    4               IF CG$->KQ$CG.QISS THEN

   8830  1 000120   200010 473500                    LDP3    CG$,,AUTO
         1 000121   300106 235100                    LDA     70,,PR3
         1 000122   000131 600000 1                  TZE     s:8834

      277     8831    5                 DO;

      278     8832    5                 IF VLP$->VLP$STATION.MSGTYP ~= MBLK$->KQ$MBLK.KEY2 THEN GOTO BWCCWRV;

   8832  1 000123   200011 474500                    LDP4    VLP$,,AUTO
         1 000124   040100 106500                    CMPC    fill='040'O
         1 000125   400002 000010                    ADSC9   2,,PR4                   cn=0,n=8
         1 000126   000004 000010                    ADSC9   4,,PR0                   cn=0,n=8
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:73   
         1 000127   001712 601000 1                  TNZ     BWCCWRV

      279     8833    5                 END;

   8833  1 000130   000136 710000 1                  TRA     s:8835

      280     8834    4               ELSE IF VLP$->VLP$STATION.MSGTYP ~= MBLK$->KQ$MBLK.KEY1 THEN GOTO
              8834                        BWCCWRV;

   8834  1 000131   200011 474500                    LDP4    VLP$,,AUTO
         1 000132   040100 106500                    CMPC    fill='040'O
         1 000133   400002 000010                    ADSC9   2,,PR4                   cn=0,n=8
         1 000134   000002 000010                    ADSC9   2,,PR0                   cn=0,n=8
         1 000135   001712 601000 1                  TNZ     BWCCWRV

      281     8835    4               BUFSZ=WRQ$->N$REQ.BUFSIZE;

   8835  1 000136   100004 236100                    LDQ     4,,PR1
         1 000137   000020 772000                    QRL     16
         1 000140   200027 756100                    STQ     BUFSZ,,AUTO

      282     8836    4               VFC=0;

   8836  1 000141   200045 450100                    STZ     VFC,,AUTO

      283     8837    4               IF BUFSZ > KQ_MCMAX# THEN BUFSZ=KQ_MCMAX#;

   8837  1 000142   007401 116007                    CMPQ    3841,DL
         1 000143   000146 602000 1                  TNC     s:8838

   8837  1 000144   007400 235007                    LDA     3840,DL
         1 000145   200027 755100                    STA     BUFSZ,,AUTO

      284     8838    4               GOTO WRITECG;

   8838  1 000146   001372 710000 1                  TRA     WRITECG

PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:74   
      285     8839    4               END;
      286     8840    3             P$=MBLK$;

   8840  1 000147   200007 236100                    LDQ     MBLK$,,AUTO
         1 000150   200014 756100                    STQ     P$,,AUTO

      287     8841    3             MBLK$=MBLK$->KQ$MBLK.LNK$;

   8841  1 000151   000000 236100                    LDQ     0,,PR0
         1 000152   200007 756100                    STQ     MBLK$,,AUTO

      288     8842    3             END;

   8842  1 000153   000001 116000 xsym               CMPQ    B_VECTNIL+1
         1 000154   000062 601000 1                  TNZ     s:8821

      289     8843    2           END;

      290     8844        /**/
      291     8845            /*********************************************
      292     8846             *                                           *
      293     8847             *         Brand new write here              *
      294     8848             *                                           *
      295     8849             *********************************************/
      296     8850    1         CALL GETMBLK ALTRET(BWCTYC);

   8850  1 000155   002521 701000 1                  TSX1    GETMBLK
         1 000156   002030 702000 1                  TSX2    BWCTYC

      297     8851    1         MBLK$->KQ$MBLK.LATCH=VLP$->VLP$STATION.CTL.LATCH;

   8851  1 000157   200007 470500                    LDP0    MBLK$,,AUTO
         1 000160   200011 471500                    LDP1    VLP$,,AUTO
         1 000161   100004 236100                    LDQ     4,,PR1
         1 000162   000010 676100                    ERQ     8,,PR0
         1 000163   200000 376003                    ANQ     65536,DU
         1 000164   000010 656100                    ERSQ    8,,PR0
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:75   

      298     8852    1         MBLK$->KQ$MBLK.DVE=WRQ$->N$REQ.DVE;

   8852  1 000165   200037 473500                    LDP3    WRQ$,,AUTO
         1 000166   300031 236100                    LDQ     25,,PR3
         1 000167   000011 772000                    QRL     9
         1 000170   000010 552130                    STBQ    8,'30'O,PR0

      299     8853    1         VFC=BITBIN(WRQ$->N$REQ.DVE.DVBYTE.VFC);

   8853  1 000171   300031 236100                    LDQ     25,,PR3
         1 000172   000041 772000                    QRL     33
         1 000173   000001 376007                    ANQ     1,DL
         1 000174   200045 756100                    STQ     VFC,,AUTO

      300     8854    1         BUFSZ=VFC+WRQ$->N$REQ.BUFSIZE;

   8854  1 000175   300004 236100                    LDQ     4,,PR3
         1 000176   000020 772000                    QRL     16
         1 000177   200045 036100                    ADLQ    VFC,,AUTO
         1 000200   200027 756100                    STQ     BUFSZ,,AUTO

      301     8855    1         IF BUFSZ > KQ_MCMAX# THEN

   8855  1 000201   007401 116007                    CMPQ    3841,DL
         1 000202   000211 602000 1                  TNC     s:8860

      302     8856    2           DO;

      303     8857    2           BUFSZ=KQ_MCMAX#;

   8857  1 000203   007400 235007                    LDA     3840,DL
         1 000204   200027 755100                    STA     BUFSZ,,AUTO

      304     8858    2           WRQ$->N$REQ.BUFSIZE=KQ_MCMAX#; /* For KQG$GOTMWB */

   8858  1 000205   300004 236100                    LDQ     4,,PR3
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:76   
         1 000206   177777 376007                    ANQ     65535,DL
         1 000207   001700 276003                    ORQ     960,DU
         1 000210   300004 756100                    STQ     4,,PR3

      305     8859    2           END;

      306     8860    1         IF VLP$->VLP$STATION.CTL.ANYDCB THEN

   8860  1 000211   100004 236100                    LDQ     4,,PR1
         1 000212   002000 316003                    CANQ    1024,DU
         1 000213   000223 600000 1                  TZE     s:8867

      307     8861    2           DO;

      308     8862    2           DSTAL=8;

   8862  1 000214   000010 235007                    LDA     8,DL
         1 000215   200042 755100                    STA     DSTAL,,AUTO

      309     8863    2           MBLK$->KQ$MBLK.DSTA=' ';

   8863  1 000216   000035 235000 xsym               LDA     B_VECTNIL+29
         1 000217   000035 236000 xsym               LDQ     B_VECTNIL+29
         1 000220   000011 755100                    STA     9,,PR0
         1 000221   000012 756100                    STQ     10,,PR0

      310     8864    2           END;

   8864  1 000222   000232 710000 1                  TRA     s:8871

      311     8865    1         ELSE
      312     8866    2           DO;

      313     8867    2           MBLK$->KQ$MBLK.DSTA=VLP$->VLP$STATION.STATION;

   8867  1 000223   040100 100500                    MLR     fill='040'O
         1 000224   100000 000010                    ADSC9   0,,PR1                   cn=0,n=8
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:77   
         1 000225   000011 000010                    ADSC9   9,,PR0                   cn=0,n=8

      314     8868    2           CALL INDEX (DSTAL,'?',MBLK$->KQ$MBLK.DSTA);

   8868  1 000226   000000 124500                    SCM     mask='000'O
         1 000227   000011 000010                    ADSC9   9,,PR0                   cn=0,n=8
         1 000230   000000 000001 2                  ADSC9   0                        cn=0,n=1
         1 000231   200042 000100                    ARG     DSTAL,,AUTO

      315     8869    2           END;

      316     8870              %LOCK (G=KQ$TTREE.GATE);

   8871  1 000232   200010 236100                    LDQ     CG$,,AUTO
         1 000233   000067 036003                    ADLQ    55,DU
         1 000234   200070 756100                    STQ     RBSTATE+4,,AUTO
         1 000235   200070 630500                    EPPR0   RBSTATE+4,,AUTO
         1 000236   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 000237   000000 701000 xent               TSX1    HFC$LOCK
         1 000240   000000 011000                    NOP     0

      317     8873    1         IF MBLK$->KQ$MBLK.LATCH THEN

   8873  1 000241   200007 470500                    LDP0    MBLK$,,AUTO
         1 000242   000010 236100                    LDQ     8,,PR0
         1 000243   200000 316003                    CANQ    65536,DU
         1 000244   000327 600000 1                  TZE     s:8900

      318     8874    2           DO;

      319     8875                                /* WRITE WITH LATCH */
      320     8876    2           RBLK$=STA$->KQ$STA.RBLK$;

   8876  1 000245   200005 471500                    LDP1    STA$,,AUTO
         1 000246   100011 236100                    LDQ     9,,PR1
         1 000247   200006 756100                    STQ     RBLK$,,AUTO

PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:78   
      321     8877    2           IF RBLK$ = ADDR(NIL) THEN GOTO BWCLWRV;

   8877  1 000250   000001 116000 xsym               CMPQ    B_VECTNIL+1
         1 000251   001716 600000 1                  TZE     BWCLWRV

      322     8878    2           IF RBLK$->KQ$RBLK.STATE ~= KQRS_COMP#

   8878  1 000252   200006 473500                    LDP3    RBLK$,,AUTO
         1 000253   300001 220100                    LDX0    1,,PR3
         1 000254   000001 100003                    CMPX0   1,DU
         1 000255   001716 601000 1                  TNZ     BWCLWRV
         1 000256   300001 236100                    LDQ     1,,PR3
         1 000257   040000 316007                    CANQ    16384,DL
         1 000260   001716 600000 1                  TZE     BWCLWRV
         1 000261   400000 316007                    CANQ    -131072,DL
         1 000262   001716 600000 1                  TZE     BWCLWRV
         1 000263   200042 235100                    LDA     DSTAL,,AUTO
         1 000264   000010 115007                    CMPA    8,DL
         1 000265   001716 601000 1                  TNZ     BWCLWRV

      323     8879    2           OR RBLK$->KQ$RBLK.CS = '0'B
      324     8880    2           OR RBLK$->KQ$RBLK.LATCH = '0'B
      325     8881    2           OR DSTAL ~= 8 THEN GOTO BWCLWRV;
      326     8882    2           IF CG$->KQ$CG.AUCTL.BIGMXT THEN

   8882  1 000266   200010 474500                    LDP4    CG$,,AUTO
         1 000267   400136 236100                    LDQ     94,,PR4
         1 000270   010000 316003                    CANQ    4096,DU
         1 000271   000306 600000 1                  TZE     s:8891

      327     8883    3             DO;

      328     8884    3             MBLK$->KQ$MBLK.MID.PRIMARY=RBLK$->KQ$RBLK.MBLK$->KQ$MBLK.MID.PRIMARY;

   8884  1 000272   300000 475500                    LDP5    0,,PR3
         1 000273   500014 235100                    LDA     12,,PR5
         1 000274   000014 755100                    STA     12,,PR0
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:79   

      329     8885    3             MBLK$->KQ$MBLK.MID.XT=CG$->KQ$CG.MSGIDXT;

   8885  1 000275   400116 235100                    LDA     78,,PR4
         1 000276   000015 755100                    STA     13,,PR0

      330     8886    3             CG$->KQ$CG.MSGIDXT=CG$->KQ$CG.MSGIDXT+1;

   8886  1 000277   400116 235100                    LDA     78,,PR4
         1 000300   000001 035007                    ADLA    1,DL
         1 000301   400116 755100                    STA     78,,PR4

      331     8887    3             RBLK$->KQ$RBLK.MIDEXTV=RBLK$->KQ$RBLK.MIDEXTV+1;

   8887  1 000302   300017 236100                    LDQ     15,,PR3
         1 000303   000001 036003                    ADLQ    1,DU
         1 000304   300017 552120                    STBQ    15,'20'O,PR3

      332     8888    3             END;

   8888  1 000305   000335 710000 1                  TRA     s:8903

      333     8889    2           ELSE
      334     8890    3             DO;

      335     8891    3             IF RBLK$->KQ$RBLK.MIDEXTV >= 62 THEN GOTO BWCLWRV;

   8891  1 000306   300017 236100                    LDQ     15,,PR3
         1 000307   000777 376003                    ANQ     511,DU
         1 000310   000076 116003                    CMPQ    62,DU
         1 000311   001716 603000 1                  TRC     BWCLWRV

      336     8892    3             RBLK$->KQ$RBLK.MIDEXTV=RBLK$->KQ$RBLK.MIDEXTV+1;

   8892  1 000312   300017 236100                    LDQ     15,,PR3
         1 000313   000001 036003                    ADLQ    1,DU
         1 000314   300017 552120                    STBQ    15,'20'O,PR3
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:80   

      337     8893    3             MBLK$->KQ$MBLK.MID=RBLK$->KQ$RBLK.MBLK$->KQ$MBLK.MID;

   8893  1 000315   300000 475500                    LDP5    0,,PR3
         1 000316   500014 237100                    LDAQ    12,,PR5
         1 000317   000014 757100                    STAQ    12,,PR0

      338     8894    3             ADDR(MBLK$->KQ$MBLK.MID.XT)->B$$MIDEXT.EXTS(RBLK$->KQ$RBLK.MIDEXTX)=

   8894  1 000320   300017 236100                    LDQ     15,,PR3
         1 000321   000033 772000                    QRL     27
         1 000322   000006 402007                    MPY     6,DL
         1 000323   003106 061500                    CSR     bolr='003'O
         1 000324   300017 200011                    BDSC    15,,PR3                  by=1,bit=0,n=9
         1 000325   000015 000006                    BDSC    13,Q,PR0                 by=0,bit=0,n=6

      339     8895    3             RBLK$->KQ$RBLK.MIDEXTV;
      340     8896    3             END;

      341     8897    2           END;

   8897  1 000326   000335 710000 1                  TRA     s:8903

      342     8898    1         ELSE
      343     8899    2           DO;

      344     8900    2           MBLK$->KQ$MBLK.MID.PRIMARY=CG$->KQ$CG.MSGID;

   8900  1 000327   200010 471500                    LDP1    CG$,,AUTO
         1 000330   100113 235100                    LDA     75,,PR1
         1 000331   000014 755100                    STA     12,,PR0

      345     8901    2           CG$->KQ$CG.MSGID=CG$->KQ$CG.MSGID+1;

   8901  1 000332   100113 235100                    LDA     75,,PR1
         1 000333   000001 035007                    ADLA    1,DL
         1 000334   100113 755100                    STA     75,,PR1
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:81   

      346     8902    2           END;

      347     8903    1         IF KQ_LOG.DSIO THEN

   8903  1 000335   000000 236000 xsym               LDQ     KQ_LOG
         1 000336   002000 316003                    CANQ    1024,DU
         1 000337   000362 600000 1                  TZE     s:8909

      348     8904    1          CALL KQZ$LOG (CG$->KQ$CG,%KQLOG_WRITE,0,
      349     8905    1          MBLK$->KQ$MBLK.MID.PRIMARY,
      350     8906    1          ADDR(MBLK$->KQ$MBLK.MID.PRIMARY)->B$$HALF,
      351     8907    1          SUBSTR(STA$->KQ$STA.BTN.KEY,0,4),
      352     8908    1          SUBSTR(STA$->KQ$STA.BTN.KEY,4,4));

   8908  1 000340   200005 236100                    LDQ     STA$,,AUTO
         1 000341   000006 036003                    ADLQ    6,DU
         1 000342   200076 756100                    STQ     RBSTATE+10,,AUTO
         1 000343   200005 236100                    LDQ     STA$,,AUTO
         1 000344   000005 036003                    ADLQ    5,DU
         1 000345   200075 756100                    STQ     RBSTATE+9,,AUTO
         1 000346   200007 236100                    LDQ     MBLK$,,AUTO
         1 000347   000014 036003                    ADLQ    12,DU
         1 000350   200074 756100                    STQ     RBSTATE+8,,AUTO
         1 000351   000002 235000 2                  LDA     2
         1 000352   200072 757100                    STAQ    RBSTATE+6,,AUTO
         1 000353   000003 236000 2                  LDQ     3
         1 000354   200010 235100                    LDA     CG$,,AUTO
         1 000355   200070 757100                    STAQ    RBSTATE+4,,AUTO
         1 000356   200070 630500                    EPPR0   RBSTATE+4,,AUTO
         1 000357   000025 631400 xsym               EPPR1   B_VECTNIL+21
         1 000360   000000 701000 xent               TSX1    KQZ$LOG
         1 000361   000000 011000                    NOP     0

      353     8909    1         IF VLP$->VLP$STATION.MSGTYP = ' ' THEN MBLK$->KQ$MBLK.KEY1=CG$->KQ$CG.AUCTL.
              8909                  DMTYP;

PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:82   
   8909  1 000362   200011 470500                    LDP0    VLP$,,AUTO
         1 000363   040000 106500                    CMPC    fill='040'O
         1 000364   000002 000010                    ADSC9   2,,PR0                   cn=0,n=8
         1 000365   000035 000001 xsym               ADSC9   B_VECTNIL+29             cn=0,n=1
         1 000366   000375 601000 1                  TNZ     s:8911

   8909  1 000367   200010 471500                    LDP1    CG$,,AUTO
         1 000370   200007 473500                    LDP3    MBLK$,,AUTO
         1 000371   040100 100500                    MLR     fill='040'O
         1 000372   100127 000010                    ADSC9   87,,PR1                  cn=0,n=8
         1 000373   300002 000010                    ADSC9   2,,PR3                   cn=0,n=8
         1 000374   000401 710000 1                  TRA     s:8912

      354     8910    1         ELSE
      355     8911    1          MBLK$->KQ$MBLK.KEY1=VLP$->VLP$STATION.MSGTYP;

   8911  1 000375   200007 471500                    LDP1    MBLK$,,AUTO
         1 000376   040100 100500                    MLR     fill='040'O
         1 000377   000002 000010                    ADSC9   2,,PR0                   cn=0,n=8
         1 000400   100002 000010                    ADSC9   2,,PR1                   cn=0,n=8

      356     8912    1         CALL KQB$SRCH (KQ$TTREE,MBLK$->KQ$MBLK.KEY1,MTYP$) ALTRET(WR0);

   8912  1 000401   200035 631500                    EPPR1   MTYP$,,AUTO
         1 000402   200072 451500                    STP1    RBSTATE+6,,AUTO
         1 000403   200007 236100                    LDQ     MBLK$,,AUTO
         1 000404   000002 036003                    ADLQ    2,DU
         1 000405   200071 756100                    STQ     RBSTATE+5,,AUTO
         1 000406   200010 236100                    LDQ     CG$,,AUTO
         1 000407   000067 036003                    ADLQ    55,DU
         1 000410   200070 756100                    STQ     RBSTATE+4,,AUTO
         1 000411   200070 630500                    EPPR0   RBSTATE+4,,AUTO
         1 000412   000021 631400 xsym               EPPR1   B_VECTNIL+17
         1 000413   000000 701000 xent               TSX1    KQB$SRCH
         1 000414   000416 702000 1                  TSX2    WR0

      357     8913    1         GOTO WR4;
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:83   

   8913  1 000415   000511 710000 1                  TRA     WR4

   8912  1 000416                       WR0          null
      358     8914    1   WR0:  ;
      359     8915    1         IF SUBSTR (MBLK$->KQ$MBLK.KEY1,0,1) = '*' THEN

   8915  1 000416   200007 470500                    LDP0    MBLK$,,AUTO
         1 000417   000002 236100                    LDQ     2,,PR0
         1 000420   777000 376003                    ANQ     -512,DU
         1 000421   052000 116003                    CMPQ    21504,DU
         1 000422   000470 601000 1                  TNZ     s:8934

      360     8916    2           DO;

      361     8917    2           IF MBLK$->KQ$MBLK.DSTA = ' '

   8917  1 000423   040000 106500                    CMPC    fill='040'O
         1 000424   000011 000010                    ADSC9   9,,PR0                   cn=0,n=8
         1 000425   000035 000001 xsym               ADSC9   B_VECTNIL+29             cn=0,n=1
         1 000426   000463 601000 1                  TNZ     s:8930

      362     8918    3           THEN DO;   /* Direct it to the AU if one exists                    */

      363     8919                  %LOCK (G=KQ$STREE.GATE);

   8920  1 000427   200010 236100                    LDQ     CG$,,AUTO
         1 000430   000075 036003                    ADLQ    61,DU
         1 000431   200070 756100                    STQ     RBSTATE+4,,AUTO
         1 000432   200070 630500                    EPPR0   RBSTATE+4,,AUTO
         1 000433   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 000434   000000 701000 xent               TSX1    HFC$LOCK
         1 000435   000000 011000                    NOP     0

      364     8922    3             IF CG$->KQ$CG.AUSTA$~=ADDR(NIL)

   8922  1 000436   200010 470500                    LDP0    CG$,,AUTO
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:84   
         1 000437   000121 236100                    LDQ     81,,PR0
         1 000440   000001 116000 xsym               CMPQ    B_VECTNIL+1
         1 000441   000447 600000 1                  TZE     s:8925

      365     8923    3             THEN MBLK$->KQ$MBLK.DSTA=CG$->KQ$CG.AUSTA$->KQ$STA.BTN.KEY;

   8923  1 000442   000121 471500                    LDP1    81,,PR0
         1 000443   200007 473500                    LDP3    MBLK$,,AUTO
         1 000444   040100 100500                    MLR     fill='040'O
         1 000445   100005 000010                    ADSC9   5,,PR1                   cn=0,n=8
         1 000446   300011 000010                    ADSC9   9,,PR3                   cn=0,n=8

      366     8924                  %UNLOCK (G=KQ$STREE.GATE);

   8925  1 000447   200010 236100                    LDQ     CG$,,AUTO
         1 000450   000075 036003                    ADLQ    61,DU
         1 000451   200070 756100                    STQ     RBSTATE+4,,AUTO
         1 000452   200070 630500                    EPPR0   RBSTATE+4,,AUTO
         1 000453   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 000454   000000 701000 xent               TSX1    HFC$UNLOCK
         1 000455   000000 011000                    NOP     0

      367     8927    3             IF MBLK$->KQ$MBLK.DSTA=' ' THEN GOTO BWCKEYT;

   8927  1 000456   200007 470500                    LDP0    MBLK$,,AUTO
         1 000457   040000 106500                    CMPC    fill='040'O
         1 000460   000011 000010                    ADSC9   9,,PR0                   cn=0,n=8
         1 000461   000035 000001 xsym               ADSC9   B_VECTNIL+29             cn=0,n=1
         1 000462   002015 600000 1                  TZE     BWCKEYT

      368     8928    3             END;

      369     8929                                               /* STAR messages may be DIRECTED only */
      370     8930    2           MBLK$->KQ$MBLK.STAR='1'B;

   8930  1 000463   100000 236003                    LDQ     32768,DU
         1 000464   000010 256100                    ORSQ    8,,PR0
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:85   

      371     8931    2           MTYP$=ADDR(KQ_IMTYP);

   8931  1 000465   000004 236000 2                  LDQ     4
         1 000466   200035 756100                    STQ     MTYP$,,AUTO

      372     8932    2           GOTO WR1;

   8932  1 000467   000513 710000 1                  TRA     WR1

      373     8933    2           END;
      374     8934    1         IF CG$->KQ$CG.AUCTL.XTYPLGL = '0'B THEN

   8934  1 000470   200010 471500                    LDP1    CG$,,AUTO
         1 000471   100133 236100                    LDQ     91,,PR1
         1 000472   000001 316007                    CANQ    1,DL
         1 000473   002015 600000 1                  TZE     BWCKEYT

      375     8935    1          GOTO BWCKEYT;
      376     8936    1         MTYP$=STA$;

   8936  1 000474   200005 236100                    LDQ     STA$,,AUTO
         1 000475   200035 756100                    STQ     MTYP$,,AUTO

      377     8937    1         CALL KQT$GETTYP (CG$->KQ$CG,MTYP$,MBLK$->KQ$MBLK.KEY1) ALTRET(BWCFULL);

   8937  1 000476   200007 236100                    LDQ     MBLK$,,AUTO
         1 000477   000002 036003                    ADLQ    2,DU
         1 000500   200072 756100                    STQ     RBSTATE+6,,AUTO
         1 000501   200035 633500                    EPPR3   MTYP$,,AUTO
         1 000502   200071 453500                    STP3    RBSTATE+5,,AUTO
         1 000503   200010 236100                    LDQ     CG$,,AUTO
         1 000504   200070 756100                    STQ     RBSTATE+4,,AUTO
         1 000505   200070 630500                    EPPR0   RBSTATE+4,,AUTO
         1 000506   000021 631400 xsym               EPPR1   B_VECTNIL+17
         1 000507   000000 701000 xent               TSX1    KQT$GETTYP
         1 000510   001731 702000 1                  TSX2    BWCFULL
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:86   

   8936  1 000511                       WR4          null
      378     8938    1   WR4:  ;   /*  VALID MESSAGE TYPE */
      379     8939    1         MTYP$->KQ$MTYP.NUMWRITES = MTYP$->KQ$MTYP.NUMWRITES + 1;

   8939  1 000511   200035 470500                    LDP0    MTYP$,,AUTO
         1 000512   000010 054100                    AOS     8,,PR0

   8939  1 000513                       WR1          null
      380     8940    1   WR1:  ;
      381     8941    1         IF (MBLK$->KQ$MBLK.LATCH) THEN

   8941  1 000513   200007 470500                    LDP0    MBLK$,,AUTO
         1 000514   000010 236100                    LDQ     8,,PR0
         1 000515   200000 316003                    CANQ    65536,DU
         1 000516   000561 600000 1                  TZE     WR5

      382     8942    2           DO;

      383     8943                  /* Find the TTREE node of the MSGTYP
      384     8944                     of the READ we are latching to. */
      385     8945    2           QTN$ = RBLK$->KQ$RBLK.QTN$;  /* short cut for default CG and TPA */

   8945  1 000517   200006 471500                    LDP1    RBLK$,,AUTO
         1 000520   100021 236100                    LDQ     17,,PR1
         1 000521   200033 756100                    STQ     QTN$,,AUTO

      386     8946
      387     8947    2           IF QTN$ = ADDR(NIL) OR (CG$->KQ$CG.QISS)

   8947  1 000522   000001 116000 xsym               CMPQ    B_VECTNIL+1
         1 000523   000527 600000 1                  TZE     s:8950
         1 000524   200010 473500                    LDP3    CG$,,AUTO
         1 000525   300106 235100                    LDA     70,,PR3
         1 000526   000547 600000 1                  TZE     s:8956

      388     8948    2           THEN /* The READ we are LATCHing to came from the
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:87   
      389     8949                            STA's MLH. We must find the TTREE NODE. */
      390     8950    2            CALL KQB$SRCH(KQ$TTREE,

   8950  1 000527   200010 473500                    LDP3    CG$,,AUTO
         1 000530   300106 720100                    LXL0    70,,PR3
         1 000531   100000 474500                    LDP4    0,,PR1
         1 000532   200033 635500                    EPPR5   QTN$,,AUTO
         1 000533   200072 455500                    STP5    RBSTATE+6,,AUTO
         1 000534   000000 635010                    EAA     0,X0
         1 000535   000021 771000                    ARL     17
         1 000536   400002 636505                    EPPR6   2,AL,PR4
         1 000537   200071 456500                    STP6    RBSTATE+5,,AUTO
         1 000540   200010 236100                    LDQ     CG$,,AUTO
         1 000541   000067 036003                    ADLQ    55,DU
         1 000542   200070 756100                    STQ     RBSTATE+4,,AUTO
         1 000543   200070 630500                    EPPR0   RBSTATE+4,,AUTO
         1 000544   000021 631400 xsym               EPPR1   B_VECTNIL+17
         1 000545   000000 701000 xent               TSX1    KQB$SRCH
         1 000546   000561 702000 1                  TSX2    WR5

      391     8951    2            PINCRW(RBLK$->KQ$RBLK.MBLK$,
      392     8952    2            2+2*BITBIN(CG$->KQ$CG.QISS))->B$$CHAR8,
      393     8953    2            QTN$) ALTRET (WR5); /* This will ALTRET if * msg */
      394     8954
      395     8955                  /* Check to see if we still have room to do latch writes */
      396     8956    2           IF (RBLK$->KQ$RBLK.MIDEXTV > QTN$->KQ$MTYP.MAXLATCH)

   8956  1 000547   200006 470500                    LDP0    RBLK$,,AUTO
         1 000550   000017 236100                    LDQ     15,,PR0
         1 000551   000022 772000                    QRL     18
         1 000552   000777 376007                    ANQ     511,DL
         1 000553   200070 756100                    STQ     RBSTATE+4,,AUTO
         1 000554   200033 471500                    LDP1    QTN$,,AUTO
         1 000555   100007 236100                    LDQ     7,,PR1
         1 000556   777777 376007                    ANQ     -1,DL
         1 000557   200070 116100                    CMPQ    RBSTATE+4,,AUTO
         1 000560   001716 604000 1                  TMI     BWCLWRV
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:88   

      397     8957    2           THEN GOTO BWCLWRV;   /* Can't latch anymore WRITES to a
      398     8958                                             READ of this type            */
      399     8959    2           END; /* IF LATCH DO */

   8952  1 000561                       WR5          null
      400     8960    1   WR5:  ;
      401     8961    1         TACTCNT=KQ$TTREE.ACTCNT;

   8961  1 000561   200010 470500                    LDP0    CG$,,AUTO
         1 000562   000074 220100                    LDX0    60,,PR0
         1 000563   200043 740100                    STX0    TACTCNT,,AUTO

      402     8962    1         IF CG$->KQ$CG.AUCTL.CARRYOSTA

   8962  1 000564   000136 236100                    LDQ     94,,PR0
         1 000565   000040 316003                    CANQ    32,DU
         1 000566   000626 600000 1                  TZE     s:8975
         1 000567   200007 471500                    LDP1    MBLK$,,AUTO
         1 000570   100010 236100                    LDQ     8,,PR1
         1 000571   200000 316003                    CANQ    65536,DU
         1 000572   000626 600000 1                  TZE     s:8975
         1 000573   040000 106500                    CMPC    fill='040'O
         1 000574   100011 000010                    ADSC9   9,,PR1                   cn=0,n=8
         1 000575   000035 000001 xsym               ADSC9   B_VECTNIL+29             cn=0,n=1
         1 000576   000626 601000 1                  TNZ     s:8975

      403     8963    1         AND MBLK$->KQ$MBLK.LATCH
      404     8964    1         AND MBLK$->KQ$MBLK.DSTA=' '
      405     8965    1         THEN IF CG$->KQ$CG.QISS

   8965  1 000577   000106 235100                    LDA     70,,PR0
         1 000600   000613 600000 1                  TZE     s:8971

      406     8966    2          THEN DO;

      407     8967    2            OSTA = RBLK$->KQ$RBLK.MBLK$->KQ$MBLK.KEY1;
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:89   

   8967  1 000601   200006 473500                    LDP3    RBLK$,,AUTO
         1 000602   300000 474500                    LDP4    0,,PR3
         1 000603   400002 237100                    LDAQ    2,,PR4
         1 000604   200031 755100                    STA     OSTA,,AUTO
         1 000605   200032 756100                    STQ     OSTA+1,,AUTO

      408     8968    2            OSTAPRIO = ADDR(RBLK$->KQ$RBLK.MBLK$->KQ$MBLK.PRIO)->B$$PRIO.HI;

   8968  1 000606   300000 474500                    LDP4    0,,PR3
         1 000607   400001 236100                    LDQ     1,,PR4
         1 000610   000033 772000                    QRL     27
         1 000611   200030 756100                    STQ     DDA,,AUTO

      409     8969    2            END;

   8969  1 000612   000636 710000 1                  TRA     s:8978

      410     8970    2          ELSE DO;

      411     8971    2            OSTA = RBLK$->KQ$RBLK.MBLK$->KQ$MBLK.KEY2;

   8971  1 000613   200006 473500                    LDP3    RBLK$,,AUTO
         1 000614   300000 474500                    LDP4    0,,PR3
         1 000615   400004 237100                    LDAQ    4,,PR4
         1 000616   200031 755100                    STA     OSTA,,AUTO
         1 000617   200032 756100                    STQ     OSTA+1,,AUTO

      412     8972    2            OSTAPRIO = ADDR(RBLK$->KQ$RBLK.MBLK$->KQ$MBLK.PRIO)->B$$PRIO.LO;

   8972  1 000620   300000 474500                    LDP4    0,,PR3
         1 000621   400001 236100                    LDQ     1,,PR4
         1 000622   000022 772000                    QRL     18
         1 000623   000777 376007                    ANQ     511,DL
         1 000624   200030 756100                    STQ     DDA,,AUTO

      413     8973    2            END;
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:90   

   8973  1 000625   000636 710000 1                  TRA     s:8978

      414     8974    2         ELSE DO;

      415     8975    2           OSTA = STA$->KQ$STA.BTN.KEY;

   8975  1 000626   200005 471500                    LDP1    STA$,,AUTO
         1 000627   040100 100500                    MLR     fill='040'O
         1 000630   100005 000010                    ADSC9   5,,PR1                   cn=0,n=8
         1 000631   200031 000010                    ADSC9   OSTA,,AUTO               cn=0,n=8

      416     8976    2           OSTAPRIO = STA$->KQ$STA.MPRIO;

   8976  1 000632   100015 236100                    LDQ     13,,PR1
         1 000633   000022 772000                    QRL     18
         1 000634   000777 376007                    ANQ     511,DL
         1 000635   200030 756100                    STQ     DDA,,AUTO

      417     8977    2           END;

      418     8978    1         IF CG$->KQ$CG.QISS THEN

   8978  1 000636   000106 235100                    LDA     70,,PR0
         1 000637   000655 600000 1                  TZE     s:8987

      419     8979    2           DO;

      420     8980    2           ADDR(MBLK$->KQ$MBLK.PRIO)->B$$PRIO.HI=OSTAPRIO;

   8980  1 000640   200007 471500                    LDP1    MBLK$,,AUTO
         1 000641   000033 736000                    QLS     27
         1 000642   100001 552140                    STBQ    1,'40'O,PR1

      421     8981    2           ADDR(MBLK$->KQ$MBLK.PRIO)->B$$PRIO.LO=MTYP$->KQ$MTYP.MPRIO;

   8981  1 000643   200035 473500                    LDP3    MTYP$,,AUTO
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:91   
         1 000644   300007 236100                    LDQ     7,,PR3
         1 000645   000011 772000                    QRL     9
         1 000646   100001 552120                    STBQ    1,'20'O,PR1

      422     8982    2           MBLK$->KQ$MBLK.KEY2=MBLK$->KQ$MBLK.KEY1;

   8982  1 000647   100002 237100                    LDAQ    2,,PR1
         1 000650   100004 757100                    STAQ    4,,PR1

      423     8983    2           MBLK$->KQ$MBLK.KEY1=OSTA;

   8983  1 000651   040100 100500                    MLR     fill='040'O
         1 000652   200031 000010                    ADSC9   OSTA,,AUTO               cn=0,n=8
         1 000653   100002 000010                    ADSC9   2,,PR1                   cn=0,n=8

      424     8984    2           END;

   8984  1 000654   000667 710000 1                  TRA     s:8991

      425     8985    1         ELSE
      426     8986    2           DO;

      427     8987    2           ADDR(MBLK$->KQ$MBLK.PRIO)->B$$PRIO.HI=MTYP$->KQ$MTYP.MPRIO;

   8987  1 000655   200035 471500                    LDP1    MTYP$,,AUTO
         1 000656   200007 473500                    LDP3    MBLK$,,AUTO
         1 000657   100007 236100                    LDQ     7,,PR1
         1 000660   300001 552140                    STBQ    1,'40'O,PR3

      428     8988    2           ADDR(MBLK$->KQ$MBLK.PRIO)->B$$PRIO.LO=OSTAPRIO;

   8988  1 000661   200030 236100                    LDQ     DDA,,AUTO
         1 000662   000022 736000                    QLS     18
         1 000663   300001 552120                    STBQ    1,'20'O,PR3

      429     8989    2           MBLK$->KQ$MBLK.KEY2=OSTA;

PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:92   
   8989  1 000664   040100 100500                    MLR     fill='040'O
         1 000665   200031 000010                    ADSC9   OSTA,,AUTO               cn=0,n=8
         1 000666   300004 000010                    ADSC9   4,,PR3                   cn=0,n=8

      430     8990    2           END;

      431     8991    1         MBLK$->KQ$MBLK.JOURNAL=MTYP$->KQ$MTYP.JOURNAL;

   8991  1 000667   200007 471500                    LDP1    MBLK$,,AUTO
         1 000670   200035 473500                    LDP3    MTYP$,,AUTO
         1 000671   300007 236100                    LDQ     7,,PR3
         1 000672   000022 772000                    QRL     18
         1 000673   100010 676100                    ERQ     8,,PR1
         1 000674   000400 376007                    ANQ     256,DL
         1 000675   100010 656100                    ERSQ    8,,PR1

      432     8992    1         IF  MTYP$->KQ$MTYP.ONEREPORT

   8992  1 000676   200035 473500                    LDP3    MTYP$,,AUTO
         1 000677   300007 236100                    LDQ     7,,PR3
         1 000700   000200 316003                    CANQ    128,DU
         1 000701   000715 600000 1                  TZE     s:8999
         1 000702   100010 236100                    LDQ     8,,PR1
         1 000703   200000 316003                    CANQ    65536,DU
         1 000704   000715 600000 1                  TZE     s:8999

      433     8993    1         AND MBLK$->KQ$MBLK.LATCH THEN
      434     8994    2           DO;

      435     8995    2           MBLK$->KQ$MBLK.FORCECONT='1'B;

   8995  1 000705   000200 236007                    LDQ     128,DL
         1 000706   100010 256100                    ORSQ    8,,PR1

      436     8996    2           MBLK$->KQ$MBLK.DVE.DVBYTE=MBLK$->KQ$MBLK.DVE.DVBYTE | %DVBYTE_CONT#;

   8996  1 000707   100010 236100                    LDQ     8,,PR1
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:93   
         1 000710   000011 736000                    QLS     9
         1 000711   777000 376003                    ANQ     -512,DU
         1 000712   001000 276003                    ORQ     512,DU
         1 000713   000011 772000                    QRL     9
         1 000714   100010 552120                    STBQ    8,'20'O,PR1

      437     8997    2           END;

      438     8998              %UNLOCK (G=KQ$TTREE.GATE);

   8999  1 000715   200010 236100                    LDQ     CG$,,AUTO
         1 000716   000067 036003                    ADLQ    55,DU
         1 000717   200070 756100                    STQ     RBSTATE+4,,AUTO
         1 000720   200070 630500                    EPPR0   RBSTATE+4,,AUTO
         1 000721   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 000722   000000 701000 xent               TSX1    HFC$UNLOCK
         1 000723   000000 011000                    NOP     0

      439     9001    1         MBLK$->KQ$MBLK.FC=WRQ$->N$REQ.FC;

   9001  1 000724   200037 470500                    LDP0    WRQ$,,AUTO
         1 000725   200007 471500                    LDP1    MBLK$,,AUTO
         1 000726   000003 236100                    LDQ     3,,PR0
         1 000727   000033 736000                    QLS     27
         1 000730   100010 676100                    ERQ     8,,PR1
         1 000731   037000 376003                    ANQ     15872,DU
         1 000732   100010 656100                    ERSQ    8,,PR1

      440     9002    1         MBLK$->KQ$MBLK.LNK$=ADDR(NIL);

   9002  1 000733   000001 236000 xsym               LDQ     B_VECTNIL+1
         1 000734   100000 756100                    STQ     0,,PR1

      441     9003    1         IF DSTAL ~= 8 THEN

   9003  1 000735   200042 235100                    LDA     DSTAL,,AUTO
         1 000736   000010 115007                    CMPA    8,DL
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:94   
         1 000737   000743 600000 1                  TZE     s:9009

      442     9004    2           DO;

      443     9005    2           CALL WRWILD ALTRET(BWCTYC);

   9005  1 000740   005130 701000 1                  TSX1    WRWILD
         1 000741   002030 702000 1                  TSX2    BWCTYC

      444     9006    2           GOTO WRITECOMP;

   9006  1 000742   001564 710000 1                  TRA     WRITECOMP

      445     9007    2           END;
      446     9008    1         ELSE
      447     9009    1          IF MBLK$->KQ$MBLK.DVE.DVBYTE&%DVBYTE_CONT#

   9009  1 000743   100010 236100                    LDQ     8,,PR1
         1 000744   000011 736000                    QLS     9
         1 000745   777000 376003                    ANQ     -512,DU
         1 000746   001000 376003                    ANQ     512,DU
         1 000747   001372 601000 1                  TNZ     WRITECG
         1 000750   100010 236100                    LDQ     8,,PR1
         1 000751   200000 316003                    CANQ    65536,DU
         1 000752   001372 601000 1                  TNZ     WRITECG
         1 000753   000400 316007                    CANQ    256,DL
         1 000754   001372 601000 1                  TNZ     WRITECG
         1 000755   100000 316003                    CANQ    32768,DU
         1 000756   001372 601000 1                  TNZ     WRITECG

      448     9010    1          OR MBLK$->KQ$MBLK.LATCH
      449     9011    1          OR MBLK$->KQ$MBLK.JOURNAL
      450     9012    1          OR MBLK$->KQ$MBLK.STAR THEN GOTO WRITECG;
      451     9013        %EJECT;
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:95   
      452     9014        /***
      453     9015         ***
      454     9016         ***
      455     9017         ***               TRY TO GIVE THIS WRITE DIRECTLY TO A READER
      456     9018         ***
      457     9019         ***
      458     9020         ***/
      459     9021
      460     9022    1         IF MBLK$->KQ$MBLK.DSTA ~= ' ' THEN

   9022  1 000757   040000 106500                    CMPC    fill='040'O
         1 000760   100011 000010                    ADSC9   9,,PR1                   cn=0,n=8
         1 000761   000035 000001 xsym               ADSC9   B_VECTNIL+29             cn=0,n=1
         1 000762   001145 600000 1                  TZE     s:9080

      461     9023    2           DO;

      462     9024    2           CALL CHKSTAL ALTRET(BWCTYC);

   9024  1 000763   003136 701000 1                  TSX1    CHKSTAL
         1 000764   002030 702000 1                  TSX2    BWCTYC

      463     9025    2           IF NOT CG$->KQ$CG.AUCTL.DRML THEN

   9025  1 000765   200010 470500                    LDP0    CG$,,AUTO
         1 000766   000136 236100                    LDQ     94,,PR0
         1 000767   020000 316003                    CANQ    8192,DU
         1 000770   001135 601000 1                  TNZ     s:9076

      464     9026    3             DO;

      465     9027                                /**********************************
      466     9028                                 *                                *
      467     9029                                 *       DIRECTED WRITE           *
      468     9030                                 *                                *
      469     9031                                 **********************************/
      470     9032    3             RBLK$=DSTA$->KQ$STA.RBLK$;
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:96   

   9032  1 000771   200036 471500                    LDP1    DSTA$,,AUTO
         1 000772   100011 236100                    LDQ     9,,PR1
         1 000773   200006 756100                    STQ     RBLK$,,AUTO

      471     9033    3             IF RBLK$ ~= ADDR(NIL) THEN

   9033  1 000774   000001 116000 xsym               CMPQ    B_VECTNIL+1
         1 000775   001132 600000 1                  TZE     s:9072

      472     9034    3              IF  RBLK$->KQ$RBLK.STATE = KQRS_PEND#

   9034  1 000776   200006 473500                    LDP3    RBLK$,,AUTO
         1 000777   300001 220100                    LDX0    1,,PR3
         1 001000   000002 100003                    CMPX0   2,DU
         1 001001   001132 601000 1                  TNZ     s:9072
         1 001002   300001 236100                    LDQ     1,,PR3
         1 001003   400000 316007                    CANQ    -131072,DL
         1 001004   001132 601000 1                  TNZ     s:9072
         1 001005   100037 236100                    LDQ     31,,PR1
         1 001006   000600 316003                    CANQ    384,DU
         1 001007   001132 601000 1                  TNZ     s:9072

      473     9035    3              AND RBLK$->KQ$RBLK.LATCH = '0'B
      474     9036    3              AND DSTA$->KQ$STA.MLH.BUSY = '0'B THEN
      475     9037    4                DO;

      476     9038    4                KEY1L=RBLK$->KQ$RBLK.KEY1L;

   9038  1 001010   300001 236100                    LDQ     1,,PR3
         1 001011   000004 772000                    QRL     4
         1 001012   000017 376007                    ANQ     15,DL
         1 001013   200012 756100                    STQ     KEY1L,,AUTO

      477     9039    4                KEY2L=RBLK$->KQ$RBLK.KEY2L;

   9039  1 001014   300001 236100                    LDQ     1,,PR3
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:97   
         1 001015   000017 376007                    ANQ     15,DL
         1 001016   200013 756100                    STQ     KEY2L,,AUTO

      478     9040    4                IF  ADDR(RBLK$->KQ$RBLK.KEY1)->B$$KEY1 = ADDR(MBLK$->KQ$MBLK.KEY1)->
              9040                         B$$KEY1

   9040  1 001017   200012 721100                    LXL1    KEY1L,,AUTO
         1 001020   200007 474500                    LDP4    MBLK$,,AUTO
         1 001021   040140 106540                    CMPC    fill='040'O
         1 001022   300002 000011                    ADSC9   2,,PR3                   cn=0,n=*X1
         1 001023   400002 000011                    ADSC9   2,,PR4                   cn=0,n=*X1
         1 001024   001132 601000 1                  TNZ     s:9072
         1 001025   000000 622006                    EAX2    0,QL
         1 001026   200013 723100                    LXL3    KEY2L,,AUTO
         1 001027   040140 106540                    CMPC    fill='040'O
         1 001030   300004 000012                    ADSC9   4,,PR3                   cn=0,n=*X2
         1 001031   400004 000013                    ADSC9   4,,PR4                   cn=0,n=*X3
         1 001032   001132 601000 1                  TNZ     s:9072
         1 001033   300006 235100                    LDA     6,,PR3
         1 001034   001040 600000 1                  TZE     s:9045
         1 001035   300006 236100                    LDQ     6,,PR3
         1 001036   400014 116100                    CMPQ    12,,PR4
         1 001037   001132 601000 1                  TNZ     s:9072

      479     9041    4                AND ADDR(RBLK$->KQ$RBLK.KEY2)->B$$KEY2 = ADDR(MBLK$->KQ$MBLK.KEY2)->
              9041                         B$$KEY2
      480     9042    4                AND ((RBLK$->KQ$RBLK.MID.PRIMARY = 0) OR
      481     9043    4                (RBLK$->KQ$RBLK.MID.PRIMARY = MBLK$->KQ$MBLK.MID.PRIMARY)) THEN
      482     9044    5                  DO;

      483     9045    5                  IF DSTA$->KQ$STA.LDCT$->NK$LDCT.RESCOD = NK_CGDCB THEN

   9045  1 001040   100010 475500                    LDP5    8,,PR1
         1 001041   500006 236100                    LDQ     6,,PR5
         1 001042   000017 376007                    ANQ     15,DL
         1 001043   000004 116007                    CMPQ    4,DL
         1 001044   001054 601000 1                  TNZ     s:9052
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:98   

      484     9046    6                    DO;

      485     9047    6                    CALL XFERD ALTRET(WRITECOMP);

   9047  1 001045   003340 701000 1                  TSX1    XFERD
         1 001046   001564 702000 1                  TSX2    WRITECOMP

      486     9048    6   WR3:             IF DEST = 0 THEN GOTO BWCBUF;

   9048  1 001047   200044 235100       WR3          LDA     DEST,,AUTO
         1 001050   001735 600000 1                  TZE     BWCBUF

      487     9049    6                    IF DEST = 3 THEN GOTO BWDELMSG;

   9049  1 001051   000003 115007                    CMPA    3,DL
         1 001052   001742 600000 1                  TZE     BWDELMSG

      488     9050    6                    END;

   9050  1 001053   001132 710000 1                  TRA     s:9072

      489     9051    5                  ELSE
      490     9052    5                   IF  DSTA$->KQ$STA.LDCT$->NK$LDCT.RLCID.NODE ~= 0

   9052  1 001054   500015 236100                    LDQ     13,,PR5
         1 001055   777000 316003                    CANQ    -512,DU
         1 001056   001132 600000 1                  TZE     s:9072
         1 001057   200037 476500                    LDP6    WRQ$,,AUTO
         1 001060   600003 236100                    LDQ     3,,PR6
         1 001061   000777 376007                    ANQ     511,DL
         1 001062   000005 116007                    CMPQ    5,DL
         1 001063   001132 600000 1                  TZE     s:9072
         1 001064   000136 236100                    LDQ     94,,PR0
         1 001065   000001 316003                    CANQ    1,DU
         1 001066   001132 601000 1                  TNZ     s:9072

PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:99   
      491     9053    5                   AND WRQ$->N$REQ.FC ~= %N_WRASC
      492     9054    5                   AND CG$->KQ$CG.AUCTL.SECURE = '0'B THEN
      493     9055    6                     DO;

      494     9056    6                     CALL SETWCOMP;

   9056  1 001067   004035 701000 1                  TSX1    SETWCOMP
         1 001070   000000 011000                    NOP     0

      495     9057    6                     DSTA$->KQ$STA.LOCKCNT=DSTA$->KQ$STA.LOCKCNT+1;

   9057  1 001071   200036 470500                    LDP0    DSTA$,,AUTO
         1 001072   000020 236100                    LDQ     16,,PR0
         1 001073   000001 036007                    ADLQ    1,DL
         1 001074   000020 552104                    STBQ    16,'04'O,PR0

      496     9058    6                     RBLK$->KQ$RBLKT.IOQ$=WRQ$;

   9058  1 001075   200037 236100                    LDQ     WRQ$,,AUTO
         1 001076   200006 471500                    LDP1    RBLK$,,AUTO
         1 001077   100015 756100                    STQ     13,,PR1

      497     9059    7                     CALL MOVMXT (MYMBLK$) WHENALTRETURN DO;

   9059  1 001100   200040 633500                    EPPR3   MYMBLK$,,AUTO
         1 001101   200061 453500                    STP3    @M$+2,,AUTO
         1 001102   004030 701000 1                  TSX1    MOVMXT
         1 001103   001105 702000 1                  TSX2    s:9060
         1 001104   001112 710000 1                  TRA     s:9063

      498     9060    7                       DSTA$->KQ$STA.LOCKCNT = DSTA$->KQ$STA.LOCKCNT-1;

   9060  1 001105   200036 470500                    LDP0    DSTA$,,AUTO
         1 001106   000020 236100                    LDQ     16,,PR0
         1 001107   000777 036007                    ADLQ    511,DL
         1 001110   000020 552104                    STBQ    16,'04'O,PR0

PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:100  
      499     9061    7                       GOTO BWDELMSG;

   9061  1 001111   001742 710000 1                  TRA     BWDELMSG

      500     9062    7                       END;
      501     9063    6                     CALL KQG$GOTMWB (DSTA$->KQ$STA.LDCT$->NK$LDCT) ALTRET(WR2);

   9063  1 001112   200036 470500                    LDP0    DSTA$,,AUTO
         1 001113   000010 471500                    LDP1    8,,PR0
         1 001114   200070 451500                    STP1    RBSTATE+4,,AUTO
         1 001115   200070 630500                    EPPR0   RBSTATE+4,,AUTO
         1 001116   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 001117   000000 701000 xent               TSX1    KQG$GOTMWB
         1 001120   001127 702000 1                  TSX2    WR2

      502     9064    6                     IF WRQ$->N$REQ.TYC THEN GOTO BADCOMP;

   9064  1 001121   200037 470500                    LDP0    WRQ$,,AUTO
         1 001122   000021 235100                    LDA     17,,PR0
         1 001123   002034 601000 1                  TNZ     BADCOMP

      503     9065    6                     WRQ$->N$REQ.STATION.LSTA$=ADDR(VLP_STATION);

   9065  1 001124   200016 631500                    EPPR1   VLP_STATION,,AUTO
         1 001125   000013 451500                    STP1    11,,PR0

      504     9066    6                     GOTO WRITECOMP;

   9066  1 001126   001564 710000 1                  TRA     WRITECOMP

      505     9067    6   WR2:              MYMBLK$=MBLK$;

   9067  1 001127   200007 236100       WR2          LDQ     MBLK$,,AUTO
         1 001130   200040 756100                    STQ     MYMBLK$,,AUTO

      506     9068    6                     GOTO WRITECG;

PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:101  
   9068  1 001131   001372 710000 1                  TRA     WRITECG

      507     9069    6                     END;
      508     9070    5                  END;
      509     9071    4                END;
      510     9072    3             DEST=1;

   9072  1 001132   000001 235007                    LDA     1,DL
         1 001133   200044 755100                    STA     DEST,,AUTO

      511     9073    3             END;

   9073  1 001134   001372 710000 1                  TRA     WRITECG

      512     9074    3           ELSE DO;

      513     9075                  %UNLOCK(G=DSTA$->KQ$STA.GATE);

   9076  1 001135   200036 236100                    LDQ     DSTA$,,AUTO
         1 001136   000016 036003                    ADLQ    14,DU
         1 001137   200070 756100                    STQ     RBSTATE+4,,AUTO
         1 001140   200070 630500                    EPPR0   RBSTATE+4,,AUTO
         1 001141   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 001142   000000 701000 xent               TSX1    HFC$UNLOCK
         1 001143   000000 011000                    NOP     0

      514     9078    3             END;

      515     9079    2           END;

   9079  1 001144   001372 710000 1                  TRA     WRITECG

      516     9080    1         ELSE IF NOT CG$->KQ$CG.AUCTL.QRML THEN

   9080  1 001145   200010 473500                    LDP3    CG$,,AUTO
         1 001146   300136 236100                    LDQ     94,,PR3
         1 001147   040000 316003                    CANQ    16384,DU
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:102  
         1 001150   001372 601000 1                  TNZ     WRITECG

      517     9081    2            DO;

      518     9082                                /**********************************
      519     9083                                 *                                *
      520     9084                                 *       WRITE TO QUEUE           *
      521     9085                                 *                                *
      522     9086                                 **********************************/
      523     9087                 %LOCK (G=KQ$QTREE.GATE);

   9088  1 001151   300057 474500                    LDP4    47,,PR3
         1 001152   200070 454500                    STP4    RBSTATE+4,,AUTO
         1 001153   200070 630500                    EPPR0   RBSTATE+4,,AUTO
         1 001154   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 001155   000000 701000 xent               TSX1    HFC$LOCK
         1 001156   000000 011000                    NOP     0

      524     9090    2            IF CG$->KQ$CG.QISS THEN QTN$=STA$;

   9090  1 001157   200010 470500                    LDP0    CG$,,AUTO
         1 001160   000106 235100                    LDA     70,,PR0
         1 001161   001165 600000 1                  TZE     s:9093

   9090  1 001162   200005 236100                    LDQ     STA$,,AUTO
         1 001163   200033 756100                    STQ     QTN$,,AUTO
         1 001164   001207 710000 1                  TRA     s:9097

      525     9091    2            ELSE
      526     9092    3              DO;

      527     9093    3              IF TACTCNT ~= KQ$TTREE.ACTCNT THEN

   9093  1 001165   200043 220100                    LDX0    TACTCNT,,AUTO
         1 001166   000074 100100                    CMPX0   60,,PR0
         1 001167   001205 600000 1                  TZE     s:9095

PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:103  
      528     9094    3               CALL KQB$SRCH (KQ$TTREE,MBLK$->KQ$MBLK.KEY1,QTN$) ALTRET(BWCKEYT);

   9094  1 001170   200033 631500                    EPPR1   QTN$,,AUTO
         1 001171   200072 451500                    STP1    RBSTATE+6,,AUTO
         1 001172   200007 236100                    LDQ     MBLK$,,AUTO
         1 001173   000002 036003                    ADLQ    2,DU
         1 001174   200071 756100                    STQ     RBSTATE+5,,AUTO
         1 001175   200010 236100                    LDQ     CG$,,AUTO
         1 001176   000067 036003                    ADLQ    55,DU
         1 001177   200070 756100                    STQ     RBSTATE+4,,AUTO
         1 001200   200070 630500                    EPPR0   RBSTATE+4,,AUTO
         1 001201   000021 631400 xsym               EPPR1   B_VECTNIL+17
         1 001202   000000 701000 xent               TSX1    KQB$SRCH
         1 001203   002015 702000 1                  TSX2    BWCKEYT
         1 001204   001207 710000 1                  TRA     s:9097

      529     9095    3              ELSE QTN$=MTYP$;

   9095  1 001205   200035 236100                    LDQ     MTYP$,,AUTO
         1 001206   200033 756100                    STQ     QTN$,,AUTO

      530     9096    3              END;

      531     9097    2            P$=ADDR(QTN$->KQ$QTN.READS$);

   9097  1 001207   200033 236100                    LDQ     QTN$,,AUTO
         1 001210   000046 036003                    ADLQ    38,DU
         1 001211   200014 756100                    STQ     P$,,AUTO

      532     9098    2            RBLK$=P$->B$$PTR;

   9098  1 001212   200014 470500                    LDP0    P$,,AUTO
         1 001213   000000 236100                    LDQ     0,,PR0
         1 001214   200006 756100                    STQ     RBLK$,,AUTO

      533     9099    3              DO WHILE (RBLK$ ~= ADDR(NIL));

PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:104  
   9099  1 001215   001275 710000 1                  TRA     s:9122

      534     9100    3              KEY2L=RBLK$->KQ$RBLK.KEY2L;

   9100  1 001216   200006 470500                    LDP0    RBLK$,,AUTO
         1 001217   000001 236100                    LDQ     1,,PR0
         1 001220   000017 376007                    ANQ     15,DL
         1 001221   200013 756100                    STQ     KEY2L,,AUTO

      535     9101    3              IF ADDR(RBLK$->KQ$RBLK.KEY2)->B$$KEY2 = ADDR(MBLK$->KQ$MBLK.KEY2)->
              9101                       B$$KEY2

   9101  1 001222   000000 620006                    EAX0    0,QL
         1 001223   200007 471500                    LDP1    MBLK$,,AUTO
         1 001224   200013 721100                    LXL1    KEY2L,,AUTO
         1 001225   040140 106540                    CMPC    fill='040'O
         1 001226   000004 000010                    ADSC9   4,,PR0                   cn=0,n=*X0
         1 001227   100004 000011                    ADSC9   4,,PR1                   cn=0,n=*X1
         1 001230   001267 601000 1                  TNZ     s:9120
         1 001231   000006 235100                    LDA     6,,PR0
         1 001232   001236 600000 1                  TZE     s:9105
         1 001233   000006 236100                    LDQ     6,,PR0
         1 001234   100014 116100                    CMPQ    12,,PR1
         1 001235   001267 601000 1                  TNZ     s:9120

      536     9102    3              AND ((RBLK$->KQ$RBLK.MID.PRIMARY = 0) OR
      537     9103    3              (RBLK$->KQ$RBLK.MID.PRIMARY = MBLK$->KQ$MBLK.MID.PRIMARY)) THEN
      538     9104    4                DO;

      539     9105    4                IF RBLK$->KQ$RBLK.LATCH THEN GOTO WR11;

   9105  1 001236   000001 236100                    LDQ     1,,PR0
         1 001237   400000 316007                    CANQ    -131072,DL
         1 001240   001370 601000 1                  TNZ     WR11

      540     9106    4                DSTA$=RBLK$->KQ$RBLK.STA$;

PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:105  
   9106  1 001241   000012 236100                    LDQ     10,,PR0
         1 001242   200036 756100                    STQ     DSTA$,,AUTO

      541     9107                     %LOCK (G=DSTA$->KQ$STA.GATE);

   9108  1 001243   000016 036003                    ADLQ    14,DU
         1 001244   200070 756100                    STQ     RBSTATE+4,,AUTO
         1 001245   200070 630500                    EPPR0   RBSTATE+4,,AUTO
         1 001246   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 001247   000000 701000 xent               TSX1    HFC$LOCK
         1 001250   000000 011000                    NOP     0

      542     9110    4                IF RBLK$->KQ$RBLK.STATE = KQRS_PEND# THEN

   9110  1 001251   200006 470500                    LDP0    RBLK$,,AUTO
         1 001252   000001 220100                    LDX0    1,,PR0
         1 001253   000002 100003                    CMPX0   2,DU
         1 001254   001260 601000 1                  TNZ     s:9117

      543     9111    5                  DO;

   9105  1 001255                       WRITENOWQ    null
      544     9112    5   WRITENOWQ:     ;
      545     9113    5                  CALL XFERQ ALTRET(WRITECOMP);

   9113  1 001255   003343 701000 1                  TSX1    XFERQ
         1 001256   001564 702000 1                  TSX2    WRITECOMP

      546     9114    5                  GOTO WR3;

   9114  1 001257   001047 710000 1                  TRA     WR3

      547     9115    5                  END;
      548     9116                     %UNLOCK (G=DSTA$->KQ$STA.GATE);

   9117  1 001260   200036 236100                    LDQ     DSTA$,,AUTO
         1 001261   000016 036003                    ADLQ    14,DU
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:106  
         1 001262   200070 756100                    STQ     RBSTATE+4,,AUTO
         1 001263   200070 630500                    EPPR0   RBSTATE+4,,AUTO
         1 001264   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 001265   000000 701000 xent               TSX1    HFC$UNLOCK
         1 001266   000000 011000                    NOP     0

      549     9119    4                END;

      550     9120    3              P$=ADDR(RBLK$->KQ$RBLK.QRLNK$);

   9120  1 001267   200006 236100                    LDQ     RBLK$,,AUTO
         1 001270   000020 036003                    ADLQ    16,DU
         1 001271   200014 756100                    STQ     P$,,AUTO

      551     9121    3              RBLK$=P$->B$$PTR;

   9121  1 001272   200014 470500                    LDP0    P$,,AUTO
         1 001273   000000 236100                    LDQ     0,,PR0
         1 001274   200006 756100                    STQ     RBLK$,,AUTO

      552     9122    3              END;

   9122  1 001275   000001 116000 xsym               CMPQ    B_VECTNIL+1
         1 001276   001216 601000 1                  TNZ     s:9100

      553     9123                           /* COULD NOT FIND A GOOD READ ON THIS Q-TREE NODE.
      554     9124                              LOOK IN WILD-CARDED READS */
      555     9125    2            P$=ADDR(KQ$QUEUE.WCRL$);

   9125  1 001277   200010 236100                    LDQ     CG$,,AUTO
         1 001300   000060 036003                    ADLQ    48,DU
         1 001301   200014 756100                    STQ     P$,,AUTO

      556     9126    2            RBLK$=P$->B$$PTR;

   9126  1 001302   200014 470500                    LDP0    P$,,AUTO
         1 001303   000000 236100                    LDQ     0,,PR0
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:107  
         1 001304   200006 756100                    STQ     RBLK$,,AUTO

      557     9127    3              DO WHILE (RBLK$ ~= ADDR(NIL));

   9127  1 001305   001366 710000 1                  TRA     s:9146

      558     9128    3              KEY1L=RBLK$->KQ$RBLK.KEY1L;

   9128  1 001306   200006 470500                    LDP0    RBLK$,,AUTO
         1 001307   000001 236100                    LDQ     1,,PR0
         1 001310   000004 772000                    QRL     4
         1 001311   000017 376007                    ANQ     15,DL
         1 001312   200012 756100                    STQ     KEY1L,,AUTO

      559     9129    3              KEY2L=RBLK$->KQ$RBLK.KEY2L;

   9129  1 001313   000001 236100                    LDQ     1,,PR0
         1 001314   000017 376007                    ANQ     15,DL
         1 001315   200013 756100                    STQ     KEY2L,,AUTO

      560     9130    3              IF  ADDR(RBLK$->KQ$RBLK.KEY1)->B$$KEY1 = ADDR(MBLK$->KQ$MBLK.KEY1)->
              9130                       B$$KEY1

   9130  1 001316   200012 720100                    LXL0    KEY1L,,AUTO
         1 001317   200007 471500                    LDP1    MBLK$,,AUTO
         1 001320   040140 106540                    CMPC    fill='040'O
         1 001321   000002 000010                    ADSC9   2,,PR0                   cn=0,n=*X0
         1 001322   100002 000010                    ADSC9   2,,PR1                   cn=0,n=*X0
         1 001323   001360 601000 1                  TNZ     s:9144
         1 001324   000000 621006                    EAX1    0,QL
         1 001325   200013 722100                    LXL2    KEY2L,,AUTO
         1 001326   040140 106540                    CMPC    fill='040'O
         1 001327   000004 000011                    ADSC9   4,,PR0                   cn=0,n=*X1
         1 001330   100004 000012                    ADSC9   4,,PR1                   cn=0,n=*X2
         1 001331   001360 601000 1                  TNZ     s:9144

      561     9131    3              AND ADDR(RBLK$->KQ$RBLK.KEY2)->B$$KEY2 = ADDR(MBLK$->KQ$MBLK.KEY2)->
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:108  
              9131                       B$$KEY2 THEN
      562     9132    4                DO;

      563     9133    4                IF RBLK$->KQ$RBLK.LATCH THEN GOTO WR11;

   9133  1 001332   000001 236100                    LDQ     1,,PR0
         1 001333   400000 316007                    CANQ    -131072,DL
         1 001334   001370 601000 1                  TNZ     WR11

      564     9134    4                DSTA$=RBLK$->KQ$RBLK.STA$;

   9134  1 001335   000012 236100                    LDQ     10,,PR0
         1 001336   200036 756100                    STQ     DSTA$,,AUTO

      565     9135                     %LOCK (G=DSTA$->KQ$STA.GATE);

   9136  1 001337   000016 036003                    ADLQ    14,DU
         1 001340   200070 756100                    STQ     RBSTATE+4,,AUTO
         1 001341   200070 630500                    EPPR0   RBSTATE+4,,AUTO
         1 001342   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 001343   000000 701000 xent               TSX1    HFC$LOCK
         1 001344   000000 011000                    NOP     0

      566     9138    4                IF RBLK$->KQ$RBLK.STATE = KQRS_PEND# THEN

   9138  1 001345   200006 470500                    LDP0    RBLK$,,AUTO
         1 001346   000001 220100                    LDX0    1,,PR0
         1 001347   000002 100003                    CMPX0   2,DU
         1 001350   001255 600000 1                  TZE     WRITENOWQ

      567     9139    4                 GOTO WRITENOWQ;
      568     9140                     %UNLOCK (G=DSTA$->KQ$STA.GATE);

   9141  1 001351   200036 236100                    LDQ     DSTA$,,AUTO
         1 001352   000016 036003                    ADLQ    14,DU
         1 001353   200070 756100                    STQ     RBSTATE+4,,AUTO
         1 001354   200070 630500                    EPPR0   RBSTATE+4,,AUTO
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:109  
         1 001355   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 001356   000000 701000 xent               TSX1    HFC$UNLOCK
         1 001357   000000 011000                    NOP     0

      569     9143    4                END;

      570     9144    3              P$=ADDR(RBLK$->KQ$RBLK.QRLNK$);

   9144  1 001360   200006 236100                    LDQ     RBLK$,,AUTO
         1 001361   000020 036003                    ADLQ    16,DU
         1 001362   200014 756100                    STQ     P$,,AUTO

      571     9145    3              RBLK$=P$->B$$PTR;

   9145  1 001363   200014 470500                    LDP0    P$,,AUTO
         1 001364   000000 236100                    LDQ     0,,PR0
         1 001365   200006 756100                    STQ     RBLK$,,AUTO

      572     9146    3              END;

   9146  1 001366   000001 116000 xsym               CMPQ    B_VECTNIL+1
         1 001367   001306 601000 1                  TNZ     s:9128

   9139  1 001370                       WR11         null
      573     9147    2   WR11:    ;
      574     9148    2            DEST=-1;

   9148  1 001370   000001 335007                    LCA     1,DL
         1 001371   200044 755100                    STA     DEST,,AUTO

      575     9149    2            END;

      576     9150        %EJECT;
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:110  
      577     9151        /***
      578     9152         ***
      579     9153         ***
      580     9154         ***          WRITE THE DATA INTO THE COMGROUP, THEN GO
      581     9155         ***          FIND A PLACE TO GIVE IT TO, UNLESS IT'S LATCHED
      582     9156         ***          OR CONTINUED.
      583     9157         ***
      584     9158         ***
      585     9159         ***/
      586     9160                      /* If DEST=1, then this is a directed write, and
      587     9161                           the destination station gate is still locked,
      588     9162                           with DSTA$ pointing to it.
      589     9163                         If DEST=-1, then this is a write to the queue,
      590     9164                           which is still locked, with QTN$ pointing to
      591     9165                           the node.
      592     9166                         If DEST=0, then we know nothing about the destination
      593     9167                           of the write. */
      594     9168    1   WRITECG:;

   9168  1 001372                       WRITECG      null
      595     9169    1         IF BUFSZ ~= 0 THEN

   9169  1 001372   200027 235100                    LDA     BUFSZ,,AUTO
         1 001373   001461 600000 1                  TZE     s:9188

      596     9170    2           DO;

      597     9171    2           CALL GETDBLK ALTRET(BWCTYC);

   9171  1 001374   002756 701000 1                  TSX1    GETDBLK
         1 001375   002030 702000 1                  TSX2    BWCTYC

      598     9172    2           CALL FILLDBLK ALTRET(BWCTYC);

   9172  1 001376   002653 701000 1                  TSX1    FILLDBLK
         1 001377   002030 702000 1                  TSX2    BWCTYC

PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:111  
      599     9173    2           IF MBLK$->KQ$MBLK.DDA = 0 THEN MBLK$->KQ$MBLK.DDA=NEWDDA;

   9173  1 001400   200007 470500                    LDP0    MBLK$,,AUTO
         1 001401   000006 235100                    LDA     6,,PR0
         1 001402   001406 601000 1                  TNZ     WRITECG0

   9173  1 001403   200041 236100                    LDQ     NEWDDA,,AUTO
         1 001404   000006 756100                    STQ     6,,PR0
         1 001405   001456 710000 1                  TRA     s:9186

      600     9174    2           ELSE
      601     9175    3             DO;

   9173  1 001406                       WRITECG0     null
      602     9176    3   WRITECG0: ;
      603     9177    3             DBLK$R=MBLK$->KQ$MBLK.STAMP;

   9177  1 001406   200007 470500                    LDP0    MBLK$,,AUTO
         1 001407   000001 236100                    LDQ     1,,PR0
         1 001410   777777 376007                    ANQ     -1,DL
         1 001411   200026 756100                    STQ     DBLK$,,AUTO

      604     9178    3             DDA=MBLK$->KQ$MBLK.PREVDDA;

   9178  1 001412   000017 235100                    LDA     15,,PR0
         1 001413   200030 755100                    STA     DDA,,AUTO

      605     9179    3             IF DEST ~= 0 THEN

   9179  1 001414   200044 235100                    LDA     DEST,,AUTO
         1 001415   001431 600000 1                  TZE     s:9181

      606     9180    3              CALL KQD$FETCH (CG$->KQ$CG,DBLK$,DDA) ALTRET(NOFETCH);

   9180  1 001416   200030 631500                    EPPR1   DDA,,AUTO
         1 001417   200072 451500                    STP1    RBSTATE+6,,AUTO
         1 001420   200026 633500                    EPPR3   DBLK$,,AUTO
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:112  
         1 001421   200071 453500                    STP3    RBSTATE+5,,AUTO
         1 001422   200010 236100                    LDQ     CG$,,AUTO
         1 001423   200070 756100                    STQ     RBSTATE+4,,AUTO
         1 001424   200070 630500                    EPPR0   RBSTATE+4,,AUTO
         1 001425   000021 631400 xsym               EPPR1   B_VECTNIL+17
         1 001426   000000 701000 xent               TSX1    KQD$FETCH
         1 001427   001573 702000 1                  TSX2    NOFETCH
         1 001430   001443 710000 1                  TRA     WRITECG1

      607     9181    3             ELSE CALL KQD$FETCHR (CG$->KQ$CG,DBLK$,DDA) ALTRET(NOFETCH1);

   9181  1 001431   200030 631500                    EPPR1   DDA,,AUTO
         1 001432   200072 451500                    STP1    RBSTATE+6,,AUTO
         1 001433   200026 633500                    EPPR3   DBLK$,,AUTO
         1 001434   200071 453500                    STP3    RBSTATE+5,,AUTO
         1 001435   200010 236100                    LDQ     CG$,,AUTO
         1 001436   200070 756100                    STQ     RBSTATE+4,,AUTO
         1 001437   200070 630500                    EPPR0   RBSTATE+4,,AUTO
         1 001440   000021 631400 xsym               EPPR1   B_VECTNIL+17
         1 001441   000000 701000 xent               TSX1    KQD$FETCHR
         1 001442   001705 702000 1                  TSX2    NOFETCH1

   9179  1 001443                       WRITECG1     null
      608     9182    3   WRITECG1: ;
      609     9183    3             DBLK$->KQ$DBLK.FLNKDA=NEWDDA;

   9183  1 001443   200026 470500                    LDP0    DBLK$,,AUTO
         1 001444   200041 235100                    LDA     NEWDDA,,AUTO
         1 001445   000001 755100                    STA     1,,PR0

      610     9184    3             CALL KQD$UPDATED (CG$->KQ$CG,DBLK$);

   9184  1 001446   200026 630500                    EPPR0   DBLK$,,AUTO
         1 001447   200071 450500                    STP0    RBSTATE+5,,AUTO
         1 001450   200010 236100                    LDQ     CG$,,AUTO
         1 001451   200070 756100                    STQ     RBSTATE+4,,AUTO
         1 001452   200070 630500                    EPPR0   RBSTATE+4,,AUTO
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:113  
         1 001453   000020 631400 xsym               EPPR1   B_VECTNIL+16
         1 001454   000000 701000 xent               TSX1    KQD$UPDATED
         1 001455   000000 011000                    NOP     0

      611     9185    3             END;

      612     9186    2           MBLK$->KQ$MBLK.PREVDDA=NEWDDA;

   9186  1 001456   200007 470500                    LDP0    MBLK$,,AUTO
         1 001457   200041 235100                    LDA     NEWDDA,,AUTO
         1 001460   000017 755100                    STA     15,,PR0

      613     9187    2           END;

      614     9188    1         CALL SETWCOMP;

   9188  1 001461   004035 701000 1                  TSX1    SETWCOMP
         1 001462   000000 011000                    NOP     0

      615     9189    1         IF NOT MBLK$->KQ$MBLK.DVE.DVBYTE&%DVBYTE_CONT# THEN

   9189  1 001463   200007 470500                    LDP0    MBLK$,,AUTO
         1 001464   000010 236100                    LDQ     8,,PR0
         1 001465   000011 736000                    QLS     9
         1 001466   777000 376003                    ANQ     -512,DU
         1 001467   001000 376003                    ANQ     512,DU
         1 001470   001554 601000 1                  TNZ     s:9219

      616     9190    2           DO;

      617     9191    2           MBLK$->KQ$MBLK.LNK$=ADDR(NIL);

   9191  1 001471   000001 236000 xsym               LDQ     B_VECTNIL+1
         1 001472   000000 756100                    STQ     0,,PR0

      618     9192    2           IF MBLK$->KQ$MBLK.LATCH THEN

PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:114  
   9192  1 001473   000010 236100                    LDQ     8,,PR0
         1 001474   200000 316003                    CANQ    65536,DU
         1 001475   001524 600000 1                  TZE     s:9207

      619     9193    3             DO;

      620     9194    3             CALL CHKSTA ALTRET(BWCTYC);

   9194  1 001476   003142 701000 1                  TSX1    CHKSTA
         1 001477   002030 702000 1                  TSX2    BWCTYC

      621     9195    3             MBLK$->KQ$MBLK.DCB$=WRQ$->N$REQ.DCB$;

   9195  1 001500   200037 470500                    LDP0    WRQ$,,AUTO
         1 001501   000022 236100                    LDQ     18,,PR0
         1 001502   200007 471500                    LDP1    MBLK$,,AUTO
         1 001503   100013 756100                    STQ     11,,PR1

      622     9196    3             RBLK$=STA$->KQ$STA.RBLK$;

   9196  1 001504   200005 473500                    LDP3    STA$,,AUTO
         1 001505   300011 236100                    LDQ     9,,PR3
         1 001506   200006 756100                    STQ     RBLK$,,AUTO

      623     9197    4               DO INHIBIT;

      624     9198    4               IF RBLK$->KQ$RBLK.LWRITES$ = ADDR(NIL) THEN

   9198  1 001507   200006 474700                    LDP4  ! RBLK$,,AUTO
         1 001510   400020 236300                    LDQ   ! 16,,PR4
         1 001511   000001 116200 xsym               CMPQ  ! B_VECTNIL+1
         1 001512   001516 601200 1                  TNZ   ! s:9201

      625     9199    4                RBLK$->KQ$RBLK.LWRITES$=MBLK$;

   9199  1 001513   200007 236300                    LDQ   ! MBLK$,,AUTO
         1 001514   400020 756300                    STQ   ! 16,,PR4
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:115  
         1 001515   001521 710200 1                  TRA   ! s:9202

      626     9200    4               ELSE
      627     9201    4                RBLK$->KQ$RBLK.LWTL$->KQ$MBLK.LNK$=MBLK$;

   9201  1 001516   400013 475700                    LDP5  ! 11,,PR4
         1 001517   200007 236300                    LDQ   ! MBLK$,,AUTO
         1 001520   500000 756300                    STQ   ! 0,,PR5

      628     9202    4               RBLK$->KQ$RBLK.LWTL$=MBLK$;

   9202  1 001521   200006 474700                    LDP4  ! RBLK$,,AUTO
         1 001522   400013 756300                    STQ   ! 11,,PR4

      629     9203    4               END;

      630     9204    3             END;

   9204  1 001523   001564 710000 1                  TRA     WRITECOMP

      631     9205    2           ELSE
      632     9206    3             DO;

      633     9207    3             MBLK$->KQ$MBLK.TYC='0'B;

   9207  1 001524   000013 450100                    STZ     11,,PR0

      634     9208    3             IF DEST > 0 THEN CALL SENDMSGD (MYMBLK$);

   9208  1 001525   200044 235100                    LDA     DEST,,AUTO
         1 001526   001534 604400 1                  TMOZ    s:9209

   9208  1 001527   200040 631500                    EPPR1   MYMBLK$,,AUTO
         1 001530   200057 451500                    STP1    FOUND+2,,AUTO
         1 001531   004764 701000 1                  TSX1    SENDMSGD
         1 001532   000000 011000                    NOP     0
         1 001533   001564 710000 1                  TRA     WRITECOMP
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:116  

      635     9209    3             ELSE IF DEST < 0 THEN CALL SENDMSGQ (MYMBLK$);

   9209  1 001534   001542 605000 1                  TPL     s:9212

   9209  1 001535   200040 631500                    EPPR1   MYMBLK$,,AUTO
         1 001536   200057 451500                    STP1    FOUND+2,,AUTO
         1 001537   005113 701000 1                  TSX1    SENDMSGQ
         1 001540   000000 011000                    NOP     0
         1 001541   001564 710000 1                  TRA     WRITECOMP

      636     9210    3              ELSE
      637     9211    4                DO;

      638     9212    4                WAS=CG$->KQ$CG.AUCTL.WAS;

   9212  1 001542   200010 471500                    LDP1    CG$,,AUTO
         1 001543   100133 236100                    LDQ     91,,PR1
         1 001544   000040 736000                    QLS     32
         1 001545   400000 376003                    ANQ     -131072,DU
         1 001546   200015 756100                    STQ     WAS,,AUTO

      639     9213    4                CALL SENDMSG (MYMBLK$) ALTRET(BWCTYC);

   9213  1 001547   200040 633500                    EPPR3   MYMBLK$,,AUTO
         1 001550   200057 453500                    STP3    FOUND+2,,AUTO
         1 001551   004070 701000 1                  TSX1    SENDMSG
         1 001552   002030 702000 1                  TSX2    BWCTYC

      640     9214    4                END;

      641     9215    3             END;

      642     9216    2           END;

   9216  1 001553   001564 710000 1                  TRA     WRITECOMP

PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:117  
      643     9217    1         ELSE
      644     9218    2           DO;

      645     9219    2           MBLK$->KQ$MBLK.DCB$=WRQ$->N$REQ.DCB$;

   9219  1 001554   200037 471500                    LDP1    WRQ$,,AUTO
         1 001555   100022 236100                    LDQ     18,,PR1
         1 001556   000013 756100                    STQ     11,,PR0

      646     9220    2           MBLK$->KQ$MBLK.LNK$=STA$->KQ$STA.MBLK$;

   9220  1 001557   200005 473500                    LDP3    STA$,,AUTO
         1 001560   300012 236100                    LDQ     10,,PR3
         1 001561   000000 756100                    STQ     0,,PR0

      647     9221    2           STA$->KQ$STA.MBLK$=MBLK$;

   9221  1 001562   200007 236100                    LDQ     MBLK$,,AUTO
         1 001563   300012 756100                    STQ     10,,PR3

      648     9222    2           END;

   9221  1 001564                       WRITECOMP    null
      649     9223    1   WRITECOMP:;
      650     9224    1         STA$->KQ$STA.WRITES=STA$->KQ$STA.WRITES+1;

   9224  1 001564   200005 470500                    LDP0    STA$,,AUTO
         1 001565   000027 054100                    AOS     23,,PR0

      651     9225    1         CALL NIO$COMPCW (WRQ$->N$REQ);

   9225  1 001566   200037 630500                    EPPR0   WRQ$,,AUTO
         1 001567   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 001570   000000 701000 xent               TSX1    NIO$COMPCW
         1 001571   000000 011000                    NOP     0

      652     9226    1         RETURN;
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:118  

   9226  1 001572   000000 702200 xent               TSX2  ! X66_ARET

   9224  1 001573                       NOFETCH      null
      653     9227        /**/
      654     9228    1   NOFETCH:;
      655     9229    1         CALL DESTUL;

   9229  1 001573   002041 701000 1                  TSX1    DESTUL
         1 001574   000000 011000                    NOP     0

      656     9230    1         IF DBLK$ = ADDR(NIL) THEN

   9230  1 001575   200026 236100                    LDQ     DBLK$,,AUTO
         1 001576   000001 116000 xsym               CMPQ    B_VECTNIL+1
         1 001577   001667 601000 1                  TNZ     s:9270

      657     9231    2           DO;

   9225  1 001600                       NOFETCH0     null
      658     9232    2   NOFETCH0:;
      659     9233    3             DO CASE (DDA);

   9233  1 001600   200030 235100                    LDA     DDA,,AUTO
         1 001601   000013 115007                    CMPA    11,DL
         1 001602   001604 602005 1                  TNC     NOFETCH0+4,AL
         1 001603   001665 710000 1                  TRA     s:9259
         1 001604   001665 710000 1                  TRA     s:9259
         1 001605   001665 710000 1                  TRA     s:9259
         1 001606   001665 710000 1                  TRA     s:9259
         1 001607   001620 710000 1                  TRA     s:9239
         1 001610   001620 710000 1                  TRA     s:9239
         1 001611   001620 710000 1                  TRA     s:9239
         1 001612   001624 710000 1                  TRA     s:9243
         1 001613   001665 710000 1                  TRA     s:9259
         1 001614   001665 710000 1                  TRA     s:9259
         1 001615   001665 710000 1                  TRA     s:9259
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:119  
         1 001616   001617 710000 1                  TRA     s:9236

      660     9234
      661     9235    3               CASE (%KQDE_NDFRBLK);

      662     9236    3                 GOTO WRITECG0;

   9236  1 001617   001406 710000 1                  TRA     WRITECG0

      663     9237
      664     9238    3               CASE (%KQDE_STMP,%KQDE_STATE,%KQDE_BDDA);

      665     9239    3                 WRQ$->N$REQ.TYC=%TYC_DI;

   9239  1 001620   000001 236000 0                  LDQ     1
         1 001621   200037 470500                    LDP0    WRQ$,,AUTO
         1 001622   000021 756100                    STQ     17,,PR0

      666     9240    3                 GOTO NOFETCH2;

   9240  1 001623   001627 710000 1                  TRA     NOFETCH2

      667     9241
      668     9242    3               CASE (%KQDE_IOERR);

      669     9243    3                 WRQ$->N$REQ.TYC=%TYC_IOERR;

   9243  1 001624   000033 236000 xsym               LDQ     B_VECTNIL+27
         1 001625   200037 470500                    LDP0    WRQ$,,AUTO
         1 001626   000021 756100                    STQ     17,,PR0

   9243  1 001627                       NOFETCH2     null
      670     9244    3   NOFETCH2:     ;
      671     9245                      %LOCK (G=KQ_ERRLOG_GATE);

   9246  1 001627   000005 630400 2                  EPPR0   5
         1 001630   000017 631400 xsym               EPPR1   B_VECTNIL+15
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:120  
         1 001631   000000 701000 xent               TSX1    HFC$LOCK
         1 001632   000000 011000                    NOP     0

      672     9248    3                 KQ_ERRLOG_BFR.CODE=%KQELOG_KQW_CWFTCH;

   9248  1 001633   012000 236003                    LDQ     5120,DU
         1 001634   000000 552040 xsym               STBQ    KQ_ERRLOG_BFR,'40'O

      673     9249    3                 KQ_ERRLOG_BFR.SIZ=2+SIZEW(KQ$MBLK);

   9249  1 001635   000022 235007                    LDA     18,DL
         1 001636   000015 755000 xsym               STA     KQ_ERRLOG_BFR+13

      674     9250    3                 P$=ADDR(KQ_ERRLOG_BFR.INFO);

   9250  1 001637   000006 236000 2                  LDQ     6
         1 001640   200014 756100                    STQ     P$,,AUTO

      675     9251    3                 KQ_ERRLOG_BFR.INFO='0'B;

   9251  1 001641   000000 100400                    MLR     fill='000'O
         1 001642   000002 000001 xsym               ADSC9   B_VECTNIL+2              cn=0,n=1
         1 001643   000016 000310 xsym               ADSC9   KQ_ERRLOG_BFR+14         cn=0,n=200

      676     9252    3                 P$->B$$CHAR8=STA$->KQ$STA.BTN.KEY;

   9252  1 001644   200005 470500                    LDP0    STA$,,AUTO
         1 001645   200014 471500                    LDP1    P$,,AUTO
         1 001646   040100 100500                    MLR     fill='040'O
         1 001647   000005 000010                    ADSC9   5,,PR0                   cn=0,n=8
         1 001650   100000 000010                    ADSC9   0,,PR1                   cn=0,n=8

      677     9253    3                 P$=PINCRW(P$,2);

   9253  1 001651   000002 036003                    ADLQ    2,DU
         1 001652   200014 756100                    STQ     P$,,AUTO

PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:121  
      678     9254    3                 P$->KQ$MBLK=MBLK$->KQ$MBLK;

   9254  1 001653   200007 471500                    LDP1    MBLK$,,AUTO
         1 001654   200014 473500                    LDP3    P$,,AUTO
         1 001655   000100 100500                    MLR     fill='000'O
         1 001656   100000 000100                    ADSC9   0,,PR1                   cn=0,n=64
         1 001657   300000 000100                    ADSC9   0,,PR3                   cn=0,n=64

      679     9255    3                 CALL KQD$ERRLOG (CG$->KQ$CG);

   9255  1 001660   200010 630500                    EPPR0   CG$,,AUTO
         1 001661   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 001662   000000 701000 xent               TSX1    KQD$ERRLOG
         1 001663   000000 011000                    NOP     0

      680     9256    3                 GOTO BWDELMSG;

   9256  1 001664   001742 710000 1                  TRA     BWDELMSG

      681     9257
      682     9258    3               CASE (ELSE);

      683     9259    3                 CALL SC_CGNOTIMP;

   9259  1 001665   000000 713400 xsym               CLIMB   SC_CGNOTIMP
         1 001666   000000 600000 xsid               climb   nvectors=         0

      684     9260        /*S* SCREECH_CODE: KQW-S$CGNOTIMP
      685     9261             TYPE:         SCREECH
      686     9262             MESSAGE:      Unimplemented comgroup condition encountered
      687     9263             DESCRIPTION:  An unknown or unimplemented comgroup condition
      688     9264                           has been encountered.  This is almost always
      689     9265                           an unknown condition that should not happen. */
      690     9266
      691     9267    3             END;

      692     9268    2           END;
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:122  

      693     9269
      694     9270    1         DDA=MBLK$->KQ$MBLK.PREVDDA;

   9270  1 001667   200007 470500                    LDP0    MBLK$,,AUTO
         1 001670   000017 235100                    LDA     15,,PR0
         1 001671   200030 755100                    STA     DDA,,AUTO

      695     9271    1         CALL KQD$DEFERWAIT (CG$->KQ$CG,DBLK$,DDA) ALTRET(NOFETCH1);

   9271  1 001672   200030 631500                    EPPR1   DDA,,AUTO
         1 001673   200072 451500                    STP1    RBSTATE+6,,AUTO
         1 001674   200026 633500                    EPPR3   DBLK$,,AUTO
         1 001675   200071 453500                    STP3    RBSTATE+5,,AUTO
         1 001676   200010 236100                    LDQ     CG$,,AUTO
         1 001677   200070 756100                    STQ     RBSTATE+4,,AUTO
         1 001700   200070 630500                    EPPR0   RBSTATE+4,,AUTO
         1 001701   000021 631400 xsym               EPPR1   B_VECTNIL+17
         1 001702   000000 701000 xent               TSX1    KQD$DEFERWAIT
         1 001703   001705 702000 1                  TSX2    NOFETCH1

      696     9272    1         GOTO WRITECG1;

   9272  1 001704   001443 710000 1                  TRA     WRITECG1

   9270  1 001705                       NOFETCH1     null
      697     9273    1   NOFETCH1:;
      698     9274    1         IF DDA ~= %KQDE_CREG THEN GOTO NOFETCH0;

   9274  1 001705   200030 235100                    LDA     DDA,,AUTO
         1 001706   000001 115007                    CMPA    1,DL
         1 001707   001600 601000 1                  TNZ     NOFETCH0

      699     9275    1         CALL SC_CGNOTIMP; /* Must be MONKEY somehow doing a */

   9275  1 001710   000000 713400 xsym               CLIMB   SC_CGNOTIMP
         1 001711   000000 600000 xsid               climb   nvectors=         0
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:123  

   9274  1 001712                       BWCCWRV      null
      700     9276                                /* continued write, which is illegal */
      701     9277        /**/
      702     9278        /**/
      703     9279    1   BWCCWRV:;
      704     9280    1         WRQ$->N$REQ.TYC=%TYC_CGCWRV;

   9280  1 001712   000002 236000 0                  LDQ     2
         1 001713   200037 470500                    LDP0    WRQ$,,AUTO
         1 001714   000021 756100                    STQ     17,,PR0

      705     9281    1         GOTO BADCOMP;

   9281  1 001715   002034 710000 1                  TRA     BADCOMP

   9280  1 001716                       BWCLWRV      null
      706     9282    1   BWCLWRV:;
      707     9283              %UNLOCK (G=KQ$TTREE.GATE);

   9284  1 001716   200010 236100                    LDQ     CG$,,AUTO
         1 001717   000067 036003                    ADLQ    55,DU
         1 001720   200070 756100                    STQ     RBSTATE+4,,AUTO
         1 001721   200070 630500                    EPPR0   RBSTATE+4,,AUTO
         1 001722   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 001723   000000 701000 xent               TSX1    HFC$UNLOCK
         1 001724   000000 011000                    NOP     0

      708     9286    1         WRQ$->N$REQ.TYC=%TYC_CGLWRV;

   9286  1 001725   000003 236000 0                  LDQ     3
         1 001726   200037 470500                    LDP0    WRQ$,,AUTO
         1 001727   000021 756100                    STQ     17,,PR0

      709     9287    1         GOTO BWDELMSG;

   9287  1 001730   001742 710000 1                  TRA     BWDELMSG
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:124  

   9286  1 001731                       BWCFULL      null
      710     9288    1   BWCFULL:;
      711     9289    1         WRQ$->N$REQ.TYC=%TYC_CGFULL;

   9289  1 001731   000004 236000 0                  LDQ     4
         1 001732   200037 470500                    LDP0    WRQ$,,AUTO
         1 001733   000021 756100                    STQ     17,,PR0

      712     9290    1         GOTO BWDELMSG;

   9290  1 001734   001742 710000 1                  TRA     BWDELMSG

   9289  1 001735                       BWCBUF       null
      713     9291    1   BWCBUF:;
      714     9292    1         WRQ$->N$REQ.TYC=%TYC_MTRAP;

   9292  1 001735   000005 236000 0                  LDQ     5
         1 001736   200037 470500                    LDP0    WRQ$,,AUTO
         1 001737   000021 756100                    STQ     17,,PR0

   9292  1 001740                       BWC1         null
      715     9293    1   BWC1: ;
      716     9294    1         CALL DESTUL;

   9294  1 001740   002041 701000 1                  TSX1    DESTUL
         1 001741   000000 011000                    NOP     0

   9292  1 001742                       BWDELMSG     null
      717     9295    1   BWDELMSG:;
      718     9296    1         IF MYMBLK$ ~= ADDR(NIL) THEN

   9296  1 001742   200040 236100                    LDQ     MYMBLK$,,AUTO
         1 001743   000001 116000 xsym               CMPQ    B_VECTNIL+1
         1 001744   002014 600000 1                  TZE     s:9311

      719     9297    2           DO;
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:125  

      720     9298    2           IF (MTYP$ ~= ADDR(NIL)) AND (MTYP$ ~= ADDR(KQ_IMTYP))

   9298  1 001745   200035 236100                    LDQ     MTYP$,,AUTO
         1 001746   000001 116000 xsym               CMPQ    B_VECTNIL+1
         1 001747   002005 600000 1                  TZE     s:9309
         1 001750   000004 236000 2                  LDQ     4
         1 001751   200035 116100                    CMPQ    MTYP$,,AUTO
         1 001752   002005 600000 1                  TZE     s:9309

      721     9299    3           THEN DO;

      722     9300    3             IF (CG$->KQ$CG.QISS)

   9300  1 001753   200010 470500                    LDP0    CG$,,AUTO
         1 001754   000106 235100                    LDA     70,,PR0
         1 001755   001763 600000 1                  TZE     s:9303

      723     9301                      /* use of OSTA here to represent MSGTYP to save AUTO */
      724     9302    3             THEN OSTA=MYMBLK$->KQ$MBLK.KEY2 ;

   9302  1 001756   200040 471500                    LDP1    MYMBLK$,,AUTO
         1 001757   100004 237100                    LDAQ    4,,PR1
         1 001760   200031 755100                    STA     OSTA,,AUTO
         1 001761   200032 756100                    STQ     OSTA+1,,AUTO
         1 001762   001767 710000 1                  TRA     s:9304

      725     9303    3             ELSE OSTA=MYMBLK$->KQ$MBLK.KEY1 ;

   9303  1 001763   200040 471500                    LDP1    MYMBLK$,,AUTO
         1 001764   100002 237100                    LDAQ    2,,PR1
         1 001765   200031 755100                    STA     OSTA,,AUTO
         1 001766   200032 756100                    STQ     OSTA+1,,AUTO

      726     9304    3             CALL KQB$SRCH (KQ$TTREE,OSTA,MTYP$)

   9304  1 001767   200035 633500                    EPPR3   MTYP$,,AUTO
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:126  
         1 001770   200072 453500                    STP3    RBSTATE+6,,AUTO
         1 001771   200031 634500                    EPPR4   OSTA,,AUTO
         1 001772   200071 454500                    STP4    RBSTATE+5,,AUTO
         1 001773   200010 236100                    LDQ     CG$,,AUTO
         1 001774   000067 036003                    ADLQ    55,DU
         1 001775   200070 756100                    STQ     RBSTATE+4,,AUTO
         1 001776   200070 630500                    EPPR0   RBSTATE+4,,AUTO
         1 001777   000021 631400 xsym               EPPR1   B_VECTNIL+17
         1 002000   000000 701000 xent               TSX1    KQB$SRCH
         1 002001   002005 702000 1                  TSX2    s:9309

      727     9305    4             WHENRETURN DO;

      728     9306    4               MTYP$->KQ$MTYP.NUMWRITES = MTYP$->KQ$MTYP.NUMWRITES - 1;

   9306  1 002002   200035 470500                    LDP0    MTYP$,,AUTO
         1 002003   000001 336007                    LCQ     1,DL
         1 002004   000010 056100                    ASQ     8,,PR0

      729     9307    4               END;

      730     9308    3             END;

      731     9309    2           CALL KQU$DELMSG (CG$->KQ$CG,MYMBLK$->KQ$MBLK);

   9309  1 002005   200040 236100                    LDQ     MYMBLK$,,AUTO
         1 002006   200010 235100                    LDA     CG$,,AUTO
         1 002007   200070 757100                    STAQ    RBSTATE+4,,AUTO
         1 002010   200070 630500                    EPPR0   RBSTATE+4,,AUTO
         1 002011   000020 631400 xsym               EPPR1   B_VECTNIL+16
         1 002012   000000 701000 xent               TSX1    KQU$DELMSG
         1 002013   000000 011000                    NOP     0

      732     9310    2           END;

      733     9311    1         GOTO BADCOMP;

PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:127  
   9311  1 002014   002034 710000 1                  TRA     BADCOMP

   9310  1 002015                       BWCKEYT      null
      734     9312    1   BWCKEYT:;
      735     9313              %UNLOCK (G=KQ$TTREE.GATE);

   9314  1 002015   200010 236100                    LDQ     CG$,,AUTO
         1 002016   000067 036003                    ADLQ    55,DU
         1 002017   200070 756100                    STQ     RBSTATE+4,,AUTO
         1 002020   200070 630500                    EPPR0   RBSTATE+4,,AUTO
         1 002021   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 002022   000000 701000 xent               TSX1    HFC$UNLOCK
         1 002023   000000 011000                    NOP     0

   9310  1 002024                       BWCKEY       null
      736     9316    1   BWCKEY:;
      737     9317    1         WRQ$->N$REQ.TYC=%TYC_CGKEYV;

   9317  1 002024   000006 236000 0                  LDQ     6
         1 002025   200037 470500                    LDP0    WRQ$,,AUTO
         1 002026   000021 756100                    STQ     17,,PR0

      738     9318    1         GOTO BWDELMSG;

   9318  1 002027   001742 710000 1                  TRA     BWDELMSG

   9317  1 002030                       BWCTYC       null
      739     9319    1   BWCTYC:;
      740     9320    1         WRQ$->N$REQ.TYC=TYC;

   9320  1 002030   200034 236100                    LDQ     TYC,,AUTO
         1 002031   200037 470500                    LDP0    WRQ$,,AUTO
         1 002032   000021 756100                    STQ     17,,PR0

      741     9321    1         GOTO BWDELMSG;

   9321  1 002033   001742 710000 1                  TRA     BWDELMSG
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:128  

   9320  1 002034                       BADCOMP      null
      742     9322    1   BADCOMP: ;
      743     9323    1         CALL NIO$COMPCNS (WRQ$->N$REQ);

   9323  1 002034   200037 630500                    EPPR0   WRQ$,,AUTO
         1 002035   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 002036   000000 701000 xent               TSX1    NIO$COMPCNS
         1 002037   000000 011000                    NOP     0

      744     9324    1         RETURN;

   9324  1 002040   000000 702200 xent               TSX2  ! X66_ARET

      745     9325    1   DESTUL: PROC;

   9325  1 002041   200060 741300       DESTUL       STX1  ! @M$+1,,AUTO

      746     9326    2         IF DEST > 0 THEN

   9326  1 002042   200044 235100                    LDA     DEST,,AUTO
         1 002043   002054 604400 1                  TMOZ    s:9332

      747     9327    3           DO;

      748     9328                %UNLOCK (G=DSTA$->KQ$STA.GATE);

   9329  1 002044   200036 236100                    LDQ     DSTA$,,AUTO
         1 002045   000016 036003                    ADLQ    14,DU
         1 002046   200070 756100                    STQ     RBSTATE+4,,AUTO
         1 002047   200070 630500                    EPPR0   RBSTATE+4,,AUTO
         1 002050   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 002051   000000 701000 xent               TSX1    HFC$UNLOCK
         1 002052   000000 011000                    NOP     0

      749     9331    3           END;

PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:129  
   9331  1 002053   002064 710000 1                  TRA     s:9338

      750     9332    2         ELSE IF DEST < 0 THEN

   9332  1 002054   002064 605000 1                  TPL     s:9338

      751     9333    3            DO;

      752     9334                 %UNLOCK (G=KQ$QTREE.GATE);

   9335  1 002055   200010 470500                    LDP0    CG$,,AUTO
         1 002056   000057 471500                    LDP1    47,,PR0
         1 002057   200070 451500                    STP1    RBSTATE+4,,AUTO
         1 002060   200070 630500                    EPPR0   RBSTATE+4,,AUTO
         1 002061   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 002062   000000 701000 xent               TSX1    HFC$UNLOCK
         1 002063   000000 011000                    NOP     0

      753     9337    3            END;

      754     9338    2         DEST=0;

   9338  1 002064   200044 450100                    STZ     DEST,,AUTO

      755     9339    2         RETURN;

   9339  1 002065   200060 221300                    LDX1  ! @M$+1,,AUTO
         1 002066   000001 702211                    TSX2  ! 1,X1

      756     9340    2   END DESTUL;
      757     9341        %EJECT;
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:130  
      758     9342        /**/
      759     9343        /*F* NAME:         KQW$SEND
      760     9344             PURPOSE:      To dispatch an output message on behalf of a station
      761     9345             CALL:         KQW$SEND (KQ$STA)
      762     9346             DESCRIPTION:  The message to be sent is pointed to by KQ$STA.MBLK$,
      763     9347                           and already has all its data in the comgroup, has
      764     9348                           a MID allocated, etc.
      765     9349                           If the message cannot be delivered, due to illegal
      766     9350                           due to illegal msg type or destination station, it is
      767     9351                           simply discarded, and we ALTRET.
      768     9352        */
      769     9353    1   KQW$SEND: ENTRY (N$WREQ) ALTRET;

   9353  1 002067   000000 700200 xent  KQW$SEND     TSX0  ! X66_AUTO_1
         1 002070   000100 000001                    ZERO    64,1

      770     9354        /**/
      771     9355    1         STA$=ADDR(N$WREQ);

   9355  1 002071   200003 236100                    LDQ     @N$WREQ,,AUTO
         1 002072   200005 756100                    STQ     STA$,,AUTO

      772     9356    1         CG$=STA$->KQ$STA.CG$;

   9356  1 002073   200005 470500                    LDP0    STA$,,AUTO
         1 002074   000007 236100                    LDQ     7,,PR0
         1 002075   200010 756100                    STQ     CG$,,AUTO

      773     9357    1         WAS=CG$->KQ$CG.AUCTL.WAS;

   9357  1 002076   200010 471500                    LDP1    CG$,,AUTO
         1 002077   100133 236100                    LDQ     91,,PR1
         1 002100   000040 736000                    QLS     32
         1 002101   400000 376003                    ANQ     -131072,DU
         1 002102   200015 756100                    STQ     WAS,,AUTO

   9357  1 002103                       SEND0        null
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:131  
      774     9358    1   SEND0:;
      775     9359    1         MTYP$=ADDR(NIL);

   9359  1 002103   000001 236000 xsym               LDQ     B_VECTNIL+1
         1 002104   200035 756100                    STQ     MTYP$,,AUTO

      776     9360    1         STA$->KQ$STA.MBLK$->KQ$MBLK.LNK$=ADDR(NIL);

   9360  1 002105   200005 470500                    LDP0    STA$,,AUTO
         1 002106   000012 471500                    LDP1    10,,PR0
         1 002107   100000 756100                    STQ     0,,PR1

      777     9361    1         CALL SENDMSG (STA$->KQ$STA.MBLK$) ALTRET(ALTRT);

   9361  1 002110   200005 236100                    LDQ     STA$,,AUTO
         1 002111   000012 036003                    ADLQ    10,DU
         1 002112   200057 756100                    STQ     FOUND+2,,AUTO
         1 002113   004070 701000 1                  TSX1    SENDMSG
         1 002114   002116 702000 1                  TSX2    ALTRT

   9360  1 002115                       RTN          null
      778     9362    1   RTN:  ;
      779     9363    1         RETURN;

   9363  1 002115   000000 702200 xent               TSX2  ! X66_ARET

   9360  1 002116                       ALTRT        null
      780     9364    1   ALTRT:;
      781     9365    1         ALTRETURN;

   9365  1 002116   000000 702200 xent               TSX2  ! X66_AALT

      782     9366        /**/
      783     9367        /*F* NAME:         KQW$SENDNA
      784     9368             PURPOSE:      To dispatch an output message on behalf of a station
      785     9369             DESCRIPTION:  Just like KQW$SEND but always dumps the message
      786     9370                           if the recipient is not there, regardless of
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:132  
      787     9371                           KQ$CG.AUCTL.WAS.
      788     9372        */
      789     9373    1   KQW$SENDNA: ENTRY (N$WREQ) ALTRET;

   9373  1 002117   000000 700200 xent  KQW$SENDNA   TSX0  ! X66_AUTO_1
         1 002120   000100 000001                    ZERO    64,1

      790     9374        /**/
      791     9375    1         WAS='0'B;

   9375  1 002121   200015 450100                    STZ     WAS,,AUTO

   9375  1 002122                       SEND00       null
      792     9376    1   SEND00:;
      793     9377    1         STA$=ADDR(N$WREQ);

   9377  1 002122   200003 236100                    LDQ     @N$WREQ,,AUTO
         1 002123   200005 756100                    STQ     STA$,,AUTO

      794     9378    1         CG$=STA$->KQ$STA.CG$;

   9378  1 002124   200005 470500                    LDP0    STA$,,AUTO
         1 002125   000007 236100                    LDQ     7,,PR0
         1 002126   200010 756100                    STQ     CG$,,AUTO

      795     9379    1         GOTO SEND0;

   9379  1 002127   002103 710000 1                  TRA     SEND0

      796     9380        /**/
      797     9381        /*F* NAME:         KQW$SENDAUP
      798     9382             PURPOSE:      To dispatch an output message on behalf of a station
      799     9383             DESCRIPTION:  Like KQW$SEND but forces AUP (but not WAS)
      800     9384        */
      801     9385    1   KQW$SENDAUP: ENTRY (N$WREQ) ALTRET;

   9385  1 002130   000000 700200 xent  KQW$SENDAUP  TSX0  ! X66_AUTO_1
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:133  
         1 002131   000100 000001                    ZERO    64,1

      802     9386        /**/
      803     9387    1         STA$=ADDR(N$WREQ);

   9387  1 002132   200003 236100                    LDQ     @N$WREQ,,AUTO
         1 002133   200005 756100                    STQ     STA$,,AUTO

      804     9388    1         CG$=STA$->KQ$STA.CG$;

   9388  1 002134   200005 470500                    LDP0    STA$,,AUTO
         1 002135   000007 236100                    LDQ     7,,PR0
         1 002136   200010 756100                    STQ     CG$,,AUTO

      805     9389    1         WAS='01'B|CG$->KQ$CG.AUCTL.WAS;

   9389  1 002137   200010 471500                    LDP1    CG$,,AUTO
         1 002140   100133 236100                    LDQ     91,,PR1
         1 002141   000040 736000                    QLS     32
         1 002142   400000 376003                    ANQ     -131072,DU
         1 002143   200000 276003                    ORQ     65536,DU
         1 002144   200015 756100                    STQ     WAS,,AUTO

      806     9390    1         GOTO SEND0;

   9390  1 002145   002103 710000 1                  TRA     SEND0

      807     9391        %EJECT;
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:134  
      808     9392        /**/
      809     9393        /*F* NAME:         KQW$XMITSELF
      810     9394             PURPOSE:      To send delayed messages to a station
      811     9395             CALL:         KQW$XMITSELF (STA$) ALTRET(DONE)
      812     9396             INPUT:        Station gate locked
      813     9397             OUTPUT:       Station gate locked
      814     9398                           STA$->KQ$MLH.DELAYDQ$, a KQ$DPTR for non-message item
      815     9399                                              (RETURN only)
      816     9400             DESCRIPTION:  ALTRETs when the delay list is empty.
      817     9401                           RETURNs when a non-message delay item is
      818     9402                           found.
      819     9403
      820     9404                           Each message found is written to the station,
      821     9405                           either satisfying a read, or being merged into
      822     9406                           the MBLK list.
      823     9407        */
      824     9408    1   KQW$XMITSELF: ENTRY (N$WREQ) ALTRET; /* !!Doesn't ALTRET!! */

   9408  1 002146   000000 700200 xent  KQW$XMITSELF TSX0  ! X66_AUTO_1
         1 002147   000100 000001                    ZERO    64,1

      825     9409        /**/
      826     9410    1         STA$=ADDR(N$WREQ)->B$$PTR;

   9410  1 002150   200003 470500                    LDP0    @N$WREQ,,AUTO
         1 002151   000000 236100                    LDQ     0,,PR0
         1 002152   200005 756100                    STQ     STA$,,AUTO

      827     9411    1         CG$=STA$->KQ$STA.CG$;

   9411  1 002153   200005 471500                    LDP1    STA$,,AUTO
         1 002154   100007 236100                    LDQ     7,,PR1
         1 002155   200010 756100                    STQ     CG$,,AUTO

      828     9412    1         DSTA$=STA$;

   9412  1 002156   200005 236100                    LDQ     STA$,,AUTO
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:135  
         1 002157   200036 756100                    STQ     DSTA$,,AUTO

      829     9413    2           DO FOREVER;

      830     9414    2          CALL KQL$DELAYDQ (STA$->KQ$STA.MLH.DELAY$,STA$->KQ$STA.MLH.DELAYDQ$) ALTRET(
              9414                    ALTRT);

   9414  1 002160   200005 236100                    LDQ     STA$,,AUTO
         1 002161   000042 036003                    ADLQ    34,DU
         1 002162   200071 756100                    STQ     RBSTATE+5,,AUTO
         1 002163   200005 236100                    LDQ     STA$,,AUTO
         1 002164   000036 036003                    ADLQ    30,DU
         1 002165   200070 756100                    STQ     RBSTATE+4,,AUTO
         1 002166   200070 630500                    EPPR0   RBSTATE+4,,AUTO
         1 002167   000020 631400 xsym               EPPR1   B_VECTNIL+16
         1 002170   000000 701000 xent               TSX1    KQL$DELAYDQ
         1 002171   002116 702000 1                  TSX2    ALTRT

      831     9415    2           IF ADDR(STA$->KQ$STA.MLH.DELAYDQ$)->KQ$DPTR.X.FLGS

   9415  1 002172   200005 470500                    LDP0    STA$,,AUTO
         1 002173   000042 236100                    LDQ     34,,PR0
         1 002174   700000 316007                    CANQ    -32768,DL
         1 002175   002202 601000 1                  TNZ     s:9417
         1 002176   000042 236100                    LDQ     34,,PR0
         1 002177   070000 376007                    ANQ     28672,DL
         1 002200   010000 116007                    CMPQ    4096,DL
         1 002201   002203 600000 1                  TZE     s:9418

      832     9416    2           OR ADDR(STA$->KQ$STA.MLH.DELAYDQ$)->KQ$DPTR.X.CODE ~= KQRA_MBLK#
      833     9417    2           THEN RETURN;

   9417  1 002202   000000 702200 xent               TSX2  ! X66_ARET

      834     9418    2           ADDR(STA$->KQ$STA.MLH.DELAYDQ$)->KQ$DPTR.X='0'B;

   9418  1 002203   000000 236003                    LDQ     0,DU
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:136  
         1 002204   000042 752104                    STCQ    34,'04'O,PR0

      835     9419    2           CALL SENDMSGD1 (STA$->KQ$STA.MLH.DELAYDQ$) ALTRET(XMS1);

   9419  1 002205   200005 236100                    LDQ     STA$,,AUTO
         1 002206   000042 036003                    ADLQ    34,DU
         1 002207   200057 756100                    STQ     FOUND+2,,AUTO
         1 002210   004771 701000 1                  TSX1    SENDMSGD1
         1 002211   002221 702000 1                  TSX2    XMS1

      836     9420                %LOCK (G=STA$->KQ$STA.GATE);

   9421  1 002212   200005 236100                    LDQ     STA$,,AUTO
         1 002213   000016 036003                    ADLQ    14,DU
         1 002214   200070 756100                    STQ     RBSTATE+4,,AUTO
         1 002215   200070 630500                    EPPR0   RBSTATE+4,,AUTO
         1 002216   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 002217   000000 701000 xent               TSX1    HFC$LOCK
         1 002220   000000 011000                    NOP     0

      837     9423    2   XMS1:   END;

   9423  1 002221   002160 710000 1     XMS1         TRA     s:9414

      838     9424        /**/
      839     9425        /*F* NAME:         KQW$XMITQ
      840     9426             PURPOSE:      To send the queue's delayed list
      841     9427                           into the queue
      842     9428             CALL:         KQW$XMITQ (CG$) ALTRET(DONE)
      843     9429             INPUT:        Q-tree gate locked
      844     9430             OUTPUT:       Q-tree gate locked
      845     9431             DESCRIPTION:  Just like KQW$XMITSELF but for the anonymous
      846     9432                           queue.
      847     9433        */
      848     9434    1   KQW$XMITQ: ENTRY (N$WREQ) ALTRET; /* !!Doesn't ALTRET!! */

   9434  1 002222   000000 700200 xent  KQW$XMITQ    TSX0  ! X66_AUTO_1
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:137  
         1 002223   000100 000001                    ZERO    64,1

      849     9435        /**/
      850     9436    1         RCVR=0;

   9436  1 002224   200041 450100                    STZ     NEWDDA,,AUTO

   9436  1 002225                       XMITQCMN     null
      851     9437    1   XMITQCMN:;
      852     9438    1         CG$=ADDR(N$WREQ)->B$$PTR;

   9438  1 002225   200003 470500                    LDP0    @N$WREQ,,AUTO
         1 002226   000000 236100                    LDQ     0,,PR0
         1 002227   200010 756100                    STQ     CG$,,AUTO

      853     9439    2           DO FOREVER;

      854     9440    2           CALL KQL$DELAYDQ (KQ$QUEUE.DELAY$,KQ$QUEUE.DELAYDQ$) ALTRET(ALTRT);

   9440  1 002230   200010 236100                    LDQ     CG$,,AUTO
         1 002231   000064 036003                    ADLQ    52,DU
         1 002232   200071 756100                    STQ     RBSTATE+5,,AUTO
         1 002233   200010 236100                    LDQ     CG$,,AUTO
         1 002234   000062 036003                    ADLQ    50,DU
         1 002235   200070 756100                    STQ     RBSTATE+4,,AUTO
         1 002236   200070 630500                    EPPR0   RBSTATE+4,,AUTO
         1 002237   000020 631400 xsym               EPPR1   B_VECTNIL+16
         1 002240   000000 701000 xent               TSX1    KQL$DELAYDQ
         1 002241   002116 702000 1                  TSX2    ALTRT

      855     9441    2           IF ADDR(KQ$QUEUE.DELAYDQ$)->KQ$DPTR.X.CODE ~= KQRA_MBLK#

   9441  1 002242   200010 470500                    LDP0    CG$,,AUTO
         1 002243   000064 236100                    LDQ     52,,PR0
         1 002244   070000 376007                    ANQ     28672,DL
         1 002245   010000 116007                    CMPQ    4096,DL
         1 002246   002256 600000 1                  TZE     s:9450
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:138  

      856     9442    3           THEN DO;

      857     9443    3             IF RCVR = 1

   9443  1 002247   200041 235100                    LDA     NEWDDA,,AUTO
         1 002250   000001 115007                    CMPA    1,DL
         1 002251   002255 601000 1                  TNZ     s:9448

      858     9444    4             THEN DO;

      859     9445    4               KQ$QUEUE.DELAYDQ$=ADDR(NIL);

   9445  1 002252   000001 236000 xsym               LDQ     B_VECTNIL+1
         1 002253   000064 756100                    STQ     52,,PR0

      860     9446    4               GOTO XMITQ2;

   9446  1 002254   002330 710000 1                  TRA     XMITQ2

      861     9447    4               END;
      862     9448    3             RETURN;

   9448  1 002255   000000 702200 xent               TSX2  ! X66_ARET

      863     9449    3             END;
      864     9450    2           ADDR(KQ$QUEUE.DELAYDQ$)->KQ$DPTR.X='0'B;

   9450  1 002256   000000 236003                    LDQ     0,DU
         1 002257   000064 752104                    STCQ    52,'04'O,PR0

      865     9451    2          CALL KQB$SRCH (KQ$QTREE,KQ$QUEUE.DELAYDQ$->KQ$MBLK.KEY1,QTN$) ALTRET(XMITQ0)
              9451                    ;

   9451  1 002260   000057 471500                    LDP1    47,,PR0
         1 002261   000064 473500                    LDP3    52,,PR0
         1 002262   200033 634500                    EPPR4   QTN$,,AUTO
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:139  
         1 002263   200072 454500                    STP4    RBSTATE+6,,AUTO
         1 002264   300002 635500                    EPPR5   2,,PR3
         1 002265   200071 455500                    STP5    RBSTATE+5,,AUTO
         1 002266   200070 451500                    STP1    RBSTATE+4,,AUTO
         1 002267   200070 630500                    EPPR0   RBSTATE+4,,AUTO
         1 002270   000021 631400 xsym               EPPR1   B_VECTNIL+17
         1 002271   000000 701000 xent               TSX1    KQB$SRCH
         1 002272   002301 702000 1                  TSX2    XMITQ0

      866     9452    2           CALL SENDMSGQ1 (KQ$QUEUE.DELAYDQ$);

   9452  1 002273   200010 236100                    LDQ     CG$,,AUTO
         1 002274   000064 036003                    ADLQ    52,DU
         1 002275   200057 756100                    STQ     FOUND+2,,AUTO
         1 002276   005120 701000 1                  TSX1    SENDMSGQ1
         1 002277   000000 011000                    NOP     0

      867     9453    2           GOTO XMITQ1;

   9453  1 002300   002321 710000 1                  TRA     XMITQ1

      868     9454    2   XMITQ0: ;

   9454  1 002301                       XMITQ0       null
      869     9455    2           CG$->KQ$CG.STATS.CCMQ=CG$->KQ$CG.STATS.CCMQ-1;

   9455  1 002301   200010 470500                    LDP0    CG$,,AUTO
         1 002302   000001 336007                    LCQ     1,DL
         1 002303   000171 056100                    ASQ     121,,PR0

      870     9456                %UNLOCK (G=KQ$QTREE.GATE);

   9457  1 002304   000057 471500                    LDP1    47,,PR0
         1 002305   200070 451500                    STP1    RBSTATE+4,,AUTO
         1 002306   200070 630500                    EPPR0   RBSTATE+4,,AUTO
         1 002307   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 002310   000000 701000 xent               TSX1    HFC$UNLOCK
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:140  
         1 002311   000000 011000                    NOP     0

      871     9459    2           CALL KQU$DELMSG (CG$->KQ$CG,P$->KQ$MBLK);

   9459  1 002312   200014 236100                    LDQ     P$,,AUTO
         1 002313   200010 235100                    LDA     CG$,,AUTO
         1 002314   200070 757100                    STAQ    RBSTATE+4,,AUTO
         1 002315   200070 630500                    EPPR0   RBSTATE+4,,AUTO
         1 002316   000020 631400 xsym               EPPR1   B_VECTNIL+16
         1 002317   000000 701000 xent               TSX1    KQU$DELMSG
         1 002320   000000 011000                    NOP     0

   9455  1 002321                       XMITQ1       null
      872     9460    2   XMITQ1: ;
      873     9461                %LOCK (G=KQ$QTREE.GATE);

   9462  1 002321   200010 470500                    LDP0    CG$,,AUTO
         1 002322   000057 471500                    LDP1    47,,PR0
         1 002323   200070 451500                    STP1    RBSTATE+4,,AUTO
         1 002324   200070 630500                    EPPR0   RBSTATE+4,,AUTO
         1 002325   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 002326   000000 701000 xent               TSX1    HFC$LOCK
         1 002327   000000 011000                    NOP     0

      874     9464    2   XMITQ2: END;

   9464  1 002330   002230 710000 1     XMITQ2       TRA     s:9440

      875     9465        /**/
      876     9466        /*F* NAME:         KQW$XMITQR
      877     9467             PURPOSE:      To send the queue's delay list into the queue
      878     9468                           during comgroup reopen
      879     9469             DESCRIPTION:  Just like KQW$XMITQ but ignores station read
      880     9470                           requests found on the delay list. */
      881     9471    1   KQW$XMITQR: ENTRY (N$WREQ) ALTRET;

   9471  1 002331   000000 700200 xent  KQW$XMITQR   TSX0  ! X66_AUTO_1
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:141  
         1 002332   000100 000001                    ZERO    64,1

      882     9472        /**/
      883     9473    1         RCVR=1;

   9473  1 002333   000001 235007                    LDA     1,DL
         1 002334   200041 755100                    STA     NEWDDA,,AUTO

      884     9474    1         GOTO XMITQCMN;

   9474  1 002335   002225 710000 1                  TRA     XMITQCMN

      885     9475        %EJECT;
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:142  
      886     9476        /**/
      887     9477        /*F* NAME:         KQW$HOLD
      888     9478             PURPOSE:      To put a message in 'hold'
      889     9479             CALL:         KQW$HOLD (KQ$STA)
      890     9480             INPUT:        Message is in KQ$STA.MBLK$
      891     9481             DESCRIPTION:  If KQ$CG.HOLDSTA$ is ADDR(NIL), deletes the
      892     9482                           msg; else writes it to that station, ignoring
      893     9483                           WAS and AUP.
      894     9484        */
      895     9485    1   KQW$HOLD: ENTRY (N$WREQ) ALTRET; /* !!Doesn't ALTRET!! */

   9485  1 002336   000000 700200 xent  KQW$HOLD     TSX0  ! X66_AUTO_1
         1 002337   000100 000001                    ZERO    64,1

      896     9486        /**/
      897     9487    1         STA$=ADDR(N$WREQ);

   9487  1 002340   200003 236100                    LDQ     @N$WREQ,,AUTO
         1 002341   200005 756100                    STQ     STA$,,AUTO

      898     9488    1         CG$=STA$->KQ$STA.CG$;

   9488  1 002342   200005 470500                    LDP0    STA$,,AUTO
         1 002343   000007 236100                    LDQ     7,,PR0
         1 002344   200010 756100                    STQ     CG$,,AUTO

      899     9489    1         P$=ADDR(CG$->KQ$CG.HOLDSTA$);

   9489  1 002345   000124 036003                    ADLQ    84,DU
         1 002346   200014 756100                    STQ     P$,,AUTO

      900     9490    1         MYMBLK$=STA$->KQ$STA.MBLK$;

   9490  1 002347   000012 236100                    LDQ     10,,PR0
         1 002350   200040 756100                    STQ     MYMBLK$,,AUTO

      901     9491    1         STA$->KQ$STA.MBLK$=ADDR(NIL);
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:143  

   9491  1 002351   000001 236000 xsym               LDQ     B_VECTNIL+1
         1 002352   000012 756100                    STQ     10,,PR0

   9491  1 002353                       HOLD0        null
      902     9492    1   HOLD0:;
      903     9493              %LOCK (G=KQ$STREE.GATE);

   9494  1 002353   200010 236100                    LDQ     CG$,,AUTO
         1 002354   000075 036003                    ADLQ    61,DU
         1 002355   200070 756100                    STQ     RBSTATE+4,,AUTO
         1 002356   200070 630500                    EPPR0   RBSTATE+4,,AUTO
         1 002357   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 002360   000000 701000 xent               TSX1    HFC$LOCK
         1 002361   000000 011000                    NOP     0

      904     9496    1         DSTA$=P$->B$$PTR;

   9496  1 002362   200014 470500                    LDP0    P$,,AUTO
         1 002363   000000 236100                    LDQ     0,,PR0
         1 002364   200036 756100                    STQ     DSTA$,,AUTO

      905     9497    1         IF DSTA$ = ADDR(NIL) THEN

   9497  1 002365   000001 116000 xsym               CMPQ    B_VECTNIL+1
         1 002366   002406 601000 1                  TNZ     s:9506

      906     9498    2           DO;

      907     9499                %UNLOCK (G=KQ$STREE.GATE);

   9500  1 002367   200010 236100                    LDQ     CG$,,AUTO
         1 002370   000075 036003                    ADLQ    61,DU
         1 002371   200070 756100                    STQ     RBSTATE+4,,AUTO
         1 002372   200070 630500                    EPPR0   RBSTATE+4,,AUTO
         1 002373   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 002374   000000 701000 xent               TSX1    HFC$UNLOCK
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:144  
         1 002375   000000 011000                    NOP     0

      908     9502    2           CALL KQU$DELMSG (CG$->KQ$CG,MYMBLK$->KQ$MBLK);

   9502  1 002376   200040 236100                    LDQ     MYMBLK$,,AUTO
         1 002377   200010 235100                    LDA     CG$,,AUTO
         1 002400   200070 757100                    STAQ    RBSTATE+4,,AUTO
         1 002401   200070 630500                    EPPR0   RBSTATE+4,,AUTO
         1 002402   000020 631400 xsym               EPPR1   B_VECTNIL+16
         1 002403   000000 701000 xent               TSX1    KQU$DELMSG
         1 002404   000000 011000                    NOP     0

      909     9503    2           RETURN;

   9503  1 002405   000000 702200 xent               TSX2  ! X66_ARET

      910     9504    2           END;
      911     9505              %LOCK (G=DSTA$->KQ$STA.GATE);

   9506  1 002406   000016 036003                    ADLQ    14,DU
         1 002407   200070 756100                    STQ     RBSTATE+4,,AUTO
         1 002410   200070 630500                    EPPR0   RBSTATE+4,,AUTO
         1 002411   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 002412   000000 701000 xent               TSX1    HFC$LOCK
         1 002413   000000 011000                    NOP     0

      912     9508              %UNLOCK (G=KQ$STREE.GATE);

   9509  1 002414   200010 236100                    LDQ     CG$,,AUTO
         1 002415   000075 036003                    ADLQ    61,DU
         1 002416   200070 756100                    STQ     RBSTATE+4,,AUTO
         1 002417   200070 630500                    EPPR0   RBSTATE+4,,AUTO
         1 002420   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 002421   000000 701000 xent               TSX1    HFC$UNLOCK
         1 002422   000000 011000                    NOP     0

      913     9511    1         CALL SENDMSGD (MYMBLK$);
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:145  

   9511  1 002423   200040 630500                    EPPR0   MYMBLK$,,AUTO
         1 002424   200057 450500                    STP0    FOUND+2,,AUTO
         1 002425   004764 701000 1                  TSX1    SENDMSGD
         1 002426   000000 011000                    NOP     0

      914     9512    1         RETURN;

   9512  1 002427   000000 702200 xent               TSX2  ! X66_ARET

      915     9513        /**/
      916     9514        /*F* NAME:         KQW$JNLD
      917     9515             PURPOSE:      To send a journal delete message to the
      918     9516                           JOURNAL station
      919     9517             CALL:         KQW$JNLD (KQ$STA)
      920     9518             INPUT:        Message is in KQ$STA.MBLK$
      921     9519                           KQ$STA.GATE is locked.
      922     9520             DESCRIPTION:  If KQ$CG.HOLDSTA$ is ADDR(NIL), deletes the
      923     9521                           message; else writes it to that station,
      924     9522                           ignoring WAS and AUP.
      925     9523        */
      926     9524    1   KQW$JNLD: ENTRY (N$WREQ) ALTRET; /* !!Doesn't ALTRET!! */

   9524  1 002430   000000 700200 xent  KQW$JNLD     TSX0  ! X66_AUTO_1
         1 002431   000100 000001                    ZERO    64,1

      927     9525        /**/
      928     9526    1         STA$=ADDR(N$WREQ);

   9526  1 002432   200003 236100                    LDQ     @N$WREQ,,AUTO
         1 002433   200005 756100                    STQ     STA$,,AUTO

      929     9527    1         CG$=STA$->KQ$STA.CG$;

   9527  1 002434   200005 470500                    LDP0    STA$,,AUTO
         1 002435   000007 236100                    LDQ     7,,PR0
         1 002436   200010 756100                    STQ     CG$,,AUTO
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:146  

      930     9528    1         P$=ADDR(CG$->KQ$CG.JRNLSTA$);

   9528  1 002437   000210 036003                    ADLQ    136,DU
         1 002440   200014 756100                    STQ     P$,,AUTO

      931     9529    1         MYMBLK$=STA$->KQ$STA.MBLK$;

   9529  1 002441   000012 236100                    LDQ     10,,PR0
         1 002442   200040 756100                    STQ     MYMBLK$,,AUTO

      932     9530    1         STA$->KQ$STA.MBLK$=ADDR(NIL);

   9530  1 002443   000001 236000 xsym               LDQ     B_VECTNIL+1
         1 002444   000012 756100                    STQ     10,,PR0

      933     9531              %UNLOCK (G=STA$->KQ$STA.GATE);

   9532  1 002445   200005 236100                    LDQ     STA$,,AUTO
         1 002446   000016 036003                    ADLQ    14,DU
         1 002447   200070 756100                    STQ     RBSTATE+4,,AUTO
         1 002450   200070 630500                    EPPR0   RBSTATE+4,,AUTO
         1 002451   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 002452   000000 701000 xent               TSX1    HFC$UNLOCK
         1 002453   000000 011000                    NOP     0

      934     9534    1         GOTO HOLD0;

   9534  1 002454   002353 710000 1                  TRA     HOLD0

      935     9535        /**/
      936     9536        /*F* NAME:         KQW$TELLAU
      937     9537             PURPOSE:      To send a message to the AU
      938     9538             CALL:         KQW$TELLAU (KQ$CG.GORGOSTA$->KQ$STA)
      939     9539             INPUT:        GORGOSTA gate locked
      940     9540                           GORGOSTA.MBLK$ is the message to send
      941     9541             DESCRIPTION:  If the destination is '*GORGO' then
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:147  
      942     9542                           a SENDF is simulated, else a SENDNA is
      943     9543                           simulated.
      944     9544        */
      945     9545    1   KQW$TELLAU: ENTRY (N$WREQ) ALTRET;

   9545  1 002455   000000 700200 xent  KQW$TELLAU   TSX0  ! X66_AUTO_1
         1 002456   000100 000001                    ZERO    64,1

      946     9546        /**/
      947     9547    1         STA$=ADDR(N$WREQ);

   9547  1 002457   200003 236100                    LDQ     @N$WREQ,,AUTO
         1 002460   200005 756100                    STQ     STA$,,AUTO

      948     9548    1         CG$=STA$->KQ$STA.CG$;

   9548  1 002461   200005 470500                    LDP0    STA$,,AUTO
         1 002462   000007 236100                    LDQ     7,,PR0
         1 002463   200010 756100                    STQ     CG$,,AUTO

      949     9549    1         MYMBLK$=STA$->KQ$STA.MBLK$;

   9549  1 002464   000012 236100                    LDQ     10,,PR0
         1 002465   200040 756100                    STQ     MYMBLK$,,AUTO

      950     9550    1         STA$->KQ$STA.MBLK$=ADDR(NIL);

   9550  1 002466   000001 236000 xsym               LDQ     B_VECTNIL+1
         1 002467   000012 756100                    STQ     10,,PR0

      951     9551              %UNLOCK (G=STA$->KQ$STA.GATE);

   9552  1 002470   200005 236100                    LDQ     STA$,,AUTO
         1 002471   000016 036003                    ADLQ    14,DU
         1 002472   200070 756100                    STQ     RBSTATE+4,,AUTO
         1 002473   200070 630500                    EPPR0   RBSTATE+4,,AUTO
         1 002474   000017 631400 xsym               EPPR1   B_VECTNIL+15
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:148  
         1 002475   000000 701000 xent               TSX1    HFC$UNLOCK
         1 002476   000000 011000                    NOP     0

      952     9554    1         MTYP$=ADDR(NIL);

   9554  1 002477   000001 236000 xsym               LDQ     B_VECTNIL+1
         1 002500   200035 756100                    STQ     MTYP$,,AUTO

      953     9555    1         MYMBLK$->KQ$MBLK.LNK$=ADDR(NIL);

   9555  1 002501   200040 470500                    LDP0    MYMBLK$,,AUTO
         1 002502   000000 756100                    STQ     0,,PR0

      954     9556    1         IF MYMBLK$->KQ$MBLK.DSTA = '*GORGO' THEN

   9556  1 002503   200040 470500                    LDP0    MYMBLK$,,AUTO
         1 002504   040000 106500                    CMPC    fill='040'O
         1 002505   000011 000010                    ADSC9   9,,PR0                   cn=0,n=8
         1 002506   000007 000006 0                  ADSC9   7                        cn=0,n=6
         1 002507   002513 601000 1                  TNZ     s:9558

      955     9557    1          WAS='11'B;

   9557  1 002510   600000 236003                    LDQ     -65536,DU
         1 002511   200015 756100                    STQ     WAS,,AUTO
         1 002512   002514 710000 1                  TRA     s:9559

      956     9558    1         ELSE WAS='0'B;

   9558  1 002513   200015 450100                    STZ     WAS,,AUTO

      957     9559    1         CALL SENDMSG (MYMBLK$) ALTRET(ALTRT);

   9559  1 002514   200040 631500                    EPPR1   MYMBLK$,,AUTO
         1 002515   200057 451500                    STP1    FOUND+2,,AUTO
         1 002516   004070 701000 1                  TSX1    SENDMSG
         1 002517   002116 702000 1                  TSX2    ALTRT
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:149  

      958     9560    1         RETURN;

   9560  1 002520   000000 702200 xent               TSX2  ! X66_ARET

      959     9561        %EJECT;
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:150  
      960     9562        /**/
      961     9563        /*********************************************************************************
      962     9564        *                                                                                *
      963     9565        *   SSS   U   U  BBBB   RRRR    OOO   U   U  TTTTT   III   N   N  EEEEE   SSS    *
      964     9566        *  S   S  U   U  B   B  R   R  O O O  U   U    T      I    N   N  E      S   S   *
      965     9567        *  S      U   U  B   B  R   R  O O O  U   U    T      I    NN  N  E      S       *
      966     9568        *   SSS   U   U  BBBB   RRRR   O  OO  U   U    T      I    N N N  EEEE    SSS    *
      967     9569        *      S  U   U  B   B  R R    O   O  U   U    T      I    N  NN  E          S   *
      968     9570        *  S   S  U   U  B   B  R  R   O   O  U   U    T      I    N   N  E      S   S   *
      969     9571        *   SSS    UUU   BBBB   R   R   OOO    UUU     T     III   N   N  EEEEE   SSS    *
      970     9572        *                                                                                *
      971     9573        *********************************************************************************/
      972     9574
      973     9575        /****************************************************************
      974     9576        *****************************************************************/
      975     9577        /*D* NAME:         GETMBLK
      976     9578             PURPOSE:      To get an MBLK
      977     9579             DESCRIPTION:  Gets an MBLK as MBLK$ and sets up MYMBLK$.
      978     9580                           If none, ALTRETs with correct TYC.
      979     9581        */
      980     9582    1   GETMBLK: PROC ALTRET;

   9582  1 002521   200056 741300       GETMBLK      STX1  ! FOUND+1,,AUTO

      981     9583        /**/
      982     9584    2   DCL T$ PTR;
      983     9585        /**/
      984     9586    2         CALL KQM$GETMBLK (CG$->KQ$CG,T$,DDA) ALTRET(W0);

   9586  1 002522   200030 630500                    EPPR0   DDA,,AUTO
         1 002523   200072 450500                    STP0    RBSTATE+6,,AUTO
         1 002524   200057 631500                    EPPR1   T$,,AUTO
         1 002525   200071 451500                    STP1    RBSTATE+5,,AUTO
         1 002526   200010 236100                    LDQ     CG$,,AUTO
         1 002527   200070 756100                    STQ     RBSTATE+4,,AUTO
         1 002530   200070 630500                    EPPR0   RBSTATE+4,,AUTO
         1 002531   000021 631400 xsym               EPPR1   B_VECTNIL+17
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:151  
         1 002532   000000 701000 xent               TSX1    KQM$GETMBLK
         1 002533   002535 702000 1                  TSX2    W0

      985     9587    2         GOTO W1;

   9587  1 002534   002640 710000 1                  TRA     W1

      986     9588    2   W0:   IF STA$->KQ$STA.MONDCB THEN

   9588  1 002535   200005 470500       W0           LDP0    STA$,,AUTO
         1 002536   000020 236100                    LDQ     16,,PR0
         1 002537   100000 316003                    CANQ    32768,DU
         1 002540   002622 600000 1                  TZE     s:9599

      987     9589    3           DO;

      988     9590    3           IF S_CUN = 0 OR S_TIMR = 2 THEN GOTO BWCFULL;

   9590  1 002541   000000 235000 xsym               LDA     S_CUN
         1 002542   002645 600000 1                  TZE     BWCFULL
         1 002543   000000 235000 xsym               LDA     S_TIMR
         1 002544   000002 115007                    CMPA    2,DL
         1 002545   002645 600000 1                  TZE     BWCFULL

      989     9591    3           I=SIZEW(KQ$MBLK);

   9591  1 002546   000020 235007                    LDA     16,DL
         1 002547   200046 755100                    STA     I,,AUTO

      990     9592    3           CALL KQM$GETBK (CG$->KQ$CG,T$,I) ALTRET(MD1);

   9592  1 002550   200046 631500                    EPPR1   I,,AUTO
         1 002551   200072 451500                    STP1    RBSTATE+6,,AUTO
         1 002552   200057 633500                    EPPR3   T$,,AUTO
         1 002553   200071 453500                    STP3    RBSTATE+5,,AUTO
         1 002554   200010 236100                    LDQ     CG$,,AUTO
         1 002555   200070 756100                    STQ     RBSTATE+4,,AUTO
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:152  
         1 002556   200070 630500                    EPPR0   RBSTATE+4,,AUTO
         1 002557   000021 631400 xsym               EPPR1   B_VECTNIL+17
         1 002560   000000 701000 xent               TSX1    KQM$GETBK
         1 002561   002576 702000 1                  TSX2    MD1

      991     9593    3           I=SIZEW(KQ$MBLK);

   9593  1 002562   000020 235007                    LDA     16,DL
         1 002563   200046 755100                    STA     I,,AUTO

      992     9594    3           CALL KQM$RELB (CG$->KQ$CG,T$,I);

   9594  1 002564   200046 630500                    EPPR0   I,,AUTO
         1 002565   200072 450500                    STP0    RBSTATE+6,,AUTO
         1 002566   200057 631500                    EPPR1   T$,,AUTO
         1 002567   200071 451500                    STP1    RBSTATE+5,,AUTO
         1 002570   200010 236100                    LDQ     CG$,,AUTO
         1 002571   200070 756100                    STQ     RBSTATE+4,,AUTO
         1 002572   200070 630500                    EPPR0   RBSTATE+4,,AUTO
         1 002573   000021 631400 xsym               EPPR1   B_VECTNIL+17
         1 002574   000000 701000 xent               TSX1    KQM$RELB
         1 002575   000000 011000                    NOP     0

      993     9595    3   MD1:    CALL SSR$REG (%SS_SL,,1);

   9595  1 002576   000010 236000 2     MD1          LDQ     8
         1 002577   200072 756100                    STQ     RBSTATE+6,,AUTO
         1 002600   000001 236000 xsym               LDQ     B_VECTNIL+1
         1 002601   000011 235000 2                  LDA     9
         1 002602   200070 757100                    STAQ    RBSTATE+4,,AUTO
         1 002603   200070 630500                    EPPR0   RBSTATE+4,,AUTO
         1 002604   000021 631400 xsym               EPPR1   B_VECTNIL+17
         1 002605   000000 701000 xent               TSX1    SSR$REG
         1 002606   000000 011000                    NOP     0

      994     9596    3           CALL KQM$GETMBLK (CG$->KQ$CG,T$,I) ALTRET(BWCFULL);

PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:153  
   9596  1 002607   200046 630500                    EPPR0   I,,AUTO
         1 002610   200072 450500                    STP0    RBSTATE+6,,AUTO
         1 002611   200057 631500                    EPPR1   T$,,AUTO
         1 002612   200071 451500                    STP1    RBSTATE+5,,AUTO
         1 002613   200010 236100                    LDQ     CG$,,AUTO
         1 002614   200070 756100                    STQ     RBSTATE+4,,AUTO
         1 002615   200070 630500                    EPPR0   RBSTATE+4,,AUTO
         1 002616   000021 631400 xsym               EPPR1   B_VECTNIL+17
         1 002617   000000 701000 xent               TSX1    KQM$GETMBLK
         1 002620   002645 702000 1                  TSX2    BWCFULL

      995     9597    3           GOTO W1;

   9597  1 002621   002640 710000 1                  TRA     W1

      996     9598    3           END;
      997     9599    2         I=KQMR_MBLK#;

   9599  1 002622   000001 235007                    LDA     1,DL
         1 002623   200046 755100                    STA     I,,AUTO

      998     9600    2         T$=STA$;

   9600  1 002624   200005 236100                    LDQ     STA$,,AUTO
         1 002625   200057 756100                    STQ     T$,,AUTO

      999     9601    2         CALL KQM$GETBR (CG$->KQ$CG,T$,I) ALTRET(BWCFULL);

   9601  1 002626   200046 631500                    EPPR1   I,,AUTO
         1 002627   200072 451500                    STP1    RBSTATE+6,,AUTO
         1 002630   200057 633500                    EPPR3   T$,,AUTO
         1 002631   200071 453500                    STP3    RBSTATE+5,,AUTO
         1 002632   200010 236100                    LDQ     CG$,,AUTO
         1 002633   200070 756100                    STQ     RBSTATE+4,,AUTO
         1 002634   200070 630500                    EPPR0   RBSTATE+4,,AUTO
         1 002635   000021 631400 xsym               EPPR1   B_VECTNIL+17
         1 002636   000000 701000 xent               TSX1    KQM$GETBR
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:154  
         1 002637   002645 702000 1                  TSX2    BWCFULL

     1000     9602    2   W1:   MYMBLK$=T$;

   9602  1 002640   200057 236100       W1           LDQ     T$,,AUTO
         1 002641   200040 756100                    STQ     MYMBLK$,,AUTO

     1001     9603    2         MBLK$=T$;

   9603  1 002642   200007 756100                    STQ     MBLK$,,AUTO

     1002     9604    2         RETURN;

   9604  1 002643   200056 221300                    LDX1  ! FOUND+1,,AUTO
         1 002644   000001 702211                    TSX2  ! 1,X1

   9603  1 002645                       BWCFULL      null
     1003     9605    2   BWCFULL:;
     1004     9606    2         MYMBLK$=ADDR(NIL);

   9606  1 002645   000001 236000 xsym               LDQ     B_VECTNIL+1
         1 002646   200040 756100                    STQ     MYMBLK$,,AUTO

     1005     9607    2         TYC=%TYC_CGFULL;

   9607  1 002647   000004 236000 0                  LDQ     4
         1 002650   200034 756100                    STQ     TYC,,AUTO

     1006     9608    2         ALTRETURN;

   9608  1 002651   200056 221300                    LDX1  ! FOUND+1,,AUTO
         1 002652   000000 702211                    TSX2  ! 0,X1

     1007     9609    2   END GETMBLK;
     1008     9610        /****************************************************************
     1009     9611        *****************************************************************/
     1010     9612        /*D* NAME:         FILLDBLK
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:155  
     1011     9613             PURPOSE:      To place the msg data in the DBLK
     1012     9614             DESCRIPTION:  DBLK$ points to the DBLK, BUFSZ is the buffer size.
     1013     9615                           VFC is 0 unless VFC char is in MBLK$->KQ$MBLK.DVE.VFC,
     1014     9616                           in which case VFC is 1 and BUFSZ includes it.
     1015     9617                           ALTRETs with TYC set if no good.
     1016     9618        */
     1017     9619    1   FILLDBLK: PROC ALTRET;

   9619  1 002653   200056 741300       FILLDBLK     STX1  ! FOUND+1,,AUTO

     1018     9620    2         CALL HFF$TRAPALT ALTRET(BWCBUFU);

   9620  1 002654   000002 631400 xsym               EPPR1   B_VECTNIL+2
         1 002655   000000 701000 xent               TSX1    HFF$TRAPALT
         1 002656   002735 702000 1                  TSX2    BWCBUFU

     1019     9621    2         IF VFC ~= 0 THEN

   9621  1 002657   200045 235100                    LDA     VFC,,AUTO
         1 002660   002705 600000 1                  TZE     s:9629

     1020     9622    3           DO;

     1021     9623    3           BUFSZ=BUFSZ-1;

   9623  1 002661   200027 236100                    LDQ     BUFSZ,,AUTO
         1 002662   000001 136007                    SBLQ    1,DL
         1 002663   200027 756100                    STQ     BUFSZ,,AUTO

     1022     9624    3           PINCRC(DBLK$,SIZEC(KQ$DBLK))->B$$CHAR=MBLK$->KQ$MBLK.DVE.VFC;

   9624  1 002664   200007 470500                    LDP0    MBLK$,,AUTO
         1 002665   200026 471500                    LDP1    DBLK$,,AUTO
         1 002666   040100 100500                    MLR     fill='040'O
         1 002667   000010 400001                    ADSC9   8,,PR0                   cn=2,n=1
         1 002670   100006 000001                    ADSC9   6,,PR1                   cn=0,n=1

PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:156  
     1023     9625    3           PINCRC(DBLK$,SIZEC(KQ$DBLK)+1)->B$$BUFCHARS=WRQ$->N$REQ.BUF$->B$$BUFCHARS;

   9625  1 002671   200037 471500                    LDP1    WRQ$,,AUTO
         1 002672   100005 473500                    LDP3    5,,PR1
         1 002673   000000 620006                    EAX0    0,QL
         1 002674   200026 474500                    LDP4    DBLK$,,AUTO
         1 002675   200027 721100                    LXL1    BUFSZ,,AUTO
         1 002676   040140 100540                    MLR     fill='040'O
         1 002677   300000 000010                    ADSC9   0,,PR3                   cn=0,n=*X0
         1 002700   400006 200011                    ADSC9   6,,PR4                   cn=1,n=*X1

     1024     9626    3           BUFSZ=BUFSZ+1;

   9626  1 002701   200027 236100                    LDQ     BUFSZ,,AUTO
         1 002702   000001 036007                    ADLQ    1,DL
         1 002703   200027 756100                    STQ     BUFSZ,,AUTO

     1025     9627    3           END;

   9627  1 002704   002714 710000 1                  TRA     s:9630

     1026     9628    2         ELSE
     1027     9629    2          PINCRW(DBLK$,LENGTHW(KQ$DBLK))->B$$BUFCHARS=WRQ$->N$REQ.BUF$->B$$BUFCHARS;

   9629  1 002705   200037 470500                    LDP0    WRQ$,,AUTO
         1 002706   000005 471500                    LDP1    5,,PR0
         1 002707   200027 720100                    LXL0    BUFSZ,,AUTO
         1 002710   200026 473500                    LDP3    DBLK$,,AUTO
         1 002711   040140 100540                    MLR     fill='040'O
         1 002712   100000 000010                    ADSC9   0,,PR1                   cn=0,n=*X0
         1 002713   300006 000010                    ADSC9   6,,PR3                   cn=0,n=*X0

     1028     9630    2         CALL HFF$TRAPALT;

   9630  1 002714   000002 631400 xsym               EPPR1   B_VECTNIL+2
         1 002715   000000 701000 xent               TSX1    HFF$TRAPALT
         1 002716   000000 011000                    NOP     0
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:157  

     1029     9631    2         MBLK$->KQ$MBLK.MSGSIZE=MBLK$->KQ$MBLK.MSGSIZE+BUFSZ;

   9631  1 002717   200007 470500                    LDP0    MBLK$,,AUTO
         1 002720   000016 236100                    LDQ     14,,PR0
         1 002721   200027 036100                    ADLQ    BUFSZ,,AUTO
         1 002722   000016 756100                    STQ     14,,PR0

     1030     9632    2         CALL KQD$UNLOCK (CG$->KQ$CG,DBLK$);

   9632  1 002723   200026 631500                    EPPR1   DBLK$,,AUTO
         1 002724   200071 451500                    STP1    RBSTATE+5,,AUTO
         1 002725   200010 236100                    LDQ     CG$,,AUTO
         1 002726   200070 756100                    STQ     RBSTATE+4,,AUTO
         1 002727   200070 630500                    EPPR0   RBSTATE+4,,AUTO
         1 002730   000020 631400 xsym               EPPR1   B_VECTNIL+16
         1 002731   000000 701000 xent               TSX1    KQD$UNLOCK
         1 002732   000000 011000                    NOP     0

     1031     9633    2         RETURN;

   9633  1 002733   200056 221300                    LDX1  ! FOUND+1,,AUTO
         1 002734   000001 702211                    TSX2  ! 1,X1

   9631  1 002735                       BWCBUFU      null
     1032     9634    2   BWCBUFU:;
     1033     9635    2         CALL HFF$TRAPALT;

   9635  1 002735   000002 631400 xsym               EPPR1   B_VECTNIL+2
         1 002736   000000 701000 xent               TSX1    HFF$TRAPALT
         1 002737   000000 011000                    NOP     0

     1034     9636    2         CALL KQD$UNLOCK (CG$->KQ$CG,DBLK$);

   9636  1 002740   200026 630500                    EPPR0   DBLK$,,AUTO
         1 002741   200071 450500                    STP0    RBSTATE+5,,AUTO
         1 002742   200010 236100                    LDQ     CG$,,AUTO
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:158  
         1 002743   200070 756100                    STQ     RBSTATE+4,,AUTO
         1 002744   200070 630500                    EPPR0   RBSTATE+4,,AUTO
         1 002745   000020 631400 xsym               EPPR1   B_VECTNIL+16
         1 002746   000000 701000 xent               TSX1    KQD$UNLOCK
         1 002747   000000 011000                    NOP     0

     1035     9637    2         CALL DESTUL;

   9637  1 002750   002041 701000 1                  TSX1    DESTUL
         1 002751   000000 011000                    NOP     0

     1036     9638    2         TYC=%TYC_MTRAP;

   9638  1 002752   000005 236000 0                  LDQ     5
         1 002753   200034 756100                    STQ     TYC,,AUTO

     1037     9639    2         ALTRETURN;

   9639  1 002754   200056 221300                    LDX1  ! FOUND+1,,AUTO
         1 002755   000000 702211                    TSX2  ! 0,X1

     1038     9640    2   END FILLDBLK;
     1039     9641        /****************************************************************
     1040     9642        *****************************************************************/
     1041     9643        /*D* NAME:         GETDBLK
     1042     9644             PURPOSE:      To allocate a data block for this WRITE
     1043     9645             DESCRIPTION:  If successful, returns DBLK$ pointing to the
     1044     9646                           locked-in data block, in which STAMP and
     1045     9647                           DSIZE have already been set up.  NEWDDA is the
     1046     9648                           DDA.  Else ALTRETs with TYC set appropriately.
     1047     9649
     1048     9650                           Entered with BUFSZ = size of DBLK to allocate,
     1049     9651                           and DEST indicating destination lock if any.
     1050     9652
     1051     9653                           Returns with DEST possibly updated.
     1052     9654
     1053     9655                           REGS the user 'till a DBLK is available.  Returns
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:159  
     1054     9656                           %TYC_CGFULL to MONKEY if no DBLK is available.
     1055     9657        */
     1056     9658    1   GETDBLK: PROC ALTRET;

   9658  1 002756   200056 741300       GETDBLK      STX1  ! FOUND+1,,AUTO

     1057     9659        /**/
     1058     9660    2   DCL REDUND UBIN;
     1059     9661        /**/
     1060     9662    2         NEWDDA=BUFSZ;

   9662  1 002757   200027 235100                    LDA     BUFSZ,,AUTO
         1 002760   200041 755100                    STA     NEWDDA,,AUTO

     1061     9663    2         REDUND=0;

   9663  1 002761   200057 450100                    STZ     REDUND,,AUTO

     1062     9664    2         IF KQ_DEBUG ~= 0

   9664  1 002762   000000 236000 xsym               LDQ     KQ_DEBUG
         1 002763   002770 601000 1                  TNZ     s:9667
         1 002764   200010 470500                    LDP0    CG$,,AUTO
         1 002765   000136 236100                    LDQ     94,,PR0
         1 002766   100000 316003                    CANQ    32768,DU
         1 002767   002774 600000 1                  TZE     s:9670

     1063     9665    2         OR CG$->KQ$CG.AUCTL.REDUNDANT THEN
     1064     9666    3           DO;

     1065     9667    3           REDUND=1;

   9667  1 002770   000001 236007                    LDQ     1,DL
         1 002771   200057 756100                    STQ     REDUND,,AUTO

     1066     9668    3           NEWDDA=NEWDDA+SIZEC(KQ$MBLK);

PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:160  
   9668  1 002772   000100 035007                    ADLA    64,DL
         1 002773   200041 755100                    STA     NEWDDA,,AUTO

     1067     9669    3           END;

     1068     9670    2         IF DEST ~= 0 THEN

   9670  1 002774   200044 236100                    LDQ     DEST,,AUTO
         1 002775   003063 600000 1                  TZE     NOGET0

     1069     9671    3           DO;

     1070     9672    3           CALL KQD$GET (CG$->KQ$CG,DBLK$,NEWDDA) ALTRET(NOGET);

   9672  1 002776   200041 630500                    EPPR0   NEWDDA,,AUTO
         1 002777   200072 450500                    STP0    RBSTATE+6,,AUTO
         1 003000   200026 631500                    EPPR1   DBLK$,,AUTO
         1 003001   200071 451500                    STP1    RBSTATE+5,,AUTO
         1 003002   200010 236100                    LDQ     CG$,,AUTO
         1 003003   200070 756100                    STQ     RBSTATE+4,,AUTO
         1 003004   200070 630500                    EPPR0   RBSTATE+4,,AUTO
         1 003005   000021 631400 xsym               EPPR1   B_VECTNIL+17
         1 003006   000000 701000 xent               TSX1    KQD$GET
         1 003007   003011 702000 1                  TSX2    NOGET

     1071     9673    3           GOTO GET0;

   9673  1 003010   003075 710000 1                  TRA     GET0

   9672  1 003011                       NOGET        null
     1072     9674    3   NOGET:  ;
     1073     9675    3           CALL DESTUL;

   9675  1 003011   002041 701000 1                  TSX1    DESTUL
         1 003012   000000 011000                    NOP     0

     1074     9676    3           NEWDDA=BUFSZ;
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:161  

   9676  1 003013   200027 235100                    LDA     BUFSZ,,AUTO
         1 003014   200041 755100                    STA     NEWDDA,,AUTO

     1075     9677    3           IF REDUND ~= 0 THEN NEWDDA=NEWDDA+SIZEC(KQ$MBLK);

   9677  1 003015   200057 236100                    LDQ     REDUND,,AUTO
         1 003016   003021 600000 1                  TZE     s:9678

   9677  1 003017   000100 035007                    ADLA    64,DL
         1 003020   200041 755100                    STA     NEWDDA,,AUTO

     1076     9678    3           IF DBLK$ = ADDR(NIL) THEN GOTO NOGET0;

   9678  1 003021   200026 236100                    LDQ     DBLK$,,AUTO
         1 003022   000001 116000 xsym               CMPQ    B_VECTNIL+1
         1 003023   003063 600000 1                  TZE     NOGET0

     1077     9679    3           IF  STA$->KQ$STA.MONDCB

   9679  1 003024   200005 470500                    LDP0    STA$,,AUTO
         1 003025   000020 236100                    LDQ     16,,PR0
         1 003026   100000 316003                    CANQ    32768,DU
         1 003027   003050 600000 1                  TZE     s:9685
         1 003030   000000 235000 xsym               LDA     S_CUN
         1 003031   003035 600000 1                  TZE     s:9682
         1 003032   000000 235000 xsym               LDA     S_TIMR
         1 003033   000002 115007                    CMPA    2,DL
         1 003034   003050 601000 1                  TNZ     s:9685

     1078     9680    3           AND (S_CUN = 0 OR S_TIMR = 2) THEN
     1079     9681    4             DO;

     1080     9682    4             CALL KQD$DEFERGO (CG$->KQ$CG,DBLK$,ENTADDR(NIL));

   9682  1 003035   000002 236000 2                  LDQ     2
         1 003036   200072 756100                    STQ     RBSTATE+6,,AUTO
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:162  
         1 003037   200026 631500                    EPPR1   DBLK$,,AUTO
         1 003040   200071 451500                    STP1    RBSTATE+5,,AUTO
         1 003041   200010 236100                    LDQ     CG$,,AUTO
         1 003042   200070 756100                    STQ     RBSTATE+4,,AUTO
         1 003043   200070 630500                    EPPR0   RBSTATE+4,,AUTO
         1 003044   000021 631400 xsym               EPPR1   B_VECTNIL+17
         1 003045   000000 701000 xent               TSX1    KQD$DEFERGO
         1 003046   000000 011000                    NOP     0

     1081     9683    4             GOTO NOGET2;

   9683  1 003047   003132 710000 1                  TRA     NOGET2

     1082     9684    4             END;
     1083     9685    3           CALL KQD$DEFERWAIT (CG$->KQ$CG,DBLK$,NEWDDA) ALTRET(NOGET1);

   9685  1 003050   200041 631500                    EPPR1   NEWDDA,,AUTO
         1 003051   200072 451500                    STP1    RBSTATE+6,,AUTO
         1 003052   200026 633500                    EPPR3   DBLK$,,AUTO
         1 003053   200071 453500                    STP3    RBSTATE+5,,AUTO
         1 003054   200010 236100                    LDQ     CG$,,AUTO
         1 003055   200070 756100                    STQ     RBSTATE+4,,AUTO
         1 003056   200070 630500                    EPPR0   RBSTATE+4,,AUTO
         1 003057   000021 631400 xsym               EPPR1   B_VECTNIL+17
         1 003060   000000 701000 xent               TSX1    KQD$DEFERWAIT
         1 003061   003123 702000 1                  TSX2    NOGET1

     1084     9686    3           END;

   9686  1 003062   003075 710000 1                  TRA     GET0

     1085     9687        /**/
     1086     9688        /**/
     1087     9689    2         ELSE
     1088     9690    2   NOGET0: CALL KQD$GETR (CG$->KQ$CG,DBLK$,NEWDDA) ALTRET(NOGET1);

   9690  1 003063   200041 630500       NOGET0       EPPR0   NEWDDA,,AUTO
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:163  
         1 003064   200072 450500                    STP0    RBSTATE+6,,AUTO
         1 003065   200026 631500                    EPPR1   DBLK$,,AUTO
         1 003066   200071 451500                    STP1    RBSTATE+5,,AUTO
         1 003067   200010 236100                    LDQ     CG$,,AUTO
         1 003070   200070 756100                    STQ     RBSTATE+4,,AUTO
         1 003071   200070 630500                    EPPR0   RBSTATE+4,,AUTO
         1 003072   000021 631400 xsym               EPPR1   B_VECTNIL+17
         1 003073   000000 701000 xent               TSX1    KQD$GETR
         1 003074   003123 702000 1                  TSX2    NOGET1

   9685  1 003075                       GET0         null
     1089     9691    2   GET0: ;
     1090     9692    2         IF REDUND ~= 0 THEN

   9692  1 003075   200057 235100                    LDA     REDUND,,AUTO
         1 003076   003115 600000 1                  TZE     s:9698

     1091     9693    3           DO;

     1092     9694    3           PINCRW(DBLK$,DBLK$->KQ$DBLK.SIZW-LENGTHW(KQ$MBLK))->KQ$MBLK=MBLK$->KQ$MBLK;

   9694  1 003077   200026 470500                    LDP0    DBLK$,,AUTO
         1 003100   000004 220100                    LDX0    4,,PR0
         1 003101   000000 636010                    EAQ     0,X0
         1 003102   000020 772000                    QRL     16
         1 003103   200007 471500                    LDP1    MBLK$,,AUTO
         1 003104   000106 100500                    MLR     fill='000'O
         1 003105   100000 000100                    ADSC9   0,,PR1                   cn=0,n=64
         1 003106   077760 000100                    ADSC9   -16,Q,PR0                cn=0,n=64

     1093     9695    3           DBLK$->KQ$DBLK.MBLK='1'B;

   9695  1 003107   200026 470500                    LDP0    DBLK$,,AUTO
         1 003110   000020 236003                    LDQ     16,DU
         1 003111   000003 256100                    ORSQ    3,,PR0

     1094     9696    3           DBLK$->KQ$DBLK.DSIZE=BUFSZ;
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:164  

   9696  1 003112   200027 720100                    LXL0    BUFSZ,,AUTO
         1 003113   200026 470500                    LDP0    DBLK$,,AUTO
         1 003114   000000 440100                    SXL0    0,,PR0

     1095     9697    3           END;

     1096     9698    2         DBLK$->KQ$DBLK.STAMP=MBLK$->KQ$MBLK.STAMP;

   9698  1 003115   200007 470500                    LDP0    MBLK$,,AUTO
         1 003116   000001 720100                    LXL0    1,,PR0
         1 003117   200026 471500                    LDP1    DBLK$,,AUTO
         1 003120   100000 740100                    STX0    0,,PR1

     1097     9699    2         RETURN;

   9699  1 003121   200056 221300                    LDX1  ! FOUND+1,,AUTO
         1 003122   000001 702211                    TSX2  ! 1,X1

   9698  1 003123                       NOGET1       null
     1098     9700        /**/
     1099     9701    2   NOGET1:;
     1100     9702    2         IF NEWDDA ~= %KQDE_CREG THEN

   9702  1 003123   200041 235100                    LDA     NEWDDA,,AUTO
         1 003124   000001 115007                    CMPA    1,DL
         1 003125   003132 600000 1                  TZE     NOGET2

     1101     9703    2          IF NEWDDA ~= %KQDE_NSPC THEN

   9703  1 003126   000002 115007                    CMPA    2,DL
         1 003127   003132 600000 1                  TZE     NOGET2

     1102     9704    2           CALL SC_CGNOTIMP;

   9704  1 003130   000000 713400 xsym               CLIMB   SC_CGNOTIMP
         1 003131   000000 600000 xsid               climb   nvectors=         0
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:165  

   9702  1 003132                       NOGET2       null
     1103     9705    2   NOGET2:;
     1104     9706    2         TYC=%TYC_CGFULL;

   9706  1 003132   000004 236000 0                  LDQ     4
         1 003133   200034 756100                    STQ     TYC,,AUTO

     1105     9707    2         ALTRETURN;

   9707  1 003134   200056 221300                    LDX1  ! FOUND+1,,AUTO
         1 003135   000000 702211                    TSX2  ! 0,X1

     1106     9708    2   END GETDBLK;
     1107     9709        /****************************************************************
     1108     9710        *****************************************************************/
     1109     9711        /*D* NAME:         CHKSTAL
     1110     9712             PURPOSE:      To find a station and lock it
     1111     9713             DESCRIPTION:  MBLK$->KQ$MBLK.DSTA is the station to find.
     1112     9714                           If it exists, then if it is connected and activated
     1113     9715                           DSTA$ is returned pointing to it, else if WAS is
     1114     9716                           zero, ALTRET.  Else (it doesn't exist) if XSTALGL
     1115     9717                           or WAS are zero, ALTRET, else get a station block
     1116     9718                           and insert it in the tree, returning DSTA$ pointing
     1117     9719                           to the new node (ALTRETs if no mem).
     1118     9720
     1119     9721                           ALTRETs return TYC as the error.
     1120     9722
     1121     9723        */
     1122     9724    1   CHKSTAL: PROC ALTRET;

   9724  1 003136   200060 741300       CHKSTAL      STX1  ! @M$+1,,AUTO

     1123     9725        /**/
     1124     9726    2   DCL T$ PTR;
     1125     9727    2   DCL LOCK BIT(1) ALIGNED;
     1126     9728        /**/
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:166  
     1127     9729    2         LOCK='1'B;

   9729  1 003137   400000 236003                    LDQ     -131072,DU
         1 003140   200062 756100                    STQ     LOCK,,AUTO

     1128     9730    2         GOTO CMN;

   9730  1 003141   003144 710000 1                  TRA     CMN

     1129     9731        /**/
     1130     9732        /* NAME:        CHKSTA
     1131     9733           PURPOSE:     To find a station
     1132     9734           DESCRIPTION: Same as CHKSTAL but returns with the station's
     1133     9735                        gate unlocked.
     1134     9736        */
     1135     9737    2   CHKSTA: ENTRY ALTRET;

   9737  1 003142   200060 741300       CHKSTA       STX1  ! @M$+1,,AUTO

     1136     9738    2         LOCK='0'B;

   9738  1 003143   200062 450100                    STZ     LOCK,,AUTO

   9738  1 003144                       CMN          null
     1137     9739    2   CMN:  ;
     1138     9740              %LOCK (G=KQ$STREE.GATE);

   9741  1 003144   200010 236100                    LDQ     CG$,,AUTO
         1 003145   000075 036003                    ADLQ    61,DU
         1 003146   200070 756100                    STQ     RBSTATE+4,,AUTO
         1 003147   200070 630500                    EPPR0   RBSTATE+4,,AUTO
         1 003150   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 003151   000000 701000 xent               TSX1    HFC$LOCK
         1 003152   000000 011000                    NOP     0

     1139     9743    2         CALL KQB$SRCH (KQ$STREE,MBLK$->KQ$MBLK.DSTA,T$) ALTRET(NOSTA);

PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:167  
   9743  1 003153   200061 630500                    EPPR0   T$,,AUTO
         1 003154   200072 450500                    STP0    RBSTATE+6,,AUTO
         1 003155   200007 236100                    LDQ     MBLK$,,AUTO
         1 003156   000011 036003                    ADLQ    9,DU
         1 003157   200071 756100                    STQ     RBSTATE+5,,AUTO
         1 003160   200010 236100                    LDQ     CG$,,AUTO
         1 003161   000075 036003                    ADLQ    61,DU
         1 003162   200070 756100                    STQ     RBSTATE+4,,AUTO
         1 003163   200070 630500                    EPPR0   RBSTATE+4,,AUTO
         1 003164   000021 631400 xsym               EPPR1   B_VECTNIL+17
         1 003165   000000 701000 xent               TSX1    KQB$SRCH
         1 003166   003257 702000 1                  TSX2    NOSTA

     1140     9744    2         DSTA$=T$;

   9744  1 003167   200061 236100                    LDQ     T$,,AUTO
         1 003170   200036 756100                    STQ     DSTA$,,AUTO

   9744  1 003171                       CHK0         null
     1141     9745    2   CHK0: ;
     1142     9746              %LOCK (G=DSTA$->KQ$STA.GATE);

   9747  1 003171   200036 236100                    LDQ     DSTA$,,AUTO
         1 003172   000016 036003                    ADLQ    14,DU
         1 003173   200070 756100                    STQ     RBSTATE+4,,AUTO
         1 003174   200070 630500                    EPPR0   RBSTATE+4,,AUTO
         1 003175   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 003176   000000 701000 xent               TSX1    HFC$LOCK
         1 003177   000000 011000                    NOP     0

     1143     9749    2         IF DSTA$->KQ$STA.AUP THEN

   9749  1 003200   200036 470500                    LDP0    DSTA$,,AUTO
         1 003201   000023 236100                    LDQ     19,,PR0
         1 003202   400000 316007                    CANQ    -131072,DL
         1 003203   003213 600000 1                  TZE     s:9751

PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:168  
     1144     9750    2          IF NOT ((WAS & '01'B) OR MBLK$->KQ$MBLK.STAR) THEN GOTO CHK1;

   9750  1 003204   200015 236100                    LDQ     WAS,,AUTO
         1 003205   200000 376003                    ANQ     65536,DU
         1 003206   003213 601000 1                  TNZ     s:9751
         1 003207   200007 471500                    LDP1    MBLK$,,AUTO
         1 003210   100010 236100                    LDQ     8,,PR1
         1 003211   100000 316003                    CANQ    32768,DU
         1 003212   003225 600000 1                  TZE     CHK1

     1145     9751    2         IF DSTA$->KQ$STA.LDCT$ ~= ADDR(NIL) THEN

   9751  1 003213   000010 236100                    LDQ     8,,PR0
         1 003214   000001 116000 xsym               CMPQ    B_VECTNIL+1
         1 003215   003222 600000 1                  TZE     s:9753

     1146     9752    2          IF DSTA$->KQ$STA.LDCT$->NK$LDCT.LKFLG.ACTIVE THEN GOTO CHKDUN;

   9752  1 003216   000010 471500                    LDP1    8,,PR0
         1 003217   100011 236100                    LDQ     9,,PR1
         1 003220   000040 316003                    CANQ    32,DU
         1 003221   003235 601000 1                  TNZ     CHKDUN

     1147     9753    2         IF NOT (WAS & '10'B) THEN

   9753  1 003222   200015 236100                    LDQ     WAS,,AUTO
         1 003223   400000 376003                    ANQ     -131072,DU
         1 003224   003235 601000 1                  TNZ     CHKDUN

     1148     9754    3           DO;

   9752  1 003225                       CHK1         null
     1149     9755    3   CHK1:   ;
     1150     9756                %UNLOCK (G=DSTA$->KQ$STA.GATE);

   9757  1 003225   200036 236100                    LDQ     DSTA$,,AUTO
         1 003226   000016 036003                    ADLQ    14,DU
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:169  
         1 003227   200070 756100                    STQ     RBSTATE+4,,AUTO
         1 003230   200070 630500                    EPPR0   RBSTATE+4,,AUTO
         1 003231   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 003232   000000 701000 xent               TSX1    HFC$UNLOCK
         1 003233   000000 011000                    NOP     0

     1151     9759    3           GOTO CHKFAIL;

   9759  1 003234   003301 710000 1                  TRA     CHKFAIL

   9753  1 003235                       CHKDUN       null
     1152     9760    3           END;
     1153     9761    2   CHKDUN:;
     1154     9762    2         IF NOT LOCK THEN

   9762  1 003235   200062 234100                    SZN     LOCK,,AUTO
         1 003236   003246 604000 1                  TMI     s:9767

     1155     9763               %UNLOCK (G=DSTA$->KQ$STA.GATE);

   9764  1 003237   200036 236100                    LDQ     DSTA$,,AUTO
         1 003240   000016 036003                    ADLQ    14,DU
         1 003241   200070 756100                    STQ     RBSTATE+4,,AUTO
         1 003242   200070 630500                    EPPR0   RBSTATE+4,,AUTO
         1 003243   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 003244   000000 701000 xent               TSX1    HFC$UNLOCK
         1 003245   000000 011000                    NOP     0

     1156     9766              %UNLOCK (G=KQ$STREE.GATE);

   9767  1 003246   200010 236100                    LDQ     CG$,,AUTO
         1 003247   000075 036003                    ADLQ    61,DU
         1 003250   200070 756100                    STQ     RBSTATE+4,,AUTO
         1 003251   200070 630500                    EPPR0   RBSTATE+4,,AUTO
         1 003252   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 003253   000000 701000 xent               TSX1    HFC$UNLOCK
         1 003254   000000 011000                    NOP     0
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:170  

     1157     9769    2         RETURN;

   9769  1 003255   200060 221300                    LDX1  ! @M$+1,,AUTO
         1 003256   000001 702211                    TSX2  ! 1,X1

   9762  1 003257                       NOSTA        null
     1158     9770    2   NOSTA:;
     1159     9771    2         IF CG$->KQ$CG.AUCTL.XSTALGL = '0'B THEN

   9771  1 003257   200010 470500                    LDP0    CG$,,AUTO
         1 003260   000133 236100                    LDQ     91,,PR0
         1 003261   000020 316007                    CANQ    16,DL
         1 003262   003276 601000 1                  TNZ     s:9780

     1160     9772    3           DO;

   9764  1 003263                       CGKEYV       null
     1161     9773    3   CGKEYV: ;
     1162     9774                %UNLOCK (G=KQ$STREE.GATE);

   9775  1 003263   200010 236100                    LDQ     CG$,,AUTO
         1 003264   000075 036003                    ADLQ    61,DU
         1 003265   200070 756100                    STQ     RBSTATE+4,,AUTO
         1 003266   200070 630500                    EPPR0   RBSTATE+4,,AUTO
         1 003267   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 003270   000000 701000 xent               TSX1    HFC$UNLOCK
         1 003271   000000 011000                    NOP     0

     1163     9777    3           TYC=%TYC_CGKEYV;

   9777  1 003272   000006 236000 0                  LDQ     6
         1 003273   200034 756100                    STQ     TYC,,AUTO

     1164     9778    3           ALTRETURN;

   9778  1 003274   200060 221300                    LDX1  ! @M$+1,,AUTO
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:171  
         1 003275   000000 702211                    TSX2  ! 0,X1

     1165     9779    3           END;
     1166     9780    2         IF NOT (WAS & '10'B) THEN

   9780  1 003276   200015 236100                    LDQ     WAS,,AUTO
         1 003277   400000 376003                    ANQ     -131072,DU
         1 003300   003314 601000 1                  TNZ     s:9789

     1167     9781    3           DO;

   9778  1 003301                       CHKFAIL      null
     1168     9782    3   CHKFAIL:;
     1169     9783                %UNLOCK (G=KQ$STREE.GATE);

   9784  1 003301   200010 236100                    LDQ     CG$,,AUTO
         1 003302   000075 036003                    ADLQ    61,DU
         1 003303   200070 756100                    STQ     RBSTATE+4,,AUTO
         1 003304   200070 630500                    EPPR0   RBSTATE+4,,AUTO
         1 003305   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 003306   000000 701000 xent               TSX1    HFC$UNLOCK
         1 003307   000000 011000                    NOP     0

     1170     9786    3           TYC=%TYC_DISC;

   9786  1 003310   000011 236000 0                  LDQ     9
         1 003311   200034 756100                    STQ     TYC,,AUTO

     1171     9787    3           ALTRETURN;

   9787  1 003312   200060 221300                    LDX1  ! @M$+1,,AUTO
         1 003313   000000 702211                    TSX2  ! 0,X1

     1172     9788    3           END;
     1173     9789    2         T$=STA$;

   9789  1 003314   200005 236100                    LDQ     STA$,,AUTO
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:172  
         1 003315   200061 756100                    STQ     T$,,AUTO

     1174     9790    2         CALL KQT$GETSTA (CG$->KQ$CG,T$,MBLK$->KQ$MBLK.DSTA) ALTRET(NOMEM);

   9790  1 003316   200007 236100                    LDQ     MBLK$,,AUTO
         1 003317   000011 036003                    ADLQ    9,DU
         1 003320   200072 756100                    STQ     RBSTATE+6,,AUTO
         1 003321   200061 631500                    EPPR1   T$,,AUTO
         1 003322   200071 451500                    STP1    RBSTATE+5,,AUTO
         1 003323   200010 236100                    LDQ     CG$,,AUTO
         1 003324   200070 756100                    STQ     RBSTATE+4,,AUTO
         1 003325   200070 630500                    EPPR0   RBSTATE+4,,AUTO
         1 003326   000021 631400 xsym               EPPR1   B_VECTNIL+17
         1 003327   000000 701000 xent               TSX1    KQT$GETSTA
         1 003330   003334 702000 1                  TSX2    NOMEM

     1175     9791    2         DSTA$=T$;

   9791  1 003331   200061 236100                    LDQ     T$,,AUTO
         1 003332   200036 756100                    STQ     DSTA$,,AUTO

     1176     9792    2         GOTO CHK0;

   9792  1 003333   003171 710000 1                  TRA     CHK0

   9791  1 003334                       NOMEM        null
     1177     9793    2   NOMEM:;
     1178     9794    2         TYC=%TYC_CGFULL;

   9794  1 003334   000004 236000 0                  LDQ     4
         1 003335   200034 756100                    STQ     TYC,,AUTO

     1179     9795    2         ALTRETURN;

   9795  1 003336   200060 221300                    LDX1  ! @M$+1,,AUTO
         1 003337   000000 702211                    TSX2  ! 0,X1

PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:173  
     1180     9796    2   END CHKSTAL;
     1181     9797        /****************************************************************
     1182     9798        *****************************************************************/
     1183     9799        /*D* NAME:         XFERD
     1184     9800             PURPOSE:      To transfer a write into the reader's buffer
     1185     9801             DESCRIPTION:  Enter with DSTA$ pointing to the reader's KQ$STA,
     1186     9802                           and with its gate locked.  RBLK$ points to the
     1187     9803                           reader's read, MBLK$ points to the writer's write.
     1188     9804
     1189     9805                           If the writer's buffer is bad, RETURNs with
     1190     9806                           everything unlocked and DEST=0.
     1191     9807
     1192     9808                           If the reader's buffer is
     1193     9809                           too small, RETURNs with DSTA still locked
     1194     9810                           and DEST=2.
     1195     9811
     1196     9812                           Else ALTRETs
     1197     9813                           with the data transfered, the read COMPed,
     1198     9814                           and SETWCOMP called.
     1199     9815
     1200     9816                           Used only if the data is being xferred directly
     1201     9817                           from the writer's buffer.
     1202     9818        */
     1203     9819    1   XFERD: PROC ALTRET;

   9819  1 003340   200050 741300       XFERD        STX1  ! I+2,,AUTO

     1204     9820        /**/
     1205     9821    2   DCL QLOCK UBIN;
     1206     9822    2   DCL RRQ$ PTR;
     1207     9823        /**/
     1208     9824    2         QLOCK=0;

   9824  1 003341   200051 450100                    STZ     QLOCK,,AUTO

     1209     9825    2         GOTO XFER;

PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:174  
   9825  1 003342   003346 710000 1                  TRA     XFER

     1210     9826        /*D* NAME:         XFERQ
     1211     9827             PURPOSE:      To transfer a write into the reader's buffer
     1212     9828             DESCRIPTION:  Same as XFERD but the read was found in the
     1213     9829                           queue.  P$ points to the link word which must
     1214     9830                           be set to the RBLK's link if we complete the
     1215     9831                           xfer (this removes the read from the queue).
     1216     9832                           Also, this routine is entered with the queue
     1217     9833                           locked.
     1218     9834        */
     1219     9835    2   XFERQ: ENTRY ALTRET;

   9835  1 003343   200050 741300       XFERQ        STX1  ! I+2,,AUTO

     1220     9836    2         QLOCK=1;

   9836  1 003344   000001 235007                    LDA     1,DL
         1 003345   200051 755100                    STA     QLOCK,,AUTO

   9836  1 003346                       XFER         null
     1221     9837    2   XFER: ;
     1222     9838    2         RRQ$=DSTA$->KQ$STA.LDCT$->NK$LDCT.IOQ$;

   9838  1 003346   200036 470500                    LDP0    DSTA$,,AUTO
         1 003347   000010 471500                    LDP1    8,,PR0
         1 003350   100001 236100                    LDQ     1,,PR1
         1 003351   200052 756100                    STQ     RRQ$,,AUTO

     1223     9839    2         RRQ$->N$REQ.TYC='0'B;

   9839  1 003352   200052 473500                    LDP3    RRQ$,,AUTO
         1 003353   300021 450100                    STZ     17,,PR3

     1224     9840    2         MBLK$->KQ$MBLK.MSGSIZE=BUFSZ;

   9840  1 003354   200007 471500                    LDP1    MBLK$,,AUTO
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:175  
         1 003355   200027 235100                    LDA     BUFSZ,,AUTO
         1 003356   100016 755100                    STA     14,,PR1

     1225     9841    2         IF BUFSZ > RBLK$->KQ$RBLK.BUFSIZE THEN

   9841  1 003357   200006 474500                    LDP4    RBLK$,,AUTO
         1 003360   400016 236100                    LDQ     14,,PR4
         1 003361   200027 116100                    CMPQ    BUFSZ,,AUTO
         1 003362   003366 603000 1                  TRC     s:9847

     1226     9842    3           DO;

     1227     9843    3           DEST=2;

   9843  1 003363   000002 235007                    LDA     2,DL
         1 003364   200044 755100                    STA     DEST,,AUTO

     1228     9844    3           GOTO UNLOCKQ;

   9844  1 003365   003536 710000 1                  TRA     UNLOCKQ

     1229     9845    3           END;
     1230     9846              %LOCK (G=KQ_XFGATE);

   9847  1 003366   000012 630400 2                  EPPR0   10
         1 003367   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 003370   000000 701000 xent               TSX1    HFC$LOCK
         1 003371   000000 011000                    NOP     0

     1231     9849    2         B$CGPT$->B$$XFPTW=RBLK$->KQ$RBLK.PTW;

   9849  1 003372   200006 470500                    LDP0    RBLK$,,AUTO
         1 003373   000014 237100                    LDAQ    12,,PR0
         1 003374   000000 471400 xsym               LDP1    B$CGPT$
         1 003375   100000 757100                    STAQ    0,,PR1

     1232     9850    2         CALL HFC$ASSOCCLR (%CGWSQ,0,2);
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:176  

   9850  1 003376   000014 630400 2                  EPPR0   12
         1 003377   000021 631400 xsym               EPPR1   B_VECTNIL+17
         1 003400   000000 701000 xent               TSX1    HFC$ASSOCCLR
         1 003401   000000 011000                    NOP     0

     1233     9851    2         CALL HFF$TRAPALT ALTRET(BADWBUF);

   9851  1 003402   000002 631400 xsym               EPPR1   B_VECTNIL+2
         1 003403   000000 701000 xent               TSX1    HFF$TRAPALT
         1 003404   003515 702000 1                  TSX2    BADWBUF

     1234     9852    2         IF VFC ~= 0 THEN

   9852  1 003405   200045 235100                    LDA     VFC,,AUTO
         1 003406   003435 600000 1                  TZE     s:9860

     1235     9853    3           DO;

     1236     9854    3           BUFSZ=BUFSZ-1;

   9854  1 003407   200027 236100                    LDQ     BUFSZ,,AUTO
         1 003410   000001 136007                    SBLQ    1,DL
         1 003411   200027 756100                    STQ     BUFSZ,,AUTO

     1237     9855    3           RBLK$->KQ$RBLK.BUF$->B$$CHAR=MBLK$->KQ$MBLK.DVE.VFC;

   9855  1 003412   200006 470500                    LDP0    RBLK$,,AUTO
         1 003413   000013 471500                    LDP1    11,,PR0
         1 003414   200007 473500                    LDP3    MBLK$,,AUTO
         1 003415   040100 100500                    MLR     fill='040'O
         1 003416   300010 400001                    ADSC9   8,,PR3                   cn=2,n=1
         1 003417   100000 000001                    ADSC9   0,,PR1                   cn=0,n=1

     1238     9856    3           PINCRC(RBLK$->KQ$RBLK.BUF$,1)->B$$BUFCHARS=WRQ$->N$REQ.BUF$->B$$BUFCHARS;

   9856  1 003420   200006 470500                    LDP0    RBLK$,,AUTO
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:177  
         1 003421   000013 471500                    LDP1    11,,PR0
         1 003422   200037 474500                    LDP4    WRQ$,,AUTO
         1 003423   400005 475500                    LDP5    5,,PR4
         1 003424   000000 620006                    EAX0    0,QL
         1 003425   200027 721100                    LXL1    BUFSZ,,AUTO
         1 003426   040140 100540                    MLR     fill='040'O
         1 003427   500000 000010                    ADSC9   0,,PR5                   cn=0,n=*X0
         1 003430   100000 200011                    ADSC9   0,,PR1                   cn=1,n=*X1

     1239     9857    3           BUFSZ=BUFSZ+1;

   9857  1 003431   200027 236100                    LDQ     BUFSZ,,AUTO
         1 003432   000001 036007                    ADLQ    1,DL
         1 003433   200027 756100                    STQ     BUFSZ,,AUTO

     1240     9858    3           END;

   9858  1 003434   003445 710000 1                  TRA     s:9861

     1241     9859    2         ELSE
     1242     9860    2          RBLK$->KQ$RBLK.BUF$->B$$BUFCHARS=WRQ$->N$REQ.BUF$->B$$BUFCHARS;

   9860  1 003435   200006 470500                    LDP0    RBLK$,,AUTO
         1 003436   000013 471500                    LDP1    11,,PR0
         1 003437   200037 473500                    LDP3    WRQ$,,AUTO
         1 003440   300005 474500                    LDP4    5,,PR3
         1 003441   200027 720100                    LXL0    BUFSZ,,AUTO
         1 003442   040140 100540                    MLR     fill='040'O
         1 003443   400000 000010                    ADSC9   0,,PR4                   cn=0,n=*X0
         1 003444   100000 000010                    ADSC9   0,,PR1                   cn=0,n=*X0

     1243     9861    2         B$CGPT$->B$$XFPTW='0'B;

   9861  1 003445   000000 235003                    LDA     0,DU
         1 003446   000000 236003                    LDQ     0,DU
         1 003447   000000 470400 xsym               LDP0    B$CGPT$
         1 003450   000000 757100                    STAQ    0,,PR0
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:178  

     1244     9862    2         CALL HFC$ASSOCCLR (%CGWSQ,0,2);

   9862  1 003451   000014 630400 2                  EPPR0   12
         1 003452   000021 631400 xsym               EPPR1   B_VECTNIL+17
         1 003453   000000 701000 xent               TSX1    HFC$ASSOCCLR
         1 003454   000000 011000                    NOP     0

     1245     9863    2         CALL HFF$TRAPALT;

   9863  1 003455   000002 631400 xsym               EPPR1   B_VECTNIL+2
         1 003456   000000 701000 xent               TSX1    HFF$TRAPALT
         1 003457   000000 011000                    NOP     0

     1246     9864              %UNLOCK (G=KQ_XFGATE);

   9865  1 003460   000012 630400 2                  EPPR0   10
         1 003461   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 003462   000000 701000 xent               TSX1    HFC$UNLOCK
         1 003463   000000 011000                    NOP     0

     1247     9867    2         RRQ$->N$REQ.ARSIZE=BUFSZ;

   9867  1 003464   200052 470500                    LDP0    RRQ$,,AUTO
         1 003465   200027 236100                    LDQ     BUFSZ,,AUTO
         1 003466   000020 736000                    QLS     16
         1 003467   000027 676100                    ERQ     23,,PR0
         1 003470   000034 376000 xsym               ANQ     B_VECTNIL+28
         1 003471   000027 656100                    ERSQ    23,,PR0

     1248     9868    2         IF QLOCK ~= 0 THEN

   9868  1 003472   200051 235100                    LDA     QLOCK,,AUTO
         1 003473   003501 600000 1                  TZE     s:9871

     1249     9869    2          CALL MOVMCQ (MYMBLK$) ALTRET(BAD_VFC);

PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:179  
   9869  1 003474   200040 631500                    EPPR1   MYMBLK$,,AUTO
         1 003475   200063 451500                    STP1    RBSTATE+1,,AUTO
         1 003476   003604 701000 1                  TSX1    MOVMCQ
         1 003477   003525 702000 1                  TSX2    BAD_VFC
         1 003500   003505 710000 1                  TRA     s:9872

     1250     9870    2         ELSE
     1251     9871    2          CALL MOVMC (MYMBLK$) ALTRET(BAD_VFC);

   9871  1 003501   200040 631500                    EPPR1   MYMBLK$,,AUTO
         1 003502   200061 451500                    STP1    T$,,AUTO
         1 003503   003724 701000 1                  TSX1    MOVMC
         1 003504   003525 702000 1                  TSX2    BAD_VFC

     1252     9872    2         CALL SETWCOMP;

   9872  1 003505   004035 701000 1                  TSX1    SETWCOMP
         1 003506   000000 011000                    NOP     0

     1253     9873    2         CALL KQR$COMP (RRQ$->N$REQ);

   9873  1 003507   200052 630500                    EPPR0   RRQ$,,AUTO
         1 003510   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 003511   000000 701000 xent               TSX1    KQR$COMP
         1 003512   000000 011000                    NOP     0

     1254     9874    2         ALTRETURN;

   9874  1 003513   200050 221300                    LDX1  ! I+2,,AUTO
         1 003514   000000 702211                    TSX2  ! 0,X1

   9868  1 003515                       BADWBUF      null
     1255     9875    2   BADWBUF:;
     1256     9876    2         CALL HFF$TRAPALT;

   9876  1 003515   000002 631400 xsym               EPPR1   B_VECTNIL+2
         1 003516   000000 701000 xent               TSX1    HFF$TRAPALT
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:180  
         1 003517   000000 011000                    NOP     0

     1257     9877              %UNLOCK (G=KQ_XFGATE);

   9878  1 003520   000012 630400 2                  EPPR0   10
         1 003521   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 003522   000000 701000 xent               TSX1    HFC$UNLOCK
         1 003523   000000 011000                    NOP     0

     1258     9880
     1259     9881    3           DO WHILE ('0'B);

   9881  1 003524   003527 710000 1                  TRA     s:9887

   9878  1 003525                       BAD_VFC      null
     1260     9882    3   BAD_VFC:;
     1261     9883    3           DEST = 3;

   9883  1 003525   000003 235007                    LDA     3,DL
         1 003526   200044 755100                    STA     DEST,,AUTO

     1262     9884    3           END;

     1263     9885
     1264     9886              %UNLOCK (G=DSTA$->KQ$STA.GATE);

   9887  1 003527   200036 236100                    LDQ     DSTA$,,AUTO
         1 003530   000016 036003                    ADLQ    14,DU
         1 003531   200070 756100                    STQ     RBSTATE+4,,AUTO
         1 003532   200070 630500                    EPPR0   RBSTATE+4,,AUTO
         1 003533   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 003534   000000 701000 xent               TSX1    HFC$UNLOCK
         1 003535   000000 011000                    NOP     0

   9882  1 003536                       UNLOCKQ      null
     1265     9889    2   UNLOCKQ:;
     1266     9890    2         IF QLOCK ~= 0 THEN
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:181  

   9890  1 003536   200051 235100                    LDA     QLOCK,,AUTO
         1 003537   003547 600000 1                  TZE     s:9896

     1267     9891    3           DO;

     1268     9892                %UNLOCK (G=KQ$QTREE.GATE);

   9893  1 003540   200010 470500                    LDP0    CG$,,AUTO
         1 003541   000057 471500                    LDP1    47,,PR0
         1 003542   200070 451500                    STP1    RBSTATE+4,,AUTO
         1 003543   200070 630500                    EPPR0   RBSTATE+4,,AUTO
         1 003544   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 003545   000000 701000 xent               TSX1    HFC$UNLOCK
         1 003546   000000 011000                    NOP     0

     1269     9895    3           END;

     1270     9896    2         RETURN;

   9896  1 003547   200050 221300                    LDX1  ! I+2,,AUTO
         1 003550   000001 702211                    TSX2  ! 1,X1

     1271     9897    2   END XFERD;
     1272     9898        /********************************************************
     1273     9899        *********************************************************/
     1274     9900        /**/
     1275     9901        /*D* NAME:         CHECKVFC
     1276     9902             PURPOSE:      To determine if this MBLK contains
     1277     9903                           a VFC char,  Only valid for terminals.
     1278     9904                           If so and this is a DCB or an FPRG, It
     1279     9905                           ALTRETURNs.
     1280     9906        */
     1281     9907
     1282     9908
     1283     9909    1   CHECKVFC: PROC ALTRET;

PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:182  
   9909  1 003551   200066 741300       CHECKVFC     STX1  ! RBSTATE+2,,AUTO

     1284     9910    2         IF (MBLK$->KQ$MBLK.DVE.VFC >  %VFC_SLPP) OR

   9910  1 003552   200007 470500                    LDP0    MBLK$,,AUTO
         1 003553   000010 236100                    LDQ     8,,PR0
         1 003554   777000 376007                    ANQ     -512,DL
         1 003555   031000 116007                    CMPQ    12800,DL
         1 003556   003560 600000 1                  TZE     s:9910+6
         1 003557   003564 603000 1                  TRC     s:9912
         1 003560   000010 236100                    LDQ     8,,PR0
         1 003561   777000 376007                    ANQ     -512,DL
         1 003562   021000 116007                    CMPQ    8704,DL
         1 003563   003565 603000 1                  TRC     s:9917

     1285     9911    2         (MBLK$->KQ$MBLK.DVE.VFC <  %VFC_OTB)
     1286     9912    2         THEN RETURN;

   9912  1 003564   000001 702211                    TSX2  ! 1,X1

     1287     9913              /*  It is a SET VFC MBLK check to see if it is a DCB */
     1288     9914
     1289     9915              /* If there is no LDCT$, the station is *GORGO and the message
     1290     9916                 should be removed.                                         */
     1291     9917    2         IF (DSTA$->KQ$STA.LDCT$ = ADDR(NIL)) THEN GOTO ALT;

   9917  1 003565   200036 471500                    LDP1    DSTA$,,AUTO
         1 003566   100010 236100                    LDQ     8,,PR1
         1 003567   000001 116000 xsym               CMPQ    B_VECTNIL+1
         1 003570   003603 600000 1                  TZE     ALT

     1292     9918
     1293     9919              /* If the read is from a CGTRM or KEYIN  let it pass */
     1294     9920    2         IF (DSTA$->KQ$STA.LDCT$->NK$LDCT.USER = JG_KEYIN#) OR

   9920  1 003571   100010 473500                    LDP3    8,,PR1
         1 003572   300007 236100                    LDQ     7,,PR3
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:183  
         1 003573   000777 376003                    ANQ     511,DU
         1 003574   000002 116003                    CMPQ    2,DU
         1 003575   003602 600000 1                  TZE     s:9922
         1 003576   300006 236100                    LDQ     6,,PR3
         1 003577   000017 376007                    ANQ     15,DL
         1 003600   000002 116007                    CMPQ    2,DL
         1 003601   003603 601000 1                  TNZ     ALT

     1295     9921    2         (DSTA$->KQ$STA.LDCT$->NK$LDCT.RESCOD = NK_CGTRM)
     1296     9922    2         THEN RETURN;

   9922  1 003602   000001 702211                    TSX2  ! 1,X1

     1297     9923
     1298     9924              /* Funny message is bound for a DCB or an FPRG, ALTRETURN. */
     1299     9925    2   ALT:  ALTRETURN;

   9925  1 003603   000000 702211       ALT          TSX2  ! 0,X1

     1300     9926    2   END CHECKVFC;
     1301     9927        %EJECT;
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:184  
     1302     9928        /****************************************************************
     1303     9929        *****************************************************************/
     1304     9930        /*D* NAME:         MOVMCQ
     1305     9931             PURPOSE:      To move a msg
     1306     9932                           to a reading station.
     1307     9933             DESCRIPTION:  DSTA$ is the destination
     1308     9934                           (the reader).  RBLK$ is the reading RBLK,
     1309     9935                           M$ is the pointer to the MBLK.
     1310     9936
     1311     9937                           The MBLK is moved to be pointed to by the
     1312     9938                           RBLK.  M$ is set to point to the MBLK's old link.
     1313     9939                           The RBLK's state is set to KQRS_XFDN#.
     1314     9940
     1315     9941                           The reader's station is locked, and it is
     1316     9942                           unlocked after we're done.  All this is done
     1317     9943                           inhibited to prevent losing the MBLK during a
     1318     9944                           crash (i.e. if another CPU screeches, it's
     1319     9945                           interrupt won't jerk us out).
     1320     9946
     1321     9947                           The RBLK was originally found in the queue, and
     1322     9948                           P$ points the link which must be set to the
     1323     9949                           RBLK's link in order to remove it from the
     1324     9950                           queue.  The queue is unlocked after we're all
     1325     9951                           done.  The RBLK does not specify LATCH.
     1326     9952        */
     1327     9953    1   MOVMCQ: PROC (M$) ALTRET;

   9953  1 003604   200062 741300       MOVMCQ       STX1  ! LOCK,,AUTO

     1328     9954        /**/
     1329     9955    2   DCL M$ PTR;
     1330     9956    2   DCL RBSTATE UBIN;
     1331     9957        /**/
     1332     9958    2         RBSTATE=KQRS_XFDN#;

   9958  1 003605   000005 235007                    LDA     5,DL
         1 003606   200064 755100                    STA     RBSTATE,,AUTO
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:185  

     1333     9959    2         GOTO MOVMQ;

   9959  1 003607   003613 710000 1                  TRA     MOVMQ

     1334     9960        /*D* NAME:         MOVMXQ
     1335     9961             PURPOSE:      To move a message from the writing station
     1336     9962                           to a reading station.
     1337     9963             DESCRIPTION:  Just like MOVMCQ except the state is to be
     1338     9964                           set to KQRS_XFIP#, and the RBLK may specify
     1339     9965                           LATCH, in which case QTN$ points to the Q-tree
     1340     9966                           node which must have CNACT incremented.
     1341     9967        */
     1342     9968    2   MOVMXQ: ENTRY (M$) ALTRET;

   9968  1 003610   200062 741300       MOVMXQ       STX1  ! LOCK,,AUTO

     1343     9969    3           DO INHIBIT;

     1344     9970    3           RBSTATE=KQRS_XFIP#;

   9970  1 003611   000003 235207                    LDA   ! 3,DL
         1 003612   200064 755300                    STA   ! RBSTATE,,AUTO

   9970  1 003613                       MOVMQ        null
     1345     9971    3   MOVMQ:  ;
     1346     9972    3           MBLK$=M$;

   9972  1 003613   200063 470700                    LDP0  ! @M$,,AUTO
         1 003614   000000 236300                    LDQ   ! 0,,PR0
         1 003615   200007 756300                    STQ   ! MBLK$,,AUTO

     1347     9973    3           CALL CHECKVFC ALTRET(ALT);

   9973  1 003616   003551 701200 1                  TSX1  ! CHECKVFC
         1 003617   003721 702200 1                  TSX2  ! ALT

PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:186  
     1348     9974    3           P$->B$$PTR=RBLK$->KQ$RBLK.QRLNK$;

   9974  1 003620   200006 470700                    LDP0  ! RBLK$,,AUTO
         1 003621   000020 236300                    LDQ   ! 16,,PR0
         1 003622   200014 471700                    LDP1  ! P$,,AUTO
         1 003623   100000 756300                    STQ   ! 0,,PR1

     1349     9975    3           RBLK$->KQ$RBLK.QRLNK$=ADDR(NIL); /* alias LWRITES$ */

   9975  1 003624   000001 236200 xsym               LDQ   ! B_VECTNIL+1
         1 003625   200006 470700                    LDP0  ! RBLK$,,AUTO
         1 003626   000020 756300                    STQ   ! 16,,PR0

     1350     9976    3           M$=MBLK$->KQ$MBLK.LNK$;

   9976  1 003627   200007 473700                    LDP3  ! MBLK$,,AUTO
         1 003630   300000 236300                    LDQ   ! 0,,PR3
         1 003631   200063 474700                    LDP4  ! @M$,,AUTO
         1 003632   400000 756300                    STQ   ! 0,,PR4

     1351     9977    3           IF RBLK$->KQ$RBLK.MBLK$~=ADDR(NIL) THEN

   9977  1 003633   200006 470700                    LDP0  ! RBLK$,,AUTO
         1 003634   000000 236300                    LDQ   ! 0,,PR0
         1 003635   000001 116200 xsym               CMPQ  ! B_VECTNIL+1
         1 003636   003642 600200 1                  TZE   ! s:9979

     1352     9978    3            RBLK$->KQ$RBLK.MBLK$->KQ$MBLK.RBLK = '0'B;

   9978  1 003637   000000 475700                    LDP5  ! 0,,PR0
         1 003640   000017 236200 2                  LDQ   ! 15
         1 003641   500010 356300                    ANSQ  ! 8,,PR5

     1353     9979    3           RBLK$->KQ$RBLK.MBLK$=MBLK$;

   9979  1 003642   200007 236300                    LDQ   ! MBLK$,,AUTO
         1 003643   000000 756300                    STQ   ! 0,,PR0
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:187  

     1354     9980    3           MBLK$->KQ$MBLK.RBLK = '1'B;

   9980  1 003644   000100 236207                    LDQ   ! 64,DL
         1 003645   300010 256300                    ORSQ  ! 8,,PR3

     1355     9981    3           MBLK$->KQ$MBLK.LNK$=ADDR(NIL);

   9981  1 003646   000001 236200 xsym               LDQ   ! B_VECTNIL+1
         1 003647   300000 756300                    STQ   ! 0,,PR3

     1356     9982    3           IF RBLK$->KQ$RBLK.LATCH THEN

   9982  1 003650   200006 470700                    LDP0  ! RBLK$,,AUTO
         1 003651   000001 236300                    LDQ   ! 1,,PR0
         1 003652   400000 316207                    CANQ  ! -131072,DL
         1 003653   003663 600200 1                  TZE   ! s:9988

     1357     9983    4             DO;

     1358     9984    4             RBLK$->KQ$RBLK.FROMQ='1'B;

   9984  1 003654   100000 236207                    LDQ   ! 32768,DL
         1 003655   000001 256300                    ORSQ  ! 1,,PR0

     1359     9985    4             RBLK$->KQ$RBLK.QTN$=QTN$;

   9985  1 003656   200033 236300                    LDQ   ! QTN$,,AUTO
         1 003657   200006 470700                    LDP0  ! RBLK$,,AUTO
         1 003660   000021 756300                    STQ   ! 17,,PR0

     1360     9986    4             QTN$->KQ$QTN.CNACT=QTN$->KQ$QTN.CNACT+1;

   9986  1 003661   200033 475700                    LDP5  ! QTN$,,AUTO
         1 003662   500044 054300                    AOS   ! 36,,PR5

     1361     9987    4             END;
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:188  

     1362     9988    3           RBLK$->KQ$RBLK.STATE=RBSTATE;

   9988  1 003663   200064 720300                    LXL0  ! RBSTATE,,AUTO
         1 003664   000001 740300                    STX0  ! 1,,PR0

     1363     9989                %UNLOCK (G=DSTA$->KQ$STA.GATE);

   9990  1 003665   200036 236300                    LDQ   ! DSTA$,,AUTO
         1 003666   000016 036203                    ADLQ  ! 14,DU
         1 003667   200070 756300                    STQ   ! RBSTATE+4,,AUTO
         1 003670   200070 630700                    EPPR0 ! RBSTATE+4,,AUTO
         1 003671   000017 631600 xsym               EPPR1 ! B_VECTNIL+15
         1 003672   000000 701200 xent               TSX1  ! HFC$UNLOCK
         1 003673   000000 011200                    NOP   ! 0

     1364     9992                %UNLOCK (G=KQ$QTREE.GATE);

   9993  1 003674   200010 470700                    LDP0  ! CG$,,AUTO
         1 003675   000057 471700                    LDP1  ! 47,,PR0
         1 003676   200070 451700                    STP1  ! RBSTATE+4,,AUTO
         1 003677   200070 630700                    EPPR0 ! RBSTATE+4,,AUTO
         1 003700   000017 631600 xsym               EPPR1 ! B_VECTNIL+15
         1 003701   000000 701200 xent               TSX1  ! HFC$UNLOCK
         1 003702   000000 011200                    NOP   ! 0

     1365     9995    3           CALL KQQ$DQEOFTIME(KQ$CG,RBLK$);

   9995  1 003703   200006 630700                    EPPR0 ! RBLK$,,AUTO
         1 003704   200071 450700                    STP0  ! RBSTATE+5,,AUTO
         1 003705   200010 236300                    LDQ   ! CG$,,AUTO
         1 003706   200070 756300                    STQ   ! RBSTATE+4,,AUTO
         1 003707   200070 630700                    EPPR0 ! RBSTATE+4,,AUTO
         1 003710   000020 631600 xsym               EPPR1 ! B_VECTNIL+16
         1 003711   000000 701200 xent               TSX1  ! KQQ$DQEOFTIME
         1 003712   000000 011200                    NOP   ! 0

PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:189  
     1366     9996    3           RBLK$->KQ$RBLK.NCDDA=MBLK$->KQ$MBLK.DDA;

   9996  1 003713   200007 470700                    LDP0  ! MBLK$,,AUTO
         1 003714   200006 471700                    LDP1  ! RBLK$,,AUTO
         1 003715   000006 235300                    LDA   ! 6,,PR0
         1 003716   100011 755300                    STA   ! 9,,PR1

     1367     9997    3           RETURN;

   9997  1 003717   200062 221300                    LDX1  ! LOCK,,AUTO
         1 003720   000001 702211                    TSX2  ! 1,X1

     1368     9998    3   ALT:    ALTRETURN;

   9998  1 003721   200062 221300       ALT          LDX1  ! LOCK,,AUTO
         1 003722   000000 702211                    TSX2  ! 0,X1

     1369     9999    3           END;

     1370    10000    2   END MOVMCQ;

  10000  1 003723   000001 702211                    TSX2  ! 1,X1

     1371    10001        /*D* NAME:         MOVMC
     1372    10002             PURPOSE:      To move a message from the writing station
     1373    10003                           to a reading station.
     1374    10004             DESCRIPTION:  Just like MOVMCQ except the read was not found
     1375    10005                           in the queue, so we must call DEQUEUE to remove
     1376    10006                           it if it was.  This means unlocking the reading station
     1377    10007                           first, since the queue isn't already locked, and
     1378    10008                           one CANNOT lock a station and then the queue
     1379    10009                           (because we sometimes do the opposite).
     1380    10010        */
     1381    10011    1   MOVMC: PROC (M$) ALTRET;

  10011  1 003724   200060 741300       MOVMC        STX1  ! @M$+1,,AUTO

PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:190  
     1382    10012        /**/
     1383    10013    2   DCL M$ PTR;
     1384    10014    2   DCL RBSTATE UBIN;
     1385    10015        /**/
     1386    10016    2         RBSTATE=KQRS_XFDN#;

  10016  1 003725   000005 235007                    LDA     5,DL
         1 003726   200062 755100                    STA     RBSTATE,,AUTO

     1387    10017    2         GOTO MOVM;

  10017  1 003727   003733 710000 1                  TRA     MOVM

     1388    10018        /*D* NAME:         MOVMX
     1389    10019             PURPOSE:      To move a message from the writing station
     1390    10020                           to a reading station.
     1391    10021             DESCRIPTION:  Just like MOVMC but state is to be set to KQRS_XFIP#.
     1392    10022        */
     1393    10023    2   MOVMX: ENTRY (M$) ALTRET;

  10023  1 003730   200060 741300       MOVMX        STX1  ! @M$+1,,AUTO

     1394    10024        /**/
     1395    10025    3           DO INHIBIT;

     1396    10026    3           RBSTATE=KQRS_XFIP#;

  10026  1 003731   000003 235207                    LDA   ! 3,DL
         1 003732   200062 755300                    STA   ! RBSTATE,,AUTO

  10026  1 003733                       MOVM         null
     1397    10027    3   MOVM:   ;
     1398    10028    3           MBLK$=M$;

  10028  1 003733   200061 470700                    LDP0  ! @M$,,AUTO
         1 003734   000000 236300                    LDQ   ! 0,,PR0
         1 003735   200007 756300                    STQ   ! MBLK$,,AUTO
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:191  

     1399    10029    3           CALL CHECKVFC ALTRET(ALT);

  10029  1 003736   003551 701200 1                  TSX1  ! CHECKVFC
         1 003737   004025 702200 1                  TSX2  ! ALT

     1400    10030    3           M$=MBLK$->KQ$MBLK.LNK$;

  10030  1 003740   200007 470700                    LDP0  ! MBLK$,,AUTO
         1 003741   000000 236300                    LDQ   ! 0,,PR0
         1 003742   200061 471700                    LDP1  ! @M$,,AUTO
         1 003743   100000 756300                    STQ   ! 0,,PR1

     1401    10031    3           IF RBLK$->KQ$RBLK.MBLK$~=ADDR(NIL) THEN

  10031  1 003744   200006 473700                    LDP3  ! RBLK$,,AUTO
         1 003745   300000 236300                    LDQ   ! 0,,PR3
         1 003746   000001 116200 xsym               CMPQ  ! B_VECTNIL+1
         1 003747   003753 600200 1                  TZE   ! s:10033

     1402    10032    3            RBLK$->KQ$RBLK.MBLK$->KQ$MBLK.RBLK = '0'B;

  10032  1 003750   300000 474700                    LDP4  ! 0,,PR3
         1 003751   000017 236200 2                  LDQ   ! 15
         1 003752   400010 356300                    ANSQ  ! 8,,PR4

     1403    10033    3           RBLK$->KQ$RBLK.MBLK$=MBLK$;

  10033  1 003753   200007 236300                    LDQ   ! MBLK$,,AUTO
         1 003754   300000 756300                    STQ   ! 0,,PR3

     1404    10034    3           MBLK$->KQ$MBLK.RBLK = '1'B;

  10034  1 003755   000100 236207                    LDQ   ! 64,DL
         1 003756   000010 256300                    ORSQ  ! 8,,PR0

     1405    10035    3           MBLK$->KQ$MBLK.LNK$=ADDR(NIL);
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:192  

  10035  1 003757   000001 236200 xsym               LDQ   ! B_VECTNIL+1
         1 003760   000000 756300                    STQ   ! 0,,PR0

     1406    10036    3           RBLK$->KQ$RBLK.STATE=RBSTATE;

  10036  1 003761   200062 720300                    LXL0  ! RBSTATE,,AUTO
         1 003762   200006 473700                    LDP3  ! RBLK$,,AUTO
         1 003763   300001 740300                    STX0  ! 1,,PR3

     1407    10037                %UNLOCK (G=DSTA$->KQ$STA.GATE);

  10038  1 003764   200036 236300                    LDQ   ! DSTA$,,AUTO
         1 003765   000016 036203                    ADLQ  ! 14,DU
         1 003766   200070 756300                    STQ   ! RBSTATE+4,,AUTO
         1 003767   200070 630700                    EPPR0 ! RBSTATE+4,,AUTO
         1 003770   000017 631600 xsym               EPPR1 ! B_VECTNIL+15
         1 003771   000000 701200 xent               TSX1  ! HFC$UNLOCK
         1 003772   000000 011200                    NOP   ! 0

     1408    10040    3           IF NOT DSTA$->KQ$STA.TERM THEN

  10040  1 003773   200036 470700                    LDP0  ! DSTA$,,AUTO
         1 003774   000020 236300                    LDQ   ! 16,,PR0
         1 003775   040000 316203                    CANQ  ! 16384,DU
         1 003776   004017 601200 1                  TNZ   ! s:10045

     1409    10041    4             DO;

     1410    10042    4             CALL KQQ$DEQUEUE (CG$->KQ$CG,RBLK$);

  10042  1 003777   200006 631700                    EPPR1 ! RBLK$,,AUTO
         1 004000   200071 451700                    STP1  ! RBSTATE+5,,AUTO
         1 004001   200010 236300                    LDQ   ! CG$,,AUTO
         1 004002   200070 756300                    STQ   ! RBSTATE+4,,AUTO
         1 004003   200070 630700                    EPPR0 ! RBSTATE+4,,AUTO
         1 004004   000020 631600 xsym               EPPR1 ! B_VECTNIL+16
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:193  
         1 004005   000000 701200 xent               TSX1  ! KQQ$DEQUEUE
         1 004006   000000 011200                    NOP   ! 0

     1411    10043    4             CALL KQQ$DQEOFTIME(KQ$CG,RBLK$);

  10043  1 004007   200006 630700                    EPPR0 ! RBLK$,,AUTO
         1 004010   200071 450700                    STP0  ! RBSTATE+5,,AUTO
         1 004011   200010 236300                    LDQ   ! CG$,,AUTO
         1 004012   200070 756300                    STQ   ! RBSTATE+4,,AUTO
         1 004013   200070 630700                    EPPR0 ! RBSTATE+4,,AUTO
         1 004014   000020 631600 xsym               EPPR1 ! B_VECTNIL+16
         1 004015   000000 701200 xent               TSX1  ! KQQ$DQEOFTIME
         1 004016   000000 011200                    NOP   ! 0

     1412    10044    4             END;

     1413    10045    3           RBLK$->KQ$RBLK.NCDDA=MBLK$->KQ$MBLK.DDA;

  10045  1 004017   200007 470700                    LDP0  ! MBLK$,,AUTO
         1 004020   200006 471700                    LDP1  ! RBLK$,,AUTO
         1 004021   000006 235300                    LDA   ! 6,,PR0
         1 004022   100011 755300                    STA   ! 9,,PR1

     1414    10046    3           RETURN;

  10046  1 004023   200060 221300                    LDX1  ! @M$+1,,AUTO
         1 004024   000001 702211                    TSX2  ! 1,X1

     1415    10047    3   ALT:    ALTRETURN;

  10047  1 004025   200060 221300       ALT          LDX1  ! @M$+1,,AUTO
         1 004026   000000 702211                    TSX2  ! 0,X1

     1416    10048    3           END;

  10048  1 004027   004031 710000 1                  TRA     s:10056

PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:194  
     1417    10049        /*D* NAME:         MOVMXT
     1418    10050             PURPOSE:      To move a message from writer to reader
     1419    10051             DESCRIPTION:  Just like MOVMX except the reader is a terminal
     1420    10052                           Also sets SECURE in the RBLK if req'd.
     1421    10053        */
     1422    10054    2   MOVMXT: ENTRY (M$) ALTRET;

  10054  1 004030   200060 741300       MOVMXT       STX1  ! @M$+1,,AUTO

     1423    10055    3           DO INHIBIT;

     1424    10056    3           RBSTATE=KQRS_XFIP#;

  10056  1 004031   000003 235207                    LDA   ! 3,DL
         1 004032   200062 755300                    STA   ! RBSTATE,,AUTO

     1425    10057    3           GOTO MOVM;

  10057  1 004033   003733 710200 1                  TRA   ! MOVM

     1426    10058    3           END;

     1427    10059    2   END MOVMC;

  10059  1 004034   000001 702211                    TSX2  ! 1,X1

     1428    10060        /****************************************************************
     1429    10061        *****************************************************************/
     1430    10062        /*D* NAME:         SETWCOMP
     1431    10063             PURPOSE:      To set up for calling NIO$COMPCW for a write
     1432    10064             DESCRIPTION:  MBLK$ points to the writing MBLK,
     1433    10065                           and WRQ$ points to the writer's request packet.
     1434    10066
     1435    10067                           Fills in the appropriate VLP_STATION, and passes
     1436    10068                           it thru to I/O comp.
     1437    10069        */
     1438    10070    1   SETWCOMP: PROC;
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:195  

  10070  1 004035   200054 741300       SETWCOMP     STX1  ! NXTSTA$+1,,AUTO

     1439    10071    2         WRQ$->N$REQ.STATION.LSTA$=ADDR(VLP_STATION);

  10071  1 004036   200016 630500                    EPPR0   VLP_STATION,,AUTO
         1 004037   200037 471500                    LDP1    WRQ$,,AUTO
         1 004040   100013 450500                    STP0    11,,PR1

     1440    10072    2         VLP_STATION.CTL=VLP$->VLP$STATION.CTL;

  10072  1 004041   200011 473500                    LDP3    VLP$,,AUTO
         1 004042   300004 236100                    LDQ     4,,PR3
         1 004043   200022 676100                    ERQ     VLP_STATION+4,,AUTO
         1 004044   777400 376003                    ANQ     -256,DU
         1 004045   200022 656100                    ERSQ    VLP_STATION+4,,AUTO

     1441    10073    2         VLP_STATION.MSGID=MBLK$->KQ$MBLK.MID.PRIMARY;

  10073  1 004046   200007 470500                    LDP0    MBLK$,,AUTO
         1 004047   000014 235100                    LDA     12,,PR0
         1 004050   200023 755100                    STA     VLP_STATION+5,,AUTO

     1442    10074    2         VLP_STATION.MSGIDXT=BINBIT(MBLK$->KQ$MBLK.MID.XT,36);

  10074  1 004051   000015 236100                    LDQ     13,,PR0
         1 004052   200024 756100                    STQ     VLP_STATION+6,,AUTO

     1443    10075    2         IF CG$->KQ$CG.QISS THEN

  10075  1 004053   200010 474500                    LDP4    CG$,,AUTO
         1 004054   400106 235100                    LDA     70,,PR4
         1 004055   004061 600000 1                  TZE     s:10077

     1444    10076    2          VLP_STATION.MSGTYP=MBLK$->KQ$MBLK.KEY2;

  10076  1 004056   000004 237100                    LDAQ    4,,PR0
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:196  
         1 004057   200020 757100                    STAQ    VLP_STATION+2,,AUTO
         1 004060   004063 710000 1                  TRA     s:10078

     1445    10077    2         ELSE VLP_STATION.MSGTYP=MBLK$->KQ$MBLK.KEY1;

  10077  1 004061   000002 237100                    LDAQ    2,,PR0
         1 004062   200020 757100                    STAQ    VLP_STATION+2,,AUTO

     1446    10078    2         VLP_STATION.STATION=MBLK$->KQ$MBLK.DSTA;

  10078  1 004063   040100 100500                    MLR     fill='040'O
         1 004064   000011 000010                    ADSC9   9,,PR0                   cn=0,n=8
         1 004065   200016 000010                    ADSC9   VLP_STATION,,AUTO        cn=0,n=8

     1447    10079    2         RETURN;

  10079  1 004066   200054 221300                    LDX1  ! NXTSTA$+1,,AUTO
         1 004067   000001 702211                    TSX2  ! 1,X1

     1448    10080    2   END SETWCOMP;
     1449    10081        /****************************************************************
     1450    10082        *****************************************************************/
     1451    10083        /*D* NAME:         SENDMSG
     1452    10084             PURPOSE:      To send a message whose data is in DBLKs, to its
     1453    10085                           destination.
     1454    10086
     1455    10087                           STA$ points to the station doing the sending, and
     1456    10088                           M$ points to the msg.
     1457    10089
     1458    10090                           If MTYP$ ~= ADDR(NIL) then MTYP$ points to the
     1459    10091                           T-tree node for the message's type, and TACTCNT
     1460    10092                           is the T-tree ACTCNT from when this was established.
     1461    10093
     1462    10094                           If the message is to be journaled, sends it
     1463    10095                           to the journal station.
     1464    10096
     1465    10097                           If a reader is
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:197  
     1466    10098                           available to take the message, then it is given to
     1467    10099                           him via KQR$GOTMSG or KQG$GOTMSG (DCB or terminal
     1468    10100                           reader), and DSTA$ is returned pointing to the
     1469    10101                           accepting station.  Otherwise, the message is
     1470    10102                           inserted in the appropriate list and left there for
     1471    10103                           receipt later, and we return with DSTA$ pointing
     1472    10104                           to the receiving station (if directed write) or
     1473    10105                           ADDR(NIL) (if write into the queue).  For a directed
     1474    10106                           write whose destination is not there and WAS is
     1475    10107                           illegal, or the MSGTYP is not in the T-tree, the
     1476    10108                           message is deleted & we ALTRET with TYC = DISC/CGKEYV.
     1477    10109
     1478    10110                           M$ is set to the LNK$ of the MBLK it points to.
     1479    10111
     1480    10112                           In checking the destination on a directed write,
     1481    10113                           WAS is used instead of KQ$CG.AUCTL.WAS.  This is
     1482    10114                           because entry from KQW$SEND needs to disallow
     1483    10115                           write-to-absent station for terminals.
     1484    10116
     1485    10117        */
     1486    10118    1   SENDMSG: PROC (M$) ALTRET;

  10118  1 004070   200056 741300       SENDMSG      STX1  ! FOUND+1,,AUTO

     1487    10119        /**/
     1488    10120    2   DCL M$ PTR;
     1489    10121        /**/
     1490    10122    2         MBLK$=M$;

  10122  1 004071   200057 470500                    LDP0    @M$,,AUTO
         1 004072   000000 236100                    LDQ     0,,PR0
         1 004073   200007 756100                    STQ     MBLK$,,AUTO

     1491    10123        /**/
     1492    10124    2         IF  MBLK$->KQ$MBLK.JOURNAL = '1'B

  10124  1 004074   200007 471500                    LDP1    MBLK$,,AUTO
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:198  
         1 004075   100010 236100                    LDQ     8,,PR1
         1 004076   000400 316007                    CANQ    256,DL
         1 004077   004161 600000 1                  TZE     s:10150
         1 004100   040000 316003                    CANQ    16384,DU
         1 004101   004161 601000 1                  TNZ     s:10150
         1 004102   200010 473500                    LDP3    CG$,,AUTO
         1 004103   300136 236100                    LDQ     94,,PR3
         1 004104   000400 316003                    CANQ    256,DU
         1 004105   004161 600000 1                  TZE     s:10150

     1493    10125    2         AND MBLK$->KQ$MBLK.JRNLD = '0'B
     1494    10126    2         AND CG$->KQ$CG.AUCTL.JOURNAL THEN
     1495    10127    3           DO;

     1496    10128                %LOCK (G=KQ$STREE.GATE);

  10129  1 004106   200010 236100                    LDQ     CG$,,AUTO
         1 004107   000075 036003                    ADLQ    61,DU
         1 004110   200070 756100                    STQ     RBSTATE+4,,AUTO
         1 004111   200070 630500                    EPPR0   RBSTATE+4,,AUTO
         1 004112   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 004113   000000 701000 xent               TSX1    HFC$LOCK
         1 004114   000000 011000                    NOP     0

     1497    10131    3           IF CG$->KQ$CG.JRNLSTA$ ~= ADDR(NIL) THEN

  10131  1 004115   200010 470500                    LDP0    CG$,,AUTO
         1 004116   000210 236100                    LDQ     136,,PR0
         1 004117   000001 116000 xsym               CMPQ    B_VECTNIL+1
         1 004120   004152 600000 1                  TZE     s:10146

     1498    10132    4             DO;

     1499    10133    4             DSTA$=CG$->KQ$CG.JRNLSTA$;

  10133  1 004121   200036 756100                    STQ     DSTA$,,AUTO

PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:199  
     1500    10134                  %LOCK (G=DSTA$->KQ$STA.GATE);

  10135  1 004122   000016 036003                    ADLQ    14,DU
         1 004123   200070 756100                    STQ     RBSTATE+4,,AUTO
         1 004124   200070 630500                    EPPR0   RBSTATE+4,,AUTO
         1 004125   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 004126   000000 701000 xent               TSX1    HFC$LOCK
         1 004127   000000 011000                    NOP     0

     1501    10137                  %UNLOCK (G=KQ$STREE.GATE);

  10138  1 004130   200010 236100                    LDQ     CG$,,AUTO
         1 004131   000075 036003                    ADLQ    61,DU
         1 004132   200070 756100                    STQ     RBSTATE+4,,AUTO
         1 004133   200070 630500                    EPPR0   RBSTATE+4,,AUTO
         1 004134   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 004135   000000 701000 xent               TSX1    HFC$UNLOCK
         1 004136   000000 011000                    NOP     0

     1502    10140    4             IF  STA$->KQ$STA.TERM

  10140  1 004137   200005 470500                    LDP0    STA$,,AUTO
         1 004140   000020 236100                    LDQ     16,,PR0
         1 004141   040000 316003                    CANQ    16384,DU
         1 004142   004151 600000 1                  TZE     s:10143
         1 004143   000023 236100                    LDQ     19,,PR0
         1 004144   004000 316007                    CANQ    2048,DL
         1 004145   004151 600000 1                  TZE     s:10143

     1503    10141    4             AND STA$->KQ$STA.JRNLW THEN
     1504    10142    4              STA$->KQ$STA.JMSGID=MBLK$->KQ$MBLK.MID.PRIMARY;

  10142  1 004146   200007 471500                    LDP1    MBLK$,,AUTO
         1 004147   100014 235100                    LDA     12,,PR1
         1 004150   000025 755100                    STA     21,,PR0

     1505    10143    4             GOTO SENDD1;
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:200  

  10143  1 004151   004207 710000 1                  TRA     SENDD1

     1506    10144    4             END;
     1507    10145                %UNLOCK (G=KQ$STREE.GATE);

  10146  1 004152   200010 236100                    LDQ     CG$,,AUTO
         1 004153   000075 036003                    ADLQ    61,DU
         1 004154   200070 756100                    STQ     RBSTATE+4,,AUTO
         1 004155   200070 630500                    EPPR0   RBSTATE+4,,AUTO
         1 004156   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 004157   000000 701000 xent               TSX1    HFC$UNLOCK
         1 004160   000000 011000                    NOP     0

     1508    10148    3           END;

     1509    10149        /**/
     1510    10150    2         IF MBLK$->KQ$MBLK.DSTA ~= ' ' THEN

  10150  1 004161   200007 470500                    LDP0    MBLK$,,AUTO
         1 004162   040000 106500                    CMPC    fill='040'O
         1 004163   000011 000010                    ADSC9   9,,PR0                   cn=0,n=8
         1 004164   000035 000001 xsym               ADSC9   B_VECTNIL+29             cn=0,n=1
         1 004165   004364 600000 1                  TZE     s:10212

     1511    10151    3           DO;

     1512    10152                                /**********************************
     1513    10153                                 *                                *
     1514    10154                                 *       DIRECTED WRITE           *
     1515    10155                                 *                                *
     1516    10156                                 **********************************/
     1517    10157    3           CALL CHKSTAL ALTRET(NOSTA);

  10157  1 004166   003136 701000 1                  TSX1    CHKSTAL
         1 004167   004651 702000 1                  TSX2    NOSTA

PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:201  
  10157  1 004170                       SENDD        null
     1518    10158    3   SENDD:  ;
     1519    10159    3           IF MBLK$->KQ$MBLK.STAR THEN

  10159  1 004170   200007 470500                    LDP0    MBLK$,,AUTO
         1 004171   000010 236100                    LDQ     8,,PR0
         1 004172   100000 316003                    CANQ    32768,DU
         1 004173   004207 600000 1                  TZE     SENDD1

     1520    10160    3            IF MBLK$->KQ$MBLK.PRIO < %KQ_AUEP# THEN

  10160  1 004174   000001 220100                    LDX0    1,,PR0
         1 004175   765000 100003                    CMPX0   -5632,DU
         1 004176   004207 603000 1                  TRC     SENDD1

     1521    10161    3             IF DSTA$->KQ$STA.DSID > MBLK$->KQ$MBLK.MID.PRIMARY THEN

  10161  1 004177   200036 471500                    LDP1    DSTA$,,AUTO
         1 004200   000014 236100                    LDQ     12,,PR0
         1 004201   100022 116100                    CMPQ    18,,PR1
         1 004202   004207 603000 1                  TRC     SENDD1

     1522    10162    3              IF SUBSTR(DSTA$->KQ$STA.BTN.KEY,0,1) ~= '*' THEN

  10162  1 004203   100005 236100                    LDQ     5,,PR1
         1 004204   777000 376003                    ANQ     -512,DU
         1 004205   052000 116003                    CMPQ    21504,DU
         1 004206   004670 601000 1                  TNZ     NOSEND

     1523    10163    3               GOTO NOSEND;
     1524    10164    3   SENDD1: ;

  10164  1 004207                       SENDD1       null
     1525    10165    3           RBLK$=DSTA$->KQ$STA.RBLK$;

  10165  1 004207   200036 470500                    LDP0    DSTA$,,AUTO
         1 004210   000011 236100                    LDQ     9,,PR0
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:202  
         1 004211   200006 756100                    STQ     RBLK$,,AUTO

     1526    10166    3           IF RBLK$ ~= ADDR(NIL) THEN

  10166  1 004212   000001 116000 xsym               CMPQ    B_VECTNIL+1
         1 004213   004341 600000 1                  TZE     s:10200

     1527    10167    3            IF RBLK$->KQ$RBLK.STATE = KQRS_PEND# AND DSTA$->KQ$STA.MLH.BUSY='0'B THEN

  10167  1 004214   200006 471500                    LDP1    RBLK$,,AUTO
         1 004215   100001 220100                    LDX0    1,,PR1
         1 004216   000002 100003                    CMPX0   2,DU
         1 004217   004341 601000 1                  TNZ     s:10200
         1 004220   000037 236100                    LDQ     31,,PR0
         1 004221   000600 316003                    CANQ    384,DU
         1 004222   004341 601000 1                  TNZ     s:10200

     1528    10168    4              DO;

     1529    10169                           /* Give events to AU regardless of the keys
     1530    10170                              specified on his read. */
     1531    10171    4              IF MBLK$->KQ$MBLK.PRIO >= %KQ_AUEP# THEN

  10171  1 004223   200007 473500                    LDP3    MBLK$,,AUTO
         1 004224   300001 221100                    LDX1    1,,PR3
         1 004225   765000 101003                    CMPX1   -5632,DU
         1 004226   004232 602000 1                  TNC     s:10173

     1532    10172    4               IF NOT RBLK$->KQ$RBLK.HONK THEN GOTO SENDAU;

  10172  1 004227   100001 236100                    LDQ     1,,PR1
         1 004230   000400 316007                    CANQ    256,DL
         1 004231   004266 600000 1                  TZE     SENDD2

     1533    10173    4              KEY1L=RBLK$->KQ$RBLK.KEY1L;

  10173  1 004232   100001 236100                    LDQ     1,,PR1
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:203  
         1 004233   000004 772000                    QRL     4
         1 004234   000017 376007                    ANQ     15,DL
         1 004235   200012 756100                    STQ     KEY1L,,AUTO

     1534    10174    4              KEY2L=RBLK$->KQ$RBLK.KEY2L;

  10174  1 004236   100001 236100                    LDQ     1,,PR1
         1 004237   000017 376007                    ANQ     15,DL
         1 004240   200013 756100                    STQ     KEY2L,,AUTO

     1535    10175    4              IF  ADDR(RBLK$->KQ$RBLK.KEY1)->B$$KEY1 = ADDR(MBLK$->KQ$MBLK.KEY1)->
             10175                       B$$KEY1

  10175  1 004241   200012 722100                    LXL2    KEY1L,,AUTO
         1 004242   040140 106540                    CMPC    fill='040'O
         1 004243   100002 000012                    ADSC9   2,,PR1                   cn=0,n=*X2
         1 004244   300002 000012                    ADSC9   2,,PR3                   cn=0,n=*X2
         1 004245   004341 601000 1                  TNZ     s:10200
         1 004246   000000 623006                    EAX3    0,QL
         1 004247   200013 724100                    LXL4    KEY2L,,AUTO
         1 004250   040140 106540                    CMPC    fill='040'O
         1 004251   100004 000013                    ADSC9   4,,PR1                   cn=0,n=*X3
         1 004252   300004 000014                    ADSC9   4,,PR3                   cn=0,n=*X4
         1 004253   004341 601000 1                  TNZ     s:10200
         1 004254   100006 235100                    LDA     6,,PR1
         1 004255   004261 600000 1                  TZE     s:10180
         1 004256   100006 236100                    LDQ     6,,PR1
         1 004257   300014 116100                    CMPQ    12,,PR3
         1 004260   004341 601000 1                  TNZ     s:10200

     1536    10176    4              AND ADDR(RBLK$->KQ$RBLK.KEY2)->B$$KEY2 = ADDR(MBLK$->KQ$MBLK.KEY2)->
             10176                       B$$KEY2
     1537    10177    4              AND ((RBLK$->KQ$RBLK.MID.PRIMARY = 0) OR
     1538    10178    4              (RBLK$->KQ$RBLK.MID.PRIMARY = MBLK$->KQ$MBLK.MID.PRIMARY)) THEN
     1539    10179    5                DO;

     1540    10180    5                IF DSTA$->KQ$STA.LDCT$->NK$LDCT.RESCOD = NK_CGDCB THEN
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:204  

  10180  1 004261   000010 474500                    LDP4    8,,PR0
         1 004262   400006 236100                    LDQ     6,,PR4
         1 004263   000017 376007                    ANQ     15,DL
         1 004264   000004 116007                    CMPQ    4,DL
         1 004265   004305 601000 1                  TNZ     s:10187

     1541    10181    6   SENDD2:        DO INHIBIT;

  10181  1 004266                       SENDD2       null
     1542    10182    6   SENDAU:        CALL MOVMX (M$) ALTRET(NOSEND);

  10182  1 004266   200057 236300       SENDAU       LDQ   ! @M$,,AUTO
         1 004267   200061 756300                    STQ   ! @M$,,AUTO
         1 004270   003730 701200 1                  TSX1  ! MOVMX
         1 004271   004670 702200 1                  TSX2  ! NOSEND

     1543    10183    6   SENDDCB:       CALL KQR$GOTMSG (DSTA$->KQ$STA.LDCT$->NK$LDCT.IOQ$->N$REQ);

  10183  1 004272   200036 470700       SENDDCB      LDP0  ! DSTA$,,AUTO
         1 004273   000010 471700                    LDP1  ! 8,,PR0
         1 004274   100001 473700                    LDP3  ! 1,,PR1
         1 004275   200070 453700                    STP3  ! RBSTATE+4,,AUTO
         1 004276   200070 630700                    EPPR0 ! RBSTATE+4,,AUTO
         1 004277   000017 631600 xsym               EPPR1 ! B_VECTNIL+15
         1 004300   000000 701200 xent               TSX1  ! KQR$GOTMSG
         1 004301   000000 011200                    NOP   ! 0

     1544    10184    6                  RETURN;

  10184  1 004302   200056 221300                    LDX1  ! FOUND+1,,AUTO
         1 004303   000001 702211                    TSX2  ! 1,X1

     1545    10185    6                  END;

  10185  1 004304   004341 710000 1                  TRA     s:10200

PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:205  
     1546    10186    5                ELSE
     1547    10187    5                 IF RBLK$->KQ$RBLK.MID.PRIMARY = 0

  10187  1 004305   000000 115003                    CMPA    0,DU
         1 004306   004312 600000 1                  TZE     SENDD3
         1 004307   100006 236100                    LDQ     6,,PR1
         1 004310   300014 116100                    CMPQ    12,,PR3
         1 004311   004341 601000 1                  TNZ     s:10200

     1548    10188    5                 OR RBLK$->KQ$RBLK.MID.PRIMARY = MBLK$->KQ$MBLK.MID.PRIMARY THEN
     1549    10189    6   SENDD3:         DO INHIBIT;

  10189  1 004312                       SENDD3       null
     1550    10190    6                   DSTA$->KQ$STA.LOCKCNT=DSTA$->KQ$STA.LOCKCNT+1;

  10190  1 004312   200036 470700                    LDP0  ! DSTA$,,AUTO
         1 004313   000020 236300                    LDQ   ! 16,,PR0
         1 004314   000001 036207                    ADLQ  ! 1,DL
         1 004315   000020 552304                    STBQ  ! 16,'04'O,PR0

     1551    10191    7                   CALL MOVMXT (M$) WHENALTRETURN DO;

  10191  1 004316   200057 236300                    LDQ   ! @M$,,AUTO
         1 004317   200061 756300                    STQ   ! @M$,,AUTO
         1 004320   004030 701200 1                  TSX1  ! MOVMXT
         1 004321   004323 702200 1                  TSX2  ! s:10192
         1 004322   004330 710200 1                  TRA   ! s:10195

     1552    10192    7                     DSTA$->KQ$STA.LOCKCNT = DSTA$->KQ$STA.LOCKCNT-1;

  10192  1 004323   200036 470700                    LDP0  ! DSTA$,,AUTO
         1 004324   000020 236300                    LDQ   ! 16,,PR0
         1 004325   000777 036207                    ADLQ  ! 511,DL
         1 004326   000020 552304                    STBQ  ! 16,'04'O,PR0

     1553    10193    7                     GOTO NOSEND;

PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:206  
  10193  1 004327   004670 710200 1                  TRA   ! NOSEND

     1554    10194    7                     END;
     1555    10195    6                   CALL KQG$GOTMSG (DSTA$->KQ$STA.LDCT$->NK$LDCT);

  10195  1 004330   200036 470700                    LDP0  ! DSTA$,,AUTO
         1 004331   000010 471700                    LDP1  ! 8,,PR0
         1 004332   200070 451700                    STP1  ! RBSTATE+4,,AUTO
         1 004333   200070 630700                    EPPR0 ! RBSTATE+4,,AUTO
         1 004334   000017 631600 xsym               EPPR1 ! B_VECTNIL+15
         1 004335   000000 701200 xent               TSX1  ! KQG$GOTMSG
         1 004336   000000 011200                    NOP   ! 0

     1556    10196    6                   RETURN;

  10196  1 004337   200056 221300                    LDX1  ! FOUND+1,,AUTO
         1 004340   000001 702211                    TSX2  ! 1,X1

     1557    10197    6                   END;

     1558    10198    5                END;

     1559    10199    4              END;

     1560    10200    3           CALL KQL$INSERT (CG$->KQ$CG,DSTA$->KQ$STA.MLH,M$);

  10200  1 004341   200057 236100                    LDQ     @M$,,AUTO
         1 004342   200072 756100                    STQ     RBSTATE+6,,AUTO
         1 004343   200036 236100                    LDQ     DSTA$,,AUTO
         1 004344   000034 036003                    ADLQ    28,DU
         1 004345   200010 235100                    LDA     CG$,,AUTO
         1 004346   200070 757100                    STAQ    RBSTATE+4,,AUTO
         1 004347   200070 630500                    EPPR0   RBSTATE+4,,AUTO
         1 004350   000021 631400 xsym               EPPR1   B_VECTNIL+17
         1 004351   000000 701000 xent               TSX1    KQL$INSERT
         1 004352   000000 011000                    NOP     0

PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:207  
     1561    10201                %UNLOCK (G=DSTA$->KQ$STA.GATE);

  10202  1 004353   200036 236100                    LDQ     DSTA$,,AUTO
         1 004354   000016 036003                    ADLQ    14,DU
         1 004355   200070 756100                    STQ     RBSTATE+4,,AUTO
         1 004356   200070 630500                    EPPR0   RBSTATE+4,,AUTO
         1 004357   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 004360   000000 701000 xent               TSX1    HFC$UNLOCK
         1 004361   000000 011000                    NOP     0

     1562    10204    3           RETURN;

  10204  1 004362   200056 221300                    LDX1  ! FOUND+1,,AUTO
         1 004363   000001 702211                    TSX2  ! 1,X1

     1563    10205    3           END;
     1564    10206                                /**********************************
     1565    10207                                 *                                *
     1566    10208                                 *       WRITE TO QUEUE           *
     1567    10209                                 *                                *
     1568    10210                                 **********************************/
     1569    10211              %LOCK (G=KQ$QTREE.GATE);

  10212  1 004364   200010 471500                    LDP1    CG$,,AUTO
         1 004365   100057 473500                    LDP3    47,,PR1
         1 004366   200070 453500                    STP3    RBSTATE+4,,AUTO
         1 004367   200070 630500                    EPPR0   RBSTATE+4,,AUTO
         1 004370   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 004371   000000 701000 xent               TSX1    HFC$LOCK
         1 004372   000000 011000                    NOP     0

     1570    10214    2         IF CG$->KQ$CG.QISS THEN

  10214  1 004373   200010 470500                    LDP0    CG$,,AUTO
         1 004374   000106 235100                    LDA     70,,PR0
         1 004375   004423 600000 1                  TZE     s:10221

PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:208  
     1571    10215    2          IF STA$->KQ$STA.BTN.KEY = '*FWCG' THEN

  10215  1 004376   200005 471500                    LDP1    STA$,,AUTO
         1 004377   040000 106500                    CMPC    fill='040'O
         1 004400   100005 000010                    ADSC9   5,,PR1                   cn=0,n=8
         1 004401   000012 000005 0                  ADSC9   10                       cn=0,n=5
         1 004402   004420 601000 1                  TNZ     s:10218

     1572    10216    2           CALL KQB$SRCH (KQ$STREE,MBLK$->KQ$MBLK.KEY1,QTN$) ALTRET(NOSTA);

  10216  1 004403   200033 633500                    EPPR3   QTN$,,AUTO
         1 004404   200072 453500                    STP3    RBSTATE+6,,AUTO
         1 004405   200007 236100                    LDQ     MBLK$,,AUTO
         1 004406   000002 036003                    ADLQ    2,DU
         1 004407   200071 756100                    STQ     RBSTATE+5,,AUTO
         1 004410   200010 236100                    LDQ     CG$,,AUTO
         1 004411   000075 036003                    ADLQ    61,DU
         1 004412   200070 756100                    STQ     RBSTATE+4,,AUTO
         1 004413   200070 630500                    EPPR0   RBSTATE+4,,AUTO
         1 004414   000021 631400 xsym               EPPR1   B_VECTNIL+17
         1 004415   000000 701000 xent               TSX1    KQB$SRCH
         1 004416   004651 702000 1                  TSX2    NOSTA
         1 004417   004447 710000 1                  TRA     SENDQ

     1573    10217    2          ELSE
     1574    10218    2           QTN$ = STA$;    /* ASSIGN IT TO THIS STATION */

  10218  1 004420   200005 236100                    LDQ     STA$,,AUTO
         1 004421   200033 756100                    STQ     QTN$,,AUTO
         1 004422   004447 710000 1                  TRA     SENDQ

     1575    10219    2         ELSE
     1576    10220    3           DO;

     1577    10221    3           IF  MTYP$ ~= ADDR(NIL)

  10221  1 004423   200035 236100                    LDQ     MTYP$,,AUTO
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:209  
         1 004424   000001 116000 xsym               CMPQ    B_VECTNIL+1
         1 004425   004433 600000 1                  TZE     s:10225
         1 004426   200043 220100                    LDX0    TACTCNT,,AUTO
         1 004427   000074 100100                    CMPX0   60,,PR0
         1 004430   004433 601000 1                  TNZ     s:10225

     1578    10222    3           AND TACTCNT = KQ$TTREE.ACTCNT THEN
     1579    10223    3            QTN$=MTYP$;

  10223  1 004431   200033 756100                    STQ     QTN$,,AUTO
         1 004432   004447 710000 1                  TRA     SENDQ

     1580    10224    3           ELSE
     1581    10225    3            CALL KQB$SRCH (KQ$TTREE,MBLK$->KQ$MBLK.KEY1,QTN$) ALTRET(NOTYP);

  10225  1 004433   200033 631500                    EPPR1   QTN$,,AUTO
         1 004434   200072 451500                    STP1    RBSTATE+6,,AUTO
         1 004435   200007 236100                    LDQ     MBLK$,,AUTO
         1 004436   000002 036003                    ADLQ    2,DU
         1 004437   200071 756100                    STQ     RBSTATE+5,,AUTO
         1 004440   200010 236100                    LDQ     CG$,,AUTO
         1 004441   000067 036003                    ADLQ    55,DU
         1 004442   200070 756100                    STQ     RBSTATE+4,,AUTO
         1 004443   200070 630500                    EPPR0   RBSTATE+4,,AUTO
         1 004444   000021 631400 xsym               EPPR1   B_VECTNIL+17
         1 004445   000000 701000 xent               TSX1    KQB$SRCH
         1 004446   004637 702000 1                  TSX2    NOTYP

     1582    10226    3           END;

  10221  1 004447                       SENDQ        null
     1583    10227    2   SENDQ:;
     1584    10228    2         IF KQ$QUEUE.BUSY THEN

  10228  1 004447   200010 470500                    LDP0    CG$,,AUTO
         1 004450   000063 236100                    LDQ     51,,PR0
         1 004451   000600 316003                    CANQ    384,DU
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:210  
         1 004452   004465 600000 1                  TZE     SENDQ1

     1585    10229    3           DO INHIBIT;

     1586    10230    3           CALL KQL$QDELAYM (CG$->KQ$CG,M$);

  10230  1 004453   200057 236300                    LDQ   ! @M$,,AUTO
         1 004454   200010 235300                    LDA   ! CG$,,AUTO
         1 004455   200070 757300                    STAQ  ! RBSTATE+4,,AUTO
         1 004456   200070 630700                    EPPR0 ! RBSTATE+4,,AUTO
         1 004457   000020 631600 xsym               EPPR1 ! B_VECTNIL+16
         1 004460   000000 701200 xent               TSX1  ! KQL$QDELAYM
         1 004461   000000 011200                    NOP   ! 0

     1587    10231    3           CG$->KQ$CG.STATS.CCMQ=CG$->KQ$CG.STATS.CCMQ+1;

  10231  1 004462   200010 470700                    LDP0  ! CG$,,AUTO
         1 004463   000171 054300                    AOS   ! 121,,PR0

     1588    10232    3           GOTO SENDQXIT;

  10232  1 004464   004624 710200 1                  TRA   ! SENDQXIT

     1589    10233    3           END;

  10228  1 004465                       SENDQ1       null
     1590    10234    2   SENDQ1:;
     1591    10235    2         IF QTN$->KQ$QTN.CNACT < QTN$->KQ$QTN.MXACT THEN

  10235  1 004465   200033 470500                    LDP0    QTN$,,AUTO
         1 004466   000044 236100                    LDQ     36,,PR0
         1 004467   000045 116100                    CMPQ    37,,PR0
         1 004470   004612 605000 1                  TPL     s:10266

     1592    10236    3           DO;

     1593    10237    3           P$=ADDR(QTN$->KQ$QTN.READS$);
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:211  

  10237  1 004471   200033 236100                    LDQ     QTN$,,AUTO
         1 004472   000046 036003                    ADLQ    38,DU
         1 004473   200014 756100                    STQ     P$,,AUTO

     1594    10238    3           RBLK$=P$->B$$PTR;

  10238  1 004474   200014 471500                    LDP1    P$,,AUTO
         1 004475   100000 236100                    LDQ     0,,PR1
         1 004476   200006 756100                    STQ     RBLK$,,AUTO

     1595    10239    4             DO WHILE (RBLK$ ~= ADDR(NIL));

  10239  1 004477   004533 710000 1                  TRA     s:10249

     1596    10240    4             KEY2L=RBLK$->KQ$RBLK.KEY2L;

  10240  1 004500   200006 470500                    LDP0    RBLK$,,AUTO
         1 004501   000001 236100                    LDQ     1,,PR0
         1 004502   000017 376007                    ANQ     15,DL
         1 004503   200013 756100                    STQ     KEY2L,,AUTO

     1597    10241    4            IF ADDR(RBLK$->KQ$RBLK.KEY2)->B$$KEY2 = ADDR(MBLK$->KQ$MBLK.KEY2)->B$$KEY2

  10241  1 004504   000000 620006                    EAX0    0,QL
         1 004505   200007 471500                    LDP1    MBLK$,,AUTO
         1 004506   200013 721100                    LXL1    KEY2L,,AUTO
         1 004507   040140 106540                    CMPC    fill='040'O
         1 004510   000004 000010                    ADSC9   4,,PR0                   cn=0,n=*X0
         1 004511   100004 000011                    ADSC9   4,,PR1                   cn=0,n=*X1
         1 004512   004525 601000 1                  TNZ     s:10247
         1 004513   000006 235100                    LDA     6,,PR0
         1 004514   004520 600000 1                  TZE     s:10244
         1 004515   000006 236100                    LDQ     6,,PR0
         1 004516   100014 116100                    CMPQ    12,,PR1
         1 004517   004525 601000 1                  TNZ     s:10247

PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:212  
     1598    10242    4             AND ((RBLK$->KQ$RBLK.MID.PRIMARY = 0) OR
     1599    10243    5             (RBLK$->KQ$RBLK.MID.PRIMARY = MBLK$->KQ$MBLK.MID.PRIMARY)) THEN DO;

     1600    10244    5               CALL SENDIT ALTRET(SENDDCB);

  10244  1 004520   004714 701000 1                  TSX1    SENDIT
         1 004521   004272 702000 1                  TSX2    SENDDCB

     1601    10245    5               IF DEST=3 THEN GOTO NOSEND;

  10245  1 004522   200044 235100                    LDA     DEST,,AUTO
         1 004523   000003 115007                    CMPA    3,DL
         1 004524   004670 600000 1                  TZE     NOSEND

     1602    10246    5               END;

     1603    10247    4             P$=ADDR(RBLK$->KQ$RBLK.QRLNK$);

  10247  1 004525   200006 236100                    LDQ     RBLK$,,AUTO
         1 004526   000020 036003                    ADLQ    16,DU
         1 004527   200014 756100                    STQ     P$,,AUTO

     1604    10248    4             RBLK$=P$->B$$PTR;

  10248  1 004530   200014 470500                    LDP0    P$,,AUTO
         1 004531   000000 236100                    LDQ     0,,PR0
         1 004532   200006 756100                    STQ     RBLK$,,AUTO

     1605    10249    4             END;

  10249  1 004533   000001 116000 xsym               CMPQ    B_VECTNIL+1
         1 004534   004500 601000 1                  TNZ     s:10240

     1606    10250    3           P$=ADDR(KQ$QUEUE.WCRL$);

  10250  1 004535   200010 236100                    LDQ     CG$,,AUTO
         1 004536   000060 036003                    ADLQ    48,DU
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:213  
         1 004537   200014 756100                    STQ     P$,,AUTO

     1607    10251    3           RBLK$=P$->B$$PTR;

  10251  1 004540   200014 470500                    LDP0    P$,,AUTO
         1 004541   000000 236100                    LDQ     0,,PR0
         1 004542   200006 756100                    STQ     RBLK$,,AUTO

     1608    10252    4             DO WHILE (RBLK$ ~= ADDR(NIL));

  10252  1 004543   004610 710000 1                  TRA     s:10264

     1609    10253    4             KEY1L=RBLK$->KQ$RBLK.KEY1L;

  10253  1 004544   200006 470500                    LDP0    RBLK$,,AUTO
         1 004545   000001 236100                    LDQ     1,,PR0
         1 004546   000004 772000                    QRL     4
         1 004547   000017 376007                    ANQ     15,DL
         1 004550   200012 756100                    STQ     KEY1L,,AUTO

     1610    10254    4             KEY2L=RBLK$->KQ$RBLK.KEY2L;

  10254  1 004551   000001 236100                    LDQ     1,,PR0
         1 004552   000017 376007                    ANQ     15,DL
         1 004553   200013 756100                    STQ     KEY2L,,AUTO

     1611    10255    4             IF  ADDR(RBLK$->KQ$RBLK.KEY1)->B$$KEY1 = ADDR(MBLK$->KQ$MBLK.KEY1)->
             10255                      B$$KEY1

  10255  1 004554   200012 720100                    LXL0    KEY1L,,AUTO
         1 004555   200007 471500                    LDP1    MBLK$,,AUTO
         1 004556   040140 106540                    CMPC    fill='040'O
         1 004557   000002 000010                    ADSC9   2,,PR0                   cn=0,n=*X0
         1 004560   100002 000010                    ADSC9   2,,PR1                   cn=0,n=*X0
         1 004561   004602 601000 1                  TNZ     s:10262
         1 004562   000000 621006                    EAX1    0,QL
         1 004563   200013 722100                    LXL2    KEY2L,,AUTO
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:214  
         1 004564   040140 106540                    CMPC    fill='040'O
         1 004565   000004 000011                    ADSC9   4,,PR0                   cn=0,n=*X1
         1 004566   100004 000012                    ADSC9   4,,PR1                   cn=0,n=*X2
         1 004567   004602 601000 1                  TNZ     s:10262
         1 004570   000006 235100                    LDA     6,,PR0
         1 004571   004575 600000 1                  TZE     s:10259
         1 004572   000006 236100                    LDQ     6,,PR0
         1 004573   100014 116100                    CMPQ    12,,PR1
         1 004574   004602 601000 1                  TNZ     s:10262

     1612    10256    4             AND ADDR(RBLK$->KQ$RBLK.KEY2)->B$$KEY2 = ADDR(MBLK$->KQ$MBLK.KEY2)->
             10256                      B$$KEY2
     1613    10257    4             AND ((RBLK$->KQ$RBLK.MID.PRIMARY = 0) OR
     1614    10258    5             (RBLK$->KQ$RBLK.MID.PRIMARY = MBLK$->KQ$MBLK.MID.PRIMARY)) THEN DO;

     1615    10259    5               CALL SENDIT ALTRET(SENDDCB);

  10259  1 004575   004714 701000 1                  TSX1    SENDIT
         1 004576   004272 702000 1                  TSX2    SENDDCB

     1616    10260    5               IF DEST=3 THEN GOTO NOSEND;

  10260  1 004577   200044 235100                    LDA     DEST,,AUTO
         1 004600   000003 115007                    CMPA    3,DL
         1 004601   004670 600000 1                  TZE     NOSEND

     1617    10261    5               END;

     1618    10262    4             P$=ADDR(RBLK$->KQ$RBLK.QRLNK$);

  10262  1 004602   200006 236100                    LDQ     RBLK$,,AUTO
         1 004603   000020 036003                    ADLQ    16,DU
         1 004604   200014 756100                    STQ     P$,,AUTO

     1619    10263    4             RBLK$=P$->B$$PTR;

  10263  1 004605   200014 470500                    LDP0    P$,,AUTO
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:215  
         1 004606   000000 236100                    LDQ     0,,PR0
         1 004607   200006 756100                    STQ     RBLK$,,AUTO

     1620    10264    4             END;

  10264  1 004610   000001 116000 xsym               CMPQ    B_VECTNIL+1
         1 004611   004544 601000 1                  TNZ     s:10253

     1621    10265    3           END;

     1622    10266    2         CALL KQL$INSERT (CG$->KQ$CG,QTN$->KQ$QTN.MLH,M$);

  10266  1 004612   200057 236100                    LDQ     @M$,,AUTO
         1 004613   200072 756100                    STQ     RBSTATE+6,,AUTO
         1 004614   200033 236100                    LDQ     QTN$,,AUTO
         1 004615   000055 036003                    ADLQ    45,DU
         1 004616   200010 235100                    LDA     CG$,,AUTO
         1 004617   200070 757100                    STAQ    RBSTATE+4,,AUTO
         1 004620   200070 630500                    EPPR0   RBSTATE+4,,AUTO
         1 004621   000021 631400 xsym               EPPR1   B_VECTNIL+17
         1 004622   000000 701000 xent               TSX1    KQL$INSERT
         1 004623   000000 011000                    NOP     0

  10266  1 004624                       SENDQXIT     null
     1623    10267    2   SENDQXIT:;
     1624    10268    2         DSTA$=ADDR(NIL);

  10268  1 004624   000001 236000 xsym               LDQ     B_VECTNIL+1
         1 004625   200036 756100                    STQ     DSTA$,,AUTO

     1625    10269              %UNLOCK (G=KQ$QTREE.GATE);

  10270  1 004626   200010 470500                    LDP0    CG$,,AUTO
         1 004627   000057 471500                    LDP1    47,,PR0
         1 004630   200070 451500                    STP1    RBSTATE+4,,AUTO
         1 004631   200070 630500                    EPPR0   RBSTATE+4,,AUTO
         1 004632   000017 631400 xsym               EPPR1   B_VECTNIL+15
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:216  
         1 004633   000000 701000 xent               TSX1    HFC$UNLOCK
         1 004634   000000 011000                    NOP     0

     1626    10272    2         RETURN;

  10272  1 004635   200056 221300                    LDX1  ! FOUND+1,,AUTO
         1 004636   000001 702211                    TSX2  ! 1,X1

  10268  1 004637                       NOTYP        null
     1627    10273    2   NOTYP:;
     1628    10274              %UNLOCK (G=KQ$QTREE.GATE);

  10275  1 004637   200010 470500                    LDP0    CG$,,AUTO
         1 004640   000057 471500                    LDP1    47,,PR0
         1 004641   200070 451500                    STP1    RBSTATE+4,,AUTO
         1 004642   200070 630500                    EPPR0   RBSTATE+4,,AUTO
         1 004643   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 004644   000000 701000 xent               TSX1    HFC$UNLOCK
         1 004645   000000 011000                    NOP     0

     1629    10277    2         TYC=%TYC_CGKEYV;

  10277  1 004646   000006 236000 0                  LDQ     6
         1 004647   200034 756100                    STQ     TYC,,AUTO

     1630    10278    2         GOTO DUMPALT;

  10278  1 004650   004653 710000 1                  TRA     DUMPALT

  10277  1 004651                       NOSTA        null
     1631    10279    2   NOSTA: ;
     1632    10280    2         TYC=%TYC_DISC;

  10280  1 004651   000011 236000 0                  LDQ     9
         1 004652   200034 756100                    STQ     TYC,,AUTO

  10280  1 004653                       DUMPALT      null
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:217  
     1633    10281    2   DUMPALT:;
     1634    10282    2         M$=MBLK$->KQ$MBLK.LNK$;

  10282  1 004653   200007 470500                    LDP0    MBLK$,,AUTO
         1 004654   000000 236100                    LDQ     0,,PR0
         1 004655   200057 471500                    LDP1    @M$,,AUTO
         1 004656   100000 756100                    STQ     0,,PR1

     1635    10283    2         CALL KQU$DELMSG (CG$->KQ$CG,MBLK$->KQ$MBLK);

  10283  1 004657   200007 236100                    LDQ     MBLK$,,AUTO
         1 004660   200010 235100                    LDA     CG$,,AUTO
         1 004661   200070 757100                    STAQ    RBSTATE+4,,AUTO
         1 004662   200070 630500                    EPPR0   RBSTATE+4,,AUTO
         1 004663   000020 631400 xsym               EPPR1   B_VECTNIL+16
         1 004664   000000 701000 xent               TSX1    KQU$DELMSG
         1 004665   000000 011000                    NOP     0

     1636    10284    2         ALTRETURN;

  10284  1 004666   200056 221300                    LDX1  ! FOUND+1,,AUTO
         1 004667   000000 702211                    TSX2  ! 0,X1

  10282  1 004670                       NOSEND       null
     1637    10285    2   NOSEND:;
     1638    10286    2         M$=MBLK$->KQ$MBLK.LNK$;

  10286  1 004670   200007 470500                    LDP0    MBLK$,,AUTO
         1 004671   000000 236100                    LDQ     0,,PR0
         1 004672   200057 471500                    LDP1    @M$,,AUTO
         1 004673   100000 756100                    STQ     0,,PR1

     1639    10287              %UNLOCK (G=DSTA$->KQ$STA.GATE);

  10288  1 004674   200036 236100                    LDQ     DSTA$,,AUTO
         1 004675   000016 036003                    ADLQ    14,DU
         1 004676   200070 756100                    STQ     RBSTATE+4,,AUTO
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:218  
         1 004677   200070 630500                    EPPR0   RBSTATE+4,,AUTO
         1 004700   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 004701   000000 701000 xent               TSX1    HFC$UNLOCK
         1 004702   000000 011000                    NOP     0

     1640    10290    2         CALL KQU$DELMSG (CG$->KQ$CG,MBLK$->KQ$MBLK);

  10290  1 004703   200007 236100                    LDQ     MBLK$,,AUTO
         1 004704   200010 235100                    LDA     CG$,,AUTO
         1 004705   200070 757100                    STAQ    RBSTATE+4,,AUTO
         1 004706   200070 630500                    EPPR0   RBSTATE+4,,AUTO
         1 004707   000020 631400 xsym               EPPR1   B_VECTNIL+16
         1 004710   000000 701000 xent               TSX1    KQU$DELMSG
         1 004711   000000 011000                    NOP     0

     1641    10291    2         RETURN;

  10291  1 004712   200056 221300                    LDX1  ! FOUND+1,,AUTO
         1 004713   000001 702211                    TSX2  ! 1,X1

     1642    10292    2   SENDIT: PROC ALTRET;

  10292  1 004714   200060 741300       SENDIT       STX1  ! @M$+1,,AUTO

     1643    10293    3         DSTA$=RBLK$->KQ$RBLK.STA$;

  10293  1 004715   200006 470500                    LDP0    RBLK$,,AUTO
         1 004716   000012 236100                    LDQ     10,,PR0
         1 004717   200036 756100                    STQ     DSTA$,,AUTO

     1644    10294    3         DEST = 0;

  10294  1 004720   200044 450100                    STZ     DEST,,AUTO

     1645    10295              %LOCK (G=DSTA$->KQ$STA.GATE);

  10296  1 004721   000016 036003                    ADLQ    14,DU
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:219  
         1 004722   200070 756100                    STQ     RBSTATE+4,,AUTO
         1 004723   200070 630500                    EPPR0   RBSTATE+4,,AUTO
         1 004724   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 004725   000000 701000 xent               TSX1    HFC$LOCK
         1 004726   000000 011000                    NOP     0

     1646    10298    3         IF RBLK$->KQ$RBLK.STATE = KQRS_PEND# THEN

  10298  1 004727   200006 470500                    LDP0    RBLK$,,AUTO
         1 004730   000001 220100                    LDX0    1,,PR0
         1 004731   000002 100003                    CMPX0   2,DU
         1 004732   004741 601000 1                  TNZ     s:10304

     1647    10299    4           DO;

     1648    10300    4           CALL MOVMXQ (M$) ALTRET(BADVFC);

  10300  1 004733   200057 236100                    LDQ     @M$,,AUTO
         1 004734   200063 756100                    STQ     @M$,,AUTO
         1 004735   003610 701000 1                  TSX1    MOVMXQ
         1 004736   004751 702000 1                  TSX2    BADVFC

     1649    10301    4           ALTRETURN;

  10301  1 004737   200060 221300                    LDX1  ! @M$+1,,AUTO
         1 004740   000000 702211                    TSX2  ! 0,X1

     1650    10302    4           END;
     1651    10303              %UNLOCK (G=DSTA$->KQ$STA.GATE);

  10304  1 004741   200036 236100                    LDQ     DSTA$,,AUTO
         1 004742   000016 036003                    ADLQ    14,DU
         1 004743   200070 756100                    STQ     RBSTATE+4,,AUTO
         1 004744   200070 630500                    EPPR0   RBSTATE+4,,AUTO
         1 004745   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 004746   000000 701000 xent               TSX1    HFC$UNLOCK
         1 004747   000000 011000                    NOP     0
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:220  

     1652    10306
     1653    10307    4           DO WHILE ('0'B);

  10307  1 004750   004762 710000 1                  TRA     s:10314

  10304  1 004751                       BADVFC       null
     1654    10308    4   BADVFC: ; DEST = 3;

  10308  1 004751   000003 235007                    LDA     3,DL
         1 004752   200044 755100                    STA     DEST,,AUTO

     1655    10309                %UNLOCK(G=KQ$QTREE.GATE);

  10310  1 004753   200010 470500                    LDP0    CG$,,AUTO
         1 004754   000057 471500                    LDP1    47,,PR0
         1 004755   200070 451500                    STP1    RBSTATE+4,,AUTO
         1 004756   200070 630500                    EPPR0   RBSTATE+4,,AUTO
         1 004757   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 004760   000000 701000 xent               TSX1    HFC$UNLOCK
         1 004761   000000 011000                    NOP     0

     1656    10312    4           END;

     1657    10313
     1658    10314    3         RETURN;

  10314  1 004762   200060 221300                    LDX1  ! @M$+1,,AUTO
         1 004763   000001 702211                    TSX2  ! 1,X1

     1659    10315    3   END SENDIT;
     1660    10316        /**/
     1661    10317        /*D* NAME:         SENDMSGD
     1662    10318             PURPOSE:      To send a directed message
     1663    10319             DESCRIPTION:  Like SENDMSG, but this is a directed write.
     1664    10320                           DSTA$ points to the destination station, which
     1665    10321                           is locked.
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:221  
     1666    10322
     1667    10323                           The destination station gate will not be unlocked
     1668    10324                           until the msg has been safely disposed of.
     1669    10325        */
     1670    10326    2   SENDMSGD: ENTRY (M$) ALTRET; /* !!Doesn't ALTRET!! */

  10326  1 004764   200056 741300       SENDMSGD     STX1  ! FOUND+1,,AUTO

     1671    10327        /**/
     1672    10328    2         MBLK$=M$;

  10328  1 004765   200057 470500                    LDP0    @M$,,AUTO
         1 004766   000000 236100                    LDQ     0,,PR0
         1 004767   200007 756100                    STQ     MBLK$,,AUTO

     1673    10329    2         GOTO SENDD;

  10329  1 004770   004170 710000 1                  TRA     SENDD

     1674    10330        /**/
     1675    10331        /*D* NAME:         SENDMSGD1
     1676    10332             PURPOSE:      To re-send a directed message
     1677    10333             DESCRIPTION:  Like SENDMSGD but the message is being re-written.
     1678    10334                           Thus it is already represented in the MLH and
     1679    10335                           must be counted out before the write takes place.
     1680    10336                           Also, the * test must be somewhat different.
     1681    10337                           Also, KQ$STA.MLH.BUSY is set so we must not check
     1682    10338                           for it.
     1683    10339
     1684    10340                           ALTRETs if gate not unlocked.
     1685    10341        */
     1686    10342    2   SENDMSGD1: ENTRY (M$) ALTRET;

  10342  1 004771   200056 741300       SENDMSGD1    STX1  ! FOUND+1,,AUTO

     1687    10343        /**/
     1688    10344    2         MBLK$=M$;
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:222  

  10344  1 004772   200057 470500                    LDP0    @M$,,AUTO
         1 004773   000000 236100                    LDQ     0,,PR0
         1 004774   200007 756100                    STQ     MBLK$,,AUTO

     1689    10345    2         IF MBLK$->KQ$MBLK.STAR THEN

  10345  1 004775   200007 471500                    LDP1    MBLK$,,AUTO
         1 004776   100010 236100                    LDQ     8,,PR1
         1 004777   100000 316003                    CANQ    32768,DU
         1 005000   005016 600000 1                  TZE     s:10353

     1690    10346    2          IF MBLK$->KQ$MBLK.PRIO < %KQ_AUEP# THEN

  10346  1 005001   100001 220100                    LDX0    1,,PR1
         1 005002   765000 100003                    CMPX0   -5632,DU
         1 005003   005016 603000 1                  TRC     s:10353

     1691    10347    2           IF DSTA$->KQ$STA.DSID > MBLK$->KQ$MBLK.MID.PRIMARY THEN

  10347  1 005004   200036 473500                    LDP3    DSTA$,,AUTO
         1 005005   100014 236100                    LDQ     12,,PR1
         1 005006   300022 116100                    CMPQ    18,,PR3
         1 005007   005016 603000 1                  TRC     s:10353

     1692    10348    3             DO;

     1693    10349    3             CG$->KQ$CG.STATS.CCMS=CG$->KQ$CG.STATS.CCMS-1;

  10349  1 005010   200010 474500                    LDP4    CG$,,AUTO
         1 005011   000001 336007                    LCQ     1,DL
         1 005012   400172 056100                    ASQ     122,,PR4

     1694    10350    3             STA$->KQ$STA.MLH.COUNT=STA$->KQ$STA.MLH.COUNT-1;

  10350  1 005013   200005 475500                    LDP5    STA$,,AUTO
         1 005014   500041 056100                    ASQ     33,,PR5
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:223  

     1695    10351    3             GOTO NOSEND;

  10351  1 005015   004670 710000 1                  TRA     NOSEND

     1696    10352    3             END;
     1697    10353    2         RBLK$=DSTA$->KQ$STA.RBLK$;

  10353  1 005016   200036 473500                    LDP3    DSTA$,,AUTO
         1 005017   300011 236100                    LDQ     9,,PR3
         1 005020   200006 756100                    STQ     RBLK$,,AUTO

     1698    10354    2         IF RBLK$ ~= ADDR(NIL) THEN

  10354  1 005021   000001 116000 xsym               CMPQ    B_VECTNIL+1
         1 005022   005077 600000 1                  TZE     s:10373

     1699    10355    2          IF RBLK$->KQ$RBLK.STATE = KQRS_PEND# THEN

  10355  1 005023   200006 474500                    LDP4    RBLK$,,AUTO
         1 005024   400001 220100                    LDX0    1,,PR4
         1 005025   000002 100003                    CMPX0   2,DU
         1 005026   005077 601000 1                  TNZ     s:10373

     1700    10356    3            DO;

     1701    10357    3            IF MBLK$->KQ$MBLK.PRIO >= %KQ_AUEP# THEN

  10357  1 005027   100001 222100                    LDX2    1,,PR1
         1 005030   765000 102003                    CMPX2   -5632,DU
         1 005031   005035 602000 1                  TNC     s:10359

     1702    10358    3             IF NOT RBLK$->KQ$RBLK.HONK THEN GOTO SENDAU;

  10358  1 005032   400001 236100                    LDQ     1,,PR4
         1 005033   000400 316007                    CANQ    256,DL
         1 005034   004266 600000 1                  TZE     SENDD2
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:224  

     1703    10359    3            KEY1L=RBLK$->KQ$RBLK.KEY1L;

  10359  1 005035   400001 236100                    LDQ     1,,PR4
         1 005036   000004 772000                    QRL     4
         1 005037   000017 376007                    ANQ     15,DL
         1 005040   200012 756100                    STQ     KEY1L,,AUTO

     1704    10360    3            KEY2L=RBLK$->KQ$RBLK.KEY2L;

  10360  1 005041   400001 236100                    LDQ     1,,PR4
         1 005042   000017 376007                    ANQ     15,DL
         1 005043   200013 756100                    STQ     KEY2L,,AUTO

     1705    10361    3            IF ADDR(RBLK$->KQ$RBLK.KEY1)->B$$KEY1 = ADDR(MBLK$->KQ$MBLK.KEY1)->B$$KEY1

  10361  1 005044   200012 723100                    LXL3    KEY1L,,AUTO
         1 005045   040140 106540                    CMPC    fill='040'O
         1 005046   400002 000013                    ADSC9   2,,PR4                   cn=0,n=*X3
         1 005047   100002 000013                    ADSC9   2,,PR1                   cn=0,n=*X3
         1 005050   005077 601000 1                  TNZ     s:10373
         1 005051   000000 624006                    EAX4    0,QL
         1 005052   200013 725100                    LXL5    KEY2L,,AUTO
         1 005053   040140 106540                    CMPC    fill='040'O
         1 005054   400004 000014                    ADSC9   4,,PR4                   cn=0,n=*X4
         1 005055   100004 000015                    ADSC9   4,,PR1                   cn=0,n=*X5
         1 005056   005077 601000 1                  TNZ     s:10373

     1706    10362    3           AND ADDR(RBLK$->KQ$RBLK.KEY2)->B$$KEY2 = ADDR(MBLK$->KQ$MBLK.KEY2)->B$$KEY2
             10362                     THEN
     1707    10363    3             IF RBLK$->KQ$RBLK.MID.PRIMARY = 0

  10363  1 005057   400006 235100                    LDA     6,,PR4
         1 005060   005064 600000 1                  TZE     s:10366
         1 005061   400006 236100                    LDQ     6,,PR4
         1 005062   100014 116100                    CMPQ    12,,PR1
         1 005063   005077 601000 1                  TNZ     s:10373
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:225  

     1708    10364    3             OR RBLK$->KQ$RBLK.MID.PRIMARY = MBLK$->KQ$MBLK.MID.PRIMARY THEN
     1709    10365    4               DO;

     1710    10366    4               CG$->KQ$CG.STATS.CCMS=CG$->KQ$CG.STATS.CCMS-1;

  10366  1 005064   200010 475500                    LDP5    CG$,,AUTO
         1 005065   000001 336007                    LCQ     1,DL
         1 005066   500172 056100                    ASQ     122,,PR5

     1711    10367    4               STA$->KQ$STA.MLH.COUNT=STA$->KQ$STA.MLH.COUNT-1;

  10367  1 005067   200005 476500                    LDP6    STA$,,AUTO
         1 005070   600041 056100                    ASQ     33,,PR6

     1712    10368    4               IF DSTA$->KQ$STA.LDCT$->NK$LDCT.RESCOD = NK_CGDCB THEN

  10368  1 005071   300010 477500                    LDP7    8,,PR3
         1 005072   700006 236100                    LDQ     6,,PR7
         1 005073   000017 376007                    ANQ     15,DL
         1 005074   000004 116007                    CMPQ    4,DL
         1 005075   004266 600000 1                  TZE     SENDD2

     1713    10369    4                GOTO SENDD2;
     1714    10370    4               GOTO SENDD3;

  10370  1 005076   004312 710000 1                  TRA     SENDD3

     1715    10371    4               END;
     1716    10372    3            END;
     1717    10373    2         CALL KQL$INSERTF (CG$->KQ$CG,DSTA$->KQ$STA.MLH,M$);

  10373  1 005077   200057 236100                    LDQ     @M$,,AUTO
         1 005100   200072 756100                    STQ     RBSTATE+6,,AUTO
         1 005101   200036 236100                    LDQ     DSTA$,,AUTO
         1 005102   000034 036003                    ADLQ    28,DU
         1 005103   200010 235100                    LDA     CG$,,AUTO
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:226  
         1 005104   200070 757100                    STAQ    RBSTATE+4,,AUTO
         1 005105   200070 630500                    EPPR0   RBSTATE+4,,AUTO
         1 005106   000021 631400 xsym               EPPR1   B_VECTNIL+17
         1 005107   000000 701000 xent               TSX1    KQL$INSERTF
         1 005110   000000 011000                    NOP     0

     1718    10374    2         ALTRETURN;

  10374  1 005111   200056 221300                    LDX1  ! FOUND+1,,AUTO
         1 005112   000000 702211                    TSX2  ! 0,X1

     1719    10375        /**/
     1720    10376        /*D* NAME:         SENDMSGQ
     1721    10377             PURPOSE:      To send a message to the queue
     1722    10378             DESCRIPTION:  Like SENDMSG, but this is a write to the queue.
     1723    10379                           QTN$ points to the Q-tree node, and the queue
     1724    10380                           is locked.
     1725    10381
     1726    10382                           The queue is not unlocked until the msg has been
     1727    10383                           safely disposed of.
     1728    10384        */
     1729    10385    2   SENDMSGQ: ENTRY (M$) ALTRET; /* !!Doesn't ALTRET!! */

  10385  1 005113   200056 741300       SENDMSGQ     STX1  ! FOUND+1,,AUTO

     1730    10386        /**/
     1731    10387    2         MBLK$=M$;

  10387  1 005114   200057 470500                    LDP0    @M$,,AUTO
         1 005115   000000 236100                    LDQ     0,,PR0
         1 005116   200007 756100                    STQ     MBLK$,,AUTO

     1732    10388    2         GOTO SENDQ;

  10388  1 005117   004447 710000 1                  TRA     SENDQ

     1733    10389        /**/
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:227  
     1734    10390        /*D* NAME:         SENDMSGQ1
     1735    10391             PURPOSE:      To re-send a message to the queue
     1736    10392             DESCRIPTION:  Like SENDMSGQ but the message is already in the
     1737    10393                           queue and must therefore be counted out.  Also,
     1738    10394                           QUEUE.BUSY is set so we must skip the check for
     1739    10395                           it.
     1740    10396        */
     1741    10397    2   SENDMSGQ1: ENTRY (M$) ALTRET; /* !!Doesn't ALTRET!! */

  10397  1 005120   200056 741300       SENDMSGQ1    STX1  ! FOUND+1,,AUTO

     1742    10398        /**/
     1743    10399    2         CG$->KQ$CG.STATS.CCMQ=CG$->KQ$CG.STATS.CCMQ-1;

  10399  1 005121   200010 470500                    LDP0    CG$,,AUTO
         1 005122   000001 336007                    LCQ     1,DL
         1 005123   000171 056100                    ASQ     121,,PR0

     1744    10400    2         MBLK$=M$;

  10400  1 005124   200057 471500                    LDP1    @M$,,AUTO
         1 005125   100000 236100                    LDQ     0,,PR1
         1 005126   200007 756100                    STQ     MBLK$,,AUTO

     1745    10401    2         GOTO SENDQ1;

  10401  1 005127   004465 710000 1                  TRA     SENDQ1

     1746    10402    2   END SENDMSG;
     1747    10403        /****************************************************************
     1748    10404        *****************************************************************/
     1749    10405        /*D* NAME:         WRWILD
     1750    10406             PURPOSE:      To handle wild-carded write
     1751    10407             INPUT:        MBLK$ points to the mblk all set up with
     1752    10408                                keys & such.
     1753    10409                           DSTAL is the length of the wild-carded destination
     1754    10410                                specification.
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:228  
     1755    10411             DESCRIPTION:  Makes as many copies of the message as required
     1756    10412                           and sends them to the correct people.  ALTRETs
     1757    10413                           with TYC set if any errors are encountered.
     1758    10414        */
     1759    10415    1   WRWILD: PROC ALTRET;

  10415  1 005130   200050 741300       WRWILD       STX1  ! I+2,,AUTO

     1760    10416        /**/
     1761    10417    2   DCL KEY BIT(72);
     1762    10418    2   DCL NXTSTA$ PTR;
     1763    10419    2   DCL M$ PTR;
     1764    10420    2   DCL FOUND SBIN;
     1765    10421        /**/
     1766    10422    2         IF MBLK$->KQ$MBLK.LATCH THEN

  10422  1 005131   200007 470500                    LDP0    MBLK$,,AUTO
         1 005132   000010 236100                    LDQ     8,,PR0
         1 005133   200000 316003                    CANQ    65536,DU
         1 005134   005140 600000 1                  TZE     s:10427

     1767    10423    3           DO;

     1768    10424    3           TYC=%TYC_CGLWRV;

  10424  1 005135   000003 236000 0                  LDQ     3
         1 005136   200034 756100                    STQ     TYC,,AUTO

     1769    10425    3           ALTRETURN;

  10425  1 005137   000000 702211                    TSX2  ! 0,X1

     1770    10426    3           END;
     1771    10427    2         ELSE IF MBLK$->KQ$MBLK.DVE.DVBYTE&%DVBYTE_CONT# THEN

  10427  1 005140   000010 236100                    LDQ     8,,PR0
         1 005141   000011 736000                    QLS     9
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:229  
         1 005142   777000 376003                    ANQ     -512,DU
         1 005143   001000 376003                    ANQ     512,DU
         1 005144   005150 600000 1                  TZE     s:10432

     1772    10428    3            DO;

     1773    10429    3            TYC=%TYC_CGCWRV;

  10429  1 005145   000002 236000 0                  LDQ     2
         1 005146   200034 756100                    STQ     TYC,,AUTO

     1774    10430    3            ALTRETURN;

  10430  1 005147   000000 702211                    TSX2  ! 0,X1

     1775    10431    3            END;
     1776    10432    2         KEY='0'B;

  10432  1 005150   200051 450100                    STZ     KEY,,AUTO
         1 005151   200052 450100                    STZ     RRQ$,,AUTO

     1777    10433    2         FOUND=0;

  10433  1 005152   200055 450100                    STZ     FOUND,,AUTO

     1778    10434    2         ADDR(KEY)->B$$DSTA=ADDR(MBLK$->KQ$MBLK.DSTA)->B$$DSTA;

  10434  1 005153   200042 720100                    LXL0    DSTAL,,AUTO
         1 005154   040140 100540                    MLR     fill='040'O
         1 005155   000011 000010                    ADSC9   9,,PR0                   cn=0,n=*X0
         1 005156   200051 000010                    ADSC9   KEY,,AUTO                cn=0,n=*X0

     1779    10435              %LOCK (G=KQ$STREE.GATE);

  10436  1 005157   200010 236100                    LDQ     CG$,,AUTO
         1 005160   000075 036003                    ADLQ    61,DU
         1 005161   200070 756100                    STQ     RBSTATE+4,,AUTO
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:230  
         1 005162   200070 630500                    EPPR0   RBSTATE+4,,AUTO
         1 005163   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 005164   000000 701000 xent               TSX1    HFC$LOCK
         1 005165   000000 011000                    NOP     0

     1780    10438    2         CALL KQB$SRCH (KQ$STREE,KEY,NXTSTA$);

  10438  1 005166   200053 630500                    EPPR0   NXTSTA$,,AUTO
         1 005167   200072 450500                    STP0    RBSTATE+6,,AUTO
         1 005170   200051 631500                    EPPR1   KEY,,AUTO
         1 005171   200071 451500                    STP1    RBSTATE+5,,AUTO
         1 005172   200010 236100                    LDQ     CG$,,AUTO
         1 005173   000075 036003                    ADLQ    61,DU
         1 005174   200070 756100                    STQ     RBSTATE+4,,AUTO
         1 005175   200070 630500                    EPPR0   RBSTATE+4,,AUTO
         1 005176   000021 631400 xsym               EPPR1   B_VECTNIL+17
         1 005177   000000 701000 xent               TSX1    KQB$SRCH
         1 005200   000000 011000                    NOP     0

     1781    10439    2         CALL GETNXT ALTRET(DONE);

  10439  1 005201   005355 701000 1                  TSX1    GETNXT
         1 005202   005335 702000 1                  TSX2    DONE

     1782    10440    2         DSTA$=NXTSTA$;

  10440  1 005203   200053 236100                    LDQ     NXTSTA$,,AUTO
         1 005204   200036 756100                    STQ     DSTA$,,AUTO

  10440  1 005205                       WW0          null
     1783    10441        /**/
     1784    10442    2   WW0:  ;
     1785    10443    2         M$=MYMBLK$;

  10443  1 005205   200040 236100                    LDQ     MYMBLK$,,AUTO
         1 005206   200054 756100                    STQ     M$,,AUTO

PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:231  
     1786    10444    2         CALL GETMBLK ALTRET(WW1);

  10444  1 005207   002521 701000 1                  TSX1    GETMBLK
         1 005210   005212 702000 1                  TSX2    WW1

     1787    10445    2         GOTO WW2;

  10445  1 005211   005215 710000 1                  TRA     WW2

  10443  1 005212                       WW1          null
     1788    10446    2   WW1:  ;
     1789    10447    2         MYMBLK$=M$;

  10447  1 005212   200054 236100                    LDQ     M$,,AUTO
         1 005213   200040 756100                    STQ     MYMBLK$,,AUTO

     1790    10448    2         GOTO ERRX;

  10448  1 005214   005347 710000 1                  TRA     ERRX

  10447  1 005215                       WW2          null
     1791    10449    2   WW2:  ;
     1792    10450    2         MYMBLK$=M$;

  10450  1 005215   200054 236100                    LDQ     M$,,AUTO
         1 005216   200040 756100                    STQ     MYMBLK$,,AUTO

     1793    10451    2         M$=MBLK$;

  10451  1 005217   200007 236100                    LDQ     MBLK$,,AUTO
         1 005220   200054 756100                    STQ     M$,,AUTO

     1794    10452    2         DDA=MBLK$->KQ$MBLK.STAMP;

  10452  1 005221   200007 470500                    LDP0    MBLK$,,AUTO
         1 005222   000001 236100                    LDQ     1,,PR0
         1 005223   777777 376007                    ANQ     -1,DL
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:232  
         1 005224   200030 756100                    STQ     DDA,,AUTO

     1795    10453    2         MBLK$->KQ$MBLK=MYMBLK$->KQ$MBLK;

  10453  1 005225   200040 471500                    LDP1    MYMBLK$,,AUTO
         1 005226   000100 100500                    MLR     fill='000'O
         1 005227   100000 000100                    ADSC9   0,,PR1                   cn=0,n=64
         1 005230   000000 000100                    ADSC9   0,,PR0                   cn=0,n=64

     1796    10454    2         MBLK$->KQ$MBLK.STAMP=DDA;

  10454  1 005231   200030 720100                    LXL0    DDA,,AUTO
         1 005232   000001 440100                    SXL0    1,,PR0

     1797    10455              %LOCK (G=KQ$TTREE.GATE);

  10456  1 005233   200010 236100                    LDQ     CG$,,AUTO
         1 005234   000067 036003                    ADLQ    55,DU
         1 005235   200070 756100                    STQ     RBSTATE+4,,AUTO
         1 005236   200070 630500                    EPPR0   RBSTATE+4,,AUTO
         1 005237   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 005240   000000 701000 xent               TSX1    HFC$LOCK
         1 005241   000000 011000                    NOP     0

     1798    10458    2         MBLK$->KQ$MBLK.MID.PRIMARY=CG$->KQ$CG.MSGID;

  10458  1 005242   200010 470500                    LDP0    CG$,,AUTO
         1 005243   200007 471500                    LDP1    MBLK$,,AUTO
         1 005244   000113 235100                    LDA     75,,PR0
         1 005245   100014 755100                    STA     12,,PR1

     1799    10459    2         CG$->KQ$CG.MSGID=CG$->KQ$CG.MSGID+1;

  10459  1 005246   000113 235100                    LDA     75,,PR0
         1 005247   000001 035007                    ADLA    1,DL
         1 005250   000113 755100                    STA     75,,PR0

PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:233  
     1800    10460              %UNLOCK (G=KQ$TTREE.GATE);

  10461  1 005251   200010 236100                    LDQ     CG$,,AUTO
         1 005252   000067 036003                    ADLQ    55,DU
         1 005253   200070 756100                    STQ     RBSTATE+4,,AUTO
         1 005254   200070 630500                    EPPR0   RBSTATE+4,,AUTO
         1 005255   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 005256   000000 701000 xent               TSX1    HFC$UNLOCK
         1 005257   000000 011000                    NOP     0

     1801    10463    2         IF BUFSZ ~= 0 THEN

  10463  1 005260   200027 235100                    LDA     BUFSZ,,AUTO
         1 005261   005271 600000 1                  TZE     s:10469

     1802    10464    3           DO;

     1803    10465    3           CALL GETDBLK ALTRET(ERRX);

  10465  1 005262   002756 701000 1                  TSX1    GETDBLK
         1 005263   005347 702000 1                  TSX2    ERRX

     1804    10466    3           MBLK$->KQ$MBLK.DDA=NEWDDA;

  10466  1 005264   200007 470500                    LDP0    MBLK$,,AUTO
         1 005265   200041 235100                    LDA     NEWDDA,,AUTO
         1 005266   000006 755100                    STA     6,,PR0

     1805    10467    3           CALL FILLDBLK ALTRET(ERRX);

  10467  1 005267   002653 701000 1                  TSX1    FILLDBLK
         1 005270   005347 702000 1                  TSX2    ERRX

     1806    10468    3           END;

     1807    10469    2         MBLK$->KQ$MBLK.DSTA=DSTA$->KQ$STA.BTN.KEY;

PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:234  
  10469  1 005271   200036 470500                    LDP0    DSTA$,,AUTO
         1 005272   200007 471500                    LDP1    MBLK$,,AUTO
         1 005273   040100 100500                    MLR     fill='040'O
         1 005274   000005 000010                    ADSC9   5,,PR0                   cn=0,n=8
         1 005275   100011 000010                    ADSC9   9,,PR1                   cn=0,n=8

     1808    10470              %LOCK (G=KQ$STREE.GATE);

  10471  1 005276   200010 236100                    LDQ     CG$,,AUTO
         1 005277   000075 036003                    ADLQ    61,DU
         1 005300   200070 756100                    STQ     RBSTATE+4,,AUTO
         1 005301   200070 630500                    EPPR0   RBSTATE+4,,AUTO
         1 005302   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 005303   000000 701000 xent               TSX1    HFC$LOCK
         1 005304   000000 011000                    NOP     0

     1809    10473    2         NXTSTA$=DSTA$->KQ$STA.BTN.FLINK$;

  10473  1 005305   200036 470500                    LDP0    DSTA$,,AUTO
         1 005306   000004 236100                    LDQ     4,,PR0
         1 005307   200053 756100                    STQ     NXTSTA$,,AUTO

     1810    10474    2         CALL GETNXT;

  10474  1 005310   005355 701000 1                  TSX1    GETNXT
         1 005311   000000 011000                    NOP     0

     1811    10475              %LOCK (G=DSTA$->KQ$STA.GATE);

  10476  1 005312   200036 236100                    LDQ     DSTA$,,AUTO
         1 005313   000016 036003                    ADLQ    14,DU
         1 005314   200070 756100                    STQ     RBSTATE+4,,AUTO
         1 005315   200070 630500                    EPPR0   RBSTATE+4,,AUTO
         1 005316   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 005317   000000 701000 xent               TSX1    HFC$LOCK
         1 005320   000000 011000                    NOP     0

PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:235  
     1812    10478    2         CALL SENDMSGD (M$);

  10478  1 005321   200054 630500                    EPPR0   M$,,AUTO
         1 005322   200057 450500                    STP0    @M$,,AUTO
         1 005323   004764 701000 1                  TSX1    SENDMSGD
         1 005324   000000 011000                    NOP     0

     1813    10479    2         CALL KQP$UNLOCK (DSTA$->KQ$STA);

  10479  1 005325   200036 630500                    EPPR0   DSTA$,,AUTO
         1 005326   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 005327   000000 701000 xent               TSX1    KQP$UNLOCK
         1 005330   000000 011000                    NOP     0

     1814    10480    2         DSTA$=NXTSTA$;

  10480  1 005331   200053 236100                    LDQ     NXTSTA$,,AUTO
         1 005332   200036 756100                    STQ     DSTA$,,AUTO

     1815    10481    2         IF DSTA$ ~= ADDR(NIL) THEN GOTO WW0;

  10481  1 005333   000001 116000 xsym               CMPQ    B_VECTNIL+1
         1 005334   005205 601000 1                  TNZ     WW0

  10481  1 005335                       DONE         null
     1816    10482    2   DONE: ;
     1817    10483    2         CALL KQM$RELMBLK (CG$->KQ$CG,MYMBLK$);

  10483  1 005335   200040 630500                    EPPR0   MYMBLK$,,AUTO
         1 005336   200071 450500                    STP0    RBSTATE+5,,AUTO
         1 005337   200010 236100                    LDQ     CG$,,AUTO
         1 005340   200070 756100                    STQ     RBSTATE+4,,AUTO
         1 005341   200070 630500                    EPPR0   RBSTATE+4,,AUTO
         1 005342   000020 631400 xsym               EPPR1   B_VECTNIL+16
         1 005343   000000 701000 xent               TSX1    KQM$RELMBLK
         1 005344   000000 011000                    NOP     0

PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:236  
     1818    10484    2         RETURN;

  10484  1 005345   200050 221300                    LDX1  ! I+2,,AUTO
         1 005346   000001 702211                    TSX2  ! 1,X1

  10481  1 005347                       ERRX         null
     1819    10485    2   ERRX: ;
     1820    10486    2         CALL KQP$UNLOCK (DSTA$->KQ$STA);

  10486  1 005347   200036 630500                    EPPR0   DSTA$,,AUTO
         1 005350   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 005351   000000 701000 xent               TSX1    KQP$UNLOCK
         1 005352   000000 011000                    NOP     0

     1821    10487    2         ALTRETURN;

  10487  1 005353   200050 221300                    LDX1  ! I+2,,AUTO
         1 005354   000000 702211                    TSX2  ! 0,X1

     1822    10488        /**/
     1823    10489        /**/
     1824    10490                           /* Find the next station & lock it */
     1825    10491    2   GETNXT: PROC ALTRET;

  10491  1 005355   200056 741300       GETNXT       STX1  ! FOUND+1,,AUTO

     1826    10492    4           DO WHILE (NXTSTA$ ~= ADDR(NIL));

  10492  1 005356   005534 710000 1                  TRA     s:10563

     1827    10493    4           IF  ADDR(KEY)->B$$DSTA = ADDR(NXTSTA$->KQ$STA.BTN.KEY)->B$$DSTA

  10493  1 005357   200042 720100                    LXL0    DSTAL,,AUTO
         1 005360   200053 470500                    LDP0    NXTSTA$,,AUTO
         1 005361   040140 106540                    CMPC    fill='040'O
         1 005362   200051 000010                    ADSC9   KEY,,AUTO                cn=0,n=*X0
         1 005363   000005 000010                    ADSC9   5,,PR0                   cn=0,n=*X0
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:237  
         1 005364   005531 601000 1                  TNZ     s:10562
         1 005365   000023 236100                    LDQ     19,,PR0
         1 005366   400000 316007                    CANQ    -131072,DL
         1 005367   005531 601000 1                  TNZ     s:10562
         1 005370   000005 236100                    LDQ     5,,PR0
         1 005371   777000 376003                    ANQ     -512,DU
         1 005372   052000 116003                    CMPQ    21504,DU
         1 005373   005531 600000 1                  TZE     s:10562

     1828    10494    4           AND NOT NXTSTA$->KQ$STA.AUP
     1829    10495    4           AND SUBSTR (NXTSTA$->KQ$STA.BTN.KEY,0,1) ~= '*' THEN
     1830    10496    5             DO;

     1831    10497                  %LOCK (G=NXTSTA$->KQ$STA.GATE);

  10498  1 005374   200053 236100                    LDQ     NXTSTA$,,AUTO
         1 005375   000016 036003                    ADLQ    14,DU
         1 005376   200070 756100                    STQ     RBSTATE+4,,AUTO
         1 005377   200070 630500                    EPPR0   RBSTATE+4,,AUTO
         1 005400   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 005401   000000 701000 xent               TSX1    HFC$LOCK
         1 005402   000000 011000                    NOP     0

     1832    10500    5             IF NOT WAS THEN

  10500  1 005403   200015 235100                    LDA     WAS,,AUTO
         1 005404   005415 601000 1                  TNZ     s:10507

     1833    10501    6               DO;

     1834    10502    6               IF NXTSTA$->KQ$STA.LDCT$ = ADDR(NIL) THEN GOTO G4;

  10502  1 005405   200053 470500                    LDP0    NXTSTA$,,AUTO
         1 005406   000010 236100                    LDQ     8,,PR0
         1 005407   000001 116000 xsym               CMPQ    B_VECTNIL+1
         1 005410   005522 600000 1                  TZE     G4

PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:238  
     1835    10503    6               IF NXTSTA$->KQ$STA.LDCT$->NK$LDCT.LKFLG.ACTIVE = '0'B THEN

  10503  1 005411   000010 471500                    LDP1    8,,PR0
         1 005412   100011 236100                    LDQ     9,,PR1
         1 005413   000040 316003                    CANQ    32,DU
         1 005414   005522 600000 1                  TZE     G4

     1836    10504    6                GOTO G4;
     1837    10505    6               END;

     1838    10506        /**/
     1839    10507    5             IF NXTSTA$->KQ$STA.LDCT$ ~= ADDR(NIL) THEN

  10507  1 005415   200053 470500                    LDP0    NXTSTA$,,AUTO
         1 005416   000010 236100                    LDQ     8,,PR0
         1 005417   000001 116000 xsym               CMPQ    B_VECTNIL+1
         1 005420   005463 600000 1                  TZE     s:10539

     1840    10508    6               DO;  /* PRESENT */

     1841    10509    6               IF NXTSTA$->KQ$STA.TERM THEN

  10509  1 005421   000020 236100                    LDQ     16,,PR0
         1 005422   040000 316003                    CANQ    16384,DU
         1 005423   005450 600000 1                  TZE     s:10528

     1842    10510    7                 DO;

     1843    10511    7                 IF NOT VLP$->VLP$STATION.CTL.ALLTRMS THEN

  10511  1 005424   200011 471500                    LDP1    VLP$,,AUTO
         1 005425   100004 236100                    LDQ     4,,PR1
         1 005426   020000 316003                    CANQ    8192,DU
         1 005427   005476 601000 1                  TNZ     s:10548

     1844    10512    7                  IF  NOT VLP$->VLP$STATION.CTL.ALLDCBS

PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:239  
  10512  1 005430   010000 316003                    CANQ    4096,DU
         1 005431   005522 601000 1                  TNZ     G4
         1 005432   000400 316003                    CANQ    256,DU
         1 005433   005522 601000 1                  TNZ     G4

     1845    10513    7                  AND NOT VLP$->VLP$STATION.CTL.ALLABSENT THEN
     1846    10514    8                    DO;

     1847    10515    8                    IF FOUND ~= 0 THEN

  10515  1 005434   200055 235100                    LDA     FOUND,,AUTO
         1 005435   005476 600000 1                  TZE     s:10548

     1848    10516    9   UDONE:             DO;

  10516  1 005436                       UDONE        null
     1849    10517                           %UNLOCK (G=NXTSTA$->KQ$STA.GATE);

  10518  1 005436   200053 236100                    LDQ     NXTSTA$,,AUTO
         1 005437   000016 036003                    ADLQ    14,DU
         1 005440   200070 756100                    STQ     RBSTATE+4,,AUTO
         1 005441   200070 630500                    EPPR0   RBSTATE+4,,AUTO
         1 005442   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 005443   000000 701000 xent               TSX1    HFC$UNLOCK
         1 005444   000000 011000                    NOP     0

     1850    10520    9                      NXTSTA$=ADDR(NIL);

  10520  1 005445   000001 236000 xsym               LDQ     B_VECTNIL+1
         1 005446   200053 756100                    STQ     NXTSTA$,,AUTO

     1851    10521    9                      GOTO G5;

  10521  1 005447   005537 710000 1                  TRA     G5

     1852    10522    9                      END;
     1853    10523    8                    END;
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:240  
     1854    10524    7                  ELSE GOTO G4;
     1855    10525    7                 END;
     1856    10526    6               ELSE /* DCB */
     1857    10527    7                 DO;

     1858    10528    7                 IF NOT VLP$->VLP$STATION.CTL.ALLDCBS THEN

  10528  1 005450   200011 471500                    LDP1    VLP$,,AUTO
         1 005451   100004 236100                    LDQ     4,,PR1
         1 005452   010000 316003                    CANQ    4096,DU
         1 005453   005476 601000 1                  TNZ     s:10548

     1859    10529    7                  IF  NOT VLP$->VLP$STATION.CTL.ALLTRMS

  10529  1 005454   020000 316003                    CANQ    8192,DU
         1 005455   005522 601000 1                  TNZ     G4
         1 005456   000400 316003                    CANQ    256,DU
         1 005457   005522 601000 1                  TNZ     G4

     1860    10530    7                  AND NOT VLP$->VLP$STATION.CTL.ALLABSENT THEN
     1861    10531    8                    DO;

     1862    10532    8                    IF FOUND ~= 0 THEN GOTO UDONE;

  10532  1 005460   200055 235100                    LDA     FOUND,,AUTO
         1 005461   005436 601000 1                  TNZ     UDONE

     1863    10533    8                    END;

  10533  1 005462   005476 710000 1                  TRA     s:10548

     1864    10534    7                  ELSE GOTO G4;
     1865    10535    7                 END;
     1866    10536    6               END; /* PRESENT */
     1867    10537    5             ELSE   /* ABSENT  */
     1868    10538    6               DO;

PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:241  
     1869    10539    6               IF NOT VLP$->VLP$STATION.CTL.ALLABSENT THEN

  10539  1 005463   200011 471500                    LDP1    VLP$,,AUTO
         1 005464   100004 236100                    LDQ     4,,PR1
         1 005465   000400 316003                    CANQ    256,DU
         1 005466   005476 601000 1                  TNZ     s:10548

     1870    10540    6                IF  NOT VLP$->VLP$STATION.CTL.ALLTRMS

  10540  1 005467   020000 316003                    CANQ    8192,DU
         1 005470   005522 601000 1                  TNZ     G4
         1 005471   010000 316003                    CANQ    4096,DU
         1 005472   005522 601000 1                  TNZ     G4

     1871    10541    6                AND NOT VLP$->VLP$STATION.CTL.ALLDCBS THEN
     1872    10542    7                  DO;

     1873    10543    7                  IF FOUND ~= 0 THEN GOTO UDONE;

  10543  1 005473   200055 235100                    LDA     FOUND,,AUTO
         1 005474   005436 601000 1                  TNZ     UDONE

     1874    10544    7                  END;

  10544  1 005475   005476 710000 1                  TRA     s:10548

     1875    10545    6                ELSE GOTO G4;
     1876    10546    6               END; /* ABSENT */
     1877    10547        /**/
     1878    10548    5             FOUND=FOUND+1;

  10548  1 005476   200055 054100                    AOS     FOUND,,AUTO

     1879    10549    5             NXTSTA$->KQ$STA.LOCKCNT=NXTSTA$->KQ$STA.LOCKCNT+1;

  10549  1 005477   000020 236100                    LDQ     16,,PR0
         1 005500   000001 036007                    ADLQ    1,DL
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:242  
         1 005501   000020 552104                    STBQ    16,'04'O,PR0

     1880    10550                  %UNLOCK (G=NXTSTA$->KQ$STA.GATE);

  10551  1 005502   200053 236100                    LDQ     NXTSTA$,,AUTO
         1 005503   000016 036003                    ADLQ    14,DU
         1 005504   200070 756100                    STQ     RBSTATE+4,,AUTO
         1 005505   200070 630500                    EPPR0   RBSTATE+4,,AUTO
         1 005506   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 005507   000000 701000 xent               TSX1    HFC$UNLOCK
         1 005510   000000 011000                    NOP     0

     1881    10553                  %UNLOCK (G=KQ$STREE.GATE);

  10554  1 005511   200010 236100                    LDQ     CG$,,AUTO
         1 005512   000075 036003                    ADLQ    61,DU
         1 005513   200070 756100                    STQ     RBSTATE+4,,AUTO
         1 005514   200070 630500                    EPPR0   RBSTATE+4,,AUTO
         1 005515   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 005516   000000 701000 xent               TSX1    HFC$UNLOCK
         1 005517   000000 011000                    NOP     0

     1882    10556    5             RETURN;

  10556  1 005520   200056 221300                    LDX1  ! FOUND+1,,AUTO
         1 005521   000001 702211                    TSX2  ! 1,X1

  10549  1 005522                       G4           null
     1883    10557    5   G4:       ;
     1884    10558                  %UNLOCK (G=NXTSTA$->KQ$STA.GATE);

  10559  1 005522   200053 236100                    LDQ     NXTSTA$,,AUTO
         1 005523   000016 036003                    ADLQ    14,DU
         1 005524   200070 756100                    STQ     RBSTATE+4,,AUTO
         1 005525   200070 630500                    EPPR0   RBSTATE+4,,AUTO
         1 005526   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 005527   000000 701000 xent               TSX1    HFC$UNLOCK
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:243  
         1 005530   000000 011000                    NOP     0

     1885    10561    5             END;

     1886    10562    4           NXTSTA$=NXTSTA$->KQ$STA.BTN.FLINK$;

  10562  1 005531   200053 470500                    LDP0    NXTSTA$,,AUTO
         1 005532   000004 236100                    LDQ     4,,PR0
         1 005533   200053 756100                    STQ     NXTSTA$,,AUTO

     1887    10563    4           END;

  10563  1 005534   200053 236100                    LDQ     NXTSTA$,,AUTO
         1 005535   000001 116000 xsym               CMPQ    B_VECTNIL+1
         1 005536   005357 601000 1                  TNZ     s:10493

  10562  1 005537                       G5           null
     1888    10564    3   G5:   ;
     1889    10565              %UNLOCK (G=KQ$STREE.GATE);

  10566  1 005537   200010 236100                    LDQ     CG$,,AUTO
         1 005540   000075 036003                    ADLQ    61,DU
         1 005541   200070 756100                    STQ     RBSTATE+4,,AUTO
         1 005542   200070 630500                    EPPR0   RBSTATE+4,,AUTO
         1 005543   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 005544   000000 701000 xent               TSX1    HFC$UNLOCK
         1 005545   000000 011000                    NOP     0

     1890    10568    3         ALTRETURN;

  10568  1 005546   200056 221300                    LDX1  ! FOUND+1,,AUTO
         1 005547   000000 702211                    TSX2  ! 0,X1

(unnamed)
 Sect OctLoc
   0     000   000020 000000   000400 000000   000000 004000   000000 040000    .............. .
   0     004   000000 020000   000100 000000   000000 100000   052107 117122    .....@....@.*GOR
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:244  
   0     010   107117 040040   000040 000000   052106 127103   107040 040040    GO  . ..*FWCG

(unnamed)
 Sect OctLoc
   2     000   077040 040040   000000 000025   000002 006000   000001 006000    ?   ............
   2     004   000000 006000   000000 006000   000016 006000   000000 000031    ................
   2     010   000003 006000   000007 006000   000000 006000   000000 000014    ................
   2     014   000013 006000   000002 006000   000004 006000   777777 777677    ................
     1891    10569    3   END GETNXT;
     1892    10570    2   END WRWILD;
     1893    10571    1   END KQW$WRITE;

PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:245  
--  Include file information  --

   SS_SCHED_C.:E05TOU  is referenced.
   EL$TABLES.:E05TOU  is referenced.
   KC$CP6V_C.:E05TOU  is referenced.
   JG_GHOSTS_C.:E05TOU  is referenced.
   NK_VFC_C.:E05TOU  is referenced.
   N_FC_C.:E05TOU  is referenced.
   B_STRINGS_C.:E05TOU  is referenced.
   CP_6_SUBS.:E05TOU  is referenced.
   KC_CP6.:E05TOU  is referenced.
   NK_LDCT_R.:E05TOU  cannot be made into a system file and is referenced.
   NK_SUBS.:E05TOU  is referenced.
   N$REQ.:E05TOU  is referenced.
   NK$LDCT.:E05TOU  is referenced.
   KQ_DATA_R.:E05TOU  cannot be made into a system file and is referenced.
   HF_LOCK_C.:E05TOU  cannot be made into a system file and is referenced.
   KQ_MAC_C.:E05TOU  is referenced.
   KQ_SUBS_C.:E05TOU  is referenced.
      No diagnostics issued in procedure KQW$WRITE.
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:246  

 **** Variables and constants ****

  ****  Auto variables  ****

  ****  Scalars and arrays  ****
OctLoc.c.b A Datatyp(siz) R M Lvl/name                 OctLoc.c.b A Datatyp(siz) R M Lvl/name

    63-0-0/w PTR         r     1 @M$                       61-0-0/w PTR         r     1 @M$
    57-0-0/w PTR         r     1 @M$                        3-0-0/w PTR         r     1 @N$WREQ
    27-0-0/w UBIN        r     1 BUFSZ                     10-0-0/w PTR         r     1 CG$
    26-0-0/w PTR         r     1 DBLK$                     26-0-0/w UBIN        r     1 DBLK$R
    30-0-0/w UBIN        r     1 DDA                       44-0-0/w SBIN        r     1 DEST
    36-0-0/w PTR         r     1 DSTA$                     42-0-0/w UBIN        r     1 DSTAL
    55-0-0/w SBIN        r     1 FOUND                     46-0-0/w UBIN        r     1 I
    51-0-0/b BIT (72)    r     1 KEY                       12-0-0/w UBIN        r     1 KEY1L
    13-0-0/w UBIN        r     1 KEY2L                      4-0-0/w PTR         r     1 LDCT$
    62-0-0/w BIT         r     1 LOCK                      *0-0-0/w PTR         r     1 M$
    *0-0-0/w PTR         r     1 M$                        *0-0-0/w PTR         r     1 M$
    54-0-0/w PTR         r     1 M$                         7-0-0/w PTR         r     1 MBLK$
    35-0-0/w PTR         r     1 MTYP$                     40-0-0/w PTR         r     1 MYMBLK$
    *0-0-0/d STRC(1080)  r     1 N$WREQ                    41-0-0/w UBIN        r     1 NEWDDA
    53-0-0/w PTR         r     1 NXTSTA$                   31-0-0/c CHAR(8)     r     1 OSTA
    30-0-0/w UBIN        r     1 OSTAPRIO                  14-0-0/w PTR         r     1 P$
    51-0-0/w UBIN        r     1 QLOCK                     33-0-0/w PTR         r     1 QTN$
     6-0-0/w PTR         r     1 RBLK$                     64-0-0/w UBIN        r     1 RBSTATE
    62-0-0/w UBIN        r     1 RBSTATE                   41-0-0/w UBIN        r     1 RCVR
    57-0-0/w UBIN        r     1 REDUND                    52-0-0/w PTR         r     1 RRQ$
     5-0-0/w PTR         r     1 STA$                      57-0-0/w PTR         r     1 T$
    61-0-0/w PTR         r     1 T$                        43-0-0/w UBIN(18)    r     1 TACTCNT
    34-0-0/b BIT         r     1 TYC                       45-0-0/w UBIN        r     1 VFC
    11-0-0/w PTR         r     1 VLP$                      16-0-0/w STRC(288)   r     1 VLP_STATION
    15-0-0/b BIT         r     1 WAS                       37-0-0/w PTR         r     1 WRQ$

  ****  SYMREF variables  ****

  ****  Scalars and arrays  ****
OctLoc.c.b A Datatyp(siz) R M Lvl/name                 OctLoc.c.b A Datatyp(siz) R M Lvl/name
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:247  

     0-0-0/w PTR         r     1 B$CGPT$                    0-0-0/w UBIN        r     1 KQ_DEBUG
     0-0-0/w STRC(2304)  r     1 KQ_ERRLOG_BFR              0-0-0/b BIT (72)    r     1 KQ_ERRLOG_GATE
     0-0-0/d STRC(360)   r     1 KQ_IMTYP                   0-0-0/b STRC        r     1 KQ_LOG
     0-0-0/w BIT (72)    r     1 KQ_XFGATE                  0-0-0/w PTR         r     1 N$DCT$$
     0-0-0/w UBIN        r     1 S_CUN                      0-0-0/w UBIN        r     1 S_TIMR

  ****  BASED and DCB variables  ****

  ****  Scalars and arrays  ****
OctLoc.c.b A Datatyp(siz) R M Lvl/name                 OctLoc.c.b A Datatyp(siz) R M Lvl/name

     0-0-0/c ACHR        r     1 B$$BUFCHARS                0-0-0/c CHAR        r     1 B$$CHAR
     0-0-0/c CHAR(8)     r     1 B$$CHAR8                   0-0-0/w ACHR        r     1 B$$DSTA
     0-0-0/h UBIN(18)    r     1 B$$HALF                    0-0-0/w ACHR        r     1 B$$KEY1
     0-0-0/w ACHR        r     1 B$$KEY2                    0-0-0/w STRC        r     1 B$$MIDEXT
     0-0-0/h STRC(18)    r     1 B$$PRIO                    0-0-0/w PTR         r     1 B$$PTR
     0-0-0/d STRC(72)    r     1 B$$XFPTW                   0-0-0/d STRC(6516)  r     1 KQ$CG
     0-0-0/d STRC(216)   r     1 KQ$DBLK                    0-0-0/w STRC        r     1 KQ$DPTR
     0-0-0/d STRC(576)   r     1 KQ$MBLK                    0-0-0/d STRC(360)   r     1 KQ$MTYP
     0-0-0/d STRC(1908)  r     1 KQ$QTN                     0-0-0/d STRC(648)   r     1 KQ$RBLK
     0-0-0/d STRC(504)   r     1 KQ$RBLKT                   0-0-0/d STRC(1296)  r     1 KQ$STA
     0-0-0/w STRC(216)   r     1 KQ$THDR                    0-0-0/d STRC(1080)  r     1 N$REQ
     0-0-0/d STRC(864)   r     1 NK$LDCT
     0-0-0/w PTR         r     1 NK$LDCT$(0:0)
     0-0-0/w STRC(288)   r     1 VLP$STATION


   Procedure KQW$WRITE requires 2920 words for executable code.
   Procedure KQW$WRITE requires 64 words of local(AUTO) storage.

    No errors detected in file KQW$WRITE.:E05TSI    .
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:248  
          *** CROSS REFERENCE LISTING ***
**     DENOTES     IDENTIFIER DEFINITION
<<                 IDENTIFIER'S VALUE SET
>>                 IDENTIFIER'S VALUE USED
<>                 IDENTIFIER SET AND/OR USED
--                 IDENTIFIER REFERENCED
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:249  
          MINI XREF LISTING

ALT IN PROCEDURE CHECKVFC
      9925**LABEL    9917--GOTO
ALT IN PROCEDURE MOVMC
     10047**LABEL   10029--CALLALT
ALT IN PROCEDURE MOVMCQ
      9998**LABEL    9973--CALLALT
ALTRT
      9360**LABEL    9361--CALLALT  9414--CALLALT  9440--CALLALT  9559--CALLALT
B$$BUFCHARS
      8670**DCL      9625<<ASSIGN   9625>>ASSIGN   9629<<ASSIGN   9629>>ASSIGN   9856<<ASSIGN   9856>>ASSIGN
      9860<<ASSIGN   9860>>ASSIGN
B$$CHAR
      8668**DCL      9624<<ASSIGN   9855<<ASSIGN
B$$CHAR8
      8669**DCL      8950<>CALL     9252<<ASSIGN
B$$DSTA
      8667**DCL     10434<<ASSIGN  10434>>ASSIGN  10493>>IF      10493>>IF
B$$HALF
      8664**DCL      8908<>CALL
B$$KEY1
      8665**DCL      9040>>IF       9040>>IF       9130>>IF       9130>>IF      10175>>IF      10175>>IF
     10255>>IF      10255>>IF      10361>>IF      10361>>IF
B$$KEY2
      8666**DCL      9040>>IF       9040>>IF       9101>>IF       9101>>IF       9130>>IF       9130>>IF
     10175>>IF      10175>>IF      10241>>IF      10241>>IF      10255>>IF      10255>>IF      10361>>IF
     10361>>IF
B$$MIDEXT.EXTS
      8672**DCL      8894<<ASSIGN
B$$PRIO.HI
      8674**DCL      8968>>ASSIGN   8980<<ASSIGN   8987<<ASSIGN
B$$PRIO.LO
      8675**DCL      8972>>ASSIGN   8981<<ASSIGN   8988<<ASSIGN
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:250  
B$$PTR
      6161**DCL      9098>>ASSIGN   9121>>ASSIGN   9126>>ASSIGN   9145>>ASSIGN   9410>>ASSIGN   9438>>ASSIGN
      9496>>ASSIGN   9974<<ASSIGN  10238>>ASSIGN  10248>>ASSIGN  10251>>ASSIGN  10263>>ASSIGN
B$$XFPTW
      8676**DCL      9849<<ASSIGN   9861<<ASSIGN
B$CGPT$
      8773**DCL      9849>>ASSIGN   9861>>ASSIGN
BADCOMP
      9320**LABEL    8807--GOTO     9064--GOTO     9281--GOTO     9311--GOTO
BADVFC IN PROCEDURE SENDIT
     10304**LABEL   10300--CALLALT
BADWBUF IN PROCEDURE XFERD
      9868**LABEL    9851--CALLALT
BAD_VFC IN PROCEDURE XFERD
      9878**LABEL    9869--CALLALT  9871--CALLALT
BUFSZ
      8708**DCL      8670--IMP-SIZ  8835<<ASSIGN   8837>>IF       8837<<ASSIGN   8854<<ASSIGN   8855>>IF
      8857<<ASSIGN   9169>>IF       9623<<ASSIGN   9623>>ASSIGN   9625>>ASSIGN   9625>>ASSIGN   9626<<ASSIGN
      9626>>ASSIGN   9629>>ASSIGN   9629>>ASSIGN   9631>>ASSIGN   9662>>ASSIGN   9676>>ASSIGN   9696>>ASSIGN
      9840>>ASSIGN   9841>>IF       9854<<ASSIGN   9854>>ASSIGN   9856>>ASSIGN   9856>>ASSIGN   9857<<ASSIGN
      9857>>ASSIGN   9860>>ASSIGN   9860>>ASSIGN   9867>>ASSIGN  10463>>IF
BWCBUF
      9289**LABEL    9048--GOTO
BWCBUFU IN PROCEDURE FILLDBLK
      9631**LABEL    9620--CALLALT
BWCCWRV
      9274**LABEL    8832--GOTO     8834--GOTO
BWCFULL
      9286**LABEL    8937--CALLALT
BWCFULL IN PROCEDURE GETMBLK
      9603**LABEL    9590--GOTO     9596--CALLALT  9601--CALLALT
BWCKEYT
      9310**LABEL    8927--GOTO     8935--GOTO     9094--CALLALT
BWCLWRV
      9280**LABEL    8877--GOTO     8881--GOTO     8891--GOTO     8957--GOTO
BWCTYC
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:251  
      9317**LABEL    8850--CALLALT  9005--CALLALT  9024--CALLALT  9171--CALLALT  9172--CALLALT  9194--CALLALT
      9213--CALLALT
BWDELMSG
      9292**LABEL    9049--GOTO     9061--GOTO     9256--GOTO     9287--GOTO     9290--GOTO     9318--GOTO
      9321--GOTO
CG$
      8688**DCL      6281--IMP-PTR  8810<<ASSIGN   8811>>CALL     8812>>ASSIGN   8812>>ASSIGN   8815>>ASSIGN
      8830>>IF       8871>>CALL     8882>>IF       8885>>ASSIGN   8886>>ASSIGN   8886>>ASSIGN   8900>>ASSIGN
      8901>>ASSIGN   8901>>ASSIGN   8908>>CALL     8909>>ASSIGN   8912>>CALL     8920>>CALL     8922>>IF
      8923>>ASSIGN   8925>>CALL     8934>>IF       8937>>CALL     8947>>IF       8950>>CALL     8950>>CALL
      8961>>ASSIGN   8962>>IF       8965>>IF       8978>>IF       8999>>CALL     9025>>IF       9052>>IF
      9080>>IF       9088>>CALL     9090>>IF       9093>>IF       9094>>CALL     9125>>ASSIGN   9180>>CALL
      9181>>CALL     9184>>CALL     9212>>ASSIGN   9255>>CALL     9271>>CALL     9284>>CALL     9300>>IF
      9304>>CALL     9309>>CALL     9314>>CALL     9335>>CALL     9356<<ASSIGN   9357>>ASSIGN   9378<<ASSIGN
      9388<<ASSIGN   9389>>ASSIGN   9411<<ASSIGN   9438<<ASSIGN   9440>>CALL     9440>>CALL     9441>>IF
      9445>>ASSIGN   9450>>ASSIGN   9451>>CALL     9451>>CALL     9452>>CALL     9455>>ASSIGN   9455>>ASSIGN
      9457>>CALL     9459>>CALL     9462>>CALL     9488<<ASSIGN   9489>>ASSIGN   9494>>CALL     9500>>CALL
      9502>>CALL     9509>>CALL     9527<<ASSIGN   9528>>ASSIGN   9548<<ASSIGN   9586>>CALL     9592>>CALL
      9594>>CALL     9596>>CALL     9601>>CALL     9632>>CALL     9636>>CALL     9664>>IF       9672>>CALL
      9682>>CALL     9685>>CALL     9690>>CALL     9741>>CALL     9743>>CALL     9767>>CALL     9771>>IF
      9775>>CALL     9784>>CALL     9790>>CALL     9893>>CALL     9993>>CALL     9995>>CALL    10042>>CALL
     10043>>CALL    10075>>IF      10124>>IF      10129>>CALL    10131>>IF      10133>>ASSIGN  10138>>CALL
     10146>>CALL    10200>>CALL    10212>>CALL    10214>>IF      10216>>CALL    10221>>IF      10225>>CALL
     10228>>IF      10230>>CALL    10231>>ASSIGN  10231>>ASSIGN  10250>>ASSIGN  10266>>CALL    10270>>CALL
     10275>>CALL    10283>>CALL    10290>>CALL    10310>>CALL    10349>>ASSIGN  10349>>ASSIGN  10366>>ASSIGN
     10366>>ASSIGN  10373>>CALL    10399>>ASSIGN  10399>>ASSIGN  10436>>CALL    10438>>CALL    10456>>CALL
     10458>>ASSIGN  10459>>ASSIGN  10459>>ASSIGN  10461>>CALL    10471>>CALL    10483>>CALL    10554>>CALL
     10566>>CALL
CHECKVFC
      9909**PROC     9973--CALL    10029--CALL
CHK0 IN PROCEDURE CHKSTAL
      9744**LABEL    9792--GOTO
CHK1 IN PROCEDURE CHKSTAL
      9752**LABEL    9750--GOTO
CHKDUN IN PROCEDURE CHKSTAL
      9753**LABEL    9752--GOTO
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:252  
CHKFAIL IN PROCEDURE CHKSTAL
      9778**LABEL    9759--GOTO
CHKSTA IN PROCEDURE CHKSTAL
      9737**ENTRY    9194--CALL
CHKSTAL
      9724**PROC     9024--CALL    10157--CALL
CMN IN PROCEDURE CHKSTAL
      9738**LABEL    9730--GOTO
DBLK$
      8706**DCL      7851--IMP-PTR  8707--REDEF    9180<>CALL     9181<>CALL     9183>>ASSIGN   9184<>CALL
      9230>>IF       9271<>CALL     9624>>ASSIGN   9625>>ASSIGN   9629>>ASSIGN   9632<>CALL     9636<>CALL
      9672<>CALL     9678>>IF       9682<>CALL     9685<>CALL     9690<>CALL     9694>>ASSIGN   9694>>ASSIGN
      9695>>ASSIGN   9696>>ASSIGN   9698>>ASSIGN
DBLK$R
      8707**DCL      9177<<ASSIGN
DDA
      8709**DCL      8710--REDEF    9178<<ASSIGN   9180<>CALL     9181<>CALL     9233>>DOCASE   9270<<ASSIGN
      9271<>CALL     9274>>IF       9586<>CALL    10452<<ASSIGN  10454>>ASSIGN
DEST
      8722**DCL      8813<<ASSIGN   9048>>IF       9049>>IF       9072<<ASSIGN   9148<<ASSIGN   9179>>IF
      9208>>IF       9209>>IF       9326>>IF       9332>>IF       9338<<ASSIGN   9670>>IF       9843<<ASSIGN
      9883<<ASSIGN  10245>>IF      10260>>IF      10294<<ASSIGN  10308<<ASSIGN
DESTUL
      9325**PROC     9229--CALL     9294--CALL     9637--CALL     9675--CALL
DONE IN PROCEDURE WRWILD
     10481**LABEL   10439--CALLALT
DSTA$
      8715**DCL      9032>>ASSIGN   9034>>IF       9045>>IF       9052>>IF       9057>>ASSIGN   9057>>ASSIGN
      9060>>ASSIGN   9060>>ASSIGN   9063>>CALL     9076>>CALL     9106<<ASSIGN   9108>>CALL     9117>>CALL
      9134<<ASSIGN   9136>>CALL     9141>>CALL     9329>>CALL     9412<<ASSIGN   9496<<ASSIGN   9497>>IF
      9506>>CALL     9744<<ASSIGN   9747>>CALL     9749>>IF       9751>>IF       9752>>IF       9757>>CALL
      9764>>CALL     9791<<ASSIGN   9838>>ASSIGN   9887>>CALL     9917>>IF       9920>>IF       9920>>IF
      9990>>CALL    10038>>CALL    10040>>IF      10133<<ASSIGN  10135>>CALL    10161>>IF      10162>>IF
     10165>>ASSIGN  10167>>IF      10180>>IF      10183>>CALL    10190>>ASSIGN  10190>>ASSIGN  10192>>ASSIGN
     10192>>ASSIGN  10195>>CALL    10200>>CALL    10202>>CALL    10268<<ASSIGN  10288>>CALL    10293<<ASSIGN
     10296>>CALL    10304>>CALL    10347>>IF      10353>>ASSIGN  10368>>IF      10373>>CALL    10440<<ASSIGN
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:253  
     10469>>ASSIGN  10473>>ASSIGN  10476>>CALL    10479>>CALL    10480<<ASSIGN  10481>>IF      10486>>CALL
DSTAL
      8720**DCL      8667--IMP-SIZ  8862<<ASSIGN   8868<<CALLBLT  8878>>IF       9003>>IF      10434>>ASSIGN
     10434>>ASSIGN  10493>>IF      10493>>IF
DUMPALT IN PROCEDURE SENDMSG
     10280**LABEL   10278--GOTO
ERRX IN PROCEDURE WRWILD
     10481**LABEL   10448--GOTO    10465--CALLALT 10467--CALLALT
FILLDBLK
      9619**PROC     9172--CALL    10467--CALL
FOUND IN PROCEDURE WRWILD
     10420**DCL     10433<<ASSIGN  10515>>IF      10532>>IF      10543>>IF      10548<<ASSIGN  10548>>ASSIGN
G4 IN PROCEDURE GETNXT
     10549**LABEL   10502--GOTO    10504--GOTO    10524--GOTO    10534--GOTO    10545--GOTO
G5 IN PROCEDURE GETNXT
     10562**LABEL   10521--GOTO
GET0 IN PROCEDURE GETDBLK
      9685**LABEL    9673--GOTO
GETDBLK
      9658**PROC     9171--CALL    10465--CALL
GETMBLK
      9582**PROC     8850--CALL    10444--CALL
GETNXT IN PROCEDURE WRWILD
     10491**PROC    10439--CALL    10474--CALL
HFC$ASSOCCLR
      8731**DCL-ENT  9850--CALL     9862--CALL
HFC$LOCK
      2942**DCL-ENT  8871--CALL     8920--CALL     9088--CALL     9108--CALL     9136--CALL     9246--CALL
      9421--CALL     9462--CALL     9494--CALL     9506--CALL     9741--CALL     9747--CALL     9847--CALL
     10129--CALL    10135--CALL    10212--CALL    10296--CALL    10436--CALL    10456--CALL    10471--CALL
     10476--CALL    10498--CALL
HFC$UNLOCK
      2942**DCL-ENT  8925--CALL     8999--CALL     9076--CALL     9117--CALL     9141--CALL     9284--CALL
      9314--CALL     9329--CALL     9335--CALL     9457--CALL     9500--CALL     9509--CALL     9532--CALL
      9552--CALL     9757--CALL     9764--CALL     9767--CALL     9775--CALL     9784--CALL     9865--CALL
      9878--CALL     9887--CALL     9893--CALL     9990--CALL     9993--CALL    10038--CALL    10138--CALL
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:254  
     10146--CALL    10202--CALL    10270--CALL    10275--CALL    10288--CALL    10304--CALL    10310--CALL
     10461--CALL    10518--CALL    10551--CALL    10554--CALL    10559--CALL    10566--CALL
HFF$TRAPALT
      8732**DCL-ENT  9620--CALL     9630--CALL     9635--CALL     9851--CALL     9863--CALL     9876--CALL
HOLD0
      9491**LABEL    9534--GOTO
I
      8724**DCL      9591<<ASSIGN   9592<>CALL     9593<<ASSIGN   9594<>CALL     9596<>CALL     9599<<ASSIGN
      9601<>CALL
KEY IN PROCEDURE WRWILD
     10417**DCL     10432<<ASSIGN  10434--ASSIGN  10438<>CALL    10493--IF
KEY1L
      8690**DCL      8665--IMP-SIZ  9038<<ASSIGN   9040>>IF       9040>>IF       9128<<ASSIGN   9130>>IF
      9130>>IF      10173<<ASSIGN  10175>>IF      10175>>IF      10253<<ASSIGN  10255>>IF      10255>>IF
     10359<<ASSIGN  10361>>IF      10361>>IF
KEY2L
      8691**DCL      8666--IMP-SIZ  9039<<ASSIGN   9040>>IF       9040>>IF       9100<<ASSIGN   9101>>IF
      9101>>IF       9129<<ASSIGN   9130>>IF       9130>>IF      10174<<ASSIGN  10175>>IF      10175>>IF
     10240<<ASSIGN  10241>>IF      10241>>IF      10254<<ASSIGN  10255>>IF      10255>>IF      10360<<ASSIGN
     10361>>IF      10361>>IF
KQ$CG
      6281**DCL      8811<>CALL     8908<>CALL     8937<>CALL     9180<>CALL     9181<>CALL     9184<>CALL
      9255<>CALL     9271<>CALL     9309<>CALL     9459<>CALL     9502<>CALL     9586<>CALL     9592<>CALL
      9594<>CALL     9596<>CALL     9601<>CALL     9632<>CALL     9636<>CALL     9672<>CALL     9682<>CALL
      9685<>CALL     9690<>CALL     9790<>CALL     9995<>CALL    10042<>CALL    10043<>CALL    10200<>CALL
     10230<>CALL    10266<>CALL    10283<>CALL    10290<>CALL    10373<>CALL    10483<>CALL
KQ$CG.AUCTL.BIGMXT
      6727**DCL      8882>>IF
KQ$CG.AUCTL.CARRYOSTA
      6728**DCL      8962>>IF
KQ$CG.AUCTL.DMTYP
      6720**DCL      8909>>ASSIGN
KQ$CG.AUCTL.DRML
      6727**DCL      9025>>IF
KQ$CG.AUCTL.DVBYTE.REREAD
      6724**DCL      6725--REDEF
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:255  
KQ$CG.AUCTL.JOURNAL
      6728**DCL     10124>>IF
KQ$CG.AUCTL.QRML
      6727**DCL      9080>>IF
KQ$CG.AUCTL.REDUNDANT
      6727**DCL      9664>>IF
KQ$CG.AUCTL.SECURE
      6729**DCL      9052>>IF
KQ$CG.AUCTL.WAS
      6723**DCL      8815>>ASSIGN   9212>>ASSIGN   9357>>ASSIGN   9389>>ASSIGN
KQ$CG.AUCTL.XSTALGL
      6723**DCL      9771>>IF
KQ$CG.AUCTL.XTYPLGL
      6724**DCL      8934>>IF
KQ$CG.AUSTA$
      6691**DCL      8922>>IF       8923>>ASSIGN
KQ$CG.HOLDSTA$
      6711**DCL      9489--ASSIGN
KQ$CG.JRNLSTA$
      6784**DCL      9528--ASSIGN  10131>>IF      10133>>ASSIGN
KQ$CG.MSGID
      6675**DCL      8900>>ASSIGN   8901<<ASSIGN   8901>>ASSIGN  10458>>ASSIGN  10459<<ASSIGN  10459>>ASSIGN
KQ$CG.MSGIDXT
      6682**DCL      8885>>ASSIGN   8886<<ASSIGN   8886>>ASSIGN
KQ$CG.QISS
      6667**DCL      8830>>IF       8947>>IF       8950>>CALL     8965>>IF       8978>>IF       9090>>IF
      9300>>IF      10075>>IF      10214>>IF
KQ$CG.QUEUE.BUSY
      6526**DCL     10228>>IF
KQ$CG.QUEUE.DELAY$
      6518**DCL      9440<>CALL
KQ$CG.QUEUE.DELAYDQ$
      6544**DCL      9440<>CALL     9441--IF       9445<<ASSIGN   9450--ASSIGN   9451>>CALL     9452<>CALL
KQ$CG.QUEUE.QTREE$
      6503**DCL      9088>>CALL     9335>>CALL     9451>>CALL     9457>>CALL     9462>>CALL     9893>>CALL
      9993>>CALL    10212>>CALL    10270>>CALL    10275>>CALL    10310>>CALL
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:256  
KQ$CG.QUEUE.WCRL$
      6506**DCL      9125--ASSIGN  10250--ASSIGN
KQ$CG.STATS.CCMQ
      6773**DCL      9455<<ASSIGN   9455>>ASSIGN  10231<<ASSIGN  10231>>ASSIGN  10399<<ASSIGN  10399>>ASSIGN
KQ$CG.STATS.CCMS
      6773**DCL     10349<<ASSIGN  10349>>ASSIGN  10366<<ASSIGN  10366>>ASSIGN
KQ$CG.STATS.WRITES
      6773**DCL      8812<<ASSIGN   8812>>ASSIGN
KQ$CG.STREE
      6613**DCL      9743<>CALL    10216<>CALL    10438<>CALL
KQ$CG.STREE.GATE
      6615**DCL      8920<>CALL     8925<>CALL     9494<>CALL     9500<>CALL     9509<>CALL     9741<>CALL
      9767<>CALL     9775<>CALL     9784<>CALL    10129<>CALL    10138<>CALL    10146<>CALL    10436<>CALL
     10471<>CALL    10554<>CALL    10566<>CALL
KQ$CG.TTREE
      6574**DCL      8912<>CALL     8950<>CALL     9094<>CALL     9304<>CALL    10225<>CALL
KQ$CG.TTREE.ACTCNT
      6589**DCL      8961>>ASSIGN   9093>>IF      10221>>IF
KQ$CG.TTREE.GATE
      6576**DCL      8871<>CALL     8999<>CALL     9284<>CALL     9314<>CALL    10456<>CALL    10461<>CALL
KQ$DBLK
      7851**DCL      9624--ASSIGN   9625--ASSIGN   9629--ASSIGN
KQ$DBLK.DSIZE
      7856**DCL      9696<<ASSIGN
KQ$DBLK.FLNKDA
      7858**DCL      9183<<ASSIGN
KQ$DBLK.MBLK
      7876**DCL      9695<<ASSIGN
KQ$DBLK.SIZW
      7885**DCL      9694>>ASSIGN
KQ$DBLK.STAMP
      7852**DCL      9698<<ASSIGN
KQ$DPTR.X
      8641**DCL      9418<<ASSIGN   9450<<ASSIGN
KQ$DPTR.X.CODE
      8646**DCL      9415>>IF       9441>>IF
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:257  
KQ$DPTR.X.FLGS
      8644**DCL      9415>>IF
KQ$MBLK
      7543**DCL      9249--ASSIGN   9254<<ASSIGN   9254>>ASSIGN   9309<>CALL     9459<>CALL     9502<>CALL
      9591--ASSIGN   9593--ASSIGN   9668--ASSIGN   9677--ASSIGN   9694--ASSIGN   9694<<ASSIGN   9694>>ASSIGN
     10283<>CALL    10290<>CALL    10453<<ASSIGN  10453>>ASSIGN
KQ$MBLK.DCB$
      7696**DCL      8821>>IF       9195<<ASSIGN   9219<<ASSIGN
KQ$MBLK.DDA
      7608**DCL      9173>>IF       9173<<ASSIGN   9996>>ASSIGN  10045>>ASSIGN  10466<<ASSIGN
KQ$MBLK.DSTA
      7692**DCL      8863<<ASSIGN   8867<<ASSIGN   8868>>CALLBLT  8917>>IF       8923<<ASSIGN   8927>>IF
      8962>>IF       9022>>IF       9556>>IF       9743<>CALL     9790<>CALL    10078>>ASSIGN  10150>>IF
     10434--ASSIGN  10469<<ASSIGN
KQ$MBLK.DVE
      7641**DCL      8852<<ASSIGN
KQ$MBLK.DVE.DVBYTE
      7643**DCL      8829<<ASSIGN   8829>>ASSIGN   8996<<ASSIGN   8996>>ASSIGN   9009>>IF       9189>>IF
     10427>>IF
KQ$MBLK.DVE.EOMCHAR
      7645**DCL      7647--REDEF
KQ$MBLK.DVE.VFC
      7647**DCL      9624>>ASSIGN   9855>>ASSIGN   9910>>IF       9910>>IF
KQ$MBLK.FC
      7638**DCL      9001<<ASSIGN
KQ$MBLK.FORCECONT
      7680**DCL      8828>>IF       8995<<ASSIGN
KQ$MBLK.JOURNAL
      7678**DCL      8991<<ASSIGN   9009>>IF      10124>>IF
KQ$MBLK.JRNLD
      7635**DCL     10124>>IF
KQ$MBLK.KEY1
      7571**DCL      7573--REDEF    8834>>IF       8909<<ASSIGN   8911<<ASSIGN   8912<>CALL     8915>>IF
      8937<>CALL     8967>>ASSIGN   8982>>ASSIGN   8983<<ASSIGN   9040--IF       9094<>CALL     9130--IF
      9303>>ASSIGN   9451<>CALL    10077>>ASSIGN  10175--IF      10216<>CALL    10225<>CALL    10255--IF
     10361--IF
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:258  
KQ$MBLK.KEY2
      7580**DCL      7598--REDEF    8832>>IF       8971>>ASSIGN   8982<<ASSIGN   8989<<ASSIGN   9040--IF
      9101--IF       9130--IF       9302>>ASSIGN  10076>>ASSIGN  10175--IF      10241--IF      10255--IF
     10361--IF
KQ$MBLK.LATCH
      7630**DCL      8851<<ASSIGN   8873>>IF       8941>>IF       8962>>IF       8992>>IF       9009>>IF
      9192>>IF      10422>>IF
KQ$MBLK.LNK$
      7545**DCL      7547--REDEF    7553--REDEF    7557--REDEF    8825>>ASSIGN   8826<<ASSIGN   8826>>ASSIGN
      8841>>ASSIGN   9002<<ASSIGN   9191<<ASSIGN   9201<<ASSIGN   9220<<ASSIGN   9360<<ASSIGN   9555<<ASSIGN
      9976>>ASSIGN   9981<<ASSIGN  10030>>ASSIGN  10035<<ASSIGN  10282>>ASSIGN  10286>>ASSIGN
KQ$MBLK.MID
      7702**DCL      8893<<ASSIGN   8893>>ASSIGN
KQ$MBLK.MID.PRIMARY
      7704**DCL      8884<<ASSIGN   8884>>ASSIGN   8900<<ASSIGN   8908<>CALL     8908--CALL     9040>>IF
      9101>>IF      10073>>ASSIGN  10142>>ASSIGN  10161>>IF      10175>>IF      10187>>IF      10241>>IF
     10255>>IF      10347>>IF      10363>>IF      10458<<ASSIGN
KQ$MBLK.MID.XT
      7705**DCL      8885<<ASSIGN   8894--ASSIGN  10074>>ASSIGN
KQ$MBLK.MSGSIZE
      7706**DCL      9631<<ASSIGN   9631>>ASSIGN   9840<<ASSIGN
KQ$MBLK.PREVDDA
      7708**DCL      9178>>ASSIGN   9186<<ASSIGN   9270>>ASSIGN
KQ$MBLK.PRIO
      7561**DCL      8968--ASSIGN   8972--ASSIGN   8980--ASSIGN   8981--ASSIGN   8987--ASSIGN   8988--ASSIGN
     10160>>IF      10171>>IF      10346>>IF      10357>>IF
KQ$MBLK.RBLK
      7684**DCL      9978<<ASSIGN   9980<<ASSIGN  10032<<ASSIGN  10034<<ASSIGN
KQ$MBLK.STAMP
      7565**DCL      9177>>ASSIGN   9698>>ASSIGN  10452>>ASSIGN  10454<<ASSIGN
KQ$MBLK.STAR
      7633**DCL      8930<<ASSIGN   9009>>IF       9750>>IF      10159>>IF      10345>>IF
KQ$MBLK.TYC
      7694**DCL      7696--REDEF    9207<<ASSIGN
KQ$MBLK.XSP.MREQ$
      7600**DCL      7604--REDEF
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:259  
KQ$MTYP.JOURNAL
      7944**DCL      8991>>ASSIGN
KQ$MTYP.MAXLATCH
      7955**DCL      8956>>IF
KQ$MTYP.MPRIO
      7940**DCL      8981>>ASSIGN   8987>>ASSIGN
KQ$MTYP.NUMWRITES
      7958**DCL      8939<<ASSIGN   8939>>ASSIGN   9306<<ASSIGN   9306>>ASSIGN
KQ$MTYP.ONEREPORT
      7947**DCL      8992>>IF
KQ$QTN.CNACT
      8321**DCL      9986<<ASSIGN   9986>>ASSIGN  10235>>IF
KQ$QTN.MLH
      8382**DCL     10266<>CALL
KQ$QTN.MXACT
      8324**DCL      8326--REDEF   10235>>IF
KQ$QTN.READS$
      8327**DCL      9097--ASSIGN  10237--ASSIGN
KQ$QTN.STA.ACTTYC
      8046**DCL      8050--REDEF
KQ$QTN.STA.DCBLNK$
      8053**DCL      8056--REDEF    8060--REDEF
KQ$QTN.STA.EVCNT
      8139**DCL      8142--REDEF
KQ$QTN.STA.EVNT
      8105**DCL      8109--REDEF    8112--REDEF
KQ$QTN.STA.OPNBLKED
      8166**DCL      8169--REDEF
KQ$QTN.STA.OPNREJ
      8172**DCL      8174--REDEF
KQ$QTN.STA.SUCCREAD
      8095**DCL      8099--REDEF
KQ$QTN.STA.TCOUNT
      8224**DCL      8230--REDEF
KQ$QTN.STA.VGOT$
      8209**DCL      8213--REDEF    8217--REDEF
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:260  
KQ$RBLK.BUF$
      7479**DCL      7481--REDEF    9855>>ASSIGN   9856>>ASSIGN   9860>>ASSIGN
KQ$RBLK.BUFSIZE
      7489**DCL      9841>>IF
KQ$RBLK.CNACTD
      7393**DCL      7402--REDEF
KQ$RBLK.CS
      7384**DCL      8878>>IF
KQ$RBLK.DBLKX
      7499**DCL      7503--REDEF
KQ$RBLK.EOFNONE
      7371**DCL      7374--REDEF
KQ$RBLK.FROMQ
      7377**DCL      7380--REDEF    9984<<ASSIGN
KQ$RBLK.HONK
      7408**DCL     10172>>IF      10358>>IF
KQ$RBLK.KEY1
      7419**DCL      9040--IF       9130--IF      10175--IF      10255--IF      10361--IF
KQ$RBLK.KEY1L
      7414**DCL      9038>>ASSIGN   9128>>ASSIGN  10173>>ASSIGN  10253>>ASSIGN  10359>>ASSIGN
KQ$RBLK.KEY1R
      7418**DCL      7419--REDEF
KQ$RBLK.KEY2
      7424**DCL      9040--IF       9101--IF       9130--IF      10175--IF      10241--IF      10255--IF
     10361--IF
KQ$RBLK.KEY2L
      7416**DCL      9039>>ASSIGN   9100>>ASSIGN   9129>>ASSIGN  10174>>ASSIGN  10240>>ASSIGN  10254>>ASSIGN
     10360>>ASSIGN
KQ$RBLK.KEY2R
      7423**DCL      7424--REDEF
KQ$RBLK.LATCH
      7366**DCL      7368--REDEF    8878>>IF       9034>>IF       9105>>IF       9133>>IF       9982>>IF
KQ$RBLK.LWRITES$
      7510**DCL      7514--REDEF    9198>>IF       9199<<ASSIGN
KQ$RBLK.LWTL$
      7481**DCL      9201>>ASSIGN   9202<<ASSIGN
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:261  
KQ$RBLK.MBLK$
      7358**DCL      8884>>ASSIGN   8893>>ASSIGN   8950>>CALL     8967>>ASSIGN   8968>>ASSIGN   8971>>ASSIGN
      8972>>ASSIGN   9977>>IF       9978>>ASSIGN   9979<<ASSIGN  10031>>IF      10032>>ASSIGN  10033<<ASSIGN
KQ$RBLK.MID.PRIMARY
      7434**DCL      9040>>IF       9040>>IF       9101>>IF       9101>>IF      10175>>IF      10175>>IF
     10187>>IF      10187>>IF      10241>>IF      10241>>IF      10255>>IF      10255>>IF      10363>>IF
     10363>>IF
KQ$RBLK.MIDEXTV
      7496**DCL      8887<<ASSIGN   8887>>ASSIGN   8891>>IF       8892<<ASSIGN   8892>>ASSIGN   8894>>ASSIGN
      8956>>IF
KQ$RBLK.MIDEXTX
      7491**DCL      8894>>ASSIGN
KQ$RBLK.NCDDA
      7440**DCL      9996<<ASSIGN  10045<<ASSIGN
KQ$RBLK.PTW
      7484**DCL      9849>>ASSIGN
KQ$RBLK.QRLNK$
      7514**DCL      9120--ASSIGN   9144--ASSIGN   9974>>ASSIGN   9975<<ASSIGN  10247--ASSIGN  10262--ASSIGN
KQ$RBLK.QTN$
      7517**DCL      8945>>ASSIGN   9985<<ASSIGN
KQ$RBLK.STA$
      7445**DCL      9106>>ASSIGN   9134>>ASSIGN  10293>>ASSIGN
KQ$RBLK.STATE
      7363**DCL      8878>>IF       9034>>IF       9110>>IF       9138>>IF       9988<<ASSIGN  10036<<ASSIGN
     10167>>IF      10298>>IF      10355>>IF
KQ$RBLKT.CNACTD
      8487**DCL      8496--REDEF
KQ$RBLKT.DBLK$
      8550**DCL      8554--REDEF    8557--REDEF
KQ$RBLKT.EOFNONE
      8465**DCL      8468--REDEF
KQ$RBLKT.FROMQ
      8471**DCL      8474--REDEF
KQ$RBLKT.IOQ$
      8564**DCL      9058<<ASSIGN
KQ$RBLKT.KEY1R
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:262  
      8512**DCL      8513--REDEF
KQ$RBLKT.KEY2R
      8517**DCL      8518--REDEF
KQ$RBLKT.LATCH
      8460**DCL      8462--REDEF
KQ$STA
      7019**DCL     10479<>CALL    10486<>CALL
KQ$STA.ACTTYC
      7071**DCL      7075--REDEF
KQ$STA.AUP
      7173**DCL      9749>>IF      10493>>IF
KQ$STA.BTN.FLINK$
      7053**DCL     10473>>ASSIGN  10562>>ASSIGN
KQ$STA.BTN.KEY
      7055**DCL      8908<>CALL     8908<>CALL     8923>>ASSIGN   8975>>ASSIGN   9252>>ASSIGN  10162>>IF
     10215>>IF      10469>>ASSIGN  10493--IF      10493>>IF
KQ$STA.CG$
      7058**DCL      9356>>ASSIGN   9378>>ASSIGN   9388>>ASSIGN   9411>>ASSIGN   9488>>ASSIGN   9527>>ASSIGN
      9548>>ASSIGN
KQ$STA.DCBLNK$
      7078**DCL      7081--REDEF    7085--REDEF
KQ$STA.DSID
      7158**DCL     10161>>IF      10347>>IF
KQ$STA.EVCNT
      7164**DCL      7167--REDEF
KQ$STA.EVNT
      7130**DCL      7134--REDEF    7137--REDEF
KQ$STA.GATE
      7097**DCL      9076<>CALL     9108<>CALL     9117<>CALL     9136<>CALL     9141<>CALL     9329<>CALL
      9421<>CALL     9506<>CALL     9532<>CALL     9552<>CALL     9747<>CALL     9757<>CALL     9764<>CALL
      9887<>CALL     9990<>CALL    10038<>CALL    10135<>CALL    10202<>CALL    10288<>CALL    10296<>CALL
     10304<>CALL    10476<>CALL    10498<>CALL    10518<>CALL    10551<>CALL    10559<>CALL
KQ$STA.JMSGID
      7242**DCL     10142<<ASSIGN
KQ$STA.JRNLW
      7202**DCL     10140>>IF
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:263  
KQ$STA.LDCT$
      7060**DCL      9045>>IF       9052>>IF       9063>>CALL     9751>>IF       9752>>IF       9838>>ASSIGN
      9917>>IF       9920>>IF       9920>>IF      10180>>IF      10183>>CALL    10195>>CALL    10368>>IF
     10502>>IF      10503>>IF      10507>>IF
KQ$STA.LOCKCNT
      7153**DCL      9057<<ASSIGN   9057>>ASSIGN   9060<<ASSIGN   9060>>ASSIGN  10190<<ASSIGN  10190>>ASSIGN
     10192<<ASSIGN  10192>>ASSIGN  10549<<ASSIGN  10549>>ASSIGN
KQ$STA.MBLK$
      7064**DCL      8816>>IF       8819>>ASSIGN   8825<<ASSIGN   9220>>ASSIGN   9221<<ASSIGN   9360>>ASSIGN
      9361<>CALL     9490>>ASSIGN   9491<<ASSIGN   9529>>ASSIGN   9530<<ASSIGN   9549>>ASSIGN   9550<<ASSIGN
KQ$STA.MLH
      7287**DCL     10200<>CALL    10373<>CALL
KQ$STA.MLH.BUSY
      7301**DCL      9034>>IF      10167>>IF
KQ$STA.MLH.COUNT
      7332**DCL     10350<<ASSIGN  10350>>ASSIGN  10367<<ASSIGN  10367>>ASSIGN
KQ$STA.MLH.DELAY$
      7293**DCL      9414<>CALL
KQ$STA.MLH.DELAYDQ$
      7334**DCL      9414<>CALL     9415--IF       9415--IF       9418--ASSIGN   9419<>CALL
KQ$STA.MONDCB
      7103**DCL      9588>>IF       9679>>IF
KQ$STA.MPRIO
      7092**DCL      8976>>ASSIGN
KQ$STA.OPNBLKED
      7191**DCL      7194--REDEF
KQ$STA.OPNREJ
      7197**DCL      7199--REDEF
KQ$STA.RBLK$
      7062**DCL      8876>>ASSIGN   9032>>ASSIGN   9196>>ASSIGN  10165>>ASSIGN  10353>>ASSIGN
KQ$STA.SUCCREAD
      7120**DCL      7124--REDEF
KQ$STA.TCOUNT
      7249**DCL      7255--REDEF
KQ$STA.TERM
      7115**DCL     10040>>IF      10140>>IF      10509>>IF
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:264  
KQ$STA.VGOT$
      7234**DCL      7238--REDEF    7242--REDEF
KQ$STA.WRITES
      7247**DCL      9224<<ASSIGN   9224>>ASSIGN
KQ$THDR
      7814**DCL      9451<>CALL
KQ$THDR.GATE
      7818**DCL      9088<>CALL     9335<>CALL     9457<>CALL     9462<>CALL     9893<>CALL     9993<>CALL
     10212<>CALL    10270<>CALL    10275<>CALL    10310<>CALL
KQB$SRCH
      8733**DCL-ENT  8912--CALL     8950--CALL     9094--CALL     9304--CALL     9451--CALL     9743--CALL
     10216--CALL    10225--CALL    10438--CALL
KQD$DEFERGO
      8734**DCL-ENT  9682--CALL
KQD$DEFERWAIT
      8735**DCL-ENT  9271--CALL     9685--CALL
KQD$ERRLOG
      8737**DCL-ENT  9255--CALL
KQD$FETCH
      8738**DCL-ENT  9180--CALL
KQD$FETCHR
      8739**DCL-ENT  9181--CALL
KQD$GET
      8740**DCL-ENT  9672--CALL
KQD$GETR
      8741**DCL-ENT  9690--CALL
KQD$UNLOCK
      8742**DCL-ENT  9632--CALL     9636--CALL
KQD$UPDATED
      8743**DCL-ENT  9184--CALL
KQG$GOTMSG
      8744**DCL-ENT 10195--CALL
KQG$GOTMWB
      8745**DCL-ENT  9063--CALL
KQL$DELAYDQ
      8746**DCL-ENT  9414--CALL     9440--CALL
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:265  
KQL$INSERT
      8747**DCL-ENT 10200--CALL    10266--CALL
KQL$INSERTF
      8748**DCL-ENT 10373--CALL
KQL$QDELAYM
      8749**DCL-ENT 10230--CALL
KQM$GETBK
      8750**DCL-ENT  9592--CALL
KQM$GETBR
      8751**DCL-ENT  9601--CALL
KQM$GETMBLK
      8752**DCL-ENT  9586--CALL     9596--CALL
KQM$RELB
      8753**DCL-ENT  9594--CALL
KQM$RELMBLK
      8754**DCL-ENT 10483--CALL
KQP$UNLOCK
      8755**DCL-ENT 10479--CALL    10486--CALL
KQQ$DEQUEUE
      8756**DCL-ENT 10042--CALL
KQQ$DQEOFTIME
      8757**DCL-ENT  9995--CALL    10043--CALL
KQR$COMP
      8758**DCL-ENT  9873--CALL
KQR$GOTMSG
      8759**DCL-ENT 10183--CALL
KQT$GETSTA
      8760**DCL-ENT  9790--CALL
KQT$GETTYP
      8761**DCL-ENT  8937--CALL
KQU$DELMSG
      8763**DCL-ENT  9309--CALL     9459--CALL     9502--CALL    10283--CALL    10290--CALL
KQX$LDASR
      8764**DCL-ENT  8811--CALL
KQZ$LOG
      8765**DCL-ENT  8908--CALL
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:266  
KQ_DEBUG
      2955**DCL      9664>>IF
KQ_ERRLOG_BFR.CODE
      8775**DCL      9248<<ASSIGN
KQ_ERRLOG_BFR.INFO
      8776**DCL      9250--ASSIGN   9251<<ASSIGN
KQ_ERRLOG_BFR.SIZ
      8776**DCL      9249<<ASSIGN
KQ_ERRLOG_GATE
      2985**DCL      9246<>CALL
KQ_IMBLK.DVE.EOMCHAR
      3617**DCL      3619--REDEF
KQ_IMBLK.KEY1
      3543**DCL      3545--REDEF
KQ_IMBLK.KEY2
      3552**DCL      3570--REDEF
KQ_IMBLK.LNK$
      3517**DCL      3519--REDEF    3525--REDEF    3529--REDEF
KQ_IMBLK.TYC
      3666**DCL      3668--REDEF
KQ_IMBLK.XSP.MREQ$
      3572**DCL      3576--REDEF
KQ_IMTYP
      3371**DCL      8931--ASSIGN   9298--IF
KQ_IRBLK.BUF$
      3121**DCL      3123--REDEF
KQ_IRBLK.CNACTD
      3035**DCL      3044--REDEF
KQ_IRBLK.DBLKX
      3141**DCL      3145--REDEF
KQ_IRBLK.EOFNONE
      3013**DCL      3016--REDEF
KQ_IRBLK.FROMQ
      3019**DCL      3022--REDEF
KQ_IRBLK.KEY1R
      3060**DCL      3061--REDEF
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:267  
KQ_IRBLK.KEY2R
      3065**DCL      3066--REDEF
KQ_IRBLK.LATCH
      3008**DCL      3010--REDEF
KQ_IRBLK.LWRITES$
      3152**DCL      3156--REDEF
KQ_IRBLKT.CNACTD
      3221**DCL      3230--REDEF
KQ_IRBLKT.DBLK$
      3284**DCL      3288--REDEF    3291--REDEF
KQ_IRBLKT.EOFNONE
      3199**DCL      3202--REDEF
KQ_IRBLKT.FROMQ
      3205**DCL      3208--REDEF
KQ_IRBLKT.KEY1R
      3246**DCL      3247--REDEF
KQ_IRBLKT.KEY2R
      3251**DCL      3252--REDEF
KQ_IRBLKT.LATCH
      3194**DCL      3196--REDEF
KQ_LOG.DSIO
      2976**DCL      8903>>IF
KQ_XFGATE
      2959**DCL      9847<>CALL     9865<>CALL     9878<>CALL
LDCT$
      8684**DCL      8803<<ASSIGN   8804>>IF       8809>>ASSIGN   8810>>ASSIGN
LOCK IN PROCEDURE CHKSTAL
      9727**DCL      9729<<ASSIGN   9738<<ASSIGN   9762>>IF
M$ IN PROCEDURE MOVMC
     10013**DCL     10011--PROC    10023--ENTRY   10028>>ASSIGN  10030<<ASSIGN  10054--ENTRY
M$ IN PROCEDURE MOVMCQ
      9955**DCL      9953--PROC     9968--ENTRY    9972>>ASSIGN   9976<<ASSIGN
M$ IN PROCEDURE SENDMSG
     10120**DCL     10118--PROC    10122>>ASSIGN  10182<>CALL    10191<>CALL    10200<>CALL    10230<>CALL
     10266<>CALL    10282<<ASSIGN  10286<<ASSIGN  10300<>CALL    10326--ENTRY   10328>>ASSIGN  10342--ENTRY
     10344>>ASSIGN  10373<>CALL    10385--ENTRY   10387>>ASSIGN  10397--ENTRY   10400>>ASSIGN
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:268  
M$ IN PROCEDURE WRWILD
     10419**DCL     10443<<ASSIGN  10447>>ASSIGN  10450>>ASSIGN  10451<<ASSIGN  10478<>CALL
MBLK$
      8687**DCL      7543--IMP-PTR  8819<<ASSIGN   8820>>DOWHILE  8821>>IF       8824>>ASSIGN   8825>>ASSIGN
      8826>>ASSIGN   8828>>IF       8829>>ASSIGN   8829>>ASSIGN   8832>>IF       8834>>IF       8840>>ASSIGN
      8841<<ASSIGN   8841>>ASSIGN   8851>>ASSIGN   8852>>ASSIGN   8863>>ASSIGN   8867>>ASSIGN   8868>>CALLBLT
      8873>>IF       8884>>ASSIGN   8885>>ASSIGN   8893>>ASSIGN   8894>>ASSIGN   8900>>ASSIGN   8908>>CALL
      8908>>CALL     8909>>ASSIGN   8911>>ASSIGN   8912>>CALL     8915>>IF       8917>>IF       8923>>ASSIGN
      8927>>IF       8930>>ASSIGN   8937>>CALL     8941>>IF       8962>>IF       8962>>IF       8980>>ASSIGN
      8981>>ASSIGN   8982>>ASSIGN   8982>>ASSIGN   8983>>ASSIGN   8987>>ASSIGN   8988>>ASSIGN   8989>>ASSIGN
      8991>>ASSIGN   8992>>IF       8995>>ASSIGN   8996>>ASSIGN   8996>>ASSIGN   9001>>ASSIGN   9002>>ASSIGN
      9009>>IF       9009>>IF       9009>>IF       9009>>IF       9022>>IF       9040>>IF       9040>>IF
      9040>>IF       9067>>ASSIGN   9094>>CALL     9101>>IF       9101>>IF       9130>>IF       9130>>IF
      9173>>IF       9173>>ASSIGN   9177>>ASSIGN   9178>>ASSIGN   9186>>ASSIGN   9189>>IF       9191>>ASSIGN
      9192>>IF       9195>>ASSIGN   9199>>ASSIGN   9201>>ASSIGN   9202>>ASSIGN   9207>>ASSIGN   9219>>ASSIGN
      9220>>ASSIGN   9221>>ASSIGN   9254>>ASSIGN   9270>>ASSIGN   9603<<ASSIGN   9624>>ASSIGN   9631>>ASSIGN
      9631>>ASSIGN   9694>>ASSIGN   9698>>ASSIGN   9743>>CALL     9750>>IF       9790>>CALL     9840>>ASSIGN
      9855>>ASSIGN   9910>>IF       9910>>IF       9972<<ASSIGN   9976>>ASSIGN   9979>>ASSIGN   9980>>ASSIGN
      9981>>ASSIGN   9996>>ASSIGN  10028<<ASSIGN  10030>>ASSIGN  10033>>ASSIGN  10034>>ASSIGN  10035>>ASSIGN
     10045>>ASSIGN  10073>>ASSIGN  10074>>ASSIGN  10076>>ASSIGN  10077>>ASSIGN  10078>>ASSIGN  10122<<ASSIGN
     10124>>IF      10124>>IF      10142>>ASSIGN  10150>>IF      10159>>IF      10160>>IF      10161>>IF
     10171>>IF      10175>>IF      10175>>IF      10175>>IF      10187>>IF      10216>>CALL    10225>>CALL
     10241>>IF      10241>>IF      10255>>IF      10255>>IF      10255>>IF      10282>>ASSIGN  10283>>CALL
     10286>>ASSIGN  10290>>CALL    10328<<ASSIGN  10344<<ASSIGN  10345>>IF      10346>>IF      10347>>IF
     10357>>IF      10361>>IF      10361>>IF      10363>>IF      10387<<ASSIGN  10400<<ASSIGN  10422>>IF
     10427>>IF      10434>>ASSIGN  10451>>ASSIGN  10452>>ASSIGN  10453>>ASSIGN  10454>>ASSIGN  10458>>ASSIGN
     10466>>ASSIGN  10469>>ASSIGN
MD1 IN PROCEDURE GETMBLK
      9595**LABEL    9592--CALLALT
MOVM IN PROCEDURE MOVMC
     10026**LABEL   10017--GOTO    10057--GOTO
MOVMC
     10011**PROC     9871--CALL
MOVMCQ
      9953**PROC     9869--CALL
MOVMQ IN PROCEDURE MOVMCQ
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:269  
      9970**LABEL    9959--GOTO
MOVMX IN PROCEDURE MOVMC
     10023**ENTRY   10182--CALL
MOVMXQ IN PROCEDURE MOVMCQ
      9968**ENTRY   10300--CALL
MOVMXT IN PROCEDURE MOVMC
     10054**ENTRY    9059--CALL    10191--CALL
MTYP$
      8714**DCL      7904--IMP-PTR  8823<<ASSIGN   8912<>CALL     8931<<ASSIGN   8936<<ASSIGN   8937<>CALL
      8939>>ASSIGN   8939>>ASSIGN   8981>>ASSIGN   8987>>ASSIGN   8991>>ASSIGN   8992>>IF       9095>>ASSIGN
      9298>>IF       9298>>IF       9304<>CALL     9306>>ASSIGN   9306>>ASSIGN   9359<<ASSIGN   9554<<ASSIGN
     10221>>IF      10223>>ASSIGN
MYMBLK$
      8717**DCL      8824<<ASSIGN   9059<>CALL     9067<<ASSIGN   9208<>CALL     9209<>CALL     9213<>CALL
      9296>>IF       9302>>ASSIGN   9303>>ASSIGN   9309>>CALL     9490<<ASSIGN   9502>>CALL     9511<>CALL
      9529<<ASSIGN   9549<<ASSIGN   9555>>ASSIGN   9556>>IF       9559<>CALL     9602<<ASSIGN   9606<<ASSIGN
      9869<>CALL     9871<>CALL    10443>>ASSIGN  10447<<ASSIGN  10450<<ASSIGN  10453>>ASSIGN  10483<>CALL
N$DCT$$
      3983**DCL      3983--IMP-PTR  8803>>ASSIGN
N$REQ
      6217**DCL      9225<>CALL     9323<>CALL     9873<>CALL    10183<>CALL
N$REQ.ARSIZE
      6250**DCL      9867<<ASSIGN
N$REQ.BUF$
      6226**DCL      9625>>ASSIGN   9629>>ASSIGN   9856>>ASSIGN   9860>>ASSIGN
N$REQ.BUFADDR
      6226**DCL      6227--REDEF    6227--REDEF
N$REQ.BUFSIZE
      6220**DCL      8835>>ASSIGN   8854>>ASSIGN   8858<<ASSIGN
N$REQ.DCB$
      6248**DCL      8821>>IF       9195>>ASSIGN   9219>>ASSIGN
N$REQ.DLA.DCTX
      6217**DCL      8803>>ASSIGN
N$REQ.DLA.DRELADDR
      6218**DCL      6218--REDEF
N$REQ.DVE
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:270  
      6252**DCL      8852>>ASSIGN
N$REQ.DVE.DVBYTE.CONT
      6255**DCL      8827>>IF
N$REQ.DVE.DVBYTE.VFC
      6253**DCL      8853>>ASSIGN
N$REQ.DVE.EOMCHAR
      6255**DCL      6256--REDEF
N$REQ.EAINFO
      6249**DCL      6249--REDEF
N$REQ.EAINFOX
      6249**DCL      6250--REDEF
N$REQ.EVNTINFO
      6250**DCL      6250--REDEF
N$REQ.FC
      6220**DCL      9001>>ASSIGN   9052>>IF
N$REQ.STATION.LSTA$
      6230**DCL      8814>>ASSIGN   9065<<ASSIGN  10071<<ASSIGN
N$REQ.STATUS
      6231**DCL      6237--REDEF
N$REQ.TYC
      6239**DCL      8806<<ASSIGN   9064>>IF       9239<<ASSIGN   9243<<ASSIGN   9280<<ASSIGN   9286<<ASSIGN
      9289<<ASSIGN   9292<<ASSIGN   9317<<ASSIGN   9320<<ASSIGN   9839<<ASSIGN
N$WREQ
      6106**DCL        71--PROC     8802--ASSIGN   9353--ENTRY    9355--ASSIGN   9373--ENTRY    9377--ASSIGN
      9385--ENTRY    9387--ASSIGN   9408--ENTRY    9410--ASSIGN   9434--ENTRY    9438--ASSIGN   9471--ENTRY
      9485--ENTRY    9487--ASSIGN   9524--ENTRY    9526--ASSIGN   9545--ENTRY    9547--ASSIGN
N$WREQ.BUFADDR
      6115**DCL      6116--REDEF    6116--REDEF
N$WREQ.DLA.DRELADDR
      6107**DCL      6107--REDEF
N$WREQ.DVE.EOMCHAR
      6144**DCL      6145--REDEF
N$WREQ.EAINFO
      6138**DCL      6138--REDEF
N$WREQ.EAINFOX
      6138**DCL      6139--REDEF
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:271  
N$WREQ.EVNTINFO
      6139**DCL      6139--REDEF
N$WREQ.STATUS
      6120**DCL      6126--REDEF
NEWDDA
      8718**DCL      8719--REDEF    9173>>ASSIGN   9183>>ASSIGN   9186>>ASSIGN   9662<<ASSIGN   9668<<ASSIGN
      9668>>ASSIGN   9672<>CALL     9676<<ASSIGN   9677<<ASSIGN   9677>>ASSIGN   9685<>CALL     9690<>CALL
      9702>>IF       9703>>IF      10466>>ASSIGN
NIO$COMPCNS
      8767**DCL-ENT  9323--CALL
NIO$COMPCW
      8766**DCL-ENT  9225--CALL
NK$LDCT
      6175**DCL      9063<>CALL    10195<>CALL
NK$LDCT.CG$
      6206**DCL      8810>>ASSIGN
NK$LDCT.DDT$
      6177**DCL      6177--REDEF
NK$LDCT.IOQ$
      6176**DCL      6177--REDEF    9838>>ASSIGN  10183>>CALL
NK$LDCT.LDCTX
      6178**DCL      6178--REDEF
NK$LDCT.LKFLG.ABORTED
      6190**DCL      6191--REDEF
NK$LDCT.LKFLG.ACTIVE
      6194**DCL      8804>>IF       9752>>IF      10503>>IF
NK$LDCT.RESCOD
      6183**DCL      9045>>IF       9920>>IF      10180>>IF      10368>>IF
NK$LDCT.RLCID.LDCTX
      6200**DCL      6200--REDEF
NK$LDCT.RLCID.NODE
      6199**DCL      9052>>IF
NK$LDCT.STA$
      6196**DCL      6197--REDEF    8809>>ASSIGN
NK$LDCT.SYMB$
      6175**DCL      6175--REDEF    6175--REDEF    6176--REDEF
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:272  
NK$LDCT.USER
      6185**DCL      9920>>IF
NK$LDCT$
      3983**DCL      8803>>ASSIGN
NOFETCH
      9224**LABEL    9180--CALLALT
NOFETCH0
      9225**LABEL    9274--GOTO
NOFETCH1
      9270**LABEL    9181--CALLALT  9271--CALLALT
NOFETCH2
      9243**LABEL    9240--GOTO
NOGET IN PROCEDURE GETDBLK
      9672**LABEL    9672--CALLALT
NOGET0 IN PROCEDURE GETDBLK
      9690**LABEL    9678--GOTO
NOGET1 IN PROCEDURE GETDBLK
      9698**LABEL    9685--CALLALT  9690--CALLALT
NOGET2 IN PROCEDURE GETDBLK
      9702**LABEL    9683--GOTO
NOMEM IN PROCEDURE CHKSTAL
      9791**LABEL    9790--CALLALT
NOSEND IN PROCEDURE SENDMSG
     10282**LABEL   10163--GOTO    10182--CALLALT 10193--GOTO    10245--GOTO    10260--GOTO    10351--GOTO
NOSTA IN PROCEDURE CHKSTAL
      9762**LABEL    9743--CALLALT
NOSTA IN PROCEDURE SENDMSG
     10277**LABEL   10157--CALLALT 10216--CALLALT
NOTYP IN PROCEDURE SENDMSG
     10268**LABEL   10225--CALLALT
NXTSTA$ IN PROCEDURE WRWILD
     10418**DCL     10438<>CALL    10440>>ASSIGN  10473<<ASSIGN  10480>>ASSIGN  10492>>DOWHILE 10493>>IF
     10493>>IF      10493>>IF      10498>>CALL    10502>>IF      10503>>IF      10507>>IF      10509>>IF
     10518>>CALL    10520<<ASSIGN  10549>>ASSIGN  10549>>ASSIGN  10551>>CALL    10559>>CALL    10562<<ASSIGN
     10562>>ASSIGN
OSTA
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:273  
      8711**DCL      8967<<ASSIGN   8971<<ASSIGN   8975<<ASSIGN   8983>>ASSIGN   8989>>ASSIGN   9302<<ASSIGN
      9303<<ASSIGN   9304<>CALL
OSTAPRIO
      8710**DCL      8968<<ASSIGN   8972<<ASSIGN   8976<<ASSIGN   8980>>ASSIGN   8988>>ASSIGN
P$
      8692**DCL      8818<<ASSIGN   8825>>IF       8826>>ASSIGN   8840<<ASSIGN   9097<<ASSIGN   9098>>ASSIGN
      9120<<ASSIGN   9121>>ASSIGN   9125<<ASSIGN   9126>>ASSIGN   9144<<ASSIGN   9145>>ASSIGN   9250<<ASSIGN
      9252>>ASSIGN   9253<<ASSIGN   9253>>ASSIGN   9254>>ASSIGN   9459>>CALL     9489<<ASSIGN   9496>>ASSIGN
      9528<<ASSIGN   9974>>ASSIGN  10237<<ASSIGN  10238>>ASSIGN  10247<<ASSIGN  10248>>ASSIGN  10250<<ASSIGN
     10251>>ASSIGN  10262<<ASSIGN  10263>>ASSIGN
QLOCK IN PROCEDURE XFERD
      9821**DCL      9824<<ASSIGN   9836<<ASSIGN   9868>>IF       9890>>IF
QTN$
      8712**DCL      7978--IMP-PTR  8945<<ASSIGN   8947>>IF       8950<>CALL     8956>>IF       9090<<ASSIGN
      9094<>CALL     9095<<ASSIGN   9097>>ASSIGN   9451<>CALL     9985>>ASSIGN   9986>>ASSIGN   9986>>ASSIGN
     10216<>CALL    10218<<ASSIGN  10223<<ASSIGN  10225<>CALL    10235>>IF      10235>>IF      10237>>ASSIGN
     10266>>CALL
RBLK$
      8686**DCL      7357--IMP-PTR  8451--IMP-PTR  8876<<ASSIGN   8877>>IF       8878>>IF       8878>>IF
      8878>>IF       8884>>ASSIGN   8887>>ASSIGN   8887>>ASSIGN   8891>>IF       8892>>ASSIGN   8892>>ASSIGN
      8893>>ASSIGN   8894>>ASSIGN   8894>>ASSIGN   8945>>ASSIGN   8950>>CALL     8956>>IF       8967>>ASSIGN
      8968>>ASSIGN   8971>>ASSIGN   8972>>ASSIGN   9032<<ASSIGN   9033>>IF       9034>>IF       9034>>IF
      9038>>ASSIGN   9039>>ASSIGN   9040>>IF       9040>>IF       9040>>IF       9040>>IF       9058>>ASSIGN
      9098<<ASSIGN   9099>>DOWHILE  9100>>ASSIGN   9101>>IF       9101>>IF       9101>>IF       9105>>IF
      9106>>ASSIGN   9110>>IF       9120>>ASSIGN   9121<<ASSIGN   9126<<ASSIGN   9127>>DOWHILE  9128>>ASSIGN
      9129>>ASSIGN   9130>>IF       9130>>IF       9133>>IF       9134>>ASSIGN   9138>>IF       9144>>ASSIGN
      9145<<ASSIGN   9196<<ASSIGN   9198>>IF       9199>>ASSIGN   9201>>ASSIGN   9202>>ASSIGN   9841>>IF
      9849>>ASSIGN   9855>>ASSIGN   9856>>ASSIGN   9860>>ASSIGN   9974>>ASSIGN   9975>>ASSIGN   9977>>IF
      9978>>ASSIGN   9979>>ASSIGN   9982>>IF       9984>>ASSIGN   9985>>ASSIGN   9988>>ASSIGN   9995<>CALL
      9996>>ASSIGN  10031>>IF      10032>>ASSIGN  10033>>ASSIGN  10036>>ASSIGN  10042<>CALL    10043<>CALL
     10045>>ASSIGN  10165<<ASSIGN  10166>>IF      10167>>IF      10172>>IF      10173>>ASSIGN  10174>>ASSIGN
     10175>>IF      10175>>IF      10175>>IF      10175>>IF      10187>>IF      10187>>IF      10238<<ASSIGN
     10239>>DOWHILE 10240>>ASSIGN  10241>>IF      10241>>IF      10241>>IF      10247>>ASSIGN  10248<<ASSIGN
     10251<<ASSIGN  10252>>DOWHILE 10253>>ASSIGN  10254>>ASSIGN  10255>>IF      10255>>IF      10255>>IF
     10255>>IF      10262>>ASSIGN  10263<<ASSIGN  10293>>ASSIGN  10298>>IF      10353<<ASSIGN  10354>>IF
     10355>>IF      10358>>IF      10359>>ASSIGN  10360>>ASSIGN  10361>>IF      10361>>IF      10363>>IF
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:274  
     10363>>IF
RBSTATE IN PROCEDURE MOVMC
     10014**DCL     10016<<ASSIGN  10026<<ASSIGN  10036>>ASSIGN  10056<<ASSIGN
RBSTATE IN PROCEDURE MOVMCQ
      9956**DCL      9958<<ASSIGN   9970<<ASSIGN   9988>>ASSIGN
RCVR
      8719**DCL      9436<<ASSIGN   9443>>IF       9473<<ASSIGN
REDUND IN PROCEDURE GETDBLK
      9660**DCL      9663<<ASSIGN   9667<<ASSIGN   9677>>IF       9692>>IF
RRQ$ IN PROCEDURE XFERD
      9822**DCL      9838<<ASSIGN   9839>>ASSIGN   9867>>ASSIGN   9873>>CALL
SC_CGNOTIMP
      8768**DCL-ENT  9259--CALL     9275--CALL     9704--CALL
SEND0
      9357**LABEL    9379--GOTO     9390--GOTO
SENDAU IN PROCEDURE SENDMSG
     10182**LABEL   10172--GOTO    10358--GOTO
SENDD IN PROCEDURE SENDMSG
     10157**LABEL   10329--GOTO
SENDD1 IN PROCEDURE SENDMSG
     10164**LABEL   10143--GOTO
SENDD2 IN PROCEDURE SENDMSG
     10181**LABEL   10369--GOTO
SENDD3 IN PROCEDURE SENDMSG
     10189**LABEL   10370--GOTO
SENDDCB IN PROCEDURE SENDMSG
     10183**LABEL   10244--CALLALT 10259--CALLALT
SENDIT IN PROCEDURE SENDMSG
     10292**PROC    10244--CALL    10259--CALL
SENDMSG
     10118**PROC     9213--CALL     9361--CALL     9559--CALL
SENDMSGD IN PROCEDURE SENDMSG
     10326**ENTRY    9208--CALL     9511--CALL    10478--CALL
SENDMSGD1 IN PROCEDURE SENDMSG
     10342**ENTRY    9419--CALL
SENDMSGQ IN PROCEDURE SENDMSG
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:275  
     10385**ENTRY    9209--CALL
SENDMSGQ1 IN PROCEDURE SENDMSG
     10397**ENTRY    9452--CALL
SENDQ IN PROCEDURE SENDMSG
     10221**LABEL   10388--GOTO
SENDQ1 IN PROCEDURE SENDMSG
     10228**LABEL   10401--GOTO
SENDQXIT IN PROCEDURE SENDMSG
     10266**LABEL   10232--GOTO
SETWCOMP
     10070**PROC     9056--CALL     9188--CALL     9872--CALL
SSR$REG
      8769**DCL-ENT  9595--CALL
STA$
      8685**DCL      7019--IMP-PTR  8809<<ASSIGN   8816>>IF       8819>>ASSIGN   8825>>ASSIGN   8876>>ASSIGN
      8908>>CALL     8908>>CALL     8936>>ASSIGN   8975>>ASSIGN   8976>>ASSIGN   9090>>ASSIGN   9196>>ASSIGN
      9220>>ASSIGN   9221>>ASSIGN   9224>>ASSIGN   9224>>ASSIGN   9252>>ASSIGN   9355<<ASSIGN   9356>>ASSIGN
      9360>>ASSIGN   9361>>CALL     9377<<ASSIGN   9378>>ASSIGN   9387<<ASSIGN   9388>>ASSIGN   9410<<ASSIGN
      9411>>ASSIGN   9412>>ASSIGN   9414>>CALL     9414>>CALL     9415>>IF       9415>>IF       9418>>ASSIGN
      9419>>CALL     9421>>CALL     9487<<ASSIGN   9488>>ASSIGN   9490>>ASSIGN   9491>>ASSIGN   9526<<ASSIGN
      9527>>ASSIGN   9529>>ASSIGN   9530>>ASSIGN   9532>>CALL     9547<<ASSIGN   9548>>ASSIGN   9549>>ASSIGN
      9550>>ASSIGN   9552>>CALL     9588>>IF       9600>>ASSIGN   9679>>IF       9789>>ASSIGN  10140>>IF
     10140>>IF      10142>>ASSIGN  10215>>IF      10218>>ASSIGN  10350>>ASSIGN  10350>>ASSIGN  10367>>ASSIGN
     10367>>ASSIGN
S_CUN
      8772**DCL      9590>>IF       9679>>IF
S_TIMR
      8771**DCL      9590>>IF       9679>>IF
T$ IN PROCEDURE CHKSTAL
      9726**DCL      9743<>CALL     9744>>ASSIGN   9789<<ASSIGN   9790<>CALL     9791>>ASSIGN
T$ IN PROCEDURE GETMBLK
      9584**DCL      9586<>CALL     9592<>CALL     9594<>CALL     9596<>CALL     9600<<ASSIGN   9601<>CALL
      9602>>ASSIGN   9603>>ASSIGN
TACTCNT
      8721**DCL      8961<<ASSIGN   9093>>IF      10221>>IF
TYC
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:276  
      8713**DCL      9320>>ASSIGN   9607<<ASSIGN   9638<<ASSIGN   9706<<ASSIGN   9777<<ASSIGN   9786<<ASSIGN
      9794<<ASSIGN  10277<<ASSIGN  10280<<ASSIGN  10424<<ASSIGN  10429<<ASSIGN
UDONE IN PROCEDURE GETNXT
     10516**LABEL   10532--GOTO    10543--GOTO
UNLOCKQ IN PROCEDURE XFERD
      9882**LABEL    9844--GOTO
VFC
      8723**DCL      8836<<ASSIGN   8853<<ASSIGN   8854>>ASSIGN   9621>>IF       9852>>IF
VLP$
      8689**DCL      8814<<ASSIGN   8815>>ASSIGN   8832>>IF       8834>>IF       8851>>ASSIGN   8860>>IF
      8867>>ASSIGN   8909>>IF       8911>>ASSIGN  10072>>ASSIGN  10511>>IF      10512>>IF      10512>>IF
     10528>>IF      10529>>IF      10529>>IF      10539>>IF      10540>>IF      10540>>IF
VLP$STATION.CTL
      8657**DCL     10072>>ASSIGN
VLP$STATION.CTL.ALLABSENT
      8659**DCL     10512>>IF      10529>>IF      10539>>IF
VLP$STATION.CTL.ALLDCBS
      8658**DCL     10512>>IF      10528>>IF      10540>>IF
VLP$STATION.CTL.ALLTRMS
      8658**DCL     10511>>IF      10529>>IF      10540>>IF
VLP$STATION.CTL.ANYDCB
      8658**DCL      8860>>IF
VLP$STATION.CTL.LATCH
      8657**DCL      8851>>ASSIGN
VLP$STATION.CTL.WAS
      8658**DCL      8815>>ASSIGN
VLP$STATION.MSGIDXT
      8659**DCL      8661--REDEF
VLP$STATION.MSGTYP
      8657**DCL      8832>>IF       8834>>IF       8909>>IF       8911>>ASSIGN
VLP$STATION.STATION
      8657**DCL      8867>>ASSIGN
VLP_STATION
      8696**DCL      9065--ASSIGN  10071--ASSIGN
VLP_STATION.CTL
      8700**DCL     10072<<ASSIGN
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:277  
VLP_STATION.MSGID
      8702**DCL     10073<<ASSIGN
VLP_STATION.MSGIDXT
      8702**DCL      8704--REDEF   10074<<ASSIGN
VLP_STATION.MSGTYP
      8700**DCL     10076<<ASSIGN  10077<<ASSIGN
VLP_STATION.STATION
      8700**DCL     10078<<ASSIGN
W0 IN PROCEDURE GETMBLK
      9588**LABEL    9586--CALLALT
W1 IN PROCEDURE GETMBLK
      9602**LABEL    9587--GOTO     9597--GOTO
WAS
      8693**DCL      8815<<ASSIGN   9212<<ASSIGN   9357<<ASSIGN   9375<<ASSIGN   9389<<ASSIGN   9557<<ASSIGN
      9558<<ASSIGN   9750>>IF       9753>>IF       9780>>IF      10500>>IF
WR0
      8912**LABEL    8912--CALLALT
WR1
      8939**LABEL    8932--GOTO
WR11
      9139**LABEL    9105--GOTO     9133--GOTO
WR2
      9067**LABEL    9063--CALLALT
WR3
      9048**LABEL    9114--GOTO
WR4
      8936**LABEL    8913--GOTO
WR5
      8952**LABEL    8950--CALLALT
WRITECG
      9168**LABEL    8838--GOTO     9012--GOTO     9068--GOTO
WRITECG0
      9173**LABEL    9236--GOTO
WRITECG1
      9179**LABEL    9272--GOTO
WRITECOMP
PL6.E3A0      #001=KQW$WRITE File=KQW$WRITE.:E05TSI                              WED 07/30/97 01:38 Page:278  
      9221**LABEL    9006--GOTO     9047--CALLALT  9066--GOTO     9113--CALLALT
WRITENOWQ
      9105**LABEL    9139--GOTO
WRQ$
      8716**DCL      8802<<ASSIGN   8803>>ASSIGN   8806>>ASSIGN   8814>>ASSIGN   8821>>IF       8827>>IF
      8835>>ASSIGN   8852>>ASSIGN   8853>>ASSIGN   8854>>ASSIGN   8858>>ASSIGN   9001>>ASSIGN   9052>>IF
      9058>>ASSIGN   9064>>IF       9065>>ASSIGN   9195>>ASSIGN   9219>>ASSIGN   9225>>CALL     9239>>ASSIGN
      9243>>ASSIGN   9280>>ASSIGN   9286>>ASSIGN   9289>>ASSIGN   9292>>ASSIGN   9317>>ASSIGN   9320>>ASSIGN
      9323>>CALL     9625>>ASSIGN   9629>>ASSIGN   9856>>ASSIGN   9860>>ASSIGN  10071>>ASSIGN
WRWILD
     10415**PROC     9005--CALL
WW0 IN PROCEDURE WRWILD
     10440**LABEL   10481--GOTO
WW1 IN PROCEDURE WRWILD
     10443**LABEL   10444--CALLALT
WW2 IN PROCEDURE WRWILD
     10447**LABEL   10445--GOTO
XFER IN PROCEDURE XFERD
      9836**LABEL    9825--GOTO
XFERD
      9819**PROC     9047--CALL
XFERQ IN PROCEDURE XFERD
      9835**ENTRY    9113--CALL
XMITQ0
      9454**LABEL    9451--CALLALT
XMITQ1
      9455**LABEL    9453--GOTO
XMITQ2
      9464**LABEL    9446--GOTO
XMITQCMN
      9436**LABEL    9474--GOTO
XMS1
      9423**LABEL    9419--CALLALT
