VERSION E05

PL6.E3A0      #001=KNH$SCAN File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:03 Page:1    
        1        1        /*M* KNH$HMI - Handler Monitor Inteface module */
        2        2        /*T***********************************************************/
        3        3        /*T*                                                         */
        4        4        /*T* Copyright (c) Bull HN Information Systems Inc., 1997    */
        5        5        /*T*                                                         */
        6        6        /*T***********************************************************/
        7        7        /*X*     NSO,PLM=3,SQB=Y,AND=Y,ENI=0,SDI=3,MCL=10,CSI=0,ECI=0,IAD=3,IND=0 */
        8        8        /*P*
        9        9             NAME: KNH$HMI
       10       10             PURPOSE:
       11       11                  This module contains the routines that make up the
       12       12                  Handler monitor interface.
       13       13             DESCRIPTION:
       14       14                  None.
       15       15        */
       16       16
       17       17        /*F*
       18       18             NAME: KNH$SCAN
       19       19             PURPOSE:
       20       20                  To scan the send circular queue for the handler.
       21       21             DESCRIPTION:
       22       22                  This module is called from the MCL handler to initiate the
       23       23                  scanning on a circular queue of a handler.
       24       24        */
       25       25
       26       26        KNH$SCAN: PROC (BUF$,ERR) ALTRET;
       27       27
       28       28        /* Include files */
       29       29        %INCLUDE GH_GATE_M;
       30       70        %INCLUDE KN_DATA_M;
       31     1856        %INCLUDE KNH_MACRO_C;
       32     2139        %INCLUDE GU_LCP6_M;
       33     3067        %INCLUDE KN_ERRORS_C;
       34     3131        %INCLUDE GH_LCP6_M;
       35     3965        %INCLUDE G_JIT_M;
       36     4230        %INCLUDE GH_SCHD_E;
       37     4326        %INCLUDE GH_SCHD_M;
PL6.E3A0      #001=KNH$SCAN File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:03 Page:2    
       38     4470        %INCLUDE KI_CP6;
       39     5566        %INCLUDE KL_MACRO_C;
       40     8918        %INCLUDE K_INTERFACE_M;
       41     9327        %INCLUDE K_SCODE_C;
       42     9412
       43     9413        /* Paramters */
       44     9414        %VLP_ERRCODE (FPTN=ERR, STCLASS=PARAM); /* Error on altreturn                 */
       45     9460    1   DCL BUF$ PTR;                           /* Used on the call to KNH$WRITE      */
       46     9461
       47     9462        /* Based structures */
       48     9463        %KN$LDCT (STCLASS="BASED(KN$NETPARM.LDCT$)");
       49     9708        %KNH$QHDR (STCLASS="BASED(G$HAND_Q$)");
       50     9721        %KNH$MESS (STCLASS="BASED(MSG$)");
       51     9770        %FPT_CONNECT (STCLASS="BASED(FPT$)");
       52     9839        %FPT_CONNECT_ACK (STCLASS="BASED(FPT$)");
       53     9888        %FPT_TERM (STCLASS="BASED(FPT$)");
       54     9910        %KN$DCT$;
       55     9913        %KNH$HMI (STCLASS="BASED(HMI$)");
       56     9920        %G$USER (FPTN="G$USER(0:0)",STCLASS="BASED(G$USRT$)");
       57     9931        %G$JIT (STCLASS="BASED(G$JIT$)");
       58    10345
       59    10346        /* Symrefs */
       60    10347        %KN$NETPARM (NAME=KN_NETPARM_INIT,STCLASS=SYMREF);
       61    10500    1   DCL KN_DCT$$ PTR SYMREF;
       62    10501    1   DCL KN_NODE# UBIN SYMREF;
       63    10502    1   DCL G$JIT$ PTR SYMREF READONLY;
       64    10503    1   DCL G$HAND_Q$ PTR SYMREF;
       65    10504    1   DCL G$USRT$ PTR SYMREF;
       66    10505
       67    10506        /* Local storage */
       68    10507        %KN$NETPARM;
       69    10660    1   DCL MSGSZ UBIN;                         /* Size of the message                */
       70    10661    1   DCL MSG$ PTR;
       71    10662    1   DCL FPT$ PTR;
       72    10663    1   DCL SCANSZ SBIN;
       73    10664    1   DCL FPTSIZE SBIN AUTO;
       74    10665    1   DCL ENTRY$ EPTR;
PL6.E3A0      #001=KNH$SCAN File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:03 Page:3    
       75    10666    1   DCL OLD_RPTR UBIN;
       76    10667    1   DCL HMI$ PTR;
       77    10668    1   DCL MYRPTR UBIN;
       78    10669    1   DCL FIRST BIT(1);
       79    10670
       80    10671        /* Entry point refereneces */
       81    10672    1   DCL KNA$GETLDCT ENTRY(1) ALTRET;
       82    10673    1   DCL KNA$RLSLDCT ENTRY(1) ALTRET;
       83    10674    1   DCL KNH$SEND ENTRY(1) ALTRET;
       84    10675    1   DCL KNH$SEND_LOOP ENTRY(1) ALTRET;
       85    10676    1   DCL KNN$RECV ENTRY(1) ALTRET;
       86    10677    1   DCL KNS$SEND ENTRY(1) ALTRET;
       87    10678    1   DCL KNT$RECV_4HOST ENTRY(1) ALTRET;
       88    10679    1   DCL SCREECH ENTRY(1);
       89    10680    1   DCL GHS$RUE ENTRY(4) ALTRET;
       90    10681
       91    10682        /* Error codes */
       92    10683        %VLP_SCODE (FPTN=BADLDCT,ERR#=%S$BADLDCT,SEV=G_SEV_SCREECH#,
       93    10684         STCLASS=CONSTANT,FCG=KN,MID=H,MON='1'B);
       94    10745
       95    10746        /*S* SCREECH_CODE: KNH-S$BADLDCT
       96    10747             TYPE: SCREECH
       97    10748             MESSAGE: Bad LDCT Type Code.
       98    10749        */
       99    10750
      100    10751        %VLP_ERRCODE (FCG=KN,MID=H,MON='1'B,STCLASS=CONSTANT,
      101    10752         FPTN=NOLDCT,ERR#=%E$NOLDCT,SEV=G_SEV_CONT#);
      102    10798        /*E*
      103    10799             ERROR: KNH-E$NOLDCT-G_SEV_CONT#
      104    10800             MESSAGE: No LDCTs available for this connection */
      105    10801        %VLP_ERRCODE (FCG=KN,MID=H,MON='1'B,STCLASS=CONSTANT,
      106    10802         FPTN=BADMFMT,ERR#=%E$BADMFMT,SEV=G_SEV_ABORT#);
      107    10848        /*E*
      108    10849             ERROR: KNH-E$BADMFMT-G_SEV_ABORT#
      109    10850             MESSAGE: Bad message format.
      110    10851             MESSAGE1: The message in the circular queue is invalid.
      111    10852         */
PL6.E3A0      #001=KNH$SCAN File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:03 Page:4    
      112    10853        %VLP_ERRCODE (FCG=KN,MID=H,MON='1'B,STCLASS=CONSTANT,
      113    10854         FPTN=ILLDCT,ERR#=%E$ILLDCT,SEV=G_SEV_ABORT#);
      114    10900        /*E*
      115    10901             ERROR: KNH-E$ILLDCT-G_SEV_ABORT#
      116    10902             MESSAGE: The LDCT specified in the message is invalid */
      117    10903
      118    10904        %VLP_ERRCODE (FCG=KN,MID=H,MON='1'B,STCLASS=CONSTANT,
      119    10905         FPTN=ILGCTYPE,ERR#=%E$ILGCTYPE,SEV=G_SEV_ABORT#);
      120    10951        /*E*
      121    10952             ERROR: KNH-E$ILGCTYPE-G_SEV_ABORT#
      122    10953             MESSAGE: Illegal connection type specified in FPT */
      123    10954
      124    10955        %VLP_ERRCODE (FCG=KN,MID=H,MON='1'B,STCLASS=CONSTANT,
      125    10956         FPTN=BADSCQFMT,ERR#=%E$BADSCQFMT,SEV=G_SEV_ABORT#);
      126    11002        /*E*
      127    11003             ERROR: KNH-E$BADSCQFMT-G_SEV_ABORT#
      128    11004             MESSAGE: The circular queue is invalid */
      129    11005
      130    11006        %VLP_ERRCODE (FCG=KN,MID=H,MON='1'B,STCLASS=CONSTANT,
      131    11007         FPTN=NORTE,ERR#=%E$NORTE,SEV=G_SEV_ERROR#);
      132    11053        /*E*
      133    11054             ERROR: KNH-E$NORTE-G_SEV_ERROR#
      134    11055             MESSAGE: No route available to that destination */
      135    11056        %VLP_ERRCODE (FCG=KN,MID=H,MON='1'B,STCLASS=CONSTANT,
      136    11057         FPTN=CQFUL,ERR#=%E$CQFUL,SEV=G_SEV_CONT#);
      137    11103        /*E*
      138    11104             ERROR: KNH-E$CQFUL-G_SEV_CONT#
      139    11105             MESSAGE: The destination circular queue is full */
      140    11106
      141    11107        %VLP_ERRCODE (FCG=KN,MID=H,MON='1'B,STCLASS=CONSTANT,
      142    11108         FPTN=NORES,ERR#=%E$RESUNDEF,SEV=G_SEV_ERROR#);
      143    11154        /*E*
      144    11155             ERROR: KNH-E$RESUNDEF-G_SEV_ERROR#
      145    11156             MESSAGE: The resource in the FPT is undefined.
      146    11157         */
      147    11158
      148    11159        %VLP_ERRCODE (FCG=KN,MID=H,MON='1'B,STCLASS=CONSTANT,
PL6.E3A0      #001=KNH$SCAN File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:03 Page:5    
      149    11160         FPTN=HMIBUSY,ERR#=%E$HMIBUSY,SEV=G_SEV_CONT#);
      150    11206        /*E*
      151    11207             ERROR: KNH-E$HMIBUSY-G_SEV_CONT#
      152    11208             MESSAGE: The HMI interface is currently busy.
      153    11209             MESSAGE1: Another level is currently using the HMI interface.
      154    11210             DESCRIPTION:
      155    11211                       The HMI context is marked busy which means another
      156    11212                       level is currently doing an MCL on the HMI.
      157    11213         */
      158    11214        %VLP_ERRCODE (FCG=KN,MID=H,MON='1'B,STCLASS=CONSTANT,
      159    11215         FPTN=INVFUN,ERR#=%E$INVFUNCTION,SEV=G_SEV_ABORT#);
      160    11261        /*E*
      161    11262             ERROR: KNH-E$INVFUNCTION-G_SEV_ABORT#
      162    11263             MESSAGE: Invalid function on message.
      163    11264             MESSAGE1: The function on this message is invalid for the current state.
      164    11265         */
      165    11266
      166    11267        %EJECT;
PL6.E3A0      #001=KNH$SCAN File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:03 Page:6    
      167    11268        /* Begin procedure */
      168    11269
      169    11270        /* Find the HMI entry */
      170    11271    1      HMI$ = G$USER.HMI$(G$JIT.USR#);
      171    11272
      172    11273    1      IF HMI$ = ADDR(NIL)
      173    11274    1      THEN
      174    11275    1      RETURN;
      175    11276
      176    11277    1      IF KNH$HMI.SCQ.CLOSING
      177    11278    2      THEN DO;
      178    11279              %LOCK(G=KNH$HMI.RCQ.LOCK);
      179    11286    2         GOTO CLOSING;
      180    11287    2      END;
      181    11288
      182    11289        /* Check to see if the queue pointer are reasonable */
      183    11290           %LOCK (G=KNH$HMI.SCQ.LOCK);
      184    11297    1      IF KNH$HMI.SCQ.BUSY
      185    11298    1      THEN
      186    11299    2      DO ;
      187    11300    2         ERR = HMIBUSY;
      188    11301              %UNLOCK (G=KNH$HMI.SCQ.LOCK);
      189    11308    2         ALTRETURN;
      190    11309    2      END;
      191    11310    1      KNH$HMI.SCQ.BUSY = '1'B;
      192    11311           %UNLOCK (G=KNH$HMI.SCQ.LOCK);
      193    11318
      194    11319        /*   Check if we should scan this time */
      195    11320    1      IF KNH$HMI.SCQ.SCANNED
      196    11321    1        AND KNH$HMI.SCQ.IPTR = KNH$QHDR.SCQ.IPTR
      197    11322    1        AND KNH$HMI.SCQ.RPTR = KNH$QHDR.SCQ.RPTR
      198    11323    1      THEN
      199    11324    2      DO;
      200    11325    2         IF KNH$HMI.SCQ.IPTR~=KNH$HMI.SCQ.RPTR
      201    11326    2         THEN
      202    11327    2         ERR = CQFUL;            /* We didnt empty the CQ, so be sure to ALTRET  */
      203    11328    2         GOTO CHECK_RCQ;
PL6.E3A0      #001=KNH$SCAN File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:03 Page:7    
      204    11329    2      END;
      205    11330
      206    11331    1      KNH$HMI.SCQ.SCANNED = '1'B;
      207    11332    1      KNH$HMI.SCQ.IPTR = KNH$QHDR.SCQ.IPTR;
      208    11333    1      KNH$HMI.SCQ.RPTR = KNH$QHDR.SCQ.RPTR;
      209    11334
      210    11335    1      IF KNH$HMI.SCQ.IPTR >= KNH$HMI.SCQ.SZ OR
      211    11336    1        KNH$HMI.SCQ.RPTR >= KNH$HMI.SCQ.SZ
      212    11337    1      THEN
      213    11338    2      DO ;
      214    11339    2         ERR = BADSCQFMT;
      215    11340    2         KNH$HMI.SCQ.BUSY = '0'B;
      216    11341    2         ALTRETURN;
      217    11342    2      END;
      218    11343
      219    11344
      220    11345        /* Calculate number of word needed to be scanned */
      221    11346    1      SCANSZ = KNH$HMI.SCQ.IPTR - KNH$HMI.SCQ.RPTR;
      222    11347
      223    11348    1      IF SCANSZ < 0                        /* Circualar queue has wrapped        */
      224    11349    1      THEN
      225    11350    1      SCANSZ = SCANSZ + KNH$HMI.SCQ.SZ;
      226    11351    1      IF SCANSZ=0 THEN GOTO CHECK_RCQ;
      227    11352
      228    11353    1      FIRST = '1'B;
      229    11354    1      MYRPTR = KNH$HMI.SCQ.RPTR;
      230    11355    1      MSG$ = PINCRW(G$HAND_Q$,MYRPTR*2+KNH$HMI.SCQ.OFFSET);
      231    11356    1      KNH$MESS.FLAGS.FREE = '0'B;
      232    11357
      233    11358    2      DO WHILE '1'B;
      234    11359
      235    11360    2         FPTSIZE = (KNH$MESS.FPTSZ + 1)/2 ;
      236    11361    2         MSGSZ = (SIZEW(KNH$MESS) + FPTSIZE + (KNH$MESS.MSGSZ + 1)/2 + 1)/2;
      237    11362    2         IF MYRPTR+MSGSZ > KNH$HMI.SCQ.SZ
      238    11363    2         THEN
      239    11364    3         DO ;
      240    11365    3            ERR = BADMFMT;
PL6.E3A0      #001=KNH$SCAN File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:03 Page:8    
      241    11366    3            KNH$HMI.SCQ.BUSY = '0'B;
      242    11367    3            ALTRETURN;
      243    11368    3         END;
      244    11369
      245    11370              %LOCK (G=KNH$HMI.SCQ.LOCK);
      246    11377    2         IF NOT KNH$MESS.FLAGS.FREE AND KNH$MESS.FUNCTION~=%KN_FCN_NOP
      247    11378    2         THEN
      248    11379    2         CALL DO$MSG
      249    11380    3         WHENRETURN DO;
      250    11381    3            KNH$MESS.FLAGS.FREE = '1'B;
      251    11382    3         END;
      252    11383    3         WHENALTRETURN DO ;
      253    11384    3            FIRST = '0'B;
      254    11385    3            IF ERR.ERR# ~= %E$CQFUL
      255    11386    4            THEN DO;
      256    11387    4               KNH$HMI.SCQ.BUSY = '0'B;
      257    11388                    %UNLOCK (G=KNH$HMI.SCQ.LOCK);
      258    11395    4               ALTRETURN;
      259    11396    4            END;
      260    11397    3            IF KN$NETPARM.SLDCT$~=ADDR(NIL)
      261    11398    3            THEN IF KN$NETPARM.SLDCT$->KN$LDCT.CQPTR<0
      262    11399    3            THEN KN$NETPARM.SLDCT$->KN$LDCT.CQPTR = MYRPTR;
      263    11400    3         END;
      264    11401              %UNLOCK (G=KNH$HMI.SCQ.LOCK);
      265    11408    2         MYRPTR = MYRPTR + MSGSZ;
      266    11409    2         IF MYRPTR >= KNH$HMI.SCQ.SZ
      267    11410    2         THEN
      268    11411    3         DO ;
      269    11412    3            MYRPTR = 0;                    /* Must of wrapped                    */
      270    11413    3            IF FIRST
      271    11414    3            THEN
      272    11415    3            KNH$QHDR.WRAP_SCQ = KNH$QHDR.WRAP_SCQ + 1;
      273    11416    3         END;
      274    11417
      275    11418
      276    11419
      277    11420    2         SCANSZ = SCANSZ - MSGSZ;
PL6.E3A0      #001=KNH$SCAN File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:03 Page:9    
      278    11421    2         IF FIRST
      279    11422    3         THEN DO;
      280    11423    3            KNH$HMI.SCQ.RPTR = MYRPTR;
      281    11424    3            KNH$QHDR.SCQ.RPTR = MYRPTR;
      282    11425        /* Do some statistic gathering */
      283    11426    3            KNH$QHDR.MSGS_SCQ = KNH$QHDR.MSGS_SCQ + 1;
      284    11427    3            KNH$QHDR.MBC_SCQ = KNH$QHDR.MBC_SCQ + MSGSZ ;
      285    11428    3         END;
      286    11429
      287    11430    2         IF SCANSZ<=0 THEN EXIT;
      288    11431    2         MSG$ = PINCRW(G$HAND_Q$,MYRPTR*2+KNH$HMI.SCQ.OFFSET);
      289    11432    2      END;                                 /* End of DO WHILE                    */
      290    11433
      291    11434    1      IF SCANSZ < 0                        /* Something is wrong                 */
      292    11435    1      THEN
      293    11436    2      DO ;
      294    11437    2         ERR = BADMFMT;
      295    11438    2         KNH$HMI.SCQ.BUSY = '0'B;
      296    11439    2         ALTRETURN;
      297    11440    2      END;
      298    11441
      299    11442    1      IF KNH$QHDR.CTX.WU AND G$USER.US(G$JIT.USR#)=%GH_W
      300    11443    1        AND KNH$QHDR.SCQ.IPTR=KNH$QHDR.SCQ.RPTR
      301    11444    2      THEN DO;
      302    11445    2         MYRPTR = G$JIT.USR#;
      303    11446    2         CALL GHS$RUE (%GH_EVWU,MYRPTR);
      304    11447    2      END;
      305    11448    1   CHECK_RCQ: ;
      306    11449           %LOCK(G=KNH$HMI.RCQ.LOCK);
      307    11456    1      IF KNH$QHDR.RCQ.RPTR ~= KNH$HMI.RCQ.RPTR /* Took something out             */
      308    11457    1      THEN
      309    11458    2      DO ;
      310    11459    2   CLOSING: ;
      311    11460    3         DO WHILE (KNH$HMI.WAIT_COUNT > 0);
      312    11461    3            KN$NETPARM = KN_NETPARM_INIT;
      313    11462    3            KN$NETPARM.LDCT$ = KNH$HMI.WAIT_HEAD$;
      314    11463    3            KN$NETPARM.FUNCTION = %KN_FCN_UNQ;
PL6.E3A0      #001=KNH$SCAN File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:03 Page:10   
      315    11464    3            KN$LDCT.FLAGS.QUEUED = '0'B;
      316    11465    3            KNH$HMI.WAIT_HEAD$ = KN$LDCT.LNK$;
      317    11466    3            KN$LDCT.LNK$=ADDR(NIL);
      318    11467    3            KNH$HMI.WAIT_COUNT = KNH$HMI.WAIT_COUNT - 1;
      319    11468
      320    11469    3            IF KN$LDCT.USER_ENTRY$~=ENTADDR(NIL)
      321    11470    3            THEN CALL KN$LDCT.USER_ENTRY$(KN$NETPARM);
      322    11471
      323    11472    3            IF KN$LDCT.FLAGS.REL
      324    11473    3            THEN
      325    11474    3            CALL KNA$RLSLDCT (KN$NETPARM.LDCT$);
      326    11475    3         END;
      327    11476
      328    11477    2         KNH$HMI.RCQ.RPTR = KNH$QHDR.RCQ.RPTR;
      329    11478    2      END;
      330    11479           %UNLOCK(G=KNH$HMI.RCQ.LOCK);
      331    11486
      332    11487    1      KNH$HMI.SCQ.BUSY = '0'B;
      333    11488    1      RETURN;
      334    11489
      335    11490        %EJECT;
PL6.E3A0      #001=KNH$SCAN File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:03 Page:11   
      336    11491    1   KNH$WRITE: ENTRY (BUF$,ERR) ALTRET;
      337    11492
      338    11493
      339    11494    1      HMI$ = G$USER.HMI$(G$JIT.USR#);
      340    11495    1      MSG$ = BUF$;
      341    11496    1      FPTSIZE = (KNH$MESS.FPTSZ + 1)/2;
      342    11497    1      MSGSZ = (SIZEW(KNH$MESS) + FPTSIZE +(KNH$MESS.MSGSZ + 1)/2 + 1)/2;
      343    11498    1      MYRPTR = 65535;
      344    11499           %LOCK (G=KNH$HMI.SCQ.LOCK);
      345    11506    1      CALL DO$MSG
      346    11507    2      WHENALTRETURN DO;
      347    11508              %UNLOCK(G=KNH$HMI.SCQ.LOCK);
      348    11515    2         GOTO CHECK_RCQ;
      349    11516    2      END;
      350    11517           %UNLOCK(G=KNH$HMI.SCQ.LOCK);
      351    11524
      352    11525    1      RETURN;
      353    11526        %EJECT;
PL6.E3A0      #001=KNH$SCAN File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:03 Page:12   
      354    11527    1   DO$MSG: PROC ALTRET;
      355    11528
      356    11529    2      KN$NETPARM = KN_NETPARM_INIT;
      357    11530    2      FPT$ = PINCRW(MSG$,SIZEW(KNH$MESS));
      358    11531    2      IF MSGSZ > SIZEW(KNH$MESS)/2         /* Message exists                     */
      359    11532    2      THEN
      360    11533    3      DO ;
      361    11534    3         KN$NETPARM.UHDRSZ = KNH$MESS.MSGSZ;
      362    11535    3         KN$NETPARM.NHDRSZ = KN$NETPARM.UHDRSZ ;
      363    11536    3         KN$NETPARM.UHDR$ = PINCRW(FPT$,FPTSIZE);
      364    11537    3         KN$NETPARM.NHDR$ = KN$NETPARM.UHDR$ ;
      365    11538    3      END;
      366    11539
      367    11540        /* Calculate LDCT$ from the header */
      368    11541    2      KN$NETPARM.RECTYPE = KNH$MESS.RECTYPE;
      369    11542    2      KN$NETPARM.FUNCTION = KNH$MESS.FUNCTION;
      370    11543    2      KN$NETPARM.LDCT$ = KN$DCT$(KNH$MESS.LDCTX);
      371    11544    2      KN$NETPARM.SLDCT$ = KN$NETPARM.LDCT$;
      372    11545
      373    11546    3      IF ADDR(KN$LDCT)~=ADDR(NIL) THEN DO;
      374    11547    3         IF KN$LDCT.CQPTR>=0
      375    11548    3         THEN IF KN$LDCT.CQPTR=MYRPTR AND NOT KN$LDCT.FLAGS.QUEUED
      376    11549    3         THEN KN$LDCT.CQPTR = -1;
      377    11550    4         ELSE DO;
      378    11551    4            ERR=CQFUL ;
      379    11552    4            ALTRETURN ;
      380    11553    4         END ;
      381    11554
      382    11555    3         IF KN$LDCT.USER#~=G$JIT.USR#
      383    11556    3         THEN
      384    11557    3         GOTO ILLDCTERR;
      385    11558
      386    11559    4         DO CASE(KN$LDCT.CONN_TYPE);
      387    11560        /*
      388    11561           Set up ENTRY$ for routine to call if not INIT or LOOP.
      389    11562        */
      390    11563    4         CASE (%KN_CNTYPE_SESS, %KN_CNTYPE_QDP);
PL6.E3A0      #001=KNH$SCAN File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:03 Page:13   
      391    11564    4            ENTRY$ = ENTADDR(KNS$SEND);
      392    11565
      393    11566    4         CASE (%KN_CNTYPE_LINK);
      394    11567    4            ENTRY$ = ENTADDR(KNN$RECV);
      395    11568
      396    11569    4         CASE (%KN_CNTYPE_CIRCUIT);
      397    11570    4            IF KN$NETPARM.FUNCTION = %KN_FCN_TERM
      398    11571    4              OR KN$LDCT.STATE = %KN_ST_OPENING THEN
      399    11572    4            ENTRY$ = ENTADDR(KNN$RECV);
      400    11573    4            ELSE IF KN$LDCT.STATE = %KN_ST_OPEN
      401    11574    5            THEN DO;
      402    11575    5               KN$NETPARM.THDR$ = KN$NETPARM.NHDR$;
      403    11576    5               KN$NETPARM.THDRSZ = KN$NETPARM.NHDRSZ;
      404    11577    5               ENTRY$ = ENTADDR(KNT$RECV_4HOST);
      405    11578    5            END;
      406    11579    4            ELSE
      407    11580    4            GOTO BADLDCTSCR;
      408    11581
      409    11582    4         CASE (ELSE);
      410    11583    4   BADLDCTSCR:;
      411    11584    4            CALL SCREECH(BADLDCT);
      412    11585    4            GOTO ILLDCTERR;
      413    11586
      414    11587    4         END;                              /* End cases                          */
      415    11588    3      END; /* if ADDR(KN$LDCT)~=addr(nil) */
      416    11589    2      ELSE IF KN$NETPARM.FUNCTION~=%KN_FCN_INIT
      417    11590    2        AND KN$NETPARM.FUNCTION~=%KN_FCN_LOOP
      418    11591    2      THEN
      419    11592    3      DO;
      420    11593    3   ILLDCTERR:;
      421    11594    3         ERR = ILLDCT;
      422    11595    3         ALTRETURN;
      423    11596    3      END;
      424    11597
      425    11598
      426    11599    2      IF KN$NETPARM.FUNCTION=%KN_FCN_DATA THEN GOTO DO$DATA;
      427    11600    2      IF FPTSIZE~=0 THEN KN$NETPARM.FPT$ = FPT$;
PL6.E3A0      #001=KNH$SCAN File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:03 Page:14   
      428    11601    3      DO CASE (KN$NETPARM.FUNCTION);
      429    11602    3      CASE (%KN_FCN_INIT);
      430    11603
      431    11604
      432    11605    3         IF KNH$MESS.FPTSZ < SIZEC(FPT_CONNECT)
      433    11606    4         THEN DO;
      434    11607    4            ERR = BADMFMT;
      435    11608    4            ALTRETURN;
      436    11609    4         END;
      437    11610
      438    11611    3         FPT_CONNECT.USER.SYSID = G$JIT.SYSID;
      439    11612        /* Look at the resource in the FPT */
      440    11613    4         DO SELECT (FPT_CONNECT.RESOURCE);
      441    11614
      442    11615    4            SELECT (' ');
      443    11616
      444    11617    4            SELECT ('NETMAN');
      445    11618    4            IF G$JIT.USR# ~= 1
      446    11619    4            THEN
      447    11620    5            DO ;
      448    11621    5               ERR = NORES;
      449    11622    5               ALTRETURN;
      450    11623    5            END;
      451    11624
      452    11625    4            SELECT ('LOGON');
      453    11626    4            FPT_CONNECT.RLCID.NODE = KN_NODE#;
      454    11627
      455    11628    4            SELECT(ELSE);
      456    11629    4         ERR=NORES;
      457    11630    4         ALTRETURN;
      458    11631
      459    11632    4         END;                              /* End DO SELECT                      */
      460    11633
      461    11634        /* Get a LDCT for this new endpoint */
      462    11635    3      IF KN$NETPARM.LDCT$ = ADDR(NIL)
      463    11636    3      THEN
      464    11637    3      CALL KNA$GETLDCT (KN$NETPARM.LDCT$) WHENALTRETURN
PL6.E3A0      #001=KNH$SCAN File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:03 Page:15   
      465    11638    4      DO ;
      466    11639    4         ERR = NOLDCT;
      467    11640    4         ALTRETURN;
      468    11641    4      END;
      469    11642
      470    11643    3      KN$LDCT.UID = KNH$MESS.UID;
      471    11644    3      KN$LDCT.USER# = G$JIT.USR#;
      472    11645    3      KN$LDCT.USER_ENTRY$ = ENTADDR(KNH$SEND);
      473    11646    3      KN$NETPARM.SLDCT$ = KN$NETPARM.LDCT$;
      474    11647    3      KNH$MESS.LDCTX = KN$LDCT.LDCTX;
      475    11648    3      KN$LDCT.CONN_TYPE = FPT_CONNECT.TYPE +1; /*KNH equ to KN equ*/
      476    11649
      477    11650    4      DO CASE (FPT_CONNECT.TYPE);
      478    11651
      479    11652    4      CASE (%KN_CON_TYP_SESS, %KN_CON_TYP_QDP);
      480    11653    4         CALL KNS$SEND(KN$NETPARM) ALTRET(REL_LDCT);
      481    11654
      482    11655    4      CASE (%KN_CON_TYP_LINK, %KN_CON_TYP_CIRCUIT);
      483    11656    4         IF KN$NETPARM.UHDRSZ = 0 THEN /* so network can tell the diff between
      484    11657                                                   connects with nsaps and those without*/
      485    11658    4         KN$NETPARM.UHDR$ = PINCRW(FPT$,FPTSIZE);
      486    11659    4         CALL KNN$RECV(KN$NETPARM) WHENALTRETURN
      487    11660    5         DO ;
      488    11661    5   REL_LDCT: ;
      489    11662    5            IF NOT KN$NETPARM.SLDCT$->KN$LDCT.FLAGS.QUEUED
      490    11663    5            THEN
      491    11664    6            DO;
      492    11665    6               CALL KNA$RLSLDCT(KN$NETPARM.SLDCT$);
      493    11666    6               KNH$MESS.LDCTX = 0;
      494    11667    6            END;
      495    11668    5            GOTO L_ALT;
      496    11669    5         END;
      497    11670
      498    11671    4      CASE (ELSE);
      499    11672    4         CALL KNA$RLSLDCT(KN$NETPARM.LDCT$);
      500    11673    4         ERR = ILGCTYPE;
      501    11674    4         ALTRETURN;
PL6.E3A0      #001=KNH$SCAN File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:03 Page:16   
      502    11675
      503    11676    4      END;                                 /* End cases                          */
      504    11677
      505    11678        %EJECT;
PL6.E3A0      #001=KNH$SCAN File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:03 Page:17   
      506    11679    3      CASE (%KN_FCN_INIT_ACK);
      507    11680
      508    11681    3         KN$LDCT.UID = KNH$MESS.UID;
      509    11682
      510    11683    3         CALL ENTRY$ (KN$NETPARM) ALTRET(L_ALT);
      511    11684
      512    11685        /* Check to see if the acknowledgement was an acceptence */
      513    11686    3         IF FPT_CONNECT_ACK.REASON ~= 0    /* Some error                         */
      514    11687    4         THEN DO;
      515    11688    4            IF KN$NETPARM.LDCT$ ~= ADDR(NIL)
      516    11689    4            THEN CALL KNA$RLSLDCT(KN$NETPARM.LDCT$);
      517    11690    4         END;
      518    11691    3         ELSE
      519    11692    3         KNH$HMI.LDCTS# = KNH$HMI.LDCTS# + 1;
      520    11693
      521    11694
      522    11695
      523    11696        %EJECT;
PL6.E3A0      #001=KNH$SCAN File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:03 Page:18   
      524    11697    3      CASE (%KN_FCN_TERM);
      525    11698    3   DO$DATA:;
      526    11699    3         CALL ENTRY$ (KN$NETPARM) ALTRET(L_ALT);
      527    11700    3         RETURN;
      528    11701
      529    11702        %EJECT;
PL6.E3A0      #001=KNH$SCAN File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:03 Page:19   
      530    11703    3      CASE (%KN_FCN_TERM_ACK);
      531    11704    3         CALL ENTRY$ (KN$NETPARM) WHENALTRETURN
      532    11705    4         DO ;
      533    11706    4   L_ALT:   ;
      534    11707    4            IF KN$NETPARM.ERRCODE = %KN_ERR_INVFCN
      535    11708    4            THEN
      536    11709    4            ERR = INVFUN;
      537    11710    4            ELSE
      538    11711    4            ERR = CQFUL;
      539    11712    4            ALTRETURN;
      540    11713    4         END;
      541    11714
      542    11715        /* Release the LDCT */
      543    11716    3         CALL KNA$RLSLDCT (KN$NETPARM.LDCT$);
      544    11717    3         KNH$HMI.LDCTS# = KNH$HMI.LDCTS# - 1;
      545    11718
      546    11719        %EJECT;
PL6.E3A0      #001=KNH$SCAN File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:03 Page:20   
      547    11720    3      CASE (%KN_FCN_LOOP);
      548    11721    3         KN$NETPARM.FUNCTION = %KN_FCN_DATA;
      549    11722    3         KN$NETPARM.LDCT$ = ADDR(KNH$MESS);
      550    11723    3         CALL KNH$SEND_LOOP (KN$NETPARM)
      551    11724    4         WHENALTRETURN DO;
      552    11725    4            ERR = CQFUL;
      553    11726    4            ALTRETURN;
      554    11727    4         END;
      555    11728
      556    11729        %EJECT;
PL6.E3A0      #001=KNH$SCAN File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:03 Page:21   
      557    11730    3      CASE(%KN_FCN_BLOCK,%KN_FCN_UNBLOCK);
      558    11731        /*
      559    11732             a block message from the link(specifically hdlc) layer.  Indicates
      560    11733             that this path is blocked and should be rerouted, if possible.
      561    11734        */
      562    11735        /*
      563    11736             an unblock message from the link layer(specifically hdlc).  Indicates that this
      564    11737             path is now unblocked.
      565    11738        */
      566    11739    3         IF KN$LDCT.CONN_TYPE~=%KN_CNTYPE_CIRCUIT /* can't unblock class A       */
      567    11740    3         THEN CALL ENTRY$(KN$NETPARM);
      568    11741         /* doesn't altet */
      569    11742
      570    11743    3      CASE(%KN_FCN_RESET);
      571    11744        /*
      572    11745             a reset function was indicated on a link line.  convert function to osi
      573    11746        */
      574    11747    3         KN$NETPARM.FUNCTION = %K_NRESET_IND;
      575    11748    3         CALL KNT$RECV_4HOST(KN$NETPARM);
      576    11749
      577    11750    3      CASE(%KN_FCN_EXPEDITED_DATA,%KN_FCN_EXPEDITED_DATA_ACK,%KN_FCN_EXPEDITED_DATA_NAK
             11750               );
      578    11751    3         CALL SCREECH (BADMFMT);
      579    11752
      580    11753        %EJECT;
PL6.E3A0      #001=KNH$SCAN File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:03 Page:22   
      581    11754    3      CASE (ELSE);
      582    11755    3         ERR = BADMFMT;
      583    11756    3         ALTRETURN;
      584    11757
      585    11758    3      END;                                 /* End cases                          */
      586    11759
      587    11760    2   END DO$MSG;
      588    11761
      589    11762    1   END KNH$SCAN;
      590    11763        %EOD;

PL6.E3A0      #001=KNH$SCAN File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:03 Page:23   
--  Include file information  --

   K_SCODE_C.:E05TOU  is referenced.
   K_INTERFACE_M.:E05TOU  is referenced.
   KL_MACRO_C.:E05TOU  is referenced.
   KI_CP6.:E05TOU  is referenced.
   GH_SCHD_M.:E05TOU  is referenced.
   GH_SCHD_E.:E05TOU  is referenced.
   G_JIT_M.:E05TOU  is referenced.
   GH_LCP6_M.:E05TOU  is referenced.
   KN_ERRORS_C.:E05TOU  is referenced.
   GU_LCP6_M.:E05TOU  is referenced.
   KNH_MACRO_C.:E05TOU  is referenced.
   KN_DATA_M.:E05TOU  is referenced.
   GH_GATE_M.:E05TOU  cannot be made into a system file and is referenced.
      No diagnostics issued in procedure KNH$SCAN.

   Procedure KNH$SCAN requires 1404 words for executable code.
   Procedure KNH$SCAN requires 62 words of local(AUTO) storage.

PL6.E3A0      #001=KNH$SCAN File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:03 Page:24   

 Object Unit name= KNH$SCAN                                   File name= KNH$HMI.:E05TOU
 UTS= JUL 30 '97 01:03:14.60 WED                              Compiler= PL-6/E31         Sev=      00
 SharedLib= :SHARED_LCP6_SYSTEM                               Alt SharedLib=


    ****  Control sections  ****

 Sect   Type Bound  Init  Size HexSiz  Section name
    0  RoData even  UTS     29     1D  KNH$SCAN
    1   Proc  even  none  1404    57C  KNH$SCAN
    2  RoData even  none     7      7  KNH$SCAN

    ****  Entry defs  ****

                              Check   Calling
                             calling  sequence
  Sect HexLoc Primary Altret sequence   type   Parms  Name
     1      0   yes    yes     yes      Std        2  KNH$SCAN
     1    25A          yes     yes      Std        2  KNH$WRITE
PL6.E3A0      #001=KNH$SCAN File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:03 Page:25   

  ****  Entry refs  ****

         Check        Calling
        calling       sequence
Altret sequence SRef   type   Args  Name
 yes     yes           Std       1 GHH$LOCK
 yes     yes           Std       1 GHH$UNLOCK
 yes     yes           Std       4 GHS$RUE
 yes     yes           Std       1 KNA$RLSLDCT
 yes     yes           Std       1 KNS$SEND
 yes     yes           Std       1 KNN$RECV
 yes     yes           Std       1 KNT$RECV_4HOST
         yes           Std       1 SCREECH
 yes     yes           Std       1 KNH$SEND
 yes     yes           Std       1 KNA$GETLDCT
 yes     yes           Std       1 KNH$SEND_LOOP
                       nStd      0 X6A_AUTO_2
                       nStd      0 X6A_ARET
                       nStd      0 X6A_AALT

  ****  Data refs  ****

  Flags:  r = read only, s = secondary
Flgs Name                             Flgs Name                             Flgs Name
     KN_NETPARM_INIT                       KN_DCT$$                              KN_NODE#
r    G$JIT$                                G$HAND_Q$                             G$USRT$
r    G$ROS$
PL6.E3A0      #001=KNH$SCAN File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:03 Page:26   


        1        1        /*M* KNH$HMI - Handler Monitor Inteface module */
        2        2        /*T***********************************************************/
        3        3        /*T*                                                         */
        4        4        /*T* Copyright (c) Bull HN Information Systems Inc., 1997    */
        5        5        /*T*                                                         */
        6        6        /*T***********************************************************/
        7        7        /*X*     NSO,PLM=3,SQB=Y,AND=Y,ENI=0,SDI=3,MCL=10,CSI=0,ECI=0,IAD=3,IND=0 */
        8        8        /*P*
        9        9             NAME: KNH$HMI
       10       10             PURPOSE:
       11       11                  This module contains the routines that make up the
       12       12                  Handler monitor interface.
       13       13             DESCRIPTION:
       14       14                  None.
       15       15        */
       16       16
       17       17        /*F*
       18       18             NAME: KNH$SCAN
       19       19             PURPOSE:
       20       20                  To scan the send circular queue for the handler.
       21       21             DESCRIPTION:
       22       22                  This module is called from the MCL handler to initiate the
       23       23                  scanning on a circular queue of a handler.
       24       24        */
       25       25
       26       26        KNH$SCAN: PROC (BUF$,ERR) ALTRET;

     26   1 000000  D380 0000 0000  xent KNH$SCAN        LNJ,B5   X6A_AUTO_2
          1 000003       003E 0002                       DC       62,2

       27       27
       28       28        /* Include files */
       29       29        %INCLUDE GH_GATE_M;
       30       70        %INCLUDE KN_DATA_M;
       31     1856        %INCLUDE KNH_MACRO_C;
       32     2139        %INCLUDE GU_LCP6_M;
PL6.E3A0      #001=KNH$SCAN File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:03 Page:27   
       33     3067        %INCLUDE KN_ERRORS_C;
       34     3131        %INCLUDE GH_LCP6_M;
       35     3965        %INCLUDE G_JIT_M;
       36     4230        %INCLUDE GH_SCHD_E;
       37     4326        %INCLUDE GH_SCHD_M;
       38     4470        %INCLUDE KI_CP6;
       39     5566        %INCLUDE KL_MACRO_C;
       40     8918        %INCLUDE K_INTERFACE_M;
       41     9327        %INCLUDE K_SCODE_C;
       42     9412
       43     9413        /* Paramters */
       44     9414        %VLP_ERRCODE (FPTN=ERR, STCLASS=PARAM); /* Error on altreturn                 */
       45     9460    1   DCL BUF$ PTR;                           /* Used on the call to KNH$WRITE      */
       46     9461
       47     9462        /* Based structures */
       48     9463        %KN$LDCT (STCLASS="BASED(KN$NETPARM.LDCT$)");
       49     9708        %KNH$QHDR (STCLASS="BASED(G$HAND_Q$)");
       50     9721        %KNH$MESS (STCLASS="BASED(MSG$)");
       51     9770        %FPT_CONNECT (STCLASS="BASED(FPT$)");
       52     9839        %FPT_CONNECT_ACK (STCLASS="BASED(FPT$)");
       53     9888        %FPT_TERM (STCLASS="BASED(FPT$)");
       54     9910        %KN$DCT$;
       55     9913        %KNH$HMI (STCLASS="BASED(HMI$)");
       56     9920        %G$USER (FPTN="G$USER(0:0)",STCLASS="BASED(G$USRT$)");
       57     9931        %G$JIT (STCLASS="BASED(G$JIT$)");
       58    10345
       59    10346        /* Symrefs */
       60    10347        %KN$NETPARM (NAME=KN_NETPARM_INIT,STCLASS=SYMREF);
       61    10500    1   DCL KN_DCT$$ PTR SYMREF;
       62    10501    1   DCL KN_NODE# UBIN SYMREF;
       63    10502    1   DCL G$JIT$ PTR SYMREF READONLY;
       64    10503    1   DCL G$HAND_Q$ PTR SYMREF;
       65    10504    1   DCL G$USRT$ PTR SYMREF;
       66    10505
       67    10506        /* Local storage */
       68    10507        %KN$NETPARM;
       69    10660    1   DCL MSGSZ UBIN;                         /* Size of the message                */
PL6.E3A0      #001=KNH$SCAN File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:03 Page:28   
       70    10661    1   DCL MSG$ PTR;
       71    10662    1   DCL FPT$ PTR;
       72    10663    1   DCL SCANSZ SBIN;
       73    10664    1   DCL FPTSIZE SBIN AUTO;
       74    10665    1   DCL ENTRY$ EPTR;
       75    10666    1   DCL OLD_RPTR UBIN;
       76    10667    1   DCL HMI$ PTR;
       77    10668    1   DCL MYRPTR UBIN;
       78    10669    1   DCL FIRST BIT(1);
       79    10670
       80    10671        /* Entry point refereneces */
       81    10672    1   DCL KNA$GETLDCT ENTRY(1) ALTRET;
       82    10673    1   DCL KNA$RLSLDCT ENTRY(1) ALTRET;
       83    10674    1   DCL KNH$SEND ENTRY(1) ALTRET;
       84    10675    1   DCL KNH$SEND_LOOP ENTRY(1) ALTRET;
       85    10676    1   DCL KNN$RECV ENTRY(1) ALTRET;
       86    10677    1   DCL KNS$SEND ENTRY(1) ALTRET;
       87    10678    1   DCL KNT$RECV_4HOST ENTRY(1) ALTRET;
       88    10679    1   DCL SCREECH ENTRY(1);
       89    10680    1   DCL GHS$RUE ENTRY(4) ALTRET;
       90    10681
       91    10682        /* Error codes */
       92    10683        %VLP_SCODE (FPTN=BADLDCT,ERR#=%S$BADLDCT,SEV=G_SEV_SCREECH#,
       93    10684         STCLASS=CONSTANT,FCG=KN,MID=H,MON='1'B);
       94    10745
       95    10746        /*S* SCREECH_CODE: KNH-S$BADLDCT
       96    10747             TYPE: SCREECH
       97    10748             MESSAGE: Bad LDCT Type Code.
       98    10749        */
       99    10750
      100    10751        %VLP_ERRCODE (FCG=KN,MID=H,MON='1'B,STCLASS=CONSTANT,
      101    10752         FPTN=NOLDCT,ERR#=%E$NOLDCT,SEV=G_SEV_CONT#);
      102    10798        /*E*
      103    10799             ERROR: KNH-E$NOLDCT-G_SEV_CONT#
      104    10800             MESSAGE: No LDCTs available for this connection */
      105    10801        %VLP_ERRCODE (FCG=KN,MID=H,MON='1'B,STCLASS=CONSTANT,
      106    10802         FPTN=BADMFMT,ERR#=%E$BADMFMT,SEV=G_SEV_ABORT#);
PL6.E3A0      #001=KNH$SCAN File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:03 Page:29   
      107    10848        /*E*
      108    10849             ERROR: KNH-E$BADMFMT-G_SEV_ABORT#
      109    10850             MESSAGE: Bad message format.
      110    10851             MESSAGE1: The message in the circular queue is invalid.
      111    10852         */
      112    10853        %VLP_ERRCODE (FCG=KN,MID=H,MON='1'B,STCLASS=CONSTANT,
      113    10854         FPTN=ILLDCT,ERR#=%E$ILLDCT,SEV=G_SEV_ABORT#);
      114    10900        /*E*
      115    10901             ERROR: KNH-E$ILLDCT-G_SEV_ABORT#
      116    10902             MESSAGE: The LDCT specified in the message is invalid */
      117    10903
      118    10904        %VLP_ERRCODE (FCG=KN,MID=H,MON='1'B,STCLASS=CONSTANT,
      119    10905         FPTN=ILGCTYPE,ERR#=%E$ILGCTYPE,SEV=G_SEV_ABORT#);
      120    10951        /*E*
      121    10952             ERROR: KNH-E$ILGCTYPE-G_SEV_ABORT#
      122    10953             MESSAGE: Illegal connection type specified in FPT */
      123    10954
      124    10955        %VLP_ERRCODE (FCG=KN,MID=H,MON='1'B,STCLASS=CONSTANT,
      125    10956         FPTN=BADSCQFMT,ERR#=%E$BADSCQFMT,SEV=G_SEV_ABORT#);
      126    11002        /*E*
      127    11003             ERROR: KNH-E$BADSCQFMT-G_SEV_ABORT#
      128    11004             MESSAGE: The circular queue is invalid */
      129    11005
      130    11006        %VLP_ERRCODE (FCG=KN,MID=H,MON='1'B,STCLASS=CONSTANT,
      131    11007         FPTN=NORTE,ERR#=%E$NORTE,SEV=G_SEV_ERROR#);
      132    11053        /*E*
      133    11054             ERROR: KNH-E$NORTE-G_SEV_ERROR#
      134    11055             MESSAGE: No route available to that destination */
      135    11056        %VLP_ERRCODE (FCG=KN,MID=H,MON='1'B,STCLASS=CONSTANT,
      136    11057         FPTN=CQFUL,ERR#=%E$CQFUL,SEV=G_SEV_CONT#);
      137    11103        /*E*
      138    11104             ERROR: KNH-E$CQFUL-G_SEV_CONT#
      139    11105             MESSAGE: The destination circular queue is full */
      140    11106
      141    11107        %VLP_ERRCODE (FCG=KN,MID=H,MON='1'B,STCLASS=CONSTANT,
      142    11108         FPTN=NORES,ERR#=%E$RESUNDEF,SEV=G_SEV_ERROR#);
      143    11154        /*E*
PL6.E3A0      #001=KNH$SCAN File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:03 Page:30   
      144    11155             ERROR: KNH-E$RESUNDEF-G_SEV_ERROR#
      145    11156             MESSAGE: The resource in the FPT is undefined.
      146    11157         */
      147    11158
      148    11159        %VLP_ERRCODE (FCG=KN,MID=H,MON='1'B,STCLASS=CONSTANT,
      149    11160         FPTN=HMIBUSY,ERR#=%E$HMIBUSY,SEV=G_SEV_CONT#);
      150    11206        /*E*
      151    11207             ERROR: KNH-E$HMIBUSY-G_SEV_CONT#
      152    11208             MESSAGE: The HMI interface is currently busy.
      153    11209             MESSAGE1: Another level is currently using the HMI interface.
      154    11210             DESCRIPTION:
      155    11211                       The HMI context is marked busy which means another
      156    11212                       level is currently doing an MCL on the HMI.
      157    11213         */
      158    11214        %VLP_ERRCODE (FCG=KN,MID=H,MON='1'B,STCLASS=CONSTANT,
      159    11215         FPTN=INVFUN,ERR#=%E$INVFUNCTION,SEV=G_SEV_ABORT#);
      160    11261        /*E*
      161    11262             ERROR: KNH-E$INVFUNCTION-G_SEV_ABORT#
      162    11263             MESSAGE: Invalid function on message.
      163    11264             MESSAGE1: The function on this message is invalid for the current state.
      164    11265         */
      165    11266
      166    11267        %EJECT;
PL6.E3A0      #001=KNH$SCAN File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:03 Page:31   
      167    11268        /* Begin procedure */
      168    11269
      169    11270        /* Find the HMI entry */
      170    11271    1      HMI$ = G$USER.HMI$(G$JIT.USR#);

  11271   1 000005  EC80 0000 0000  xsym                 LDB,B6   G$JIT$
          1 000008  B846 0004                            LDR,R3   4,B6
          1 00000A  B570 00FF                            AND,R3   255,IMO
          1 00000C  DC80 0000 0000  xsym                 LDB,B5   G$USRT$
          1 00000F  3F0C                                 MLV,R3   12
          1 000010  3E0A                                 ADV,R3   10
          1 000011  CCB5                                 LDB,B4   ,B5,R3
          1 000012  CFC7 0033                            STB,B4   HMI$,AUTO

      171    11272
      172    11273    1      IF HMI$ = ADDR(NIL)

  11273   1 000014  8DC7 0033                            CMN      HMI$,AUTO
          1 000016  0981 0004                            BNE      s:11277,PREL

      173    11274    1      THEN
      174    11275    1      RETURN;

  11275   1 000018  C380 0000 0000  xent                 LNJ,B4   X6A_ARET

      175    11276
      176    11277    1      IF KNH$HMI.SCQ.CLOSING

  11277   1 00001B  82C4 000E                            LB,'0001'X        14,B4
  11277   1 00001D       0001
          1 00001E  0581 000F                            BBF      s:11295,PREL

      177    11278    2      THEN DO;

      178    11279              %LOCK(G=KNH$HMI.RCQ.LOCK);

  11284   1 000020  BBC4 0004                            LAB,B3   4,B4
PL6.E3A0      #001=KNH$SCAN File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:03 Page:32   
          1 000022  BFC7 003A                            STB,B3   FIRST+4,AUTO
          1 000024  BBC7 003A                            LAB,B3   FIRST+4,AUTO
          1 000026  CBF0 0100                            LAB,B4   256,IMO
          1 000028  E380 0000 0000  xent                 LNJ,B6   GHH$LOCK
          1 00002B       0001                            DC       s:11286,PREL

      179    11286    2         GOTO CLOSING;

  11286   1 00002C  0F81 01BD                            B        s:11458,PREL

      180    11287    2      END;
      181    11288
      182    11289        /* Check to see if the queue pointer are reasonable */
      183    11290           %LOCK (G=KNH$HMI.SCQ.LOCK);

  11295   1 00002E  BBC4 000B                            LAB,B3   11,B4
          1 000030  BFC7 003A                            STB,B3   FIRST+4,AUTO
          1 000032  BBC7 003A                            LAB,B3   FIRST+4,AUTO
          1 000034  CBF0 0100                            LAB,B4   256,IMO
          1 000036  E380 0000 0000  xent                 LNJ,B6   GHH$LOCK
          1 000039       0001                            DC       s:11297,PREL

      184    11297    1      IF KNH$HMI.SCQ.BUSY

  11297   1 00003A  ECC7 0033                            LDB,B6   HMI$,AUTO
          1 00003C  89C6 000E                            CMZ      14,B6
          1 00003E  0881 0016                            BAGE     s:11310,PREL

      185    11298    1      THEN
      186    11299    2      DO ;

      187    11300    2         ERR = HMIBUSY;

  11300   1 000040  8C80 0000 0013  00                   LDI      HMIBUSY
          1 000043  DCC7 0006                            LDB,B5   @ERR,AUTO
          1 000045  8D05                                 SDI      ,B5

PL6.E3A0      #001=KNH$SCAN File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:03 Page:33   
      188    11301              %UNLOCK (G=KNH$HMI.SCQ.LOCK);

  11306   1 000046  CBC6 000B                            LAB,B4   11,B6
          1 000048  CFC7 003A                            STB,B4   FIRST+4,AUTO
          1 00004A  BBC7 003A                            LAB,B3   FIRST+4,AUTO
          1 00004C  CBF0 0100                            LAB,B4   256,IMO
          1 00004E  E380 0000 0000  xent                 LNJ,B6   GHH$UNLOCK
          1 000051       0001                            DC       s:11308,PREL

      189    11308    2         ALTRETURN;

  11308   1 000052  C380 0000 0000  xent                 LNJ,B4   X6A_AALT

      190    11309    2      END;
      191    11310    1      KNH$HMI.SCQ.BUSY = '1'B;

  11310   1 000055  8946 000E                            LBT,'8000'X       14,B6
  11310   1 000057       8000

      192    11311           %UNLOCK (G=KNH$HMI.SCQ.LOCK);

  11316   1 000058  DBC6 000B                            LAB,B5   11,B6
          1 00005A  DFC7 003A                            STB,B5   FIRST+4,AUTO
          1 00005C  BBC7 003A                            LAB,B3   FIRST+4,AUTO
          1 00005E  CBF0 0100                            LAB,B4   256,IMO
          1 000060  E380 0000 0000  xent                 LNJ,B6   GHH$UNLOCK
          1 000063       0001                            DC       s:11320,PREL

      193    11318
      194    11319        /*   Check if we should scan this time */
      195    11320    1      IF KNH$HMI.SCQ.SCANNED

  11320   1 000064  ECC7 0033                            LDB,B6   HMI$,AUTO
          1 000066  82C6 000E                            LB,'4000'X        14,B6
          1 000068       4000
          1 000069  0581 001B                            BBF      s:11331,PREL
          1 00006B  DC80 0000 0000  xsym                 LDB,B5   G$HAND_Q$
PL6.E3A0      #001=KNH$SCAN File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:03 Page:34   
          1 00006E  E846 0007                            LDR,R6   7,B6
          1 000070  E945 0004                            CMR,R6   4,B5
          1 000072  0981 0012                            BNE      s:11331,PREL
          1 000074  D846 0008                            LDR,R5   8,B6
          1 000076  D945 0005                            CMR,R5   5,B5
          1 000078  0981 000C                            BNE      s:11331,PREL

      196    11321    1        AND KNH$HMI.SCQ.IPTR = KNH$QHDR.SCQ.IPTR
      197    11322    1        AND KNH$HMI.SCQ.RPTR = KNH$QHDR.SCQ.RPTR
      198    11323    1      THEN
      199    11324    2      DO;

      200    11325    2         IF KNH$HMI.SCQ.IPTR~=KNH$HMI.SCQ.RPTR

  11325   1 00007A  E955                                 CMR,R6   R5
          1 00007B  0901 0007                            BE       s:11328,PREL

      201    11326    2         THEN
      202    11327    2         ERR = CQFUL;            /* We didnt empty the CQ, so be sure to ALTRET  */

  11327   1 00007D  8C80 0000 000F  00                   LDI      CQFUL
          1 000080  CCC7 0006                            LDB,B4   @ERR,AUTO
          1 000082  8D04                                 SDI      ,B4

      203    11328    2         GOTO CHECK_RCQ;

  11328   1 000083  0F81 014D                            B        s:11447,PREL

      204    11329    2      END;
      205    11330
      206    11331    1      KNH$HMI.SCQ.SCANNED = '1'B;

  11331   1 000085  8946 000E                            LBT,'4000'X       14,B6
  11331   1 000087       4000

      207    11332    1      KNH$HMI.SCQ.IPTR = KNH$QHDR.SCQ.IPTR;

PL6.E3A0      #001=KNH$SCAN File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:03 Page:35   
  11332   1 000088  DC80 0000 0000  xsym                 LDB,B5   G$HAND_Q$
          1 00008B  E845 0004                            LDR,R6   4,B5
          1 00008D  EF46 0007                            STR,R6   7,B6

      208    11333    1      KNH$HMI.SCQ.RPTR = KNH$QHDR.SCQ.RPTR;

  11333   1 00008F  D845 0005                            LDR,R5   5,B5
          1 000091  DF46 0008                            STR,R5   8,B6

      209    11334
      210    11335    1      IF KNH$HMI.SCQ.IPTR >= KNH$HMI.SCQ.SZ OR

  11335   1 000093  E946 0009                            CMR,R6   9,B6
          1 000095  0281 0005                            BGE      s:11339,PREL
          1 000097  D946 0009                            CMR,R5   9,B6
          1 000099  0201 000D                            BL       s:11346,PREL

      211    11336    1        KNH$HMI.SCQ.RPTR >= KNH$HMI.SCQ.SZ
      212    11337    1      THEN
      213    11338    2      DO ;

      214    11339    2         ERR = BADSCQFMT;

  11339   1 00009B  8C80 0000 000B  00                   LDI      BADSCQFMT
          1 00009E  CCC7 0006                            LDB,B4   @ERR,AUTO
          1 0000A0  8D04                                 SDI      ,B4

      215    11340    2         KNH$HMI.SCQ.BUSY = '0'B;

  11340   1 0000A1  8846 000E                            LBF,'8000'X       14,B6
  11340   1 0000A3       8000

      216    11341    2         ALTRETURN;

  11341   1 0000A4  C380 0000 0000  xent                 LNJ,B4   X6A_AALT

      217    11342    2      END;
PL6.E3A0      #001=KNH$SCAN File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:03 Page:36   
      218    11343
      219    11344
      220    11345        /* Calculate number of word needed to be scanned */
      221    11346    1      SCANSZ = KNH$HMI.SCQ.IPTR - KNH$HMI.SCQ.RPTR;

  11346   1 0000A7  E255                                 SUB,R6   R5
          1 0000A8  EF47 002E                            STR,R6   SCANSZ,AUTO

      222    11347
      223    11348    1      IF SCANSZ < 0                        /* Circualar queue has wrapped        */

  11348   1 0000AA  6881 0005                            BGEZ,R6  s:11351,PREL

      224    11349    1      THEN
      225    11350    1      SCANSZ = SCANSZ + KNH$HMI.SCQ.SZ;

  11350   1 0000AC  EA46 0009                            ADD,R6   9,B6
          1 0000AE  EF47 002E                            STR,R6   SCANSZ,AUTO

      226    11351    1      IF SCANSZ=0 THEN GOTO CHECK_RCQ;

  11351   1 0000B0  6901 0120                            BEZ,R6   s:11447,PREL

      227    11352
      228    11353    1      FIRST = '1'B;

  11353   1 0000B2  8947 0036                            LBT,'8000'X       FIRST,AUTO
  11353   1 0000B4       8000

      229    11354    1      MYRPTR = KNH$HMI.SCQ.RPTR;

  11354   1 0000B5  DF47 0035                            STR,R5   MYRPTR,AUTO

      230    11355    1      MSG$ = PINCRW(G$HAND_Q$,MYRPTR*2+KNH$HMI.SCQ.OFFSET);

  11355   1 0000B7  5001                                 SOL,R5   1
          1 0000B8  DA46 000A                            ADD,R5   10,B6
PL6.E3A0      #001=KNH$SCAN File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:03 Page:37   
          1 0000BA  F855                                 LDR,R7   R5
          1 0000BB  6C00                                 LDV,R6   0
          1 0000BC  8400 0000 0000  xsym                 AID      G$HAND_Q$
          1 0000BF  8D47 002A                            SDI      MSG$,AUTO

      231    11356    1      KNH$MESS.FLAGS.FREE = '0'B;

  11356   1 0000C1  CCC7 002A                            LDB,B4   MSG$,AUTO
          1 0000C3  8804                                 LBF,'8000'X       ,B4
          1 0000C4       8000

      232    11357
      233    11358    2      DO WHILE '1'B;

      234    11359
      235    11360    2         FPTSIZE = (KNH$MESS.FPTSZ + 1)/2 ;

  11360   1 0000C5  ECC7 002A                            LDB,B6   MSG$,AUTO
          1 0000C7  E846 0006                            LDR,R6   6,B6
          1 0000C9  6E01                                 ADV,R6   1
          1 0000CA  6041                                 SOR,R6   1
          1 0000CB  EF47 002F                            STR,R6   FPTSIZE,AUTO

      236    11361    2         MSGSZ = (SIZEW(KNH$MESS) + FPTSIZE + (KNH$MESS.MSGSZ + 1)/2 + 1)/2;

  11361   1 0000CD  D846 0007                            LDR,R5   7,B6
          1 0000CF  5E01                                 ADV,R5   1
          1 0000D0  5041                                 SOR,R5   1
          1 0000D1  DA56                                 ADD,R5   R6
          1 0000D2  5E09                                 ADV,R5   9
          1 0000D3  D370 0002                            DIV,R5   2,IMO
          1 0000D5  DF47 0029                            STR,R5   MSGSZ,AUTO

      237    11362    2         IF MYRPTR+MSGSZ > KNH$HMI.SCQ.SZ

  11362   1 0000D7  DA47 0035                            ADD,R5   MYRPTR,AUTO
          1 0000D9  DCC7 0033                            LDB,B5   HMI$,AUTO
PL6.E3A0      #001=KNH$SCAN File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:03 Page:38   
          1 0000DB  D945 0009                            CMR,R5   9,B5
          1 0000DD  0381 000D                            BLE      s:11375,PREL

      238    11363    2         THEN
      239    11364    3         DO ;

      240    11365    3            ERR = BADMFMT;

  11365   1 0000DF  8C80 0000 0005  00                   LDI      BADMFMT
          1 0000E2  CCC7 0006                            LDB,B4   @ERR,AUTO
          1 0000E4  8D04                                 SDI      ,B4

      241    11366    3            KNH$HMI.SCQ.BUSY = '0'B;

  11366   1 0000E5  8845 000E                            LBF,'8000'X       14,B5
  11366   1 0000E7       8000

      242    11367    3            ALTRETURN;

  11367   1 0000E8  C380 0000 0000  xent                 LNJ,B4   X6A_AALT

      243    11368    3         END;
      244    11369
      245    11370              %LOCK (G=KNH$HMI.SCQ.LOCK);

  11375   1 0000EB  CBC5 000B                            LAB,B4   11,B5
          1 0000ED  CFC7 003A                            STB,B4   FIRST+4,AUTO
          1 0000EF  BBC7 003A                            LAB,B3   FIRST+4,AUTO
          1 0000F1  CBF0 0100                            LAB,B4   256,IMO
          1 0000F3  E380 0000 0000  xent                 LNJ,B6   GHH$LOCK
          1 0000F6       0001                            DC       s:11377,PREL

      246    11377    2         IF NOT KNH$MESS.FLAGS.FREE AND KNH$MESS.FUNCTION~=%KN_FCN_NOP

  11377   1 0000F7  ECC7 002A                            LDB,B6   MSG$,AUTO
          1 0000F9  8986                                 CMZ      ,B6
          1 0000FA  0801 003B                            BAL      s:11406,PREL
PL6.E3A0      #001=KNH$SCAN File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:03 Page:39   
          1 0000FC  E806                                 LDR,R6   ,B6
          1 0000FD  6D06                                 CMV,R6   6
          1 0000FE  0901 0037                            BE       s:11406,PREL

      247    11378    2         THEN
      248    11379    2         CALL DO$MSG

  11379   1 000100  E3C0 01B7                            LNJ,B6   s:0,PREL
          1 000102       0007                            DC       s:11384,PREL

      249    11380    3         WHENRETURN DO;

      250    11381    3            KNH$MESS.FLAGS.FREE = '1'B;

  11381   1 000103  ECC7 002A                            LDB,B6   MSG$,AUTO
          1 000105  8906                                 LBT,'8000'X       ,B6
          1 000106       8000

      251    11382    3         END;

  11382   1 000107  0F81 002E                            B        s:11406,PREL

      252    11383    3         WHENALTRETURN DO ;

      253    11384    3            FIRST = '0'B;

  11384   1 000109  8747 0036                            CL       FIRST,AUTO

      254    11385    3            IF ERR.ERR# ~= %E$CQFUL

  11385   1 00010B  ECC7 0006                            LDB,B6   @ERR,AUTO
          1 00010D  E846 0001                            LDR,R6   1,B6
          1 00010F  6043                                 SOR,R6   3
          1 000110  E970 04DF                            CMR,R6   1247,IMO
          1 000112  0901 0015                            BE       s:11397,PREL

      255    11386    4            THEN DO;
PL6.E3A0      #001=KNH$SCAN File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:03 Page:40   

      256    11387    4               KNH$HMI.SCQ.BUSY = '0'B;

  11387   1 000114  DCC7 0033                            LDB,B5   HMI$,AUTO
          1 000116  8845 000E                            LBF,'8000'X       14,B5
          1 000118       8000

      257    11388                    %UNLOCK (G=KNH$HMI.SCQ.LOCK);

  11393   1 000119  CBC5 000B                            LAB,B4   11,B5
          1 00011B  CFC7 003A                            STB,B4   FIRST+4,AUTO
          1 00011D  BBC7 003A                            LAB,B3   FIRST+4,AUTO
          1 00011F  CBF0 0100                            LAB,B4   256,IMO
          1 000121  E380 0000 0000  xent                 LNJ,B6   GHH$UNLOCK
          1 000124       0001                            DC       s:11395,PREL

      258    11395    4               ALTRETURN;

  11395   1 000125  C380 0000 0000  xent                 LNJ,B4   X6A_AALT

      259    11396    4            END;
      260    11397    3            IF KN$NETPARM.SLDCT$~=ADDR(NIL)

  11397   1 000128  8DC7 001F                            CMN      KN$NETPARM+23,AUTO
          1 00012A  0901 000B                            BE       s:11406,PREL

      261    11398    3            THEN IF KN$NETPARM.SLDCT$->KN$LDCT.CQPTR<0

  11398   1 00012C  DCC7 001F                            LDB,B5   KN$NETPARM+23,AUTO
          1 00012E  D845 000F                            LDR,R5   15,B5
          1 000130  5881 0005                            BGEZ,R5  s:11406,PREL

      262    11399    3            THEN KN$NETPARM.SLDCT$->KN$LDCT.CQPTR = MYRPTR;

  11399   1 000132  D847 0035                            LDR,R5   MYRPTR,AUTO
          1 000134  DF45 000F                            STR,R5   15,B5

PL6.E3A0      #001=KNH$SCAN File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:03 Page:41   
      263    11400    3         END;

      264    11401              %UNLOCK (G=KNH$HMI.SCQ.LOCK);

  11406   1 000136  ECC7 0033                            LDB,B6   HMI$,AUTO
          1 000138  DBC6 000B                            LAB,B5   11,B6
          1 00013A  DFC7 003A                            STB,B5   FIRST+4,AUTO
          1 00013C  BBC7 003A                            LAB,B3   FIRST+4,AUTO
          1 00013E  CBF0 0100                            LAB,B4   256,IMO
          1 000140  E380 0000 0000  xent                 LNJ,B6   GHH$UNLOCK
          1 000143       0001                            DC       s:11408,PREL

      265    11408    2         MYRPTR = MYRPTR + MSGSZ;

  11408   1 000144  E847 0035                            LDR,R6   MYRPTR,AUTO
          1 000146  EA47 0029                            ADD,R6   MSGSZ,AUTO
          1 000148  EF47 0035                            STR,R6   MYRPTR,AUTO

      266    11409    2         IF MYRPTR >= KNH$HMI.SCQ.SZ

  11409   1 00014A  ECC7 0033                            LDB,B6   HMI$,AUTO
          1 00014C  E946 0009                            CMR,R6   9,B6
          1 00014E  0201 000E                            BL       s:11420,PREL

      267    11410    2         THEN
      268    11411    3         DO ;

      269    11412    3            MYRPTR = 0;                    /* Must of wrapped                    */

  11412   1 000150  8747 0035                            CL       MYRPTR,AUTO

      270    11413    3            IF FIRST

  11413   1 000152  89C7 0036                            CMZ      FIRST,AUTO
          1 000154  0881 0008                            BAGE     s:11420,PREL

      271    11414    3            THEN
PL6.E3A0      #001=KNH$SCAN File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:03 Page:42   
      272    11415    3            KNH$QHDR.WRAP_SCQ = KNH$QHDR.WRAP_SCQ + 1;

  11415   1 000156  DC80 0000 0000  xsym                 LDB,B5   G$HAND_Q$
          1 000159  8AC5 000F                            INC      15,B5
          1 00015B  8EC5 000E                            CAD      14,B5

      273    11416    3         END;

      274    11417
      275    11418
      276    11419
      277    11420    2         SCANSZ = SCANSZ - MSGSZ;

  11420   1 00015D  E847 002E                            LDR,R6   SCANSZ,AUTO
          1 00015F  E247 0029                            SUB,R6   MSGSZ,AUTO
          1 000161  EF47 002E                            STR,R6   SCANSZ,AUTO

      278    11421    2         IF FIRST

  11421   1 000163  89C7 0036                            CMZ      FIRST,AUTO
          1 000165  0881 0017                            BAGE     s:11430,PREL

      279    11422    3         THEN DO;

      280    11423    3            KNH$HMI.SCQ.RPTR = MYRPTR;

  11423   1 000167  D847 0035                            LDR,R5   MYRPTR,AUTO
          1 000169  DF46 0008                            STR,R5   8,B6

      281    11424    3            KNH$QHDR.SCQ.RPTR = MYRPTR;

  11424   1 00016B  DC80 0000 0000  xsym                 LDB,B5   G$HAND_Q$
          1 00016E  C847 0035                            LDR,R4   MYRPTR,AUTO
          1 000170  CF45 0005                            STR,R4   5,B5

      282    11425        /* Do some statistic gathering */
      283    11426    3            KNH$QHDR.MSGS_SCQ = KNH$QHDR.MSGS_SCQ + 1;
PL6.E3A0      #001=KNH$SCAN File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:03 Page:43   

  11426   1 000172  8AC5 000B                            INC      11,B5
          1 000174  8EC5 000A                            CAD      10,B5

      284    11427    3            KNH$QHDR.MBC_SCQ = KNH$QHDR.MBC_SCQ + MSGSZ ;

  11427   1 000176  F847 0029                            LDR,R7   MSGSZ,AUTO
          1 000178  6C00                                 LDV,R6   0
          1 000179  8445 000C                            AID      12,B5
          1 00017B  8D45 000C                            SDI      12,B5

      285    11428    3         END;

      286    11429
      287    11430    2         IF SCANSZ<=0 THEN EXIT;

  11430   1 00017D  E847 002E                            LDR,R6   SCANSZ,AUTO
          1 00017F  6A81 000F                            BLEZ,R6  s:11434,PREL

      288    11431    2         MSG$ = PINCRW(G$HAND_Q$,MYRPTR*2+KNH$HMI.SCQ.OFFSET);

  11431   1 000181  D847 0035                            LDR,R5   MYRPTR,AUTO
          1 000183  5001                                 SOL,R5   1
          1 000184  DA46 000A                            ADD,R5   10,B6
          1 000186  F855                                 LDR,R7   R5
          1 000187  6C00                                 LDV,R6   0
          1 000188  8400 0000 0000  xsym                 AID      G$HAND_Q$
          1 00018B  8D47 002A                            SDI      MSG$,AUTO

      289    11432    2      END;                                 /* End of DO WHILE                    */

  11432   1 00018D  0F81 FF37                            B        s:11360,PREL

      290    11433
      291    11434    1      IF SCANSZ < 0                        /* Something is wrong                 */

  11434   1 00018F  6881 000D                            BGEZ,R6  s:11442,PREL
PL6.E3A0      #001=KNH$SCAN File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:03 Page:44   

      292    11435    1      THEN
      293    11436    2      DO ;

      294    11437    2         ERR = BADMFMT;

  11437   1 000191  8C80 0000 0005  00                   LDI      BADMFMT
          1 000194  DCC7 0006                            LDB,B5   @ERR,AUTO
          1 000196  8D05                                 SDI      ,B5

      295    11438    2         KNH$HMI.SCQ.BUSY = '0'B;

  11438   1 000197  8846 000E                            LBF,'8000'X       14,B6
  11438   1 000199       8000

      296    11439    2         ALTRETURN;

  11439   1 00019A  C380 0000 0000  xent                 LNJ,B4   X6A_AALT

      297    11440    2      END;
      298    11441
      299    11442    1      IF KNH$QHDR.CTX.WU AND G$USER.US(G$JIT.USR#)=%GH_W

  11442   1 00019D  DC80 0000 0000  xsym                 LDB,B5   G$HAND_Q$
          1 0001A0  82C5 0009                            LB,'0001'X        9,B5
          1 0001A2       0001
          1 0001A3  0581 002D                            BBF      s:11447,PREL
          1 0001A5  CC80 0000 0000  xsym                 LDB,B4   G$JIT$
          1 0001A8  B844 0004                            LDR,R3   4,B4
          1 0001AA  B570 00FF                            AND,R3   255,IMO
          1 0001AC  BC80 0000 0000  xsym                 LDB,B3   G$USRT$
          1 0001AF  3F18                                 MLV,R3   24
          1 0001B0  3E02                                 ADV,R3   2
          1 0001B1  D833                                 LDR,R5   ,B3,R3
          1 0001B2  5D0E                                 CMV,R5   14
          1 0001B3  0981 001D                            BNE      s:11447,PREL
          1 0001B5  D845 0004                            LDR,R5   4,B5
PL6.E3A0      #001=KNH$SCAN File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:03 Page:45   
          1 0001B7  D945 0005                            CMR,R5   5,B5
          1 0001B9  0981 0017                            BNE      s:11447,PREL

      300    11443    1        AND KNH$QHDR.SCQ.IPTR=KNH$QHDR.SCQ.RPTR
      301    11444    2      THEN DO;

      302    11445    2         MYRPTR = G$JIT.USR#;

  11445   1 0001BB  C844 0004                            LDR,R4   4,B4
          1 0001BD  C570 00FF                            AND,R4   255,IMO
          1 0001BF  CF47 0035                            STR,R4   MYRPTR,AUTO

      303    11446    2         CALL GHS$RUE (%GH_EVWU,MYRPTR);

  11446   1 0001C1  ABF0 0002                            LAB,B2   2,IMO
          1 0001C3  9BC7 0035                            LAB,B1   MYRPTR,AUTO
          1 0001C5  9FC7 003C                            STB,B1   FIRST+6,AUTO
          1 0001C7  AFC7 003A                            STB,B2   FIRST+4,AUTO
          1 0001C9  BBC7 003A                            LAB,B3   FIRST+4,AUTO
          1 0001CB  CBF0 0200                            LAB,B4   512,IMO
          1 0001CD  E380 0000 0000  xent                 LNJ,B6   GHS$RUE
          1 0001D0       0001                            DC       s:11447,PREL

      304    11447    2      END;

  11442   1                              CHECK_RCQ       null
      305    11448    1   CHECK_RCQ: ;
      306    11449           %LOCK(G=KNH$HMI.RCQ.LOCK);

  11454   1 0001D1  ECC7 0033            CHECK_RCQ       LDB,B6   HMI$,AUTO
          1 0001D3  DBC6 0004                            LAB,B5   4,B6
          1 0001D5  DFC7 003A                            STB,B5   FIRST+4,AUTO
          1 0001D7  BBC7 003A                            LAB,B3   FIRST+4,AUTO
          1 0001D9  CBF0 0100                            LAB,B4   256,IMO
          1 0001DB  E380 0000 0000  xent                 LNJ,B6   GHH$LOCK
          1 0001DE       0001                            DC       s:11456,PREL

PL6.E3A0      #001=KNH$SCAN File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:03 Page:46   
      307    11456    1      IF KNH$QHDR.RCQ.RPTR ~= KNH$HMI.RCQ.RPTR /* Took something out             */

  11456   1 0001DF  EC80 0000 0000  xsym                 LDB,B6   G$HAND_Q$
          1 0001E2  DCC7 0033                            LDB,B5   HMI$,AUTO
          1 0001E4  E846 0001                            LDR,R6   1,B6
          1 0001E6  E945 0001                            CMR,R6   1,B5
          1 0001E8  0901 005B                            BE       s:11484,PREL

      308    11457    1      THEN
      309    11458    2      DO ;

  11445   1                              CLOSING         null
      310    11459    2   CLOSING: ;
      311    11460    3         DO WHILE (KNH$HMI.WAIT_COUNT > 0);

  11460   1 0001EA  ECC7 0033            CLOSING         LDB,B6   HMI$,AUTO
          1 0001EC  E846 0013                            LDR,R6   19,B6
          1 0001EE  6901 004E                            BEZ,R6   s:11477,PREL

      312    11461    3            KN$NETPARM = KN_NETPARM_INIT;

  11461   1 0001F0  AB80 0000 0000  xsym                 LAB,B2   KN_NETPARM_INIT
          1 0001F3  2C00                                 LDV,R2   0
          1 0001F4  6C42                                 LDV,R6   66
          1 0001F5  BB87                                 LAB,B3   ,AUTO
          1 0001F6  3C10                                 LDV,R3   16
          1 0001F7  0008                                 MMM

      313    11462    3            KN$NETPARM.LDCT$ = KNH$HMI.WAIT_HEAD$;

  11462   1 0001F8  ECC7 0033                            LDB,B6   HMI$,AUTO
          1 0001FA  DCC6 0011                            LDB,B5   17,B6
          1 0001FC  DFC7 0008                            STB,B5   KN$NETPARM,AUTO

      314    11463    3            KN$NETPARM.FUNCTION = %KN_FCN_UNQ;

  11463   1 0001FE  6C08                                 LDV,R6   8
PL6.E3A0      #001=KNH$SCAN File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:03 Page:47   
          1 0001FF  EF47 001C                            STR,R6   KN$NETPARM+20,AUTO

      315    11464    3            KN$LDCT.FLAGS.QUEUED = '0'B;

  11464   1 000201  8845 000A                            LBF,'8000'X       10,B5
  11464   1 000203       8000

      316    11465    3            KNH$HMI.WAIT_HEAD$ = KN$LDCT.LNK$;

  11465   1 000204  CCC5 0008                            LDB,B4   8,B5
          1 000206  CFC6 0011                            STB,B4   17,B6

      317    11466    3            KN$LDCT.LNK$=ADDR(NIL);

  11466   1 000208  AB80 0000 0000                       LAB,B2   0
          1 00020B  AFC5 0008                            STB,B2   8,B5

      318    11467    3            KNH$HMI.WAIT_COUNT = KNH$HMI.WAIT_COUNT - 1;

  11467   1 00020D  88C6 0013                            DEC      19,B6

      319    11468
      320    11469    3            IF KN$LDCT.USER_ENTRY$~=ENTADDR(NIL)

  11469   1 00020F  DCC7 0008                            LDB,B5   KN$NETPARM,AUTO
          1 000211  CCC5 000C                            LDB,B4   12,B5
          1 000213  CD80 0000 0000  02                   CMB,B4   0
          1 000216  0901 000D                            BE       s:11472,PREL

      321    11470    3            THEN CALL KN$LDCT.USER_ENTRY$(KN$NETPARM);

  11470   1 000218  ABC7 0008                            LAB,B2   KN$NETPARM,AUTO
          1 00021A  AFC7 003A                            STB,B2   FIRST+4,AUTO
          1 00021C  BBC7 003A                            LAB,B3   FIRST+4,AUTO
          1 00021E  9CC5 000C                            LDB,B1   12,B5
          1 000220  CBF0 0100                            LAB,B4   256,IMO
          1 000222  E381                                 LNJ,B6   ,B1
PL6.E3A0      #001=KNH$SCAN File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:03 Page:48   
          1 000223       0001                            DC       s:11472,PREL

      322    11471
      323    11472    3            IF KN$LDCT.FLAGS.REL

  11472   1 000224  ECC7 0008                            LDB,B6   KN$NETPARM,AUTO
          1 000226  82C6 000A                            LB,'4000'X        10,B6
          1 000228       4000
          1 000229  0581 000D                            BBF      s:11475,PREL

      324    11473    3            THEN
      325    11474    3            CALL KNA$RLSLDCT (KN$NETPARM.LDCT$);

  11474   1 00022B  DBC7 0008                            LAB,B5   KN$NETPARM,AUTO
          1 00022D  DFC7 003A                            STB,B5   FIRST+4,AUTO
          1 00022F  BBC7 003A                            LAB,B3   FIRST+4,AUTO
          1 000231  CBF0 0100                            LAB,B4   256,IMO
          1 000233  E380 0000 0000  xent                 LNJ,B6   KNA$RLSLDCT
          1 000236       0001                            DC       s:11475,PREL

      326    11475    3         END;

  11475   1 000237  ECC7 0033                            LDB,B6   HMI$,AUTO
          1 000239  E846 0013                            LDR,R6   19,B6
          1 00023B  6981 FFB4                            BNEZ,R6  s:11461,PREL

      327    11476
      328    11477    2         KNH$HMI.RCQ.RPTR = KNH$QHDR.RCQ.RPTR;

  11477   1 00023D  DC80 0000 0000  xsym                 LDB,B5   G$HAND_Q$
          1 000240  D845 0001                            LDR,R5   1,B5
          1 000242  DF46 0001                            STR,R5   1,B6

      329    11478    2      END;

      330    11479           %UNLOCK(G=KNH$HMI.RCQ.LOCK);

PL6.E3A0      #001=KNH$SCAN File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:03 Page:49   
  11484   1 000244  ECC7 0033                            LDB,B6   HMI$,AUTO
          1 000246  DBC6 0004                            LAB,B5   4,B6
          1 000248  DFC7 003A                            STB,B5   FIRST+4,AUTO
          1 00024A  BBC7 003A                            LAB,B3   FIRST+4,AUTO
          1 00024C  CBF0 0100                            LAB,B4   256,IMO
          1 00024E  E380 0000 0000  xent                 LNJ,B6   GHH$UNLOCK
          1 000251       0001                            DC       s:11487,PREL

      331    11486
      332    11487    1      KNH$HMI.SCQ.BUSY = '0'B;

  11487   1 000252  ECC7 0033                            LDB,B6   HMI$,AUTO
          1 000254  8846 000E                            LBF,'8000'X       14,B6
          1 000256       8000

      333    11488    1      RETURN;

  11488   1 000257  C380 0000 0000  xent                 LNJ,B4   X6A_ARET

      334    11489
      335    11490        %EJECT;
PL6.E3A0      #001=KNH$SCAN File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:03 Page:50   
      336    11491    1   KNH$WRITE: ENTRY (BUF$,ERR) ALTRET;

  11491   1 00025A  D380 0000 0000  xent KNH$WRITE       LNJ,B5   X6A_AUTO_2
          1 00025D       003E 0002                       DC       62,2

      337    11492
      338    11493
      339    11494    1      HMI$ = G$USER.HMI$(G$JIT.USR#);

  11494   1 00025F  EC80 0000 0000  xsym                 LDB,B6   G$JIT$
          1 000262  B846 0004                            LDR,R3   4,B6
          1 000264  B570 00FF                            AND,R3   255,IMO
          1 000266  DC80 0000 0000  xsym                 LDB,B5   G$USRT$
          1 000269  3F0C                                 MLV,R3   12
          1 00026A  3E0A                                 ADV,R3   10
          1 00026B  CCB5                                 LDB,B4   ,B5,R3
          1 00026C  CFC7 0033                            STB,B4   HMI$,AUTO

      340    11495    1      MSG$ = BUF$;

  11495   1 00026E  BCC7 0004                            LDB,B3   @BUF$,AUTO
          1 000270  AC83                                 LDB,B2   ,B3
          1 000271  AFC7 002A                            STB,B2   MSG$,AUTO

      341    11496    1      FPTSIZE = (KNH$MESS.FPTSZ + 1)/2;

  11496   1 000273  E842 0006                            LDR,R6   6,B2
          1 000275  6E01                                 ADV,R6   1
          1 000276  6041                                 SOR,R6   1
          1 000277  EF47 002F                            STR,R6   FPTSIZE,AUTO

      342    11497    1      MSGSZ = (SIZEW(KNH$MESS) + FPTSIZE +(KNH$MESS.MSGSZ + 1)/2 + 1)/2;

  11497   1 000279  D842 0007                            LDR,R5   7,B2
          1 00027B  5E01                                 ADV,R5   1
          1 00027C  5041                                 SOR,R5   1
          1 00027D  DA56                                 ADD,R5   R6
PL6.E3A0      #001=KNH$SCAN File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:03 Page:51   
          1 00027E  5E09                                 ADV,R5   9
          1 00027F  D370 0002                            DIV,R5   2,IMO
          1 000281  DF47 0029                            STR,R5   MSGSZ,AUTO

      343    11498    1      MYRPTR = 65535;

  11498   1 000283  8947 0035                            LBT,'FFFF'X       MYRPTR,AUTO
  11498   1 000285       FFFF

      344    11499           %LOCK (G=KNH$HMI.SCQ.LOCK);

  11504   1 000286  9BC4 000B                            LAB,B1   11,B4
          1 000288  9FC7 003A                            STB,B1   FIRST+4,AUTO
          1 00028A  BBC7 003A                            LAB,B3   FIRST+4,AUTO
          1 00028C  CBF0 0100                            LAB,B4   256,IMO
          1 00028E  E380 0000 0000  xent                 LNJ,B6   GHH$LOCK
          1 000291       0001                            DC       s:11506,PREL

      345    11506    1      CALL DO$MSG

  11506   1 000292  E3C0 0025                            LNJ,B6   s:0,PREL
          1 000294       0003                            DC       s:11513,PREL
          1 000295  0F81 0011                            B        s:11522,PREL

      346    11507    2      WHENALTRETURN DO;

      347    11508              %UNLOCK(G=KNH$HMI.SCQ.LOCK);

  11513   1 000297  ECC7 0033                            LDB,B6   HMI$,AUTO
          1 000299  DBC6 000B                            LAB,B5   11,B6
          1 00029B  DFC7 003A                            STB,B5   FIRST+4,AUTO
          1 00029D  BBC7 003A                            LAB,B3   FIRST+4,AUTO
          1 00029F  CBF0 0100                            LAB,B4   256,IMO
          1 0002A1  E380 0000 0000  xent                 LNJ,B6   GHH$UNLOCK
          1 0002A4       0001                            DC       s:11515,PREL

      348    11515    2         GOTO CHECK_RCQ;
PL6.E3A0      #001=KNH$SCAN File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:03 Page:52   

  11515   1 0002A5  0F81 FF2B                            B        s:11447,PREL

      349    11516    2      END;
      350    11517           %UNLOCK(G=KNH$HMI.SCQ.LOCK);

  11522   1 0002A7  ECC7 0033                            LDB,B6   HMI$,AUTO
          1 0002A9  DBC6 000B                            LAB,B5   11,B6
          1 0002AB  DFC7 003A                            STB,B5   FIRST+4,AUTO
          1 0002AD  BBC7 003A                            LAB,B3   FIRST+4,AUTO
          1 0002AF  CBF0 0100                            LAB,B4   256,IMO
          1 0002B1  E380 0000 0000  xent                 LNJ,B6   GHH$UNLOCK
          1 0002B4       0001                            DC       s:11525,PREL

      351    11524
      352    11525    1      RETURN;

  11525   1 0002B5  C380 0000 0000  xent                 LNJ,B4   X6A_ARET

      353    11526        %EJECT;
PL6.E3A0      #001=KNH$SCAN File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:03 Page:53   
      354    11527    1   DO$MSG: PROC ALTRET;

  11527   1 0002B8  EFC7 0038            DO$MSG          STB,B6   FIRST+2,AUTO

      355    11528
      356    11529    2      KN$NETPARM = KN_NETPARM_INIT;

  11529   1 0002BA  AB80 0000 0000  xsym                 LAB,B2   KN_NETPARM_INIT
          1 0002BD  2C00                                 LDV,R2   0
          1 0002BE  6C42                                 LDV,R6   66
          1 0002BF  BB87                                 LAB,B3   ,AUTO
          1 0002C0  3C10                                 LDV,R3   16
          1 0002C1  0008                                 MMM

      357    11530    2      FPT$ = PINCRW(MSG$,SIZEW(KNH$MESS));

  11530   1 0002C2  ECC7 002A                            LDB,B6   MSG$,AUTO
          1 0002C4  DBC6 0008                            LAB,B5   8,B6
          1 0002C6  DFC7 002C                            STB,B5   FPT$,AUTO

      358    11531    2      IF MSGSZ > SIZEW(KNH$MESS)/2         /* Message exists                     */

  11531   1 0002C8  E847 0029                            LDR,R6   MSGSZ,AUTO
          1 0002CA  6D04                                 CMV,R6   4
          1 0002CB  0381 000E                            BLE      s:11541,PREL

      359    11532    2      THEN
      360    11533    3      DO ;

      361    11534    3         KN$NETPARM.UHDRSZ = KNH$MESS.MSGSZ;

  11534   1 0002CD  D846 0007                            LDR,R5   7,B6
          1 0002CF  DF47 000F                            STR,R5   KN$NETPARM+7,AUTO

      362    11535    3         KN$NETPARM.NHDRSZ = KN$NETPARM.UHDRSZ ;

  11535   1 0002D1  DF47 0018                            STR,R5   KN$NETPARM+16,AUTO
PL6.E3A0      #001=KNH$SCAN File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:03 Page:54   

      363    11536    3         KN$NETPARM.UHDR$ = PINCRW(FPT$,FPTSIZE);

  11536   1 0002D3  B847 002F                            LDR,R3   FPTSIZE,AUTO
          1 0002D5  CBB5                                 LAB,B4   ,B5,R3
          1 0002D6  CFC7 000D                            STB,B4   KN$NETPARM+5,AUTO

      364    11537    3         KN$NETPARM.NHDR$ = KN$NETPARM.UHDR$ ;

  11537   1 0002D8  CFC7 0016                            STB,B4   KN$NETPARM+14,AUTO

      365    11538    3      END;

      366    11539
      367    11540        /* Calculate LDCT$ from the header */
      368    11541    2      KN$NETPARM.RECTYPE = KNH$MESS.RECTYPE;

  11541   1 0002DA  D846 0004                            LDR,R5   4,B6
          1 0002DC  DF47 001B                            STR,R5   KN$NETPARM+19,AUTO

      369    11542    2      KN$NETPARM.FUNCTION = KNH$MESS.FUNCTION;

  11542   1 0002DE  C806                                 LDR,R4   ,B6
          1 0002DF  CF47 001C                            STR,R4   KN$NETPARM+20,AUTO

      370    11543    2      KN$NETPARM.LDCT$ = KN$DCT$(KNH$MESS.LDCTX);

  11543   1 0002E1  B846 0001                            LDR,R3   1,B6
          1 0002E3  CC80 0000 0000  xsym                 LDB,B4   KN_DCT$$
          1 0002E6  ACB4                                 LDB,B2   ,B4,R3
          1 0002E7  AFC7 0008                            STB,B2   KN$NETPARM,AUTO

      371    11544    2      KN$NETPARM.SLDCT$ = KN$NETPARM.LDCT$;

  11544   1 0002E9  AFC7 001F                            STB,B2   KN$NETPARM+23,AUTO

      372    11545
PL6.E3A0      #001=KNH$SCAN File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:03 Page:55   
      373    11546    3      IF ADDR(KN$LDCT)~=ADDR(NIL) THEN DO;

  11546   1 0002EB  8DD2                                 CMN      B2
          1 0002EC  0901 0078                            BE       s:11589,PREL

      374    11547    3         IF KN$LDCT.CQPTR>=0

  11547   1 0002EE  B842 000F                            LDR,R3   15,B2
          1 0002F0  3801 001A                            BLZ,R3   s:11555,PREL

      375    11548    3         THEN IF KN$LDCT.CQPTR=MYRPTR AND NOT KN$LDCT.FLAGS.QUEUED

  11548   1 0002F2  3801 000E                            BLZ,R3   s:11551,PREL
          1 0002F4  B947 0035                            CMR,R3   MYRPTR,AUTO
          1 0002F6  0981 000A                            BNE      s:11551,PREL
          1 0002F8  89C2 000A                            CMZ      10,B2
          1 0002FA  0801 0006                            BAL      s:11551,PREL

      376    11549    3         THEN KN$LDCT.CQPTR = -1;

  11549   1 0002FC  8942 000F                            LBT,'FFFF'X       15,B2
  11549   1 0002FE       FFFF
          1 0002FF  0F81 000B                            B        s:11555,PREL

      377    11550    4         ELSE DO;

      378    11551    4            ERR=CQFUL ;

  11551   1 000301  8C80 0000 000F  00                   LDI      CQFUL
          1 000304  9CC7 0006                            LDB,B1   @ERR,AUTO
          1 000306  8D01                                 SDI      ,B1

      379    11552    4            ALTRETURN ;

  11552   1 000307  ECC7 0038                            LDB,B6   FIRST+2,AUTO
          1 000309  B806                                 LDR,R3   ,B6
          1 00030A  C3B6                                 LNJ,B4   ,B6,R3
PL6.E3A0      #001=KNH$SCAN File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:03 Page:56   

      380    11553    4         END ;
      381    11554
      382    11555    3         IF KN$LDCT.USER#~=G$JIT.USR#

  11555   1 00030B  9C80 0000 0000  xsym                 LDB,B1   G$JIT$
          1 00030E  D841 0004                            LDR,R5   4,B1
          1 000310  D570 00FF                            AND,R5   255,IMO
          1 000312  D942 000E                            CMR,R5   14,B2
          1 000314  0981 0056                            BNE      s:11592,PREL

      383    11556    3         THEN
      384    11557    3         GOTO ILLDCTERR;
      385    11558
      386    11559    4         DO CASE(KN$LDCT.CONN_TYPE);

  11559   1 000316  B282                                 LLH,R3   ,B2
          1 000317  3D08                                 CMV,R3   8
          1 000318  0281 0041                            BGE      s:11582,PREL
          1 00031A  A830 0000 0320  01                   LDR,R2   s:11559+10,R3
          1 00031D  83A0 0000 0328  01                   JMP      s:11564,R2
          1 000320       0032                            DC       s:11582,PREL
          1 000321       0032                            DC       s:11582,PREL
          1 000322       0000                            DC       s:11564,PREL
          1 000323       0032                            DC       s:11582,PREL
          1 000324       0032                            DC       s:11582,PREL
          1 000325       0000                            DC       s:11564,PREL
          1 000326       0007                            DC       s:11567,PREL
          1 000327       000E                            DC       s:11570,PREL

      387    11560        /*
      388    11561           Set up ENTRY$ for routine to call if not INIT or LOOP.
      389    11562        */
      390    11563    4         CASE (%KN_CNTYPE_SESS, %KN_CNTYPE_QDP);

      391    11564    4            ENTRY$ = ENTADDR(KNS$SEND);

PL6.E3A0      #001=KNH$SCAN File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:03 Page:57   
  11564   1 000328  EB80 0000 0000  xent                 LAB,B6   KNS$SEND
          1 00032B  EFC7 0030                            STB,B6   ENTRY$,AUTO
          1 00032D  0F81 0047                            B        s:11599,PREL

      392    11565
      393    11566    4         CASE (%KN_CNTYPE_LINK);

      394    11567    4            ENTRY$ = ENTADDR(KNN$RECV);

  11567   1 00032F  EB80 0000 0000  xent                 LAB,B6   KNN$RECV
          1 000332  EFC7 0030                            STB,B6   ENTRY$,AUTO
          1 000334  0F81 0040                            B        s:11599,PREL

      395    11568
      396    11569    4         CASE (%KN_CNTYPE_CIRCUIT);

      397    11570    4            IF KN$NETPARM.FUNCTION = %KN_FCN_TERM

  11570   1 000336  C847 001C                            LDR,R4   KN$NETPARM+20,AUTO
          1 000338  4D03                                 CMV,R4   3
          1 000339  0901 0007                            BE       s:11572,PREL
          1 00033B  9802                                 LDR,R1   ,B2
          1 00033C  9570 00FF                            AND,R1   255,IMO
          1 00033E  1D09                                 CMV,R1   9
          1 00033F  0981 0008                            BNE      s:11573,PREL

      398    11571    4              OR KN$LDCT.STATE = %KN_ST_OPENING THEN
      399    11572    4            ENTRY$ = ENTADDR(KNN$RECV);

  11572   1 000341  EB80 0000 0000  xent                 LAB,B6   KNN$RECV
          1 000344  EFC7 0030                            STB,B6   ENTRY$,AUTO
          1 000346  0F81 002E                            B        s:11599,PREL

      400    11573    4            ELSE IF KN$LDCT.STATE = %KN_ST_OPEN

  11573   1 000348  1D08                                 CMV,R1   8
          1 000349  0981 0010                            BNE      s:11582,PREL
PL6.E3A0      #001=KNH$SCAN File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:03 Page:58   

      401    11574    5            THEN DO;

      402    11575    5               KN$NETPARM.THDR$ = KN$NETPARM.NHDR$;

  11575   1 00034B  ECC7 0016                            LDB,B6   KN$NETPARM+14,AUTO
          1 00034D  EFC7 0013                            STB,B6   KN$NETPARM+11,AUTO

      403    11576    5               KN$NETPARM.THDRSZ = KN$NETPARM.NHDRSZ;

  11576   1 00034F  D847 0018                            LDR,R5   KN$NETPARM+16,AUTO
          1 000351  DF47 0015                            STR,R5   KN$NETPARM+13,AUTO

      404    11577    5               ENTRY$ = ENTADDR(KNT$RECV_4HOST);

  11577   1 000353  EB80 0000 0000  xent                 LAB,B6   KNT$RECV_4HOST
          1 000356  EFC7 0030                            STB,B6   ENTRY$,AUTO

      405    11578    5            END;

  11578   1 000358  0F81 001C                            B        s:11599,PREL

      406    11579    4            ELSE
      407    11580    4            GOTO BADLDCTSCR;
      408    11581
      409    11582    4         CASE (ELSE);

  11577   1                              BADLDCTSCR      null
      410    11583    4   BADLDCTSCR:;
      411    11584    4            CALL SCREECH(BADLDCT);

  11584   1 00035A  BB80 0000 0002  02   BADLDCTSCR      LAB,B3   +2
          1 00035D  CBF0 0100                            LAB,B4   256,IMO
          1 00035F  E380 0000 0000  xent                 LNJ,B6   SCREECH
          1 000362       0001                            DC       s:11585,PREL

      412    11585    4            GOTO ILLDCTERR;
PL6.E3A0      #001=KNH$SCAN File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:03 Page:59   

  11585   1 000363  0F81 0007                            B        s:11592,PREL

      413    11586
      414    11587    4         END;                              /* End cases                          */

      415    11588    3      END; /* if ADDR(KN$LDCT)~=addr(nil) */
      416    11589    2      ELSE IF KN$NETPARM.FUNCTION~=%KN_FCN_INIT

  11589   1 000365  4D01                                 CMV,R4   1
          1 000366  0901 000E                            BE       s:11599,PREL
          1 000368  4D07                                 CMV,R4   7
          1 000369  0901 000B                            BE       s:11599,PREL

      417    11590    2        AND KN$NETPARM.FUNCTION~=%KN_FCN_LOOP
      418    11591    2      THEN
      419    11592    3      DO;

  11583   1                              ILLDCTERR       null
      420    11593    3   ILLDCTERR:;
      421    11594    3         ERR = ILLDCT;

  11594   1 00036B  8C80 0000 0007  00   ILLDCTERR       LDI      ILLDCT
          1 00036E  ECC7 0006                            LDB,B6   @ERR,AUTO
          1 000370  8D06                                 SDI      ,B6

      422    11595    3         ALTRETURN;

  11595   1 000371  ECC7 0038                            LDB,B6   FIRST+2,AUTO
          1 000373  B806                                 LDR,R3   ,B6
          1 000374  C3B6                                 LNJ,B4   ,B6,R3

      423    11596    3      END;
      424    11597
      425    11598
      426    11599    2      IF KN$NETPARM.FUNCTION=%KN_FCN_DATA THEN GOTO DO$DATA;

PL6.E3A0      #001=KNH$SCAN File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:03 Page:60   
  11599   1 000375  D847 001C                            LDR,R5   KN$NETPARM+20,AUTO
          1 000377  5D05                                 CMV,R5   5
          1 000378  0901 015F                            BE       s:11697,PREL

      427    11600    2      IF FPTSIZE~=0 THEN KN$NETPARM.FPT$ = FPT$;

  11600   1 00037A  C847 002F                            LDR,R4   FPTSIZE,AUTO
          1 00037C  4901 0003                            BEZ,R4   s:11601,PREL

  11600   1 00037E  DFC7 0021                            STB,B5   KN$NETPARM+25,AUTO

      428    11601    3      DO CASE (KN$NETPARM.FUNCTION);

  11601   1 000380  B855                                 LDR,R3   R5
          1 000381  3D10                                 CMV,R3   16
          1 000382  0281 01EB                            BGE      s:11755,PREL
          1 000384  A830 0000 038A  01                   LDR,R2   s:11601+10,R3
          1 000387  83A0 0000 039A  01                   JMP      s:11605,R2
          1 00038A       01D4                            DC       s:11755,PREL
          1 00038B       0000                            DC       s:11605,PREL
          1 00038C       010F                            DC       s:11681,PREL
          1 00038D       013E                            DC       s:11697,PREL
          1 00038E       014E                            DC       s:11704,PREL
          1 00038F       01D4                            DC       s:11755,PREL
          1 000390       01D4                            DC       s:11755,PREL
          1 000391       0185                            DC       s:11721,PREL
          1 000392       01D4                            DC       s:11755,PREL
          1 000393       01D4                            DC       s:11755,PREL
          1 000394       01B8                            DC       s:11747,PREL
          1 000395       01A6                            DC       s:11739,PREL
          1 000396       01A6                            DC       s:11739,PREL
          1 000397       01C9                            DC       s:11751,PREL
          1 000398       01C9                            DC       s:11751,PREL
          1 000399       01C9                            DC       s:11751,PREL

      429    11602    3      CASE (%KN_FCN_INIT);

PL6.E3A0      #001=KNH$SCAN File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:03 Page:61   
      430    11603
      431    11604
      432    11605    3         IF KNH$MESS.FPTSZ < SIZEC(FPT_CONNECT)

  11605   1 00039A  ECC7 002A                            LDB,B6   MSG$,AUTO
          1 00039C  9846 0006                            LDR,R1   6,B6
          1 00039E  1D26                                 CMV,R1   38
          1 00039F  0281 000B                            BGE      s:11611,PREL

      433    11606    4         THEN DO;

      434    11607    4            ERR = BADMFMT;

  11607   1 0003A1  8C80 0000 0005  00                   LDI      BADMFMT
          1 0003A4  9CC7 0006                            LDB,B1   @ERR,AUTO
          1 0003A6  8D01                                 SDI      ,B1

      435    11608    4            ALTRETURN;

  11608   1 0003A7  ECC7 0038                            LDB,B6   FIRST+2,AUTO
          1 0003A9  A806                                 LDR,R2   ,B6
          1 0003AA  C3A6                                 LNJ,B4   ,B6,R2

      436    11609    4         END;
      437    11610
      438    11611    3         FPT_CONNECT.USER.SYSID = G$JIT.SYSID;

  11611   1 0003AB  9C80 0000 0000  xsym                 LDB,B1   G$JIT$
          1 0003AE  E841 0005                            LDR,R6   5,B1
          1 0003B0  EF45 000F                            STR,R6   15,B5

      439    11612        /* Look at the resource in the FPT */
      440    11613    4         DO SELECT (FPT_CONNECT.RESOURCE);

  11613   1 0003B2  EB80 0000 0000  00                   LAB,B6   BADLDCT
          1 0003B5  0022                                 ACM      ;
          1 0003B6       4805 0001                                ALPHANUM(1,B5,,8,FILL),;
PL6.E3A0      #001=KNH$SCAN File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:03 Page:62   
          1 0003B8       4506 0017                                ALPHANUM(23,B6,,5,FILL)
          1 0003BA  7301 0017                            CBL      s:11613+32,PREL
          1 0003BC  EB80 0000 0000  00                   LAB,B6   BADLDCT
          1 0003BF  0022                                 ACM      ;
          1 0003C0       4805 0001                                ALPHANUM(1,B5,,8,FILL),;
          1 0003C2       4506 0017                                ALPHANUM(23,B6,,5,FILL)
          1 0003C4  5381 002C                            CBE      s:11626,PREL
          1 0003C6  EB80 0000 0000  00                   LAB,B6   BADLDCT
          1 0003C9  0022                                 ACM      ;
          1 0003CA       4805 0001                                ALPHANUM(1,B5,,8,FILL),;
          1 0003CC       4606 001A                                ALPHANUM(26,B6,,6,FILL)
          1 0003CE  5301 0029                            CBNE     s:11629,PREL
          1 0003D0  0F81 000F                            B        s:11618,PREL
          1 0003D2  EB80 0000 0000  02                   LAB,B6   0
          1 0003D5  0022                                 ACM      ;
          1 0003D6       4805 0001                                ALPHANUM(1,B5,,8,FILL),;
          1 0003D8       4106 0004                                ALPHANUM(4,B6,,1,FILL)
          1 0003DA  5301 001D                            CBNE     s:11629,PREL
          1 0003DC  0F81 0001                            B        s:11615,PREL

      441    11614
      442    11615    4            SELECT (' ');

  11615   1 0003DE  0F81 0023                            B        s:11635,PREL

      443    11616
      444    11617    4            SELECT ('NETMAN');

      445    11618    4            IF G$JIT.USR# ~= 1

  11618   1 0003E0  A841 0004                            LDR,R2   4,B1
          1 0003E2  A570 00FF                            AND,R2   255,IMO
          1 0003E4  2D01                                 CMV,R2   1
          1 0003E5  0901 001C                            BE       s:11635,PREL

      446    11619    4            THEN
      447    11620    5            DO ;
PL6.E3A0      #001=KNH$SCAN File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:03 Page:63   

      448    11621    5               ERR = NORES;

  11621   1 0003E7  8C80 0000 0011  00                   LDI      NORES
          1 0003EA  ECC7 0006                            LDB,B6   @ERR,AUTO
          1 0003EC  8D06                                 SDI      ,B6

      449    11622    5               ALTRETURN;

  11622   1 0003ED  ECC7 0038                            LDB,B6   FIRST+2,AUTO
          1 0003EF  A806                                 LDR,R2   ,B6
          1 0003F0  C3A6                                 LNJ,B4   ,B6,R2

      450    11623    5            END;
      451    11624
      452    11625    4            SELECT ('LOGON');

      453    11626    4            FPT_CONNECT.RLCID.NODE = KN_NODE#;

  11626   1 0003F1  A800 0000 0000  xsym                 LDR,R2   KN_NODE#
          1 0003F4  A7C5 000D                            STH,R2   13,B5
          1 0003F6  0F81 000B                            B        s:11635,PREL

      454    11627
      455    11628    4            SELECT(ELSE);

      456    11629    4         ERR=NORES;

  11629   1 0003F8  8C80 0000 0011  00                   LDI      NORES
          1 0003FB  ECC7 0006                            LDB,B6   @ERR,AUTO
          1 0003FD  8D06                                 SDI      ,B6

      457    11630    4         ALTRETURN;

  11630   1 0003FE  ECC7 0038                            LDB,B6   FIRST+2,AUTO
          1 000400  A806                                 LDR,R2   ,B6
          1 000401  C3A6                                 LNJ,B4   ,B6,R2
PL6.E3A0      #001=KNH$SCAN File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:03 Page:64   

      458    11631
      459    11632    4         END;                              /* End DO SELECT                      */

      460    11633
      461    11634        /* Get a LDCT for this new endpoint */
      462    11635    3      IF KN$NETPARM.LDCT$ = ADDR(NIL)

  11635   1 000402  8DC7 0008                            CMN      KN$NETPARM,AUTO
          1 000404  0981 0019                            BNE      s:11643,PREL

      463    11636    3      THEN
      464    11637    3      CALL KNA$GETLDCT (KN$NETPARM.LDCT$) WHENALTRETURN

  11637   1 000406  EBC7 0008                            LAB,B6   KN$NETPARM,AUTO
          1 000408  EFC7 003A                            STB,B6   FIRST+4,AUTO
          1 00040A  BBC7 003A                            LAB,B3   FIRST+4,AUTO
          1 00040C  CBF0 0100                            LAB,B4   256,IMO
          1 00040E  E380 0000 0000  xent                 LNJ,B6   KNA$GETLDCT
          1 000411       0003                            DC       s:11639,PREL
          1 000412  0F81 000B                            B        s:11643,PREL

      465    11638    4      DO ;

      466    11639    4         ERR = NOLDCT;

  11639   1 000414  8C80 0000 0003  00                   LDI      NOLDCT
          1 000417  ECC7 0006                            LDB,B6   @ERR,AUTO
          1 000419  8D06                                 SDI      ,B6

      467    11640    4         ALTRETURN;

  11640   1 00041A  ECC7 0038                            LDB,B6   FIRST+2,AUTO
          1 00041C  B806                                 LDR,R3   ,B6
          1 00041D  C3B6                                 LNJ,B4   ,B6,R3

      468    11641    4      END;
PL6.E3A0      #001=KNH$SCAN File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:03 Page:65   
      469    11642
      470    11643    3      KN$LDCT.UID = KNH$MESS.UID;

  11643   1 00041E  ECC7 002A                            LDB,B6   MSG$,AUTO
          1 000420  8CC6 0002                            LDI      2,B6
          1 000422  DCC7 0008                            LDB,B5   KN$NETPARM,AUTO
          1 000424  8D45 0005                            SDI      5,B5

      471    11644    3      KN$LDCT.USER# = G$JIT.USR#;

  11644   1 000426  DCC7 0008                            LDB,B5   KN$NETPARM,AUTO
          1 000428  CC80 0000 0000  xsym                 LDB,B4   G$JIT$
          1 00042B  E844 0004                            LDR,R6   4,B4
          1 00042D  E570 00FF                            AND,R6   255,IMO
          1 00042F  EF45 000E                            STR,R6   14,B5

      472    11645    3      KN$LDCT.USER_ENTRY$ = ENTADDR(KNH$SEND);

  11645   1 000431  BB80 0000 0000  xent                 LAB,B3   KNH$SEND
          1 000434  BFC5 000C                            STB,B3   12,B5

      473    11646    3      KN$NETPARM.SLDCT$ = KN$NETPARM.LDCT$;

  11646   1 000436  DFC7 001F                            STB,B5   KN$NETPARM+23,AUTO

      474    11647    3      KNH$MESS.LDCTX = KN$LDCT.LDCTX;

  11647   1 000438  E845 0007                            LDR,R6   7,B5
          1 00043A  EF46 0001                            STR,R6   1,B6

      475    11648    3      KN$LDCT.CONN_TYPE = FPT_CONNECT.TYPE +1; /*KNH equ to KN equ*/

  11648   1 00043C  DCC7 002C                            LDB,B5   FPT$,AUTO
          1 00043E  D805                                 LDR,R5   ,B5
          1 00043F  5E01                                 ADV,R5   1
          1 000440  BCC7 0008                            LDB,B3   KN$NETPARM,AUTO
          1 000442  D783                                 STH,R5   ,B3
PL6.E3A0      #001=KNH$SCAN File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:03 Page:66   

      476    11649
      477    11650    4      DO CASE (FPT_CONNECT.TYPE);

  11650   1 000443  B805                                 LDR,R3   ,B5
          1 000444  3D07                                 CMV,R3   7
          1 000445  0281 004D                            BGE      s:11672,PREL
          1 000447  A830 0000 044D  01                   LDR,R2   s:11650+10,R3
          1 00044A  83A0 0000 0454  01                   JMP      s:11653,R2
          1 00044D       003F                            DC       s:11672,PREL
          1 00044E       0000                            DC       s:11653,PREL
          1 00044F       003F                            DC       s:11672,PREL
          1 000450       003F                            DC       s:11672,PREL
          1 000451       0000                            DC       s:11653,PREL
          1 000452       000E                            DC       s:11656,PREL
          1 000453       000E                            DC       s:11656,PREL

      478    11651
      479    11652    4      CASE (%KN_CON_TYP_SESS, %KN_CON_TYP_QDP);

      480    11653    4         CALL KNS$SEND(KN$NETPARM) ALTRET(REL_LDCT);

  11653   1 000454  BBC7 0008                            LAB,B3   KN$NETPARM,AUTO
          1 000456  BFC7 003A                            STB,B3   FIRST+4,AUTO
          1 000458  BBC7 003A                            LAB,B3   FIRST+4,AUTO
          1 00045A  CBF0 0100                            LAB,B4   256,IMO
          1 00045C  E380 0000 0000  xent                 LNJ,B6   KNS$SEND
          1 00045F       001A                            DC       s:11660,PREL
          1 000460  0F81 0117                            B        s:11760,PREL

      481    11654
      482    11655    4      CASE (%KN_CON_TYP_LINK, %KN_CON_TYP_CIRCUIT);

      483    11656    4         IF KN$NETPARM.UHDRSZ = 0 THEN /* so network can tell the diff between

  11656   1 000462  E847 000F                            LDR,R6   KN$NETPARM+7,AUTO
          1 000464  6981 0006                            BNEZ,R6  s:11659,PREL
PL6.E3A0      #001=KNH$SCAN File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:03 Page:67   

      484    11657                                                   connects with nsaps and those without*/
      485    11658    4         KN$NETPARM.UHDR$ = PINCRW(FPT$,FPTSIZE);

  11658   1 000466  9847 002F                            LDR,R1   FPTSIZE,AUTO
          1 000468  BB95                                 LAB,B3   ,B5,R1
          1 000469  BFC7 000D                            STB,B3   KN$NETPARM+5,AUTO

      486    11659    4         CALL KNN$RECV(KN$NETPARM) WHENALTRETURN

  11659   1 00046B  BBC7 0008                            LAB,B3   KN$NETPARM,AUTO
          1 00046D  BFC7 003A                            STB,B3   FIRST+4,AUTO
          1 00046F  BBC7 003A                            LAB,B3   FIRST+4,AUTO
          1 000471  CBF0 0100                            LAB,B4   256,IMO
          1 000473  E380 0000 0000  xent                 LNJ,B6   KNN$RECV
          1 000476       0003                            DC       s:11660,PREL
          1 000477  0F81 0019                            B        s:11668+2,PREL

      487    11660    5         DO ;

  11658   1                              REL_LDCT        null
      488    11661    5   REL_LDCT: ;
      489    11662    5            IF NOT KN$NETPARM.SLDCT$->KN$LDCT.FLAGS.QUEUED

  11662   1 000479  ECC7 001F            REL_LDCT        LDB,B6   KN$NETPARM+23,AUTO
          1 00047B  89C6 000A                            CMZ      10,B6
          1 00047D  0801 0011                            BAL      s:11668,PREL

      490    11663    5            THEN
      491    11664    6            DO;

      492    11665    6               CALL KNA$RLSLDCT(KN$NETPARM.SLDCT$);

  11665   1 00047F  DBC7 001F                            LAB,B5   KN$NETPARM+23,AUTO
          1 000481  DFC7 003A                            STB,B5   FIRST+4,AUTO
          1 000483  BBC7 003A                            LAB,B3   FIRST+4,AUTO
          1 000485  CBF0 0100                            LAB,B4   256,IMO
PL6.E3A0      #001=KNH$SCAN File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:03 Page:68   
          1 000487  E380 0000 0000  xent                 LNJ,B6   KNA$RLSLDCT
          1 00048A       0001                            DC       s:11666,PREL

      493    11666    6               KNH$MESS.LDCTX = 0;

  11666   1 00048B  ECC7 002A                            LDB,B6   MSG$,AUTO
          1 00048D  8746 0001                            CL       1,B6

      494    11667    6            END;

      495    11668    5            GOTO L_ALT;

  11668   1 00048F  0F81 0066                            B        s:11705,PREL
          1 000491  0F81 00E6                            B        s:11760,PREL

      496    11669    5         END;
      497    11670
      498    11671    4      CASE (ELSE);

      499    11672    4         CALL KNA$RLSLDCT(KN$NETPARM.LDCT$);

  11672   1 000493  BBC7 0008                            LAB,B3   KN$NETPARM,AUTO
          1 000495  BFC7 003A                            STB,B3   FIRST+4,AUTO
          1 000497  BBC7 003A                            LAB,B3   FIRST+4,AUTO
          1 000499  CBF0 0100                            LAB,B4   256,IMO
          1 00049B  E380 0000 0000  xent                 LNJ,B6   KNA$RLSLDCT
          1 00049E       0001                            DC       s:11673,PREL

      500    11673    4         ERR = ILGCTYPE;

  11673   1 00049F  8C80 0000 0009  00                   LDI      ILGCTYPE
          1 0004A2  ECC7 0006                            LDB,B6   @ERR,AUTO
          1 0004A4  8D06                                 SDI      ,B6

      501    11674    4         ALTRETURN;

  11674   1 0004A5  ECC7 0038                            LDB,B6   FIRST+2,AUTO
PL6.E3A0      #001=KNH$SCAN File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:03 Page:69   
          1 0004A7  B806                                 LDR,R3   ,B6
          1 0004A8  C3B6                                 LNJ,B4   ,B6,R3

      502    11675
      503    11676    4      END;                                 /* End cases                          */

      504    11677
      505    11678        %EJECT;
PL6.E3A0      #001=KNH$SCAN File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:03 Page:70   
      506    11679    3      CASE (%KN_FCN_INIT_ACK);

      507    11680
      508    11681    3         KN$LDCT.UID = KNH$MESS.UID;

  11681   1 0004A9  ECC7 002A                            LDB,B6   MSG$,AUTO
          1 0004AB  8CC6 0002                            LDI      2,B6
          1 0004AD  8D42 0005                            SDI      5,B2

      509    11682
      510    11683    3         CALL ENTRY$ (KN$NETPARM) ALTRET(L_ALT);

  11683   1 0004AF  ABC7 0008                            LAB,B2   KN$NETPARM,AUTO
          1 0004B1  AFC7 003A                            STB,B2   FIRST+4,AUTO
          1 0004B3  BBC7 003A                            LAB,B3   FIRST+4,AUTO
          1 0004B5  9CC7 0030                            LDB,B1   ENTRY$,AUTO
          1 0004B7  CBF0 0100                            LAB,B4   256,IMO
          1 0004B9  E381                                 LNJ,B6   ,B1
          1 0004BA       003C                            DC       s:11705,PREL

      511    11684
      512    11685        /* Check to see if the acknowledgement was an acceptence */
      513    11686    3         IF FPT_CONNECT_ACK.REASON ~= 0    /* Some error                         */

  11686   1 0004BB  ECC7 002C                            LDB,B6   FPT$,AUTO
          1 0004BD  E806                                 LDR,R6   ,B6
          1 0004BE  6901 0013                            BEZ,R6   s:11692,PREL

      514    11687    4         THEN DO;

      515    11688    4            IF KN$NETPARM.LDCT$ ~= ADDR(NIL)

  11688   1 0004C0  8DC7 0008                            CMN      KN$NETPARM,AUTO
          1 0004C2  0901 00B5                            BE       s:11760,PREL

      516    11689    4            THEN CALL KNA$RLSLDCT(KN$NETPARM.LDCT$);

PL6.E3A0      #001=KNH$SCAN File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:03 Page:71   
  11689   1 0004C4  DBC7 0008                            LAB,B5   KN$NETPARM,AUTO
          1 0004C6  DFC7 003A                            STB,B5   FIRST+4,AUTO
          1 0004C8  BBC7 003A                            LAB,B3   FIRST+4,AUTO
          1 0004CA  CBF0 0100                            LAB,B4   256,IMO
          1 0004CC  E380 0000 0000  xent                 LNJ,B6   KNA$RLSLDCT
          1 0004CF       0001                            DC       s:11690,PREL

      517    11690    4         END;

  11690   1 0004D0  0F81 00A7                            B        s:11760,PREL

      518    11691    3         ELSE
      519    11692    3         KNH$HMI.LDCTS# = KNH$HMI.LDCTS# + 1;

  11692   1 0004D2  DCC7 0033                            LDB,B5   HMI$,AUTO
          1 0004D4  8AC5 0018                            INC      24,B5
          1 0004D6  0F81 00A1                            B        s:11760,PREL

      520    11693
      521    11694
      522    11695
      523    11696        %EJECT;
PL6.E3A0      #001=KNH$SCAN File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:03 Page:72   
      524    11697    3      CASE (%KN_FCN_TERM);

  11692   1                              DO$DATA         null
      525    11698    3   DO$DATA:;
      526    11699    3         CALL ENTRY$ (KN$NETPARM) ALTRET(L_ALT);

  11699   1 0004D8  EBC7 0008            DO$DATA         LAB,B6   KN$NETPARM,AUTO
          1 0004DA  EFC7 003A                            STB,B6   FIRST+4,AUTO
          1 0004DC  BBC7 003A                            LAB,B3   FIRST+4,AUTO
          1 0004DE  9CC7 0030                            LDB,B1   ENTRY$,AUTO
          1 0004E0  CBF0 0100                            LAB,B4   256,IMO
          1 0004E2  E381                                 LNJ,B6   ,B1
          1 0004E3       0013                            DC       s:11705,PREL

      527    11700    3         RETURN;

  11700   1 0004E4  ECC7 0038                            LDB,B6   FIRST+2,AUTO
          1 0004E6  C3C6 0001                            LNJ,B4   1,B6

      528    11701
      529    11702        %EJECT;
PL6.E3A0      #001=KNH$SCAN File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:03 Page:73   
      530    11703    3      CASE (%KN_FCN_TERM_ACK);

      531    11704    3         CALL ENTRY$ (KN$NETPARM) WHENALTRETURN

  11704   1 0004E8  EBC7 0008                            LAB,B6   KN$NETPARM,AUTO
          1 0004EA  EFC7 003A                            STB,B6   FIRST+4,AUTO
          1 0004EC  BBC7 003A                            LAB,B3   FIRST+4,AUTO
          1 0004EE  9CC7 0030                            LDB,B1   ENTRY$,AUTO
          1 0004F0  CBF0 0100                            LAB,B4   256,IMO
          1 0004F2  E381                                 LNJ,B6   ,B1
          1 0004F3       0003                            DC       s:11705,PREL
          1 0004F4  0F81 0018                            B        s:11716,PREL

      532    11705    4         DO ;

  11692   1                              L_ALT           null
      533    11706    4   L_ALT:   ;
      534    11707    4            IF KN$NETPARM.ERRCODE = %KN_ERR_INVFCN

  11707   1 0004F6  E847 001E            L_ALT           LDR,R6   KN$NETPARM+22,AUTO
          1 0004F8  6D02                                 CMV,R6   2
          1 0004F9  0981 0009                            BNE      s:11711,PREL

      535    11708    4            THEN
      536    11709    4            ERR = INVFUN;

  11709   1 0004FB  8C80 0000 0015  00                   LDI      INVFUN
          1 0004FE  ECC7 0006                            LDB,B6   @ERR,AUTO
          1 000500  8D06                                 SDI      ,B6
          1 000501  0F81 0007                            B        s:11712,PREL

      537    11710    4            ELSE
      538    11711    4            ERR = CQFUL;

  11711   1 000503  8C80 0000 000F  00                   LDI      CQFUL
          1 000506  ECC7 0006                            LDB,B6   @ERR,AUTO
          1 000508  8D06                                 SDI      ,B6
PL6.E3A0      #001=KNH$SCAN File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:03 Page:74   

      539    11712    4            ALTRETURN;

  11712   1 000509  ECC7 0038                            LDB,B6   FIRST+2,AUTO
          1 00050B  B806                                 LDR,R3   ,B6
          1 00050C  C3B6                                 LNJ,B4   ,B6,R3

      540    11713    4         END;
      541    11714
      542    11715        /* Release the LDCT */
      543    11716    3         CALL KNA$RLSLDCT (KN$NETPARM.LDCT$);

  11716   1 00050D  EBC7 0008                            LAB,B6   KN$NETPARM,AUTO
          1 00050F  EFC7 003A                            STB,B6   FIRST+4,AUTO
          1 000511  BBC7 003A                            LAB,B3   FIRST+4,AUTO
          1 000513  CBF0 0100                            LAB,B4   256,IMO
          1 000515  E380 0000 0000  xent                 LNJ,B6   KNA$RLSLDCT
          1 000518       0001                            DC       s:11717,PREL

      544    11717    3         KNH$HMI.LDCTS# = KNH$HMI.LDCTS# - 1;

  11717   1 000519  ECC7 0033                            LDB,B6   HMI$,AUTO
          1 00051B  88C6 0018                            DEC      24,B6
          1 00051D  0F81 005A                            B        s:11760,PREL

      545    11718
      546    11719        %EJECT;
PL6.E3A0      #001=KNH$SCAN File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:03 Page:75   
      547    11720    3      CASE (%KN_FCN_LOOP);

      548    11721    3         KN$NETPARM.FUNCTION = %KN_FCN_DATA;

  11721   1 00051F  3C05                                 LDV,R3   5
          1 000520  BF47 001C                            STR,R3   KN$NETPARM+20,AUTO

      549    11722    3         KN$NETPARM.LDCT$ = ADDR(KNH$MESS);

  11722   1 000522  ECC7 002A                            LDB,B6   MSG$,AUTO
          1 000524  EFC7 0008                            STB,B6   KN$NETPARM,AUTO

      550    11723    3         CALL KNH$SEND_LOOP (KN$NETPARM)

  11723   1 000526  ABC7 0008                            LAB,B2   KN$NETPARM,AUTO
          1 000528  AFC7 003A                            STB,B2   FIRST+4,AUTO
          1 00052A  BBC7 003A                            LAB,B3   FIRST+4,AUTO
          1 00052C  CBF0 0100                            LAB,B4   256,IMO
          1 00052E  E380 0000 0000  xent                 LNJ,B6   KNH$SEND_LOOP
          1 000531       0003                            DC       s:11725,PREL
          1 000532  0F81 000B                            B        s:11726+4,PREL

      551    11724    4         WHENALTRETURN DO;

      552    11725    4            ERR = CQFUL;

  11725   1 000534  8C80 0000 000F  00                   LDI      CQFUL
          1 000537  ECC7 0006                            LDB,B6   @ERR,AUTO
          1 000539  8D06                                 SDI      ,B6

      553    11726    4            ALTRETURN;

  11726   1 00053A  ECC7 0038                            LDB,B6   FIRST+2,AUTO
          1 00053C  B806                                 LDR,R3   ,B6
          1 00053D  C3B6                                 LNJ,B4   ,B6,R3
          1 00053E  0F81 0039                            B        s:11760,PREL

PL6.E3A0      #001=KNH$SCAN File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:03 Page:76   
      554    11727    4         END;
      555    11728
      556    11729        %EJECT;
PL6.E3A0      #001=KNH$SCAN File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:03 Page:77   
      557    11730    3      CASE(%KN_FCN_BLOCK,%KN_FCN_UNBLOCK);

      558    11731        /*
      559    11732             a block message from the link(specifically hdlc) layer.  Indicates
      560    11733             that this path is blocked and should be rerouted, if possible.
      561    11734        */
      562    11735        /*
      563    11736             an unblock message from the link layer(specifically hdlc). Indicates that this
      564    11737             path is now unblocked.
      565    11738        */
      566    11739    3         IF KN$LDCT.CONN_TYPE~=%KN_CNTYPE_CIRCUIT /* can't unblock class A       */

  11739   1 000540  9282                                 LLH,R1   ,B2
          1 000541  1D07                                 CMV,R1   7
          1 000542  0901 0035                            BE       s:11760,PREL

      567    11740    3         THEN CALL ENTRY$(KN$NETPARM);

  11740   1 000544  EBC7 0008                            LAB,B6   KN$NETPARM,AUTO
          1 000546  EFC7 003A                            STB,B6   FIRST+4,AUTO
          1 000548  BBC7 003A                            LAB,B3   FIRST+4,AUTO
          1 00054A  9CC7 0030                            LDB,B1   ENTRY$,AUTO
          1 00054C  CBF0 0100                            LAB,B4   256,IMO
          1 00054E  E381                                 LNJ,B6   ,B1
          1 00054F       0001                            DC       s:11740+12,PREL
          1 000550  0F81 0027                            B        s:11760,PREL

      568    11741         /* doesn't altet */
      569    11742
      570    11743    3      CASE(%KN_FCN_RESET);

      571    11744        /*
      572    11745             a reset function was indicated on a link line.  convert function to osi
      573    11746        */
      574    11747    3         KN$NETPARM.FUNCTION = %K_NRESET_IND;

  11747   1 000552  3C23                                 LDV,R3   35
PL6.E3A0      #001=KNH$SCAN File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:03 Page:78   
          1 000553  BF47 001C                            STR,R3   KN$NETPARM+20,AUTO

      575    11748    3         CALL KNT$RECV_4HOST(KN$NETPARM);

  11748   1 000555  EBC7 0008                            LAB,B6   KN$NETPARM,AUTO
          1 000557  EFC7 003A                            STB,B6   FIRST+4,AUTO
          1 000559  BBC7 003A                            LAB,B3   FIRST+4,AUTO
          1 00055B  CBF0 0100                            LAB,B4   256,IMO
          1 00055D  E380 0000 0000  xent                 LNJ,B6   KNT$RECV_4HOST
          1 000560       0001                            DC       s:11748+12,PREL
          1 000561  0F81 0016                            B        s:11760,PREL

      576    11749
      577    11750    3     CASE(%KN_FCN_EXPEDITED_DATA,%KN_FCN_EXPEDITED_DATA_ACK,%KN_FCN_EXPEDITED_DATA_NAK
             11750               );

      578    11751    3         CALL SCREECH (BADMFMT);

  11751   1 000563  BB80 0000 0005  02                   LAB,B3   +5
          1 000566  CBF0 0100                            LAB,B4   256,IMO
          1 000568  E380 0000 0000  xent                 LNJ,B6   SCREECH
          1 00056B       0001                            DC       s:11751+9,PREL
          1 00056C  0F81 000B                            B        s:11760,PREL

      579    11752
      580    11753        %EJECT;
PL6.E3A0      #001=KNH$SCAN File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:03 Page:79   
      581    11754    3      CASE (ELSE);

      582    11755    3         ERR = BADMFMT;

  11755   1 00056E  8C80 0000 0005  00                   LDI      BADMFMT
          1 000571  ECC7 0006                            LDB,B6   @ERR,AUTO
          1 000573  8D06                                 SDI      ,B6

      583    11756    3         ALTRETURN;

  11756   1 000574  ECC7 0038                            LDB,B6   FIRST+2,AUTO
          1 000576  A806                                 LDR,R2   ,B6
          1 000577  C3A6                                 LNJ,B4   ,B6,R2

      584    11757
      585    11758    3      END;                                 /* End cases                          */

      586    11759
      587    11760    2   END DO$MSG;

  11760   1 000578  ECC7 0038                            LDB,B6   FIRST+2,AUTO
          1 00057A  C3C6 0001                            LNJ,B4   1,B6
      588    11761
      589    11762    1   END KNH$SCAN;
      590    11763        %EOD;

PL6.E3A0      #001=KNH$SCAN File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:03 Page:80   
--  Include file information  --

   K_SCODE_C.:E05TOU  is referenced.
   K_INTERFACE_M.:E05TOU  is referenced.
   KL_MACRO_C.:E05TOU  is referenced.
   KI_CP6.:E05TOU  is referenced.
   GH_SCHD_M.:E05TOU  is referenced.
   GH_SCHD_E.:E05TOU  is referenced.
   G_JIT_M.:E05TOU  is referenced.
   GH_LCP6_M.:E05TOU  is referenced.
   KN_ERRORS_C.:E05TOU  is referenced.
   GU_LCP6_M.:E05TOU  is referenced.
   KNH_MACRO_C.:E05TOU  is referenced.
   KN_DATA_M.:E05TOU  is referenced.
   GH_GATE_M.:E05TOU  cannot be made into a system file and is referenced.
      No diagnostics issued in procedure KNH$SCAN.
PL6.E3A0      #001=KNH$SCAN File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:03 Page:81   

 **** Variables and constants ****

  ****  Section 000 RoData KNH$SCAN

  ****  Scalars and arrays  ****
HexLoc.c.b A Datatyp(siz) R M Lvl/name                 HexLoc.c.b A Datatyp(siz) R M Lvl/name

     0-0-0/w STRC(48)    r     1 BADLDCT                    5-0-0/w STRC(32)    r     1 BADMFMT
     B-0-0/w STRC(32)    r     1 BADSCQFMT                  F-0-0/w STRC(32)    r     1 CQFUL
    13-0-0/w STRC(32)    r     1 HMIBUSY                    9-0-0/w STRC(32)    r     1 ILGCTYPE
     7-0-0/w STRC(32)    r     1 ILLDCT                    15-0-0/w STRC(32)    r     1 INVFUN
     3-0-0/w STRC(32)    r     1 NOLDCT                    11-0-0/w STRC(32)    r     1 NORES

  ****  Auto variables  ****

  ****  Scalars and arrays  ****
HexLoc.c.b A Datatyp(siz) R M Lvl/name                 HexLoc.c.b A Datatyp(siz) R M Lvl/name

     4-0-0/w PTR         r     1 @BUF$                      6-0-0/w PTR         r     1 @ERR
    *0-0-0/w PTR         r     1 BUF$                      30-0-0/w EPTR        r     1 ENTRY$
    *0-0-0/w STRC(32)    r     1 ERR                       36-0-0/b BIT         r     1 FIRST
    2C-0-0/w PTR         r     1 FPT$                      2F-0-0/w SBIN(16)    r     1 FPTSIZE
    33-0-0/w PTR         r     1 HMI$                       8-0-0/w STRC(528)   r     1 KN$NETPARM
    2A-0-0/w PTR         r     1 MSG$                      29-0-0/w UBIN(16)    r     1 MSGSZ
    35-0-0/w UBIN(16)    r     1 MYRPTR                    2E-0-0/w SBIN(16)    r     1 SCANSZ

  ****  SYMREF variables  ****

  ****  Scalars and arrays  ****
HexLoc.c.b A Datatyp(siz) R M Lvl/name                 HexLoc.c.b A Datatyp(siz) R M Lvl/name

     0-0-0/w PTR         r     1 G$HAND_Q$                  0-0-0/w PTR         r     1 G$JIT$
     0-0-0/w PTR         r     1 G$USRT$                    0-0-0/w PTR         r     1 KN_DCT$$
     0-0-0/w STRC(528)   r     1 KN_NETPARM_INIT            0-0-0/w UBIN(16)    r     1 KN_NODE#

  ****  BASED and DCB variables  ****

PL6.E3A0      #001=KNH$SCAN File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:03 Page:82   
  ****  Scalars and arrays  ****
HexLoc.c.b A Datatyp(siz) R M Lvl/name                 HexLoc.c.b A Datatyp(siz) R M Lvl/name

     0-0-0/w STRC(304)   r     1 FPT_CONNECT                0-0-0/w STRC(96)    r     1 FPT_CONNECT_ACK
     0-0-0/w STRC(5616)  r     1 G$JIT                      0-0-0/w STRC(384)   r     1 G$USER(0:0)
     0-0-0/w PTR         r     1 KN$DCT$(0:0)
     0-0-0/w STRC(256)   r     1 KN$LDCT                    0-0-0/c STRC(400)   r     1 KNH$HMI
     0-0-0/c STRC(128)   r     1 KNH$MESS                   0-0-0/w STRC(384)   r     1 KNH$QHDR


   Procedure KNH$SCAN requires 1404 words for executable code.
   Procedure KNH$SCAN requires 62 words of local(AUTO) storage.
PL6.E3A0      #001=KNH$SCAN File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:03 Page:83   
          *** CROSS REFERENCE LISTING ***
**     DENOTES     IDENTIFIER DEFINITION
<<                 IDENTIFIER'S VALUE SET
>>                 IDENTIFIER'S VALUE USED
<>                 IDENTIFIER SET AND/OR USED
--                 IDENTIFIER REFERENCED
PL6.E3A0      #001=KNH$SCAN File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:03 Page:84   
          MINI XREF LISTING

BADLDCT
     10711**DCL     11584<>CALL
BADLDCTSCR IN PROCEDURE DO$MSG
     11577**LABEL   11580--GOTO
BADMFMT
     10816**DCL     11365>>ASSIGN  11437>>ASSIGN  11607>>ASSIGN  11751<>CALL    11755>>ASSIGN
BADSCQFMT
     10970**DCL     11339>>ASSIGN
BUF$
      9460**DCL        26--PROC    11491--ENTRY   11495>>ASSIGN
CHECK_RCQ
     11442**LABEL   11328--GOTO    11351--GOTO    11515--GOTO
CLOSING
     11445**LABEL   11286--GOTO
CQFUL
     11071**DCL     11327>>ASSIGN  11551>>ASSIGN  11711>>ASSIGN  11725>>ASSIGN
DO$DATA IN PROCEDURE DO$MSG
     11692**LABEL   11599--GOTO
DO$MSG
     11527**PROC    11379--CALL    11506--CALL
ENTRY$
     10665**DCL     11564<<ASSIGN  11567<<ASSIGN  11572<<ASSIGN  11577<<ASSIGN  11683>>CALL    11699>>CALL
     11704>>CALL    11740>>CALL
ERR
      9428**DCL        26--PROC    11300<<ASSIGN  11327<<ASSIGN  11339<<ASSIGN  11365<<ASSIGN  11437<<ASSIGN
     11491--ENTRY   11551<<ASSIGN  11594<<ASSIGN  11607<<ASSIGN  11621<<ASSIGN  11629<<ASSIGN  11639<<ASSIGN
     11673<<ASSIGN  11709<<ASSIGN  11711<<ASSIGN  11725<<ASSIGN  11755<<ASSIGN
ERR.ERR#
      9457**DCL     11385>>IF
FIRST
     10669**DCL     11353<<ASSIGN  11384<<ASSIGN  11413>>IF      11421>>IF
FPT$
PL6.E3A0      #001=KNH$SCAN File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:03 Page:85   
     10662**DCL      9784--IMP-PTR  9853--IMP-PTR  9902--IMP-PTR 11530<<ASSIGN  11536>>ASSIGN  11600>>ASSIGN
     11611>>ASSIGN  11613>>DOSELCT 11626>>ASSIGN  11648>>ASSIGN  11650>>DOCASE  11658>>ASSIGN  11686>>IF
FPTSIZE
     10664**DCL     11360<<ASSIGN  11361>>ASSIGN  11496<<ASSIGN  11497>>ASSIGN  11536>>ASSIGN  11600>>IF
     11658>>ASSIGN
FPT_CONNECT
      9784**DCL     11605--IF
FPT_CONNECT.RESOURCE
      9790**DCL     11613>>DOSELCT
FPT_CONNECT.RLCID.GENERATION
      9820**DCL      9821--REDEF
FPT_CONNECT.RLCID.LDCTX
      9821**DCL      9821--REDEF
FPT_CONNECT.RLCID.NODE
      9820**DCL     11626<<ASSIGN
FPT_CONNECT.TERMINAL_ID.TERM
      9809**DCL      9818--REDEF
FPT_CONNECT.TYPE
      9788**DCL     11648>>ASSIGN  11650>>DOCASE
FPT_CONNECT.USER.SYSID
      9822**DCL     11611<<ASSIGN
FPT_CONNECT_ACK.REASON
      9857**DCL     11686>>IF
FPT_CONNECT_ACK.UID.UID
      9883**DCL      9883--REDEF    9883--REDEF
G$HAND_Q$
     10503**DCL      9709--IMP-PTR 11320>>IF      11320>>IF      11332>>ASSIGN  11333>>ASSIGN  11355>>ASSIGN
     11415>>ASSIGN  11415>>ASSIGN  11424>>ASSIGN  11426>>ASSIGN  11426>>ASSIGN  11427>>ASSIGN  11427>>ASSIGN
     11431>>ASSIGN  11442>>IF      11442>>IF      11442>>IF      11456>>IF      11477>>ASSIGN
G$JIT.ERRLOG
     10275**DCL     10278--REDEF
G$JIT.JSUNIT
     10014**DCL     10015--REDEF
G$JIT.MCLS
     10013**DCL     10013--REDEF
G$JIT.SYSID
PL6.E3A0      #001=KNH$SCAN File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:03 Page:86   
     10003**DCL     11611>>ASSIGN
G$JIT.TMRZ
     10282**DCL     10283--REDEF
G$JIT.USER_EXTIME
     10006**DCL     10007--REDEF
G$JIT.USER_MEMTIME
     10009**DCL     10009--REDEF
G$JIT.USER_SVTIME
     10008**DCL     10008--REDEF
G$JIT.USR#
     10003**DCL     11271>>ASSIGN  11442>>IF      11445>>ASSIGN  11494>>ASSIGN  11555>>IF      11618>>IF
     11644>>ASSIGN
G$JIT$
     10502**DCL      9945--IMP-PTR 11271>>ASSIGN  11442>>IF      11445>>ASSIGN  11494>>ASSIGN  11555>>IF
     11611>>ASSIGN  11618>>IF      11644>>ASSIGN
G$USER.HMI$
      9929**DCL     11271>>ASSIGN  11494>>ASSIGN
G$USER.MISC
      9926**DCL      9926--REDEF
G$USER.US
      9926**DCL     11442>>IF
G$USRT$
     10504**DCL      9925--IMP-PTR 11271>>ASSIGN  11442>>IF      11494>>ASSIGN
GHH$LOCK
        69**DCL-ENT 11284--CALL    11295--CALL    11375--CALL    11454--CALL    11504--CALL
GHH$UNLOCK
        69**DCL-ENT 11306--CALL    11316--CALL    11393--CALL    11406--CALL    11484--CALL    11513--CALL
     11522--CALL
GHS$RUE
     10680**DCL-ENT 11446--CALL
HMI$
     10667**DCL      9914--IMP-PTR 11271<<ASSIGN  11273>>IF      11277>>IF      11284>>CALL    11295>>CALL
     11297>>IF      11306>>CALL    11310>>ASSIGN  11316>>CALL    11320>>IF      11320>>IF      11320>>IF
     11325>>IF      11325>>IF      11331>>ASSIGN  11332>>ASSIGN  11333>>ASSIGN  11335>>IF      11335>>IF
     11335>>IF      11335>>IF      11340>>ASSIGN  11346>>ASSIGN  11346>>ASSIGN  11350>>ASSIGN  11354>>ASSIGN
     11355>>ASSIGN  11362>>IF      11366>>ASSIGN  11375>>CALL    11387>>ASSIGN  11393>>CALL    11406>>CALL
PL6.E3A0      #001=KNH$SCAN File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:03 Page:87   
     11409>>IF      11423>>ASSIGN  11431>>ASSIGN  11438>>ASSIGN  11454>>CALL    11456>>IF      11460>>DOWHILE
     11462>>ASSIGN  11465>>ASSIGN  11467>>ASSIGN  11467>>ASSIGN  11477>>ASSIGN  11484>>CALL    11487>>ASSIGN
     11494<<ASSIGN  11504>>CALL    11513>>CALL    11522>>CALL    11692>>ASSIGN  11692>>ASSIGN  11717>>ASSIGN
     11717>>ASSIGN
HMIBUSY
     11174**DCL     11300>>ASSIGN
ILGCTYPE
     10919**DCL     11673>>ASSIGN
ILLDCT
     10868**DCL     11594>>ASSIGN
ILLDCTERR IN PROCEDURE DO$MSG
     11583**LABEL   11557--GOTO    11585--GOTO
INVFUN
     11229**DCL     11709>>ASSIGN
KN$DCT$
      9911**DCL     11543>>ASSIGN
KN$LDCT
      9478**DCL     11546--IF
KN$LDCT.CONN_TYPE
      9479**DCL     11559>>DOCASE  11648<<ASSIGN  11739>>IF
KN$LDCT.CQPTR
      9701**DCL     11398>>IF      11399<<ASSIGN  11547>>IF      11548>>IF      11549<<ASSIGN
KN$LDCT.FLAGS.QUEUED
      9655**DCL     11464<<ASSIGN  11548>>IF      11662>>IF
KN$LDCT.FLAGS.REL
      9663**DCL     11472>>IF
KN$LDCT.LDCTX
      9620**DCL     11647>>ASSIGN
KN$LDCT.LNK$
      9624**DCL     11465>>ASSIGN  11466<<ASSIGN
KN$LDCT.RLCID.LDCTX
      9539**DCL      9546--REDEF    9554--REDEF
KN$LDCT.STATE
      9493**DCL     11570>>IF      11573>>IF
KN$LDCT.TRANSPORT_ID
      9573**DCL      9581--REDEF
PL6.E3A0      #001=KNH$SCAN File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:03 Page:88   
KN$LDCT.UID
      9603**DCL      9604--REDEF    9613--REDEF   11643<<ASSIGN  11681<<ASSIGN
KN$LDCT.USER#
      9696**DCL     11555>>IF      11644<<ASSIGN
KN$LDCT.USER_ENTRY$
      9684**DCL     11469>>IF      11470>>CALL    11645<<ASSIGN
KN$NETPARM
     10520**DCL     11461<<ASSIGN  11470<>CALL    11529<<ASSIGN  11653<>CALL    11659<>CALL    11683<>CALL
     11699<>CALL    11704<>CALL    11723<>CALL    11740<>CALL    11748<>CALL
KN$NETPARM.ERRCODE
     10627**DCL     11707>>IF
KN$NETPARM.FPT$
     10639**DCL     11600<<ASSIGN
KN$NETPARM.FUNCTION
     10615**DCL     11463<<ASSIGN  11542<<ASSIGN  11570>>IF      11589>>IF      11589>>IF      11599>>IF
     11601>>DOCASE  11721<<ASSIGN  11747<<ASSIGN
KN$NETPARM.LDCT$
     10521**DCL      9478--IMP-PTR 11462<<ASSIGN  11464>>ASSIGN  11465>>ASSIGN  11466>>ASSIGN  11469>>IF
     11470>>CALL    11472>>IF      11474<>CALL    11543<<ASSIGN  11544>>ASSIGN  11546>>IF      11547>>IF
     11548>>IF      11548>>IF      11549>>ASSIGN  11555>>IF      11559>>DOCASE  11570>>IF      11573>>IF
     11635>>IF      11637<>CALL    11643>>ASSIGN  11644>>ASSIGN  11645>>ASSIGN  11646>>ASSIGN  11647>>ASSIGN
     11648>>ASSIGN  11672<>CALL    11681>>ASSIGN  11688>>IF      11689<>CALL    11716<>CALL    11722<<ASSIGN
     11739>>IF
KN$NETPARM.MSG$
     10527**DCL     10532--REDEF
KN$NETPARM.NHDR$
     10579**DCL     10580--REDEF   11537<<ASSIGN  11575>>ASSIGN
KN$NETPARM.NHDRSZ
     10585**DCL     11535<<ASSIGN  11576>>ASSIGN
KN$NETPARM.RECTYPE
     10606**DCL     11541<<ASSIGN
KN$NETPARM.SHDR$
     10557**DCL     10558--REDEF
KN$NETPARM.SLDCT$
     10634**DCL     11397>>IF      11398>>IF      11399>>ASSIGN  11544<<ASSIGN  11646<<ASSIGN  11662>>IF
     11665<>CALL
PL6.E3A0      #001=KNH$SCAN File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:03 Page:89   
KN$NETPARM.THDR$
     10568**DCL     10569--REDEF   11575<<ASSIGN
KN$NETPARM.THDRSZ
     10574**DCL     11576<<ASSIGN
KN$NETPARM.UHDR$
     10543**DCL     10544--REDEF   11536<<ASSIGN  11537>>ASSIGN  11658<<ASSIGN
KN$NETPARM.UHDRSZ
     10552**DCL     11534<<ASSIGN  11535>>ASSIGN  11656>>IF
KNA$GETLDCT
     10672**DCL-ENT 11637--CALL
KNA$RLSLDCT
     10673**DCL-ENT 11474--CALL    11665--CALL    11672--CALL    11689--CALL    11716--CALL
KNH$HMI.LDCTS#
      9918**DCL     11692<<ASSIGN  11692>>ASSIGN  11717<<ASSIGN  11717>>ASSIGN
KNH$HMI.RCQ.LOCK
      9914**DCL     11284<>CALL    11454<>CALL    11484<>CALL
KNH$HMI.RCQ.RPTR
      9914**DCL     11456>>IF      11477<<ASSIGN
KNH$HMI.SCQ.BUSY
      9916**DCL     11297>>IF      11310<<ASSIGN  11340<<ASSIGN  11366<<ASSIGN  11387<<ASSIGN  11438<<ASSIGN
     11487<<ASSIGN
KNH$HMI.SCQ.CLOSING
      9916**DCL     11277>>IF
KNH$HMI.SCQ.IPTR
      9915**DCL     11320>>IF      11325>>IF      11332<<ASSIGN  11335>>IF      11346>>ASSIGN
KNH$HMI.SCQ.LOCK
      9916**DCL     11295<>CALL    11306<>CALL    11316<>CALL    11375<>CALL    11393<>CALL    11406<>CALL
     11504<>CALL    11513<>CALL    11522<>CALL
KNH$HMI.SCQ.OFFSET
      9915**DCL     11355>>ASSIGN  11431>>ASSIGN
KNH$HMI.SCQ.RPTR
      9915**DCL     11320>>IF      11325>>IF      11333<<ASSIGN  11335>>IF      11346>>ASSIGN  11354>>ASSIGN
     11423<<ASSIGN
KNH$HMI.SCQ.SCANNED
      9916**DCL     11320>>IF      11331<<ASSIGN
KNH$HMI.SCQ.SZ
PL6.E3A0      #001=KNH$SCAN File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:03 Page:90   
      9915**DCL     11335>>IF      11335>>IF      11350>>ASSIGN  11362>>IF      11409>>IF
KNH$HMI.WAIT_COUNT
      9917**DCL     11460>>DOWHILE 11467<<ASSIGN  11467>>ASSIGN
KNH$HMI.WAIT_HEAD$
      9917**DCL     11462>>ASSIGN  11465<<ASSIGN
KNH$MESS
      9734**DCL     11361--ASSIGN  11497--ASSIGN  11530--ASSIGN  11531--IF      11722--ASSIGN
KNH$MESS.FLAGS.FREE
      9739**DCL     11356<<ASSIGN  11377>>IF      11381<<ASSIGN
KNH$MESS.FPTSZ
      9767**DCL     11360>>ASSIGN  11496>>ASSIGN  11605>>IF
KNH$MESS.FUNCTION
      9734**DCL      9734--REDEF   11377>>IF      11542>>ASSIGN
KNH$MESS.LDCTX
      9739**DCL     11543>>ASSIGN  11647<<ASSIGN  11666<<ASSIGN
KNH$MESS.MSGSZ
      9768**DCL     11361>>ASSIGN  11497>>ASSIGN  11534>>ASSIGN
KNH$MESS.RECTYPE
      9767**DCL     11541>>ASSIGN
KNH$MESS.UID
      9764**DCL      9764--REDEF    9764--REDEF   11643>>ASSIGN  11681>>ASSIGN
KNH$QHDR.CTX.WU
      9717**DCL     11442>>IF
KNH$QHDR.MBC_SCQ
      9717**DCL     11427<<ASSIGN  11427>>ASSIGN
KNH$QHDR.MSGS_SCQ
      9717**DCL     11426<<ASSIGN  11426>>ASSIGN
KNH$QHDR.RCQ
      9709**DCL      9709--REDEF
KNH$QHDR.RCQ.RPTR
      9709**DCL     11456>>IF      11477>>ASSIGN
KNH$QHDR.SCQ.IPTR
      9710**DCL     11320>>IF      11332>>ASSIGN  11442>>IF
KNH$QHDR.SCQ.RPTR
      9710**DCL     11320>>IF      11333>>ASSIGN  11424<<ASSIGN  11442>>IF
KNH$QHDR.WRAP_SCQ
PL6.E3A0      #001=KNH$SCAN File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:03 Page:91   
      9717**DCL     11415<<ASSIGN  11415>>ASSIGN
KNH$SEND
     10674**DCL-ENT 11645--ASSIGN
KNH$SEND_LOOP
     10675**DCL-ENT 11723--CALL
KNN$RECV
     10676**DCL-ENT 11567--ASSIGN  11572--ASSIGN  11659--CALL
KNS$SEND
     10677**DCL-ENT 11564--ASSIGN  11653--CALL
KNT$RECV_4HOST
     10678**DCL-ENT 11577--ASSIGN  11748--CALL
KN_DCT$$
     10500**DCL      9911--IMP-PTR 11543>>ASSIGN
KN_NETPARM_INIT
     10360**DCL     11461>>ASSIGN  11529>>ASSIGN
KN_NETPARM_INIT.MSG$
     10367**DCL     10372--REDEF
KN_NETPARM_INIT.NHDR$
     10419**DCL     10420--REDEF
KN_NETPARM_INIT.SHDR$
     10397**DCL     10398--REDEF
KN_NETPARM_INIT.THDR$
     10408**DCL     10409--REDEF
KN_NETPARM_INIT.UHDR$
     10383**DCL     10384--REDEF
KN_NODE#
     10501**DCL     11626>>ASSIGN
L_ALT IN PROCEDURE DO$MSG
     11692**LABEL   11668--GOTO    11683--CALLALT 11699--CALLALT
MSG$
     10661**DCL      9734--IMP-PTR 11355<<ASSIGN  11356>>ASSIGN  11360>>ASSIGN  11361>>ASSIGN  11377>>IF
     11377>>IF      11381>>ASSIGN  11431<<ASSIGN  11495<<ASSIGN  11496>>ASSIGN  11497>>ASSIGN  11530>>ASSIGN
     11534>>ASSIGN  11541>>ASSIGN  11542>>ASSIGN  11543>>ASSIGN  11605>>IF      11643>>ASSIGN  11647>>ASSIGN
     11666>>ASSIGN  11681>>ASSIGN  11722>>ASSIGN
MSGSZ
     10660**DCL     11361<<ASSIGN  11362>>IF      11408>>ASSIGN  11420>>ASSIGN  11427>>ASSIGN  11497<<ASSIGN
PL6.E3A0      #001=KNH$SCAN File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:03 Page:92   
     11531>>IF
MYRPTR
     10668**DCL     11354<<ASSIGN  11355>>ASSIGN  11362>>IF      11399>>ASSIGN  11408<<ASSIGN  11408>>ASSIGN
     11409>>IF      11412<<ASSIGN  11423>>ASSIGN  11424>>ASSIGN  11431>>ASSIGN  11445<<ASSIGN  11446<>CALL
     11498<<ASSIGN  11548>>IF
NOLDCT
     10766**DCL     11639>>ASSIGN
NORES
     11122**DCL     11621>>ASSIGN  11629>>ASSIGN
REL_LDCT IN PROCEDURE DO$MSG
     11658**LABEL   11653--CALLALT
SCANSZ
     10663**DCL     11346<<ASSIGN  11348>>IF      11350<<ASSIGN  11350>>ASSIGN  11351>>IF      11420<<ASSIGN
     11420>>ASSIGN  11430>>IF      11434>>IF
SCREECH
     10679**DCL-ENT 11584--CALL    11751--CALL

PL6.E3A0      #002=KNH$SEND File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:04 Page:93   
      591        1        /*T***********************************************************/
      592        2        /*T*                                                         */
      593        3        /*T* Copyright (c) Bull HN Information Systems Inc., 1997    */
      594        4        /*T*                                                         */
      595        5        /*T***********************************************************/
      596        6        /*X*     NSO,PLM=3,SQB=Y,AND=Y,ENI=0,SDI=3,MCL=10,CSI=0,ECI=0,IAD=3,IND=0 */
      597        7        /*F*
      598        8             NAME: KNH$SEND
      599        9             PURPOSE:
      600       10                  T receive data and commands from Network and Session.
      601       11             DESCRIPTION:
      602       12                  This routine will get called from Session or Network
      603       13                  when ever there is an interaction needed with a handler.
      604       14        */
      605       15
      606       16        KNH$SEND: PROC (KN$NETPARM) ALTRET;
      607       17
      608       18        /* Include files */
      609       19        %INCLUDE KN_DATA_M;
      610     1805        %INCLUDE KNH_MACRO_C;
      611     2088        %INCLUDE KN_ERRORS_C;
      612     2152        %INCLUDE GH_LCP6_M;
      613     2986        %INCLUDE GH_SCHD_E;
      614     3082        %INCLUDE GH_SCHD_M;
      615     3226        %INCLUDE GU_LCP6_M;
      616     4154        %INCLUDE G_JIT_M;
      617     4419        %INCLUDE G_HJIT_M;
      618     4564        %INCLUDE GH_GATE_M;
      619     4605        %INCLUDE KL_MACRO_C;
      620     7957        %INCLUDE KI_CP6;
      621     9053        %INCLUDE K_ADDRESS_M;
      622     9556        %INCLUDE K_SCODE_C;
      623     9641        %INCLUDE K_INTERFACE_M;
      624    10050
      625    10051        /* Paramter definitions */
      626    10052        %KN$NETPARM;
      627    10205
PL6.E3A0      #002=KNH$SEND File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:04 Page:94   
      628    10206        /* Based structures */
      629    10207        %KN$LDCT (STCLASS="BASED(KN$NETPARM.LDCT$)");
      630    10452        %KNH$QHDR (STCLASS="BASED(G$WINDOW1$)");
      631    10465        %FPT_CONNECT_ACK (STCLASS=BASED);
      632    10514        %FPT_CONNECT (STCLASS=BASED);
      633    10583        %FPT_CONNECT(FPTN=FPT_CONNECT_CIRCUIT,STCLASS=BASED,ADRTYP=NET);
      634    10754        %FPT_NSAP;
      635    10826        %G$UHJIT (STCLASS="BASED(G$UHJIT$)");
      636    13800        %G$JIT (STCLASS="BASED(G$JIT$)");
      637    14214        %G$USER (FPTN="G$USER(0:0)",STCLASS="BASED(G$USRT$)");
      638    14225        %KNH$HMI (STCLASS="BASED(HMI$)");
      639    14232
      640    14233        /* Based structures */
      641    14234    1   DCL FPT CHAR(FPTSZ) BASED(KN$NETPARM.FPT$);
      642    14235    1   DCL MSG CHAR(KN$NETPARM.MSGSZ) BASED CALIGNED;
      643    14236    1   DCL UHDR CHAR(KN$NETPARM.UHDRSZ) BASED CALIGNED;
      644    14237    1   DCL SHDR CHAR(KN$NETPARM.SHDRSZ) BASED WALIGNED;
      645    14238    1   DCL THDR CHAR(KN$NETPARM.THDRSZ) BASED CALIGNED;
      646    14239    1   DCL NHDR CHAR(KN$NETPARM.NHDRSZ) BASED WALIGNED;
      647    14240
      648    14241        /* Symref items */
      649    14242    1   DCL G$USRT$ PTR SYMREF READONLY;
      650    14243    1   DCL G$JIT$ PTR SYMREF READONLY;
      651    14244    1   DCL G$UHJIT$ PTR SYMREF READONLY;
      652    14245    1   DCL G$WINDOW1$ PTR SYMREF READONLY;
      653    14246
      654    14247        /* Local variables */
      655    14248    1   DCL FPTSZ SBIN;
      656    14249    1   DCL FPTSZ2 REDEF FPTSZ SBIN;
      657    14250    1   DCL MSGSZ UBIN WORD;
      658    14251    1   DCL HMI$ PTR;
      659    14252    1   DCL FPTSZ1 UBIN;
      660    14253    1   DCL FNCTN UBIN;
      661    14254
      662    14255        /* Auto */
      663    14256    1   DCL IPTR SBIN ;
      664    14257    1   DCL RPTR SBIN ;
PL6.E3A0      #002=KNH$SEND File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:04 Page:95   
      665    14258    1   DCL SZ UBIN ;
      666    14259    1   DCL OP$ PTR;
      667    14260    1   DCL QQQ$ PTR;
      668    14261    1   DCL QQC$ REDEF QQQ$ CPTR;
      669    14262    1   DCL 1 QQC REDEF QQQ$,
      670    14263    1          2 OFS UBIN(8) UNAL,
      671    14264    1          2 BASE BIT(24);
      672    14265        %KNH$MESS (STCLASS="BASED(OP$)");
      673    14314    1   DCL TMSGSZ UBIN;
      674    14315    1   DCL CONN_TYPE SBIN;
      675    14316    1   DCL MSGX REDEF CONN_TYPE SBIN;
      676    14317    1   DCL USER_NUM UBIN;
      677    14318    1   DCL USER_ID UBIN(32);
      678    14319    1   DCL LDCT_NDX UBIN;
      679    14320        %FPT_TERM (STCLASS=AUTO);
      680    14342
      681    14343        /* Entry point references */
      682    14344    1   DCL KNA$RLSLDCT ENTRY(1) ALTRET;
      683    14345    1   DCL GHH$ASD ENTRY(2);
      684    14346    1   DCL GHS$RUE ENTRY(4) ALTRET;
      685    14347    1   DCL SCREECH ENTRY(1);
      686    14348
      687    14349
      688    14350        /* Constant */
      689    14351        %KNH$MESS (FPTN=MESS_CON,STCLASS=CONSTANT);
      690    14400        %VLP_SCODE (FPTN=BADFNC,ERR#=%S$BADFNC,SEV=G_SEV_SCREECH#,
      691    14401         STCLASS=CONSTANT,FCG=KN,MID=H,MON='1'B);
      692    14462
      693    14463
      694    14464
      695    14465        %EJECT;
PL6.E3A0      #002=KNH$SEND File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:04 Page:96   
      696    14466        /* Begin procedure */
      697    14467
      698    14468    1      USER_ID = KN$LDCT.UID;
      699    14469    1      LDCT_NDX = KN$LDCT.LDCTX;
      700    14470    1      USER_NUM = KN$LDCT.USER#;
      701    14471    1      CONN_TYPE = KN$LDCT.CONN_TYPE;
      702    14472    1      FNCTN = KN$NETPARM.FUNCTION;
      703    14473
      704    14474    1      IF FNCTN=%K_NDATA THEN FNCTN = %KN_FCN_DATA;
      705    14475    1      IF FNCTN~=%KN_FCN_DATA THEN
      706    14476    1      GOTO L_NSEND_DATA ;
      707    14477
      708    14478        %EJECT;
PL6.E3A0      #002=KNH$SEND File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:04 Page:97   
      709    14479    1   L_SEND_DATA:
      710    14480    1      FPTSZ = 0;
      711    14481    2      IF KN$NETPARM.FPT$~=ADDR(NIL) THEN DO;
      712    14482    2         FPTSZ = SIZEC(FPT_NSAP);
      713    14483    2         QQQ$ = ADDR(FPT);
      714    14484    2      END;
      715    14485    1   OPUT:
      716    14486
      717    14487    1      HMI$ = G$USER.HMI$(USER_NUM);
      718    14488           %LOCK (G=KNH$HMI.RCQ.LOCK);
      719    14495    1      G$UHJIT.ASDT_MCL.WINDOW1.SIZE = KNH$HMI.PPSZ;
      720    14496    1      G$UHJIT.ASDT_MCL.WINDOW1.BASE = KNH$HMI.PP#;
      721    14497    1      CALL GHH$ASD (G$WINDOW1$,G$UHJIT.ASDT_MCL.WINDOW1);
      722    14498
      723    14499    1      IF KNH$HMI.SCQ.CLOSING
      724    14500    1      THEN
      725    14501    1      GOTO DONT_SEND_CLOSING;
      726    14502
      727    14503    1      MSGSZ = KN$NETPARM.MSGSZ + KN$NETPARM.UHDRSZ;
      728    14504    1      IF CONN_TYPE~=%KN_CNTYPE_SESS
      729    14505    1        AND CONN_TYPE~=%KN_CNTYPE_QDP
      730    14506    1      THEN
      731    14507    2      DO ;
      732    14508    2         CONN_TYPE = 0;                    /* Make it easier to test next time   */
      733    14509    2         MSGSZ = MSGSZ + KN$NETPARM.SHDRSZ +
      734    14510    2           KN$NETPARM.THDRSZ + KN$NETPARM.NHDRSZ ;
      735    14511    2      END;
      736    14512
      737    14513    1      TMSGSZ = ( MSGSZ + SIZEC(KNH$MESS) + FPTSZ + 3)/4;
      738    14514
      739    14515
      740    14516    1      IPTR = KNH$HMI.RCQ.IPTR;
      741    14517    1      RPTR = KNH$HMI.RCQ.RPTR;
      742    14518
      743    14519    1      IF RPTR<=IPTR
      744    14520    1      THEN
      745    14521    1      SZ = KNH$HMI.RCQ.SZ - IPTR - SIZEW(KNH$MESS)/2;
PL6.E3A0      #002=KNH$SEND File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:04 Page:98   
      746    14522    1      ELSE
      747    14523    1      SZ = RPTR - IPTR - 1;
      748    14524
      749    14525    1      IF SZ<TMSGSZ                         /* No space for message               */
      750    14526    1      THEN
      751    14527    2      DO ;
      752    14528    2         IF IPTR >= RPTR AND RPTR ~= 0     /* Put nop at end                     */
      753    14529    2         THEN
      754    14530    3         DO ;
      755    14531    3            OP$ = PINCRW(G$WINDOW1$,KNH$QHDR.RCQ.OFFSET+IPTR);
      756    14532    3            OP$ = PINCRW(OP$,IPTR);
      757    14533    3            KNH$MESS.LDCTX = 0;
      758    14534    3            KNH$MESS.FUNCTION = %KN_FCN_NOP;
      759    14535    3            KNH$MESS.FPTSZ = 0;
      760    14536    3            KNH$MESS.MSGSZ = SZ*4;
      761    14537    3            KNH$HMI.RCQ.IPTR = 0;
      762    14538    3            KNH$QHDR.RCQ.IPTR = 0;
      763    14539    3            IPTR = 0;
      764    14540    3            SZ = RPTR - 1;
      765    14541        /* Increment number of messages */
      766    14542    3            KNH$QHDR.MSGS_RCQ = KNH$QHDR.MSGS_RCQ + 1;
      767    14543    3            KNH$QHDR.WRAP_RCQ = KNH$QHDR.WRAP_RCQ + 1;
      768    14544    3            IF SZ>=TMSGSZ THEN
      769    14545    3            GOTO L_IT_FITS ;
      770    14546    3            CALL GHS$RUE (%GH_EVWU,USER_NUM);
      771    14547    3         END;
      772    14548
      773    14549    2         KN$NETPARM.ERRCODE = %KN_ERR_NOQ2;
      774    14550    2         IF IPTR = RPTR AND IPTR = 0       /* It's never gonna fit here          */
      775    14551    2         THEN
      776    14552    2         KN$NETPARM.ERRCODE = %KN_ERR_Q2SMALL;
      777    14553    2         ELSE
      778    14554    2         IF KN$NETPARM.SLDCT$ ~= ADDR(NIL) AND NOT KN$NETPARM.SLDCT$->KN$LDCT.FLAGS.
             14554                  QUEUED
      779    14555    3         THEN DO;
      780    14556    3            KN$NETPARM.ERRCODE = %KN_ERR_NOQ;
      781    14557    3            KN$NETPARM.SLDCT$->KN$LDCT.FLAGS.QUEUED = '1'B;
PL6.E3A0      #002=KNH$SEND File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:04 Page:99   
      782    14558    3            KN$NETPARM.SLDCT$->KN$LDCT.LNK$ = KNH$HMI.WAIT_HEAD$;
      783    14559    3            KNH$HMI.WAIT_HEAD$ = KN$NETPARM.SLDCT$;
      784    14560    3            KNH$HMI.WAIT_COUNT = KNH$HMI.WAIT_COUNT + 1;
      785    14561    3         END;
      786    14562              %UNLOCK (G=KNH$HMI.RCQ.LOCK);
      787    14569    2         ALTRETURN;
      788    14570    2      END;
      789    14571
      790    14572    1   L_IT_FITS:
      791    14573    1      OP$ = PINCRW(G$WINDOW1$,KNH$QHDR.RCQ.OFFSET+IPTR);
      792    14574    1      OP$ = PINCRW(OP$,IPTR);
      793    14575
      794    14576        /* Fill in fields of the message */
      795    14577        /* OP$->KNH$MESS = MESS_CON; every word is initialized separately */
      796    14578    1      OP$->KNH$MESS.FUNCTION = FNCTN;
      797    14579    1      OP$->KNH$MESS.UID = USER_ID;
      798    14580    1      OP$->KNH$MESS.LDCTX = LDCT_NDX;
      799    14581    1      OP$->KNH$MESS.RECTYPE = KN$NETPARM.RECTYPE;
      800    14582    1      KNH$MESS.LAST_PTR = KNH$QHDR.LAST_RCQPTR;
      801    14583    1      KNH$QHDR.LAST_RCQPTR = IPTR;
      802    14584    1      KNH$MESS.MSGSZ = MSGSZ;
      803    14585    1      KNH$MESS.FPTSZ = FPTSZ;
      804    14586
      805    14587    1      IF FPTSZ ~= 0
      806    14588    1      THEN
      807    14589    2      DO ;
      808    14590    2         PINCRC(OP$,SIZEC(KNH$MESS))->FPT = QQQ$->FPT;
      809    14591    2      END;
      810    14592
      811    14593    1      FPTSZ = FPTSZ + SIZEC(KNH$MESS);
      812    14594    1      IF CONN_TYPE=0
      813    14595    1      THEN
      814    14596    2      DO ;
      815    14597    2         IF KN$NETPARM.NHDRSZ ~= 0
      816    14598    2         THEN
      817    14599    3         DO ;
      818    14600    3            PINCRC(OP$,FPTSZ)->NHDR = KN$NETPARM.NHDR$->NHDR;
PL6.E3A0      #002=KNH$SEND File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:04 Page:100  
      819    14601    3            FPTSZ = FPTSZ + KN$NETPARM.NHDRSZ ;
      820    14602    3         END;
      821    14603
      822    14604    2         IF KN$NETPARM.THDRSZ ~= 0
      823    14605    2         THEN
      824    14606    3         DO ;
      825    14607    3            PINCRC(OP$,FPTSZ)->THDR = KN$NETPARM.THDR_C$->THDR;
      826    14608    3            FPTSZ = FPTSZ + KN$NETPARM.THDRSZ ;
      827    14609    3         END;
      828    14610
      829    14611    2         IF KN$NETPARM.SHDRSZ ~= 0
      830    14612    2         THEN
      831    14613    3         DO ;
      832    14614    3            PINCRC(OP$,FPTSZ)->SHDR = KN$NETPARM.SHDR$->SHDR;
      833    14615    3            FPTSZ = FPTSZ + KN$NETPARM.SHDRSZ ;
      834    14616    3         END;
      835    14617
      836    14618
      837    14619    2      END;
      838    14620    1      IF KN$NETPARM.UHDRSZ ~= 0
      839    14621    1      THEN
      840    14622    2      DO ;
      841    14623    2         PINCRC(OP$,FPTSZ)->UHDR = KN$NETPARM.UHDR$->UHDR;
      842    14624    2         FPTSZ = FPTSZ + KN$NETPARM.UHDRSZ ;
      843    14625    2      END;
      844    14626
      845    14627    1      IF KN$NETPARM.MSGSZ ~= 0
      846    14628    2      THEN DO;
      847    14629    2         QQC$ = KN$NETPARM.MSG$;
      848    14630    2         MSGX = QQC.OFS/128;
      849    14631    2         QQC.OFS = 0;
      850    14632    2         PINCRC(OP$,FPTSZ)->MSG = PINCRC(QQQ$,MSGX)->MSG;
      851    14633    2      END;
      852    14634
      853    14635    1      KNH$HMI.RCQ.IPTR = KNH$HMI.RCQ.IPTR + TMSGSZ;
      854    14636    1      KNH$QHDR.RCQ.IPTR = KNH$HMI.RCQ.IPTR;
      855    14637
PL6.E3A0      #002=KNH$SEND File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:04 Page:101  
      856    14638        /* Increment statistics */
      857    14639    1      KNH$QHDR.MSGS_RCQ = KNH$QHDR.MSGS_RCQ + 1;
      858    14640    1      KNH$QHDR.MBC_RCQ = KNH$QHDR.MBC_RCQ + TMSGSZ ;
      859    14641
      860    14642
      861    14643    1      CALL GHS$RUE (%GH_EVWU,USER_NUM);
      862    14644
      863    14645    1   DONT_SEND_CLOSING: ;
      864    14646           %UNLOCK (G=KNH$HMI.RCQ.LOCK);
      865    14653    1      IF FNCTN~=%KN_FCN_DATA
      866    14654    1      THEN
      867    14655    2      IF FNCTN=%KN_FCN_INIT_ACK THEN DO;
      868    14656    2         IF ADDR(FPT)->FPT_CONNECT_ACK.REASON ~= 0
      869    14657    2         THEN
      870    14658    2         CALL KNA$RLSLDCT(KN$NETPARM.LDCT$);
      871    14659    2         ELSE
      872    14660    2         KNH$HMI.LDCTS# = KNH$HMI.LDCTS# + 1;
      873    14661    2      END;
      874    14662
      875    14663    2      ELSE IF FNCTN=%KN_FCN_TERM_ACK THEN DO;
      876    14664    2         CALL KNA$RLSLDCT(KN$NETPARM.LDCT$);
      877    14665    2         KNH$HMI.LDCTS# = KNH$HMI.LDCTS# - 1;
      878    14666    2      END;
      879    14667
      880    14668    1      RETURN;
      881    14669        %EJECT;
PL6.E3A0      #002=KNH$SEND File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:04 Page:102  
      882    14670    1   L_NSEND_DATA:
      883    14671    1      IF FNCTN = %KN_FCN_UNQ THEN
      884    14672    2      DO ;
      885    14673    2         CALL GHS$RUE (%GH_EVWU,USER_NUM);
      886    14674    2         HMI$ = G$USER.HMI$(USER_NUM);
      887    14675    2         KNH$HMI.SCQ.SCANNED = '0'B;
      888    14676    2         RETURN;
      889    14677    2      END ;
      890    14678
      891    14679    1      IF FNCTN = %KN_FCN_INIT THEN
      892    14680    2      DO ;
      893    14681    2         IF KN$LDCT.CONN_TYPE = %KN_CNTYPE_CIRCUIT THEN
      894    14682    2         FPTSZ = SIZEC(FPT_CONNECT_CIRCUIT);
      895    14683    2         ELSE
      896    14684    2         FPTSZ = SIZEC(FPT_CONNECT) ;
      897    14685    2         QQQ$ = ADDR(FPT);
      898    14686    2         GOTO OPUT ;
      899    14687    2      END ;
      900    14688
      901    14689    1      IF FNCTN = %KN_FCN_INIT_ACK THEN
      902    14690    2      DO ;
      903    14691    2         FPTSZ = SIZEC(FPT_CONNECT_ACK) ;
      904    14692    2         QQQ$ = ADDR(FPT);
      905    14693    2         IF ADDR(FPT)->FPT_CONNECT_ACK.REASON~=0
      906    14694    2         THEN LDCT_NDX = 0;
      907    14695    2         GOTO OPUT ;
      908    14696    2      END ;
      909    14697
      910    14698    1      IF FNCTN = %KN_FCN_TERM THEN
      911    14699    2      DO ;
      912    14700    2         IF ADDR(FPT)=ADDR(NIL) THEN
      913    14701    3         DO ;
      914    14702    3            QQQ$ = ADDR(FPT_TERM) ;
      915    14703    3            FPT_TERM.RLCID = KN$LDCT.RLCID ;
      916    14704    3            FPT_TERM.REASON = %KN_TERM_REASON_NTRNSPRT ;
      917    14705    3         END ;
      918    14706    2         ELSE
PL6.E3A0      #002=KNH$SEND File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:04 Page:103  
      919    14707    2         QQQ$ = ADDR(FPT) ;
      920    14708    2         FPTSZ = SIZEC(FPT_TERM);
      921    14709    2         GOTO OPUT;
      922    14710    2      END ;
      923    14711
      924    14712    1      IF FNCTN = %KN_FCN_TERM_ACK THEN
      925    14713    1      GOTO L_SEND_DATA ;
      926    14714
      927    14715    1      IF FNCTN = %KN_FCN_UNCOUNT THEN
      928    14716    2      DO ;
      929    14717    2         HMI$ = G$USER.HMI$(USER_NUM);
      930    14718    2         KNH$HMI.WAIT_COUNT = KNH$HMI.WAIT_COUNT - 1 ;
      931    14719    2         OP$ = KNH$HMI.WAIT_HEAD$ ;
      932    14720    2         KNH$HMI.WAIT_HEAD$ = OP$->KN$LDCT.LNK$ ;
      933    14721    2         OP$->KN$LDCT.LNK$ = ADDR(NIL) ;
      934    14722    2         KNH$HMI.SCQ.SCANNED = '0'B;
      935    14723    2         RETURN;
      936    14724    2      END;
      937    14725
      938    14726    1      CALL SCREECH(BADFNC);
      939    14727
      940    14728        /*S* SCREECH_CODE: KNH-S$BADFNC
      941    14729             TYPE: SCREECH
      942    14730             MESSAGE: Bad function passed to Session
      943    14731        */
      944    14732        %EJECT;
PL6.E3A0      #002=KNH$SEND File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:04 Page:104  
      945    14733    1   KNH$SEND_LOOP: ENTRY (KN$NETPARM) ALTRET;
      946    14734        /*F*
      947    14735              NAME: KNH$SEND_LOOP
      948    14736              PURPOSE:
      949    14737                   To send an empty data message to the same user, preserving
      950    14738                   USER_ID, but possibly without any LDCT.  KN$NETPARM.LDCT$ points
      951    14739                   to the KN_FCN_LOOP message in the senders SCQ.
      952    14740        */
      953    14741
      954    14742    1      LDCT_NDX = KN$NETPARM.LDCT$->KNH$MESS.LDCTX;
      955    14743    1      USER_ID = KN$NETPARM.LDCT$->KNH$MESS.UID;
      956    14744    1      USER_NUM = G$JIT.USR#;
      957    14745    1      FNCTN = %KN_FCN_DATA;
      958    14746    1      CONN_TYPE = %KN_CNTYPE_SESS;
      959    14747    1      FPTSZ = 0;
      960    14748    1      GOTO OPUT;
      961    14749    1   END KNH$SEND;
      962    14750        %EOD;

PL6.E3A0      #002=KNH$SEND File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:04 Page:105  
--  Include file information  --

   K_INTERFACE_M.:E05TOU  is referenced.
   K_SCODE_C.:E05TOU  is referenced.
   K_ADDRESS_M.:E05TOU  is referenced.
   KI_CP6.:E05TOU  is referenced.
   KL_MACRO_C.:E05TOU  is referenced.
   GH_GATE_M.:E05TOU  cannot be made into a system file and is referenced.
   G_HJIT_M.:E05TOU  is referenced.
   G_JIT_M.:E05TOU  is referenced.
   GU_LCP6_M.:E05TOU  is referenced.
   GH_SCHD_M.:E05TOU  is referenced.
   GH_SCHD_E.:E05TOU  is referenced.
   GH_LCP6_M.:E05TOU  is referenced.
   KN_ERRORS_C.:E05TOU  is referenced.
   KNH_MACRO_C.:E05TOU  is referenced.
   KN_DATA_M.:E05TOU  is referenced.
      No diagnostics issued in procedure KNH$SEND.

   Procedure KNH$SEND requires 763 words for executable code.
   Procedure KNH$SEND requires 34 words of local(AUTO) storage.

PL6.E3A0      #002=KNH$SEND File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:04 Page:106  

 Object Unit name= KNH$SEND                                   File name= KNH$HMI.:E05TOU
 UTS= JUL 30 '97 01:04:22.72 WED                              Compiler= PL-6/E31         Sev=      00
 SharedLib= :SHARED_LCP6_SYSTEM                               Alt SharedLib=


    ****  Control sections  ****

 Sect   Type Bound  Init  Size HexSiz  Section name
    0  RoData even  UTS     11      B  KNH$SEND
    1   Proc  even  none   763    2FB  KNH$SEND
    2  RoData even  none     2      2  KNH$SEND

    ****  Entry defs  ****

                              Check   Calling
                             calling  sequence
  Sect HexLoc Primary Altret sequence   type   Parms  Name
     1      0   yes    yes     yes      Std        1  KNH$SEND
     1    2D8          yes     yes      Std        1  KNH$SEND_LOOP

  ****  Entry refs  ****

         Check        Calling
        calling       sequence
Altret sequence SRef   type   Args  Name
 yes     yes           Std       1 GHH$LOCK
         yes           Std       2 GHH$ASD
 yes     yes           Std       1 GHH$UNLOCK
         yes           Std       1 SCREECH
 yes     yes           Std       4 GHS$RUE
 yes     yes           Std       1 KNA$RLSLDCT
                       nStd      0 X6A_AUTO_1
                       nStd      0 X6A_AALT
                       nStd      0 X6A_ARET
PL6.E3A0      #002=KNH$SEND File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:04 Page:107  

  ****  Data refs  ****

  Flags:  r = read only, s = secondary
Flgs Name                             Flgs Name                             Flgs Name
r    G$USRT$                          r    G$JIT$                           r    G$UHJIT$
r    G$WINDOW1$                       r    G$ROS$
PL6.E3A0      #002=KNH$SEND File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:04 Page:108  


      591        1        /*T***********************************************************/
      592        2        /*T*                                                         */
      593        3        /*T* Copyright (c) Bull HN Information Systems Inc., 1997    */
      594        4        /*T*                                                         */
      595        5        /*T***********************************************************/
      596        6        /*X*     NSO,PLM=3,SQB=Y,AND=Y,ENI=0,SDI=3,MCL=10,CSI=0,ECI=0,IAD=3,IND=0 */
      597        7        /*F*
      598        8             NAME: KNH$SEND
      599        9             PURPOSE:
      600       10                  T receive data and commands from Network and Session.
      601       11             DESCRIPTION:
      602       12                  This routine will get called from Session or Network
      603       13                  when ever there is an interaction needed with a handler.
      604       14        */
      605       15
      606       16        KNH$SEND: PROC (KN$NETPARM) ALTRET;

     16   1 000000  D380 0000 0000  xent KNH$SEND        LNJ,B5   X6A_AUTO_1
          1 000003       0022 0001                       DC       34,1

      607       17
      608       18        /* Include files */
      609       19        %INCLUDE KN_DATA_M;
      610     1805        %INCLUDE KNH_MACRO_C;
      611     2088        %INCLUDE KN_ERRORS_C;
      612     2152        %INCLUDE GH_LCP6_M;
      613     2986        %INCLUDE GH_SCHD_E;
      614     3082        %INCLUDE GH_SCHD_M;
      615     3226        %INCLUDE GU_LCP6_M;
      616     4154        %INCLUDE G_JIT_M;
      617     4419        %INCLUDE G_HJIT_M;
      618     4564        %INCLUDE GH_GATE_M;
      619     4605        %INCLUDE KL_MACRO_C;
      620     7957        %INCLUDE KI_CP6;
      621     9053        %INCLUDE K_ADDRESS_M;
      622     9556        %INCLUDE K_SCODE_C;
PL6.E3A0      #002=KNH$SEND File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:04 Page:109  
      623     9641        %INCLUDE K_INTERFACE_M;
      624    10050
      625    10051        /* Paramter definitions */
      626    10052        %KN$NETPARM;
      627    10205
      628    10206        /* Based structures */
      629    10207        %KN$LDCT (STCLASS="BASED(KN$NETPARM.LDCT$)");
      630    10452        %KNH$QHDR (STCLASS="BASED(G$WINDOW1$)");
      631    10465        %FPT_CONNECT_ACK (STCLASS=BASED);
      632    10514        %FPT_CONNECT (STCLASS=BASED);
      633    10583        %FPT_CONNECT(FPTN=FPT_CONNECT_CIRCUIT,STCLASS=BASED,ADRTYP=NET);
      634    10754        %FPT_NSAP;
      635    10826        %G$UHJIT (STCLASS="BASED(G$UHJIT$)");
      636    13800        %G$JIT (STCLASS="BASED(G$JIT$)");
      637    14214        %G$USER (FPTN="G$USER(0:0)",STCLASS="BASED(G$USRT$)");
      638    14225        %KNH$HMI (STCLASS="BASED(HMI$)");
      639    14232
      640    14233        /* Based structures */
      641    14234    1   DCL FPT CHAR(FPTSZ) BASED(KN$NETPARM.FPT$);
      642    14235    1   DCL MSG CHAR(KN$NETPARM.MSGSZ) BASED CALIGNED;
      643    14236    1   DCL UHDR CHAR(KN$NETPARM.UHDRSZ) BASED CALIGNED;
      644    14237    1   DCL SHDR CHAR(KN$NETPARM.SHDRSZ) BASED WALIGNED;
      645    14238    1   DCL THDR CHAR(KN$NETPARM.THDRSZ) BASED CALIGNED;
      646    14239    1   DCL NHDR CHAR(KN$NETPARM.NHDRSZ) BASED WALIGNED;
      647    14240
      648    14241        /* Symref items */
      649    14242    1   DCL G$USRT$ PTR SYMREF READONLY;
      650    14243    1   DCL G$JIT$ PTR SYMREF READONLY;
      651    14244    1   DCL G$UHJIT$ PTR SYMREF READONLY;
      652    14245    1   DCL G$WINDOW1$ PTR SYMREF READONLY;
      653    14246
      654    14247        /* Local variables */
      655    14248    1   DCL FPTSZ SBIN;
      656    14249    1   DCL FPTSZ2 REDEF FPTSZ SBIN;
      657    14250    1   DCL MSGSZ UBIN WORD;
      658    14251    1   DCL HMI$ PTR;
      659    14252    1   DCL FPTSZ1 UBIN;
PL6.E3A0      #002=KNH$SEND File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:04 Page:110  
      660    14253    1   DCL FNCTN UBIN;
      661    14254
      662    14255        /* Auto */
      663    14256    1   DCL IPTR SBIN ;
      664    14257    1   DCL RPTR SBIN ;
      665    14258    1   DCL SZ UBIN ;
      666    14259    1   DCL OP$ PTR;
      667    14260    1   DCL QQQ$ PTR;
      668    14261    1   DCL QQC$ REDEF QQQ$ CPTR;
      669    14262    1   DCL 1 QQC REDEF QQQ$,
      670    14263    1          2 OFS UBIN(8) UNAL,
      671    14264    1          2 BASE BIT(24);
      672    14265        %KNH$MESS (STCLASS="BASED(OP$)");
      673    14314    1   DCL TMSGSZ UBIN;
      674    14315    1   DCL CONN_TYPE SBIN;
      675    14316    1   DCL MSGX REDEF CONN_TYPE SBIN;
      676    14317    1   DCL USER_NUM UBIN;
      677    14318    1   DCL USER_ID UBIN(32);
      678    14319    1   DCL LDCT_NDX UBIN;
      679    14320        %FPT_TERM (STCLASS=AUTO);
      680    14342
      681    14343        /* Entry point references */
      682    14344    1   DCL KNA$RLSLDCT ENTRY(1) ALTRET;
      683    14345    1   DCL GHH$ASD ENTRY(2);
      684    14346    1   DCL GHS$RUE ENTRY(4) ALTRET;
      685    14347    1   DCL SCREECH ENTRY(1);
      686    14348
      687    14349
      688    14350        /* Constant */
      689    14351        %KNH$MESS (FPTN=MESS_CON,STCLASS=CONSTANT);
      690    14400        %VLP_SCODE (FPTN=BADFNC,ERR#=%S$BADFNC,SEV=G_SEV_SCREECH#,
      691    14401         STCLASS=CONSTANT,FCG=KN,MID=H,MON='1'B);
      692    14462
      693    14463
      694    14464
      695    14465        %EJECT;
PL6.E3A0      #002=KNH$SEND File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:04 Page:111  
      696    14466        /* Begin procedure */
      697    14467
      698    14468    1      USER_ID = KN$LDCT.UID;

  14468   1 000005  ECC7 0004                            LDB,B6   @KN$NETPARM,AUTO
          1 000007  DC86                                 LDB,B5   ,B6
          1 000008  8CC5 0005                            LDI      5,B5
          1 00000A  8D47 0016                            SDI      USER_ID,AUTO

      699    14469    1      LDCT_NDX = KN$LDCT.LDCTX;

  14469   1 00000C  D845 0007                            LDR,R5   7,B5
          1 00000E  DF47 0018                            STR,R5   LDCT_NDX,AUTO

      700    14470    1      USER_NUM = KN$LDCT.USER#;

  14470   1 000010  C845 000E                            LDR,R4   14,B5
          1 000012  CF47 0015                            STR,R4   USER_NUM,AUTO

      701    14471    1      CONN_TYPE = KN$LDCT.CONN_TYPE;

  14471   1 000014  DC86                                 LDB,B5   ,B6
          1 000015  B285                                 LLH,R3   ,B5
          1 000016  BF47 0014                            STR,R3   CONN_TYPE,AUTO

      702    14472    1      FNCTN = KN$NETPARM.FUNCTION;

  14472   1 000018  A846 0014                            LDR,R2   20,B6
          1 00001A  AF47 000B                            STR,R2   FNCTN,AUTO

      703    14473
      704    14474    1      IF FNCTN=%K_NDATA THEN FNCTN = %KN_FCN_DATA;

  14474   1 00001C  2D21                                 CMV,R2   33
          1 00001D  0981 0004                            BNE      s:14475,PREL

  14474   1 00001F  2C05                                 LDV,R2   5
PL6.E3A0      #002=KNH$SEND File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:04 Page:112  
          1 000020  AF47 000B                            STR,R2   FNCTN,AUTO

      705    14475    1      IF FNCTN~=%KN_FCN_DATA THEN

  14475   1 000022  2D05                                 CMV,R2   5
          1 000023  0981 0221                            BNE      s:14671,PREL

      706    14476    1      GOTO L_NSEND_DATA ;
      707    14477
      708    14478        %EJECT;
PL6.E3A0      #002=KNH$SEND File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:04 Page:113  
      709    14479    1   L_SEND_DATA:
      710    14480    1      FPTSZ = 0;

  14480   1 000025  8747 0006            L_SEND_DATA     CL       FPTSZ,AUTO

      711    14481    2      IF KN$NETPARM.FPT$~=ADDR(NIL) THEN DO;

  14481   1 000027  ECC7 0004                            LDB,B6   @KN$NETPARM,AUTO
          1 000029  8DC6 0019                            CMN      25,B6
          1 00002B  0901 0008                            BE       s:14484,PREL

      712    14482    2         FPTSZ = SIZEC(FPT_NSAP);

  14482   1 00002D  6C16                                 LDV,R6   22
          1 00002E  EF47 0006                            STR,R6   FPTSZ,AUTO

      713    14483    2         QQQ$ = ADDR(FPT);

  14483   1 000030  DCC6 0019                            LDB,B5   25,B6
          1 000032  DFC7 0011                            STB,B5   QQQ$,AUTO

      714    14484    2      END;

      715    14485    1   OPUT:
      716    14486
      717    14487    1      HMI$ = G$USER.HMI$(USER_NUM);

  14487   1 000034  EC80 0000 0000  xsym OPUT            LDB,B6   G$USRT$
          1 000037  B847 0015                            LDR,R3   USER_NUM,AUTO
          1 000039  3F0C                                 MLV,R3   12
          1 00003A  3E0A                                 ADV,R3   10
          1 00003B  DCB6                                 LDB,B5   ,B6,R3
          1 00003C  DFC7 0008                            STB,B5   HMI$,AUTO

      718    14488           %LOCK (G=KNH$HMI.RCQ.LOCK);

  14493   1 00003E  CBC5 0004                            LAB,B4   4,B5
PL6.E3A0      #002=KNH$SEND File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:04 Page:114  
          1 000040  CFC7 001E                            STB,B4   FPT_TERM+5,AUTO
          1 000042  BBC7 001E                            LAB,B3   FPT_TERM+5,AUTO
          1 000044  CBF0 0100                            LAB,B4   256,IMO
          1 000046  E380 0000 0000  xent                 LNJ,B6   GHH$LOCK
          1 000049       0001                            DC       s:14495,PREL

      719    14495    1      G$UHJIT.ASDT_MCL.WINDOW1.SIZE = KNH$HMI.PPSZ;

  14495   1 00004A  ECC7 0008                            LDB,B6   HMI$,AUTO
          1 00004C  E846 0017                            LDR,R6   23,B6
          1 00004E  DC80 0000 0000  xsym                 LDB,B5   G$UHJIT$
          1 000051  EAC5 006F                            SRM,R6,'01FF'X    111,B5
          1 000053       01FF

      720    14496    1      G$UHJIT.ASDT_MCL.WINDOW1.BASE = KNH$HMI.PP#;

  14496   1 000054  E846 0016                            LDR,R6   22,B6
          1 000056  EAC5 006E                            SRM,R6,'7FFF'X    110,B5
          1 000058       7FFF

      721    14497    1      CALL GHH$ASD (G$WINDOW1$,G$UHJIT.ASDT_MCL.WINDOW1);

  14497   1 000059  CBC5 006E                            LAB,B4   110,B5
          1 00005B  CFC7 0020                            STB,B4   FPT_TERM+7,AUTO
          1 00005D  BB80 0000 0000  xsym                 LAB,B3   G$WINDOW1$
          1 000060  BFC7 001E                            STB,B3   FPT_TERM+5,AUTO
          1 000062  BBC7 001E                            LAB,B3   FPT_TERM+5,AUTO
          1 000064  CBF0 0200                            LAB,B4   512,IMO
          1 000066  E380 0000 0000  xent                 LNJ,B6   GHH$ASD
          1 000069       0001                            DC       s:14499,PREL

      722    14498
      723    14499    1      IF KNH$HMI.SCQ.CLOSING

  14499   1 00006A  ECC7 0008                            LDB,B6   HMI$,AUTO
          1 00006C  82C6 000E                            LB,'0001'X        14,B6
          1 00006E       0001
PL6.E3A0      #002=KNH$SEND File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:04 Page:115  
          1 00006F  0501 0196                            BBT      s:14640,PREL

      724    14500    1      THEN
      725    14501    1      GOTO DONT_SEND_CLOSING;
      726    14502
      727    14503    1      MSGSZ = KN$NETPARM.MSGSZ + KN$NETPARM.UHDRSZ;

  14503   1 000071  DCC7 0004                            LDB,B5   @KN$NETPARM,AUTO
          1 000073  E845 0004                            LDR,R6   4,B5
          1 000075  EA45 0007                            ADD,R6   7,B5
          1 000077  EF47 0007                            STR,R6   MSGSZ,AUTO

      728    14504    1      IF CONN_TYPE~=%KN_CNTYPE_SESS

  14504   1 000079  D847 0014                            LDR,R5   CONN_TYPE,AUTO
          1 00007B  5D02                                 CMV,R5   2
          1 00007C  0901 000E                            BE       s:14513,PREL
          1 00007E  5D05                                 CMV,R5   5
          1 00007F  0901 000B                            BE       s:14513,PREL

      729    14505    1        AND CONN_TYPE~=%KN_CNTYPE_QDP
      730    14506    1      THEN
      731    14507    2      DO ;

      732    14508    2         CONN_TYPE = 0;                    /* Make it easier to test next time   */

  14508   1 000081  8747 0014                            CL       CONN_TYPE,AUTO

      733    14509    2         MSGSZ = MSGSZ + KN$NETPARM.SHDRSZ +

  14509   1 000083  EA45 000A                            ADD,R6   10,B5
          1 000085  EA45 000D                            ADD,R6   13,B5
          1 000087  EA45 0010                            ADD,R6   16,B5
          1 000089  EF47 0007                            STR,R6   MSGSZ,AUTO

      734    14510    2           KN$NETPARM.THDRSZ + KN$NETPARM.NHDRSZ ;
      735    14511    2      END;
PL6.E3A0      #002=KNH$SEND File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:04 Page:116  

      736    14512
      737    14513    1      TMSGSZ = ( MSGSZ + SIZEC(KNH$MESS) + FPTSZ + 3)/4;

  14513   1 00008B  EA47 0006                            ADD,R6   FPTSZ,AUTO
          1 00008D  6E13                                 ADV,R6   19
          1 00008E  E370 0004                            DIV,R6   4,IMO
          1 000090  EF47 0013                            STR,R6   TMSGSZ,AUTO

      738    14514
      739    14515
      740    14516    1      IPTR = KNH$HMI.RCQ.IPTR;

  14516   1 000092  D806                                 LDR,R5   ,B6
          1 000093  DF47 000C                            STR,R5   IPTR,AUTO

      741    14517    1      RPTR = KNH$HMI.RCQ.RPTR;

  14517   1 000095  C846 0001                            LDR,R4   1,B6
          1 000097  CF47 000D                            STR,R4   RPTR,AUTO

      742    14518
      743    14519    1      IF RPTR<=IPTR

  14519   1 000099  C955                                 CMR,R4   R5
          1 00009A  0A01 0009                            BAG      s:14523,PREL

      744    14520    1      THEN
      745    14521    1      SZ = KNH$HMI.RCQ.SZ - IPTR - SIZEW(KNH$MESS)/2;

  14521   1 00009C  D246 0002                            SUB,R5   2,B6
          1 00009E  8255                                 NEG      R5
          1 00009F  5EFC                                 ADV,R5   -4
          1 0000A0  DF47 000E                            STR,R5   SZ,AUTO
          1 0000A2  0F81 0005                            B        s:14525,PREL

      746    14522    1      ELSE
PL6.E3A0      #002=KNH$SEND File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:04 Page:117  
      747    14523    1      SZ = RPTR - IPTR - 1;

  14523   1 0000A4  C255                                 SUB,R4   R5
          1 0000A5  4EFF                                 ADV,R4   -1
          1 0000A6  CF47 000E                            STR,R4   SZ,AUTO

      748    14524
      749    14525    1      IF SZ<TMSGSZ                         /* No space for message               */

  14525   1 0000A8  E947 000E                            CMR,R6   SZ,AUTO
          1 0000AA  0381 0087                            BLE      s:14573,PREL

      750    14526    1      THEN
      751    14527    2      DO ;

      752    14528    2         IF IPTR >= RPTR AND RPTR ~= 0     /* Put nop at end                     */

  14528   1 0000AC  D847 000C                            LDR,R5   IPTR,AUTO
          1 0000AE  D947 000D                            CMR,R5   RPTR,AUTO
          1 0000B0  0801 0040                            BAL      s:14549,PREL
          1 0000B2  C847 000D                            LDR,R4   RPTR,AUTO
          1 0000B4  4901 003C                            BEZ,R4   s:14549,PREL

      753    14529    2         THEN
      754    14530    3         DO ;

      755    14531    3            OP$ = PINCRW(G$WINDOW1$,KNH$QHDR.RCQ.OFFSET+IPTR);

  14531   1 0000B6  CC80 0000 0000  xsym                 LDB,B4   G$WINDOW1$
          1 0000B9  DA44 0003                            ADD,R5   3,B4
          1 0000BB  B855                                 LDR,R3   R5
          1 0000BC  BBB4                                 LAB,B3   ,B4,R3
          1 0000BD  BFC7 000F                            STB,B3   OP$,AUTO

      756    14532    3            OP$ = PINCRW(OP$,IPTR);

  14532   1 0000BF  B847 000C                            LDR,R3   IPTR,AUTO
PL6.E3A0      #002=KNH$SEND File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:04 Page:118  
          1 0000C1  ABB3                                 LAB,B2   ,B3,R3
          1 0000C2  AFC7 000F                            STB,B2   OP$,AUTO

      757    14533    3            KNH$MESS.LDCTX = 0;

  14533   1 0000C4  8742 0001                            CL       1,B2

      758    14534    3            KNH$MESS.FUNCTION = %KN_FCN_NOP;

  14534   1 0000C6  5C06                                 LDV,R5   6
          1 0000C7  DF02                                 STR,R5   ,B2

      759    14535    3            KNH$MESS.FPTSZ = 0;

  14535   1 0000C8  8742 0006                            CL       6,B2

      760    14536    3            KNH$MESS.MSGSZ = SZ*4;

  14536   1 0000CA  A847 000E                            LDR,R2   SZ,AUTO
          1 0000CC  2002                                 SOL,R2   2
          1 0000CD  AF42 0007                            STR,R2   7,B2

      761    14537    3            KNH$HMI.RCQ.IPTR = 0;

  14537   1 0000CF  8706                                 CL       ,B6

      762    14538    3            KNH$QHDR.RCQ.IPTR = 0;

  14538   1 0000D0  8704                                 CL       ,B4

      763    14539    3            IPTR = 0;

  14539   1 0000D1  8747 000C                            CL       IPTR,AUTO

      764    14540    3            SZ = RPTR - 1;

  14540   1 0000D3  4EFF                                 ADV,R4   -1
PL6.E3A0      #002=KNH$SEND File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:04 Page:119  
          1 0000D4  CF47 000E                            STR,R4   SZ,AUTO

      765    14541        /* Increment number of messages */
      766    14542    3            KNH$QHDR.MSGS_RCQ = KNH$QHDR.MSGS_RCQ + 1;

  14542   1 0000D6  8AC4 0011                            INC      17,B4
          1 0000D8  8EC4 0010                            CAD      16,B4

      767    14543    3            KNH$QHDR.WRAP_RCQ = KNH$QHDR.WRAP_RCQ + 1;

  14543   1 0000DA  8AC4 0015                            INC      21,B4
          1 0000DC  8EC4 0014                            CAD      20,B4

      768    14544    3            IF SZ>=TMSGSZ THEN

  14544   1 0000DE  C956                                 CMR,R4   R6
          1 0000DF  0281 0052                            BGE      s:14573,PREL

      769    14545    3            GOTO L_IT_FITS ;
      770    14546    3            CALL GHS$RUE (%GH_EVWU,USER_NUM);

  14546   1 0000E1  BBF0 0002                            LAB,B3   2,IMO
          1 0000E3  9BC7 0015                            LAB,B1   USER_NUM,AUTO
          1 0000E5  9FC7 0020                            STB,B1   FPT_TERM+7,AUTO
          1 0000E7  BFC7 001E                            STB,B3   FPT_TERM+5,AUTO
          1 0000E9  BBC7 001E                            LAB,B3   FPT_TERM+5,AUTO
          1 0000EB  CBF0 0200                            LAB,B4   512,IMO
          1 0000ED  E380 0000 0000  xent                 LNJ,B6   GHS$RUE
          1 0000F0       0001                            DC       s:14549,PREL

      771    14547    3         END;

      772    14548
      773    14549    2         KN$NETPARM.ERRCODE = %KN_ERR_NOQ2;

  14549   1 0000F1  ECC7 0004                            LDB,B6   @KN$NETPARM,AUTO
          1 0000F3  6C07                                 LDV,R6   7
PL6.E3A0      #002=KNH$SEND File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:04 Page:120  
          1 0000F4  EF46 0016                            STR,R6   22,B6

      774    14550    2         IF IPTR = RPTR AND IPTR = 0       /* It's never gonna fit here          */

  14550   1 0000F6  D847 000C                            LDR,R5   IPTR,AUTO
          1 0000F8  D947 000D                            CMR,R5   RPTR,AUTO
          1 0000FA  0981 0008                            BNE      s:14554,PREL
          1 0000FC  5981 0006                            BNEZ,R5  s:14554,PREL

      775    14551    2         THEN
      776    14552    2         KN$NETPARM.ERRCODE = %KN_ERR_Q2SMALL;

  14552   1 0000FE  6C04                                 LDV,R6   4
          1 0000FF  EF46 0016                            STR,R6   22,B6
          1 000101  0F81 001F                            B        s:14567,PREL

      777    14553    2         ELSE
      778    14554    2         IF KN$NETPARM.SLDCT$ ~= ADDR(NIL) AND NOT KN$NETPARM.SLDCT$->KN$LDCT.FLAGS.
             14554                  QUEUED

  14554   1 000103  8DC6 0017                            CMN      23,B6
          1 000105  0901 001B                            BE       s:14567,PREL
          1 000107  DCC6 0017                            LDB,B5   23,B6
          1 000109  89C5 000A                            CMZ      10,B5
          1 00010B  0801 0015                            BAL      s:14567,PREL

      779    14555    3         THEN DO;

      780    14556    3            KN$NETPARM.ERRCODE = %KN_ERR_NOQ;

  14556   1 00010D  6C01                                 LDV,R6   1
          1 00010E  EF46 0016                            STR,R6   22,B6

      781    14557    3            KN$NETPARM.SLDCT$->KN$LDCT.FLAGS.QUEUED = '1'B;

  14557   1 000110  8945 000A                            LBT,'8000'X       10,B5
  14557   1 000112       8000
PL6.E3A0      #002=KNH$SEND File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:04 Page:121  

      782    14558    3            KN$NETPARM.SLDCT$->KN$LDCT.LNK$ = KNH$HMI.WAIT_HEAD$;

  14558   1 000113  DCC6 0017                            LDB,B5   23,B6
          1 000115  CCC7 0008                            LDB,B4   HMI$,AUTO
          1 000117  BCC4 0011                            LDB,B3   17,B4
          1 000119  BFC5 0008                            STB,B3   8,B5

      783    14559    3            KNH$HMI.WAIT_HEAD$ = KN$NETPARM.SLDCT$;

  14559   1 00011B  DCC6 0017                            LDB,B5   23,B6
          1 00011D  DFC4 0011                            STB,B5   17,B4

      784    14560    3            KNH$HMI.WAIT_COUNT = KNH$HMI.WAIT_COUNT + 1;

  14560   1 00011F  8AC4 0013                            INC      19,B4

      785    14561    3         END;

      786    14562              %UNLOCK (G=KNH$HMI.RCQ.LOCK);

  14567   1 000121  DCC7 0008                            LDB,B5   HMI$,AUTO
          1 000123  CBC5 0004                            LAB,B4   4,B5
          1 000125  CFC7 001E                            STB,B4   FPT_TERM+5,AUTO
          1 000127  BBC7 001E                            LAB,B3   FPT_TERM+5,AUTO
          1 000129  CBF0 0100                            LAB,B4   256,IMO
          1 00012B  E380 0000 0000  xent                 LNJ,B6   GHH$UNLOCK
          1 00012E       0001                            DC       s:14569,PREL

      787    14569    2         ALTRETURN;

  14569   1 00012F  C380 0000 0000  xent                 LNJ,B4   X6A_AALT

      788    14570    2      END;
      789    14571
      790    14572    1   L_IT_FITS:
      791    14573    1      OP$ = PINCRW(G$WINDOW1$,KNH$QHDR.RCQ.OFFSET+IPTR);
PL6.E3A0      #002=KNH$SEND File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:04 Page:122  

  14573   1 000132  CC80 0000 0000  xsym L_IT_FITS       LDB,B4   G$WINDOW1$
          1 000135  D844 0003                            LDR,R5   3,B4
          1 000137  DA47 000C                            ADD,R5   IPTR,AUTO
          1 000139  B855                                 LDR,R3   R5
          1 00013A  BBB4                                 LAB,B3   ,B4,R3
          1 00013B  BFC7 000F                            STB,B3   OP$,AUTO

      792    14574    1      OP$ = PINCRW(OP$,IPTR);

  14574   1 00013D  B847 000C                            LDR,R3   IPTR,AUTO
          1 00013F  ABB3                                 LAB,B2   ,B3,R3
          1 000140  AFC7 000F                            STB,B2   OP$,AUTO

      793    14575
      794    14576        /* Fill in fields of the message */
      795    14577        /* OP$->KNH$MESS = MESS_CON; every word is initialized separately */
      796    14578    1      OP$->KNH$MESS.FUNCTION = FNCTN;

  14578   1 000142  D847 000B                            LDR,R5   FNCTN,AUTO
          1 000144  DF02                                 STR,R5   ,B2

      797    14579    1      OP$->KNH$MESS.UID = USER_ID;

  14579   1 000145  8CC7 0016                            LDI      USER_ID,AUTO
          1 000147  8D42 0002                            SDI      2,B2

      798    14580    1      OP$->KNH$MESS.LDCTX = LDCT_NDX;

  14580   1 000149  C847 0018                            LDR,R4   LDCT_NDX,AUTO
          1 00014B  CF42 0001                            STR,R4   1,B2

      799    14581    1      OP$->KNH$MESS.RECTYPE = KN$NETPARM.RECTYPE;

  14581   1 00014D  A845 0013                            LDR,R2   19,B5
          1 00014F  AF42 0004                            STR,R2   4,B2

PL6.E3A0      #002=KNH$SEND File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:04 Page:123  
      800    14582    1      KNH$MESS.LAST_PTR = KNH$QHDR.LAST_RCQPTR;

  14582   1 000151  9844 0016                            LDR,R1   22,B4
          1 000153  9F42 0005                            STR,R1   5,B2

      801    14583    1      KNH$QHDR.LAST_RCQPTR = IPTR;

  14583   1 000155  BF44 0016                            STR,R3   22,B4

      802    14584    1      KNH$MESS.MSGSZ = MSGSZ;

  14584   1 000157  A847 0007                            LDR,R2   MSGSZ,AUTO
          1 000159  AF42 0007                            STR,R2   7,B2

      803    14585    1      KNH$MESS.FPTSZ = FPTSZ;

  14585   1 00015B  9847 0006                            LDR,R1   FPTSZ,AUTO
          1 00015D  9F42 0006                            STR,R1   6,B2

      804    14586
      805    14587    1      IF FPTSZ ~= 0

  14587   1 00015F  1901 0009                            BEZ,R1   s:14593,PREL

      806    14588    1      THEN
      807    14589    2      DO ;

      808    14590    2         PINCRC(OP$,SIZEC(KNH$MESS))->FPT = QQQ$->FPT;

  14590   1 000161  ACC7 0011                            LDB,B2   QQQ$,AUTO
          1 000163  2C00                                 LDV,R2   0
          1 000164  E851                                 LDR,R6   R1
          1 000165  BCC7 000F                            LDB,B3   OP$,AUTO
          1 000167  3C10                                 LDV,R3   16
          1 000168  0008                                 MMM

      809    14591    2      END;
PL6.E3A0      #002=KNH$SEND File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:04 Page:124  

      810    14592
      811    14593    1      FPTSZ = FPTSZ + SIZEC(KNH$MESS);

  14593   1 000169  E847 0006                            LDR,R6   FPTSZ,AUTO
          1 00016B  6E10                                 ADV,R6   16
          1 00016C  EF47 0006                            STR,R6   FPTSZ,AUTO

      812    14594    1      IF CONN_TYPE=0

  14594   1 00016E  D847 0014                            LDR,R5   CONN_TYPE,AUTO
          1 000170  5981 0047                            BNEZ,R5  s:14620,PREL

      813    14595    1      THEN
      814    14596    2      DO ;

      815    14597    2         IF KN$NETPARM.NHDRSZ ~= 0

  14597   1 000172  C845 0010                            LDR,R4   16,B5
          1 000174  4901 0011                            BEZ,R4   s:14604,PREL

      816    14598    2         THEN
      817    14599    3         DO ;

      818    14600    3            PINCRC(OP$,FPTSZ)->NHDR = KN$NETPARM.NHDR$->NHDR;

  14600   1 000176  ECC5 000E                            LDB,B6   14,B5
          1 000178  AB86                                 LAB,B2   ,B6
          1 000179  2C00                                 LDV,R2   0
          1 00017A  E854                                 LDR,R6   R4
          1 00017B  BCC7 000F                            LDB,B3   OP$,AUTO
          1 00017D  B847 0006                            LDR,R3   FPTSZ,AUTO
          1 00017F  0008                                 MMM

      819    14601    3            FPTSZ = FPTSZ + KN$NETPARM.NHDRSZ ;

  14601   1 000180  E847 0006                            LDR,R6   FPTSZ,AUTO
PL6.E3A0      #002=KNH$SEND File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:04 Page:125  
          1 000182  EA45 0010                            ADD,R6   16,B5
          1 000184  EF47 0006                            STR,R6   FPTSZ,AUTO

      820    14602    3         END;

      821    14603
      822    14604    2         IF KN$NETPARM.THDRSZ ~= 0

  14604   1 000186  D845 000D                            LDR,R5   13,B5
          1 000188  5901 001B                            BEZ,R5   s:14611,PREL

      823    14605    2         THEN
      824    14606    3         DO ;

      825    14607    3            PINCRC(OP$,FPTSZ)->THDR = KN$NETPARM.THDR_C$->THDR;

  14607   1 00018A  8CC5 000B                            LDI      11,B5
          1 00018C  B856                                 LDR,R3   R6
          1 00018D  E570 7FFF                            AND,R6   32767,IMO
          1 00018F  8D47 001E                            SDI      FPT_TERM+5,AUTO
          1 000191  ECC7 001E                            LDB,B6   FPT_TERM+5,AUTO
          1 000193  304F                                 SOR,R3   15
          1 000194  C845 000D                            LDR,R4   13,B5
          1 000196  AB86                                 LAB,B2   ,B6
          1 000197  A853                                 LDR,R2   R3
          1 000198  E854                                 LDR,R6   R4
          1 000199  BCC7 000F                            LDB,B3   OP$,AUTO
          1 00019B  B847 0006                            LDR,R3   FPTSZ,AUTO
          1 00019D  0008                                 MMM

      826    14608    3            FPTSZ = FPTSZ + KN$NETPARM.THDRSZ ;

  14608   1 00019E  E847 0006                            LDR,R6   FPTSZ,AUTO
          1 0001A0  EA45 000D                            ADD,R6   13,B5
          1 0001A2  EF47 0006                            STR,R6   FPTSZ,AUTO

      827    14609    3         END;
PL6.E3A0      #002=KNH$SEND File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:04 Page:126  

      828    14610
      829    14611    2         IF KN$NETPARM.SHDRSZ ~= 0

  14611   1 0001A4  D845 000A                            LDR,R5   10,B5
          1 0001A6  5901 0011                            BEZ,R5   s:14620,PREL

      830    14612    2         THEN
      831    14613    3         DO ;

      832    14614    3            PINCRC(OP$,FPTSZ)->SHDR = KN$NETPARM.SHDR$->SHDR;

  14614   1 0001A8  ECC5 0008                            LDB,B6   8,B5
          1 0001AA  AB86                                 LAB,B2   ,B6
          1 0001AB  2C00                                 LDV,R2   0
          1 0001AC  E855                                 LDR,R6   R5
          1 0001AD  BCC7 000F                            LDB,B3   OP$,AUTO
          1 0001AF  B847 0006                            LDR,R3   FPTSZ,AUTO
          1 0001B1  0008                                 MMM

      833    14615    3            FPTSZ = FPTSZ + KN$NETPARM.SHDRSZ ;

  14615   1 0001B2  E847 0006                            LDR,R6   FPTSZ,AUTO
          1 0001B4  EA45 000A                            ADD,R6   10,B5
          1 0001B6  EF47 0006                            STR,R6   FPTSZ,AUTO

      834    14616    3         END;

      835    14617
      836    14618
      837    14619    2      END;

      838    14620    1      IF KN$NETPARM.UHDRSZ ~= 0

  14620   1 0001B8  D845 0007                            LDR,R5   7,B5
          1 0001BA  5901 0011                            BEZ,R5   s:14627,PREL

PL6.E3A0      #002=KNH$SEND File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:04 Page:127  
      839    14621    1      THEN
      840    14622    2      DO ;

      841    14623    2         PINCRC(OP$,FPTSZ)->UHDR = KN$NETPARM.UHDR$->UHDR;

  14623   1 0001BC  ECC5 0005                            LDB,B6   5,B5
          1 0001BE  AB86                                 LAB,B2   ,B6
          1 0001BF  2C00                                 LDV,R2   0
          1 0001C0  E855                                 LDR,R6   R5
          1 0001C1  BCC7 000F                            LDB,B3   OP$,AUTO
          1 0001C3  B847 0006                            LDR,R3   FPTSZ,AUTO
          1 0001C5  0008                                 MMM

      842    14624    2         FPTSZ = FPTSZ + KN$NETPARM.UHDRSZ ;

  14624   1 0001C6  E847 0006                            LDR,R6   FPTSZ,AUTO
          1 0001C8  EA45 0007                            ADD,R6   7,B5
          1 0001CA  EF47 0006                            STR,R6   FPTSZ,AUTO

      843    14625    2      END;

      844    14626
      845    14627    1      IF KN$NETPARM.MSGSZ ~= 0

  14627   1 0001CC  D845 0004                            LDR,R5   4,B5
          1 0001CE  5901 0015                            BEZ,R5   s:14635,PREL

      846    14628    2      THEN DO;

      847    14629    2         QQC$ = KN$NETPARM.MSG$;

  14629   1 0001D0  8CC5 0002                            LDI      2,B5
          1 0001D2  8D47 0011                            SDI      QQQ$,AUTO

      848    14630    2         MSGX = QQC.OFS/128;

  14630   1 0001D4  C2C7 0011                            LLH,R4   QQQ$,AUTO
PL6.E3A0      #002=KNH$SEND File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:04 Page:128  
          1 0001D6  4047                                 SOR,R4   7
          1 0001D7  CF47 0014                            STR,R4   CONN_TYPE,AUTO

      849    14631    2         QQC.OFS = 0;

  14631   1 0001D9  87C7 0011                            CLH      QQQ$,AUTO

      850    14632    2         PINCRC(OP$,FPTSZ)->MSG = PINCRC(QQQ$,MSGX)->MSG;

  14632   1 0001DB  ACC7 0011                            LDB,B2   QQQ$,AUTO
          1 0001DD  A854                                 LDR,R2   R4
          1 0001DE  E855                                 LDR,R6   R5
          1 0001DF  BCC7 000F                            LDB,B3   OP$,AUTO
          1 0001E1  B847 0006                            LDR,R3   FPTSZ,AUTO
          1 0001E3  0008                                 MMM

      851    14633    2      END;

      852    14634
      853    14635    1      KNH$HMI.RCQ.IPTR = KNH$HMI.RCQ.IPTR + TMSGSZ;

  14635   1 0001E4  ECC7 0008                            LDB,B6   HMI$,AUTO
          1 0001E6  E806                                 LDR,R6   ,B6
          1 0001E7  EA47 0013                            ADD,R6   TMSGSZ,AUTO
          1 0001E9  EF06                                 STR,R6   ,B6

      854    14636    1      KNH$QHDR.RCQ.IPTR = KNH$HMI.RCQ.IPTR;

  14636   1 0001EA  EF04                                 STR,R6   ,B4

      855    14637
      856    14638        /* Increment statistics */
      857    14639    1      KNH$QHDR.MSGS_RCQ = KNH$QHDR.MSGS_RCQ + 1;

  14639   1 0001EB  8AC4 0011                            INC      17,B4
          1 0001ED  8EC4 0010                            CAD      16,B4

PL6.E3A0      #002=KNH$SEND File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:04 Page:129  
      858    14640    1      KNH$QHDR.MBC_RCQ = KNH$QHDR.MBC_RCQ + TMSGSZ ;

  14640   1 0001EF  F847 0013                            LDR,R7   TMSGSZ,AUTO
          1 0001F1  6C00                                 LDV,R6   0
          1 0001F2  8444 0012                            AID      18,B4
          1 0001F4  8D44 0012                            SDI      18,B4

      859    14641
      860    14642
      861    14643    1      CALL GHS$RUE (%GH_EVWU,USER_NUM);

  14643   1 0001F6  BBF0 0002                            LAB,B3   2,IMO
          1 0001F8  ABC7 0015                            LAB,B2   USER_NUM,AUTO
          1 0001FA  AFC7 0020                            STB,B2   FPT_TERM+7,AUTO
          1 0001FC  BFC7 001E                            STB,B3   FPT_TERM+5,AUTO
          1 0001FE  BBC7 001E                            LAB,B3   FPT_TERM+5,AUTO
          1 000200  CBF0 0200                            LAB,B4   512,IMO
          1 000202  E380 0000 0000  xent                 LNJ,B6   GHS$RUE
          1 000205       0001                            DC       s:14640,PREL

  14640   1                              DONT_SEND_CLOSI*null
      862    14644
      863    14645    1   DONT_SEND_CLOSING: ;
      864    14646           %UNLOCK (G=KNH$HMI.RCQ.LOCK);

  14651   1 000206  ECC7 0008            DONT_SEND_CLOSI*LDB,B6   HMI$,AUTO
          1 000208  DBC6 0004                            LAB,B5   4,B6
          1 00020A  DFC7 001E                            STB,B5   FPT_TERM+5,AUTO
          1 00020C  BBC7 001E                            LAB,B3   FPT_TERM+5,AUTO
          1 00020E  CBF0 0100                            LAB,B4   256,IMO
          1 000210  E380 0000 0000  xent                 LNJ,B6   GHH$UNLOCK
          1 000213       0001                            DC       s:14653,PREL

      865    14653    1      IF FNCTN~=%KN_FCN_DATA

  14653   1 000214  E847 000B                            LDR,R6   FNCTN,AUTO
          1 000216  6D05                                 CMV,R6   5
PL6.E3A0      #002=KNH$SEND File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:04 Page:130  
          1 000217  0901 002A                            BE       s:14668,PREL

      866    14654    1      THEN
      867    14655    2      IF FNCTN=%KN_FCN_INIT_ACK THEN DO;

  14655   1 000219  6D02                                 CMV,R6   2
          1 00021A  0981 0018                            BNE      s:14663,PREL

      868    14656    2         IF ADDR(FPT)->FPT_CONNECT_ACK.REASON ~= 0

  14656   1 00021C  ECC7 0004                            LDB,B6   @KN$NETPARM,AUTO
          1 00021E  DCC6 0019                            LDB,B5   25,B6
          1 000220  D805                                 LDR,R5   ,B5
          1 000221  5901 000B                            BEZ,R5   s:14660,PREL

      869    14657    2         THEN
      870    14658    2         CALL KNA$RLSLDCT(KN$NETPARM.LDCT$);

  14658   1 000223  BBC7 0004                            LAB,B3   @KN$NETPARM,AUTO
          1 000225  CBF0 0100                            LAB,B4   256,IMO
          1 000227  E380 0000 0000  xent                 LNJ,B6   KNA$RLSLDCT
          1 00022A       0001                            DC       s:14658+8,PREL
          1 00022B  0F81 0016                            B        s:14668,PREL

      871    14659    2         ELSE
      872    14660    2         KNH$HMI.LDCTS# = KNH$HMI.LDCTS# + 1;

  14660   1 00022D  CCC7 0008                            LDB,B4   HMI$,AUTO
          1 00022F  8AC4 0018                            INC      24,B4

      873    14661    2      END;

  14661   1 000231  0F81 0010                            B        s:14668,PREL

      874    14662
      875    14663    2      ELSE IF FNCTN=%KN_FCN_TERM_ACK THEN DO;

PL6.E3A0      #002=KNH$SEND File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:04 Page:131  
  14663   1 000233  6D04                                 CMV,R6   4
          1 000234  0981 000D                            BNE      s:14668,PREL

      876    14664    2         CALL KNA$RLSLDCT(KN$NETPARM.LDCT$);

  14664   1 000236  BBC7 0004                            LAB,B3   @KN$NETPARM,AUTO
          1 000238  CBF0 0100                            LAB,B4   256,IMO
          1 00023A  E380 0000 0000  xent                 LNJ,B6   KNA$RLSLDCT
          1 00023D       0001                            DC       s:14665,PREL

      877    14665    2         KNH$HMI.LDCTS# = KNH$HMI.LDCTS# - 1;

  14665   1 00023E  ECC7 0008                            LDB,B6   HMI$,AUTO
          1 000240  88C6 0018                            DEC      24,B6

      878    14666    2      END;

      879    14667
      880    14668    1      RETURN;

  14668   1 000242  C380 0000 0000  xent                 LNJ,B4   X6A_ARET

      881    14669        %EJECT;
PL6.E3A0      #002=KNH$SEND File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:04 Page:132  
      882    14670    1   L_NSEND_DATA:
      883    14671    1      IF FNCTN = %KN_FCN_UNQ THEN

  14671   1 000245  2D08                 L_NSEND_DATA    CMV,R2   8
          1 000246  0981 0021                            BNE      s:14679,PREL

      884    14672    2      DO ;

      885    14673    2         CALL GHS$RUE (%GH_EVWU,USER_NUM);

  14673   1 000248  CBF0 0002                            LAB,B4   2,IMO
          1 00024A  BBC7 0015                            LAB,B3   USER_NUM,AUTO
          1 00024C  BFC7 0020                            STB,B3   FPT_TERM+7,AUTO
          1 00024E  CFC7 001E                            STB,B4   FPT_TERM+5,AUTO
          1 000250  BBC7 001E                            LAB,B3   FPT_TERM+5,AUTO
          1 000252  CBF0 0200                            LAB,B4   512,IMO
          1 000254  E380 0000 0000  xent                 LNJ,B6   GHS$RUE
          1 000257       0001                            DC       s:14674,PREL

      886    14674    2         HMI$ = G$USER.HMI$(USER_NUM);

  14674   1 000258  EC80 0000 0000  xsym                 LDB,B6   G$USRT$
          1 00025B  B847 0015                            LDR,R3   USER_NUM,AUTO
          1 00025D  3F0C                                 MLV,R3   12
          1 00025E  3E0A                                 ADV,R3   10
          1 00025F  DCB6                                 LDB,B5   ,B6,R3
          1 000260  DFC7 0008                            STB,B5   HMI$,AUTO

      887    14675    2         KNH$HMI.SCQ.SCANNED = '0'B;

  14675   1 000262  8845 000E                            LBF,'4000'X       14,B5
  14675   1 000264       4000

      888    14676    2         RETURN;

  14676   1 000265  C380 0000 0000  xent                 LNJ,B4   X6A_ARET

PL6.E3A0      #002=KNH$SEND File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:04 Page:133  
      889    14677    2      END ;
      890    14678
      891    14679    1      IF FNCTN = %KN_FCN_INIT THEN

  14679   1 000268  2D01                                 CMV,R2   1
          1 000269  0981 0012                            BNE      s:14689,PREL

      892    14680    2      DO ;

      893    14681    2         IF KN$LDCT.CONN_TYPE = %KN_CNTYPE_CIRCUIT THEN

  14681   1 00026B  3D07                                 CMV,R3   7
          1 00026C  0981 0006                            BNE      s:14684,PREL

      894    14682    2         FPTSZ = SIZEC(FPT_CONNECT_CIRCUIT);

  14682   1 00026E  1C5A                                 LDV,R1   90
          1 00026F  9F47 0006                            STR,R1   FPTSZ,AUTO
          1 000271  0F81 0004                            B        s:14685,PREL

      895    14683    2         ELSE
      896    14684    2         FPTSZ = SIZEC(FPT_CONNECT) ;

  14684   1 000273  1C26                                 LDV,R1   38
          1 000274  9F47 0006                            STR,R1   FPTSZ,AUTO

      897    14685    2         QQQ$ = ADDR(FPT);

  14685   1 000276  CCC6 0019                            LDB,B4   25,B6
          1 000278  CFC7 0011                            STB,B4   QQQ$,AUTO

      898    14686    2         GOTO OPUT ;

  14686   1 00027A  0F81 FDB9                            B        s:14484,PREL

      899    14687    2      END ;
      900    14688
PL6.E3A0      #002=KNH$SEND File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:04 Page:134  
      901    14689    1      IF FNCTN = %KN_FCN_INIT_ACK THEN

  14689   1 00027C  2D02                                 CMV,R2   2
          1 00027D  0981 000F                            BNE      s:14698,PREL

      902    14690    2      DO ;

      903    14691    2         FPTSZ = SIZEC(FPT_CONNECT_ACK) ;

  14691   1 00027F  1C0C                                 LDV,R1   12
          1 000280  9F47 0006                            STR,R1   FPTSZ,AUTO

      904    14692    2         QQQ$ = ADDR(FPT);

  14692   1 000282  CCC6 0019                            LDB,B4   25,B6
          1 000284  CFC7 0011                            STB,B4   QQQ$,AUTO

      905    14693    2         IF ADDR(FPT)->FPT_CONNECT_ACK.REASON~=0

  14693   1 000286  E804                                 LDR,R6   ,B4
          1 000287  6901 0003                            BEZ,R6   s:14695,PREL

      906    14694    2         THEN LDCT_NDX = 0;

  14694   1 000289  8747 0018                            CL       LDCT_NDX,AUTO

      907    14695    2         GOTO OPUT ;

  14695   1 00028B  0F81 FDA8                            B        s:14484,PREL

      908    14696    2      END ;
      909    14697
      910    14698    1      IF FNCTN = %KN_FCN_TERM THEN

  14698   1 00028D  2D03                                 CMV,R2   3
          1 00028E  0981 001A                            BNE      s:14712,PREL

PL6.E3A0      #002=KNH$SEND File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:04 Page:135  
      911    14699    2      DO ;

      912    14700    2         IF ADDR(FPT)=ADDR(NIL) THEN

  14700   1 000290  CCC6 0019                            LDB,B4   25,B6
          1 000292  8DD4                                 CMN      B4
          1 000293  0981 000E                            BNE      s:14707,PREL

      913    14701    3         DO ;

      914    14702    3            QQQ$ = ADDR(FPT_TERM) ;

  14702   1 000295  BBC7 0019                            LAB,B3   FPT_TERM,AUTO
          1 000297  BFC7 0011                            STB,B3   QQQ$,AUTO

      915    14703    3            FPT_TERM.RLCID = KN$LDCT.RLCID ;

  14703   1 000299  8CC5 0001                            LDI      1,B5
          1 00029B  8D47 0019                            SDI      FPT_TERM,AUTO

      916    14704    3            FPT_TERM.REASON = %KN_TERM_REASON_NTRNSPRT ;

  14704   1 00029D  1C03                                 LDV,R1   3
          1 00029E  9F47 001B                            STR,R1   FPT_TERM+2,AUTO

      917    14705    3         END ;

  14705   1 0002A0  0F81 0003                            B        s:14708,PREL

      918    14706    2         ELSE
      919    14707    2         QQQ$ = ADDR(FPT) ;

  14707   1 0002A2  CFC7 0011                            STB,B4   QQQ$,AUTO

      920    14708    2         FPTSZ = SIZEC(FPT_TERM);

  14708   1 0002A4  6C08                                 LDV,R6   8
PL6.E3A0      #002=KNH$SEND File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:04 Page:136  
          1 0002A5  EF47 0006                            STR,R6   FPTSZ,AUTO

      921    14709    2         GOTO OPUT;

  14709   1 0002A7  0F81 FD8C                            B        s:14484,PREL

      922    14710    2      END ;
      923    14711
      924    14712    1      IF FNCTN = %KN_FCN_TERM_ACK THEN

  14712   1 0002A9  2D04                                 CMV,R2   4
          1 0002AA  0901 FD7A                            BE       s:14480,PREL

      925    14713    1      GOTO L_SEND_DATA ;
      926    14714
      927    14715    1      IF FNCTN = %KN_FCN_UNCOUNT THEN

  14715   1 0002AC  2D09                                 CMV,R2   9
          1 0002AD  0981 001F                            BNE      s:14726,PREL

      928    14716    2      DO ;

      929    14717    2         HMI$ = G$USER.HMI$(USER_NUM);

  14717   1 0002AF  CC80 0000 0000  xsym                 LDB,B4   G$USRT$
          1 0002B2  9854                                 LDR,R1   R4
          1 0002B3  1F0C                                 MLV,R1   12
          1 0002B4  1E0A                                 ADV,R1   10
          1 0002B5  BC94                                 LDB,B3   ,B4,R1
          1 0002B6  BFC7 0008                            STB,B3   HMI$,AUTO

      930    14718    2         KNH$HMI.WAIT_COUNT = KNH$HMI.WAIT_COUNT - 1 ;

  14718   1 0002B8  88C3 0013                            DEC      19,B3

      931    14719    2         OP$ = KNH$HMI.WAIT_HEAD$ ;

PL6.E3A0      #002=KNH$SEND File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:04 Page:137  
  14719   1 0002BA  DCC3 0011                            LDB,B5   17,B3
          1 0002BC  DFC7 000F                            STB,B5   OP$,AUTO

      932    14720    2         KNH$HMI.WAIT_HEAD$ = OP$->KN$LDCT.LNK$ ;

  14720   1 0002BE  ACC5 0008                            LDB,B2   8,B5
          1 0002C0  AFC3 0011                            STB,B2   17,B3

      933    14721    2         OP$->KN$LDCT.LNK$ = ADDR(NIL) ;

  14721   1 0002C2  9B80 0000 0000                       LAB,B1   0
          1 0002C5  9FC5 0008                            STB,B1   8,B5

      934    14722    2         KNH$HMI.SCQ.SCANNED = '0'B;

  14722   1 0002C7  8843 000E                            LBF,'4000'X       14,B3
  14722   1 0002C9       4000

      935    14723    2         RETURN;

  14723   1 0002CA  C380 0000 0000  xent                 LNJ,B4   X6A_ARET

      936    14724    2      END;
      937    14725
      938    14726    1      CALL SCREECH(BADFNC);

  14726   1 0002CD  BB80 0000 0000  02                   LAB,B3   0
          1 0002D0  CBF0 0100                            LAB,B4   256,IMO
          1 0002D2  E380 0000 0000  xent                 LNJ,B6   SCREECH
          1 0002D5       0001                            DC       s:14726+9,PREL
          1 0002D6  0F81 0006                            B        s:14742,PREL

      939    14727
      940    14728        /*S* SCREECH_CODE: KNH-S$BADFNC
      941    14729             TYPE: SCREECH
      942    14730             MESSAGE: Bad function passed to Session
      943    14731        */
PL6.E3A0      #002=KNH$SEND File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:04 Page:138  
      944    14732        %EJECT;
PL6.E3A0      #002=KNH$SEND File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:04 Page:139  
      945    14733    1   KNH$SEND_LOOP: ENTRY (KN$NETPARM) ALTRET;

  14733   1 0002D8  D380 0000 0000  xent KNH$SEND_LOOP   LNJ,B5   X6A_AUTO_1
          1 0002DB       0022 0001                       DC       34,1

      946    14734        /*F*
      947    14735              NAME: KNH$SEND_LOOP
      948    14736              PURPOSE:
      949    14737                   To send an empty data message to the same user, preserving
      950    14738                   USER_ID, but possibly without any LDCT.  KN$NETPARM.LDCT$ points
      951    14739                   to the KN_FCN_LOOP message in the senders SCQ.
      952    14740        */
      953    14741
      954    14742    1      LDCT_NDX = KN$NETPARM.LDCT$->KNH$MESS.LDCTX;

  14742   1 0002DD  ECC7 0004                            LDB,B6   @KN$NETPARM,AUTO
          1 0002DF  DC86                                 LDB,B5   ,B6
          1 0002E0  E845 0001                            LDR,R6   1,B5
          1 0002E2  EF47 0018                            STR,R6   LDCT_NDX,AUTO

      955    14743    1      USER_ID = KN$NETPARM.LDCT$->KNH$MESS.UID;

  14743   1 0002E4  8CC5 0002                            LDI      2,B5
          1 0002E6  8D47 0016                            SDI      USER_ID,AUTO

      956    14744    1      USER_NUM = G$JIT.USR#;

  14744   1 0002E8  CC80 0000 0000  xsym                 LDB,B4   G$JIT$
          1 0002EB  D844 0004                            LDR,R5   4,B4
          1 0002ED  D570 00FF                            AND,R5   255,IMO
          1 0002EF  DF47 0015                            STR,R5   USER_NUM,AUTO

      957    14745    1      FNCTN = %KN_FCN_DATA;

  14745   1 0002F1  4C05                                 LDV,R4   5
          1 0002F2  CF47 000B                            STR,R4   FNCTN,AUTO

PL6.E3A0      #002=KNH$SEND File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:04 Page:140  
      958    14746    1      CONN_TYPE = %KN_CNTYPE_SESS;

  14746   1 0002F4  3C02                                 LDV,R3   2
          1 0002F5  BF47 0014                            STR,R3   CONN_TYPE,AUTO

      959    14747    1      FPTSZ = 0;

  14747   1 0002F7  8747 0006                            CL       FPTSZ,AUTO

      960    14748    1      GOTO OPUT;

  14748   1 0002F9  0F81 FD3A                            B        s:14484,PREL
      961    14749    1   END KNH$SEND;
      962    14750        %EOD;

PL6.E3A0      #002=KNH$SEND File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:04 Page:141  
--  Include file information  --

   K_INTERFACE_M.:E05TOU  is referenced.
   K_SCODE_C.:E05TOU  is referenced.
   K_ADDRESS_M.:E05TOU  is referenced.
   KI_CP6.:E05TOU  is referenced.
   KL_MACRO_C.:E05TOU  is referenced.
   GH_GATE_M.:E05TOU  cannot be made into a system file and is referenced.
   G_HJIT_M.:E05TOU  is referenced.
   G_JIT_M.:E05TOU  is referenced.
   GU_LCP6_M.:E05TOU  is referenced.
   GH_SCHD_M.:E05TOU  is referenced.
   GH_SCHD_E.:E05TOU  is referenced.
   GH_LCP6_M.:E05TOU  is referenced.
   KN_ERRORS_C.:E05TOU  is referenced.
   KNH_MACRO_C.:E05TOU  is referenced.
   KN_DATA_M.:E05TOU  is referenced.
      No diagnostics issued in procedure KNH$SEND.
PL6.E3A0      #002=KNH$SEND File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:04 Page:142  

 **** Variables and constants ****

  ****  Section 000 RoData KNH$SEND

  ****  Scalars and arrays  ****
HexLoc.c.b A Datatyp(siz) R M Lvl/name                 HexLoc.c.b A Datatyp(siz) R M Lvl/name

     8-0-0/w STRC(48)    r     1 BADFNC

  ****  Auto variables  ****

  ****  Scalars and arrays  ****
HexLoc.c.b A Datatyp(siz) R M Lvl/name                 HexLoc.c.b A Datatyp(siz) R M Lvl/name

     4-0-0/w PTR         r     1 @KN$NETPARM               14-0-0/w SBIN(16)    r     1 CONN_TYPE
     B-0-0/w UBIN(16)    r     1 FNCTN                      6-0-0/w SBIN(16)    r     1 FPTSZ
    19-0-0/w STRC(64)    r     1 FPT_TERM                   8-0-0/w PTR         r     1 HMI$
     C-0-0/w SBIN(16)    r     1 IPTR                      *0-0-0/w STRC(528)   r     1 KN$NETPARM
    18-0-0/w UBIN(16)    r     1 LDCT_NDX                   7-0-0/w UBIN(16)    r     1 MSGSZ
    14-0-0/w SBIN(16)    r     1 MSGX                       F-0-0/w PTR         r     1 OP$
    11-0-0/w STRC(32)    r     1 QQC                       11-0-0/w PTR         r     1 QQC$
    11-0-0/w PTR         r     1 QQQ$                       D-0-0/w SBIN(16)    r     1 RPTR
     E-0-0/w UBIN(16)    r     1 SZ                        13-0-0/w UBIN(16)    r     1 TMSGSZ
    16-0-0/w UBIN(32)    r     1 USER_ID                   15-0-0/w UBIN(16)    r     1 USER_NUM

  ****  SYMREF variables  ****

  ****  Scalars and arrays  ****
HexLoc.c.b A Datatyp(siz) R M Lvl/name                 HexLoc.c.b A Datatyp(siz) R M Lvl/name

     0-0-0/w PTR         r     1 G$JIT$                     0-0-0/w PTR         r     1 G$UHJIT$
     0-0-0/w PTR         r     1 G$USRT$                    0-0-0/w PTR         r     1 G$WINDOW1$

  ****  BASED and DCB variables  ****

  ****  Scalars and arrays  ****
HexLoc.c.b A Datatyp(siz) R M Lvl/name                 HexLoc.c.b A Datatyp(siz) R M Lvl/name
PL6.E3A0      #002=KNH$SEND File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:04 Page:143  

     0-0-0/c ACHR        r     1 FPT                        0-0-0/w STRC(304)   r     1 FPT_CONNECT
     0-0-0/w STRC(96)    r     1 FPT_CONNECT_ACK            0-0-0/w STRC(720)   r     1 FPT_CONNECT_CIRCUIT
     0-0-0/w STRC(176)   r     1 FPT_NSAP                   0-0-0/w STRC(5616)  r     1 G$JIT
     0-0-0/w STRC(6480)  r     1 G$UHJIT                    0-0-0/w STRC(384)   r     1 G$USER(0:0)
     0-0-0/w STRC(256)   r     1 KN$LDCT                    0-0-0/c STRC(400)   r     1 KNH$HMI
     0-0-0/c STRC(128)   r     1 KNH$MESS                   0-0-0/w STRC(384)   r     1 KNH$QHDR
     0-0-0/c ACHR        r     1 MSG                        0-0-0/w ACHR        r     1 NHDR
     0-0-0/w ACHR        r     1 SHDR                       0-0-0/c ACHR        r     1 THDR
     0-0-0/c ACHR        r     1 UHDR


   Procedure KNH$SEND requires 763 words for executable code.
   Procedure KNH$SEND requires 34 words of local(AUTO) storage.
PL6.E3A0      #002=KNH$SEND File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:04 Page:144  
          *** CROSS REFERENCE LISTING ***
**     DENOTES     IDENTIFIER DEFINITION
<<                 IDENTIFIER'S VALUE SET
>>                 IDENTIFIER'S VALUE USED
<>                 IDENTIFIER SET AND/OR USED
--                 IDENTIFIER REFERENCED
PL6.E3A0      #002=KNH$SEND File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:04 Page:145  
          MINI XREF LISTING

BADFNC
     14428**DCL     14726<>CALL
CONN_TYPE
     14315**DCL     14316--REDEF   14471<<ASSIGN  14504>>IF      14504>>IF      14508<<ASSIGN  14594>>IF
     14746<<ASSIGN
DONT_SEND_CLOSING
     14640**LABEL   14501--GOTO
FNCTN
     14253**DCL     14472<<ASSIGN  14474>>IF      14474<<ASSIGN  14475>>IF      14578>>ASSIGN  14653>>IF
     14655>>IF      14663>>IF      14671>>IF      14679>>IF      14689>>IF      14698>>IF      14712>>IF
     14715>>IF      14745<<ASSIGN
FPT
     14234**DCL     14483--ASSIGN  14590<<ASSIGN  14590>>ASSIGN  14656--IF      14685--ASSIGN  14692--ASSIGN
     14693--IF      14700--IF      14707--ASSIGN
FPTSZ
     14248**DCL     14234--IMP-SIZ 14249--REDEF   14480<<ASSIGN  14482<<ASSIGN  14513>>ASSIGN  14585>>ASSIGN
     14587>>IF      14590>>ASSIGN  14590>>ASSIGN  14593<<ASSIGN  14593>>ASSIGN  14600>>ASSIGN  14601<<ASSIGN
     14601>>ASSIGN  14607>>ASSIGN  14608<<ASSIGN  14608>>ASSIGN  14614>>ASSIGN  14615<<ASSIGN  14615>>ASSIGN
     14623>>ASSIGN  14624<<ASSIGN  14624>>ASSIGN  14632>>ASSIGN  14682<<ASSIGN  14684<<ASSIGN  14691<<ASSIGN
     14708<<ASSIGN  14747<<ASSIGN
FPT_CONNECT
     10528**DCL     14684--ASSIGN
FPT_CONNECT.RLCID.GENERATION
     10564**DCL     10565--REDEF
FPT_CONNECT.RLCID.LDCTX
     10565**DCL     10565--REDEF
FPT_CONNECT.TERMINAL_ID.TERM
     10553**DCL     10562--REDEF
FPT_CONNECT_ACK
     10479**DCL     14691--ASSIGN
FPT_CONNECT_ACK.REASON
     10483**DCL     14656>>IF      14693>>IF
PL6.E3A0      #002=KNH$SEND File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:04 Page:146  
FPT_CONNECT_ACK.UID.UID
     10509**DCL     10509--REDEF   10509--REDEF
FPT_CONNECT_CIRCUIT
     10597**DCL     14682--ASSIGN
FPT_CONNECT_CIRCUIT.DEST.ADDRESS_N
     10694**DCL     10695--REDEF
FPT_CONNECT_CIRCUIT.DSTSNPA.ADR_STRING
     10750**DCL     10750--REDEF
FPT_CONNECT_CIRCUIT.LADR.ADDRESS_N
     10746**DCL     10747--REDEF
FPT_CONNECT_CIRCUIT.RLCID.GENERATION
     10633**DCL     10634--REDEF
FPT_CONNECT_CIRCUIT.RLCID.LDCTX
     10634**DCL     10634--REDEF
FPT_CONNECT_CIRCUIT.TERMINAL_ID.TERM
     10622**DCL     10631--REDEF
FPT_NSAP
     10768**DCL     14482--ASSIGN
FPT_NSAP.NSAP.ADDRESS_N
     10821**DCL     10822--REDEF
FPT_TERM
     14334**DCL     14702--ASSIGN  14708--ASSIGN
FPT_TERM.REASON
     14339**DCL     14704<<ASSIGN
FPT_TERM.RLCID
     14338**DCL     14703<<ASSIGN
G$JIT.ERRLOG
     14144**DCL     14147--REDEF
G$JIT.JSUNIT
     13883**DCL     13884--REDEF
G$JIT.MCLS
     13882**DCL     13882--REDEF
G$JIT.TMRZ
     14151**DCL     14152--REDEF
G$JIT.USER_EXTIME
     13875**DCL     13876--REDEF
PL6.E3A0      #002=KNH$SEND File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:04 Page:147  
G$JIT.USER_MEMTIME
     13878**DCL     13878--REDEF
G$JIT.USER_SVTIME
     13877**DCL     13877--REDEF
G$JIT.USR#
     13872**DCL     14744>>ASSIGN
G$JIT$
     14243**DCL     13814--IMP-PTR 14744>>ASSIGN
G$UHJIT.ASDT_MCL.WINDOW1
     12097**DCL     14497<>CALL
G$UHJIT.ASDT_MCL.WINDOW1.BASE
     12099**DCL     14496<<ASSIGN
G$UHJIT.ASDT_MCL.WINDOW1.SIZE
     12101**DCL     14495<<ASSIGN
G$UHJIT.ISA_USR
     12266**DCL     12561--REDEF
G$UHJIT.ISA_USR.P$$
     12341**DCL     12341--REDEF
G$UHJIT.TSA_CP.ISA.P$$
     13548**DCL     13548--REDEF
G$UHJIT.TSA_CP.P$$
     13419**DCL     13419--REDEF   13420--REDEF
G$UHJIT.TSA_DB.ISA.P$$
     13160**DCL     13160--REDEF
G$UHJIT.TSA_DB.P$$
     13031**DCL     13031--REDEF   13032--REDEF
G$UHJIT.TSA_RTT.P$$
     13794**DCL     13794--REDEF   13795--REDEF
G$UHJIT.TSA_USR.ISA.P$$
     12750**DCL     12750--REDEF
G$UHJIT.TSA_USR.P$$
     12621**DCL     12621--REDEF   12622--REDEF
G$UHJIT$
     14244**DCL     10843--IMP-PTR 14495>>ASSIGN  14496>>ASSIGN  14497>>CALL
G$USER.HMI$
     14223**DCL     14487>>ASSIGN  14674>>ASSIGN  14717>>ASSIGN
PL6.E3A0      #002=KNH$SEND File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:04 Page:148  
G$USER.MISC
     14220**DCL     14220--REDEF
G$USRT$
     14242**DCL     14219--IMP-PTR 14487>>ASSIGN  14674>>ASSIGN  14717>>ASSIGN
G$WINDOW1$
     14245**DCL     10453--IMP-PTR 14497<>CALL    14531>>ASSIGN  14531>>ASSIGN  14538>>ASSIGN  14542>>ASSIGN
     14542>>ASSIGN  14543>>ASSIGN  14543>>ASSIGN  14573>>ASSIGN  14573>>ASSIGN  14582>>ASSIGN  14583>>ASSIGN
     14636>>ASSIGN  14639>>ASSIGN  14639>>ASSIGN  14640>>ASSIGN  14640>>ASSIGN
GHH$ASD
     14345**DCL-ENT 14497--CALL
GHH$LOCK
      4604**DCL-ENT 14493--CALL
GHH$UNLOCK
      4604**DCL-ENT 14567--CALL    14651--CALL
GHS$RUE
     14346**DCL-ENT 14546--CALL    14643--CALL    14673--CALL
HMI$
     14251**DCL     14226--IMP-PTR 14487<<ASSIGN  14493>>CALL    14495>>ASSIGN  14496>>ASSIGN  14499>>IF
     14516>>ASSIGN  14517>>ASSIGN  14521>>ASSIGN  14537>>ASSIGN  14558>>ASSIGN  14559>>ASSIGN  14560>>ASSIGN
     14560>>ASSIGN  14567>>CALL    14635>>ASSIGN  14635>>ASSIGN  14636>>ASSIGN  14651>>CALL    14660>>ASSIGN
     14660>>ASSIGN  14665>>ASSIGN  14665>>ASSIGN  14674<<ASSIGN  14675>>ASSIGN  14717<<ASSIGN  14718>>ASSIGN
     14718>>ASSIGN  14719>>ASSIGN  14720>>ASSIGN  14722>>ASSIGN
IPTR
     14256**DCL     14516<<ASSIGN  14519>>IF      14521>>ASSIGN  14523>>ASSIGN  14528>>IF      14531>>ASSIGN
     14532>>ASSIGN  14539<<ASSIGN  14550>>IF      14550>>IF      14573>>ASSIGN  14574>>ASSIGN  14583>>ASSIGN
KN$LDCT.CONN_TYPE
     10223**DCL     14471>>ASSIGN  14681>>IF
KN$LDCT.FLAGS.QUEUED
     10399**DCL     14554>>IF      14557<<ASSIGN
KN$LDCT.LDCTX
     10364**DCL     14469>>ASSIGN
KN$LDCT.LNK$
     10368**DCL     14558<<ASSIGN  14720>>ASSIGN  14721<<ASSIGN
KN$LDCT.RLCID
     10255**DCL     14703>>ASSIGN
KN$LDCT.RLCID.LDCTX
PL6.E3A0      #002=KNH$SEND File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:04 Page:149  
     10283**DCL     10290--REDEF   10298--REDEF
KN$LDCT.TRANSPORT_ID
     10317**DCL     10325--REDEF
KN$LDCT.UID
     10347**DCL     10348--REDEF   10357--REDEF   14468>>ASSIGN
KN$LDCT.USER#
     10440**DCL     14470>>ASSIGN
KN$NETPARM
     10065**DCL        16--PROC    14733--ENTRY
KN$NETPARM.ERRCODE
     10172**DCL     14549<<ASSIGN  14552<<ASSIGN  14556<<ASSIGN
KN$NETPARM.FPT$
     10184**DCL     14234--IMP-PTR 14481>>IF      14483>>ASSIGN  14656>>IF      14685>>ASSIGN  14692>>ASSIGN
     14693>>IF      14700>>IF      14707>>ASSIGN
KN$NETPARM.FUNCTION
     10160**DCL     14472>>ASSIGN
KN$NETPARM.LDCT$
     10066**DCL     10222--IMP-PTR 14468>>ASSIGN  14469>>ASSIGN  14470>>ASSIGN  14471>>ASSIGN  14658<>CALL
     14664<>CALL    14681>>IF      14703>>ASSIGN  14742>>ASSIGN  14743>>ASSIGN
KN$NETPARM.MSG$
     10072**DCL     10077--REDEF   14629>>ASSIGN
KN$NETPARM.MSGSZ
     10083**DCL     14235--IMP-SIZ 14503>>ASSIGN  14627>>IF      14632>>ASSIGN  14632>>ASSIGN
KN$NETPARM.NHDR$
     10124**DCL     10125--REDEF   14600>>ASSIGN
KN$NETPARM.NHDRSZ
     10130**DCL     14239--IMP-SIZ 14509>>ASSIGN  14597>>IF      14600>>ASSIGN  14600>>ASSIGN  14601>>ASSIGN
KN$NETPARM.RECTYPE
     10151**DCL     14581>>ASSIGN
KN$NETPARM.SHDR$
     10102**DCL     10103--REDEF   14614>>ASSIGN
KN$NETPARM.SHDRSZ
     10108**DCL     14237--IMP-SIZ 14509>>ASSIGN  14611>>IF      14614>>ASSIGN  14614>>ASSIGN  14615>>ASSIGN
KN$NETPARM.SLDCT$
     10179**DCL     14554>>IF      14554>>IF      14557>>ASSIGN  14558>>ASSIGN  14559>>ASSIGN
KN$NETPARM.THDR$
PL6.E3A0      #002=KNH$SEND File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:04 Page:150  
     10113**DCL     10114--REDEF
KN$NETPARM.THDRSZ
     10119**DCL     14238--IMP-SIZ 14509>>ASSIGN  14604>>IF      14607>>ASSIGN  14607>>ASSIGN  14608>>ASSIGN
KN$NETPARM.THDR_C$
     10114**DCL     14607>>ASSIGN
KN$NETPARM.UHDR$
     10088**DCL     10089--REDEF   14623>>ASSIGN
KN$NETPARM.UHDRSZ
     10097**DCL     14236--IMP-SIZ 14503>>ASSIGN  14620>>IF      14623>>ASSIGN  14623>>ASSIGN  14624>>ASSIGN
KNA$RLSLDCT
     14344**DCL-ENT 14658--CALL    14664--CALL
KNH$HMI.LDCTS#
     14230**DCL     14660<<ASSIGN  14660>>ASSIGN  14665<<ASSIGN  14665>>ASSIGN
KNH$HMI.PP#
     14229**DCL     14496>>ASSIGN
KNH$HMI.PPSZ
     14230**DCL     14495>>ASSIGN
KNH$HMI.RCQ.IPTR
     14226**DCL     14516>>ASSIGN  14537<<ASSIGN  14635<<ASSIGN  14635>>ASSIGN  14636>>ASSIGN
KNH$HMI.RCQ.LOCK
     14226**DCL     14493<>CALL    14567<>CALL    14651<>CALL
KNH$HMI.RCQ.RPTR
     14226**DCL     14517>>ASSIGN
KNH$HMI.RCQ.SZ
     14226**DCL     14521>>ASSIGN
KNH$HMI.SCQ.CLOSING
     14228**DCL     14499>>IF
KNH$HMI.SCQ.SCANNED
     14228**DCL     14675<<ASSIGN  14722<<ASSIGN
KNH$HMI.WAIT_COUNT
     14229**DCL     14560<<ASSIGN  14560>>ASSIGN  14718<<ASSIGN  14718>>ASSIGN
KNH$HMI.WAIT_HEAD$
     14229**DCL     14558>>ASSIGN  14559<<ASSIGN  14719>>ASSIGN  14720<<ASSIGN
KNH$MESS
     14278**DCL     14513--ASSIGN  14521--ASSIGN  14590--ASSIGN  14593--ASSIGN
KNH$MESS.FPTSZ
PL6.E3A0      #002=KNH$SEND File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:04 Page:151  
     14311**DCL     14535<<ASSIGN  14585<<ASSIGN
KNH$MESS.FUNCTION
     14278**DCL     14278--REDEF   14534<<ASSIGN  14578<<ASSIGN
KNH$MESS.LAST_PTR
     14311**DCL     14582<<ASSIGN
KNH$MESS.LDCTX
     14283**DCL     14533<<ASSIGN  14580<<ASSIGN  14742>>ASSIGN
KNH$MESS.MSGSZ
     14312**DCL     14536<<ASSIGN  14584<<ASSIGN
KNH$MESS.RECTYPE
     14311**DCL     14581<<ASSIGN
KNH$MESS.UID
     14308**DCL     14308--REDEF   14308--REDEF   14579<<ASSIGN  14743>>ASSIGN
KNH$QHDR.LAST_RCQPTR
     10462**DCL     14582>>ASSIGN  14583<<ASSIGN
KNH$QHDR.MBC_RCQ
     10461**DCL     14640<<ASSIGN  14640>>ASSIGN
KNH$QHDR.MSGS_RCQ
     10461**DCL     14542<<ASSIGN  14542>>ASSIGN  14639<<ASSIGN  14639>>ASSIGN
KNH$QHDR.RCQ
     10453**DCL     10453--REDEF
KNH$QHDR.RCQ.IPTR
     10453**DCL     14538<<ASSIGN  14636<<ASSIGN
KNH$QHDR.RCQ.OFFSET
     10453**DCL     14531>>ASSIGN  14573>>ASSIGN
KNH$QHDR.WRAP_RCQ
     10462**DCL     14543<<ASSIGN  14543>>ASSIGN
LDCT_NDX
     14319**DCL     14469<<ASSIGN  14580>>ASSIGN  14694<<ASSIGN  14742<<ASSIGN
L_IT_FITS
     14573**LABEL   14545--GOTO
L_NSEND_DATA
     14671**LABEL   14476--GOTO
L_SEND_DATA
     14480**LABEL   14713--GOTO
MESS_CON.FUNCTION
PL6.E3A0      #002=KNH$SEND File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:04 Page:152  
     14364**DCL     14364--REDEF
MESS_CON.UID
     14394**DCL     14394--REDEF   14394--REDEF
MSG
     14235**DCL     14632<<ASSIGN  14632>>ASSIGN
MSGSZ
     14250**DCL     14503<<ASSIGN  14509<<ASSIGN  14509>>ASSIGN  14513>>ASSIGN  14584>>ASSIGN
MSGX
     14316**DCL     14630<<ASSIGN  14632>>ASSIGN
NHDR
     14239**DCL     14600<<ASSIGN  14600>>ASSIGN
OP$
     14259**DCL     14278--IMP-PTR 14531<<ASSIGN  14532<<ASSIGN  14532>>ASSIGN  14533>>ASSIGN  14534>>ASSIGN
     14535>>ASSIGN  14536>>ASSIGN  14573<<ASSIGN  14574<<ASSIGN  14574>>ASSIGN  14578>>ASSIGN  14579>>ASSIGN
     14580>>ASSIGN  14581>>ASSIGN  14582>>ASSIGN  14584>>ASSIGN  14585>>ASSIGN  14590>>ASSIGN  14600>>ASSIGN
     14607>>ASSIGN  14614>>ASSIGN  14623>>ASSIGN  14632>>ASSIGN  14719<<ASSIGN  14720>>ASSIGN  14721>>ASSIGN
OPUT
     14487**LABEL   14686--GOTO    14695--GOTO    14709--GOTO    14748--GOTO
QQC.OFS
     14263**DCL     14630>>ASSIGN  14631<<ASSIGN
QQC$
     14261**DCL     14629<<ASSIGN
QQQ$
     14260**DCL     14261--REDEF   14262--REDEF   14483<<ASSIGN  14590>>ASSIGN  14632>>ASSIGN  14685<<ASSIGN
     14692<<ASSIGN  14702<<ASSIGN  14707<<ASSIGN
RPTR
     14257**DCL     14517<<ASSIGN  14519>>IF      14523>>ASSIGN  14528>>IF      14528>>IF      14540>>ASSIGN
     14550>>IF
SCREECH
     14347**DCL-ENT 14726--CALL
SHDR
     14237**DCL     14614<<ASSIGN  14614>>ASSIGN
SZ
     14258**DCL     14521<<ASSIGN  14523<<ASSIGN  14525>>IF      14536>>ASSIGN  14540<<ASSIGN  14544>>IF
THDR
     14238**DCL     14607<<ASSIGN  14607>>ASSIGN
PL6.E3A0      #002=KNH$SEND File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:04 Page:153  
TMSGSZ
     14314**DCL     14513<<ASSIGN  14525>>IF      14544>>IF      14635>>ASSIGN  14640>>ASSIGN
UHDR
     14236**DCL     14623<<ASSIGN  14623>>ASSIGN
USER_ID
     14318**DCL     14468<<ASSIGN  14579>>ASSIGN  14743<<ASSIGN
USER_NUM
     14317**DCL     14470<<ASSIGN  14487>>ASSIGN  14546<>CALL    14643<>CALL    14673<>CALL    14674>>ASSIGN
     14717>>ASSIGN  14744<<ASSIGN

PL6.E3A0      #003=KNH$OPEN File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:05 Page:154  
      963        1        /*T***********************************************************/
      964        2        /*T*                                                         */
      965        3        /*T* Copyright (c) Bull HN Information Systems Inc., 1997    */
      966        4        /*T*                                                         */
      967        5        /*T***********************************************************/
      968        6        /*X*     NSO,PLM=3,SQB=Y,AND=Y,ENI=0,SDI=3,MCL=10,CSI=0,ECI=0,IAD=3,IND=0 */
      969        7        KNH$OPEN: PROC (VLP_HMI,ERR) ALTRET;
      970        8
      971        9        /*F* NAME: KNH$OPEN
      972       10             PURPOSE:
      973       11                  To open the Handler Monitor Interface for a handler.
      974       12             DESCRIPTION:
      975       13                  When an M$OPEN is issued by a handler with ORG=HMI,
      976       14                  this routine acquires the memory and sets up the users
      977       15                  map for the HMI.
      978       16              */
      979       17
      980       18        /* Include files */
      981       19        %INCLUDE KN_ERRORS_C;
      982       83        %INCLUDE GF_LCP6_M;
      983      551        %INCLUDE GH_LCP6_M;
      984     1385        %INCLUDE GH_SCHD_E;
      985     1481        %INCLUDE GH_SCHD_M;
      986     1625        %INCLUDE GM_MACRO_M;
      987     2107        %INCLUDE GM_VIRTUAL_E;
      988     2317        %INCLUDE G_LCP6_E;
      989     2575        %INCLUDE GU_LCP6_M;
      990     3503        %INCLUDE G_HJIT_M;
      991     3648        %INCLUDE G_JIT_M;
      992     3913        %INCLUDE GH_GATE_M;
      993     3954        %INCLUDE KN_DATA_M;
      994     5740        %INCLUDE KNH_MACRO_C;
      995     6023        %INCLUDE K_REASON_C;
      996     6049
      997     6050        /* Parameters */
      998     6051        %VLP_HMI (STCLASS="");
      999     6067    1   DCL ERR BIT(32) ALIGNED;                /* Error code returned if an altret   */
PL6.E3A0      #003=KNH$OPEN File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:05 Page:155  
     1000     6068
     1001     6069        /* Entry point references */
     1002     6070    1   DCL GHS$REG ENTRY(2) ALTRET;
     1003     6071    1   DCL GHH$ASD ENTRY(2);
     1004     6072    1   DCL GMA$GET ENTRY(5) ALTRET;
     1005     6073    1   DCL GMA$GETIO ENTRY(5) ALTRET;
     1006     6074    1   DCL GMA$REL ENTRY(2) ALTRET;
     1007     6075    1   DCL GMA$REL_ACCTMEM ENTRY(1) ALTRET;
     1008     6076    1   DCL GMA$CHKSIZE ENTRY(1) ALTRET;
     1009     6077    1   DCL KNH$SCAN ENTRY(2) ALTRET;
     1010     6078    1   DCL KNN$RECV ENTRY(1) ALTRET;
     1011     6079    1   DCL KNS$SEND ENTRY(1) ALTRET;
     1012     6080    1   DCL KNB$INIT ENTRY;
     1013     6081
     1014     6082        /* Macro invocations */
     1015     6083        %G$UHJIT (STCLASS="BASED(G$UHJIT$)");
     1016     9057        %G$JIT (STCLASS="BASED(G$JIT$)");
     1017     9471        %G$USER (FPTN="G$USER(0:0)",STCLASS="BASED(G$USRT$)");
     1018     9482        %GATE (FPTN=G$GATE, STCLASS=BASED);
     1019     9501        %KNH$HMI (STCLASS="BASED(HMI$)");
     1020     9508        %KNH$QHDR (STCLASS="BASED(G$HAND_Q$)");
     1021     9521        %KN$LDCT(STCLASS="BASED(DCT$)");
     1022     9766        %KN$DCT$;
     1023     9769        %GM_CHKSZ_PARAMS (FPTN=CHKSZ, STCLASS=AUTO);
     1024     9863        %KN$NETPARM(STCLASS=AUTO,NAME=NETPARM) ;
     1025    10016        %FPT_TERM(FPTN=FPT$TERM,STCLASS=AUTO);
     1026    10038        %FPT_CONNECT_ACK (FPTN=FPT$CONNECT_ACK,STCLASS=AUTO);
     1027    10087
     1028    10088        /* Symref items */
     1029    10089        %KN$NETPARM (NAME=KN_NETPARM_INIT,STCLASS=SYMREF);
     1030    10242    1   DCL G$JIT$ PTR SYMREF READONLY;
     1031    10243    1   DCL G$UHJIT$ PTR SYMREF;
     1032    10244    1   DCL G$USRT$ PTR SYMREF;
     1033    10245    1   DCL G$HAND_Q$ PTR SYMREF;
     1034    10246    1   DCL KN_LDCT_MAX# UBIN SYMREF;
     1035    10247    1   DCL KN_HMI$ PTR SYMREF;
     1036    10248    1   DCL KN_HMI# UBIN SYMREF;
PL6.E3A0      #003=KNH$OPEN File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:05 Page:156  
     1037    10249    1   DCL KN_DCT$$ PTR SYMREF;
     1038    10250
     1039    10251        /* Auto variables */
     1040    10252    1   DCL PPS UBIN;
     1041    10253    1   DCL HMI$ PTR;
     1042    10254    1   DCL I UBIN;
     1043    10255    1   DCL USR# UBIN;
     1044    10256    1   DCL DCT$ PTR ;
     1045    10257        /* Error codes */
     1046    10258        %VLP_ERRCODE (FPTN=NOCQMEM,
     1047    10259         FCG=KN,
     1048    10260         MID=H,
     1049    10261         MON='1'B,
     1050    10262         ERR#=%E$NOCQMEM,
     1051    10263         SEV=G_SEV_ERROR#,
     1052    10264         STCLASS=CONSTANT);
     1053    10310        /*E*
     1054    10311             ERROR: KNH-E$NOCQMEM-G_SEV_ERR#
     1055    10312             MESSAGE1: No memory available for Handler Monitor Interface
     1056    10313         */
     1057    10314        %VLP_ERRCODE (FPTN=NOHMI,
     1058    10315         FCG=KN,
     1059    10316         MID=H,
     1060    10317         MON='1'B,
     1061    10318         ERR#=%E$NOHMI,
     1062    10319         SEV=G_SEV_ERROR#,
     1063    10320         STCLASS=CONSTANT);
     1064    10366        /*E*
     1065    10367             ERROR: KNH-E$NOHMI-G_SEV_ERROR#
     1066    10368             MESSAGE: No HMI entry available.
     1067    10369             MESSAGE1: All the available HMI entries are used.
     1068    10370             */
     1069    10371        %VLP_ERRCODE (FPTN=ONEHMI,
     1070    10372         FCG=KN,
     1071    10373         MID=H,
     1072    10374         MON='1'B,
     1073    10375         ERR#=%E$ONEHMI,
PL6.E3A0      #003=KNH$OPEN File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:05 Page:157  
     1074    10376         SEV=G_SEV_ERROR#,
     1075    10377         STCLASS=CONSTANT);
     1076    10423        /*E*
     1077    10424             ERROR: KNH-E$ONEHMI-G_SEV_ERR#
     1078    10425             MESSAGE1: Only one DCB open to ORG=CQ is allowed
     1079    10426         */
     1080    10427
     1081    10428
     1082    10429
     1083    10430        %EJECT;
PL6.E3A0      #003=KNH$OPEN File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:05 Page:158  
     1084    10431    1      IF G$USER.HMI$(G$JIT.USR#) ~= ADDR(NIL)
     1085    10432    2      THEN DO;
     1086    10433    2         ERR = ONEHMI;
     1087    10434    2         ALTRETURN;
     1088    10435    2      END;
     1089    10436        /* Find an available HMI slot for this user */
     1090    10437    1      HMI$ = KN_HMI$ ;
     1091    10438    1   L_LEXIT:
     1092    10439    2      DO ;
     1093    10440    3         DO I = 1 TO KN_HMI#;
     1094    10441                 %LOCK (G=KNH$HMI.SCQ.LOCK);
     1095    10448    3            IF KNH$HMI.USER# = 0
     1096    10449    3            THEN
     1097    10450    3            EXIT L_LEXIT ;
     1098    10451
     1099    10452                 %UNLOCK (G=KNH$HMI.SCQ.LOCK);
     1100    10459
     1101    10460    3            HMI$ = PINCRW(HMI$,SIZEW(KNH$HMI)) ;
     1102    10461    3         END;
     1103    10462    2         ERR = NOHMI;
     1104    10463    2         ALTRETURN;
     1105    10464    2      END L_LEXIT ;
     1106    10465
     1107    10466    1      KNH$HMI.USER# = G$JIT.USR#;
     1108    10467           %UNLOCK (G=KNH$HMI.SCQ.LOCK);
     1109    10474
     1110    10475    1      PPS = (VLP_HMI.CTXSIZE + VLP_HMI.RCQSIZE +
     1111    10476    1        VLP_HMI.SCQSIZE + SIZEW(KNH$QHDR) + 255)/256;
     1112    10477
     1113    10478    1      CHKSZ='0'B;
     1114    10479    1      CHKSZ.SIZE = PPS;
     1115    10480    1      CHKSZ.FLGS.REQ_ALL = '1'B;
     1116    10481    1      CHKSZ.FLGS.PARK = '1'B;
     1117    10482    1      IF VLP_HMI.IO THEN CHKSZ.FLGS.NSHUF = '1'B;
     1118    10483    1      CALL GMA$CHKSIZE(CHKSZ)
     1119    10484    2      WHENALTRETURN DO;
     1120    10485    2         KNH$HMI.USER# = 0;
PL6.E3A0      #003=KNH$OPEN File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:05 Page:159  
     1121    10486    2         ERR = NOCQMEM;
     1122    10487    2         ALTRETURN;
     1123    10488    2      END;
     1124    10489    1      IF CHKSZ.FLGS.NSHUF
     1125    10490    2      THEN DO;
     1126    10491    2         CALL GMA$GETIO (%GM_HAND_Q#,PPS,%G_R_USR#,%G_R_USR#,%G_RING0#)
     1127    10492    3         WHENALTRETURN DO;
     1128    10493    3            ERR = NOCQMEM;
     1129    10494    3            ALTRETURN;
     1130    10495    3         END;
     1131    10496    2      END;
     1132    10497    2      ELSE DO;
     1133    10498    2         CALL GMA$GET (%GM_HAND_Q#,PPS,%G_R_USR#,%G_R_USR#,%G_RING0#);
     1134    10499    2      END;
     1135    10500
     1136    10501    1      G$JIT.CQPC = G$JIT.CQPC + PPS;
     1137    10502
     1138    10503        /* Put HMI index into user table */
     1139    10504    1      G$USER.HMI$(G$JIT.USR#) = HMI$ ;
     1140    10505    1      KNH$HMI.PP# = G$UHJIT.ASDT_USR.HAND_Q.BASE;
     1141    10506    1      KNH$HMI.PPSZ = PPS - 1;
     1142    10507
     1143    10508    1      G$UHJIT.ASDT_MCL.HAND_Q = G$UHJIT.ASDT_USR.HAND_Q;
     1144    10509    1      CALL GHH$ASD(G$HAND_Q$,G$UHJIT.ASDT_MCL.HAND_Q);
     1145    10510
     1146    10511        /* Initialize the header */
     1147    10512    1      KNH$QHDR = '0'B;
     1148    10513
     1149    10514        /* Use all the memory we allocated. */
     1150    10515    1      PPS = (PPS*256 - SIZEW(KNH$QHDR) -
     1151    10516    1        VLP_HMI.CTXSIZE - VLP_HMI.RCQSIZE - VLP_HMI.SCQSIZE)/2;
     1152    10517    1      KNH$QHDR.RCQ.SZ = (VLP_HMI.RCQSIZE + PPS)/2;
     1153    10518    1      KNH$QHDR.SCQ.SZ = (VLP_HMI.SCQSIZE + PPS)/2;
     1154    10519    1      KNH$QHDR.CTX.SZ = VLP_HMI.CTXSIZE;
     1155    10520    1      KNH$QHDR.CTX.OFFSET = SIZEW(KNH$QHDR);
     1156    10521    1      KNH$QHDR.RCQ.OFFSET = KNH$QHDR.CTX.OFFSET + VLP_HMI.CTXSIZE;
     1157    10522    1      KNH$QHDR.SCQ.OFFSET = KNH$QHDR.RCQ.OFFSET + KNH$QHDR.RCQ.SZ*2;
PL6.E3A0      #003=KNH$OPEN File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:05 Page:160  
     1158    10523        /* Initialize KNH$HMI */
     1159    10524    1      KNH$HMI.SCQ = KNH$QHDR.SCQ;
     1160    10525    1      KNH$HMI.RCQ = KNH$QHDR.RCQ;
     1161    10526    1      ADDR(KNH$HMI.SCQ.LOCK)->G$GATE.FLG = '1'B;
     1162    10527    1      ADDR(KNH$HMI.RCQ.LOCK)->G$GATE.FLG = '1'B;
     1163    10528    1      KNH$HMI.WAIT_HEAD$ = ADDR(NIL);
     1164    10529    1      KNH$HMI.WAIT_COUNT = 0;
     1165    10530    1      KNH$HMI.CTX.SZ = VLP_HMI.CTXSIZE;
     1166    10531    1      KNH$HMI.CTX.OFFSET = SIZEW(KNH$QHDR);
     1167    10532    1      KNH$HMI.SCQ.SCANNED = '0'B;
     1168    10533    1      KNH$HMI.SCQ.CLOSING = '0'B;
     1169    10534
     1170    10535        /* If this is user 1 initialize the monitor connection */
     1171    10536    1      IF KNH$HMI.USER# = 1
     1172    10537    1      THEN
     1173    10538    1      CALL KNB$INIT;
     1174    10539    1      RETURN;
     1175    10540
     1176    10541        %EJECT;
PL6.E3A0      #003=KNH$OPEN File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:05 Page:161  
     1177    10542    1   KNH$CLOSE: ENTRY ALTRET;
     1178    10543
     1179    10544        /*F*  NAME:    KNH$CLOSE
     1180    10545              PURPOSE: To close down a circular queue.
     1181    10546              DESCRIPTION:
     1182    10547                       All LDCTs associated with the queue are terminated
     1183    10548              and the ASDTs are NILed out.  The memory for the queue is
     1184    10549              released.
     1185    10550                                                        */
     1186    10551
     1187    10552    1      USR# = G$JIT.USR# ;
     1188    10553    1      HMI$ = G$USER.HMI$(USR#) ;
     1189    10554    1      PPS = KNH$HMI.PPSZ + 1 ;
     1190    10555    1      KNH$HMI.SCQ.CLOSING = '1'B;
     1191    10556
     1192    10557        /* Call KNH$SCAN to free up anyone waiting for this HMI interface */
     1193    10558    1      CALL KNH$SCAN;
     1194    10559
     1195    10560
     1196    10561    2      DO WHILE (KNH$HMI.LDCTS# > 0);
     1197    10562
     1198    10563    3         DO I = 1 TO KN_LDCT_MAX# ;
     1199    10564
     1200    10565    3            DCT$ = KN$DCT$(I) ;
     1201    10566    3            IF DCT$ ~= ADDR(NIL) THEN
     1202    10567    3            IF KN$LDCT.STATE ~= %KN_ST_NULL THEN
     1203    10568    3            IF USR# = KN$LDCT.USER# THEN
     1204    10569    4            DO ;
     1205    10570    4               NETPARM = KN_NETPARM_INIT;
     1206    10571    4               NETPARM.LDCT$ = DCT$ ;
     1207    10572    4               FPT$TERM.RLCID = KN$LDCT.RLCID ;
     1208    10573    4               FPT$TERM.REASON = %KN_TERM_REASON_CLOSE ;
     1209    10574    4               FPT$CONNECT_ACK.REASON = %K_REASON_USRREJ;
     1210    10575
     1211    10576    4               IF KN$LDCT.CONN_TYPE=%KN_CNTYPE_LINK
     1212    10577    5               THEN DO;
     1213    10578    5                  NETPARM.FUNCTION = %KN_FCN_TERM;
PL6.E3A0      #003=KNH$OPEN File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:05 Page:162  
     1214    10579    5                  NETPARM.FPT$ = ADDR(FPT$TERM);
     1215    10580    5                  CALL KNN$RECV(NETPARM);
     1216    10581    5               END;
     1217    10582    4               ELSE
     1218    10583    5               DO CASE (KN$LDCT.STATE);
     1219    10584
     1220    10585    5               CASE (%KN_ST_ACTIVE);
     1221    10586    5                  NETPARM.FUNCTION = %KN_FCN_TERM;
     1222    10587    5                  NETPARM.FPT$ = ADDR(FPT$TERM);
     1223    10588    5                  CALL KNS$SEND(NETPARM);
     1224    10589
     1225    10590    5               CASE (%KN_ST_WIAFL,%KN_ST_WTIAFLNT,%KN_ST_WTAFLNT);
     1226    10591    5                  NETPARM.FUNCTION = %KN_FCN_INIT_ACK;
     1227    10592    5                  NETPARM.FPT$ = ADDR(FPT$CONNECT_ACK);
     1228    10593    5                  CALL KNS$SEND(NETPARM);
     1229    10594
     1230    10595    5               CASE (%KN_ST_WTAFL);
     1231    10596    5                  NETPARM.FUNCTION = %KN_FCN_TERM;
     1232    10597    5                  NETPARM.FPT$ = ADDR(FPT$TERM);
     1233    10598    5                  CALL KNS$SEND(NETPARM);
     1234    10599
     1235    10600    5               END;
     1236    10601    4            END ;
     1237    10602
     1238    10603    3         END ;
     1239    10604
     1240    10605    2         CALL GHS$REG(%GH_EVSL,10);
     1241    10606    2      END;                                 /* DO WHILE (KNH$HMI.LDCTS# > 0)      */
     1242    10607
     1243    10608
     1244    10609    1      G$USER.HMI$(USR#) = ADDR(NIL);
     1245    10610    1      G$UHJIT.ASDT_MCL.HAND_Q.V = '0'B;
     1246    10611    1      CALL GMA$REL_ACCTMEM(PPS);
     1247    10612    1      CALL GMA$REL(%GM_HAND_Q#,PPS);
     1248    10613    1      G$JIT.CQPC = G$JIT.CQPC - PPS;
     1249    10614    1      KNH$HMI.USER# = 0 ;
     1250    10615
PL6.E3A0      #003=KNH$OPEN File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:05 Page:163  
     1251    10616    1      RETURN ;
     1252    10617
     1253    10618    1   END KNH$OPEN;

PL6.E3A0      #003=KNH$OPEN File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:05 Page:164  
--  Include file information  --

   K_REASON_C.:E05TOU  is referenced.
   KNH_MACRO_C.:E05TOU  is referenced.
   KN_DATA_M.:E05TOU  is referenced.
   GH_GATE_M.:E05TOU  cannot be made into a system file and is referenced.
   G_JIT_M.:E05TOU  is referenced.
   G_HJIT_M.:E05TOU  is referenced.
   GU_LCP6_M.:E05TOU  is referenced.
   G_LCP6_E.:E05TOU  is referenced.
   GM_VIRTUAL_E.:E05TOU  is referenced.
   GM_MACRO_M.:E05TOU  is referenced.
   GH_SCHD_M.:E05TOU  is referenced.
   GH_SCHD_E.:E05TOU  is referenced.
   GH_LCP6_M.:E05TOU  is referenced.
   GF_LCP6_M.:E05TOU  is referenced.
   KN_ERRORS_C.:E05TOU  is referenced.
      No diagnostics issued in procedure KNH$OPEN.

   Procedure KNH$OPEN requires 709 words for executable code.
   Procedure KNH$OPEN requires 72 words of local(AUTO) storage.

    No errors detected in file KNH$HMI.:E05TSI    .

PL6.E3A0      #003=KNH$OPEN File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:05 Page:165  

 Object Unit name= KNH$OPEN                                   File name= KNH$HMI.:E05TOU
 UTS= JUL 30 '97 01:05:51.20 WED                              Compiler= PL-6/E31         Sev=      00
 SharedLib= :SHARED_LCP6_SYSTEM                               Alt SharedLib=


    ****  Control sections  ****

 Sect   Type Bound  Init  Size HexSiz  Section name
    0  RoData even  UTS      6      6  KNH$OPEN
    1   Proc  even  none   709    2C5  KNH$OPEN
    2  RoData even  none     6      6  KNH$OPEN

    ****  Entry defs  ****

                              Check   Calling
                             calling  sequence
  Sect HexLoc Primary Altret sequence   type   Parms  Name
     1      0   yes    yes     yes      Std        2  KNH$OPEN
     1    1AB          yes     yes      Std        0  KNH$CLOSE
PL6.E3A0      #003=KNH$OPEN File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:05 Page:166  

  ****  Entry refs  ****

         Check        Calling
        calling       sequence
Altret sequence SRef   type   Args  Name
 yes     yes           Std       1 GHH$LOCK
 yes     yes           Std       1 GHH$UNLOCK
 yes     yes           Std       5 GMA$GETIO
 yes     yes           Std       5 GMA$GET
 yes     yes           Std       1 GMA$REL_ACCTMEM
         yes           Std       2 GHH$ASD
 yes     yes           Std       2 KNH$SCAN
 yes     yes           Std       1 KNN$RECV
 yes     yes           Std       1 GMA$CHKSIZE
 yes     yes           Std       1 KNS$SEND
 yes     yes           Std       2 GHS$REG
         yes           Std       0 KNB$INIT
 yes     yes           Std       2 GMA$REL
                       nStd      0 X6A_AUTO_2
                       nStd      0 X6A_AALT
                       nStd      0 X6A_ARET

  ****  Data refs  ****

  Flags:  r = read only, s = secondary
Flgs Name                             Flgs Name                             Flgs Name
     KN_NETPARM_INIT                  r    G$JIT$                                G$UHJIT$
     G$USRT$                               G$HAND_Q$                             KN_LDCT_MAX#
     KN_HMI$                               KN_HMI#                               KN_DCT$$
r    G$ROS$
PL6.E3A0      #003=KNH$OPEN File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:05 Page:167  


      963        1        /*T***********************************************************/
      964        2        /*T*                                                         */
      965        3        /*T* Copyright (c) Bull HN Information Systems Inc., 1997    */
      966        4        /*T*                                                         */
      967        5        /*T***********************************************************/
      968        6        /*X*     NSO,PLM=3,SQB=Y,AND=Y,ENI=0,SDI=3,MCL=10,CSI=0,ECI=0,IAD=3,IND=0 */
      969        7        KNH$OPEN: PROC (VLP_HMI,ERR) ALTRET;

      7   1 000000  D380 0000 0000  xent KNH$OPEN        LNJ,B5   X6A_AUTO_2
          1 000003       0048 0002                       DC       72,2

      970        8
      971        9        /*F* NAME: KNH$OPEN
      972       10             PURPOSE:
      973       11                  To open the Handler Monitor Interface for a handler.
      974       12             DESCRIPTION:
      975       13                  When an M$OPEN is issued by a handler with ORG=HMI,
      976       14                  this routine acquires the memory and sets up the users
      977       15                  map for the HMI.
      978       16              */
      979       17
      980       18        /* Include files */
      981       19        %INCLUDE KN_ERRORS_C;
      982       83        %INCLUDE GF_LCP6_M;
      983      551        %INCLUDE GH_LCP6_M;
      984     1385        %INCLUDE GH_SCHD_E;
      985     1481        %INCLUDE GH_SCHD_M;
      986     1625        %INCLUDE GM_MACRO_M;
      987     2107        %INCLUDE GM_VIRTUAL_E;
      988     2317        %INCLUDE G_LCP6_E;
      989     2575        %INCLUDE GU_LCP6_M;
      990     3503        %INCLUDE G_HJIT_M;
      991     3648        %INCLUDE G_JIT_M;
      992     3913        %INCLUDE GH_GATE_M;
      993     3954        %INCLUDE KN_DATA_M;
      994     5740        %INCLUDE KNH_MACRO_C;
PL6.E3A0      #003=KNH$OPEN File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:05 Page:168  
      995     6023        %INCLUDE K_REASON_C;
      996     6049
      997     6050        /* Parameters */
      998     6051        %VLP_HMI (STCLASS="");
      999     6067    1   DCL ERR BIT(32) ALIGNED;                /* Error code returned if an altret   */
     1000     6068
     1001     6069        /* Entry point references */
     1002     6070    1   DCL GHS$REG ENTRY(2) ALTRET;
     1003     6071    1   DCL GHH$ASD ENTRY(2);
     1004     6072    1   DCL GMA$GET ENTRY(5) ALTRET;
     1005     6073    1   DCL GMA$GETIO ENTRY(5) ALTRET;
     1006     6074    1   DCL GMA$REL ENTRY(2) ALTRET;
     1007     6075    1   DCL GMA$REL_ACCTMEM ENTRY(1) ALTRET;
     1008     6076    1   DCL GMA$CHKSIZE ENTRY(1) ALTRET;
     1009     6077    1   DCL KNH$SCAN ENTRY(2) ALTRET;
     1010     6078    1   DCL KNN$RECV ENTRY(1) ALTRET;
     1011     6079    1   DCL KNS$SEND ENTRY(1) ALTRET;
     1012     6080    1   DCL KNB$INIT ENTRY;
     1013     6081
     1014     6082        /* Macro invocations */
     1015     6083        %G$UHJIT (STCLASS="BASED(G$UHJIT$)");
     1016     9057        %G$JIT (STCLASS="BASED(G$JIT$)");
     1017     9471        %G$USER (FPTN="G$USER(0:0)",STCLASS="BASED(G$USRT$)");
     1018     9482        %GATE (FPTN=G$GATE, STCLASS=BASED);
     1019     9501        %KNH$HMI (STCLASS="BASED(HMI$)");
     1020     9508        %KNH$QHDR (STCLASS="BASED(G$HAND_Q$)");
     1021     9521        %KN$LDCT(STCLASS="BASED(DCT$)");
     1022     9766        %KN$DCT$;
     1023     9769        %GM_CHKSZ_PARAMS (FPTN=CHKSZ, STCLASS=AUTO);
     1024     9863        %KN$NETPARM(STCLASS=AUTO,NAME=NETPARM) ;
     1025    10016        %FPT_TERM(FPTN=FPT$TERM,STCLASS=AUTO);
     1026    10038        %FPT_CONNECT_ACK (FPTN=FPT$CONNECT_ACK,STCLASS=AUTO);
     1027    10087
     1028    10088        /* Symref items */
     1029    10089        %KN$NETPARM (NAME=KN_NETPARM_INIT,STCLASS=SYMREF);
     1030    10242    1   DCL G$JIT$ PTR SYMREF READONLY;
     1031    10243    1   DCL G$UHJIT$ PTR SYMREF;
PL6.E3A0      #003=KNH$OPEN File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:05 Page:169  
     1032    10244    1   DCL G$USRT$ PTR SYMREF;
     1033    10245    1   DCL G$HAND_Q$ PTR SYMREF;
     1034    10246    1   DCL KN_LDCT_MAX# UBIN SYMREF;
     1035    10247    1   DCL KN_HMI$ PTR SYMREF;
     1036    10248    1   DCL KN_HMI# UBIN SYMREF;
     1037    10249    1   DCL KN_DCT$$ PTR SYMREF;
     1038    10250
     1039    10251        /* Auto variables */
     1040    10252    1   DCL PPS UBIN;
     1041    10253    1   DCL HMI$ PTR;
     1042    10254    1   DCL I UBIN;
     1043    10255    1   DCL USR# UBIN;
     1044    10256    1   DCL DCT$ PTR ;
     1045    10257        /* Error codes */
     1046    10258        %VLP_ERRCODE (FPTN=NOCQMEM,
     1047    10259         FCG=KN,
     1048    10260         MID=H,
     1049    10261         MON='1'B,
     1050    10262         ERR#=%E$NOCQMEM,
     1051    10263         SEV=G_SEV_ERROR#,
     1052    10264         STCLASS=CONSTANT);
     1053    10310        /*E*
     1054    10311             ERROR: KNH-E$NOCQMEM-G_SEV_ERR#
     1055    10312             MESSAGE1: No memory available for Handler Monitor Interface
     1056    10313         */
     1057    10314        %VLP_ERRCODE (FPTN=NOHMI,
     1058    10315         FCG=KN,
     1059    10316         MID=H,
     1060    10317         MON='1'B,
     1061    10318         ERR#=%E$NOHMI,
     1062    10319         SEV=G_SEV_ERROR#,
     1063    10320         STCLASS=CONSTANT);
     1064    10366        /*E*
     1065    10367             ERROR: KNH-E$NOHMI-G_SEV_ERROR#
     1066    10368             MESSAGE: No HMI entry available.
     1067    10369             MESSAGE1: All the available HMI entries are used.
     1068    10370             */
PL6.E3A0      #003=KNH$OPEN File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:05 Page:170  
     1069    10371        %VLP_ERRCODE (FPTN=ONEHMI,
     1070    10372         FCG=KN,
     1071    10373         MID=H,
     1072    10374         MON='1'B,
     1073    10375         ERR#=%E$ONEHMI,
     1074    10376         SEV=G_SEV_ERROR#,
     1075    10377         STCLASS=CONSTANT);
     1076    10423        /*E*
     1077    10424             ERROR: KNH-E$ONEHMI-G_SEV_ERR#
     1078    10425             MESSAGE1: Only one DCB open to ORG=CQ is allowed
     1079    10426         */
     1080    10427
     1081    10428
     1082    10429
     1083    10430        %EJECT;
PL6.E3A0      #003=KNH$OPEN File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:05 Page:171  
     1084    10431    1      IF G$USER.HMI$(G$JIT.USR#) ~= ADDR(NIL)

  10431   1 000005  EC80 0000 0000  xsym                 LDB,B6   G$JIT$
          1 000008  B846 0004                            LDR,R3   4,B6
          1 00000A  B570 00FF                            AND,R3   255,IMO
          1 00000C  DC80 0000 0000  xsym                 LDB,B5   G$USRT$
          1 00000F  3F0C                                 MLV,R3   12
          1 000010  3E0A                                 ADV,R3   10
          1 000011  8DB5                                 CMN      ,B5,R3
          1 000012  0901 000A                            BE       s:10437,PREL

     1085    10432    2      THEN DO;

     1086    10433    2         ERR = ONEHMI;

  10433   1 000014  8C80 0000 0004  00                   LDI      ONEHMI
          1 000017  CCC7 0006                            LDB,B4   @ERR,AUTO
          1 000019  8D04                                 SDI      ,B4

     1087    10434    2         ALTRETURN;

  10434   1 00001A  C380 0000 0000  xent                 LNJ,B4   X6A_AALT

     1088    10435    2      END;
     1089    10436        /* Find an available HMI slot for this user */
     1090    10437    1      HMI$ = KN_HMI$ ;

  10437   1 00001D  CC80 0000 0000  xsym                 LDB,B4   KN_HMI$
          1 000020  CFC7 0038                            STB,B4   HMI$,AUTO

     1091    10438    1   L_LEXIT:
     1092    10439    2      DO ;

  10439   1                              L_LEXIT         null
     1093    10440    3         DO I = 1 TO KN_HMI#;

  10440   1 000022  6C01                 L_LEXIT         LDV,R6   1
PL6.E3A0      #003=KNH$OPEN File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:05 Page:172  
          1 000023  EF47 003A                            STR,R6   I,AUTO
          1 000025  0F81 0029                            B        s:10461+2,PREL

     1094    10441                 %LOCK (G=KNH$HMI.SCQ.LOCK);

  10446   1 000027  ECC7 0038                            LDB,B6   HMI$,AUTO
          1 000029  DBC6 000B                            LAB,B5   11,B6
          1 00002B  DFC7 003E                            STB,B5   DCT$+2,AUTO
          1 00002D  BBC7 003E                            LAB,B3   DCT$+2,AUTO
          1 00002F  CBF0 0100                            LAB,B4   256,IMO
          1 000031  E380 0000 0000  xent                 LNJ,B6   GHH$LOCK
          1 000034       0001                            DC       s:10448,PREL

     1095    10448    3            IF KNH$HMI.USER# = 0

  10448   1 000035  ECC7 0038                            LDB,B6   HMI$,AUTO
          1 000037  E846 0014                            LDR,R6   20,B6
          1 000039  6901 0024                            BEZ,R6   s:10466,PREL

     1096    10449    3            THEN
     1097    10450    3            EXIT L_LEXIT ;
     1098    10451
     1099    10452                 %UNLOCK (G=KNH$HMI.SCQ.LOCK);

  10457   1 00003B  DBC6 000B                            LAB,B5   11,B6
          1 00003D  DFC7 003E                            STB,B5   DCT$+2,AUTO
          1 00003F  BBC7 003E                            LAB,B3   DCT$+2,AUTO
          1 000041  CBF0 0100                            LAB,B4   256,IMO
          1 000043  E380 0000 0000  xent                 LNJ,B6   GHH$UNLOCK
          1 000046       0001                            DC       s:10460,PREL

     1100    10459
     1101    10460    3            HMI$ = PINCRW(HMI$,SIZEW(KNH$HMI)) ;

  10460   1 000047  ECC7 0038                            LDB,B6   HMI$,AUTO
          1 000049  DBC6 0019                            LAB,B5   25,B6
          1 00004B  DFC7 0038                            STB,B5   HMI$,AUTO
PL6.E3A0      #003=KNH$OPEN File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:05 Page:173  

     1102    10461    3         END;

  10461   1 00004D  8AC7 003A                            INC      I,AUTO
          1 00004F  E847 003A                            LDR,R6   I,AUTO
          1 000051  E900 0000 0000  xsym                 CMR,R6   KN_HMI#
          1 000054  03D3                                 BLE      s:10446,SPREL

     1103    10462    2         ERR = NOHMI;

  10462   1 000055  8C80 0000 0002  00                   LDI      NOHMI
          1 000058  ECC7 0006                            LDB,B6   @ERR,AUTO
          1 00005A  8D06                                 SDI      ,B6

     1104    10463    2         ALTRETURN;

  10463   1 00005B  C380 0000 0000  xent                 LNJ,B4   X6A_AALT

     1105    10464    2      END L_LEXIT ;
     1106    10465
     1107    10466    1      KNH$HMI.USER# = G$JIT.USR#;

  10466   1 00005E  DC80 0000 0000  xsym                 LDB,B5   G$JIT$
          1 000061  E845 0004                            LDR,R6   4,B5
          1 000063  E570 00FF                            AND,R6   255,IMO
          1 000065  EF46 0014                            STR,R6   20,B6

     1108    10467           %UNLOCK (G=KNH$HMI.SCQ.LOCK);

  10472   1 000067  CBC6 000B                            LAB,B4   11,B6
          1 000069  CFC7 003E                            STB,B4   DCT$+2,AUTO
          1 00006B  BBC7 003E                            LAB,B3   DCT$+2,AUTO
          1 00006D  CBF0 0100                            LAB,B4   256,IMO
          1 00006F  E380 0000 0000  xent                 LNJ,B6   GHH$UNLOCK
          1 000072       0001                            DC       s:10475,PREL

     1109    10474
PL6.E3A0      #003=KNH$OPEN File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:05 Page:174  
     1110    10475    1      PPS = (VLP_HMI.CTXSIZE + VLP_HMI.RCQSIZE +

  10475   1 000073  ECC7 0004                            LDB,B6   @VLP_HMI,AUTO
          1 000075  E846 0002                            LDR,R6   2,B6
          1 000077  EA46 0001                            ADD,R6   1,B6
          1 000079  EA06                                 ADD,R6   ,B6
          1 00007A  EA70 0117                            ADD,R6   279,IMO
          1 00007C  6048                                 SOR,R6   8
          1 00007D  EF47 0037                            STR,R6   PPS,AUTO

     1111    10476    1        VLP_HMI.SCQSIZE + SIZEW(KNH$QHDR) + 255)/256;
     1112    10477
     1113    10478    1      CHKSZ='0'B;

  10478   1 00007F  5C08                                 LDV,R5   8
          1 000080  0021                                 ALR      ;
          1 000081       4178 0000                                ALPHANUM('0000'X,IMO,,1),;
          1 000083       4007 0008                                ALPHANUM(CHKSZ,AUTO,,R5,FILL)

     1114    10479    1      CHKSZ.SIZE = PPS;

  10479   1 000085  437F                                 CSYNC    s:10478+5,SPREL
          1 000086  E847 0037                            LDR,R6   PPS,AUTO
          1 000088  EF47 0008                            STR,R6   CHKSZ,AUTO

     1115    10480    1      CHKSZ.FLGS.REQ_ALL = '1'B;

  10480   1 00008A  8947 000B                            LBT,'4000'X       CHKSZ+3,AUTO
  10480   1 00008C       4000

     1116    10481    1      CHKSZ.FLGS.PARK = '1'B;

  10481   1 00008D  8947 000B                            LBT,'2000'X       CHKSZ+3,AUTO
  10481   1 00008F       2000

     1117    10482    1      IF VLP_HMI.IO THEN CHKSZ.FLGS.NSHUF = '1'B;

PL6.E3A0      #003=KNH$OPEN File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:05 Page:175  
  10482   1 000090  89C6 0003                            CMZ      3,B6
          1 000092  0881 0004                            BAGE     s:10483,PREL

  10482   1 000094  8947 000B                            LBT,'1000'X       CHKSZ+3,AUTO
  10482   1 000096       1000

     1118    10483    1      CALL GMA$CHKSIZE(CHKSZ)

  10483   1 000097  DBC7 0008                            LAB,B5   CHKSZ,AUTO
          1 000099  DFC7 003E                            STB,B5   DCT$+2,AUTO
          1 00009B  BBC7 003E                            LAB,B3   DCT$+2,AUTO
          1 00009D  CBF0 0100                            LAB,B4   256,IMO
          1 00009F  E380 0000 0000  xent                 LNJ,B6   GMA$CHKSIZE
          1 0000A2       0003                            DC       s:10485,PREL
          1 0000A3  0F81 000E                            B        s:10489,PREL

     1119    10484    2      WHENALTRETURN DO;

     1120    10485    2         KNH$HMI.USER# = 0;

  10485   1 0000A5  ECC7 0038                            LDB,B6   HMI$,AUTO
          1 0000A7  8746 0014                            CL       20,B6

     1121    10486    2         ERR = NOCQMEM;

  10486   1 0000A9  8C80 0000 0000  00                   LDI      NOCQMEM
          1 0000AC  DCC7 0006                            LDB,B5   @ERR,AUTO
          1 0000AE  8D05                                 SDI      ,B5

     1122    10487    2         ALTRETURN;

  10487   1 0000AF  C380 0000 0000  xent                 LNJ,B4   X6A_AALT

     1123    10488    2      END;
     1124    10489    1      IF CHKSZ.FLGS.NSHUF

  10489   1 0000B2  82C7 000B                            LB,'1000'X        CHKSZ+3,AUTO
PL6.E3A0      #003=KNH$OPEN File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:05 Page:176  
  10489   1 0000B4       1000
          1 0000B5  0581 002A                            BBF      s:10498,PREL

     1125    10490    2      THEN DO;

     1126    10491    2         CALL GMA$GETIO (%GM_HAND_Q#,PPS,%G_R_USR#,%G_R_USR#,%G_RING0#)

  10491   1 0000B7  EBF0 001C                            LAB,B6   28,IMO
          1 0000B9  DBF0 0000                            LAB,B5   0,IMO
          1 0000BB  CBF0 0000                            LAB,B4   0,IMO
          1 0000BD  BBF0 C000                            LAB,B3   -16384,IMO
          1 0000BF  BFC7 0046                            STB,B3   DCT$+10,AUTO
          1 0000C1  CFC7 0044                            STB,B4   DCT$+8,AUTO
          1 0000C3  DFC7 0042                            STB,B5   DCT$+6,AUTO
          1 0000C5  ABC7 0037                            LAB,B2   PPS,AUTO
          1 0000C7  AFC7 0040                            STB,B2   DCT$+4,AUTO
          1 0000C9  EFC7 003E                            STB,B6   DCT$+2,AUTO
          1 0000CB  BBC7 003E                            LAB,B3   DCT$+2,AUTO
          1 0000CD  CBF0 0500                            LAB,B4   1280,IMO
          1 0000CF  E380 0000 0000  xent                 LNJ,B6   GMA$GETIO
          1 0000D2       0003                            DC       s:10493,PREL
          1 0000D3  0F81 000A                            B        s:10496,PREL

     1127    10492    3         WHENALTRETURN DO;

     1128    10493    3            ERR = NOCQMEM;

  10493   1 0000D5  8C80 0000 0000  00                   LDI      NOCQMEM
          1 0000D8  ECC7 0006                            LDB,B6   @ERR,AUTO
          1 0000DA  8D06                                 SDI      ,B6

     1129    10494    3            ALTRETURN;

  10494   1 0000DB  C380 0000 0000  xent                 LNJ,B4   X6A_AALT

     1130    10495    3         END;
     1131    10496    2      END;
PL6.E3A0      #003=KNH$OPEN File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:05 Page:177  

  10496   1 0000DE  0F81 001D                            B        s:10501,PREL

     1132    10497    2      ELSE DO;

     1133    10498    2         CALL GMA$GET (%GM_HAND_Q#,PPS,%G_R_USR#,%G_R_USR#,%G_RING0#);

  10498   1 0000E0  EBF0 001C                            LAB,B6   28,IMO
          1 0000E2  DBF0 0000                            LAB,B5   0,IMO
          1 0000E4  CBF0 0000                            LAB,B4   0,IMO
          1 0000E6  BBF0 C000                            LAB,B3   -16384,IMO
          1 0000E8  BFC7 0046                            STB,B3   DCT$+10,AUTO
          1 0000EA  CFC7 0044                            STB,B4   DCT$+8,AUTO
          1 0000EC  DFC7 0042                            STB,B5   DCT$+6,AUTO
          1 0000EE  ABC7 0037                            LAB,B2   PPS,AUTO
          1 0000F0  AFC7 0040                            STB,B2   DCT$+4,AUTO
          1 0000F2  EFC7 003E                            STB,B6   DCT$+2,AUTO
          1 0000F4  BBC7 003E                            LAB,B3   DCT$+2,AUTO
          1 0000F6  CBF0 0500                            LAB,B4   1280,IMO
          1 0000F8  E380 0000 0000  xent                 LNJ,B6   GMA$GET
          1 0000FB       0001                            DC       s:10501,PREL

     1134    10499    2      END;

     1135    10500
     1136    10501    1      G$JIT.CQPC = G$JIT.CQPC + PPS;

  10501   1 0000FC  EC80 0000 0000  xsym                 LDB,B6   G$JIT$
          1 0000FF  E846 008B                            LDR,R6   139,B6
          1 000101  EA47 0037                            ADD,R6   PPS,AUTO
          1 000103  EF46 008B                            STR,R6   139,B6

     1137    10502
     1138    10503        /* Put HMI index into user table */
     1139    10504    1      G$USER.HMI$(G$JIT.USR#) = HMI$ ;

  10504   1 000105  B846 0004                            LDR,R3   4,B6
PL6.E3A0      #003=KNH$OPEN File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:05 Page:178  
          1 000107  B570 00FF                            AND,R3   255,IMO
          1 000109  DCC7 0038                            LDB,B5   HMI$,AUTO
          1 00010B  CC80 0000 0000  xsym                 LDB,B4   G$USRT$
          1 00010E  3F0C                                 MLV,R3   12
          1 00010F  3E0A                                 ADV,R3   10
          1 000110  DFB4                                 STB,B5   ,B4,R3

     1140    10505    1      KNH$HMI.PP# = G$UHJIT.ASDT_USR.HAND_Q.BASE;

  10505   1 000111  CC80 0000 0000  xsym                 LDB,B4   G$UHJIT$
          1 000114  F844 0038                            LDR,R7   56,B4
          1 000116  F570 7FFF                            AND,R7   32767,IMO
          1 000118  6C00                                 LDV,R6   0
          1 000119  8D45 0015                            SDI      21,B5

     1141    10506    1      KNH$HMI.PPSZ = PPS - 1;

  10506   1 00011B  D847 0037                            LDR,R5   PPS,AUTO
          1 00011D  5EFF                                 ADV,R5   -1
          1 00011E  DF45 0017                            STR,R5   23,B5

     1142    10507
     1143    10508    1      G$UHJIT.ASDT_MCL.HAND_Q = G$UHJIT.ASDT_USR.HAND_Q;

  10508   1 000120  8CC4 0038                            LDI      56,B4
          1 000122  8D44 0076                            SDI      118,B4

     1144    10509    1      CALL GHH$ASD(G$HAND_Q$,G$UHJIT.ASDT_MCL.HAND_Q);

  10509   1 000124  BBC4 0076                            LAB,B3   118,B4
          1 000126  BFC7 0040                            STB,B3   DCT$+4,AUTO
          1 000128  AB80 0000 0000  xsym                 LAB,B2   G$HAND_Q$
          1 00012B  AFC7 003E                            STB,B2   DCT$+2,AUTO
          1 00012D  BBC7 003E                            LAB,B3   DCT$+2,AUTO
          1 00012F  CBF0 0200                            LAB,B4   512,IMO
          1 000131  E380 0000 0000  xent                 LNJ,B6   GHH$ASD
          1 000134       0001                            DC       s:10512,PREL
PL6.E3A0      #003=KNH$OPEN File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:05 Page:179  

     1145    10510
     1146    10511        /* Initialize the header */
     1147    10512    1      KNH$QHDR = '0'B;

  10512   1 000135  EC80 0000 0000  xsym                 LDB,B6   G$HAND_Q$
          1 000138  5C30                                 LDV,R5   48
          1 000139  0021                                 ALR      ;
          1 00013A       4178 0000                                ALPHANUM('0000'X,IMO,,1),;
          1 00013C       4006 0000                                ALPHANUM(0,B6,,R5,FILL)

     1148    10513
     1149    10514        /* Use all the memory we allocated. */
     1150    10515    1      PPS = (PPS*256 - SIZEW(KNH$QHDR) -

  10515   1 00013E  437F                                 CSYNC    s:10512+8,SPREL
          1 00013F  ECC7 0004                            LDB,B6   @VLP_HMI,AUTO
          1 000141  E847 0037                            LDR,R6   PPS,AUTO
          1 000143  6008                                 SOL,R6   8
          1 000144  8256                                 NEG      R6
          1 000145  EA46 0002                            ADD,R6   2,B6
          1 000147  EA46 0001                            ADD,R6   1,B6
          1 000149  EA06                                 ADD,R6   ,B6
          1 00014A  8256                                 NEG      R6
          1 00014B  6EE8                                 ADV,R6   -24
          1 00014C  E370 0002                            DIV,R6   2,IMO
          1 00014E  EF47 0037                            STR,R6   PPS,AUTO

     1151    10516    1        VLP_HMI.CTXSIZE - VLP_HMI.RCQSIZE - VLP_HMI.SCQSIZE)/2;
     1152    10517    1      KNH$QHDR.RCQ.SZ = (VLP_HMI.RCQSIZE + PPS)/2;

  10517   1 000150  EA46 0001                            ADD,R6   1,B6
          1 000152  6041                                 SOR,R6   1
          1 000153  DC80 0000 0000  xsym                 LDB,B5   G$HAND_Q$
          1 000156  EF45 0002                            STR,R6   2,B5

     1153    10518    1      KNH$QHDR.SCQ.SZ = (VLP_HMI.SCQSIZE + PPS)/2;
PL6.E3A0      #003=KNH$OPEN File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:05 Page:180  

  10518   1 000158  C806                                 LDR,R4   ,B6
          1 000159  CA47 0037                            ADD,R4   PPS,AUTO
          1 00015B  4041                                 SOR,R4   1
          1 00015C  CF45 0006                            STR,R4   6,B5

     1154    10519    1      KNH$QHDR.CTX.SZ = VLP_HMI.CTXSIZE;

  10519   1 00015E  B846 0002                            LDR,R3   2,B6
          1 000160  3001                                 SOL,R3   1
          1 000161  BAC5 0009                            SRM,R3,'FFFE'X    9,B5
          1 000163       FFFE

     1155    10520    1      KNH$QHDR.CTX.OFFSET = SIZEW(KNH$QHDR);

  10520   1 000164  3C18                                 LDV,R3   24
          1 000165  BF45 0008                            STR,R3   8,B5

     1156    10521    1      KNH$QHDR.RCQ.OFFSET = KNH$QHDR.CTX.OFFSET + VLP_HMI.CTXSIZE;

  10521   1 000167  BA46 0002                            ADD,R3   2,B6
          1 000169  BF45 0003                            STR,R3   3,B5

     1157    10522    1      KNH$QHDR.SCQ.OFFSET = KNH$QHDR.RCQ.OFFSET + KNH$QHDR.RCQ.SZ*2;

  10522   1 00016B  6001                                 SOL,R6   1
          1 00016C  EA53                                 ADD,R6   R3
          1 00016D  EF45 0007                            STR,R6   7,B5

     1158    10523        /* Initialize KNH$HMI */
     1159    10524    1      KNH$HMI.SCQ = KNH$QHDR.SCQ;

  10524   1 00016F  CCC7 0038                            LDB,B4   HMI$,AUTO
          1 000171  5C10                                 LDV,R5   16
          1 000172  0021                                 ALR      ;
          1 000173       4805 0004                                ALPHANUM(4,B5,,8),;
          1 000175       4004 0007                                ALPHANUM(7,B4,,R5,FILL)
PL6.E3A0      #003=KNH$OPEN File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:05 Page:181  

     1160    10525    1      KNH$HMI.RCQ = KNH$QHDR.RCQ;

  10525   1 000177  437F                                 CSYNC    s:10524+7,SPREL
          1 000178  CCC7 0038                            LDB,B4   HMI$,AUTO
          1 00017A  5C0E                                 LDV,R5   14
          1 00017B  0021                                 ALR      ;
          1 00017C       4805 0000                                ALPHANUM(0,B5,,8),;
          1 00017E       4004 0000                                ALPHANUM(0,B4,,R5,FILL)

     1161    10526    1      ADDR(KNH$HMI.SCQ.LOCK)->G$GATE.FLG = '1'B;

  10526   1 000180  437F                                 CSYNC    s:10525+8,SPREL
          1 000181  DCC7 0038                            LDB,B5   HMI$,AUTO
          1 000183  8945 000B                            LBT,'8000'X       11,B5
          1 000185       8000

     1162    10527    1      ADDR(KNH$HMI.RCQ.LOCK)->G$GATE.FLG = '1'B;

  10527   1 000186  8945 0004                            LBT,'8000'X       4,B5
  10527   1 000188       8000

     1163    10528    1      KNH$HMI.WAIT_HEAD$ = ADDR(NIL);

  10528   1 000189  CB80 0000 0000                       LAB,B4   0
          1 00018C  CFC5 0011                            STB,B4   17,B5

     1164    10529    1      KNH$HMI.WAIT_COUNT = 0;

  10529   1 00018E  8745 0013                            CL       19,B5

     1165    10530    1      KNH$HMI.CTX.SZ = VLP_HMI.CTXSIZE;

  10530   1 000190  E846 0002                            LDR,R6   2,B6
          1 000192  EF45 0010                            STR,R6   16,B5

     1166    10531    1      KNH$HMI.CTX.OFFSET = SIZEW(KNH$QHDR);
PL6.E3A0      #003=KNH$OPEN File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:05 Page:182  

  10531   1 000194  4C18                                 LDV,R4   24
          1 000195  CF45 000F                            STR,R4   15,B5

     1167    10532    1      KNH$HMI.SCQ.SCANNED = '0'B;

  10532   1 000197  8845 000E                            LBF,'4000'X       14,B5
  10532   1 000199       4000

     1168    10533    1      KNH$HMI.SCQ.CLOSING = '0'B;

  10533   1 00019A  8845 000E                            LBF,'0001'X       14,B5
  10533   1 00019C       0001

     1169    10534
     1170    10535        /* If this is user 1 initialize the monitor connection */
     1171    10536    1      IF KNH$HMI.USER# = 1

  10536   1 00019D  B845 0014                            LDR,R3   20,B5
          1 00019F  3D01                                 CMV,R3   1
          1 0001A0  0981 0007                            BNE      s:10539,PREL

     1172    10537    1      THEN
     1173    10538    1      CALL KNB$INIT;

  10538   1 0001A2  CBF0 0000                            LAB,B4   0,IMO
          1 0001A4  E380 0000 0000  xent                 LNJ,B6   KNB$INIT
          1 0001A7       0001                            DC       s:10539,PREL

     1174    10539    1      RETURN;

  10539   1 0001A8  C380 0000 0000  xent                 LNJ,B4   X6A_ARET

     1175    10540
     1176    10541        %EJECT;
PL6.E3A0      #003=KNH$OPEN File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:05 Page:183  
     1177    10542    1   KNH$CLOSE: ENTRY ALTRET;

  10542   1 0001AB  D380 0000 0000  xent KNH$CLOSE       LNJ,B5   X6A_AUTO_2
          1 0001AE       0048 0002                       DC       72,2

     1178    10543
     1179    10544        /*F*  NAME:    KNH$CLOSE
     1180    10545              PURPOSE: To close down a circular queue.
     1181    10546              DESCRIPTION:
     1182    10547                       All LDCTs associated with the queue are terminated
     1183    10548              and the ASDTs are NILed out.  The memory for the queue is
     1184    10549              released.
     1185    10550                                                        */
     1186    10551
     1187    10552    1      USR# = G$JIT.USR# ;

  10552   1 0001B0  EC80 0000 0000  xsym                 LDB,B6   G$JIT$
          1 0001B3  E846 0004                            LDR,R6   4,B6
          1 0001B5  E570 00FF                            AND,R6   255,IMO
          1 0001B7  EF47 003B                            STR,R6   USR#,AUTO

     1188    10553    1      HMI$ = G$USER.HMI$(USR#) ;

  10553   1 0001B9  DC80 0000 0000  xsym                 LDB,B5   G$USRT$
          1 0001BC  B856                                 LDR,R3   R6
          1 0001BD  3F0C                                 MLV,R3   12
          1 0001BE  3E0A                                 ADV,R3   10
          1 0001BF  CCB5                                 LDB,B4   ,B5,R3
          1 0001C0  CFC7 0038                            STB,B4   HMI$,AUTO

     1189    10554    1      PPS = KNH$HMI.PPSZ + 1 ;

  10554   1 0001C2  D844 0017                            LDR,R5   23,B4
          1 0001C4  5E01                                 ADV,R5   1
          1 0001C5  DF47 0037                            STR,R5   PPS,AUTO

     1190    10555    1      KNH$HMI.SCQ.CLOSING = '1'B;
PL6.E3A0      #003=KNH$OPEN File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:05 Page:184  

  10555   1 0001C7  8944 000E                            LBT,'0001'X       14,B4
  10555   1 0001C9       0001

     1191    10556
     1192    10557        /* Call KNH$SCAN to free up anyone waiting for this HMI interface */
     1193    10558    1      CALL KNH$SCAN;

  10558   1 0001CA  CBF0 0000                            LAB,B4   0,IMO
          1 0001CC  E380 0000 0000  xent                 LNJ,B6   KNH$SCAN
          1 0001CF       0001                            DC       s:10561,PREL

     1194    10559
     1195    10560
     1196    10561    2      DO WHILE (KNH$HMI.LDCTS# > 0);

  10561   1 0001D0  ECC7 0038                            LDB,B6   HMI$,AUTO
          1 0001D2  E846 0018                            LDR,R6   24,B6
          1 0001D4  6901 00B3                            BEZ,R6   s:10609,PREL

     1197    10562
     1198    10563    3         DO I = 1 TO KN_LDCT_MAX# ;

  10563   1 0001D6  6C01                                 LDV,R6   1
          1 0001D7  EF47 003A                            STR,R6   I,AUTO
          1 0001D9  0F81 0098                            B        s:10603+2,PREL

     1199    10564
     1200    10565    3            DCT$ = KN$DCT$(I) ;

  10565   1 0001DB  EC80 0000 0000  xsym                 LDB,B6   KN_DCT$$
          1 0001DE  B847 003A                            LDR,R3   I,AUTO
          1 0001E0  DCB6                                 LDB,B5   ,B6,R3
          1 0001E1  DFC7 003C                            STB,B5   DCT$,AUTO

     1201    10566    3            IF DCT$ ~= ADDR(NIL) THEN

PL6.E3A0      #003=KNH$OPEN File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:05 Page:185  
  10566   1 0001E3  8DC7 003C                            CMN      DCT$,AUTO
          1 0001E5  0901 008A                            BE       s:10603,PREL

     1202    10567    3            IF KN$LDCT.STATE ~= %KN_ST_NULL THEN

  10567   1 0001E7  8285                                 LB,'00FF'X        ,B5
  10567   1 0001E8       00FF
          1 0001E9  0581 0086                            BBF      s:10603,PREL

     1203    10568    3            IF USR# = KN$LDCT.USER# THEN

  10568   1 0001EB  E847 003B                            LDR,R6   USR#,AUTO
          1 0001ED  E945 000E                            CMR,R6   14,B5
          1 0001EF  0981 0080                            BNE      s:10603,PREL

     1204    10569    4            DO ;

     1205    10570    4               NETPARM = KN_NETPARM_INIT;

  10570   1 0001F1  AB80 0000 0000  xsym                 LAB,B2   KN_NETPARM_INIT
          1 0001F4  2C00                                 LDV,R2   0
          1 0001F5  6C42                                 LDV,R6   66
          1 0001F6  BB87                                 LAB,B3   ,AUTO
          1 0001F7  3C18                                 LDV,R3   24
          1 0001F8  0008                                 MMM

     1206    10571    4               NETPARM.LDCT$ = DCT$ ;

  10571   1 0001F9  ECC7 003C                            LDB,B6   DCT$,AUTO
          1 0001FB  EFC7 000C                            STB,B6   NETPARM,AUTO

     1207    10572    4               FPT$TERM.RLCID = KN$LDCT.RLCID ;

  10572   1 0001FD  8CC6 0001                            LDI      1,B6
          1 0001FF  8D47 002D                            SDI      FPT$TERM,AUTO

     1208    10573    4               FPT$TERM.REASON = %KN_TERM_REASON_CLOSE ;
PL6.E3A0      #003=KNH$OPEN File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:05 Page:186  

  10573   1 000201  5C02                                 LDV,R5   2
          1 000202  DF47 002F                            STR,R5   FPT$TERM+2,AUTO

     1209    10574    4               FPT$CONNECT_ACK.REASON = %K_REASON_USRREJ;

  10574   1 000204  4C05                                 LDV,R4   5
          1 000205  CF47 0031                            STR,R4   FPT$CONNECT_ACK,AUTO

     1210    10575
     1211    10576    4               IF KN$LDCT.CONN_TYPE=%KN_CNTYPE_LINK

  10576   1 000207  B286                                 LLH,R3   ,B6
          1 000208  3D06                                 CMV,R3   6
          1 000209  0981 0016                            BNE      s:10583,PREL

     1212    10577    5               THEN DO;

     1213    10578    5                  NETPARM.FUNCTION = %KN_FCN_TERM;

  10578   1 00020B  2C03                                 LDV,R2   3
          1 00020C  AF47 0020                            STR,R2   NETPARM+20,AUTO

     1214    10579    5                  NETPARM.FPT$ = ADDR(FPT$TERM);

  10579   1 00020E  DBC7 002D                            LAB,B5   FPT$TERM,AUTO
          1 000210  DFC7 0025                            STB,B5   NETPARM+25,AUTO

     1215    10580    5                  CALL KNN$RECV(NETPARM);

  10580   1 000212  CBC7 000C                            LAB,B4   NETPARM,AUTO
          1 000214  CFC7 003E                            STB,B4   DCT$+2,AUTO
          1 000216  BBC7 003E                            LAB,B3   DCT$+2,AUTO
          1 000218  CBF0 0100                            LAB,B4   256,IMO
          1 00021A  E380 0000 0000  xent                 LNJ,B6   KNN$RECV
          1 00021D       0001                            DC       s:10581,PREL

PL6.E3A0      #003=KNH$OPEN File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:05 Page:187  
     1216    10581    5               END;

  10581   1 00021E  0F81 0051                            B        s:10603,PREL

     1217    10582    4               ELSE
     1218    10583    5               DO CASE (KN$LDCT.STATE);

  10583   1 000220  A806                                 LDR,R2   ,B6
          1 000221  A570 00FF                            AND,R2   255,IMO
          1 000223  2D08                                 CMV,R2   8
          1 000224  0281 004B                            BGE      s:10603,PREL
          1 000226  9820 0000 022C  01                   LDR,R1   s:10583+12,R2
          1 000229  8390 0000 0234  01                   JMP      s:10586,R1
          1 00022C       003C                            DC       s:10603,PREL
          1 00022D       003C                            DC       s:10603,PREL
          1 00022E       0015                            DC       s:10591,PREL
          1 00022F       003C                            DC       s:10603,PREL
          1 000230       0029                            DC       s:10596,PREL
          1 000231       0000                            DC       s:10586,PREL
          1 000232       0015                            DC       s:10591,PREL
          1 000233       0015                            DC       s:10591,PREL

     1219    10584
     1220    10585    5               CASE (%KN_ST_ACTIVE);

     1221    10586    5                  NETPARM.FUNCTION = %KN_FCN_TERM;

  10586   1 000234  6C03                                 LDV,R6   3
          1 000235  EF47 0020                            STR,R6   NETPARM+20,AUTO

     1222    10587    5                  NETPARM.FPT$ = ADDR(FPT$TERM);

  10587   1 000237  DBC7 002D                            LAB,B5   FPT$TERM,AUTO
          1 000239  DFC7 0025                            STB,B5   NETPARM+25,AUTO

     1223    10588    5                  CALL KNS$SEND(NETPARM);

PL6.E3A0      #003=KNH$OPEN File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:05 Page:188  
  10588   1 00023B  CBC7 000C                            LAB,B4   NETPARM,AUTO
          1 00023D  CFC7 003E                            STB,B4   DCT$+2,AUTO
          1 00023F  BBC7 003E                            LAB,B3   DCT$+2,AUTO
          1 000241  CBF0 0100                            LAB,B4   256,IMO
          1 000243  E380 0000 0000  xent                 LNJ,B6   KNS$SEND
          1 000246       0001                            DC       s:10588+12,PREL
          1 000247  0F81 0028                            B        s:10603,PREL

     1224    10589
     1225    10590    5               CASE (%KN_ST_WIAFL,%KN_ST_WTIAFLNT,%KN_ST_WTAFLNT);

     1226    10591    5                  NETPARM.FUNCTION = %KN_FCN_INIT_ACK;

  10591   1 000249  DF47 0020                            STR,R5   NETPARM+20,AUTO

     1227    10592    5                  NETPARM.FPT$ = ADDR(FPT$CONNECT_ACK);

  10592   1 00024B  DBC7 0031                            LAB,B5   FPT$CONNECT_ACK,AUTO
          1 00024D  DFC7 0025                            STB,B5   NETPARM+25,AUTO

     1228    10593    5                  CALL KNS$SEND(NETPARM);

  10593   1 00024F  CBC7 000C                            LAB,B4   NETPARM,AUTO
          1 000251  CFC7 003E                            STB,B4   DCT$+2,AUTO
          1 000253  BBC7 003E                            LAB,B3   DCT$+2,AUTO
          1 000255  CBF0 0100                            LAB,B4   256,IMO
          1 000257  E380 0000 0000  xent                 LNJ,B6   KNS$SEND
          1 00025A       0001                            DC       s:10593+12,PREL
          1 00025B  0F81 0014                            B        s:10603,PREL

     1229    10594
     1230    10595    5               CASE (%KN_ST_WTAFL);

     1231    10596    5                  NETPARM.FUNCTION = %KN_FCN_TERM;

  10596   1 00025D  6C03                                 LDV,R6   3
          1 00025E  EF47 0020                            STR,R6   NETPARM+20,AUTO
PL6.E3A0      #003=KNH$OPEN File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:05 Page:189  

     1232    10597    5                  NETPARM.FPT$ = ADDR(FPT$TERM);

  10597   1 000260  DBC7 002D                            LAB,B5   FPT$TERM,AUTO
          1 000262  DFC7 0025                            STB,B5   NETPARM+25,AUTO

     1233    10598    5                  CALL KNS$SEND(NETPARM);

  10598   1 000264  CBC7 000C                            LAB,B4   NETPARM,AUTO
          1 000266  CFC7 003E                            STB,B4   DCT$+2,AUTO
          1 000268  BBC7 003E                            LAB,B3   DCT$+2,AUTO
          1 00026A  CBF0 0100                            LAB,B4   256,IMO
          1 00026C  E380 0000 0000  xent                 LNJ,B6   KNS$SEND
          1 00026F       0001                            DC       s:10603,PREL

     1234    10599
     1235    10600    5               END;

     1236    10601    4            END ;

     1237    10602
     1238    10603    3         END ;

  10603   1 000270  8AC7 003A                            INC      I,AUTO
          1 000272  E847 003A                            LDR,R6   I,AUTO
          1 000274  E900 0000 0000  xsym                 CMR,R6   KN_LDCT_MAX#
          1 000277  0381 FF63                            BLE      s:10565,PREL

     1239    10604
     1240    10605    2         CALL GHS$REG(%GH_EVSL,10);

  10605   1 000279  BB80 0000 0002  02                   LAB,B3   +2
          1 00027C  CBF0 0200                            LAB,B4   512,IMO
          1 00027E  E380 0000 0000  xent                 LNJ,B6   GHS$REG
          1 000281       0001                            DC       s:10606,PREL

     1241    10606    2      END;                                 /* DO WHILE (KNH$HMI.LDCTS# > 0)      */
PL6.E3A0      #003=KNH$OPEN File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:05 Page:190  

  10606   1 000282  ECC7 0038                            LDB,B6   HMI$,AUTO
          1 000284  E846 0018                            LDR,R6   24,B6
          1 000286  6981 FF4F                            BNEZ,R6  s:10563,PREL

     1242    10607
     1243    10608
     1244    10609    1      G$USER.HMI$(USR#) = ADDR(NIL);

  10609   1 000288  DB80 0000 0000                       LAB,B5   0
          1 00028B  CC80 0000 0000  xsym                 LDB,B4   G$USRT$
          1 00028E  B847 003B                            LDR,R3   USR#,AUTO
          1 000290  3F0C                                 MLV,R3   12
          1 000291  3E0A                                 ADV,R3   10
          1 000292  DFB4                                 STB,B5   ,B4,R3

     1245    10610    1      G$UHJIT.ASDT_MCL.HAND_Q.V = '0'B;

  10610   1 000293  DC80 0000 0000  xsym                 LDB,B5   G$UHJIT$
          1 000296  8845 0076                            LBF,'8000'X       118,B5
          1 000298       8000

     1246    10611    1      CALL GMA$REL_ACCTMEM(PPS);

  10611   1 000299  CBC7 0037                            LAB,B4   PPS,AUTO
          1 00029B  CFC7 003E                            STB,B4   DCT$+2,AUTO
          1 00029D  BBC7 003E                            LAB,B3   DCT$+2,AUTO
          1 00029F  CBF0 0100                            LAB,B4   256,IMO
          1 0002A1  E380 0000 0000  xent                 LNJ,B6   GMA$REL_ACCTMEM
          1 0002A4       0001                            DC       s:10612,PREL

     1247    10612    1      CALL GMA$REL(%GM_HAND_Q#,PPS);

  10612   1 0002A5  EBF0 001C                            LAB,B6   28,IMO
          1 0002A7  DBC7 0037                            LAB,B5   PPS,AUTO
          1 0002A9  DFC7 0040                            STB,B5   DCT$+4,AUTO
          1 0002AB  EFC7 003E                            STB,B6   DCT$+2,AUTO
PL6.E3A0      #003=KNH$OPEN File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:05 Page:191  
          1 0002AD  BBC7 003E                            LAB,B3   DCT$+2,AUTO
          1 0002AF  CBF0 0200                            LAB,B4   512,IMO
          1 0002B1  E380 0000 0000  xent                 LNJ,B6   GMA$REL
          1 0002B4       0001                            DC       s:10613,PREL

     1248    10613    1      G$JIT.CQPC = G$JIT.CQPC - PPS;

  10613   1 0002B5  EC80 0000 0000  xsym                 LDB,B6   G$JIT$
          1 0002B8  E846 008B                            LDR,R6   139,B6
          1 0002BA  E247 0037                            SUB,R6   PPS,AUTO
          1 0002BC  EF46 008B                            STR,R6   139,B6

     1249    10614    1      KNH$HMI.USER# = 0 ;

  10614   1 0002BE  DCC7 0038                            LDB,B5   HMI$,AUTO
          1 0002C0  8745 0014                            CL       20,B5

     1250    10615
     1251    10616    1      RETURN ;

  10616   1 0002C2  C380 0000 0000  xent                 LNJ,B4   X6A_ARET
     1252    10617
     1253    10618    1   END KNH$OPEN;

PL6.E3A0      #003=KNH$OPEN File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:05 Page:192  
--  Include file information  --

   K_REASON_C.:E05TOU  is referenced.
   KNH_MACRO_C.:E05TOU  is referenced.
   KN_DATA_M.:E05TOU  is referenced.
   GH_GATE_M.:E05TOU  cannot be made into a system file and is referenced.
   G_JIT_M.:E05TOU  is referenced.
   G_HJIT_M.:E05TOU  is referenced.
   GU_LCP6_M.:E05TOU  is referenced.
   G_LCP6_E.:E05TOU  is referenced.
   GM_VIRTUAL_E.:E05TOU  is referenced.
   GM_MACRO_M.:E05TOU  is referenced.
   GH_SCHD_M.:E05TOU  is referenced.
   GH_SCHD_E.:E05TOU  is referenced.
   GH_LCP6_M.:E05TOU  is referenced.
   GF_LCP6_M.:E05TOU  is referenced.
   KN_ERRORS_C.:E05TOU  is referenced.
      No diagnostics issued in procedure KNH$OPEN.
PL6.E3A0      #003=KNH$OPEN File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:05 Page:193  

 **** Variables and constants ****

  ****  Section 000 RoData KNH$OPEN

  ****  Scalars and arrays  ****
HexLoc.c.b A Datatyp(siz) R M Lvl/name                 HexLoc.c.b A Datatyp(siz) R M Lvl/name

     0-0-0/w STRC(32)    r     1 NOCQMEM                    2-0-0/w STRC(32)    r     1 NOHMI
     4-0-0/w STRC(32)    r     1 ONEHMI

  ****  Auto variables  ****

  ****  Scalars and arrays  ****
HexLoc.c.b A Datatyp(siz) R M Lvl/name                 HexLoc.c.b A Datatyp(siz) R M Lvl/name

     6-0-0/w PTR         r     1 @ERR                       4-0-0/w PTR         r     1 @VLP_HMI
     8-0-0/w STRC(64)    r     1 CHKSZ                     3C-0-0/w PTR         r     1 DCT$
    *0-0-0/w BIT (32)    r     1 ERR                       31-0-0/w STRC(96)    r     1 FPT$CONNECT_ACK
    2D-0-0/w STRC(64)    r     1 FPT$TERM                  38-0-0/w PTR         r     1 HMI$
    3A-0-0/w UBIN(16)    r     1 I                          C-0-0/w STRC(528)   r     1 NETPARM
    37-0-0/w UBIN(16)    r     1 PPS                       3B-0-0/w UBIN(16)    r     1 USR#
    *0-0-0/w STRC(64)    r     1 VLP_HMI

  ****  SYMREF variables  ****

  ****  Scalars and arrays  ****
HexLoc.c.b A Datatyp(siz) R M Lvl/name                 HexLoc.c.b A Datatyp(siz) R M Lvl/name

     0-0-0/w PTR         r     1 G$HAND_Q$                  0-0-0/w PTR         r     1 G$JIT$
     0-0-0/w PTR         r     1 G$UHJIT$                   0-0-0/w PTR         r     1 G$USRT$
     0-0-0/w PTR         r     1 KN_DCT$$                   0-0-0/w UBIN(16)    r     1 KN_HMI#
     0-0-0/w PTR         r     1 KN_HMI$                    0-0-0/w UBIN(16)    r     1 KN_LDCT_MAX#
     0-0-0/w STRC(528)   r     1 KN_NETPARM_INIT

  ****  BASED and DCB variables  ****

  ****  Scalars and arrays  ****
PL6.E3A0      #003=KNH$OPEN File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:05 Page:194  
HexLoc.c.b A Datatyp(siz) R M Lvl/name                 HexLoc.c.b A Datatyp(siz) R M Lvl/name

     0-0-0/w STRC(48)    r     1 G$GATE                     0-0-0/w STRC(5616)  r     1 G$JIT
     0-0-0/w STRC(6480)  r     1 G$UHJIT                    0-0-0/w STRC(384)   r     1 G$USER(0:0)
     0-0-0/w PTR         r     1 KN$DCT$(0:0)
     0-0-0/w STRC(256)   r     1 KN$LDCT                    0-0-0/c STRC(400)   r     1 KNH$HMI
     0-0-0/w STRC(384)   r     1 KNH$QHDR


   Procedure KNH$OPEN requires 709 words for executable code.
   Procedure KNH$OPEN requires 72 words of local(AUTO) storage.

    No errors detected in file KNH$HMI.:E05TSI    .
PL6.E3A0      #003=KNH$OPEN File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:05 Page:195  
          *** CROSS REFERENCE LISTING ***
**     DENOTES     IDENTIFIER DEFINITION
<<                 IDENTIFIER'S VALUE SET
>>                 IDENTIFIER'S VALUE USED
<>                 IDENTIFIER SET AND/OR USED
--                 IDENTIFIER REFERENCED
PL6.E3A0      #003=KNH$OPEN File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:05 Page:196  
          MINI XREF LISTING

CHKSZ
      9775**DCL     10478<<ASSIGN  10483<>CALL
CHKSZ.FLGS.NSHUF
      9849**DCL     10482<<ASSIGN  10489>>IF
CHKSZ.FLGS.PARK
      9843**DCL     10481<<ASSIGN
CHKSZ.FLGS.REQ_ALL
      9837**DCL     10480<<ASSIGN
CHKSZ.SIZE
      9776**DCL     10479<<ASSIGN
DCT$
     10256**DCL      9536--IMP-PTR 10565<<ASSIGN  10566>>IF      10567>>IF      10568>>IF      10571>>ASSIGN
     10572>>ASSIGN  10576>>IF      10583>>DOCASE
ERR
      6067**DCL         7--PROC    10433<<ASSIGN  10462<<ASSIGN  10486<<ASSIGN  10493<<ASSIGN
FPT$CONNECT_ACK
     10052**DCL     10592--ASSIGN
FPT$CONNECT_ACK.REASON
     10056**DCL     10574<<ASSIGN
FPT$CONNECT_ACK.UID.UID
     10082**DCL     10082--REDEF   10082--REDEF
FPT$TERM
     10030**DCL     10579--ASSIGN  10587--ASSIGN  10597--ASSIGN
FPT$TERM.REASON
     10035**DCL     10573<<ASSIGN
FPT$TERM.RLCID
     10034**DCL     10572<<ASSIGN
G$GATE.FLG
      9498**DCL     10526<<ASSIGN  10527<<ASSIGN
G$HAND_Q$
     10245**DCL      9509--IMP-PTR 10509<>CALL    10512>>ASSIGN  10517>>ASSIGN  10518>>ASSIGN  10519>>ASSIGN
     10520>>ASSIGN  10521>>ASSIGN  10521>>ASSIGN  10522>>ASSIGN  10522>>ASSIGN  10522>>ASSIGN  10524>>ASSIGN
PL6.E3A0      #003=KNH$OPEN File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:05 Page:197  
     10525>>ASSIGN
G$JIT.CQPC
      9251**DCL     10501<<ASSIGN  10501>>ASSIGN  10613<<ASSIGN  10613>>ASSIGN
G$JIT.ERRLOG
      9401**DCL      9404--REDEF
G$JIT.JSUNIT
      9140**DCL      9141--REDEF
G$JIT.MCLS
      9139**DCL      9139--REDEF
G$JIT.TMRZ
      9408**DCL      9409--REDEF
G$JIT.USER_EXTIME
      9132**DCL      9133--REDEF
G$JIT.USER_MEMTIME
      9135**DCL      9135--REDEF
G$JIT.USER_SVTIME
      9134**DCL      9134--REDEF
G$JIT.USR#
      9129**DCL     10431>>IF      10466>>ASSIGN  10504>>ASSIGN  10552>>ASSIGN
G$JIT$
     10242**DCL      9071--IMP-PTR 10431>>IF      10466>>ASSIGN  10501>>ASSIGN  10501>>ASSIGN  10504>>ASSIGN
     10552>>ASSIGN  10613>>ASSIGN  10613>>ASSIGN
G$UHJIT.ASDT_MCL.HAND_Q
      7442**DCL     10508<<ASSIGN  10509<>CALL
G$UHJIT.ASDT_MCL.HAND_Q.V
      7444**DCL     10610<<ASSIGN
G$UHJIT.ASDT_USR.HAND_Q
      6748**DCL     10508>>ASSIGN
G$UHJIT.ASDT_USR.HAND_Q.BASE
      6750**DCL     10505>>ASSIGN
G$UHJIT.ISA_USR
      7523**DCL      7818--REDEF
G$UHJIT.ISA_USR.P$$
      7598**DCL      7598--REDEF
G$UHJIT.TSA_CP.ISA.P$$
      8805**DCL      8805--REDEF
PL6.E3A0      #003=KNH$OPEN File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:05 Page:198  
G$UHJIT.TSA_CP.P$$
      8676**DCL      8676--REDEF    8677--REDEF
G$UHJIT.TSA_DB.ISA.P$$
      8417**DCL      8417--REDEF
G$UHJIT.TSA_DB.P$$
      8288**DCL      8288--REDEF    8289--REDEF
G$UHJIT.TSA_RTT.P$$
      9051**DCL      9051--REDEF    9052--REDEF
G$UHJIT.TSA_USR.ISA.P$$
      8007**DCL      8007--REDEF
G$UHJIT.TSA_USR.P$$
      7878**DCL      7878--REDEF    7879--REDEF
G$UHJIT$
     10243**DCL      6100--IMP-PTR 10505>>ASSIGN  10508>>ASSIGN  10508>>ASSIGN  10509>>CALL    10610>>ASSIGN
G$USER.HMI$
      9480**DCL     10431>>IF      10504<<ASSIGN  10553>>ASSIGN  10609<<ASSIGN
G$USER.MISC
      9477**DCL      9477--REDEF
G$USRT$
     10244**DCL      9476--IMP-PTR 10431>>IF      10504>>ASSIGN  10553>>ASSIGN  10609>>ASSIGN
GHH$ASD
      6071**DCL-ENT 10509--CALL
GHH$LOCK
      3953**DCL-ENT 10446--CALL
GHH$UNLOCK
      3953**DCL-ENT 10457--CALL    10472--CALL
GHS$REG
      6070**DCL-ENT 10605--CALL
GMA$CHKSIZE
      6076**DCL-ENT 10483--CALL
GMA$GET
      6072**DCL-ENT 10498--CALL
GMA$GETIO
      6073**DCL-ENT 10491--CALL
GMA$REL
      6074**DCL-ENT 10612--CALL
PL6.E3A0      #003=KNH$OPEN File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:05 Page:199  
GMA$REL_ACCTMEM
      6075**DCL-ENT 10611--CALL
HMI$
     10253**DCL      9502--IMP-PTR 10437<<ASSIGN  10446>>CALL    10448>>IF      10457>>CALL    10460<<ASSIGN
     10460>>ASSIGN  10466>>ASSIGN  10472>>CALL    10485>>ASSIGN  10504>>ASSIGN  10505>>ASSIGN  10506>>ASSIGN
     10524>>ASSIGN  10525>>ASSIGN  10526>>ASSIGN  10527>>ASSIGN  10528>>ASSIGN  10529>>ASSIGN  10530>>ASSIGN
     10531>>ASSIGN  10532>>ASSIGN  10533>>ASSIGN  10536>>IF      10553<<ASSIGN  10554>>ASSIGN  10555>>ASSIGN
     10561>>DOWHILE 10614>>ASSIGN
I
     10254**DCL     10440<<DOINDEX 10563<<DOINDEX 10565>>ASSIGN
KN$DCT$
      9767**DCL     10565>>ASSIGN
KN$LDCT.CONN_TYPE
      9537**DCL     10576>>IF
KN$LDCT.RLCID
      9569**DCL     10572>>ASSIGN
KN$LDCT.RLCID.LDCTX
      9597**DCL      9604--REDEF    9612--REDEF
KN$LDCT.STATE
      9551**DCL     10567>>IF      10583>>DOCASE
KN$LDCT.TRANSPORT_ID
      9631**DCL      9639--REDEF
KN$LDCT.UID
      9661**DCL      9662--REDEF    9671--REDEF
KN$LDCT.USER#
      9754**DCL     10568>>IF
KNB$INIT
      6080**DCL-ENT 10538--CALL
KNH$HMI
      9502**DCL     10460--ASSIGN
KNH$HMI.CTX.OFFSET
      9504**DCL     10531<<ASSIGN
KNH$HMI.CTX.SZ
      9505**DCL     10530<<ASSIGN
KNH$HMI.LDCTS#
      9506**DCL     10561>>DOWHILE
PL6.E3A0      #003=KNH$OPEN File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:05 Page:200  
KNH$HMI.PP#
      9505**DCL     10505<<ASSIGN
KNH$HMI.PPSZ
      9506**DCL     10506<<ASSIGN  10554>>ASSIGN
KNH$HMI.RCQ
      9502**DCL     10525<<ASSIGN
KNH$HMI.RCQ.LOCK
      9502**DCL     10527--ASSIGN
KNH$HMI.SCQ
      9503**DCL     10524<<ASSIGN
KNH$HMI.SCQ.CLOSING
      9504**DCL     10533<<ASSIGN  10555<<ASSIGN
KNH$HMI.SCQ.LOCK
      9504**DCL     10446<>CALL    10457<>CALL    10472<>CALL    10526--ASSIGN
KNH$HMI.SCQ.SCANNED
      9504**DCL     10532<<ASSIGN
KNH$HMI.USER#
      9505**DCL     10448>>IF      10466<<ASSIGN  10485<<ASSIGN  10536>>IF      10614<<ASSIGN
KNH$HMI.WAIT_COUNT
      9505**DCL     10529<<ASSIGN
KNH$HMI.WAIT_HEAD$
      9505**DCL     10528<<ASSIGN
KNH$QHDR
      9509**DCL     10475--ASSIGN  10512<<ASSIGN  10515--ASSIGN  10520--ASSIGN  10531--ASSIGN
KNH$QHDR.CTX.OFFSET
      9513**DCL     10520<<ASSIGN  10521>>ASSIGN
KNH$QHDR.CTX.SZ
      9513**DCL     10519<<ASSIGN
KNH$QHDR.RCQ
      9509**DCL      9509--REDEF   10525>>ASSIGN
KNH$QHDR.RCQ.OFFSET
      9509**DCL     10521<<ASSIGN  10522>>ASSIGN
KNH$QHDR.RCQ.SZ
      9509**DCL     10517<<ASSIGN  10522>>ASSIGN
KNH$QHDR.SCQ
      9510**DCL     10524>>ASSIGN
PL6.E3A0      #003=KNH$OPEN File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:05 Page:201  
KNH$QHDR.SCQ.OFFSET
      9510**DCL     10522<<ASSIGN
KNH$QHDR.SCQ.SZ
      9510**DCL     10518<<ASSIGN
KNH$SCAN
      6077**DCL-ENT 10558--CALL
KNN$RECV
      6078**DCL-ENT 10580--CALL
KNS$SEND
      6079**DCL-ENT 10588--CALL    10593--CALL    10598--CALL
KN_DCT$$
     10249**DCL      9767--IMP-PTR 10565>>ASSIGN
KN_HMI#
     10248**DCL     10440>>DOINDEX
KN_HMI$
     10247**DCL     10437>>ASSIGN
KN_LDCT_MAX#
     10246**DCL     10563>>DOINDEX
KN_NETPARM_INIT
     10102**DCL     10570>>ASSIGN
KN_NETPARM_INIT.MSG$
     10109**DCL     10114--REDEF
KN_NETPARM_INIT.NHDR$
     10161**DCL     10162--REDEF
KN_NETPARM_INIT.SHDR$
     10139**DCL     10140--REDEF
KN_NETPARM_INIT.THDR$
     10150**DCL     10151--REDEF
KN_NETPARM_INIT.UHDR$
     10125**DCL     10126--REDEF
L_LEXIT
     10439**LABEL   10450--EXIT
NETPARM
      9876**DCL     10570<<ASSIGN  10580<>CALL    10588<>CALL    10593<>CALL    10598<>CALL
NETPARM.FPT$
      9995**DCL     10579<<ASSIGN  10587<<ASSIGN  10592<<ASSIGN  10597<<ASSIGN
PL6.E3A0      #003=KNH$OPEN File=KNH$HMI.:E05TSI                                 WED 07/30/97 01:05 Page:202  
NETPARM.FUNCTION
      9971**DCL     10578<<ASSIGN  10586<<ASSIGN  10591<<ASSIGN  10596<<ASSIGN
NETPARM.LDCT$
      9877**DCL     10571<<ASSIGN
NETPARM.MSG$
      9883**DCL      9888--REDEF
NETPARM.NHDR$
      9935**DCL      9936--REDEF
NETPARM.SHDR$
      9913**DCL      9914--REDEF
NETPARM.THDR$
      9924**DCL      9925--REDEF
NETPARM.UHDR$
      9899**DCL      9900--REDEF
NOCQMEM
     10278**DCL     10486>>ASSIGN  10493>>ASSIGN
NOHMI
     10334**DCL     10462>>ASSIGN
ONEHMI
     10391**DCL     10433>>ASSIGN
PPS
     10252**DCL     10475<<ASSIGN  10479>>ASSIGN  10491<>CALL    10498<>CALL    10501>>ASSIGN  10506>>ASSIGN
     10515<<ASSIGN  10515>>ASSIGN  10517>>ASSIGN  10518>>ASSIGN  10554<<ASSIGN  10611<>CALL    10612<>CALL
     10613>>ASSIGN
USR#
     10255**DCL     10552<<ASSIGN  10553>>ASSIGN  10568>>IF      10609>>ASSIGN
VLP_HMI
      6064**DCL         7--PROC
VLP_HMI.CTXSIZE
      6064**DCL     10475>>ASSIGN  10515>>ASSIGN  10519>>ASSIGN  10521>>ASSIGN  10530>>ASSIGN
VLP_HMI.IO
      6065**DCL     10482>>IF
VLP_HMI.RCQSIZE
      6064**DCL     10475>>ASSIGN  10515>>ASSIGN  10517>>ASSIGN
VLP_HMI.SCQSIZE
      6064**DCL     10475>>ASSIGN  10515>>ASSIGN  10518>>ASSIGN
