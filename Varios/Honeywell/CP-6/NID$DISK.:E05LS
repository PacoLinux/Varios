VERSION E05

PL6.E3A0      #001=NID$DEVSCHED File=NID$DISK.:E05TSI                            WED 07/30/97 03:29 Page:1    
        1        1        /*M* NID$DISK - Disk Handler */
        2        2        /*T***********************************************************/
        3        3        /*T*                                                         */
        4        4        /*T* Copyright (c) Bull HN Information Systems Inc., 1997    */
        5        5        /*T*                                                         */
        6        6        /*T***********************************************************/
        7        7        /*X* DFC=YES, DMC=YES, EDMC=YES                                    */
        8        8        /**/
        9        9        /*P* NAME:        NID$DISK
       10       10
       11       11             PURPOSE:     NID$DISK is the disk handler.
       12       12
       13       13             REFERENCE:   43A232230  EPS-1 DSC181/DSC190 Disk Controller
       14       14        */
       15       15        /*D* NAME:        NID$DEVSCHED, NID$DEVSCHEDL
       16       16
       17       17             CALL:        CALL NID$DEVSCHED(DCT,NEWSTATE);
       18       18                          CALL NID$DEVSCHEDL(DCT,NEWSTATE);
       19       19                          where:
       20       20                                 DCT$ PTR -> Device Control Table entry
       21       21                                 NEWSTATE New device state.  Put in DCT after
       22       22                                          locking SQH.GATE.
       23       23
       24       24             ENVIRONMENT: Monitor, not privileged, not inhibited
       25       25
       26       26             INPUT:       Disk I/O Tables
       27       27
       28       28             DESCRIPTION:   SQH.GATE is locked and the device's state is
       29       29                            changed to NEWSTATE.  Control then passes to
       30       30                            the SCHED code which is common to NID$DEVSCHED
       31       31                            and NID$REQSCHED.  NID$DEVSCHEDL is called if
       32       32                            SQH.GATE is already locked.  SQH.GATE will always
       33       33                            be unlocked after the return.
       34       34
       35       35                            At SCHED if the device's state is IDLE and there
       36       36                            are requests pending on the device it is placed
       37       37                            on the assign que for the subsystem.  The device
PL6.E3A0      #001=NID$DEVSCHED File=NID$DISK.:E05TSI                            WED 07/30/97 03:29 Page:2    
       38       38                            state is changed to requested.  Control then
       39       39                            passes to NID$SCANAQ.
       40       40        */
       41       41        NID$DEVSCHED: PROC (PAR,NEWSTATE);
       42       42        /*
       43       43                Includes
       44       44        */
       45       45        %INCLUDE                CP_6_SUBS ;
       46      585        %INCLUDE                HF_LOCK_C ;
       47      599        %INCLUDE                NI_DATA_C ;
       48      712        %INCLUDE                NI_DATA_R ;
       49     1149        %INCLUDE                NI_MACROS_C ;
       50     1416        %INCLUDE                N_FC_C ;
       51     1453        %INCLUDE                PM$NI ;
       52     1477        %INCLUDE                P_PMDAT_R ;
       53     1785        /*
       54     1786                Parameters
       55     1787        */
       56     1788    1   DCL 1 NEWSTATE          UBIN PARAM ;
       57     1789    1   DCL 1 PAR               UBIN PARAM ;
       58     1790        /*
       59     1791                Entries
       60     1792        */
       61     1793    1   DCL 1 NIO$DCWBLD        ENTRY(1) ALTRET ;
       62     1794    1   DCL 1 NIS$DRIVER        ENTRY(1) ;
       63     1795    1   DCL 1 PMN$COLLECT       ENTRY(2) ;
       64     1796    1   DCL 1 SC_NIDINVMIR      ENTRY CONV(2,0) ;
       65     1797    1   DCL 1 SC_NIDNOPMIR      ENTRY CONV(2,0) ;
       66     1798        /*
       67     1799                Symrefs
       68     1800        */
       69     1801    1   DCL 1 NI_IOLEAPERS      UBIN WORD SYMREF ;
       70     1802    1   DCL 1 NK_MXLOCAL        UBIN WORD SYMREF ;
       71     1803        /*
       72     1804                Auto
       73     1805        */
       74     1806    1   DCL 1 DCT$              PTR ALIGNED AUTO ;
PL6.E3A0      #001=NID$DEVSCHED File=NID$DISK.:E05TSI                            WED 07/30/97 03:29 Page:3    
       75     1807    1   DCL 1 DQH$              PTR ALIGNED AUTO ;
       76     1808    1   DCL 1 DVT$              PTR ALIGNED AUTO ;
       77     1809    1   DCL 1 MDCT$             PTR ALIGNED AUTO ;
       78     1810    1   DCL 1 MDCTX             SBIN WORD ALIGNED AUTO ;
       79     1811    1   DCL 1 MSQH$             PTR ALIGNED AUTO ;
       80     1812    1   DCL 1 REQ$              PTR ALIGNED AUTO ;
       81     1813    1   DCL 1 REQSCHEDONLY      BIT(1) ALIGNED AUTO ;
       82     1814    1   DCL 1 SQH$              PTR ALIGNED AUTO ;
       83     1815    1   DCL 1 SVDCT$            PTR ALIGNED AUTO ;
       84     1816        /*
       85     1817                Based
       86     1818        */
       87     1819        %NI$DCT                 ( NAME=DCT,     STCLASS="BASED(DCT$)" ) ;
       88     1867        %NI$DQH                 ( NAME=DQH,     STCLASS="BASED(DQH$)" ) ;
       89     1890        %NI$DVT                 ( NAME=DVT,     STCLASS="BASED(DVT$)" ) ;
       90     1897        %NI$DCT                 ( NAME=MDCT,    STCLASS="BASED(MDCT$)" ) ;
       91     1945        %NI$SQH                 ( NAME=MSQH,    STCLASS="BASED(MSQH$)" ) ;
       92     1958        %N$REQ                  ( NAME=REQ,     STCLASS="BASED(REQ$)" ) ;
       93     2016        %NI$SQH                 ( NAME=SQH,     STCLASS="BASED(SQH$)" ) ;
       94     2029
       95     2030        %EJECT ;
PL6.E3A0      #001=NID$DEVSCHED File=NID$DISK.:E05TSI                            WED 07/30/97 03:29 Page:4    
       96     2031    1           DCT$      = ADDR(PAR) ;
       97     2032    1           SQH$      = DCT.SQH$ ;
       98     2033                %LOCK ( G#=SQH.GATE ) ;
       99     2036    1           DCT.STATE = NEWSTATE ;
      100     2037    1           GOTO DEVSCHED ;
      101     2038        %EJECT ;
PL6.E3A0      #001=NID$DEVSCHED File=NID$DISK.:E05TSI                            WED 07/30/97 03:29 Page:5    
      102     2039        /*D* NAME:        NID$REQSCHED
      103     2040
      104     2041             CALL:        CALL NID$REQSCHED(REQ);
      105     2042                          where:
      106     2043                                 REQ$   PTR    -> the IOQ request packet
      107     2044
      108     2045             ENVIRONMENT: Monitor, not privileged, not inhibited.
      109     2046
      110     2047             INPUT:       N$REQ  IOQ request packet
      111     2048
      112     2049             DESCRIPTION:   NID$REQSCHED enqueues a request on the appropriate
      113     2050                            queue.  If the device is a Mirrored Disk, if it
      114     2051                            is locked, and if this is not the user who locked
      115     2052                            the device, then the IO request is enqued on the
      116     2053                            locked queue (LQ$).  Otherwise, the IO request
      117     2054                            is queued on either the device's scheduler or
      118     2055                            backup queue.  Then NID$REQSCHED goes to the
      119     2056                            common code at SCHED.
      120     2057        */
      121     2058    1   NID$REQSCHED: ENTRY(PAR);
      122     2059
      123     2060    1   REQSCHED:
      124     2061
      125     2062    2           DO  INHIBIT ;
      126     2063    2               REQ$=ADDR(PAR);
      127     2064    2               DCT$=REQ.DCT$;
      128     2065    2               SQH$=DCT.SQH$;
      129     2066                    %LOCK(G#=SQH.GATE);
      130     2069    2               END ;
      131     2070    1           REQSCHEDONLY = '0'B ;
      132     2071
      133     2072    1           IF  DCT.DP.MIRROR.FLAG
      134     2073    1           AND NOT REQ.MIRDONE
      135     2074    2           THEN DO ;
      136     2075    2               IF  REQ.DLA.DRELADDR < DCT.DP.MIRROR.DRZERO
      137     2076    2               THEN
      138     2077    2                   REQ.BPMIR = '1'B ;
PL6.E3A0      #001=NID$DEVSCHED File=NID$DISK.:E05TSI                            WED 07/30/97 03:29 Page:6    
      139     2078
      140     2079    2               IF  NOT REQ.BPMIR
      141     2080    3               THEN DO ;
      142     2081    3                   MDCTX = DCT.DP.MIRROR.DCTX ;
      143     2082    3                   MDCT$ = N$DCT$(MDCTX) ;
      144     2083    3                   MSQH$ = MDCT.SQH$ ;
      145     2084
      146     2085    3                   REQ.DOMIR = '0'B ;
      147     2086    3                   REQ.COMP  = %COMP_MIRROR ;
      148     2087
      149     2088    3                   IF  DCT.DP.MIRROR.STATE ~= %NI_MIRROR_OPER
      150     2089    4                   THEN DO ;
      151     2090    4                       IF  MDCTX > NK_MXLOCAL
      152     2091    4                       OR  MDCTX = 0
      153     2092    4                       THEN
      154     2093        /*S* SCREECH_CODE:  NID-S$INVMIR-7
      155     2094             TYPE:          SCREECH
      156     2095             MESSAGE:       Invalid Mirrored Disk DCT index.
      157     2096             DESCRIPTION:   The DCT index for the mirror of this Mirrored
      158     2097                            Disk device is invalid.
      159     2098        */
      160     2099    4                           CALL SC_NIDINVMIR ;
      161     2100
      162     2101    4                       IF  MDCT.DP.MIRROR.STATE ~= %NI_MIRROR_OPER
      163     2102    4                       THEN
      164     2103        /*S* SCREECH_CODE:  NID-S$NOPMIR-7
      165     2104             TYPE:          SCREECH
      166     2105             MESSAGE:       No operational Mirrored Disk device.
      167     2106             DESCRIPTION:   The IO system detected no operational Mirrored Disk device
      168     2107                            in a Mirrored Disk pair.  There is always supposed to be
      169     2108                            one operational Mirrored Disk device for normal Mirrored
      170     2109                            Disk IO.
      171     2110        */
      172     2111    4                           CALL SC_NIDNOPMIR ;
      173     2112
      174     2113    5                       ELSE DO ;
      175     2114    5                           REQ.DLA.DCTX = MDCTX ;
PL6.E3A0      #001=NID$DEVSCHED File=NID$DISK.:E05TSI                            WED 07/30/97 03:29 Page:7    
      176     2115    5                           REQ.DCT$     = MDCT$ ;
      177     2116    5                           CALL NIO$DCWBLD ( REQ ) ;
      178     2117                                %UNLOCK ( G#=SQH.GATE ) ;
      179     2120    5                           GOTO REQSCHED ;
      180     2121    5                           END ;
      181     2122    4                       END ;
      182     2123
      183     2124    3                   IF  REQ.FC = %N_RDBIN
      184     2125    3                   OR  REQ.FC = %N_RDASC
      185     2126    4                   THEN DO ;
      186     2127        /*N*                Alternating reads on Mirrored Disks not done
      187     2128                            because of errors caused by read done on secondary
      188     2129                            device before preceding write is completed on
      189     2130                            secondary device.
      190     2131
      191     2132                            IF  MDCT.DP.MIRROR.READ
      192     2133                            AND NOT MDCT.DP.MIRROR.LOCK
      193     2134                            THEN DO ;
      194     2135                                IF  DCT.DP.MIRROR.TOGGLE
      195     2136                                THEN
      196     2137                                    DCT.DP.MIRROR.TOGGLE = '0'B ;
      197     2138                                ELSE DO ;
      198     2139                                    DCT.DP.MIRROR.TOGGLE = '1'B ;
      199     2140                                    REQ.DLA.DCTX         = MDCTX ;
      200     2141                                    DCT$                 = MDCT$ ;
      201     2142                                    REQ.DCT$             = DCT$ ;
      202     2143                                    MDCTX                = DCT.DP.MIRROR.DCTX ;
      203     2144                                    MDCT$                = N$DCT$(MDCTX) ;
      204     2145                                    CALL NIO$DCWBLD ( REQ ) ;
      205     2146                                    IF  SQH$ ~= MSQH$
      206     2147                                    THEN DO INHIBIT ;
      207     2148                                        %UNLOCK ( G#=SQH.GATE ) ;
      208     2149                                        %LOCK   ( G#=MSQH.GATE ) ;
      209     2150                                        SQH$    = MSQH$ ;
      210     2151                                        MSQH$   = MDCT.SQH$ ;
      211     2152                                        END ;
      212     2153                                    END ;
PL6.E3A0      #001=NID$DEVSCHED File=NID$DISK.:E05TSI                            WED 07/30/97 03:29 Page:8    
      213     2154                                END ;
      214     2155
      215     2156                            ELSE DO ;
      216     2157                                END ;
      217     2158
      218     2159        *N*/
      219     2160    4                       END ;
      220     2161
      221     2162    3                   ELSE IF  MDCT.DP.MIRROR.WRITE
      222     2163    3                   THEN
      223     2164    3                       REQ.DOMIR = '1'B ;
      224     2165
      225     2166    3                   END ; /* IF  NOT REQ.BPMIR */
      226     2167
      227     2168    2               END ; /* IF  Mirrored Disk */
      228     2169    1           IF  DCT.DP.MIRROR.FLAG
      229     2170    1           AND DCT.DP.MIRROR.LOCK
      230     2171    1           AND REQ.USER# ~= DCT.DP.MIRROR.USER#
      231     2172    2           THEN DO ;
      232     2173                    %ENQUEUE ( P#=REQ, Q#=DCT.DP.MIRROR.LQ$ ) ;
      233     2176    2               GOTO PMNBUSY ;
      234     2177    2               END ;
      235     2178
      236     2179
      237     2180    1           GOTO REQSCHEDL ;
      238     2181
      239     2182        /*
      240     2183           ENQUEUE REQUEST ON APPROPRIATE QUEUE
      241     2184        */
      242     2185
      243     2186    1   NID$REQSCHEDL:  ENTRY ( PAR ) ;
      244     2187    1           REQ$         = ADDR(PAR) ;
      245     2188    1           DCT$         = REQ.DCT$ ;
      246     2189    1           SQH$         = DCT.SQH$ ;
      247     2190    1           REQSCHEDONLY = '1'B ;
      248     2191
      249     2192    1   REQSCHEDL:
PL6.E3A0      #001=NID$DEVSCHED File=NID$DISK.:E05TSI                            WED 07/30/97 03:29 Page:9    
      250     2193    1           IF DCT.SQ$ = ADDR(NIL)
      251     2194    2           THEN DO ;
      252     2195    2              REQ.FL$=REQ$;
      253     2196    2              DCT.SQ$=REQ$;
      254     2197    2              DCT.DP.LEAPERS=0;
      255     2198    2              DCT.DP.SWP='0'B;
      256     2199    2              DCT.DP.CSEEK=0;
      257     2200    2              END;
      258     2201    2           ELSE DO;
      259     2202    3              IF DCT.DP.SWP THEN DO;       /* GOING DOWN */
      260     2203    3                 IF BITBIN(REQ.DLA)>DCT.DP.CSEEK OR
      261     2204    3                   (DCT.DP.BQ$~=ADDR(NIL) AND DCT.DP.LEAPERS>NI_IOLEAPERS) THEN
      262     2205    3                    CALL ENQUP(DCT.DP.BQ$);
      263     2206    4                 ELSE DO;
      264     2207    4                    DCT.DP.LEAPERS=DCT.DP.LEAPERS+1;
      265     2208    4                    CALL ENQDOWN(DCT.SQ$);
      266     2209    4                    END;
      267     2210    3                 END;
      268     2211    3              ELSE DO;                     /* GOING UP */
      269     2212    3                 IF BITBIN(REQ.DLA)<DCT.DP.CSEEK OR
      270     2213    3                   (DCT.DP.BQ$~=ADDR(NIL) AND DCT.DP.LEAPERS>NI_IOLEAPERS) THEN
      271     2214    3                    CALL ENQDOWN(DCT.DP.BQ$);
      272     2215    4                 ELSE DO;
      273     2216    4                    DCT.DP.LEAPERS=DCT.DP.LEAPERS+1;
      274     2217    4                    CALL ENQUP(DCT.SQ$);
      275     2218    4                    END;
      276     2219    3                 END;
      277     2220    2              END;
      278     2221    1           IF  REQSCHEDONLY
      279     2222    2           THEN DO ;
      280     2223    2               IF  DCT.STATE = %IDLE
      281     2224    2               AND DCT.SQ$ ~= ADDR(NIL)
      282     2225    3               THEN DO ;
      283     2226                        %ENQUEUE ( P#=DCT, Q#=SQH.AQ$ ) ;
      284     2229    3                   DCT.STATE = %REQUESTED ;
      285     2230    3                   CALL PMN$COLLECT ( DCT.PM, %PM_WAIT ) ;
      286     2231    3                   END ;
PL6.E3A0      #001=NID$DEVSCHED File=NID$DISK.:E05TSI                            WED 07/30/97 03:29 Page:10   
      287     2232    2               RETURN ;
      288     2233    2               END ;
      289     2234
      290     2235    1   PMNBUSY:
      291     2236    1           IF  DCT.PM.MODE = %PM_BUSY
      292     2237    1           THEN
      293     2238    1               CALL PMN$COLLECT ( DCT.PM, %PM_QUED ) ;
      294     2239
      295     2240    1           GOTO DEVSCHED ;
      296     2241        %EJECT;
PL6.E3A0      #001=NID$DEVSCHED File=NID$DISK.:E05TSI                            WED 07/30/97 03:29 Page:11   
      297     2242    1   NID$DEVSCHEDL: ENTRY(PAR,NEWSTATE);
      298     2243    1           DCT$=ADDR(PAR);
      299     2244    1           SQH$=DCT.SQH$;
      300     2245    1           DCT.STATE=NEWSTATE;
      301     2246    1   DEVSCHED:
      302     2247    2           IF DCT.STATE=%IDLE THEN DO;
      303     2248    3              IF DCT.SQ$~=ADDR(NIL) THEN DO;
      304     2249                      %ENQUEUE (P#=DCT,Q#=SQH.AQ$);
      305     2252    3                 DCT.STATE=%REQUESTED;
      306     2253    3                 CALL PMN$COLLECT(DCT.PM,%PM_WAIT);
      307     2254    3                 END;
      308     2255    3              ELSE DO;
      309     2256    3                 IF DCT.TYPE=%DV_DP THEN DCT.DP.CSEEK=0;
      310     2257    3                 CALL PMN$COLLECT(DCT.PM,%PM_IDLE);
      311     2258    3                 END;
      312     2259    2              END;
      313     2260    1           GOTO SCANAQ;
      314     2261        %EJECT ;
PL6.E3A0      #001=NID$DEVSCHED File=NID$DISK.:E05TSI                            WED 07/30/97 03:29 Page:12   
      315     2262        /*D* NAME:          NID$SCANAQ
      316     2263
      317     2264             CALL:          CALL NID$SCANAQ(SQH);
      318     2265                            where:
      319     2266                                  SQH is the subsytem to be scanned.
      320     2267
      321     2268             ENVIRONMENT:   Monitor, not privileged, not inhibited
      322     2269
      323     2270             INPUT:         Disk I/O Tables
      324     2271
      325     2272             DESCRIPTION:   NID$SCANAQ scans all the requests on the subsystem
      326     2273                            assign queue to find any that can be started.
      327     2274                            After the scan is completed, SQH.GATE is unlocked.
      328     2275                                                                           */
      329     2276    1   NID$SCANAQ: ENTRY(PAR);
      330     2277    1           SQH$=ADDR(PAR);
      331     2278                %LOCK (G#=SQH.GATE);
      332     2281    1   SCANAQ:
      333     2282    1           SVDCT$=ADDR(NIL);
      334     2283    2           DO WHILE(SQH.AQ$~=ADDR(NIL));
      335     2284                   %DEQUEUE(P#=DCT$,Q#=SQH.AQ$);
      336     2291    2              DVT$=DCT.DVT$;
      337     2292    2              REQ$=DCT.SQ$->REQ.FL$;
      338     2293    3              IF REQ.DQH$=ADDR(NIL) THEN DO; /* REGULAR REQUEST */
      339     2294    4                 IF SQH.CQ$=ADDR(NIL) THEN DO;
      340     2295                         %ENQUEUE(P#=DCT,Q#=SVDCT$);
      341     2298    4                    END;
      342     2299    4                 ELSE DO;
      343     2300                         %DEQUEUE(P#=DQH$,Q#=SQH.CQ$);
      344     2307                         %DEQUEUE(P#=REQ$,Q#=DCT.SQ$);
      345     2314    4                    DQH.IO$=REQ$;
      346     2315    4                    DCT.DQH$=DQH$;
      347     2316    4                    DCT.STATE=%BUSY;
      348     2317    4                    DCT.DP.CSEEK=BITBIN(REQ.DLA);
      349     2318    5                    IF DCT.SQ$=ADDR(NIL) THEN DO;
      350     2319    5                       DCT.SQ$=DCT.DP.BQ$;
      351     2320    5                       DCT.DP.BQ$=ADDR(NIL);
PL6.E3A0      #001=NID$DEVSCHED File=NID$DISK.:E05TSI                            WED 07/30/97 03:29 Page:13   
      352     2321    5                       DCT.DP.LEAPERS=0;
      353     2322    5                       DCT.DP.SWP=~DCT.DP.SWP;
      354     2323    5                       IF DCT.SQ$=ADDR(NIL) THEN
      355     2324    5                          CALL PMN$COLLECT(DCT.PM,%PM_BUSY);
      356     2325    5                       ELSE
      357     2326    5                          CALL PMN$COLLECT(DCT.PM,%PM_QUED);
      358     2327    5                       END;
      359     2328    4                    ELSE CALL PMN$COLLECT(DCT.PM,%PM_QUED);
      360     2329    4                    CALL NIS$DRIVER(DQH);
      361     2330    4                    END;
      362     2331    3                 END;
      363     2332    3              ELSE DO;                     /* SPECIAL REQUESTS */
      364     2333    3                 DQH$=REQ.DQH$;
      365     2334    3                 IF DQH.STATE~=%IDLE OR
      366     2335    4                   (REQ.IOFLG.STOPMPC AND NOT DQH.MPC$->DCT.DFLG.MPCSTOP) THEN DO;
      367     2336                         %ENQUEUE(P#=DCT,Q#=SVDCT$);
      368     2339    4                    END;
      369     2340    4                 ELSE DO;
      370     2341    5                    IF DQH.FL$~=ADDR(NIL) THEN DO;
      371     2342    6                       DO WHILE(SQH.CQ$->DQH.FL$~=DQH$);
      372     2343    6                          SQH.CQ$=SQH.CQ$->DQH.FL$;
      373     2344    6                          END;
      374     2345                            %DEQUEUE(P#=DQH$,Q#=SQH.CQ$);
      375     2352    5                       END;
      376     2353                         %DEQUEUE(P#=REQ$,Q#=DCT.SQ$);
      377     2360    4                    DQH.IO$=REQ$;
      378     2361    4                    IF REQ.IOFLG.SUSP THEN DQH.MPC$->DCT.DFLG.MPCSUSPENDED='1'B;
      379     2362    4                    DCT.DQH$=DQH$;
      380     2363    4                    DCT.STATE=%BUSY;
      381     2364    5                    IF DCT.TYPE=%DV_DP THEN DO;
      382     2365    5                       DCT.DP.CSEEK=BITBIN(REQ.DLA);
      383     2366    6                       IF DCT.SQ$=ADDR(NIL) THEN DO;
      384     2367    6                          DCT.SQ$=DCT.DP.BQ$;
      385     2368    6                          DCT.DP.BQ$=ADDR(NIL);
      386     2369    6                          DCT.DP.LEAPERS=0;
      387     2370    6                          DCT.DP.SWP=~DCT.DP.SWP;
      388     2371    6                          IF DCT.SQ$=ADDR(NIL) THEN
PL6.E3A0      #001=NID$DEVSCHED File=NID$DISK.:E05TSI                            WED 07/30/97 03:29 Page:14   
      389     2372    6                             CALL PMN$COLLECT(DCT.PM,%PM_BUSY);
      390     2373    6                          ELSE
      391     2374    6                             CALL PMN$COLLECT(DCT.PM,%PM_QUED);
      392     2375    6                          END;
      393     2376    5                       ELSE CALL PMN$COLLECT(DCT.PM,%PM_QUED);
      394     2377    5                       END;
      395     2378    4                    ELSE CALL PMN$COLLECT(DCT.PM,%PM_BUSY);
      396     2379    4                    CALL NIS$DRIVER(DQH);
      397     2380    4                    END;
      398     2381    3                 END;
      399     2382    2              END;
      400     2383    1           SQH.AQ$=SVDCT$;
      401     2384                %UNLOCK(G#=SQH.GATE);
      402     2387    1           RETURN;
      403     2388        %EJECT;
PL6.E3A0      #001=NID$DEVSCHED File=NID$DISK.:E05TSI                            WED 07/30/97 03:29 Page:15   
      404     2389        /* ENQUEUE REQUEST ON APPROPRIATE SCHEDULER QUEUE */
      405     2390        /**/
      406     2391    1   ENQUP:  PROC(Q$);
      407     2392    2   DCL Q$ PTR;
      408     2393        /**/
      409     2394        /* ON ENTRY TO THIS PROCEDURE REQ$ POINTS TO REQUEST TO BE ENQUEUED */
      410     2395        /**/
      411     2396    2   DCL DLA UBIN;
      412     2397    2   DCL FREQ$ PTR;
      413     2398    2   DCL NXT$ PTR;
      414     2399    3           IF Q$=ADDR(NIL) THEN DO;
      415     2400    3              REQ.FL$=REQ$;
      416     2401    3              Q$=REQ$;
      417     2402    3              RETURN;
      418     2403    3              END;
      419     2404    2           DLA=BITBIN(REQ.DLA)+1;
      420     2405    2           FREQ$=ADDR(NIL);
      421     2406    2           NXT$=Q$->REQ.FL$;
      422     2407    3           DO WHILE(DLA>BITBIN(NXT$->REQ.DLA) AND FREQ$~=Q$);
      423     2408    3              FREQ$=NXT$;
      424     2409    3              NXT$=FREQ$->REQ.FL$;
      425     2410    3              END;
      426     2411    2           GOTO INSRT;
      427     2412        /**/
      428     2413        /**/
      429     2414        /**/
      430     2415    2   ENQDOWN: ENTRY(Q$);
      431     2416    3           IF Q$=ADDR(NIL) THEN DO;
      432     2417    3              REQ.FL$=REQ$;
      433     2418    3              Q$=REQ$;
      434     2419    3              RETURN;
      435     2420    3              END;
      436     2421    2           DLA=BITBIN(REQ.DLA)-1;
      437     2422    2           FREQ$=ADDR(NIL);
      438     2423    2           NXT$=Q$->REQ.FL$;
      439     2424    3           DO WHILE(DLA<BITBIN(NXT$->REQ.DLA) AND FREQ$~=Q$);
      440     2425    3              FREQ$=NXT$;
PL6.E3A0      #001=NID$DEVSCHED File=NID$DISK.:E05TSI                            WED 07/30/97 03:29 Page:16   
      441     2426    3              NXT$=FREQ$->REQ.FL$;
      442     2427    3              END;
      443     2428    2   INSRT:
      444     2429    3           IF FREQ$=ADDR(NIL) THEN DO;
      445     2430    3              REQ.FL$=Q$->REQ.FL$;
      446     2431    3              Q$->REQ.FL$=REQ$;
      447     2432    3              RETURN;
      448     2433    3              END;
      449     2434    2           REQ.FL$=FREQ$->REQ.FL$;
      450     2435    2           FREQ$->REQ.FL$=REQ$;
      451     2436    2           IF FREQ$=Q$ THEN Q$=REQ$;
      452     2437    2           RETURN;
      453     2438    2   END ENQUP;
      454     2439    1   END NID$DEVSCHED;
      455     2440        %EOD;

PL6.E3A0      #001=NID$DEVSCHED File=NID$DISK.:E05TSI                            WED 07/30/97 03:29 Page:17   
--  Include file information  --

   P_PMDAT_C.:E05TOU  is referenced.
   P_PMDAT_R.:E05TOU  cannot be made into a system file and is referenced.
   PM$NI.:E05TOU  is referenced.
   N_FC_C.:E05TOU  is referenced.
   NI_MACROS_C.:E05TOU  cannot be made into a system file and is referenced.
   NI$TABLES.:E05TOU  is referenced.
   N$REQ.:E05TOU  is referenced.
   NI_DATA_R.:E05TOU  cannot be made into a system file and is referenced.
   NI_DATA_C.:E05TOU  is referenced.
   HF_LOCK_C.:E05TOU  cannot be made into a system file and is referenced.
   CP_6_SUBS.:E05TOU  is referenced.
      No diagnostics issued in procedure NID$DEVSCHED.

   Procedure NID$DEVSCHED requires 680 words for executable code.
   Procedure NID$DEVSCHED requires 24 words of local(AUTO) storage.

PL6.E3A0      #001=NID$DEVSCHED File=NID$DISK.:E05TSI                            WED 07/30/97 03:29 Page:18   

 Object Unit name= NID$DEVSCHED                               File name= NID$DISK.:E05TOU
 UTS= JUL 30 '97 03:29:40.44 WED                              Compiler= PL-6/E31         Sev=      00
 SharedLib= :SHARED_SYSTEM                                    Alt SharedLib=


    ****  Control sections  ****

 Sect   Type Bound  Init  Size OctSiz  Section name(segment info)
    0   Proc  even  none   680   1250  NID$DEVSCHED
    1  RoData even  none     6      6  NID$DEVSCHED

    ****  Entry defs  ****

                              Check   Calling
                             calling  sequence
  Sect OctLoc Primary Altret sequence   type   Parms  Name
     0      0   yes            yes      Std        2  NID$DEVSCHED
     0     20                  yes      Std        1  NID$REQSCHED
     0    205                  yes      Std        1  NID$REQSCHEDL
     0    400                  yes      Std        2  NID$DEVSCHEDL
     0    465                  yes      Std        1  NID$SCANAQ

  ****  Entry refs  ****

         Check        Calling
        calling       sequence
Altret sequence SRef   type   Args  Name
         yes           Std       1 HFC$LOCK
         yes           Std       1 HFC$UNLOCK
         yes           Std       2 PMN$COLLECT
 yes     yes           Std       2 NIM$DEQUEUE
         yes           Std       1 NIS$DRIVER
 yes     yes           Std       1 NIO$DCWBLD
         yes           Std       2 NIM$ENQUEUE
                       nStd      0 X66_AUTO_2
                       Std       0 B_CONSPOOL_D
                       nStd      0 X66_ARET
PL6.E3A0      #001=NID$DEVSCHED File=NID$DISK.:E05TSI                            WED 07/30/97 03:29 Page:19   

  ****  Data refs  ****

  Flags:  r = read only, s = secondary
Flgs Name                             Flgs Name                             Flgs Name
     SC_NIDINVMIR                          SC_NIDNOPMIR                          N$DCT$$
     N$FQ$                                 NI$FQ$                                NI$IBUF$
     NI$RP$                                P_RESOURCE$                           P_UPTIME
     P_NSCPU                               NI_IOLEAPERS                          NK_MXLOCAL
     B_VECTNIL

  ****  Segment refs  ****

  Flags:  r = read only, s = secondary
Flgs Name                             Flgs Name                             Flgs Name
     ASLENTSID                             ISSID
PL6.E3A0      #001=NID$DEVSCHED File=NID$DISK.:E05TSI                            WED 07/30/97 03:29 Page:20   


        1        1        /*M* NID$DISK - Disk Handler */
        2        2        /*T***********************************************************/
        3        3        /*T*                                                         */
        4        4        /*T* Copyright (c) Bull HN Information Systems Inc., 1997    */
        5        5        /*T*                                                         */
        6        6        /*T***********************************************************/
        7        7        /*X* DFC=YES, DMC=YES, EDMC=YES                                    */
        8        8        /**/
        9        9        /*P* NAME:        NID$DISK
       10       10
       11       11             PURPOSE:     NID$DISK is the disk handler.
       12       12
       13       13             REFERENCE:   43A232230  EPS-1 DSC181/DSC190 Disk Controller
       14       14        */
       15       15        /*D* NAME:        NID$DEVSCHED, NID$DEVSCHEDL
       16       16
       17       17             CALL:        CALL NID$DEVSCHED(DCT,NEWSTATE);
       18       18                          CALL NID$DEVSCHEDL(DCT,NEWSTATE);
       19       19                          where:
       20       20                                 DCT$ PTR -> Device Control Table entry
       21       21                                 NEWSTATE New device state.  Put in DCT after
       22       22                                          locking SQH.GATE.
       23       23
       24       24             ENVIRONMENT: Monitor, not privileged, not inhibited
       25       25
       26       26             INPUT:       Disk I/O Tables
       27       27
       28       28             DESCRIPTION:   SQH.GATE is locked and the device's state is
       29       29                            changed to NEWSTATE.  Control then passes to
       30       30                            the SCHED code which is common to NID$DEVSCHED
       31       31                            and NID$REQSCHED.  NID$DEVSCHEDL is called if
       32       32                            SQH.GATE is already locked.  SQH.GATE will always
       33       33                            be unlocked after the return.
       34       34
       35       35                            At SCHED if the device's state is IDLE and there
       36       36                            are requests pending on the device it is placed
PL6.E3A0      #001=NID$DEVSCHED File=NID$DISK.:E05TSI                            WED 07/30/97 03:29 Page:21   
       37       37                            on the assign que for the subsystem.  The device
       38       38                            state is changed to requested.  Control then
       39       39                            passes to NID$SCANAQ.
       40       40        */
       41       41        NID$DEVSCHED: PROC (PAR,NEWSTATE);

     41  0 000000   000000 700200 xent  NID$DEVSCHED TSX0  ! X66_AUTO_2
         0 000001   000030 000002                    ZERO    24,2

       42       42        /*
       43       43                Includes
       44       44        */
       45       45        %INCLUDE                CP_6_SUBS ;
       46      585        %INCLUDE                HF_LOCK_C ;
       47      599        %INCLUDE                NI_DATA_C ;
       48      712        %INCLUDE                NI_DATA_R ;
       49     1149        %INCLUDE                NI_MACROS_C ;
       50     1416        %INCLUDE                N_FC_C ;
       51     1453        %INCLUDE                PM$NI ;
       52     1477        %INCLUDE                P_PMDAT_R ;
       53     1785        /*
       54     1786                Parameters
       55     1787        */
       56     1788    1   DCL 1 NEWSTATE          UBIN PARAM ;
       57     1789    1   DCL 1 PAR               UBIN PARAM ;
       58     1790        /*
       59     1791                Entries
       60     1792        */
       61     1793    1   DCL 1 NIO$DCWBLD        ENTRY(1) ALTRET ;
       62     1794    1   DCL 1 NIS$DRIVER        ENTRY(1) ;
       63     1795    1   DCL 1 PMN$COLLECT       ENTRY(2) ;
       64     1796    1   DCL 1 SC_NIDINVMIR      ENTRY CONV(2,0) ;
       65     1797    1   DCL 1 SC_NIDNOPMIR      ENTRY CONV(2,0) ;
       66     1798        /*
       67     1799                Symrefs
       68     1800        */
       69     1801    1   DCL 1 NI_IOLEAPERS      UBIN WORD SYMREF ;
PL6.E3A0      #001=NID$DEVSCHED File=NID$DISK.:E05TSI                            WED 07/30/97 03:29 Page:22   
       70     1802    1   DCL 1 NK_MXLOCAL        UBIN WORD SYMREF ;
       71     1803        /*
       72     1804                Auto
       73     1805        */
       74     1806    1   DCL 1 DCT$              PTR ALIGNED AUTO ;
       75     1807    1   DCL 1 DQH$              PTR ALIGNED AUTO ;
       76     1808    1   DCL 1 DVT$              PTR ALIGNED AUTO ;
       77     1809    1   DCL 1 MDCT$             PTR ALIGNED AUTO ;
       78     1810    1   DCL 1 MDCTX             SBIN WORD ALIGNED AUTO ;
       79     1811    1   DCL 1 MSQH$             PTR ALIGNED AUTO ;
       80     1812    1   DCL 1 REQ$              PTR ALIGNED AUTO ;
       81     1813    1   DCL 1 REQSCHEDONLY      BIT(1) ALIGNED AUTO ;
       82     1814    1   DCL 1 SQH$              PTR ALIGNED AUTO ;
       83     1815    1   DCL 1 SVDCT$            PTR ALIGNED AUTO ;
       84     1816        /*
       85     1817                Based
       86     1818        */
       87     1819        %NI$DCT                 ( NAME=DCT,     STCLASS="BASED(DCT$)" ) ;
       88     1867        %NI$DQH                 ( NAME=DQH,     STCLASS="BASED(DQH$)" ) ;
       89     1890        %NI$DVT                 ( NAME=DVT,     STCLASS="BASED(DVT$)" ) ;
       90     1897        %NI$DCT                 ( NAME=MDCT,    STCLASS="BASED(MDCT$)" ) ;
       91     1945        %NI$SQH                 ( NAME=MSQH,    STCLASS="BASED(MSQH$)" ) ;
       92     1958        %N$REQ                  ( NAME=REQ,     STCLASS="BASED(REQ$)" ) ;
       93     2016        %NI$SQH                 ( NAME=SQH,     STCLASS="BASED(SQH$)" ) ;
       94     2029
       95     2030        %EJECT ;
PL6.E3A0      #001=NID$DEVSCHED File=NID$DISK.:E05TSI                            WED 07/30/97 03:29 Page:23   
       96     2031    1           DCT$      = ADDR(PAR) ;

   2031  0 000002   200003 236100                    LDQ     @PAR,,AUTO
         0 000003   200005 756100                    STQ     DCT$,,AUTO

       97     2032    1           SQH$      = DCT.SQH$ ;

   2032  0 000004   200005 470500                    LDP0    DCT$,,AUTO
         0 000005   000022 236100                    LDQ     18,,PR0
         0 000006   200015 756100                    STQ     SQH$,,AUTO

       98     2033                %LOCK ( G#=SQH.GATE ) ;

   2034  0 000007   200015 630500                    EPPR0   SQH$,,AUTO
         0 000010   000017 631400 xsym               EPPR1   B_VECTNIL+15
         0 000011   000000 701000 xent               TSX1    HFC$LOCK
         0 000012   000000 011000                    NOP     0

       99     2036    1           DCT.STATE = NEWSTATE ;

   2036  0 000013   200004 470500                    LDP0    @NEWSTATE,,AUTO
         0 000014   200005 471500                    LDP1    DCT$,,AUTO
         0 000015   000000 236100                    LDQ     0,,PR0
         0 000016   100007 752101                    STCQ    7,'01'O,PR1

      100     2037    1           GOTO DEVSCHED ;

   2037  0 000017   000412 710000 0                  TRA     DEVSCHED

      101     2038        %EJECT ;
PL6.E3A0      #001=NID$DEVSCHED File=NID$DISK.:E05TSI                            WED 07/30/97 03:29 Page:24   
      102     2039        /*D* NAME:        NID$REQSCHED
      103     2040
      104     2041             CALL:        CALL NID$REQSCHED(REQ);
      105     2042                          where:
      106     2043                                 REQ$   PTR    -> the IOQ request packet
      107     2044
      108     2045             ENVIRONMENT: Monitor, not privileged, not inhibited.
      109     2046
      110     2047             INPUT:       N$REQ  IOQ request packet
      111     2048
      112     2049             DESCRIPTION:   NID$REQSCHED enqueues a request on the appropriate
      113     2050                            queue.  If the device is a Mirrored Disk, if it
      114     2051                            is locked, and if this is not the user who locked
      115     2052                            the device, then the IO request is enqued on the
      116     2053                            locked queue (LQ$).  Otherwise, the IO request
      117     2054                            is queued on either the device's scheduler or
      118     2055                            backup queue.  Then NID$REQSCHED goes to the
      119     2056                            common code at SCHED.
      120     2057        */
      121     2058    1   NID$REQSCHED: ENTRY(PAR);

   2058  0 000020   000000 700200 xent  NID$REQSCHED TSX0  ! X66_AUTO_2
         0 000021   000030 000002                    ZERO    24,2

      122     2059
      123     2060    1   REQSCHED:
      124     2061
      125     2062    2           DO  INHIBIT ;

   2062  0 000022                       REQSCHED     null
      126     2063    2               REQ$=ADDR(PAR);

   2063  0 000022   200003 236300                    LDQ   ! @PAR,,AUTO
         0 000023   200013 756300                    STQ   ! REQ$,,AUTO

      127     2064    2               DCT$=REQ.DCT$;

PL6.E3A0      #001=NID$DEVSCHED File=NID$DISK.:E05TSI                            WED 07/30/97 03:29 Page:25   
   2064  0 000024   200013 470700                    LDP0  ! REQ$,,AUTO
         0 000025   000002 236300                    LDQ   ! 2,,PR0
         0 000026   200005 756300                    STQ   ! DCT$,,AUTO

      128     2065    2               SQH$=DCT.SQH$;

   2065  0 000027   200005 471700                    LDP1  ! DCT$,,AUTO
         0 000030   100022 236300                    LDQ   ! 18,,PR1
         0 000031   200015 756300                    STQ   ! SQH$,,AUTO

      129     2066                    %LOCK(G#=SQH.GATE);

   2067  0 000032   200015 630700                    EPPR0 ! SQH$,,AUTO
         0 000033   000017 631600 xsym               EPPR1 ! B_VECTNIL+15
         0 000034   000000 701200 xent               TSX1  ! HFC$LOCK
         0 000035   000000 011200                    NOP   ! 0

      130     2069    2               END ;

      131     2070    1           REQSCHEDONLY = '0'B ;

   2070  0 000036   200014 450100                    STZ     REQSCHEDONLY,,AUTO

      132     2071
      133     2072    1           IF  DCT.DP.MIRROR.FLAG

   2072  0 000037   200005 470500                    LDP0    DCT$,,AUTO
         0 000040   000036 234100                    SZN     30,,PR0
         0 000041   000160 605000 0                  TPL     s:2169
         0 000042   200013 471500                    LDP1    REQ$,,AUTO
         0 000043   100034 236100                    LDQ     28,,PR1
         0 000044   100000 316003                    CANQ    32768,DU
         0 000045   000160 601000 0                  TNZ     s:2169

      134     2073    1           AND NOT REQ.MIRDONE
      135     2074    2           THEN DO ;

PL6.E3A0      #001=NID$DEVSCHED File=NID$DISK.:E05TSI                            WED 07/30/97 03:29 Page:26   
      136     2075    2               IF  REQ.DLA.DRELADDR < DCT.DP.MIRROR.DRZERO

   2075  0 000046   100001 236100                    LDQ     1,,PR1
         0 000047   000000 376000 1                  ANQ     0
         0 000050   000041 116100                    CMPQ    33,,PR0
         0 000051   000054 605000 0                  TPL     s:2079

      137     2076    2               THEN
      138     2077    2                   REQ.BPMIR = '1'B ;

   2077  0 000052   200000 236003                    LDQ     65536,DU
         0 000053   100034 256100                    ORSQ    28,,PR1

      139     2078
      140     2079    2               IF  NOT REQ.BPMIR

   2079  0 000054   100034 236100                    LDQ     28,,PR1
         0 000055   200000 316003                    CANQ    65536,DU
         0 000056   000160 601000 0                  TNZ     s:2169

      141     2080    3               THEN DO ;

      142     2081    3                   MDCTX = DCT.DP.MIRROR.DCTX ;

   2081  0 000057   000037 236100                    LDQ     31,,PR0
         0 000060   000022 772000                    QRL     18
         0 000061   200011 756100                    STQ     MDCTX,,AUTO

      143     2082    3                   MDCT$ = N$DCT$(MDCTX) ;

   2082  0 000062   000000 473400 xsym               LDP3    N$DCT$$
         0 000063   300000 236106                    LDQ     0,QL,PR3
         0 000064   200010 756100                    STQ     MDCT$,,AUTO

      144     2083    3                   MSQH$ = MDCT.SQH$ ;

   2083  0 000065   200010 474500                    LDP4    MDCT$,,AUTO
PL6.E3A0      #001=NID$DEVSCHED File=NID$DISK.:E05TSI                            WED 07/30/97 03:29 Page:27   
         0 000066   400022 236100                    LDQ     18,,PR4
         0 000067   200012 756100                    STQ     MSQH$,,AUTO

      145     2084
      146     2085    3                   REQ.DOMIR = '0'B ;

   2085  0 000070   000031 236000 xsym               LDQ     B_VECTNIL+25
         0 000071   100034 356100                    ANSQ    28,,PR1

      147     2086    3                   REQ.COMP  = %COMP_MIRROR ;

   2086  0 000072   100027 236100                    LDQ     23,,PR1
         0 000073   000001 376000 1                  ANQ     1
         0 000074   010000 276007                    ORQ     4096,DL
         0 000075   100027 756100                    STQ     23,,PR1

      148     2087
      149     2088    3                   IF  DCT.DP.MIRROR.STATE ~= %NI_MIRROR_OPER

   2088  0 000076   000036 236100                    LDQ     30,,PR0
         0 000077   007700 316003                    CANQ    4032,DU
         0 000100   000142 600000 0                  TZE     s:2124

      150     2089    4                   THEN DO ;

      151     2090    4                       IF  MDCTX > NK_MXLOCAL

   2090  0 000101   000000 236000 xsym               LDQ     NK_MXLOCAL
         0 000102   000105 604000 0                  TMI     s:2090+4
         0 000103   200011 116100                    CMPQ    MDCTX,,AUTO
         0 000104   000107 604000 0                  TMI     s:2099
         0 000105   200011 235100                    LDA     MDCTX,,AUTO
         0 000106   000111 601000 0                  TNZ     s:2101

      152     2091    4                       OR  MDCTX = 0
      153     2092    4                       THEN
      154     2093        /*S* SCREECH_CODE:  NID-S$INVMIR-7
PL6.E3A0      #001=NID$DEVSCHED File=NID$DISK.:E05TSI                            WED 07/30/97 03:29 Page:28   
      155     2094             TYPE:          SCREECH
      156     2095             MESSAGE:       Invalid Mirrored Disk DCT index.
      157     2096             DESCRIPTION:   The DCT index for the mirror of this Mirrored
      158     2097                            Disk device is invalid.
      159     2098        */
      160     2099    4                           CALL SC_NIDINVMIR ;

   2099  0 000107   000000 713400 xsym               CLIMB   SC_NIDINVMIR
         0 000110   000000 600000 xsid               climb   nvectors=         0

      161     2100
      162     2101    4                       IF  MDCT.DP.MIRROR.STATE ~= %NI_MIRROR_OPER

   2101  0 000111   200010 470500                    LDP0    MDCT$,,AUTO
         0 000112   000036 236100                    LDQ     30,,PR0
         0 000113   007700 316003                    CANQ    4032,DU
         0 000114   000120 600000 0                  TZE     s:2114

      163     2102    4                       THEN
      164     2103        /*S* SCREECH_CODE:  NID-S$NOPMIR-7
      165     2104             TYPE:          SCREECH
      166     2105             MESSAGE:       No operational Mirrored Disk device.
      167     2106             DESCRIPTION:   The IO system detected no operational Mirrored Disk device
      168     2107                            in a Mirrored Disk pair.  There is always supposed to be
      169     2108                            one operational Mirrored Disk device for normal Mirrored
      170     2109                            Disk IO.
      171     2110        */
      172     2111    4                           CALL SC_NIDNOPMIR ;

   2111  0 000115   000000 713400 xsym               CLIMB   SC_NIDNOPMIR
         0 000116   000000 600000 xsid               climb   nvectors=         0
         0 000117   000142 710000 0                  TRA     s:2124

      173     2112
      174     2113    5                       ELSE DO ;

      175     2114    5                           REQ.DLA.DCTX = MDCTX ;
PL6.E3A0      #001=NID$DEVSCHED File=NID$DISK.:E05TSI                            WED 07/30/97 03:29 Page:29   

   2114  0 000120   200013 471500                    LDP1    REQ$,,AUTO
         0 000121   200011 236100                    LDQ     MDCTX,,AUTO
         0 000122   000025 736000                    QLS     21
         0 000123   100001 676100                    ERQ     1,,PR1
         0 000124   777770 376003                    ANQ     -8,DU
         0 000125   100001 656100                    ERSQ    1,,PR1

      176     2115    5                           REQ.DCT$     = MDCT$ ;

   2115  0 000126   200010 236100                    LDQ     MDCT$,,AUTO
         0 000127   200013 471500                    LDP1    REQ$,,AUTO
         0 000130   100002 756100                    STQ     2,,PR1

      177     2116    5                           CALL NIO$DCWBLD ( REQ ) ;

   2116  0 000131   200013 630500                    EPPR0   REQ$,,AUTO
         0 000132   000017 631400 xsym               EPPR1   B_VECTNIL+15
         0 000133   000000 701000 xent               TSX1    NIO$DCWBLD
         0 000134   000000 011000                    NOP     0

      178     2117                                %UNLOCK ( G#=SQH.GATE ) ;

   2118  0 000135   200015 630500                    EPPR0   SQH$,,AUTO
         0 000136   000017 631400 xsym               EPPR1   B_VECTNIL+15
         0 000137   000000 701000 xent               TSX1    HFC$UNLOCK
         0 000140   000000 011000                    NOP     0

      179     2120    5                           GOTO REQSCHED ;

   2120  0 000141   000022 710000 0                  TRA     REQSCHED

      180     2121    5                           END ;
      181     2122    4                       END ;
      182     2123
      183     2124    3                   IF  REQ.FC = %N_RDBIN

PL6.E3A0      #001=NID$DEVSCHED File=NID$DISK.:E05TSI                            WED 07/30/97 03:29 Page:30   
   2124  0 000142   200013 470500                    LDP0    REQ$,,AUTO
         0 000143   000003 236100                    LDQ     3,,PR0
         0 000144   000777 376007                    ANQ     511,DL
         0 000145   000002 116007                    CMPQ    2,DL
         0 000146   000151 600000 0                  TZE     s:2160
         0 000147   000004 116007                    CMPQ    4,DL
         0 000150   000152 601000 0                  TNZ     s:2162

      184     2125    3                   OR  REQ.FC = %N_RDASC
      185     2126    4                   THEN DO ;

      186     2127        /*N*                Alternating reads on Mirrored Disks not done
      187     2128                            because of errors caused by read done on secondary
      188     2129                            device before preceding write is completed on
      189     2130                            secondary device.
      190     2131
      191     2132                            IF  MDCT.DP.MIRROR.READ
      192     2133                            AND NOT MDCT.DP.MIRROR.LOCK
      193     2134                            THEN DO ;
      194     2135                                IF  DCT.DP.MIRROR.TOGGLE
      195     2136                                THEN
      196     2137                                    DCT.DP.MIRROR.TOGGLE = '0'B ;
      197     2138                                ELSE DO ;
      198     2139                                    DCT.DP.MIRROR.TOGGLE = '1'B ;
      199     2140                                    REQ.DLA.DCTX         = MDCTX ;
      200     2141                                    DCT$                 = MDCT$ ;
      201     2142                                    REQ.DCT$             = DCT$ ;
      202     2143                                    MDCTX                = DCT.DP.MIRROR.DCTX ;
      203     2144                                    MDCT$                = N$DCT$(MDCTX) ;
      204     2145                                    CALL NIO$DCWBLD ( REQ ) ;
      205     2146                                    IF  SQH$ ~= MSQH$
      206     2147                                    THEN DO INHIBIT ;
      207     2148                                        %UNLOCK ( G#=SQH.GATE ) ;
      208     2149                                        %LOCK   ( G#=MSQH.GATE ) ;
      209     2150                                        SQH$    = MSQH$ ;
      210     2151                                        MSQH$   = MDCT.SQH$ ;
      211     2152                                        END ;
PL6.E3A0      #001=NID$DEVSCHED File=NID$DISK.:E05TSI                            WED 07/30/97 03:29 Page:31   
      212     2153                                    END ;
      213     2154                                END ;
      214     2155
      215     2156                            ELSE DO ;
      216     2157                                END ;
      217     2158
      218     2159        *N*/
      219     2160    4                       END ;

   2160  0 000151   000160 710000 0                  TRA     s:2169

      220     2161
      221     2162    3                   ELSE IF  MDCT.DP.MIRROR.WRITE

   2162  0 000152   200010 471500                    LDP1    MDCT$,,AUTO
         0 000153   100036 236100                    LDQ     30,,PR1
         0 000154   200000 316003                    CANQ    65536,DU
         0 000155   000160 600000 0                  TZE     s:2169

      222     2163    3                   THEN
      223     2164    3                       REQ.DOMIR = '1'B ;

   2164  0 000156   400000 236003                    LDQ     -131072,DU
         0 000157   000034 256100                    ORSQ    28,,PR0

      224     2165
      225     2166    3                   END ; /* IF  NOT REQ.BPMIR */

      226     2167
      227     2168    2               END ; /* IF  Mirrored Disk */

      228     2169    1           IF  DCT.DP.MIRROR.FLAG

   2169  0 000160   200005 470500                    LDP0    DCT$,,AUTO
         0 000161   000036 234100                    SZN     30,,PR0
         0 000162   000204 605000 0                  TPL     s:2180
         0 000163   000036 236100                    LDQ     30,,PR0
PL6.E3A0      #001=NID$DEVSCHED File=NID$DISK.:E05TSI                            WED 07/30/97 03:29 Page:32   
         0 000164   040000 316003                    CANQ    16384,DU
         0 000165   000204 600000 0                  TZE     s:2180
         0 000166   200013 471500                    LDP1    REQ$,,AUTO
         0 000167   100027 236100                    LDQ     23,,PR1
         0 000170   000036 676100                    ERQ     30,,PR0
         0 000171   000777 376007                    ANQ     511,DL
         0 000172   000204 600000 0                  TZE     s:2180

      229     2170    1           AND DCT.DP.MIRROR.LOCK
      230     2171    1           AND REQ.USER# ~= DCT.DP.MIRROR.USER#
      231     2172    2           THEN DO ;

      232     2173                    %ENQUEUE ( P#=REQ, Q#=DCT.DP.MIRROR.LQ$ ) ;

   2174  0 000173   200005 236100                    LDQ     DCT$,,AUTO
         0 000174   000042 036003                    ADLQ    34,DU
         0 000175   200013 235100                    LDA     REQ$,,AUTO
         0 000176   200026 757100                    STAQ    NXT$+2,,AUTO
         0 000177   200026 630500                    EPPR0   NXT$+2,,AUTO
         0 000200   000020 631400 xsym               EPPR1   B_VECTNIL+16
         0 000201   000000 701000 xent               TSX1    NIM$ENQUEUE
         0 000202   000000 011000                    NOP     0

      233     2176    2               GOTO PMNBUSY ;

   2176  0 000203   000362 710000 0                  TRA     PMNBUSY

      234     2177    2               END ;
      235     2178
      236     2179
      237     2180    1           GOTO REQSCHEDL ;

   2180  0 000204   000221 710000 0                  TRA     REQSCHEDL

      238     2181
      239     2182        /*
      240     2183           ENQUEUE REQUEST ON APPROPRIATE QUEUE
PL6.E3A0      #001=NID$DEVSCHED File=NID$DISK.:E05TSI                            WED 07/30/97 03:29 Page:33   
      241     2184        */
      242     2185
      243     2186    1   NID$REQSCHEDL:  ENTRY ( PAR ) ;

   2186  0 000205   000000 700200 xent  NID$REQSCHE* TSX0  ! X66_AUTO_2
         0 000206   000030 000002                    ZERO    24,2

      244     2187    1           REQ$         = ADDR(PAR) ;

   2187  0 000207   200003 236100                    LDQ     @PAR,,AUTO
         0 000210   200013 756100                    STQ     REQ$,,AUTO

      245     2188    1           DCT$         = REQ.DCT$ ;

   2188  0 000211   200013 470500                    LDP0    REQ$,,AUTO
         0 000212   000002 236100                    LDQ     2,,PR0
         0 000213   200005 756100                    STQ     DCT$,,AUTO

      246     2189    1           SQH$         = DCT.SQH$ ;

   2189  0 000214   200005 471500                    LDP1    DCT$,,AUTO
         0 000215   100022 236100                    LDQ     18,,PR1
         0 000216   200015 756100                    STQ     SQH$,,AUTO

      247     2190    1           REQSCHEDONLY = '1'B ;

   2190  0 000217   400000 236003                    LDQ     -131072,DU
         0 000220   200014 756100                    STQ     REQSCHEDONLY,,AUTO

      248     2191
      249     2192    1   REQSCHEDL:
      250     2193    1           IF DCT.SQ$ = ADDR(NIL)

   2193  0 000221   200005 470500       REQSCHEDL    LDP0    DCT$,,AUTO
         0 000222   000001 236100                    LDQ     1,,PR0
         0 000223   000001 116000 xsym               CMPQ    B_VECTNIL+1
         0 000224   000241 601000 0                  TNZ     s:2202
PL6.E3A0      #001=NID$DEVSCHED File=NID$DISK.:E05TSI                            WED 07/30/97 03:29 Page:34   

      251     2194    2           THEN DO ;

      252     2195    2              REQ.FL$=REQ$;

   2195  0 000225   200013 236100                    LDQ     REQ$,,AUTO
         0 000226   200013 471500                    LDP1    REQ$,,AUTO
         0 000227   100000 756100                    STQ     0,,PR1

      253     2196    2              DCT.SQ$=REQ$;

   2196  0 000230   200013 236100                    LDQ     REQ$,,AUTO
         0 000231   200005 470500                    LDP0    DCT$,,AUTO
         0 000232   000001 756100                    STQ     1,,PR0

      254     2197    2              DCT.DP.LEAPERS=0;

   2197  0 000233   200005 470500                    LDP0    DCT$,,AUTO
         0 000234   000035 450100                    STZ     29,,PR0

      255     2198    2              DCT.DP.SWP='0'B;

   2198  0 000235   000031 236000 xsym               LDQ     B_VECTNIL+25
         0 000236   000031 356100                    ANSQ    25,,PR0

      256     2199    2              DCT.DP.CSEEK=0;

   2199  0 000237   000033 450100                    STZ     27,,PR0

      257     2200    2              END;

   2200  0 000240   000324 710000 0                  TRA     s:2221

      258     2201    2           ELSE DO;

      259     2202    3              IF DCT.DP.SWP THEN DO;       /* GOING DOWN */

PL6.E3A0      #001=NID$DEVSCHED File=NID$DISK.:E05TSI                            WED 07/30/97 03:29 Page:35   
   2202  0 000241   000031 234100                    SZN     25,,PR0
         0 000242   000274 605000 0                  TPL     s:2212

      260     2203    3                 IF BITBIN(REQ.DLA)>DCT.DP.CSEEK OR

   2203  0 000243   200013 471500                    LDP1    REQ$,,AUTO
         0 000244   000033 236100                    LDQ     27,,PR0
         0 000245   100001 116100                    CMPQ    1,,PR1
         0 000246   000255 602000 0                  TNC     s:2205
         0 000247   000030 236100                    LDQ     24,,PR0
         0 000250   000001 116000 xsym               CMPQ    B_VECTNIL+1
         0 000251   000263 600000 0                  TZE     s:2207
         0 000252   000000 236000 xsym               LDQ     NI_IOLEAPERS
         0 000253   000035 116100                    CMPQ    29,,PR0
         0 000254   000263 603000 0                  TRC     s:2207

      261     2204    3                   (DCT.DP.BQ$~=ADDR(NIL) AND DCT.DP.LEAPERS>NI_IOLEAPERS) THEN
      262     2205    3                    CALL ENQUP(DCT.DP.BQ$);

   2205  0 000255   200005 236100                    LDQ     DCT$,,AUTO
         0 000256   000030 036003                    ADLQ    24,DU
         0 000257   200021 756100                    STQ     SVDCT$+3,,AUTO
         0 000260   001106 701000 0                  TSX1    ENQUP
         0 000261   000000 011000                    NOP     0
         0 000262   000324 710000 0                  TRA     s:2221

      263     2206    4                 ELSE DO;

      264     2207    4                    DCT.DP.LEAPERS=DCT.DP.LEAPERS+1;

   2207  0 000263   000035 235100                    LDA     29,,PR0
         0 000264   000001 035007                    ADLA    1,DL
         0 000265   000035 755100                    STA     29,,PR0

      265     2208    4                    CALL ENQDOWN(DCT.SQ$);

   2208  0 000266   200005 236100                    LDQ     DCT$,,AUTO
PL6.E3A0      #001=NID$DEVSCHED File=NID$DISK.:E05TSI                            WED 07/30/97 03:29 Page:36   
         0 000267   000001 036003                    ADLQ    1,DU
         0 000270   200021 756100                    STQ     SVDCT$+3,,AUTO
         0 000271   001152 701000 0                  TSX1    ENQDOWN
         0 000272   000000 011000                    NOP     0

      266     2209    4                    END;

      267     2210    3                 END;

   2210  0 000273   000324 710000 0                  TRA     s:2221

      268     2211    3              ELSE DO;                     /* GOING UP */

      269     2212    3                 IF BITBIN(REQ.DLA)<DCT.DP.CSEEK OR

   2212  0 000274   200013 471500                    LDP1    REQ$,,AUTO
         0 000275   100001 236100                    LDQ     1,,PR1
         0 000276   000033 116100                    CMPQ    27,,PR0
         0 000277   000306 602000 0                  TNC     s:2214
         0 000300   000030 236100                    LDQ     24,,PR0
         0 000301   000001 116000 xsym               CMPQ    B_VECTNIL+1
         0 000302   000314 600000 0                  TZE     s:2216
         0 000303   000000 236000 xsym               LDQ     NI_IOLEAPERS
         0 000304   000035 116100                    CMPQ    29,,PR0
         0 000305   000314 603000 0                  TRC     s:2216

      270     2213    3                   (DCT.DP.BQ$~=ADDR(NIL) AND DCT.DP.LEAPERS>NI_IOLEAPERS) THEN
      271     2214    3                    CALL ENQDOWN(DCT.DP.BQ$);

   2214  0 000306   200005 236100                    LDQ     DCT$,,AUTO
         0 000307   000030 036003                    ADLQ    24,DU
         0 000310   200021 756100                    STQ     SVDCT$+3,,AUTO
         0 000311   001152 701000 0                  TSX1    ENQDOWN
         0 000312   000000 011000                    NOP     0
         0 000313   000324 710000 0                  TRA     s:2221

      272     2215    4                 ELSE DO;
PL6.E3A0      #001=NID$DEVSCHED File=NID$DISK.:E05TSI                            WED 07/30/97 03:29 Page:37   

      273     2216    4                    DCT.DP.LEAPERS=DCT.DP.LEAPERS+1;

   2216  0 000314   000035 235100                    LDA     29,,PR0
         0 000315   000001 035007                    ADLA    1,DL
         0 000316   000035 755100                    STA     29,,PR0

      274     2217    4                    CALL ENQUP(DCT.SQ$);

   2217  0 000317   200005 236100                    LDQ     DCT$,,AUTO
         0 000320   000001 036003                    ADLQ    1,DU
         0 000321   200021 756100                    STQ     SVDCT$+3,,AUTO
         0 000322   001106 701000 0                  TSX1    ENQUP
         0 000323   000000 011000                    NOP     0

      275     2218    4                    END;

      276     2219    3                 END;

      277     2220    2              END;

      278     2221    1           IF  REQSCHEDONLY

   2221  0 000324   200014 234100                    SZN     REQSCHEDONLY,,AUTO
         0 000325   000362 605000 0                  TPL     PMNBUSY

      279     2222    2           THEN DO ;

      280     2223    2               IF  DCT.STATE = %IDLE

   2223  0 000326   200005 470500                    LDP0    DCT$,,AUTO
         0 000327   000007 236100                    LDQ     7,,PR0
         0 000330   000077 316007                    CANQ    63,DL
         0 000331   000361 601000 0                  TNZ     s:2232
         0 000332   000001 236100                    LDQ     1,,PR0
         0 000333   000001 116000 xsym               CMPQ    B_VECTNIL+1
         0 000334   000361 600000 0                  TZE     s:2232
PL6.E3A0      #001=NID$DEVSCHED File=NID$DISK.:E05TSI                            WED 07/30/97 03:29 Page:38   

      281     2224    2               AND DCT.SQ$ ~= ADDR(NIL)
      282     2225    3               THEN DO ;

      283     2226                        %ENQUEUE ( P#=DCT, Q#=SQH.AQ$ ) ;

   2227  0 000335   200015 236100                    LDQ     SQH$,,AUTO
         0 000336   000003 036003                    ADLQ    3,DU
         0 000337   200005 235100                    LDA     DCT$,,AUTO
         0 000340   200026 757100                    STAQ    NXT$+2,,AUTO
         0 000341   200026 630500                    EPPR0   NXT$+2,,AUTO
         0 000342   000020 631400 xsym               EPPR1   B_VECTNIL+16
         0 000343   000000 701000 xent               TSX1    NIM$ENQUEUE
         0 000344   000000 011000                    NOP     0

      284     2229    3                   DCT.STATE = %REQUESTED ;

   2229  0 000345   200005 470500                    LDP0    DCT$,,AUTO
         0 000346   000001 236007                    LDQ     1,DL
         0 000347   000007 752101                    STCQ    7,'01'O,PR0

      285     2230    3                   CALL PMN$COLLECT ( DCT.PM, %PM_WAIT ) ;

   2230  0 000350   000002 236000 1                  LDQ     2
         0 000351   200027 756100                    STQ     NXT$+3,,AUTO
         0 000352   200005 236100                    LDQ     DCT$,,AUTO
         0 000353   000010 036003                    ADLQ    8,DU
         0 000354   200026 756100                    STQ     NXT$+2,,AUTO
         0 000355   200026 630500                    EPPR0   NXT$+2,,AUTO
         0 000356   000020 631400 xsym               EPPR1   B_VECTNIL+16
         0 000357   000000 701000 xent               TSX1    PMN$COLLECT
         0 000360   000000 011000                    NOP     0

      286     2231    3                   END ;

      287     2232    2               RETURN ;

PL6.E3A0      #001=NID$DEVSCHED File=NID$DISK.:E05TSI                            WED 07/30/97 03:29 Page:39   
   2232  0 000361   000000 702200 xent               TSX2  ! X66_ARET

      288     2233    2               END ;
      289     2234
      290     2235    1   PMNBUSY:
      291     2236    1           IF  DCT.PM.MODE = %PM_BUSY

   2236  0 000362   200005 470500       PMNBUSY      LDP0    DCT$,,AUTO
         0 000363   000010 235100                    LDA     8,,PR0
         0 000364   000002 115007                    CMPA    2,DL
         0 000365   000377 601000 0                  TNZ     s:2240

      292     2237    1           THEN
      293     2238    1               CALL PMN$COLLECT ( DCT.PM, %PM_QUED ) ;

   2238  0 000366   000003 236000 1                  LDQ     3
         0 000367   200027 756100                    STQ     NXT$+3,,AUTO
         0 000370   200005 236100                    LDQ     DCT$,,AUTO
         0 000371   000010 036003                    ADLQ    8,DU
         0 000372   200026 756100                    STQ     NXT$+2,,AUTO
         0 000373   200026 630500                    EPPR0   NXT$+2,,AUTO
         0 000374   000020 631400 xsym               EPPR1   B_VECTNIL+16
         0 000375   000000 701000 xent               TSX1    PMN$COLLECT
         0 000376   000000 011000                    NOP     0

      294     2239
      295     2240    1           GOTO DEVSCHED ;

   2240  0 000377   000412 710000 0                  TRA     DEVSCHED

      296     2241        %EJECT;
PL6.E3A0      #001=NID$DEVSCHED File=NID$DISK.:E05TSI                            WED 07/30/97 03:29 Page:40   
      297     2242    1   NID$DEVSCHEDL: ENTRY(PAR,NEWSTATE);

   2242  0 000400   000000 700200 xent  NID$DEVSCHE* TSX0  ! X66_AUTO_2
         0 000401   000030 000002                    ZERO    24,2

      298     2243    1           DCT$=ADDR(PAR);

   2243  0 000402   200003 236100                    LDQ     @PAR,,AUTO
         0 000403   200005 756100                    STQ     DCT$,,AUTO

      299     2244    1           SQH$=DCT.SQH$;

   2244  0 000404   200005 470500                    LDP0    DCT$,,AUTO
         0 000405   000022 236100                    LDQ     18,,PR0
         0 000406   200015 756100                    STQ     SQH$,,AUTO

      300     2245    1           DCT.STATE=NEWSTATE;

   2245  0 000407   200004 471500                    LDP1    @NEWSTATE,,AUTO
         0 000410   100000 236100                    LDQ     0,,PR1
         0 000411   000007 752101                    STCQ    7,'01'O,PR0

      301     2246    1   DEVSCHED:
      302     2247    2           IF DCT.STATE=%IDLE THEN DO;

   2247  0 000412   200005 470500       DEVSCHED     LDP0    DCT$,,AUTO
         0 000413   000007 236100                    LDQ     7,,PR0
         0 000414   000077 316007                    CANQ    63,DL
         0 000415   000464 601000 0                  TNZ     s:2260

      303     2248    3              IF DCT.SQ$~=ADDR(NIL) THEN DO;

   2248  0 000416   000001 236100                    LDQ     1,,PR0
         0 000417   000001 116000 xsym               CMPQ    B_VECTNIL+1
         0 000420   000446 600000 0                  TZE     s:2256

      304     2249                      %ENQUEUE (P#=DCT,Q#=SQH.AQ$);
PL6.E3A0      #001=NID$DEVSCHED File=NID$DISK.:E05TSI                            WED 07/30/97 03:29 Page:41   

   2250  0 000421   200015 236100                    LDQ     SQH$,,AUTO
         0 000422   000003 036003                    ADLQ    3,DU
         0 000423   200005 235100                    LDA     DCT$,,AUTO
         0 000424   200026 757100                    STAQ    NXT$+2,,AUTO
         0 000425   200026 630500                    EPPR0   NXT$+2,,AUTO
         0 000426   000020 631400 xsym               EPPR1   B_VECTNIL+16
         0 000427   000000 701000 xent               TSX1    NIM$ENQUEUE
         0 000430   000000 011000                    NOP     0

      305     2252    3                 DCT.STATE=%REQUESTED;

   2252  0 000431   200005 470500                    LDP0    DCT$,,AUTO
         0 000432   000001 236007                    LDQ     1,DL
         0 000433   000007 752101                    STCQ    7,'01'O,PR0

      306     2253    3                 CALL PMN$COLLECT(DCT.PM,%PM_WAIT);

   2253  0 000434   000002 236000 1                  LDQ     2
         0 000435   200027 756100                    STQ     NXT$+3,,AUTO
         0 000436   200005 236100                    LDQ     DCT$,,AUTO
         0 000437   000010 036003                    ADLQ    8,DU
         0 000440   200026 756100                    STQ     NXT$+2,,AUTO
         0 000441   200026 630500                    EPPR0   NXT$+2,,AUTO
         0 000442   000020 631400 xsym               EPPR1   B_VECTNIL+16
         0 000443   000000 701000 xent               TSX1    PMN$COLLECT
         0 000444   000000 011000                    NOP     0

      307     2254    3                 END;

   2254  0 000445   000464 710000 0                  TRA     s:2260

      308     2255    3              ELSE DO;

      309     2256    3                 IF DCT.TYPE=%DV_DP THEN DCT.DP.CSEEK=0;

   2256  0 000446   000007 236100                    LDQ     7,,PR0
PL6.E3A0      #001=NID$DEVSCHED File=NID$DISK.:E05TSI                            WED 07/30/97 03:29 Page:42   
         0 000447   007700 376007                    ANQ     4032,DL
         0 000450   000600 116007                    CMPQ    384,DL
         0 000451   000453 601000 0                  TNZ     s:2257

   2256  0 000452   000033 450100                    STZ     27,,PR0

      310     2257    3                 CALL PMN$COLLECT(DCT.PM,%PM_IDLE);

   2257  0 000453   000004 236000 1                  LDQ     4
         0 000454   200027 756100                    STQ     NXT$+3,,AUTO
         0 000455   200005 236100                    LDQ     DCT$,,AUTO
         0 000456   000010 036003                    ADLQ    8,DU
         0 000457   200026 756100                    STQ     NXT$+2,,AUTO
         0 000460   200026 630500                    EPPR0   NXT$+2,,AUTO
         0 000461   000020 631400 xsym               EPPR1   B_VECTNIL+16
         0 000462   000000 701000 xent               TSX1    PMN$COLLECT
         0 000463   000000 011000                    NOP     0

      311     2258    3                 END;

      312     2259    2              END;

      313     2260    1           GOTO SCANAQ;

   2260  0 000464   000475 710000 0                  TRA     SCANAQ

      314     2261        %EJECT ;
PL6.E3A0      #001=NID$DEVSCHED File=NID$DISK.:E05TSI                            WED 07/30/97 03:29 Page:43   
      315     2262        /*D* NAME:          NID$SCANAQ
      316     2263
      317     2264             CALL:          CALL NID$SCANAQ(SQH);
      318     2265                            where:
      319     2266                                  SQH is the subsytem to be scanned.
      320     2267
      321     2268             ENVIRONMENT:   Monitor, not privileged, not inhibited
      322     2269
      323     2270             INPUT:         Disk I/O Tables
      324     2271
      325     2272             DESCRIPTION:   NID$SCANAQ scans all the requests on the subsystem
      326     2273                            assign queue to find any that can be started.
      327     2274                            After the scan is completed, SQH.GATE is unlocked.
      328     2275                                                                           */
      329     2276    1   NID$SCANAQ: ENTRY(PAR);

   2276  0 000465   000000 700200 xent  NID$SCANAQ   TSX0  ! X66_AUTO_2
         0 000466   000030 000002                    ZERO    24,2

      330     2277    1           SQH$=ADDR(PAR);

   2277  0 000467   200003 236100                    LDQ     @PAR,,AUTO
         0 000470   200015 756100                    STQ     SQH$,,AUTO

      331     2278                %LOCK (G#=SQH.GATE);

   2279  0 000471   200015 630500                    EPPR0   SQH$,,AUTO
         0 000472   000017 631400 xsym               EPPR1   B_VECTNIL+15
         0 000473   000000 701000 xent               TSX1    HFC$LOCK
         0 000474   000000 011000                    NOP     0

      332     2281    1   SCANAQ:
      333     2282    1           SVDCT$=ADDR(NIL);

   2282  0 000475   000001 236000 xsym  SCANAQ       LDQ     B_VECTNIL+1
         0 000476   200016 756100                    STQ     SVDCT$,,AUTO

PL6.E3A0      #001=NID$DEVSCHED File=NID$DISK.:E05TSI                            WED 07/30/97 03:29 Page:44   
      334     2283    2           DO WHILE(SQH.AQ$~=ADDR(NIL));

   2283  0 000477   001073 710000 0                  TRA     s:2382

      335     2284                   %DEQUEUE(P#=DCT$,Q#=SQH.AQ$);

   2288  0 000500   200015 236100                    LDQ     SQH$,,AUTO
         0 000501   000003 036003                    ADLQ    3,DU
         0 000502   200027 756100                    STQ     NXT$+3,,AUTO
         0 000503   200005 630500                    EPPR0   DCT$,,AUTO
         0 000504   200026 450500                    STP0    NXT$+2,,AUTO
         0 000505   200026 630500                    EPPR0   NXT$+2,,AUTO
         0 000506   000020 631400 xsym               EPPR1   B_VECTNIL+16
         0 000507   000000 701000 xent               TSX1    NIM$DEQUEUE
         0 000510   000000 011000                    NOP     0

      336     2291    2              DVT$=DCT.DVT$;

   2291  0 000511   200005 470500                    LDP0    DCT$,,AUTO
         0 000512   000024 236100                    LDQ     20,,PR0
         0 000513   200007 756100                    STQ     DVT$,,AUTO

      337     2292    2              REQ$=DCT.SQ$->REQ.FL$;

   2292  0 000514   000001 471500                    LDP1    1,,PR0
         0 000515   100000 236100                    LDQ     0,,PR1
         0 000516   200013 756100                    STQ     REQ$,,AUTO

      338     2293    3              IF REQ.DQH$=ADDR(NIL) THEN DO; /* REGULAR REQUEST */

   2293  0 000517   200013 471500                    LDP1    REQ$,,AUTO
         0 000520   100020 236100                    LDQ     16,,PR1
         0 000521   000001 116000 xsym               CMPQ    B_VECTNIL+1
         0 000522   000661 601000 0                  TNZ     s:2333

      339     2294    4                 IF SQH.CQ$=ADDR(NIL) THEN DO;

PL6.E3A0      #001=NID$DEVSCHED File=NID$DISK.:E05TSI                            WED 07/30/97 03:29 Page:45   
   2294  0 000523   200015 473500                    LDP3    SQH$,,AUTO
         0 000524   300004 236100                    LDQ     4,,PR3
         0 000525   000001 116000 xsym               CMPQ    B_VECTNIL+1
         0 000526   000540 601000 0                  TNZ     s:2304

      340     2295                         %ENQUEUE(P#=DCT,Q#=SVDCT$);

   2296  0 000527   200016 634500                    EPPR4   SVDCT$,,AUTO
         0 000530   200027 454500                    STP4    NXT$+3,,AUTO
         0 000531   200005 236100                    LDQ     DCT$,,AUTO
         0 000532   200026 756100                    STQ     NXT$+2,,AUTO
         0 000533   200026 630500                    EPPR0   NXT$+2,,AUTO
         0 000534   000020 631400 xsym               EPPR1   B_VECTNIL+16
         0 000535   000000 701000 xent               TSX1    NIM$ENQUEUE
         0 000536   000000 011000                    NOP     0

      341     2298    4                    END;

   2298  0 000537   001073 710000 0                  TRA     s:2382

      342     2299    4                 ELSE DO;

      343     2300                         %DEQUEUE(P#=DQH$,Q#=SQH.CQ$);

   2304  0 000540   200015 236100                    LDQ     SQH$,,AUTO
         0 000541   000004 036003                    ADLQ    4,DU
         0 000542   200027 756100                    STQ     NXT$+3,,AUTO
         0 000543   200006 634500                    EPPR4   DQH$,,AUTO
         0 000544   200026 454500                    STP4    NXT$+2,,AUTO
         0 000545   200026 630500                    EPPR0   NXT$+2,,AUTO
         0 000546   000020 631400 xsym               EPPR1   B_VECTNIL+16
         0 000547   000000 701000 xent               TSX1    NIM$DEQUEUE
         0 000550   000000 011000                    NOP     0

      344     2307                         %DEQUEUE(P#=REQ$,Q#=DCT.SQ$);

   2311  0 000551   200005 236100                    LDQ     DCT$,,AUTO
PL6.E3A0      #001=NID$DEVSCHED File=NID$DISK.:E05TSI                            WED 07/30/97 03:29 Page:46   
         0 000552   000001 036003                    ADLQ    1,DU
         0 000553   200027 756100                    STQ     NXT$+3,,AUTO
         0 000554   200013 630500                    EPPR0   REQ$,,AUTO
         0 000555   200026 450500                    STP0    NXT$+2,,AUTO
         0 000556   200026 630500                    EPPR0   NXT$+2,,AUTO
         0 000557   000020 631400 xsym               EPPR1   B_VECTNIL+16
         0 000560   000000 701000 xent               TSX1    NIM$DEQUEUE
         0 000561   000000 011000                    NOP     0

      345     2314    4                    DQH.IO$=REQ$;

   2314  0 000562   200013 236100                    LDQ     REQ$,,AUTO
         0 000563   200006 470500                    LDP0    DQH$,,AUTO
         0 000564   000014 756100                    STQ     12,,PR0

      346     2315    4                    DCT.DQH$=DQH$;

   2315  0 000565   200006 236100                    LDQ     DQH$,,AUTO
         0 000566   200005 471500                    LDP1    DCT$,,AUTO
         0 000567   100023 756100                    STQ     19,,PR1

      347     2316    4                    DCT.STATE=%BUSY;

   2316  0 000570   000005 236007                    LDQ     5,DL
         0 000571   100007 752101                    STCQ    7,'01'O,PR1

      348     2317    4                    DCT.DP.CSEEK=BITBIN(REQ.DLA);

   2317  0 000572   200013 473500                    LDP3    REQ$,,AUTO
         0 000573   300001 235100                    LDA     1,,PR3
         0 000574   100033 755100                    STA     27,,PR1

      349     2318    5                    IF DCT.SQ$=ADDR(NIL) THEN DO;

   2318  0 000575   100001 236100                    LDQ     1,,PR1
         0 000576   000001 116000 xsym               CMPQ    B_VECTNIL+1
         0 000577   000643 601000 0                  TNZ     s:2328
PL6.E3A0      #001=NID$DEVSCHED File=NID$DISK.:E05TSI                            WED 07/30/97 03:29 Page:47   

      350     2319    5                       DCT.SQ$=DCT.DP.BQ$;

   2319  0 000600   100030 236100                    LDQ     24,,PR1
         0 000601   100001 756100                    STQ     1,,PR1

      351     2320    5                       DCT.DP.BQ$=ADDR(NIL);

   2320  0 000602   000001 236000 xsym               LDQ     B_VECTNIL+1
         0 000603   200005 470500                    LDP0    DCT$,,AUTO
         0 000604   000030 756100                    STQ     24,,PR0

      352     2321    5                       DCT.DP.LEAPERS=0;

   2321  0 000605   000035 450100                    STZ     29,,PR0

      353     2322    5                       DCT.DP.SWP=~DCT.DP.SWP;

   2322  0 000606   000031 236100                    LDQ     25,,PR0
         0 000607   400000 376003                    ANQ     -131072,DU
         0 000610   400000 676003                    ERQ     -131072,DU
         0 000611   000031 676100                    ERQ     25,,PR0
         0 000612   400000 376003                    ANQ     -131072,DU
         0 000613   000031 656100                    ERSQ    25,,PR0

      354     2323    5                       IF DCT.SQ$=ADDR(NIL) THEN

   2323  0 000614   000001 236100                    LDQ     1,,PR0
         0 000615   000001 116000 xsym               CMPQ    B_VECTNIL+1
         0 000616   000631 601000 0                  TNZ     s:2326

      355     2324    5                          CALL PMN$COLLECT(DCT.PM,%PM_BUSY);

   2324  0 000617   000005 236000 1                  LDQ     5
         0 000620   200027 756100                    STQ     NXT$+3,,AUTO
         0 000621   200005 236100                    LDQ     DCT$,,AUTO
         0 000622   000010 036003                    ADLQ    8,DU
PL6.E3A0      #001=NID$DEVSCHED File=NID$DISK.:E05TSI                            WED 07/30/97 03:29 Page:48   
         0 000623   200026 756100                    STQ     NXT$+2,,AUTO
         0 000624   200026 630500                    EPPR0   NXT$+2,,AUTO
         0 000625   000020 631400 xsym               EPPR1   B_VECTNIL+16
         0 000626   000000 701000 xent               TSX1    PMN$COLLECT
         0 000627   000000 011000                    NOP     0
         0 000630   000654 710000 0                  TRA     s:2329

      356     2325    5                       ELSE
      357     2326    5                          CALL PMN$COLLECT(DCT.PM,%PM_QUED);

   2326  0 000631   000003 236000 1                  LDQ     3
         0 000632   200027 756100                    STQ     NXT$+3,,AUTO
         0 000633   200005 236100                    LDQ     DCT$,,AUTO
         0 000634   000010 036003                    ADLQ    8,DU
         0 000635   200026 756100                    STQ     NXT$+2,,AUTO
         0 000636   200026 630500                    EPPR0   NXT$+2,,AUTO
         0 000637   000020 631400 xsym               EPPR1   B_VECTNIL+16
         0 000640   000000 701000 xent               TSX1    PMN$COLLECT
         0 000641   000000 011000                    NOP     0

      358     2327    5                       END;

   2327  0 000642   000654 710000 0                  TRA     s:2329

      359     2328    4                    ELSE CALL PMN$COLLECT(DCT.PM,%PM_QUED);

   2328  0 000643   000003 236000 1                  LDQ     3
         0 000644   200027 756100                    STQ     NXT$+3,,AUTO
         0 000645   200005 236100                    LDQ     DCT$,,AUTO
         0 000646   000010 036003                    ADLQ    8,DU
         0 000647   200026 756100                    STQ     NXT$+2,,AUTO
         0 000650   200026 630500                    EPPR0   NXT$+2,,AUTO
         0 000651   000020 631400 xsym               EPPR1   B_VECTNIL+16
         0 000652   000000 701000 xent               TSX1    PMN$COLLECT
         0 000653   000000 011000                    NOP     0

      360     2329    4                    CALL NIS$DRIVER(DQH);
PL6.E3A0      #001=NID$DEVSCHED File=NID$DISK.:E05TSI                            WED 07/30/97 03:29 Page:49   

   2329  0 000654   200006 630500                    EPPR0   DQH$,,AUTO
         0 000655   000017 631400 xsym               EPPR1   B_VECTNIL+15
         0 000656   000000 701000 xent               TSX1    NIS$DRIVER
         0 000657   000000 011000                    NOP     0

      361     2330    4                    END;

      362     2331    3                 END;

   2331  0 000660   001073 710000 0                  TRA     s:2382

      363     2332    3              ELSE DO;                     /* SPECIAL REQUESTS */

      364     2333    3                 DQH$=REQ.DQH$;

   2333  0 000661   200006 756100                    STQ     DQH$,,AUTO

      365     2334    3                 IF DQH.STATE~=%IDLE OR

   2334  0 000662   200006 473500                    LDP3    DQH$,,AUTO
         0 000663   300001 236100                    LDQ     1,,PR3
         0 000664   000077 316007                    CANQ    63,DL
         0 000665   000675 601000 0                  TNZ     s:2337
         0 000666   100004 236100                    LDQ     4,,PR1
         0 000667   001000 316007                    CANQ    512,DL
         0 000670   000706 600000 0                  TZE     s:2341
         0 000671   300015 474500                    LDP4    13,,PR3
         0 000672   400006 236100                    LDQ     6,,PR4
         0 000673   001000 316007                    CANQ    512,DL
         0 000674   000706 601000 0                  TNZ     s:2341

      366     2335    4                   (REQ.IOFLG.STOPMPC AND NOT DQH.MPC$->DCT.DFLG.MPCSTOP) THEN DO;

      367     2336                         %ENQUEUE(P#=DCT,Q#=SVDCT$);

   2337  0 000675   200016 634500                    EPPR4   SVDCT$,,AUTO
PL6.E3A0      #001=NID$DEVSCHED File=NID$DISK.:E05TSI                            WED 07/30/97 03:29 Page:50   
         0 000676   200027 454500                    STP4    NXT$+3,,AUTO
         0 000677   200005 236100                    LDQ     DCT$,,AUTO
         0 000700   200026 756100                    STQ     NXT$+2,,AUTO
         0 000701   200026 630500                    EPPR0   NXT$+2,,AUTO
         0 000702   000020 631400 xsym               EPPR1   B_VECTNIL+16
         0 000703   000000 701000 xent               TSX1    NIM$ENQUEUE
         0 000704   000000 011000                    NOP     0

      368     2339    4                    END;

   2339  0 000705   001073 710000 0                  TRA     s:2382

      369     2340    4                 ELSE DO;

      370     2341    5                    IF DQH.FL$~=ADDR(NIL) THEN DO;

   2341  0 000706   300000 236100                    LDQ     0,,PR3
         0 000707   000001 116000 xsym               CMPQ    B_VECTNIL+1
         0 000710   000737 600000 0                  TZE     s:2357

      371     2342    6                       DO WHILE(SQH.CQ$->DQH.FL$~=DQH$);

   2342  0 000711   200015 474500                    LDP4    SQH$,,AUTO
         0 000712   400004 475500                    LDP5    4,,PR4
         0 000713   500000 236100                    LDQ     0,,PR5
         0 000714   200006 116100                    CMPQ    DQH$,,AUTO
         0 000715   000726 600000 0                  TZE     s:2349

      372     2343    6                          SQH.CQ$=SQH.CQ$->DQH.FL$;

   2343  0 000716   200015 470500                    LDP0    SQH$,,AUTO
         0 000717   000004 471500                    LDP1    4,,PR0
         0 000720   100000 236100                    LDQ     0,,PR1
         0 000721   000004 756100                    STQ     4,,PR0

      373     2344    6                          END;

PL6.E3A0      #001=NID$DEVSCHED File=NID$DISK.:E05TSI                            WED 07/30/97 03:29 Page:51   
   2344  0 000722   000004 471500                    LDP1    4,,PR0
         0 000723   100000 236100                    LDQ     0,,PR1
         0 000724   200006 116100                    CMPQ    DQH$,,AUTO
         0 000725   000716 601000 0                  TNZ     s:2343

      374     2345                            %DEQUEUE(P#=DQH$,Q#=SQH.CQ$);

   2349  0 000726   200015 236100                    LDQ     SQH$,,AUTO
         0 000727   000004 036003                    ADLQ    4,DU
         0 000730   200027 756100                    STQ     NXT$+3,,AUTO
         0 000731   200006 630500                    EPPR0   DQH$,,AUTO
         0 000732   200026 450500                    STP0    NXT$+2,,AUTO
         0 000733   200026 630500                    EPPR0   NXT$+2,,AUTO
         0 000734   000020 631400 xsym               EPPR1   B_VECTNIL+16
         0 000735   000000 701000 xent               TSX1    NIM$DEQUEUE
         0 000736   000000 011000                    NOP     0

      375     2352    5                       END;

      376     2353                         %DEQUEUE(P#=REQ$,Q#=DCT.SQ$);

   2357  0 000737   200005 236100                    LDQ     DCT$,,AUTO
         0 000740   000001 036003                    ADLQ    1,DU
         0 000741   200027 756100                    STQ     NXT$+3,,AUTO
         0 000742   200013 630500                    EPPR0   REQ$,,AUTO
         0 000743   200026 450500                    STP0    NXT$+2,,AUTO
         0 000744   200026 630500                    EPPR0   NXT$+2,,AUTO
         0 000745   000020 631400 xsym               EPPR1   B_VECTNIL+16
         0 000746   000000 701000 xent               TSX1    NIM$DEQUEUE
         0 000747   000000 011000                    NOP     0

      377     2360    4                    DQH.IO$=REQ$;

   2360  0 000750   200013 236100                    LDQ     REQ$,,AUTO
         0 000751   200006 470500                    LDP0    DQH$,,AUTO
         0 000752   000014 756100                    STQ     12,,PR0

PL6.E3A0      #001=NID$DEVSCHED File=NID$DISK.:E05TSI                            WED 07/30/97 03:29 Page:52   
      378     2361    4                    IF REQ.IOFLG.SUSP THEN DQH.MPC$->DCT.DFLG.MPCSUSPENDED='1'B;

   2361  0 000753   200013 471500                    LDP1    REQ$,,AUTO
         0 000754   100004 236100                    LDQ     4,,PR1
         0 000755   004000 316007                    CANQ    2048,DL
         0 000756   000762 600000 0                  TZE     s:2362

   2361  0 000757   000015 473500                    LDP3    13,,PR0
         0 000760   002000 236007                    LDQ     1024,DL
         0 000761   300006 256100                    ORSQ    6,,PR3

      379     2362    4                    DCT.DQH$=DQH$;

   2362  0 000762   200006 236100                    LDQ     DQH$,,AUTO
         0 000763   200005 470500                    LDP0    DCT$,,AUTO
         0 000764   000023 756100                    STQ     19,,PR0

      380     2363    4                    DCT.STATE=%BUSY;

   2363  0 000765   000005 236007                    LDQ     5,DL
         0 000766   000007 752101                    STCQ    7,'01'O,PR0

      381     2364    5                    IF DCT.TYPE=%DV_DP THEN DO;

   2364  0 000767   000007 236100                    LDQ     7,,PR0
         0 000770   007700 376007                    ANQ     4032,DL
         0 000771   000600 116007                    CMPQ    384,DL
         0 000772   001056 601000 0                  TNZ     s:2378

      382     2365    5                       DCT.DP.CSEEK=BITBIN(REQ.DLA);

   2365  0 000773   200013 471500                    LDP1    REQ$,,AUTO
         0 000774   100001 235100                    LDA     1,,PR1
         0 000775   000033 755100                    STA     27,,PR0

      383     2366    6                       IF DCT.SQ$=ADDR(NIL) THEN DO;

PL6.E3A0      #001=NID$DEVSCHED File=NID$DISK.:E05TSI                            WED 07/30/97 03:29 Page:53   
   2366  0 000776   000001 236100                    LDQ     1,,PR0
         0 000777   000001 116000 xsym               CMPQ    B_VECTNIL+1
         0 001000   001044 601000 0                  TNZ     s:2376

      384     2367    6                          DCT.SQ$=DCT.DP.BQ$;

   2367  0 001001   000030 236100                    LDQ     24,,PR0
         0 001002   000001 756100                    STQ     1,,PR0

      385     2368    6                          DCT.DP.BQ$=ADDR(NIL);

   2368  0 001003   000001 236000 xsym               LDQ     B_VECTNIL+1
         0 001004   200005 470500                    LDP0    DCT$,,AUTO
         0 001005   000030 756100                    STQ     24,,PR0

      386     2369    6                          DCT.DP.LEAPERS=0;

   2369  0 001006   000035 450100                    STZ     29,,PR0

      387     2370    6                          DCT.DP.SWP=~DCT.DP.SWP;

   2370  0 001007   000031 236100                    LDQ     25,,PR0
         0 001010   400000 376003                    ANQ     -131072,DU
         0 001011   400000 676003                    ERQ     -131072,DU
         0 001012   000031 676100                    ERQ     25,,PR0
         0 001013   400000 376003                    ANQ     -131072,DU
         0 001014   000031 656100                    ERSQ    25,,PR0

      388     2371    6                          IF DCT.SQ$=ADDR(NIL) THEN

   2371  0 001015   000001 236100                    LDQ     1,,PR0
         0 001016   000001 116000 xsym               CMPQ    B_VECTNIL+1
         0 001017   001032 601000 0                  TNZ     s:2374

      389     2372    6                             CALL PMN$COLLECT(DCT.PM,%PM_BUSY);

   2372  0 001020   000005 236000 1                  LDQ     5
PL6.E3A0      #001=NID$DEVSCHED File=NID$DISK.:E05TSI                            WED 07/30/97 03:29 Page:54   
         0 001021   200027 756100                    STQ     NXT$+3,,AUTO
         0 001022   200005 236100                    LDQ     DCT$,,AUTO
         0 001023   000010 036003                    ADLQ    8,DU
         0 001024   200026 756100                    STQ     NXT$+2,,AUTO
         0 001025   200026 630500                    EPPR0   NXT$+2,,AUTO
         0 001026   000020 631400 xsym               EPPR1   B_VECTNIL+16
         0 001027   000000 701000 xent               TSX1    PMN$COLLECT
         0 001030   000000 011000                    NOP     0
         0 001031   001067 710000 0                  TRA     s:2379

      390     2373    6                          ELSE
      391     2374    6                             CALL PMN$COLLECT(DCT.PM,%PM_QUED);

   2374  0 001032   000003 236000 1                  LDQ     3
         0 001033   200027 756100                    STQ     NXT$+3,,AUTO
         0 001034   200005 236100                    LDQ     DCT$,,AUTO
         0 001035   000010 036003                    ADLQ    8,DU
         0 001036   200026 756100                    STQ     NXT$+2,,AUTO
         0 001037   200026 630500                    EPPR0   NXT$+2,,AUTO
         0 001040   000020 631400 xsym               EPPR1   B_VECTNIL+16
         0 001041   000000 701000 xent               TSX1    PMN$COLLECT
         0 001042   000000 011000                    NOP     0

      392     2375    6                          END;

   2375  0 001043   001067 710000 0                  TRA     s:2379

      393     2376    5                       ELSE CALL PMN$COLLECT(DCT.PM,%PM_QUED);

   2376  0 001044   000003 236000 1                  LDQ     3
         0 001045   200027 756100                    STQ     NXT$+3,,AUTO
         0 001046   200005 236100                    LDQ     DCT$,,AUTO
         0 001047   000010 036003                    ADLQ    8,DU
         0 001050   200026 756100                    STQ     NXT$+2,,AUTO
         0 001051   200026 630500                    EPPR0   NXT$+2,,AUTO
         0 001052   000020 631400 xsym               EPPR1   B_VECTNIL+16
         0 001053   000000 701000 xent               TSX1    PMN$COLLECT
PL6.E3A0      #001=NID$DEVSCHED File=NID$DISK.:E05TSI                            WED 07/30/97 03:29 Page:55   
         0 001054   000000 011000                    NOP     0

      394     2377    5                       END;

   2377  0 001055   001067 710000 0                  TRA     s:2379

      395     2378    4                    ELSE CALL PMN$COLLECT(DCT.PM,%PM_BUSY);

   2378  0 001056   000005 236000 1                  LDQ     5
         0 001057   200027 756100                    STQ     NXT$+3,,AUTO
         0 001060   200005 236100                    LDQ     DCT$,,AUTO
         0 001061   000010 036003                    ADLQ    8,DU
         0 001062   200026 756100                    STQ     NXT$+2,,AUTO
         0 001063   200026 630500                    EPPR0   NXT$+2,,AUTO
         0 001064   000020 631400 xsym               EPPR1   B_VECTNIL+16
         0 001065   000000 701000 xent               TSX1    PMN$COLLECT
         0 001066   000000 011000                    NOP     0

      396     2379    4                    CALL NIS$DRIVER(DQH);

   2379  0 001067   200006 630500                    EPPR0   DQH$,,AUTO
         0 001070   000017 631400 xsym               EPPR1   B_VECTNIL+15
         0 001071   000000 701000 xent               TSX1    NIS$DRIVER
         0 001072   000000 011000                    NOP     0

      397     2380    4                    END;

      398     2381    3                 END;

      399     2382    2              END;

   2382  0 001073   200015 470500                    LDP0    SQH$,,AUTO
         0 001074   000003 236100                    LDQ     3,,PR0
         0 001075   000001 116000 xsym               CMPQ    B_VECTNIL+1
         0 001076   000500 601000 0                  TNZ     s:2288

      400     2383    1           SQH.AQ$=SVDCT$;
PL6.E3A0      #001=NID$DEVSCHED File=NID$DISK.:E05TSI                            WED 07/30/97 03:29 Page:56   

   2383  0 001077   200016 236100                    LDQ     SVDCT$,,AUTO
         0 001100   000003 756100                    STQ     3,,PR0

      401     2384                %UNLOCK(G#=SQH.GATE);

   2385  0 001101   200015 630500                    EPPR0   SQH$,,AUTO
         0 001102   000017 631400 xsym               EPPR1   B_VECTNIL+15
         0 001103   000000 701000 xent               TSX1    HFC$UNLOCK
         0 001104   000000 011000                    NOP     0

      402     2387    1           RETURN;

   2387  0 001105   000000 702200 xent               TSX2  ! X66_ARET

      403     2388        %EJECT;
PL6.E3A0      #001=NID$DEVSCHED File=NID$DISK.:E05TSI                            WED 07/30/97 03:29 Page:57   
      404     2389        /* ENQUEUE REQUEST ON APPROPRIATE SCHEDULER QUEUE */
      405     2390        /**/
      406     2391    1   ENQUP:  PROC(Q$);

   2391  0 001106   200020 741300       ENQUP        STX1  ! SVDCT$+2,,AUTO

      407     2392    2   DCL Q$ PTR;
      408     2393        /**/
      409     2394        /* ON ENTRY TO THIS PROCEDURE REQ$ POINTS TO REQUEST TO BE ENQUEUED */
      410     2395        /**/
      411     2396    2   DCL DLA UBIN;
      412     2397    2   DCL FREQ$ PTR;
      413     2398    2   DCL NXT$ PTR;
      414     2399    3           IF Q$=ADDR(NIL) THEN DO;

   2399  0 001107   200021 470500                    LDP0    @Q$,,AUTO
         0 001110   000000 236100                    LDQ     0,,PR0
         0 001111   000001 116000 xsym               CMPQ    B_VECTNIL+1
         0 001112   001122 601000 0                  TNZ     s:2404

      415     2400    3              REQ.FL$=REQ$;

   2400  0 001113   200013 236100                    LDQ     REQ$,,AUTO
         0 001114   200013 471500                    LDP1    REQ$,,AUTO
         0 001115   100000 756100                    STQ     0,,PR1

      416     2401    3              Q$=REQ$;

   2401  0 001116   200013 236100                    LDQ     REQ$,,AUTO
         0 001117   000000 756100                    STQ     0,,PR0

      417     2402    3              RETURN;

   2402  0 001120   200020 221300                    LDX1  ! SVDCT$+2,,AUTO
         0 001121   000001 702211                    TSX2  ! 1,X1

      418     2403    3              END;
PL6.E3A0      #001=NID$DEVSCHED File=NID$DISK.:E05TSI                            WED 07/30/97 03:29 Page:58   
      419     2404    2           DLA=BITBIN(REQ.DLA)+1;

   2404  0 001122   200013 471500                    LDP1    REQ$,,AUTO
         0 001123   100001 235100                    LDA     1,,PR1
         0 001124   000001 035007                    ADLA    1,DL
         0 001125   200022 755100                    STA     DLA,,AUTO

      420     2405    2           FREQ$=ADDR(NIL);

   2405  0 001126   000001 236000 xsym               LDQ     B_VECTNIL+1
         0 001127   200023 756100                    STQ     FREQ$,,AUTO

      421     2406    2           NXT$=Q$->REQ.FL$;

   2406  0 001130   000000 473500                    LDP3    0,,PR0
         0 001131   300000 236100                    LDQ     0,,PR3
         0 001132   200024 756100                    STQ     NXT$,,AUTO

      422     2407    3           DO WHILE(DLA>BITBIN(NXT$->REQ.DLA) AND FREQ$~=Q$);

   2407  0 001133   001141 710000 0                  TRA     s:2410

      423     2408    3              FREQ$=NXT$;

   2408  0 001134   200024 236100                    LDQ     NXT$,,AUTO
         0 001135   200023 756100                    STQ     FREQ$,,AUTO

      424     2409    3              NXT$=FREQ$->REQ.FL$;

   2409  0 001136   200023 470500                    LDP0    FREQ$,,AUTO
         0 001137   000000 236100                    LDQ     0,,PR0
         0 001140   200024 756100                    STQ     NXT$,,AUTO

      425     2410    3              END;

   2410  0 001141   200024 470500                    LDP0    NXT$,,AUTO
         0 001142   000001 236100                    LDQ     1,,PR0
PL6.E3A0      #001=NID$DEVSCHED File=NID$DISK.:E05TSI                            WED 07/30/97 03:29 Page:59   
         0 001143   200022 116100                    CMPQ    DLA,,AUTO
         0 001144   001151 603000 0                  TRC     s:2411
         0 001145   200021 471500                    LDP1    @Q$,,AUTO
         0 001146   200023 236100                    LDQ     FREQ$,,AUTO
         0 001147   100000 116100                    CMPQ    0,,PR1
         0 001150   001134 601000 0                  TNZ     s:2408

      426     2411    2           GOTO INSRT;

   2411  0 001151   001215 710000 0                  TRA     INSRT

      427     2412        /**/
      428     2413        /**/
      429     2414        /**/
      430     2415    2   ENQDOWN: ENTRY(Q$);

   2415  0 001152   200020 741300       ENQDOWN      STX1  ! SVDCT$+2,,AUTO

      431     2416    3           IF Q$=ADDR(NIL) THEN DO;

   2416  0 001153   200021 470500                    LDP0    @Q$,,AUTO
         0 001154   000000 236100                    LDQ     0,,PR0
         0 001155   000001 116000 xsym               CMPQ    B_VECTNIL+1
         0 001156   001166 601000 0                  TNZ     s:2421

      432     2417    3              REQ.FL$=REQ$;

   2417  0 001157   200013 236100                    LDQ     REQ$,,AUTO
         0 001160   200013 471500                    LDP1    REQ$,,AUTO
         0 001161   100000 756100                    STQ     0,,PR1

      433     2418    3              Q$=REQ$;

   2418  0 001162   200013 236100                    LDQ     REQ$,,AUTO
         0 001163   000000 756100                    STQ     0,,PR0

      434     2419    3              RETURN;
PL6.E3A0      #001=NID$DEVSCHED File=NID$DISK.:E05TSI                            WED 07/30/97 03:29 Page:60   

   2419  0 001164   200020 221300                    LDX1  ! SVDCT$+2,,AUTO
         0 001165   000001 702211                    TSX2  ! 1,X1

      435     2420    3              END;
      436     2421    2           DLA=BITBIN(REQ.DLA)-1;

   2421  0 001166   200013 471500                    LDP1    REQ$,,AUTO
         0 001167   100001 235100                    LDA     1,,PR1
         0 001170   000001 135007                    SBLA    1,DL
         0 001171   200022 755100                    STA     DLA,,AUTO

      437     2422    2           FREQ$=ADDR(NIL);

   2422  0 001172   000001 236000 xsym               LDQ     B_VECTNIL+1
         0 001173   200023 756100                    STQ     FREQ$,,AUTO

      438     2423    2           NXT$=Q$->REQ.FL$;

   2423  0 001174   000000 473500                    LDP3    0,,PR0
         0 001175   300000 236100                    LDQ     0,,PR3
         0 001176   200024 756100                    STQ     NXT$,,AUTO

      439     2424    3           DO WHILE(DLA<BITBIN(NXT$->REQ.DLA) AND FREQ$~=Q$);

   2424  0 001177   001205 710000 0                  TRA     s:2427

      440     2425    3              FREQ$=NXT$;

   2425  0 001200   200024 236100                    LDQ     NXT$,,AUTO
         0 001201   200023 756100                    STQ     FREQ$,,AUTO

      441     2426    3              NXT$=FREQ$->REQ.FL$;

   2426  0 001202   200023 470500                    LDP0    FREQ$,,AUTO
         0 001203   000000 236100                    LDQ     0,,PR0
         0 001204   200024 756100                    STQ     NXT$,,AUTO
PL6.E3A0      #001=NID$DEVSCHED File=NID$DISK.:E05TSI                            WED 07/30/97 03:29 Page:61   

      442     2427    3              END;

   2427  0 001205   200024 470500                    LDP0    NXT$,,AUTO
         0 001206   200022 236100                    LDQ     DLA,,AUTO
         0 001207   000001 116100                    CMPQ    1,,PR0
         0 001210   001215 603000 0                  TRC     INSRT
         0 001211   200021 471500                    LDP1    @Q$,,AUTO
         0 001212   200023 236100                    LDQ     FREQ$,,AUTO
         0 001213   100000 116100                    CMPQ    0,,PR1
         0 001214   001200 601000 0                  TNZ     s:2425

      443     2428    2   INSRT:
      444     2429    3           IF FREQ$=ADDR(NIL) THEN DO;

   2429  0 001215   200023 236100       INSRT        LDQ     FREQ$,,AUTO
         0 001216   000001 116000 xsym               CMPQ    B_VECTNIL+1
         0 001217   001232 601000 0                  TNZ     s:2434

      445     2430    3              REQ.FL$=Q$->REQ.FL$;

   2430  0 001220   200021 471500                    LDP1    @Q$,,AUTO
         0 001221   100000 473500                    LDP3    0,,PR1
         0 001222   300000 236100                    LDQ     0,,PR3
         0 001223   200013 474500                    LDP4    REQ$,,AUTO
         0 001224   400000 756100                    STQ     0,,PR4

      446     2431    3              Q$->REQ.FL$=REQ$;

   2431  0 001225   100000 473500                    LDP3    0,,PR1
         0 001226   200013 236100                    LDQ     REQ$,,AUTO
         0 001227   300000 756100                    STQ     0,,PR3

      447     2432    3              RETURN;

   2432  0 001230   200020 221300                    LDX1  ! SVDCT$+2,,AUTO
         0 001231   000001 702211                    TSX2  ! 1,X1
PL6.E3A0      #001=NID$DEVSCHED File=NID$DISK.:E05TSI                            WED 07/30/97 03:29 Page:62   

      448     2433    3              END;
      449     2434    2           REQ.FL$=FREQ$->REQ.FL$;

   2434  0 001232   200023 471500                    LDP1    FREQ$,,AUTO
         0 001233   100000 236100                    LDQ     0,,PR1
         0 001234   200013 473500                    LDP3    REQ$,,AUTO
         0 001235   300000 756100                    STQ     0,,PR3

      450     2435    2           FREQ$->REQ.FL$=REQ$;

   2435  0 001236   200013 236100                    LDQ     REQ$,,AUTO
         0 001237   100000 756100                    STQ     0,,PR1

      451     2436    2           IF FREQ$=Q$ THEN Q$=REQ$;

   2436  0 001240   200021 473500                    LDP3    @Q$,,AUTO
         0 001241   200023 236100                    LDQ     FREQ$,,AUTO
         0 001242   300000 116100                    CMPQ    0,,PR3
         0 001243   001246 601000 0                  TNZ     s:2437

   2436  0 001244   200013 236100                    LDQ     REQ$,,AUTO
         0 001245   300000 756100                    STQ     0,,PR3

      452     2437    2           RETURN;

   2437  0 001246   200020 221300                    LDX1  ! SVDCT$+2,,AUTO
         0 001247   000001 702211                    TSX2  ! 1,X1

(unnamed)
 Sect OctLoc
   1     000   000007 777777   777777 600777   000003 006000   000005 006000    ................
   1     004   000002 006000   000004 006000                                    ........
      453     2438    2   END ENQUP;
      454     2439    1   END NID$DEVSCHED;
      455     2440        %EOD;

PL6.E3A0      #001=NID$DEVSCHED File=NID$DISK.:E05TSI                            WED 07/30/97 03:29 Page:63   
--  Include file information  --

   P_PMDAT_C.:E05TOU  is referenced.
   P_PMDAT_R.:E05TOU  cannot be made into a system file and is referenced.
   PM$NI.:E05TOU  is referenced.
   N_FC_C.:E05TOU  is referenced.
   NI_MACROS_C.:E05TOU  cannot be made into a system file and is referenced.
   NI$TABLES.:E05TOU  is referenced.
   N$REQ.:E05TOU  is referenced.
   NI_DATA_R.:E05TOU  cannot be made into a system file and is referenced.
   NI_DATA_C.:E05TOU  is referenced.
   HF_LOCK_C.:E05TOU  cannot be made into a system file and is referenced.
   CP_6_SUBS.:E05TOU  is referenced.
      No diagnostics issued in procedure NID$DEVSCHED.
PL6.E3A0      #001=NID$DEVSCHED File=NID$DISK.:E05TSI                            WED 07/30/97 03:29 Page:64   

 **** Variables and constants ****

  ****  Auto variables  ****

  ****  Scalars and arrays  ****
OctLoc.c.b A Datatyp(siz) R M Lvl/name                 OctLoc.c.b A Datatyp(siz) R M Lvl/name

     4-0-0/w PTR         r     1 @NEWSTATE                  3-0-0/w PTR         r     1 @PAR
    21-0-0/w PTR         r     1 @Q$                        5-0-0/w PTR         r     1 DCT$
    22-0-0/w UBIN        r     1 DLA                        6-0-0/w PTR         r     1 DQH$
     7-0-0/w PTR         r     1 DVT$                      23-0-0/w PTR         r     1 FREQ$
    10-0-0/w PTR         r     1 MDCT$                     11-0-0/w SBIN        r     1 MDCTX
    12-0-0/w PTR         r     1 MSQH$                     *0-0-0/w UBIN        r     1 NEWSTATE
    24-0-0/w PTR         r     1 NXT$                      *0-0-0/w UBIN        r     1 PAR
    *0-0-0/w PTR         r     1 Q$                        13-0-0/w PTR         r     1 REQ$
    14-0-0/w BIT         r     1 REQSCHEDONLY              15-0-0/w PTR         r     1 SQH$
    16-0-0/w PTR         r     1 SVDCT$

  ****  SYMREF variables  ****

  ****  Scalars and arrays  ****
OctLoc.c.b A Datatyp(siz) R M Lvl/name                 OctLoc.c.b A Datatyp(siz) R M Lvl/name

     0-0-0/w PTR         r     1 N$DCT$$                    0-0-0/w PTR         r     1 N$FQ$
     0-0-0/w PTR         r     1 NI$FQ$                     0-0-0/w PTR         r     1 NI$IBUF$
     0-0-0/w PTR         r     1 NI$RP$                     0-0-0/w UBIN        r     1 NI_IOLEAPERS
     0-0-0/w UBIN        r     1 NK_MXLOCAL                 0-0-0/w PTR         r     1 P_RESOURCE$

  ****  BASED and DCB variables  ****

  ****  Scalars and arrays  ****
OctLoc.c.b A Datatyp(siz) R M Lvl/name                 OctLoc.c.b A Datatyp(siz) R M Lvl/name

     0-0-0/w STRC(1332)  r     1 DCT                        0-0-0/w STRC(648)   r     1 DQH
     0-0-0/w STRC(1332)  r     1 MDCT                       0-0-0/w PTR         r     1 N$DCT$(0:0)
     0-0-0/d STRC(1080)  r     1 REQ                        0-0-0/w STRC(252)   r     1 SQH

PL6.E3A0      #001=NID$DEVSCHED File=NID$DISK.:E05TSI                            WED 07/30/97 03:29 Page:65   

   Procedure NID$DEVSCHED requires 680 words for executable code.
   Procedure NID$DEVSCHED requires 24 words of local(AUTO) storage.
PL6.E3A0      #001=NID$DEVSCHED File=NID$DISK.:E05TSI                            WED 07/30/97 03:29 Page:66   
          *** CROSS REFERENCE LISTING ***
**     DENOTES     IDENTIFIER DEFINITION
<<                 IDENTIFIER'S VALUE SET
>>                 IDENTIFIER'S VALUE USED
<>                 IDENTIFIER SET AND/OR USED
--                 IDENTIFIER REFERENCED
PL6.E3A0      #001=NID$DEVSCHED File=NID$DISK.:E05TSI                            WED 07/30/97 03:29 Page:67   
          MINI XREF LISTING

DCT
      1828**DCL      2227<>CALL     2250<>CALL     2296<>CALL     2337<>CALL
DCT.DFLG.MPCSTOP
      1833**DCL      2334>>IF
DCT.DFLG.MPCSUSPENDED
      1833**DCL      2361<<ASSIGN
DCT.DP
      1848**DCL      1855--REDEF    1858--REDEF    1859--REDEF    1861--REDEF    1861--REDEF    1862--REDEF
      1863--REDEF    1863--REDEF
DCT.DP.BQ$
      1848**DCL      2203>>IF       2205<>CALL     2212>>IF       2214<>CALL     2319>>ASSIGN   2320<<ASSIGN
      2367>>ASSIGN   2368<<ASSIGN
DCT.DP.CSEEK
      1849**DCL      2199<<ASSIGN   2203>>IF       2212>>IF       2256<<ASSIGN   2317<<ASSIGN   2365<<ASSIGN
DCT.DP.LEAPERS
      1850**DCL      2197<<ASSIGN   2203>>IF       2207<<ASSIGN   2207>>ASSIGN   2212>>IF       2216<<ASSIGN
      2216>>ASSIGN   2321<<ASSIGN   2369<<ASSIGN
DCT.DP.MIRROR.DCTX
      1853**DCL      2081>>ASSIGN
DCT.DP.MIRROR.DRZERO
      1854**DCL      2075>>IF
DCT.DP.MIRROR.FLAG
      1850**DCL      2072>>IF       2169>>IF
DCT.DP.MIRROR.LOCK
      1851**DCL      2169>>IF
DCT.DP.MIRROR.LQ$
      1855**DCL      2174<>CALL
DCT.DP.MIRROR.STATE
      1852**DCL      2088>>IF
DCT.DP.MIRROR.USER#
      1853**DCL      2169>>IF
DCT.DP.SWP
PL6.E3A0      #001=NID$DEVSCHED File=NID$DISK.:E05TSI                            WED 07/30/97 03:29 Page:68   
      1848**DCL      2198<<ASSIGN   2202>>IF       2322<<ASSIGN   2322>>ASSIGN   2370<<ASSIGN   2370>>ASSIGN
DCT.DQH$
      1844**DCL      2315<<ASSIGN   2362<<ASSIGN
DCT.DVT$
      1844**DCL      2291>>ASSIGN
DCT.MPC.IOCHANX
      1856**DCL      1856--REDEF
DCT.PM
      1839**DCL      2230<>CALL     2238<>CALL     2253<>CALL     2257<>CALL     2324<>CALL     2326<>CALL
      2328<>CALL     2372<>CALL     2374<>CALL     2376<>CALL     2378<>CALL
DCT.PM.MODE
      1839**DCL      2236>>IF
DCT.SQ$
      1828**DCL      2193>>IF       2196<<ASSIGN   2208<>CALL     2217<>CALL     2223>>IF       2248>>IF
      2292>>ASSIGN   2311<>CALL     2318>>IF       2319<<ASSIGN   2323>>IF       2357<>CALL     2366>>IF
      2367<<ASSIGN   2371>>IF
DCT.SQH$
      1843**DCL      2032>>ASSIGN   2065>>ASSIGN   2189>>ASSIGN   2244>>ASSIGN
DCT.STATE
      1838**DCL      2036<<ASSIGN   2223>>IF       2229<<ASSIGN   2245<<ASSIGN   2247>>IF       2252<<ASSIGN
      2316<<ASSIGN   2363<<ASSIGN
DCT.TYPE
      1838**DCL      2256>>IF       2364>>IF
DCT$
      1806**DCL      1828--IMP-PTR  2031<<ASSIGN   2032>>ASSIGN   2036>>ASSIGN   2064<<ASSIGN   2065>>ASSIGN
      2072>>IF       2075>>IF       2081>>ASSIGN   2088>>IF       2169>>IF       2169>>IF       2169>>IF
      2174>>CALL     2188<<ASSIGN   2189>>ASSIGN   2193>>IF       2196>>ASSIGN   2197>>ASSIGN   2198>>ASSIGN
      2199>>ASSIGN   2202>>IF       2203>>IF       2203>>IF       2203>>IF       2205>>CALL     2207>>ASSIGN
      2207>>ASSIGN   2208>>CALL     2212>>IF       2212>>IF       2212>>IF       2214>>CALL     2216>>ASSIGN
      2216>>ASSIGN   2217>>CALL     2223>>IF       2223>>IF       2227>>CALL     2229>>ASSIGN   2230>>CALL
      2236>>IF       2238>>CALL     2243<<ASSIGN   2244>>ASSIGN   2245>>ASSIGN   2247>>IF       2248>>IF
      2250>>CALL     2252>>ASSIGN   2253>>CALL     2256>>IF       2256>>ASSIGN   2257>>CALL     2288<>CALL
      2291>>ASSIGN   2292>>ASSIGN   2296>>CALL     2311>>CALL     2315>>ASSIGN   2316>>ASSIGN   2317>>ASSIGN
      2318>>IF       2319>>ASSIGN   2319>>ASSIGN   2320>>ASSIGN   2321>>ASSIGN   2322>>ASSIGN   2322>>ASSIGN
      2323>>IF       2324>>CALL     2326>>CALL     2328>>CALL     2337>>CALL     2357>>CALL     2362>>ASSIGN
      2363>>ASSIGN   2364>>IF       2365>>ASSIGN   2366>>IF       2367>>ASSIGN   2367>>ASSIGN   2368>>ASSIGN
PL6.E3A0      #001=NID$DEVSCHED File=NID$DISK.:E05TSI                            WED 07/30/97 03:29 Page:69   
      2369>>ASSIGN   2370>>ASSIGN   2370>>ASSIGN   2371>>IF       2372>>CALL     2374>>CALL     2376>>CALL
      2378>>CALL
DEVSCHED
      2247**LABEL    2037--GOTO     2240--GOTO
DLA IN PROCEDURE ENQUP
      2396**DCL      2404<<ASSIGN   2407>>DOWHILE  2421<<ASSIGN   2424>>DOWHILE
DQH
      1876**DCL      2329<>CALL     2379<>CALL
DQH.FL$
      1876**DCL      2341>>IF       2342>>DOWHILE  2343>>ASSIGN
DQH.IO$
      1883**DCL      2314<<ASSIGN   2360<<ASSIGN
DQH.IOCHANX
      1878**DCL      1879--REDEF
DQH.MBX$
      1887**DCL      1888--REDEF
DQH.MPC$
      1883**DCL      2334>>IF       2361>>ASSIGN
DQH.STATE
      1880**DCL      2334>>IF
DQH$
      1807**DCL      1876--IMP-PTR  2304<>CALL     2314>>ASSIGN   2315>>ASSIGN   2329>>CALL     2333<<ASSIGN
      2334>>IF       2334>>IF       2341>>IF       2342>>DOWHILE  2349<>CALL     2360>>ASSIGN   2361>>ASSIGN
      2362>>ASSIGN   2379>>CALL
DVT.MPC
      1893**DCL      1894--REDEF
DVT$
      1808**DCL      1891--IMP-PTR  2291<<ASSIGN
ENQDOWN IN PROCEDURE ENQUP
      2415**ENTRY    2208--CALL     2214--CALL
ENQUP
      2391**PROC     2205--CALL     2217--CALL
FREQ$ IN PROCEDURE ENQUP
      2397**DCL      2405<<ASSIGN   2407>>DOWHILE  2408<<ASSIGN   2409>>ASSIGN   2422<<ASSIGN   2424>>DOWHILE
      2425<<ASSIGN   2426>>ASSIGN   2429>>IF       2434>>ASSIGN   2435>>ASSIGN   2436>>IF
HFC$LOCK
PL6.E3A0      #001=NID$DEVSCHED File=NID$DISK.:E05TSI                            WED 07/30/97 03:29 Page:70   
       598**DCL-ENT  2034--CALL     2067--CALL     2279--CALL
HFC$UNLOCK
       598**DCL-ENT  2118--CALL     2385--CALL
INSRT IN PROCEDURE ENQUP
      2429**LABEL    2411--GOTO
MDCT.DP
      1926**DCL      1933--REDEF    1936--REDEF    1937--REDEF    1939--REDEF    1939--REDEF    1940--REDEF
      1941--REDEF    1941--REDEF
MDCT.DP.MIRROR.STATE
      1930**DCL      2101>>IF
MDCT.DP.MIRROR.WRITE
      1929**DCL      2162>>IF
MDCT.MPC.IOCHANX
      1934**DCL      1934--REDEF
MDCT.SQH$
      1921**DCL      2083>>ASSIGN
MDCT$
      1809**DCL      1906--IMP-PTR  2082<<ASSIGN   2083>>ASSIGN   2101>>IF       2115>>ASSIGN   2162>>IF
MDCTX
      1810**DCL      2081<<ASSIGN   2082>>ASSIGN   2090>>IF       2090>>IF       2114>>ASSIGN
MSQH.DOOR
      1954**DCL      1954--REDEF
MSQH$
      1811**DCL      1954--IMP-PTR  2083<<ASSIGN
N$DCT$
      1144**DCL      2082>>ASSIGN
N$DCT$$
      1010**DCL      1144--IMP-PTR  2082>>ASSIGN
N$FQ$
      1010**DCL      1145--IMP-PTR
N$REQ_INIT.BUFADDR
      1029**DCL      1030--REDEF    1030--REDEF
N$REQ_INIT.DLA.DRELADDR
      1021**DCL      1021--REDEF
N$REQ_INIT.DVE.EOMCHAR
      1058**DCL      1059--REDEF
PL6.E3A0      #001=NID$DEVSCHED File=NID$DISK.:E05TSI                            WED 07/30/97 03:29 Page:71   
N$REQ_INIT.EAINFO
      1052**DCL      1052--REDEF
N$REQ_INIT.EAINFOX
      1052**DCL      1053--REDEF
N$REQ_INIT.EVNTINFO
      1053**DCL      1053--REDEF
N$REQ_INIT.STATUS
      1034**DCL      1040--REDEF
NEWSTATE
      1788**DCL        41--PROC     2036>>ASSIGN   2242--ENTRY    2245>>ASSIGN
NI$FQ$
      1070**DCL      1146--IMP-PTR
NI$IBUF$
      1070**DCL      1146--IMP-PTR
NI$IMXMBX_INIT.PAGED_BASE
      1080**DCL      1081--REDEF    1081--REDEF
NI$IMXMBX_INIT.SIZE
      1082**DCL      1082--REDEF
NI$REQ_INIT.DCW
      1104**DCL      1107--REDEF
NI$REQ_INIT.DCW.TALLY
      1105**DCL      1105--REDEF
NI$REQ_INIT.IDCW.EXTA
      1107**DCL      1107--REDEF
NI$REQ_INIT.PCW
      1109**DCL      1113--REDEF
NI$REQ_INIT.SEEK
      1114**DCL      1115--REDEF    1116--REDEF
NI$RP$
      1118**DCL      1148--IMP-PTR
NIM$DEQUEUE
      1173**DCL-ENT  2288--CALL     2304--CALL     2311--CALL     2349--CALL     2357--CALL
NIM$ENQUEUE
      1174**DCL-ENT  2174--CALL     2227--CALL     2250--CALL     2296--CALL     2337--CALL
NIO$DCWBLD
      1793**DCL-ENT  2116--CALL
PL6.E3A0      #001=NID$DEVSCHED File=NID$DISK.:E05TSI                            WED 07/30/97 03:29 Page:72   
NIS$DRIVER
      1794**DCL-ENT  2329--CALL     2379--CALL
NI_IOLEAPERS
      1801**DCL      2203>>IF       2212>>IF
NI_MBX_INIT.DCW.CONTROL.AE
      1140**DCL      1140--REDEF
NI_MBX_INIT.LPW.CONTROL.AE
      1136**DCL      1136--REDEF
NK_MXLOCAL
      1802**DCL      2090>>IF
NXT$ IN PROCEDURE ENQUP
      2398**DCL      2406<<ASSIGN   2407>>DOWHILE  2408>>ASSIGN   2409<<ASSIGN   2423<<ASSIGN   2424>>DOWHILE
      2425>>ASSIGN   2426<<ASSIGN
PAR
      1789**DCL        41--PROC     2031--ASSIGN   2058--ENTRY    2063--ASSIGN   2186--ENTRY    2187--ASSIGN
      2242--ENTRY    2243--ASSIGN   2276--ENTRY    2277--ASSIGN
PMN$COLLECT
      1795**DCL-ENT  2230--CALL     2238--CALL     2253--CALL     2257--CALL     2324--CALL     2326--CALL
      2328--CALL     2372--CALL     2374--CALL     2376--CALL     2378--CALL
PMNBUSY
      2236**LABEL    2176--GOTO
P_NSCPU
      1765**DCL      1766--REDEF
P_RESOURCE.RES
      1638**DCL      1705--REDEF
P_RESOURCE$
      1718**DCL      1606--IMP-PTR
P_UPTIME
      1754**DCL      1755--REDEF
Q$ IN PROCEDURE ENQUP
      2392**DCL      2391--PROC     2399>>IF       2401<<ASSIGN   2406>>ASSIGN   2407>>DOWHILE  2415--ENTRY
      2416>>IF       2418<<ASSIGN   2423>>ASSIGN   2424>>DOWHILE  2430>>ASSIGN   2431>>ASSIGN   2436>>IF
      2436<<ASSIGN
REQ
      1967**DCL      2116<>CALL     2174<>CALL
REQ.BPMIR
PL6.E3A0      #001=NID$DEVSCHED File=NID$DISK.:E05TSI                            WED 07/30/97 03:29 Page:73   
      2012**DCL      2077<<ASSIGN   2079>>IF
REQ.BUFADDR
      1976**DCL      1977--REDEF    1977--REDEF
REQ.COMP
      2001**DCL      2086<<ASSIGN
REQ.DCT$
      1968**DCL      2064>>ASSIGN   2115<<ASSIGN   2188>>ASSIGN
REQ.DLA
      1967**DCL      2203>>IF       2212>>IF       2317>>ASSIGN   2365>>ASSIGN   2404>>ASSIGN   2407>>DOWHILE
      2421>>ASSIGN   2424>>DOWHILE
REQ.DLA.DCTX
      1967**DCL      2114<<ASSIGN
REQ.DLA.DRELADDR
      1968**DCL      1968--REDEF    2075>>IF
REQ.DOMIR
      2011**DCL      2085<<ASSIGN   2164<<ASSIGN
REQ.DQH$
      1989**DCL      2293>>IF       2333>>ASSIGN
REQ.DVE.EOMCHAR
      2005**DCL      2006--REDEF
REQ.EAINFO
      1999**DCL      1999--REDEF
REQ.EAINFOX
      1999**DCL      2000--REDEF
REQ.EVNTINFO
      2000**DCL      2000--REDEF
REQ.FC
      1970**DCL      2124>>IF       2124>>IF
REQ.FL$
      1967**DCL      2195<<ASSIGN   2292>>ASSIGN   2400<<ASSIGN   2406>>ASSIGN   2409>>ASSIGN   2417<<ASSIGN
      2423>>ASSIGN   2426>>ASSIGN   2430<<ASSIGN   2430>>ASSIGN   2431<<ASSIGN   2434<<ASSIGN   2434>>ASSIGN
      2435<<ASSIGN
REQ.IOFLG.STOPMPC
      1973**DCL      2334>>IF
REQ.IOFLG.SUSP
      1972**DCL      2361>>IF
PL6.E3A0      #001=NID$DEVSCHED File=NID$DISK.:E05TSI                            WED 07/30/97 03:29 Page:74   
REQ.MIRDONE
      2012**DCL      2072>>IF
REQ.STATUS
      1981**DCL      1987--REDEF
REQ.USER#
      2001**DCL      2169>>IF
REQ$
      1812**DCL      1967--IMP-PTR  2063<<ASSIGN   2064>>ASSIGN   2072>>IF       2075>>IF       2077>>ASSIGN
      2079>>IF       2085>>ASSIGN   2086>>ASSIGN   2114>>ASSIGN   2115>>ASSIGN   2116>>CALL     2124>>IF
      2124>>IF       2164>>ASSIGN   2169>>IF       2174>>CALL     2187<<ASSIGN   2188>>ASSIGN   2195>>ASSIGN
      2195>>ASSIGN   2196>>ASSIGN   2203>>IF       2212>>IF       2292<<ASSIGN   2293>>IF       2311<>CALL
      2314>>ASSIGN   2317>>ASSIGN   2333>>ASSIGN   2334>>IF       2357<>CALL     2360>>ASSIGN   2361>>IF
      2365>>ASSIGN   2400>>ASSIGN   2400>>ASSIGN   2401>>ASSIGN   2404>>ASSIGN   2417>>ASSIGN   2417>>ASSIGN
      2418>>ASSIGN   2421>>ASSIGN   2430>>ASSIGN   2431>>ASSIGN   2434>>ASSIGN   2435>>ASSIGN   2436>>ASSIGN
REQSCHED
      2062**LABEL    2120--GOTO
REQSCHEDL
      2193**LABEL    2180--GOTO
REQSCHEDONLY
      1813**DCL      2070<<ASSIGN   2190<<ASSIGN   2221>>IF
SCANAQ
      2282**LABEL    2260--GOTO
SC_NIDINVMIR
      1796**DCL-ENT  2099--CALL
SC_NIDNOPMIR
      1797**DCL-ENT  2111--CALL
SQH.AQ$
      2026**DCL      2227<>CALL     2250<>CALL     2283>>DOWHILE  2288<>CALL     2383<<ASSIGN
SQH.CQ$
      2026**DCL      2294>>IF       2304<>CALL     2342>>DOWHILE  2343<<ASSIGN   2343>>ASSIGN   2349<>CALL
SQH.DOOR
      2025**DCL      2025--REDEF
SQH.GATE
      2025**DCL      2034<>CALL     2067<>CALL     2118<>CALL     2279<>CALL     2385<>CALL
SQH$
      1814**DCL      2025--IMP-PTR  2032<<ASSIGN   2034>>CALL     2065<<ASSIGN   2067>>CALL     2118>>CALL
PL6.E3A0      #001=NID$DEVSCHED File=NID$DISK.:E05TSI                            WED 07/30/97 03:29 Page:75   
      2189<<ASSIGN   2227>>CALL     2244<<ASSIGN   2250>>CALL     2277<<ASSIGN   2279>>CALL     2283>>DOWHILE
      2288>>CALL     2294>>IF       2304>>CALL     2342>>DOWHILE  2343>>ASSIGN   2343>>ASSIGN   2349>>CALL
      2383>>ASSIGN   2385>>CALL
SVDCT$
      1815**DCL      2282<<ASSIGN   2296<>CALL     2337<>CALL     2383>>ASSIGN

PL6.E3A0      #002=NID$POSTER File=NID$DISK.:E05TSI                              WED 07/30/97 03:30 Page:76   
      456        1        /*T***********************************************************/
      457        2        /*T*                                                         */
      458        3        /*T* Copyright (c) Bull HN Information Systems Inc., 1997    */
      459        4        /*T*                                                         */
      460        5        /*T***********************************************************/
      461        6        /*D*    NAME:    NID$POSTER
      462        7
      463        8                CALL:    CALL NID$POSTER(PAR,INTLVL,STATUS)
      464        9
      465       10                INPUT:   PAR - If INTLVL = 0, 1, 2, 3, or 4 then PAR is DQH.
      466       11                               If INTLVL = 5 then PAR is DCT.
      467       12                         INTLVL - Interrupt level.
      468       13                                     0 = Overhead
      469       14                                     1 = Terminate
      470       15                                     2 = Marker (unused)
      471       16                                     3 = Special
      472       17                                     4 = Time out (software)
      473       18                                     5 = Repost (software)
      474       19                         STATUS - Status if INTLVL = 0, 3 or 4.  Otherwise
      475       20                                  status is in NI$REQ.STATUS.
      476       21
      477       22                DESCRIPTION:   NID$POSTER handles disk I/O completions and
      478       23                               special interrupts.  It is called from
      479       24                               NIM$INTDIS, NIF$FAULT and NII$LIP.  Appropriate
      480       25                               action is taken based on INTLVL and the
      481       26                               status.
      482       27
      483       28                               INTLVL = 1 is the normal completion entry with
      484       29                               values of 0, 4 and 5 being special cases.  If
      485       30                               the status is normal completion then a fast
      486       31                               path is taken which reschedules the device and
      487       32                               reports the I/O completion on the request.
      488       33                               Otherwise a appropriate recovery action is taken
      489       34                               based on the status.
      490       35
      491       36                               INTLVL = 3 is the special interrupt entry.  If
      492       37                               the special status says "Device ready" and the
PL6.E3A0      #002=NID$POSTER File=NID$DISK.:E05TSI                              WED 07/30/97 03:30 Page:77   
      493       38                               current device state is SPWAIT then the device
      494       39                               is restarted.  Otherwise the special interrupt
      495       40                               is reported to whoever has special interrupt
      496       41                               control for this device.
      497       42                                                                           */
      498       43        NID$POSTER: PROC (PAR,INTLVL,STATUS);
      499       44        /*
      500       45                Includes
      501       46        */
      502       47        %INCLUDE                CP_6_SUBS ;
      503      587        %INCLUDE                EL_SUBS_C ;
      504      671        %INCLUDE                HF_LOCK_C ;
      505      685        %INCLUDE                HF_DATA_R ;
      506      728        %INCLUDE                NI$ERRLOG ;
      507      794        %INCLUDE                NI_DATA_C ;
      508      907        %INCLUDE                NI_DATA_R ;
      509     1344        %INCLUDE                NI_MACROS_C ;
      510     1611        %INCLUDE                N_FC_C ;
      511     1648        %INCLUDE                OC_SUBS_C ;
      512     2379        %INCLUDE                PM$NI ;
      513     2403        /*
      514     2404                Parameters
      515     2405        */
      516     2406    1   DCL 1 INTLVL            UBIN(18) PARAM ;
      517     2407    1   DCL 1 PAR               PTR PARAM ;
      518     2408        %STATUS                 ( NAME=STATUS, STCLASS=PARAM ) ;
      519     2475        /*
      520     2476                Entries
      521     2477        */
      522     2478    1   DCL 1 FMN$AVR           ENTRY(2) ;
      523     2479    1   DCL 1 NIA$LOGERR        ENTRY(4) ;
      524     2480    1   DCL 1 NIA$RELERR        ENTRY(1) ;
      525     2481    1   DCL 1 NIA$SPURINT       ENTRY(4) ;
      526     2482    1   DCL 1 NID$DEVSCHED      ENTRY(2) ;
      527     2483    1   DCL 1 NID$DEVSCHEDL     ENTRY(2) ;
      528     2484    1   DCL 1 NID$REQSCHED      ENTRY(1) ;
      529     2485    1   DCL 1 NID$REQSCHEDL     ENTRY(1) ;
PL6.E3A0      #002=NID$POSTER File=NID$DISK.:E05TSI                              WED 07/30/97 03:30 Page:78   
      530     2486    1   DCL 1 NID$SCANAQ        ENTRY(1) ;
      531     2487    1   DCL 1 NIF$ANFAULT       ENTRY(3) ALTRET ;
      532     2488    1   DCL 1 NIF$ANIOM         ENTRY(2) ALTRET ;
      533     2489    1   DCL 1 NIK$OPMSG         ENTRY(5) ;
      534     2490    1   DCL 1 NIM$CVTPTR        ENTRY(3) ;
      535     2491    1   DCL 1 NIO$DCWBLD        ENTRY(1) ALTRET ;
      536     2492    1   DCL 1 NIO$COMP          ENTRY(2) ;
      537     2493    1   DCL 1 NIO$SPCOMP        ENTRY(1) ;
      538     2494    1   DCL 1 NIQ$GET           ENTRY(1) ALTRET ;
      539     2495    1   DCL 1 NIQ$REL           ENTRY(1) ALTRET ;
      540     2496    1   DCL 1 NIS$DRIVER        ENTRY(1) ;
      541     2497    1   DCL 1 NIS$MASK          ENTRY(2) ;
      542     2498    1   DCL 1 NIW$LDFW          ENTRY(2) ALTRET ;
      543     2499    1   DCL 1 NIW$MPCSTART      ENTRY(1) ;
      544     2500    1   DCL 1 NIW$MPCSTOP       ENTRY(1) ;
      545     2501    1   DCL 1 OCI$MK_STTM       ENTRY(1) ;
      546     2502    1   DCL 1 PMN$COLLECT       ENTRY(3) ;
      547     2503    1   DCL 1 SC_NIDBADINTLVL   ENTRY CONV(2,0) ;
      548     2504    1   DCL 1 SC_NIDINVMIR      ENTRY CONV(2,0) ;
      549     2505    1   DCL 1 SC_NIDNOPMIR      ENTRY CONV(2,0) ;
      550     2506    1   DCL 1 TDM$MIRFAIL       ENTRY(2) ;
      551     2507        /*
      552     2508                Auto
      553     2509        */
      554     2510    1   DCL 1 CHANTIME          UBIN WORD ALIGNED AUTO ;
      555     2511    1   DCL 1 COMP              BIT(1) ALIGNED AUTO ;
      556     2512    1   DCL 1 DCT$              PTR ALIGNED AUTO ;
      557     2513    1   DCL 1 DQH$              PTR ALIGNED AUTO ;
      558     2514    1   DCL 1 EXTST$            PTR ALIGNED AUTO ;
      559     2515    1   DCL 1 I                 SBIN WORD ALIGNED AUTO ;
      560     2516    1   DCL 1 MDCT$             PTR ALIGNED AUTO ;
      561     2517    1   DCL 1 MDCTX             UBIN WORD ALIGNED AUTO ;
      562     2518    1   DCL 1 NEWSTATE          UBIN WORD ALIGNED AUTO ;
      563     2519        %NI$EXTST               ( NAME=NI$EXTST, STCLASS=AUTO ) ;
      564     2553    1   DCL 1 REQ$              PTR ALIGNED AUTO ;
      565     2554    1   DCL 1 RESTORE$          PTR ALIGNED AUTO ;
      566     2555    1   DCL 1 RCVR              ALIGNED AUTO,
PL6.E3A0      #002=NID$POSTER File=NID$DISK.:E05TSI                              WED 07/30/97 03:30 Page:79   
      567     2556    1         2 RETRY           BIT(1),
      568     2557    1         2 NOINC           BIT(1),
      569     2558    1         2 LOG             BIT(1),
      570     2559    1         2 RESTORE         BIT(1),
      571     2560    1         2 EXTST           BIT(1),
      572     2561    1         2 OPMSG           BIT(1),
      573     2562    1         2 *               BIT(30) ;
      574     2563    1   DCL 1 SQH$              PTR ALIGNED AUTO ;
      575     2564        /*
      576     2565                Based
      577     2566        */
      578     2567        %NI$DCT                 ( NAME=DCT,       STCLASS="BASED(DCT$)" ) ;
      579     2615        %NI$DQH                 ( NAME=DQH,       STCLASS="BASED(DQH$)" ) ;
      580     2638        %NI$IOM                 ( NAME=IOM,       STCLASS=BASED ) ;
      581     2643        %NI$IOSTAT              ( NAME=IOSTAT,    STCLASS=BASED ) ;
      582     2652        %NI$MBX                 ( NAME=MBX,       STCLASS=BASED ) ;
      583     2671        %NI$DCT                 ( NAME=MDCT,      STCLASS="BASED(MDCT$)" ) ;
      584     2719        %NI$IOERR               ( NAME=NI$IOERR,  STCLASS=BASED ) ;
      585     2773        %N$REQ                  ( NAME=REQ,       STCLASS="BASED(REQ$)" ) ;
      586     2831        %NI$REQ                 ( NAME=IOS,       STCLASS=BASED ) ;
      587     2856        %NI$SQH                 ( NAME=SQH,       STCLASS="BASED(SQH$)" ) ;
      588     2869        /*
      589     2870                Constants
      590     2871        */
      591     2872        %EQU RCVR_RETRY='400000000000'O;
      592     2873        %EQU RCVR_NOINC='200000000000'O;
      593     2874        %EQU RCVR_LOG='100000000000'O;
      594     2875        %EQU RCVR_RESTORE='040000000000'O;
      595     2876        %EQU RCVR_EXTST='020000000000'O;
      596     2877        %EQU RCVR_OPMSG='010000000000'O;
      597     2878        /**/
      598     2879        /* READY STATUS */
      599     2880        /**/
      600     2881    1   DCL 1 READY_STAT CONSTANT ALIGNED,
      601     2882    1         2 TYC(0:6) BIT(36) INIT('0'B*3,%TYC_IOERR,'0'B*3),
      602     2883    1         2 RCVR(0:6) BIT(36) INIT('0'B,%RCVR_LOG*2,
      603     2884    1                                  %(RCVR_LOG|RCVR_RETRY),
PL6.E3A0      #002=NID$POSTER File=NID$DISK.:E05TSI                              WED 07/30/97 03:30 Page:80   
      604     2885    1                                  %RCVR_LOG*3),
      605     2886    1         2 STATE(0:6) UBIN INIT(%IDLE*7);
      606     2887        /**/
      607     2888        /* ATTENTION STATUS */
      608     2889        /**/
      609     2890    1   DCL 1 ATT_STAT CONSTANT ALIGNED,        /* ATTENTION = '02'O */
      610     2891    1         2 TYC(0:6) BIT(36) INIT(%TYC_IOERR*6,%TYC_PROT),
      611     2892    1         2 RCVR(0:6) BIT(36) INIT(%(RCVR_RETRY|RCVR_LOG|RCVR_EXTST),
      612     2893    1        %(RCVR_RETRY|RCVR_LOG|RCVR_EXTST), /* DEV OFFLINE */
      613     2894    1        %(RCVR_RETRY|RCVR_LOG|RCVR_EXTST), /* DEV IN STANDBY */
      614     2895    1        %(RCVR_RETRY|RCVR_LOG|RCVR_EXTST), /* DEV INOPERABLE */
      615     2896    1                                  %(RCVR_RETRY|RCVR_LOG|RCVR_EXTST),
      616     2897    1   %(RCVR_RETRY|RCVR_LOG|RCVR_RESTORE|RCVR_EXTST), /* SEEK INCOMPLETE */
      617     2898    1       %(RCVR_RETRY|RCVR_LOG|RCVR_EXTST)), /* WRITE INHIBIT */
      618     2899    1         2 STATE(0:6) UBIN INIT(%SPWAIT*7);
      619     2900        /**/
      620     2901        /* DATA ALERT STATUS */
      621     2902        /**/
      622     2903    1   DCL 1 DAL_STAT CONSTANT ALIGNED,        /* DATA ALERT = '03'O */
      623     2904    1         2 TYC(0:6) BIT(36) INIT(%TYC_IOERR, '0'B, %TYC_IOERR*5),
      624     2905    1         2 RCVR(0:6) BIT(36) INIT(%(RCVR_RETRY|RCVR_LOG|RCVR_EXTST),
      625     2906    1                                  '0'B,    /* DATA VERIFY ALERT */
      626     2907    1        %(RCVR_RETRY|RCVR_LOG|RCVR_EXTST), /* CHECK CHAR ALERT */
      627     2908    1   %(RCVR_RETRY|RCVR_LOG|RCVR_RESTORE|RCVR_EXTST), /* HDR VERIFY FAIL */
      628     2909    1        %(RCVR_RETRY|RCVR_LOG|RCVR_EXTST), /* INVALID SEEK ADDR */
      629     2910    1        %(RCVR_RETRY|RCVR_LOG|RCVR_EXTST), /* TRANS PARITY ALERT */
      630     2911    1       %(RCVR_RETRY|RCVR_LOG|RCVR_EXTST)), /* TRANS TIMING ALERT */
      631     2912    1         2 STATE(0:6) UBIN INIT(%IDLE*7);
      632     2913        /**/
      633     2914    1   DCL CHECKBITS BIT(72) CONSTANT DALIGNED INIT('37770077'O);
      634     2915        %SUB FOREVER="WHILE('1'B)";
      635     2916        %SUB NEVER="WHILE('0'B)";
      636     2917        %EJECT;
PL6.E3A0      #002=NID$POSTER File=NID$DISK.:E05TSI                              WED 07/30/97 03:30 Page:81   
      637     2918    2           DO INHIBIT;
      638     2919    2              MDCTX = 0 ;
      639     2920    2              MDCT$ = ADDR(NIL) ;
      640     2921    3              DO CASE(INTLVL);
      641     2922    3               CASE(%OVERHEAD,%TERMINATE,%LOST);
      642     2923    3                 DQH$=ADDR(PAR);
      643     2924    3                 SQH$=DQH.SQH$;
      644     2925                      %LOCK (G#=SQH.GATE);
      645     2928    3                 IF  DQH.STATE ~= %BUSY
      646     2929    4                 THEN DO ;
      647     2930    4                     IF  ADDR(STATUS) ~= ADDR(NIL)
      648     2931    4                     THEN
      649     2932    4                         CALL NIA$SPURINT ( DQH, EL_SPURINT, INTLVL, STATUS ) ;
      650     2933    4                     ELSE IF  INTLVL = %TERMINATE
      651     2934    4                          AND DQH.IOSTATUS$ ~= ADDR(NIL)
      652     2935    4                     THEN
      653     2936    4                         CALL NIA$SPURINT ( DQH, EL_SPURINT, INTLVL, DQH.IOSTATUS$->
              2936                                  IOSTAT.STATUS ) ;
      654     2937    4                     ELSE
      655     2938    4                         CALL NIA$SPURINT ( DQH, EL_SPURINT, INTLVL, NI_DBLZERO ) ;
      656     2939                          %UNLOCK ( G#=SQH.GATE ) ;
      657     2942    4                     RETURN;
      658     2943    4                     END;
      659     2944    3                 REQ$=DQH.IO$;
      660     2945    3                 DCT$=REQ.DCT$;
      661     2946    3                 IF  DCT.DP.MIRROR.FLAG
      662     2947    4                 THEN DO ;
      663     2948    4                     MDCTX = DCT.DP.MIRROR.DCTX ;
      664     2949    4                     MDCT$ = N$DCT$(MDCTX) ;
      665     2950    4                     END ;
      666     2951    3                 CALL PMN$COLLECT(DQH.PM,%PM_IDLE,CHANTIME);
      667     2952    3                 IF HW_IMX THEN
      668     2953    3                    REQ.FLPW=DQH.IOSTATUS$->IOSTAT.LPW_RESIDUE;
      669     2954    3                 ELSE
      670     2955    3                    REQ.FLPW=DQH.MBX$->MBX.LPW;
      671     2956    4                 IF INTLVL=%TERMINATE THEN DO;
      672     2957    4                    REQ.STATUS=DQH.IOSTATUS$->IOSTAT.STATUS;
PL6.E3A0      #002=NID$POSTER File=NID$DISK.:E05TSI                              WED 07/30/97 03:30 Page:82   
      673     2958    4                    IF HW_IOP THEN    /* ignore IOP generated lost interrupt */
      674     2959    4                       IF REQ.STATUS.MAJOR = %READY AND
      675     2960    5                         REQ.STATUS.IOM.CHANNEL = %LOSTINT THEN DO;
      676     2961                               %UNLOCK (G#=SQH.GATE);
      677     2964    5                          RETURN;
      678     2965    5                          END;
      679     2966    4                    END;
      680     2967    4                 ELSE DO;
      681     2968    4                    REQ.STATUS=STATUS;
      682     2969    5                    IF REQ.STATUS.MAJOR=%LOST_INTERRUPT THEN DO;
      683     2970    5                       CALL NIS$MASK(DQH,%IMX_CCW_MASK_CHAN);
      684     2971    5                       END;
      685     2972    4                    END;
      686     2973    3                 REQ.TYC='0'B;
      687     2974    3                 IF  ( NOT REQ.STATUS & CHECKBITS )
      688     2975    3                 AND (    REQ.COMP = %COMP_REG
      689     2976    3                       OR REQ.COMP = %COMP_MIRROR )
      690     2977    4                 THEN DO ;
      691     2978    4                     COMP = '1'B ;
      692     2979    4                     IF  REQ.COMP = %COMP_MIRROR
      693     2980    5                     THEN DO ;
      694     2981    5                         IF  REQ.ERR$ ~= ADDR(NIL)
      695     2982    5                         THEN
      696     2983    5                             CALL NIA$RELERR ( REQ )  ;
      697     2984    5                         REQ.MIRDONE = '1'B ;
      698     2985    5                         IF  REQ.DOMIR AND MDCTX ~= 0 /* DONT MIRROR */
      699     2986    6                         THEN DO ;
      700     2987    6                             IF  MDCT$ = ADDR(NIL)
      701     2988    6                             THEN
      702     2989    6                                 CALL SC_NIDINVMIR ;
      703     2990    6                             IF  MDCT.DP.MIRROR.WRITE
      704     2991    7                             THEN DO ;
      705     2992    7                                 COMP               = '0'B ;
      706     2993    7                                 REQ.DOMIR          = '0'B ;
      707     2994    7                                 REQ.DLA.DCTX       = MDCTX ;
      708     2995    7                                 REQ.DCT$           = MDCT$ ;
      709     2996    7                                 CALL NIO$DCWBLD    ( REQ ) ;
PL6.E3A0      #002=NID$POSTER File=NID$DISK.:E05TSI                              WED 07/30/97 03:30 Page:83   
      710     2997                                      %UNLOCK ( G# = SQH.GATE ) ;
      711     3000    7                                 CALL NID$REQSCHED ( REQ ) ;
      712     3001                                      %LOCK  ( G# = SQH.GATE  ) ;
      713     3004    7                                 END ;
      714     3005    6                             END ;
      715     3006    5                         END ;
      716     3007    4                         ELSE
      717     3008    4                            REQ.DOMIR          = '0'B ;
      718     3009    5                    IF DCT.SQ$~=ADDR(NIL) AND NOT DCT.DP.RELCHAN THEN DO;
      719     3010                            %DEQUEUE(P#=DQH.IO$,Q#=DCT.SQ$);
      720     3017    6                       IF DCT.SQ$=ADDR(NIL) THEN DO;
      721     3018    6                          DCT.SQ$=DCT.DP.BQ$;
      722     3019    6                          DCT.DP.BQ$=ADDR(NIL);
      723     3020    6                          DCT.DP.LEAPERS=0;
      724     3021    6                          DCT.DP.SWP=~DCT.DP.SWP;
      725     3022    6                          DCT.DP.RELCHAN='1'B;
      726     3023    6                          END;
      727     3024    6                       IF DCT.SQ$~=ADDR(NIL) OR DCT.DP.BQ$~=ADDR(NIL) THEN DO;
      728     3025    6                          CALL PMN$COLLECT(DCT.PM,%PM_QUED);
      729     3026    6                          END;
      730     3027    6                       ELSE DO;
      731     3028    6                          CALL PMN$COLLECT(DCT.PM,%PM_BUSY);
      732     3029    6                          END;
      733     3030    5                       DCT.DP.CSEEK=BITBIN(DQH.IO$->REQ.DLA);
      734     3031    5                       CALL NIS$DRIVER(DQH);
      735     3032                            %UNLOCK (G#=SQH.GATE);
      736     3035    5                       END;
      737     3036    5                    ELSE DO ;
      738     3037    5                        CALL RELCHAN ;
      739     3038    5                        DCT.DP.RELCHAN = '0'B ;
      740     3039    5                        CALL NID$DEVSCHEDL ( DCT, %IDLE ) ;
      741     3040    5                        END ;
      742     3041    4                    DCT.DFLG.AUTOERROR='0'B;
      743     3042    4                    IF  COMP
      744     3043    4                    THEN
      745     3044    4                        CALL NIO$COMP ( REQ, NI$EXTST ) ;
      746     3045    4                    ELSE
PL6.E3A0      #002=NID$POSTER File=NID$DISK.:E05TSI                              WED 07/30/97 03:30 Page:84   
      747     3046    4                        ;
      748     3047    4                    RETURN;
      749     3048    4                    END;
      750     3049    3                 NI$EXTST.EXTST=DQH.IOSTATUS$->IOSTAT.EXTST;
              3049                          /* MEANINGFUL FOR IOP/IMX */
      751     3050    3                 CALL RELCHAN;
      752     3051    3                 CALL PMN$COLLECT(DCT.PM,%PM_WAIT);
      753     3052                      %UNLOCK (G#=SQH.GATE);
      754     3055    3                 CALL NID$SCANAQ(SQH);
      755     3056    3               CASE(%MARKER);
      756     3057    3                 DQH$=ADDR(PAR);
      757     3058    3                 CALL NIA$SPURINT(DQH,EL_SPURINT,INTLVL,NI_DBLZERO);
      758     3059    3                 RETURN;
      759     3060    3               CASE(%SPECIAL);
      760     3061    3                 IF ADDR(STATUS)=ADDR(NIL) THEN
      761     3062    3                    RETURN;
      762     3063    3                 DQH$=ADDR(PAR);
      763     3064    3                 SQH$=DQH.SQH$;
      764     3065    4                 DO I=SQH.FDCT TO SQH.FDCT+SQH.NDCT-1;
      765     3066    4                    DCT$=N$DCT$(I);
      766     3067    4                    IF  DCT.DP.MIRROR.FLAG
      767     3068    5                    THEN DO ;
      768     3069    5                        MDCTX = DCT.DP.MIRROR.DCTX ;
      769     3070    5                        MDCT$ = N$DCT$(MDCTX) ;
      770     3071    5                        END ;
      771     3072    5                    IF DCT.DVN=SPSTAT.DVN AND DCT.TYPE~=%DV_MPC THEN DO;
      772     3073                            %LOCK(G#=SQH.GATE);
      773     3076    5                       DCT.DFLG.AUTOERROR='0'B;
      774     3077    6                       IF DCT.SPSTAT.PRESENCE THEN DO;
      775     3078                               %UNLOCK (G#=SQH.GATE);
      776     3081    6                          END;
      777     3082    6                       ELSE DO;
      778     3083    6                          DCT.SPSTAT=STATUS;
      779     3084    7                          IF DCT.SPSTAT.CODE = '000001'O AND DCT.STATE=%SPWAIT THEN DO;
      780     3085    7                             DCT.STATE=%SUSPENDED;
      781     3086                                  %UNLOCK (G#=SQH.GATE);
      782     3089    8                             IF DCT.MSG#~=0 THEN DO;
PL6.E3A0      #002=NID$POSTER File=NID$DISK.:E05TSI                              WED 07/30/97 03:30 Page:85   
      783     3090    8                                CALL OCI$MK_STTM(DCT.MSG#);
      784     3091    8                                DCT.MSG#=0;
      785     3092    8                                END;
      786     3093    7                             DCT.SPSTAT.PRESENCE='0'B;
      787     3094    7                             CALL NID$DEVSCHED(DCT,%IDLE);
      788     3095    7                             END;
      789     3096    7                          ELSE DO;
      790     3097                                  %UNLOCK (G#=SQH.GATE);
      791     3100    7                             END;
      792     3101    7                          IF  DCT.DP.MIRROR.FLAG THEN DO;
      793     3102    7                             IF DCT.SPSTAT.CODE = '000003'O
      794     3103    7                             AND MDCT.DP.MIRROR.STATE = %NI_MIRROR_OPER
      795     3104    7                             THEN
      796     3105    7                                 ;
      797     3106    8                             ELSE DO ;
      798     3107    8                                IF DCT.SPSTAT.CODE = '000001'O THEN
      799     3108    8                                    DCT.SPSTAT.CODE = '000005'O;
      800     3109    8                                CALL NIO$SPCOMP ( DCT ) ;
      801     3110    8                                END ;
      802     3111    7                             END;
      803     3112    6                          DCT.SPSTAT.PRESENCE='0'B;
      804     3113    6                          END;
      805     3114    5                       RETURN;
      806     3115    5                       END /* IF STATUS.DVN */;
      807     3116    4                    END /* DO I */;
      808     3117    3                 CALL NIA$SPURINT(DQH,EL_SPURINT,INTLVL,STATUS); /* DEVICE NOT FOUND */
      809     3118    3                 RETURN;
      810     3119    3               CASE(%REPOST);
      811     3120    3                 REQ$=ADDR(PAR);
      812     3121    3                 DCT$=REQ.DCT$;
      813     3122    3                 IF  DCT.DP.MIRROR.FLAG
      814     3123    4                 THEN DO ;
      815     3124    4                     MDCTX = DCT.DP.MIRROR.DCTX ;
      816     3125    4                     MDCT$ = N$DCT$(MDCTX) ;
      817     3126    4                     END ;
      818     3127    3                 SQH$=DCT.SQH$;
      819     3128    3                 DQH$=DCT.DQH$;            /* FOR REFERENCE ONLY! */
PL6.E3A0      #002=NID$POSTER File=NID$DISK.:E05TSI                              WED 07/30/97 03:30 Page:86   
      820     3129    3                 NI$EXTST.EXTST='0'B;
      821     3130    3               CASE(ELSE);
      822     3131    3                 CALL SC_NIDBADINTLVL;
      823     3132        /*S* SCREECH_CODE: NID-S$BADINTLVL-5
      824     3133             TYPE: SNAP
      825     3134             MESSAGE: Invalid interrupt level.
      826     3135        */
      827     3136    3                 RETURN;
      828     3137    3               END /* CASE INTLVL */;
      829     3138    2              END /* INHIBIT */;
      830     3139    1           REQ.TYC='0'B;
      831     3140    1           RCVR='0'B;
      832     3141    1           NEWSTATE=%IDLE;
      833     3142    1           RESTORE$=ADDR(NIL);
      834     3143    1           EXTST$=ADDR(NIL);
      835     3144    1           IF  REQ.COMP = %COMP_MIRROR
      836     3145    1           AND NOT DCT.DP.MIRROR.FLAG
      837     3146    1           THEN
      838     3147    1               REQ.COMP = %COMP_REG;
      839     3148    2           IF REQ.FC~=%N_RQSTAT AND REQ.COMP~=%COMP_TD THEN DO;
      840     3149    3              IF REQ.STATUS.POWEROFF THEN DO;
      841     3150    3                 REQ.TYC.IOERR='1'B;
      842     3151    3                 RCVR=%(RCVR_RETRY|RCVR_LOG);
      843     3152    3                 IF  HW_IMX
      844     3153    3                 AND DCT.CTYP = %C_IPC
      845     3154    4                 THEN  DO ;
      846     3155    4                     DQH.MPC$->DCT.DFLG.MPCSTOP = '0'B ;
      847     3156    4                     DQH.MPC$->DCT.DFLG.RELOAD  = '0'B ;
      848     3157    4                     CALL NIW$MPCSTOP ( DQH.MPC$->DCT ) ;
      849     3158    4                     CALL NIK$OPMSG ( DCT, POWEROFF_MSG#, M_DISK, %KIWAIT, REQ ) ;
      850     3159    4                     END ;
      851     3160    4                 ELSE  DO ;
      852     3161    4                     CALL NIW$LDFW ( DQH.MPC$->DCT, '0'B ) ;
      853     3162    4                     END ;
      854     3163    3                 END;
      855     3164    3              ELSE DO CASE(REQ.STATUS.MAJOR);
      856     3165    3               CASE(%READY);
PL6.E3A0      #002=NID$POSTER File=NID$DISK.:E05TSI                              WED 07/30/97 03:30 Page:87   
      857     3166    4                 IF REQ.STATUS.IOM THEN DO;
      858     3167    4                    CALL NIF$ANIOM(REQ,RCVR.RETRY) ALTRET(IOM_ALT);
      859     3168    5                    DO NEVER;
      860     3169    5   IOM_ALT:            NEWSTATE=%KIWAIT;
      861     3170    5                       END;
      862     3171    4                    END;
      863     3172    4                 ELSE DO;
      864     3173    4                    CALL CHECKMINOR(READY_STAT);
      865     3174    4                    END;
      866     3175    3               CASE(%DEVICE_BUSY);         /* '01'O */
      867     3176    3                 REQ.TYC.IOERR='1'B;
      868     3177    3                 RCVR = %( RCVR_RESTORE | RCVR_RETRY | RCVR_LOG ) ;
      869     3178    3                 IF  DCT.FIPS
      870     3179    3                 AND  REQ.STATUS.MINOR = '40'O
      871     3180    3                 THEN  /* Alternate Channel in Control */
      872     3181    3                     IF  REQ.ERRCT < 12
      873     3182    3                     THEN
      874     3183    3                     /*  NEWSTATE = %IDLE  */ ;
      875     3184    3                     ELSE
      876     3185    3                         NEWSTATE = %SPWAIT ;
      877     3186    3                 ELSE
      878     3187    3                     NEWSTATE = %KIWAIT ;
      879     3188    3               CASE(%ATTENTION);           /* '02'O */
      880     3189    3                 CALL CHECKMINOR(ATT_STAT);
      881     3190    3               CASE(%DATA_ALERT);          /* '03'O */
      882     3191    3                 CALL CHECKMINOR(DAL_STAT);
      883     3192    3               CASE(%END_OF_FILE,%COMMAND_REJECT); /* '04'O, '05'O */
      884     3193    3                 RCVR=%(RCVR_RETRY|RCVR_LOG|RCVR_EXTST);
      885     3194    3                 REQ.TYC.IOERR='1'B;
      886     3195    3               CASE(%LOST_INTERRUPT);      /* '10'O */
      887     3196    3                 REQ.TYC.TIMO='1'B;
      888     3197    3                 RCVR=%(RCVR_RETRY|RCVR_LOG);
      889     3198    3                 REQ.STATUS.NCP=7;         /* DONT CALC ARS IN COMP */
      890     3199    3                 REQ.ARSIZE=0;
      891     3200    3               CASE(%MPC_ATTENTION);       /* '12'O */
      892     3201    3                 REQ.TYC.IOERR='1'B;
      893     3202    3                 IF DCT.FIPS AND REQ.STATUS.MINOR='16'O THEN /* SD OFFLINE */
PL6.E3A0      #002=NID$POSTER File=NID$DISK.:E05TSI                              WED 07/30/97 03:30 Page:88   
      894     3203    3                    CALL NIS$MASK(DQH,%IMX_CCW_MASK_CHAN);
      895     3204    3                 IF DCT.FIPS AND (REQ.STATUS.MINOR='17'O OR /* CHAN WRITE ERR */
      896     3205    4                   REQ.STATUS.MINOR='13'O) THEN DO; /* UNEXPECTED INTERRUPT */
      897     3206    4                    RCVR=%(RCVR_RETRY|RCVR_LOG|RCVR_EXTST);
      898     3207    4                    END;
      899     3208    4                 ELSE DO;
      900     3209    4                    NEWSTATE=%KIWAIT;
      901     3210    4                    RCVR=%(RCVR_RETRY|RCVR_LOG);
      902     3211    4                    END;
      903     3212    3               CASE(%MPC_DATA_ALERT);      /* '13'O */
      904     3213    3                 REQ.TYC.IOERR='1'B;
      905     3214    3                 RCVR=%(RCVR_RETRY|RCVR_LOG);
      906     3215    3               CASE(%MPC_COMMAND_REJECT);  /* '15'O */
      907     3216    3                 REQ.TYC.IOERR='1'B;
      908     3217    3                 RCVR=%(RCVR_RETRY|RCVR_LOG);
      909     3218    3                 IF REQ.STATUS.MINOR='03'O AND REQ.ERRCT>8 THEN
      910     3219    3                    NEWSTATE=%KIWAIT;
      911     3220    3               CASE(%SYSTEM_FAULT);
      912     3221    3                 CALL NIF$ANFAULT(REQ,RCVR.RETRY) ALTRET(FLT_ALT);
      913     3222    4                 DO NEVER;
      914     3223    4   FLT_ALT:         NEWSTATE=%KIWAIT;
      915     3224    4                    END;
      916     3225    3                 RCVR.LOG='1'B;
      917     3226    3               CASE(ELSE);
      918     3227    3                 RCVR=%(RCVR_RETRY|RCVR_LOG);
      919     3228    3                 REQ.TYC.IOERR='1'B;
      920     3229    3               END;
      921     3230    2              END;
      922     3231    1           COMP = '1'B ;
      923     3232    2           DO CASE(REQ.COMP);
      924     3233    2            CASE ( %COMP_REG, %COMP_MIRROR ) ;
      925     3234    3              IF RCVR.RETRY AND NOT RCVR.NOINC THEN DO;
      926     3235    3                 REQ.ERRCT=REQ.ERRCT+1;
      927     3236    3                 IF  REQ.ERRCT > 16
      928     3237    4                 THEN DO ;
      929     3238    4                     IF  DCT.DP.MIRROR.FLAG
      930     3239    4                     AND REQ.COMP = %COMP_MIRROR
PL6.E3A0      #002=NID$POSTER File=NID$DISK.:E05TSI                              WED 07/30/97 03:30 Page:89   
      931     3240    5                     THEN DO ;
      932     3241    5                         IF  RCVR.LOG
      933     3242    6                         THEN DO ;
      934     3243    6                             CALL NIA$LOGERR ( REQ, EL_IOERR ) ;
      935     3244    6                             RCVR.LOG = '0'B ;
      936     3245    6                             END ;
      937     3246    5                         IF  REQ.ERR$ ~= ADDR(NIL)
      938     3247    5                         THEN
      939     3248    5                             CALL NIA$RELERR ( REQ ) ;
      940     3249    5                         REQ.ERRCT = 0 ;
      941     3250    5                         REQ.TYC = '0'B ;
      942     3251                              %LOCK    ( G#=SQH.GATE        ) ;
      943     3254                              %REQUEUE ( P#=REQ, Q#=DCT.SQ$ ) ;
      944     3257    5                         CALL TDM$MIRFAIL ( DCT ) ;
      945     3258    5                         CALL NID$DEVSCHED ( DCT, %IDLE ) ;
      946     3259    5                         RETURN ;
      947     3260    5                         END ;
      948     3261    5                     ELSE DO ;
      949     3262    5                         RCVR.RETRY = '0'B ;
      950     3263    5                         RCVR.OPMSG = '1'B ;
      951     3264    5                         END ;
      952     3265    4                     END ;
      953     3266    3                 END;
      954     3267    2              IF RCVR.LOG THEN
      955     3268    2                 CALL NIA$LOGERR(REQ,EL_IOERR);
      956     3269    3              IF REQ.ERR$~=ADDR(NIL) THEN DO;
      957     3270    4                 IF NOT REQ.ERR$->NI$IOERR.GOTEXTST THEN DO;
      958     3271    5                    IF HW_EXT_STATUS THEN DO;
      959     3272    6                       IF NI$EXTST.EXTSTT.WRD(0)~=0 THEN DO;
      960     3273    6                          REQ.ERR$->NI$IOERR.EXTST=NI$EXTST.EXTST;
      961     3274    6                          REQ.ERR$->NI$IOERR.GOTEXTST='1'B;
      962     3275    6                          END;
      963     3276    5                       END;
      964     3277    5                    ELSE IF RCVR.EXTST THEN DO;
      965     3278    5                          CALL NIQ$GET(EXTST$) ALTRET(NOEXTST);
      966     3279    5                          EXTST$->REQ.DLA=REQ.DLA;
      967     3280    5                          EXTST$->REQ.FC=%N_EXTST;
PL6.E3A0      #002=NID$POSTER File=NID$DISK.:E05TSI                              WED 07/30/97 03:30 Page:90   
      968     3281    5                          EXTST$->REQ.BUF$=ADDR(REQ.ERR$->NI$IOERR.EXTST);
      969     3282    5                          EXTST$->REQ.BUFSIZE=SIZEC(NI$IOERR.EXTST);
      970     3283    5                          EXTST$->REQ.OPFLG=OP_BPF;
      971     3284    5                          EXTST$->REQ.COMP=%COMP_IOS;
      972     3285    5                          EXTST$->REQ.BPMIR = '1'B ;
      973     3286    5                          CALL NIO$DCWBLD(EXTST$->REQ) ALTRET(NOEXTST0);
      974     3287    5                          REQ.ERR$->NI$IOERR.GOTEXTST='1'B;
      975     3288    5                          EXTST$->REQ.POSTER=NEWSTATE;
      976     3289    5                          NEWSTATE=%IDLE;
      977     3290    5                          EXTST$->REQ.EAINFOP$=REQ$;
      978     3291    6                          DO NEVER;
      979     3292    6   NOEXTST0:                 CALL NIQ$REL(EXTST$);
      980     3293    6                             EXTST$=ADDR(NIL);
      981     3294    6                             END;
      982     3295    5   NOEXTST:               END;
      983     3296    4                    END;
      984     3297    3                 END;
      985     3298    3              IF RCVR.RESTORE THEN DO;
      986     3299    3                 CALL NIQ$GET(RESTORE$) ALTRET(REPOST);
      987     3300    3                 RESTORE$->REQ.DLA=REQ.DLA;
      988     3301    3                 RESTORE$->REQ.FC=%N_RESTORE;
      989     3302    3                 RESTORE$->REQ.COMP=%COMP_IOS;
      990     3303    3                 RESTORE$->REQ.BPMIR = '1'B ;
      991     3304    3                 CALL NIO$DCWBLD(RESTORE$->REQ) ALTRET(REPOST);
      992     3305    3                 END;
      993     3306                   %LOCK (G#=SQH.GATE);
      994     3309    3              IF RCVR.RETRY THEN DO;
      995     3310                      %REQUEUE (P#=REQ,Q#=DCT.SQ$);
      996     3313    3                 END;
      997     3314    3              IF RESTORE$~=ADDR(NIL) THEN DO;
      998     3315                      %REQUEUE (P#="RESTORE$->REQ",Q#=DCT.SQ$);
      999     3318    3                 END;
     1000     3319    3              IF EXTST$~=ADDR(NIL) THEN DO;
     1001     3320                      %REQUEUE (P#="EXTST$->REQ",Q#=DCT.SQ$);
     1002     3323    3                 END;
     1003     3324    2              IF  NOT RCVR.RETRY
     1004     3325    2              AND REQ.COMP = %COMP_MIRROR
PL6.E3A0      #002=NID$POSTER File=NID$DISK.:E05TSI                              WED 07/30/97 03:30 Page:91   
     1005     3326    2              AND REQ.DOMIR
     1006     3327    3              THEN DO ;
     1007     3328    3                  IF  REQ.ERR$ ~= ADDR(NIL)
     1008     3329    3                  THEN
     1009     3330    3                      CALL NIA$RELERR ( REQ ) ;
     1010     3331    3                  IF  MDCT$ = ADDR(NIL)
     1011     3332    3                  THEN
     1012     3333    3                      CALL SC_NIDINVMIR ;
     1013     3334    3                  REQ.MIRDONE        = '1'B ;
     1014     3335    3                  REQ.DOMIR          = '0'B ;
     1015     3336    3                  REQ.DLA.DCTX       = MDCTX ;
     1016     3337    3                  REQ.DCT$           = MDCT$ ;
     1017     3338    3                  CALL NIO$DCWBLD  ( REQ   ) ;
     1018     3339                       %UNLOCK ( G# = SQH.GATE  ) ;
     1019     3342    3                  CALL NID$REQSCHED  ( REQ ) ;
     1020     3343    3                  COMP = '0'B ;
     1021     3344    3                  END ;
     1022     3345    3              ELSE DO ;
     1023     3346                       %UNLOCK ( G# = SQH.GATE  ) ;
     1024     3349    3                  END ;
     1025     3350    2            CASE(%COMP_IOS);
     1026     3351    2              RCVR='0'B;
     1027     3352    3              IF REQ.FC=%N_EXTST THEN DO;
     1028     3353    3                 NEWSTATE=REQ.POSTER;
     1029     3354    3                 REQ.STATUS=REQ.EAINFOP$->REQ.STATUS; /* PRINT PROPER MESSAGE */
     1030     3355    3                 END;
     1031     3356    2            CASE(%COMP_TD);
     1032     3357    2              RCVR='0'B;
     1033     3358    2              REQ.EAINFO=CHANTIME;
     1034     3359    2              IF REQ.IOFLG.STOPMPC THEN CALL NIW$MPCSTART(DQH.MPC$->DCT);
     1035     3360    2              IF REQ.IOFLG.REL THEN DQH.MPC$->DCT.DFLG.MPCSUSPENDED='0'B;
     1036     3361    2            END;
     1037     3362    1           IF  NEWSTATE ~= %IDLE
     1038     3363    2           THEN DO ;
     1039     3364    2               IF  DCT.DP.MIRROR.FLAG
     1040     3365    2               OR  ( NOT DCT.DP.MIRROR.FLAG
     1041     3366    2                     AND DCT.DP.MIRROR.STATE = %NI_MIRROR_FAIL
PL6.E3A0      #002=NID$POSTER File=NID$DISK.:E05TSI                              WED 07/30/97 03:30 Page:92   
     1042     3367    2                     AND REQ.DLA.DRELADDR    = 0               )
     1043     3368    3               THEN DO ;
     1044     3369    3                   NEWSTATE   = %IDLE ;
     1045     3370    3                   RCVR.OPMSG = '0'B ;
     1046     3371    3                   END ;
     1047     3372    2               END ;
     1048     3373    2           IF NEWSTATE~=%IDLE AND DCT.DFLG.AUTOERROR THEN DO;
     1049     3374    2              REQ.TYC.OPER='1'B;
     1050     3375    2              NEWSTATE=%IDLE;
     1051     3376    2              RCVR.OPMSG='0'B;
     1052     3377    2              END;
     1053     3378    2           IF NEWSTATE~=%IDLE OR RCVR.OPMSG THEN DO;
     1054     3379    2              CALL NIK$OPMSG(DCT,DP_MSG#,M_DISK,NEWSTATE,REQ);
     1055     3380    2              END;
     1056     3381    1           CALL NID$DEVSCHED(DCT,NEWSTATE);
     1057     3382    1           IF  COMP
     1058     3383    1           AND NOT RCVR.RETRY
     1059     3384    1           THEN
     1060     3385    1               CALL NIO$COMP ( REQ, NI$EXTST ) ;
     1061     3386    1           RETURN;
     1062     3387        /**/
     1063     3388    1   REPOST:
     1064     3389    2           IF  EXTST$ ~= ADDR(NIL)  THEN DO ;
     1065     3390    2               EXTST$->REQ.IOQFLG.IOQUED = '0'B ;
     1066     3391    2               CALL NIQ$REL ( EXTST$ ) ;
     1067     3392    2               END ;
     1068     3393    2           IF  RESTORE$ ~= ADDR(NIL)  THEN DO ;
     1069     3394    2               RESTORE$->REQ.IOQFLG.IOQUED = '0'B ;
     1070     3395    2               CALL NIQ$REL ( RESTORE$ ) ;
     1071     3396    2               END ;
     1072     3397                %LOCK (G#=NI$RP.GATE);
     1073     3400                %ENQUEUE (Q#=NI$RP.RP$,P#=REQ);
     1074     3403                %UNLOCK (G#=NI$RP.GATE);
     1075     3406    1           CALL NID$DEVSCHED(DCT,%SUSPENDED);
     1076     3407    1           RETURN;
     1077     3408        %EJECT;
PL6.E3A0      #002=NID$POSTER File=NID$DISK.:E05TSI                              WED 07/30/97 03:30 Page:93   
     1078     3409    1   CHECKMINOR: PROC(TBL);
     1079     3410        /**/
     1080     3411        /* SET RCVR, TYC AND NEWSTATE BASED ON MINOR STATUS BITS. */
     1081     3412        /**/
     1082     3413    2   DCL 1 TBL ALIGNED,
     1083     3414    2         2 TYC(0:6) BIT(36),
     1084     3415    2         2 RCVR(0:6) BIT(36),
     1085     3416    2         2 STATE(0:6) UBIN;
     1086     3417    2   DCL I UBIN;
     1087     3418    2   DCL 1 MNSTAT ALIGNED,
     1088     3419    2         2 BT(0:5) BIT(1);
     1089     3420        /**/
     1090     3421        /**/
     1091     3422        /**/
     1092     3423    3           IF REQ.STATUS.MINOR='0'B THEN DO;
     1093     3424    3              REQ.TYC=TBL.TYC(0);
     1094     3425    3              RCVR=TBL.RCVR(0);
     1095     3426    3              NEWSTATE=TBL.STATE(0);
     1096     3427    3              END;
     1097     3428    3           ELSE DO;
     1098     3429    3              MNSTAT=REQ.STATUS.MINOR;
     1099     3430    4              DO I=0 TO 5;
     1100     3431    5                 IF MNSTAT.BT(I) THEN DO;
     1101     3432    5                    REQ.TYC=REQ.TYC|TBL.TYC(I+1);
     1102     3433    5                    RCVR=RCVR|TBL.RCVR(I+1);
     1103     3434    5                    IF NEWSTATE<TBL.STATE(I+1) THEN NEWSTATE=TBL.STATE(I+1);
     1104     3435    5                    END;
     1105     3436    4                 END;
     1106     3437    3              END;
     1107     3438    2           RETURN;
     1108     3439    2   END CHECKMINOR;
     1109     3440        %EJECT;
PL6.E3A0      #002=NID$POSTER File=NID$DISK.:E05TSI                              WED 07/30/97 03:30 Page:94   
     1110     3441    1   RELCHAN: PROC;
     1111     3442    2           DQH.STATE=%IDLE;
     1112     3443    3           IF DQH.CHANSTATE THEN DO;
     1113     3444    4              IF DQH.CHANSTATE.STOP THEN DO;
     1114     3445                      %UNLOCK (G#=SQH.GATE);
     1115     3448    4                 CALL NIW$MPCSTOP(DQH.MPC$->DCT);
     1116     3449                      %LOCK (G#=SQH.GATE);
     1117     3452    4                 END;
     1118     3453    3              END;
     1119     3454    3           ELSE IF NOT DQH.STATUS.DOWN THEN DO;
     1120     3455                      %ENQUEUE (P#=DQH,Q#=SQH.CQ$);
     1121     3458    3                 END;
     1122     3459    2           RETURN;
     1123     3460    2   END RELCHAN;
     1124     3461    1   END NID$POSTER;

PL6.E3A0      #002=NID$POSTER File=NID$DISK.:E05TSI                              WED 07/30/97 03:30 Page:95   
--  Include file information  --

   PM$NI.:E05TOU  is referenced.
   OC_SUBS_C.:E05TOU  is referenced.
   N_FC_C.:E05TOU  is referenced.
   NI_MACROS_C.:E05TOU  cannot be made into a system file and is referenced.
   NI$TABLES.:E05TOU  is referenced.
   N$REQ.:E05TOU  is referenced.
   NI_DATA_R.:E05TOU  cannot be made into a system file and is referenced.
   NI_DATA_C.:E05TOU  is referenced.
   NI$ERRLOG.:E05TOU  is referenced.
   HF_DATA_R.:E05TOU  cannot be made into a system file and is referenced.
   HF_LOCK_C.:E05TOU  cannot be made into a system file and is referenced.
   EL_SUBS_C.:E05TOU  is referenced.
   CP_6_SUBS.:E05TOU  is referenced.
      No diagnostics issued in procedure NID$POSTER.

   Procedure NID$POSTER requires 1283 words for executable code.
   Procedure NID$POSTER requires 38 words of local(AUTO) storage.

    No errors detected in file NID$DISK.:E05TSI    .

PL6.E3A0      #002=NID$POSTER File=NID$DISK.:E05TSI                              WED 07/30/97 03:30 Page:96   

 Object Unit name= NID$POSTER                                 File name= NID$DISK.:E05TOU
 UTS= JUL 30 '97 03:30:43.80 WED                              Compiler= PL-6/E31         Sev=      00
 SharedLib= :SHARED_SYSTEM                                    Alt SharedLib=


    ****  Control sections  ****

 Sect   Type Bound  Init  Size OctSiz  Section name(segment info)
    0  RoData even  UTS     70    106  NID$POSTER
    1   Proc  even  none  1283   2403  NID$POSTER
    2  RoData even  none    31     37  NID$POSTER

    ****  Entry defs  ****

                              Check   Calling
                             calling  sequence
  Sect OctLoc Primary Altret sequence   type   Parms  Name
     1      0   yes            yes      Std        3  NID$POSTER
PL6.E3A0      #002=NID$POSTER File=NID$DISK.:E05TSI                              WED 07/30/97 03:30 Page:97   

  ****  Entry refs  ****

         Check        Calling
        calling       sequence
Altret sequence SRef   type   Args  Name
         yes           Std       1 HFC$LOCK
         yes           Std       4 NIA$SPURINT
         yes           Std       1 HFC$UNLOCK
         yes           Std       2 NIS$MASK
         yes           Std       2 NIM$REQUEUE
         yes           Std       3 PMN$COLLECT
         yes           Std       1 NIA$RELERR
         yes           Std       2 NID$DEVSCHEDL
         yes           Std       2 TDM$MIRFAIL
 yes     yes           Std       1 NIQ$REL
 yes     yes           Std       2 NIM$DEQUEUE
         yes           Std       1 NIS$DRIVER
         yes           Std       1 NID$SCANAQ
         yes           Std       2 NID$DEVSCHED
         yes           Std       1 OCI$MK_STTM
         yes           Std       1 NIW$MPCSTOP
 yes     yes           Std       1 NIQ$GET
         yes           Std       2 NIO$COMP
         yes           Std       1 NIO$SPCOMP
 yes     yes           Std       2 NIW$LDFW
 yes     yes           Std       3 NIF$ANFAULT
 yes     yes           Std       2 NIF$ANIOM
         yes           Std       1 NIW$MPCSTART
 yes     yes           Std       1 NIO$DCWBLD
         yes           Std       5 NIK$OPMSG
         yes           Std       4 NIA$LOGERR
         yes           Std       1 NID$REQSCHED
         yes           Std       2 NIM$ENQUEUE
                       nStd      0 X66_AUTO_3
                       Std       0 B_CONSPOOL_D
                       nStd      0 X66_ARET
PL6.E3A0      #002=NID$POSTER File=NID$DISK.:E05TSI                              WED 07/30/97 03:30 Page:98   

  ****  Data refs  ****

  Flags:  r = read only, s = secondary
Flgs Name                             Flgs Name                             Flgs Name
     SC_NIDINVMIR                          SC_NIDBADINTLVL                       HW_IOP
     HW_EXT_STATUS                         HW_IMX                                N$DCT$$
     N$FQ$                                 NI$FQ$                                NI$IBUF$
     NI$RP$                                NI_DBLZERO                            B_VECTNIL

  ****  Segment refs  ****

  Flags:  r = read only, s = secondary
Flgs Name                             Flgs Name                             Flgs Name
     ASLENTSID                             ISSID
PL6.E3A0      #002=NID$POSTER File=NID$DISK.:E05TSI                              WED 07/30/97 03:30 Page:99   


      456        1        /*T***********************************************************/
      457        2        /*T*                                                         */
      458        3        /*T* Copyright (c) Bull HN Information Systems Inc., 1997    */
      459        4        /*T*                                                         */
      460        5        /*T***********************************************************/
      461        6        /*D*    NAME:    NID$POSTER
      462        7
      463        8                CALL:    CALL NID$POSTER(PAR,INTLVL,STATUS)
      464        9
      465       10                INPUT:   PAR - If INTLVL = 0, 1, 2, 3, or 4 then PAR is DQH.
      466       11                               If INTLVL = 5 then PAR is DCT.
      467       12                         INTLVL - Interrupt level.
      468       13                                     0 = Overhead
      469       14                                     1 = Terminate
      470       15                                     2 = Marker (unused)
      471       16                                     3 = Special
      472       17                                     4 = Time out (software)
      473       18                                     5 = Repost (software)
      474       19                         STATUS - Status if INTLVL = 0, 3 or 4.  Otherwise
      475       20                                  status is in NI$REQ.STATUS.
      476       21
      477       22                DESCRIPTION:   NID$POSTER handles disk I/O completions and
      478       23                               special interrupts.  It is called from
      479       24                               NIM$INTDIS, NIF$FAULT and NII$LIP.  Appropriate
      480       25                               action is taken based on INTLVL and the
      481       26                               status.
      482       27
      483       28                               INTLVL = 1 is the normal completion entry with
      484       29                               values of 0, 4 and 5 being special cases.  If
      485       30                               the status is normal completion then a fast
      486       31                               path is taken which reschedules the device and
      487       32                               reports the I/O completion on the request.
      488       33                               Otherwise a appropriate recovery action is taken
      489       34                               based on the status.
      490       35
      491       36                               INTLVL = 3 is the special interrupt entry.  If
PL6.E3A0      #002=NID$POSTER File=NID$DISK.:E05TSI                              WED 07/30/97 03:30 Page:100  
      492       37                               the special status says "Device ready" and the
      493       38                               current device state is SPWAIT then the device
      494       39                               is restarted.  Otherwise the special interrupt
      495       40                               is reported to whoever has special interrupt
      496       41                               control for this device.
      497       42                                                                           */
      498       43        NID$POSTER: PROC (PAR,INTLVL,STATUS);

     43  1 000000   000000 700200 xent  NID$POSTER   TSX0  ! X66_AUTO_3
         1 000001   000046 000003                    ZERO    38,3

      499       44        /*
      500       45                Includes
      501       46        */
      502       47        %INCLUDE                CP_6_SUBS ;
      503      587        %INCLUDE                EL_SUBS_C ;
      504      671        %INCLUDE                HF_LOCK_C ;
      505      685        %INCLUDE                HF_DATA_R ;
      506      728        %INCLUDE                NI$ERRLOG ;
      507      794        %INCLUDE                NI_DATA_C ;
      508      907        %INCLUDE                NI_DATA_R ;
      509     1344        %INCLUDE                NI_MACROS_C ;
      510     1611        %INCLUDE                N_FC_C ;
      511     1648        %INCLUDE                OC_SUBS_C ;
      512     2379        %INCLUDE                PM$NI ;
      513     2403        /*
      514     2404                Parameters
      515     2405        */
      516     2406    1   DCL 1 INTLVL            UBIN(18) PARAM ;
      517     2407    1   DCL 1 PAR               PTR PARAM ;
      518     2408        %STATUS                 ( NAME=STATUS, STCLASS=PARAM ) ;
      519     2475        /*
      520     2476                Entries
      521     2477        */
      522     2478    1   DCL 1 FMN$AVR           ENTRY(2) ;
      523     2479    1   DCL 1 NIA$LOGERR        ENTRY(4) ;
      524     2480    1   DCL 1 NIA$RELERR        ENTRY(1) ;
PL6.E3A0      #002=NID$POSTER File=NID$DISK.:E05TSI                              WED 07/30/97 03:30 Page:101  
      525     2481    1   DCL 1 NIA$SPURINT       ENTRY(4) ;
      526     2482    1   DCL 1 NID$DEVSCHED      ENTRY(2) ;
      527     2483    1   DCL 1 NID$DEVSCHEDL     ENTRY(2) ;
      528     2484    1   DCL 1 NID$REQSCHED      ENTRY(1) ;
      529     2485    1   DCL 1 NID$REQSCHEDL     ENTRY(1) ;
      530     2486    1   DCL 1 NID$SCANAQ        ENTRY(1) ;
      531     2487    1   DCL 1 NIF$ANFAULT       ENTRY(3) ALTRET ;
      532     2488    1   DCL 1 NIF$ANIOM         ENTRY(2) ALTRET ;
      533     2489    1   DCL 1 NIK$OPMSG         ENTRY(5) ;
      534     2490    1   DCL 1 NIM$CVTPTR        ENTRY(3) ;
      535     2491    1   DCL 1 NIO$DCWBLD        ENTRY(1) ALTRET ;
      536     2492    1   DCL 1 NIO$COMP          ENTRY(2) ;
      537     2493    1   DCL 1 NIO$SPCOMP        ENTRY(1) ;
      538     2494    1   DCL 1 NIQ$GET           ENTRY(1) ALTRET ;
      539     2495    1   DCL 1 NIQ$REL           ENTRY(1) ALTRET ;
      540     2496    1   DCL 1 NIS$DRIVER        ENTRY(1) ;
      541     2497    1   DCL 1 NIS$MASK          ENTRY(2) ;
      542     2498    1   DCL 1 NIW$LDFW          ENTRY(2) ALTRET ;
      543     2499    1   DCL 1 NIW$MPCSTART      ENTRY(1) ;
      544     2500    1   DCL 1 NIW$MPCSTOP       ENTRY(1) ;
      545     2501    1   DCL 1 OCI$MK_STTM       ENTRY(1) ;
      546     2502    1   DCL 1 PMN$COLLECT       ENTRY(3) ;
      547     2503    1   DCL 1 SC_NIDBADINTLVL   ENTRY CONV(2,0) ;
      548     2504    1   DCL 1 SC_NIDINVMIR      ENTRY CONV(2,0) ;
      549     2505    1   DCL 1 SC_NIDNOPMIR      ENTRY CONV(2,0) ;
      550     2506    1   DCL 1 TDM$MIRFAIL       ENTRY(2) ;
      551     2507        /*
      552     2508                Auto
      553     2509        */
      554     2510    1   DCL 1 CHANTIME          UBIN WORD ALIGNED AUTO ;
      555     2511    1   DCL 1 COMP              BIT(1) ALIGNED AUTO ;
      556     2512    1   DCL 1 DCT$              PTR ALIGNED AUTO ;
      557     2513    1   DCL 1 DQH$              PTR ALIGNED AUTO ;
      558     2514    1   DCL 1 EXTST$            PTR ALIGNED AUTO ;
      559     2515    1   DCL 1 I                 SBIN WORD ALIGNED AUTO ;
      560     2516    1   DCL 1 MDCT$             PTR ALIGNED AUTO ;
      561     2517    1   DCL 1 MDCTX             UBIN WORD ALIGNED AUTO ;
PL6.E3A0      #002=NID$POSTER File=NID$DISK.:E05TSI                              WED 07/30/97 03:30 Page:102  
      562     2518    1   DCL 1 NEWSTATE          UBIN WORD ALIGNED AUTO ;
      563     2519        %NI$EXTST               ( NAME=NI$EXTST, STCLASS=AUTO ) ;
      564     2553    1   DCL 1 REQ$              PTR ALIGNED AUTO ;
      565     2554    1   DCL 1 RESTORE$          PTR ALIGNED AUTO ;
      566     2555    1   DCL 1 RCVR              ALIGNED AUTO,
      567     2556    1         2 RETRY           BIT(1),
      568     2557    1         2 NOINC           BIT(1),
      569     2558    1         2 LOG             BIT(1),
      570     2559    1         2 RESTORE         BIT(1),
      571     2560    1         2 EXTST           BIT(1),
      572     2561    1         2 OPMSG           BIT(1),
      573     2562    1         2 *               BIT(30) ;
      574     2563    1   DCL 1 SQH$              PTR ALIGNED AUTO ;
      575     2564        /*
      576     2565                Based
      577     2566        */
      578     2567        %NI$DCT                 ( NAME=DCT,       STCLASS="BASED(DCT$)" ) ;
      579     2615        %NI$DQH                 ( NAME=DQH,       STCLASS="BASED(DQH$)" ) ;
      580     2638        %NI$IOM                 ( NAME=IOM,       STCLASS=BASED ) ;
      581     2643        %NI$IOSTAT              ( NAME=IOSTAT,    STCLASS=BASED ) ;
      582     2652        %NI$MBX                 ( NAME=MBX,       STCLASS=BASED ) ;
      583     2671        %NI$DCT                 ( NAME=MDCT,      STCLASS="BASED(MDCT$)" ) ;
      584     2719        %NI$IOERR               ( NAME=NI$IOERR,  STCLASS=BASED ) ;
      585     2773        %N$REQ                  ( NAME=REQ,       STCLASS="BASED(REQ$)" ) ;
      586     2831        %NI$REQ                 ( NAME=IOS,       STCLASS=BASED ) ;
      587     2856        %NI$SQH                 ( NAME=SQH,       STCLASS="BASED(SQH$)" ) ;
      588     2869        /*
      589     2870                Constants
      590     2871        */
      591     2872        %EQU RCVR_RETRY='400000000000'O;
      592     2873        %EQU RCVR_NOINC='200000000000'O;
      593     2874        %EQU RCVR_LOG='100000000000'O;
      594     2875        %EQU RCVR_RESTORE='040000000000'O;
      595     2876        %EQU RCVR_EXTST='020000000000'O;
      596     2877        %EQU RCVR_OPMSG='010000000000'O;
      597     2878        /**/
      598     2879        /* READY STATUS */
PL6.E3A0      #002=NID$POSTER File=NID$DISK.:E05TSI                              WED 07/30/97 03:30 Page:103  
      599     2880        /**/
      600     2881    1   DCL 1 READY_STAT CONSTANT ALIGNED,
      601     2882    1         2 TYC(0:6) BIT(36) INIT('0'B*3,%TYC_IOERR,'0'B*3),
      602     2883    1         2 RCVR(0:6) BIT(36) INIT('0'B,%RCVR_LOG*2,
      603     2884    1                                  %(RCVR_LOG|RCVR_RETRY),
      604     2885    1                                  %RCVR_LOG*3),
      605     2886    1         2 STATE(0:6) UBIN INIT(%IDLE*7);
      606     2887        /**/
      607     2888        /* ATTENTION STATUS */
      608     2889        /**/
      609     2890    1   DCL 1 ATT_STAT CONSTANT ALIGNED,        /* ATTENTION = '02'O */
      610     2891    1         2 TYC(0:6) BIT(36) INIT(%TYC_IOERR*6,%TYC_PROT),
      611     2892    1         2 RCVR(0:6) BIT(36) INIT(%(RCVR_RETRY|RCVR_LOG|RCVR_EXTST),
      612     2893    1        %(RCVR_RETRY|RCVR_LOG|RCVR_EXTST), /* DEV OFFLINE */
      613     2894    1        %(RCVR_RETRY|RCVR_LOG|RCVR_EXTST), /* DEV IN STANDBY */
      614     2895    1        %(RCVR_RETRY|RCVR_LOG|RCVR_EXTST), /* DEV INOPERABLE */
      615     2896    1                                  %(RCVR_RETRY|RCVR_LOG|RCVR_EXTST),
      616     2897    1   %(RCVR_RETRY|RCVR_LOG|RCVR_RESTORE|RCVR_EXTST), /* SEEK INCOMPLETE */
      617     2898    1       %(RCVR_RETRY|RCVR_LOG|RCVR_EXTST)), /* WRITE INHIBIT */
      618     2899    1         2 STATE(0:6) UBIN INIT(%SPWAIT*7);
      619     2900        /**/
      620     2901        /* DATA ALERT STATUS */
      621     2902        /**/
      622     2903    1   DCL 1 DAL_STAT CONSTANT ALIGNED,        /* DATA ALERT = '03'O */
      623     2904    1         2 TYC(0:6) BIT(36) INIT(%TYC_IOERR, '0'B, %TYC_IOERR*5),
      624     2905    1         2 RCVR(0:6) BIT(36) INIT(%(RCVR_RETRY|RCVR_LOG|RCVR_EXTST),
      625     2906    1                                  '0'B,    /* DATA VERIFY ALERT */
      626     2907    1        %(RCVR_RETRY|RCVR_LOG|RCVR_EXTST), /* CHECK CHAR ALERT */
      627     2908    1   %(RCVR_RETRY|RCVR_LOG|RCVR_RESTORE|RCVR_EXTST), /* HDR VERIFY FAIL */
      628     2909    1        %(RCVR_RETRY|RCVR_LOG|RCVR_EXTST), /* INVALID SEEK ADDR */
      629     2910    1        %(RCVR_RETRY|RCVR_LOG|RCVR_EXTST), /* TRANS PARITY ALERT */
      630     2911    1       %(RCVR_RETRY|RCVR_LOG|RCVR_EXTST)), /* TRANS TIMING ALERT */
      631     2912    1         2 STATE(0:6) UBIN INIT(%IDLE*7);
      632     2913        /**/
      633     2914    1   DCL CHECKBITS BIT(72) CONSTANT DALIGNED INIT('37770077'O);
      634     2915        %SUB FOREVER="WHILE('1'B)";
      635     2916        %SUB NEVER="WHILE('0'B)";
PL6.E3A0      #002=NID$POSTER File=NID$DISK.:E05TSI                              WED 07/30/97 03:30 Page:104  
      636     2917        %EJECT;
PL6.E3A0      #002=NID$POSTER File=NID$DISK.:E05TSI                              WED 07/30/97 03:30 Page:105  
      637     2918    2           DO INHIBIT;

      638     2919    2              MDCTX = 0 ;

   2919  1 000002   200015 450300                    STZ   ! MDCTX,,AUTO

      639     2920    2              MDCT$ = ADDR(NIL) ;

   2920  1 000003   000001 236200 xsym               LDQ   ! B_VECTNIL+1
         1 000004   200014 756300                    STQ   ! MDCT$,,AUTO

      640     2921    3              DO CASE(INTLVL);

   2921  1 000005   200004 470700                    LDP0  ! @INTLVL,,AUTO
         1 000006   000000 220300                    LDX0  ! 0,,PR0
         1 000007   000006 100203                    CMPX0 ! 6,DU
         1 000010   000012 602210 1                  TNC   ! s:2921+5,X0
         1 000011   001007 710200 1                  TRA   ! s:3131
         1 000012   000020 710200 1                  TRA   ! s:2923
         1 000013   000020 710200 1                  TRA   ! s:2923
         1 000014   000530 710200 1                  TRA   ! s:3057
         1 000015   000545 710200 1                  TRA   ! s:3061
         1 000016   000020 710200 1                  TRA   ! s:2923
         1 000017   000761 710200 1                  TRA   ! s:3120

      641     2922    3               CASE(%OVERHEAD,%TERMINATE,%LOST);

      642     2923    3                 DQH$=ADDR(PAR);

   2923  1 000020   200003 236300                    LDQ   ! @PAR,,AUTO
         1 000021   200011 756300                    STQ   ! DQH$,,AUTO

      643     2924    3                 SQH$=DQH.SQH$;

   2924  1 000022   200011 471700                    LDP1  ! DQH$,,AUTO
         1 000023   100013 236300                    LDQ   ! 11,,PR1
         1 000024   200032 756300                    STQ   ! SQH$,,AUTO
PL6.E3A0      #002=NID$POSTER File=NID$DISK.:E05TSI                              WED 07/30/97 03:30 Page:106  

      644     2925                      %LOCK (G#=SQH.GATE);

   2926  1 000025   200032 630700                    EPPR0 ! SQH$,,AUTO
         1 000026   000017 631600 xsym               EPPR1 ! B_VECTNIL+15
         1 000027   000000 701200 xent               TSX1  ! HFC$LOCK
         1 000030   000000 011200                    NOP   ! 0

      645     2928    3                 IF  DQH.STATE ~= %BUSY

   2928  1 000031   200011 470700                    LDP0  ! DQH$,,AUTO
         1 000032   000001 236300                    LDQ   ! 1,,PR0
         1 000033   000077 376207                    ANQ   ! 63,DL
         1 000034   000005 116207                    CMPQ  ! 5,DL
         1 000035   000115 600200 1                  TZE   ! s:2944

      646     2929    4                 THEN DO ;

      647     2930    4                     IF  ADDR(STATUS) ~= ADDR(NIL)

   2930  1 000036   200005 236300                    LDQ   ! @STATUS,,AUTO
         1 000037   000001 116200 xsym               CMPQ  ! B_VECTNIL+1
         1 000040   000053 600200 1                  TZE   ! s:2933

      648     2931    4                     THEN
      649     2932    4                         CALL NIA$SPURINT ( DQH, EL_SPURINT, INTLVL, STATUS ) ;

   2932  1 000041   200004 237300                    LDAQ  ! @INTLVL,,AUTO
         1 000042   200042 757300                    STAQ  ! MNSTAT+3,,AUTO
         1 000043   000001 236200 2                  LDQ   ! 1
         1 000044   200011 235300                    LDA   ! DQH$,,AUTO
         1 000045   200040 757300                    STAQ  ! MNSTAT+1,,AUTO
         1 000046   200040 630700                    EPPR0 ! MNSTAT+1,,AUTO
         1 000047   000022 631600 xsym               EPPR1 ! B_VECTNIL+18
         1 000050   000000 701200 xent               TSX1  ! NIA$SPURINT
         1 000051   000000 011200                    NOP   ! 0
         1 000052   000110 710200 1                  TRA   ! s:2940
PL6.E3A0      #002=NID$POSTER File=NID$DISK.:E05TSI                              WED 07/30/97 03:30 Page:107  

      650     2933    4                     ELSE IF  INTLVL = %TERMINATE

   2933  1 000053   200004 471700                    LDP1  ! @INTLVL,,AUTO
         1 000054   100000 220300                    LDX0  ! 0,,PR1
         1 000055   000001 100203                    CMPX0 ! 1,DU
         1 000056   000076 601200 1                  TNZ   ! s:2938
         1 000057   000016 236300                    LDQ   ! 14,,PR0
         1 000060   000001 116200 xsym               CMPQ  ! B_VECTNIL+1
         1 000061   000076 600200 1                  TZE   ! s:2938

      651     2934    4                          AND DQH.IOSTATUS$ ~= ADDR(NIL)
      652     2935    4                     THEN
      653     2936    4                         CALL NIA$SPURINT ( DQH, EL_SPURINT, INTLVL, DQH.IOSTATUS$->
              2936                                  IOSTAT.STATUS ) ;

   2936  1 000062   000016 473700                    LDP3  ! 14,,PR0
         1 000063   200043 453700                    STP3  ! MNSTAT+4,,AUTO
         1 000064   200004 236300                    LDQ   ! @INTLVL,,AUTO
         1 000065   200042 756300                    STQ   ! MNSTAT+3,,AUTO
         1 000066   000001 236200 2                  LDQ   ! 1
         1 000067   200011 235300                    LDA   ! DQH$,,AUTO
         1 000070   200040 757300                    STAQ  ! MNSTAT+1,,AUTO
         1 000071   200040 630700                    EPPR0 ! MNSTAT+1,,AUTO
         1 000072   000022 631600 xsym               EPPR1 ! B_VECTNIL+18
         1 000073   000000 701200 xent               TSX1  ! NIA$SPURINT
         1 000074   000000 011200                    NOP   ! 0
         1 000075   000110 710200 1                  TRA   ! s:2940

      654     2937    4                     ELSE
      655     2938    4                         CALL NIA$SPURINT ( DQH, EL_SPURINT, INTLVL, NI_DBLZERO ) ;

   2938  1 000076   000002 236200 2                  LDQ   ! 2
         1 000077   200004 235300                    LDA   ! @INTLVL,,AUTO
         1 000100   200042 757300                    STAQ  ! MNSTAT+3,,AUTO
         1 000101   000001 236200 2                  LDQ   ! 1
         1 000102   200011 235300                    LDA   ! DQH$,,AUTO
PL6.E3A0      #002=NID$POSTER File=NID$DISK.:E05TSI                              WED 07/30/97 03:30 Page:108  
         1 000103   200040 757300                    STAQ  ! MNSTAT+1,,AUTO
         1 000104   200040 630700                    EPPR0 ! MNSTAT+1,,AUTO
         1 000105   000022 631600 xsym               EPPR1 ! B_VECTNIL+18
         1 000106   000000 701200 xent               TSX1  ! NIA$SPURINT
         1 000107   000000 011200                    NOP   ! 0

      656     2939                          %UNLOCK ( G#=SQH.GATE ) ;

   2940  1 000110   200032 630700                    EPPR0 ! SQH$,,AUTO
         1 000111   000017 631600 xsym               EPPR1 ! B_VECTNIL+15
         1 000112   000000 701200 xent               TSX1  ! HFC$UNLOCK
         1 000113   000000 011200                    NOP   ! 0

      657     2942    4                     RETURN;

   2942  1 000114   000000 702200 xent               TSX2  ! X66_ARET

      658     2943    4                     END;
      659     2944    3                 REQ$=DQH.IO$;

   2944  1 000115   000014 236300                    LDQ   ! 12,,PR0
         1 000116   200027 756300                    STQ   ! REQ$,,AUTO

      660     2945    3                 DCT$=REQ.DCT$;

   2945  1 000117   200027 471700                    LDP1  ! REQ$,,AUTO
         1 000120   100002 236300                    LDQ   ! 2,,PR1
         1 000121   200010 756300                    STQ   ! DCT$,,AUTO

      661     2946    3                 IF  DCT.DP.MIRROR.FLAG

   2946  1 000122   200010 473700                    LDP3  ! DCT$,,AUTO
         1 000123   300036 234300                    SZN   ! 30,,PR3
         1 000124   000133 605200 1                  TPL   ! s:2951

      662     2947    4                 THEN DO ;

PL6.E3A0      #002=NID$POSTER File=NID$DISK.:E05TSI                              WED 07/30/97 03:30 Page:109  
      663     2948    4                     MDCTX = DCT.DP.MIRROR.DCTX ;

   2948  1 000125   300037 236300                    LDQ   ! 31,,PR3
         1 000126   000022 772200                    QRL   ! 18
         1 000127   200015 756300                    STQ   ! MDCTX,,AUTO

      664     2949    4                     MDCT$ = N$DCT$(MDCTX) ;

   2949  1 000130   000000 474600 xsym               LDP4  ! N$DCT$$
         1 000131   400000 236306                    LDQ   ! 0,QL,PR4
         1 000132   200014 756300                    STQ   ! MDCT$,,AUTO

      665     2950    4                     END ;

      666     2951    3                 CALL PMN$COLLECT(DQH.PM,%PM_IDLE,CHANTIME);

   2951  1 000133   200006 634700                    EPPR4 ! CHANTIME,,AUTO
         1 000134   200042 454700                    STP4  ! MNSTAT+3,,AUTO
         1 000135   000003 236200 2                  LDQ   ! 3
         1 000136   200041 756300                    STQ   ! MNSTAT+2,,AUTO
         1 000137   200011 236300                    LDQ   ! DQH$,,AUTO
         1 000140   000002 036203                    ADLQ  ! 2,DU
         1 000141   200040 756300                    STQ   ! MNSTAT+1,,AUTO
         1 000142   200040 630700                    EPPR0 ! MNSTAT+1,,AUTO
         1 000143   000021 631600 xsym               EPPR1 ! B_VECTNIL+17
         1 000144   000000 701200 xent               TSX1  ! PMN$COLLECT
         1 000145   000000 011200                    NOP   ! 0

      667     2952    3                 IF HW_IMX THEN

   2952  1 000146   000000 234200 xsym               SZN   ! HW_IMX
         1 000147   000156 605200 1                  TPL   ! s:2955

      668     2953    3                    REQ.FLPW=DQH.IOSTATUS$->IOSTAT.LPW_RESIDUE;

   2953  1 000150   200011 470700                    LDP0  ! DQH$,,AUTO
         1 000151   000016 471700                    LDP1  ! 14,,PR0
PL6.E3A0      #002=NID$POSTER File=NID$DISK.:E05TSI                              WED 07/30/97 03:30 Page:110  
         1 000152   100003 236300                    LDQ   ! 3,,PR1
         1 000153   200027 473700                    LDP3  ! REQ$,,AUTO
         1 000154   300016 756300                    STQ   ! 14,,PR3
         1 000155   000163 710200 1                  TRA   ! s:2956

      669     2954    3                 ELSE
      670     2955    3                    REQ.FLPW=DQH.MBX$->MBX.LPW;

   2955  1 000156   200011 470700                    LDP0  ! DQH$,,AUTO
         1 000157   000021 471700                    LDP1  ! 17,,PR0
         1 000160   100000 236300                    LDQ   ! 0,,PR1
         1 000161   200027 473700                    LDP3  ! REQ$,,AUTO
         1 000162   300016 756300                    STQ   ! 14,,PR3

      671     2956    4                 IF INTLVL=%TERMINATE THEN DO;

   2956  1 000163   200004 471700                    LDP1  ! @INTLVL,,AUTO
         1 000164   100000 220300                    LDX0  ! 0,,PR1
         1 000165   000001 100203                    CMPX0 ! 1,DU
         1 000166   000210 601200 1                  TNZ   ! s:2968

      672     2957    4                    REQ.STATUS=DQH.IOSTATUS$->IOSTAT.STATUS;

   2957  1 000167   000016 474700                    LDP4  ! 14,,PR0
         1 000170   400000 237300                    LDAQ  ! 0,,PR4
         1 000171   300014 757300                    STAQ  ! 12,,PR3

      673     2958    4                    IF HW_IOP THEN    /* ignore IOP generated lost interrupt */

   2958  1 000172   000000 234200 xsym               SZN   ! HW_IOP
         1 000173   000226 605200 1                  TPL   ! s:2973

      674     2959    4                       IF REQ.STATUS.MAJOR = %READY AND

   2959  1 000174   300014 236300                    LDQ   ! 12,,PR3
         1 000175   170000 316203                    CANQ  ! 61440,DU
         1 000176   000226 601200 1                  TNZ   ! s:2973
PL6.E3A0      #002=NID$POSTER File=NID$DISK.:E05TSI                              WED 07/30/97 03:30 Page:111  
         1 000177   300014 236300                    LDQ   ! 12,,PR3
         1 000200   700000 376207                    ANQ   ! -32768,DL
         1 000201   400000 116207                    CMPQ  ! -131072,DL
         1 000202   000226 601200 1                  TNZ   ! s:2973

      675     2960    5                         REQ.STATUS.IOM.CHANNEL = %LOSTINT THEN DO;

      676     2961                               %UNLOCK (G#=SQH.GATE);

   2962  1 000203   200032 630700                    EPPR0 ! SQH$,,AUTO
         1 000204   000017 631600 xsym               EPPR1 ! B_VECTNIL+15
         1 000205   000000 701200 xent               TSX1  ! HFC$UNLOCK
         1 000206   000000 011200                    NOP   ! 0

      677     2964    5                          RETURN;

   2964  1 000207   000000 702200 xent               TSX2  ! X66_ARET

      678     2965    5                          END;
      679     2966    4                    END;
      680     2967    4                 ELSE DO;

      681     2968    4                    REQ.STATUS=STATUS;

   2968  1 000210   200005 474700                    LDP4  ! @STATUS,,AUTO
         1 000211   400000 237300                    LDAQ  ! 0,,PR4
         1 000212   300014 757300                    STAQ  ! 12,,PR3

      682     2969    5                    IF REQ.STATUS.MAJOR=%LOST_INTERRUPT THEN DO;

   2969  1 000213   300014 236300                    LDQ   ! 12,,PR3
         1 000214   170000 376203                    ANQ   ! 61440,DU
         1 000215   100000 116203                    CMPQ  ! 32768,DU
         1 000216   000226 601200 1                  TNZ   ! s:2973

      683     2970    5                       CALL NIS$MASK(DQH,%IMX_CCW_MASK_CHAN);

PL6.E3A0      #002=NID$POSTER File=NID$DISK.:E05TSI                              WED 07/30/97 03:30 Page:112  
   2970  1 000217   000004 236200 2                  LDQ   ! 4
         1 000220   200011 235300                    LDA   ! DQH$,,AUTO
         1 000221   200040 757300                    STAQ  ! MNSTAT+1,,AUTO
         1 000222   200040 630700                    EPPR0 ! MNSTAT+1,,AUTO
         1 000223   000020 631600 xsym               EPPR1 ! B_VECTNIL+16
         1 000224   000000 701200 xent               TSX1  ! NIS$MASK
         1 000225   000000 011200                    NOP   ! 0

      684     2971    5                       END;

      685     2972    4                    END;

      686     2973    3                 REQ.TYC='0'B;

   2973  1 000226   200027 470700                    LDP0  ! REQ$,,AUTO
         1 000227   000021 450300                    STZ   ! 17,,PR0

      687     2974    3                 IF  ( NOT REQ.STATUS & CHECKBITS )

   2974  1 000230   000014 237300                    LDAQ  ! 12,,PR0
         1 000231   000100 377200 0                  ANAQ  ! CHECKBITS
         1 000232   000477 601200 1                  TNZ   ! s:3049
         1 000233   000027 236300                    LDQ   ! 23,,PR0
         1 000234   177000 316207                    CANQ  ! 65024,DL
         1 000235   000242 600200 1                  TZE   ! s:2978
         1 000236   000027 236300                    LDQ   ! 23,,PR0
         1 000237   177000 376207                    ANQ   ! 65024,DL
         1 000240   010000 116207                    CMPQ  ! 4096,DL
         1 000241   000477 601200 1                  TNZ   ! s:3049

      688     2975    3                 AND (    REQ.COMP = %COMP_REG
      689     2976    3                       OR REQ.COMP = %COMP_MIRROR )
      690     2977    4                 THEN DO ;

      691     2978    4                     COMP = '1'B ;

   2978  1 000242   400000 236203                    LDQ   ! -131072,DU
PL6.E3A0      #002=NID$POSTER File=NID$DISK.:E05TSI                              WED 07/30/97 03:30 Page:113  
         1 000243   200007 756300                    STQ   ! COMP,,AUTO

      692     2979    4                     IF  REQ.COMP = %COMP_MIRROR

   2979  1 000244   000027 236300                    LDQ   ! 23,,PR0
         1 000245   177000 376207                    ANQ   ! 65024,DL
         1 000246   010000 116207                    CMPQ  ! 4096,DL
         1 000247   000333 601200 1                  TNZ   ! s:3008

      693     2980    5                     THEN DO ;

      694     2981    5                         IF  REQ.ERR$ ~= ADDR(NIL)

   2981  1 000250   000017 236300                    LDQ   ! 15,,PR0
         1 000251   000001 116200 xsym               CMPQ  ! B_VECTNIL+1
         1 000252   000257 600200 1                  TZE   ! s:2984

      695     2982    5                         THEN
      696     2983    5                             CALL NIA$RELERR ( REQ )  ;

   2983  1 000253   200027 630700                    EPPR0 ! REQ$,,AUTO
         1 000254   000017 631600 xsym               EPPR1 ! B_VECTNIL+15
         1 000255   000000 701200 xent               TSX1  ! NIA$RELERR
         1 000256   000000 011200                    NOP   ! 0

      697     2984    5                         REQ.MIRDONE = '1'B ;

   2984  1 000257   200027 470700                    LDP0  ! REQ$,,AUTO
         1 000260   100000 236203                    LDQ   ! 32768,DU
         1 000261   000034 256300                    ORSQ  ! 28,,PR0

      698     2985    5                         IF  REQ.DOMIR AND MDCTX ~= 0 /* DONT MIRROR */

   2985  1 000262   000034 234300                    SZN   ! 28,,PR0
         1 000263   000335 605200 1                  TPL   ! s:3009
         1 000264   200015 235300                    LDA   ! MDCTX,,AUTO
         1 000265   000335 600200 1                  TZE   ! s:3009
PL6.E3A0      #002=NID$POSTER File=NID$DISK.:E05TSI                              WED 07/30/97 03:30 Page:114  

      699     2986    6                         THEN DO ;

      700     2987    6                             IF  MDCT$ = ADDR(NIL)

   2987  1 000266   200014 236300                    LDQ   ! MDCT$,,AUTO
         1 000267   000001 116200 xsym               CMPQ  ! B_VECTNIL+1
         1 000270   000273 601200 1                  TNZ   ! s:2990

      701     2988    6                             THEN
      702     2989    6                                 CALL SC_NIDINVMIR ;

   2989  1 000271   000000 713600 xsym               CLIMB ! SC_NIDINVMIR
         1 000272   000000 600000 xsid               climb   nvectors=         0

      703     2990    6                             IF  MDCT.DP.MIRROR.WRITE

   2990  1 000273   200014 470700                    LDP0  ! MDCT$,,AUTO
         1 000274   000036 236300                    LDQ   ! 30,,PR0
         1 000275   200000 316203                    CANQ  ! 65536,DU
         1 000276   000335 600200 1                  TZE   ! s:3009

      704     2991    7                             THEN DO ;

      705     2992    7                                 COMP               = '0'B ;

   2992  1 000277   200007 450300                    STZ   ! COMP,,AUTO

      706     2993    7                                 REQ.DOMIR          = '0'B ;

   2993  1 000300   200027 471700                    LDP1  ! REQ$,,AUTO
         1 000301   000031 236200 xsym               LDQ   ! B_VECTNIL+25
         1 000302   100034 356300                    ANSQ  ! 28,,PR1

      707     2994    7                                 REQ.DLA.DCTX       = MDCTX ;

   2994  1 000303   200015 236300                    LDQ   ! MDCTX,,AUTO
PL6.E3A0      #002=NID$POSTER File=NID$DISK.:E05TSI                              WED 07/30/97 03:30 Page:115  
         1 000304   000025 736200                    QLS   ! 21
         1 000305   100001 676300                    ERQ   ! 1,,PR1
         1 000306   777770 376203                    ANQ   ! -8,DU
         1 000307   100001 656300                    ERSQ  ! 1,,PR1

      708     2995    7                                 REQ.DCT$           = MDCT$ ;

   2995  1 000310   200014 236300                    LDQ   ! MDCT$,,AUTO
         1 000311   100002 756300                    STQ   ! 2,,PR1

      709     2996    7                                 CALL NIO$DCWBLD    ( REQ ) ;

   2996  1 000312   200027 630700                    EPPR0 ! REQ$,,AUTO
         1 000313   000017 631600 xsym               EPPR1 ! B_VECTNIL+15
         1 000314   000000 701200 xent               TSX1  ! NIO$DCWBLD
         1 000315   000000 011200                    NOP   ! 0

      710     2997                                      %UNLOCK ( G# = SQH.GATE ) ;

   2998  1 000316   200032 630700                    EPPR0 ! SQH$,,AUTO
         1 000317   000017 631600 xsym               EPPR1 ! B_VECTNIL+15
         1 000320   000000 701200 xent               TSX1  ! HFC$UNLOCK
         1 000321   000000 011200                    NOP   ! 0

      711     3000    7                                 CALL NID$REQSCHED ( REQ ) ;

   3000  1 000322   200027 630700                    EPPR0 ! REQ$,,AUTO
         1 000323   000017 631600 xsym               EPPR1 ! B_VECTNIL+15
         1 000324   000000 701200 xent               TSX1  ! NID$REQSCHED
         1 000325   000000 011200                    NOP   ! 0

      712     3001                                      %LOCK  ( G# = SQH.GATE  ) ;

   3002  1 000326   200032 630700                    EPPR0 ! SQH$,,AUTO
         1 000327   000017 631600 xsym               EPPR1 ! B_VECTNIL+15
         1 000330   000000 701200 xent               TSX1  ! HFC$LOCK
         1 000331   000000 011200                    NOP   ! 0
PL6.E3A0      #002=NID$POSTER File=NID$DISK.:E05TSI                              WED 07/30/97 03:30 Page:116  

      713     3004    7                                 END ;

      714     3005    6                             END ;

      715     3006    5                         END ;

   3006  1 000332   000335 710200 1                  TRA   ! s:3009

      716     3007    4                         ELSE
      717     3008    4                            REQ.DOMIR          = '0'B ;

   3008  1 000333   000031 236200 xsym               LDQ   ! B_VECTNIL+25
         1 000334   000034 356300                    ANSQ  ! 28,,PR0

      718     3009    5                    IF DCT.SQ$~=ADDR(NIL) AND NOT DCT.DP.RELCHAN THEN DO;

   3009  1 000335   200010 470700                    LDP0  ! DCT$,,AUTO
         1 000336   000001 236300                    LDQ   ! 1,,PR0
         1 000337   000001 116200 xsym               CMPQ  ! B_VECTNIL+1
         1 000340   000445 600200 1                  TZE   ! s:3037
         1 000341   000034 234300                    SZN   ! 28,,PR0
         1 000342   000445 604200 1                  TMI   ! s:3037

      719     3010                            %DEQUEUE(P#=DQH.IO$,Q#=DCT.SQ$);

   3014  1 000343   200010 236300                    LDQ   ! DCT$,,AUTO
         1 000344   000001 036203                    ADLQ  ! 1,DU
         1 000345   200041 756300                    STQ   ! MNSTAT+2,,AUTO
         1 000346   200011 236300                    LDQ   ! DQH$,,AUTO
         1 000347   000014 036203                    ADLQ  ! 12,DU
         1 000350   200040 756300                    STQ   ! MNSTAT+1,,AUTO
         1 000351   200040 630700                    EPPR0 ! MNSTAT+1,,AUTO
         1 000352   000020 631600 xsym               EPPR1 ! B_VECTNIL+16
         1 000353   000000 701200 xent               TSX1  ! NIM$DEQUEUE
         1 000354   000000 011200                    NOP   ! 0

PL6.E3A0      #002=NID$POSTER File=NID$DISK.:E05TSI                              WED 07/30/97 03:30 Page:117  
      720     3017    6                       IF DCT.SQ$=ADDR(NIL) THEN DO;

   3017  1 000355   200010 470700                    LDP0  ! DCT$,,AUTO
         1 000356   000001 236300                    LDQ   ! 1,,PR0
         1 000357   000001 116200 xsym               CMPQ  ! B_VECTNIL+1
         1 000360   000376 601200 1                  TNZ   ! s:3024

      721     3018    6                          DCT.SQ$=DCT.DP.BQ$;

   3018  1 000361   000030 236300                    LDQ   ! 24,,PR0
         1 000362   000001 756300                    STQ   ! 1,,PR0

      722     3019    6                          DCT.DP.BQ$=ADDR(NIL);

   3019  1 000363   000001 236200 xsym               LDQ   ! B_VECTNIL+1
         1 000364   000030 756300                    STQ   ! 24,,PR0

      723     3020    6                          DCT.DP.LEAPERS=0;

   3020  1 000365   000035 450300                    STZ   ! 29,,PR0

      724     3021    6                          DCT.DP.SWP=~DCT.DP.SWP;

   3021  1 000366   000031 236300                    LDQ   ! 25,,PR0
         1 000367   400000 376203                    ANQ   ! -131072,DU
         1 000370   400000 676203                    ERQ   ! -131072,DU
         1 000371   000031 676300                    ERQ   ! 25,,PR0
         1 000372   400000 376203                    ANQ   ! -131072,DU
         1 000373   000031 656300                    ERSQ  ! 25,,PR0

      725     3022    6                          DCT.DP.RELCHAN='1'B;

   3022  1 000374   400000 236203                    LDQ   ! -131072,DU
         1 000375   000034 256300                    ORSQ  ! 28,,PR0

      726     3023    6                          END;

PL6.E3A0      #002=NID$POSTER File=NID$DISK.:E05TSI                              WED 07/30/97 03:30 Page:118  
      727     3024    6                       IF DCT.SQ$~=ADDR(NIL) OR DCT.DP.BQ$~=ADDR(NIL) THEN DO;

   3024  1 000376   000001 236300                    LDQ   ! 1,,PR0
         1 000377   000001 116200 xsym               CMPQ  ! B_VECTNIL+1
         1 000400   000404 601200 1                  TNZ   ! s:3025
         1 000401   000030 236300                    LDQ   ! 24,,PR0
         1 000402   000001 116200 xsym               CMPQ  ! B_VECTNIL+1
         1 000403   000416 600200 1                  TZE   ! s:3028

      728     3025    6                          CALL PMN$COLLECT(DCT.PM,%PM_QUED);

   3025  1 000404   000005 236200 2                  LDQ   ! 5
         1 000405   200041 756300                    STQ   ! MNSTAT+2,,AUTO
         1 000406   200010 236300                    LDQ   ! DCT$,,AUTO
         1 000407   000010 036203                    ADLQ  ! 8,DU
         1 000410   200040 756300                    STQ   ! MNSTAT+1,,AUTO
         1 000411   200040 630700                    EPPR0 ! MNSTAT+1,,AUTO
         1 000412   000020 631600 xsym               EPPR1 ! B_VECTNIL+16
         1 000413   000000 701200 xent               TSX1  ! PMN$COLLECT
         1 000414   000000 011200                    NOP   ! 0

      729     3026    6                          END;

   3026  1 000415   000427 710200 1                  TRA   ! s:3030

      730     3027    6                       ELSE DO;

      731     3028    6                          CALL PMN$COLLECT(DCT.PM,%PM_BUSY);

   3028  1 000416   000006 236200 2                  LDQ   ! 6
         1 000417   200041 756300                    STQ   ! MNSTAT+2,,AUTO
         1 000420   200010 236300                    LDQ   ! DCT$,,AUTO
         1 000421   000010 036203                    ADLQ  ! 8,DU
         1 000422   200040 756300                    STQ   ! MNSTAT+1,,AUTO
         1 000423   200040 630700                    EPPR0 ! MNSTAT+1,,AUTO
         1 000424   000020 631600 xsym               EPPR1 ! B_VECTNIL+16
         1 000425   000000 701200 xent               TSX1  ! PMN$COLLECT
PL6.E3A0      #002=NID$POSTER File=NID$DISK.:E05TSI                              WED 07/30/97 03:30 Page:119  
         1 000426   000000 011200                    NOP   ! 0

      732     3029    6                          END;

      733     3030    5                       DCT.DP.CSEEK=BITBIN(DQH.IO$->REQ.DLA);

   3030  1 000427   200011 470700                    LDP0  ! DQH$,,AUTO
         1 000430   000014 471700                    LDP1  ! 12,,PR0
         1 000431   200010 473700                    LDP3  ! DCT$,,AUTO
         1 000432   100001 235300                    LDA   ! 1,,PR1
         1 000433   300033 755300                    STA   ! 27,,PR3

      734     3031    5                       CALL NIS$DRIVER(DQH);

   3031  1 000434   200011 630700                    EPPR0 ! DQH$,,AUTO
         1 000435   000017 631600 xsym               EPPR1 ! B_VECTNIL+15
         1 000436   000000 701200 xent               TSX1  ! NIS$DRIVER
         1 000437   000000 011200                    NOP   ! 0

      735     3032                            %UNLOCK (G#=SQH.GATE);

   3033  1 000440   200032 630700                    EPPR0 ! SQH$,,AUTO
         1 000441   000017 631600 xsym               EPPR1 ! B_VECTNIL+15
         1 000442   000000 701200 xent               TSX1  ! HFC$UNLOCK
         1 000443   000000 011200                    NOP   ! 0

      736     3035    5                       END;

   3035  1 000444   000461 710200 1                  TRA   ! s:3041

      737     3036    5                    ELSE DO ;

      738     3037    5                        CALL RELCHAN ;

   3037  1 000445   002335 701200 1                  TSX1  ! RELCHAN
         1 000446   000000 011200                    NOP   ! 0

PL6.E3A0      #002=NID$POSTER File=NID$DISK.:E05TSI                              WED 07/30/97 03:30 Page:120  
      739     3038    5                        DCT.DP.RELCHAN = '0'B ;

   3038  1 000447   200010 470700                    LDP0  ! DCT$,,AUTO
         1 000450   000031 236200 xsym               LDQ   ! B_VECTNIL+25
         1 000451   000034 356300                    ANSQ  ! 28,,PR0

      740     3039    5                        CALL NID$DEVSCHEDL ( DCT, %IDLE ) ;

   3039  1 000452   000003 236200 2                  LDQ   ! 3
         1 000453   200010 235300                    LDA   ! DCT$,,AUTO
         1 000454   200040 757300                    STAQ  ! MNSTAT+1,,AUTO
         1 000455   200040 630700                    EPPR0 ! MNSTAT+1,,AUTO
         1 000456   000020 631600 xsym               EPPR1 ! B_VECTNIL+16
         1 000457   000000 701200 xent               TSX1  ! NID$DEVSCHEDL
         1 000460   000000 011200                    NOP   ! 0

      741     3040    5                        END ;

      742     3041    4                    DCT.DFLG.AUTOERROR='0'B;

   3041  1 000461   200010 470700                    LDP0  ! DCT$,,AUTO
         1 000462   000007 236200 2                  LDQ   ! 7
         1 000463   000006 356300                    ANSQ  ! 6,,PR0

      743     3042    4                    IF  COMP

   3042  1 000464   200007 234300                    SZN   ! COMP,,AUTO
         1 000465   000476 605200 1                  TPL   ! s:3047

      744     3043    4                    THEN
      745     3044    4                        CALL NIO$COMP ( REQ, NI$EXTST ) ;

   3044  1 000466   200017 631700                    EPPR1 ! NI$EXTST,,AUTO
         1 000467   200041 451700                    STP1  ! MNSTAT+2,,AUTO
         1 000470   200027 236300                    LDQ   ! REQ$,,AUTO
         1 000471   200040 756300                    STQ   ! MNSTAT+1,,AUTO
         1 000472   200040 630700                    EPPR0 ! MNSTAT+1,,AUTO
PL6.E3A0      #002=NID$POSTER File=NID$DISK.:E05TSI                              WED 07/30/97 03:30 Page:121  
         1 000473   000020 631600 xsym               EPPR1 ! B_VECTNIL+16
         1 000474   000000 701200 xent               TSX1  ! NIO$COMP
         1 000475   000000 011200                    NOP   ! 0

      746     3045    4                    ELSE
      747     3046    4                        ;
      748     3047    4                    RETURN;

   3047  1 000476   000000 702200 xent               TSX2  ! X66_ARET

      749     3048    4                    END;
      750     3049    3                 NI$EXTST.EXTST=DQH.IOSTATUS$->IOSTAT.EXTST;
              3049                          /* MEANINGFUL FOR IOP/IMX */

   3049  1 000477   200011 471700                    LDP1  ! DQH$,,AUTO
         1 000500   100016 473700                    LDP3  ! 14,,PR1
         1 000501   000100 100700                    MLR   ! fill='000'O
         1 000502   300010 000040                    ADSC9   8,,PR3                   cn=0,n=32
         1 000503   200017 000040                    ADSC9   NI$EXTST,,AUTO           cn=0,n=32

      751     3050    3                 CALL RELCHAN;

   3050  1 000504   002335 701200 1                  TSX1  ! RELCHAN
         1 000505   000000 011200                    NOP   ! 0

      752     3051    3                 CALL PMN$COLLECT(DCT.PM,%PM_WAIT);

   3051  1 000506   000010 236200 2                  LDQ   ! 8
         1 000507   200041 756300                    STQ   ! MNSTAT+2,,AUTO
         1 000510   200010 236300                    LDQ   ! DCT$,,AUTO
         1 000511   000010 036203                    ADLQ  ! 8,DU
         1 000512   200040 756300                    STQ   ! MNSTAT+1,,AUTO
         1 000513   200040 630700                    EPPR0 ! MNSTAT+1,,AUTO
         1 000514   000020 631600 xsym               EPPR1 ! B_VECTNIL+16
         1 000515   000000 701200 xent               TSX1  ! PMN$COLLECT
         1 000516   000000 011200                    NOP   ! 0

PL6.E3A0      #002=NID$POSTER File=NID$DISK.:E05TSI                              WED 07/30/97 03:30 Page:122  
      753     3052                      %UNLOCK (G#=SQH.GATE);

   3053  1 000517   200032 630700                    EPPR0 ! SQH$,,AUTO
         1 000520   000017 631600 xsym               EPPR1 ! B_VECTNIL+15
         1 000521   000000 701200 xent               TSX1  ! HFC$UNLOCK
         1 000522   000000 011200                    NOP   ! 0

      754     3055    3                 CALL NID$SCANAQ(SQH);

   3055  1 000523   200032 630700                    EPPR0 ! SQH$,,AUTO
         1 000524   000017 631600 xsym               EPPR1 ! B_VECTNIL+15
         1 000525   000000 701200 xent               TSX1  ! NID$SCANAQ
         1 000526   000000 011200                    NOP   ! 0
         1 000527   001012 710200 1                  TRA   ! s:3139

      755     3056    3               CASE(%MARKER);

      756     3057    3                 DQH$=ADDR(PAR);

   3057  1 000530   200003 236300                    LDQ   ! @PAR,,AUTO
         1 000531   200011 756300                    STQ   ! DQH$,,AUTO

      757     3058    3                 CALL NIA$SPURINT(DQH,EL_SPURINT,INTLVL,NI_DBLZERO);

   3058  1 000532   000002 236200 2                  LDQ   ! 2
         1 000533   200004 235300                    LDA   ! @INTLVL,,AUTO
         1 000534   200042 757300                    STAQ  ! MNSTAT+3,,AUTO
         1 000535   000001 236200 2                  LDQ   ! 1
         1 000536   200011 235300                    LDA   ! DQH$,,AUTO
         1 000537   200040 757300                    STAQ  ! MNSTAT+1,,AUTO
         1 000540   200040 630700                    EPPR0 ! MNSTAT+1,,AUTO
         1 000541   000022 631600 xsym               EPPR1 ! B_VECTNIL+18
         1 000542   000000 701200 xent               TSX1  ! NIA$SPURINT
         1 000543   000000 011200                    NOP   ! 0

      758     3059    3                 RETURN;

PL6.E3A0      #002=NID$POSTER File=NID$DISK.:E05TSI                              WED 07/30/97 03:30 Page:123  
   3059  1 000544   000000 702200 xent               TSX2  ! X66_ARET

      759     3060    3               CASE(%SPECIAL);

      760     3061    3                 IF ADDR(STATUS)=ADDR(NIL) THEN

   3061  1 000545   200005 236300                    LDQ   ! @STATUS,,AUTO
         1 000546   000001 116200 xsym               CMPQ  ! B_VECTNIL+1
         1 000547   000551 601200 1                  TNZ   ! s:3063

      761     3062    3                    RETURN;

   3062  1 000550   000000 702200 xent               TSX2  ! X66_ARET

      762     3063    3                 DQH$=ADDR(PAR);

   3063  1 000551   200003 236300                    LDQ   ! @PAR,,AUTO
         1 000552   200011 756300                    STQ   ! DQH$,,AUTO

      763     3064    3                 SQH$=DQH.SQH$;

   3064  1 000553   200011 471700                    LDP1  ! DQH$,,AUTO
         1 000554   100013 236300                    LDQ   ! 11,,PR1
         1 000555   200032 756300                    STQ   ! SQH$,,AUTO

      764     3065    4                 DO I=SQH.FDCT TO SQH.FDCT+SQH.NDCT-1;

   3065  1 000556   200032 473700                    LDP3  ! SQH$,,AUTO
         1 000557   300002 236300                    LDQ   ! 2,,PR3
         1 000560   000022 772200                    QRL   ! 18
         1 000561   200013 756300                    STQ   ! I,,AUTO
         1 000562   000735 710200 1                  TRA   ! s:3116+1

      765     3066    4                    DCT$=N$DCT$(I);

   3066  1 000563   000000 470600 xsym               LDP0  ! N$DCT$$
         1 000564   200013 720300                    LXL0  ! I,,AUTO
PL6.E3A0      #002=NID$POSTER File=NID$DISK.:E05TSI                              WED 07/30/97 03:30 Page:124  
         1 000565   000000 236310                    LDQ   ! 0,X0,PR0
         1 000566   200010 756300                    STQ   ! DCT$,,AUTO

      766     3067    4                    IF  DCT.DP.MIRROR.FLAG

   3067  1 000567   200010 471700                    LDP1  ! DCT$,,AUTO
         1 000570   100036 234300                    SZN   ! 30,,PR1
         1 000571   000577 605200 1                  TPL   ! s:3072

      767     3068    5                    THEN DO ;

      768     3069    5                        MDCTX = DCT.DP.MIRROR.DCTX ;

   3069  1 000572   100037 236300                    LDQ   ! 31,,PR1
         1 000573   000022 772200                    QRL   ! 18
         1 000574   200015 756300                    STQ   ! MDCTX,,AUTO

      769     3070    5                        MDCT$ = N$DCT$(MDCTX) ;

   3070  1 000575   000000 236306                    LDQ   ! 0,QL,PR0
         1 000576   200014 756300                    STQ   ! MDCT$,,AUTO

      770     3071    5                        END ;

      771     3072    5                    IF DCT.DVN=SPSTAT.DVN AND DCT.TYPE~=%DV_MPC THEN DO;

   3072  1 000577   200005 473700                    LDP3  ! @STATUS,,AUTO
         1 000600   300000 236300                    LDQ   ! 0,,PR3
         1 000601   000022 772200                    QRL   ! 18
         1 000602   000077 376207                    ANQ   ! 63,DL
         1 000603   200040 756300                    STQ   ! MNSTAT+1,,AUTO
         1 000604   100007 236300                    LDQ   ! 7,,PR1
         1 000605   000030 772200                    QRL   ! 24
         1 000606   000077 376207                    ANQ   ! 63,DL
         1 000607   200040 116300                    CMPQ  ! MNSTAT+1,,AUTO
         1 000610   000734 601200 1                  TNZ   ! s:3116
         1 000611   100007 236300                    LDQ   ! 7,,PR1
PL6.E3A0      #002=NID$POSTER File=NID$DISK.:E05TSI                              WED 07/30/97 03:30 Page:125  
         1 000612   007700 376207                    ANQ   ! 4032,DL
         1 000613   000700 116207                    CMPQ  ! 448,DL
         1 000614   000734 600200 1                  TZE   ! s:3116

      772     3073                            %LOCK(G#=SQH.GATE);

   3074  1 000615   200032 630700                    EPPR0 ! SQH$,,AUTO
         1 000616   000017 631600 xsym               EPPR1 ! B_VECTNIL+15
         1 000617   000000 701200 xent               TSX1  ! HFC$LOCK
         1 000620   000000 011200                    NOP   ! 0

      773     3076    5                       DCT.DFLG.AUTOERROR='0'B;

   3076  1 000621   200010 470700                    LDP0  ! DCT$,,AUTO
         1 000622   000007 236200 2                  LDQ   ! 7
         1 000623   000006 356300                    ANSQ  ! 6,,PR0

      774     3077    6                       IF DCT.SPSTAT.PRESENCE THEN DO;

   3077  1 000624   000017 234300                    SZN   ! 15,,PR0
         1 000625   000633 605200 1                  TPL   ! s:3083

      775     3078                               %UNLOCK (G#=SQH.GATE);

   3079  1 000626   200032 630700                    EPPR0 ! SQH$,,AUTO
         1 000627   000017 631600 xsym               EPPR1 ! B_VECTNIL+15
         1 000630   000000 701200 xent               TSX1  ! HFC$UNLOCK
         1 000631   000000 011200                    NOP   ! 0

      776     3081    6                          END;

   3081  1 000632   000733 710200 1                  TRA   ! s:3114

      777     3082    6                       ELSE DO;

      778     3083    6                          DCT.SPSTAT=STATUS;

PL6.E3A0      #002=NID$POSTER File=NID$DISK.:E05TSI                              WED 07/30/97 03:30 Page:126  
   3083  1 000633   200005 471700                    LDP1  ! @STATUS,,AUTO
         1 000634   100000 236300                    LDQ   ! 0,,PR1
         1 000635   000017 756300                    STQ   ! 15,,PR0

      779     3084    7                         IF DCT.SPSTAT.CODE = '000001'O AND DCT.STATE=%SPWAIT THEN DO;

   3084  1 000636   000017 720300                    LXL0  ! 15,,PR0
         1 000637   000001 100203                    CMPX0 ! 1,DU
         1 000640   000702 601200 1                  TNZ   ! s:3098
         1 000641   000007 236300                    LDQ   ! 7,,PR0
         1 000642   000077 376207                    ANQ   ! 63,DL
         1 000643   000003 116207                    CMPQ  ! 3,DL
         1 000644   000702 601200 1                  TNZ   ! s:3098

      780     3085    7                             DCT.STATE=%SUSPENDED;

   3085  1 000645   000006 236207                    LDQ   ! 6,DL
         1 000646   000007 752301                    STCQ  ! 7,'01'O,PR0

      781     3086                                  %UNLOCK (G#=SQH.GATE);

   3087  1 000647   200032 630700                    EPPR0 ! SQH$,,AUTO
         1 000650   000017 631600 xsym               EPPR1 ! B_VECTNIL+15
         1 000651   000000 701200 xent               TSX1  ! HFC$UNLOCK
         1 000652   000000 011200                    NOP   ! 0

      782     3089    8                             IF DCT.MSG#~=0 THEN DO;

   3089  1 000653   200010 470700                    LDP0  ! DCT$,,AUTO
         1 000654   000027 720300                    LXL0  ! 23,,PR0
         1 000655   000670 600200 1                  TZE   ! s:3093

      783     3090    8                                CALL OCI$MK_STTM(DCT.MSG#);

   3090  1 000656   200010 236300                    LDQ   ! DCT$,,AUTO
         1 000657   000011 036200 2                  ADLQ  ! 9
         1 000660   200040 756300                    STQ   ! MNSTAT+1,,AUTO
PL6.E3A0      #002=NID$POSTER File=NID$DISK.:E05TSI                              WED 07/30/97 03:30 Page:127  
         1 000661   200040 630700                    EPPR0 ! MNSTAT+1,,AUTO
         1 000662   000017 631600 xsym               EPPR1 ! B_VECTNIL+15
         1 000663   000000 701200 xent               TSX1  ! OCI$MK_STTM
         1 000664   000000 011200                    NOP   ! 0

      784     3091    8                                DCT.MSG#=0;

   3091  1 000665   000000 220203                    LDX0  ! 0,DU
         1 000666   200010 470700                    LDP0  ! DCT$,,AUTO
         1 000667   000027 440300                    SXL0  ! 23,,PR0

      785     3092    8                                END;

      786     3093    7                             DCT.SPSTAT.PRESENCE='0'B;

   3093  1 000670   000031 236200 xsym               LDQ   ! B_VECTNIL+25
         1 000671   000017 356300                    ANSQ  ! 15,,PR0

      787     3094    7                             CALL NID$DEVSCHED(DCT,%IDLE);

   3094  1 000672   000003 236200 2                  LDQ   ! 3
         1 000673   200010 235300                    LDA   ! DCT$,,AUTO
         1 000674   200040 757300                    STAQ  ! MNSTAT+1,,AUTO
         1 000675   200040 630700                    EPPR0 ! MNSTAT+1,,AUTO
         1 000676   000020 631600 xsym               EPPR1 ! B_VECTNIL+16
         1 000677   000000 701200 xent               TSX1  ! NID$DEVSCHED
         1 000700   000000 011200                    NOP   ! 0

      788     3095    7                             END;

   3095  1 000701   000706 710200 1                  TRA   ! s:3101

      789     3096    7                          ELSE DO;

      790     3097                                  %UNLOCK (G#=SQH.GATE);

   3098  1 000702   200032 630700                    EPPR0 ! SQH$,,AUTO
PL6.E3A0      #002=NID$POSTER File=NID$DISK.:E05TSI                              WED 07/30/97 03:30 Page:128  
         1 000703   000017 631600 xsym               EPPR1 ! B_VECTNIL+15
         1 000704   000000 701200 xent               TSX1  ! HFC$UNLOCK
         1 000705   000000 011200                    NOP   ! 0

      791     3100    7                             END;

      792     3101    7                          IF  DCT.DP.MIRROR.FLAG THEN DO;

   3101  1 000706   200010 470700                    LDP0  ! DCT$,,AUTO
         1 000707   000036 234300                    SZN   ! 30,,PR0
         1 000710   000730 605200 1                  TPL   ! s:3112

      793     3102    7                             IF DCT.SPSTAT.CODE = '000003'O

   3102  1 000711   000017 720300                    LXL0  ! 15,,PR0
         1 000712   000003 100203                    CMPX0 ! 3,DU
         1 000713   000720 601200 1                  TNZ   ! s:3107
         1 000714   200014 471700                    LDP1  ! MDCT$,,AUTO
         1 000715   100036 236300                    LDQ   ! 30,,PR1
         1 000716   007700 316203                    CANQ  ! 4032,DU
         1 000717   000730 600200 1                  TZE   ! s:3112

      794     3103    7                             AND MDCT.DP.MIRROR.STATE = %NI_MIRROR_OPER
      795     3104    7                             THEN
      796     3105    7                                 ;
      797     3106    8                             ELSE DO ;

      798     3107    8                                IF DCT.SPSTAT.CODE = '000001'O THEN

   3107  1 000720   000001 100203                    CMPX0 ! 1,DU
         1 000721   000724 601200 1                  TNZ   ! s:3109

      799     3108    8                                    DCT.SPSTAT.CODE = '000005'O;

   3108  1 000722   000005 221203                    LDX1  ! 5,DU
         1 000723   000017 441300                    SXL1  ! 15,,PR0

PL6.E3A0      #002=NID$POSTER File=NID$DISK.:E05TSI                              WED 07/30/97 03:30 Page:129  
      800     3109    8                                CALL NIO$SPCOMP ( DCT ) ;

   3109  1 000724   200010 630700                    EPPR0 ! DCT$,,AUTO
         1 000725   000017 631600 xsym               EPPR1 ! B_VECTNIL+15
         1 000726   000000 701200 xent               TSX1  ! NIO$SPCOMP
         1 000727   000000 011200                    NOP   ! 0

      801     3110    8                                END ;

      802     3111    7                             END;

      803     3112    6                          DCT.SPSTAT.PRESENCE='0'B;

   3112  1 000730   200010 470700                    LDP0  ! DCT$,,AUTO
         1 000731   000031 236200 xsym               LDQ   ! B_VECTNIL+25
         1 000732   000017 356300                    ANSQ  ! 15,,PR0

      804     3113    6                          END;

      805     3114    5                       RETURN;

   3114  1 000733   000000 702200 xent               TSX2  ! X66_ARET

      806     3115    5                       END /* IF STATUS.DVN */;
      807     3116    4                    END /* DO I */;

   3116  1 000734   200013 054300                    AOS   ! I,,AUTO
         1 000735   200032 470700                    LDP0  ! SQH$,,AUTO
         1 000736   000002 236300                    LDQ   ! 2,,PR0
         1 000737   777777 376207                    ANQ   ! -1,DL
         1 000740   200040 756300                    STQ   ! MNSTAT+1,,AUTO
         1 000741   000002 236300                    LDQ   ! 2,,PR0
         1 000742   000022 772200                    QRL   ! 18
         1 000743   200040 036300                    ADLQ  ! MNSTAT+1,,AUTO
         1 000744   000563 604200 1                  TMI   ! s:3066
         1 000745   200013 116300                    CMPQ  ! I,,AUTO
         1 000746   000563 605600 1                  TPNZ  ! s:3066
PL6.E3A0      #002=NID$POSTER File=NID$DISK.:E05TSI                              WED 07/30/97 03:30 Page:130  

      808     3117    3                CALL NIA$SPURINT(DQH,EL_SPURINT,INTLVL,STATUS); /* DEVICE NOT FOUND */

   3117  1 000747   200004 237300                    LDAQ  ! @INTLVL,,AUTO
         1 000750   200042 757300                    STAQ  ! MNSTAT+3,,AUTO
         1 000751   000001 236200 2                  LDQ   ! 1
         1 000752   200011 235300                    LDA   ! DQH$,,AUTO
         1 000753   200040 757300                    STAQ  ! MNSTAT+1,,AUTO
         1 000754   200040 630700                    EPPR0 ! MNSTAT+1,,AUTO
         1 000755   000022 631600 xsym               EPPR1 ! B_VECTNIL+18
         1 000756   000000 701200 xent               TSX1  ! NIA$SPURINT
         1 000757   000000 011200                    NOP   ! 0

      809     3118    3                 RETURN;

   3118  1 000760   000000 702200 xent               TSX2  ! X66_ARET

      810     3119    3               CASE(%REPOST);

      811     3120    3                 REQ$=ADDR(PAR);

   3120  1 000761   200003 236300                    LDQ   ! @PAR,,AUTO
         1 000762   200027 756300                    STQ   ! REQ$,,AUTO

      812     3121    3                 DCT$=REQ.DCT$;

   3121  1 000763   200027 471700                    LDP1  ! REQ$,,AUTO
         1 000764   100002 236300                    LDQ   ! 2,,PR1
         1 000765   200010 756300                    STQ   ! DCT$,,AUTO

      813     3122    3                 IF  DCT.DP.MIRROR.FLAG

   3122  1 000766   200010 473700                    LDP3  ! DCT$,,AUTO
         1 000767   300036 234300                    SZN   ! 30,,PR3
         1 000770   000777 605200 1                  TPL   ! s:3127

      814     3123    4                 THEN DO ;
PL6.E3A0      #002=NID$POSTER File=NID$DISK.:E05TSI                              WED 07/30/97 03:30 Page:131  

      815     3124    4                     MDCTX = DCT.DP.MIRROR.DCTX ;

   3124  1 000771   300037 236300                    LDQ   ! 31,,PR3
         1 000772   000022 772200                    QRL   ! 18
         1 000773   200015 756300                    STQ   ! MDCTX,,AUTO

      816     3125    4                     MDCT$ = N$DCT$(MDCTX) ;

   3125  1 000774   000000 474600 xsym               LDP4  ! N$DCT$$
         1 000775   400000 236306                    LDQ   ! 0,QL,PR4
         1 000776   200014 756300                    STQ   ! MDCT$,,AUTO

      817     3126    4                     END ;

      818     3127    3                 SQH$=DCT.SQH$;

   3127  1 000777   300022 236300                    LDQ   ! 18,,PR3
         1 001000   200032 756300                    STQ   ! SQH$,,AUTO

      819     3128    3                 DQH$=DCT.DQH$;            /* FOR REFERENCE ONLY! */

   3128  1 001001   300023 236300                    LDQ   ! 19,,PR3
         1 001002   200011 756300                    STQ   ! DQH$,,AUTO

      820     3129    3                 NI$EXTST.EXTST='0'B;

   3129  1 001003   000100 100600                    MLR   ! fill='000'O
         1 001004   000002 000001 xsym               ADSC9   B_VECTNIL+2              cn=0,n=1
         1 001005   200017 000040                    ADSC9   NI$EXTST,,AUTO           cn=0,n=32
         1 001006   001012 710200 1                  TRA   ! s:3139

      821     3130    3               CASE(ELSE);

      822     3131    3                 CALL SC_NIDBADINTLVL;

   3131  1 001007   000000 713600 xsym               CLIMB ! SC_NIDBADINTLVL
PL6.E3A0      #002=NID$POSTER File=NID$DISK.:E05TSI                              WED 07/30/97 03:30 Page:132  
         1 001010   000000 600000 xsid               climb   nvectors=         0

      823     3132        /*S* SCREECH_CODE: NID-S$BADINTLVL-5
      824     3133             TYPE: SNAP
      825     3134             MESSAGE: Invalid interrupt level.
      826     3135        */
      827     3136    3                 RETURN;

   3136  1 001011   000000 702200 xent               TSX2  ! X66_ARET

      828     3137    3               END /* CASE INTLVL */;

      829     3138    2              END /* INHIBIT */;

      830     3139    1           REQ.TYC='0'B;

   3139  1 001012   200027 470500                    LDP0    REQ$,,AUTO
         1 001013   000021 450100                    STZ     17,,PR0

      831     3140    1           RCVR='0'B;

   3140  1 001014   200031 450100                    STZ     RCVR,,AUTO

      832     3141    1           NEWSTATE=%IDLE;

   3141  1 001015   200016 450100                    STZ     NEWSTATE,,AUTO

      833     3142    1           RESTORE$=ADDR(NIL);

   3142  1 001016   000001 236000 xsym               LDQ     B_VECTNIL+1
         1 001017   200030 756100                    STQ     RESTORE$,,AUTO

      834     3143    1           EXTST$=ADDR(NIL);

   3143  1 001020   200012 756100                    STQ     EXTST$,,AUTO

      835     3144    1           IF  REQ.COMP = %COMP_MIRROR
PL6.E3A0      #002=NID$POSTER File=NID$DISK.:E05TSI                              WED 07/30/97 03:30 Page:133  

   3144  1 001021   000027 236100                    LDQ     23,,PR0
         1 001022   177000 376007                    ANQ     65024,DL
         1 001023   010000 116007                    CMPQ    4096,DL
         1 001024   001032 601000 1                  TNZ     s:3148
         1 001025   200010 471500                    LDP1    DCT$,,AUTO
         1 001026   100036 234100                    SZN     30,,PR1
         1 001027   001032 604000 1                  TMI     s:3148

      836     3145    1           AND NOT DCT.DP.MIRROR.FLAG
      837     3146    1           THEN
      838     3147    1               REQ.COMP = %COMP_REG;

   3147  1 001030   000012 236000 2                  LDQ     10
         1 001031   000027 356100                    ANSQ    23,,PR0

      839     3148    2           IF REQ.FC~=%N_RQSTAT AND REQ.COMP~=%COMP_TD THEN DO;

   3148  1 001032   000003 236100                    LDQ     3,,PR0
         1 001033   000777 376007                    ANQ     511,DL
         1 001034   000001 116007                    CMPQ    1,DL
         1 001035   001367 600000 1                  TZE     s:3231
         1 001036   000027 236100                    LDQ     23,,PR0
         1 001037   177000 376007                    ANQ     65024,DL
         1 001040   004000 116007                    CMPQ    2048,DL
         1 001041   001367 600000 1                  TZE     s:3231

      840     3149    3              IF REQ.STATUS.POWEROFF THEN DO;

   3149  1 001042   000014 236100                    LDQ     12,,PR0
         1 001043   200000 316003                    CANQ    65536,DU
         1 001044   001123 600000 1                  TZE     s:3164

      841     3150    3                 REQ.TYC.IOERR='1'B;

   3150  1 001045   001000 236003                    LDQ     512,DU
         1 001046   000021 256100                    ORSQ    17,,PR0
PL6.E3A0      #002=NID$POSTER File=NID$DISK.:E05TSI                              WED 07/30/97 03:30 Page:134  

      842     3151    3                 RCVR=%(RCVR_RETRY|RCVR_LOG);

   3151  1 001047   000103 236000 0                  LDQ     CHECKBITS+3
         1 001050   200031 756100                    STQ     RCVR,,AUTO

      843     3152    3                 IF  HW_IMX

   3152  1 001051   000000 234000 xsym               SZN     HW_IMX
         1 001052   001111 605000 1                  TPL     s:3161
         1 001053   200010 471500                    LDP1    DCT$,,AUTO
         1 001054   100007 236100                    LDQ     7,,PR1
         1 001055   070000 376003                    ANQ     28672,DU
         1 001056   020000 116003                    CMPQ    8192,DU
         1 001057   001111 601000 1                  TNZ     s:3161

      844     3153    3                 AND DCT.CTYP = %C_IPC
      845     3154    4                 THEN  DO ;

      846     3155    4                     DQH.MPC$->DCT.DFLG.MPCSTOP = '0'B ;

   3155  1 001060   200011 473500                    LDP3    DQH$,,AUTO
         1 001061   300015 474500                    LDP4    13,,PR3
         1 001062   000013 236000 2                  LDQ     11
         1 001063   400006 356100                    ANSQ    6,,PR4

      847     3156    4                     DQH.MPC$->DCT.DFLG.RELOAD  = '0'B ;

   3156  1 001064   300015 474500                    LDP4    13,,PR3
         1 001065   000014 236000 2                  LDQ     12
         1 001066   400006 356100                    ANSQ    6,,PR4

      848     3157    4                     CALL NIW$MPCSTOP ( DQH.MPC$->DCT ) ;

   3157  1 001067   300015 474500                    LDP4    13,,PR3
         1 001070   200040 454500                    STP4    MNSTAT+1,,AUTO
         1 001071   200040 630500                    EPPR0   MNSTAT+1,,AUTO
PL6.E3A0      #002=NID$POSTER File=NID$DISK.:E05TSI                              WED 07/30/97 03:30 Page:135  
         1 001072   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 001073   000000 701000 xent               TSX1    NIW$MPCSTOP
         1 001074   000000 011000                    NOP     0

      849     3158    4                     CALL NIK$OPMSG ( DCT, POWEROFF_MSG#, M_DISK, %KIWAIT, REQ ) ;

   3158  1 001075   200027 236100                    LDQ     REQ$,,AUTO
         1 001076   200044 756100                    STQ     MNSTAT+5,,AUTO
         1 001077   000020 237000 2                  LDAQ    16
         1 001100   200042 757100                    STAQ    MNSTAT+3,,AUTO
         1 001101   000017 236000 2                  LDQ     15
         1 001102   200010 235100                    LDA     DCT$,,AUTO
         1 001103   200040 757100                    STAQ    MNSTAT+1,,AUTO
         1 001104   200040 630500                    EPPR0   MNSTAT+1,,AUTO
         1 001105   000023 631400 xsym               EPPR1   B_VECTNIL+19
         1 001106   000000 701000 xent               TSX1    NIK$OPMSG
         1 001107   000000 011000                    NOP     0

      850     3159    4                     END ;

   3159  1 001110   001367 710000 1                  TRA     s:3231

      851     3160    4                 ELSE  DO ;

      852     3161    4                     CALL NIW$LDFW ( DQH.MPC$->DCT, '0'B ) ;

   3161  1 001111   200011 471500                    LDP1    DQH$,,AUTO
         1 001112   100015 473500                    LDP3    13,,PR1
         1 001113   000003 236000 2                  LDQ     3
         1 001114   200041 756100                    STQ     MNSTAT+2,,AUTO
         1 001115   200040 453500                    STP3    MNSTAT+1,,AUTO
         1 001116   200040 630500                    EPPR0   MNSTAT+1,,AUTO
         1 001117   000020 631400 xsym               EPPR1   B_VECTNIL+16
         1 001120   000000 701000 xent               TSX1    NIW$LDFW
         1 001121   000000 011000                    NOP     0

      853     3162    4                     END ;
PL6.E3A0      #002=NID$POSTER File=NID$DISK.:E05TSI                              WED 07/30/97 03:30 Page:136  

      854     3163    3                 END;

   3163  1 001122   001367 710000 1                  TRA     s:3231

      855     3164    3              ELSE DO CASE(REQ.STATUS.MAJOR);

   3164  1 001123   000014 236100                    LDQ     12,,PR0
         1 001124   000036 772000                    QRL     30
         1 001125   000017 376007                    ANQ     15,DL
         1 001126   000020 116007                    CMPQ    16,DL
         1 001127   001131 602006 1                  TNC     s:3164+6,QL
         1 001130   001363 710000 1                  TRA     s:3227
         1 001131   001151 710000 1                  TRA     s:3166
         1 001132   001175 710000 1                  TRA     s:3176
         1 001133   001223 710000 1                  TRA     s:3189
         1 001134   001230 710000 1                  TRA     s:3191
         1 001135   001235 710000 1                  TRA     s:3193
         1 001136   001235 710000 1                  TRA     s:3193
         1 001137   001363 710000 1                  TRA     s:3227
         1 001140   001363 710000 1                  TRA     s:3227
         1 001141   001242 710000 1                  TRA     s:3196
         1 001142   001363 710000 1                  TRA     s:3227
         1 001143   001253 710000 1                  TRA     s:3201
         1 001144   001321 710000 1                  TRA     s:3213
         1 001145   001363 710000 1                  TRA     s:3227
         1 001146   001326 710000 1                  TRA     s:3216
         1 001147   001363 710000 1                  TRA     s:3227
         1 001150   001345 710000 1                  TRA     s:3221

      856     3165    3               CASE(%READY);

      857     3166    4                 IF REQ.STATUS.IOM THEN DO;

   3166  1 001151   000014 236100                    LDQ     12,,PR0
         1 001152   770000 316007                    CANQ    -4096,DL
         1 001153   001170 600000 1                  TZE     s:3173
PL6.E3A0      #002=NID$POSTER File=NID$DISK.:E05TSI                              WED 07/30/97 03:30 Page:137  

      858     3167    4                    CALL NIF$ANIOM(REQ,RCVR.RETRY) ALTRET(IOM_ALT);

   3167  1 001154   200031 631500                    EPPR1   RCVR,,AUTO
         1 001155   200041 451500                    STP1    MNSTAT+2,,AUTO
         1 001156   200027 236100                    LDQ     REQ$,,AUTO
         1 001157   200040 756100                    STQ     MNSTAT+1,,AUTO
         1 001160   200040 630500                    EPPR0   MNSTAT+1,,AUTO
         1 001161   000020 631400 xsym               EPPR1   B_VECTNIL+16
         1 001162   000000 701000 xent               TSX1    NIF$ANIOM
         1 001163   001165 702000 1                  TSX2    IOM_ALT

      859     3168    5                    DO NEVER;

   3168  1 001164   001367 710000 1                  TRA     s:3231

      860     3169    5   IOM_ALT:            NEWSTATE=%KIWAIT;

   3169  1 001165   000004 235007       IOM_ALT      LDA     4,DL
         1 001166   200016 755100                    STA     NEWSTATE,,AUTO

      861     3170    5                       END;

      862     3171    4                    END;

   3171  1 001167   001367 710000 1                  TRA     s:3231

      863     3172    4                 ELSE DO;

      864     3173    4                    CALL CHECKMINOR(READY_STAT);

   3173  1 001170   000022 236000 2                  LDQ     18
         1 001171   200035 756100                    STQ     SQH$+3,,AUTO
         1 001172   002261 701000 1                  TSX1    CHECKMINOR
         1 001173   000000 011000                    NOP     0

      865     3174    4                    END;
PL6.E3A0      #002=NID$POSTER File=NID$DISK.:E05TSI                              WED 07/30/97 03:30 Page:138  

   3174  1 001174   001367 710000 1                  TRA     s:3231

      866     3175    3               CASE(%DEVICE_BUSY);         /* '01'O */

      867     3176    3                 REQ.TYC.IOERR='1'B;

   3176  1 001175   001000 236003                    LDQ     512,DU
         1 001176   000021 256100                    ORSQ    17,,PR0

      868     3177    3                 RCVR = %( RCVR_RESTORE | RCVR_RETRY | RCVR_LOG ) ;

   3177  1 001177   000104 236000 0                  LDQ     CHECKBITS+4
         1 001200   200031 756100                    STQ     RCVR,,AUTO

      869     3178    3                 IF  DCT.FIPS

   3178  1 001201   200010 471500                    LDP1    DCT$,,AUTO
         1 001202   100007 236100                    LDQ     7,,PR1
         1 001203   200000 316003                    CANQ    65536,DU
         1 001204   001220 600000 1                  TZE     s:3187
         1 001205   000014 236100                    LDQ     12,,PR0
         1 001206   007700 376003                    ANQ     4032,DU
         1 001207   004000 116003                    CMPQ    2048,DU
         1 001210   001220 601000 1                  TNZ     s:3187

      870     3179    3                 AND  REQ.STATUS.MINOR = '40'O
      871     3180    3                 THEN  /* Alternate Channel in Control */
      872     3181    3                     IF  REQ.ERRCT < 12

   3181  1 001211   000003 236100                    LDQ     3,,PR0
         1 001212   777000 376003                    ANQ     -512,DU
         1 001213   014000 116003                    CMPQ    6144,DU
         1 001214   001367 602000 1                  TNC     s:3231

      873     3182    3                     THEN
      874     3183    3                     /*  NEWSTATE = %IDLE  */ ;
PL6.E3A0      #002=NID$POSTER File=NID$DISK.:E05TSI                              WED 07/30/97 03:30 Page:139  
      875     3184    3                     ELSE
      876     3185    3                         NEWSTATE = %SPWAIT ;

   3185  1 001215   000003 235007                    LDA     3,DL
         1 001216   200016 755100                    STA     NEWSTATE,,AUTO
         1 001217   001367 710000 1                  TRA     s:3231

      877     3186    3                 ELSE
      878     3187    3                     NEWSTATE = %KIWAIT ;

   3187  1 001220   000004 235007                    LDA     4,DL
         1 001221   200016 755100                    STA     NEWSTATE,,AUTO
         1 001222   001367 710000 1                  TRA     s:3231

      879     3188    3               CASE(%ATTENTION);           /* '02'O */

      880     3189    3                 CALL CHECKMINOR(ATT_STAT);

   3189  1 001223   000023 236000 2                  LDQ     19
         1 001224   200035 756100                    STQ     SQH$+3,,AUTO
         1 001225   002261 701000 1                  TSX1    CHECKMINOR
         1 001226   000000 011000                    NOP     0
         1 001227   001367 710000 1                  TRA     s:3231

      881     3190    3               CASE(%DATA_ALERT);          /* '03'O */

      882     3191    3                 CALL CHECKMINOR(DAL_STAT);

   3191  1 001230   000024 236000 2                  LDQ     20
         1 001231   200035 756100                    STQ     SQH$+3,,AUTO
         1 001232   002261 701000 1                  TSX1    CHECKMINOR
         1 001233   000000 011000                    NOP     0
         1 001234   001367 710000 1                  TRA     s:3231

      883     3192    3               CASE(%END_OF_FILE,%COMMAND_REJECT); /* '04'O, '05'O */

      884     3193    3                 RCVR=%(RCVR_RETRY|RCVR_LOG|RCVR_EXTST);
PL6.E3A0      #002=NID$POSTER File=NID$DISK.:E05TSI                              WED 07/30/97 03:30 Page:140  

   3193  1 001235   000105 236000 0                  LDQ     CHECKBITS+5
         1 001236   200031 756100                    STQ     RCVR,,AUTO

      885     3194    3                 REQ.TYC.IOERR='1'B;

   3194  1 001237   001000 236003                    LDQ     512,DU
         1 001240   000021 256100                    ORSQ    17,,PR0
         1 001241   001367 710000 1                  TRA     s:3231

      886     3195    3               CASE(%LOST_INTERRUPT);      /* '10'O */

      887     3196    3                 REQ.TYC.TIMO='1'B;

   3196  1 001242   000010 236003                    LDQ     8,DU
         1 001243   000021 256100                    ORSQ    17,,PR0

      888     3197    3                 RCVR=%(RCVR_RETRY|RCVR_LOG);

   3197  1 001244   000103 236000 0                  LDQ     CHECKBITS+3
         1 001245   200031 756100                    STQ     RCVR,,AUTO

      889     3198    3                 REQ.STATUS.NCP=7;         /* DONT CALC ARS IN COMP */

   3198  1 001246   700000 236007                    LDQ     -32768,DL
         1 001247   000015 256100                    ORSQ    13,,PR0

      890     3199    3                 REQ.ARSIZE=0;

   3199  1 001250   177777 236007                    LDQ     65535,DL
         1 001251   000027 356100                    ANSQ    23,,PR0
         1 001252   001367 710000 1                  TRA     s:3231

      891     3200    3               CASE(%MPC_ATTENTION);       /* '12'O */

      892     3201    3                 REQ.TYC.IOERR='1'B;

PL6.E3A0      #002=NID$POSTER File=NID$DISK.:E05TSI                              WED 07/30/97 03:30 Page:141  
   3201  1 001253   001000 236003                    LDQ     512,DU
         1 001254   000021 256100                    ORSQ    17,,PR0

      893     3202    3                 IF DCT.FIPS AND REQ.STATUS.MINOR='16'O THEN /* SD OFFLINE */

   3202  1 001255   200010 471500                    LDP1    DCT$,,AUTO
         1 001256   100007 236100                    LDQ     7,,PR1
         1 001257   200000 316003                    CANQ    65536,DU
         1 001260   001274 600000 1                  TZE     s:3204
         1 001261   000014 236100                    LDQ     12,,PR0
         1 001262   007700 376003                    ANQ     4032,DU
         1 001263   001600 116003                    CMPQ    896,DU
         1 001264   001274 601000 1                  TNZ     s:3204

      894     3203    3                    CALL NIS$MASK(DQH,%IMX_CCW_MASK_CHAN);

   3203  1 001265   000004 236000 2                  LDQ     4
         1 001266   200011 235100                    LDA     DQH$,,AUTO
         1 001267   200040 757100                    STAQ    MNSTAT+1,,AUTO
         1 001270   200040 630500                    EPPR0   MNSTAT+1,,AUTO
         1 001271   000020 631400 xsym               EPPR1   B_VECTNIL+16
         1 001272   000000 701000 xent               TSX1    NIS$MASK
         1 001273   000000 011000                    NOP     0

      895     3204    3                 IF DCT.FIPS AND (REQ.STATUS.MINOR='17'O OR /* CHAN WRITE ERR */

   3204  1 001274   200010 470500                    LDP0    DCT$,,AUTO
         1 001275   000007 236100                    LDQ     7,,PR0
         1 001276   200000 316003                    CANQ    65536,DU
         1 001277   001314 600000 1                  TZE     s:3209
         1 001300   200027 471500                    LDP1    REQ$,,AUTO
         1 001301   100014 236100                    LDQ     12,,PR1
         1 001302   007700 376003                    ANQ     4032,DU
         1 001303   001700 116003                    CMPQ    960,DU
         1 001304   001311 600000 1                  TZE     s:3206
         1 001305   100014 236100                    LDQ     12,,PR1
         1 001306   007700 376003                    ANQ     4032,DU
PL6.E3A0      #002=NID$POSTER File=NID$DISK.:E05TSI                              WED 07/30/97 03:30 Page:142  
         1 001307   001300 116003                    CMPQ    704,DU
         1 001310   001314 601000 1                  TNZ     s:3209

      896     3205    4                   REQ.STATUS.MINOR='13'O) THEN DO; /* UNEXPECTED INTERRUPT */

      897     3206    4                    RCVR=%(RCVR_RETRY|RCVR_LOG|RCVR_EXTST);

   3206  1 001311   000105 236000 0                  LDQ     CHECKBITS+5
         1 001312   200031 756100                    STQ     RCVR,,AUTO

      898     3207    4                    END;

   3207  1 001313   001367 710000 1                  TRA     s:3231

      899     3208    4                 ELSE DO;

      900     3209    4                    NEWSTATE=%KIWAIT;

   3209  1 001314   000004 235007                    LDA     4,DL
         1 001315   200016 755100                    STA     NEWSTATE,,AUTO

      901     3210    4                    RCVR=%(RCVR_RETRY|RCVR_LOG);

   3210  1 001316   000103 236000 0                  LDQ     CHECKBITS+3
         1 001317   200031 756100                    STQ     RCVR,,AUTO

      902     3211    4                    END;

   3211  1 001320   001367 710000 1                  TRA     s:3231

      903     3212    3               CASE(%MPC_DATA_ALERT);      /* '13'O */

      904     3213    3                 REQ.TYC.IOERR='1'B;

   3213  1 001321   001000 236003                    LDQ     512,DU
         1 001322   000021 256100                    ORSQ    17,,PR0

PL6.E3A0      #002=NID$POSTER File=NID$DISK.:E05TSI                              WED 07/30/97 03:30 Page:143  
      905     3214    3                 RCVR=%(RCVR_RETRY|RCVR_LOG);

   3214  1 001323   000103 236000 0                  LDQ     CHECKBITS+3
         1 001324   200031 756100                    STQ     RCVR,,AUTO
         1 001325   001367 710000 1                  TRA     s:3231

      906     3215    3               CASE(%MPC_COMMAND_REJECT);  /* '15'O */

      907     3216    3                 REQ.TYC.IOERR='1'B;

   3216  1 001326   001000 236003                    LDQ     512,DU
         1 001327   000021 256100                    ORSQ    17,,PR0

      908     3217    3                 RCVR=%(RCVR_RETRY|RCVR_LOG);

   3217  1 001330   000103 236000 0                  LDQ     CHECKBITS+3
         1 001331   200031 756100                    STQ     RCVR,,AUTO

      909     3218    3                 IF REQ.STATUS.MINOR='03'O AND REQ.ERRCT>8 THEN

   3218  1 001332   000014 236100                    LDQ     12,,PR0
         1 001333   007700 376003                    ANQ     4032,DU
         1 001334   000300 116003                    CMPQ    192,DU
         1 001335   001367 601000 1                  TNZ     s:3231
         1 001336   000003 236100                    LDQ     3,,PR0
         1 001337   777000 376003                    ANQ     -512,DU
         1 001340   011000 116003                    CMPQ    4608,DU
         1 001341   001367 602000 1                  TNC     s:3231

      910     3219    3                    NEWSTATE=%KIWAIT;

   3219  1 001342   000004 235007                    LDA     4,DL
         1 001343   200016 755100                    STA     NEWSTATE,,AUTO
         1 001344   001367 710000 1                  TRA     s:3231

      911     3220    3               CASE(%SYSTEM_FAULT);

PL6.E3A0      #002=NID$POSTER File=NID$DISK.:E05TSI                              WED 07/30/97 03:30 Page:144  
      912     3221    3                 CALL NIF$ANFAULT(REQ,RCVR.RETRY) ALTRET(FLT_ALT);

   3221  1 001345   200031 631500                    EPPR1   RCVR,,AUTO
         1 001346   200041 451500                    STP1    MNSTAT+2,,AUTO
         1 001347   200027 236100                    LDQ     REQ$,,AUTO
         1 001350   200040 756100                    STQ     MNSTAT+1,,AUTO
         1 001351   200040 630500                    EPPR0   MNSTAT+1,,AUTO
         1 001352   000020 631400 xsym               EPPR1   B_VECTNIL+16
         1 001353   000000 701000 xent               TSX1    NIF$ANFAULT
         1 001354   001356 702000 1                  TSX2    FLT_ALT

      913     3222    4                 DO NEVER;

   3222  1 001355   001360 710000 1                  TRA     s:3225

      914     3223    4   FLT_ALT:         NEWSTATE=%KIWAIT;

   3223  1 001356   000004 235007       FLT_ALT      LDA     4,DL
         1 001357   200016 755100                    STA     NEWSTATE,,AUTO

      915     3224    4                    END;

      916     3225    3                 RCVR.LOG='1'B;

   3225  1 001360   100000 236003                    LDQ     32768,DU
         1 001361   200031 256100                    ORSQ    RCVR,,AUTO
         1 001362   001367 710000 1                  TRA     s:3231

      917     3226    3               CASE(ELSE);

      918     3227    3                 RCVR=%(RCVR_RETRY|RCVR_LOG);

   3227  1 001363   000103 236000 0                  LDQ     CHECKBITS+3
         1 001364   200031 756100                    STQ     RCVR,,AUTO

      919     3228    3                 REQ.TYC.IOERR='1'B;

PL6.E3A0      #002=NID$POSTER File=NID$DISK.:E05TSI                              WED 07/30/97 03:30 Page:145  
   3228  1 001365   001000 236003                    LDQ     512,DU
         1 001366   000021 256100                    ORSQ    17,,PR0

      920     3229    3               END;

      921     3230    2              END;

      922     3231    1           COMP = '1'B ;

   3231  1 001367   400000 236003                    LDQ     -131072,DU
         1 001370   200007 756100                    STQ     COMP,,AUTO

      923     3232    2           DO CASE(REQ.COMP);

   3232  1 001371   200027 470500                    LDP0    REQ$,,AUTO
         1 001372   000027 236100                    LDQ     23,,PR0
         1 001373   000011 772000                    QRL     9
         1 001374   000177 376007                    ANQ     127,DL
         1 001375   000011 116007                    CMPQ    9,DL
         1 001376   001400 602006 1                  TNC     s:3232+7,QL
         1 001377   002075 710000 1                  TRA     s:3362
         1 001400   001411 710000 1                  TRA     s:3234
         1 001401   002075 710000 1                  TRA     s:3362
         1 001402   002075 710000 1                  TRA     s:3362
         1 001403   002034 710000 1                  TRA     s:3351
         1 001404   002050 710000 1                  TRA     s:3357
         1 001405   002075 710000 1                  TRA     s:3362
         1 001406   002075 710000 1                  TRA     s:3362
         1 001407   002075 710000 1                  TRA     s:3362
         1 001410   001411 710000 1                  TRA     s:3234

      924     3233    2            CASE ( %COMP_REG, %COMP_MIRROR ) ;

      925     3234    3              IF RCVR.RETRY AND NOT RCVR.NOINC THEN DO;

   3234  1 001411   200031 234100                    SZN     RCVR,,AUTO
         1 001412   001520 605000 1                  TPL     s:3267
PL6.E3A0      #002=NID$POSTER File=NID$DISK.:E05TSI                              WED 07/30/97 03:30 Page:146  
         1 001413   200031 236100                    LDQ     RCVR,,AUTO
         1 001414   200000 316003                    CANQ    65536,DU
         1 001415   001520 601000 1                  TNZ     s:3267

      926     3235    3                 REQ.ERRCT=REQ.ERRCT+1;

   3235  1 001416   000003 236100                    LDQ     3,,PR0
         1 001417   001000 036003                    ADLQ    512,DU
         1 001420   000003 552140                    STBQ    3,'40'O,PR0

      927     3236    3                 IF  REQ.ERRCT > 16

   3236  1 001421   000003 236100                    LDQ     3,,PR0
         1 001422   777000 376003                    ANQ     -512,DU
         1 001423   021000 116003                    CMPQ    8704,DU
         1 001424   001520 602000 1                  TNC     s:3267

      928     3237    4                 THEN DO ;

      929     3238    4                     IF  DCT.DP.MIRROR.FLAG

   3238  1 001425   200010 471500                    LDP1    DCT$,,AUTO
         1 001426   100036 234100                    SZN     30,,PR1
         1 001427   001514 605000 1                  TPL     s:3262
         1 001430   000027 236100                    LDQ     23,,PR0
         1 001431   177000 376007                    ANQ     65024,DL
         1 001432   010000 116007                    CMPQ    4096,DL
         1 001433   001514 601000 1                  TNZ     s:3262

      930     3239    4                     AND REQ.COMP = %COMP_MIRROR
      931     3240    5                     THEN DO ;

      932     3241    5                         IF  RCVR.LOG

   3241  1 001434   200031 236100                    LDQ     RCVR,,AUTO
         1 001435   100000 316003                    CANQ    32768,DU
         1 001436   001450 600000 1                  TZE     s:3246
PL6.E3A0      #002=NID$POSTER File=NID$DISK.:E05TSI                              WED 07/30/97 03:30 Page:147  

      933     3242    6                         THEN DO ;

      934     3243    6                             CALL NIA$LOGERR ( REQ, EL_IOERR ) ;

   3243  1 001437   000026 236000 2                  LDQ     22
         1 001440   200027 235100                    LDA     REQ$,,AUTO
         1 001441   200040 757100                    STAQ    MNSTAT+1,,AUTO
         1 001442   200040 630500                    EPPR0   MNSTAT+1,,AUTO
         1 001443   000020 631400 xsym               EPPR1   B_VECTNIL+16
         1 001444   000000 701000 xent               TSX1    NIA$LOGERR
         1 001445   000000 011000                    NOP     0

      935     3244    6                             RCVR.LOG = '0'B ;

   3244  1 001446   000027 236000 2                  LDQ     23
         1 001447   200031 356100                    ANSQ    RCVR,,AUTO

      936     3245    6                             END ;

      937     3246    5                         IF  REQ.ERR$ ~= ADDR(NIL)

   3246  1 001450   200027 470500                    LDP0    REQ$,,AUTO
         1 001451   000017 236100                    LDQ     15,,PR0
         1 001452   000001 116000 xsym               CMPQ    B_VECTNIL+1
         1 001453   001460 600000 1                  TZE     s:3249

      938     3247    5                         THEN
      939     3248    5                             CALL NIA$RELERR ( REQ ) ;

   3248  1 001454   200027 630500                    EPPR0   REQ$,,AUTO
         1 001455   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 001456   000000 701000 xent               TSX1    NIA$RELERR
         1 001457   000000 011000                    NOP     0

      940     3249    5                         REQ.ERRCT = 0 ;

PL6.E3A0      #002=NID$POSTER File=NID$DISK.:E05TSI                              WED 07/30/97 03:30 Page:148  
   3249  1 001460   200027 470500                    LDP0    REQ$,,AUTO
         1 001461   000000 236003                    LDQ     0,DU
         1 001462   000003 552140                    STBQ    3,'40'O,PR0

      941     3250    5                         REQ.TYC = '0'B ;

   3250  1 001463   000021 450100                    STZ     17,,PR0

      942     3251                              %LOCK    ( G#=SQH.GATE        ) ;

   3252  1 001464   200032 630500                    EPPR0   SQH$,,AUTO
         1 001465   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 001466   000000 701000 xent               TSX1    HFC$LOCK
         1 001467   000000 011000                    NOP     0

      943     3254                              %REQUEUE ( P#=REQ, Q#=DCT.SQ$ ) ;

   3255  1 001470   200010 236100                    LDQ     DCT$,,AUTO
         1 001471   000001 036003                    ADLQ    1,DU
         1 001472   200027 235100                    LDA     REQ$,,AUTO
         1 001473   200040 757100                    STAQ    MNSTAT+1,,AUTO
         1 001474   200040 630500                    EPPR0   MNSTAT+1,,AUTO
         1 001475   000020 631400 xsym               EPPR1   B_VECTNIL+16
         1 001476   000000 701000 xent               TSX1    NIM$REQUEUE
         1 001477   000000 011000                    NOP     0

      944     3257    5                         CALL TDM$MIRFAIL ( DCT ) ;

   3257  1 001500   200010 630500                    EPPR0   DCT$,,AUTO
         1 001501   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 001502   000000 701000 xent               TSX1    TDM$MIRFAIL
         1 001503   000000 011000                    NOP     0

      945     3258    5                         CALL NID$DEVSCHED ( DCT, %IDLE ) ;

   3258  1 001504   000003 236000 2                  LDQ     3
         1 001505   200010 235100                    LDA     DCT$,,AUTO
PL6.E3A0      #002=NID$POSTER File=NID$DISK.:E05TSI                              WED 07/30/97 03:30 Page:149  
         1 001506   200040 757100                    STAQ    MNSTAT+1,,AUTO
         1 001507   200040 630500                    EPPR0   MNSTAT+1,,AUTO
         1 001510   000020 631400 xsym               EPPR1   B_VECTNIL+16
         1 001511   000000 701000 xent               TSX1    NID$DEVSCHED
         1 001512   000000 011000                    NOP     0

      946     3259    5                         RETURN ;

   3259  1 001513   000000 702200 xent               TSX2  ! X66_ARET

      947     3260    5                         END ;
      948     3261    5                     ELSE DO ;

      949     3262    5                         RCVR.RETRY = '0'B ;

   3262  1 001514   000031 236000 xsym               LDQ     B_VECTNIL+25
         1 001515   200031 356100                    ANSQ    RCVR,,AUTO

      950     3263    5                         RCVR.OPMSG = '1'B ;

   3263  1 001516   010000 236003                    LDQ     4096,DU
         1 001517   200031 256100                    ORSQ    RCVR,,AUTO

      951     3264    5                         END ;

      952     3265    4                     END ;

      953     3266    3                 END;

      954     3267    2              IF RCVR.LOG THEN

   3267  1 001520   200031 236100                    LDQ     RCVR,,AUTO
         1 001521   100000 316003                    CANQ    32768,DU
         1 001522   001532 600000 1                  TZE     s:3269

      955     3268    2                 CALL NIA$LOGERR(REQ,EL_IOERR);

PL6.E3A0      #002=NID$POSTER File=NID$DISK.:E05TSI                              WED 07/30/97 03:30 Page:150  
   3268  1 001523   000026 236000 2                  LDQ     22
         1 001524   200027 235100                    LDA     REQ$,,AUTO
         1 001525   200040 757100                    STAQ    MNSTAT+1,,AUTO
         1 001526   200040 630500                    EPPR0   MNSTAT+1,,AUTO
         1 001527   000020 631400 xsym               EPPR1   B_VECTNIL+16
         1 001530   000000 701000 xent               TSX1    NIA$LOGERR
         1 001531   000000 011000                    NOP     0

      956     3269    3              IF REQ.ERR$~=ADDR(NIL) THEN DO;

   3269  1 001532   200027 470500                    LDP0    REQ$,,AUTO
         1 001533   000017 236100                    LDQ     15,,PR0
         1 001534   000001 116000 xsym               CMPQ    B_VECTNIL+1
         1 001535   001650 600000 1                  TZE     NOEXTST

      957     3270    4                 IF NOT REQ.ERR$->NI$IOERR.GOTEXTST THEN DO;

   3270  1 001536   000017 471500                    LDP1    15,,PR0
         1 001537   100020 236100                    LDQ     16,,PR1
         1 001540   020000 316003                    CANQ    8192,DU
         1 001541   001650 601000 1                  TNZ     NOEXTST

      958     3271    5                    IF HW_EXT_STATUS THEN DO;

   3271  1 001542   000000 234000 xsym               SZN     HW_EXT_STATUS
         1 001543   001555 605000 1                  TPL     s:3277

      959     3272    6                       IF NI$EXTST.EXTSTT.WRD(0)~=0 THEN DO;

   3272  1 001544   200017 235100                    LDA     NI$EXTST,,AUTO
         1 001545   001650 600000 1                  TZE     NOEXTST

      960     3273    6                          REQ.ERR$->NI$IOERR.EXTST=NI$EXTST.EXTST;

   3273  1 001546   000100 100500                    MLR     fill='000'O
         1 001547   200017 000040                    ADSC9   NI$EXTST,,AUTO           cn=0,n=32
         1 001550   100007 000040                    ADSC9   7,,PR1                   cn=0,n=32
PL6.E3A0      #002=NID$POSTER File=NID$DISK.:E05TSI                              WED 07/30/97 03:30 Page:151  

      961     3274    6                          REQ.ERR$->NI$IOERR.GOTEXTST='1'B;

   3274  1 001551   000017 471500                    LDP1    15,,PR0
         1 001552   020000 236003                    LDQ     8192,DU
         1 001553   100020 256100                    ORSQ    16,,PR1

      962     3275    6                          END;

      963     3276    5                       END;

   3276  1 001554   001650 710000 1                  TRA     NOEXTST

      964     3277    5                    ELSE IF RCVR.EXTST THEN DO;

   3277  1 001555   200031 236100                    LDQ     RCVR,,AUTO
         1 001556   020000 316003                    CANQ    8192,DU
         1 001557   001650 600000 1                  TZE     NOEXTST

      965     3278    5                          CALL NIQ$GET(EXTST$) ALTRET(NOEXTST);

   3278  1 001560   200012 633500                    EPPR3   EXTST$,,AUTO
         1 001561   200040 453500                    STP3    MNSTAT+1,,AUTO
         1 001562   200040 630500                    EPPR0   MNSTAT+1,,AUTO
         1 001563   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 001564   000000 701000 xent               TSX1    NIQ$GET
         1 001565   001650 702000 1                  TSX2    NOEXTST

      966     3279    5                          EXTST$->REQ.DLA=REQ.DLA;

   3279  1 001566   200027 470500                    LDP0    REQ$,,AUTO
         1 001567   000001 236100                    LDQ     1,,PR0
         1 001570   200012 471500                    LDP1    EXTST$,,AUTO
         1 001571   100001 756100                    STQ     1,,PR1

      967     3280    5                          EXTST$->REQ.FC=%N_EXTST;

PL6.E3A0      #002=NID$POSTER File=NID$DISK.:E05TSI                              WED 07/30/97 03:30 Page:152  
   3280  1 001572   200012 471500                    LDP1    EXTST$,,AUTO
         1 001573   000033 236007                    LDQ     27,DL
         1 001574   100003 552104                    STBQ    3,'04'O,PR1

      968     3281    5                          EXTST$->REQ.BUF$=ADDR(REQ.ERR$->NI$IOERR.EXTST);

   3281  1 001575   000017 471500                    LDP1    15,,PR0
         1 001576   100007 633500                    EPPR3   7,,PR1
         1 001577   200012 474500                    LDP4    EXTST$,,AUTO
         1 001600   400005 453500                    STP3    5,,PR4

      969     3282    5                          EXTST$->REQ.BUFSIZE=SIZEC(NI$IOERR.EXTST);

   3282  1 001601   200012 471500                    LDP1    EXTST$,,AUTO
         1 001602   100004 236100                    LDQ     4,,PR1
         1 001603   177777 376007                    ANQ     65535,DL
         1 001604   000010 276003                    ORQ     8,DU
         1 001605   100004 756100                    STQ     4,,PR1

      970     3283    5                          EXTST$->REQ.OPFLG=OP_BPF;

   3283  1 001606   200012 471500                    LDP1    EXTST$,,AUTO
         1 001607   000010 236007                    LDQ     8,DL
         1 001610   100004 552104                    STBQ    4,'04'O,PR1

      971     3284    5                          EXTST$->REQ.COMP=%COMP_IOS;

   3284  1 001611   200012 471500                    LDP1    EXTST$,,AUTO
         1 001612   100027 236100                    LDQ     23,,PR1
         1 001613   000012 376000 2                  ANQ     10
         1 001614   003000 276007                    ORQ     1536,DL
         1 001615   100027 756100                    STQ     23,,PR1

      972     3285    5                          EXTST$->REQ.BPMIR = '1'B ;

   3285  1 001616   200000 236003                    LDQ     65536,DU
         1 001617   100034 256100                    ORSQ    28,,PR1
PL6.E3A0      #002=NID$POSTER File=NID$DISK.:E05TSI                              WED 07/30/97 03:30 Page:153  

      973     3286    5                          CALL NIO$DCWBLD(EXTST$->REQ) ALTRET(NOEXTST0);

   3286  1 001620   200012 630500                    EPPR0   EXTST$,,AUTO
         1 001621   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 001622   000000 701000 xent               TSX1    NIO$DCWBLD
         1 001623   001640 702000 1                  TSX2    NOEXTST0

      974     3287    5                          REQ.ERR$->NI$IOERR.GOTEXTST='1'B;

   3287  1 001624   200027 470500                    LDP0    REQ$,,AUTO
         1 001625   000017 471500                    LDP1    15,,PR0
         1 001626   020000 236003                    LDQ     8192,DU
         1 001627   100020 256100                    ORSQ    16,,PR1

      975     3288    5                          EXTST$->REQ.POSTER=NEWSTATE;

   3288  1 001630   200012 471500                    LDP1    EXTST$,,AUTO
         1 001631   200016 236100                    LDQ     NEWSTATE,,AUTO
         1 001632   100010 552104                    STBQ    8,'04'O,PR1

      976     3289    5                          NEWSTATE=%IDLE;

   3289  1 001633   200016 450100                    STZ     NEWSTATE,,AUTO

      977     3290    5                          EXTST$->REQ.EAINFOP$=REQ$;

   3290  1 001634   200027 236100                    LDQ     REQ$,,AUTO
         1 001635   200012 471500                    LDP1    EXTST$,,AUTO
         1 001636   100024 756100                    STQ     20,,PR1

      978     3291    6                          DO NEVER;

   3291  1 001637   001650 710000 1                  TRA     NOEXTST

      979     3292    6   NOEXTST0:                 CALL NIQ$REL(EXTST$);

PL6.E3A0      #002=NID$POSTER File=NID$DISK.:E05TSI                              WED 07/30/97 03:30 Page:154  
   3292  1 001640   200012 630500       NOEXTST0     EPPR0   EXTST$,,AUTO
         1 001641   200040 450500                    STP0    MNSTAT+1,,AUTO
         1 001642   200040 630500                    EPPR0   MNSTAT+1,,AUTO
         1 001643   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 001644   000000 701000 xent               TSX1    NIQ$REL
         1 001645   000000 011000                    NOP     0

      980     3293    6                             EXTST$=ADDR(NIL);

   3293  1 001646   000001 236000 xsym               LDQ     B_VECTNIL+1
         1 001647   200012 756100                    STQ     EXTST$,,AUTO

      981     3294    6                             END;

      982     3295    5   NOEXTST:               END;

   3295  1 001650                       NOEXTST      null
      983     3296    4                    END;

      984     3297    3                 END;

      985     3298    3              IF RCVR.RESTORE THEN DO;

   3298  1 001650   200031 236100                    LDQ     RCVR,,AUTO
         1 001651   040000 316003                    CANQ    16384,DU
         1 001652   001704 600000 1                  TZE     s:3307

      986     3299    3                 CALL NIQ$GET(RESTORE$) ALTRET(REPOST);

   3299  1 001653   200030 630500                    EPPR0   RESTORE$,,AUTO
         1 001654   200040 450500                    STP0    MNSTAT+1,,AUTO
         1 001655   200040 630500                    EPPR0   MNSTAT+1,,AUTO
         1 001656   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 001657   000000 701000 xent               TSX1    NIQ$GET
         1 001660   002201 702000 1                  TSX2    REPOST

      987     3300    3                 RESTORE$->REQ.DLA=REQ.DLA;
PL6.E3A0      #002=NID$POSTER File=NID$DISK.:E05TSI                              WED 07/30/97 03:30 Page:155  

   3300  1 001661   200027 470500                    LDP0    REQ$,,AUTO
         1 001662   000001 236100                    LDQ     1,,PR0
         1 001663   200030 471500                    LDP1    RESTORE$,,AUTO
         1 001664   100001 756100                    STQ     1,,PR1

      988     3301    3                 RESTORE$->REQ.FC=%N_RESTORE;

   3301  1 001665   200030 471500                    LDP1    RESTORE$,,AUTO
         1 001666   000030 236007                    LDQ     24,DL
         1 001667   100003 552104                    STBQ    3,'04'O,PR1

      989     3302    3                 RESTORE$->REQ.COMP=%COMP_IOS;

   3302  1 001670   200030 471500                    LDP1    RESTORE$,,AUTO
         1 001671   100027 236100                    LDQ     23,,PR1
         1 001672   000012 376000 2                  ANQ     10
         1 001673   003000 276007                    ORQ     1536,DL
         1 001674   100027 756100                    STQ     23,,PR1

      990     3303    3                 RESTORE$->REQ.BPMIR = '1'B ;

   3303  1 001675   200030 471500                    LDP1    RESTORE$,,AUTO
         1 001676   200000 236003                    LDQ     65536,DU
         1 001677   100034 256100                    ORSQ    28,,PR1

      991     3304    3                 CALL NIO$DCWBLD(RESTORE$->REQ) ALTRET(REPOST);

   3304  1 001700   200030 630500                    EPPR0   RESTORE$,,AUTO
         1 001701   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 001702   000000 701000 xent               TSX1    NIO$DCWBLD
         1 001703   002201 702000 1                  TSX2    REPOST

      992     3305    3                 END;

      993     3306                   %LOCK (G#=SQH.GATE);

PL6.E3A0      #002=NID$POSTER File=NID$DISK.:E05TSI                              WED 07/30/97 03:30 Page:156  
   3307  1 001704   200032 630500                    EPPR0   SQH$,,AUTO
         1 001705   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 001706   000000 701000 xent               TSX1    HFC$LOCK
         1 001707   000000 011000                    NOP     0

      994     3309    3              IF RCVR.RETRY THEN DO;

   3309  1 001710   200031 234100                    SZN     RCVR,,AUTO
         1 001711   001722 605000 1                  TPL     s:3314

      995     3310                      %REQUEUE (P#=REQ,Q#=DCT.SQ$);

   3311  1 001712   200010 236100                    LDQ     DCT$,,AUTO
         1 001713   000001 036003                    ADLQ    1,DU
         1 001714   200027 235100                    LDA     REQ$,,AUTO
         1 001715   200040 757100                    STAQ    MNSTAT+1,,AUTO
         1 001716   200040 630500                    EPPR0   MNSTAT+1,,AUTO
         1 001717   000020 631400 xsym               EPPR1   B_VECTNIL+16
         1 001720   000000 701000 xent               TSX1    NIM$REQUEUE
         1 001721   000000 011000                    NOP     0

      996     3313    3                 END;

      997     3314    3              IF RESTORE$~=ADDR(NIL) THEN DO;

   3314  1 001722   200030 236100                    LDQ     RESTORE$,,AUTO
         1 001723   000001 116000 xsym               CMPQ    B_VECTNIL+1
         1 001724   001735 600000 1                  TZE     s:3319

      998     3315                      %REQUEUE (P#="RESTORE$->REQ",Q#=DCT.SQ$);

   3316  1 001725   200010 236100                    LDQ     DCT$,,AUTO
         1 001726   000001 036003                    ADLQ    1,DU
         1 001727   200030 235100                    LDA     RESTORE$,,AUTO
         1 001730   200040 757100                    STAQ    MNSTAT+1,,AUTO
         1 001731   200040 630500                    EPPR0   MNSTAT+1,,AUTO
         1 001732   000020 631400 xsym               EPPR1   B_VECTNIL+16
PL6.E3A0      #002=NID$POSTER File=NID$DISK.:E05TSI                              WED 07/30/97 03:30 Page:157  
         1 001733   000000 701000 xent               TSX1    NIM$REQUEUE
         1 001734   000000 011000                    NOP     0

      999     3318    3                 END;

     1000     3319    3              IF EXTST$~=ADDR(NIL) THEN DO;

   3319  1 001735   200012 236100                    LDQ     EXTST$,,AUTO
         1 001736   000001 116000 xsym               CMPQ    B_VECTNIL+1
         1 001737   001750 600000 1                  TZE     s:3324

     1001     3320                      %REQUEUE (P#="EXTST$->REQ",Q#=DCT.SQ$);

   3321  1 001740   200010 236100                    LDQ     DCT$,,AUTO
         1 001741   000001 036003                    ADLQ    1,DU
         1 001742   200012 235100                    LDA     EXTST$,,AUTO
         1 001743   200040 757100                    STAQ    MNSTAT+1,,AUTO
         1 001744   200040 630500                    EPPR0   MNSTAT+1,,AUTO
         1 001745   000020 631400 xsym               EPPR1   B_VECTNIL+16
         1 001746   000000 701000 xent               TSX1    NIM$REQUEUE
         1 001747   000000 011000                    NOP     0

     1002     3323    3                 END;

     1003     3324    2              IF  NOT RCVR.RETRY

   3324  1 001750   200031 234100                    SZN     RCVR,,AUTO
         1 001751   002027 604000 1                  TMI     s:3347
         1 001752   200027 470500                    LDP0    REQ$,,AUTO
         1 001753   000027 236100                    LDQ     23,,PR0
         1 001754   177000 376007                    ANQ     65024,DL
         1 001755   010000 116007                    CMPQ    4096,DL
         1 001756   002027 601000 1                  TNZ     s:3347
         1 001757   000034 234100                    SZN     28,,PR0
         1 001760   002027 605000 1                  TPL     s:3347

     1004     3325    2              AND REQ.COMP = %COMP_MIRROR
PL6.E3A0      #002=NID$POSTER File=NID$DISK.:E05TSI                              WED 07/30/97 03:30 Page:158  
     1005     3326    2              AND REQ.DOMIR
     1006     3327    3              THEN DO ;

     1007     3328    3                  IF  REQ.ERR$ ~= ADDR(NIL)

   3328  1 001761   000017 236100                    LDQ     15,,PR0
         1 001762   000001 116000 xsym               CMPQ    B_VECTNIL+1
         1 001763   001770 600000 1                  TZE     s:3331

     1008     3329    3                  THEN
     1009     3330    3                      CALL NIA$RELERR ( REQ ) ;

   3330  1 001764   200027 630500                    EPPR0   REQ$,,AUTO
         1 001765   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 001766   000000 701000 xent               TSX1    NIA$RELERR
         1 001767   000000 011000                    NOP     0

     1010     3331    3                  IF  MDCT$ = ADDR(NIL)

   3331  1 001770   200014 236100                    LDQ     MDCT$,,AUTO
         1 001771   000001 116000 xsym               CMPQ    B_VECTNIL+1
         1 001772   001775 601000 1                  TNZ     s:3334

     1011     3332    3                  THEN
     1012     3333    3                      CALL SC_NIDINVMIR ;

   3333  1 001773   000000 713400 xsym               CLIMB   SC_NIDINVMIR
         1 001774   000000 600000 xsid               climb   nvectors=         0

     1013     3334    3                  REQ.MIRDONE        = '1'B ;

   3334  1 001775   200027 470500                    LDP0    REQ$,,AUTO
         1 001776   100000 236003                    LDQ     32768,DU
         1 001777   000034 256100                    ORSQ    28,,PR0

     1014     3335    3                  REQ.DOMIR          = '0'B ;

PL6.E3A0      #002=NID$POSTER File=NID$DISK.:E05TSI                              WED 07/30/97 03:30 Page:159  
   3335  1 002000   000031 236000 xsym               LDQ     B_VECTNIL+25
         1 002001   000034 356100                    ANSQ    28,,PR0

     1015     3336    3                  REQ.DLA.DCTX       = MDCTX ;

   3336  1 002002   200015 236100                    LDQ     MDCTX,,AUTO
         1 002003   000025 736000                    QLS     21
         1 002004   000001 676100                    ERQ     1,,PR0
         1 002005   777770 376003                    ANQ     -8,DU
         1 002006   000001 656100                    ERSQ    1,,PR0

     1016     3337    3                  REQ.DCT$           = MDCT$ ;

   3337  1 002007   200014 236100                    LDQ     MDCT$,,AUTO
         1 002010   000002 756100                    STQ     2,,PR0

     1017     3338    3                  CALL NIO$DCWBLD  ( REQ   ) ;

   3338  1 002011   200027 630500                    EPPR0   REQ$,,AUTO
         1 002012   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 002013   000000 701000 xent               TSX1    NIO$DCWBLD
         1 002014   000000 011000                    NOP     0

     1018     3339                       %UNLOCK ( G# = SQH.GATE  ) ;

   3340  1 002015   200032 630500                    EPPR0   SQH$,,AUTO
         1 002016   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 002017   000000 701000 xent               TSX1    HFC$UNLOCK
         1 002020   000000 011000                    NOP     0

     1019     3342    3                  CALL NID$REQSCHED  ( REQ ) ;

   3342  1 002021   200027 630500                    EPPR0   REQ$,,AUTO
         1 002022   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 002023   000000 701000 xent               TSX1    NID$REQSCHED
         1 002024   000000 011000                    NOP     0

PL6.E3A0      #002=NID$POSTER File=NID$DISK.:E05TSI                              WED 07/30/97 03:30 Page:160  
     1020     3343    3                  COMP = '0'B ;

   3343  1 002025   200007 450100                    STZ     COMP,,AUTO

     1021     3344    3                  END ;

   3344  1 002026   002075 710000 1                  TRA     s:3362

     1022     3345    3              ELSE DO ;

     1023     3346                       %UNLOCK ( G# = SQH.GATE  ) ;

   3347  1 002027   200032 630500                    EPPR0   SQH$,,AUTO
         1 002030   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 002031   000000 701000 xent               TSX1    HFC$UNLOCK
         1 002032   000000 011000                    NOP     0

     1024     3349    3                  END ;

   3349  1 002033   002075 710000 1                  TRA     s:3362

     1025     3350    2            CASE(%COMP_IOS);

     1026     3351    2              RCVR='0'B;

   3351  1 002034   200031 450100                    STZ     RCVR,,AUTO

     1027     3352    3              IF REQ.FC=%N_EXTST THEN DO;

   3352  1 002035   000003 236100                    LDQ     3,,PR0
         1 002036   000777 376007                    ANQ     511,DL
         1 002037   000033 116007                    CMPQ    27,DL
         1 002040   002075 601000 1                  TNZ     s:3362

     1028     3353    3                 NEWSTATE=REQ.POSTER;

   3353  1 002041   000010 236100                    LDQ     8,,PR0
PL6.E3A0      #002=NID$POSTER File=NID$DISK.:E05TSI                              WED 07/30/97 03:30 Page:161  
         1 002042   000777 376007                    ANQ     511,DL
         1 002043   200016 756100                    STQ     NEWSTATE,,AUTO

     1029     3354    3                 REQ.STATUS=REQ.EAINFOP$->REQ.STATUS; /* PRINT PROPER MESSAGE */

   3354  1 002044   000024 471500                    LDP1    20,,PR0
         1 002045   100014 237100                    LDAQ    12,,PR1
         1 002046   000014 757100                    STAQ    12,,PR0

     1030     3355    3                 END;

   3355  1 002047   002075 710000 1                  TRA     s:3362

     1031     3356    2            CASE(%COMP_TD);

     1032     3357    2              RCVR='0'B;

   3357  1 002050   200031 450100                    STZ     RCVR,,AUTO

     1033     3358    2              REQ.EAINFO=CHANTIME;

   3358  1 002051   200006 235100                    LDA     CHANTIME,,AUTO
         1 002052   000024 755100                    STA     20,,PR0

     1034     3359    2              IF REQ.IOFLG.STOPMPC THEN CALL NIW$MPCSTART(DQH.MPC$->DCT);

   3359  1 002053   000004 236100                    LDQ     4,,PR0
         1 002054   001000 316007                    CANQ    512,DL
         1 002055   002065 600000 1                  TZE     s:3360

   3359  1 002056   200011 471500                    LDP1    DQH$,,AUTO
         1 002057   100015 473500                    LDP3    13,,PR1
         1 002060   200040 453500                    STP3    MNSTAT+1,,AUTO
         1 002061   200040 630500                    EPPR0   MNSTAT+1,,AUTO
         1 002062   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 002063   000000 701000 xent               TSX1    NIW$MPCSTART
         1 002064   000000 011000                    NOP     0
PL6.E3A0      #002=NID$POSTER File=NID$DISK.:E05TSI                              WED 07/30/97 03:30 Page:162  

     1035     3360    2              IF REQ.IOFLG.REL THEN DQH.MPC$->DCT.DFLG.MPCSUSPENDED='0'B;

   3360  1 002065   200027 470500                    LDP0    REQ$,,AUTO
         1 002066   000004 236100                    LDQ     4,,PR0
         1 002067   002000 316007                    CANQ    1024,DL
         1 002070   002075 600000 1                  TZE     s:3362

   3360  1 002071   200011 471500                    LDP1    DQH$,,AUTO
         1 002072   100015 473500                    LDP3    13,,PR1
         1 002073   000030 236000 2                  LDQ     24
         1 002074   300006 356100                    ANSQ    6,,PR3

     1036     3361    2            END;

     1037     3362    1           IF  NEWSTATE ~= %IDLE

   3362  1 002075   200016 235100                    LDA     NEWSTATE,,AUTO
         1 002076   002116 600000 1                  TZE     s:3373

     1038     3363    2           THEN DO ;

     1039     3364    2               IF  DCT.DP.MIRROR.FLAG

   3364  1 002077   200010 470500                    LDP0    DCT$,,AUTO
         1 002100   000036 234100                    SZN     30,,PR0
         1 002101   002113 604000 1                  TMI     s:3369
         1 002102   002116 604000 1                  TMI     s:3373
         1 002103   000036 236100                    LDQ     30,,PR0
         1 002104   007700 376003                    ANQ     4032,DU
         1 002105   000100 116003                    CMPQ    64,DU
         1 002106   002116 601000 1                  TNZ     s:3373
         1 002107   200027 471500                    LDP1    REQ$,,AUTO
         1 002110   100001 236100                    LDQ     1,,PR1
         1 002111   000031 316000 2                  CANQ    25
         1 002112   002116 601000 1                  TNZ     s:3373

PL6.E3A0      #002=NID$POSTER File=NID$DISK.:E05TSI                              WED 07/30/97 03:30 Page:163  
     1040     3365    2               OR  ( NOT DCT.DP.MIRROR.FLAG
     1041     3366    2                     AND DCT.DP.MIRROR.STATE = %NI_MIRROR_FAIL
     1042     3367    2                     AND REQ.DLA.DRELADDR    = 0               )
     1043     3368    3               THEN DO ;

     1044     3369    3                   NEWSTATE   = %IDLE ;

   3369  1 002113   200016 450100                    STZ     NEWSTATE,,AUTO

     1045     3370    3                   RCVR.OPMSG = '0'B ;

   3370  1 002114   000032 236000 2                  LDQ     26
         1 002115   200031 356100                    ANSQ    RCVR,,AUTO

     1046     3371    3                   END ;

     1047     3372    2               END ;

     1048     3373    2           IF NEWSTATE~=%IDLE AND DCT.DFLG.AUTOERROR THEN DO;

   3373  1 002116   200016 235100                    LDA     NEWSTATE,,AUTO
         1 002117   002132 600000 1                  TZE     s:3378
         1 002120   200010 470500                    LDP0    DCT$,,AUTO
         1 002121   000006 236100                    LDQ     6,,PR0
         1 002122   000020 316007                    CANQ    16,DL
         1 002123   002132 600000 1                  TZE     s:3378

     1049     3374    2              REQ.TYC.OPER='1'B;

   3374  1 002124   200027 471500                    LDP1    REQ$,,AUTO
         1 002125   200000 236003                    LDQ     65536,DU
         1 002126   100021 256100                    ORSQ    17,,PR1

     1050     3375    2              NEWSTATE=%IDLE;

   3375  1 002127   200016 450100                    STZ     NEWSTATE,,AUTO

PL6.E3A0      #002=NID$POSTER File=NID$DISK.:E05TSI                              WED 07/30/97 03:30 Page:164  
     1051     3376    2              RCVR.OPMSG='0'B;

   3376  1 002130   000032 236000 2                  LDQ     26
         1 002131   200031 356100                    ANSQ    RCVR,,AUTO

     1052     3377    2              END;

     1053     3378    2           IF NEWSTATE~=%IDLE OR RCVR.OPMSG THEN DO;

   3378  1 002132   200016 235100                    LDA     NEWSTATE,,AUTO
         1 002133   002137 601000 1                  TNZ     s:3379
         1 002134   200031 236100                    LDQ     RCVR,,AUTO
         1 002135   010000 316003                    CANQ    4096,DU
         1 002136   002154 600000 1                  TZE     s:3381

     1054     3379    2              CALL NIK$OPMSG(DCT,DP_MSG#,M_DISK,NEWSTATE,REQ);

   3379  1 002137   200027 236100                    LDQ     REQ$,,AUTO
         1 002140   200044 756100                    STQ     MNSTAT+5,,AUTO
         1 002141   200016 630500                    EPPR0   NEWSTATE,,AUTO
         1 002142   200043 450500                    STP0    MNSTAT+4,,AUTO
         1 002143   000020 236000 2                  LDQ     16
         1 002144   200042 756100                    STQ     MNSTAT+3,,AUTO
         1 002145   000034 236000 2                  LDQ     28
         1 002146   200010 235100                    LDA     DCT$,,AUTO
         1 002147   200040 757100                    STAQ    MNSTAT+1,,AUTO
         1 002150   200040 630500                    EPPR0   MNSTAT+1,,AUTO
         1 002151   000023 631400 xsym               EPPR1   B_VECTNIL+19
         1 002152   000000 701000 xent               TSX1    NIK$OPMSG
         1 002153   000000 011000                    NOP     0

     1055     3380    2              END;

     1056     3381    1           CALL NID$DEVSCHED(DCT,NEWSTATE);

   3381  1 002154   200016 630500                    EPPR0   NEWSTATE,,AUTO
         1 002155   200041 450500                    STP0    MNSTAT+2,,AUTO
PL6.E3A0      #002=NID$POSTER File=NID$DISK.:E05TSI                              WED 07/30/97 03:30 Page:165  
         1 002156   200010 236100                    LDQ     DCT$,,AUTO
         1 002157   200040 756100                    STQ     MNSTAT+1,,AUTO
         1 002160   200040 630500                    EPPR0   MNSTAT+1,,AUTO
         1 002161   000020 631400 xsym               EPPR1   B_VECTNIL+16
         1 002162   000000 701000 xent               TSX1    NID$DEVSCHED
         1 002163   000000 011000                    NOP     0

     1057     3382    1           IF  COMP

   3382  1 002164   200007 234100                    SZN     COMP,,AUTO
         1 002165   002200 605000 1                  TPL     s:3386
         1 002166   200031 234100                    SZN     RCVR,,AUTO
         1 002167   002200 604000 1                  TMI     s:3386

     1058     3383    1           AND NOT RCVR.RETRY
     1059     3384    1           THEN
     1060     3385    1               CALL NIO$COMP ( REQ, NI$EXTST ) ;

   3385  1 002170   200017 630500                    EPPR0   NI$EXTST,,AUTO
         1 002171   200041 450500                    STP0    MNSTAT+2,,AUTO
         1 002172   200027 236100                    LDQ     REQ$,,AUTO
         1 002173   200040 756100                    STQ     MNSTAT+1,,AUTO
         1 002174   200040 630500                    EPPR0   MNSTAT+1,,AUTO
         1 002175   000020 631400 xsym               EPPR1   B_VECTNIL+16
         1 002176   000000 701000 xent               TSX1    NIO$COMP
         1 002177   000000 011000                    NOP     0

     1061     3386    1           RETURN;

   3386  1 002200   000000 702200 xent               TSX2  ! X66_ARET

     1062     3387        /**/
     1063     3388    1   REPOST:
     1064     3389    2           IF  EXTST$ ~= ADDR(NIL)  THEN DO ;

   3389  1 002201   200012 236100       REPOST       LDQ     EXTST$,,AUTO
         1 002202   000001 116000 xsym               CMPQ    B_VECTNIL+1
PL6.E3A0      #002=NID$POSTER File=NID$DISK.:E05TSI                              WED 07/30/97 03:30 Page:166  
         1 002203   002215 600000 1                  TZE     s:3393

     1065     3390    2               EXTST$->REQ.IOQFLG.IOQUED = '0'B ;

   3390  1 002204   200012 470500                    LDP0    EXTST$,,AUTO
         1 002205   000035 236000 2                  LDQ     29
         1 002206   000033 356100                    ANSQ    27,,PR0

     1066     3391    2               CALL NIQ$REL ( EXTST$ ) ;

   3391  1 002207   200012 631500                    EPPR1   EXTST$,,AUTO
         1 002210   200040 451500                    STP1    MNSTAT+1,,AUTO
         1 002211   200040 630500                    EPPR0   MNSTAT+1,,AUTO
         1 002212   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 002213   000000 701000 xent               TSX1    NIQ$REL
         1 002214   000000 011000                    NOP     0

     1067     3392    2               END ;

     1068     3393    2           IF  RESTORE$ ~= ADDR(NIL)  THEN DO ;

   3393  1 002215   200030 236100                    LDQ     RESTORE$,,AUTO
         1 002216   000001 116000 xsym               CMPQ    B_VECTNIL+1
         1 002217   002231 600000 1                  TZE     s:3398

     1069     3394    2               RESTORE$->REQ.IOQFLG.IOQUED = '0'B ;

   3394  1 002220   200030 470500                    LDP0    RESTORE$,,AUTO
         1 002221   000035 236000 2                  LDQ     29
         1 002222   000033 356100                    ANSQ    27,,PR0

     1070     3395    2               CALL NIQ$REL ( RESTORE$ ) ;

   3395  1 002223   200030 631500                    EPPR1   RESTORE$,,AUTO
         1 002224   200040 451500                    STP1    MNSTAT+1,,AUTO
         1 002225   200040 630500                    EPPR0   MNSTAT+1,,AUTO
         1 002226   000017 631400 xsym               EPPR1   B_VECTNIL+15
PL6.E3A0      #002=NID$POSTER File=NID$DISK.:E05TSI                              WED 07/30/97 03:30 Page:167  
         1 002227   000000 701000 xent               TSX1    NIQ$REL
         1 002230   000000 011000                    NOP     0

     1071     3396    2               END ;

     1072     3397                %LOCK (G#=NI$RP.GATE);

   3398  1 002231   000000 630400 xsym               EPPR0   NI$RP$
         1 002232   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 002233   000000 701000 xent               TSX1    HFC$LOCK
         1 002234   000000 011000                    NOP     0

     1073     3400                %ENQUEUE (Q#=NI$RP.RP$,P#=REQ);

   3401  1 002235   000000 236000 xsym               LDQ     NI$RP$
         1 002236   000002 036003                    ADLQ    2,DU
         1 002237   200027 235100                    LDA     REQ$,,AUTO
         1 002240   200040 757100                    STAQ    MNSTAT+1,,AUTO
         1 002241   200040 630500                    EPPR0   MNSTAT+1,,AUTO
         1 002242   000020 631400 xsym               EPPR1   B_VECTNIL+16
         1 002243   000000 701000 xent               TSX1    NIM$ENQUEUE
         1 002244   000000 011000                    NOP     0

     1074     3403                %UNLOCK (G#=NI$RP.GATE);

   3404  1 002245   000000 630400 xsym               EPPR0   NI$RP$
         1 002246   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 002247   000000 701000 xent               TSX1    HFC$UNLOCK
         1 002250   000000 011000                    NOP     0

     1075     3406    1           CALL NID$DEVSCHED(DCT,%SUSPENDED);

   3406  1 002251   000036 236000 2                  LDQ     30
         1 002252   200010 235100                    LDA     DCT$,,AUTO
         1 002253   200040 757100                    STAQ    MNSTAT+1,,AUTO
         1 002254   200040 630500                    EPPR0   MNSTAT+1,,AUTO
         1 002255   000020 631400 xsym               EPPR1   B_VECTNIL+16
PL6.E3A0      #002=NID$POSTER File=NID$DISK.:E05TSI                              WED 07/30/97 03:30 Page:168  
         1 002256   000000 701000 xent               TSX1    NID$DEVSCHED
         1 002257   000000 011000                    NOP     0

     1076     3407    1           RETURN;

   3407  1 002260   000000 702200 xent               TSX2  ! X66_ARET

     1077     3408        %EJECT;
PL6.E3A0      #002=NID$POSTER File=NID$DISK.:E05TSI                              WED 07/30/97 03:30 Page:169  
     1078     3409    1   CHECKMINOR: PROC(TBL);

   3409  1 002261   200034 741300       CHECKMINOR   STX1  ! SQH$+2,,AUTO

     1079     3410        /**/
     1080     3411        /* SET RCVR, TYC AND NEWSTATE BASED ON MINOR STATUS BITS. */
     1081     3412        /**/
     1082     3413    2   DCL 1 TBL ALIGNED,
     1083     3414    2         2 TYC(0:6) BIT(36),
     1084     3415    2         2 RCVR(0:6) BIT(36),
     1085     3416    2         2 STATE(0:6) UBIN;
     1086     3417    2   DCL I UBIN;
     1087     3418    2   DCL 1 MNSTAT ALIGNED,
     1088     3419    2         2 BT(0:5) BIT(1);
     1089     3420        /**/
     1090     3421        /**/
     1091     3422        /**/
     1092     3423    3           IF REQ.STATUS.MINOR='0'B THEN DO;

   3423  1 002262   200027 470500                    LDP0    REQ$,,AUTO
         1 002263   000014 236100                    LDQ     12,,PR0
         1 002264   007700 316003                    CANQ    4032,DU
         1 002265   002276 601000 1                  TNZ     s:3429

     1093     3424    3              REQ.TYC=TBL.TYC(0);

   3424  1 002266   200035 471500                    LDP1    @TBL,,AUTO
         1 002267   100000 236100                    LDQ     0,,PR1
         1 002270   000021 756100                    STQ     17,,PR0

     1094     3425    3              RCVR=TBL.RCVR(0);

   3425  1 002271   100007 236100                    LDQ     7,,PR1
         1 002272   200031 756100                    STQ     RCVR,,AUTO

     1095     3426    3              NEWSTATE=TBL.STATE(0);

PL6.E3A0      #002=NID$POSTER File=NID$DISK.:E05TSI                              WED 07/30/97 03:30 Page:170  
   3426  1 002273   100016 235100                    LDA     14,,PR1
         1 002274   200016 755100                    STA     NEWSTATE,,AUTO

     1096     3427    3              END;

   3427  1 002275   002333 710000 1                  TRA     s:3438

     1097     3428    3           ELSE DO;

     1098     3429    3              MNSTAT=REQ.STATUS.MINOR;

   3429  1 002276   000014 236100                    LDQ     12,,PR0
         1 002277   000006 736000                    QLS     6
         1 002300   770000 376003                    ANQ     -4096,DU
         1 002301   200037 756100                    STQ     MNSTAT,,AUTO

     1099     3430    4              DO I=0 TO 5;

   3430  1 002302   200036 450100                    STZ     I,,AUTO

     1100     3431    5                 IF MNSTAT.BT(I) THEN DO;

   3431  1 002303   200036 235100                    LDA     I,,AUTO
         1 002304   000000 066505                    CMPB    filb='0'B
         1 002305   200037 000001                    BDSC    MNSTAT,A,AUTO            by=0,bit=0,n=1
         1 002306   000002 000022 xsym               BDSC    B_VECTNIL+2              by=0,bit=0,n=18
         1 002307   002326 600000 1                  TZE     s:3436

     1101     3432    5                    REQ.TYC=REQ.TYC|TBL.TYC(I+1);

   3432  1 002310   200027 470500                    LDP0    REQ$,,AUTO
         1 002311   200035 471500                    LDP1    @TBL,,AUTO
         1 002312   000021 236100                    LDQ     17,,PR0
         1 002313   100001 276105                    ORQ     1,AL,PR1
         1 002314   000021 756100                    STQ     17,,PR0

     1102     3433    5                    RCVR=RCVR|TBL.RCVR(I+1);
PL6.E3A0      #002=NID$POSTER File=NID$DISK.:E05TSI                              WED 07/30/97 03:30 Page:171  

   3433  1 002315   200036 720100                    LXL0    I,,AUTO
         1 002316   200031 236100                    LDQ     RCVR,,AUTO
         1 002317   100010 276110                    ORQ     8,X0,PR1
         1 002320   200031 756100                    STQ     RCVR,,AUTO

     1103     3434    5                    IF NEWSTATE<TBL.STATE(I+1) THEN NEWSTATE=TBL.STATE(I+1);

   3434  1 002321   200016 236100                    LDQ     NEWSTATE,,AUTO
         1 002322   100017 116110                    CMPQ    15,X0,PR1
         1 002323   002326 603000 1                  TRC     s:3436

   3434  1 002324   100017 235110                    LDA     15,X0,PR1
         1 002325   200016 755100                    STA     NEWSTATE,,AUTO

     1104     3435    5                    END;

     1105     3436    4                 END;

   3436  1 002326   200036 235100                    LDA     I,,AUTO
         1 002327   000001 035007                    ADLA    1,DL
         1 002330   200036 755100                    STA     I,,AUTO
         1 002331   000006 115007                    CMPA    6,DL
         1 002332   002303 602000 1                  TNC     s:3431

     1106     3437    3              END;

     1107     3438    2           RETURN;

   3438  1 002333   200034 221300                    LDX1  ! SQH$+2,,AUTO
         1 002334   000001 702211                    TSX2  ! 1,X1

     1108     3439    2   END CHECKMINOR;
     1109     3440        %EJECT;
PL6.E3A0      #002=NID$POSTER File=NID$DISK.:E05TSI                              WED 07/30/97 03:30 Page:172  
     1110     3441    1   RELCHAN: PROC;

   3441  1 002335   200034 741300       RELCHAN      STX1  ! SQH$+2,,AUTO

     1111     3442    2           DQH.STATE=%IDLE;

   3442  1 002336   200011 470500                    LDP0    DQH$,,AUTO
         1 002337   000000 236003                    LDQ     0,DU
         1 002340   000001 752101                    STCQ    1,'01'O,PR0

     1112     3443    3           IF DQH.CHANSTATE THEN DO;

   3443  1 002341   000020 236100                    LDQ     16,,PR0
         1 002342   740000 316003                    CANQ    -16384,DU
         1 002343   002366 600000 1                  TZE     s:3454

     1113     3444    4              IF DQH.CHANSTATE.STOP THEN DO;

   3444  1 002344   000020 234100                    SZN     16,,PR0
         1 002345   002401 605000 1                  TPL     s:3459

     1114     3445                      %UNLOCK (G#=SQH.GATE);

   3446  1 002346   200032 630500                    EPPR0   SQH$,,AUTO
         1 002347   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 002350   000000 701000 xent               TSX1    HFC$UNLOCK
         1 002351   000000 011000                    NOP     0

     1115     3448    4                 CALL NIW$MPCSTOP(DQH.MPC$->DCT);

   3448  1 002352   200011 470500                    LDP0    DQH$,,AUTO
         1 002353   000015 471500                    LDP1    13,,PR0
         1 002354   200040 451500                    STP1    MNSTAT+1,,AUTO
         1 002355   200040 630500                    EPPR0   MNSTAT+1,,AUTO
         1 002356   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 002357   000000 701000 xent               TSX1    NIW$MPCSTOP
         1 002360   000000 011000                    NOP     0
PL6.E3A0      #002=NID$POSTER File=NID$DISK.:E05TSI                              WED 07/30/97 03:30 Page:173  

     1116     3449                      %LOCK (G#=SQH.GATE);

   3450  1 002361   200032 630500                    EPPR0   SQH$,,AUTO
         1 002362   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 002363   000000 701000 xent               TSX1    HFC$LOCK
         1 002364   000000 011000                    NOP     0

     1117     3452    4                 END;

     1118     3453    3              END;

   3453  1 002365   002401 710000 1                  TRA     s:3459

     1119     3454    3           ELSE IF NOT DQH.STATUS.DOWN THEN DO;

   3454  1 002366   000001 236100                    LDQ     1,,PR0
         1 002367   200000 316003                    CANQ    65536,DU
         1 002370   002401 601000 1                  TNZ     s:3459

     1120     3455                      %ENQUEUE (P#=DQH,Q#=SQH.CQ$);

   3456  1 002371   200032 236100                    LDQ     SQH$,,AUTO
         1 002372   000004 036003                    ADLQ    4,DU
         1 002373   200011 235100                    LDA     DQH$,,AUTO
         1 002374   200040 757100                    STAQ    MNSTAT+1,,AUTO
         1 002375   200040 630500                    EPPR0   MNSTAT+1,,AUTO
         1 002376   000020 631400 xsym               EPPR1   B_VECTNIL+16
         1 002377   000000 701000 xent               TSX1    NIM$ENQUEUE
         1 002400   000000 011000                    NOP     0

     1121     3458    3                 END;

     1122     3459    2           RETURN;

   3459  1 002401   200034 221300                    LDX1  ! SQH$+2,,AUTO
         1 002402   000001 702211                    TSX2  ! 1,X1
PL6.E3A0      #002=NID$POSTER File=NID$DISK.:E05TSI                              WED 07/30/97 03:30 Page:174  

READY_STAT
 Sect OctLoc
   0     000   000000 000000   000000 000000   000000 000000   001000 000000    ................
   0     004   000000 000000   000000 000000   000000 000000   000000 000000    ................
   0     010   100000 000000   100000 000000   500000 000000   100000 000000    @...@.......@...
   0     014   100000 000000   100000 000000   000000 000000   000000 000000    @...@...........
   0     020   000000 000000   000000 000000   000000 000000   000000 000000    ................
   0     024   000000 000000                                                    ....

ATT_STAT
 Sect OctLoc
   0     025   001000 000000   001000 000000   001000 000000   001000 000000    ................
   0     031   001000 000000   001000 000000   000004 000000   520000 000000    ................
   0     035   520000 000000   520000 000000   520000 000000   520000 000000    ................
   0     041   560000 000000   520000 000000   000000 000003   000000 000003    ................
   0     045   000000 000003   000000 000003   000000 000003   000000 000003    ................
   0     051   000000 000003                                                    ....

DAL_STAT
 Sect OctLoc
   0     052   001000 000000   000000 000000   001000 000000   001000 000000    ................
   0     056   001000 000000   001000 000000   001000 000000   520000 000000    ................
   0     062   000000 000000   520000 000000   560000 000000   520000 000000    ................
   0     066   520000 000000   520000 000000   000000 000000   000000 000000    ................
   0     072   000000 000000   000000 000000   000000 000000   000000 000000    ................
   0     076   000000 000000                                                    ....

CHECKBITS
 Sect OctLoc
   0     100   377700 770000   000000 000000                                    ........

(unnamed)
 Sect OctLoc
   0     102   604000 000000   500000 000000   540000 000000   520000 000000    ................

(unnamed)
PL6.E3A0      #002=NID$POSTER File=NID$DISK.:E05TSI                              WED 07/30/97 03:30 Page:175  
 Sect OctLoc
   2     000   000000 000315   000000 006000   000000 006000   000002 006000    ................
   2     004   000102 006000   000005 006000   000004 006000   777777 777757    .B..............
   2     010   000003 006000   000027 400000   777777 600777   777777 776777    ................
   2     014   777777 773777   000000 000224   100000 000000   000015 006000    ........@.......
   2     020   000016 006000   000006 006000   000000 006000   000025 006000    ................
   2     024   000052 006000   000000 000311   000025 006000   677777 777777    .*..............
   2     030   777777 775777   000007 777777   767777 777777   000000 000214    ................
   2     034   000033 006000   577777 777777   000010 006000                    ............
     1123     3460    2   END RELCHAN;
     1124     3461    1   END NID$POSTER;

PL6.E3A0      #002=NID$POSTER File=NID$DISK.:E05TSI                              WED 07/30/97 03:30 Page:176  
--  Include file information  --

   PM$NI.:E05TOU  is referenced.
   OC_SUBS_C.:E05TOU  is referenced.
   N_FC_C.:E05TOU  is referenced.
   NI_MACROS_C.:E05TOU  cannot be made into a system file and is referenced.
   NI$TABLES.:E05TOU  is referenced.
   N$REQ.:E05TOU  is referenced.
   NI_DATA_R.:E05TOU  cannot be made into a system file and is referenced.
   NI_DATA_C.:E05TOU  is referenced.
   NI$ERRLOG.:E05TOU  is referenced.
   HF_DATA_R.:E05TOU  cannot be made into a system file and is referenced.
   HF_LOCK_C.:E05TOU  cannot be made into a system file and is referenced.
   EL_SUBS_C.:E05TOU  is referenced.
   CP_6_SUBS.:E05TOU  is referenced.
      No diagnostics issued in procedure NID$POSTER.
PL6.E3A0      #002=NID$POSTER File=NID$DISK.:E05TSI                              WED 07/30/97 03:30 Page:177  

 **** Variables and constants ****

  ****  Section 000 RoData NID$POSTER

  ****  Scalars and arrays  ****
OctLoc.c.b A Datatyp(siz) R M Lvl/name                 OctLoc.c.b A Datatyp(siz) R M Lvl/name

    25-0-0/w STRC(756)   r     1 ATT_STAT                 100-0-0/d BIT (72)    r     1 CHECKBITS
    52-0-0/w STRC(756)   r     1 DAL_STAT                   0-0-0/w STRC(756)   r     1 READY_STAT

  ****  Auto variables  ****

  ****  Scalars and arrays  ****
OctLoc.c.b A Datatyp(siz) R M Lvl/name                 OctLoc.c.b A Datatyp(siz) R M Lvl/name

     4-0-0/w PTR         r     1 @INTLVL                    3-0-0/w PTR         r     1 @PAR
     5-0-0/w PTR         r     1 @STATUS                   35-0-0/w PTR         r     1 @TBL
     6-0-0/w UBIN        r     1 CHANTIME                   7-0-0/w BIT         r     1 COMP
    10-0-0/w PTR         r     1 DCT$                      11-0-0/w PTR         r     1 DQH$
    12-0-0/w PTR         r     1 EXTST$                    13-0-0/w SBIN        r     1 I
    36-0-0/w UBIN        r     1 I                         *0-0-0/w UBIN(18)    r     1 INTLVL
    14-0-0/w PTR         r     1 MDCT$                     15-0-0/w UBIN        r     1 MDCTX
    37-0-0/w STRC(6)     r     1 MNSTAT                    16-0-0/w UBIN        r     1 NEWSTATE
    17-0-0/w STRC(288)   r     1 NI$EXTST                  *0-0-0/w PTR         r     1 PAR
    31-0-0/w STRC        r     1 RCVR                      27-0-0/w PTR         r     1 REQ$
    30-0-0/w PTR         r     1 RESTORE$                  *0-0-0/d STRC(72)    r     1 SPSTAT
    32-0-0/w PTR         r     1 SQH$                      *0-0-0/d STRC(72)    r     1 STATUS
    *0-0-0/w STRC(756)   r     1 TBL

  ****  SYMREF variables  ****

  ****  Scalars and arrays  ****
OctLoc.c.b A Datatyp(siz) R M Lvl/name                 OctLoc.c.b A Datatyp(siz) R M Lvl/name

     0-0-0/w BIT         r     1 HW_EXT_STATUS              0-0-0/w BIT         r     1 HW_IMX
     0-0-0/w BIT         r     1 HW_IOP                     0-0-0/w PTR         r     1 N$DCT$$
     0-0-0/w PTR         r     1 N$FQ$                      0-0-0/w PTR         r     1 NI$FQ$
PL6.E3A0      #002=NID$POSTER File=NID$DISK.:E05TSI                              WED 07/30/97 03:30 Page:178  
     0-0-0/w PTR         r     1 NI$IBUF$                   0-0-0/w PTR         r     1 NI$RP$
     0-0-0/d BIT (72)    r     1 NI_DBLZERO

  ****  BASED and DCB variables  ****

  ****  Scalars and arrays  ****
OctLoc.c.b A Datatyp(siz) R M Lvl/name                 OctLoc.c.b A Datatyp(siz) R M Lvl/name

     0-0-0/w STRC(1332)  r     1 DCT                        0-0-0/w STRC(648)   r     1 DQH
     0-0-0/d STRC(576)   r     1 IOSTAT                     0-0-0/d STRC(144)   r     1 MBX
     0-0-0/w STRC(1332)  r     1 MDCT                       0-0-0/w PTR         r     1 N$DCT$(0:0)
     0-0-0/w STRC(612)   r     1 NI$IOERR                   0-0-0/w STRC(180)   r     1 NI$RP
     0-0-0/d STRC(1080)  r     1 REQ                        0-0-0/w STRC(252)   r     1 SQH


   Procedure NID$POSTER requires 1283 words for executable code.
   Procedure NID$POSTER requires 38 words of local(AUTO) storage.

    No errors detected in file NID$DISK.:E05TSI    .
PL6.E3A0      #002=NID$POSTER File=NID$DISK.:E05TSI                              WED 07/30/97 03:30 Page:179  
          *** CROSS REFERENCE LISTING ***
**     DENOTES     IDENTIFIER DEFINITION
<<                 IDENTIFIER'S VALUE SET
>>                 IDENTIFIER'S VALUE USED
<>                 IDENTIFIER SET AND/OR USED
--                 IDENTIFIER REFERENCED
PL6.E3A0      #002=NID$POSTER File=NID$DISK.:E05TSI                              WED 07/30/97 03:30 Page:180  
          MINI XREF LISTING

ATT_STAT
      2890**DCL      3189<>CALL
CHANTIME
      2510**DCL      2951<>CALL     3358>>ASSIGN
CHECKBITS
      2914**DCL      2974>>IF
CHECKMINOR
      3409**PROC     3173--CALL     3189--CALL     3191--CALL
COMP
      2511**DCL      2978<<ASSIGN   2992<<ASSIGN   3042>>IF       3231<<ASSIGN   3343<<ASSIGN   3382>>IF
DAL_STAT
      2903**DCL      3191<>CALL
DCT
      2576**DCL      3039<>CALL     3094<>CALL     3109<>CALL     3157<>CALL     3158<>CALL     3161<>CALL
      3257<>CALL     3258<>CALL     3359<>CALL     3379<>CALL     3381<>CALL     3406<>CALL     3448<>CALL
DCT.CTYP
      2584**DCL      3152>>IF
DCT.DFLG.AUTOERROR
      2583**DCL      3041<<ASSIGN   3076<<ASSIGN   3373>>IF
DCT.DFLG.MPCSTOP
      2581**DCL      3155<<ASSIGN
DCT.DFLG.MPCSUSPENDED
      2581**DCL      3360<<ASSIGN
DCT.DFLG.RELOAD
      2580**DCL      3156<<ASSIGN
DCT.DP
      2596**DCL      2603--REDEF    2606--REDEF    2607--REDEF    2609--REDEF    2609--REDEF    2610--REDEF
      2611--REDEF    2611--REDEF
DCT.DP.BQ$
      2596**DCL      3018>>ASSIGN   3019<<ASSIGN   3024>>IF
DCT.DP.CSEEK
      2597**DCL      3030<<ASSIGN
PL6.E3A0      #002=NID$POSTER File=NID$DISK.:E05TSI                              WED 07/30/97 03:30 Page:181  
DCT.DP.LEAPERS
      2598**DCL      3020<<ASSIGN
DCT.DP.MIRROR.DCTX
      2601**DCL      2948>>ASSIGN   3069>>ASSIGN   3124>>ASSIGN
DCT.DP.MIRROR.FLAG
      2598**DCL      2946>>IF       3067>>IF       3101>>IF       3122>>IF       3144>>IF       3238>>IF
      3364>>IF       3364>>IF
DCT.DP.MIRROR.STATE
      2600**DCL      3364>>IF
DCT.DP.RELCHAN
      2598**DCL      3009>>IF       3022<<ASSIGN   3038<<ASSIGN
DCT.DP.SWP
      2596**DCL      3021<<ASSIGN   3021>>ASSIGN
DCT.DQH$
      2592**DCL      3128>>ASSIGN
DCT.DVN
      2585**DCL      3072>>IF
DCT.FIPS
      2584**DCL      3178>>IF       3202>>IF       3204>>IF
DCT.MPC.IOCHANX
      2604**DCL      2604--REDEF
DCT.MSG#
      2596**DCL      3089>>IF       3090<>CALL     3091<<ASSIGN
DCT.PM
      2587**DCL      3025<>CALL     3028<>CALL     3051<>CALL
DCT.SPSTAT
      2588**DCL      3083<<ASSIGN
DCT.SPSTAT.CODE
      2590**DCL      3084>>IF       3102>>IF       3107>>IF       3108<<ASSIGN
DCT.SPSTAT.PRESENCE
      2588**DCL      3077>>IF       3093<<ASSIGN   3112<<ASSIGN
DCT.SQ$
      2576**DCL      3009>>IF       3014<>CALL     3017>>IF       3018<<ASSIGN   3024>>IF       3255<>CALL
      3311<>CALL     3316<>CALL     3321<>CALL
DCT.SQH$
      2591**DCL      3127>>ASSIGN
PL6.E3A0      #002=NID$POSTER File=NID$DISK.:E05TSI                              WED 07/30/97 03:30 Page:182  
DCT.STATE
      2586**DCL      3084>>IF       3085<<ASSIGN
DCT.TYPE
      2586**DCL      3072>>IF
DCT$
      2512**DCL      2576--IMP-PTR  2945<<ASSIGN   2946>>IF       2948>>ASSIGN   3009>>IF       3009>>IF
      3014>>CALL     3017>>IF       3018>>ASSIGN   3018>>ASSIGN   3019>>ASSIGN   3020>>ASSIGN   3021>>ASSIGN
      3021>>ASSIGN   3022>>ASSIGN   3024>>IF       3024>>IF       3025>>CALL     3028>>CALL     3030>>ASSIGN
      3038>>ASSIGN   3039>>CALL     3041>>ASSIGN   3051>>CALL     3066<<ASSIGN   3067>>IF       3069>>ASSIGN
      3072>>IF       3072>>IF       3076>>ASSIGN   3077>>IF       3083>>ASSIGN   3084>>IF       3084>>IF
      3085>>ASSIGN   3089>>IF       3090>>CALL     3091>>ASSIGN   3093>>ASSIGN   3094>>CALL     3101>>IF
      3102>>IF       3107>>IF       3108>>ASSIGN   3109>>CALL     3112>>ASSIGN   3121<<ASSIGN   3122>>IF
      3124>>ASSIGN   3127>>ASSIGN   3128>>ASSIGN   3144>>IF       3152>>IF       3158>>CALL     3178>>IF
      3202>>IF       3204>>IF       3238>>IF       3255>>CALL     3257>>CALL     3258>>CALL     3311>>CALL
      3316>>CALL     3321>>CALL     3364>>IF       3364>>IF       3364>>IF       3373>>IF       3379>>CALL
      3381>>CALL     3406>>CALL
DQH
      2624**DCL      2932<>CALL     2936<>CALL     2938<>CALL     2970<>CALL     3031<>CALL     3058<>CALL
      3117<>CALL     3203<>CALL     3456<>CALL
DQH.CHANSTATE
      2632**DCL      3443>>IF
DQH.CHANSTATE.STOP
      2632**DCL      3444>>IF
DQH.IO$
      2631**DCL      2944>>ASSIGN   3014<>CALL     3030>>ASSIGN
DQH.IOCHANX
      2626**DCL      2627--REDEF
DQH.IOSTATUS$
      2631**DCL      2933>>IF       2936>>CALL     2953>>ASSIGN   2957>>ASSIGN   3049>>ASSIGN
DQH.MBX$
      2635**DCL      2636--REDEF    2955>>ASSIGN
DQH.MPC$
      2631**DCL      3155>>ASSIGN   3156>>ASSIGN   3157>>CALL     3161>>CALL     3359>>CALL     3360>>ASSIGN
      3448>>CALL
DQH.PM
      2628**DCL      2951<>CALL
PL6.E3A0      #002=NID$POSTER File=NID$DISK.:E05TSI                              WED 07/30/97 03:30 Page:183  
DQH.SQH$
      2630**DCL      2924>>ASSIGN   3064>>ASSIGN
DQH.STATE
      2628**DCL      2928>>IF       3442<<ASSIGN
DQH.STATUS.DOWN
      2624**DCL      3454>>IF
DQH$
      2513**DCL      2624--IMP-PTR  2923<<ASSIGN   2924>>ASSIGN   2928>>IF       2932>>CALL     2933>>IF
      2936>>CALL     2936>>CALL     2938>>CALL     2944>>ASSIGN   2951>>CALL     2953>>ASSIGN   2955>>ASSIGN
      2957>>ASSIGN   2970>>CALL     3014>>CALL     3030>>ASSIGN   3031>>CALL     3049>>ASSIGN   3057<<ASSIGN
      3058>>CALL     3063<<ASSIGN   3064>>ASSIGN   3117>>CALL     3128<<ASSIGN   3155>>ASSIGN   3156>>ASSIGN
      3157>>CALL     3161>>CALL     3203>>CALL     3359>>CALL     3360>>ASSIGN   3442>>ASSIGN   3443>>IF
      3444>>IF       3448>>CALL     3454>>IF       3456>>CALL
EXTST$
      2514**DCL      3143<<ASSIGN   3278<>CALL     3279>>ASSIGN   3280>>ASSIGN   3281>>ASSIGN   3282>>ASSIGN
      3283>>ASSIGN   3284>>ASSIGN   3285>>ASSIGN   3286>>CALL     3288>>ASSIGN   3290>>ASSIGN   3292<>CALL
      3293<<ASSIGN   3319>>IF       3321>>CALL     3389>>IF       3390>>ASSIGN   3391<>CALL
FLT_ALT
      3223**LABEL    3221--CALLALT
HFC$LOCK
       684**DCL-ENT  2926--CALL     3002--CALL     3074--CALL     3252--CALL     3307--CALL     3398--CALL
      3450--CALL
HFC$UNLOCK
       684**DCL-ENT  2940--CALL     2962--CALL     2998--CALL     3033--CALL     3053--CALL     3079--CALL
      3087--CALL     3098--CALL     3340--CALL     3347--CALL     3404--CALL     3446--CALL
HW_EXT_STATUS
       724**DCL      3271>>IF
HW_IMX
       727**DCL      2952>>IF       3152>>IF
HW_IOP
       724**DCL      2958>>IF
I
      2515**DCL      3065<<DOINDEX  3066>>ASSIGN
I IN PROCEDURE CHECKMINOR
      3417**DCL      3430<<DOINDEX  3431>>IF       3432>>ASSIGN   3433>>ASSIGN   3434>>IF       3434>>ASSIGN
INTLVL
PL6.E3A0      #002=NID$POSTER File=NID$DISK.:E05TSI                              WED 07/30/97 03:30 Page:184  
      2406**DCL        43--PROC     2921>>DOCASE   2932<>CALL     2933>>IF       2936<>CALL     2938<>CALL
      2956>>IF       3058<>CALL     3117<>CALL
IOM_ALT
      3169**LABEL    3167--CALLALT
IOS.DCW
      2842**DCL      2845--REDEF
IOS.DCW.TALLY
      2843**DCL      2843--REDEF
IOS.IDCW.EXTA
      2845**DCL      2845--REDEF
IOS.PCW
      2847**DCL      2851--REDEF
IOS.SEEK
      2852**DCL      2853--REDEF    2854--REDEF
IOSTAT.AESDCW
      2649**DCL      2649--REDEF
IOSTAT.EXTST
      2650**DCL      3049>>ASSIGN
IOSTAT.LPW_RESIDUE
      2647**DCL      2953>>ASSIGN
IOSTAT.STATUS
      2644**DCL      2936<>CALL     2957>>ASSIGN
MBX.DCW.CONTROL.AE
      2668**DCL      2668--REDEF
MBX.LPW
      2663**DCL      2955>>ASSIGN
MBX.LPW.CONTROL.AE
      2664**DCL      2664--REDEF
MDCT.DP
      2700**DCL      2707--REDEF    2710--REDEF    2711--REDEF    2713--REDEF    2713--REDEF    2714--REDEF
      2715--REDEF    2715--REDEF
MDCT.DP.MIRROR.STATE
      2704**DCL      3102>>IF
MDCT.DP.MIRROR.WRITE
      2703**DCL      2990>>IF
MDCT.MPC.IOCHANX
PL6.E3A0      #002=NID$POSTER File=NID$DISK.:E05TSI                              WED 07/30/97 03:30 Page:185  
      2708**DCL      2708--REDEF
MDCT$
      2516**DCL      2680--IMP-PTR  2920<<ASSIGN   2949<<ASSIGN   2987>>IF       2990>>IF       2995>>ASSIGN
      3070<<ASSIGN   3102>>IF       3125<<ASSIGN   3331>>IF       3337>>ASSIGN
MDCTX
      2517**DCL      2919<<ASSIGN   2948<<ASSIGN   2949>>ASSIGN   2985>>IF       2994>>ASSIGN   3069<<ASSIGN
      3070>>ASSIGN   3124<<ASSIGN   3125>>ASSIGN   3336>>ASSIGN
MNSTAT IN PROCEDURE CHECKMINOR
      3418**DCL      3429<<ASSIGN
MNSTAT.BT IN PROCEDURE CHECKMINOR
      3419**DCL      3431>>IF
N$DCT$
      1339**DCL      2949>>ASSIGN   3066>>ASSIGN   3070>>ASSIGN   3125>>ASSIGN
N$DCT$$
      1205**DCL      1339--IMP-PTR  2949>>ASSIGN   3066>>ASSIGN   3070>>ASSIGN   3125>>ASSIGN
N$FQ$
      1205**DCL      1340--IMP-PTR
N$REQ_INIT.BUFADDR
      1224**DCL      1225--REDEF    1225--REDEF
N$REQ_INIT.DLA.DRELADDR
      1216**DCL      1216--REDEF
N$REQ_INIT.DVE.EOMCHAR
      1253**DCL      1254--REDEF
N$REQ_INIT.EAINFO
      1247**DCL      1247--REDEF
N$REQ_INIT.EAINFOX
      1247**DCL      1248--REDEF
N$REQ_INIT.EVNTINFO
      1248**DCL      1248--REDEF
N$REQ_INIT.STATUS
      1229**DCL      1235--REDEF
NEWSTATE
      2518**DCL      3141<<ASSIGN   3169<<ASSIGN   3185<<ASSIGN   3187<<ASSIGN   3209<<ASSIGN   3219<<ASSIGN
      3223<<ASSIGN   3288>>ASSIGN   3289<<ASSIGN   3353<<ASSIGN   3362>>IF       3369<<ASSIGN   3373>>IF
      3375<<ASSIGN   3378>>IF       3379<>CALL     3381<>CALL     3426<<ASSIGN   3434>>IF       3434<<ASSIGN
NI$EXTST
PL6.E3A0      #002=NID$POSTER File=NID$DISK.:E05TSI                              WED 07/30/97 03:30 Page:186  
      2524**DCL      3044<>CALL     3385<>CALL
NI$EXTST.EXTST
      2528**DCL      2530--REDEF    2532--REDEF    3049<<ASSIGN   3129<<ASSIGN   3273>>ASSIGN
NI$EXTST.EXTSTT.WRD
      2531**DCL      3272>>IF
NI$FQ$
      1265**DCL      1341--IMP-PTR
NI$IBUF$
      1265**DCL      1341--IMP-PTR
NI$IMXMBX_INIT.PAGED_BASE
      1275**DCL      1276--REDEF    1276--REDEF
NI$IMXMBX_INIT.SIZE
      1277**DCL      1277--REDEF
NI$IOERR.EXTST
      2747**DCL      2749--REDEF    3273<<ASSIGN   3281--ASSIGN   3282--ASSIGN
NI$IOERR.GOTEXTST
      2770**DCL      3270>>IF       3274<<ASSIGN   3287<<ASSIGN
NI$REQ_INIT.DCW
      1299**DCL      1302--REDEF
NI$REQ_INIT.DCW.TALLY
      1300**DCL      1300--REDEF
NI$REQ_INIT.IDCW.EXTA
      1302**DCL      1302--REDEF
NI$REQ_INIT.PCW
      1304**DCL      1308--REDEF
NI$REQ_INIT.SEEK
      1309**DCL      1310--REDEF    1311--REDEF
NI$RP.GATE
      1343**DCL      3398<>CALL     3404<>CALL
NI$RP.RP$
      1343**DCL      3401<>CALL
NI$RP$
      1313**DCL      1343--IMP-PTR  3398>>CALL     3401>>CALL     3404>>CALL
NIA$LOGERR
      2479**DCL-ENT  3243--CALL     3268--CALL
NIA$RELERR
PL6.E3A0      #002=NID$POSTER File=NID$DISK.:E05TSI                              WED 07/30/97 03:30 Page:187  
      2480**DCL-ENT  2983--CALL     3248--CALL     3330--CALL
NIA$SPURINT
      2481**DCL-ENT  2932--CALL     2936--CALL     2938--CALL     3058--CALL     3117--CALL
NID$DEVSCHED
      2482**DCL-ENT  3094--CALL     3258--CALL     3381--CALL     3406--CALL
NID$DEVSCHEDL
      2483**DCL-ENT  3039--CALL
NID$REQSCHED
      2484**DCL-ENT  3000--CALL     3342--CALL
NID$SCANAQ
      2486**DCL-ENT  3055--CALL
NIF$ANFAULT
      2487**DCL-ENT  3221--CALL
NIF$ANIOM
      2488**DCL-ENT  3167--CALL
NIK$OPMSG
      2489**DCL-ENT  3158--CALL     3379--CALL
NIM$DEQUEUE
      1368**DCL-ENT  3014--CALL
NIM$ENQUEUE
      1369**DCL-ENT  3401--CALL     3456--CALL
NIM$REQUEUE
      1370**DCL-ENT  3255--CALL     3311--CALL     3316--CALL     3321--CALL
NIO$COMP
      2492**DCL-ENT  3044--CALL     3385--CALL
NIO$DCWBLD
      2491**DCL-ENT  2996--CALL     3286--CALL     3304--CALL     3338--CALL
NIO$SPCOMP
      2493**DCL-ENT  3109--CALL
NIQ$GET
      2494**DCL-ENT  3278--CALL     3299--CALL
NIQ$REL
      2495**DCL-ENT  3292--CALL     3391--CALL     3395--CALL
NIS$DRIVER
      2496**DCL-ENT  3031--CALL
NIS$MASK
PL6.E3A0      #002=NID$POSTER File=NID$DISK.:E05TSI                              WED 07/30/97 03:30 Page:188  
      2497**DCL-ENT  2970--CALL     3203--CALL
NIW$LDFW
      2498**DCL-ENT  3161--CALL
NIW$MPCSTART
      2499**DCL-ENT  3359--CALL
NIW$MPCSTOP
      2500**DCL-ENT  3157--CALL     3448--CALL
NI_DBLZERO
      1314**DCL      2938<>CALL     3058<>CALL
NI_MBX_INIT.DCW.CONTROL.AE
      1335**DCL      1335--REDEF
NI_MBX_INIT.LPW.CONTROL.AE
      1331**DCL      1331--REDEF
NOEXTST
      3295**LABEL    3278--CALLALT
NOEXTST0
      3292**LABEL    3286--CALLALT
OCI$MK_STTM
      2501**DCL-ENT  3090--CALL
PAR
      2407**DCL        43--PROC     2923--ASSIGN   3057--ASSIGN   3063--ASSIGN   3120--ASSIGN
PMN$COLLECT
      2502**DCL-ENT  2951--CALL     3025--CALL     3028--CALL     3051--CALL
RCVR
      2555**DCL      3140<<ASSIGN   3151<<ASSIGN   3177<<ASSIGN   3193<<ASSIGN   3197<<ASSIGN   3206<<ASSIGN
      3210<<ASSIGN   3214<<ASSIGN   3217<<ASSIGN   3227<<ASSIGN   3351<<ASSIGN   3357<<ASSIGN   3425<<ASSIGN
      3433<<ASSIGN   3433>>ASSIGN
RCVR.EXTST
      2560**DCL      3277>>IF
RCVR.LOG
      2558**DCL      3225<<ASSIGN   3241>>IF       3244<<ASSIGN   3267>>IF
RCVR.NOINC
      2557**DCL      3234>>IF
RCVR.OPMSG
      2561**DCL      3263<<ASSIGN   3370<<ASSIGN   3376<<ASSIGN   3378>>IF
RCVR.RESTORE
PL6.E3A0      #002=NID$POSTER File=NID$DISK.:E05TSI                              WED 07/30/97 03:30 Page:189  
      2559**DCL      3298>>IF
RCVR.RETRY
      2556**DCL      3167<>CALL     3221<>CALL     3234>>IF       3262<<ASSIGN   3309>>IF       3324>>IF
      3382>>IF
READY_STAT
      2881**DCL      3173<>CALL
RELCHAN
      3441**PROC     3037--CALL     3050--CALL
REPOST
      3389**LABEL    3299--CALLALT  3304--CALLALT
REQ
      2782**DCL      2983<>CALL     2996<>CALL     3000<>CALL     3044<>CALL     3158<>CALL     3167<>CALL
      3221<>CALL     3243<>CALL     3248<>CALL     3255<>CALL     3268<>CALL     3286<>CALL     3304<>CALL
      3311<>CALL     3316<>CALL     3321<>CALL     3330<>CALL     3338<>CALL     3342<>CALL     3379<>CALL
      3385<>CALL     3401<>CALL
REQ.ARSIZE
      2815**DCL      3199<<ASSIGN
REQ.BPMIR
      2827**DCL      3285<<ASSIGN   3303<<ASSIGN
REQ.BUF$
      2791**DCL      3281<<ASSIGN
REQ.BUFADDR
      2791**DCL      2792--REDEF    2792--REDEF
REQ.BUFSIZE
      2785**DCL      3282<<ASSIGN
REQ.COMP
      2816**DCL      2974>>IF       2974>>IF       2979>>IF       3144>>IF       3147<<ASSIGN   3148>>IF
      3232>>DOCASE   3238>>IF       3284<<ASSIGN   3302<<ASSIGN   3324>>IF
REQ.DCT$
      2783**DCL      2945>>ASSIGN   2995<<ASSIGN   3121>>ASSIGN   3337<<ASSIGN
REQ.DLA
      2782**DCL      3030>>ASSIGN   3279<<ASSIGN   3279>>ASSIGN   3300<<ASSIGN   3300>>ASSIGN
REQ.DLA.DCTX
      2782**DCL      2994<<ASSIGN   3336<<ASSIGN
REQ.DLA.DRELADDR
      2783**DCL      2783--REDEF    3364>>IF
PL6.E3A0      #002=NID$POSTER File=NID$DISK.:E05TSI                              WED 07/30/97 03:30 Page:190  
REQ.DOMIR
      2826**DCL      2985>>IF       2993<<ASSIGN   3008<<ASSIGN   3324>>IF       3335<<ASSIGN
REQ.DVE.EOMCHAR
      2820**DCL      2821--REDEF
REQ.EAINFO
      2814**DCL      2814--REDEF    3358<<ASSIGN
REQ.EAINFOP$
      2814**DCL      3290<<ASSIGN   3354>>ASSIGN
REQ.EAINFOX
      2814**DCL      2815--REDEF
REQ.ERR$
      2804**DCL      2981>>IF       3246>>IF       3269>>IF       3270>>IF       3273>>ASSIGN   3274>>ASSIGN
      3281>>ASSIGN   3287>>ASSIGN   3328>>IF
REQ.ERRCT
      2784**DCL      3181>>IF       3218>>IF       3235<<ASSIGN   3235>>ASSIGN   3236>>IF       3249<<ASSIGN
REQ.EVNTINFO
      2815**DCL      2815--REDEF
REQ.FC
      2785**DCL      3148>>IF       3280<<ASSIGN   3301<<ASSIGN   3352>>IF
REQ.FLPW
      2803**DCL      2953<<ASSIGN   2955<<ASSIGN
REQ.IOFLG.REL
      2787**DCL      3360>>IF
REQ.IOFLG.STOPMPC
      2788**DCL      3359>>IF
REQ.IOQFLG.IOQUED
      2825**DCL      3390<<ASSIGN   3394<<ASSIGN
REQ.MIRDONE
      2827**DCL      2984<<ASSIGN   3334<<ASSIGN
REQ.OPFLG
      2788**DCL      3283<<ASSIGN
REQ.POSTER
      2794**DCL      3288<<ASSIGN   3353>>ASSIGN
REQ.STATUS
      2796**DCL      2802--REDEF    2957<<ASSIGN   2968<<ASSIGN   2974>>IF       3354<<ASSIGN   3354>>ASSIGN
REQ.STATUS.IOM
PL6.E3A0      #002=NID$POSTER File=NID$DISK.:E05TSI                              WED 07/30/97 03:30 Page:191  
      2799**DCL      3166>>IF
REQ.STATUS.IOM.CHANNEL
      2799**DCL      2959>>IF
REQ.STATUS.MAJOR
      2796**DCL      2959>>IF       2969>>IF       3164>>DOCASE
REQ.STATUS.MINOR
      2797**DCL      3178>>IF       3202>>IF       3204>>IF       3204>>IF       3218>>IF       3423>>IF
      3429>>ASSIGN
REQ.STATUS.NCP
      2800**DCL      3198<<ASSIGN
REQ.STATUS.POWEROFF
      2796**DCL      3149>>IF
REQ.TYC
      2804**DCL      2973<<ASSIGN   3139<<ASSIGN   3250<<ASSIGN   3424<<ASSIGN   3432<<ASSIGN   3432>>ASSIGN
REQ.TYC.IOERR
      2807**DCL      3150<<ASSIGN   3176<<ASSIGN   3194<<ASSIGN   3201<<ASSIGN   3213<<ASSIGN   3216<<ASSIGN
      3228<<ASSIGN
REQ.TYC.OPER
      2805**DCL      3374<<ASSIGN
REQ.TYC.TIMO
      2809**DCL      3196<<ASSIGN
REQ$
      2553**DCL      2782--IMP-PTR  2944<<ASSIGN   2945>>ASSIGN   2953>>ASSIGN   2955>>ASSIGN   2957>>ASSIGN
      2959>>IF       2959>>IF       2968>>ASSIGN   2969>>IF       2973>>ASSIGN   2974>>IF       2974>>IF
      2974>>IF       2979>>IF       2981>>IF       2983>>CALL     2984>>ASSIGN   2985>>IF       2993>>ASSIGN
      2994>>ASSIGN   2995>>ASSIGN   2996>>CALL     3000>>CALL     3008>>ASSIGN   3044>>CALL     3120<<ASSIGN
      3121>>ASSIGN   3139>>ASSIGN   3144>>IF       3147>>ASSIGN   3148>>IF       3148>>IF       3149>>IF
      3150>>ASSIGN   3158>>CALL     3164>>DOCASE   3166>>IF       3167>>CALL     3176>>ASSIGN   3178>>IF
      3181>>IF       3194>>ASSIGN   3196>>ASSIGN   3198>>ASSIGN   3199>>ASSIGN   3201>>ASSIGN   3202>>IF
      3204>>IF       3204>>IF       3213>>ASSIGN   3216>>ASSIGN   3218>>IF       3218>>IF       3221>>CALL
      3228>>ASSIGN   3232>>DOCASE   3235>>ASSIGN   3235>>ASSIGN   3236>>IF       3238>>IF       3243>>CALL
      3246>>IF       3248>>CALL     3249>>ASSIGN   3250>>ASSIGN   3255>>CALL     3268>>CALL     3269>>IF
      3270>>IF       3273>>ASSIGN   3274>>ASSIGN   3279>>ASSIGN   3281>>ASSIGN   3287>>ASSIGN   3290>>ASSIGN
      3300>>ASSIGN   3311>>CALL     3324>>IF       3324>>IF       3328>>IF       3330>>CALL     3334>>ASSIGN
      3335>>ASSIGN   3336>>ASSIGN   3337>>ASSIGN   3338>>CALL     3342>>CALL     3352>>IF       3353>>ASSIGN
      3354>>ASSIGN   3354>>ASSIGN   3358>>ASSIGN   3359>>IF       3360>>IF       3364>>IF       3374>>ASSIGN
PL6.E3A0      #002=NID$POSTER File=NID$DISK.:E05TSI                              WED 07/30/97 03:30 Page:192  
      3379>>CALL     3385>>CALL     3401>>CALL     3423>>IF       3424>>ASSIGN   3429>>ASSIGN   3432>>ASSIGN
      3432>>ASSIGN
RESTORE$
      2554**DCL      3142<<ASSIGN   3299<>CALL     3300>>ASSIGN   3301>>ASSIGN   3302>>ASSIGN   3303>>ASSIGN
      3304>>CALL     3314>>IF       3316>>CALL     3393>>IF       3394>>ASSIGN   3395<>CALL
SC_NIDBADINTLVL
      2503**DCL-ENT  3131--CALL
SC_NIDINVMIR
      2504**DCL-ENT  2989--CALL     3333--CALL
SPSTAT.DVN
      2464**DCL      3072>>IF
SQH
      2865**DCL      3055<>CALL
SQH.CQ$
      2866**DCL      3456<>CALL
SQH.DOOR
      2865**DCL      2865--REDEF
SQH.FDCT
      2865**DCL      3065>>DOINDEX  3065>>DOINDEX
SQH.GATE
      2865**DCL      2926<>CALL     2940<>CALL     2962<>CALL     2998<>CALL     3002<>CALL     3033<>CALL
      3053<>CALL     3074<>CALL     3079<>CALL     3087<>CALL     3098<>CALL     3252<>CALL     3307<>CALL
      3340<>CALL     3347<>CALL     3446<>CALL     3450<>CALL
SQH.NDCT
      2866**DCL      3065>>DOINDEX
SQH$
      2563**DCL      2865--IMP-PTR  2924<<ASSIGN   2926>>CALL     2940>>CALL     2962>>CALL     2998>>CALL
      3002>>CALL     3033>>CALL     3053>>CALL     3055>>CALL     3064<<ASSIGN   3065>>DOINDEX  3065>>DOINDEX
      3065>>DOINDEX  3074>>CALL     3079>>CALL     3087>>CALL     3098>>CALL     3127<<ASSIGN   3252>>CALL
      3307>>CALL     3340>>CALL     3347>>CALL     3446>>CALL     3450>>CALL     3456>>CALL
STATUS
      2413**DCL        43--PROC     2438--REDEF    2454--REDEF    2930--IF       2932<>CALL     2968>>ASSIGN
      3061--IF       3083>>ASSIGN   3117<>CALL
TBL IN PROCEDURE CHECKMINOR
      3413**DCL      3409--PROC
TBL.RCVR IN PROCEDURE CHECKMINOR
PL6.E3A0      #002=NID$POSTER File=NID$DISK.:E05TSI                              WED 07/30/97 03:30 Page:193  
      3415**DCL      3425>>ASSIGN   3433>>ASSIGN
TBL.STATE IN PROCEDURE CHECKMINOR
      3416**DCL      3426>>ASSIGN   3434>>IF       3434>>ASSIGN
TBL.TYC IN PROCEDURE CHECKMINOR
      3414**DCL      3424>>ASSIGN   3432>>ASSIGN
TDM$MIRFAIL
      2506**DCL-ENT  3257--CALL
