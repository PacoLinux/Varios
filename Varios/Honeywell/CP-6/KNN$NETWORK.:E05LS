VERSION E05

PL6.E3A0      #001=KNN$SEND File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:04 Page:1    
        1        1        /*M* KNN$NETWORK - send and receive CP6 network level messages*/
        2        2        /*T***********************************************************/
        3        3        /*T*                                                         */
        4        4        /*T* Copyright (c) Bull HN Information Systems Inc., 1997    */
        5        5        /*T*                                                         */
        6        6        /*T***********************************************************/
        7        7
        8        8        /*X* PLM=3,IND=5,ECU=0,ENU=0   */
        9        9
       10       10        KNN$SEND: PROC (KN$NETPARM) ALTRET;
       11       11
       12       12        %INCLUDE K_SCODE_C;
       13       97        %INCLUDE GU_LCP6_M;
       14     1025        %INCLUDE KN_DATA_M;
       15     2811        %INCLUDE KNH_MACRO_C;
       16     3094        %INCLUDE KNN_NETWORK_M;
       17     3457        %INCLUDE K_QDPHDRS_M;
       18     4339        %INCLUDE KJ_FCNS_C;
       19     4366        %INCLUDE K_ADDRESS_M;
       20     4869        %INCLUDE KL_MACRO_C;
       21     8221        %INCLUDE K_INTERFACE_M;
       22     8630        %INCLUDE KI_CP6;
       23     9726        %INCLUDE KI_SUBS_C;
       24     9862
       25     9863                                                /* Parameters                         */
       26     9864        %PLIST;
       27     9865        %KN$NETPARM (NAME=KN$NETPARM);
       28    10018
       29    10019                                                /* Auto                               */
       30    10020        %K$NQDP_HDR (NAME=QDP_HDR, STCLASS=AUTO);
       31    10097        %K$NQDP_HDR (NAME=OSI_INIT,STCLASS=AUTO,MSGTYPE=OSI_INIT); /* a big one,too*/
       32    10442    1   DCL DEST_NODE UBIN;
       33    10443    1   DCL ROUTE$ PTR;
       34    10444    1   DCL LINK$ PTR;
       35    10445    1   DCL TLINK$ PTR;
       36    10446    1   DCL LINK# UBIN;
       37    10447    1   DCL CHAN# UBIN;
PL6.E3A0      #001=KNN$SEND File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:04 Page:2    
       38    10448    1   DCL QQQ$ PTR AUTO;
       39    10449    1   DCL SAVE_FPT$ PTR;
       40    10450    1   DCL I UBIN;
       41    10451    1   DCL J UBIN;
       42    10452        %KL_UPDOSI(FPTN=ROUTE,ADRTYP=NET,STCLASS=AUTO);
       43    10661        %FPT_CONNECT(STCLASS=AUTO,ADRTYP=NET);
       44    10832    1   DCL SNPATMPLT1 CHAR(8) ALIGNED;
       45    10833    1   DCL 1 SNPATMPLT2 REDEF SNPATMPLT1 ALIGNED,
       46    10834    1         2 NIBBLES(0:13) UNAL,
       47    10835    1           3 NIB UBIN(4) UNAL;
       48    10836
       49    10837    1   DCL SNPATMPLT3 CHAR(8) ALIGNED;
       50    10838    1   DCL 1 SNPATMPLT4 REDEF SNPATMPLT3 ALIGNED,
       51    10839    1         2 NIBBLES(0:13) UNAL,
       52    10840    1           3 NIB UBIN(4) UNAL;
       53    10841
       54    10842                                                /* External Data                      */
       55    10843    1   DCL KN_NODE# UBIN SYMREF;
       56    10844    1   DCL KNN_ROUTE$$ PTR SYMREF;
       57    10845    1   DCL KNN_NODES UBIN SYMREF;
       58    10846    1   DCL KNN_LINK$$ PTR SYMREF;
       59    10847    1   DCL KNN_LINKS UBIN SYMREF;
       60    10848
       61    10849                                                /* Internal Data                      */
       62    10850
       63    10851        %K$NQDP_HDR (NAME=INIT_QDP_HDR, STCLASS=CONSTANT, MSGTYPE=OSI_DATA);
       64    10928        %K$NQDP_HDR (NAME=OSI_INIT_C,STCLASS=CONSTANT,MSGTYPE=OSI_INIT);
       65    11273
       66    11274        %FPT_CONNECT(FPTN=FPT_CONNECT_C,STCLASS=CONSTANT,ADRTYP=NET,TYPE=CIRCUIT);
       67    11445        %VLP_SCODE (FPTN=SNODES,ERR#=%S$BADNODE,SEV=G_SEV_SCREECH#,
       68    11446                    STCLASS=CONSTANT,FCG=KN,MID=N,MON='1'B);
       69    11507
       70    11508        %VLP_SCODE (FPTN=PRTCLERR,ERR#=%S$PRTCLERR,SEV=G_SEV_SCREECH#,
       71    11509                       STCLASS=CONSTANT,FCG=KN,MID=N,MON='1'B);
       72    11570
       73    11571        %VLP_SCODE (FPTN=BADFNC,ERR#=%S$BADFNC,SEV=G_SEV_SCREECH#,
       74    11572                       STCLASS=CONSTANT,FCG=KN,MID=N,MON='1'B);
PL6.E3A0      #001=KNN$SEND File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:04 Page:3    
       75    11633
       76    11634                                                /* Entry references                   */
       77    11635    1   DCL KNH$SEND ENTRY(1) ALTRET;
       78    11636    1   DCL KNN$DECODE_NSAP ENTRY(2) ALTRET;
       79    11637    1   DCL KNA$RLSLDCT ENTRY(1) ALTRET;
       80    11638    1   DCL KNA$GETLDCT ENTRY(1) ALTRET;
       81    11639    1   DCL KNN$RECV ENTRY(1) ALTRET;
       82    11640    1   DCL SCREECH ENTRY(1);
       83    11641    1   DCL KNN$SENDOSI ENTRY(1) ALTRET;
       84    11642
       85    11643                                                /* Based structures                   */
       86    11644    1   DCL KNN$ROUTE$(0:0) PTR BASED(KNN_ROUTE$$);
       87    11645    1   DCL KNN$LINK$(0:0) PTR BASED(KNN_LINK$$);
       88    11646        %KNN$ROUTE (STCLASS="BASED(ROUTE$)");
       89    11718        %KNN$LINK (STCLASS="BASED(LINK$)");
       90    11969        %KN$LDCT (STCLASS="BASED(KN$NETPARM.LDCT$)");
       91    12214        %K$NSAP(FPTN=DST,STCLASS="BASED(KN$NETPARM.DST_ADDR$)");
       92    12266        %K$NSAP(FPTN=SRC,STCLASS="BASED(KN$NETPARM.SRC_ADDR$)");
       93    12318        %EJECT;
PL6.E3A0      #001=KNN$SEND File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:04 Page:4    
       94    12319
       95    12320        /*F* NAME: Fep_Network_Services
       96    12321
       97    12322        KNN$NETWORK contains the network functions for the FEP. It
       98    12323        interfaces to KNH (Handler monitor interface, KNT (transport),
       99    12324        or KNS (session).
      100    12325
      101    12326        The file KNN$NETWORK contains the following modules:
      102    12327
      103    12328        .fif
      104    12329        }  KNN$SEND  - Forwards messages to another node
      105    12330        }  KNN$RECV  - Receives incoming messages
      106    12331        .fin
      107    12332
      108    12333        */
      109    12334        %EJECT;
PL6.E3A0      #001=KNN$SEND File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:04 Page:5    
      110    12335
      111    12336        /*F* NAME: KNN$SEND Outbound Messages
      112    12337
      113    12338        This procedure is the interface for the higher layers to the
      114    12339        network layer. It is called from KNS$SEND or KNT$SEND with
      115    12340        the following parameters:
      116    12341
      117    12342        .fif
      118    12343        }  KN$NETPARM.FUNCTION
      119    12344        }                     - Contains the function to be performed
      120    12345        }                       When called for CP-6 connections:
      121    12346        }                          KN_FCN_DATA
      122    12347        }                       When called for OSI connections:
      123    12348        }                          K_NCONNECT_REQ
      124    12349        }                          K_NDATA_REQ
      125    12350        }
      126    12351        }  KN$NETPARM.NODE contains the desintation node#.
      127    12352        .fin
      128    12353
      129    12354        A network header is built in auto and KN$NETPARM is updated
      130    12355        to frame this header in .NHDR$ and .NHDRSZ.
      131    12356
      132    12357        KNN$SEND finds the KNN$ROUTE table entry for the destination
      133    12358        node, and then finds the KNN$LINK table entry from KNN$ROUTE.LINK$.
      134    12359
      135    12360        KN$NETPARM.LDCT$ is reset with the address of the LDCT that is
      136    12361        specified in KNN$LINK.LDCT$.
      137    12362
      138    12363        The message is then forwarded by a call to KNH$SEND with function
      139    12364        set to DATA.
      140    12365        */
      141    12366
      142    12367        /*
      143    12368             coupler uses rectype as the function code when transmitting non
      144    12369             standard function types such as time messages back to the host.
      145    12370        */
      146    12371    1      KN$NETPARM.RECTYPE = 0;
PL6.E3A0      #001=KNN$SEND File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:04 Page:6    
      147    12372        /*
      148    12373                connection request for OSI transport over CONS.
      149    12374        */
      150    12375    1      IF KN$NETPARM.FUNCTION = %K_NCONNECT_REQ
      151    12376    2        AND KN$NETPARM.FLAGS.CONS THEN DO;
      152    12377    3           CALL KNN$DECODE_NSAP(DST,ROUTE) WHENALTRETURN DO;
      153    12378    3                KN$NETPARM.ERRCODE = %KN_ERR_NORTE;
      154    12379    3                ALTRETURN;
      155    12380    3                END;
      156    12381    3           IF ROUTE.QOS = 255 OR ROUTE.FEP# >= KNN_NODES THEN DO;
      157    12382    3                KN$NETPARM.ERRCODE = %KN_ERR_NORTE;
      158    12383    3                ALTRETURN;
      159    12384    3                END;
      160    12385
      161    12386
      162    12387    2           IF KN_NODE# = ROUTE.FEP# THEN;  /* this node is the boundry node      */
      163    12388    3           ELSE DO;
      164    12389    3                IF KNN$ROUTE$(ROUTE.FEP#)->KNN$ROUTE.LINK$ = ADDR(NIL) OR
      165    12390    4                  KNN$ROUTE$(ROUTE.FEP#)->KNN$ROUTE.CURRENT_QOS = 255 THEN DO;
      166    12391    4                     KN$NETPARM.ERRCODE = %KN_ERR_NORTE;
      167    12392    4                     CALL KNA$RLSLDCT(KN$NETPARM.LDCT$);
      168    12393    4                     ALTRETURN;
      169    12394    4                     END;
      170    12395
      171    12396    3                LINK$ = KNN$ROUTE$(ROUTE.FEP#)->KNN$ROUTE.LINK$;
      172    12397    4                IF KNN$LINK.LDCT$ = ADDR(NIL) OR KNN$LINK.QOS = 255 THEN DO;
      173    12398    4                     KN$NETPARM.ERRCODE = %KN_ERR_NORTE;
      174    12399    4                     ALTRETURN;
      175    12400    4                     END;
      176    12401    3                LINK# = KNN$LINK.LDCT$->KN$LDCT.LINK_ID;
      177    12402    3                END;
      178    12403        /*
      179    12404             now that we are sure that there is a route associated with this link.
      180    12405             This could be a connection request from the host, in which case we need
      181    12406             to allocate the ldct.  If the connection request is from a remote connected
      182    12407             system then the ldct was allocated during the knn$recv.fpt_connect code.
      183    12408             Transport is reqesting us to build a K_MSGTYP_OSI_INIT#.
PL6.E3A0      #001=KNN$SEND File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:04 Page:7    
      184    12409        */
      185    12410    3           IF KN$NETPARM.LDCT$ = ADDR(NIL) THEN DO;
      186    12411    4                CALL KNA$GETLDCT(KN$NETPARM.LDCT$) WHENALTRETURN DO;
      187    12412    4                     KN$NETPARM.ERRCODE = %KN_ERR_NOLDCT;
      188    12413    4                     ALTRETURN;
      189    12414    4                     END;
      190    12415    3                KN$LDCT.CONN_TYPE = %KN_CNTYPE_CIRCUIT;
      191    12416    3                KN$LDCT.STATE = %KN_ST_OPENING;
      192    12417    3                KN$LDCT.USER_ENTRY$ = ENTADDR(KNN$RECV);
      193    12418        /*
      194    12419             to find the link on which to issue this connect.  scan the list of links and
      195    12420             compare the chan# with knn$link.chan# and not vc.
      196    12421        */
      197    12422    4                IF KN_NODE# = ROUTE.FEP# THEN DO;
      198    12423                   /*
      199    12424                   the connection to the network is on this node.
      200    12425                   */
      201    12426    5                     DO J = 0 TO KNN_LINKS - 1;
      202    12427    5                          LINK$ = KNN$LINK$(J);
      203    12428    5                          IF NOT KNN$LINK.FLAGS.VIRCIR
      204    12429    5                            AND KNN$LINK.NODE# >= %K_CNC_IS#
      205    12430    5                            AND KNN$LINK.LDCT$ ~= ADDR(NIL)
      206    12431    6                          THEN DO;
      207    12432    6                               SNPATMPLT1 = ROUTE.SNPA.ADDRESS;
      208    12433    6                               SNPATMPLT3 = KNN$LINK.SNPA.ADDRESS;
      209    12434    7                               DO I = 0 TO MINIMUM(ROUTE.SNPA.LEN,KNN$LINK.SNPA.LEN)-1;
      210    12435    7                                    IF SNPATMPLT2.NIBBLES.NIB(I) ~= SNPATMPLT4.NIBBLES.
             12435                                             NIB(I) THEN
      211    12436    7                                         GOTO NXTJ2;
      212    12437    7                                    END;   /* do i = 0 to min(len,len)-1         */
      213    12438    6                               TLINK$ = LINK$;
      214    12439    6                               GOTO FOUNDROUTE;
      215    12440    6                               END;        /* if not vircir and node > is        */
      216    12441    5   NXTJ2:                 ;
      217    12442    5                          END;             /* do j= 0 to knn_links -1            */
      218    12443    4                     GOTO NOROUTE;
      219    12444    4                     END;                  /* if kn_node# = route.fep#           */
PL6.E3A0      #001=KNN$SEND File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:04 Page:8    
      220    12445    4                ELSE DO;
      221    12446    4                     CHAN# = KNN$LINK.CHAN#;
      222    12447    5                     DO I = 0 TO KNN_LINKS-1;
      223    12448    5                          TLINK$ = KNN$LINK$(I);
      224    12449    6                          IF TLINK$->KNN$LINK.CHAN# = CHAN# AND NOT TLINK$->KNN$LINK.
             12449                                   FLAGS.VIRCIR THEN DO;
      225    12450    6                               QQQ$ = KN$NETPARM.LDCT$;
             12450                                        /* save so we can return it to transport*/
      226    12451    7                               IF TLINK$->KNN$LINK.LDCT$ = ADDR(NIL) THEN DO;
      227    12452    7   NOROUTE:                         CALL KNA$RLSLDCT(KN$NETPARM.LDCT$);
      228    12453    7                                    KN$NETPARM.ERRCODE = %KN_ERR_NORTE;
      229    12454    7                                    ALTRETURN;
      230    12455    7                                    END;
      231    12456    6                               GOTO FOUNDROUTE;
      232    12457    6                               END;        /* chan# and not vircir               */
      233    12458    5                          END;             /* do i = 0 knn_links                 */
      234    12459    4                     GOTO NOROUTE;
      235    12460    4                     END;                  /* else kn_node = route.fep#          */
      236    12461    3   FOUNDROUTE:  ;
      237    12462    3                KN$LDCT.UID = TLINK$->KNN$LINK.LDCT$->KN$LDCT.UID;
      238    12463    3                KN$LDCT.USER# = TLINK$->KNN$LINK.LDCT$->KN$LDCT.USER#;
      239    12464    3                FPT_CONNECT = FPT_CONNECT_C;
      240    12465    3                FPT_CONNECT.CLASS = 0;
      241    12466    3                FPT_CONNECT.TR_FLAGS = '0'B;
      242    12467    3                IF ROUTE.NW_TYPE ~= %K_NWTYPE_X2580
      243    12468    4                THEN DO;
      244    12469    4                     FPT_CONNECT.DEST = DST;
      245    12470    4                     FPT_CONNECT.LADR = SRC;
      246    12471    4                     FPT_CONNECT.DSTSNPA = ROUTE.SNPA;
      247    12472    4                     END;
      248    12473    4                ELSE DO;
      249    12474    4                     FPT_CONNECT.DSTSNPA = DST;
      250    12475    4                     FPT_CONNECT.DSTSNPA.LNG = FPT_CONNECT.DSTSNPA.LNG*2;
      251    12476    4                     END;
      252    12477    3                KN$NETPARM.FUNCTION = %KN_FCN_INIT;
      253    12478    3                FPT_CONNECT.RESOURCE = ' ';
      254    12479    3                KN$NETPARM.RECTYPE = 0;
PL6.E3A0      #001=KNN$SEND File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:04 Page:9    
      255    12480    3                KN$NETPARM.THDRSZ = 0;
      256    12481    3                KN$NETPARM.UHDRSZ = 0;
      257    12482    3                KN$NETPARM.SHDRSZ = 0;
      258    12483    3                KN$NETPARM.NHDRSZ = 0;
      259    12484    3                IF KN$NETPARM.FLAGS.CONS = '0'B
      260    12485    3                THEN KN$NETPARM.MSGSZ = 0; /*else contains tpdu_un*/
      261    12486    3                KN$NETPARM.FPT$ = ADDR(FPT_CONNECT);
      262    12487    4                CALL KNH$SEND(KN$NETPARM) WHENALTRETURN DO;
      263    12488    4                     GOTO NOROUTE;         /* error code is set by send          */
      264    12489    4                     END;
      265    12490    3                RETURN;     /* now back to transport to await the fpt_init_ack   */
      266    12491    3                END;                       /* if ldct = addr(nil)                */
      267    12492    3           ELSE DO;         /* ldct is not addr(nil) connection is to the host   */
      268    12493    3                DEST_NODE = ROUTE.HOST#;
      269    12494    3                ROUTE$ = KNN$ROUTE$(DEST_NODE);
      270    12495    3                IF NOT KNN$ROUTE.FLAGS.LINK_CONNECTED
      271    12496    4                  OR NOT KNN$ROUTE.FLAGS.HOST_NODE OR KNN$ROUTE.CURRENT_QOS = 255 THEN
             12496                           DO;
      272    12497        /*
      273    12498                   if the dest node is not link connected and it is not a host node then
      274    12499                   we shouldn't be here
      275    12500        */
      276    12501    4                     KN$NETPARM.ERRCODE = %KN_ERR_NORTE;
      277    12502    4                     ALTRETURN;
      278    12503    4                     END;
      279    12504    3                IF KNN$ROUTE.LINK$ = ADDR(NIL)
      280    12505    4                  OR KNN$ROUTE.LINK$->KNN$LINK.LDCT$ = ADDR(NIL) THEN DO;
      281    12506    4                     KN$NETPARM.ERRCODE = %KN_ERR_NORTE;
      282    12507    4                     ALTRETURN;
      283    12508    4                     END;
      284    12509
      285    12510    3                QQQ$ = KN$NETPARM.LDCT$;
      286    12511    3                KN$NETPARM.LDCT$ = KNN$ROUTE.LINK$->KNN$LINK.LDCT$;
      287    12512    3                KN$NETPARM.FUNCTION = %KN_FCN_DATA;
      288    12513    3                OSI_INIT = OSI_INIT_C;
      289    12514    3                OSI_INIT.DEST_NODE = DEST_NODE + 1;
      290    12515    3                OSI_INIT.SOURCE_NODE = KN_NODE# + 1;
PL6.E3A0      #001=KNN$SEND File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:04 Page:10   
      291    12516    3                OSI_INIT.DST_NSAP = DST;
      292    12517    3                OSI_INIT.SRC_NSAP = SRC;
      293    12518    3                KN$NETPARM.NHDR$ = ADDR(OSI_INIT);
      294    12519    3                KN$NETPARM.NHDRSZ = LENGTHC(OSI_INIT);
      295    12520    3                SAVE_FPT$ = KN$NETPARM.FPT$;
      296    12521    3                KN$NETPARM.FPT$ = ADDR(NIL);
      297    12522    3                CALL KNH$SEND(KN$NETPARM) ALTRET(ERROR1);
      298    12523
      299    12524    3                KNN$ROUTE.LINK$->KNN$LINK.MSGS_OUT = KNN$ROUTE.LINK$->KNN$LINK.MSGS_OUT
             12524                         + 1;
      300    12525    3                LINK# = KN$LDCT.LINK_ID;
      301    12526    3                KNN$ROUTE.LINK.MSGS_OUT(LINK#) = KNN$ROUTE.LINK.MSGS_OUT(LINK#) + 1;
      302    12527
      303    12528    3                KN$NETPARM.LDCT$ = QQQ$;
      304    12529    3                KN$NETPARM.FPT$ = SAVE_FPT$;
      305    12530    3                RETURN;
      306    12531    3                END;                       /* else ldct ~= addr(nil)             */
      307    12532    2           END;                            /* function = nconnect and CONS       */
      308    12533        %EJECT;
PL6.E3A0      #001=KNN$SEND File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:04 Page:11   
      309    12534        /*
      310    12535                connection request for OSI transport over CLNS.
      311    12536        */
      312    12537
      313    12538    2      IF KN$NETPARM.FUNCTION = %K_NCONNECT_REQ THEN DO;
      314    12539    2           KN$NETPARM.FUNCTION = %K_NDATA;
      315    12540    2           OSI_INIT = OSI_INIT_C;
      316    12541    2           OSI_INIT.DEST_NODE = KN$NETPARM.NODE + 1;
      317    12542    2           DEST_NODE = KN$NETPARM.NODE;
      318    12543    2           OSI_INIT.SOURCE_NODE = KN_NODE# + 1;
      319    12544    2           OSI_INIT.DST_NSAP = DST;
      320    12545    2           OSI_INIT.SRC_NSAP = SRC;
      321    12546    2           KN$NETPARM.UHDRSZ = 0;
      322    12547    2           KN$NETPARM.NHDR$ = ADDR(OSI_INIT);
      323    12548    2           KN$NETPARM.NHDRSZ = LENGTHC(OSI_INIT);
      324    12549    2           QQQ$ = KN$NETPARM.LDCT$;
      325    12550    2           SAVE_FPT$ = KN$NETPARM.FPT$;
      326    12551    2           KN$NETPARM.FPT$ = ADDR(NIL);
      327    12552    3           IF DEST_NODE <= KNN_NODES THEN DO;
      328    12553    3                ROUTE$ = KNN$ROUTE$(DEST_NODE);
      329    12554    3                IF KNN$ROUTE.LINK$ = ADDR(NIL)
      330    12555    3                  OR KNN$ROUTE.LINK$->KNN$LINK.LDCT$ = ADDR(NIL)
      331    12556    3                  OR NOT KNN$ROUTE.FLAGS.LINK_CONNECTED
      332    12557    4                  OR NOT KNN$ROUTE.FLAGS.HOST_NODE THEN DO;
      333    12558    4                     KN$NETPARM.ERRCODE = %KN_ERR_NORTE;
      334    12559    4                     GOTO ERROR1;
      335    12560    4                     END;
      336    12561    3                KN$NETPARM.LDCT$ = KNN$ROUTE.LINK$->KNN$LINK.LDCT$;
      337    12562    3                CALL KNH$SEND(KN$NETPARM) ALTRET(ERROR1);
      338    12563    3                END;                       /*  if dest_node <                    */
      339    12564    3           ELSE DO;
      340    12565    3                KN$NETPARM.ERRCODE = %KN_ERR_NORTE;
      341    12566    3                GOTO ERROR1;
      342    12567    3                END;                       /* else dest_node <                   */
      343    12568    2           RETURN;
      344    12569    2           END;                            /* nconnect and CLNS                  */
      345    12570        %EJECT;
PL6.E3A0      #001=KNN$SEND File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:04 Page:12   
      346    12571
      347    12572    2      IF KN$NETPARM.FUNCTION = %K_NDATA THEN DO;
      348    12573        /*
      349    12574             a function of k_ndata could indicate one of two things:
      350    12575                1 - an incoming transport frag from a foreign osi
      351    12576                    system.  In this case we build an osi_data message and forward
      352    12577                    to the designated host.
      353    12578
      354    12579                2 - an outgoing data message.  These are for OSI CLNS
      355    12580                    connections which have already been established.  forward kn$netparm
      356    12581                    to sendosi.
      357    12582        */
      358    12583    3           IF KN$NETPARM.DST_ADDR$ = ADDR(NIL) THEN DO;
      359    12584         /*
      360    12585                incoming request to be forwarded to the host
      361    12586        */
      362    12587    3                QDP_HDR = INIT_QDP_HDR;
      363    12588    3                QDP_HDR.DEST_NODE = KN$NETPARM.NODE + 1;
      364    12589    3                DEST_NODE = KN$NETPARM.NODE;
      365    12590    3                QDP_HDR.SOURCE_NODE = KN_NODE# + 1;
      366    12591    3                KN$NETPARM.UHDRSZ = 0;
      367    12592    3                KN$NETPARM.NHDR$ = ADDR(QDP_HDR);
      368    12593    3                KN$NETPARM.NHDRSZ = LENGTHC(QDP_HDR);
      369    12594    3                QQQ$ = KN$NETPARM.LDCT$;
      370    12595    3                SAVE_FPT$ = KN$NETPARM.FPT$;
      371    12596    3                KN$NETPARM.FPT$ = ADDR(NIL);
      372    12597    4                IF DEST_NODE <= KNN_NODES THEN DO;
      373    12598    4                     ROUTE$ = KNN$ROUTE$(DEST_NODE);
      374    12599    4                     IF KNN$ROUTE.LINK$ = ADDR(NIL)
      375    12600    4                       OR KNN$ROUTE.LINK$->KNN$LINK.LDCT$ = ADDR(NIL)
      376    12601    4                       OR NOT KNN$ROUTE.FLAGS.LINK_CONNECTED
      377    12602    5                       OR NOT KNN$ROUTE.FLAGS.HOST_NODE THEN DO;
      378    12603    5                          KN$NETPARM.ERRCODE = %KN_ERR_NORTE;
      379    12604    5                          GOTO ERROR1;
      380    12605    5                          END;
      381    12606    4                     KN$NETPARM.LDCT$ = KNN$ROUTE.LINK$->KNN$LINK.LDCT$;
      382    12607    4                     CALL KNH$SEND(KN$NETPARM) ALTRET(ERROR1);
PL6.E3A0      #001=KNN$SEND File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:04 Page:13   
      383    12608    4                     END;                  /*  if dest_node <                    */
      384    12609    4                ELSE DO;
      385    12610    4                     KN$NETPARM.ERRCODE = %KN_ERR_NORTE;
      386    12611    4                     GOTO ERROR1;
      387    12612    4                     END;                  /* else dest_node <                   */
      388    12613    3                RETURN;
      389    12614    3                END;                       /* if dst_addr$ = addr(nil)           */
      390    12615    3           ELSE DO;         /* dst_addr$ ~= addr(nil) forward to knn$sendosi     */
      391    12616    3                QQQ$ = KN$NETPARM.LDCT$;
      392    12617    3                SAVE_FPT$ = KN$NETPARM.FPT$;
      393    12618    3                KN$NETPARM.FPT$ = ADDR(NIL);
      394    12619
      395    12620    3                CALL KNN$SENDOSI(KN$NETPARM);
             12620                         /* may altret, drop the message regardless*/
      396    12621    3                KN$NETPARM.FPT$ = SAVE_FPT$;
      397    12622    3                KN$NETPARM.LDCT$ = QQQ$;
      398    12623    3                RETURN; /*  kn$netparm.errcode set in sendosi, drop the message  */
      399    12624    3                END;
      400    12625    2           END;                            /* if function = k_ndata              */
      401    12626
      402    12627        %EJECT;
PL6.E3A0      #001=KNN$SEND File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:04 Page:14   
      403    12628        /*
      404    12629                data request for CP-6 QDP or CP-6 Class 4 transport
      405    12630        */
      406    12631    1      IF KN$NETPARM.FUNCTION ~= %KN_FCN_DATA
      407    12632    1      THEN CALL SCREECH(BADFNC);
      408    12633
      409    12634        /*S* SCREECH_CODE: KNN-S$BADFNC
      410    12635             TYPE: SCREECH
      411    12636             MESSAGE: Bad Function code passed to network.
      412    12637        */
      413    12638
      414    12639    1      SAVE_FPT$ = KN$NETPARM.FPT$;
             12639               /* dont send the fpt$ to knh$send, it confuses hdlc */
      415    12640    1      KN$NETPARM.FPT$ = ADDR(NIL);
      416    12641
      417    12642    1      IF KN$NETPARM.NODE > KNN_NODES
      418    12643    1      THEN CALL SCREECH(SNODES);
      419    12644
      420    12645        /*S* SCREECH_CODE: KNN-S$BADNODE
      421    12646             TYPE: SCREECH
      422    12647             MESSAGE: Bad FEP Node parameter passed to KNN$SEND
      423    12648        */
      424    12649
      425    12650
      426    12651    1      DEST_NODE = KN$NETPARM.NODE;
      427    12652    1      ROUTE$ = KNN$ROUTE$(DEST_NODE);
      428    12653    1      LINK$ = KNN$ROUTE.LINK$;
      429    12654
      430    12655    1      IF LINK$ = ADDR(NIL) OR KNN$LINK.LDCT$ = ADDR(NIL)
      431    12656    2      THEN DO;
      432    12657    2           KN$NETPARM.ERRCODE = %KN_ERR_NORTE;
      433    12658    2           ALTRETURN;
      434    12659    2           END;
      435    12660
      436    12661    1      QQQ$ = KN$NETPARM.LDCT$;
      437    12662
      438    12663    1      KN$NETPARM.NHDRSZ=LENGTHC(INIT_QDP_HDR);
PL6.E3A0      #001=KNN$SEND File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:04 Page:15   
      439    12664    1      KN$NETPARM.NHDR$ = ADDR(QDP_HDR);
      440    12665
      441    12666    1      QDP_HDR = INIT_QDP_HDR;
      442    12667
      443    12668    1      IF KN$NETPARM.LDCT$ ~= ADDR(NIL) AND KN$LDCT.CONN_TYPE = %KN_CNTYPE_QDP
      444    12669    1      THEN QDP_HDR.MSGTYP = %K_MSGTYP_CP6_QDP#;
      445    12670    1      ELSE QDP_HDR.MSGTYP = %K_MSGTYP_CP6_CL4#; /* ape, ssn, link                */
      446    12671
      447    12672    1      QDP_HDR.DEST_NODE = KN$NETPARM.NODE + 1;
      448    12673    1      QDP_HDR.SOURCE_NODE = KN_NODE# + 1;
      449    12674
      450    12675    1      KN$NETPARM.LDCT$ = KNN$LINK.LDCT$;
      451    12676    1      CALL KNH$SEND (KN$NETPARM) ALTRET(ERROR1);
      452    12677
      453    12678    1      KNN$LINK.MSGS_OUT = KNN$LINK.MSGS_OUT + 1;
      454    12679    1      LINK# = KN$LDCT.LINK_ID;
      455    12680    1      KNN$ROUTE.LINK.MSGS_OUT(LINK#) = KNN$ROUTE.LINK.MSGS_OUT(LINK#) + 1;
      456    12681
      457    12682    1      KN$NETPARM.LDCT$ = QQQ$;
      458    12683    1      KN$NETPARM.FPT$ = SAVE_FPT$;
      459    12684    1      RETURN;
      460    12685
      461    12686    1   ERROR1:
      462    12687    1      KN$NETPARM.FPT$ = SAVE_FPT$;
      463    12688    1      KN$NETPARM.LDCT$ = QQQ$;
      464    12689    1      ALTRETURN;
      465    12690
      466    12691    1   END KNN$SEND;
      467    12692        %EOD;

PL6.E3A0      #001=KNN$SEND File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:04 Page:16   
--  Include file information  --

   KI_SUBS_C.:E05TOU  is referenced.
   KI_CP6.:E05TOU  is referenced.
   K_INTERFACE_M.:E05TOU  is referenced.
   KL_MACRO_C.:E05TOU  is referenced.
   K_ADDRESS_M.:E05TOU  is referenced.
   KJ_FCNS_C.:E05TOU  is referenced.
   K_QDPHDRS_M.:E05TOU  is referenced.
   KNN_NETWORK_M.:E05TOU  is referenced.
   KNH_MACRO_C.:E05TOU  is referenced.
   KN_DATA_M.:E05TOU  is referenced.
   GU_LCP6_M.:E05TOU  is referenced.
   K_SCODE_C.:E05TOU  is referenced.
      No diagnostics issued in procedure KNN$SEND.

   Procedure KNN$SEND requires 1079 words for executable code.
   Procedure KNN$SEND requires 144 words of local(AUTO) storage.

PL6.E3A0      #001=KNN$SEND File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:04 Page:17   

 Object Unit name= KNN$SEND                                   File name= KNN$NETWORK.:E05TOU
 UTS= JUL 30 '97 01:04:15.04 WED                              Compiler= PL-6/E31         Sev=      00
 SharedLib= :SHARED_LCP6_SYSTEM                               Alt SharedLib=


    ****  Control sections  ****

 Sect   Type Bound  Init  Size HexSiz  Section name
    0  RoData even  UTS     90     5A  KNN$SEND
    1   Proc  even  none  1079    437  KNN$SEND
    2  RoData even  none     4      4  KNN$SEND

    ****  Entry defs  ****

                              Check   Calling
                             calling  sequence
  Sect HexLoc Primary Altret sequence   type   Parms  Name
     1      0   yes    yes     yes      Std        1  KNN$SEND

  ****  Entry refs  ****

         Check        Calling
        calling       sequence
Altret sequence SRef   type   Args  Name
 yes     yes           Std       2 KNN$DECODE_NSAP
 yes     yes           Std       1 KNA$RLSLDCT
 yes     yes           Std       1 KNN$RECV
 yes     yes           Std       1 KNH$SEND
 yes     yes           Std       1 KNN$SENDOSI
         yes           Std       1 SCREECH
 yes     yes           Std       1 KNA$GETLDCT
                       nStd      0 X6A_AUTO_1
                       nStd      0 X6A_AALT
                       nStd      0 X6B_BLR
                       nStd      0 X6A_ARET
PL6.E3A0      #001=KNN$SEND File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:04 Page:18   

  ****  Data refs  ****

  Flags:  r = read only, s = secondary
Flgs Name                             Flgs Name                             Flgs Name
     KN_NODE#                              KNN_ROUTE$$                           KNN_NODES
     KNN_LINK$$                            KNN_LINKS                        r    G$ROS$
PL6.E3A0      #001=KNN$SEND File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:04 Page:19   


        1        1        /*M* KNN$NETWORK - send and receive CP6 network level messages*/
        2        2        /*T***********************************************************/
        3        3        /*T*                                                         */
        4        4        /*T* Copyright (c) Bull HN Information Systems Inc., 1997    */
        5        5        /*T*                                                         */
        6        6        /*T***********************************************************/
        7        7
        8        8        /*X* PLM=3,IND=5,ECU=0,ENU=0   */
        9        9
       10       10        KNN$SEND: PROC (KN$NETPARM) ALTRET;

     10   1 000000  D380 0000 0000  xent KNN$SEND        LNJ,B5   X6A_AUTO_1
          1 000003       0090 0001                       DC       144,1

       11       11
       12       12        %INCLUDE K_SCODE_C;
       13       97        %INCLUDE GU_LCP6_M;
       14     1025        %INCLUDE KN_DATA_M;
       15     2811        %INCLUDE KNH_MACRO_C;
       16     3094        %INCLUDE KNN_NETWORK_M;
       17     3457        %INCLUDE K_QDPHDRS_M;
       18     4339        %INCLUDE KJ_FCNS_C;
       19     4366        %INCLUDE K_ADDRESS_M;
       20     4869        %INCLUDE KL_MACRO_C;
       21     8221        %INCLUDE K_INTERFACE_M;
       22     8630        %INCLUDE KI_CP6;
       23     9726        %INCLUDE KI_SUBS_C;
       24     9862
       25     9863                                                /* Parameters                         */
       26     9864        %PLIST;
       27     9865        %KN$NETPARM (NAME=KN$NETPARM);
       28    10018
       29    10019                                                /* Auto                               */
       30    10020        %K$NQDP_HDR (NAME=QDP_HDR, STCLASS=AUTO);
       31    10097        %K$NQDP_HDR (NAME=OSI_INIT,STCLASS=AUTO,MSGTYPE=OSI_INIT); /* a big one,too*/
       32    10442    1   DCL DEST_NODE UBIN;
PL6.E3A0      #001=KNN$SEND File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:04 Page:20   
       33    10443    1   DCL ROUTE$ PTR;
       34    10444    1   DCL LINK$ PTR;
       35    10445    1   DCL TLINK$ PTR;
       36    10446    1   DCL LINK# UBIN;
       37    10447    1   DCL CHAN# UBIN;
       38    10448    1   DCL QQQ$ PTR AUTO;
       39    10449    1   DCL SAVE_FPT$ PTR;
       40    10450    1   DCL I UBIN;
       41    10451    1   DCL J UBIN;
       42    10452        %KL_UPDOSI(FPTN=ROUTE,ADRTYP=NET,STCLASS=AUTO);
       43    10661        %FPT_CONNECT(STCLASS=AUTO,ADRTYP=NET);
       44    10832    1   DCL SNPATMPLT1 CHAR(8) ALIGNED;
       45    10833    1   DCL 1 SNPATMPLT2 REDEF SNPATMPLT1 ALIGNED,
       46    10834    1         2 NIBBLES(0:13) UNAL,
       47    10835    1           3 NIB UBIN(4) UNAL;
       48    10836
       49    10837    1   DCL SNPATMPLT3 CHAR(8) ALIGNED;
       50    10838    1   DCL 1 SNPATMPLT4 REDEF SNPATMPLT3 ALIGNED,
       51    10839    1         2 NIBBLES(0:13) UNAL,
       52    10840    1           3 NIB UBIN(4) UNAL;
       53    10841
       54    10842                                                /* External Data                      */
       55    10843    1   DCL KN_NODE# UBIN SYMREF;
       56    10844    1   DCL KNN_ROUTE$$ PTR SYMREF;
       57    10845    1   DCL KNN_NODES UBIN SYMREF;
       58    10846    1   DCL KNN_LINK$$ PTR SYMREF;
       59    10847    1   DCL KNN_LINKS UBIN SYMREF;
       60    10848
       61    10849                                                /* Internal Data                      */
       62    10850
       63    10851        %K$NQDP_HDR (NAME=INIT_QDP_HDR, STCLASS=CONSTANT, MSGTYPE=OSI_DATA);
       64    10928        %K$NQDP_HDR (NAME=OSI_INIT_C,STCLASS=CONSTANT,MSGTYPE=OSI_INIT);
       65    11273
       66    11274        %FPT_CONNECT(FPTN=FPT_CONNECT_C,STCLASS=CONSTANT,ADRTYP=NET,TYPE=CIRCUIT);
       67    11445        %VLP_SCODE (FPTN=SNODES,ERR#=%S$BADNODE,SEV=G_SEV_SCREECH#,
       68    11446                    STCLASS=CONSTANT,FCG=KN,MID=N,MON='1'B);
       69    11507
PL6.E3A0      #001=KNN$SEND File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:04 Page:21   
       70    11508        %VLP_SCODE (FPTN=PRTCLERR,ERR#=%S$PRTCLERR,SEV=G_SEV_SCREECH#,
       71    11509                       STCLASS=CONSTANT,FCG=KN,MID=N,MON='1'B);
       72    11570
       73    11571        %VLP_SCODE (FPTN=BADFNC,ERR#=%S$BADFNC,SEV=G_SEV_SCREECH#,
       74    11572                       STCLASS=CONSTANT,FCG=KN,MID=N,MON='1'B);
       75    11633
       76    11634                                                /* Entry references                   */
       77    11635    1   DCL KNH$SEND ENTRY(1) ALTRET;
       78    11636    1   DCL KNN$DECODE_NSAP ENTRY(2) ALTRET;
       79    11637    1   DCL KNA$RLSLDCT ENTRY(1) ALTRET;
       80    11638    1   DCL KNA$GETLDCT ENTRY(1) ALTRET;
       81    11639    1   DCL KNN$RECV ENTRY(1) ALTRET;
       82    11640    1   DCL SCREECH ENTRY(1);
       83    11641    1   DCL KNN$SENDOSI ENTRY(1) ALTRET;
       84    11642
       85    11643                                                /* Based structures                   */
       86    11644    1   DCL KNN$ROUTE$(0:0) PTR BASED(KNN_ROUTE$$);
       87    11645    1   DCL KNN$LINK$(0:0) PTR BASED(KNN_LINK$$);
       88    11646        %KNN$ROUTE (STCLASS="BASED(ROUTE$)");
       89    11718        %KNN$LINK (STCLASS="BASED(LINK$)");
       90    11969        %KN$LDCT (STCLASS="BASED(KN$NETPARM.LDCT$)");
       91    12214        %K$NSAP(FPTN=DST,STCLASS="BASED(KN$NETPARM.DST_ADDR$)");
       92    12266        %K$NSAP(FPTN=SRC,STCLASS="BASED(KN$NETPARM.SRC_ADDR$)");
       93    12318        %EJECT;
PL6.E3A0      #001=KNN$SEND File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:04 Page:22   
       94    12319
       95    12320        /*F* NAME: Fep_Network_Services
       96    12321
       97    12322        KNN$NETWORK contains the network functions for the FEP. It
       98    12323        interfaces to KNH (Handler monitor interface, KNT (transport),
       99    12324        or KNS (session).
      100    12325
      101    12326        The file KNN$NETWORK contains the following modules:
      102    12327
      103    12328        .fif
      104    12329        }  KNN$SEND  - Forwards messages to another node
      105    12330        }  KNN$RECV  - Receives incoming messages
      106    12331        .fin
      107    12332
      108    12333        */
      109    12334        %EJECT;
PL6.E3A0      #001=KNN$SEND File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:04 Page:23   
      110    12335
      111    12336        /*F* NAME: KNN$SEND Outbound Messages
      112    12337
      113    12338        This procedure is the interface for the higher layers to the
      114    12339        network layer. It is called from KNS$SEND or KNT$SEND with
      115    12340        the following parameters:
      116    12341
      117    12342        .fif
      118    12343        }  KN$NETPARM.FUNCTION
      119    12344        }                     - Contains the function to be performed
      120    12345        }                       When called for CP-6 connections:
      121    12346        }                          KN_FCN_DATA
      122    12347        }                       When called for OSI connections:
      123    12348        }                          K_NCONNECT_REQ
      124    12349        }                          K_NDATA_REQ
      125    12350        }
      126    12351        }  KN$NETPARM.NODE contains the desintation node#.
      127    12352        .fin
      128    12353
      129    12354        A network header is built in auto and KN$NETPARM is updated
      130    12355        to frame this header in .NHDR$ and .NHDRSZ.
      131    12356
      132    12357        KNN$SEND finds the KNN$ROUTE table entry for the destination
      133    12358        node, and then finds the KNN$LINK table entry from KNN$ROUTE.LINK$.
      134    12359
      135    12360        KN$NETPARM.LDCT$ is reset with the address of the LDCT that is
      136    12361        specified in KNN$LINK.LDCT$.
      137    12362
      138    12363        The message is then forwarded by a call to KNH$SEND with function
      139    12364        set to DATA.
      140    12365        */
      141    12366
      142    12367        /*
      143    12368             coupler uses rectype as the function code when transmitting non
      144    12369             standard function types such as time messages back to the host.
      145    12370        */
      146    12371    1      KN$NETPARM.RECTYPE = 0;
PL6.E3A0      #001=KNN$SEND File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:04 Page:24   

  12371   1 000005  ECC7 0004                            LDB,B6   @KN$NETPARM,AUTO
          1 000007  8746 0013                            CL       19,B6

      147    12372        /*
      148    12373                connection request for OSI transport over CONS.
      149    12374        */
      150    12375    1      IF KN$NETPARM.FUNCTION = %K_NCONNECT_REQ

  12375   1 000009  E846 0014                            LDR,R6   20,B6
          1 00000B  6D1F                                 CMV,R6   31
          1 00000C  0981 026F                            BNE      s:12538,PREL
          1 00000E  82C6 0012                            LB,'0100'X        18,B6
          1 000010       0100
          1 000011  0581 026A                            BBF      s:12538,PREL

      151    12376    2        AND KN$NETPARM.FLAGS.CONS THEN DO;

      152    12377    3           CALL KNN$DECODE_NSAP(DST,ROUTE) WHENALTRETURN DO;

  12377   1 000013  DCC6 001F                            LDB,B5   31,B6
          1 000015  CBC7 0039                            LAB,B4   ROUTE,AUTO
          1 000017  CFC7 008E                            STB,B4   SNPATMPLT3+6,AUTO
          1 000019  DFC7 008C                            STB,B5   SNPATMPLT3+4,AUTO
          1 00001B  BBC7 008C                            LAB,B3   SNPATMPLT3+4,AUTO
          1 00001D  CBF0 0200                            LAB,B4   512,IMO
          1 00001F  E380 0000 0000  xent                 LNJ,B6   KNN$DECODE_NSAP
          1 000022       0003                            DC       s:12378,PREL
          1 000023  0F81 0009                            B        s:12381,PREL

      153    12378    3                KN$NETPARM.ERRCODE = %KN_ERR_NORTE;

  12378   1 000025  ECC7 0004                            LDB,B6   @KN$NETPARM,AUTO
          1 000027  6C03                                 LDV,R6   3
          1 000028  EF46 0016                            STR,R6   22,B6

      154    12379    3                ALTRETURN;
PL6.E3A0      #001=KNN$SEND File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:04 Page:25   

  12379   1 00002A  C380 0000 0000  xent                 LNJ,B4   X6A_AALT

      155    12380    3                END;
      156    12381    3           IF ROUTE.QOS = 255 OR ROUTE.FEP# >= KNN_NODES THEN DO;

  12381   1 00002D  E847 003B                            LDR,R6   ROUTE+2,AUTO
          1 00002F  E570 00FF                            AND,R6   255,IMO
          1 000031  E970 00FF                            CMR,R6   255,IMO
          1 000033  0901 000A                            BE       s:12382,PREL
          1 000035  D847 003A                            LDR,R5   ROUTE+1,AUTO
          1 000037  D570 00FF                            AND,R5   255,IMO
          1 000039  D900 0000 0000  xsym                 CMR,R5   KNN_NODES
          1 00003C  0201 0009                            BL       s:12387,PREL

      157    12382    3                KN$NETPARM.ERRCODE = %KN_ERR_NORTE;

  12382   1 00003E  ECC7 0004                            LDB,B6   @KN$NETPARM,AUTO
          1 000040  5C03                                 LDV,R5   3
          1 000041  DF46 0016                            STR,R5   22,B6

      158    12383    3                ALTRETURN;

  12383   1 000043  C380 0000 0000  xent                 LNJ,B4   X6A_AALT

      159    12384    3                END;
      160    12385
      161    12386
      162    12387    2           IF KN_NODE# = ROUTE.FEP# THEN;  /* this node is the boundry node      */

  12387   1 000046  D900 0000 0000  xsym                 CMR,R5   KN_NODE#
          1 000049  0901 0038                            BE       s:12410,PREL

      163    12388    3           ELSE DO;

      164    12389    3                IF KNN$ROUTE$(ROUTE.FEP#)->KNN$ROUTE.LINK$ = ADDR(NIL) OR

PL6.E3A0      #001=KNN$SEND File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:04 Page:26   
  12389   1 00004B  B855                                 LDR,R3   R5
          1 00004C  EC80 0000 0000  xsym                 LDB,B6   KNN_ROUTE$$
          1 00004F  DCB6                                 LDB,B5   ,B6,R3
          1 000050  8D85                                 CMN      ,B5
          1 000051  0901 0007                            BE       s:12391,PREL
          1 000053  C845 0005                            LDR,R4   5,B5
          1 000055  C970 00FF                            CMR,R4   255,IMO
          1 000057  0981 0011                            BNE      s:12396,PREL

      165    12390    4                  KNN$ROUTE$(ROUTE.FEP#)->KNN$ROUTE.CURRENT_QOS = 255 THEN DO;

      166    12391    4                     KN$NETPARM.ERRCODE = %KN_ERR_NORTE;

  12391   1 000059  CCC7 0004                            LDB,B4   @KN$NETPARM,AUTO
          1 00005B  4C03                                 LDV,R4   3
          1 00005C  CF44 0016                            STR,R4   22,B4

      167    12392    4                     CALL KNA$RLSLDCT(KN$NETPARM.LDCT$);

  12392   1 00005E  BBC7 0004                            LAB,B3   @KN$NETPARM,AUTO
          1 000060  CBF0 0100                            LAB,B4   256,IMO
          1 000062  E380 0000 0000  xent                 LNJ,B6   KNA$RLSLDCT
          1 000065       0001                            DC       s:12393,PREL

      168    12393    4                     ALTRETURN;

  12393   1 000066  C380 0000 0000  xent                 LNJ,B4   X6A_AALT

      169    12394    4                     END;
      170    12395
      171    12396    3                LINK$ = KNN$ROUTE$(ROUTE.FEP#)->KNN$ROUTE.LINK$;

  12396   1 000069  CC85                                 LDB,B4   ,B5
          1 00006A  CFC7 002D                            STB,B4   LINK$,AUTO

      172    12397    4                IF KNN$LINK.LDCT$ = ADDR(NIL) OR KNN$LINK.QOS = 255 THEN DO;

PL6.E3A0      #001=KNN$SEND File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:04 Page:27   
  12397   1 00006C  8D84                                 CMN      ,B4
          1 00006D  0901 0007                            BE       s:12398,PREL
          1 00006F  A844 0004                            LDR,R2   4,B4
          1 000071  A970 00FF                            CMR,R2   255,IMO
          1 000073  0981 0009                            BNE      s:12401,PREL

      173    12398    4                     KN$NETPARM.ERRCODE = %KN_ERR_NORTE;

  12398   1 000075  BCC7 0004                            LDB,B3   @KN$NETPARM,AUTO
          1 000077  2C03                                 LDV,R2   3
          1 000078  AF43 0016                            STR,R2   22,B3

      174    12399    4                     ALTRETURN;

  12399   1 00007A  C380 0000 0000  xent                 LNJ,B4   X6A_AALT

      175    12400    4                     END;
      176    12401    3                LINK# = KNN$LINK.LDCT$->KN$LDCT.LINK_ID;

  12401   1 00007D  BC84                                 LDB,B3   ,B4
          1 00007E  9843 0003                            LDR,R1   3,B3
          1 000080  9F47 0031                            STR,R1   LINK#,AUTO

      177    12402    3                END;

      178    12403        /*
      179    12404             now that we are sure that there is a route associated with this link.
      180    12405             This could be a connection request from the host, in which case we need
      181    12406             to allocate the ldct.  If the connection request is from a remote connected
      182    12407             system then the ldct was allocated during the knn$recv.fpt_connect code.
      183    12408             Transport is reqesting us to build a K_MSGTYP_OSI_INIT#.
      184    12409        */
      185    12410    3           IF KN$NETPARM.LDCT$ = ADDR(NIL) THEN DO;

  12410   1 000082  ECC7 0004                            LDB,B6   @KN$NETPARM,AUTO
          1 000084  8D86                                 CMN      ,B6
          1 000085  0981 0154                            BNE      s:12493,PREL
PL6.E3A0      #001=KNN$SEND File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:04 Page:28   

      186    12411    4                CALL KNA$GETLDCT(KN$NETPARM.LDCT$) WHENALTRETURN DO;

  12411   1 000087  BBC7 0004                            LAB,B3   @KN$NETPARM,AUTO
          1 000089  CBF0 0100                            LAB,B4   256,IMO
          1 00008B  E380 0000 0000  xent                 LNJ,B6   KNA$GETLDCT
          1 00008E       0003                            DC       s:12412,PREL
          1 00008F  0F81 0009                            B        s:12415,PREL

      187    12412    4                     KN$NETPARM.ERRCODE = %KN_ERR_NOLDCT;

  12412   1 000091  ECC7 0004                            LDB,B6   @KN$NETPARM,AUTO
          1 000093  6C05                                 LDV,R6   5
          1 000094  EF46 0016                            STR,R6   22,B6

      188    12413    4                     ALTRETURN;

  12413   1 000096  C380 0000 0000  xent                 LNJ,B4   X6A_AALT

      189    12414    4                     END;
      190    12415    3                KN$LDCT.CONN_TYPE = %KN_CNTYPE_CIRCUIT;

  12415   1 000099  ECC7 0004                            LDB,B6   @KN$NETPARM,AUTO
          1 00009B  DC86                                 LDB,B5   ,B6
          1 00009C  6C07                                 LDV,R6   7
          1 00009D  E785                                 STH,R6   ,B5

      191    12416    3                KN$LDCT.STATE = %KN_ST_OPENING;

  12416   1 00009E  DC86                                 LDB,B5   ,B6
          1 00009F  5C09                                 LDV,R5   9
          1 0000A0  DA85                                 SRM,R5,'00FF'X    ,B5
          1 0000A1       00FF

      192    12417    3                KN$LDCT.USER_ENTRY$ = ENTADDR(KNN$RECV);

  12417   1 0000A2  DC86                                 LDB,B5   ,B6
PL6.E3A0      #001=KNN$SEND File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:04 Page:29   
          1 0000A3  CB80 0000 0000  xent                 LAB,B4   KNN$RECV
          1 0000A6  CFC5 000C                            STB,B4   12,B5

      193    12418        /*
      194    12419             to find the link on which to issue this connect.  scan the list of links and
      195    12420             compare the chan# with knn$link.chan# and not vc.
      196    12421        */
      197    12422    4                IF KN_NODE# = ROUTE.FEP# THEN DO;

  12422   1 0000A8  C847 003A                            LDR,R4   ROUTE+1,AUTO
          1 0000AA  C570 00FF                            AND,R4   255,IMO
          1 0000AC  C900 0000 0000  xsym                 CMR,R4   KN_NODE#
          1 0000AF  0981 006F                            BNE      s:12446,PREL

      198    12423                   /*
      199    12424                   the connection to the network is on this node.
      200    12425                   */
      201    12426    5                     DO J = 0 TO KNN_LINKS - 1;

  12426   1 0000B1  8747 0038                            CL       J,AUTO
          1 0000B3  0F81 0062                            B        s:12434+2,PREL

      202    12427    5                          LINK$ = KNN$LINK$(J);

  12427   1 0000B5  EC80 0000 0000  xsym                 LDB,B6   KNN_LINK$$
          1 0000B8  B847 0038                            LDR,R3   J,AUTO
          1 0000BA  DCB6                                 LDB,B5   ,B6,R3
          1 0000BB  DFC7 002D                            STB,B5   LINK$,AUTO

      203    12428    5                          IF NOT KNN$LINK.FLAGS.VIRCIR

  12428   1 0000BD  82C5 0003                            LB,'1000'X        3,B5
  12428   1 0000BF       1000
          1 0000C0  0501 0053                            BBT      s:12434,PREL
          1 0000C2  E845 0002                            LDR,R6   2,B5
          1 0000C4  E970 00FD                            CMR,R6   253,IMO
          1 0000C6  0201 004D                            BL       s:12434,PREL
PL6.E3A0      #001=KNN$SEND File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:04 Page:30   
          1 0000C8  8D85                                 CMN      ,B5
          1 0000C9  0901 004A                            BE       s:12434,PREL

      204    12429    5                            AND KNN$LINK.NODE# >= %K_CNC_IS#
      205    12430    5                            AND KNN$LINK.LDCT$ ~= ADDR(NIL)
      206    12431    6                          THEN DO;

      207    12432    6                               SNPATMPLT1 = ROUTE.SNPA.ADDRESS;

  12432   1 0000CB  0021                                 ALR      ;
          1 0000CC       C707 0053                                ALPHANUM(ROUTE+26,AUTO,1,7),;
          1 0000CE       4807 0084                                ALPHANUM(SNPATMPLT1,AUTO,,8,FILL)

      208    12433    6                               SNPATMPLT3 = KNN$LINK.SNPA.ADDRESS;

  12433   1 0000D0  0021                                 ALR      ;
          1 0000D1       C705 001F                                ALPHANUM(31,B5,1,7),;
          1 0000D3       4807 0088                                ALPHANUM(SNPATMPLT3,AUTO,,8,FILL)

      209    12434    7                              DO I = 0 TO MINIMUM(ROUTE.SNPA.LEN,KNN$LINK.SNPA.LEN)-1;

  12434   1 0000D5  437F                                 CSYNC    s:12433+4,SPREL
          1 0000D6  8747 0037                            CL       I,AUTO
          1 0000D8  0F81 002A                            B        s:12437+2,PREL

      210    12435    7                                   IF SNPATMPLT2.NIBBLES.NIB(I) ~= SNPATMPLT4.NIBBLES.
             12435                                             NIB(I) THEN

  12435   1 0000DA  ABC7 0084                            LAB,B2   SNPATMPLT1,AUTO
          1 0000DC  A847 0037                            LDR,R2   I,AUTO
          1 0000DE  2002                                 SOL,R2   2
          1 0000DF  6C04                                 LDV,R6   4
          1 0000E0  BBC7 008C                            LAB,B3   SNPATMPLT3+4,AUTO
          1 0000E2  3C00                                 LDV,R3   0
          1 0000E3  7C10                                 LDV,R7   16
          1 0000E4  D380 0000 0000  xent                 LNJ,B5   X6B_BLR
          1 0000E7  E847 008C                            LDR,R6   SNPATMPLT3+4,AUTO
PL6.E3A0      #001=KNN$SEND File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:04 Page:31   
          1 0000E9  604C                                 SOR,R6   12
          1 0000EA  EF47 008E                            STR,R6   SNPATMPLT3+6,AUTO
          1 0000EC  ABC7 0088                            LAB,B2   SNPATMPLT3,AUTO
          1 0000EE  A847 0037                            LDR,R2   I,AUTO
          1 0000F0  2002                                 SOL,R2   2
          1 0000F1  6C04                                 LDV,R6   4
          1 0000F2  BBC7 008C                            LAB,B3   SNPATMPLT3+4,AUTO
          1 0000F4  3C10                                 LDV,R3   16
          1 0000F5  7C10                                 LDV,R7   16
          1 0000F6  D380 0000 0000  xent                 LNJ,B5   X6B_BLR
          1 0000F9  E847 008D                            LDR,R6   SNPATMPLT3+5,AUTO
          1 0000FB  604C                                 SOR,R6   12
          1 0000FC  D847 008E                            LDR,R5   SNPATMPLT3+6,AUTO
          1 0000FE  E955                                 CMR,R6   R5
          1 0000FF  0981 0014                            BNE      s:12434,PREL

      211    12436    7                                         GOTO NXTJ2;
      212    12437    7                                    END;   /* do i = 0 to min(len,len)-1         */

  12437   1 000101  8AC7 0037                            INC      I,AUTO
          1 000103  ECC7 002D                            LDB,B6   LINK$,AUTO
          1 000105  E2C6 001F                            LLH,R6   31,B6
          1 000107  D2C7 0053                            LLH,R5   ROUTE+26,AUTO
          1 000109  D956                                 CMR,R5   R6
          1 00010A  0281 0002                            BGE      s:12437+12,PREL
          1 00010C  E855                                 LDR,R6   R5
          1 00010D  E947 0037                            CMR,R6   I,AUTO
          1 00010F  034B                                 BG       s:12435,SPREL

      213    12438    6                               TLINK$ = LINK$;

  12438   1 000110  EFC7 002F                            STB,B6   TLINK$,AUTO

      214    12439    6                               GOTO FOUNDROUTE;

  12439   1 000112  0F81 004C                            B        s:12452,PREL

PL6.E3A0      #001=KNN$SEND File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:04 Page:32   
  12434   1                              NXTJ2           null
      215    12440    6                               END;        /* if not vircir and node > is        */
      216    12441    5   NXTJ2:                 ;
      217    12442    5                          END;             /* do j= 0 to knn_links -1            */

  12442   1 000114  8AC7 0038            NXTJ2           INC      J,AUTO
          1 000116  E847 0038                            LDR,R6   J,AUTO
          1 000118  E900 0000 0000  xsym                 CMR,R6   KNN_LINKS
          1 00011B  0201 FF99                            BL       s:12427,PREL

      218    12443    4                     GOTO NOROUTE;

  12443   1 00011D  0F81 0026                            B        s:12452,PREL

      219    12444    4                     END;                  /* if kn_node# = route.fep#           */
      220    12445    4                ELSE DO;

      221    12446    4                     CHAN# = KNN$LINK.CHAN#;

  12446   1 00011F  DCC7 002D                            LDB,B5   LINK$,AUTO
          1 000121  B845 0023                            LDR,R3   35,B5
          1 000123  BF47 0032                            STR,R3   CHAN#,AUTO

      222    12447    5                     DO I = 0 TO KNN_LINKS-1;

  12447   1 000125  8747 0037                            CL       I,AUTO
          1 000127  0F81 0030                            B        s:12458+2,PREL

      223    12448    5                          TLINK$ = KNN$LINK$(I);

  12448   1 000129  EC80 0000 0000  xsym                 LDB,B6   KNN_LINK$$
          1 00012C  B847 0037                            LDR,R3   I,AUTO
          1 00012E  DCB6                                 LDB,B5   ,B6,R3
          1 00012F  DFC7 002F                            STB,B5   TLINK$,AUTO

      224    12449    6                          IF TLINK$->KNN$LINK.CHAN# = CHAN# AND NOT TLINK$->KNN$LINK.
             12449                                   FLAGS.VIRCIR THEN DO;
PL6.E3A0      #001=KNN$SEND File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:04 Page:33   

  12449   1 000131  E845 0023                            LDR,R6   35,B5
          1 000133  E947 0032                            CMR,R6   CHAN#,AUTO
          1 000135  0981 0020                            BNE      s:12458,PREL
          1 000137  82C5 0003                            LB,'1000'X        3,B5
          1 000139       1000
          1 00013A  0501 001B                            BBT      s:12458,PREL

      225    12450    6                               QQQ$ = KN$NETPARM.LDCT$;
             12450                                        /* save so we can return it to transport*/

  12450   1 00013C  CCC7 0004                            LDB,B4   @KN$NETPARM,AUTO
          1 00013E  BC84                                 LDB,B3   ,B4
          1 00013F  BFC7 0033                            STB,B3   QQQ$,AUTO

      226    12451    7                               IF TLINK$->KNN$LINK.LDCT$ = ADDR(NIL) THEN DO;

  12451   1 000141  8D85                                 CMN      ,B5
          1 000142  0981 0011                            BNE      s:12456,PREL

      227    12452    7   NOROUTE:                         CALL KNA$RLSLDCT(KN$NETPARM.LDCT$);

  12452   1 000144  BBC7 0004            NOROUTE         LAB,B3   @KN$NETPARM,AUTO
          1 000146  CBF0 0100                            LAB,B4   256,IMO
          1 000148  E380 0000 0000  xent                 LNJ,B6   KNA$RLSLDCT
          1 00014B       0001                            DC       s:12453,PREL

      228    12453    7                                    KN$NETPARM.ERRCODE = %KN_ERR_NORTE;

  12453   1 00014C  ECC7 0004                            LDB,B6   @KN$NETPARM,AUTO
          1 00014E  6C03                                 LDV,R6   3
          1 00014F  EF46 0016                            STR,R6   22,B6

      229    12454    7                                    ALTRETURN;

  12454   1 000151  C380 0000 0000  xent                 LNJ,B4   X6A_AALT

PL6.E3A0      #001=KNN$SEND File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:04 Page:34   
      230    12455    7                                    END;
      231    12456    6                               GOTO FOUNDROUTE;

  12456   1 000154  0F81 000A                            B        s:12452,PREL

      232    12457    6                               END;        /* chan# and not vircir               */
      233    12458    5                          END;             /* do i = 0 knn_links                 */

  12458   1 000156  8AC7 0037                            INC      I,AUTO
          1 000158  E847 0037                            LDR,R6   I,AUTO
          1 00015A  E900 0000 0000  xsym                 CMR,R6   KNN_LINKS
          1 00015D  024C                                 BL       s:12448,SPREL

      234    12459    4                     GOTO NOROUTE;

  12459   1 00015E  0FE6                                 B        s:12452,SPREL

  12452   1                              FOUNDROUTE      null
      235    12460    4                     END;                  /* else kn_node = route.fep#          */
      236    12461    3   FOUNDROUTE:  ;
      237    12462    3                KN$LDCT.UID = TLINK$->KNN$LINK.LDCT$->KN$LDCT.UID;

  12462   1 00015F  ECC7 0004            FOUNDROUTE      LDB,B6   @KN$NETPARM,AUTO
          1 000161  DC86                                 LDB,B5   ,B6
          1 000162  CCC7 002F                            LDB,B4   TLINK$,AUTO
          1 000164  BC84                                 LDB,B3   ,B4
          1 000165  8CC3 0005                            LDI      5,B3
          1 000167  8D45 0005                            SDI      5,B5

      238    12463    3                KN$LDCT.USER# = TLINK$->KNN$LINK.LDCT$->KN$LDCT.USER#;

  12463   1 000169  DC86                                 LDB,B5   ,B6
          1 00016A  BC84                                 LDB,B3   ,B4
          1 00016B  E843 000E                            LDR,R6   14,B3
          1 00016D  EF45 000E                            STR,R6   14,B5

      239    12464    3                FPT_CONNECT = FPT_CONNECT_C;
PL6.E3A0      #001=KNN$SEND File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:04 Page:35   

  12464   1 00016F  AB80 0000 0000  00                   LAB,B2   INIT_QDP_HDR
          1 000172  2C48                                 LDV,R2   72
          1 000173  6C5A                                 LDV,R6   90
          1 000174  BBC7 0057                            LAB,B3   FPT_CONNECT,AUTO
          1 000176  3C00                                 LDV,R3   0
          1 000177  0008                                 MMM

      240    12465    3                FPT_CONNECT.CLASS = 0;

  12465   1 000178  87C7 0068                            CLH      FPT_CONNECT+17,AUTO

      241    12466    3                FPT_CONNECT.TR_FLAGS = '0'B;

  12466   1 00017A  8747 0069                            CL       FPT_CONNECT+18,AUTO

      242    12467    3                IF ROUTE.NW_TYPE ~= %K_NWTYPE_X2580

  12467   1 00017C  E847 0039                            LDR,R6   ROUTE,AUTO
          1 00017E  E570 000F                            AND,R6   15,IMO
          1 000180  6D01                                 CMV,R6   1
          1 000181  0901 001D                            BE       s:12474,PREL

      243    12468    4                THEN DO;

      244    12469    4                     FPT_CONNECT.DEST = DST;

  12469   1 000183  DCC6 001F                            LDB,B5   31,B6
          1 000185  AB85                                 LAB,B2   ,B5
          1 000186  2C00                                 LDV,R2   0
          1 000187  6C16                                 LDV,R6   22
          1 000188  BBC7 006A                            LAB,B3   FPT_CONNECT+19,AUTO
          1 00018A  3C00                                 LDV,R3   0
          1 00018B  0008                                 MMM

      245    12470    4                     FPT_CONNECT.LADR = SRC;

PL6.E3A0      #001=KNN$SEND File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:04 Page:36   
  12470   1 00018C  CCC6 001D                            LDB,B4   29,B6
          1 00018E  AB84                                 LAB,B2   ,B4
          1 00018F  2C00                                 LDV,R2   0
          1 000190  6C16                                 LDV,R6   22
          1 000191  BBC7 0075                            LAB,B3   FPT_CONNECT+30,AUTO
          1 000193  3C00                                 LDV,R3   0
          1 000194  0008                                 MMM

      246    12471    4                     FPT_CONNECT.DSTSNPA = ROUTE.SNPA;

  12471   1 000195  ABC7 0053                            LAB,B2   ROUTE+26,AUTO
          1 000197  2C00                                 LDV,R2   0
          1 000198  6C08                                 LDV,R6   8
          1 000199  BBC7 0080                            LAB,B3   FPT_CONNECT+41,AUTO
          1 00019B  3C00                                 LDV,R3   0
          1 00019C  0008                                 MMM

      247    12472    4                     END;

  12472   1 00019D  0F81 000F                            B        s:12477,PREL

      248    12473    4                ELSE DO;

      249    12474    4                     FPT_CONNECT.DSTSNPA = DST;

  12474   1 00019F  DCC6 001F                            LDB,B5   31,B6
          1 0001A1  AB85                                 LAB,B2   ,B5
          1 0001A2  2C00                                 LDV,R2   0
          1 0001A3  6C08                                 LDV,R6   8
          1 0001A4  BBC7 0080                            LAB,B3   FPT_CONNECT+41,AUTO
          1 0001A6  3C00                                 LDV,R3   0
          1 0001A7  0008                                 MMM

      250    12475    4                     FPT_CONNECT.DSTSNPA.LNG = FPT_CONNECT.DSTSNPA.LNG*2;

  12475   1 0001A8  E2C7 0080                            LLH,R6   FPT_CONNECT+41,AUTO
          1 0001AA  6001                                 SOL,R6   1
PL6.E3A0      #001=KNN$SEND File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:04 Page:37   
          1 0001AB  E7C7 0080                            STH,R6   FPT_CONNECT+41,AUTO

      251    12476    4                     END;

      252    12477    3                KN$NETPARM.FUNCTION = %KN_FCN_INIT;

  12477   1 0001AD  6C01                                 LDV,R6   1
          1 0001AE  EF46 0014                            STR,R6   20,B6

      253    12478    3                FPT_CONNECT.RESOURCE = ' ';

  12478   1 0001B0  0021                                 ALR      ;
          1 0001B1       4178 2000                                ALPHANUM('2000'X,IMO,,1),;
          1 0001B3       4807 0058                                ALPHANUM(FPT_CONNECT+1,AUTO,,8,FILL)

      254    12479    3                KN$NETPARM.RECTYPE = 0;

  12479   1 0001B5  437F                                 CSYNC    s:12478+4,SPREL
          1 0001B6  8746 0013                            CL       19,B6

      255    12480    3                KN$NETPARM.THDRSZ = 0;

  12480   1 0001B8  8746 000D                            CL       13,B6

      256    12481    3                KN$NETPARM.UHDRSZ = 0;

  12481   1 0001BA  8746 0007                            CL       7,B6

      257    12482    3                KN$NETPARM.SHDRSZ = 0;

  12482   1 0001BC  8746 000A                            CL       10,B6

      258    12483    3                KN$NETPARM.NHDRSZ = 0;

  12483   1 0001BE  8746 0010                            CL       16,B6

      259    12484    3                IF KN$NETPARM.FLAGS.CONS = '0'B
PL6.E3A0      #001=KNN$SEND File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:04 Page:38   

  12484   1 0001C0  82C6 0012                            LB,'0100'X        18,B6
  12484   1 0001C2       0100
          1 0001C3  0501 0003                            BBT      s:12486,PREL

      260    12485    3                THEN KN$NETPARM.MSGSZ = 0; /*else contains tpdu_un*/

  12485   1 0001C5  8746 0004                            CL       4,B6

      261    12486    3                KN$NETPARM.FPT$ = ADDR(FPT_CONNECT);

  12486   1 0001C7  CBC7 0057                            LAB,B4   FPT_CONNECT,AUTO
          1 0001C9  CFC6 0019                            STB,B4   25,B6

      262    12487    4                CALL KNH$SEND(KN$NETPARM) WHENALTRETURN DO;

  12487   1 0001CB  BBC7 0004                            LAB,B3   @KN$NETPARM,AUTO
          1 0001CD  CBF0 0100                            LAB,B4   256,IMO
          1 0001CF  E380 0000 0000  xent                 LNJ,B6   KNH$SEND
          1 0001D2       0003                            DC       s:12488,PREL
          1 0001D3  0F81 0003                            B        s:12490,PREL

      263    12488    4                     GOTO NOROUTE;         /* error code is set by send          */

  12488   1 0001D5  0F81 FF6E                            B        s:12452,PREL

      264    12489    4                     END;
      265    12490    3                RETURN;     /* now back to transport to await the fpt_init_ack   */

  12490   1 0001D7  C380 0000 0000  xent                 LNJ,B4   X6A_ARET

      266    12491    3                END;                       /* if ldct = addr(nil)                */
      267    12492    3           ELSE DO;         /* ldct is not addr(nil) connection is to the host   */

      268    12493    3                DEST_NODE = ROUTE.HOST#;

  12493   1 0001DA  C2C7 003A                            LLH,R4   ROUTE+1,AUTO
PL6.E3A0      #001=KNN$SEND File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:04 Page:39   
          1 0001DC  CF47 002A                            STR,R4   DEST_NODE,AUTO

      269    12494    3                ROUTE$ = KNN$ROUTE$(DEST_NODE);

  12494   1 0001DE  DC80 0000 0000  xsym                 LDB,B5   KNN_ROUTE$$
          1 0001E1  B854                                 LDR,R3   R4
          1 0001E2  CCB5                                 LDB,B4   ,B5,R3
          1 0001E3  CFC7 002B                            STB,B4   ROUTE$,AUTO

      270    12495    3                IF NOT KNN$ROUTE.FLAGS.LINK_CONNECTED

  12495   1 0001E5  82C4 0007                            LB,'4000'X        7,B4
  12495   1 0001E7       4000
          1 0001E8  0581 000B                            BBF      s:12501,PREL
          1 0001EA  89C4 0007                            CMZ      7,B4
          1 0001EC  0881 0007                            BAGE     s:12501,PREL
          1 0001EE  A844 0005                            LDR,R2   5,B4
          1 0001F0  A970 00FF                            CMR,R2   255,IMO
          1 0001F2  0981 0007                            BNE      s:12504,PREL

      271    12496    4                  OR NOT KNN$ROUTE.FLAGS.HOST_NODE OR KNN$ROUTE.CURRENT_QOS = 255 THEN
             12496                           DO;

      272    12497        /*
      273    12498                   if the dest node is not link connected and it is not a host node then
      274    12499                   we shouldn't be here
      275    12500        */
      276    12501    4                     KN$NETPARM.ERRCODE = %KN_ERR_NORTE;

  12501   1 0001F4  2C03                                 LDV,R2   3
          1 0001F5  AF46 0016                            STR,R2   22,B6

      277    12502    4                     ALTRETURN;

  12502   1 0001F7  C380 0000 0000  xent                 LNJ,B4   X6A_AALT

      278    12503    4                     END;
PL6.E3A0      #001=KNN$SEND File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:04 Page:40   
      279    12504    3                IF KNN$ROUTE.LINK$ = ADDR(NIL)

  12504   1 0001FA  8D84                                 CMN      ,B4
          1 0001FB  0901 0005                            BE       s:12506,PREL
          1 0001FD  BC84                                 LDB,B3   ,B4
          1 0001FE  8D83                                 CMN      ,B3
          1 0001FF  0981 0007                            BNE      s:12510,PREL

      280    12505    4                  OR KNN$ROUTE.LINK$->KNN$LINK.LDCT$ = ADDR(NIL) THEN DO;

      281    12506    4                     KN$NETPARM.ERRCODE = %KN_ERR_NORTE;

  12506   1 000201  1C03                                 LDV,R1   3
          1 000202  9F46 0016                            STR,R1   22,B6

      282    12507    4                     ALTRETURN;

  12507   1 000204  C380 0000 0000  xent                 LNJ,B4   X6A_AALT

      283    12508    4                     END;
      284    12509
      285    12510    3                QQQ$ = KN$NETPARM.LDCT$;

  12510   1 000207  AC86                                 LDB,B2   ,B6
          1 000208  AFC7 0033                            STB,B2   QQQ$,AUTO

      286    12511    3                KN$NETPARM.LDCT$ = KNN$ROUTE.LINK$->KNN$LINK.LDCT$;

  12511   1 00020A  9C83                                 LDB,B1   ,B3
          1 00020B  9F86                                 STB,B1   ,B6

      287    12512    3                KN$NETPARM.FUNCTION = %KN_FCN_DATA;

  12512   1 00020C  6C05                                 LDV,R6   5
          1 00020D  EF46 0014                            STR,R6   20,B6

      288    12513    3                OSI_INIT = OSI_INIT_C;
PL6.E3A0      #001=KNN$SEND File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:04 Page:41   

  12513   1 00020F  AB80 0000 0000  00                   LAB,B2   INIT_QDP_HDR
          1 000212  2C04                                 LDV,R2   4
          1 000213  6C44                                 LDV,R6   68
          1 000214  BB87                                 LAB,B3   ,AUTO
          1 000215  3C10                                 LDV,R3   16
          1 000216  0008                                 MMM

      289    12514    3                OSI_INIT.DEST_NODE = DEST_NODE + 1;

  12514   1 000217  E847 002A                            LDR,R6   DEST_NODE,AUTO
          1 000219  6E01                                 ADV,R6   1
          1 00021A  E7C7 0009                            STH,R6   OSI_INIT+1,AUTO

      290    12515    3                OSI_INIT.SOURCE_NODE = KN_NODE# + 1;

  12515   1 00021C  D800 0000 0000  xsym                 LDR,R5   KN_NODE#
          1 00021F  5E01                                 ADV,R5   1
          1 000220  DAC7 0009                            SRM,R5,'00FF'X    OSI_INIT+1,AUTO
          1 000222       00FF

      291    12516    3                OSI_INIT.DST_NSAP = DST;

  12516   1 000223  DCC6 001F                            LDB,B5   31,B6
          1 000225  AB85                                 LAB,B2   ,B5
          1 000226  2C00                                 LDV,R2   0
          1 000227  6C16                                 LDV,R6   22
          1 000228  BB87                                 LAB,B3   ,AUTO
          1 000229  3C14                                 LDV,R3   20
          1 00022A  0008                                 MMM

      292    12517    3                OSI_INIT.SRC_NSAP = SRC;

  12517   1 00022B  CCC6 001D                            LDB,B4   29,B6
          1 00022D  AB84                                 LAB,B2   ,B4
          1 00022E  2C00                                 LDV,R2   0
          1 00022F  6C16                                 LDV,R6   22
PL6.E3A0      #001=KNN$SEND File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:04 Page:42   
          1 000230  BB87                                 LAB,B3   ,AUTO
          1 000231  3C2A                                 LDV,R3   42
          1 000232  0008                                 MMM

      293    12518    3                KN$NETPARM.NHDR$ = ADDR(OSI_INIT);

  12518   1 000233  9BC7 0008                            LAB,B1   OSI_INIT,AUTO
          1 000235  9FC6 000E                            STB,B1   14,B6

      294    12519    3                KN$NETPARM.NHDRSZ = LENGTHC(OSI_INIT);

  12519   1 000237  6C44                                 LDV,R6   68
          1 000238  EF46 0010                            STR,R6   16,B6

      295    12520    3                SAVE_FPT$ = KN$NETPARM.FPT$;

  12520   1 00023A  DCC6 0019                            LDB,B5   25,B6
          1 00023C  DFC7 0035                            STB,B5   SAVE_FPT$,AUTO

      296    12521    3                KN$NETPARM.FPT$ = ADDR(NIL);

  12521   1 00023E  EB80 0000 0000                       LAB,B6   0
          1 000241  9CC7 0004                            LDB,B1   @KN$NETPARM,AUTO
          1 000243  EFC1 0019                            STB,B6   25,B1

      297    12522    3                CALL KNH$SEND(KN$NETPARM) ALTRET(ERROR1);

  12522   1 000245  BBC7 0004                            LAB,B3   @KN$NETPARM,AUTO
          1 000247  CBF0 0100                            LAB,B4   256,IMO
          1 000249  E380 0000 0000  xent                 LNJ,B6   KNH$SEND
          1 00024C       01DF                            DC       s:12687,PREL

      298    12523
      299    12524    3               KNN$ROUTE.LINK$->KNN$LINK.MSGS_OUT = KNN$ROUTE.LINK$->KNN$LINK.MSGS_OUT
             12524                         + 1;

  12524   1 00024D  ECC7 002B                            LDB,B6   ROUTE$,AUTO
PL6.E3A0      #001=KNN$SEND File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:04 Page:43   
          1 00024F  DC86                                 LDB,B5   ,B6
          1 000250  8AC5 0008                            INC      8,B5
          1 000252  8EC5 0007                            CAD      7,B5

      300    12525    3                LINK# = KN$LDCT.LINK_ID;

  12525   1 000254  DCC7 0004                            LDB,B5   @KN$NETPARM,AUTO
          1 000256  CC85                                 LDB,B4   ,B5
          1 000257  E844 0003                            LDR,R6   3,B4
          1 000259  EF47 0031                            STR,R6   LINK#,AUTO

      301    12526    3                KNN$ROUTE.LINK.MSGS_OUT(LINK#) = KNN$ROUTE.LINK.MSGS_OUT(LINK#) + 1;

  12526   1 00025B  B856                                 LDR,R3   R6
          1 00025C  3F0A                                 MLV,R3   10
          1 00025D  5C04                                 LDV,R5   4
          1 00025E  0021                                 ALR      ;
          1 00025F       4436 000B                                ALPHANUM(11,B6,R3,,4),;
          1 000261       4007 008E                                ALPHANUM(SNPATMPLT3+6,AUTO,,R5,FILL)
          1 000263  437F                                 CSYNC    s:12526+7,SPREL
          1 000264  8CC7 008E                            LDI      SNPATMPLT3+6,AUTO
          1 000266  8470 0000 0001                       AID      1,IMO
          1 000269  8D47 008C                            SDI      SNPATMPLT3+4,AUTO
          1 00026B  ABC7 008C                            LAB,B2   SNPATMPLT3+4,AUTO
          1 00026D  2C00                                 LDV,R2   0
          1 00026E  6C04                                 LDV,R6   4
          1 00026F  BB86                                 LAB,B3   ,B6
          1 000270  3E16                                 ADV,R3   22
          1 000271  0008                                 MMM

      302    12527
      303    12528    3                KN$NETPARM.LDCT$ = QQQ$;

  12528   1 000272  CCC7 0033                            LDB,B4   QQQ$,AUTO
          1 000274  CF85                                 STB,B4   ,B5

      304    12529    3                KN$NETPARM.FPT$ = SAVE_FPT$;
PL6.E3A0      #001=KNN$SEND File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:04 Page:44   

  12529   1 000275  ACC7 0035                            LDB,B2   SAVE_FPT$,AUTO
          1 000277  AFC5 0019                            STB,B2   25,B5

      305    12530    3                RETURN;

  12530   1 000279  C380 0000 0000  xent                 LNJ,B4   X6A_ARET

      306    12531    3                END;                       /* else ldct ~= addr(nil)             */
      307    12532    2           END;                            /* function = nconnect and CONS       */
      308    12533        %EJECT;
PL6.E3A0      #001=KNN$SEND File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:04 Page:45   
      309    12534        /*
      310    12535                connection request for OSI transport over CLNS.
      311    12536        */
      312    12537
      313    12538    2      IF KN$NETPARM.FUNCTION = %K_NCONNECT_REQ THEN DO;

  12538   1 00027C  0981 007A                            BNE      s:12572,PREL

      314    12539    2           KN$NETPARM.FUNCTION = %K_NDATA;

  12539   1 00027E  6C21                                 LDV,R6   33
          1 00027F  EF46 0014                            STR,R6   20,B6

      315    12540    2           OSI_INIT = OSI_INIT_C;

  12540   1 000281  AB80 0000 0000  00                   LAB,B2   INIT_QDP_HDR
          1 000284  2C04                                 LDV,R2   4
          1 000285  6C44                                 LDV,R6   68
          1 000286  BB87                                 LAB,B3   ,AUTO
          1 000287  3C10                                 LDV,R3   16
          1 000288  0008                                 MMM

      316    12541    2           OSI_INIT.DEST_NODE = KN$NETPARM.NODE + 1;

  12541   1 000289  E846 0015                            LDR,R6   21,B6
          1 00028B  6E01                                 ADV,R6   1
          1 00028C  E7C7 0009                            STH,R6   OSI_INIT+1,AUTO

      317    12542    2           DEST_NODE = KN$NETPARM.NODE;

  12542   1 00028E  D846 0015                            LDR,R5   21,B6
          1 000290  DF47 002A                            STR,R5   DEST_NODE,AUTO

      318    12543    2           OSI_INIT.SOURCE_NODE = KN_NODE# + 1;

  12543   1 000292  C800 0000 0000  xsym                 LDR,R4   KN_NODE#
          1 000295  4E01                                 ADV,R4   1
PL6.E3A0      #001=KNN$SEND File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:04 Page:46   
          1 000296  CAC7 0009                            SRM,R4,'00FF'X    OSI_INIT+1,AUTO
          1 000298       00FF

      319    12544    2           OSI_INIT.DST_NSAP = DST;

  12544   1 000299  DCC6 001F                            LDB,B5   31,B6
          1 00029B  AB85                                 LAB,B2   ,B5
          1 00029C  2C00                                 LDV,R2   0
          1 00029D  6C16                                 LDV,R6   22
          1 00029E  BB87                                 LAB,B3   ,AUTO
          1 00029F  3C14                                 LDV,R3   20
          1 0002A0  0008                                 MMM

      320    12545    2           OSI_INIT.SRC_NSAP = SRC;

  12545   1 0002A1  CCC6 001D                            LDB,B4   29,B6
          1 0002A3  AB84                                 LAB,B2   ,B4
          1 0002A4  2C00                                 LDV,R2   0
          1 0002A5  6C16                                 LDV,R6   22
          1 0002A6  BB87                                 LAB,B3   ,AUTO
          1 0002A7  3C2A                                 LDV,R3   42
          1 0002A8  0008                                 MMM

      321    12546    2           KN$NETPARM.UHDRSZ = 0;

  12546   1 0002A9  8746 0007                            CL       7,B6

      322    12547    2           KN$NETPARM.NHDR$ = ADDR(OSI_INIT);

  12547   1 0002AB  9BC7 0008                            LAB,B1   OSI_INIT,AUTO
          1 0002AD  9FC6 000E                            STB,B1   14,B6

      323    12548    2           KN$NETPARM.NHDRSZ = LENGTHC(OSI_INIT);

  12548   1 0002AF  6C44                                 LDV,R6   68
          1 0002B0  EF46 0010                            STR,R6   16,B6

PL6.E3A0      #001=KNN$SEND File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:04 Page:47   
      324    12549    2           QQQ$ = KN$NETPARM.LDCT$;

  12549   1 0002B2  DC86                                 LDB,B5   ,B6
          1 0002B3  DFC7 0033                            STB,B5   QQQ$,AUTO

      325    12550    2           SAVE_FPT$ = KN$NETPARM.FPT$;

  12550   1 0002B5  DCC6 0019                            LDB,B5   25,B6
          1 0002B7  DFC7 0035                            STB,B5   SAVE_FPT$,AUTO

      326    12551    2           KN$NETPARM.FPT$ = ADDR(NIL);

  12551   1 0002B9  EB80 0000 0000                       LAB,B6   0
          1 0002BC  9CC7 0004                            LDB,B1   @KN$NETPARM,AUTO
          1 0002BE  EFC1 0019                            STB,B6   25,B1

      327    12552    3           IF DEST_NODE <= KNN_NODES THEN DO;

  12552   1 0002C0  D847 002A                            LDR,R5   DEST_NODE,AUTO
          1 0002C2  D900 0000 0000  xsym                 CMR,R5   KNN_NODES
          1 0002C5  0301 0029                            BG       s:12565,PREL

      328    12553    3                ROUTE$ = KNN$ROUTE$(DEST_NODE);

  12553   1 0002C7  EC80 0000 0000  xsym                 LDB,B6   KNN_ROUTE$$
          1 0002CA  B855                                 LDR,R3   R5
          1 0002CB  DCB6                                 LDB,B5   ,B6,R3
          1 0002CC  DFC7 002B                            STB,B5   ROUTE$,AUTO

      329    12554    3                IF KNN$ROUTE.LINK$ = ADDR(NIL)

  12554   1 0002CE  8D85                                 CMN      ,B5
          1 0002CF  0901 000E                            BE       s:12558,PREL
          1 0002D1  EC85                                 LDB,B6   ,B5
          1 0002D2  8D86                                 CMN      ,B6
          1 0002D3  0901 000A                            BE       s:12558,PREL
          1 0002D5  82C5 0007                            LB,'4000'X        7,B5
PL6.E3A0      #001=KNN$SEND File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:04 Page:48   
          1 0002D7       4000
          1 0002D8  0581 0005                            BBF      s:12558,PREL
          1 0002DA  89C5 0007                            CMZ      7,B5
          1 0002DC  0801 0006                            BAL      s:12561,PREL

      330    12555    3                  OR KNN$ROUTE.LINK$->KNN$LINK.LDCT$ = ADDR(NIL)
      331    12556    3                  OR NOT KNN$ROUTE.FLAGS.LINK_CONNECTED
      332    12557    4                  OR NOT KNN$ROUTE.FLAGS.HOST_NODE THEN DO;

      333    12558    4                     KN$NETPARM.ERRCODE = %KN_ERR_NORTE;

  12558   1 0002DE  4C03                                 LDV,R4   3
          1 0002DF  CF41 0016                            STR,R4   22,B1

      334    12559    4                     GOTO ERROR1;

  12559   1 0002E1  0F81 0149                            B        s:12687,PREL

      335    12560    4                     END;
      336    12561    3                KN$NETPARM.LDCT$ = KNN$ROUTE.LINK$->KNN$LINK.LDCT$;

  12561   1 0002E3  DC86                                 LDB,B5   ,B6
          1 0002E4  DF81                                 STB,B5   ,B1

      337    12562    3                CALL KNH$SEND(KN$NETPARM) ALTRET(ERROR1);

  12562   1 0002E5  BBC7 0004                            LAB,B3   @KN$NETPARM,AUTO
          1 0002E7  CBF0 0100                            LAB,B4   256,IMO
          1 0002E9  E380 0000 0000  xent                 LNJ,B6   KNH$SEND
          1 0002EC       013F                            DC       s:12687,PREL

      338    12563    3                END;                       /*  if dest_node <                    */

  12563   1 0002ED  0F81 0006                            B        s:12568,PREL

      339    12564    3           ELSE DO;

PL6.E3A0      #001=KNN$SEND File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:04 Page:49   
      340    12565    3                KN$NETPARM.ERRCODE = %KN_ERR_NORTE;

  12565   1 0002EF  4C03                                 LDV,R4   3
          1 0002F0  CF41 0016                            STR,R4   22,B1

      341    12566    3                GOTO ERROR1;

  12566   1 0002F2  0F81 0138                            B        s:12687,PREL

      342    12567    3                END;                       /* else dest_node <                   */
      343    12568    2           RETURN;

  12568   1 0002F4  C380 0000 0000  xent                 LNJ,B4   X6A_ARET

      344    12569    2           END;                            /* nconnect and CLNS                  */
      345    12570        %EJECT;
PL6.E3A0      #001=KNN$SEND File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:04 Page:50   
      346    12571
      347    12572    2      IF KN$NETPARM.FUNCTION = %K_NDATA THEN DO;

  12572   1 0002F7  6D21                                 CMV,R6   33
          1 0002F8  0981 0088                            BNE      s:12631,PREL

      348    12573        /*
      349    12574             a function of k_ndata could indicate one of two things:
      350    12575                1 - an incoming transport frag from a foreign osi
      351    12576                    system.  In this case we build an osi_data message and forward
      352    12577                    to the designated host.
      353    12578
      354    12579                2 - an outgoing data message.  These are for OSI CLNS
      355    12580                    connections which have already been established.  forward kn$netparm
      356    12581                    to sendosi.
      357    12582        */
      358    12583    3           IF KN$NETPARM.DST_ADDR$ = ADDR(NIL) THEN DO;

  12583   1 0002FA  8DC6 001F                            CMN      31,B6
          1 0002FC  0981 0064                            BNE      s:12616,PREL

      359    12584         /*
      360    12585                incoming request to be forwarded to the host
      361    12586        */
      362    12587    3                QDP_HDR = INIT_QDP_HDR;

  12587   1 0002FE  8C80 0000 0000  00                   LDI      INIT_QDP_HDR
          1 000301  8D47 0006                            SDI      QDP_HDR,AUTO

      363    12588    3                QDP_HDR.DEST_NODE = KN$NETPARM.NODE + 1;

  12588   1 000303  D846 0015                            LDR,R5   21,B6
          1 000305  5E01                                 ADV,R5   1
          1 000306  D7C7 0007                            STH,R5   QDP_HDR+1,AUTO

      364    12589    3                DEST_NODE = KN$NETPARM.NODE;

PL6.E3A0      #001=KNN$SEND File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:04 Page:51   
  12589   1 000308  C846 0015                            LDR,R4   21,B6
          1 00030A  CF47 002A                            STR,R4   DEST_NODE,AUTO

      365    12590    3                QDP_HDR.SOURCE_NODE = KN_NODE# + 1;

  12590   1 00030C  B800 0000 0000  xsym                 LDR,R3   KN_NODE#
          1 00030F  3E01                                 ADV,R3   1
          1 000310  BAC7 0007                            SRM,R3,'00FF'X    QDP_HDR+1,AUTO
          1 000312       00FF

      366    12591    3                KN$NETPARM.UHDRSZ = 0;

  12591   1 000313  8746 0007                            CL       7,B6

      367    12592    3                KN$NETPARM.NHDR$ = ADDR(QDP_HDR);

  12592   1 000315  DBC7 0006                            LAB,B5   QDP_HDR,AUTO
          1 000317  DFC6 000E                            STB,B5   14,B6

      368    12593    3                KN$NETPARM.NHDRSZ = LENGTHC(QDP_HDR);

  12593   1 000319  2C04                                 LDV,R2   4
          1 00031A  AF46 0010                            STR,R2   16,B6

      369    12594    3                QQQ$ = KN$NETPARM.LDCT$;

  12594   1 00031C  CC86                                 LDB,B4   ,B6
          1 00031D  CFC7 0033                            STB,B4   QQQ$,AUTO

      370    12595    3                SAVE_FPT$ = KN$NETPARM.FPT$;

  12595   1 00031F  BCC6 0019                            LDB,B3   25,B6
          1 000321  BFC7 0035                            STB,B3   SAVE_FPT$,AUTO

      371    12596    3                KN$NETPARM.FPT$ = ADDR(NIL);

  12596   1 000323  AB80 0000 0000                       LAB,B2   0
PL6.E3A0      #001=KNN$SEND File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:04 Page:52   
          1 000326  AFC6 0019                            STB,B2   25,B6

      372    12597    4                IF DEST_NODE <= KNN_NODES THEN DO;

  12597   1 000328  C900 0000 0000  xsym                 CMR,R4   KNN_NODES
          1 00032B  0301 002D                            BG       s:12610,PREL

      373    12598    4                     ROUTE$ = KNN$ROUTE$(DEST_NODE);

  12598   1 00032D  9C80 0000 0000  xsym                 LDB,B1   KNN_ROUTE$$
          1 000330  9854                                 LDR,R1   R4
          1 000331  EC91                                 LDB,B6   ,B1,R1
          1 000332  EFC7 002B                            STB,B6   ROUTE$,AUTO

      374    12599    4                     IF KNN$ROUTE.LINK$ = ADDR(NIL)

  12599   1 000334  8D86                                 CMN      ,B6
          1 000335  0901 000E                            BE       s:12603,PREL
          1 000337  DC86                                 LDB,B5   ,B6
          1 000338  8D85                                 CMN      ,B5
          1 000339  0901 000A                            BE       s:12603,PREL
          1 00033B  82C6 0007                            LB,'4000'X        7,B6
          1 00033D       4000
          1 00033E  0581 0005                            BBF      s:12603,PREL
          1 000340  89C6 0007                            CMZ      7,B6
          1 000342  0801 0008                            BAL      s:12606,PREL

      375    12600    4                       OR KNN$ROUTE.LINK$->KNN$LINK.LDCT$ = ADDR(NIL)
      376    12601    4                       OR NOT KNN$ROUTE.FLAGS.LINK_CONNECTED
      377    12602    5                       OR NOT KNN$ROUTE.FLAGS.HOST_NODE THEN DO;

      378    12603    5                          KN$NETPARM.ERRCODE = %KN_ERR_NORTE;

  12603   1 000344  DCC7 0004                            LDB,B5   @KN$NETPARM,AUTO
          1 000346  5C03                                 LDV,R5   3
          1 000347  DF45 0016                            STR,R5   22,B5

PL6.E3A0      #001=KNN$SEND File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:04 Page:53   
      379    12604    5                          GOTO ERROR1;

  12604   1 000349  0F81 00E1                            B        s:12687,PREL

      380    12605    5                          END;
      381    12606    4                     KN$NETPARM.LDCT$ = KNN$ROUTE.LINK$->KNN$LINK.LDCT$;

  12606   1 00034B  AC85                                 LDB,B2   ,B5
          1 00034C  ECC7 0004                            LDB,B6   @KN$NETPARM,AUTO
          1 00034E  AF86                                 STB,B2   ,B6

      382    12607    4                     CALL KNH$SEND(KN$NETPARM) ALTRET(ERROR1);

  12607   1 00034F  BBC7 0004                            LAB,B3   @KN$NETPARM,AUTO
          1 000351  CBF0 0100                            LAB,B4   256,IMO
          1 000353  E380 0000 0000  xent                 LNJ,B6   KNH$SEND
          1 000356       00D5                            DC       s:12687,PREL

      383    12608    4                     END;                  /*  if dest_node <                    */

  12608   1 000357  0F81 0006                            B        s:12613,PREL

      384    12609    4                ELSE DO;

      385    12610    4                     KN$NETPARM.ERRCODE = %KN_ERR_NORTE;

  12610   1 000359  1C03                                 LDV,R1   3
          1 00035A  9F46 0016                            STR,R1   22,B6

      386    12611    4                     GOTO ERROR1;

  12611   1 00035C  0F81 00CE                            B        s:12687,PREL

      387    12612    4                     END;                  /* else dest_node <                   */
      388    12613    3                RETURN;

  12613   1 00035E  C380 0000 0000  xent                 LNJ,B4   X6A_ARET
PL6.E3A0      #001=KNN$SEND File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:04 Page:54   

      389    12614    3                END;                       /* if dst_addr$ = addr(nil)           */
      390    12615    3           ELSE DO;         /* dst_addr$ ~= addr(nil) forward to knn$sendosi     */

      391    12616    3                QQQ$ = KN$NETPARM.LDCT$;

  12616   1 000361  DC86                                 LDB,B5   ,B6
          1 000362  DFC7 0033                            STB,B5   QQQ$,AUTO

      392    12617    3                SAVE_FPT$ = KN$NETPARM.FPT$;

  12617   1 000364  CCC6 0019                            LDB,B4   25,B6
          1 000366  CFC7 0035                            STB,B4   SAVE_FPT$,AUTO

      393    12618    3                KN$NETPARM.FPT$ = ADDR(NIL);

  12618   1 000368  BB80 0000 0000                       LAB,B3   0
          1 00036B  BFC6 0019                            STB,B3   25,B6

      394    12619
      395    12620    3                CALL KNN$SENDOSI(KN$NETPARM);
             12620                         /* may altret, drop the message regardless*/

  12620   1 00036D  BBC7 0004                            LAB,B3   @KN$NETPARM,AUTO
          1 00036F  CBF0 0100                            LAB,B4   256,IMO
          1 000371  E380 0000 0000  xent                 LNJ,B6   KNN$SENDOSI
          1 000374       0001                            DC       s:12621,PREL

      396    12621    3                KN$NETPARM.FPT$ = SAVE_FPT$;

  12621   1 000375  ECC7 0035                            LDB,B6   SAVE_FPT$,AUTO
          1 000377  DCC7 0004                            LDB,B5   @KN$NETPARM,AUTO
          1 000379  EFC5 0019                            STB,B6   25,B5

      397    12622    3                KN$NETPARM.LDCT$ = QQQ$;

  12622   1 00037B  CCC7 0033                            LDB,B4   QQQ$,AUTO
PL6.E3A0      #001=KNN$SEND File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:04 Page:55   
          1 00037D  CF85                                 STB,B4   ,B5

      398    12623    3                RETURN; /*  kn$netparm.errcode set in sendosi, drop the message  */

  12623   1 00037E  C380 0000 0000  xent                 LNJ,B4   X6A_ARET

      399    12624    3                END;
      400    12625    2           END;                            /* if function = k_ndata              */
      401    12626
      402    12627        %EJECT;
PL6.E3A0      #001=KNN$SEND File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:04 Page:56   
      403    12628        /*
      404    12629                data request for CP-6 QDP or CP-6 Class 4 transport
      405    12630        */
      406    12631    1      IF KN$NETPARM.FUNCTION ~= %KN_FCN_DATA

  12631   1 000381  6D05                                 CMV,R6   5
          1 000382  0901 000A                            BE       s:12639,PREL

      407    12632    1      THEN CALL SCREECH(BADFNC);

  12632   1 000384  BB80 0000 0000  02                   LAB,B3   0
          1 000387  CBF0 0100                            LAB,B4   256,IMO
          1 000389  E380 0000 0000  xent                 LNJ,B6   SCREECH
          1 00038C       0001                            DC       s:12639,PREL

      408    12633
      409    12634        /*S* SCREECH_CODE: KNN-S$BADFNC
      410    12635             TYPE: SCREECH
      411    12636             MESSAGE: Bad Function code passed to network.
      412    12637        */
      413    12638
      414    12639    1      SAVE_FPT$ = KN$NETPARM.FPT$;
             12639               /* dont send the fpt$ to knh$send, it confuses hdlc */

  12639   1 00038D  ECC7 0004                            LDB,B6   @KN$NETPARM,AUTO
          1 00038F  DCC6 0019                            LDB,B5   25,B6
          1 000391  DFC7 0035                            STB,B5   SAVE_FPT$,AUTO

      415    12640    1      KN$NETPARM.FPT$ = ADDR(NIL);

  12640   1 000393  CB80 0000 0000                       LAB,B4   0
          1 000396  CFC6 0019                            STB,B4   25,B6

      416    12641
      417    12642    1      IF KN$NETPARM.NODE > KNN_NODES

  12642   1 000398  E846 0015                            LDR,R6   21,B6
PL6.E3A0      #001=KNN$SEND File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:04 Page:57   
          1 00039A  6801 000F                            BLZ,R6   s:12651,PREL
          1 00039C  E900 0000 0000  xsym                 CMR,R6   KNN_NODES
          1 00039F  0381 000A                            BLE      s:12651,PREL

      418    12643    1      THEN CALL SCREECH(SNODES);

  12643   1 0003A1  BB80 0000 0002  02                   LAB,B3   +2
          1 0003A4  CBF0 0100                            LAB,B4   256,IMO
          1 0003A6  E380 0000 0000  xent                 LNJ,B6   SCREECH
          1 0003A9       0001                            DC       s:12651,PREL

      419    12644
      420    12645        /*S* SCREECH_CODE: KNN-S$BADNODE
      421    12646             TYPE: SCREECH
      422    12647             MESSAGE: Bad FEP Node parameter passed to KNN$SEND
      423    12648        */
      424    12649
      425    12650
      426    12651    1      DEST_NODE = KN$NETPARM.NODE;

  12651   1 0003AA  ECC7 0004                            LDB,B6   @KN$NETPARM,AUTO
          1 0003AC  E846 0015                            LDR,R6   21,B6
          1 0003AE  EF47 002A                            STR,R6   DEST_NODE,AUTO

      427    12652    1      ROUTE$ = KNN$ROUTE$(DEST_NODE);

  12652   1 0003B0  DC80 0000 0000  xsym                 LDB,B5   KNN_ROUTE$$
          1 0003B3  B856                                 LDR,R3   R6
          1 0003B4  CCB5                                 LDB,B4   ,B5,R3
          1 0003B5  CFC7 002B                            STB,B4   ROUTE$,AUTO

      428    12653    1      LINK$ = KNN$ROUTE.LINK$;

  12653   1 0003B7  BC84                                 LDB,B3   ,B4
          1 0003B8  BFC7 002D                            STB,B3   LINK$,AUTO

      429    12654
PL6.E3A0      #001=KNN$SEND File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:04 Page:58   
      430    12655    1      IF LINK$ = ADDR(NIL) OR KNN$LINK.LDCT$ = ADDR(NIL)

  12655   1 0003BA  8DC7 002D                            CMN      LINK$,AUTO
          1 0003BC  0901 0004                            BE       s:12657,PREL
          1 0003BE  8D83                                 CMN      ,B3
          1 0003BF  0981 0007                            BNE      s:12661,PREL

      431    12656    2      THEN DO;

      432    12657    2           KN$NETPARM.ERRCODE = %KN_ERR_NORTE;

  12657   1 0003C1  5C03                                 LDV,R5   3
          1 0003C2  DF46 0016                            STR,R5   22,B6

      433    12658    2           ALTRETURN;

  12658   1 0003C4  C380 0000 0000  xent                 LNJ,B4   X6A_AALT

      434    12659    2           END;
      435    12660
      436    12661    1      QQQ$ = KN$NETPARM.LDCT$;

  12661   1 0003C7  AC86                                 LDB,B2   ,B6
          1 0003C8  AFC7 0033                            STB,B2   QQQ$,AUTO

      437    12662
      438    12663    1      KN$NETPARM.NHDRSZ=LENGTHC(INIT_QDP_HDR);

  12663   1 0003CA  5C04                                 LDV,R5   4
          1 0003CB  DF46 0010                            STR,R5   16,B6

      439    12664    1      KN$NETPARM.NHDR$ = ADDR(QDP_HDR);

  12664   1 0003CD  9BC7 0006                            LAB,B1   QDP_HDR,AUTO
          1 0003CF  9FC6 000E                            STB,B1   14,B6

      440    12665
PL6.E3A0      #001=KNN$SEND File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:04 Page:59   
      441    12666    1      QDP_HDR = INIT_QDP_HDR;

  12666   1 0003D1  8C80 0000 0000  00                   LDI      INIT_QDP_HDR
          1 0003D4  8D47 0006                            SDI      QDP_HDR,AUTO

      442    12667
      443    12668    1      IF KN$NETPARM.LDCT$ ~= ADDR(NIL) AND KN$LDCT.CONN_TYPE = %KN_CNTYPE_QDP

  12668   1 0003D6  8D86                                 CMN      ,B6
          1 0003D7  0901 000C                            BE       s:12670,PREL
          1 0003D9  DC86                                 LDB,B5   ,B6
          1 0003DA  C285                                 LLH,R4   ,B5
          1 0003DB  4D05                                 CMV,R4   5
          1 0003DC  0981 0007                            BNE      s:12670,PREL

      444    12669    1      THEN QDP_HDR.MSGTYP = %K_MSGTYP_CP6_QDP#;

  12669   1 0003DE  A870 00FE                            LDR,R2   254,IMO
          1 0003E0  A7C7 0006                            STH,R2   QDP_HDR,AUTO
          1 0003E2  0F81 0005                            B        s:12672,PREL

      445    12670    1      ELSE QDP_HDR.MSGTYP = %K_MSGTYP_CP6_CL4#; /* ape, ssn, link                */

  12670   1 0003E4  C870 00FD                            LDR,R4   253,IMO
          1 0003E6  C7C7 0006                            STH,R4   QDP_HDR,AUTO

      446    12671
      447    12672    1      QDP_HDR.DEST_NODE = KN$NETPARM.NODE + 1;

  12672   1 0003E8  3E01                                 ADV,R3   1
          1 0003E9  B7C7 0007                            STH,R3   QDP_HDR+1,AUTO

      448    12673    1      QDP_HDR.SOURCE_NODE = KN_NODE# + 1;

  12673   1 0003EB  C800 0000 0000  xsym                 LDR,R4   KN_NODE#
          1 0003EE  4E01                                 ADV,R4   1
          1 0003EF  CAC7 0007                            SRM,R4,'00FF'X    QDP_HDR+1,AUTO
PL6.E3A0      #001=KNN$SEND File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:04 Page:60   
          1 0003F1       00FF

      449    12674
      450    12675    1      KN$NETPARM.LDCT$ = KNN$LINK.LDCT$;

  12675   1 0003F2  DC83                                 LDB,B5   ,B3
          1 0003F3  DF86                                 STB,B5   ,B6

      451    12676    1      CALL KNH$SEND (KN$NETPARM) ALTRET(ERROR1);

  12676   1 0003F4  BBC7 0004                            LAB,B3   @KN$NETPARM,AUTO
          1 0003F6  CBF0 0100                            LAB,B4   256,IMO
          1 0003F8  E380 0000 0000  xent                 LNJ,B6   KNH$SEND
          1 0003FB       0030                            DC       s:12687,PREL

      452    12677
      453    12678    1      KNN$LINK.MSGS_OUT = KNN$LINK.MSGS_OUT + 1;

  12678   1 0003FC  ECC7 002D                            LDB,B6   LINK$,AUTO
          1 0003FE  8AC6 0008                            INC      8,B6
          1 000400  8EC6 0007                            CAD      7,B6

      454    12679    1      LINK# = KN$LDCT.LINK_ID;

  12679   1 000402  DCC7 0004                            LDB,B5   @KN$NETPARM,AUTO
          1 000404  CC85                                 LDB,B4   ,B5
          1 000405  E844 0003                            LDR,R6   3,B4
          1 000407  EF47 0031                            STR,R6   LINK#,AUTO

      455    12680    1      KNN$ROUTE.LINK.MSGS_OUT(LINK#) = KNN$ROUTE.LINK.MSGS_OUT(LINK#) + 1;

  12680   1 000409  BCC7 002B                            LDB,B3   ROUTE$,AUTO
          1 00040B  B856                                 LDR,R3   R6
          1 00040C  3F0A                                 MLV,R3   10
          1 00040D  5C04                                 LDV,R5   4
          1 00040E  0021                                 ALR      ;
          1 00040F       4433 000B                                ALPHANUM(11,B3,R3,,4),;
PL6.E3A0      #001=KNN$SEND File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:04 Page:61   
          1 000411       4007 008E                                ALPHANUM(SNPATMPLT3+6,AUTO,,R5,FILL)
          1 000413  437F                                 CSYNC    s:12680+9,SPREL
          1 000414  8CC7 008E                            LDI      SNPATMPLT3+6,AUTO
          1 000416  8470 0000 0001                       AID      1,IMO
          1 000419  8D47 008C                            SDI      SNPATMPLT3+4,AUTO
          1 00041B  ABC7 008C                            LAB,B2   SNPATMPLT3+4,AUTO
          1 00041D  2C00                                 LDV,R2   0
          1 00041E  6C04                                 LDV,R6   4
          1 00041F  3E16                                 ADV,R3   22
          1 000420  0008                                 MMM

      456    12681
      457    12682    1      KN$NETPARM.LDCT$ = QQQ$;

  12682   1 000421  ECC7 0033                            LDB,B6   QQQ$,AUTO
          1 000423  EF85                                 STB,B6   ,B5

      458    12683    1      KN$NETPARM.FPT$ = SAVE_FPT$;

  12683   1 000424  CCC7 0035                            LDB,B4   SAVE_FPT$,AUTO
          1 000426  CFC5 0019                            STB,B4   25,B5

      459    12684    1      RETURN;

  12684   1 000428  C380 0000 0000  xent                 LNJ,B4   X6A_ARET

      460    12685
      461    12686    1   ERROR1:
      462    12687    1      KN$NETPARM.FPT$ = SAVE_FPT$;

  12687   1 00042B  ECC7 0035            ERROR1          LDB,B6   SAVE_FPT$,AUTO
          1 00042D  DCC7 0004                            LDB,B5   @KN$NETPARM,AUTO
          1 00042F  EFC5 0019                            STB,B6   25,B5

      463    12688    1      KN$NETPARM.LDCT$ = QQQ$;

  12688   1 000431  CCC7 0033                            LDB,B4   QQQ$,AUTO
PL6.E3A0      #001=KNN$SEND File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:04 Page:62   
          1 000433  CF85                                 STB,B4   ,B5

      464    12689    1      ALTRETURN;

  12689   1 000434  C380 0000 0000  xent                 LNJ,B4   X6A_AALT
      465    12690
      466    12691    1   END KNN$SEND;
      467    12692        %EOD;

PL6.E3A0      #001=KNN$SEND File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:04 Page:63   
--  Include file information  --

   KI_SUBS_C.:E05TOU  is referenced.
   KI_CP6.:E05TOU  is referenced.
   K_INTERFACE_M.:E05TOU  is referenced.
   KL_MACRO_C.:E05TOU  is referenced.
   K_ADDRESS_M.:E05TOU  is referenced.
   KJ_FCNS_C.:E05TOU  is referenced.
   K_QDPHDRS_M.:E05TOU  is referenced.
   KNN_NETWORK_M.:E05TOU  is referenced.
   KNH_MACRO_C.:E05TOU  is referenced.
   KN_DATA_M.:E05TOU  is referenced.
   GU_LCP6_M.:E05TOU  is referenced.
   K_SCODE_C.:E05TOU  is referenced.
      No diagnostics issued in procedure KNN$SEND.
PL6.E3A0      #001=KNN$SEND File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:04 Page:64   

 **** Variables and constants ****

  ****  Section 000 RoData KNN$SEND

  ****  Scalars and arrays  ****
HexLoc.c.b A Datatyp(siz) R M Lvl/name                 HexLoc.c.b A Datatyp(siz) R M Lvl/name

    57-0-0/w STRC(48)    r     1 BADFNC                    24-0-0/w STRC(720)   r     1 FPT_CONNECT_C
     0-0-0/w STRC(32)    r     1 INIT_QDP_HDR               2-0-0/w STRC(544)   r     1 OSI_INIT_C
    51-0-0/w STRC(48)    r     1 SNODES

  ****  Auto variables  ****

  ****  Scalars and arrays  ****
HexLoc.c.b A Datatyp(siz) R M Lvl/name                 HexLoc.c.b A Datatyp(siz) R M Lvl/name

     4-0-0/w PTR         r     1 @KN$NETPARM               32-0-0/w UBIN(16)    r     1 CHAN#
    2A-0-0/w UBIN(16)    r     1 DEST_NODE                 57-0-0/w STRC(720)   r     1 FPT_CONNECT
    37-0-0/w UBIN(16)    r     1 I                         38-0-0/w UBIN(16)    r     1 J
    *0-0-0/w STRC(528)   r     1 KN$NETPARM                31-0-0/w UBIN(16)    r     1 LINK#
    2D-0-0/w PTR         r     1 LINK$                      8-0-0/w STRC(544)   r     1 OSI_INIT
     6-0-0/w STRC(32)    r     1 QDP_HDR                   33-0-0/w PTR         r     1 QQQ$
    39-0-0/w STRC(480)   r     1 ROUTE                     2B-0-0/w PTR         r     1 ROUTE$
    35-0-0/w PTR         r     1 SAVE_FPT$                 84-0-0/w CHAR(8)     r     1 SNPATMPLT1
    84-0-0/w STRC(56)    r     1 SNPATMPLT2                88-0-0/w CHAR(8)     r     1 SNPATMPLT3
    88-0-0/w STRC(56)    r     1 SNPATMPLT4                2F-0-0/w PTR         r     1 TLINK$

  ****  SYMREF variables  ****

  ****  Scalars and arrays  ****
HexLoc.c.b A Datatyp(siz) R M Lvl/name                 HexLoc.c.b A Datatyp(siz) R M Lvl/name

     0-0-0/w PTR         r     1 KNN_LINK$$                 0-0-0/w UBIN(16)    r     1 KNN_LINKS
     0-0-0/w UBIN(16)    r     1 KNN_NODES                  0-0-0/w PTR         r     1 KNN_ROUTE$$
     0-0-0/w UBIN(16)    r     1 KN_NODE#

  ****  BASED and DCB variables  ****
PL6.E3A0      #001=KNN$SEND File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:04 Page:65   

  ****  Scalars and arrays  ****
HexLoc.c.b A Datatyp(siz) R M Lvl/name                 HexLoc.c.b A Datatyp(siz) R M Lvl/name

     0-0-0/c STRC(176)   r     1 DST                        0-0-0/w STRC(256)   r     1 KN$LDCT
     0-0-0/c STRC(608)   r     1 KNN$LINK
     0-0-0/w PTR         r     1 KNN$LINK$(0:0)
     0-0-0/w STRC(208)   r     1 KNN$ROUTE
     0-0-0/w PTR         r     1 KNN$ROUTE$(0:0)
     0-0-0/c STRC(176)   r     1 SRC


   Procedure KNN$SEND requires 1079 words for executable code.
   Procedure KNN$SEND requires 144 words of local(AUTO) storage.
PL6.E3A0      #001=KNN$SEND File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:04 Page:66   
          *** CROSS REFERENCE LISTING ***
**     DENOTES     IDENTIFIER DEFINITION
<<                 IDENTIFIER'S VALUE SET
>>                 IDENTIFIER'S VALUE USED
<>                 IDENTIFIER SET AND/OR USED
--                 IDENTIFIER REFERENCED
PL6.E3A0      #001=KNN$SEND File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:04 Page:67   
          MINI XREF LISTING

BADFNC
     11599**DCL     12632<>CALL
CHAN#
     10447**DCL     12446<<ASSIGN  12449>>IF
DEST_NODE
     10442**DCL     12493<<ASSIGN  12494>>ASSIGN  12514>>ASSIGN  12542<<ASSIGN  12552>>IF      12553>>ASSIGN
     12589<<ASSIGN  12597>>IF      12598>>ASSIGN  12651<<ASSIGN  12652>>ASSIGN
DST
     12230**DCL     12377<>CALL    12469>>ASSIGN  12474>>ASSIGN  12516>>ASSIGN  12544>>ASSIGN
DST.ADDRESS_N
     12262**DCL     12263--REDEF
ERROR1
     12687**LABEL   12522--CALLALT 12559--GOTO    12562--CALLALT 12566--GOTO    12604--GOTO    12607--CALLALT
     12611--GOTO    12676--CALLALT
FOUNDROUTE
     12452**LABEL   12439--GOTO    12456--GOTO
FPT_CONNECT
     10675**DCL     12464<<ASSIGN  12486--ASSIGN
FPT_CONNECT.CLASS
     10715**DCL     12465<<ASSIGN
FPT_CONNECT.DEST
     10742**DCL     12469<<ASSIGN
FPT_CONNECT.DEST.ADDRESS_N
     10772**DCL     10773--REDEF
FPT_CONNECT.DSTSNPA
     10828**DCL     12471<<ASSIGN  12474<<ASSIGN
FPT_CONNECT.DSTSNPA.ADR_STRING
     10828**DCL     10828--REDEF
FPT_CONNECT.DSTSNPA.LNG
     10828**DCL     12475<<ASSIGN  12475>>ASSIGN
FPT_CONNECT.LADR
     10794**DCL     12470<<ASSIGN
PL6.E3A0      #001=KNN$SEND File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:04 Page:68   
FPT_CONNECT.LADR.ADDRESS_N
     10824**DCL     10825--REDEF
FPT_CONNECT.RESOURCE
     10681**DCL     12478<<ASSIGN
FPT_CONNECT.RLCID.GENERATION
     10711**DCL     10712--REDEF
FPT_CONNECT.RLCID.LDCTX
     10712**DCL     10712--REDEF
FPT_CONNECT.TERMINAL_ID.TERM
     10700**DCL     10709--REDEF
FPT_CONNECT.TR_FLAGS
     10716**DCL     12466<<ASSIGN
FPT_CONNECT_C
     11288**DCL     12464>>ASSIGN
FPT_CONNECT_C.DEST.ADDRESS_N
     11385**DCL     11386--REDEF
FPT_CONNECT_C.DSTSNPA.ADR_STRING
     11441**DCL     11441--REDEF
FPT_CONNECT_C.LADR.ADDRESS_N
     11437**DCL     11438--REDEF
FPT_CONNECT_C.RLCID.GENERATION
     11324**DCL     11325--REDEF
FPT_CONNECT_C.RLCID.LDCTX
     11325**DCL     11325--REDEF
FPT_CONNECT_C.TERMINAL_ID.TERM
     11313**DCL     11322--REDEF
I
     10450**DCL     12434<<DOINDEX 12435>>IF      12435>>IF      12447<<DOINDEX 12448>>ASSIGN
INIT_QDP_HDR
     10872**DCL     12587>>ASSIGN  12663--ASSIGN  12666>>ASSIGN
J
     10451**DCL     12426<<DOINDEX 12427>>ASSIGN
KN$LDCT.CONN_TYPE
     11985**DCL     12415<<ASSIGN  12668>>IF
KN$LDCT.LINK_ID
     12087**DCL     12401>>ASSIGN  12525>>ASSIGN  12679>>ASSIGN
PL6.E3A0      #001=KNN$SEND File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:04 Page:69   
KN$LDCT.RLCID.LDCTX
     12045**DCL     12052--REDEF   12060--REDEF
KN$LDCT.STATE
     11999**DCL     12416<<ASSIGN
KN$LDCT.TRANSPORT_ID
     12079**DCL     12087--REDEF
KN$LDCT.UID
     12109**DCL     12110--REDEF   12119--REDEF   12462<<ASSIGN  12462>>ASSIGN
KN$LDCT.USER#
     12202**DCL     12463<<ASSIGN  12463>>ASSIGN
KN$LDCT.USER_ENTRY$
     12190**DCL     12417<<ASSIGN
KN$NETPARM
      9878**DCL        10--PROC    12487<>CALL    12522<>CALL    12562<>CALL    12607<>CALL    12620<>CALL
     12676<>CALL
KN$NETPARM.DST_ADDR$
     10012**DCL     12230--IMP-PTR 12377>>CALL    12469>>ASSIGN  12474>>ASSIGN  12516>>ASSIGN  12544>>ASSIGN
     12583>>IF
KN$NETPARM.ERRCODE
      9985**DCL     12378<<ASSIGN  12382<<ASSIGN  12391<<ASSIGN  12398<<ASSIGN  12412<<ASSIGN  12453<<ASSIGN
     12501<<ASSIGN  12506<<ASSIGN  12558<<ASSIGN  12565<<ASSIGN  12603<<ASSIGN  12610<<ASSIGN  12657<<ASSIGN
KN$NETPARM.FLAGS.CONS
      9955**DCL     12375>>IF      12484>>IF
KN$NETPARM.FPT$
      9997**DCL     12486<<ASSIGN  12520>>ASSIGN  12521<<ASSIGN  12529<<ASSIGN  12550>>ASSIGN  12551<<ASSIGN
     12595>>ASSIGN  12596<<ASSIGN  12617>>ASSIGN  12618<<ASSIGN  12621<<ASSIGN  12639>>ASSIGN  12640<<ASSIGN
     12683<<ASSIGN  12687<<ASSIGN
KN$NETPARM.FUNCTION
      9973**DCL     12375>>IF      12477<<ASSIGN  12512<<ASSIGN  12538>>IF      12539<<ASSIGN  12572>>IF
     12631>>IF
KN$NETPARM.LDCT$
      9879**DCL     11984--IMP-PTR 12392<>CALL    12410>>IF      12411<>CALL    12415>>ASSIGN  12416>>ASSIGN
     12417>>ASSIGN  12450>>ASSIGN  12452<>CALL    12462>>ASSIGN  12463>>ASSIGN  12510>>ASSIGN  12511<<ASSIGN
     12525>>ASSIGN  12528<<ASSIGN  12549>>ASSIGN  12561<<ASSIGN  12594>>ASSIGN  12606<<ASSIGN  12616>>ASSIGN
     12622<<ASSIGN  12661>>ASSIGN  12668>>IF      12668>>IF      12675<<ASSIGN  12679>>ASSIGN  12682<<ASSIGN
     12688<<ASSIGN
PL6.E3A0      #001=KNN$SEND File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:04 Page:70   
KN$NETPARM.MSG$
      9885**DCL      9890--REDEF
KN$NETPARM.MSGSZ
      9896**DCL     12485<<ASSIGN
KN$NETPARM.NHDR$
      9937**DCL      9938--REDEF   12518<<ASSIGN  12547<<ASSIGN  12592<<ASSIGN  12664<<ASSIGN
KN$NETPARM.NHDRSZ
      9943**DCL     12483<<ASSIGN  12519<<ASSIGN  12548<<ASSIGN  12593<<ASSIGN  12663<<ASSIGN
KN$NETPARM.NODE
      9980**DCL     12541>>ASSIGN  12542>>ASSIGN  12588>>ASSIGN  12589>>ASSIGN  12642>>IF      12651>>ASSIGN
     12672>>ASSIGN
KN$NETPARM.RECTYPE
      9964**DCL     12371<<ASSIGN  12479<<ASSIGN
KN$NETPARM.SHDR$
      9915**DCL      9916--REDEF
KN$NETPARM.SHDRSZ
      9921**DCL     12482<<ASSIGN
KN$NETPARM.SRC_ADDR$
     10007**DCL     12282--IMP-PTR 12470>>ASSIGN  12517>>ASSIGN  12545>>ASSIGN
KN$NETPARM.THDR$
      9926**DCL      9927--REDEF
KN$NETPARM.THDRSZ
      9932**DCL     12480<<ASSIGN
KN$NETPARM.UHDR$
      9901**DCL      9902--REDEF
KN$NETPARM.UHDRSZ
      9910**DCL     12481<<ASSIGN  12546<<ASSIGN  12591<<ASSIGN
KNA$GETLDCT
     11638**DCL-ENT 12411--CALL
KNA$RLSLDCT
     11637**DCL-ENT 12392--CALL    12452--CALL
KNH$SEND
     11635**DCL-ENT 12487--CALL    12522--CALL    12562--CALL    12607--CALL    12676--CALL
KNN$DECODE_NSAP
     11636**DCL-ENT 12377--CALL
KNN$LINK.CHAN#
PL6.E3A0      #001=KNN$SEND File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:04 Page:71   
     11953**DCL     12446>>ASSIGN  12449>>IF
KNN$LINK.DEST.ADDRESS_N
     11906**DCL     11907--REDEF
KNN$LINK.FLAGS.VIRCIR
     11764**DCL     12428>>IF      12449>>IF
KNN$LINK.LADR.ADDRESS_N
     11849**DCL     11850--REDEF
KNN$LINK.LDCT$
     11720**DCL     11727--REDEF   12397>>IF      12401>>ASSIGN  12428>>IF      12451>>IF      12462>>ASSIGN
     12463>>ASSIGN  12504>>IF      12511>>ASSIGN  12554>>IF      12561>>ASSIGN  12599>>IF      12606>>ASSIGN
     12655>>IF      12675>>ASSIGN
KNN$LINK.MSGS_OUT
     11795**DCL     12524<<ASSIGN  12524>>ASSIGN  12678<<ASSIGN  12678>>ASSIGN
KNN$LINK.NODE#
     11735**DCL     12428>>IF
KNN$LINK.QOS
     11779**DCL     12397>>IF
KNN$LINK.SNPA.ADDRESS
     11942**DCL     12433>>ASSIGN
KNN$LINK.SNPA.LEN
     11937**DCL     12434>>DOINDEX
KNN$LINK$
     11645**DCL     12427>>ASSIGN  12448>>ASSIGN
KNN$RECV
     11639**DCL-ENT 12417--ASSIGN
KNN$ROUTE.CURRENT_QOS
     11665**DCL     12389>>IF      12495>>IF
KNN$ROUTE.FLAGS.HOST_NODE
     11675**DCL     12495>>IF      12554>>IF      12599>>IF
KNN$ROUTE.FLAGS.LINK_CONNECTED
     11679**DCL     12495>>IF      12554>>IF      12599>>IF
KNN$ROUTE.LINK.MSGS_OUT
     11712**DCL     12526<<ASSIGN  12526>>ASSIGN  12680<<ASSIGN  12680>>ASSIGN
KNN$ROUTE.LINK$
     11648**DCL     12389>>IF      12396>>ASSIGN  12504>>IF      12504>>IF      12511>>ASSIGN  12524>>ASSIGN
     12524>>ASSIGN  12554>>IF      12554>>IF      12561>>ASSIGN  12599>>IF      12599>>IF      12606>>ASSIGN
PL6.E3A0      #001=KNN$SEND File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:04 Page:72   
     12653>>ASSIGN
KNN$ROUTE$
     11644**DCL     12389>>IF      12389>>IF      12396>>ASSIGN  12494>>ASSIGN  12553>>ASSIGN  12598>>ASSIGN
     12652>>ASSIGN
KNN$SENDOSI
     11641**DCL-ENT 12620--CALL
KNN_LINK$$
     10846**DCL     11645--IMP-PTR 12427>>ASSIGN  12448>>ASSIGN
KNN_LINKS
     10847**DCL     12426>>DOINDEX 12447>>DOINDEX
KNN_NODES
     10845**DCL     12381>>IF      12552>>IF      12597>>IF      12642>>IF
KNN_ROUTE$$
     10844**DCL     11644--IMP-PTR 12389>>IF      12389>>IF      12396>>ASSIGN  12494>>ASSIGN  12553>>ASSIGN
     12598>>ASSIGN  12652>>ASSIGN
KN_NODE#
     10843**DCL     12387>>IF      12422>>IF      12515>>ASSIGN  12543>>ASSIGN  12590>>ASSIGN  12673>>ASSIGN
LINK#
     10446**DCL     12401<<ASSIGN  12525<<ASSIGN  12526>>ASSIGN  12526>>ASSIGN  12679<<ASSIGN  12680>>ASSIGN
     12680>>ASSIGN
LINK$
     10444**DCL     11719--IMP-PTR 12396<<ASSIGN  12397>>IF      12397>>IF      12401>>ASSIGN  12427<<ASSIGN
     12428>>IF      12428>>IF      12428>>IF      12433>>ASSIGN  12434>>DOINDEX 12438>>ASSIGN  12446>>ASSIGN
     12653<<ASSIGN  12655>>IF      12655>>IF      12675>>ASSIGN  12678>>ASSIGN  12678>>ASSIGN
NOROUTE
     12452**LABEL   12443--GOTO    12459--GOTO    12488--GOTO
NXTJ2
     12434**LABEL   12436--GOTO
OSI_INIT
     10118**DCL     12513<<ASSIGN  12518--ASSIGN  12519--ASSIGN  12540<<ASSIGN  12547--ASSIGN  12548--ASSIGN
OSI_INIT.DEST_NODE
     10139**DCL     12514<<ASSIGN  12541<<ASSIGN
OSI_INIT.DST_NSAP
     10170**DCL     12516<<ASSIGN  12544<<ASSIGN
OSI_INIT.DST_NSAP.ADDRESS
     10179**DCL     10180--REDEF
PL6.E3A0      #001=KNN$SEND File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:04 Page:73   
OSI_INIT.SOURCE_NODE
     10147**DCL     12515<<ASSIGN  12543<<ASSIGN
OSI_INIT.SRC_NSAP
     10228**DCL     12517<<ASSIGN  12545<<ASSIGN
OSI_INIT.SRC_NSAP.ADDRESS
     10237**DCL     10238--REDEF
OSI_INIT.TR_OPTIONS.TPDUSIZE
     10294**DCL     10295--REDEF
OSI_INIT_C
     10949**DCL     12513>>ASSIGN  12540>>ASSIGN
OSI_INIT_C.DST_NSAP.ADDRESS
     11010**DCL     11011--REDEF
OSI_INIT_C.SRC_NSAP.ADDRESS
     11068**DCL     11069--REDEF
OSI_INIT_C.TR_OPTIONS.TPDUSIZE
     11125**DCL     11126--REDEF
QDP_HDR
     10041**DCL     12587<<ASSIGN  12592--ASSIGN  12593--ASSIGN  12664--ASSIGN  12666<<ASSIGN
QDP_HDR.DEST_NODE
     10062**DCL     12588<<ASSIGN  12672<<ASSIGN
QDP_HDR.MSGTYP
     10042**DCL     12669<<ASSIGN  12670<<ASSIGN
QDP_HDR.SOURCE_NODE
     10068**DCL     12590<<ASSIGN  12673<<ASSIGN
QQQ$
     10448**DCL     12450<<ASSIGN  12510<<ASSIGN  12528>>ASSIGN  12549<<ASSIGN  12594<<ASSIGN  12616<<ASSIGN
     12622>>ASSIGN  12661<<ASSIGN  12682>>ASSIGN  12688>>ASSIGN
ROUTE
     10469**DCL     12377<>CALL
ROUTE.FEP#
     10509**DCL     12381>>IF      12387>>IF      12389>>IF      12389>>IF      12396>>ASSIGN  12422>>IF
ROUTE.HOST#
     10506**DCL     12493>>ASSIGN
ROUTE.LNSAP.ADDRESS_N
     10623**DCL     10624--REDEF
ROUTE.MYNODE#
PL6.E3A0      #001=KNN$SEND File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:04 Page:74   
     10504**DCL     10506--REDEF
ROUTE.NODE#
     10507**DCL     10509--REDEF
ROUTE.NSAP.ADDRESS_N
     10567**DCL     10568--REDEF
ROUTE.NW_TYPE
     10498**DCL     12467>>IF
ROUTE.QOS
     10512**DCL     12381>>IF
ROUTE.SNPA
     10647**DCL     12471>>ASSIGN
ROUTE.SNPA.ADDRESS
     10654**DCL     12432>>ASSIGN
ROUTE.SNPA.LEN
     10649**DCL     12434>>DOINDEX
ROUTE$
     10443**DCL     11647--IMP-PTR 12494<<ASSIGN  12495>>IF      12495>>IF      12495>>IF      12504>>IF
     12504>>IF      12511>>ASSIGN  12524>>ASSIGN  12524>>ASSIGN  12526>>ASSIGN  12526>>ASSIGN  12553<<ASSIGN
     12554>>IF      12554>>IF      12554>>IF      12554>>IF      12561>>ASSIGN  12598<<ASSIGN  12599>>IF
     12599>>IF      12599>>IF      12599>>IF      12606>>ASSIGN  12652<<ASSIGN  12653>>ASSIGN  12680>>ASSIGN
     12680>>ASSIGN
SAVE_FPT$
     10449**DCL     12520<<ASSIGN  12529>>ASSIGN  12550<<ASSIGN  12595<<ASSIGN  12617<<ASSIGN  12621>>ASSIGN
     12639<<ASSIGN  12683>>ASSIGN  12687>>ASSIGN
SCREECH
     11640**DCL-ENT 12632--CALL    12643--CALL
SNODES
     11473**DCL     12643<>CALL
SNPATMPLT1
     10832**DCL     10833--REDEF   12432<<ASSIGN
SNPATMPLT2.NIBBLES.NIB
     10835**DCL     12435>>IF
SNPATMPLT3
     10837**DCL     10838--REDEF   12433<<ASSIGN
SNPATMPLT4.NIBBLES.NIB
     10840**DCL     12435>>IF
PL6.E3A0      #001=KNN$SEND File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:04 Page:75   
SRC
     12282**DCL     12470>>ASSIGN  12517>>ASSIGN  12545>>ASSIGN
SRC.ADDRESS_N
     12314**DCL     12315--REDEF
TLINK$
     10445**DCL     12438<<ASSIGN  12448<<ASSIGN  12449>>IF      12449>>IF      12451>>IF      12462>>ASSIGN
     12463>>ASSIGN

PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:76   
      468        1        /*T***********************************************************/
      469        2        /*T*                                                         */
      470        3        /*T* Copyright (c) Bull HN Information Systems Inc., 1997    */
      471        4        /*T*                                                         */
      472        5        /*T***********************************************************/
      473        6
      474        7        /*X* PLM=3,IND=5,ECU=0,ENU=0   */
      475        8
      476        9        KNN$RECV: PROC (KN$NETPARM) ALTRET;
      477       10
      478       11        %INCLUDE GH_GATE_M;
      479       52        %INCLUDE KI_CP6;
      480     1148        %INCLUDE KI_SUBS_C;
      481     1284        %INCLUDE K_SCODE_C;
      482     1369        %INCLUDE K_REASON_C;
      483     1395        %INCLUDE GU_LCP6_M;
      484     2323        %INCLUDE KN_DATA_M;
      485     4109        %INCLUDE KNH_MACRO_C;
      486     4392        %INCLUDE KNN_NETWORK_M;
      487     4755        %INCLUDE K_QDPHDRS_M;
      488     5637        %INCLUDE KJ_FCNS_C;
      489     5664        %INCLUDE KL_AFCN_C;
      490     5765        %INCLUDE KL_MACRO_C;
      491     9117        %INCLUDE K_ADDRESS_M;                   /* osi address macros                 */
      492     9620        %INCLUDE K_NETWORK_E;                   /* osi network equates                */
      493     9709        %INCLUDE K_INTERFACE_M;
      494    10118
      495    10119                                                /* Parameters                         */
      496    10120        %KN$NETPARM (NAME=KN$NETPARM);
      497    10273
      498    10274                                                /* Auto                               */
      499    10275        %KL_FEPST (FPTN=FEPST,STCLASS=AUTO);
      500    10310    1   DCL DEST_NODE UBIN;
      501    10311    1   DCL ROUTE$ PTR;
      502    10312    1   DCL LINK$ PTR;
      503    10313    1   DCL LINK# UBIN;
      504    10314    1   DCL LINKIN# UBIN;
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:77   
      505    10315    1   DCL CLNK# SBIN;               /* current link# on block and unblock functions*/
      506    10316    1   DCL CQOS UBIN;           /* current qos value on block and unblock functions*/
      507    10317    1   DCL QOS UBIN;
      508    10318    1   DCL I UBIN;
      509    10319    1   DCL J UBIN;
      510    10320    1   DCL L SBIN;
      511    10321    1   DCL K SBIN;
      512    10322    1   DCL LEN SBIN;
      513    10323    1   DCL SIZE UBIN;
      514    10324    1   DCL UPDOSI$ PTR;
      515    10325    1   DCL OSI$ PTR;
      516    10326    1   DCL OSIROUTE$ PTR;
      517    10327    1   DCL QQQ$ PTR AUTO;
      518    10328    1   DCL FUNCTION UBIN;
      519    10329    1   DCL SOURCE_NODE UBIN;
      520    10330    1   DCL NWHDR_SZ UBIN;
      521    10331    1   DCL OSILINK# UBIN;
      522    10332    1   DCL OSIADDR# UBIN;
      523    10333    1   DCL FOUNDONE BIT(1);
      524    10334    1   DCL SNPATMPLT1 CHAR(8) ALIGNED;
      525    10335    1   DCL 1 SNPATMPLT2 REDEF SNPATMPLT1 ALIGNED,
      526    10336    1         2 NIBBLES(0:13) UNAL,
      527    10337    1           3 NIB UBIN(4) UNAL;
      528    10338
      529    10339    1   DCL SNPATMPLT3 CHAR(8) ALIGNED;
      530    10340    1   DCL 1 SNPATMPLT4 REDEF SNPATMPLT3 ALIGNED,
      531    10341    1         2 NIBBLES(0:13) UNAL,
      532    10342    1           3 NIB UBIN(4) UNAL;
      533    10343        %KL_UPDOSI(FPTN=UPDOSI,ADRTYP=NET,STCLASS=AUTO); /* the biggest one           */
      534    10552        %KL_UPDOSI(FPTN=ROUTE,ADRTYP=NET,STCLASS="REDEF UPDOSI");
      535    10761        %KL_OSILINKCHG(FPTN=OSILINKCHG,STCLASS=AUTO);
      536    10884        %K$SNPA(FPTN=SNPA,STCLASS=AUTO);
      537    10914        %FPT_CONNECT_ACK(FPTN=FPT@ACK,STCLASS=AUTO);
      538    10963        %KN$NETPARM(NAME=KN@NETPARM,STCLASS=AUTO); /*for local use                    */
      539    11116
      540    11117                                                /* External Data                      */
      541    11118    1   DCL KN_NODE# UBIN SYMREF;
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:78   
      542    11119    1   DCL KNN_ROUTE$$ PTR SYMREF;
      543    11120    1   DCL KNN_LINK$$ PTR SYMREF;
      544    11121    1   DCL KNN_NODES UBIN SYMREF;
      545    11122    1   DCL KNN_LINKS UBIN SYMREF;
      546    11123    1   DCL KNN_OSIROUTE$$ PTR SYMREF;
      547    11124    1   DCL KNN_OSIROUTE# UBIN SYMREF;
      548    11125    1   DCL KNN_OSIMAX# UBIN SYMREF;
      549    11126        %GATE (FPTN=KNN_LOCK, STCLASS=SYMREF);
      550    11145        %KN$NETPARM (NAME=KN_NETPARM_INIT, STCLASS=SYMREF);
      551    11298
      552    11299                                                /* Internal Data                      */
      553    11300
      554    11301        %VLP_SCODE (FPTN=PRTCLERR,ERR#=%S$PRTCLERR,SEV=G_SEV_SCREECH#,
      555    11302                       STCLASS=CONSTANT,FCG=KN,MID=N,MON='1'B);
      556    11363
      557    11364        %VLP_SCODE (FPTN=BADFNC,ERR#=%S$BADFNC,SEV=G_SEV_SCREECH#,
      558    11365                       STCLASS=CONSTANT,FCG=KN,MID=N,MON='1'B);
      559    11426
      560    11427        %FPT_CONNECT_ACK (FPTN=FPT_ACK, STCLASS=CONSTANT);
      561    11476        %FPT_CONNECT_ACK (FPTN=FPT_NAK, STCLASS=CONSTANT, REASON=%K_REASON_NOLDCT);
      562    11525        %FPT_TERM_ACK(FPTN=FPT@TERM_ACK,STCLASS=CONSTANT);
      563    11547
      564    11548    1   DCL KN_SCREECH_HOPCOUNT UBIN CONSTANT SYMDEF INIT(0);
      565    11549    1   DCL KN_SCREECH UBIN CONSTANT SYMDEF INIT(0); /* if set screech on error flag  */
      566    11550
      567    11551
      568    11552                                                /* Entry references                   */
      569    11553    1   DCL KNS$RECV ENTRY(1) ALTRET;
      570    11554    1   DCL KNT$RECV ENTRY(1) ALTRET;
      571    11555    1   DCL KNH$SEND ENTRY(1) ALTRET;
      572    11556    1   DCL KNB$WRITE ENTRY(4) ALTRET;
      573    11557    1   DCL SCREECH ENTRY(1);
      574    11558    1   DCL KNT$RECV_4HOST ENTRY(1) ALTRET;
      575    11559    1   DCL KNT$SEND_4HOST ENTRY(1) ALTRET;
      576    11560    1   DCL KNN$DECODE_NSAP ENTRY(2) ALTRET;
      577    11561    1   DCL KNN$RECVOSI ENTRY(1) ALTRET;
      578    11562    1   DCL KNN$SENDOSI ENTRY(1) ALTRET;
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:79   
      579    11563    1   DCL KNN$SENDTERM_ACK ENTRY(1);
      580    11564
      581    11565
      582    11566                                                /* Based structures                   */
      583    11567    1   DCL KNN$ROUTE$(0:0) PTR BASED(KNN_ROUTE$$);
      584    11568    1   DCL KNN$LINK$(0:0) PTR BASED(KNN_LINK$$);
      585    11569        %KNN$ROUTE (STCLASS="BASED(ROUTE$)");
      586    11641        %KNN$LINK (STCLASS="BASED(LINK$)");
      587    11892        %KN$LDCT (STCLASS="BASED(KN$NETPARM.LDCT$)");
      588    12137        %KL_NODECHG (FPTN=KL$NODECHG,STCLASS="BASED(KN$NETPARM.FPT$)");
      589    12161        %K$NQDP_HDR (NAME=B$QDP_HDR, STCLASS="BASED(KN$NETPARM.NHDR$)");
      590    12238        %K$NQDP_HDR(NAME=B$OSI_HDR,STCLASS="BASED(KN$NETPARM.NHDR$)",MSGTYPE=OSI_INIT);
      591    12583        %FPT_CONNECT (ADRTYP=NET,STCLASS="BASED(KN$NETPARM.FPT$)");
      592    12754        %FPT_CONNECT (FPTN=FPT$CONNECT,ADRTYP=NONE,STCLASS="BASED(KN$NETPARM.FPT$)");
      593    12823        %FPT_CONNECT_ACK(STCLASS="BASED(KN$NETPARM.FPT$)");
      594    12872        %K$NSAP(FPTN=SRC,ADRTYP=NET,STCLASS="BASED(KN$NETPARM.SRC_ADDR$)");
      595    12924        %K$NSAP(FPTN=DST,ADRTYP=NET,STCLASS="BASED(KN$NETPARM.DST_ADDR$)");
             12924            /* network entity title is the largest type of nsap*/
      596    12976    1   DCL ADDRESS CHAR(SIZE) BASED ALIGNED;
      597    12977        %KNH@UID(FPTN=KNH$UID,STCLASS=BASED);
      598    13004    1   DCL KNN$OSIROUTE$(0:0) PTR BASED(KNN_OSIROUTE$$);
      599    13005        %KNN$OSIROUTE(STCLASS="BASED(OSI$)");
      600    13222        %KL_UPDOSI(FPTN=KL$UPDOSI,ADRTYP=NET,STCLASS="BASED(KN$NETPARM.FPT$)");
      601    13431        %KL_OSILINKCHG(FPTN=KL$OSILINKCHG,STCLASS="BASED(KN$NETPARM.FPT$)");
      602    13554
      603    13555    1   DCL 1 ADDRTMPLT ALIGNED BASED(UPDOSI$),
      604    13556    1         2 BYT(0:50),
      605    13557    1           3 HIGH BIT(4) UNAL,
      606    13558    1           3 LOW  BIT(4) UNAL;
      607    13559
      608    13560    1   DCL 1 ADDRTMPLT1 ALIGNED BASED(OSIROUTE$),
      609    13561    1         2 BYT(0:50),
      610    13562    1           3 HIGH BIT(4) UNAL,
      611    13563    1           3 LOW BIT(4)  UNAL;
      612    13564        %EJECT;
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:80   
      613    13565
      614    13566
      615    13567        /*F* NAME: KNN$RECV Inbound Messages
      616    13568
      617    13569        KNN$RECV is called from KNH$SCAN.  It is used to pass
      618    13570        incoming messages on up through the transport and session
      619    13571        layers.
      620    13572
      621    13573        KNN$RECV is called from KNH$SCAN with the following parameters:
      622    13574
      623    13575        .fif
      624    13576        } KN$NETPARM.FUNCTION
      625    13577        }                - The function to be performed.  This will be one of the
      626    13578        }                  folowing EQUed values from the file KNH_MACRO_M:
      627    13579        }                      KN_FCN_INIT
      628    13580        }                      KN_FCN_INIT_ACK
      629    13581        }                      KN_FCN_DATA
      630    13582        }                      KN_FCN_TERM
      631    13583        }                      KN_FCN_UNQ
      632    13584        }                      KN_FCN_BLOCK
      633    13585        }                      KN_FCN_UNBLOCK
      634    13586        }
      635    13587        } KN$NETPARM.RECTYPE - contains ????
      636    13588        }
      637    13589        } KN$NETPARM.LDCT$ - contains the LDCT of the destination end-point.
      638    13590        }                    This has been initialized using KNH$MESS.LDCTX.
      639    13591        }
      640    13592        } KN$NETPARM.NHDR$ - and .NHDRSZ frame the entire message,
      641    13593        }                  including the headers for the various layers.
      642    13594        }
      643    13595        } KN$NETPARM.FPT$ - Contains the address of FPT_CONNECT
      644    13596        }                 - Only used when FUNCTION is INIT.  The format
      645    13597        }                   of the FPT is described by the FPT_CONNECT macro.
      646    13598        }
      647    13599        .fin
      648    13600        The action taken by KNN$RECV is dependent on the value of FUNCTION.
      649    13601        */
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:81   
      650    13602
      651    13603
      652    13604    1      FUNCTION = KN$NETPARM.FUNCTION;
      653    13605    1      IF FUNCTION = %KN_FCN_DATA
      654    13606    1      THEN GOTO RECEIVE_DATA;              /*fast path*/
      655    13607
      656    13608    1      IF FUNCTION > %KN_FCN_MAX
      657    13609    1      THEN CALL SCREECH(BADFNC);
      658    13610
      659    13611    2      DO CASE (FUNCTION);
      660    13612
      661    13613        /*F* NAME: KNN$RECV - Initiate Connection
      662    13614
      663    13615        KNN$RECV is called from KNH$SCAN with the function set to
      664    13616        INIT when the scanning has found an INIT message
      665    13617        and the FPT_CONNECT in the message has .TYPE set to LINK.
      666    13618
      667    13619        The number of the connecting node is in FPT_CONNECT.RLCID.NODE.
      668    13620
      669    13621        KNN$RECV finds an unused entry in the KNN$LINK table and stores
      670    13622        the address of the LINK type LDCT in KNN$LINK.LDCT$.
      671    13623        The index to the Link Table entry is remembered in LDCT.LINK_ID.
      672    13624
      673    13625        The node number in KNN$LINK is initialized from the value supplied
      674    13626        in FPT_CONNECT.RLCID.NODE.
      675    13627
      676    13628        The "connected" bit in the KNN$ROUTE table entry for the connecting
      677    13629        node is turned on.  The HOST_NODE bit is turned on in both the Link
      678    13630        Table Entry and the Route Table entry if it is set in the FPT.
      679    13631
      680    13632        *** internal call to link_active - lets nodeadmn know.
      681    13633        *** internal call to update_route
      682    13634
      683    13635        An INIT_ACK message is returned by calling KNH$SEND.
      684    13636        */
      685    13637
      686    13638    2       CASE (%KN_FCN_INIT);
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:82   
      687    13639              %LOCK(G=KNN_LOCK);
      688    13646    2         IF FPT_CONNECT.DEST.AFI ~= 0
      689    13647    3           AND POFFW(KN$NETPARM.UHDR$,KN$NETPARM.FPT$) > SIZEW(FPT$CONNECT) THEN DO;
      690    13648                   /*
      691    13649                     if the afi is non-zero and the fpt is large enough to contain addresses
      692    13650                      then, in all likely hood, an address has been specified.  This is
      693    13651                      probably a OSI CONS connection being attempted
      694    13652                   */
      695    13653    4              CALL KNN$DECODE_NSAP(FPT_CONNECT.DEST,ROUTE) WHENALTRETURN DO;
      696    13654    4                   FPT@ACK.REASON = %K_REASON_NORTE;
      697    13655    4   FPT_NAK:        KN$NETPARM.NHDR$ = ADDR(NIL);
      698    13656    4                   KN$NETPARM.NHDRSZ = 0;
      699    13657    4                   KN$NETPARM.FUNCTION = %KN_FCN_INIT_ACK;
      700    13658    4                   KN$NETPARM.FPT$ = ADDR(FPT@ACK);
      701    13659    4                   CALL KNH$SEND(KN$NETPARM);
      702    13660                        %UNLOCK(G=KNN_LOCK);
      703    13667    4                   RETURN;
      704    13668    4                   END;
      705    13669    3              IF ROUTE.FEP# = KN_NODE# THEN
      706    13670    3                   DEST_NODE = ROUTE.HOST#;
      707    13671    3              ELSE
      708    13672    3                   DEST_NODE = ROUTE.FEP#;
      709    13673    4              IF ROUTE.FEP# >= KNN_NODES OR ROUTE.QOS = 255 THEN DO;
      710    13674    4                   FPT@ACK.REASON = %K_REASON_NORTE;
      711    13675    4                   GOTO FPT_NAK;
      712    13676    4                   END;
      713    13677    3              ROUTE$ = KNN$ROUTE$(DEST_NODE);
      714    13678    4              IF KNN$ROUTE.LINK$ = ADDR(NIL) OR KNN$ROUTE.LINK$->KNN$LINK.LDCT$ = ADDR(
             13678                       NIL) THEN DO;
      715    13679    4                   FPT@ACK.REASON = %K_REASON_NORTE;
      716    13680    4                   GOTO FPT_NAK;
      717    13681    4                   END;
      718    13682    4              IF KNN$ROUTE.FLAGS.LINK_CONNECTED AND KNN$ROUTE.FLAGS.HOST_NODE THEN DO;
      719    13683                         /*
      720    13684                    this is really a OSI CONS connection destined for a link connected host.
      721    13685                               Change the ldct type to circuit and call recv4_host
      722    13686                         */
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:83   
      723    13687    4                   KN$LDCT.CONN_TYPE = %KN_CNTYPE_CIRCUIT;
      724    13688    4                   KN$LDCT.STATE = %KN_ST_OPEN;
      725    13689    4                   KN$NETPARM.FUNCTION = %K_NCONNECT_IND;
      726    13690    4                   KN$NETPARM.NODE = DEST_NODE;
      727    13691    5                   CALL KNT$RECV_4HOST(KN$NETPARM) WHENALTRETURN DO;
      728    13692    5                        FPT@ACK.REASON = KN$NETPARM.ERRCODE;
      729    13693    5                        GOTO FPT_NAK;
      730    13694    5                        END;
      731    13695    4                   FPT@ACK.REASON = %K_REASON_NORMAL; /* implied k_nconnect_rsp*/
      732    13696    4                   GOTO FPT_NAK;
      733    13697    4                   END;
      734    13698    4              ELSE DO;
      735    13699    5                   IF KNN$ROUTE.LINK$->KNN$LINK.FLAGS.HOST_NODE THEN DO;
      736    13700                            /*
      737    13701                               this OSI CONS connection is being attempted thru a host.
      738    13702                               Due to the datagram nature of the host network, this
      739    13703                               type of connection is not allowed.
      740    13704                            */
      741    13705    5                        FPT@ACK.REASON = %K_REASON_NORTE;
      742    13706    5                        GOTO FPT_NAK;
      743    13707    5                        END;
      744    13708    5                   ELSE DO;
      745    13709                            /*
      746    13710                            connection needs to be forwared to the next hop.
      747    13711                            return the link uid # to hdlc with reason=redirect.
      748    13712                            */
      749    13713    5                        FPT@ACK.REASON = %K_REASON_REDIRECT;
      750    13714    5                        FPT@ACK.UID.UIDX.CQ_HNDCTXID = ADDR(KNN$ROUTE.LINK$->KNN$LINK.
             13714                                 LDCT$->KN$LDCT.UID)->KNH$UID.UIDX.CQ_HNDCTXID;
      751    13715    5                        GOTO FPT_NAK;
             13715                              /* altret to get rid of the ldct, which we dont need anymore*/
      752    13716    5                        END;
      753    13717    4                   END;
      754    13718    3              END;
      755    13719        /*
      756    13720                   the afi = 0, therefore use the node# to determine the type of connection.
      757    13721                k_cnc_is(253?) indicates that this is a connection to a intermediate system.
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:84   
      758    13722               and an end-system-hello pdu needs to be generated. k_cnc_other(254) indicates
      759    13723                     that some other type of non-cp6 vc is logging on.
      760    13724        */
      761    13725        /*
      762    13726                   This is either an hdlc link level connection or a coupler connection
      763    13727                   to the host.
      764    13728        */
      765    13729    2         IF NOT FPT_CONNECT.RLCID.FLAGS.VIRCIR
      766    13730    2           AND NOT FPT_CONNECT.RLCID.FLAGS.HOST_NODE
      767    13731    2         THEN
      768    13732    2              DEST_NODE = %K_CNC_LINK#;    /*link level connection*/
      769    13733    2         ELSE
      770    13734    2              DEST_NODE = FPT_CONNECT.RLCID.NODE;
      771    13735
      772    13736    3         DO LINK# = 0 TO KNN_LINKS-1;
      773    13737    3              LINK$ = KNN$LINK$(LINK#);
      774    13738    3              IF KNN$LINK.LDCT$ = ADDR(NIL) /* Found a free one                  */
      775    13739    3              THEN GOTO FOUND_LINK;
      776    13740    3              END;
      777    13741
      778    13742        /* If there is no available entry in the KNN$LINK table, return
      779    13743           an INIT_ACK with FPT_CONNECT_ACK.REASON non-zero.  Then altreturn.
      780    13744        */
      781    13745    2         KN$NETPARM.NHDR$ = ADDR(NIL);
      782    13746    2         KN$NETPARM.NHDRSZ = 0;
      783    13747    2         KN$NETPARM.FUNCTION = %KN_FCN_INIT_ACK;
      784    13748    2         KN$NETPARM.FPT$ = ADDR(FPT_NAK);
      785    13749
      786    13750    2         CALL KNH$SEND(KN$NETPARM);
      787    13751              %UNLOCK (G=KNN_LOCK);
      788    13758    2         ALTRETURN;
      789    13759
      790    13760    2   FOUND_LINK:;
      791    13761    2         KNN$LINK = '0'B;
      792    13762    2         KNN$LINK.LDCT$ = KN$NETPARM.LDCT$;
      793    13763    2         QOS = FPT_CONNECT.SERVICE;
      794    13764    2         KNN$LINK.QOS = QOS;
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:85   
      795    13765    2         KNN$LINK.NODE# = DEST_NODE;
      796    13766    2         KNN$LINK.FLAGS.HOST_NODE = FPT_CONNECT.RLCID.FLAGS.HOST_NODE;
      797    13767    2         KNN$LINK.CHAN# = FPT_CONNECT.TERMINAL_ID.TERM.CHANNEL;
      798    13768    2         KNN$LINK.SNPA = FPT_CONNECT.DSTSNPA;
      799    13769    2         KNN$LINK.FLAGS.VIRCIR = FPT_CONNECT.RLCID.FLAGS.VIRCIR;
      800    13770
      801    13771    3         IF DEST_NODE < %K_CNC_IS# THEN DO;
      802    13772    3              KNN$ROUTE$(DEST_NODE)->KNN$ROUTE.FLAGS.HOST_NODE = KNN$LINK.FLAGS.
             13772                       HOST_NODE;
      803    13773    3              KNN$ROUTE$(DEST_NODE)->KNN$ROUTE.FLAGS.LINK_CONNECTED = '1'B;
      804    13774    3              END;
      805    13775
      806    13776    2         KN$LDCT.LINK_ID = LINK#;
      807    13777
      808    13778    3         IF DEST_NODE < %K_CNC_IS# THEN DO;
      809    13779    3              CALL LINK_ACTIVE
      810    13780    4              WHENALTRETURN DO;
      811    13781    4                   KNN$LINK.LDCT$ = ADDR(NIL);
      812    13782                        %UNLOCK (G=KNN_LOCK);
      813    13789    4                   ALTRETURN;
      814    13790    4                   END;
      815    13791    3              END;
      816    13792
      817    13793    2         KN$LDCT.RLCID = FPT_CONNECT.RLCID;
      818    13794
      819    13795    2         KN$NETPARM.NHDR$ = ADDR(NIL);
      820    13796    2         KN$NETPARM.NHDRSZ = 0;
      821    13797    2         KN$NETPARM.FUNCTION = %KN_FCN_INIT_ACK;
      822    13798    2         FPT@ACK.REASON = %K_REASON_NORMAL;
      823    13799    2         KN$NETPARM.FPT$ = ADDR(FPT@ACK);
      824    13800
      825    13801    2         CALL KNH$SEND (KN$NETPARM)
      826    13802    3         WHENALTRETURN DO;
      827    13803    3              IF DEST_NODE < %K_CNC_IS# THEN
      828    13804    3                   CALL LINK_DOWN;
      829    13805    3              KNN$LINK.LDCT$ = ADDR(NIL);
      830    13806                   %UNLOCK (G=KNN_LOCK);
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:86   
      831    13813    3              ALTRETURN;
      832    13814    3              END;
      833    13815
      834    13816    3         IF DEST_NODE = %K_CNC_IS# THEN DO;
      835    13817                      /*
      836    13818                         intermediate system. respond with esh pdu
      837    13819                      */
      838    13820    3              CALL SENDESH;
      839    13821    3              END;
      840    13822
      841    13823    2         IF NOT KNN$LINK.FLAGS.VIRCIR
      842    13824    2           AND KNN$LINK.NODE# >= %K_CNC_IS#
      843    13825    2           AND KNN$LINK.SNPA.LEN ~= 0 THEN
      844    13826    3         DO;
      845    13827                      /*
      846    13828                         update the osiroute table with the new
      847    13829                         information.  forward the info to nodeadmn
      848    13830                         for propagation to the other nodes in the network.
      849    13831                      */
      850    13832    3              SNPA = KNN$LINK.SNPA;
      851    13833    3              DEST_NODE = KN_NODE#;
      852    13834    3              QOS = KNN$LINK.QOS;
      853    13835    3              CALL OSILINK_UP;
      854    13836    3              OSILINKCHG.FCN = IGA_OSILINKUP;
      855    13837    3              OSILINKCHG.SNPA = SNPA;
      856    13838    3              OSILINKCHG.QOS = QOS;
      857    13839    3              OSILINKCHG.TERMID.TERM.CHANNEL = KNN$LINK.CHAN#;
      858    13840    3              OSILINKCHG.MYNODE# = KN_NODE#;
      859    13841    3              CALL KNB$WRITE(ADDR(OSILINKCHG),SIZEC(OSILINKCHG));
             13841                       /* drop altreturn if any */
      860    13842    3              END;
      861    13843
      862    13844              %UNLOCK (G=KNN_LOCK);
      863    13851    2         RETURN;
      864    13852
      865    13853        %EJECT;
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:87   
      866    13854        /*F* NAME: KNN$RECV - init ack.
      867    13855             called from knh$scan and is the result, hopefully, of a previous init
      868    13856             realized from a OSI CONS request.
      869    13857        */
      870    13858
      871    13859    2       CASE (%KN_FCN_INIT_ACK);
      872    13860              %LOCK(G=KNN_LOCK);
      873    13867    2         IF KN$LDCT.STATE ~= %KN_ST_OPENING THEN
      874    13868    2              CALL SCREECH(PRTCLERR);
      875    13869    3         IF FPT_CONNECT_ACK.REASON ~= 0 THEN DO;
      876    13870    3              KN$NETPARM.FUNCTION = %K_NDISCONNECT_IND;
      877    13871    4              CALL KNT$RECV_4HOST(KN$NETPARM) WHENALTRETURN DO;
      878    13872                        %UNLOCK(G=KNN_LOCK);
      879    13879    4                   ALTRETURN;    /* will knh$scan try to resend this message ?   */
      880    13880    4                   END;
      881    13881                   %UNLOCK(G=KNN_LOCK);
      882    13888    3              RETURN;
      883    13889    3              END;
      884    13890
      885    13891    2         KN$LDCT.STATE = %KN_ST_OPEN;
      886    13892    2         KN$LDCT.USER_ENTRY$ = ENTADDR(NIL);
      887    13893    2         KN$NETPARM.FUNCTION = %K_NCONNECT_CFM;
      888    13894    3         CALL KNT$RECV_4HOST(KN$NETPARM) WHENALTRETURN DO;
      889    13895                   %UNLOCK(G=KNN_LOCK);
      890    13902    3              ALTRETURN;
      891    13903    3              END;
      892    13904              %UNLOCK(G=KNN_LOCK);
      893    13911    2         RETURN;
      894    13912        %EJECT;
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:88   
      895    13913        /*F* NAME: KNN$RECV - Data Function
      896    13914
      897    13915        KNN$RECV is called from KNH$SCAN with the function set to
      898    13916        DATA when the scanning has found a DATA message
      899    13917        and the LDCT as specified by KNH$MESS.LDCTX has a LINK
      900    13918        connection type.
      901    13919
      902    13920        No FPT is passed on this call.
      903    13921
      904    13922        If the message isn't for this fep, it is sent on by calling KNH$SEND.
      905    13923
      906    13924        If the message is for this node, it is passed on up the layers by
      907    13925        updating NETPARM.THDR$ and .THDRSZ to reflect the stripping
      908    13926        off of the network header and calling KNT$RECV or KNS$RECV.
      909    13927        */
      910    13928
      911    13929    2       CASE (%KN_FCN_DATA);
      912    13930    2   RECEIVE_DATA:
      913    13931
      914    13932        /* If the RECTYPE is nonzero check for a special function.
      915    13933        */
      916    13934    2         IF KN$NETPARM.RECTYPE = %KJ_FCN_TIM
      917    13935    3         THEN DO;
      918    13936    3              CALL KNH$SEND (KN$NETPARM)
      919    13937    4              WHENALTRETURN DO;
      920    13938    4                   ALTRETURN;
      921    13939    4                   END;
      922    13940    3              RETURN;
      923    13941    3              END;
      924    13942
      925    13943    2         LINK# = KN$LDCT.LINK_ID;
      926    13944    2         LINKIN# = LINK#;
      927    13945    2         LINK$ = KNN$LINK$(LINK#);
      928    13946
      929    13947        /*
      930    13948             if this message if on a OSI CONS connection then setup
      931    13949             netparm and call recv4_host.
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:89   
      932    13950        */
      933    13951    3         IF KN$LDCT.CONN_TYPE = %KN_CNTYPE_CIRCUIT THEN DO;
      934    13952    3              IF KN$LDCT.STATE ~= %KN_ST_OPEN THEN
      935    13953    3                   CALL SCREECH(PRTCLERR);
      936    13954
      937    13955    3              KN$NETPARM.FUNCTION = %K_NDATA;
      938    13956    3              KN$NETPARM.THDR$ = KN$NETPARM.NHDR$;
      939    13957    3              KN$NETPARM.THDRSZ = KN$NETPARM.NHDRSZ;
      940    13958    3              KN$NETPARM.NHDRSZ = 0;
      941    13959    3              KN$NETPARM.NHDR$ = ADDR(NIL);
      942    13960    3              KN$NETPARM.FLAGS.CONS = '1'B;
      943    13961    4              CALL KNT$RECV_4HOST(KN$NETPARM) WHENALTRETURN DO;
      944    13962    4                   ALTRETURN;
      945    13963    4                   END;
      946    13964    3              RETURN;
      947    13965    3              END;                         /* conn_type = circuit                */
      948    13966
      949    13967        /*
      950    13968                   This message is osi class 4 transport, class C network.  Call
      951    13969                   the osi pdu burster to decide what to do with it.  possibly
      952    13970                   from a foreign system or an alien cp6.
      953    13971        */
      954    13972    3         IF B$QDP_HDR.MSGTYP = %K_MSGTYP_OSI# THEN DO;
      955    13973    4              CALL KNN$RECVOSI(KN$NETPARM) WHENALTRETURN DO;
      956    13974    4                   ALTRETURN;
      957    13975    4                   END;
      958    13976    3              RETURN;
      959    13977    3              END;
      960    13978
      961    13979        /*
      962    13980                   cp6 class4.  type pdu indicates that an osi type message
      963    13981                   orginated on the host.  This code needs to decide where to
      964    13982                   forward the message to(node or link).  The code must also
      965    13983                   build a proper osi network header.
      966    13984        */
      967    13985
      968    13986    3         IF B$OSI_HDR.MSGTYP = %K_MSGTYP_OSI_INIT# THEN DO;
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:90   
      969    13987    3              KN$NETPARM.SRC_ADDR$ = ADDR(B$OSI_HDR.SRC_NSAP);
      970    13988    3              KN$NETPARM.DST_ADDR$ = ADDR(B$OSI_HDR.DST_NSAP);
      971    13989    3              KN$NETPARM.FPT$ = ADDR(B$OSI_HDR.TR_OPTIONS);
      972    13990    3              KN$NETPARM.NODE = B$OSI_HDR.SOURCE_NODE-1;
      973    13991    3              KN$NETPARM.THDRSZ = KN$NETPARM.NHDRSZ - LENGTHC(B$OSI_HDR);
      974    13992    3              KN$NETPARM.THDR_C$ = PINCRC(KN$NETPARM.NHDR$,LENGTHC(B$OSI_HDR));
      975    13993    3              KN$NETPARM.FUNCTION = %K_NDATA;
      976    13994    3              QQQ$ = KN$NETPARM.LDCT$;
      977    13995                      /*
      978    13996                            osi_init msgtype - call send4_host.   altreturn indicates
      979    13997                            a class 0 connection which transport resolved via a call to
      980    13998                            knn$send.  An altreturn with a non-zero kn$netparm.errcode
      981    13999                            indicates that something went amiss.  A return indicates that
      982    14000                            this message is class4/C and an osi network header should be
      983    14001                            built.
      984    14002                      */
      985    14003    4              CALL KNT$SEND_4HOST(KN$NETPARM) WHENALTRETURN DO;
      986    14004    5                   IF KN$NETPARM.ERRCODE ~= 0 THEN DO;
      987    14005    5                        KN$NETPARM.LDCT$ = QQQ$;
      988    14006    5                        ALTRETURN;         /* an error was encountered           */
      989    14007    5                        END;
      990    14008    4                   KN$NETPARM.LDCT$ = QQQ$;
      991    14009    4                   RETURN;
      992    14010    4                   END;
      993    14011                      /*
      994    14012                            transport will keep the addresses in transport context.
      995    14013                      */
      996    14014
      997    14015    4              CALL KNN$SENDOSI(KN$NETPARM) WHENALTRETURN DO;
      998    14016    4                   KN$NETPARM.LDCT$ = QQQ$;
      999    14017    4                   ALTRETURN;
     1000    14018    4                   END;
     1001    14019    3              KN$NETPARM.LDCT$ = QQQ$;
     1002    14020    3              RETURN;
     1003    14021        /*N*
     1004    14022                need code to do the msgs in and messages out code
     1005    14023        */
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:91   
     1006    14024
     1007    14025    3              END;                         /* end msgtype=osi_init               */
     1008    14026
     1009    14027                   /*
     1010    14028                   osi_data   handled the same as osi_init except that transport
     1011    14029                   remembers the addresses for the connection.  And/or in the case
     1012    14030                   of class 0 forwards the message to knh$send.  If this is a class0
     1013    14031                   connection an altreturn with a zero kn$netparm.errcode field will
     1014    14032                   result.  A non zero kn$netparm.errcode indicates that for whatever
     1015    14033                   reason the message could not be delivered.
     1016    14034                   */
     1017    14035
     1018    14036    3         IF B$OSI_HDR.MSGTYP = %K_MSGTYP_OSI_DATA# THEN DO;
     1019    14037    3              KN$NETPARM.NODE = B$OSI_HDR.SOURCE_NODE-1;
     1020    14038    3              KN$NETPARM.FUNCTION = %K_NDATA;
     1021    14039    3              KN$NETPARM.DST_ADDR$ = ADDR(NIL);
     1022    14040    3              KN$NETPARM.SRC_ADDR$ = ADDR(NIL);
     1023    14041    3              KN$NETPARM.THDRSZ = KN$NETPARM.NHDRSZ - LENGTHC(B$QDP_HDR);
     1024    14042    3              KN$NETPARM.THDR$ = PINCRC(KN$NETPARM.NHDR$, LENGTHC(B$QDP_HDR));
     1025    14043    4              CALL KNT$SEND_4HOST(KN$NETPARM) WHENALTRETURN DO;
     1026    14044    4                   IF KN$NETPARM.ERRCODE ~= 0 THEN ALTRETURN; /* error           */
     1027    14045    4                   RETURN;                 /* successful class0 transmittion???  */
     1028    14046    4                   END;
     1029    14047
     1030    14048                      /*   kn$netparm.dst_addr$ and kn$netparm.src_addr$ should now
     1031    14049                            point to the tctx bobcat data where transport stowed the
     1032    14050                            nsap addresses during connect.*/
     1033    14051    3              QQQ$ = KN$NETPARM.LDCT$;     /* save ldct                          */
     1034    14052    4              CALL KNN$SENDOSI(KN$NETPARM) WHENALTRETURN DO;
     1035    14053    4                   KN$NETPARM.LDCT$ = QQQ$;
     1036    14054    4                   ALTRETURN;
     1037    14055    4                   END;
     1038    14056    3              KN$NETPARM.LDCT$ = QQQ$;
     1039    14057    3              RETURN;
     1040    14058        /*N*
     1041    14059                need code to do the msgs in and messages out code
     1042    14060        */
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:92   
     1043    14061    3              END;                         /* msgtype = osi_data#                */
     1044    14062
     1045    14063        /*
     1046    14064              If it isn't one of the above
     1047    14065              Extract node numbers and fix up kn$netparm for transport or session.
     1048    14066        */
     1049    14067    2         DEST_NODE = B$QDP_HDR.DEST_NODE -1;
     1050    14068    2         SOURCE_NODE = B$QDP_HDR.SOURCE_NODE -1;
     1051    14069    2         IF (SOURCE_NODE > KNN_NODES) OR
     1052    14070    2           (DEST_NODE > KNN_NODES) THEN
     1053    14071    2              IF (KN_SCREECH ~= 0) THEN
     1054    14072    2                   CALL SCREECH(PRTCLERR);
     1055    14073    2              ELSE
     1056    14074    2                   RETURN;
     1057    14075
     1058    14076        /* Screech if we have passed this message through 15 nodes.
     1059    14077        */
     1060    14078    2         B$QDP_HDR.HOP_COUNT = B$QDP_HDR.HOP_COUNT +1;
     1061    14079    2         IF B$QDP_HDR.HOP_COUNT = 15
     1062    14080    3         THEN DO;
     1063    14081    3              IF KN_SCREECH_HOPCOUNT ~= 0
     1064    14082    3              THEN CALL SCREECH(PRTCLERR);
     1065    14083    3              ELSE RETURN;
     1066    14084    3              END;
     1067    14085
     1068    14086        /* If the message isn't for this fep, send it on by calling KNH$SEND.
     1069    14087        */
     1070    14088    2         IF DEST_NODE ~= KN_NODE#
     1071    14089    3         THEN DO;
     1072    14090    3              ROUTE$ = KNN$ROUTE$(DEST_NODE);
     1073    14091
     1074    14092    3              IF KNN$ROUTE.LINK$ = ADDR(NIL)
     1075    14093    3                OR KNN$ROUTE.LINK$->KNN$LINK.LDCT$ = ADDR(NIL)
     1076    14094    4              THEN DO;
     1077    14095    4                   RETURN;
     1078    14096    4                   END;
     1079    14097
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:93   
     1080    14098    3              LINK# = KNN$ROUTE.LINK$->KNN$LINK.LDCT$->KN$LDCT.LINK_ID;
     1081    14099    3              QQQ$ = KN$NETPARM.LDCT$;
     1082    14100
     1083    14101    3              KN$NETPARM.LDCT$ = KNN$ROUTE.LINK$->KNN$LINK.LDCT$;
     1084    14102
     1085    14103    3              KN$NETPARM.MSGSZ = 0;
     1086    14104    3              KN$NETPARM.UHDRSZ = 0;
     1087    14105    3              KN$NETPARM.SHDRSZ = 0;
     1088    14106    3              KN$NETPARM.THDRSZ = 0;
     1089    14107    3              IF KN$LDCT.CONN_TYPE = %KN_CNTYPE_LINK AND
     1090    14108    3                B$QDP_HDR.MSGTYP = %K_MSGTYP_CP6_CL4#
     1091    14109    4              THEN DO;
     1092    14110                                                /* must be an rfep                    */
     1093    14111    4                   KN$NETPARM.FUNCTION = %KN_FCN_DATA;
     1094    14112    4                   KN$NETPARM.DST_ADDR$ = ADDR(NIL);
     1095    14113    4                   KN$NETPARM.SRC_ADDR$ = ADDR(NIL);
     1096    14114
     1097    14115        /*
     1098    14116                               if the message is not destined for this node and the
     1099    14117                               source node is link connected and a host, then call
     1100    14118                               transports send for host.  If the destination node is
     1101    14119                               a host and is link connected then call transport receive
     1102    14120                               for host.  If neither is true neither is true then forward
     1103    14121                               the message normally.
     1104    14122        */
     1105    14123    4                   NWHDR_SZ = LENGTHC(B$QDP_HDR); /* patched for pe0f            */
     1106    14124    4                   KN$NETPARM.THDR$ = PINCRW(KN$NETPARM.NHDR$, NWHDR_SZ/2);
     1107    14125    4                   KN$NETPARM.THDRSZ = KN$NETPARM.NHDRSZ - NWHDR_SZ;
     1108    14126    4                   IF KNN$ROUTE$(SOURCE_NODE)->KNN$ROUTE.FLAGS.HOST_NODE
     1109    14127    4                     AND KNN$ROUTE$(SOURCE_NODE)->KNN$ROUTE.FLAGS.LINK_CONNECTED THEN
     1110    14128    5                        CALL KNT$SEND_4HOST(KN$NETPARM) WHENRETURN DO;
     1111    14129    5                             KN$NETPARM.THDRSZ = 0;
     1112    14130    5                             END;
     1113    14131    5                        WHENALTRETURN DO;
     1114    14132    5                             IF KN$NETPARM.ERRCODE ~= 0 THEN GOTO RESTORE_QQQ;
             14132                                      /* altret*/
     1115    14133    6                             ELSE DO;      /* message has been buffered by trans*/
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:94   
     1116    14134    6                                  KN$NETPARM.LDCT$ = QQQ$;
     1117    14135    6                                  RETURN;
     1118    14136    6                                  END;
     1119    14137    5                             END;
     1120    14138    4                   ELSE IF KNN$ROUTE.FLAGS.HOST_NODE
     1121    14139    4                          AND KNN$ROUTE.FLAGS.LINK_CONNECTED THEN
     1122    14140    5                             CALL KNT$RECV_4HOST(KN$NETPARM) WHENRETURN DO;
     1123    14141    5                                  KN$NETPARM.THDRSZ = 0;
     1124    14142    5                                  END;
     1125    14143    5                             WHENALTRETURN DO;
     1126    14144    5                                  IF KN$NETPARM.ERRCODE ~= 0 THEN GOTO RESTORE_QQQ;
             14144                                           /*altret*/
     1127    14145    6                                  ELSE DO; /* message buffered by trans          */
     1128    14146    6                                       KN$NETPARM.LDCT$ = QQQ$;
     1129    14147    6                                       RETURN;
     1130    14148    6                                       END;
     1131    14149    5                                  END;
     1132    14150    5                        ELSE DO;
     1133    14151                               /*
     1134    14152                               message is not from/to a host don't put a network
     1135    14153                               header on it.
     1136    14154                               */
     1137    14155    5                             KN$NETPARM.THDR$ = ADDR(NIL);
     1138    14156    5                             KN$NETPARM.THDRSZ = 0;
     1139    14157    5                             END;
     1140    14158    4                   END;
     1141    14159
     1142    14160    3   SENDDATA:  ;
     1143    14161    3              CALL KNH$SEND (KN$NETPARM) ALTRET(RESTORE_QQQ);
     1144    14162
     1145    14163    3              KN$NETPARM.LDCT$ = QQQ$;
     1146    14164    3              KNN$ROUTE.LINK.MSGS_IN(LINKIN#) = KNN$ROUTE.LINK.MSGS_IN(LINKIN#) + 1;
     1147    14165    3              KNN$ROUTE.LINK.MSGS_OUT(LINK#) = KNN$ROUTE.LINK.MSGS_OUT(LINK#) + 1;
     1148    14166
     1149    14167    3              KNN$ROUTE.LINK$->KNN$LINK.MSGS_IN = KNN$ROUTE.LINK$->KNN$LINK.MSGS_IN+1;
     1150    14168    3              KNN$ROUTE.LINK$->KNN$LINK.MSGS_OUT = KNN$ROUTE.LINK$->KNN$LINK.MSGS_OUT +
             14168                       1;
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:95   
     1151    14169
     1152    14170    3              RETURN;
     1153    14171    3              END;
     1154    14172
     1155    14173        /* Message is for this node.
     1156    14174        */
     1157    14175    2         KN$NETPARM.NODE = SOURCE_NODE;
     1158    14176    2         ROUTE$ = KNN$ROUTE$(KN$NETPARM.NODE);
     1159    14177
     1160    14178    2         IF KNN$ROUTE.LINK$ = ADDR(NIL)    /* No route yet                       */
     1161    14179    3         THEN DO;
     1162    14180    3              KNN$ROUTE.LINK.QOS(LINK#) = 254;
     1163    14181    3              CALL UPDATE_ROUTE
     1164    14182    4              WHENALTRETURN DO;
     1165    14183    4                   ALTRETURN;
     1166    14184    4                   END;
     1167    14185    3              END;
     1168    14186
     1169    14187        /* Fix up kn$netparm for transport or session and pass msg on up the layers.
     1170    14188        */
     1171    14189    2         NWHDR_SZ = LENGTHC(B$QDP_HDR);
     1172    14190
     1173    14191    2         IF B$QDP_HDR.MSGTYP =%K_MSGTYP_CP6_QDP#
     1174    14192    3         THEN DO;
     1175    14193    3              KN$NETPARM.SHDR$ = PINCRW(KN$NETPARM.NHDR$, NWHDR_SZ/2);
     1176    14194    3              KN$NETPARM.SHDRSZ = KN$NETPARM.NHDRSZ - NWHDR_SZ;
     1177    14195    3              CALL KNS$RECV(KN$NETPARM) ALTRET(DO_ALTRET);
     1178    14196    3              END;
     1179    14197    3         ELSE DO;
     1180    14198    3              KN$NETPARM.THDR$ = PINCRW(KN$NETPARM.NHDR$, NWHDR_SZ/2);
     1181    14199    3              KN$NETPARM.THDRSZ = KN$NETPARM.NHDRSZ - NWHDR_SZ;
     1182    14200    3              CALL KNT$RECV(KN$NETPARM) ALTRET(DO_ALTRET);
     1183    14201    3              END;
     1184    14202
     1185    14203    2         ROUTE$ = KNN$ROUTE$(KN_NODE#);
     1186    14204    2         KNN$ROUTE.LINK.MSGS_IN(LINK#) = KNN$ROUTE.LINK.MSGS_IN(LINK#) + 1;
     1187    14205    2         KNN$LINK.MSGS_IN = KNN$LINK.MSGS_IN + 1;
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:96   
     1188    14206    2         RETURN;
     1189    14207
     1190    14208    2   RESTORE_QQQ: ;
     1191    14209    2         KN$NETPARM.LDCT$ = QQQ$;
     1192    14210    2   DO_ALTRET: ;
     1193    14211    2         B$QDP_HDR.HOP_COUNT = B$QDP_HDR.HOP_COUNT -1;
     1194    14212    2         ALTRETURN;
     1195    14213
     1196    14214        %EJECT;
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:97   
     1197    14215
     1198    14216        /*F* NAME: KNN$RECV - Unqueue
     1199    14217
     1200    14218        KNN$RECV is called from KNH$SCAN if the user has removed items
     1201    14219        from his receive circular queue since the last scan and there are
     1202    14220        other user's messages queued waiting for space in that queue.
     1203    14221        No FPT is passed on this call.
     1204    14222
     1205    14223        KN$NETPARM.LDCT$ has been set from KNH$HMI.WAIT_HEAD$, so it
     1206    14224        contains the address of the first LDCT queued.
     1207    14225
     1208    14226        KNN$RECV does nothing but pass the NETPARM on up the layers
     1209    14227        by calling KNT$RECV with the function set to KN_FCN_UNQ.
     1210    14228        */
     1211    14229
     1212    14230    2       CASE (%KN_FCN_UNQ);                 /* Link requests a unqueue.           */
     1213    14231                   /*
     1214    14232                    *    A previous term ack failed to make it to the user.
     1215    14233                    *    attempt to send the term_ack now.  If we are successful
     1216    14234                    *    set the ldct.rel flag so that scan will release the ldct.
     1217    14235                    */
     1218    14236    2         KN$NETPARM.FPT$ = ADDR(FPT@TERM_ACK);
     1219    14237    2         KN$NETPARM.FUNCTION = %KN_FCN_TERM_ACK;
     1220    14238    2         KN$NETPARM.NHDR$ = ADDR(NIL);
     1221    14239    2         KN$NETPARM.NHDRSZ = 0;
     1222    14240    2         KN$NETPARM.SLDCT$ = KN$NETPARM.LDCT$;
     1223    14241    3         CALL KNH$SEND(KN$NETPARM) WHENALTRETURN DO;
     1224    14242    3              KN$LDCT.FLAGS.REL = '0'B; /* dont release the ldct. we aren't done*/
     1225    14243    3              RETURN;                      /* doesn't matter scan doesn't check  */
     1226    14244    3              END;
     1227    14245    2         KN$LDCT.FLAGS.REL = '1'B;         /* let scan release it now            */
     1228    14246    2         KNN$LINK.LDCT$ = ADDR(NIL);
     1229    14247    2         RETURN;
     1230    14248
     1231    14249        %EJECT;
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:98   
     1232    14250
     1233    14251        /*F* NAME: KNN$RECV - Terminate connection
     1234    14252
     1235    14253        KNN$RECV is also called from KNH$CLOSE when a link handler
     1236    14254        terminates.
     1237    14255
     1238    14256        The parameters are:
     1239    14257        .fif
     1240    14258        } KN$NETPARM.FUNCTION
     1241    14259        }                - The function to be performed.  This will be the
     1242    14260        }                  folowing EQUed value from the file KNH_MACRO_M:
     1243    14261        }                      KN_FCN_TERM
     1244    14262        }
     1245    14263        } KN$NETPARM.LDCT$ - contains the LDCT of the destination
     1246    14264        }                    end-point on this fep.
     1247    14265        }
     1248    14266        } FPT_TERM    - This parameter is passed in KN$NETPARM.FPT$, but
     1249    14267        }               we don't use it.
     1250    14268        }
     1251    14269        .fin
     1252    14270
     1253    14271        */
     1254    14272
     1255    14273    2       CASE (%KN_FCN_TERM);
     1256    14274
     1257    14275              %LOCK (G=KNN_LOCK);
     1258    14282    2         QQQ$ = KN$NETPARM.LDCT$;
     1259    14283    2         IF KN$LDCT.FLAGS.REL THEN
     1260    14284                      /*
     1261    14285                       *we already sent the disconnect_ind but the term ack failed to
     1262    14286                       *make it thru the cq of the handler(hdlc).
     1263    14287                       */
     1264    14288    2              GOTO DONTSENDOSIDOWN;
     1265    14289    3         IF KN$LDCT.CONN_TYPE = %KN_CNTYPE_CIRCUIT THEN DO;
     1266    14290    3              KN$NETPARM.FUNCTION = %K_NDISCONNECT_IND;
     1267    14291    4              CALL KNT$RECV_4HOST(KN$NETPARM) WHENALTRETURN DO;
     1268    14292                        %UNLOCK(G=KNN_LOCK);
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:99   
     1269    14299    4                   ALTRETURN;
     1270    14300    4                   END;
     1271    14301    3              GOTO DONTSENDOSIDOWN;
     1272    14302    3              END;
     1273    14303
     1274    14304
     1275    14305    2         DEST_NODE = KN$LDCT.RLCID.NODE;
     1276    14306    2         LINK$ = KNN$LINK$(KN$LDCT.LINK_ID);
     1277    14307    2         LINK# = KN$LDCT.LINK_ID;
     1278    14308    2         QOS = KNN$LINK.QOS;
     1279    14309    2         SNPA = KNN$LINK.SNPA;
     1280    14310    2         IF KN$LDCT.FLAGS.REL THEN GOTO DONTSENDOSIDOWN;
     1281    14311
     1282    14312    3         IF DEST_NODE < %K_CNC_IS# THEN DO;
     1283    14313    3              CALL LINK_DOWN
     1284    14314    4              WHENALTRETURN DO;
     1285    14315                        %UNLOCK (G=KNN_LOCK);
     1286    14322    4                   ALTRETURN;
     1287    14323    4                   END;
     1288    14324    3              IF KNN$ROUTE$(DEST_NODE)->KNN$ROUTE.CURRENT_QOS = 255 THEN
     1289    14325    3                   KNN$ROUTE$(DEST_NODE)->KNN$ROUTE.FLAGS.LINK_CONNECTED = '0'B;
     1290    14326    3              END;               /* dont call linkdown on linklevel connections*/
     1291    14327    2         ELSE
     1292    14328    3              IF NOT KNN$LINK.FLAGS.VIRCIR THEN DO;
     1293    14329                         /*
     1294    14330                            if another link to this same network exists
     1295    14331                            dont call osilink_down
     1296    14332                         */
     1297    14333    4                   DO I = 0 TO KNN_LINKS-1;
     1298    14334    4                        IF LINK# ~= I
     1299    14335    4                          AND KNN$LINK$(I)->KNN$LINK.SNPA = KNN$LINK.SNPA THEN
     1300    14336    4                             GOTO DONTSENDOSIDOWN;
     1301    14337    4                        END;
     1302    14338    3                   DEST_NODE = KN_NODE#;   /* so we know its this node           */
     1303    14339    3                   IF KNN$LINK.SNPA.LEN = 0 THEN GOTO DONTSENDOSIDOWN;
     1304    14340    3                   CALL OSILINK_DOWN;
     1305    14341    3                   OSILINKCHG.FCN = IGA_OSILINKDOWN;
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:100  
     1306    14342    3                   OSILINKCHG.SNPA = SNPA;
     1307    14343    3                   OSILINKCHG.QOS = QOS;
     1308    14344    3                   OSILINKCHG.TERMID.TERM.CHANNEL = KNN$LINK.CHAN#;
     1309    14345    3                   OSILINKCHG.MYNODE# = KN_NODE#;
     1310    14346    3                   CALL KNB$WRITE(ADDR(OSILINKCHG),SIZEC(OSILINKCHG));
             14346                            /* drop altreturn if any */
     1311    14347    3                   END;
     1312    14348
     1313    14349    2   DONTSENDOSIDOWN:;
     1314    14350    2         KN$NETPARM = KN_NETPARM_INIT;
     1315    14351    2         KN$NETPARM.LDCT$ = QQQ$;
     1316    14352    2         I = KN$LDCT.CONN_TYPE;       /* save because ldct is released in send   */
     1317    14353    2         KN$NETPARM.FUNCTION = %KN_FCN_TERM_ACK;
     1318    14354    2         KN$NETPARM.FPT$ = ADDR(FPT@TERM_ACK);
     1319    14355    2         IF (I ~= %KN_CNTYPE_CIRCUIT) THEN
     1320    14356    2              KNN$LINK.SNPA = '0'B;
     1321    14357    2         KN$NETPARM.NHDRSZ=0;
     1322    14358    2         KN$NETPARM.NHDR$ = ADDR(NIL);
     1323    14359
     1324    14360    3         CALL KNH$SEND (KN$NETPARM) WHENALTRETURN DO;
     1325    14361                   /*
     1326    14362                    *setup a call to timer routine.
     1327    14363                    */
     1328    14364    3              CALL KNN$SENDTERM_ACK(KN$LDCT.LDCTX);
     1329    14365    3              KN$LDCT.FLAGS.REL = '1'B;
     1330    14366    3              KN$LDCT.USER_ENTRY$ = ENTADDR(KNN$RECV);
     1331    14367                   %UNLOCK (G=KNN_LOCK);
     1332    14374                   /*
     1333    14375                    * return releases the message. subsequent timer event will cause
     1334    14376                    ldct to be released
     1335    14377                    */
     1336    14378    3              RETURN;
     1337    14379    3              END;
     1338    14380    2         IF I ~= %KN_CNTYPE_CIRCUIT THEN
     1339    14381    2              KNN$LINK.LDCT$ = ADDR(NIL);
     1340    14382              %UNLOCK (G=KNN_LOCK);
     1341    14389    2         RETURN;
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:101  
     1342    14390
     1343    14391        %EJECT;
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:102  
     1344    14392    2       CASE (%KN_FCN_BLOCK);
     1345    14393              %LOCK(G=KNN_LOCK);
     1346    14400    2         LINK# = KN$LDCT.LINK_ID;
     1347    14401    2         LINK$ = KNN$LINK$(LINK#);
     1348    14402    2         KNN$LINK.BLKCNT = KNN$LINK.BLKCNT + 1;
     1349    14403    2         IF KNN$LINK.FLAGS.CLASS_A
     1350    14404    3           OR NOT KNN$LINK.FLAGS.VIRCIR THEN DO;
     1351    14405                   %UNLOCK(G=KNN_LOCK);
     1352    14412    3              RETURN;                      /* sorry no blockee classA connections*/
     1353    14413    3              END;
     1354    14414    2         CQOS = 255;
     1355    14415    2         CLNK# = -1;
     1356    14416    3         DO J = 0 TO KNN_LINKS-1;
     1357    14417    3              IF KNN$ROUTE$(KNN$LINK.NODE#)->KNN$ROUTE.LINK.ACTIVE(J)
     1358    14418    3                AND KNN$LINK$(J)->KNN$LINK.NODE# = KNN$LINK.NODE#
     1359    14419    3                AND NOT KNN$LINK$(J)->KNN$LINK.FLAGS.BLOCKED
     1360    14420    4                AND LINK# ~= J THEN DO;
     1361    14421    5                   IF CQOS > KNN$LINK$(J)->KNN$LINK.QOS THEN DO;
     1362    14422    5                        CQOS = KNN$LINK$(J)->KNN$LINK.QOS;
     1363    14423    5                        CLNK# = J;
     1364    14424    5                        END;
     1365    14425    4                   END;
     1366    14426    3              END;
     1367    14427
     1368    14428    3         IF CLNK# ~= -1 THEN DO;      /* found a link to replace the blocked link*/
     1369    14429    3              KNN$LINK.FLAGS.BLOCKED = '1'B; /* mark old link as blocked         */
     1370    14430    4              DO I = 0 TO KNN_NODES;
     1371    14431    4                   IF KNN$ROUTE$(I)->KNN$ROUTE.LINK# = LINK#
     1372    14432    5                     AND KNN$ROUTE$(I)->KNN$ROUTE.CURRENT_QOS < 255 THEN DO;
     1373    14433    5                        KNN$ROUTE$(I)->KNN$ROUTE.LINK# = CLNK#;
     1374    14434    5                        KNN$ROUTE$(I)->KNN$ROUTE.LINK$ = KNN$LINK$(CLNK#);
     1375    14435        /*
     1376    14436                     replace the current qos with the new qos if the node is link connected.
     1377    14437                         otherwise subtract off the old links qos and add on the new links
     1378    14438                         qos.
     1379    14439        */
     1380    14440    5                        IF I = KNN$LINK.NODE# THEN
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:103  
     1381    14441    5                             KNN$ROUTE$(I)->KNN$ROUTE.CURRENT_QOS = KNN$LINK$(CLNK#)->
             14441                                      KNN$LINK.QOS;
     1382    14442    5                        ELSE
     1383    14443    5                             KNN$ROUTE$(I)->KNN$ROUTE.CURRENT_QOS = KNN$ROUTE$(I)->
             14443                                      KNN$ROUTE.CURRENT_QOS -
     1384    14444    5                               KNN$LINK.QOS + KNN$LINK$(CLNK#)->KNN$LINK.QOS;
     1385    14445    5                        END;
     1386    14446        /*
     1387    14447                           mark the new link as up and running in the route tables.
     1388    14448        */
     1389    14449    4                   END;
             14449                          /*  do i = 0 to knn_nodes update route table to reflect new link*/
     1390    14450    3              END;
     1391    14451              %UNLOCK(G=KNN_LOCK);
     1392    14458    2         RETURN;
     1393    14459        %EJECT;
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:104  
     1394    14460    2       CASE (%KN_FCN_UNBLOCK);
     1395    14461              %LOCK(G=KNN_LOCK);
     1396    14468    2         LINK# = KN$LDCT.LINK_ID;
     1397    14469    2         LINK$ = KNN$LINK$(LINK#);
     1398    14470    2         KNN$LINK.UNBLKCNT = KNN$LINK.UNBLKCNT + 1;
     1399    14471    2         IF KNN$LINK.FLAGS.CLASS_A
     1400    14472    3           OR NOT KNN$LINK.FLAGS.VIRCIR THEN DO;
     1401    14473                   %UNLOCK(G=KNN_LOCK);
     1402    14480    3              RETURN;                 /*no unblock allowed on classA connections*/
     1403    14481    3              END;
     1404    14482    3         IF NOT KNN$LINK.FLAGS.BLOCKED THEN DO;
     1405    14483                   %UNLOCK(G=KNN_LOCK);
     1406    14490    3              RETURN;                      /* this link isn't blocked*/
     1407    14491    3              END;
     1408    14492
     1409    14493    2         KNN$LINK.FLAGS.BLOCKED = '0'B;
     1410    14494              %UNLOCK(G=KNN_LOCK);
     1411    14501    2         RETURN;
     1412    14502
     1413    14503        %EJECT;
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:105  
     1414    14504    2       CASE (ELSE);
     1415    14505    2         CALL SCREECH(BADFNC);
     1416    14506    2         END/*do case(function)*/;
     1417    14507
     1418    14508    1      RETURN;
     1419    14509        %EJECT;
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:106  
     1420    14510        /*F* NAME: KNN$OSICHG
     1421    14511
     1422    14512        KNN$OSICHG is called from knb$action when that routine receives a kl$updosi
     1423    14513        from another network manager.
     1424    14514        */
     1425    14515    1   KNN$OSICHG: ENTRY(KN$NETPARM) ALTRET;
     1426    14516
     1427    14517
     1428    14518    1      FOUNDONE = '0'B;
     1429    14519    2      DO I = 0 TO KNN_OSIMAX# - 1;
     1430    14520    2           OSI$ = KNN$OSIROUTE$(I);
     1431    14521
     1432    14522    2           IF KNN$OSIROUTE.NS_TYPE = KL$UPDOSI.NS_TYPE
     1433    14523    2             AND KNN$OSIROUTE.NSAP.AFI = KL$UPDOSI.NSAP.AFI
     1434    14524    2             AND KNN$OSIROUTE.NSAP.LEN = KL$UPDOSI.NSAP.LEN THEN
     1435    14525    3   NXTI:   DO;
     1436    14526    3                L = 0;
     1437    14527    3                UPDOSI$ = ADDR(KL$UPDOSI.NSAP);
     1438    14528    3                OSIROUTE$ = ADDR(KNN$OSIROUTE.NSAP);
     1439    14529    3                LEN = KNN$OSIROUTE.NSAP.LEN;
     1440    14530    3                IF SUBSTR(UPDOSI$->ADDRESS,2,LEN-1) ~= SUBSTR(OSIROUTE$->ADDRESS,2,LEN-
             14530                         1) THEN
     1441    14531    3                     EXIT NXTI;       /* compare the address, but dont do afi*/
     1442    14532        /*
     1443    14533             found a match, but now is this a separate incarnation of the same
     1444    14534             entity or a new connection.
     1445    14535        */
     1446    14536    3                IF KL$UPDOSI.NS_TYPE = %K_TYPE_LNSAP THEN
     1447    14537    3                     IF KNN$OSIROUTE.LINK.HOST#(0) = KL$UPDOSI.HOST#
     1448    14538    3                       AND KNN$OSIROUTE.LINK.FEP#(0) = KL$UPDOSI.FEP# THEN
     1449    14539    3                          IF KL$UPDOSI.FCN = IGA_DELOSI THEN
     1450    14540    4                          DO;
     1451    14541    4                               KNN$OSIROUTE.NSAP.AFI = 0;
     1452    14542    4                               RETURN;
     1453    14543    4                               END;
     1454    14544    3                          ELSE
     1455    14545    3                               RETURN;     /* that lnsap is already defined      */
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:107  
     1456    14546    3                     ELSE
     1457    14547    3                          EXIT NXTI;
     1458    14548    4                ELSE DO;                   /* rnsap                              */
     1459    14549    4                     IF KNN$OSIROUTE.SNPA ~= KL$UPDOSI.SNPA THEN
     1460    14550    4                          EXIT NXTI;
     1461    14551    5                     DO K = 0 TO KNN_LINKS - 1;
     1462    14552    5                          IF KNN$OSIROUTE.LINK.FEP#(K) = KL$UPDOSI.FEP# THEN
             14552                                   /* same connection*/
     1463    14553    6                          DO;
     1464    14554                                    %LOCK(G=KNN_LOCK);
     1465    14561    6                               IF KL$UPDOSI.FCN = IGA_DELOSI THEN
     1466    14562    6                                    KNN$OSIROUTE.NSAP.AFI = 0;
     1467    14563    6                               ELSE
     1468    14564    6                                    KNN$OSIROUTE.LNSAP = KL$UPDOSI.LNSAP;
     1469    14565    6                               KNN$OSIROUTE.LINK.QOS(K) = KL$UPDOSI.QOS;
     1470    14566                                    %UNLOCK(G=KNN_LOCK);
     1471    14573    6                               RETURN;
     1472    14574    6                               END;   /* if osiroute.link.fep# = updosi.fep#     */
     1473    14575    5                          END;             /* do k                               */
     1474    14576        /*
     1475    14577             could not find the requested nsap address
     1476    14578        */
     1477    14579
     1478    14580    4                     IF KL$UPDOSI.FCN = IGA_DELOSI THEN
     1479    14581    4                          RETURN;
     1480    14582        /*
     1481    14583             otherwise look for the first available slot and install the new info.
     1482    14584        */
     1483    14585    5                     DO K = 0 TO KNN_LINKS - 1;
     1484    14586    5                          IF NOT KNN$OSIROUTE.LINK.ACTIVE(K) THEN
     1485    14587    6                          DO;
     1486    14588                                    %LOCK(G=KNN_LOCK);
     1487    14595    6                               KNN$OSIROUTE.LNSAP = KL$UPDOSI.LNSAP;
     1488    14596    6                               KNN$OSIROUTE.LINK.HOST#(K) = 255;
     1489    14597    6                               KNN$OSIROUTE.SNPA = KL$UPDOSI.SNPA;
     1490    14598    6                               KNN$OSIROUTE.LINK.FEP#(K) = KL$UPDOSI.FEP#;
     1491    14599    6                               KNN$OSIROUTE.LINK.QOS(K) = KL$UPDOSI.QOS;
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:108  
     1492    14600    6                               KNN$OSIROUTE.LINK.ACTIVE(K) = '1'B;
     1493    14601                                    %UNLOCK(G=KNN_LOCK);
     1494    14608    6                               RETURN;
     1495    14609    6                               END;        /* not active                         */
     1496    14610    5                          END;             /* do k                               */
     1497    14611    4                     RETURN;               /* no more space in current nsap      */
     1498    14612    4                     END;                  /* else rnsap                         */
     1499    14613    3                END;                  /* type = type and afi=afi and len = len   */
     1500    14614    2           END;                            /* do i                               */
     1501    14615        /*
     1502    14616          couldn't find anyone who wanted us up there, lets make our own space.
     1503    14617        */
     1504    14618    2      DO I = 0 TO KNN_OSIMAX# - 1;
     1505    14619    2           OSI$ = KNN$OSIROUTE$(I);
     1506    14620    2           IF KNN$OSIROUTE.NSAP.AFI = 0 THEN
     1507    14621    3           DO;
     1508    14622                     %LOCK(G=KNN_LOCK);
     1509    14629    3                KNN$OSIROUTE = '0'B;
     1510    14630    3                KNN$OSIROUTE.NS_TYPE = KL$UPDOSI.NS_TYPE;
     1511    14631    3                KNN$OSIROUTE.NW_TYPE = KL$UPDOSI.NW_TYPE;
     1512    14632    3                KNN$OSIROUTE.NSAP = KL$UPDOSI.NSAP;
     1513    14633    4                IF KL$UPDOSI.NS_TYPE = %K_TYPE_RNSAP THEN DO;
     1514    14634    4                     KNN$OSIROUTE.LNSAP = KL$UPDOSI.LNSAP;
     1515    14635    4                     KNN$OSIROUTE.LINK.HOST#(K) = 255;
     1516    14636    4                     KNN$OSIROUTE.SNPA = KL$UPDOSI.SNPA;
     1517    14637    4                     END;
     1518    14638    4                ELSE DO;
     1519    14639    4                     KNN$OSIROUTE.LNSAP = '0'B;
     1520    14640    4                     KNN$OSIROUTE.LINK.HOST#(0) = KL$UPDOSI.HOST#;
     1521    14641    4                     KNN$OSIROUTE.SNPA = '0'B;
     1522    14642    4                     END;
     1523    14643    3                KNN$OSIROUTE.LINK.FEP#(0) = KL$UPDOSI.FEP#;
     1524    14644    3                KNN$OSIROUTE.LINK.QOS(0) = KL$UPDOSI.QOS;
     1525    14645    3                KNN$OSIROUTE.LINK.ACTIVE(0) = '1'B;
     1526    14646                     %UNLOCK(G=KNN_LOCK);
     1527    14653    3                RETURN;
     1528    14654    3                END;                       /* route table entry not in use       */
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:109  
     1529    14655    2           END;                            /* do i                               */
     1530    14656    1      RETURN;
     1531    14657
     1532    14658        %EJECT;
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:110  
     1533    14659        /*F* NAME: KNN$OSILINKCHG
     1534    14660
     1535    14661        KNN$OSILINKCHG
     1536    14662             called from KNB$ACTION when osilinkchg message is receive from another
     1537    14663             network manager.  The sending network manager(updosi.mynode) must be link
     1538    14664             connected for this to be a valid number */
     1539    14665
     1540    14666    1   KNN$OSILINKCHG: ENTRY(KN$NETPARM) ALTRET;
     1541    14667
     1542    14668    1      IF NOT KNN$ROUTE$(KL$OSILINKCHG.MYNODE#)->KNN$ROUTE.FLAGS.LINK_CONNECTED THEN
     1543    14669    1           RETURN;
     1544    14670
     1545    14671    1      DEST_NODE = KL$OSILINKCHG.NODE#;
     1546    14672    1      SNPA = KL$OSILINKCHG.SNPA;
     1547    14673    1      QOS = KL$OSILINKCHG.QOS;
     1548    14674
     1549    14675    1      IF KL$OSILINKCHG.SNPA.LEN = 0 THEN RETURN;
     1550    14676    1      IF KL$OSILINKCHG.TYPE = IGA_OSILINKDOWN THEN
     1551    14677    1           CALL OSILINK_DOWN;
     1552    14678    1      ELSE
     1553    14679    1           CALL OSILINK_UP;
     1554    14680
     1555    14681    1      RETURN;
     1556    14682        %EJECT;
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:111  
     1557    14683        /*F* NAME: KNN$NODECHG
     1558    14684
     1559    14685        KNN$NODECHG is called from KNB$ACTION when that routine has received
     1560    14686        an KL$NODECHG message from SLUG.
     1561    14687
     1562    14688        This routine will search the link table for any link to the effected
     1563    14689        node.  When one is found, UPDATE_ROUTE is called to recalculate
     1564    14690        network routing.
     1565    14691
     1566    14692        KNN$NODECHG is called with the following parameters:
     1567    14693
     1568    14694        .fif
     1569    14695        }    KN$NETPARM.FPT$ - Contains the address of the KL$NODECHG structure.
     1570    14696        }    KL$NODECHG -  See file KL_MACRO_C
     1571    14697        }                  .NODE refers to the node that is going thru a state change
     1572    14698        }                  .MYNODE refers to the node that is reporting the state change
     1573    14699        }
     1574    14700        .fin
     1575    14701        */
     1576    14702
     1577    14703    1   KNN$NODECHG: ENTRY(KN$NETPARM) ALTRET;
     1578    14704
     1579    14705    1      DEST_NODE = KL$NODECHG.NODE;
     1580    14706
     1581    14707    1      IF KL$NODECHG.MYNODE > KNN_NODES
     1582    14708    1        OR DEST_NODE > KNN_NODES
     1583    14709    1      THEN RETURN;
     1584    14710
     1585    14711        /* If the link is not active return.
     1586    14712        */
     1587    14713    1      ROUTE$ = KNN$ROUTE$(KL$NODECHG.MYNODE);
     1588    14714    1      QOS = KNN$ROUTE.CURRENT_QOS;
     1589    14715    1      IF NOT KNN$ROUTE.FLAGS.LINK_CONNECTED
     1590    14716    1        OR KNN$ROUTE$(KL$NODECHG.NODE)->KNN$ROUTE.FLAGS.LINK_CONNECTED
     1591    14717    1      THEN RETURN;
     1592    14718
     1593    14719    1      FEPST.REASON = KIER_QOSCHG;
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:112  
     1594    14720           %LOCK (G=KNN_LOCK);
     1595    14727
     1596    14728    2      DO LINK# = 0 TO KNN_LINKS-1;
     1597    14729    2           LINK$ = KNN$LINK$(LINK#);
     1598    14730    2           IF KNN$LINK.NODE# = KL$NODECHG.MYNODE
     1599    14731    3           THEN DO;
     1600    14732    3                QOS = MINIMUM (KL$NODECHG.QOS + QOS, 255);
     1601    14733    3                ROUTE$ = KNN$ROUTE$(DEST_NODE);
     1602    14734    3                KNN$ROUTE.LINK.QOS(LINK#) = QOS;
     1603    14735
     1604    14736    3                IF KL$NODECHG.HOSTNODE ~= 0
     1605    14737    3                THEN KNN$ROUTE.FLAGS.HOST_NODE = '1'B;
     1606    14738
     1607    14739
     1608    14740    3                END/*do if this node*/;
     1609    14741    2           END/*do 0 to knn_links*/;
     1610    14742    1      CALL UPDATE_ROUTE
     1611    14743    2      WHENALTRETURN DO;
     1612    14744                %UNLOCK (G=KNN_LOCK);
     1613    14751    2           ALTRETURN;
     1614    14752    2           END;
     1615    14753
     1616    14754           %UNLOCK (G=KNN_LOCK);
     1617    14761    1      RETURN;
     1618    14762
     1619    14763        %EJECT;
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:113  
     1620    14764        /*I* NAME: UPDATE_ROUTE
     1621    14765
     1622    14766        UPDATE_ROUTE recalculates network routing.  For each node, the
     1623    14767        following is done:
     1624    14768
     1625    14769         - The route table is searched for the link with the best QOS.
     1626    14770
     1627    14771         - If this link is different from the one being used, or if either
     1628    14772           the QOS or ALTQOS is different, a KL$FEPST message is sent to
     1629    14773           nodeadmin.
     1630    14774
     1631    14775         - If a usable link was found the route table entry is updated with
     1632    14776           the new link and QOS values.
     1633    14777
     1634    14778         - If a usable link was not found the route table entry is updated
     1635    14779           to reflect that there is no link.  If there had been a link in
     1636    14780           use, a term function is passed up to transport and session via
     1637    14781           a call to KNT$RECV.
     1638    14782        */
     1639    14783
     1640    14784    1   UPDATE_ROUTE: PROC ALTRET;
     1641    14785
     1642    14786    2   DCL SVLINK SBIN;
     1643    14787    2   DCL BESTQOS UBIN;
     1644    14788    2   DCL ALTQOS UBIN;
     1645    14789
     1646    14790    3      DO I = 0 TO KNN_NODES;
     1647    14791    3           SVLINK = -1;
     1648    14792    3           BESTQOS = 255;
     1649    14793    3           ALTQOS = 255;
     1650    14794    3           ROUTE$ = KNN$ROUTE$(I);
     1651    14795
     1652    14796                                                /* Go through every link              */
     1653    14797    4           DO J = 0 TO KNN_LINKS-1;
     1654    14798    4                IF KNN$ROUTE.LINK.ACTIVE(J)
     1655    14799    4                  AND BESTQOS > KNN$ROUTE.LINK.QOS(J)
     1656    14800    5                THEN DO;
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:114  
     1657    14801    5                     ALTQOS = 255;         /* always                             */
     1658    14802
     1659    14803    5                     BESTQOS = KNN$ROUTE.LINK.QOS(J);
     1660    14804    5                     SVLINK = J;
     1661    14805    5                     END;
     1662    14806    4                END/*do j=0 to knn_links*/;
     1663    14807
     1664    14808        /* If the status has changed tell NA.
     1665    14809        */
     1666    14810    3           IF KNN$ROUTE.LINK# ~= SVLINK OR KNN$ROUTE.CURRENT_QOS ~= BESTQOS
     1667    14811    4           THEN DO;
     1668    14812    4                FEPST.FCN = IGA_FEPST;
     1669    14813    4                FEPST.PROB = KIER_QOSCHG;
     1670    14814    4                FEPST.FEP = I;
     1671    14815    4                FEPST.QOS = BESTQOS;
     1672    14816    4                FEPST.ALT_QOS = ALTQOS;
     1673    14817
     1674    14818    4                IF SVLINK ~= -1
     1675    14819    4                THEN FEPST.LNK_NODE = KNN$LINK$(SVLINK)->KNN$LINK.NODE#;
     1676    14820    4                ELSE FEPST.LNK_NODE = KN_NODE#;
     1677    14821
     1678    14822    4                CALL KNB$WRITE(ADDR(FEPST),SIZEC(FEPST))
     1679    14823    5                WHENALTRETURN DO;
     1680    14824    5                     ALTRETURN;
     1681    14825    5                     END;
     1682    14826    4                END/*do if reporting change to NA*/;
     1683    14827
     1684    14828    3           IF SVLINK ~= -1                 /*  link available                    */
     1685    14829    4           THEN DO;
     1686    14830    4                KNN$ROUTE.LINK# = SVLINK;
     1687    14831    4                KNN$ROUTE.LINK$ = KNN$LINK$(SVLINK);
     1688    14832    4                KNN$ROUTE.CURRENT_QOS = BESTQOS;
     1689    14833    4                KNN$ROUTE.ALT_QOS = ALTQOS;
     1690    14834    4                END;
     1691    14835
     1692    14836    4           ELSE DO;
     1693    14837    4                IF KNN$ROUTE.LINK$ ~= ADDR(NIL) AND I ~= KN_NODE#
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:115  
     1694    14838    5                THEN DO;
     1695    14839    5                     KN@NETPARM = KN_NETPARM_INIT;
     1696    14840    5                     KN@NETPARM.NODE = I;
     1697    14841    5                     KN@NETPARM.FUNCTION = %KN_FCN_TERM;
     1698    14842    5                     CALL KNT$RECV (KN@NETPARM);
     1699    14843
     1700    14844    5                     KNN$ROUTE.LINK# = -1;
     1701    14845    5                     KNN$ROUTE.LINK$ = ADDR(NIL);
     1702    14846    5                     KNN$ROUTE.CURRENT_QOS = 255;
     1703    14847    5                     KNN$ROUTE.ALT_QOS = 255;
     1704    14848    6                     DO K = 0 TO KNN_OSIMAX#-1;
     1705    14849    6                          OSI$ = KNN$OSIROUTE$(K);
     1706    14850    7                          DO L = 0 TO KNN_LINKS-1;
     1707    14851    7                               IF KNN$OSIROUTE.LINK.ACTIVE(L)
     1708    14852    8                                 AND KNN$OSIROUTE.LINK.FEP#(L) = I THEN DO;
     1709    14853    8                                    KNN$OSIROUTE.LINK.ACTIVE(L) = '0'B;
     1710    14854    8                                    KNN$OSIROUTE.LINK.QOS(L) = 255;
     1711    14855    8                                    KNN$OSIROUTE.LINK.FEP#(L) = 255;
     1712    14856    8                                    END;
     1713    14857    7                               END;        /* do l                               */
     1714    14858    6                          END;             /* do k                               */
     1715    14859    5                     END;
     1716    14860    4                END/*do if no link available*/;
     1717    14861    3           END/*do 0 to knn_nodes*/;
     1718    14862    2      RETURN;
     1719    14863    2   END UPDATE_ROUTE;
     1720    14864        %EJECT;
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:116  
     1721    14865    1   LINK_ACTIVE: PROC ALTRET;
     1722    14866
     1723    14867
     1724    14868    2      FEPST.FCN = IGA_FEPST;
     1725    14869    2      FEPST.PROB = KIER_LNKUP;
     1726    14870    2      FEPST.FEP = DEST_NODE;
     1727    14871    2      FEPST.QOS = QOS;
     1728    14872    2      FEPST.REASON = KIER_LNKUP;
     1729    14873
     1730    14874        /*
     1731    14875             if the node is already active then don't tell nodeadmn
     1732    14876        */
     1733    14877    2      IF KNN$ROUTE$(DEST_NODE)->KNN$ROUTE.CURRENT_QOS = 255 AND
     1734    14878    3        KNN$ROUTE$(DEST_NODE)->KNN$ROUTE.CTX$ = ADDR(NIL) THEN DO;
     1735    14879    3           FEPST.CHAN# = KNN$LINK.CHAN#;
     1736    14880    3           CALL KNB$WRITE(ADDR(FEPST),SIZEC(FEPST))
     1737    14881    4           WHENALTRETURN DO;
     1738    14882    4                ALTRETURN;
     1739    14883    4                END;
     1740    14884    3           END;
     1741    14885
     1742    14886    3      DO I = 0 TO KNN_NODES;
     1743    14887    3           IF I = DEST_NODE THEN           /* Going to same node                 */
     1744    14888    3                KNN$ROUTE$(I)->KNN$ROUTE.LINK.QOS(LINK#) = QOS;
     1745    14889    3           ELSE
     1746    14890    3                KNN$ROUTE$(I)->KNN$ROUTE.LINK.QOS(LINK#)= 255;
     1747    14891
     1748    14892    3           KNN$ROUTE$(I)->KNN$ROUTE.LINK.ACTIVE(LINK#) = '1'B;
     1749    14893    3           KNN$ROUTE$(I)->KNN$ROUTE.LINK.MSGS_IN(LINK#) = 0;
     1750    14894    3           KNN$ROUTE$(I)->KNN$ROUTE.LINK.MSGS_OUT(LINK#) = 0;
     1751    14895    3           END;
     1752    14896
     1753    14897    2      CALL UPDATE_ROUTE
     1754    14898    3      WHENALTRETURN DO;
     1755    14899    3           ALTRETURN;
     1756    14900    3           END;
     1757    14901    2      RETURN;
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:117  
     1758    14902    2   END LINK_ACTIVE;
     1759    14903        %EJECT;
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:118  
     1760    14904    1   LINK_DOWN: PROC ALTRET;
     1761    14905    2      FOUNDONE = '0'B;
     1762    14906    2      FEPST.FCN = IGA_FEPST;
     1763    14907    2      FEPST.PROB = KIER_LNKDWN;
     1764    14908    2      FEPST.FEP = KNN$LINK.NODE#;
     1765    14909    2      FEPST.REASON = KIER_LNKDWN;
     1766    14910
     1767    14911        /* determine if there is a secondary link to this node available
     1768    14912           if so do not tell nodeadmn that the link is no longer available */
     1769    14913
     1770    14914    3      IF KNN$ROUTE$(KNN$LINK.NODE#)->KNN$ROUTE.LINK# = LINK# THEN DO;
     1771    14915    4           DO J=0 TO KNN_LINKS-1;
     1772    14916    4                IF KNN$ROUTE$(KNN$LINK.NODE#)->KNN$ROUTE.LINK.ACTIVE(J)
     1773    14917    4                  AND J ~= LINK#
     1774    14918    5                  AND KNN$LINK$(J)->KNN$LINK.NODE# = KNN$LINK.NODE# THEN DO;
     1775    14919    5                     FOUNDONE = '1'B;
     1776    14920        /*
     1777    14921                if another path to the same is node is available, then go thru
     1778    14922                and change all of the nodes which were using that link to the
     1779    14923                new link.
     1780    14924        */
     1781    14925    6                     DO I = 0 TO KNN_NODES;
     1782    14926    6                          IF KNN$ROUTE$(I)->KNN$ROUTE.LINK# = LINK#
     1783    14927    7                            AND KNN$ROUTE$(I)->KNN$ROUTE.CURRENT_QOS < 255 THEN DO;
     1784    14928    7                               KNN$ROUTE$(I)->KNN$ROUTE.LINK# = J;
     1785    14929    7                               KNN$ROUTE$(I)->KNN$ROUTE.LINK$ = KNN$LINK$(J);
     1786    14930        /*
     1787    14931                     replace the current qos with the new qos if the node is link connected.
     1788    14932                         otherwise subtract off the old links qos and add on the new links
     1789    14933                         qos.   also update the qos in the routes link table.
     1790    14934        */
     1791    14935    8                               IF I = KNN$LINK.NODE# THEN DO;
     1792    14936    8                                    KNN$ROUTE$(I)->KNN$ROUTE.CURRENT_QOS = KNN$LINK$(J)
             14936                                             ->KNN$LINK.QOS;
     1793    14937    8                                    KNN$ROUTE$(I)->KNN$ROUTE.LINK.QOS(J) = KNN$LINK$(J)
             14937                                             ->KNN$LINK.QOS;
     1794    14938    8                                    END;
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:119  
     1795    14939    8                               ELSE DO;
     1796    14940    8                                    KNN$ROUTE$(I)->KNN$ROUTE.CURRENT_QOS = KNN$ROUTE$(I
             14940                                             )->KNN$ROUTE.CURRENT_QOS -
     1797    14941    8                                      KNN$LINK.QOS + KNN$LINK$(J)->KNN$LINK.QOS;
     1798    14942    8                                    KNN$ROUTE$(I)->KNN$ROUTE.LINK.QOS(J) = KNN$ROUTE$(I
             14942                                             )->KNN$ROUTE.CURRENT_QOS;
     1799    14943    8                                    END;
     1800    14944    7                               END;
     1801    14945    6                          KNN$ROUTE$(I)->KNN$ROUTE.LINK.QOS(LINK#) = 255;
     1802    14946    6                          KNN$ROUTE$(I)->KNN$ROUTE.LINK.ACTIVE(LINK#) = '0'B;
     1803    14947    6                          END;
             14947                          /*  do i = 0 to knn_nodes update route table to reflect new link*/
     1804    14948    5                     RETURN;     /* continue processing like nothing happened    */
     1805    14949    5                     END;
     1806    14950    4                END;                       /* do j = 0 to knn_nodes*/
     1807    14951    4           IF NOT FOUNDONE THEN DO;
     1808    14952    4                FEPST.CHAN# = KNN$LINK.CHAN#;
     1809    14953    4                CALL KNB$WRITE(ADDR(FEPST),SIZEC(FEPST))
     1810    14954    5                WHENALTRETURN DO;
     1811    14955    5                     ALTRETURN;
     1812    14956    5                     END;
     1813    14957    4                END;
     1814    14958    3           END;
     1815    14959
     1816    14960    3      DO I = 0 TO KNN_NODES;
     1817    14961    3           KNN$ROUTE$(I)->KNN$ROUTE.LINK.QOS(LINK#) = 255;
     1818    14962    3           KNN$ROUTE$(I)->KNN$ROUTE.LINK.ACTIVE(LINK#) = '0'B;
     1819    14963    3           END;
     1820    14964
     1821    14965    2      CALL UPDATE_ROUTE
     1822    14966    3      WHENALTRETURN DO;
     1823    14967    3           ALTRETURN;
     1824    14968    3           END;
     1825    14969
     1826    14970    2      RETURN;
     1827    14971
     1828    14972    2   END LINK_DOWN;
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:120  
     1829    14973        %EJECT;
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:121  
     1830    14974    1   OSILINK_UP: PROC;
     1831    14975
     1832    14976    3      DO J = 0 TO KNN_OSIMAX# - 1 ;
     1833    14977    3           OSI$ = KNN$OSIROUTE$(J);
     1834    14978    4           IF KNN$OSIROUTE.NS_TYPE = %K_TYPE_RNSAP THEN DO;
     1835    14979    4                SNPATMPLT1 = KNN$OSIROUTE.SNPA.ADDRESS;
     1836    14980    4                SNPATMPLT3 = SNPA.ADDRESS;
     1837    14981    5                DO I = 0 TO MINIMUM(KNN$OSIROUTE.SNPA.LEN,SNPA.LEN)-1;
     1838    14982    5                     IF SNPATMPLT2.NIBBLES.NIB(I) ~= SNPATMPLT4.NIBBLES.NIB(I) THEN
     1839    14983    5                          GOTO NXTJ2;
     1840    14984    5                     END;                  /* do i = 0 to min(len,len)-1         */
     1841    14985                                                /* found a match                      */
     1842    14986    5                DO I = 0 TO KNN_LINKS - 1;
     1843    14987    6                     IF KNN$OSIROUTE.LINK.FEP#(I) = DEST_NODE THEN DO;
     1844    14988    6                          KNN$OSIROUTE.LINK.ACTIVE(I) = '1'B;
     1845    14989    6                          KNN$OSIROUTE.LINK.QOS(I) = QOS;
     1846    14990    6                          FOUNDONE = '1'B;
     1847    14991    6                          GOTO NXTJ2;
     1848    14992    6                          END;             /* fep# = dest_node                   */
     1849    14993    5                     END;                  /* do I = 0 to knn_links - 1          */
     1850    14994
     1851    14995        /*
     1852    14996             couldn't find a current entry, so lets make one
     1853    14997        */
     1854    14998    5                DO I = 0 TO KNN_LINKS - 1;
     1855    14999    6                     IF NOT KNN$OSIROUTE.LINK.ACTIVE(I) THEN DO;
     1856    15000    6                          KNN$OSIROUTE.LINK.FEP#(I) = DEST_NODE;
     1857    15001    6                          KNN$OSIROUTE.LINK.QOS(I) = QOS;
     1858    15002    6                          KNN$OSIROUTE.LINK.ACTIVE(I) = '1'B;
     1859    15003    6                          GOTO NXTJ2;
     1860    15004    6                          END;
     1861    15005    5                     END;                  /* DO I                               */
     1862    15006                            /* CALL GHS$ERRLOG( no space for osi link up in nsap x)*/
     1863    15007    4                END;                       /* type = rnsap                       */
     1864    15008    3   NXTJ2:  ;
     1865    15009    3           END;                            /* do j                               */
     1866    15010    2   END OSILINK_UP;
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:122  
     1867    15011
     1868    15012        %EJECT;
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:123  
     1869    15013    1   OSILINK_DOWN: PROC;
     1870    15014
     1871    15015
     1872    15016    3      DO J = 0 TO KNN_OSIMAX# - 1 ;
     1873    15017    3           OSI$ = KNN$OSIROUTE$(J);
     1874    15018    4           IF KNN$OSIROUTE.NS_TYPE = %K_TYPE_RNSAP THEN DO;
     1875    15019    4                SNPATMPLT1 = KNN$OSIROUTE.SNPA.ADDRESS;
     1876    15020    4                SNPATMPLT3 = SNPA.ADDRESS;
     1877    15021    5                DO I = 0 TO MINIMUM(KNN$OSIROUTE.SNPA.LEN,SNPA.LEN)-1;
     1878    15022    5                     IF SNPATMPLT2.NIBBLES.NIB(I) ~= SNPATMPLT4.NIBBLES.NIB(I) THEN
     1879    15023    5                          GOTO NXTJ3;
     1880    15024    5                     END;                  /* do i = 0 to min(len,len)-1         */
     1881    15025                                                /* found a match                      */
     1882    15026    5                DO I = 0 TO KNN_LINKS - 1;
     1883    15027    6                     IF KNN$OSIROUTE.LINK.ACTIVE(I) AND KNN$OSIROUTE.LINK.FEP#(I) =
             15027                              DEST_NODE THEN DO;
     1884    15028    6                          KNN$OSIROUTE.LINK.ACTIVE(I) = '0'B;
     1885    15029    6                          KNN$OSIROUTE.LINK.QOS(I) = 255;
     1886    15030    6                          END;             /* fep# = dest_node                   */
     1887    15031    5                     END;                  /* do I = 0 to knn_links - 1          */
     1888    15032
     1889    15033    4                END;                       /* type = rnsap                       */
     1890    15034    3   NXTJ3:  ;
     1891    15035    3           END;                            /* do j                               */
     1892    15036    2   END OSILINK_DOWN;
     1893    15037        %EJECT;
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:124  
     1894    15038    1   BLDOSIHDR: PROC(NETPARM);
     1895    15039
     1896    15040        %KN$NETPARM(NAME=NETPARM,STCLASS="");
     1897    15193    2      RETURN;
     1898    15194    2   END BLDOSIHDR;
     1899    15195    1   SENDESH: PROC;
     1900    15196    2      RETURN;
     1901    15197    2   END SENDESH;
     1902    15198    1   END KNN$RECV;
     1903    15199        %EJECT;
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:125  
     1904    15200        %EOD;

PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:126  
--  Include file information  --

   K_INTERFACE_M.:E05TOU  is referenced.
   K_NETWORK_E.:E05TOU  is referenced.
   K_ADDRESS_M.:E05TOU  is referenced.
   KL_MACRO_C.:E05TOU  is referenced.
   KL_AFCN_C.:E05TOU  is referenced.
   KJ_FCNS_C.:E05TOU  is referenced.
   K_QDPHDRS_M.:E05TOU  is referenced.
   KNN_NETWORK_M.:E05TOU  is referenced.
   KNH_MACRO_C.:E05TOU  is referenced.
   KN_DATA_M.:E05TOU  is referenced.
   GU_LCP6_M.:E05TOU  is referenced.
   K_REASON_C.:E05TOU  is referenced.
   K_SCODE_C.:E05TOU  is referenced.
   KI_SUBS_C.:E05TOU  is referenced.
   KI_CP6.:E05TOU  is referenced.
   GH_GATE_M.:E05TOU  cannot be made into a system file and is referenced.
      No diagnostics issued in procedure KNN$RECV.

   Procedure KNN$RECV requires 4044 words for executable code.
   Procedure KNN$RECV requires 154 words of local(AUTO) storage.

PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:127  

 Object Unit name= KNN$RECV                                   File name= KNN$NETWORK.:E05TOU
 UTS= JUL 30 '97 01:05:20.68 WED                              Compiler= PL-6/E31         Sev=      00
 SharedLib= :SHARED_LCP6_SYSTEM                               Alt SharedLib=


    ****  Control sections  ****

 Sect   Type Bound  Init  Size HexSiz  Section name
    0  RoData even  UTS     22     16  KNN$RECV
    1   Proc  even  none  4044    FCC  KNN$RECV
    2  RoData even  none     8      8  KNN$RECV

    ****  Entry defs  ****

                              Check   Calling
                             calling  sequence
  Sect HexLoc Primary Altret sequence   type   Parms  Name
     1      0   yes    yes     yes      Std        1  KNN$RECV
     1    8A6          yes     yes      Std        1  KNN$OSICHG
     1    A9E          yes     yes      Std        1  KNN$OSILINKCHG
     1    AE0          yes     yes      Std        1  KNN$NODECHG

  ****  Data defs  ****

 Sect HexLoc  Name                           Sect HexLoc  Name
    0     14  KN_SCREECH_HOPCOUNT                0     15  KN_SCREECH
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:128  

  ****  Entry refs  ****

         Check        Calling
        calling       sequence
Altret sequence SRef   type   Args  Name
         yes           Std       1 SCREECH
 yes     yes           Std       1 KNH$SEND
 yes     yes           Std       1 GHH$UNLOCK
 yes     yes           Std       1 KNT$RECV_4HOST
 yes     yes           Std       1 GHH$LOCK
 yes     yes           Std       4 KNB$WRITE
 yes     yes           Std       1 KNN$RECVOSI
 yes     yes           Std       1 KNN$SENDOSI
 yes     yes           Std       2 KNN$DECODE_NSAP
 yes     yes           Std       1 KNT$SEND_4HOST
         yes           Std       1 KNN$SENDTERM_ACK
 yes     yes           Std       1 KNS$RECV
 yes     yes           Std       1 KNT$RECV
 yes     yes           Std       1 KNN$RECV
                       nStd      0 X6A_AUTO_1
                       nStd      0 X6A_ARET
                       nStd      0 X6A_AALT
                       nStd      0 X6C_ACM
                       nStd      0 X6B_BLR

  ****  Data refs  ****

  Flags:  r = read only, s = secondary
Flgs Name                             Flgs Name                             Flgs Name
     KN_NODE#                              KNN_ROUTE$$                           KNN_LINK$$
     KNN_NODES                             KNN_LINKS                             KNN_OSIROUTE$$
     KNN_OSIMAX#                           KNN_LOCK                              KN_NETPARM_INIT
r    G$ROS$
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:129  


      468        1        /*T***********************************************************/
      469        2        /*T*                                                         */
      470        3        /*T* Copyright (c) Bull HN Information Systems Inc., 1997    */
      471        4        /*T*                                                         */
      472        5        /*T***********************************************************/
      473        6
      474        7        /*X* PLM=3,IND=5,ECU=0,ENU=0   */
      475        8
      476        9        KNN$RECV: PROC (KN$NETPARM) ALTRET;

      9   1 000000  D380 0000 0000  xent KNN$RECV        LNJ,B5   X6A_AUTO_1
          1 000003       009A 0001                       DC       154,1

      477       10
      478       11        %INCLUDE GH_GATE_M;
      479       52        %INCLUDE KI_CP6;
      480     1148        %INCLUDE KI_SUBS_C;
      481     1284        %INCLUDE K_SCODE_C;
      482     1369        %INCLUDE K_REASON_C;
      483     1395        %INCLUDE GU_LCP6_M;
      484     2323        %INCLUDE KN_DATA_M;
      485     4109        %INCLUDE KNH_MACRO_C;
      486     4392        %INCLUDE KNN_NETWORK_M;
      487     4755        %INCLUDE K_QDPHDRS_M;
      488     5637        %INCLUDE KJ_FCNS_C;
      489     5664        %INCLUDE KL_AFCN_C;
      490     5765        %INCLUDE KL_MACRO_C;
      491     9117        %INCLUDE K_ADDRESS_M;                   /* osi address macros                 */
      492     9620        %INCLUDE K_NETWORK_E;                   /* osi network equates                */
      493     9709        %INCLUDE K_INTERFACE_M;
      494    10118
      495    10119                                                /* Parameters                         */
      496    10120        %KN$NETPARM (NAME=KN$NETPARM);
      497    10273
      498    10274                                                /* Auto                               */
      499    10275        %KL_FEPST (FPTN=FEPST,STCLASS=AUTO);
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:130  
      500    10310    1   DCL DEST_NODE UBIN;
      501    10311    1   DCL ROUTE$ PTR;
      502    10312    1   DCL LINK$ PTR;
      503    10313    1   DCL LINK# UBIN;
      504    10314    1   DCL LINKIN# UBIN;
      505    10315    1   DCL CLNK# SBIN;               /* current link# on block and unblock functions*/
      506    10316    1   DCL CQOS UBIN;           /* current qos value on block and unblock functions*/
      507    10317    1   DCL QOS UBIN;
      508    10318    1   DCL I UBIN;
      509    10319    1   DCL J UBIN;
      510    10320    1   DCL L SBIN;
      511    10321    1   DCL K SBIN;
      512    10322    1   DCL LEN SBIN;
      513    10323    1   DCL SIZE UBIN;
      514    10324    1   DCL UPDOSI$ PTR;
      515    10325    1   DCL OSI$ PTR;
      516    10326    1   DCL OSIROUTE$ PTR;
      517    10327    1   DCL QQQ$ PTR AUTO;
      518    10328    1   DCL FUNCTION UBIN;
      519    10329    1   DCL SOURCE_NODE UBIN;
      520    10330    1   DCL NWHDR_SZ UBIN;
      521    10331    1   DCL OSILINK# UBIN;
      522    10332    1   DCL OSIADDR# UBIN;
      523    10333    1   DCL FOUNDONE BIT(1);
      524    10334    1   DCL SNPATMPLT1 CHAR(8) ALIGNED;
      525    10335    1   DCL 1 SNPATMPLT2 REDEF SNPATMPLT1 ALIGNED,
      526    10336    1         2 NIBBLES(0:13) UNAL,
      527    10337    1           3 NIB UBIN(4) UNAL;
      528    10338
      529    10339    1   DCL SNPATMPLT3 CHAR(8) ALIGNED;
      530    10340    1   DCL 1 SNPATMPLT4 REDEF SNPATMPLT3 ALIGNED,
      531    10341    1         2 NIBBLES(0:13) UNAL,
      532    10342    1           3 NIB UBIN(4) UNAL;
      533    10343        %KL_UPDOSI(FPTN=UPDOSI,ADRTYP=NET,STCLASS=AUTO); /* the biggest one           */
      534    10552        %KL_UPDOSI(FPTN=ROUTE,ADRTYP=NET,STCLASS="REDEF UPDOSI");
      535    10761        %KL_OSILINKCHG(FPTN=OSILINKCHG,STCLASS=AUTO);
      536    10884        %K$SNPA(FPTN=SNPA,STCLASS=AUTO);
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:131  
      537    10914        %FPT_CONNECT_ACK(FPTN=FPT@ACK,STCLASS=AUTO);
      538    10963        %KN$NETPARM(NAME=KN@NETPARM,STCLASS=AUTO); /*for local use                    */
      539    11116
      540    11117                                                /* External Data                      */
      541    11118    1   DCL KN_NODE# UBIN SYMREF;
      542    11119    1   DCL KNN_ROUTE$$ PTR SYMREF;
      543    11120    1   DCL KNN_LINK$$ PTR SYMREF;
      544    11121    1   DCL KNN_NODES UBIN SYMREF;
      545    11122    1   DCL KNN_LINKS UBIN SYMREF;
      546    11123    1   DCL KNN_OSIROUTE$$ PTR SYMREF;
      547    11124    1   DCL KNN_OSIROUTE# UBIN SYMREF;
      548    11125    1   DCL KNN_OSIMAX# UBIN SYMREF;
      549    11126        %GATE (FPTN=KNN_LOCK, STCLASS=SYMREF);
      550    11145        %KN$NETPARM (NAME=KN_NETPARM_INIT, STCLASS=SYMREF);
      551    11298
      552    11299                                                /* Internal Data                      */
      553    11300
      554    11301        %VLP_SCODE (FPTN=PRTCLERR,ERR#=%S$PRTCLERR,SEV=G_SEV_SCREECH#,
      555    11302                       STCLASS=CONSTANT,FCG=KN,MID=N,MON='1'B);
      556    11363
      557    11364        %VLP_SCODE (FPTN=BADFNC,ERR#=%S$BADFNC,SEV=G_SEV_SCREECH#,
      558    11365                       STCLASS=CONSTANT,FCG=KN,MID=N,MON='1'B);
      559    11426
      560    11427        %FPT_CONNECT_ACK (FPTN=FPT_ACK, STCLASS=CONSTANT);
      561    11476        %FPT_CONNECT_ACK (FPTN=FPT_NAK, STCLASS=CONSTANT, REASON=%K_REASON_NOLDCT);
      562    11525        %FPT_TERM_ACK(FPTN=FPT@TERM_ACK,STCLASS=CONSTANT);
      563    11547
      564    11548    1   DCL KN_SCREECH_HOPCOUNT UBIN CONSTANT SYMDEF INIT(0);
      565    11549    1   DCL KN_SCREECH UBIN CONSTANT SYMDEF INIT(0); /* if set screech on error flag  */
      566    11550
      567    11551
      568    11552                                                /* Entry references                   */
      569    11553    1   DCL KNS$RECV ENTRY(1) ALTRET;
      570    11554    1   DCL KNT$RECV ENTRY(1) ALTRET;
      571    11555    1   DCL KNH$SEND ENTRY(1) ALTRET;
      572    11556    1   DCL KNB$WRITE ENTRY(4) ALTRET;
      573    11557    1   DCL SCREECH ENTRY(1);
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:132  
      574    11558    1   DCL KNT$RECV_4HOST ENTRY(1) ALTRET;
      575    11559    1   DCL KNT$SEND_4HOST ENTRY(1) ALTRET;
      576    11560    1   DCL KNN$DECODE_NSAP ENTRY(2) ALTRET;
      577    11561    1   DCL KNN$RECVOSI ENTRY(1) ALTRET;
      578    11562    1   DCL KNN$SENDOSI ENTRY(1) ALTRET;
      579    11563    1   DCL KNN$SENDTERM_ACK ENTRY(1);
      580    11564
      581    11565
      582    11566                                                /* Based structures                   */
      583    11567    1   DCL KNN$ROUTE$(0:0) PTR BASED(KNN_ROUTE$$);
      584    11568    1   DCL KNN$LINK$(0:0) PTR BASED(KNN_LINK$$);
      585    11569        %KNN$ROUTE (STCLASS="BASED(ROUTE$)");
      586    11641        %KNN$LINK (STCLASS="BASED(LINK$)");
      587    11892        %KN$LDCT (STCLASS="BASED(KN$NETPARM.LDCT$)");
      588    12137        %KL_NODECHG (FPTN=KL$NODECHG,STCLASS="BASED(KN$NETPARM.FPT$)");
      589    12161        %K$NQDP_HDR (NAME=B$QDP_HDR, STCLASS="BASED(KN$NETPARM.NHDR$)");
      590    12238        %K$NQDP_HDR(NAME=B$OSI_HDR,STCLASS="BASED(KN$NETPARM.NHDR$)",MSGTYPE=OSI_INIT);
      591    12583        %FPT_CONNECT (ADRTYP=NET,STCLASS="BASED(KN$NETPARM.FPT$)");
      592    12754        %FPT_CONNECT (FPTN=FPT$CONNECT,ADRTYP=NONE,STCLASS="BASED(KN$NETPARM.FPT$)");
      593    12823        %FPT_CONNECT_ACK(STCLASS="BASED(KN$NETPARM.FPT$)");
      594    12872        %K$NSAP(FPTN=SRC,ADRTYP=NET,STCLASS="BASED(KN$NETPARM.SRC_ADDR$)");
      595    12924        %K$NSAP(FPTN=DST,ADRTYP=NET,STCLASS="BASED(KN$NETPARM.DST_ADDR$)");
             12924            /* network entity title is the largest type of nsap*/
      596    12976    1   DCL ADDRESS CHAR(SIZE) BASED ALIGNED;
      597    12977        %KNH@UID(FPTN=KNH$UID,STCLASS=BASED);
      598    13004    1   DCL KNN$OSIROUTE$(0:0) PTR BASED(KNN_OSIROUTE$$);
      599    13005        %KNN$OSIROUTE(STCLASS="BASED(OSI$)");
      600    13222        %KL_UPDOSI(FPTN=KL$UPDOSI,ADRTYP=NET,STCLASS="BASED(KN$NETPARM.FPT$)");
      601    13431        %KL_OSILINKCHG(FPTN=KL$OSILINKCHG,STCLASS="BASED(KN$NETPARM.FPT$)");
      602    13554
      603    13555    1   DCL 1 ADDRTMPLT ALIGNED BASED(UPDOSI$),
      604    13556    1         2 BYT(0:50),
      605    13557    1           3 HIGH BIT(4) UNAL,
      606    13558    1           3 LOW  BIT(4) UNAL;
      607    13559
      608    13560    1   DCL 1 ADDRTMPLT1 ALIGNED BASED(OSIROUTE$),
      609    13561    1         2 BYT(0:50),
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:133  
      610    13562    1           3 HIGH BIT(4) UNAL,
      611    13563    1           3 LOW BIT(4)  UNAL;
      612    13564        %EJECT;
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:134  
      613    13565
      614    13566
      615    13567        /*F* NAME: KNN$RECV Inbound Messages
      616    13568
      617    13569        KNN$RECV is called from KNH$SCAN.  It is used to pass
      618    13570        incoming messages on up through the transport and session
      619    13571        layers.
      620    13572
      621    13573        KNN$RECV is called from KNH$SCAN with the following parameters:
      622    13574
      623    13575        .fif
      624    13576        } KN$NETPARM.FUNCTION
      625    13577        }                - The function to be performed.  This will be one of the
      626    13578        }                  folowing EQUed values from the file KNH_MACRO_M:
      627    13579        }                      KN_FCN_INIT
      628    13580        }                      KN_FCN_INIT_ACK
      629    13581        }                      KN_FCN_DATA
      630    13582        }                      KN_FCN_TERM
      631    13583        }                      KN_FCN_UNQ
      632    13584        }                      KN_FCN_BLOCK
      633    13585        }                      KN_FCN_UNBLOCK
      634    13586        }
      635    13587        } KN$NETPARM.RECTYPE - contains ????
      636    13588        }
      637    13589        } KN$NETPARM.LDCT$ - contains the LDCT of the destination end-point.
      638    13590        }                    This has been initialized using KNH$MESS.LDCTX.
      639    13591        }
      640    13592        } KN$NETPARM.NHDR$ - and .NHDRSZ frame the entire message,
      641    13593        }                  including the headers for the various layers.
      642    13594        }
      643    13595        } KN$NETPARM.FPT$ - Contains the address of FPT_CONNECT
      644    13596        }                 - Only used when FUNCTION is INIT.  The format
      645    13597        }                   of the FPT is described by the FPT_CONNECT macro.
      646    13598        }
      647    13599        .fin
      648    13600        The action taken by KNN$RECV is dependent on the value of FUNCTION.
      649    13601        */
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:135  
      650    13602
      651    13603
      652    13604    1      FUNCTION = KN$NETPARM.FUNCTION;

  13604   1 000005  ECC7 0004                            LDB,B6   @KN$NETPARM,AUTO
          1 000007  E846 0014                            LDR,R6   20,B6
          1 000009  EF47 0025                            STR,R6   FUNCTION,AUTO

      653    13605    1      IF FUNCTION = %KN_FCN_DATA

  13605   1 00000B  6D05                                 CMV,R6   5
          1 00000C  0901 02D0                            BE       s:13929,PREL

      654    13606    1      THEN GOTO RECEIVE_DATA;              /*fast path*/
      655    13607
      656    13608    1      IF FUNCTION > %KN_FCN_MAX

  13608   1 00000E  6D0F                                 CMV,R6   15
          1 00000F  0381 000A                            BLE      s:13611,PREL

      657    13609    1      THEN CALL SCREECH(BADFNC);

  13609   1 000011  BB80 0000 0000  02                   LAB,B3   0
          1 000014  CBF0 0100                            LAB,B4   256,IMO
          1 000016  E380 0000 0000  xent                 LNJ,B6   SCREECH
          1 000019       0001                            DC       s:13611,PREL

      658    13610
      659    13611    2      DO CASE (FUNCTION);

  13611   1 00001A  B847 0025                            LDR,R3   FUNCTION,AUTO
          1 00001C  3D0D                                 CMV,R3   13
          1 00001D  0281 087C                            BGE      s:14505,PREL
          1 00001F  A830 0000 0025  01                   LDR,R2   s:13611+11,R3
          1 000022  83A0 0000 0032  01                   JMP      s:13644,R2
          1 000025       0868                            DC       s:14505,PREL
          1 000026       0000                            DC       s:13644,PREL
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:136  
          1 000027       0235                            DC       s:13865,PREL
          1 000028       05F4                            DC       s:14280,PREL
          1 000029       0868                            DC       s:14505,PREL
          1 00002A       02AB                            DC       s:13929,PREL
          1 00002B       0868                            DC       s:14505,PREL
          1 00002C       0868                            DC       s:14505,PREL
          1 00002D       05BE                            DC       s:14236,PREL
          1 00002E       0868                            DC       s:14505,PREL
          1 00002F       0868                            DC       s:14505,PREL
          1 000030       0743                            DC       s:14398,PREL
          1 000031       0819                            DC       s:14466,PREL

      660    13612
      661    13613        /*F* NAME: KNN$RECV - Initiate Connection
      662    13614
      663    13615        KNN$RECV is called from KNH$SCAN with the function set to
      664    13616        INIT when the scanning has found an INIT message
      665    13617        and the FPT_CONNECT in the message has .TYPE set to LINK.
      666    13618
      667    13619        The number of the connecting node is in FPT_CONNECT.RLCID.NODE.
      668    13620
      669    13621        KNN$RECV finds an unused entry in the KNN$LINK table and stores
      670    13622        the address of the LINK type LDCT in KNN$LINK.LDCT$.
      671    13623        The index to the Link Table entry is remembered in LDCT.LINK_ID.
      672    13624
      673    13625        The node number in KNN$LINK is initialized from the value supplied
      674    13626        in FPT_CONNECT.RLCID.NODE.
      675    13627
      676    13628        The "connected" bit in the KNN$ROUTE table entry for the connecting
      677    13629        node is turned on.  The HOST_NODE bit is turned on in both the Link
      678    13630        Table Entry and the Route Table entry if it is set in the FPT.
      679    13631
      680    13632        *** internal call to link_active - lets nodeadmn know.
      681    13633        *** internal call to update_route
      682    13634
      683    13635        An INIT_ACK message is returned by calling KNH$SEND.
      684    13636        */
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:137  
      685    13637
      686    13638    2       CASE (%KN_FCN_INIT);

      687    13639              %LOCK(G=KNN_LOCK);

  13644   1 000032  BB80 0000 0002  02                   LAB,B3   +2
          1 000035  CBF0 0100                            LAB,B4   256,IMO
          1 000037  E380 0000 0000  xent                 LNJ,B6   GHH$LOCK
          1 00003A       0001                            DC       s:13646,PREL

      688    13646    2         IF FPT_CONNECT.DEST.AFI ~= 0

  13646   1 00003B  ECC7 0004                            LDB,B6   @KN$NETPARM,AUTO
          1 00003D  DCC6 0019                            LDB,B5   25,B6
          1 00003F  82C5 0013                            LB,'00FF'X        19,B5
          1 000041       00FF
          1 000042  0581 00C2                            BBF      s:13729,PREL
          1 000044  8CC6 0005                            LDI      5,B6
          1 000046  84C6 0019                            SID      25,B6
          1 000048  84F0 0000 0013                       SID      19,IMO
          1 00004B  6801 00B9                            BLZ,R6   s:13729,PREL
          1 00004D  6A01 0003                            BGZ,R6   s:13653,PREL
          1 00004F  7901 00B5                            BEZ,R7   s:13729,PREL

      689    13647    3           AND POFFW(KN$NETPARM.UHDR$,KN$NETPARM.FPT$) > SIZEW(FPT$CONNECT) THEN DO;

      690    13648                   /*
      691    13649                    if the afi is non-zero and the fpt is large enough to contain addresses
      692    13650                      then, in all likely hood, an address has been specified.  This is
      693    13651                      probably a OSI CONS connection being attempted
      694    13652                   */
      695    13653    4              CALL KNN$DECODE_NSAP(FPT_CONNECT.DEST,ROUTE) WHENALTRETURN DO;

  13653   1 000051  CBC7 0033                            LAB,B4   UPDOSI,AUTO
          1 000053  CFC7 0096                            STB,B4   ALTQOS+4,AUTO
          1 000055  BBC5 0013                            LAB,B3   19,B5
          1 000057  BFC7 0094                            STB,B3   ALTQOS+2,AUTO
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:138  
          1 000059  BBC7 0094                            LAB,B3   ALTQOS+2,AUTO
          1 00005B  CBF0 0200                            LAB,B4   512,IMO
          1 00005D  E380 0000 0000  xent                 LNJ,B6   KNN$DECODE_NSAP
          1 000060       0003                            DC       s:13654,PREL
          1 000061  0F81 0028                            B        s:13669,PREL

      696    13654    4                   FPT@ACK.REASON = %K_REASON_NORTE;

  13654   1 000063  6C02                                 LDV,R6   2
          1 000064  EF47 0065                            STR,R6   FPT@ACK,AUTO

      697    13655    4   FPT_NAK:        KN$NETPARM.NHDR$ = ADDR(NIL);

  13655   1 000066  EB80 0000 0000       FPT_NAK         LAB,B6   0
          1 000069  DCC7 0004                            LDB,B5   @KN$NETPARM,AUTO
          1 00006B  EFC5 000E                            STB,B6   14,B5

      698    13656    4                   KN$NETPARM.NHDRSZ = 0;

  13656   1 00006D  8745 0010                            CL       16,B5

      699    13657    4                   KN$NETPARM.FUNCTION = %KN_FCN_INIT_ACK;

  13657   1 00006F  6C02                                 LDV,R6   2
          1 000070  EF45 0014                            STR,R6   20,B5

      700    13658    4                   KN$NETPARM.FPT$ = ADDR(FPT@ACK);

  13658   1 000072  CBC7 0065                            LAB,B4   FPT@ACK,AUTO
          1 000074  CFC5 0019                            STB,B4   25,B5

      701    13659    4                   CALL KNH$SEND(KN$NETPARM);

  13659   1 000076  BBC7 0004                            LAB,B3   @KN$NETPARM,AUTO
          1 000078  CBF0 0100                            LAB,B4   256,IMO
          1 00007A  E380 0000 0000  xent                 LNJ,B6   KNH$SEND
          1 00007D       0001                            DC       s:13665,PREL
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:139  

      702    13660                        %UNLOCK(G=KNN_LOCK);

  13665   1 00007E  BB80 0000 0002  02                   LAB,B3   +2
          1 000081  CBF0 0100                            LAB,B4   256,IMO
          1 000083  E380 0000 0000  xent                 LNJ,B6   GHH$UNLOCK
          1 000086       0001                            DC       s:13667,PREL

      703    13667    4                   RETURN;

  13667   1 000087  C380 0000 0000  xent                 LNJ,B4   X6A_ARET

      704    13668    4                   END;
      705    13669    3              IF ROUTE.FEP# = KN_NODE# THEN

  13669   1 00008A  E847 0034                            LDR,R6   UPDOSI+1,AUTO
          1 00008C  E570 00FF                            AND,R6   255,IMO
          1 00008E  E900 0000 0000  xsym                 CMR,R6   KN_NODE#
          1 000091  0981 0007                            BNE      s:13672,PREL

      706    13670    3                   DEST_NODE = ROUTE.HOST#;

  13670   1 000093  D2C7 0034                            LLH,R5   UPDOSI+1,AUTO
          1 000095  DF47 000D                            STR,R5   DEST_NODE,AUTO
          1 000097  0F81 0003                            B        s:13673,PREL

      707    13671    3              ELSE
      708    13672    3                   DEST_NODE = ROUTE.FEP#;

  13672   1 000099  EF47 000D                            STR,R6   DEST_NODE,AUTO

      709    13673    4              IF ROUTE.FEP# >= KNN_NODES OR ROUTE.QOS = 255 THEN DO;

  13673   1 00009B  E900 0000 0000  xsym                 CMR,R6   KNN_NODES
          1 00009E  0281 0009                            BGE      s:13674,PREL
          1 0000A0  D847 0035                            LDR,R5   UPDOSI+2,AUTO
          1 0000A2  D570 00FF                            AND,R5   255,IMO
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:140  
          1 0000A4  D970 00FF                            CMR,R5   255,IMO
          1 0000A6  0981 0006                            BNE      s:13677,PREL

      710    13674    4                   FPT@ACK.REASON = %K_REASON_NORTE;

  13674   1 0000A8  5C02                                 LDV,R5   2
          1 0000A9  DF47 0065                            STR,R5   FPT@ACK,AUTO

      711    13675    4                   GOTO FPT_NAK;

  13675   1 0000AB  0F81 FFBA                            B        s:13655,PREL

      712    13676    4                   END;
      713    13677    3              ROUTE$ = KNN$ROUTE$(DEST_NODE);

  13677   1 0000AD  EC80 0000 0000  xsym                 LDB,B6   KNN_ROUTE$$
          1 0000B0  B847 000D                            LDR,R3   DEST_NODE,AUTO
          1 0000B2  DCB6                                 LDB,B5   ,B6,R3
          1 0000B3  DFC7 000E                            STB,B5   ROUTE$,AUTO

      714    13678    4             IF KNN$ROUTE.LINK$ = ADDR(NIL) OR KNN$ROUTE.LINK$->KNN$LINK.LDCT$ = ADDR(
             13678                       NIL) THEN DO;

  13678   1 0000B5  8D85                                 CMN      ,B5
          1 0000B6  0901 0005                            BE       s:13679,PREL
          1 0000B8  CC85                                 LDB,B4   ,B5
          1 0000B9  8D84                                 CMN      ,B4
          1 0000BA  0981 0006                            BNE      s:13682,PREL

      715    13679    4                   FPT@ACK.REASON = %K_REASON_NORTE;

  13679   1 0000BC  4C02                                 LDV,R4   2
          1 0000BD  CF47 0065                            STR,R4   FPT@ACK,AUTO

      716    13680    4                   GOTO FPT_NAK;

  13680   1 0000BF  0F81 FFA6                            B        s:13655,PREL
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:141  

      717    13681    4                   END;
      718    13682    4              IF KNN$ROUTE.FLAGS.LINK_CONNECTED AND KNN$ROUTE.FLAGS.HOST_NODE THEN DO;

  13682   1 0000C1  82C5 0007                            LB,'4000'X        7,B5
  13682   1 0000C3       4000
          1 0000C4  0581 0029                            BBF      s:13699,PREL
          1 0000C6  89C5 0007                            CMZ      7,B5
          1 0000C8  0881 0025                            BAGE     s:13699,PREL

      719    13683                         /*
      720    13684                   this is really a OSI CONS connection destined for a link connected host.
      721    13685                               Change the ldct type to circuit and call recv4_host
      722    13686                         */
      723    13687    4                   KN$LDCT.CONN_TYPE = %KN_CNTYPE_CIRCUIT;

  13687   1 0000CA  BCC7 0004                            LDB,B3   @KN$NETPARM,AUTO
          1 0000CC  AC83                                 LDB,B2   ,B3
          1 0000CD  4C07                                 LDV,R4   7
          1 0000CE  C782                                 STH,R4   ,B2

      724    13688    4                   KN$LDCT.STATE = %KN_ST_OPEN;

  13688   1 0000CF  EC83                                 LDB,B6   ,B3
          1 0000D0  6C08                                 LDV,R6   8
          1 0000D1  EA86                                 SRM,R6,'00FF'X    ,B6
          1 0000D2       00FF

      725    13689    4                   KN$NETPARM.FUNCTION = %K_NCONNECT_IND;

  13689   1 0000D3  5C1F                                 LDV,R5   31
          1 0000D4  DF43 0014                            STR,R5   20,B3

      726    13690    4                   KN$NETPARM.NODE = DEST_NODE;

  13690   1 0000D6  BF43 0015                            STR,R3   21,B3

PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:142  
      727    13691    5                   CALL KNT$RECV_4HOST(KN$NETPARM) WHENALTRETURN DO;

  13691   1 0000D8  BBC7 0004                            LAB,B3   @KN$NETPARM,AUTO
          1 0000DA  CBF0 0100                            LAB,B4   256,IMO
          1 0000DC  E380 0000 0000  xent                 LNJ,B6   KNT$RECV_4HOST
          1 0000DF       0003                            DC       s:13692,PREL
          1 0000E0  0F81 0009                            B        s:13695,PREL

      728    13692    5                        FPT@ACK.REASON = KN$NETPARM.ERRCODE;

  13692   1 0000E2  ECC7 0004                            LDB,B6   @KN$NETPARM,AUTO
          1 0000E4  E846 0016                            LDR,R6   22,B6
          1 0000E6  EF47 0065                            STR,R6   FPT@ACK,AUTO

      729    13693    5                        GOTO FPT_NAK;

  13693   1 0000E8  0F81 FF7D                            B        s:13655,PREL

      730    13694    5                        END;
      731    13695    4                   FPT@ACK.REASON = %K_REASON_NORMAL; /* implied k_nconnect_rsp*/

  13695   1 0000EA  8747 0065                            CL       FPT@ACK,AUTO

      732    13696    4                   GOTO FPT_NAK;

  13696   1 0000EC  0F81 FF79                            B        s:13655,PREL

      733    13697    4                   END;
      734    13698    4              ELSE DO;

      735    13699    5                   IF KNN$ROUTE.LINK$->KNN$LINK.FLAGS.HOST_NODE THEN DO;

  13699   1 0000EE  89C4 0003                            CMZ      3,B4
          1 0000F0  0881 0006                            BAGE     s:13713,PREL

      736    13700                            /*
      737    13701                               this OSI CONS connection is being attempted thru a host.
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:143  
      738    13702                               Due to the datagram nature of the host network, this
      739    13703                               type of connection is not allowed.
      740    13704                            */
      741    13705    5                        FPT@ACK.REASON = %K_REASON_NORTE;

  13705   1 0000F2  4C02                                 LDV,R4   2
          1 0000F3  CF47 0065                            STR,R4   FPT@ACK,AUTO

      742    13706    5                        GOTO FPT_NAK;

  13706   1 0000F5  0F81 FF70                            B        s:13655,PREL

      743    13707    5                        END;
      744    13708    5                   ELSE DO;

      745    13709                            /*
      746    13710                            connection needs to be forwared to the next hop.
      747    13711                            return the link uid # to hdlc with reason=redirect.
      748    13712                            */
      749    13713    5                        FPT@ACK.REASON = %K_REASON_REDIRECT;

  13713   1 0000F7  4C06                                 LDV,R4   6
          1 0000F8  CF47 0065                            STR,R4   FPT@ACK,AUTO

      750    13714    5                        FPT@ACK.UID.UIDX.CQ_HNDCTXID = ADDR(KNN$ROUTE.LINK$->KNN$LINK.
             13714                                 LDCT$->KN$LDCT.UID)->KNH$UID.UIDX.CQ_HNDCTXID;

  13714   1 0000FA  CC85                                 LDB,B4   ,B5
          1 0000FB  BC84                                 LDB,B3   ,B4
          1 0000FC  AB83                                 LAB,B2   ,B3
          1 0000FD  2C0B                                 LDV,R2   11
          1 0000FE  6C03                                 LDV,R6   3
          1 0000FF  BBC7 0068                            LAB,B3   FPT@ACK+3,AUTO
          1 000101  3C01                                 LDV,R3   1
          1 000102  0008                                 MMM

      751    13715    5                        GOTO FPT_NAK;
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:144  
             13715                             /* altret to get rid of the ldct, which we dont need anymore*/

  13715   1 000103  0F81 FF62                            B        s:13655,PREL

      752    13716    5                        END;
      753    13717    4                   END;
      754    13718    3              END;
      755    13719        /*
      756    13720                  the afi = 0, therefore use the node# to determine the type of connection.
      757    13721               k_cnc_is(253?) indicates that this is a connection to a intermediate system.
      758    13722              and an end-system-hello pdu needs to be generated. k_cnc_other(254) indicates
      759    13723                     that some other type of non-cp6 vc is logging on.
      760    13724        */
      761    13725        /*
      762    13726                   This is either an hdlc link level connection or a coupler connection
      763    13727                   to the host.
      764    13728        */
      765    13729    2         IF NOT FPT_CONNECT.RLCID.FLAGS.VIRCIR

  13729   1 000105  82C5 000E                            LB,'4000'X        14,B5
  13729   1 000107       4000
          1 000108  0501 000B                            BBT      s:13734,PREL
          1 00010A  89C5 000E                            CMZ      14,B5
          1 00010C  0801 0007                            BAL      s:13734,PREL

      766    13730    2           AND NOT FPT_CONNECT.RLCID.FLAGS.HOST_NODE
      767    13731    2         THEN
      768    13732    2              DEST_NODE = %K_CNC_LINK#;    /*link level connection*/

  13732   1 00010E  E870 00FF                            LDR,R6   255,IMO
          1 000110  EF47 000D                            STR,R6   DEST_NODE,AUTO
          1 000112  0F81 0005                            B        s:13736,PREL

      769    13733    2         ELSE
      770    13734    2              DEST_NODE = FPT_CONNECT.RLCID.NODE;

  13734   1 000114  E2C5 000D                            LLH,R6   13,B5
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:145  
          1 000116  EF47 000D                            STR,R6   DEST_NODE,AUTO

      771    13735
      772    13736    3         DO LINK# = 0 TO KNN_LINKS-1;

  13736   1 000118  8747 0012                            CL       LINK#,AUTO
          1 00011A  0F81 000E                            B        s:13740+2,PREL

      773    13737    3              LINK$ = KNN$LINK$(LINK#);

  13737   1 00011C  EC80 0000 0000  xsym                 LDB,B6   KNN_LINK$$
          1 00011F  B847 0012                            LDR,R3   LINK#,AUTO
          1 000121  DCB6                                 LDB,B5   ,B6,R3
          1 000122  DFC7 0010                            STB,B5   LINK$,AUTO

      774    13738    3              IF KNN$LINK.LDCT$ = ADDR(NIL) /* Found a free one                  */

  13738   1 000124  8D85                                 CMN      ,B5
          1 000125  0901 002E                            BE       s:13748,PREL

      775    13739    3              THEN GOTO FOUND_LINK;
      776    13740    3              END;

  13740   1 000127  8AC7 0012                            INC      LINK#,AUTO
          1 000129  E847 0012                            LDR,R6   LINK#,AUTO
          1 00012B  E900 0000 0000  xsym                 CMR,R6   KNN_LINKS
          1 00012E  026E                                 BL       s:13737,SPREL

      777    13741
      778    13742        /* If there is no available entry in the KNN$LINK table, return
      779    13743           an INIT_ACK with FPT_CONNECT_ACK.REASON non-zero.  Then altreturn.
      780    13744        */
      781    13745    2         KN$NETPARM.NHDR$ = ADDR(NIL);

  13745   1 00012F  EB80 0000 0000                       LAB,B6   0
          1 000132  DCC7 0004                            LDB,B5   @KN$NETPARM,AUTO
          1 000134  EFC5 000E                            STB,B6   14,B5
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:146  

      782    13746    2         KN$NETPARM.NHDRSZ = 0;

  13746   1 000136  8745 0010                            CL       16,B5

      783    13747    2         KN$NETPARM.FUNCTION = %KN_FCN_INIT_ACK;

  13747   1 000138  5C02                                 LDV,R5   2
          1 000139  DF45 0014                            STR,R5   20,B5

      784    13748    2         KN$NETPARM.FPT$ = ADDR(FPT_NAK);

  13748   1 00013B  CB80 0000 000C  00                   LAB,B4   FPT_NAK
          1 00013E  CFC5 0019                            STB,B4   25,B5

      785    13749
      786    13750    2         CALL KNH$SEND(KN$NETPARM);

  13750   1 000140  BBC7 0004                            LAB,B3   @KN$NETPARM,AUTO
          1 000142  CBF0 0100                            LAB,B4   256,IMO
          1 000144  E380 0000 0000  xent                 LNJ,B6   KNH$SEND
          1 000147       0001                            DC       s:13756,PREL

      787    13751              %UNLOCK (G=KNN_LOCK);

  13756   1 000148  BB80 0000 0002  02                   LAB,B3   +2
          1 00014B  CBF0 0100                            LAB,B4   256,IMO
          1 00014D  E380 0000 0000  xent                 LNJ,B6   GHH$UNLOCK
          1 000150       0001                            DC       s:13758,PREL

      788    13758    2         ALTRETURN;

  13758   1 000151  C380 0000 0000  xent                 LNJ,B4   X6A_AALT

  13748   1                              FOUND_LINK      null
      789    13759
      790    13760    2   FOUND_LINK:;
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:147  
      791    13761    2         KNN$LINK = '0'B;

  13761   1 000154  5C4C                 FOUND_LINK      LDV,R5   76
          1 000155  0021                                 ALR      ;
          1 000156       4178 0000                                ALPHANUM('0000'X,IMO,,1),;
          1 000158       4005 0000                                ALPHANUM(0,B5,,R5,FILL)

      792    13762    2         KNN$LINK.LDCT$ = KN$NETPARM.LDCT$;

  13762   1 00015A  437F                                 CSYNC    s:13748+5,SPREL
          1 00015B  ECC7 0004                            LDB,B6   @KN$NETPARM,AUTO
          1 00015D  DC86                                 LDB,B5   ,B6
          1 00015E  CCC7 0010                            LDB,B4   LINK$,AUTO
          1 000160  DF84                                 STB,B5   ,B4

      793    13763    2         QOS = FPT_CONNECT.SERVICE;

  13763   1 000161  BCC6 0019                            LDB,B3   25,B6
          1 000163  E843 0010                            LDR,R6   16,B3
          1 000165  E570 00FF                            AND,R6   255,IMO
          1 000167  EF47 0016                            STR,R6   QOS,AUTO

      794    13764    2         KNN$LINK.QOS = QOS;

  13764   1 000169  EF44 0004                            STR,R6   4,B4

      795    13765    2         KNN$LINK.NODE# = DEST_NODE;

  13765   1 00016B  C847 000D                            LDR,R4   DEST_NODE,AUTO
          1 00016D  CF44 0002                            STR,R4   2,B4

      796    13766    2         KNN$LINK.FLAGS.HOST_NODE = FPT_CONNECT.RLCID.FLAGS.HOST_NODE;

  13766   1 00016F  BCC6 0019                            LDB,B3   25,B6
          1 000171  B843 000E                            LDR,R3   14,B3
          1 000173  BAC4 0003                            SRM,R3,'8000'X    3,B4
          1 000175       8000
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:148  

      797    13767    2         KNN$LINK.CHAN# = FPT_CONNECT.TERMINAL_ID.TERM.CHANNEL;

  13767   1 000176  BCC6 0019                            LDB,B3   25,B6
          1 000178  B843 0006                            LDR,R3   6,B3
          1 00017A  BF44 0023                            STR,R3   35,B4

      798    13768    2         KNN$LINK.SNPA = FPT_CONNECT.DSTSNPA;

  13768   1 00017C  BCC6 0019                            LDB,B3   25,B6
          1 00017E  AB83                                 LAB,B2   ,B3
          1 00017F  2C52                                 LDV,R2   82
          1 000180  6C08                                 LDV,R6   8
          1 000181  BB84                                 LAB,B3   ,B4
          1 000182  3C3E                                 LDV,R3   62
          1 000183  0008                                 MMM

      799    13769    2         KNN$LINK.FLAGS.VIRCIR = FPT_CONNECT.RLCID.FLAGS.VIRCIR;

  13769   1 000184  DCC6 0019                            LDB,B5   25,B6
          1 000186  E845 000E                            LDR,R6   14,B5
          1 000188  6042                                 SOR,R6   2
          1 000189  ACC7 0010                            LDB,B2   LINK$,AUTO
          1 00018B  EAC2 0003                            SRM,R6,'1000'X    3,B2
          1 00018D       1000

      800    13770
      801    13771    3         IF DEST_NODE < %K_CNC_IS# THEN DO;

  13771   1 00018E  E847 000D                            LDR,R6   DEST_NODE,AUTO
          1 000190  E970 00FD                            CMR,R6   253,IMO
          1 000192  0281 000F                            BGE      s:13776,PREL

      802    13772    3              KNN$ROUTE$(DEST_NODE)->KNN$ROUTE.FLAGS.HOST_NODE = KNN$LINK.FLAGS.
             13772                       HOST_NODE;

  13772   1 000194  DC80 0000 0000  xsym                 LDB,B5   KNN_ROUTE$$
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:149  
          1 000197  B856                                 LDR,R3   R6
          1 000198  9CB5                                 LDB,B1   ,B5,R3
          1 000199  C842 0003                            LDR,R4   3,B2
          1 00019B  CAC1 0007                            SRM,R4,'8000'X    7,B1
          1 00019D       8000

      803    13773    3              KNN$ROUTE$(DEST_NODE)->KNN$ROUTE.FLAGS.LINK_CONNECTED = '1'B;

  13773   1 00019E  9CB5                                 LDB,B1   ,B5,R3
          1 00019F  8941 0007                            LBT,'4000'X       7,B1
          1 0001A1       4000

      804    13774    3              END;

      805    13775
      806    13776    2         KN$LDCT.LINK_ID = LINK#;

  13776   1 0001A2  DC86                                 LDB,B5   ,B6
          1 0001A3  C847 0012                            LDR,R4   LINK#,AUTO
          1 0001A5  CF45 0003                            STR,R4   3,B5

      807    13777
      808    13778    3         IF DEST_NODE < %K_CNC_IS# THEN DO;

  13778   1 0001A7  0281 0018                            BGE      s:13793,PREL

      809    13779    3              CALL LINK_ACTIVE

  13779   1 0001A9  E3C0 0B05                            LNJ,B6   s:0,PREL
          1 0001AB       0003                            DC       s:13781,PREL
          1 0001AC  0F81 0013                            B        s:13793,PREL

      810    13780    4              WHENALTRETURN DO;

      811    13781    4                   KNN$LINK.LDCT$ = ADDR(NIL);

  13781   1 0001AE  EB80 0000 0000                       LAB,B6   0
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:150  
          1 0001B1  DCC7 0010                            LDB,B5   LINK$,AUTO
          1 0001B3  EF85                                 STB,B6   ,B5

      812    13782                        %UNLOCK (G=KNN_LOCK);

  13787   1 0001B4  BB80 0000 0002  02                   LAB,B3   +2
          1 0001B7  CBF0 0100                            LAB,B4   256,IMO
          1 0001B9  E380 0000 0000  xent                 LNJ,B6   GHH$UNLOCK
          1 0001BC       0001                            DC       s:13789,PREL

      813    13789    4                   ALTRETURN;

  13789   1 0001BD  C380 0000 0000  xent                 LNJ,B4   X6A_AALT

      814    13790    4                   END;
      815    13791    3              END;

      816    13792
      817    13793    2         KN$LDCT.RLCID = FPT_CONNECT.RLCID;

  13793   1 0001C0  ECC7 0004                            LDB,B6   @KN$NETPARM,AUTO
          1 0001C2  DC86                                 LDB,B5   ,B6
          1 0001C3  CCC6 0019                            LDB,B4   25,B6
          1 0001C5  8CC4 000D                            LDI      13,B4
          1 0001C7  8D45 0001                            SDI      1,B5

      818    13794
      819    13795    2         KN$NETPARM.NHDR$ = ADDR(NIL);

  13795   1 0001C9  DB80 0000 0000                       LAB,B5   0
          1 0001CC  DFC6 000E                            STB,B5   14,B6

      820    13796    2         KN$NETPARM.NHDRSZ = 0;

  13796   1 0001CE  8746 0010                            CL       16,B6

      821    13797    2         KN$NETPARM.FUNCTION = %KN_FCN_INIT_ACK;
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:151  

  13797   1 0001D0  6C02                                 LDV,R6   2
          1 0001D1  EF46 0014                            STR,R6   20,B6

      822    13798    2         FPT@ACK.REASON = %K_REASON_NORMAL;

  13798   1 0001D3  8747 0065                            CL       FPT@ACK,AUTO

      823    13799    2         KN$NETPARM.FPT$ = ADDR(FPT@ACK);

  13799   1 0001D5  DBC7 0065                            LAB,B5   FPT@ACK,AUTO
          1 0001D7  DFC6 0019                            STB,B5   25,B6

      824    13800
      825    13801    2         CALL KNH$SEND (KN$NETPARM)

  13801   1 0001D9  BBC7 0004                            LAB,B3   @KN$NETPARM,AUTO
          1 0001DB  CBF0 0100                            LAB,B4   256,IMO
          1 0001DD  E380 0000 0000  xent                 LNJ,B6   KNH$SEND
          1 0001E0       0003                            DC       s:13803,PREL
          1 0001E1  0F81 001C                            B        s:13816,PREL

      826    13802    3         WHENALTRETURN DO;

      827    13803    3              IF DEST_NODE < %K_CNC_IS# THEN

  13803   1 0001E3  E847 000D                            LDR,R6   DEST_NODE,AUTO
          1 0001E5  E970 00FD                            CMR,R6   253,IMO
          1 0001E7  0281 0004                            BGE      s:13805,PREL

      828    13804    3                   CALL LINK_DOWN;

  13804   1 0001E9  E3C0 0B73                            LNJ,B6   s:0,PREL
          1 0001EB       0001                            DC       s:13805,PREL

      829    13805    3              KNN$LINK.LDCT$ = ADDR(NIL);

PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:152  
  13805   1 0001EC  EB80 0000 0000                       LAB,B6   0
          1 0001EF  DCC7 0010                            LDB,B5   LINK$,AUTO
          1 0001F1  EF85                                 STB,B6   ,B5

      830    13806                   %UNLOCK (G=KNN_LOCK);

  13811   1 0001F2  BB80 0000 0002  02                   LAB,B3   +2
          1 0001F5  CBF0 0100                            LAB,B4   256,IMO
          1 0001F7  E380 0000 0000  xent                 LNJ,B6   GHH$UNLOCK
          1 0001FA       0001                            DC       s:13813,PREL

      831    13813    3              ALTRETURN;

  13813   1 0001FB  C380 0000 0000  xent                 LNJ,B4   X6A_AALT

      832    13814    3              END;
      833    13815
      834    13816    3         IF DEST_NODE = %K_CNC_IS# THEN DO;

  13816   1 0001FE  E847 000D                            LDR,R6   DEST_NODE,AUTO
          1 000200  E970 00FD                            CMR,R6   253,IMO
          1 000202  0981 0004                            BNE      s:13823,PREL

      835    13817                      /*
      836    13818                         intermediate system. respond with esh pdu
      837    13819                      */
      838    13820    3              CALL SENDESH;

  13820   1 000204  E3C0 0DC1                            LNJ,B6   s:0,PREL
          1 000206       0001                            DC       s:13823,PREL

      839    13821    3              END;

      840    13822
      841    13823    2         IF NOT KNN$LINK.FLAGS.VIRCIR

  13823   1 000207  ECC7 0010                            LDB,B6   LINK$,AUTO
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:153  
          1 000209  82C6 0003                            LB,'1000'X        3,B6
          1 00020B       1000
          1 00020C  0501 004E                            BBT      s:13849,PREL
          1 00020E  E846 0002                            LDR,R6   2,B6
          1 000210  E970 00FD                            CMR,R6   253,IMO
          1 000212  0201 0048                            BL       s:13849,PREL
          1 000214  D2C6 001F                            LLH,R5   31,B6
          1 000216  5901 0044                            BEZ,R5   s:13849,PREL

      842    13824    2           AND KNN$LINK.NODE# >= %K_CNC_IS#
      843    13825    2           AND KNN$LINK.SNPA.LEN ~= 0 THEN
      844    13826    3         DO;

      845    13827                      /*
      846    13828                         update the osiroute table with the new
      847    13829                         information.  forward the info to nodeadmn
      848    13830                         for propagation to the other nodes in the network.
      849    13831                      */
      850    13832    3              SNPA = KNN$LINK.SNPA;

  13832   1 000218  AB86                                 LAB,B2   ,B6
          1 000219  2C3E                                 LDV,R2   62
          1 00021A  6C08                                 LDV,R6   8
          1 00021B  BBC7 0061                            LAB,B3   SNPA,AUTO
          1 00021D  3C00                                 LDV,R3   0
          1 00021E  0008                                 MMM

      851    13833    3              DEST_NODE = KN_NODE#;

  13833   1 00021F  E800 0000 0000  xsym                 LDR,R6   KN_NODE#
          1 000222  EF47 000D                            STR,R6   DEST_NODE,AUTO

      852    13834    3              QOS = KNN$LINK.QOS;

  13834   1 000224  DCC7 0010                            LDB,B5   LINK$,AUTO
          1 000226  D845 0004                            LDR,R5   4,B5
          1 000228  DF47 0016                            STR,R5   QOS,AUTO
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:154  

      853    13835    3              CALL OSILINK_UP;

  13835   1 00022A  E3C0 0C4B                            LNJ,B6   s:0,PREL
          1 00022C       0001                            DC       s:13836,PREL

      854    13836    3              OSILINKCHG.FCN = IGA_OSILINKUP;

  13836   1 00022D  6C58                                 LDV,R6   88
          1 00022E  E7C7 0051                            STH,R6   OSILINKCHG,AUTO

      855    13837    3              OSILINKCHG.SNPA = SNPA;

  13837   1 000230  ABC7 0061                            LAB,B2   SNPA,AUTO
          1 000232  2C00                                 LDV,R2   0
          1 000233  6C08                                 LDV,R6   8
          1 000234  BBC7 0055                            LAB,B3   OSILINKCHG+4,AUTO
          1 000236  3C00                                 LDV,R3   0
          1 000237  0008                                 MMM

      856    13838    3              OSILINKCHG.QOS = QOS;

  13838   1 000238  E847 0016                            LDR,R6   QOS,AUTO
          1 00023A  E7C7 0053                            STH,R6   OSILINKCHG+2,AUTO

      857    13839    3              OSILINKCHG.TERMID.TERM.CHANNEL = KNN$LINK.CHAN#;

  13839   1 00023C  ECC7 0010                            LDB,B6   LINK$,AUTO
          1 00023E  D846 0023                            LDR,R5   35,B6
          1 000240  DF47 005A                            STR,R5   OSILINKCHG+9,AUTO

      858    13840    3              OSILINKCHG.MYNODE# = KN_NODE#;

  13840   1 000242  C800 0000 0000  xsym                 LDR,R4   KN_NODE#
          1 000245  C7C7 0052                            STH,R4   OSILINKCHG+1,AUTO

      859    13841    3              CALL KNB$WRITE(ADDR(OSILINKCHG),SIZEC(OSILINKCHG));
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:155  
             13841                       /* drop altreturn if any */

  13841   1 000247  DBC7 0051                            LAB,B5   OSILINKCHG,AUTO
          1 000249  DFC7 0094                            STB,B5   ALTQOS+2,AUTO
          1 00024B  CBF0 0020                            LAB,B4   32,IMO
          1 00024D  CFC7 0098                            STB,B4   ALTQOS+6,AUTO
          1 00024F  BBC7 0094                            LAB,B3   ALTQOS+2,AUTO
          1 000251  BFC7 0096                            STB,B3   ALTQOS+4,AUTO
          1 000253  BBC7 0096                            LAB,B3   ALTQOS+4,AUTO
          1 000255  CBF0 0200                            LAB,B4   512,IMO
          1 000257  E380 0000 0000  xent                 LNJ,B6   KNB$WRITE
          1 00025A       0001                            DC       s:13849,PREL

      860    13842    3              END;

      861    13843
      862    13844              %UNLOCK (G=KNN_LOCK);

  13849   1 00025B  BB80 0000 0002  02                   LAB,B3   +2
          1 00025E  CBF0 0100                            LAB,B4   256,IMO
          1 000260  E380 0000 0000  xent                 LNJ,B6   GHH$UNLOCK
          1 000263       0001                            DC       s:13851,PREL

      863    13851    2         RETURN;

  13851   1 000264  C380 0000 0000  xent                 LNJ,B4   X6A_ARET

      864    13852
      865    13853        %EJECT;
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:156  
      866    13854        /*F* NAME: KNN$RECV - init ack.
      867    13855             called from knh$scan and is the result, hopefully, of a previous init
      868    13856             realized from a OSI CONS request.
      869    13857        */
      870    13858
      871    13859    2       CASE (%KN_FCN_INIT_ACK);

      872    13860              %LOCK(G=KNN_LOCK);

  13865   1 000267  BB80 0000 0002  02                   LAB,B3   +2
          1 00026A  CBF0 0100                            LAB,B4   256,IMO
          1 00026C  E380 0000 0000  xent                 LNJ,B6   GHH$LOCK
          1 00026F       0001                            DC       s:13867,PREL

      873    13867    2         IF KN$LDCT.STATE ~= %KN_ST_OPENING THEN

  13867   1 000270  ECC7 0004                            LDB,B6   @KN$NETPARM,AUTO
          1 000272  DC86                                 LDB,B5   ,B6
          1 000273  E805                                 LDR,R6   ,B5
          1 000274  E570 00FF                            AND,R6   255,IMO
          1 000276  6D09                                 CMV,R6   9
          1 000277  0901 000A                            BE       s:13869,PREL

      874    13868    2              CALL SCREECH(PRTCLERR);

  13868   1 000279  BB80 0000 0004  02                   LAB,B3   +4
          1 00027C  CBF0 0100                            LAB,B4   256,IMO
          1 00027E  E380 0000 0000  xent                 LNJ,B6   SCREECH
          1 000281       0001                            DC       s:13869,PREL

      875    13869    3         IF FPT_CONNECT_ACK.REASON ~= 0 THEN DO;

  13869   1 000282  ECC7 0004                            LDB,B6   @KN$NETPARM,AUTO
          1 000284  DCC6 0019                            LDB,B5   25,B6
          1 000286  E805                                 LDR,R6   ,B5
          1 000287  6901 0026                            BEZ,R6   s:13891,PREL

PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:157  
      876    13870    3              KN$NETPARM.FUNCTION = %K_NDISCONNECT_IND;

  13870   1 000289  5C24                                 LDV,R5   36
          1 00028A  DF46 0014                            STR,R5   20,B6

      877    13871    4              CALL KNT$RECV_4HOST(KN$NETPARM) WHENALTRETURN DO;

  13871   1 00028C  BBC7 0004                            LAB,B3   @KN$NETPARM,AUTO
          1 00028E  CBF0 0100                            LAB,B4   256,IMO
          1 000290  E380 0000 0000  xent                 LNJ,B6   KNT$RECV_4HOST
          1 000293       0003                            DC       s:13877,PREL
          1 000294  0F81 000D                            B        s:13886,PREL

      878    13872                        %UNLOCK(G=KNN_LOCK);

  13877   1 000296  BB80 0000 0002  02                   LAB,B3   +2
          1 000299  CBF0 0100                            LAB,B4   256,IMO
          1 00029B  E380 0000 0000  xent                 LNJ,B6   GHH$UNLOCK
          1 00029E       0001                            DC       s:13879,PREL

      879    13879    4                   ALTRETURN;    /* will knh$scan try to resend this message ?   */

  13879   1 00029F  C380 0000 0000  xent                 LNJ,B4   X6A_AALT

      880    13880    4                   END;
      881    13881                   %UNLOCK(G=KNN_LOCK);

  13886   1 0002A2  BB80 0000 0002  02                   LAB,B3   +2
          1 0002A5  CBF0 0100                            LAB,B4   256,IMO
          1 0002A7  E380 0000 0000  xent                 LNJ,B6   GHH$UNLOCK
          1 0002AA       0001                            DC       s:13888,PREL

      882    13888    3              RETURN;

  13888   1 0002AB  C380 0000 0000  xent                 LNJ,B4   X6A_ARET

      883    13889    3              END;
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:158  
      884    13890
      885    13891    2         KN$LDCT.STATE = %KN_ST_OPEN;

  13891   1 0002AE  CC86                                 LDB,B4   ,B6
          1 0002AF  5C08                                 LDV,R5   8
          1 0002B0  DA84                                 SRM,R5,'00FF'X    ,B4
          1 0002B1       00FF

      886    13892    2         KN$LDCT.USER_ENTRY$ = ENTADDR(NIL);

  13892   1 0002B2  DC86                                 LDB,B5   ,B6
          1 0002B3  CC80 0000 0006  02                   LDB,B4   +6
          1 0002B6  CFC5 000C                            STB,B4   12,B5

      887    13893    2         KN$NETPARM.FUNCTION = %K_NCONNECT_CFM;

  13893   1 0002B8  6C20                                 LDV,R6   32
          1 0002B9  EF46 0014                            STR,R6   20,B6

      888    13894    3         CALL KNT$RECV_4HOST(KN$NETPARM) WHENALTRETURN DO;

  13894   1 0002BB  BBC7 0004                            LAB,B3   @KN$NETPARM,AUTO
          1 0002BD  CBF0 0100                            LAB,B4   256,IMO
          1 0002BF  E380 0000 0000  xent                 LNJ,B6   KNT$RECV_4HOST
          1 0002C2       0003                            DC       s:13900,PREL
          1 0002C3  0F81 000D                            B        s:13909,PREL

      889    13895                   %UNLOCK(G=KNN_LOCK);

  13900   1 0002C5  BB80 0000 0002  02                   LAB,B3   +2
          1 0002C8  CBF0 0100                            LAB,B4   256,IMO
          1 0002CA  E380 0000 0000  xent                 LNJ,B6   GHH$UNLOCK
          1 0002CD       0001                            DC       s:13902,PREL

      890    13902    3              ALTRETURN;

  13902   1 0002CE  C380 0000 0000  xent                 LNJ,B4   X6A_AALT
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:159  

      891    13903    3              END;
      892    13904              %UNLOCK(G=KNN_LOCK);

  13909   1 0002D1  BB80 0000 0002  02                   LAB,B3   +2
          1 0002D4  CBF0 0100                            LAB,B4   256,IMO
          1 0002D6  E380 0000 0000  xent                 LNJ,B6   GHH$UNLOCK
          1 0002D9       0001                            DC       s:13911,PREL

      893    13911    2         RETURN;

  13911   1 0002DA  C380 0000 0000  xent                 LNJ,B4   X6A_ARET

      894    13912        %EJECT;
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:160  
      895    13913        /*F* NAME: KNN$RECV - Data Function
      896    13914
      897    13915        KNN$RECV is called from KNH$SCAN with the function set to
      898    13916        DATA when the scanning has found a DATA message
      899    13917        and the LDCT as specified by KNH$MESS.LDCTX has a LINK
      900    13918        connection type.
      901    13919
      902    13920        No FPT is passed on this call.
      903    13921
      904    13922        If the message isn't for this fep, it is sent on by calling KNH$SEND.
      905    13923
      906    13924        If the message is for this node, it is passed on up the layers by
      907    13925        updating NETPARM.THDR$ and .THDRSZ to reflect the stripping
      908    13926        off of the network header and calling KNT$RECV or KNS$RECV.
      909    13927        */
      910    13928
      911    13929    2       CASE (%KN_FCN_DATA);

      912    13930    2   RECEIVE_DATA:
      913    13931
      914    13932        /* If the RECTYPE is nonzero check for a special function.
      915    13933        */
      916    13934    2         IF KN$NETPARM.RECTYPE = %KJ_FCN_TIM

  13934   1 0002DD  ECC7 0004            RECEIVE_DATA    LDB,B6   @KN$NETPARM,AUTO
          1 0002DF  E846 0013                            LDR,R6   19,B6
          1 0002E1  6D21                                 CMV,R6   33
          1 0002E2  0981 0011                            BNE      s:13943,PREL

      917    13935    3         THEN DO;

      918    13936    3              CALL KNH$SEND (KN$NETPARM)

  13936   1 0002E4  BBC7 0004                            LAB,B3   @KN$NETPARM,AUTO
          1 0002E6  CBF0 0100                            LAB,B4   256,IMO
          1 0002E8  E380 0000 0000  xent                 LNJ,B6   KNH$SEND
          1 0002EB       0003                            DC       s:13938,PREL
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:161  
          1 0002EC  0F81 0004                            B        s:13940,PREL

      919    13937    4              WHENALTRETURN DO;

      920    13938    4                   ALTRETURN;

  13938   1 0002EE  C380 0000 0000  xent                 LNJ,B4   X6A_AALT

      921    13939    4                   END;
      922    13940    3              RETURN;

  13940   1 0002F1  C380 0000 0000  xent                 LNJ,B4   X6A_ARET

      923    13941    3              END;
      924    13942
      925    13943    2         LINK# = KN$LDCT.LINK_ID;

  13943   1 0002F4  DC86                                 LDB,B5   ,B6
          1 0002F5  D845 0003                            LDR,R5   3,B5
          1 0002F7  DF47 0012                            STR,R5   LINK#,AUTO

      926    13944    2         LINKIN# = LINK#;

  13944   1 0002F9  DF47 0013                            STR,R5   LINKIN#,AUTO

      927    13945    2         LINK$ = KNN$LINK$(LINK#);

  13945   1 0002FB  CC80 0000 0000  xsym                 LDB,B4   KNN_LINK$$
          1 0002FE  B855                                 LDR,R3   R5
          1 0002FF  BCB4                                 LDB,B3   ,B4,R3
          1 000300  BFC7 0010                            STB,B3   LINK$,AUTO

      928    13946
      929    13947        /*
      930    13948             if this message if on a OSI CONS connection then setup
      931    13949             netparm and call recv4_host.
      932    13950        */
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:162  
      933    13951    3         IF KN$LDCT.CONN_TYPE = %KN_CNTYPE_CIRCUIT THEN DO;

  13951   1 000302  C285                                 LLH,R4   ,B5
          1 000303  4D07                                 CMV,R4   7
          1 000304  0981 0037                            BNE      s:13972,PREL

      934    13952    3              IF KN$LDCT.STATE ~= %KN_ST_OPEN THEN

  13952   1 000306  A805                                 LDR,R2   ,B5
          1 000307  A570 00FF                            AND,R2   255,IMO
          1 000309  2D08                                 CMV,R2   8
          1 00030A  0901 000A                            BE       s:13955,PREL

      935    13953    3                   CALL SCREECH(PRTCLERR);

  13953   1 00030C  BB80 0000 0004  02                   LAB,B3   +4
          1 00030F  CBF0 0100                            LAB,B4   256,IMO
          1 000311  E380 0000 0000  xent                 LNJ,B6   SCREECH
          1 000314       0001                            DC       s:13955,PREL

      936    13954
      937    13955    3              KN$NETPARM.FUNCTION = %K_NDATA;

  13955   1 000315  ECC7 0004                            LDB,B6   @KN$NETPARM,AUTO
          1 000317  6C21                                 LDV,R6   33
          1 000318  EF46 0014                            STR,R6   20,B6

      938    13956    3              KN$NETPARM.THDR$ = KN$NETPARM.NHDR$;

  13956   1 00031A  DCC6 000E                            LDB,B5   14,B6
          1 00031C  DFC6 000B                            STB,B5   11,B6

      939    13957    3              KN$NETPARM.THDRSZ = KN$NETPARM.NHDRSZ;

  13957   1 00031E  D846 0010                            LDR,R5   16,B6
          1 000320  DF46 000D                            STR,R5   13,B6

PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:163  
      940    13958    3              KN$NETPARM.NHDRSZ = 0;

  13958   1 000322  8746 0010                            CL       16,B6

      941    13959    3              KN$NETPARM.NHDR$ = ADDR(NIL);

  13959   1 000324  CB80 0000 0000                       LAB,B4   0
          1 000327  CFC6 000E                            STB,B4   14,B6

      942    13960    3              KN$NETPARM.FLAGS.CONS = '1'B;

  13960   1 000329  8946 0012                            LBT,'0100'X       18,B6
  13960   1 00032B       0100

      943    13961    4              CALL KNT$RECV_4HOST(KN$NETPARM) WHENALTRETURN DO;

  13961   1 00032C  BBC7 0004                            LAB,B3   @KN$NETPARM,AUTO
          1 00032E  CBF0 0100                            LAB,B4   256,IMO
          1 000330  E380 0000 0000  xent                 LNJ,B6   KNT$RECV_4HOST
          1 000333       0003                            DC       s:13962,PREL
          1 000334  0F81 0004                            B        s:13964,PREL

      944    13962    4                   ALTRETURN;

  13962   1 000336  C380 0000 0000  xent                 LNJ,B4   X6A_AALT

      945    13963    4                   END;
      946    13964    3              RETURN;

  13964   1 000339  C380 0000 0000  xent                 LNJ,B4   X6A_ARET

      947    13965    3              END;                         /* conn_type = circuit                */
      948    13966
      949    13967        /*
      950    13968                   This message is osi class 4 transport, class C network.  Call
      951    13969                   the osi pdu burster to decide what to do with it.  possibly
      952    13970                   from a foreign system or an alien cp6.
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:164  
      953    13971        */
      954    13972    3         IF B$QDP_HDR.MSGTYP = %K_MSGTYP_OSI# THEN DO;

  13972   1 00033C  ACC6 000E                            LDB,B2   14,B6
          1 00033E  A282                                 LLH,R2   ,B2
          1 00033F  A970 0081                            CMR,R2   129,IMO
          1 000341  0981 0011                            BNE      s:13986,PREL

      955    13973    4              CALL KNN$RECVOSI(KN$NETPARM) WHENALTRETURN DO;

  13973   1 000343  BBC7 0004                            LAB,B3   @KN$NETPARM,AUTO
          1 000345  CBF0 0100                            LAB,B4   256,IMO
          1 000347  E380 0000 0000  xent                 LNJ,B6   KNN$RECVOSI
          1 00034A       0003                            DC       s:13974,PREL
          1 00034B  0F81 0004                            B        s:13976,PREL

      956    13974    4                   ALTRETURN;

  13974   1 00034D  C380 0000 0000  xent                 LNJ,B4   X6A_AALT

      957    13975    4                   END;
      958    13976    3              RETURN;

  13976   1 000350  C380 0000 0000  xent                 LNJ,B4   X6A_ARET

      959    13977    3              END;
      960    13978
      961    13979        /*
      962    13980                   cp6 class4.  type pdu indicates that an osi type message
      963    13981                   orginated on the host.  This code needs to decide where to
      964    13982                   forward the message to(node or link).  The code must also
      965    13983                   build a proper osi network header.
      966    13984        */
      967    13985
      968    13986    3         IF B$OSI_HDR.MSGTYP = %K_MSGTYP_OSI_INIT# THEN DO;

  13986   1 000353  A970 00FB                            CMR,R2   251,IMO
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:165  
          1 000355  0981 005D                            BNE      s:14036,PREL

      969    13987    3              KN$NETPARM.SRC_ADDR$ = ADDR(B$OSI_HDR.SRC_NSAP);

  13987   1 000357  9BC2 000D                            LAB,B1   13,B2
          1 000359  9FC6 001D                            STB,B1   29,B6

      970    13988    3              KN$NETPARM.DST_ADDR$ = ADDR(B$OSI_HDR.DST_NSAP);

  13988   1 00035B  EBC2 0002                            LAB,B6   2,B2
          1 00035D  DCC7 0004                            LDB,B5   @KN$NETPARM,AUTO
          1 00035F  EFC5 001F                            STB,B6   31,B5

      971    13989    3              KN$NETPARM.FPT$ = ADDR(B$OSI_HDR.TR_OPTIONS);

  13989   1 000361  ACC5 000E                            LDB,B2   14,B5
          1 000363  9BC2 0018                            LAB,B1   24,B2
          1 000365  9FC5 0019                            STB,B1   25,B5

      972    13990    3              KN$NETPARM.NODE = B$OSI_HDR.SOURCE_NODE-1;

  13990   1 000367  E842 0001                            LDR,R6   1,B2
          1 000369  E570 00FF                            AND,R6   255,IMO
          1 00036B  6EFF                                 ADV,R6   -1
          1 00036C  EF45 0015                            STR,R6   21,B5

      973    13991    3              KN$NETPARM.THDRSZ = KN$NETPARM.NHDRSZ - LENGTHC(B$OSI_HDR);

  13991   1 00036E  C845 0010                            LDR,R4   16,B5
          1 000370  4EBC                                 ADV,R4   -68
          1 000371  CF45 000D                            STR,R4   13,B5

      974    13992    3              KN$NETPARM.THDR_C$ = PINCRC(KN$NETPARM.NHDR$,LENGTHC(B$OSI_HDR));

  13992   1 000373  EBC2 0022                            LAB,B6   34,B2
          1 000375  EFC5 000B                            STB,B6   11,B5

PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:166  
      975    13993    3              KN$NETPARM.FUNCTION = %K_NDATA;

  13993   1 000377  2C21                                 LDV,R2   33
          1 000378  AF45 0014                            STR,R2   20,B5

      976    13994    3              QQQ$ = KN$NETPARM.LDCT$;

  13994   1 00037A  EC85                                 LDB,B6   ,B5
          1 00037B  EFC7 0023                            STB,B6   QQQ$,AUTO

      977    13995                      /*
      978    13996                            osi_init msgtype - call send4_host.   altreturn indicates
      979    13997                            a class 0 connection which transport resolved via a call to
      980    13998                            knn$send.  An altreturn with a non-zero kn$netparm.errcode
      981    13999                            indicates that something went amiss.  A return indicates that
      982    14000                            this message is class4/C and an osi network header should be
      983    14001                            built.
      984    14002                      */
      985    14003    4              CALL KNT$SEND_4HOST(KN$NETPARM) WHENALTRETURN DO;

  14003   1 00037D  BBC7 0004                            LAB,B3   @KN$NETPARM,AUTO
          1 00037F  CBF0 0100                            LAB,B4   256,IMO
          1 000381  E380 0000 0000  xent                 LNJ,B6   KNT$SEND_4HOST
          1 000384       0003                            DC       s:14004,PREL
          1 000385  0F81 0013                            B        s:14015,PREL

      986    14004    5                   IF KN$NETPARM.ERRCODE ~= 0 THEN DO;

  14004   1 000387  ECC7 0004                            LDB,B6   @KN$NETPARM,AUTO
          1 000389  E846 0016                            LDR,R6   22,B6
          1 00038B  6901 0007                            BEZ,R6   s:14008,PREL

      987    14005    5                        KN$NETPARM.LDCT$ = QQQ$;

  14005   1 00038D  DCC7 0023                            LDB,B5   QQQ$,AUTO
          1 00038F  DF86                                 STB,B5   ,B6

PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:167  
      988    14006    5                        ALTRETURN;         /* an error was encountered           */

  14006   1 000390  C380 0000 0000  xent                 LNJ,B4   X6A_AALT

      989    14007    5                        END;
      990    14008    4                   KN$NETPARM.LDCT$ = QQQ$;

  14008   1 000393  DCC7 0023                            LDB,B5   QQQ$,AUTO
          1 000395  DF86                                 STB,B5   ,B6

      991    14009    4                   RETURN;

  14009   1 000396  C380 0000 0000  xent                 LNJ,B4   X6A_ARET

      992    14010    4                   END;
      993    14011                      /*
      994    14012                            transport will keep the addresses in transport context.
      995    14013                      */
      996    14014
      997    14015    4              CALL KNN$SENDOSI(KN$NETPARM) WHENALTRETURN DO;

  14015   1 000399  BBC7 0004                            LAB,B3   @KN$NETPARM,AUTO
          1 00039B  CBF0 0100                            LAB,B4   256,IMO
          1 00039D  E380 0000 0000  xent                 LNJ,B6   KNN$SENDOSI
          1 0003A0       0003                            DC       s:14016,PREL
          1 0003A1  0F81 0009                            B        s:14019,PREL

      998    14016    4                   KN$NETPARM.LDCT$ = QQQ$;

  14016   1 0003A3  ECC7 0023                            LDB,B6   QQQ$,AUTO
          1 0003A5  DCC7 0004                            LDB,B5   @KN$NETPARM,AUTO
          1 0003A7  EF85                                 STB,B6   ,B5

      999    14017    4                   ALTRETURN;

  14017   1 0003A8  C380 0000 0000  xent                 LNJ,B4   X6A_AALT

PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:168  
     1000    14018    4                   END;
     1001    14019    3              KN$NETPARM.LDCT$ = QQQ$;

  14019   1 0003AB  ECC7 0023                            LDB,B6   QQQ$,AUTO
          1 0003AD  DCC7 0004                            LDB,B5   @KN$NETPARM,AUTO
          1 0003AF  EF85                                 STB,B6   ,B5

     1002    14020    3              RETURN;

  14020   1 0003B0  C380 0000 0000  xent                 LNJ,B4   X6A_ARET

     1003    14021        /*N*
     1004    14022                need code to do the msgs in and messages out code
     1005    14023        */
     1006    14024
     1007    14025    3              END;                         /* end msgtype=osi_init               */
     1008    14026
     1009    14027                   /*
     1010    14028                   osi_data   handled the same as osi_init except that transport
     1011    14029                   remembers the addresses for the connection.  And/or in the case
     1012    14030                   of class 0 forwards the message to knh$send.  If this is a class0
     1013    14031                   connection an altreturn with a zero kn$netparm.errcode field will
     1014    14032                   result.  A non zero kn$netparm.errcode indicates that for whatever
     1015    14033                   reason the message could not be delivered.
     1016    14034                   */
     1017    14035
     1018    14036    3         IF B$OSI_HDR.MSGTYP = %K_MSGTYP_OSI_DATA# THEN DO;

  14036   1 0003B3  A970 00FC                            CMR,R2   252,IMO
          1 0003B5  0981 0057                            BNE      s:14067,PREL

     1019    14037    3              KN$NETPARM.NODE = B$OSI_HDR.SOURCE_NODE-1;

  14037   1 0003B7  9842 0001                            LDR,R1   1,B2
          1 0003B9  9570 00FF                            AND,R1   255,IMO
          1 0003BB  1EFF                                 ADV,R1   -1
          1 0003BC  9F46 0015                            STR,R1   21,B6
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:169  

     1020    14038    3              KN$NETPARM.FUNCTION = %K_NDATA;

  14038   1 0003BE  4C21                                 LDV,R4   33
          1 0003BF  CF46 0014                            STR,R4   20,B6

     1021    14039    3              KN$NETPARM.DST_ADDR$ = ADDR(NIL);

  14039   1 0003C1  9B80 0000 0000                       LAB,B1   0
          1 0003C4  9FC6 001F                            STB,B1   31,B6

     1022    14040    3              KN$NETPARM.SRC_ADDR$ = ADDR(NIL);

  14040   1 0003C6  EB80 0000 0000                       LAB,B6   0
          1 0003C9  DCC7 0004                            LDB,B5   @KN$NETPARM,AUTO
          1 0003CB  EFC5 001D                            STB,B6   29,B5

     1023    14041    3              KN$NETPARM.THDRSZ = KN$NETPARM.NHDRSZ - LENGTHC(B$QDP_HDR);

  14041   1 0003CD  E845 0010                            LDR,R6   16,B5
          1 0003CF  6EFC                                 ADV,R6   -4
          1 0003D0  EF45 000D                            STR,R6   13,B5

     1024    14042    3              KN$NETPARM.THDR$ = PINCRC(KN$NETPARM.NHDR$, LENGTHC(B$QDP_HDR));

  14042   1 0003D2  ACC5 000E                            LDB,B2   14,B5
          1 0003D4  9BC2 0002                            LAB,B1   2,B2
          1 0003D6  9FC5 000B                            STB,B1   11,B5

     1025    14043    4              CALL KNT$SEND_4HOST(KN$NETPARM) WHENALTRETURN DO;

  14043   1 0003D8  BBC7 0004                            LAB,B3   @KN$NETPARM,AUTO
          1 0003DA  CBF0 0100                            LAB,B4   256,IMO
          1 0003DC  E380 0000 0000  xent                 LNJ,B6   KNT$SEND_4HOST
          1 0003DF       0003                            DC       s:14044,PREL
          1 0003E0  0F81 000D                            B        s:14051,PREL

PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:170  
     1026    14044    4                   IF KN$NETPARM.ERRCODE ~= 0 THEN ALTRETURN; /* error           */

  14044   1 0003E2  ECC7 0004                            LDB,B6   @KN$NETPARM,AUTO
          1 0003E4  E846 0016                            LDR,R6   22,B6
          1 0003E6  6901 0004                            BEZ,R6   s:14045,PREL

  14044   1 0003E8  C380 0000 0000  xent                 LNJ,B4   X6A_AALT

     1027    14045    4                   RETURN;                 /* successful class0 transmittion???  */

  14045   1 0003EB  C380 0000 0000  xent                 LNJ,B4   X6A_ARET

     1028    14046    4                   END;
     1029    14047
     1030    14048                      /*   kn$netparm.dst_addr$ and kn$netparm.src_addr$ should now
     1031    14049                            point to the tctx bobcat data where transport stowed the
     1032    14050                            nsap addresses during connect.*/
     1033    14051    3              QQQ$ = KN$NETPARM.LDCT$;     /* save ldct                          */

  14051   1 0003EE  ECC7 0004                            LDB,B6   @KN$NETPARM,AUTO
          1 0003F0  DC86                                 LDB,B5   ,B6
          1 0003F1  DFC7 0023                            STB,B5   QQQ$,AUTO

     1034    14052    4              CALL KNN$SENDOSI(KN$NETPARM) WHENALTRETURN DO;

  14052   1 0003F3  BBC7 0004                            LAB,B3   @KN$NETPARM,AUTO
          1 0003F5  CBF0 0100                            LAB,B4   256,IMO
          1 0003F7  E380 0000 0000  xent                 LNJ,B6   KNN$SENDOSI
          1 0003FA       0003                            DC       s:14053,PREL
          1 0003FB  0F81 0009                            B        s:14056,PREL

     1035    14053    4                   KN$NETPARM.LDCT$ = QQQ$;

  14053   1 0003FD  ECC7 0023                            LDB,B6   QQQ$,AUTO
          1 0003FF  DCC7 0004                            LDB,B5   @KN$NETPARM,AUTO
          1 000401  EF85                                 STB,B6   ,B5

PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:171  
     1036    14054    4                   ALTRETURN;

  14054   1 000402  C380 0000 0000  xent                 LNJ,B4   X6A_AALT

     1037    14055    4                   END;
     1038    14056    3              KN$NETPARM.LDCT$ = QQQ$;

  14056   1 000405  ECC7 0023                            LDB,B6   QQQ$,AUTO
          1 000407  DCC7 0004                            LDB,B5   @KN$NETPARM,AUTO
          1 000409  EF85                                 STB,B6   ,B5

     1039    14057    3              RETURN;

  14057   1 00040A  C380 0000 0000  xent                 LNJ,B4   X6A_ARET

     1040    14058        /*N*
     1041    14059                need code to do the msgs in and messages out code
     1042    14060        */
     1043    14061    3              END;                         /* msgtype = osi_data#                */
     1044    14062
     1045    14063        /*
     1046    14064              If it isn't one of the above
     1047    14065              Extract node numbers and fix up kn$netparm for transport or session.
     1048    14066        */
     1049    14067    2         DEST_NODE = B$QDP_HDR.DEST_NODE -1;

  14067   1 00040D  92C2 0001                            LLH,R1   1,B2
          1 00040F  1EFF                                 ADV,R1   -1
          1 000410  9F47 000D                            STR,R1   DEST_NODE,AUTO

     1050    14068    2         SOURCE_NODE = B$QDP_HDR.SOURCE_NODE -1;

  14068   1 000412  E842 0001                            LDR,R6   1,B2
          1 000414  E570 00FF                            AND,R6   255,IMO
          1 000416  6EFF                                 ADV,R6   -1
          1 000417  EF47 0026                            STR,R6   SOURCE_NODE,AUTO

PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:172  
     1051    14069    2         IF (SOURCE_NODE > KNN_NODES) OR

  14069   1 000419  E900 0000 0000  xsym                 CMR,R6   KNN_NODES
          1 00041C  0301 0006                            BG       s:14071,PREL
          1 00041E  9900 0000 0000  xsym                 CMR,R1   KNN_NODES
          1 000421  0381 0014                            BLE      s:14078,PREL

     1052    14070    2           (DEST_NODE > KNN_NODES) THEN
     1053    14071    2              IF (KN_SCREECH ~= 0) THEN

  14071   1 000423  E800 0000 0015  00                   LDR,R6   KN_SCREECH
          1 000426  6901 000C                            BEZ,R6   s:14074,PREL

     1054    14072    2                   CALL SCREECH(PRTCLERR);

  14072   1 000428  BB80 0000 0004  02                   LAB,B3   +4
          1 00042B  CBF0 0100                            LAB,B4   256,IMO
          1 00042D  E380 0000 0000  xent                 LNJ,B6   SCREECH
          1 000430       0001                            DC       s:14072+9,PREL
          1 000431  0F81 0004                            B        s:14078,PREL

     1055    14073    2              ELSE
     1056    14074    2                   RETURN;

  14074   1 000433  C380 0000 0000  xent                 LNJ,B4   X6A_ARET

     1057    14075
     1058    14076        /* Screech if we have passed this message through 15 nodes.
     1059    14077        */
     1060    14078    2         B$QDP_HDR.HOP_COUNT = B$QDP_HDR.HOP_COUNT +1;

  14078   1 000436  ECC7 0004                            LDB,B6   @KN$NETPARM,AUTO
          1 000438  DCC6 000E                            LDB,B5   14,B6
          1 00043A  E805                                 LDR,R6   ,B5
          1 00043B  EA70 0001                            ADD,R6   1,IMO
          1 00043D  EA85                                 SRM,R6,'00FF'X    ,B5
          1 00043E       00FF
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:173  

     1061    14079    2         IF B$QDP_HDR.HOP_COUNT = 15

  14079   1 00043F  DCC6 000E                            LDB,B5   14,B6
          1 000441  E805                                 LDR,R6   ,B5
          1 000442  E570 00FF                            AND,R6   255,IMO
          1 000444  6D0F                                 CMV,R6   15
          1 000445  0981 0014                            BNE      s:14088,PREL

     1062    14080    3         THEN DO;

     1063    14081    3              IF KN_SCREECH_HOPCOUNT ~= 0

  14081   1 000447  D800 0000 0014  00                   LDR,R5   KN_SCREECH_HOPCOUNT
          1 00044A  5901 000C                            BEZ,R5   s:14083,PREL

     1064    14082    3              THEN CALL SCREECH(PRTCLERR);

  14082   1 00044C  BB80 0000 0004  02                   LAB,B3   +4
          1 00044F  CBF0 0100                            LAB,B4   256,IMO
          1 000451  E380 0000 0000  xent                 LNJ,B6   SCREECH
          1 000454       0001                            DC       s:14082+9,PREL
          1 000455  0F81 0004                            B        s:14088,PREL

     1065    14083    3              ELSE RETURN;

  14083   1 000457  C380 0000 0000  xent                 LNJ,B4   X6A_ARET

     1066    14084    3              END;
     1067    14085
     1068    14086        /* If the message isn't for this fep, send it on by calling KNH$SEND.
     1069    14087        */
     1070    14088    2         IF DEST_NODE ~= KN_NODE#

  14088   1 00045A  E847 000D                            LDR,R6   DEST_NODE,AUTO
          1 00045C  E900 0000 0000  xsym                 CMR,R6   KN_NODE#
          1 00045F  0901 00F7                            BE       s:14175,PREL
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:174  

     1071    14089    3         THEN DO;

     1072    14090    3              ROUTE$ = KNN$ROUTE$(DEST_NODE);

  14090   1 000461  EC80 0000 0000  xsym                 LDB,B6   KNN_ROUTE$$
          1 000464  B856                                 LDR,R3   R6
          1 000465  DCB6                                 LDB,B5   ,B6,R3
          1 000466  DFC7 000E                            STB,B5   ROUTE$,AUTO

     1073    14091
     1074    14092    3              IF KNN$ROUTE.LINK$ = ADDR(NIL)

  14092   1 000468  8D85                                 CMN      ,B5
          1 000469  0901 0005                            BE       s:14095,PREL
          1 00046B  CC85                                 LDB,B4   ,B5
          1 00046C  8D84                                 CMN      ,B4
          1 00046D  0981 0004                            BNE      s:14098,PREL

     1075    14093    3                OR KNN$ROUTE.LINK$->KNN$LINK.LDCT$ = ADDR(NIL)
     1076    14094    4              THEN DO;

     1077    14095    4                   RETURN;

  14095   1 00046F  C380 0000 0000  xent                 LNJ,B4   X6A_ARET

     1078    14096    4                   END;
     1079    14097
     1080    14098    3              LINK# = KNN$ROUTE.LINK$->KNN$LINK.LDCT$->KN$LDCT.LINK_ID;

  14098   1 000472  BC84                                 LDB,B3   ,B4
          1 000473  D843 0003                            LDR,R5   3,B3
          1 000475  DF47 0012                            STR,R5   LINK#,AUTO

     1081    14099    3              QQQ$ = KN$NETPARM.LDCT$;

  14099   1 000477  ACC7 0004                            LDB,B2   @KN$NETPARM,AUTO
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:175  
          1 000479  9C82                                 LDB,B1   ,B2
          1 00047A  9FC7 0023                            STB,B1   QQQ$,AUTO

     1082    14100
     1083    14101    3              KN$NETPARM.LDCT$ = KNN$ROUTE.LINK$->KNN$LINK.LDCT$;

  14101   1 00047C  BF82                                 STB,B3   ,B2

     1084    14102
     1085    14103    3              KN$NETPARM.MSGSZ = 0;

  14103   1 00047D  8742 0004                            CL       4,B2

     1086    14104    3              KN$NETPARM.UHDRSZ = 0;

  14104   1 00047F  8742 0007                            CL       7,B2

     1087    14105    3              KN$NETPARM.SHDRSZ = 0;

  14105   1 000481  8742 000A                            CL       10,B2

     1088    14106    3              KN$NETPARM.THDRSZ = 0;

  14106   1 000483  8742 000D                            CL       13,B2

     1089    14107    3              IF KN$LDCT.CONN_TYPE = %KN_CNTYPE_LINK AND

  14107   1 000485  C283                                 LLH,R4   ,B3
          1 000486  4D06                                 CMV,R4   6
          1 000487  0981 0080                            BNE      s:14158,PREL
          1 000489  ECC2 000E                            LDB,B6   14,B2
          1 00048B  A286                                 LLH,R2   ,B6
          1 00048C  A970 00FD                            CMR,R2   253,IMO
          1 00048E  0981 0079                            BNE      s:14158,PREL

     1090    14108    3                B$QDP_HDR.MSGTYP = %K_MSGTYP_CP6_CL4#
     1091    14109    4              THEN DO;
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:176  

     1092    14110                                                /* must be an rfep                    */
     1093    14111    4                   KN$NETPARM.FUNCTION = %KN_FCN_DATA;

  14111   1 000490  1C05                                 LDV,R1   5
          1 000491  9F42 0014                            STR,R1   20,B2

     1094    14112    4                   KN$NETPARM.DST_ADDR$ = ADDR(NIL);

  14112   1 000493  CB80 0000 0000                       LAB,B4   0
          1 000496  CFC2 001F                            STB,B4   31,B2

     1095    14113    4                   KN$NETPARM.SRC_ADDR$ = ADDR(NIL);

  14113   1 000498  EB80 0000 0000                       LAB,B6   0
          1 00049B  EFC2 001D                            STB,B6   29,B2

     1096    14114
     1097    14115        /*
     1098    14116                               if the message is not destined for this node and the
     1099    14117                               source node is link connected and a host, then call
     1100    14118                               transports send for host.  If the destination node is
     1101    14119                               a host and is link connected then call transport receive
     1102    14120                               for host.  If neither is true neither is true then forward
     1103    14121                               the message normally.
     1104    14122        */
     1105    14123    4                   NWHDR_SZ = LENGTHC(B$QDP_HDR); /* patched for pe0f            */

  14123   1 00049D  4C04                                 LDV,R4   4
          1 00049E  CF47 0027                            STR,R4   NWHDR_SZ,AUTO

     1106    14124    4                   KN$NETPARM.THDR$ = PINCRW(KN$NETPARM.NHDR$, NWHDR_SZ/2);

  14124   1 0004A0  4041                                 SOR,R4   1
          1 0004A1  ECC2 000E                            LDB,B6   14,B2
          1 0004A3  EFC7 0094                            STB,B6   ALTQOS+2,AUTO
          1 0004A5  F854                                 LDR,R7   R4
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:177  
          1 0004A6  6C00                                 LDV,R6   0
          1 0004A7  8447 0094                            AID      ALTQOS+2,AUTO
          1 0004A9  8D42 000B                            SDI      11,B2

     1107    14125    4                   KN$NETPARM.THDRSZ = KN$NETPARM.NHDRSZ - NWHDR_SZ;

  14125   1 0004AB  C842 0010                            LDR,R4   16,B2
          1 0004AD  C247 0027                            SUB,R4   NWHDR_SZ,AUTO
          1 0004AF  CF42 000D                            STR,R4   13,B2

     1108    14126    4                   IF KNN$ROUTE$(SOURCE_NODE)->KNN$ROUTE.FLAGS.HOST_NODE

  14126   1 0004B1  EC80 0000 0000  xsym                 LDB,B6   KNN_ROUTE$$
          1 0004B4  A847 0026                            LDR,R2   SOURCE_NODE,AUTO
          1 0004B6  CCA6                                 LDB,B4   ,B6,R2
          1 0004B7  89C4 0007                            CMZ      7,B4
          1 0004B9  0881 0022                            BAGE     s:14138,PREL
          1 0004BB  82C4 0007                            LB,'4000'X        7,B4
          1 0004BD       4000
          1 0004BE  0581 001D                            BBF      s:14138,PREL

     1109    14127    4                     AND KNN$ROUTE$(SOURCE_NODE)->KNN$ROUTE.FLAGS.LINK_CONNECTED THEN
     1110    14128    5                        CALL KNT$SEND_4HOST(KN$NETPARM) WHENRETURN DO;

  14128   1 0004C0  BBC7 0004                            LAB,B3   @KN$NETPARM,AUTO
          1 0004C2  CBF0 0100                            LAB,B4   256,IMO
          1 0004C4  E380 0000 0000  xent                 LNJ,B6   KNT$SEND_4HOST
          1 0004C7       0007                            DC       s:14132,PREL

     1111    14129    5                             KN$NETPARM.THDRSZ = 0;

  14129   1 0004C8  ECC7 0004                            LDB,B6   @KN$NETPARM,AUTO
          1 0004CA  8746 000D                            CL       13,B6

     1112    14130    5                             END;

  14130   1 0004CC  0F81 000D                            B        s:14135+3,PREL
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:178  

     1113    14131    5                        WHENALTRETURN DO;

     1114    14132    5                             IF KN$NETPARM.ERRCODE ~= 0 THEN GOTO RESTORE_QQQ;
             14132                                      /* altret*/

  14132   1 0004CE  ECC7 0004                            LDB,B6   @KN$NETPARM,AUTO
          1 0004D0  E846 0016                            LDR,R6   22,B6
          1 0004D2  6981 010C                            BNEZ,R6  s:14205,PREL

     1115    14133    6                             ELSE DO;      /* message has been buffered by trans*/

     1116    14134    6                                  KN$NETPARM.LDCT$ = QQQ$;

  14134   1 0004D4  DCC7 0023                            LDB,B5   QQQ$,AUTO
          1 0004D6  DF86                                 STB,B5   ,B6

     1117    14135    6                                  RETURN;

  14135   1 0004D7  C380 0000 0000  xent                 LNJ,B4   X6A_ARET
          1 0004DA  0F81 002D                            B        s:14158,PREL

     1118    14136    6                                  END;
     1119    14137    5                             END;
     1120    14138    4                   ELSE IF KNN$ROUTE.FLAGS.HOST_NODE

  14138   1 0004DC  89C5 0007                            CMZ      7,B5
          1 0004DE  0881 0022                            BAGE     s:14155,PREL
          1 0004E0  82C5 0007                            LB,'4000'X        7,B5
          1 0004E2       4000
          1 0004E3  0581 001D                            BBF      s:14155,PREL

     1121    14139    4                          AND KNN$ROUTE.FLAGS.LINK_CONNECTED THEN
     1122    14140    5                             CALL KNT$RECV_4HOST(KN$NETPARM) WHENRETURN DO;

  14140   1 0004E5  BBC7 0004                            LAB,B3   @KN$NETPARM,AUTO
          1 0004E7  CBF0 0100                            LAB,B4   256,IMO
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:179  
          1 0004E9  E380 0000 0000  xent                 LNJ,B6   KNT$RECV_4HOST
          1 0004EC       0007                            DC       s:14144,PREL

     1123    14141    5                                  KN$NETPARM.THDRSZ = 0;

  14141   1 0004ED  ECC7 0004                            LDB,B6   @KN$NETPARM,AUTO
          1 0004EF  8746 000D                            CL       13,B6

     1124    14142    5                                  END;

  14142   1 0004F1  0F81 000D                            B        s:14147+3,PREL

     1125    14143    5                             WHENALTRETURN DO;

     1126    14144    5                                  IF KN$NETPARM.ERRCODE ~= 0 THEN GOTO RESTORE_QQQ;
             14144                                           /*altret*/

  14144   1 0004F3  ECC7 0004                            LDB,B6   @KN$NETPARM,AUTO
          1 0004F5  E846 0016                            LDR,R6   22,B6
          1 0004F7  6981 00E7                            BNEZ,R6  s:14205,PREL

     1127    14145    6                                  ELSE DO; /* message buffered by trans          */

     1128    14146    6                                       KN$NETPARM.LDCT$ = QQQ$;

  14146   1 0004F9  DCC7 0023                            LDB,B5   QQQ$,AUTO
          1 0004FB  DF86                                 STB,B5   ,B6

     1129    14147    6                                       RETURN;

  14147   1 0004FC  C380 0000 0000  xent                 LNJ,B4   X6A_ARET
          1 0004FF  0F81 0008                            B        s:14158,PREL

     1130    14148    6                                       END;
     1131    14149    5                                  END;
     1132    14150    5                        ELSE DO;

PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:180  
     1133    14151                               /*
     1134    14152                               message is not from/to a host don't put a network
     1135    14153                               header on it.
     1136    14154                               */
     1137    14155    5                             KN$NETPARM.THDR$ = ADDR(NIL);

  14155   1 000501  BB80 0000 0000                       LAB,B3   0
          1 000504  BFC2 000B                            STB,B3   11,B2

     1138    14156    5                             KN$NETPARM.THDRSZ = 0;

  14156   1 000506  8742 000D                            CL       13,B2

     1139    14157    5                             END;

     1140    14158    4                   END;

  14155   1                              SENDDATA        null
     1141    14159
     1142    14160    3   SENDDATA:  ;
     1143    14161    3              CALL KNH$SEND (KN$NETPARM) ALTRET(RESTORE_QQQ);

  14161   1 000508  BBC7 0004            SENDDATA        LAB,B3   @KN$NETPARM,AUTO
          1 00050A  CBF0 0100                            LAB,B4   256,IMO
          1 00050C  E380 0000 0000  xent                 LNJ,B6   KNH$SEND
          1 00050F       00D0                            DC       s:14205,PREL

     1144    14162
     1145    14163    3              KN$NETPARM.LDCT$ = QQQ$;

  14163   1 000510  ECC7 0023                            LDB,B6   QQQ$,AUTO
          1 000512  DCC7 0004                            LDB,B5   @KN$NETPARM,AUTO
          1 000514  EF85                                 STB,B6   ,B5

     1146    14164    3              KNN$ROUTE.LINK.MSGS_IN(LINKIN#) = KNN$ROUTE.LINK.MSGS_IN(LINKIN#) + 1;

  14164   1 000515  CCC7 000E                            LDB,B4   ROUTE$,AUTO
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:181  
          1 000517  B847 0013                            LDR,R3   LINKIN#,AUTO
          1 000519  3F0A                                 MLV,R3   10
          1 00051A  5C04                                 LDV,R5   4
          1 00051B  0021                                 ALR      ;
          1 00051C       4434 0009                                ALPHANUM(9,B4,R3,,4),;
          1 00051E       4007 0096                                ALPHANUM(ALTQOS+4,AUTO,,R5,FILL)
          1 000520  437F                                 CSYNC    s:14164+10,SPREL
          1 000521  8CC7 0096                            LDI      ALTQOS+4,AUTO
          1 000523  8470 0000 0001                       AID      1,IMO
          1 000526  8D47 0094                            SDI      ALTQOS+2,AUTO
          1 000528  ABC7 0094                            LAB,B2   ALTQOS+2,AUTO
          1 00052A  2C00                                 LDV,R2   0
          1 00052B  6C04                                 LDV,R6   4
          1 00052C  BB84                                 LAB,B3   ,B4
          1 00052D  3E12                                 ADV,R3   18
          1 00052E  0008                                 MMM

     1147    14165    3              KNN$ROUTE.LINK.MSGS_OUT(LINK#) = KNN$ROUTE.LINK.MSGS_OUT(LINK#) + 1;

  14165   1 00052F  ECC7 000E                            LDB,B6   ROUTE$,AUTO
          1 000531  B847 0012                            LDR,R3   LINK#,AUTO
          1 000533  3F0A                                 MLV,R3   10
          1 000534  0021                                 ALR      ;
          1 000535       4436 000B                                ALPHANUM(11,B6,R3,,4),;
          1 000537       4007 0096                                ALPHANUM(ALTQOS+4,AUTO,,R5,FILL)
          1 000539  437F                                 CSYNC    s:14165+9,SPREL
          1 00053A  8CC7 0096                            LDI      ALTQOS+4,AUTO
          1 00053C  8470 0000 0001                       AID      1,IMO
          1 00053F  8D47 0094                            SDI      ALTQOS+2,AUTO
          1 000541  ABC7 0094                            LAB,B2   ALTQOS+2,AUTO
          1 000543  2C00                                 LDV,R2   0
          1 000544  6C04                                 LDV,R6   4
          1 000545  BB86                                 LAB,B3   ,B6
          1 000546  3E16                                 ADV,R3   22
          1 000547  0008                                 MMM

     1148    14166
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:182  
     1149    14167    3              KNN$ROUTE.LINK$->KNN$LINK.MSGS_IN = KNN$ROUTE.LINK$->KNN$LINK.MSGS_IN+1;

  14167   1 000548  ACC7 000E                            LDB,B2   ROUTE$,AUTO
          1 00054A  9C82                                 LDB,B1   ,B2
          1 00054B  8AC1 0006                            INC      6,B1
          1 00054D  8EC1 0005                            CAD      5,B1

     1150    14168    3             KNN$ROUTE.LINK$->KNN$LINK.MSGS_OUT = KNN$ROUTE.LINK$->KNN$LINK.MSGS_OUT +
             14168                       1;

  14168   1 00054F  9C82                                 LDB,B1   ,B2
          1 000550  8AC1 0008                            INC      8,B1
          1 000552  8EC1 0007                            CAD      7,B1

     1151    14169
     1152    14170    3              RETURN;

  14170   1 000554  C380 0000 0000  xent                 LNJ,B4   X6A_ARET

     1153    14171    3              END;
     1154    14172
     1155    14173        /* Message is for this node.
     1156    14174        */
     1157    14175    2         KN$NETPARM.NODE = SOURCE_NODE;

  14175   1 000557  ECC7 0004                            LDB,B6   @KN$NETPARM,AUTO
          1 000559  D847 0026                            LDR,R5   SOURCE_NODE,AUTO
          1 00055B  DF46 0015                            STR,R5   21,B6

     1158    14176    2         ROUTE$ = KNN$ROUTE$(KN$NETPARM.NODE);

  14176   1 00055D  B855                                 LDR,R3   R5
          1 00055E  DC80 0000 0000  xsym                 LDB,B5   KNN_ROUTE$$
          1 000561  CCB5                                 LDB,B4   ,B5,R3
          1 000562  CFC7 000E                            STB,B4   ROUTE$,AUTO

     1159    14177
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:183  
     1160    14178    2         IF KNN$ROUTE.LINK$ = ADDR(NIL)    /* No route yet                       */

  14178   1 000564  8D84                                 CMN      ,B4
          1 000565  0981 0010                            BNE      s:14189,PREL

     1161    14179    3         THEN DO;

     1162    14180    3              KNN$ROUTE.LINK.QOS(LINK#) = 254;

  14180   1 000567  C870 00FE                            LDR,R4   254,IMO
          1 000569  A847 0012                            LDR,R2   LINK#,AUTO
          1 00056B  2F0A                                 MLV,R2   10
          1 00056C  2E11                                 ADV,R2   17
          1 00056D  C7A4                                 STH,R4   ,B4,R2

     1163    14181    3              CALL UPDATE_ROUTE

  14181   1 00056E  E3C0 0613                            LNJ,B6   s:0,PREL
          1 000570       0003                            DC       s:14183,PREL
          1 000571  0F81 0004                            B        s:14189,PREL

     1164    14182    4              WHENALTRETURN DO;

     1165    14183    4                   ALTRETURN;

  14183   1 000573  C380 0000 0000  xent                 LNJ,B4   X6A_AALT

     1166    14184    4                   END;
     1167    14185    3              END;

     1168    14186
     1169    14187        /* Fix up kn$netparm for transport or session and pass msg on up the layers.
     1170    14188        */
     1171    14189    2         NWHDR_SZ = LENGTHC(B$QDP_HDR);

  14189   1 000576  6C04                                 LDV,R6   4
          1 000577  EF47 0027                            STR,R6   NWHDR_SZ,AUTO
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:184  

     1172    14190
     1173    14191    2         IF B$QDP_HDR.MSGTYP =%K_MSGTYP_CP6_QDP#

  14191   1 000579  ECC7 0004                            LDB,B6   @KN$NETPARM,AUTO
          1 00057B  DCC6 000E                            LDB,B5   14,B6
          1 00057D  D285                                 LLH,R5   ,B5
          1 00057E  D970 00FE                            CMR,R5   254,IMO
          1 000580  0981 001A                            BNE      s:14198,PREL

     1174    14192    3         THEN DO;

     1175    14193    3              KN$NETPARM.SHDR$ = PINCRW(KN$NETPARM.NHDR$, NWHDR_SZ/2);

  14193   1 000582  6041                                 SOR,R6   1
          1 000583  DFC7 0094                            STB,B5   ALTQOS+2,AUTO
          1 000585  F856                                 LDR,R7   R6
          1 000586  6C00                                 LDV,R6   0
          1 000587  8447 0094                            AID      ALTQOS+2,AUTO
          1 000589  8D46 0008                            SDI      8,B6

     1176    14194    3              KN$NETPARM.SHDRSZ = KN$NETPARM.NHDRSZ - NWHDR_SZ;

  14194   1 00058B  D846 0010                            LDR,R5   16,B6
          1 00058D  D247 0027                            SUB,R5   NWHDR_SZ,AUTO
          1 00058F  DF46 000A                            STR,R5   10,B6

     1177    14195    3              CALL KNS$RECV(KN$NETPARM) ALTRET(DO_ALTRET);

  14195   1 000591  BBC7 0004                            LAB,B3   @KN$NETPARM,AUTO
          1 000593  CBF0 0100                            LAB,B4   256,IMO
          1 000595  E380 0000 0000  xent                 LNJ,B6   KNS$RECV
          1 000598       004C                            DC       s:14209,PREL

     1178    14196    3              END;

  14196   1 000599  0F81 0018                            B        s:14203,PREL
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:185  

     1179    14197    3         ELSE DO;

     1180    14198    3              KN$NETPARM.THDR$ = PINCRW(KN$NETPARM.NHDR$, NWHDR_SZ/2);

  14198   1 00059B  6041                                 SOR,R6   1
          1 00059C  DFC7 0094                            STB,B5   ALTQOS+2,AUTO
          1 00059E  F856                                 LDR,R7   R6
          1 00059F  6C00                                 LDV,R6   0
          1 0005A0  8447 0094                            AID      ALTQOS+2,AUTO
          1 0005A2  8D46 000B                            SDI      11,B6

     1181    14199    3              KN$NETPARM.THDRSZ = KN$NETPARM.NHDRSZ - NWHDR_SZ;

  14199   1 0005A4  D846 0010                            LDR,R5   16,B6
          1 0005A6  D247 0027                            SUB,R5   NWHDR_SZ,AUTO
          1 0005A8  DF46 000D                            STR,R5   13,B6

     1182    14200    3              CALL KNT$RECV(KN$NETPARM) ALTRET(DO_ALTRET);

  14200   1 0005AA  BBC7 0004                            LAB,B3   @KN$NETPARM,AUTO
          1 0005AC  CBF0 0100                            LAB,B4   256,IMO
          1 0005AE  E380 0000 0000  xent                 LNJ,B6   KNT$RECV
          1 0005B1       0033                            DC       s:14209,PREL

     1183    14201    3              END;

     1184    14202
     1185    14203    2         ROUTE$ = KNN$ROUTE$(KN_NODE#);

  14203   1 0005B2  EC80 0000 0000  xsym                 LDB,B6   KNN_ROUTE$$
          1 0005B5  B800 0000 0000  xsym                 LDR,R3   KN_NODE#
          1 0005B8  DCB6                                 LDB,B5   ,B6,R3
          1 0005B9  DFC7 000E                            STB,B5   ROUTE$,AUTO

     1186    14204    2         KNN$ROUTE.LINK.MSGS_IN(LINK#) = KNN$ROUTE.LINK.MSGS_IN(LINK#) + 1;

PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:186  
  14204   1 0005BB  A847 0012                            LDR,R2   LINK#,AUTO
          1 0005BD  2F0A                                 MLV,R2   10
          1 0005BE  5C04                                 LDV,R5   4
          1 0005BF  0021                                 ALR      ;
          1 0005C0       4425 0009                                ALPHANUM(9,B5,R2,,4),;
          1 0005C2       4007 0096                                ALPHANUM(ALTQOS+4,AUTO,,R5,FILL)
          1 0005C4  437F                                 CSYNC    s:14204+8,SPREL
          1 0005C5  8CC7 0096                            LDI      ALTQOS+4,AUTO
          1 0005C7  8470 0000 0001                       AID      1,IMO
          1 0005CA  8D47 0094                            SDI      ALTQOS+2,AUTO
          1 0005CC  ABC7 0094                            LAB,B2   ALTQOS+2,AUTO
          1 0005CE  2C00                                 LDV,R2   0
          1 0005CF  6C04                                 LDV,R6   4
          1 0005D0  BB85                                 LAB,B3   ,B5
          1 0005D1  B847 0012                            LDR,R3   LINK#,AUTO
          1 0005D3  3F0A                                 MLV,R3   10
          1 0005D4  3E12                                 ADV,R3   18
          1 0005D5  0008                                 MMM

     1187    14205    2         KNN$LINK.MSGS_IN = KNN$LINK.MSGS_IN + 1;

  14205   1 0005D6  ECC7 0010                            LDB,B6   LINK$,AUTO
          1 0005D8  8AC6 0006                            INC      6,B6
          1 0005DA  8EC6 0005                            CAD      5,B6

     1188    14206    2         RETURN;

  14206   1 0005DC  C380 0000 0000  xent                 LNJ,B4   X6A_ARET

  14205   1                              RESTORE_QQQ     null
     1189    14207
     1190    14208    2   RESTORE_QQQ: ;
     1191    14209    2         KN$NETPARM.LDCT$ = QQQ$;

  14209   1 0005DF  ECC7 0023            RESTORE_QQQ     LDB,B6   QQQ$,AUTO
          1 0005E1  DCC7 0004                            LDB,B5   @KN$NETPARM,AUTO
          1 0005E3  EF85                                 STB,B6   ,B5
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:187  

  14209   1                              DO_ALTRET       null
     1192    14210    2   DO_ALTRET: ;
     1193    14211    2         B$QDP_HDR.HOP_COUNT = B$QDP_HDR.HOP_COUNT -1;

  14211   1 0005E4  ECC7 0004            DO_ALTRET       LDB,B6   @KN$NETPARM,AUTO
          1 0005E6  DCC6 000E                            LDB,B5   14,B6
          1 0005E8  E805                                 LDR,R6   ,B5
          1 0005E9  EA70 00FF                            ADD,R6   255,IMO
          1 0005EB  EA85                                 SRM,R6,'00FF'X    ,B5
          1 0005EC       00FF

     1194    14212    2         ALTRETURN;

  14212   1 0005ED  C380 0000 0000  xent                 LNJ,B4   X6A_AALT

     1195    14213
     1196    14214        %EJECT;
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:188  
     1197    14215
     1198    14216        /*F* NAME: KNN$RECV - Unqueue
     1199    14217
     1200    14218        KNN$RECV is called from KNH$SCAN if the user has removed items
     1201    14219        from his receive circular queue since the last scan and there are
     1202    14220        other user's messages queued waiting for space in that queue.
     1203    14221        No FPT is passed on this call.
     1204    14222
     1205    14223        KN$NETPARM.LDCT$ has been set from KNH$HMI.WAIT_HEAD$, so it
     1206    14224        contains the address of the first LDCT queued.
     1207    14225
     1208    14226        KNN$RECV does nothing but pass the NETPARM on up the layers
     1209    14227        by calling KNT$RECV with the function set to KN_FCN_UNQ.
     1210    14228        */
     1211    14229
     1212    14230    2       CASE (%KN_FCN_UNQ);                 /* Link requests a unqueue.           */

     1213    14231                   /*
     1214    14232                    *    A previous term ack failed to make it to the user.
     1215    14233                    *    attempt to send the term_ack now.  If we are successful
     1216    14234                    *    set the ldct.rel flag so that scan will release the ldct.
     1217    14235                    */
     1218    14236    2         KN$NETPARM.FPT$ = ADDR(FPT@TERM_ACK);

  14236   1 0005F0  EB80 0000 0012  00                   LAB,B6   FPT@TERM_ACK
          1 0005F3  DCC7 0004                            LDB,B5   @KN$NETPARM,AUTO
          1 0005F5  EFC5 0019                            STB,B6   25,B5

     1219    14237    2         KN$NETPARM.FUNCTION = %KN_FCN_TERM_ACK;

  14237   1 0005F7  6C04                                 LDV,R6   4
          1 0005F8  EF45 0014                            STR,R6   20,B5

     1220    14238    2         KN$NETPARM.NHDR$ = ADDR(NIL);

  14238   1 0005FA  CB80 0000 0000                       LAB,B4   0
          1 0005FD  CFC5 000E                            STB,B4   14,B5
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:189  

     1221    14239    2         KN$NETPARM.NHDRSZ = 0;

  14239   1 0005FF  8745 0010                            CL       16,B5

     1222    14240    2         KN$NETPARM.SLDCT$ = KN$NETPARM.LDCT$;

  14240   1 000601  BC85                                 LDB,B3   ,B5
          1 000602  BFC5 0017                            STB,B3   23,B5

     1223    14241    3         CALL KNH$SEND(KN$NETPARM) WHENALTRETURN DO;

  14241   1 000604  BBC7 0004                            LAB,B3   @KN$NETPARM,AUTO
          1 000606  CBF0 0100                            LAB,B4   256,IMO
          1 000608  E380 0000 0000  xent                 LNJ,B6   KNH$SEND
          1 00060B       0003                            DC       s:14242,PREL
          1 00060C  0F81 000A                            B        s:14245,PREL

     1224    14242    3              KN$LDCT.FLAGS.REL = '0'B; /* dont release the ldct. we aren't done*/

  14242   1 00060E  ECC7 0004                            LDB,B6   @KN$NETPARM,AUTO
          1 000610  DC86                                 LDB,B5   ,B6
          1 000611  8845 000A                            LBF,'4000'X       10,B5
          1 000613       4000

     1225    14243    3              RETURN;                      /* doesn't matter scan doesn't check  */

  14243   1 000614  C380 0000 0000  xent                 LNJ,B4   X6A_ARET

     1226    14244    3              END;
     1227    14245    2         KN$LDCT.FLAGS.REL = '1'B;         /* let scan release it now            */

  14245   1 000617  ECC7 0004                            LDB,B6   @KN$NETPARM,AUTO
          1 000619  DC86                                 LDB,B5   ,B6
          1 00061A  8945 000A                            LBT,'4000'X       10,B5
          1 00061C       4000

PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:190  
     1228    14246    2         KNN$LINK.LDCT$ = ADDR(NIL);

  14246   1 00061D  DB80 0000 0000                       LAB,B5   0
          1 000620  CCC7 0010                            LDB,B4   LINK$,AUTO
          1 000622  DF84                                 STB,B5   ,B4

     1229    14247    2         RETURN;

  14247   1 000623  C380 0000 0000  xent                 LNJ,B4   X6A_ARET

     1230    14248
     1231    14249        %EJECT;
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:191  
     1232    14250
     1233    14251        /*F* NAME: KNN$RECV - Terminate connection
     1234    14252
     1235    14253        KNN$RECV is also called from KNH$CLOSE when a link handler
     1236    14254        terminates.
     1237    14255
     1238    14256        The parameters are:
     1239    14257        .fif
     1240    14258        } KN$NETPARM.FUNCTION
     1241    14259        }                - The function to be performed.  This will be the
     1242    14260        }                  folowing EQUed value from the file KNH_MACRO_M:
     1243    14261        }                      KN_FCN_TERM
     1244    14262        }
     1245    14263        } KN$NETPARM.LDCT$ - contains the LDCT of the destination
     1246    14264        }                    end-point on this fep.
     1247    14265        }
     1248    14266        } FPT_TERM    - This parameter is passed in KN$NETPARM.FPT$, but
     1249    14267        }               we don't use it.
     1250    14268        }
     1251    14269        .fin
     1252    14270
     1253    14271        */
     1254    14272
     1255    14273    2       CASE (%KN_FCN_TERM);

     1256    14274
     1257    14275              %LOCK (G=KNN_LOCK);

  14280   1 000626  BB80 0000 0002  02                   LAB,B3   +2
          1 000629  CBF0 0100                            LAB,B4   256,IMO
          1 00062B  E380 0000 0000  xent                 LNJ,B6   GHH$LOCK
          1 00062E       0001                            DC       s:14282,PREL

     1258    14282    2         QQQ$ = KN$NETPARM.LDCT$;

  14282   1 00062F  ECC7 0004                            LDB,B6   @KN$NETPARM,AUTO
          1 000631  DC86                                 LDB,B5   ,B6
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:192  
          1 000632  DFC7 0023                            STB,B5   QQQ$,AUTO

     1259    14283    2         IF KN$LDCT.FLAGS.REL THEN

  14283   1 000634  82C5 000A                            LB,'4000'X        10,B5
  14283   1 000636       4000
          1 000637  0501 00CC                            BBT      s:14347,PREL

     1260    14284                      /*
     1261    14285                       *we already sent the disconnect_ind but the term ack failed to
     1262    14286                       *make it thru the cq of the handler(hdlc).
     1263    14287                       */
     1264    14288    2              GOTO DONTSENDOSIDOWN;
     1265    14289    3         IF KN$LDCT.CONN_TYPE = %KN_CNTYPE_CIRCUIT THEN DO;

  14289   1 000639  E285                                 LLH,R6   ,B5
          1 00063A  6D07                                 CMV,R6   7
          1 00063B  0981 001C                            BNE      s:14305,PREL

     1266    14290    3              KN$NETPARM.FUNCTION = %K_NDISCONNECT_IND;

  14290   1 00063D  5C24                                 LDV,R5   36
          1 00063E  DF46 0014                            STR,R5   20,B6

     1267    14291    4              CALL KNT$RECV_4HOST(KN$NETPARM) WHENALTRETURN DO;

  14291   1 000640  BBC7 0004                            LAB,B3   @KN$NETPARM,AUTO
          1 000642  CBF0 0100                            LAB,B4   256,IMO
          1 000644  E380 0000 0000  xent                 LNJ,B6   KNT$RECV_4HOST
          1 000647       0003                            DC       s:14297,PREL
          1 000648  0F81 000D                            B        s:14301,PREL

     1268    14292                        %UNLOCK(G=KNN_LOCK);

  14297   1 00064A  BB80 0000 0002  02                   LAB,B3   +2
          1 00064D  CBF0 0100                            LAB,B4   256,IMO
          1 00064F  E380 0000 0000  xent                 LNJ,B6   GHH$UNLOCK
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:193  
          1 000652       0001                            DC       s:14299,PREL

     1269    14299    4                   ALTRETURN;

  14299   1 000653  C380 0000 0000  xent                 LNJ,B4   X6A_AALT

     1270    14300    4                   END;
     1271    14301    3              GOTO DONTSENDOSIDOWN;

  14301   1 000656  0F81 00AD                            B        s:14347,PREL

     1272    14302    3              END;
     1273    14303
     1274    14304
     1275    14305    2         DEST_NODE = KN$LDCT.RLCID.NODE;

  14305   1 000658  D2C5 0001                            LLH,R5   1,B5
          1 00065A  DF47 000D                            STR,R5   DEST_NODE,AUTO

     1276    14306    2         LINK$ = KNN$LINK$(KN$LDCT.LINK_ID);

  14306   1 00065C  B845 0003                            LDR,R3   3,B5
          1 00065E  CC80 0000 0000  xsym                 LDB,B4   KNN_LINK$$
          1 000661  BCB4                                 LDB,B3   ,B4,R3
          1 000662  BFC7 0010                            STB,B3   LINK$,AUTO

     1277    14307    2         LINK# = KN$LDCT.LINK_ID;

  14307   1 000664  BF47 0012                            STR,R3   LINK#,AUTO

     1278    14308    2         QOS = KNN$LINK.QOS;

  14308   1 000666  C843 0004                            LDR,R4   4,B3
          1 000668  CF47 0016                            STR,R4   QOS,AUTO

     1279    14309    2         SNPA = KNN$LINK.SNPA;

PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:194  
  14309   1 00066A  AB83                                 LAB,B2   ,B3
          1 00066B  2C3E                                 LDV,R2   62
          1 00066C  6C08                                 LDV,R6   8
          1 00066D  BBC7 0061                            LAB,B3   SNPA,AUTO
          1 00066F  3C00                                 LDV,R3   0
          1 000670  0008                                 MMM

     1280    14310    2         IF KN$LDCT.FLAGS.REL THEN GOTO DONTSENDOSIDOWN;

  14310   1 000671  DC86                                 LDB,B5   ,B6
          1 000672  82C5 000A                            LB,'4000'X        10,B5
          1 000674       4000
          1 000675  0501 008E                            BBT      s:14347,PREL

     1281    14311
     1282    14312    3         IF DEST_NODE < %K_CNC_IS# THEN DO;

  14312   1 000677  E847 000D                            LDR,R6   DEST_NODE,AUTO
          1 000679  E970 00FD                            CMR,R6   253,IMO
          1 00067B  0281 0023                            BGE      s:14328,PREL

     1283    14313    3              CALL LINK_DOWN

  14313   1 00067D  E3C0 06DF                            LNJ,B6   s:0,PREL
          1 00067F       0003                            DC       s:14320,PREL
          1 000680  0F81 000D                            B        s:14324,PREL

     1284    14314    4              WHENALTRETURN DO;

     1285    14315                        %UNLOCK (G=KNN_LOCK);

  14320   1 000682  BB80 0000 0002  02                   LAB,B3   +2
          1 000685  CBF0 0100                            LAB,B4   256,IMO
          1 000687  E380 0000 0000  xent                 LNJ,B6   GHH$UNLOCK
          1 00068A       0001                            DC       s:14322,PREL

     1286    14322    4                   ALTRETURN;
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:195  

  14322   1 00068B  C380 0000 0000  xent                 LNJ,B4   X6A_AALT

     1287    14323    4                   END;
     1288    14324    3              IF KNN$ROUTE$(DEST_NODE)->KNN$ROUTE.CURRENT_QOS = 255 THEN

  14324   1 00068E  EC80 0000 0000  xsym                 LDB,B6   KNN_ROUTE$$
          1 000691  B847 000D                            LDR,R3   DEST_NODE,AUTO
          1 000693  DCB6                                 LDB,B5   ,B6,R3
          1 000694  E845 0005                            LDR,R6   5,B5
          1 000696  E970 00FF                            CMR,R6   255,IMO
          1 000698  0981 006B                            BNE      s:14347,PREL

     1289    14325    3                   KNN$ROUTE$(DEST_NODE)->KNN$ROUTE.FLAGS.LINK_CONNECTED = '0'B;

  14325   1 00069A  8845 0007                            LBF,'4000'X       7,B5
  14325   1 00069C       4000

     1290    14326    3              END;               /* dont call linkdown on linklevel connections*/

  14326   1 00069D  0F81 0066                            B        s:14347,PREL

     1291    14327    2         ELSE
     1292    14328    3              IF NOT KNN$LINK.FLAGS.VIRCIR THEN DO;

  14328   1 00069F  CCC7 0010                            LDB,B4   LINK$,AUTO
          1 0006A1  82C4 0003                            LB,'1000'X        3,B4
          1 0006A3       1000
          1 0006A4  0501 005F                            BBT      s:14347,PREL

     1293    14329                         /*
     1294    14330                            if another link to this same network exists
     1295    14331                            dont call osilink_down
     1296    14332                         */
     1297    14333    4                   DO I = 0 TO KNN_LINKS-1;

  14333   1 0006A6  8747 0017                            CL       I,AUTO
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:196  
          1 0006A8  0F81 0019                            B        s:14337+2,PREL

     1298    14334    4                        IF LINK# ~= I

  14334   1 0006AA  E847 0012                            LDR,R6   LINK#,AUTO
          1 0006AC  E947 0017                            CMR,R6   I,AUTO
          1 0006AE  0901 0011                            BE       s:14337,PREL
          1 0006B0  EC80 0000 0000  xsym                 LDB,B6   KNN_LINK$$
          1 0006B3  B847 0017                            LDR,R3   I,AUTO
          1 0006B5  DCB6                                 LDB,B5   ,B6,R3
          1 0006B6  CCC7 0010                            LDB,B4   LINK$,AUTO
          1 0006B8  5C08                                 LDV,R5   8
          1 0006B9  0022                                 ACM      ;
          1 0006BA       4805 001F                                ALPHANUM(31,B5,,8,FILL),;
          1 0006BC       4004 001F                                ALPHANUM(31,B4,,R5,FILL)
          1 0006BE  5381 0045                            CBE      s:14347,PREL

     1299    14335    4                          AND KNN$LINK$(I)->KNN$LINK.SNPA = KNN$LINK.SNPA THEN
     1300    14336    4                             GOTO DONTSENDOSIDOWN;
     1301    14337    4                        END;

  14337   1 0006C0  8AC7 0017                            INC      I,AUTO
          1 0006C2  E847 0017                            LDR,R6   I,AUTO
          1 0006C4  E900 0000 0000  xsym                 CMR,R6   KNN_LINKS
          1 0006C7  0263                                 BL       s:14334,SPREL

     1302    14338    3                   DEST_NODE = KN_NODE#;   /* so we know its this node           */

  14338   1 0006C8  D800 0000 0000  xsym                 LDR,R5   KN_NODE#
          1 0006CB  DF47 000D                            STR,R5   DEST_NODE,AUTO

     1303    14339    3                   IF KNN$LINK.SNPA.LEN = 0 THEN GOTO DONTSENDOSIDOWN;

  14339   1 0006CD  ECC7 0010                            LDB,B6   LINK$,AUTO
          1 0006CF  C2C6 001F                            LLH,R4   31,B6
          1 0006D1  4901 0032                            BEZ,R4   s:14347,PREL

PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:197  
     1304    14340    3                   CALL OSILINK_DOWN;

  14340   1 0006D3  E3C0 085C                            LNJ,B6   s:0,PREL
          1 0006D5       0001                            DC       s:14341,PREL

     1305    14341    3                   OSILINKCHG.FCN = IGA_OSILINKDOWN;

  14341   1 0006D6  6C59                                 LDV,R6   89
          1 0006D7  E7C7 0051                            STH,R6   OSILINKCHG,AUTO

     1306    14342    3                   OSILINKCHG.SNPA = SNPA;

  14342   1 0006D9  ABC7 0061                            LAB,B2   SNPA,AUTO
          1 0006DB  2C00                                 LDV,R2   0
          1 0006DC  6C08                                 LDV,R6   8
          1 0006DD  BBC7 0055                            LAB,B3   OSILINKCHG+4,AUTO
          1 0006DF  3C00                                 LDV,R3   0
          1 0006E0  0008                                 MMM

     1307    14343    3                   OSILINKCHG.QOS = QOS;

  14343   1 0006E1  E847 0016                            LDR,R6   QOS,AUTO
          1 0006E3  E7C7 0053                            STH,R6   OSILINKCHG+2,AUTO

     1308    14344    3                   OSILINKCHG.TERMID.TERM.CHANNEL = KNN$LINK.CHAN#;

  14344   1 0006E5  ECC7 0010                            LDB,B6   LINK$,AUTO
          1 0006E7  D846 0023                            LDR,R5   35,B6
          1 0006E9  DF47 005A                            STR,R5   OSILINKCHG+9,AUTO

     1309    14345    3                   OSILINKCHG.MYNODE# = KN_NODE#;

  14345   1 0006EB  C800 0000 0000  xsym                 LDR,R4   KN_NODE#
          1 0006EE  C7C7 0052                            STH,R4   OSILINKCHG+1,AUTO

     1310    14346    3                   CALL KNB$WRITE(ADDR(OSILINKCHG),SIZEC(OSILINKCHG));
             14346                            /* drop altreturn if any */
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:198  

  14346   1 0006F0  DBC7 0051                            LAB,B5   OSILINKCHG,AUTO
          1 0006F2  DFC7 0094                            STB,B5   ALTQOS+2,AUTO
          1 0006F4  CBF0 0020                            LAB,B4   32,IMO
          1 0006F6  CFC7 0098                            STB,B4   ALTQOS+6,AUTO
          1 0006F8  BBC7 0094                            LAB,B3   ALTQOS+2,AUTO
          1 0006FA  BFC7 0096                            STB,B3   ALTQOS+4,AUTO
          1 0006FC  BBC7 0096                            LAB,B3   ALTQOS+4,AUTO
          1 0006FE  CBF0 0200                            LAB,B4   512,IMO
          1 000700  E380 0000 0000  xent                 LNJ,B6   KNB$WRITE
          1 000703       0001                            DC       s:14347,PREL

     1311    14347    3                   END;

  14346   1                              DONTSENDOSIDOWN null
     1312    14348
     1313    14349    2   DONTSENDOSIDOWN:;
     1314    14350    2         KN$NETPARM = KN_NETPARM_INIT;

  14350   1 000704  AB80 0000 0000  xsym DONTSENDOSIDOWN LAB,B2   KN_NETPARM_INIT
          1 000707  2C00                                 LDV,R2   0
          1 000708  6C42                                 LDV,R6   66
          1 000709  BCC7 0004                            LDB,B3   @KN$NETPARM,AUTO
          1 00070B  3C00                                 LDV,R3   0
          1 00070C  0008                                 MMM

     1315    14351    2         KN$NETPARM.LDCT$ = QQQ$;

  14351   1 00070D  ECC7 0023                            LDB,B6   QQQ$,AUTO
          1 00070F  EF83                                 STB,B6   ,B3

     1316    14352    2         I = KN$LDCT.CONN_TYPE;       /* save because ldct is released in send   */

  14352   1 000710  E286                                 LLH,R6   ,B6
          1 000711  EF47 0017                            STR,R6   I,AUTO

     1317    14353    2         KN$NETPARM.FUNCTION = %KN_FCN_TERM_ACK;
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:199  

  14353   1 000713  5C04                                 LDV,R5   4
          1 000714  DF43 0014                            STR,R5   20,B3

     1318    14354    2         KN$NETPARM.FPT$ = ADDR(FPT@TERM_ACK);

  14354   1 000716  DB80 0000 0012  00                   LAB,B5   FPT@TERM_ACK
          1 000719  DFC3 0019                            STB,B5   25,B3

     1319    14355    2         IF (I ~= %KN_CNTYPE_CIRCUIT) THEN

  14355   1 00071B  6D07                                 CMV,R6   7
          1 00071C  0901 0009                            BE       s:14357,PREL

     1320    14356    2              KNN$LINK.SNPA = '0'B;

  14356   1 00071E  CCC7 0010                            LDB,B4   LINK$,AUTO
          1 000720  5C08                                 LDV,R5   8
          1 000721  0021                                 ALR      ;
          1 000722       4178 0000                                ALPHANUM('0000'X,IMO,,1),;
          1 000724       4004 001F                                ALPHANUM(31,B4,,R5,FILL)

     1321    14357    2         KN$NETPARM.NHDRSZ=0;

  14357   1 000726  437F                                 CSYNC    s:14356+7,SPREL
          1 000727  8743 0010                            CL       16,B3

     1322    14358    2         KN$NETPARM.NHDR$ = ADDR(NIL);

  14358   1 000729  EB80 0000 0000                       LAB,B6   0
          1 00072C  EFC3 000E                            STB,B6   14,B3

     1323    14359
     1324    14360    3         CALL KNH$SEND (KN$NETPARM) WHENALTRETURN DO;

  14360   1 00072E  BBC7 0004                            LAB,B3   @KN$NETPARM,AUTO
          1 000730  CBF0 0100                            LAB,B4   256,IMO
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:200  
          1 000732  E380 0000 0000  xent                 LNJ,B6   KNH$SEND
          1 000735       0003                            DC       s:14364,PREL
          1 000736  0F81 0027                            B        s:14380,PREL

     1325    14361                   /*
     1326    14362                    *setup a call to timer routine.
     1327    14363                    */
     1328    14364    3              CALL KNN$SENDTERM_ACK(KN$LDCT.LDCTX);

  14364   1 000738  ECC7 0004                            LDB,B6   @KN$NETPARM,AUTO
          1 00073A  DC86                                 LDB,B5   ,B6
          1 00073B  CBC5 0007                            LAB,B4   7,B5
          1 00073D  CFC7 0094                            STB,B4   ALTQOS+2,AUTO
          1 00073F  BBC7 0094                            LAB,B3   ALTQOS+2,AUTO
          1 000741  CBF0 0100                            LAB,B4   256,IMO
          1 000743  E380 0000 0000  xent                 LNJ,B6   KNN$SENDTERM_ACK
          1 000746       0001                            DC       s:14365,PREL

     1329    14365    3              KN$LDCT.FLAGS.REL = '1'B;

  14365   1 000747  ECC7 0004                            LDB,B6   @KN$NETPARM,AUTO
          1 000749  DC86                                 LDB,B5   ,B6
          1 00074A  8945 000A                            LBT,'4000'X       10,B5
          1 00074C       4000

     1330    14366    3              KN$LDCT.USER_ENTRY$ = ENTADDR(KNN$RECV);

  14366   1 00074D  DC86                                 LDB,B5   ,B6
          1 00074E  CBC0 F8B1                            LAB,B4   s:9,PREL
          1 000750  CFC5 000C                            STB,B4   12,B5

     1331    14367                   %UNLOCK (G=KNN_LOCK);

  14372   1 000752  BB80 0000 0002  02                   LAB,B3   +2
          1 000755  CBF0 0100                            LAB,B4   256,IMO
          1 000757  E380 0000 0000  xent                 LNJ,B6   GHH$UNLOCK
          1 00075A       0001                            DC       s:14378,PREL
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:201  

     1332    14374                   /*
     1333    14375                    * return releases the message. subsequent timer event will cause
     1334    14376                    ldct to be released
     1335    14377                    */
     1336    14378    3              RETURN;

  14378   1 00075B  C380 0000 0000  xent                 LNJ,B4   X6A_ARET

     1337    14379    3              END;
     1338    14380    2         IF I ~= %KN_CNTYPE_CIRCUIT THEN

  14380   1 00075E  E847 0017                            LDR,R6   I,AUTO
          1 000760  6D07                                 CMV,R6   7
          1 000761  0901 0007                            BE       s:14387,PREL

     1339    14381    2              KNN$LINK.LDCT$ = ADDR(NIL);

  14381   1 000763  EB80 0000 0000                       LAB,B6   0
          1 000766  DCC7 0010                            LDB,B5   LINK$,AUTO
          1 000768  EF85                                 STB,B6   ,B5

     1340    14382              %UNLOCK (G=KNN_LOCK);

  14387   1 000769  BB80 0000 0002  02                   LAB,B3   +2
          1 00076C  CBF0 0100                            LAB,B4   256,IMO
          1 00076E  E380 0000 0000  xent                 LNJ,B6   GHH$UNLOCK
          1 000771       0001                            DC       s:14389,PREL

     1341    14389    2         RETURN;

  14389   1 000772  C380 0000 0000  xent                 LNJ,B4   X6A_ARET

     1342    14390
     1343    14391        %EJECT;
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:202  
     1344    14392    2       CASE (%KN_FCN_BLOCK);

     1345    14393              %LOCK(G=KNN_LOCK);

  14398   1 000775  BB80 0000 0002  02                   LAB,B3   +2
          1 000778  CBF0 0100                            LAB,B4   256,IMO
          1 00077A  E380 0000 0000  xent                 LNJ,B6   GHH$LOCK
          1 00077D       0001                            DC       s:14400,PREL

     1346    14400    2         LINK# = KN$LDCT.LINK_ID;

  14400   1 00077E  ECC7 0004                            LDB,B6   @KN$NETPARM,AUTO
          1 000780  DC86                                 LDB,B5   ,B6
          1 000781  E845 0003                            LDR,R6   3,B5
          1 000783  EF47 0012                            STR,R6   LINK#,AUTO

     1347    14401    2         LINK$ = KNN$LINK$(LINK#);

  14401   1 000785  CC80 0000 0000  xsym                 LDB,B4   KNN_LINK$$
          1 000788  B856                                 LDR,R3   R6
          1 000789  BCB4                                 LDB,B3   ,B4,R3
          1 00078A  BFC7 0010                            STB,B3   LINK$,AUTO

     1348    14402    2         KNN$LINK.BLKCNT = KNN$LINK.BLKCNT + 1;

  14402   1 00078C  8AC3 0024                            INC      36,B3

     1349    14403    2         IF KNN$LINK.FLAGS.CLASS_A

  14403   1 00078E  82C3 0003                            LB,'4000'X        3,B3
  14403   1 000790       4000
          1 000791  0501 0006                            BBT      s:14410,PREL
          1 000793  82C3 0003                            LB,'1000'X        3,B3
          1 000795       1000
          1 000796  0501 000D                            BBT      s:14414,PREL

     1350    14404    3           OR NOT KNN$LINK.FLAGS.VIRCIR THEN DO;
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:203  

     1351    14405                   %UNLOCK(G=KNN_LOCK);

  14410   1 000798  BB80 0000 0002  02                   LAB,B3   +2
          1 00079B  CBF0 0100                            LAB,B4   256,IMO
          1 00079D  E380 0000 0000  xent                 LNJ,B6   GHH$UNLOCK
          1 0007A0       0001                            DC       s:14412,PREL

     1352    14412    3              RETURN;                      /* sorry no blockee classA connections*/

  14412   1 0007A1  C380 0000 0000  xent                 LNJ,B4   X6A_ARET

     1353    14413    3              END;
     1354    14414    2         CQOS = 255;

  14414   1 0007A4  D870 00FF                            LDR,R5   255,IMO
          1 0007A6  DF47 0015                            STR,R5   CQOS,AUTO

     1355    14415    2         CLNK# = -1;

  14415   1 0007A8  8947 0014                            LBT,'FFFF'X       CLNK#,AUTO
  14415   1 0007AA       FFFF

     1356    14416    3         DO J = 0 TO KNN_LINKS-1;

  14416   1 0007AB  8747 0018                            CL       J,AUTO
          1 0007AD  0F81 0031                            B        s:14426+2,PREL

     1357    14417    3              IF KNN$ROUTE$(KNN$LINK.NODE#)->KNN$ROUTE.LINK.ACTIVE(J)

  14417   1 0007AF  ECC7 0010                            LDB,B6   LINK$,AUTO
          1 0007B1  B846 0002                            LDR,R3   2,B6
          1 0007B3  DC80 0000 0000  xsym                 LDB,B5   KNN_ROUTE$$
          1 0007B6  CCB5                                 LDB,B4   ,B5,R3
          1 0007B7  A847 0018                            LDR,R2   J,AUTO
          1 0007B9  2F05                                 MLV,R2   5
          1 0007BA  2E08                                 ADV,R2   8
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:204  
          1 0007BB  89A4                                 CMZ      ,B4,R2
          1 0007BC  0881 0020                            BAGE     s:14426,PREL
          1 0007BE  BC80 0000 0000  xsym                 LDB,B3   KNN_LINK$$
          1 0007C1  9847 0018                            LDR,R1   J,AUTO
          1 0007C3  AC93                                 LDB,B2   ,B3,R1
          1 0007C4  B942 0002                            CMR,R3   2,B2
          1 0007C6  0981 0016                            BNE      s:14426,PREL
          1 0007C8  82C2 0003                            LB,'2000'X        3,B2
          1 0007CA       2000
          1 0007CB  0501 0011                            BBT      s:14426,PREL
          1 0007CD  9947 0012                            CMR,R1   LINK#,AUTO
          1 0007CF  0901 000D                            BE       s:14426,PREL

     1358    14418    3                AND KNN$LINK$(J)->KNN$LINK.NODE# = KNN$LINK.NODE#
     1359    14419    3                AND NOT KNN$LINK$(J)->KNN$LINK.FLAGS.BLOCKED
     1360    14420    4                AND LINK# ~= J THEN DO;

     1361    14421    5                   IF CQOS > KNN$LINK$(J)->KNN$LINK.QOS THEN DO;

  14421   1 0007D1  E847 0015                            LDR,R6   CQOS,AUTO
          1 0007D3  E942 0004                            CMR,R6   4,B2
          1 0007D5  0381 0007                            BLE      s:14426,PREL

     1362    14422    5                        CQOS = KNN$LINK$(J)->KNN$LINK.QOS;

  14422   1 0007D7  E842 0004                            LDR,R6   4,B2
          1 0007D9  EF47 0015                            STR,R6   CQOS,AUTO

     1363    14423    5                        CLNK# = J;

  14423   1 0007DB  9F47 0014                            STR,R1   CLNK#,AUTO

     1364    14424    5                        END;

     1365    14425    4                   END;

     1366    14426    3              END;
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:205  

  14426   1 0007DD  8AC7 0018                            INC      J,AUTO
          1 0007DF  E847 0018                            LDR,R6   J,AUTO
          1 0007E1  E900 0000 0000  xsym                 CMR,R6   KNN_LINKS
          1 0007E4  024B                                 BL       s:14417,SPREL

     1367    14427
     1368    14428    3         IF CLNK# ~= -1 THEN DO;      /* found a link to replace the blocked link*/

  14428   1 0007E5  D847 0014                            LDR,R5   CLNK#,AUTO
          1 0007E7  5DFF                                 CMV,R5   -1
          1 0007E8  0901 0056                            BE       s:14456,PREL

     1369    14429    3              KNN$LINK.FLAGS.BLOCKED = '1'B; /* mark old link as blocked         */

  14429   1 0007EA  ECC7 0010                            LDB,B6   LINK$,AUTO
          1 0007EC  8946 0003                            LBT,'2000'X       3,B6
          1 0007EE       2000

     1370    14430    4              DO I = 0 TO KNN_NODES;

  14430   1 0007EF  8747 0017                            CL       I,AUTO
          1 0007F1  0F81 0046                            B        s:14449+2,PREL

     1371    14431    4                   IF KNN$ROUTE$(I)->KNN$ROUTE.LINK# = LINK#

  14431   1 0007F3  EC80 0000 0000  xsym                 LDB,B6   KNN_ROUTE$$
          1 0007F6  B847 0017                            LDR,R3   I,AUTO
          1 0007F8  DCB6                                 LDB,B5   ,B6,R3
          1 0007F9  E845 0004                            LDR,R6   4,B5
          1 0007FB  6801 003A                            BLZ,R6   s:14449,PREL
          1 0007FD  E947 0012                            CMR,R6   LINK#,AUTO
          1 0007FF  0981 0036                            BNE      s:14449,PREL
          1 000801  D845 0005                            LDR,R5   5,B5
          1 000803  D970 00FF                            CMR,R5   255,IMO
          1 000805  0281 0030                            BGE      s:14449,PREL

PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:206  
     1372    14432    5                     AND KNN$ROUTE$(I)->KNN$ROUTE.CURRENT_QOS < 255 THEN DO;

     1373    14433    5                        KNN$ROUTE$(I)->KNN$ROUTE.LINK# = CLNK#;

  14433   1 000807  E847 0014                            LDR,R6   CLNK#,AUTO
          1 000809  EF45 0004                            STR,R6   4,B5

     1374    14434    5                        KNN$ROUTE$(I)->KNN$ROUTE.LINK$ = KNN$LINK$(CLNK#);

  14434   1 00080B  DCB6                                 LDB,B5   ,B6,R3
          1 00080C  CC80 0000 0000  xsym                 LDB,B4   KNN_LINK$$
          1 00080F  A856                                 LDR,R2   R6
          1 000810  BCA4                                 LDB,B3   ,B4,R2
          1 000811  BF85                                 STB,B3   ,B5

     1375    14435        /*
     1376    14436                    replace the current qos with the new qos if the node is link connected.
     1377    14437                         otherwise subtract off the old links qos and add on the new links
     1378    14438                         qos.
     1379    14439        */
     1380    14440    5                        IF I = KNN$LINK.NODE# THEN

  14440   1 000812  ECC7 0010                            LDB,B6   LINK$,AUTO
          1 000814  B946 0002                            CMR,R3   2,B6
          1 000816  0981 000F                            BNE      s:14443,PREL

     1381    14441    5                             KNN$ROUTE$(I)->KNN$ROUTE.CURRENT_QOS = KNN$LINK$(CLNK#)->
             14441                                      KNN$LINK.QOS;

  14441   1 000818  DC80 0000 0000  xsym                 LDB,B5   KNN_ROUTE$$
          1 00081B  CCB5                                 LDB,B4   ,B5,R3
          1 00081C  BC80 0000 0000  xsym                 LDB,B3   KNN_LINK$$
          1 00081F  ACA3                                 LDB,B2   ,B3,R2
          1 000820  D842 0004                            LDR,R5   4,B2
          1 000822  DF44 0005                            STR,R5   5,B4
          1 000824  0F81 0011                            B        s:14449,PREL

PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:207  
     1382    14442    5                        ELSE
     1383    14443    5                             KNN$ROUTE$(I)->KNN$ROUTE.CURRENT_QOS = KNN$ROUTE$(I)->
             14443                                      KNN$ROUTE.CURRENT_QOS -

  14443   1 000826  DC80 0000 0000  xsym                 LDB,B5   KNN_ROUTE$$
          1 000829  CCB5                                 LDB,B4   ,B5,R3
          1 00082A  D844 0005                            LDR,R5   5,B4
          1 00082C  D246 0004                            SUB,R5   4,B6
          1 00082E  BC80 0000 0000  xsym                 LDB,B3   KNN_LINK$$
          1 000831  ACA3                                 LDB,B2   ,B3,R2
          1 000832  DA42 0004                            ADD,R5   4,B2
          1 000834  DF44 0005                            STR,R5   5,B4

     1384    14444    5                               KNN$LINK.QOS + KNN$LINK$(CLNK#)->KNN$LINK.QOS;
     1385    14445    5                        END;

     1386    14446        /*
     1387    14447                           mark the new link as up and running in the route tables.
     1388    14448        */
     1389    14449    4                   END;
             14449                          /* do i = 0 to knn_nodes update route table to reflect new link*/

  14449   1 000836  8AC7 0017                            INC      I,AUTO
          1 000838  E847 0017                            LDR,R6   I,AUTO
          1 00083A  E900 0000 0000  xsym                 CMR,R6   KNN_NODES
          1 00083D  0381 FFB5                            BLE      s:14431,PREL

     1390    14450    3              END;

     1391    14451              %UNLOCK(G=KNN_LOCK);

  14456   1 00083F  BB80 0000 0002  02                   LAB,B3   +2
          1 000842  CBF0 0100                            LAB,B4   256,IMO
          1 000844  E380 0000 0000  xent                 LNJ,B6   GHH$UNLOCK
          1 000847       0001                            DC       s:14458,PREL

     1392    14458    2         RETURN;
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:208  

  14458   1 000848  C380 0000 0000  xent                 LNJ,B4   X6A_ARET

     1393    14459        %EJECT;
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:209  
     1394    14460    2       CASE (%KN_FCN_UNBLOCK);

     1395    14461              %LOCK(G=KNN_LOCK);

  14466   1 00084B  BB80 0000 0002  02                   LAB,B3   +2
          1 00084E  CBF0 0100                            LAB,B4   256,IMO
          1 000850  E380 0000 0000  xent                 LNJ,B6   GHH$LOCK
          1 000853       0001                            DC       s:14468,PREL

     1396    14468    2         LINK# = KN$LDCT.LINK_ID;

  14468   1 000854  ECC7 0004                            LDB,B6   @KN$NETPARM,AUTO
          1 000856  DC86                                 LDB,B5   ,B6
          1 000857  E845 0003                            LDR,R6   3,B5
          1 000859  EF47 0012                            STR,R6   LINK#,AUTO

     1397    14469    2         LINK$ = KNN$LINK$(LINK#);

  14469   1 00085B  CC80 0000 0000  xsym                 LDB,B4   KNN_LINK$$
          1 00085E  B856                                 LDR,R3   R6
          1 00085F  BCB4                                 LDB,B3   ,B4,R3
          1 000860  BFC7 0010                            STB,B3   LINK$,AUTO

     1398    14470    2         KNN$LINK.UNBLKCNT = KNN$LINK.UNBLKCNT + 1;

  14470   1 000862  8AC3 0025                            INC      37,B3

     1399    14471    2         IF KNN$LINK.FLAGS.CLASS_A

  14471   1 000864  82C3 0003                            LB,'4000'X        3,B3
  14471   1 000866       4000
          1 000867  0501 0006                            BBT      s:14478,PREL
          1 000869  82C3 0003                            LB,'1000'X        3,B3
          1 00086B       1000
          1 00086C  0501 000D                            BBT      s:14482,PREL

     1400    14472    3           OR NOT KNN$LINK.FLAGS.VIRCIR THEN DO;
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:210  

     1401    14473                   %UNLOCK(G=KNN_LOCK);

  14478   1 00086E  BB80 0000 0002  02                   LAB,B3   +2
          1 000871  CBF0 0100                            LAB,B4   256,IMO
          1 000873  E380 0000 0000  xent                 LNJ,B6   GHH$UNLOCK
          1 000876       0001                            DC       s:14480,PREL

     1402    14480    3              RETURN;                 /*no unblock allowed on classA connections*/

  14480   1 000877  C380 0000 0000  xent                 LNJ,B4   X6A_ARET

     1403    14481    3              END;
     1404    14482    3         IF NOT KNN$LINK.FLAGS.BLOCKED THEN DO;

  14482   1 00087A  82C3 0003                            LB,'2000'X        3,B3
  14482   1 00087C       2000
          1 00087D  0501 000D                            BBT      s:14493,PREL

     1405    14483                   %UNLOCK(G=KNN_LOCK);

  14488   1 00087F  BB80 0000 0002  02                   LAB,B3   +2
          1 000882  CBF0 0100                            LAB,B4   256,IMO
          1 000884  E380 0000 0000  xent                 LNJ,B6   GHH$UNLOCK
          1 000887       0001                            DC       s:14490,PREL

     1406    14490    3              RETURN;                      /* this link isn't blocked*/

  14490   1 000888  C380 0000 0000  xent                 LNJ,B4   X6A_ARET

     1407    14491    3              END;
     1408    14492
     1409    14493    2         KNN$LINK.FLAGS.BLOCKED = '0'B;

  14493   1 00088B  8843 0003                            LBF,'2000'X       3,B3
  14493   1 00088D       2000

PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:211  
     1410    14494              %UNLOCK(G=KNN_LOCK);

  14499   1 00088E  BB80 0000 0002  02                   LAB,B3   +2
          1 000891  CBF0 0100                            LAB,B4   256,IMO
          1 000893  E380 0000 0000  xent                 LNJ,B6   GHH$UNLOCK
          1 000896       0001                            DC       s:14501,PREL

     1411    14501    2         RETURN;

  14501   1 000897  C380 0000 0000  xent                 LNJ,B4   X6A_ARET

     1412    14502
     1413    14503        %EJECT;
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:212  
     1414    14504    2       CASE (ELSE);

     1415    14505    2         CALL SCREECH(BADFNC);

  14505   1 00089A  BB80 0000 0000  02                   LAB,B3   0
          1 00089D  CBF0 0100                            LAB,B4   256,IMO
          1 00089F  E380 0000 0000  xent                 LNJ,B6   SCREECH
          1 0008A2       0001                            DC       s:14508,PREL

     1416    14506    2         END/*do case(function)*/;

     1417    14507
     1418    14508    1      RETURN;

  14508   1 0008A3  C380 0000 0000  xent                 LNJ,B4   X6A_ARET

     1419    14509        %EJECT;
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:213  
     1420    14510        /*F* NAME: KNN$OSICHG
     1421    14511
     1422    14512        KNN$OSICHG is called from knb$action when that routine receives a kl$updosi
     1423    14513        from another network manager.
     1424    14514        */
     1425    14515    1   KNN$OSICHG: ENTRY(KN$NETPARM) ALTRET;

  14515   1 0008A6  D380 0000 0000  xent KNN$OSICHG      LNJ,B5   X6A_AUTO_1
          1 0008A9       009A 0001                       DC       154,1

     1426    14516
     1427    14517
     1428    14518    1      FOUNDONE = '0'B;

  14518   1 0008AB  8747 002A                            CL       FOUNDONE,AUTO

     1429    14519    2      DO I = 0 TO KNN_OSIMAX# - 1;

  14519   1 0008AD  8747 0017                            CL       I,AUTO
          1 0008AF  0F81 013F                            B        s:14614+2,PREL

     1430    14520    2           OSI$ = KNN$OSIROUTE$(I);

  14520   1 0008B1  EC80 0000 0000  xsym                 LDB,B6   KNN_OSIROUTE$$
          1 0008B4  B847 0017                            LDR,R3   I,AUTO
          1 0008B6  DCB6                                 LDB,B5   ,B6,R3
          1 0008B7  DFC7 001F                            STB,B5   OSI$,AUTO

     1431    14521
     1432    14522    2           IF KNN$OSIROUTE.NS_TYPE = KL$UPDOSI.NS_TYPE

  14522   1 0008B9  CCC7 0004                            LDB,B4   @KN$NETPARM,AUTO
          1 0008BB  BCC4 0019                            LDB,B3   25,B4
          1 0008BD  E845 001A                            LDR,R6   26,B5
          1 0008BF  604C                                 SOR,R6   12
          1 0008C0  D803                                 LDR,R5   ,B3
          1 0008C1  5044                                 SOR,R5   4
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:214  
          1 0008C2  D570 000F                            AND,R5   15,IMO
          1 0008C4  E955                                 CMR,R6   R5
          1 0008C5  0981 0127                            BNE      s:14614,PREL
          1 0008C7  C805                                 LDR,R4   ,B5
          1 0008C8  C570 00FF                            AND,R4   255,IMO
          1 0008CA  A843 0004                            LDR,R2   4,B3
          1 0008CC  A570 00FF                            AND,R2   255,IMO
          1 0008CE  C952                                 CMR,R4   R2
          1 0008CF  0981 011D                            BNE      s:14614,PREL
          1 0008D1  9285                                 LLH,R1   ,B5
          1 0008D2  E2C3 0004                            LLH,R6   4,B3
          1 0008D4  9956                                 CMR,R1   R6
          1 0008D5  0981 0117                            BNE      s:14614,PREL

     1433    14523    2             AND KNN$OSIROUTE.NSAP.AFI = KL$UPDOSI.NSAP.AFI
     1434    14524    2             AND KNN$OSIROUTE.NSAP.LEN = KL$UPDOSI.NSAP.LEN THEN
     1435    14525    3   NXTI:   DO;

  14525   1                              NXTI            null
     1436    14526    3                L = 0;

  14526   1 0008D7  8747 0019            NXTI            CL       L,AUTO

     1437    14527    3                UPDOSI$ = ADDR(KL$UPDOSI.NSAP);

  14527   1 0008D9  ABC3 0004                            LAB,B2   4,B3
          1 0008DB  AFC7 001D                            STB,B2   UPDOSI$,AUTO

     1438    14528    3                OSIROUTE$ = ADDR(KNN$OSIROUTE.NSAP);

  14528   1 0008DD  DFC7 0021                            STB,B5   OSIROUTE$,AUTO

     1439    14529    3                LEN = KNN$OSIROUTE.NSAP.LEN;

  14529   1 0008DF  9F47 001B                            STR,R1   LEN,AUTO

     1440    14530    3               IF SUBSTR(UPDOSI$->ADDRESS,2,LEN-1) ~= SUBSTR(OSIROUTE$->ADDRESS,2,LEN-
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:215  
             14530                         1) THEN

  14530   1 0008E1  2C02                                 LDV,R2   2
          1 0008E2  E851                                 LDR,R6   R1
          1 0008E3  6EFF                                 ADV,R6   -1
          1 0008E4  BB85                                 LAB,B3   ,B5
          1 0008E5  3C02                                 LDV,R3   2
          1 0008E6  F856                                 LDR,R7   R6
          1 0008E7  D380 0000 0000  xent                 LNJ,B5   X6C_ACM
          1 0008EA  5301 0102                            CBNE     s:14614,PREL

     1441    14531    3                     EXIT NXTI;       /* compare the address, but dont do afi*/
     1442    14532        /*
     1443    14533             found a match, but now is this a separate incarnation of the same
     1444    14534             entity or a new connection.
     1445    14535        */
     1446    14536    3                IF KL$UPDOSI.NS_TYPE = %K_TYPE_LNSAP THEN

  14536   1 0008EC  ECC7 0004                            LDB,B6   @KN$NETPARM,AUTO
          1 0008EE  DCC6 0019                            LDB,B5   25,B6
          1 0008F0  E805                                 LDR,R6   ,B5
          1 0008F1  6044                                 SOR,R6   4
          1 0008F2  E570 000F                            AND,R6   15,IMO
          1 0008F4  6D01                                 CMV,R6   1
          1 0008F5  0981 0021                            BNE      s:14549,PREL

     1447    14537    3                     IF KNN$OSIROUTE.LINK.HOST#(0) = KL$UPDOSI.HOST#

  14537   1 0008F7  CCC7 001F                            LDB,B4   OSI$,AUTO
          1 0008F9  D844 001B                            LDR,R5   27,B4
          1 0008FB  D570 00FF                            AND,R5   255,IMO
          1 0008FD  C2C5 0001                            LLH,R4   1,B5
          1 0008FF  D954                                 CMR,R5   R4
          1 000900  0981 00EC                            BNE      s:14614,PREL
          1 000902  B2C4 001B                            LLH,R3   27,B4
          1 000904  A845 0001                            LDR,R2   1,B5
          1 000906  A570 00FF                            AND,R2   255,IMO
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:216  
          1 000908  B952                                 CMR,R3   R2
          1 000909  0981 00E3                            BNE      s:14614,PREL

     1448    14538    3                       AND KNN$OSIROUTE.LINK.FEP#(0) = KL$UPDOSI.FEP# THEN
     1449    14539    3                          IF KL$UPDOSI.FCN = IGA_DELOSI THEN

  14539   1 00090B  9285                                 LLH,R1   ,B5
          1 00090C  1D57                                 CMV,R1   87
          1 00090D  0981 0006                            BNE      s:14545,PREL

     1450    14540    4                          DO;

     1451    14541    4                               KNN$OSIROUTE.NSAP.AFI = 0;

  14541   1 00090F  8804                                 LBF,'00FF'X       ,B4
  14541   1 000910       00FF

     1452    14542    4                               RETURN;

  14542   1 000911  C380 0000 0000  xent                 LNJ,B4   X6A_ARET

     1453    14543    4                               END;
     1454    14544    3                          ELSE
     1455    14545    3                               RETURN;     /* that lnsap is already defined      */

  14545   1 000914  C380 0000 0000  xent                 LNJ,B4   X6A_ARET

     1456    14546    3                     ELSE
     1457    14547    3                          EXIT NXTI;
     1458    14548    4                ELSE DO;                   /* rnsap                              */

     1459    14549    4                     IF KNN$OSIROUTE.SNPA ~= KL$UPDOSI.SNPA THEN

  14549   1 000917  CCC7 001F                            LDB,B4   OSI$,AUTO
          1 000919  5C08                                 LDV,R5   8
          1 00091A  0022                                 ACM      ;
          1 00091B       4804 000B                                ALPHANUM(11,B4,,8,FILL),;
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:217  
          1 00091D       4005 001A                                ALPHANUM(26,B5,,R5,FILL)
          1 00091F  5301 00CD                            CBNE     s:14614,PREL

     1460    14550    4                          EXIT NXTI;
     1461    14551    5                     DO K = 0 TO KNN_LINKS - 1;

  14551   1 000921  8747 001A                            CL       K,AUTO
          1 000923  0F81 004C                            B        s:14575+2,PREL

     1462    14552    5                          IF KNN$OSIROUTE.LINK.FEP#(K) = KL$UPDOSI.FEP# THEN
             14552                                   /* same connection*/

  14552   1 000925  ECC7 0004                            LDB,B6   @KN$NETPARM,AUTO
          1 000927  DCC6 0019                            LDB,B5   25,B6
          1 000929  CCC7 001F                            LDB,B4   OSI$,AUTO
          1 00092B  B847 001A                            LDR,R3   K,AUTO
          1 00092D  3F0F                                 MLV,R3   15
          1 00092E  3E36                                 ADV,R3   54
          1 00092F  E2B4                                 LLH,R6   ,B4,R3
          1 000930  D845 0001                            LDR,R5   1,B5
          1 000932  D570 00FF                            AND,R5   255,IMO
          1 000934  E955                                 CMR,R6   R5
          1 000935  0981 0038                            BNE      s:14575,PREL

     1463    14553    6                          DO;

     1464    14554                                    %LOCK(G=KNN_LOCK);

  14559   1 000937  BB80 0000 0002  02                   LAB,B3   +2
          1 00093A  CBF0 0100                            LAB,B4   256,IMO
          1 00093C  E380 0000 0000  xent                 LNJ,B6   GHH$LOCK
          1 00093F       0001                            DC       s:14561,PREL

     1465    14561    6                               IF KL$UPDOSI.FCN = IGA_DELOSI THEN

  14561   1 000940  ECC7 0004                            LDB,B6   @KN$NETPARM,AUTO
          1 000942  DCC6 0019                            LDB,B5   25,B6
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:218  
          1 000944  E285                                 LLH,R6   ,B5
          1 000945  6D57                                 CMV,R6   87
          1 000946  0981 0007                            BNE      s:14564,PREL

     1466    14562    6                                    KNN$OSIROUTE.NSAP.AFI = 0;

  14562   1 000948  CCC7 001F                            LDB,B4   OSI$,AUTO
          1 00094A  8804                                 LBF,'00FF'X       ,B4
          1 00094B       00FF
          1 00094C  0F81 0008                            B        s:14565,PREL

     1467    14563    6                               ELSE
     1468    14564    6                                    KNN$OSIROUTE.LNSAP = KL$UPDOSI.LNSAP;

  14564   1 00094E  AB85                                 LAB,B2   ,B5
          1 00094F  2C1E                                 LDV,R2   30
          1 000950  6C16                                 LDV,R6   22
          1 000951  BCC7 001F                            LDB,B3   OSI$,AUTO
          1 000953  3C1E                                 LDV,R3   30
          1 000954  0008                                 MMM

     1469    14565    6                               KNN$OSIROUTE.LINK.QOS(K) = KL$UPDOSI.QOS;

  14565   1 000955  DCC6 0019                            LDB,B5   25,B6
          1 000957  E845 0002                            LDR,R6   2,B5
          1 000959  E570 00FF                            AND,R6   255,IMO
          1 00095B  CCC7 001F                            LDB,B4   OSI$,AUTO
          1 00095D  B847 001A                            LDR,R3   K,AUTO
          1 00095F  3F0F                                 MLV,R3   15
          1 000960  3E38                                 ADV,R3   56
          1 000961  E7B4                                 STH,R6   ,B4,R3

     1470    14566                                    %UNLOCK(G=KNN_LOCK);

  14571   1 000962  BB80 0000 0002  02                   LAB,B3   +2
          1 000965  CBF0 0100                            LAB,B4   256,IMO
          1 000967  E380 0000 0000  xent                 LNJ,B6   GHH$UNLOCK
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:219  
          1 00096A       0001                            DC       s:14573,PREL

     1471    14573    6                               RETURN;

  14573   1 00096B  C380 0000 0000  xent                 LNJ,B4   X6A_ARET

     1472    14574    6                               END;   /* if osiroute.link.fep# = updosi.fep#     */
     1473    14575    5                          END;             /* do k                               */

  14575   1 00096E  8AC7 001A                            INC      K,AUTO
          1 000970  E847 001A                            LDR,R6   K,AUTO
          1 000972  6801 FFB2                            BLZ,R6   s:14552,PREL
          1 000974  E900 0000 0000  xsym                 CMR,R6   KNN_LINKS
          1 000977  0201 FFAD                            BL       s:14552,PREL

     1474    14576        /*
     1475    14577             could not find the requested nsap address
     1476    14578        */
     1477    14579
     1478    14580    4                     IF KL$UPDOSI.FCN = IGA_DELOSI THEN

  14580   1 000979  D285                                 LLH,R5   ,B5
          1 00097A  5D57                                 CMV,R5   87
          1 00097B  0981 0004                            BNE      s:14585,PREL

     1479    14581    4                          RETURN;

  14581   1 00097D  C380 0000 0000  xent                 LNJ,B4   X6A_ARET

     1480    14582        /*
     1481    14583             otherwise look for the first available slot and install the new info.
     1482    14584        */
     1483    14585    5                     DO K = 0 TO KNN_LINKS - 1;

  14585   1 000980  8747 001A                            CL       K,AUTO
          1 000982  0F81 005E                            B        s:14610+2,PREL

PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:220  
     1484    14586    5                          IF NOT KNN$OSIROUTE.LINK.ACTIVE(K) THEN

  14586   1 000984  ECC7 001F                            LDB,B6   OSI$,AUTO
          1 000986  DBC6 001A                            LAB,B5   26,B6
          1 000988  B847 001A                            LDR,R3   K,AUTO
          1 00098A  3F78                                 MLV,R3   120
          1 00098B  3E08                                 ADV,R3   8
          1 00098C  82B5                                 LB       ,B5,R3
          1 00098D  0501 0051                            BBT      s:14610,PREL

     1485    14587    6                          DO;

     1486    14588                                    %LOCK(G=KNN_LOCK);

  14593   1 00098F  BB80 0000 0002  02                   LAB,B3   +2
          1 000992  CBF0 0100                            LAB,B4   256,IMO
          1 000994  E380 0000 0000  xent                 LNJ,B6   GHH$LOCK
          1 000997       0001                            DC       s:14595,PREL

     1487    14595    6                               KNN$OSIROUTE.LNSAP = KL$UPDOSI.LNSAP;

  14595   1 000998  ECC7 0004                            LDB,B6   @KN$NETPARM,AUTO
          1 00099A  DCC6 0019                            LDB,B5   25,B6
          1 00099C  AB85                                 LAB,B2   ,B5
          1 00099D  2C1E                                 LDV,R2   30
          1 00099E  6C16                                 LDV,R6   22
          1 00099F  BCC7 001F                            LDB,B3   OSI$,AUTO
          1 0009A1  3C1E                                 LDV,R3   30
          1 0009A2  0008                                 MMM

     1488    14596    6                               KNN$OSIROUTE.LINK.HOST#(K) = 255;

  14596   1 0009A3  E870 00FF                            LDR,R6   255,IMO
          1 0009A5  CCC7 001F                            LDB,B4   OSI$,AUTO
          1 0009A7  B847 001A                            LDR,R3   K,AUTO
          1 0009A9  3F0F                                 MLV,R3   15
          1 0009AA  3E37                                 ADV,R3   55
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:221  
          1 0009AB  E7B4                                 STH,R6   ,B4,R3

     1489    14597    6                               KNN$OSIROUTE.SNPA = KL$UPDOSI.SNPA;

  14597   1 0009AC  BCC6 0019                            LDB,B3   25,B6
          1 0009AE  AB83                                 LAB,B2   ,B3
          1 0009AF  2C34                                 LDV,R2   52
          1 0009B0  6C08                                 LDV,R6   8
          1 0009B1  BB84                                 LAB,B3   ,B4
          1 0009B2  3C16                                 LDV,R3   22
          1 0009B3  0008                                 MMM

     1490    14598    6                               KNN$OSIROUTE.LINK.FEP#(K) = KL$UPDOSI.FEP#;

  14598   1 0009B4  ACC6 0019                            LDB,B2   25,B6
          1 0009B6  E842 0001                            LDR,R6   1,B2
          1 0009B8  E570 00FF                            AND,R6   255,IMO
          1 0009BA  9CC7 001F                            LDB,B1   OSI$,AUTO
          1 0009BC  B847 001A                            LDR,R3   K,AUTO
          1 0009BE  3F0F                                 MLV,R3   15
          1 0009BF  3E36                                 ADV,R3   54
          1 0009C0  E7B1                                 STH,R6   ,B1,R3

     1491    14599    6                               KNN$OSIROUTE.LINK.QOS(K) = KL$UPDOSI.QOS;

  14599   1 0009C1  ACC6 0019                            LDB,B2   25,B6
          1 0009C3  E842 0002                            LDR,R6   2,B2
          1 0009C5  E570 00FF                            AND,R6   255,IMO
          1 0009C7  A847 001A                            LDR,R2   K,AUTO
          1 0009C9  2F0F                                 MLV,R2   15
          1 0009CA  2E38                                 ADV,R2   56
          1 0009CB  E7A1                                 STH,R6   ,B1,R2

     1492    14600    6                               KNN$OSIROUTE.LINK.ACTIVE(K) = '1'B;

  14600   1 0009CC  ABC1 001A                            LAB,B2   26,B1
          1 0009CE  9847 001A                            LDR,R1   K,AUTO
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:222  
          1 0009D0  1F78                                 MLV,R1   120
          1 0009D1  1E08                                 ADV,R1   8
          1 0009D2  8912                                 LBT      ,B2,R1

     1493    14601                                    %UNLOCK(G=KNN_LOCK);

  14606   1 0009D3  BB80 0000 0002  02                   LAB,B3   +2
          1 0009D6  CBF0 0100                            LAB,B4   256,IMO
          1 0009D8  E380 0000 0000  xent                 LNJ,B6   GHH$UNLOCK
          1 0009DB       0001                            DC       s:14608,PREL

     1494    14608    6                               RETURN;

  14608   1 0009DC  C380 0000 0000  xent                 LNJ,B4   X6A_ARET

     1495    14609    6                               END;        /* not active                         */
     1496    14610    5                          END;             /* do k                               */

  14610   1 0009DF  8AC7 001A                            INC      K,AUTO
          1 0009E1  E847 001A                            LDR,R6   K,AUTO
          1 0009E3  6801 FFA0                            BLZ,R6   s:14586,PREL
          1 0009E5  E900 0000 0000  xsym                 CMR,R6   KNN_LINKS
          1 0009E8  0201 FF9B                            BL       s:14586,PREL

     1497    14611    4                     RETURN;               /* no more space in current nsap      */

  14611   1 0009EA  C380 0000 0000  xent                 LNJ,B4   X6A_ARET

     1498    14612    4                     END;                  /* else rnsap                         */
     1499    14613    3                END;                  /* type = type and afi=afi and len = len   */
     1500    14614    2           END;                            /* do i                               */

  14614   1 0009ED  8AC7 0017                            INC      I,AUTO
          1 0009EF  E847 0017                            LDR,R6   I,AUTO
          1 0009F1  E900 0000 0000  xsym                 CMR,R6   KNN_OSIMAX#
          1 0009F4  0201 FEBC                            BL       s:14520,PREL

PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:223  
     1501    14615        /*
     1502    14616          couldn't find anyone who wanted us up there, lets make our own space.
     1503    14617        */
     1504    14618    2      DO I = 0 TO KNN_OSIMAX# - 1;

  14618   1 0009F6  8747 0017                            CL       I,AUTO
          1 0009F8  0F81 009B                            B        s:14655+2,PREL

     1505    14619    2           OSI$ = KNN$OSIROUTE$(I);

  14619   1 0009FA  EC80 0000 0000  xsym                 LDB,B6   KNN_OSIROUTE$$
          1 0009FD  B847 0017                            LDR,R3   I,AUTO
          1 0009FF  DCB6                                 LDB,B5   ,B6,R3
          1 000A00  DFC7 001F                            STB,B5   OSI$,AUTO

     1506    14620    2           IF KNN$OSIROUTE.NSAP.AFI = 0 THEN

  14620   1 000A02  8285                                 LB,'00FF'X        ,B5
  14620   1 000A03       00FF
          1 000A04  0501 008D                            BBT      s:14655,PREL

     1507    14621    3           DO;

     1508    14622                     %LOCK(G=KNN_LOCK);

  14627   1 000A06  BB80 0000 0002  02                   LAB,B3   +2
          1 000A09  CBF0 0100                            LAB,B4   256,IMO
          1 000A0B  E380 0000 0000  xent                 LNJ,B6   GHH$LOCK
          1 000A0E       0001                            DC       s:14629,PREL

     1509    14629    3                KNN$OSIROUTE = '0'B;

  14629   1 000A0F  ECC7 001F                            LDB,B6   OSI$,AUTO
          1 000A11  5C44                                 LDV,R5   68
          1 000A12  0021                                 ALR      ;
          1 000A13       4178 0000                                ALPHANUM('0000'X,IMO,,1),;
          1 000A15       4006 0000                                ALPHANUM(0,B6,,R5,FILL)
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:224  

     1510    14630    3                KNN$OSIROUTE.NS_TYPE = KL$UPDOSI.NS_TYPE;

  14630   1 000A17  437F                                 CSYNC    s:14629+7,SPREL
          1 000A18  ECC7 0004                            LDB,B6   @KN$NETPARM,AUTO
          1 000A1A  DCC6 0019                            LDB,B5   25,B6
          1 000A1C  CCC7 001F                            LDB,B4   OSI$,AUTO
          1 000A1E  E805                                 LDR,R6   ,B5
          1 000A1F  6008                                 SOL,R6   8
          1 000A20  EAC4 001A                            SRM,R6,'F000'X    26,B4
          1 000A22       F000

     1511    14631    3                KNN$OSIROUTE.NW_TYPE = KL$UPDOSI.NW_TYPE;

  14631   1 000A23  DCC6 0019                            LDB,B5   25,B6
          1 000A25  E805                                 LDR,R6   ,B5
          1 000A26  6008                                 SOL,R6   8
          1 000A27  EAC4 001A                            SRM,R6,'0F00'X    26,B4
          1 000A29       0F00

     1512    14632    3                KNN$OSIROUTE.NSAP = KL$UPDOSI.NSAP;

  14632   1 000A2A  DCC6 0019                            LDB,B5   25,B6
          1 000A2C  AB85                                 LAB,B2   ,B5
          1 000A2D  2C08                                 LDV,R2   8
          1 000A2E  6C16                                 LDV,R6   22
          1 000A2F  BB84                                 LAB,B3   ,B4
          1 000A30  3C00                                 LDV,R3   0
          1 000A31  0008                                 MMM

     1513    14633    4                IF KL$UPDOSI.NS_TYPE = %K_TYPE_RNSAP THEN DO;

  14633   1 000A32  9CC6 0019                            LDB,B1   25,B6
          1 000A34  E801                                 LDR,R6   ,B1
          1 000A35  6044                                 SOR,R6   4
          1 000A36  E570 000F                            AND,R6   15,IMO
          1 000A38  6D02                                 CMV,R6   2
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:225  
          1 000A39  0981 001A                            BNE      s:14639,PREL

     1514    14634    4                     KNN$OSIROUTE.LNSAP = KL$UPDOSI.LNSAP;

  14634   1 000A3B  AB81                                 LAB,B2   ,B1
          1 000A3C  2C1E                                 LDV,R2   30
          1 000A3D  6C16                                 LDV,R6   22
          1 000A3E  BCC7 001F                            LDB,B3   OSI$,AUTO
          1 000A40  3C1E                                 LDV,R3   30
          1 000A41  0008                                 MMM

     1515    14635    4                     KNN$OSIROUTE.LINK.HOST#(K) = 255;

  14635   1 000A42  E870 00FF                            LDR,R6   255,IMO
          1 000A44  BCC7 001F                            LDB,B3   OSI$,AUTO
          1 000A46  B847 001A                            LDR,R3   K,AUTO
          1 000A48  3F0F                                 MLV,R3   15
          1 000A49  3E37                                 ADV,R3   55
          1 000A4A  E7B3                                 STH,R6   ,B3,R3

     1516    14636    4                     KNN$OSIROUTE.SNPA = KL$UPDOSI.SNPA;

  14636   1 000A4B  DCC6 0019                            LDB,B5   25,B6
          1 000A4D  AB85                                 LAB,B2   ,B5
          1 000A4E  2C34                                 LDV,R2   52
          1 000A4F  6C08                                 LDV,R6   8
          1 000A50  3C16                                 LDV,R3   22
          1 000A51  0008                                 MMM

     1517    14637    4                     END;

  14637   1 000A52  0F81 001B                            B        s:14643,PREL

     1518    14638    4                ELSE DO;

     1519    14639    4                     KNN$OSIROUTE.LNSAP = '0'B;

PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:226  
  14639   1 000A54  ECC7 001F                            LDB,B6   OSI$,AUTO
          1 000A56  5C16                                 LDV,R5   22
          1 000A57  0021                                 ALR      ;
          1 000A58       4178 0000                                ALPHANUM('0000'X,IMO,,1),;
          1 000A5A       4006 000F                                ALPHANUM(15,B6,,R5,FILL)

     1520    14640    4                     KNN$OSIROUTE.LINK.HOST#(0) = KL$UPDOSI.HOST#;

  14640   1 000A5C  ECC7 0004                            LDB,B6   @KN$NETPARM,AUTO
          1 000A5E  437F                                 CSYNC    s:14640+1,SPREL
          1 000A5F  9CC6 0019                            LDB,B1   25,B6
          1 000A61  E2C1 0001                            LLH,R6   1,B1
          1 000A63  ECC7 001F                            LDB,B6   OSI$,AUTO
          1 000A65  EAC6 001B                            SRM,R6,'00FF'X    27,B6
          1 000A67       00FF

     1521    14641    4                     KNN$OSIROUTE.SNPA = '0'B;

  14641   1 000A68  5C08                                 LDV,R5   8
          1 000A69  0021                                 ALR      ;
          1 000A6A       4178 0000                                ALPHANUM('0000'X,IMO,,1),;
          1 000A6C       4006 000B                                ALPHANUM(11,B6,,R5,FILL)

     1522    14642    4                     END;

     1523    14643    3                KNN$OSIROUTE.LINK.FEP#(0) = KL$UPDOSI.FEP#;

  14643   1 000A6E  437F                                 CSYNC    s:14641+5,SPREL
          1 000A6F  ECC7 0004                            LDB,B6   @KN$NETPARM,AUTO
          1 000A71  BCC6 0019                            LDB,B3   25,B6
          1 000A73  E843 0001                            LDR,R6   1,B3
          1 000A75  E570 00FF                            AND,R6   255,IMO
          1 000A77  9CC7 001F                            LDB,B1   OSI$,AUTO
          1 000A79  E7C1 001B                            STH,R6   27,B1

     1524    14644    3                KNN$OSIROUTE.LINK.QOS(0) = KL$UPDOSI.QOS;

PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:227  
  14644   1 000A7B  BCC6 0019                            LDB,B3   25,B6
          1 000A7D  E843 0002                            LDR,R6   2,B3
          1 000A7F  E570 00FF                            AND,R6   255,IMO
          1 000A81  E7C1 001C                            STH,R6   28,B1

     1525    14645    3                KNN$OSIROUTE.LINK.ACTIVE(0) = '1'B;

  14645   1 000A83  8941 001A                            LBT,'0080'X       26,B1
  14645   1 000A85       0080

     1526    14646                     %UNLOCK(G=KNN_LOCK);

  14651   1 000A86  BB80 0000 0002  02                   LAB,B3   +2
          1 000A89  CBF0 0100                            LAB,B4   256,IMO
          1 000A8B  E380 0000 0000  xent                 LNJ,B6   GHH$UNLOCK
          1 000A8E       0001                            DC       s:14653,PREL

     1527    14653    3                RETURN;

  14653   1 000A8F  C380 0000 0000  xent                 LNJ,B4   X6A_ARET

     1528    14654    3                END;                       /* route table entry not in use       */
     1529    14655    2           END;                            /* do i                               */

  14655   1 000A92  8AC7 0017                            INC      I,AUTO
          1 000A94  E847 0017                            LDR,R6   I,AUTO
          1 000A96  E900 0000 0000  xsym                 CMR,R6   KNN_OSIMAX#
          1 000A99  0201 FF60                            BL       s:14619,PREL

     1530    14656    1      RETURN;

  14656   1 000A9B  C380 0000 0000  xent                 LNJ,B4   X6A_ARET

     1531    14657
     1532    14658        %EJECT;
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:228  
     1533    14659        /*F* NAME: KNN$OSILINKCHG
     1534    14660
     1535    14661        KNN$OSILINKCHG
     1536    14662             called from KNB$ACTION when osilinkchg message is receive from another
     1537    14663             network manager.  The sending network manager(updosi.mynode) must be link
     1538    14664             connected for this to be a valid number */
     1539    14665
     1540    14666    1   KNN$OSILINKCHG: ENTRY(KN$NETPARM) ALTRET;

  14666   1 000A9E  D380 0000 0000  xent KNN$OSILINKCHG  LNJ,B5   X6A_AUTO_1
          1 000AA1       009A 0001                       DC       154,1

     1541    14667
     1542    14668    1      IF NOT KNN$ROUTE$(KL$OSILINKCHG.MYNODE#)->KNN$ROUTE.FLAGS.LINK_CONNECTED THEN

  14668   1 000AA3  ECC7 0004                            LDB,B6   @KN$NETPARM,AUTO
          1 000AA5  DCC6 0019                            LDB,B5   25,B6
          1 000AA7  B2C5 0001                            LLH,R3   1,B5
          1 000AA9  CC80 0000 0000  xsym                 LDB,B4   KNN_ROUTE$$
          1 000AAC  BCB4                                 LDB,B3   ,B4,R3
          1 000AAD  82C3 0007                            LB,'4000'X        7,B3
          1 000AAF       4000
          1 000AB0  0501 0004                            BBT      s:14671,PREL

     1543    14669    1           RETURN;

  14669   1 000AB2  C380 0000 0000  xent                 LNJ,B4   X6A_ARET

     1544    14670
     1545    14671    1      DEST_NODE = KL$OSILINKCHG.NODE#;

  14671   1 000AB5  E845 0001                            LDR,R6   1,B5
          1 000AB7  E570 00FF                            AND,R6   255,IMO
          1 000AB9  EF47 000D                            STR,R6   DEST_NODE,AUTO

     1546    14672    1      SNPA = KL$OSILINKCHG.SNPA;

PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:229  
  14672   1 000ABB  AB85                                 LAB,B2   ,B5
          1 000ABC  2C08                                 LDV,R2   8
          1 000ABD  6C08                                 LDV,R6   8
          1 000ABE  BBC7 0061                            LAB,B3   SNPA,AUTO
          1 000AC0  3C00                                 LDV,R3   0
          1 000AC1  0008                                 MMM

     1547    14673    1      QOS = KL$OSILINKCHG.QOS;

  14673   1 000AC2  CCC6 0019                            LDB,B4   25,B6
          1 000AC4  E2C4 0002                            LLH,R6   2,B4
          1 000AC6  EF47 0016                            STR,R6   QOS,AUTO

     1548    14674
     1549    14675    1      IF KL$OSILINKCHG.SNPA.LEN = 0 THEN RETURN;

  14675   1 000AC8  D2C4 0004                            LLH,R5   4,B4
          1 000ACA  5981 0004                            BNEZ,R5  s:14676,PREL

  14675   1 000ACC  C380 0000 0000  xent                 LNJ,B4   X6A_ARET

     1550    14676    1      IF KL$OSILINKCHG.TYPE = IGA_OSILINKDOWN THEN

  14676   1 000ACF  C804                                 LDR,R4   ,B4
          1 000AD0  C570 00FF                            AND,R4   255,IMO
          1 000AD2  4D59                                 CMV,R4   89
          1 000AD3  0981 0006                            BNE      s:14679,PREL

     1551    14677    1           CALL OSILINK_DOWN;

  14677   1 000AD5  E3C0 045A                            LNJ,B6   s:0,PREL
          1 000AD7       0001                            DC       s:14677+3,PREL
          1 000AD8  0F81 0004                            B        s:14681,PREL

     1552    14678    1      ELSE
     1553    14679    1           CALL OSILINK_UP;

PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:230  
  14679   1 000ADA  E3C0 039B                            LNJ,B6   s:0,PREL
          1 000ADC       0001                            DC       s:14681,PREL

     1554    14680
     1555    14681    1      RETURN;

  14681   1 000ADD  C380 0000 0000  xent                 LNJ,B4   X6A_ARET

     1556    14682        %EJECT;
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:231  
     1557    14683        /*F* NAME: KNN$NODECHG
     1558    14684
     1559    14685        KNN$NODECHG is called from KNB$ACTION when that routine has received
     1560    14686        an KL$NODECHG message from SLUG.
     1561    14687
     1562    14688        This routine will search the link table for any link to the effected
     1563    14689        node.  When one is found, UPDATE_ROUTE is called to recalculate
     1564    14690        network routing.
     1565    14691
     1566    14692        KNN$NODECHG is called with the following parameters:
     1567    14693
     1568    14694        .fif
     1569    14695        }    KN$NETPARM.FPT$ - Contains the address of the KL$NODECHG structure.
     1570    14696        }    KL$NODECHG -  See file KL_MACRO_C
     1571    14697        }                  .NODE refers to the node that is going thru a state change
     1572    14698        }                  .MYNODE refers to the node that is reporting the state change
     1573    14699        }
     1574    14700        .fin
     1575    14701        */
     1576    14702
     1577    14703    1   KNN$NODECHG: ENTRY(KN$NETPARM) ALTRET;

  14703   1 000AE0  D380 0000 0000  xent KNN$NODECHG     LNJ,B5   X6A_AUTO_1
          1 000AE3       009A 0001                       DC       154,1

     1578    14704
     1579    14705    1      DEST_NODE = KL$NODECHG.NODE;

  14705   1 000AE5  ECC7 0004                            LDB,B6   @KN$NETPARM,AUTO
          1 000AE7  DCC6 0019                            LDB,B5   25,B6
          1 000AE9  E2C5 0002                            LLH,R6   2,B5
          1 000AEB  EF47 000D                            STR,R6   DEST_NODE,AUTO

     1580    14706
     1581    14707    1      IF KL$NODECHG.MYNODE > KNN_NODES

  14707   1 000AED  D845 0001                            LDR,R5   1,B5
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:232  
          1 000AEF  D570 00FF                            AND,R5   255,IMO
          1 000AF1  D900 0000 0000  xsym                 CMR,R5   KNN_NODES
          1 000AF4  0301 0006                            BG       s:14709,PREL
          1 000AF6  E900 0000 0000  xsym                 CMR,R6   KNN_NODES
          1 000AF9  0381 0004                            BLE      s:14713,PREL

     1582    14708    1        OR DEST_NODE > KNN_NODES
     1583    14709    1      THEN RETURN;

  14709   1 000AFB  C380 0000 0000  xent                 LNJ,B4   X6A_ARET

     1584    14710
     1585    14711        /* If the link is not active return.
     1586    14712        */
     1587    14713    1      ROUTE$ = KNN$ROUTE$(KL$NODECHG.MYNODE);

  14713   1 000AFE  B855                                 LDR,R3   R5
          1 000AFF  CC80 0000 0000  xsym                 LDB,B4   KNN_ROUTE$$
          1 000B02  BCB4                                 LDB,B3   ,B4,R3
          1 000B03  BFC7 000E                            STB,B3   ROUTE$,AUTO

     1588    14714    1      QOS = KNN$ROUTE.CURRENT_QOS;

  14714   1 000B05  C843 0005                            LDR,R4   5,B3
          1 000B07  CF47 0016                            STR,R4   QOS,AUTO

     1589    14715    1      IF NOT KNN$ROUTE.FLAGS.LINK_CONNECTED

  14715   1 000B09  82C3 0007                            LB,'4000'X        7,B3
  14715   1 000B0B       4000
          1 000B0C  0581 0008                            BBF      s:14717,PREL
          1 000B0E  A856                                 LDR,R2   R6
          1 000B0F  ACA4                                 LDB,B2   ,B4,R2
          1 000B10  82C2 0007                            LB,'4000'X        7,B2
          1 000B12       4000
          1 000B13  0581 0004                            BBF      s:14719,PREL

PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:233  
     1590    14716    1        OR KNN$ROUTE$(KL$NODECHG.NODE)->KNN$ROUTE.FLAGS.LINK_CONNECTED
     1591    14717    1      THEN RETURN;

  14717   1 000B15  C380 0000 0000  xent                 LNJ,B4   X6A_ARET

     1592    14718
     1593    14719    1      FEPST.REASON = KIER_QOSCHG;

  14719   1 000B18  1C13                                 LDV,R1   19
          1 000B19  9F47 0008                            STR,R1   FEPST+2,AUTO

     1594    14720           %LOCK (G=KNN_LOCK);

  14725   1 000B1B  BB80 0000 0002  02                   LAB,B3   +2
          1 000B1E  CBF0 0100                            LAB,B4   256,IMO
          1 000B20  E380 0000 0000  xent                 LNJ,B6   GHH$LOCK
          1 000B23       0001                            DC       s:14728,PREL

     1595    14727
     1596    14728    2      DO LINK# = 0 TO KNN_LINKS-1;

  14728   1 000B24  8747 0012                            CL       LINK#,AUTO
          1 000B26  0F81 0038                            B        s:14741+2,PREL

     1597    14729    2           LINK$ = KNN$LINK$(LINK#);

  14729   1 000B28  EC80 0000 0000  xsym                 LDB,B6   KNN_LINK$$
          1 000B2B  B847 0012                            LDR,R3   LINK#,AUTO
          1 000B2D  DCB6                                 LDB,B5   ,B6,R3
          1 000B2E  DFC7 0010                            STB,B5   LINK$,AUTO

     1598    14730    2           IF KNN$LINK.NODE# = KL$NODECHG.MYNODE

  14730   1 000B30  CCC7 0004                            LDB,B4   @KN$NETPARM,AUTO
          1 000B32  BCC4 0019                            LDB,B3   25,B4
          1 000B34  E843 0001                            LDR,R6   1,B3
          1 000B36  E570 00FF                            AND,R6   255,IMO
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:234  
          1 000B38  E945 0002                            CMR,R6   2,B5
          1 000B3A  0981 0022                            BNE      s:14741,PREL

     1599    14731    3           THEN DO;

     1600    14732    3                QOS = MINIMUM (KL$NODECHG.QOS + QOS, 255);

  14732   1 000B3C  D2C3 0003                            LLH,R5   3,B3
          1 000B3E  DA47 0016                            ADD,R5   QOS,AUTO
          1 000B40  D970 00FF                            CMR,R5   255,IMO
          1 000B42  0381 0003                            BLE      s:14732+10,PREL
          1 000B44  D870 00FF                            LDR,R5   255,IMO
          1 000B46  DF47 0016                            STR,R5   QOS,AUTO

     1601    14733    3                ROUTE$ = KNN$ROUTE$(DEST_NODE);

  14733   1 000B48  AC80 0000 0000  xsym                 LDB,B2   KNN_ROUTE$$
          1 000B4B  A847 000D                            LDR,R2   DEST_NODE,AUTO
          1 000B4D  9CA2                                 LDB,B1   ,B2,R2
          1 000B4E  9FC7 000E                            STB,B1   ROUTE$,AUTO

     1602    14734    3                KNN$ROUTE.LINK.QOS(LINK#) = QOS;

  14734   1 000B50  3F0A                                 MLV,R3   10
          1 000B51  3E11                                 ADV,R3   17
          1 000B52  D7B1                                 STH,R5   ,B1,R3

     1603    14735
     1604    14736    3                IF KL$NODECHG.HOSTNODE ~= 0

  14736   1 000B53  ECC4 0019                            LDB,B6   25,B4
          1 000B55  82C6 0002                            LB,'00FF'X        2,B6
          1 000B57       00FF
          1 000B58  0581 0004                            BBF      s:14741,PREL

     1605    14737    3                THEN KNN$ROUTE.FLAGS.HOST_NODE = '1'B;

PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:235  
  14737   1 000B5A  8941 0007                            LBT,'8000'X       7,B1
  14737   1 000B5C       8000

     1606    14738
     1607    14739
     1608    14740    3                END/*do if this node*/;

     1609    14741    2           END/*do 0 to knn_links*/;

  14741   1 000B5D  8AC7 0012                            INC      LINK#,AUTO
          1 000B5F  E847 0012                            LDR,R6   LINK#,AUTO
          1 000B61  E900 0000 0000  xsym                 CMR,R6   KNN_LINKS
          1 000B64  0244                                 BL       s:14729,SPREL

     1610    14742    1      CALL UPDATE_ROUTE

  14742   1 000B65  E3C0 001C                            LNJ,B6   s:0,PREL
          1 000B67       0003                            DC       s:14749,PREL
          1 000B68  0F81 000D                            B        s:14759,PREL

     1611    14743    2      WHENALTRETURN DO;

     1612    14744                %UNLOCK (G=KNN_LOCK);

  14749   1 000B6A  BB80 0000 0002  02                   LAB,B3   +2
          1 000B6D  CBF0 0100                            LAB,B4   256,IMO
          1 000B6F  E380 0000 0000  xent                 LNJ,B6   GHH$UNLOCK
          1 000B72       0001                            DC       s:14751,PREL

     1613    14751    2           ALTRETURN;

  14751   1 000B73  C380 0000 0000  xent                 LNJ,B4   X6A_AALT

     1614    14752    2           END;
     1615    14753
     1616    14754           %UNLOCK (G=KNN_LOCK);

PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:236  
  14759   1 000B76  BB80 0000 0002  02                   LAB,B3   +2
          1 000B79  CBF0 0100                            LAB,B4   256,IMO
          1 000B7B  E380 0000 0000  xent                 LNJ,B6   GHH$UNLOCK
          1 000B7E       0001                            DC       s:14761,PREL

     1617    14761    1      RETURN;

  14761   1 000B7F  C380 0000 0000  xent                 LNJ,B4   X6A_ARET

     1618    14762
     1619    14763        %EJECT;
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:237  
     1620    14764        /*I* NAME: UPDATE_ROUTE
     1621    14765
     1622    14766        UPDATE_ROUTE recalculates network routing.  For each node, the
     1623    14767        following is done:
     1624    14768
     1625    14769         - The route table is searched for the link with the best QOS.
     1626    14770
     1627    14771         - If this link is different from the one being used, or if either
     1628    14772           the QOS or ALTQOS is different, a KL$FEPST message is sent to
     1629    14773           nodeadmin.
     1630    14774
     1631    14775         - If a usable link was found the route table entry is updated with
     1632    14776           the new link and QOS values.
     1633    14777
     1634    14778         - If a usable link was not found the route table entry is updated
     1635    14779           to reflect that there is no link.  If there had been a link in
     1636    14780           use, a term function is passed up to transport and session via
     1637    14781           a call to KNT$RECV.
     1638    14782        */
     1639    14783
     1640    14784    1   UPDATE_ROUTE: PROC ALTRET;

  14784   1 000B82  EFC7 008E            UPDATE_ROUTE    STB,B6   KN@NETPARM+35,AUTO

     1641    14785
     1642    14786    2   DCL SVLINK SBIN;
     1643    14787    2   DCL BESTQOS UBIN;
     1644    14788    2   DCL ALTQOS UBIN;
     1645    14789
     1646    14790    3      DO I = 0 TO KNN_NODES;

  14790   1 000B84  8747 0017                            CL       I,AUTO
          1 000B86  0F81 011D                            B        s:14861+2,PREL

     1647    14791    3           SVLINK = -1;

  14791   1 000B88  8947 0090                            LBT,'FFFF'X       SVLINK,AUTO
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:238  
  14791   1 000B8A       FFFF

     1648    14792    3           BESTQOS = 255;

  14792   1 000B8B  E870 00FF                            LDR,R6   255,IMO
          1 000B8D  EF47 0091                            STR,R6   BESTQOS,AUTO

     1649    14793    3           ALTQOS = 255;

  14793   1 000B8F  EF47 0092                            STR,R6   ALTQOS,AUTO

     1650    14794    3           ROUTE$ = KNN$ROUTE$(I);

  14794   1 000B91  EC80 0000 0000  xsym                 LDB,B6   KNN_ROUTE$$
          1 000B94  B847 0017                            LDR,R3   I,AUTO
          1 000B96  DCB6                                 LDB,B5   ,B6,R3
          1 000B97  DFC7 000E                            STB,B5   ROUTE$,AUTO

     1651    14795
     1652    14796                                                /* Go through every link              */
     1653    14797    4           DO J = 0 TO KNN_LINKS-1;

  14797   1 000B99  8747 0018                            CL       J,AUTO
          1 000B9B  0F81 001F                            B        s:14806+2,PREL

     1654    14798    4                IF KNN$ROUTE.LINK.ACTIVE(J)

  14798   1 000B9D  ECC7 000E                            LDB,B6   ROUTE$,AUTO
          1 000B9F  B847 0018                            LDR,R3   J,AUTO
          1 000BA1  3F05                                 MLV,R3   5
          1 000BA2  3E08                                 ADV,R3   8
          1 000BA3  89B6                                 CMZ      ,B6,R3
          1 000BA4  0881 0014                            BAGE     s:14806,PREL
          1 000BA6  A847 0018                            LDR,R2   J,AUTO
          1 000BA8  2F0A                                 MLV,R2   10
          1 000BA9  2E11                                 ADV,R2   17
          1 000BAA  E2A6                                 LLH,R6   ,B6,R2
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:239  
          1 000BAB  E947 0091                            CMR,R6   BESTQOS,AUTO
          1 000BAD  0281 000B                            BGE      s:14806,PREL

     1655    14799    4                  AND BESTQOS > KNN$ROUTE.LINK.QOS(J)
     1656    14800    5                THEN DO;

     1657    14801    5                     ALTQOS = 255;         /* always                             */

  14801   1 000BAF  D870 00FF                            LDR,R5   255,IMO
          1 000BB1  DF47 0092                            STR,R5   ALTQOS,AUTO

     1658    14802
     1659    14803    5                     BESTQOS = KNN$ROUTE.LINK.QOS(J);

  14803   1 000BB3  EF47 0091                            STR,R6   BESTQOS,AUTO

     1660    14804    5                     SVLINK = J;

  14804   1 000BB5  C847 0018                            LDR,R4   J,AUTO
          1 000BB7  CF47 0090                            STR,R4   SVLINK,AUTO

     1661    14805    5                     END;

     1662    14806    4                END/*do j=0 to knn_links*/;

  14806   1 000BB9  8AC7 0018                            INC      J,AUTO
          1 000BBB  E847 0018                            LDR,R6   J,AUTO
          1 000BBD  E900 0000 0000  xsym                 CMR,R6   KNN_LINKS
          1 000BC0  025D                                 BL       s:14798,SPREL

     1663    14807
     1664    14808        /* If the status has changed tell NA.
     1665    14809        */
     1666    14810    3           IF KNN$ROUTE.LINK# ~= SVLINK OR KNN$ROUTE.CURRENT_QOS ~= BESTQOS

  14810   1 000BC1  ECC7 000E                            LDB,B6   ROUTE$,AUTO
          1 000BC3  D846 0004                            LDR,R5   4,B6
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:240  
          1 000BC5  D947 0090                            CMR,R5   SVLINK,AUTO
          1 000BC7  0981 0007                            BNE      s:14812,PREL
          1 000BC9  C846 0005                            LDR,R4   5,B6
          1 000BCB  C947 0091                            CMR,R4   BESTQOS,AUTO
          1 000BCD  0901 0043                            BE       s:14828,PREL

     1667    14811    4           THEN DO;

     1668    14812    4                FEPST.FCN = IGA_FEPST;

  14812   1 000BCF  4C20                                 LDV,R4   32
          1 000BD0  C7C7 0006                            STH,R4   FEPST,AUTO

     1669    14813    4                FEPST.PROB = KIER_QOSCHG;

  14813   1 000BD2  5C13                                 LDV,R5   19
          1 000BD3  DF47 0007                            STR,R5   FEPST+1,AUTO

     1670    14814    4                FEPST.FEP = I;

  14814   1 000BD5  B847 0017                            LDR,R3   I,AUTO
          1 000BD7  BAC7 0006                            SRM,R3,'00FF'X    FEPST,AUTO
          1 000BD9       00FF

     1671    14815    4                FEPST.QOS = BESTQOS;

  14815   1 000BDA  A847 0091                            LDR,R2   BESTQOS,AUTO
          1 000BDC  AF47 0009                            STR,R2   FEPST+3,AUTO

     1672    14816    4                FEPST.ALT_QOS = ALTQOS;

  14816   1 000BDE  9847 0092                            LDR,R1   ALTQOS,AUTO
          1 000BE0  9F47 000B                            STR,R1   FEPST+5,AUTO

     1673    14817
     1674    14818    4                IF SVLINK ~= -1

PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:241  
  14818   1 000BE2  E847 0090                            LDR,R6   SVLINK,AUTO
          1 000BE4  6DFF                                 CMV,R6   -1
          1 000BE5  0901 000C                            BE       s:14820,PREL

     1675    14819    4                THEN FEPST.LNK_NODE = KNN$LINK$(SVLINK)->KNN$LINK.NODE#;

  14819   1 000BE7  DC80 0000 0000  xsym                 LDB,B5   KNN_LINK$$
          1 000BEA  B856                                 LDR,R3   R6
          1 000BEB  CCB5                                 LDB,B4   ,B5,R3
          1 000BEC  E844 0002                            LDR,R6   2,B4
          1 000BEE  EF47 000A                            STR,R6   FEPST+4,AUTO
          1 000BF0  0F81 0006                            B        s:14822,PREL

     1676    14820    4                ELSE FEPST.LNK_NODE = KN_NODE#;

  14820   1 000BF2  E800 0000 0000  xsym                 LDR,R6   KN_NODE#
          1 000BF5  EF47 000A                            STR,R6   FEPST+4,AUTO

     1677    14821
     1678    14822    4                CALL KNB$WRITE(ADDR(FEPST),SIZEC(FEPST))

  14822   1 000BF7  DBC7 0006                            LAB,B5   FEPST,AUTO
          1 000BF9  DFC7 0094                            STB,B5   ALTQOS+2,AUTO
          1 000BFB  CBF0 000E                            LAB,B4   14,IMO
          1 000BFD  CFC7 0098                            STB,B4   ALTQOS+6,AUTO
          1 000BFF  BBC7 0094                            LAB,B3   ALTQOS+2,AUTO
          1 000C01  BFC7 0096                            STB,B3   ALTQOS+4,AUTO
          1 000C03  BBC7 0096                            LAB,B3   ALTQOS+4,AUTO
          1 000C05  CBF0 0200                            LAB,B4   512,IMO
          1 000C07  E380 0000 0000  xent                 LNJ,B6   KNB$WRITE
          1 000C0A       0003                            DC       s:14824,PREL
          1 000C0B  0F81 0005                            B        s:14828,PREL

     1679    14823    5                WHENALTRETURN DO;

     1680    14824    5                     ALTRETURN;

PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:242  
  14824   1 000C0D  ECC7 008E                            LDB,B6   KN@NETPARM+35,AUTO
          1 000C0F  B806                                 LDR,R3   ,B6
          1 000C10  C3B6                                 LNJ,B4   ,B6,R3

     1681    14825    5                     END;
     1682    14826    4                END/*do if reporting change to NA*/;

     1683    14827
     1684    14828    3           IF SVLINK ~= -1                 /*  link available                    */

  14828   1 000C11  E847 0090                            LDR,R6   SVLINK,AUTO
          1 000C13  6DFF                                 CMV,R6   -1
          1 000C14  0901 0015                            BE       s:14837,PREL

     1685    14829    4           THEN DO;

     1686    14830    4                KNN$ROUTE.LINK# = SVLINK;

  14830   1 000C16  ECC7 000E                            LDB,B6   ROUTE$,AUTO
          1 000C18  EF46 0004                            STR,R6   4,B6

     1687    14831    4                KNN$ROUTE.LINK$ = KNN$LINK$(SVLINK);

  14831   1 000C1A  DC80 0000 0000  xsym                 LDB,B5   KNN_LINK$$
          1 000C1D  B856                                 LDR,R3   R6
          1 000C1E  CCB5                                 LDB,B4   ,B5,R3
          1 000C1F  CF86                                 STB,B4   ,B6

     1688    14832    4                KNN$ROUTE.CURRENT_QOS = BESTQOS;

  14832   1 000C20  D847 0091                            LDR,R5   BESTQOS,AUTO
          1 000C22  DF46 0005                            STR,R5   5,B6

     1689    14833    4                KNN$ROUTE.ALT_QOS = ALTQOS;

  14833   1 000C24  C847 0092                            LDR,R4   ALTQOS,AUTO
          1 000C26  CF46 0006                            STR,R4   6,B6
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:243  

     1690    14834    4                END;

  14834   1 000C28  0F81 0079                            B        s:14861,PREL

     1691    14835
     1692    14836    4           ELSE DO;

     1693    14837    4                IF KNN$ROUTE.LINK$ ~= ADDR(NIL) AND I ~= KN_NODE#

  14837   1 000C2A  ECC7 000E                            LDB,B6   ROUTE$,AUTO
          1 000C2C  8D86                                 CMN      ,B6
          1 000C2D  0901 0074                            BE       s:14861,PREL
          1 000C2F  D847 0017                            LDR,R5   I,AUTO
          1 000C31  D900 0000 0000  xsym                 CMR,R5   KN_NODE#
          1 000C34  0901 006D                            BE       s:14861,PREL

     1694    14838    5                THEN DO;

     1695    14839    5                     KN@NETPARM = KN_NETPARM_INIT;

  14839   1 000C36  AB80 0000 0000  xsym                 LAB,B2   KN_NETPARM_INIT
          1 000C39  2C00                                 LDV,R2   0
          1 000C3A  6C42                                 LDV,R6   66
          1 000C3B  BBC7 006B                            LAB,B3   KN@NETPARM,AUTO
          1 000C3D  3C00                                 LDV,R3   0
          1 000C3E  0008                                 MMM

     1696    14840    5                     KN@NETPARM.NODE = I;

  14840   1 000C3F  E847 0017                            LDR,R6   I,AUTO
          1 000C41  EF47 0080                            STR,R6   KN@NETPARM+21,AUTO

     1697    14841    5                     KN@NETPARM.FUNCTION = %KN_FCN_TERM;

  14841   1 000C43  5C03                                 LDV,R5   3
          1 000C44  DF47 007F                            STR,R5   KN@NETPARM+20,AUTO
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:244  

     1698    14842    5                     CALL KNT$RECV (KN@NETPARM);

  14842   1 000C46  EBC7 006B                            LAB,B6   KN@NETPARM,AUTO
          1 000C48  EFC7 0094                            STB,B6   ALTQOS+2,AUTO
          1 000C4A  BBC7 0094                            LAB,B3   ALTQOS+2,AUTO
          1 000C4C  CBF0 0100                            LAB,B4   256,IMO
          1 000C4E  E380 0000 0000  xent                 LNJ,B6   KNT$RECV
          1 000C51       0001                            DC       s:14844,PREL

     1699    14843
     1700    14844    5                     KNN$ROUTE.LINK# = -1;

  14844   1 000C52  ECC7 000E                            LDB,B6   ROUTE$,AUTO
          1 000C54  8946 0004                            LBT,'FFFF'X       4,B6
          1 000C56       FFFF

     1701    14845    5                     KNN$ROUTE.LINK$ = ADDR(NIL);

  14845   1 000C57  DB80 0000 0000                       LAB,B5   0
          1 000C5A  DF86                                 STB,B5   ,B6

     1702    14846    5                     KNN$ROUTE.CURRENT_QOS = 255;

  14846   1 000C5B  E870 00FF                            LDR,R6   255,IMO
          1 000C5D  EF46 0005                            STR,R6   5,B6

     1703    14847    5                     KNN$ROUTE.ALT_QOS = 255;

  14847   1 000C5F  EF46 0006                            STR,R6   6,B6

     1704    14848    6                     DO K = 0 TO KNN_OSIMAX#-1;

  14848   1 000C61  8747 001A                            CL       K,AUTO
          1 000C63  0F81 0037                            B        s:14858+2,PREL

     1705    14849    6                          OSI$ = KNN$OSIROUTE$(K);
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:245  

  14849   1 000C65  EC80 0000 0000  xsym                 LDB,B6   KNN_OSIROUTE$$
          1 000C68  B847 001A                            LDR,R3   K,AUTO
          1 000C6A  DCB6                                 LDB,B5   ,B6,R3
          1 000C6B  DFC7 001F                            STB,B5   OSI$,AUTO

     1706    14850    7                          DO L = 0 TO KNN_LINKS-1;

  14850   1 000C6D  8747 0019                            CL       L,AUTO
          1 000C6F  0F81 0022                            B        s:14857+2,PREL

     1707    14851    7                               IF KNN$OSIROUTE.LINK.ACTIVE(L)

  14851   1 000C71  ECC7 001F                            LDB,B6   OSI$,AUTO
          1 000C73  DBC6 001A                            LAB,B5   26,B6
          1 000C75  B847 0019                            LDR,R3   L,AUTO
          1 000C77  3F78                                 MLV,R3   120
          1 000C78  3E08                                 ADV,R3   8
          1 000C79  82B5                                 LB       ,B5,R3
          1 000C7A  0581 0015                            BBF      s:14857,PREL
          1 000C7C  A847 0019                            LDR,R2   L,AUTO
          1 000C7E  2F0F                                 MLV,R2   15
          1 000C7F  2E36                                 ADV,R2   54
          1 000C80  E2A6                                 LLH,R6   ,B6,R2
          1 000C81  E947 0017                            CMR,R6   I,AUTO
          1 000C83  0981 000C                            BNE      s:14857,PREL

     1708    14852    8                                 AND KNN$OSIROUTE.LINK.FEP#(L) = I THEN DO;

     1709    14853    8                                    KNN$OSIROUTE.LINK.ACTIVE(L) = '0'B;

  14853   1 000C85  DBC6 001A                            LAB,B5   26,B6
          1 000C87  8835                                 LBF      ,B5,R3

     1710    14854    8                                    KNN$OSIROUTE.LINK.QOS(L) = 255;

  14854   1 000C88  E870 00FF                            LDR,R6   255,IMO
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:246  
          1 000C8A  9847 0019                            LDR,R1   L,AUTO
          1 000C8C  1F0F                                 MLV,R1   15
          1 000C8D  1E38                                 ADV,R1   56
          1 000C8E  E796                                 STH,R6   ,B6,R1

     1711    14855    8                                    KNN$OSIROUTE.LINK.FEP#(L) = 255;

  14855   1 000C8F  E7A6                                 STH,R6   ,B6,R2

     1712    14856    8                                    END;

     1713    14857    7                               END;        /* do l                               */

  14857   1 000C90  8AC7 0019                            INC      L,AUTO
          1 000C92  E847 0019                            LDR,R6   L,AUTO
          1 000C94  685D                                 BLZ,R6   s:14851,SPREL
          1 000C95  E900 0000 0000  xsym                 CMR,R6   KNN_LINKS
          1 000C98  0259                                 BL       s:14851,SPREL

     1714    14858    6                          END;             /* do k                               */

  14858   1 000C99  8AC7 001A                            INC      K,AUTO
          1 000C9B  E847 001A                            LDR,R6   K,AUTO
          1 000C9D  6848                                 BLZ,R6   s:14849,SPREL
          1 000C9E  E900 0000 0000  xsym                 CMR,R6   KNN_OSIMAX#
          1 000CA1  0244                                 BL       s:14849,SPREL

     1715    14859    5                     END;

     1716    14860    4                END/*do if no link available*/;

     1717    14861    3           END/*do 0 to knn_nodes*/;

  14861   1 000CA2  8AC7 0017                            INC      I,AUTO
          1 000CA4  E847 0017                            LDR,R6   I,AUTO
          1 000CA6  E900 0000 0000  xsym                 CMR,R6   KNN_NODES
          1 000CA9  0381 FEDE                            BLE      s:14791,PREL
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:247  

     1718    14862    2      RETURN;

  14862   1 000CAB  ECC7 008E                            LDB,B6   KN@NETPARM+35,AUTO
          1 000CAD  C3C6 0001                            LNJ,B4   1,B6

     1719    14863    2   END UPDATE_ROUTE;
     1720    14864        %EJECT;
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:248  
     1721    14865    1   LINK_ACTIVE: PROC ALTRET;

  14865   1 000CAF  EFC7 008C            LINK_ACTIVE     STB,B6   KN@NETPARM+33,AUTO

     1722    14866
     1723    14867
     1724    14868    2      FEPST.FCN = IGA_FEPST;

  14868   1 000CB1  6C20                                 LDV,R6   32
          1 000CB2  E7C7 0006                            STH,R6   FEPST,AUTO

     1725    14869    2      FEPST.PROB = KIER_LNKUP;

  14869   1 000CB4  5C11                                 LDV,R5   17
          1 000CB5  DF47 0007                            STR,R5   FEPST+1,AUTO

     1726    14870    2      FEPST.FEP = DEST_NODE;

  14870   1 000CB7  C847 000D                            LDR,R4   DEST_NODE,AUTO
          1 000CB9  CAC7 0006                            SRM,R4,'00FF'X    FEPST,AUTO
          1 000CBB       00FF

     1727    14871    2      FEPST.QOS = QOS;

  14871   1 000CBC  B847 0016                            LDR,R3   QOS,AUTO
          1 000CBE  BF47 0009                            STR,R3   FEPST+3,AUTO

     1728    14872    2      FEPST.REASON = KIER_LNKUP;

  14872   1 000CC0  DF47 0008                            STR,R5   FEPST+2,AUTO

     1729    14873
     1730    14874        /*
     1731    14875             if the node is already active then don't tell nodeadmn
     1732    14876        */
     1733    14877    2      IF KNN$ROUTE$(DEST_NODE)->KNN$ROUTE.CURRENT_QOS = 255 AND

PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:249  
  14877   1 000CC2  DC80 0000 0000  xsym                 LDB,B5   KNN_ROUTE$$
          1 000CC5  A854                                 LDR,R2   R4
          1 000CC6  CCA5                                 LDB,B4   ,B5,R2
          1 000CC7  9844 0005                            LDR,R1   5,B4
          1 000CC9  9970 00FF                            CMR,R1   255,IMO
          1 000CCB  0981 0025                            BNE      s:14886,PREL
          1 000CCD  8DC4 0002                            CMN      2,B4
          1 000CCF  0981 0021                            BNE      s:14886,PREL

     1734    14878    3        KNN$ROUTE$(DEST_NODE)->KNN$ROUTE.CTX$ = ADDR(NIL) THEN DO;

     1735    14879    3           FEPST.CHAN# = KNN$LINK.CHAN#;

  14879   1 000CD1  BCC7 0010                            LDB,B3   LINK$,AUTO
          1 000CD3  E843 0023                            LDR,R6   35,B3
          1 000CD5  EF47 000C                            STR,R6   FEPST+6,AUTO

     1736    14880    3           CALL KNB$WRITE(ADDR(FEPST),SIZEC(FEPST))

  14880   1 000CD7  CBC7 0006                            LAB,B4   FEPST,AUTO
          1 000CD9  CFC7 0094                            STB,B4   ALTQOS+2,AUTO
          1 000CDB  ABF0 000E                            LAB,B2   14,IMO
          1 000CDD  AFC7 0098                            STB,B2   ALTQOS+6,AUTO
          1 000CDF  9BC7 0094                            LAB,B1   ALTQOS+2,AUTO
          1 000CE1  9FC7 0096                            STB,B1   ALTQOS+4,AUTO
          1 000CE3  BBC7 0096                            LAB,B3   ALTQOS+4,AUTO
          1 000CE5  CBF0 0200                            LAB,B4   512,IMO
          1 000CE7  E380 0000 0000  xent                 LNJ,B6   KNB$WRITE
          1 000CEA       0003                            DC       s:14882,PREL
          1 000CEB  0F81 0005                            B        s:14886,PREL

     1737    14881    4           WHENALTRETURN DO;

     1738    14882    4                ALTRETURN;

  14882   1 000CED  ECC7 008C                            LDB,B6   KN@NETPARM+33,AUTO
          1 000CEF  B806                                 LDR,R3   ,B6
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:250  
          1 000CF0  C3B6                                 LNJ,B4   ,B6,R3

     1739    14883    4                END;
     1740    14884    3           END;

     1741    14885
     1742    14886    3      DO I = 0 TO KNN_NODES;

  14886   1 000CF1  8747 0017                            CL       I,AUTO
          1 000CF3  0F81 0055                            B        s:14895+2,PREL

     1743    14887    3           IF I = DEST_NODE THEN           /* Going to same node                 */

  14887   1 000CF5  E847 0017                            LDR,R6   I,AUTO
          1 000CF7  E947 000D                            CMR,R6   DEST_NODE,AUTO
          1 000CF9  0981 000F                            BNE      s:14890,PREL

     1744    14888    3                KNN$ROUTE$(I)->KNN$ROUTE.LINK.QOS(LINK#) = QOS;

  14888   1 000CFB  EC80 0000 0000  xsym                 LDB,B6   KNN_ROUTE$$
          1 000CFE  B856                                 LDR,R3   R6
          1 000CFF  DCB6                                 LDB,B5   ,B6,R3
          1 000D00  D847 0016                            LDR,R5   QOS,AUTO
          1 000D02  A847 0012                            LDR,R2   LINK#,AUTO
          1 000D04  2F0A                                 MLV,R2   10
          1 000D05  2E11                                 ADV,R2   17
          1 000D06  D7A5                                 STH,R5   ,B5,R2
          1 000D07  0F81 000D                            B        s:14892,PREL

     1745    14889    3           ELSE
     1746    14890    3                KNN$ROUTE$(I)->KNN$ROUTE.LINK.QOS(LINK#)= 255;

  14890   1 000D09  EC80 0000 0000  xsym                 LDB,B6   KNN_ROUTE$$
          1 000D0C  B856                                 LDR,R3   R6
          1 000D0D  DCB6                                 LDB,B5   ,B6,R3
          1 000D0E  D870 00FF                            LDR,R5   255,IMO
          1 000D10  A847 0012                            LDR,R2   LINK#,AUTO
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:251  
          1 000D12  2F0A                                 MLV,R2   10
          1 000D13  2E11                                 ADV,R2   17
          1 000D14  D7A5                                 STH,R5   ,B5,R2

     1747    14891
     1748    14892    3           KNN$ROUTE$(I)->KNN$ROUTE.LINK.ACTIVE(LINK#) = '1'B;

  14892   1 000D15  EC80 0000 0000  xsym                 LDB,B6   KNN_ROUTE$$
          1 000D18  DCB6                                 LDB,B5   ,B6,R3
          1 000D19  CBC5 0008                            LAB,B4   8,B5
          1 000D1B  9847 0012                            LDR,R1   LINK#,AUTO
          1 000D1D  1F50                                 MLV,R1   80
          1 000D1E  8914                                 LBT      ,B4,R1

     1749    14893    3           KNN$ROUTE$(I)->KNN$ROUTE.LINK.MSGS_IN(LINK#) = 0;

  14893   1 000D1F  EC80 0000 0000  xsym                 LDB,B6   KNN_ROUTE$$
          1 000D22  DCB6                                 LDB,B5   ,B6,R3
          1 000D23  8CF0 0000 0000                       LDI      0,IMO
          1 000D26  8D47 0094                            SDI      ALTQOS+2,AUTO
          1 000D28  ABC7 0094                            LAB,B2   ALTQOS+2,AUTO
          1 000D2A  2C00                                 LDV,R2   0
          1 000D2B  6C04                                 LDV,R6   4
          1 000D2C  BB85                                 LAB,B3   ,B5
          1 000D2D  B847 0012                            LDR,R3   LINK#,AUTO
          1 000D2F  3F0A                                 MLV,R3   10
          1 000D30  3E12                                 ADV,R3   18
          1 000D31  0008                                 MMM

     1750    14894    3           KNN$ROUTE$(I)->KNN$ROUTE.LINK.MSGS_OUT(LINK#) = 0;

  14894   1 000D32  EC80 0000 0000  xsym                 LDB,B6   KNN_ROUTE$$
          1 000D35  B847 0017                            LDR,R3   I,AUTO
          1 000D37  DCB6                                 LDB,B5   ,B6,R3
          1 000D38  8CF0 0000 0000                       LDI      0,IMO
          1 000D3B  8D47 0094                            SDI      ALTQOS+2,AUTO
          1 000D3D  ABC7 0094                            LAB,B2   ALTQOS+2,AUTO
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:252  
          1 000D3F  2C00                                 LDV,R2   0
          1 000D40  6C04                                 LDV,R6   4
          1 000D41  BB85                                 LAB,B3   ,B5
          1 000D42  B847 0012                            LDR,R3   LINK#,AUTO
          1 000D44  3F0A                                 MLV,R3   10
          1 000D45  3E16                                 ADV,R3   22
          1 000D46  0008                                 MMM

     1751    14895    3           END;

  14895   1 000D47  8AC7 0017                            INC      I,AUTO
          1 000D49  E847 0017                            LDR,R6   I,AUTO
          1 000D4B  E900 0000 0000  xsym                 CMR,R6   KNN_NODES
          1 000D4E  0381 FFA6                            BLE      s:14887,PREL

     1752    14896
     1753    14897    2      CALL UPDATE_ROUTE

  14897   1 000D50  E3C0 FE31                            LNJ,B6   s:0,PREL
          1 000D52       0003                            DC       s:14899,PREL
          1 000D53  0F81 0005                            B        s:14901,PREL

     1754    14898    3      WHENALTRETURN DO;

     1755    14899    3           ALTRETURN;

  14899   1 000D55  ECC7 008C                            LDB,B6   KN@NETPARM+33,AUTO
          1 000D57  B806                                 LDR,R3   ,B6
          1 000D58  C3B6                                 LNJ,B4   ,B6,R3

     1756    14900    3           END;
     1757    14901    2      RETURN;

  14901   1 000D59  ECC7 008C                            LDB,B6   KN@NETPARM+33,AUTO
          1 000D5B  C3C6 0001                            LNJ,B4   1,B6

     1758    14902    2   END LINK_ACTIVE;
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:253  
     1759    14903        %EJECT;
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:254  
     1760    14904    1   LINK_DOWN: PROC ALTRET;

  14904   1 000D5D  EFC7 008C            LINK_DOWN       STB,B6   KN@NETPARM+33,AUTO

     1761    14905    2      FOUNDONE = '0'B;

  14905   1 000D5F  8747 002A                            CL       FOUNDONE,AUTO

     1762    14906    2      FEPST.FCN = IGA_FEPST;

  14906   1 000D61  6C20                                 LDV,R6   32
          1 000D62  E7C7 0006                            STH,R6   FEPST,AUTO

     1763    14907    2      FEPST.PROB = KIER_LNKDWN;

  14907   1 000D64  5C12                                 LDV,R5   18
          1 000D65  DF47 0007                            STR,R5   FEPST+1,AUTO

     1764    14908    2      FEPST.FEP = KNN$LINK.NODE#;

  14908   1 000D67  DCC7 0010                            LDB,B5   LINK$,AUTO
          1 000D69  C845 0002                            LDR,R4   2,B5
          1 000D6B  CAC7 0006                            SRM,R4,'00FF'X    FEPST,AUTO
          1 000D6D       00FF

     1765    14909    2      FEPST.REASON = KIER_LNKDWN;

  14909   1 000D6E  DF47 0008                            STR,R5   FEPST+2,AUTO

     1766    14910
     1767    14911        /* determine if there is a secondary link to this node available
     1768    14912           if so do not tell nodeadmn that the link is no longer available */
     1769    14913
     1770    14914    3      IF KNN$ROUTE$(KNN$LINK.NODE#)->KNN$ROUTE.LINK# = LINK# THEN DO;

  14914   1 000D70  B845 0002                            LDR,R3   2,B5
          1 000D72  CC80 0000 0000  xsym                 LDB,B4   KNN_ROUTE$$
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:255  
          1 000D75  BCB4                                 LDB,B3   ,B4,R3
          1 000D76  C843 0004                            LDR,R4   4,B3
          1 000D78  4801 00CD                            BLZ,R4   s:14960,PREL
          1 000D7A  C947 0012                            CMR,R4   LINK#,AUTO
          1 000D7C  0981 00C9                            BNE      s:14960,PREL

     1771    14915    4           DO J=0 TO KNN_LINKS-1;

  14915   1 000D7E  8747 0018                            CL       J,AUTO
          1 000D80  0F81 009A                            B        s:14950+2,PREL

     1772    14916    4                IF KNN$ROUTE$(KNN$LINK.NODE#)->KNN$ROUTE.LINK.ACTIVE(J)

  14916   1 000D82  ECC7 0010                            LDB,B6   LINK$,AUTO
          1 000D84  B846 0002                            LDR,R3   2,B6
          1 000D86  DC80 0000 0000  xsym                 LDB,B5   KNN_ROUTE$$
          1 000D89  CCB5                                 LDB,B4   ,B5,R3
          1 000D8A  A847 0018                            LDR,R2   J,AUTO
          1 000D8C  2F05                                 MLV,R2   5
          1 000D8D  2E08                                 ADV,R2   8
          1 000D8E  89A4                                 CMZ      ,B4,R2
          1 000D8F  0881 0089                            BAGE     s:14950,PREL
          1 000D91  E847 0018                            LDR,R6   J,AUTO
          1 000D93  E947 0012                            CMR,R6   LINK#,AUTO
          1 000D95  0901 0083                            BE       s:14950,PREL
          1 000D97  BC80 0000 0000  xsym                 LDB,B3   KNN_LINK$$
          1 000D9A  9856                                 LDR,R1   R6
          1 000D9B  AC93                                 LDB,B2   ,B3,R1
          1 000D9C  B942 0002                            CMR,R3   2,B2
          1 000D9E  0981 007A                            BNE      s:14950,PREL

     1773    14917    4                  AND J ~= LINK#
     1774    14918    5                  AND KNN$LINK$(J)->KNN$LINK.NODE# = KNN$LINK.NODE# THEN DO;

     1775    14919    5                     FOUNDONE = '1'B;

  14919   1 000DA0  8947 002A                            LBT,'8000'X       FOUNDONE,AUTO
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:256  
  14919   1 000DA2       8000

     1776    14920        /*
     1777    14921                if another path to the same is node is available, then go thru
     1778    14922                and change all of the nodes which were using that link to the
     1779    14923                new link.
     1780    14924        */
     1781    14925    6                     DO I = 0 TO KNN_NODES;

  14925   1 000DA3  8747 0017                            CL       I,AUTO
          1 000DA5  0F81 0068                            B        s:14947+2,PREL

     1782    14926    6                          IF KNN$ROUTE$(I)->KNN$ROUTE.LINK# = LINK#

  14926   1 000DA7  EC80 0000 0000  xsym                 LDB,B6   KNN_ROUTE$$
          1 000DAA  B847 0017                            LDR,R3   I,AUTO
          1 000DAC  DCB6                                 LDB,B5   ,B6,R3
          1 000DAD  E845 0004                            LDR,R6   4,B5
          1 000DAF  6801 0047                            BLZ,R6   s:14945,PREL
          1 000DB1  E947 0012                            CMR,R6   LINK#,AUTO
          1 000DB3  0981 0043                            BNE      s:14945,PREL
          1 000DB5  D845 0005                            LDR,R5   5,B5
          1 000DB7  D970 00FF                            CMR,R5   255,IMO
          1 000DB9  0281 003D                            BGE      s:14945,PREL

     1783    14927    7                            AND KNN$ROUTE$(I)->KNN$ROUTE.CURRENT_QOS < 255 THEN DO;

     1784    14928    7                               KNN$ROUTE$(I)->KNN$ROUTE.LINK# = J;

  14928   1 000DBB  E847 0018                            LDR,R6   J,AUTO
          1 000DBD  EF45 0004                            STR,R6   4,B5

     1785    14929    7                               KNN$ROUTE$(I)->KNN$ROUTE.LINK$ = KNN$LINK$(J);

  14929   1 000DBF  DCB6                                 LDB,B5   ,B6,R3
          1 000DC0  CC80 0000 0000  xsym                 LDB,B4   KNN_LINK$$
          1 000DC3  A856                                 LDR,R2   R6
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:257  
          1 000DC4  BCA4                                 LDB,B3   ,B4,R2
          1 000DC5  BF85                                 STB,B3   ,B5

     1786    14930        /*
     1787    14931                    replace the current qos with the new qos if the node is link connected.
     1788    14932                         otherwise subtract off the old links qos and add on the new links
     1789    14933                         qos.   also update the qos in the routes link table.
     1790    14934        */
     1791    14935    8                               IF I = KNN$LINK.NODE# THEN DO;

  14935   1 000DC6  ECC7 0010                            LDB,B6   LINK$,AUTO
          1 000DC8  B946 0002                            CMR,R3   2,B6
          1 000DCA  0981 0016                            BNE      s:14940,PREL

     1792    14936    8                                   KNN$ROUTE$(I)->KNN$ROUTE.CURRENT_QOS = KNN$LINK$(J)
             14936                                             ->KNN$LINK.QOS;

  14936   1 000DCC  DC80 0000 0000  xsym                 LDB,B5   KNN_ROUTE$$
          1 000DCF  CCB5                                 LDB,B4   ,B5,R3
          1 000DD0  BC80 0000 0000  xsym                 LDB,B3   KNN_LINK$$
          1 000DD3  ACA3                                 LDB,B2   ,B3,R2
          1 000DD4  D842 0004                            LDR,R5   4,B2
          1 000DD6  DF44 0005                            STR,R5   5,B4

     1793    14937    8                                   KNN$ROUTE$(I)->KNN$ROUTE.LINK.QOS(J) = KNN$LINK$(J)
             14937                                             ->KNN$LINK.QOS;

  14937   1 000DD8  CCB5                                 LDB,B4   ,B5,R3
          1 000DD9  ACA3                                 LDB,B2   ,B3,R2
          1 000DDA  D842 0004                            LDR,R5   4,B2
          1 000DDC  2F0A                                 MLV,R2   10
          1 000DDD  2E11                                 ADV,R2   17
          1 000DDE  D7A4                                 STH,R5   ,B4,R2

     1794    14938    8                                    END;

  14938   1 000DDF  0F81 0017                            B        s:14945,PREL
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:258  

     1795    14939    8                               ELSE DO;

     1796    14940    8                                   KNN$ROUTE$(I)->KNN$ROUTE.CURRENT_QOS = KNN$ROUTE$(I
             14940                                             )->KNN$ROUTE.CURRENT_QOS -

  14940   1 000DE1  DC80 0000 0000  xsym                 LDB,B5   KNN_ROUTE$$
          1 000DE4  CCB5                                 LDB,B4   ,B5,R3
          1 000DE5  D844 0005                            LDR,R5   5,B4
          1 000DE7  D246 0004                            SUB,R5   4,B6
          1 000DE9  BC80 0000 0000  xsym                 LDB,B3   KNN_LINK$$
          1 000DEC  ACA3                                 LDB,B2   ,B3,R2
          1 000DED  DA42 0004                            ADD,R5   4,B2
          1 000DEF  DF44 0005                            STR,R5   5,B4

     1797    14941    8                                      KNN$LINK.QOS + KNN$LINK$(J)->KNN$LINK.QOS;
     1798    14942    8                                   KNN$ROUTE$(I)->KNN$ROUTE.LINK.QOS(J) = KNN$ROUTE$(I
             14942                                             )->KNN$ROUTE.CURRENT_QOS;

  14942   1 000DF1  CCB5                                 LDB,B4   ,B5,R3
          1 000DF2  D844 0005                            LDR,R5   5,B4
          1 000DF4  2F0A                                 MLV,R2   10
          1 000DF5  2E11                                 ADV,R2   17
          1 000DF6  D7A4                                 STH,R5   ,B4,R2

     1799    14943    8                                    END;

     1800    14944    7                               END;

     1801    14945    6                          KNN$ROUTE$(I)->KNN$ROUTE.LINK.QOS(LINK#) = 255;

  14945   1 000DF7  EC80 0000 0000  xsym                 LDB,B6   KNN_ROUTE$$
          1 000DFA  DCB6                                 LDB,B5   ,B6,R3
          1 000DFB  E870 00FF                            LDR,R6   255,IMO
          1 000DFD  A847 0012                            LDR,R2   LINK#,AUTO
          1 000DFF  2F0A                                 MLV,R2   10
          1 000E00  2E11                                 ADV,R2   17
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:259  
          1 000E01  E7A5                                 STH,R6   ,B5,R2

     1802    14946    6                          KNN$ROUTE$(I)->KNN$ROUTE.LINK.ACTIVE(LINK#) = '0'B;

  14946   1 000E02  EC80 0000 0000  xsym                 LDB,B6   KNN_ROUTE$$
          1 000E05  DCB6                                 LDB,B5   ,B6,R3
          1 000E06  CBC5 0008                            LAB,B4   8,B5
          1 000E08  9847 0012                            LDR,R1   LINK#,AUTO
          1 000E0A  1F50                                 MLV,R1   80
          1 000E0B  8814                                 LBF      ,B4,R1

     1803    14947    6                          END;
             14947                          /* do i = 0 to knn_nodes update route table to reflect new link*/

  14947   1 000E0C  8AC7 0017                            INC      I,AUTO
          1 000E0E  E847 0017                            LDR,R6   I,AUTO
          1 000E10  E900 0000 0000  xsym                 CMR,R6   KNN_NODES
          1 000E13  0381 FF93                            BLE      s:14926,PREL

     1804    14948    5                     RETURN;     /* continue processing like nothing happened    */

  14948   1 000E15  ECC7 008C                            LDB,B6   KN@NETPARM+33,AUTO
          1 000E17  C3C6 0001                            LNJ,B4   1,B6

     1805    14949    5                     END;
     1806    14950    4                END;                       /* do j = 0 to knn_nodes*/

  14950   1 000E19  8AC7 0018                            INC      J,AUTO
          1 000E1B  E847 0018                            LDR,R6   J,AUTO
          1 000E1D  E900 0000 0000  xsym                 CMR,R6   KNN_LINKS
          1 000E20  0201 FF61                            BL       s:14916,PREL

     1807    14951    4           IF NOT FOUNDONE THEN DO;

  14951   1 000E22  89C7 002A                            CMZ      FOUNDONE,AUTO
          1 000E24  0801 0021                            BAL      s:14960,PREL

PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:260  
     1808    14952    4                FEPST.CHAN# = KNN$LINK.CHAN#;

  14952   1 000E26  ECC7 0010                            LDB,B6   LINK$,AUTO
          1 000E28  D846 0023                            LDR,R5   35,B6
          1 000E2A  DF47 000C                            STR,R5   FEPST+6,AUTO

     1809    14953    4                CALL KNB$WRITE(ADDR(FEPST),SIZEC(FEPST))

  14953   1 000E2C  DBC7 0006                            LAB,B5   FEPST,AUTO
          1 000E2E  DFC7 0094                            STB,B5   ALTQOS+2,AUTO
          1 000E30  CBF0 000E                            LAB,B4   14,IMO
          1 000E32  CFC7 0098                            STB,B4   ALTQOS+6,AUTO
          1 000E34  BBC7 0094                            LAB,B3   ALTQOS+2,AUTO
          1 000E36  BFC7 0096                            STB,B3   ALTQOS+4,AUTO
          1 000E38  BBC7 0096                            LAB,B3   ALTQOS+4,AUTO
          1 000E3A  CBF0 0200                            LAB,B4   512,IMO
          1 000E3C  E380 0000 0000  xent                 LNJ,B6   KNB$WRITE
          1 000E3F       0003                            DC       s:14955,PREL
          1 000E40  0F81 0005                            B        s:14960,PREL

     1810    14954    5                WHENALTRETURN DO;

     1811    14955    5                     ALTRETURN;

  14955   1 000E42  ECC7 008C                            LDB,B6   KN@NETPARM+33,AUTO
          1 000E44  B806                                 LDR,R3   ,B6
          1 000E45  C3B6                                 LNJ,B4   ,B6,R3

     1812    14956    5                     END;
     1813    14957    4                END;

     1814    14958    3           END;

     1815    14959
     1816    14960    3      DO I = 0 TO KNN_NODES;

  14960   1 000E46  8747 0017                            CL       I,AUTO
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:261  
          1 000E48  0F81 001A                            B        s:14963+2,PREL

     1817    14961    3           KNN$ROUTE$(I)->KNN$ROUTE.LINK.QOS(LINK#) = 255;

  14961   1 000E4A  EC80 0000 0000  xsym                 LDB,B6   KNN_ROUTE$$
          1 000E4D  B847 0017                            LDR,R3   I,AUTO
          1 000E4F  DCB6                                 LDB,B5   ,B6,R3
          1 000E50  E870 00FF                            LDR,R6   255,IMO
          1 000E52  A847 0012                            LDR,R2   LINK#,AUTO
          1 000E54  2F0A                                 MLV,R2   10
          1 000E55  2E11                                 ADV,R2   17
          1 000E56  E7A5                                 STH,R6   ,B5,R2

     1818    14962    3           KNN$ROUTE$(I)->KNN$ROUTE.LINK.ACTIVE(LINK#) = '0'B;

  14962   1 000E57  EC80 0000 0000  xsym                 LDB,B6   KNN_ROUTE$$
          1 000E5A  DCB6                                 LDB,B5   ,B6,R3
          1 000E5B  CBC5 0008                            LAB,B4   8,B5
          1 000E5D  9847 0012                            LDR,R1   LINK#,AUTO
          1 000E5F  1F50                                 MLV,R1   80
          1 000E60  8814                                 LBF      ,B4,R1

     1819    14963    3           END;

  14963   1 000E61  8AC7 0017                            INC      I,AUTO
          1 000E63  E847 0017                            LDR,R6   I,AUTO
          1 000E65  E900 0000 0000  xsym                 CMR,R6   KNN_NODES
          1 000E68  03E2                                 BLE      s:14961,SPREL

     1820    14964
     1821    14965    2      CALL UPDATE_ROUTE

  14965   1 000E69  E3C0 FD18                            LNJ,B6   s:0,PREL
          1 000E6B       0003                            DC       s:14967,PREL
          1 000E6C  0F81 0005                            B        s:14970,PREL

     1822    14966    3      WHENALTRETURN DO;
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:262  

     1823    14967    3           ALTRETURN;

  14967   1 000E6E  ECC7 008C                            LDB,B6   KN@NETPARM+33,AUTO
          1 000E70  B806                                 LDR,R3   ,B6
          1 000E71  C3B6                                 LNJ,B4   ,B6,R3

     1824    14968    3           END;
     1825    14969
     1826    14970    2      RETURN;

  14970   1 000E72  ECC7 008C                            LDB,B6   KN@NETPARM+33,AUTO
          1 000E74  C3C6 0001                            LNJ,B4   1,B6

     1827    14971
     1828    14972    2   END LINK_DOWN;
     1829    14973        %EJECT;
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:263  
     1830    14974    1   OSILINK_UP: PROC;

  14974   1 000E76  EFC7 008C            OSILINK_UP      STB,B6   KN@NETPARM+33,AUTO

     1831    14975
     1832    14976    3      DO J = 0 TO KNN_OSIMAX# - 1 ;

  14976   1 000E78  8747 0018                            CL       J,AUTO
          1 000E7A  0F81 00AA                            B        s:15007+2,PREL

     1833    14977    3           OSI$ = KNN$OSIROUTE$(J);

  14977   1 000E7C  EC80 0000 0000  xsym                 LDB,B6   KNN_OSIROUTE$$
          1 000E7F  B847 0018                            LDR,R3   J,AUTO
          1 000E81  DCB6                                 LDB,B5   ,B6,R3
          1 000E82  DFC7 001F                            STB,B5   OSI$,AUTO

     1834    14978    4           IF KNN$OSIROUTE.NS_TYPE = %K_TYPE_RNSAP THEN DO;

  14978   1 000E84  E845 001A                            LDR,R6   26,B5
          1 000E86  604C                                 SOR,R6   12
          1 000E87  6D02                                 CMV,R6   2
          1 000E88  0981 009A                            BNE      s:15007,PREL

     1835    14979    4                SNPATMPLT1 = KNN$OSIROUTE.SNPA.ADDRESS;

  14979   1 000E8A  0021                                 ALR      ;
          1 000E8B       C705 000B                                ALPHANUM(11,B5,1,7),;
          1 000E8D       4807 002B                                ALPHANUM(SNPATMPLT1,AUTO,,8,FILL)

     1836    14980    4                SNPATMPLT3 = SNPA.ADDRESS;

  14980   1 000E8F  0021                                 ALR      ;
          1 000E90       C707 0061                                ALPHANUM(SNPA,AUTO,1,7),;
          1 000E92       4807 002F                                ALPHANUM(SNPATMPLT3,AUTO,,8,FILL)

     1837    14981    5                DO I = 0 TO MINIMUM(KNN$OSIROUTE.SNPA.LEN,SNPA.LEN)-1;
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:264  

  14981   1 000E94  8747 0017                            CL       I,AUTO
          1 000E96  437F                                 CSYNC    s:14981+1,SPREL
          1 000E97  0F81 002A                            B        s:14984+2,PREL

     1838    14982    5                     IF SNPATMPLT2.NIBBLES.NIB(I) ~= SNPATMPLT4.NIBBLES.NIB(I) THEN

  14982   1 000E99  ABC7 002B                            LAB,B2   SNPATMPLT1,AUTO
          1 000E9B  A847 0017                            LDR,R2   I,AUTO
          1 000E9D  2002                                 SOL,R2   2
          1 000E9E  6C04                                 LDV,R6   4
          1 000E9F  BBC7 0094                            LAB,B3   ALTQOS+2,AUTO
          1 000EA1  3C00                                 LDV,R3   0
          1 000EA2  7C10                                 LDV,R7   16
          1 000EA3  D380 0000 0000  xent                 LNJ,B5   X6B_BLR
          1 000EA6  E847 0094                            LDR,R6   ALTQOS+2,AUTO
          1 000EA8  604C                                 SOR,R6   12
          1 000EA9  EF47 0096                            STR,R6   ALTQOS+4,AUTO
          1 000EAB  ABC7 002F                            LAB,B2   SNPATMPLT3,AUTO
          1 000EAD  A847 0017                            LDR,R2   I,AUTO
          1 000EAF  2002                                 SOL,R2   2
          1 000EB0  6C04                                 LDV,R6   4
          1 000EB1  BBC7 0094                            LAB,B3   ALTQOS+2,AUTO
          1 000EB3  3C10                                 LDV,R3   16
          1 000EB4  7C10                                 LDV,R7   16
          1 000EB5  D380 0000 0000  xent                 LNJ,B5   X6B_BLR
          1 000EB8  E847 0095                            LDR,R6   ALTQOS+3,AUTO
          1 000EBA  604C                                 SOR,R6   12
          1 000EBB  D847 0096                            LDR,R5   ALTQOS+4,AUTO
          1 000EBD  E955                                 CMR,R6   R5
          1 000EBE  0981 0064                            BNE      s:15007,PREL

     1839    14983    5                          GOTO NXTJ2;
     1840    14984    5                     END;                  /* do i = 0 to min(len,len)-1         */

  14984   1 000EC0  8AC7 0017                            INC      I,AUTO
          1 000EC2  E2C7 0061                            LLH,R6   SNPA,AUTO
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:265  
          1 000EC4  ECC7 001F                            LDB,B6   OSI$,AUTO
          1 000EC6  D2C6 000B                            LLH,R5   11,B6
          1 000EC8  D956                                 CMR,R5   R6
          1 000EC9  0281 0002                            BGE      s:14984+12,PREL
          1 000ECB  E855                                 LDR,R6   R5
          1 000ECC  E947 0017                            CMR,R6   I,AUTO
          1 000ECE  034B                                 BG       s:14982,SPREL

     1841    14985                                                /* found a match                      */
     1842    14986    5                DO I = 0 TO KNN_LINKS - 1;

  14986   1 000ECF  8747 0017                            CL       I,AUTO
          1 000ED1  0F81 0021                            B        s:14993+2,PREL

     1843    14987    6                     IF KNN$OSIROUTE.LINK.FEP#(I) = DEST_NODE THEN DO;

  14987   1 000ED3  ECC7 001F                            LDB,B6   OSI$,AUTO
          1 000ED5  B847 0017                            LDR,R3   I,AUTO
          1 000ED7  3F0F                                 MLV,R3   15
          1 000ED8  3E36                                 ADV,R3   54
          1 000ED9  E2B6                                 LLH,R6   ,B6,R3
          1 000EDA  E947 000D                            CMR,R6   DEST_NODE,AUTO
          1 000EDC  0981 0014                            BNE      s:14993,PREL

     1844    14988    6                          KNN$OSIROUTE.LINK.ACTIVE(I) = '1'B;

  14988   1 000EDE  DBC6 001A                            LAB,B5   26,B6
          1 000EE0  A847 0017                            LDR,R2   I,AUTO
          1 000EE2  2F78                                 MLV,R2   120
          1 000EE3  2E08                                 ADV,R2   8
          1 000EE4  8925                                 LBT      ,B5,R2

     1845    14989    6                          KNN$OSIROUTE.LINK.QOS(I) = QOS;

  14989   1 000EE5  E847 0016                            LDR,R6   QOS,AUTO
          1 000EE7  9847 0017                            LDR,R1   I,AUTO
          1 000EE9  1F0F                                 MLV,R1   15
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:266  
          1 000EEA  1E38                                 ADV,R1   56
          1 000EEB  E796                                 STH,R6   ,B6,R1

     1846    14990    6                          FOUNDONE = '1'B;

  14990   1 000EEC  8947 002A                            LBT,'8000'X       FOUNDONE,AUTO
  14990   1 000EEE       8000

     1847    14991    6                          GOTO NXTJ2;

  14991   1 000EEF  0F81 0033                            B        s:15007,PREL

     1848    14992    6                          END;             /* fep# = dest_node                   */
     1849    14993    5                     END;                  /* do I = 0 to knn_links - 1          */

  14993   1 000EF1  8AC7 0017                            INC      I,AUTO
          1 000EF3  E847 0017                            LDR,R6   I,AUTO
          1 000EF5  E900 0000 0000  xsym                 CMR,R6   KNN_LINKS
          1 000EF8  025B                                 BL       s:14987,SPREL

     1850    14994
     1851    14995        /*
     1852    14996             couldn't find a current entry, so lets make one
     1853    14997        */
     1854    14998    5                DO I = 0 TO KNN_LINKS - 1;

  14998   1 000EF9  8747 0017                            CL       I,AUTO
          1 000EFB  0F81 0021                            B        s:15005+2,PREL

     1855    14999    6                     IF NOT KNN$OSIROUTE.LINK.ACTIVE(I) THEN DO;

  14999   1 000EFD  ECC7 001F                            LDB,B6   OSI$,AUTO
          1 000EFF  DBC6 001A                            LAB,B5   26,B6
          1 000F01  B847 0017                            LDR,R3   I,AUTO
          1 000F03  3F78                                 MLV,R3   120
          1 000F04  3E08                                 ADV,R3   8
          1 000F05  82B5                                 LB       ,B5,R3
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:267  
          1 000F06  0501 0014                            BBT      s:15005,PREL

     1856    15000    6                          KNN$OSIROUTE.LINK.FEP#(I) = DEST_NODE;

  15000   1 000F08  E847 000D                            LDR,R6   DEST_NODE,AUTO
          1 000F0A  A847 0017                            LDR,R2   I,AUTO
          1 000F0C  2F0F                                 MLV,R2   15
          1 000F0D  2E36                                 ADV,R2   54
          1 000F0E  E7A6                                 STH,R6   ,B6,R2

     1857    15001    6                          KNN$OSIROUTE.LINK.QOS(I) = QOS;

  15001   1 000F0F  D847 0016                            LDR,R5   QOS,AUTO
          1 000F11  9847 0017                            LDR,R1   I,AUTO
          1 000F13  1F0F                                 MLV,R1   15
          1 000F14  1E38                                 ADV,R1   56
          1 000F15  D796                                 STH,R5   ,B6,R1

     1858    15002    6                          KNN$OSIROUTE.LINK.ACTIVE(I) = '1'B;

  15002   1 000F16  DBC6 001A                            LAB,B5   26,B6
          1 000F18  8935                                 LBT      ,B5,R3

     1859    15003    6                          GOTO NXTJ2;

  15003   1 000F19  0F81 0009                            B        s:15007,PREL

     1860    15004    6                          END;
     1861    15005    5                     END;                  /* DO I                               */

  15005   1 000F1B  8AC7 0017                            INC      I,AUTO
          1 000F1D  E847 0017                            LDR,R6   I,AUTO
          1 000F1F  E900 0000 0000  xsym                 CMR,R6   KNN_LINKS
          1 000F22  025B                                 BL       s:14999,SPREL

     1862    15006                            /* CALL GHS$ERRLOG( no space for osi link up in nsap x)*/
     1863    15007    4                END;                       /* type = rnsap                       */
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:268  

  15000   1                              NXTJ2           null
     1864    15008    3   NXTJ2:  ;
     1865    15009    3           END;                            /* do j                               */

  15009   1 000F23  8AC7 0018            NXTJ2           INC      J,AUTO
          1 000F25  E847 0018                            LDR,R6   J,AUTO
          1 000F27  E900 0000 0000  xsym                 CMR,R6   KNN_OSIMAX#
          1 000F2A  0201 FF51                            BL       s:14977,PREL

     1866    15010    2   END OSILINK_UP;

  15010   1 000F2C  ECC7 008C                            LDB,B6   KN@NETPARM+33,AUTO
          1 000F2E  C3C6 0001                            LNJ,B4   1,B6

     1867    15011
     1868    15012        %EJECT;
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:269  
     1869    15013    1   OSILINK_DOWN: PROC;

  15013   1 000F30  EFC7 008C            OSILINK_DOWN    STB,B6   KN@NETPARM+33,AUTO

     1870    15014
     1871    15015
     1872    15016    3      DO J = 0 TO KNN_OSIMAX# - 1 ;

  15016   1 000F32  8747 0018                            CL       J,AUTO
          1 000F34  0F81 0080                            B        s:15033+2,PREL

     1873    15017    3           OSI$ = KNN$OSIROUTE$(J);

  15017   1 000F36  EC80 0000 0000  xsym                 LDB,B6   KNN_OSIROUTE$$
          1 000F39  B847 0018                            LDR,R3   J,AUTO
          1 000F3B  DCB6                                 LDB,B5   ,B6,R3
          1 000F3C  DFC7 001F                            STB,B5   OSI$,AUTO

     1874    15018    4           IF KNN$OSIROUTE.NS_TYPE = %K_TYPE_RNSAP THEN DO;

  15018   1 000F3E  E845 001A                            LDR,R6   26,B5
          1 000F40  604C                                 SOR,R6   12
          1 000F41  6D02                                 CMV,R6   2
          1 000F42  0981 0070                            BNE      s:15033,PREL

     1875    15019    4                SNPATMPLT1 = KNN$OSIROUTE.SNPA.ADDRESS;

  15019   1 000F44  0021                                 ALR      ;
          1 000F45       C705 000B                                ALPHANUM(11,B5,1,7),;
          1 000F47       4807 002B                                ALPHANUM(SNPATMPLT1,AUTO,,8,FILL)

     1876    15020    4                SNPATMPLT3 = SNPA.ADDRESS;

  15020   1 000F49  0021                                 ALR      ;
          1 000F4A       C707 0061                                ALPHANUM(SNPA,AUTO,1,7),;
          1 000F4C       4807 002F                                ALPHANUM(SNPATMPLT3,AUTO,,8,FILL)

PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:270  
     1877    15021    5                DO I = 0 TO MINIMUM(KNN$OSIROUTE.SNPA.LEN,SNPA.LEN)-1;

  15021   1 000F4E  8747 0017                            CL       I,AUTO
          1 000F50  437F                                 CSYNC    s:15021+1,SPREL
          1 000F51  0F81 002A                            B        s:15024+2,PREL

     1878    15022    5                     IF SNPATMPLT2.NIBBLES.NIB(I) ~= SNPATMPLT4.NIBBLES.NIB(I) THEN

  15022   1 000F53  ABC7 002B                            LAB,B2   SNPATMPLT1,AUTO
          1 000F55  A847 0017                            LDR,R2   I,AUTO
          1 000F57  2002                                 SOL,R2   2
          1 000F58  6C04                                 LDV,R6   4
          1 000F59  BBC7 0094                            LAB,B3   ALTQOS+2,AUTO
          1 000F5B  3C00                                 LDV,R3   0
          1 000F5C  7C10                                 LDV,R7   16
          1 000F5D  D380 0000 0000  xent                 LNJ,B5   X6B_BLR
          1 000F60  E847 0094                            LDR,R6   ALTQOS+2,AUTO
          1 000F62  604C                                 SOR,R6   12
          1 000F63  EF47 0096                            STR,R6   ALTQOS+4,AUTO
          1 000F65  ABC7 002F                            LAB,B2   SNPATMPLT3,AUTO
          1 000F67  A847 0017                            LDR,R2   I,AUTO
          1 000F69  2002                                 SOL,R2   2
          1 000F6A  6C04                                 LDV,R6   4
          1 000F6B  BBC7 0094                            LAB,B3   ALTQOS+2,AUTO
          1 000F6D  3C10                                 LDV,R3   16
          1 000F6E  7C10                                 LDV,R7   16
          1 000F6F  D380 0000 0000  xent                 LNJ,B5   X6B_BLR
          1 000F72  E847 0095                            LDR,R6   ALTQOS+3,AUTO
          1 000F74  604C                                 SOR,R6   12
          1 000F75  D847 0096                            LDR,R5   ALTQOS+4,AUTO
          1 000F77  E955                                 CMR,R6   R5
          1 000F78  0981 003A                            BNE      s:15033,PREL

     1879    15023    5                          GOTO NXTJ3;
     1880    15024    5                     END;                  /* do i = 0 to min(len,len)-1         */

  15024   1 000F7A  8AC7 0017                            INC      I,AUTO
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:271  
          1 000F7C  E2C7 0061                            LLH,R6   SNPA,AUTO
          1 000F7E  ECC7 001F                            LDB,B6   OSI$,AUTO
          1 000F80  D2C6 000B                            LLH,R5   11,B6
          1 000F82  D956                                 CMR,R5   R6
          1 000F83  0281 0002                            BGE      s:15024+12,PREL
          1 000F85  E855                                 LDR,R6   R5
          1 000F86  E947 0017                            CMR,R6   I,AUTO
          1 000F88  034B                                 BG       s:15022,SPREL

     1881    15025                                                /* found a match                      */
     1882    15026    5                DO I = 0 TO KNN_LINKS - 1;

  15026   1 000F89  8747 0017                            CL       I,AUTO
          1 000F8B  0F81 0021                            B        s:15031+2,PREL

     1883    15027    6                     IF KNN$OSIROUTE.LINK.ACTIVE(I) AND KNN$OSIROUTE.LINK.FEP#(I) =
             15027                              DEST_NODE THEN DO;

  15027   1 000F8D  ECC7 001F                            LDB,B6   OSI$,AUTO
          1 000F8F  DBC6 001A                            LAB,B5   26,B6
          1 000F91  B847 0017                            LDR,R3   I,AUTO
          1 000F93  3F78                                 MLV,R3   120
          1 000F94  3E08                                 ADV,R3   8
          1 000F95  82B5                                 LB       ,B5,R3
          1 000F96  0581 0014                            BBF      s:15031,PREL
          1 000F98  A847 0017                            LDR,R2   I,AUTO
          1 000F9A  2F0F                                 MLV,R2   15
          1 000F9B  2E36                                 ADV,R2   54
          1 000F9C  E2A6                                 LLH,R6   ,B6,R2
          1 000F9D  E947 000D                            CMR,R6   DEST_NODE,AUTO
          1 000F9F  0981 000B                            BNE      s:15031,PREL

     1884    15028    6                          KNN$OSIROUTE.LINK.ACTIVE(I) = '0'B;

  15028   1 000FA1  DBC6 001A                            LAB,B5   26,B6
          1 000FA3  8835                                 LBF      ,B5,R3

PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:272  
     1885    15029    6                          KNN$OSIROUTE.LINK.QOS(I) = 255;

  15029   1 000FA4  E870 00FF                            LDR,R6   255,IMO
          1 000FA6  9847 0017                            LDR,R1   I,AUTO
          1 000FA8  1F0F                                 MLV,R1   15
          1 000FA9  1E38                                 ADV,R1   56
          1 000FAA  E796                                 STH,R6   ,B6,R1

     1886    15030    6                          END;             /* fep# = dest_node                   */

     1887    15031    5                     END;                  /* do I = 0 to knn_links - 1          */

  15031   1 000FAB  8AC7 0017                            INC      I,AUTO
          1 000FAD  E847 0017                            LDR,R6   I,AUTO
          1 000FAF  E900 0000 0000  xsym                 CMR,R6   KNN_LINKS
          1 000FB2  025B                                 BL       s:15027,SPREL

     1888    15032
     1889    15033    4                END;                       /* type = rnsap                       */

  15028   1                              NXTJ3           null
     1890    15034    3   NXTJ3:  ;
     1891    15035    3           END;                            /* do j                               */

  15035   1 000FB3  8AC7 0018            NXTJ3           INC      J,AUTO
          1 000FB5  E847 0018                            LDR,R6   J,AUTO
          1 000FB7  E900 0000 0000  xsym                 CMR,R6   KNN_OSIMAX#
          1 000FBA  0201 FF7B                            BL       s:15017,PREL

     1892    15036    2   END OSILINK_DOWN;

  15036   1 000FBC  ECC7 008C                            LDB,B6   KN@NETPARM+33,AUTO
          1 000FBE  C3C6 0001                            LNJ,B4   1,B6

     1893    15037        %EJECT;
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:273  
     1894    15038    1   BLDOSIHDR: PROC(NETPARM);

  15038   1 000FC0  EFC7 008C            BLDOSIHDR       STB,B6   KN@NETPARM+33,AUTO

     1895    15039
     1896    15040        %KN$NETPARM(NAME=NETPARM,STCLASS="");
     1897    15193    2      RETURN;

  15193   1 000FC2  ECC7 008C                            LDB,B6   KN@NETPARM+33,AUTO
          1 000FC4  C3C6 0001                            LNJ,B4   1,B6

     1898    15194    2   END BLDOSIHDR;
     1899    15195    1   SENDESH: PROC;

  15195   1 000FC6  EFC7 008C            SENDESH         STB,B6   KN@NETPARM+33,AUTO

     1900    15196    2      RETURN;

  15196   1 000FC8  ECC7 008C                            LDB,B6   KN@NETPARM+33,AUTO
          1 000FCA  C3C6 0001                            LNJ,B4   1,B6
     1901    15197    2   END SENDESH;
     1902    15198    1   END KNN$RECV;
     1903    15199        %EJECT;
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:274  
     1904    15200        %EOD;

PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:275  
--  Include file information  --

   K_INTERFACE_M.:E05TOU  is referenced.
   K_NETWORK_E.:E05TOU  is referenced.
   K_ADDRESS_M.:E05TOU  is referenced.
   KL_MACRO_C.:E05TOU  is referenced.
   KL_AFCN_C.:E05TOU  is referenced.
   KJ_FCNS_C.:E05TOU  is referenced.
   K_QDPHDRS_M.:E05TOU  is referenced.
   KNN_NETWORK_M.:E05TOU  is referenced.
   KNH_MACRO_C.:E05TOU  is referenced.
   KN_DATA_M.:E05TOU  is referenced.
   GU_LCP6_M.:E05TOU  is referenced.
   K_REASON_C.:E05TOU  is referenced.
   K_SCODE_C.:E05TOU  is referenced.
   KI_SUBS_C.:E05TOU  is referenced.
   KI_CP6.:E05TOU  is referenced.
   GH_GATE_M.:E05TOU  cannot be made into a system file and is referenced.
      No diagnostics issued in procedure KNN$RECV.
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:276  

 **** Variables and constants ****

  ****  Section 000 RoData KNN$RECV

  ****  Scalars and arrays  ****
HexLoc.c.b A Datatyp(siz) R M Lvl/name                 HexLoc.c.b A Datatyp(siz) R M Lvl/name

     3-0-0/w STRC(48)    r     1 BADFNC                    12-0-0/w STRC(32)    r     1 FPT@TERM_ACK
     C-0-0/w STRC(96)    r     1 FPT_NAK                   15-0-0/w UBIN(16)    r     1 KN_SCREECH
    14-0-0/w UBIN(16)    r     1 KN_SCREECH_HOPCOUNT        0-0-0/w STRC(48)    r     1 PRTCLERR

  ****  Auto variables  ****

  ****  Scalars and arrays  ****
HexLoc.c.b A Datatyp(siz) R M Lvl/name                 HexLoc.c.b A Datatyp(siz) R M Lvl/name

     4-0-0/w PTR         r     1 @KN$NETPARM               8E-0-0/w PTR         r     1 @NETPARM
    92-0-0/w UBIN(16)    r     1 ALTQOS                    91-0-0/w UBIN(16)    r     1 BESTQOS
    14-0-0/w SBIN(16)    r     1 CLNK#                     15-0-0/w UBIN(16)    r     1 CQOS
     D-0-0/w UBIN(16)    r     1 DEST_NODE                  6-0-0/w STRC(112)   r     1 FEPST
    2A-0-0/b BIT         r     1 FOUNDONE                  65-0-0/w STRC(96)    r     1 FPT@ACK
    25-0-0/w UBIN(16)    r     1 FUNCTION                  17-0-0/w UBIN(16)    r     1 I
    18-0-0/w UBIN(16)    r     1 J                         1A-0-0/w SBIN(16)    r     1 K
    *0-0-0/w STRC(528)   r     1 KN$NETPARM                6B-0-0/w STRC(528)   r     1 KN@NETPARM
    19-0-0/w SBIN(16)    r     1 L                         1B-0-0/w SBIN(16)    r     1 LEN
    12-0-0/w UBIN(16)    r     1 LINK#                     10-0-0/w PTR         r     1 LINK$
    13-0-0/w UBIN(16)    r     1 LINKIN#                   *0-0-0/w STRC(528)   r     1 NETPARM
    27-0-0/w UBIN(16)    r     1 NWHDR_SZ                  1F-0-0/w PTR         r     1 OSI$
    51-0-0/w STRC(256)   r     1 OSILINKCHG                21-0-0/w PTR         r     1 OSIROUTE$
    16-0-0/w UBIN(16)    r     1 QOS                       23-0-0/w PTR         r     1 QQQ$
    33-0-0/w STRC(480)   r     1 ROUTE                      E-0-0/w PTR         r     1 ROUTE$
    1C-0-0/w UBIN(16)    r     1 SIZE                      61-0-0/w STRC(64)    r     1 SNPA
    2B-0-0/w CHAR(8)     r     1 SNPATMPLT1                2B-0-0/w STRC(56)    r     1 SNPATMPLT2
    2F-0-0/w CHAR(8)     r     1 SNPATMPLT3                2F-0-0/w STRC(56)    r     1 SNPATMPLT4
    26-0-0/w UBIN(16)    r     1 SOURCE_NODE               90-0-0/w SBIN(16)    r     1 SVLINK
    33-0-0/w STRC(480)   r     1 UPDOSI                    1D-0-0/w PTR         r     1 UPDOSI$

PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:277  
  ****  SYMREF variables  ****

  ****  Scalars and arrays  ****
HexLoc.c.b A Datatyp(siz) R M Lvl/name                 HexLoc.c.b A Datatyp(siz) R M Lvl/name

     0-0-0/w PTR         r     1 KNN_LINK$$                 0-0-0/w UBIN(16)    r     1 KNN_LINKS
     0-0-0/w STRC(48)    r     1 KNN_LOCK                   0-0-0/w UBIN(16)    r     1 KNN_NODES
     0-0-0/w UBIN(16)    r     1 KNN_OSIMAX#                0-0-0/w PTR         r     1 KNN_OSIROUTE$$
     0-0-0/w PTR         r     1 KNN_ROUTE$$                0-0-0/w STRC(528)   r     1 KN_NETPARM_INIT
     0-0-0/w UBIN(16)    r     1 KN_NODE#

  ****  BASED and DCB variables  ****

  ****  Scalars and arrays  ****
HexLoc.c.b A Datatyp(siz) R M Lvl/name                 HexLoc.c.b A Datatyp(siz) R M Lvl/name

     0-0-0/w ACHR        r     1 ADDRESS                    0-0-0/w STRC(544)   r     1 B$OSI_HDR
     0-0-0/w STRC(32)    r     1 B$QDP_HDR                  0-0-0/w STRC(304)   r     1 FPT$CONNECT
     0-0-0/w STRC(720)   r     1 FPT_CONNECT                0-0-0/w STRC(96)    r     1 FPT_CONNECT_ACK
     0-0-0/w STRC(56)    r     1 KL$NODECHG                 0-0-0/w STRC(256)   r     1 KL$OSILINKCHG
     0-0-0/w STRC(480)   r     1 KL$UPDOSI                  0-0-0/w STRC(256)   r     1 KN$LDCT
     0-0-0/w STRC(32)    r     1 KNH$UID                    0-0-0/c STRC(608)   r     1 KNN$LINK
     0-0-0/w PTR         r     1 KNN$LINK$(0:0)
     0-0-0/w STRC(544)   r     1 KNN$OSIROUTE
     0-0-0/w PTR         r     1 KNN$OSIROUTE$(0:0)
     0-0-0/w STRC(208)   r     1 KNN$ROUTE
     0-0-0/w PTR         r     1 KNN$ROUTE$(0:0)


   Procedure KNN$RECV requires 4044 words for executable code.
   Procedure KNN$RECV requires 154 words of local(AUTO) storage.
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:278  
          *** CROSS REFERENCE LISTING ***
**     DENOTES     IDENTIFIER DEFINITION
<<                 IDENTIFIER'S VALUE SET
>>                 IDENTIFIER'S VALUE USED
<>                 IDENTIFIER SET AND/OR USED
--                 IDENTIFIER REFERENCED
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:279  
          MINI XREF LISTING

ADDRESS
     12976**DCL     14530>>IF      14530>>IF
ALTQOS IN PROCEDURE UPDATE_ROUTE
     14788**DCL     14793<<ASSIGN  14801<<ASSIGN  14816>>ASSIGN  14833>>ASSIGN
B$OSI_HDR
     12259**DCL     13991--ASSIGN  13992--ASSIGN
B$OSI_HDR.DST_NSAP
     12311**DCL     13988--ASSIGN
B$OSI_HDR.DST_NSAP.ADDRESS
     12320**DCL     12321--REDEF
B$OSI_HDR.MSGTYP
     12260**DCL     13986>>IF      14036>>IF
B$OSI_HDR.SOURCE_NODE
     12288**DCL     13990>>ASSIGN  14037>>ASSIGN
B$OSI_HDR.SRC_NSAP
     12369**DCL     13987--ASSIGN
B$OSI_HDR.SRC_NSAP.ADDRESS
     12378**DCL     12379--REDEF
B$OSI_HDR.TR_OPTIONS
     12428**DCL     13989--ASSIGN
B$OSI_HDR.TR_OPTIONS.TPDUSIZE
     12435**DCL     12436--REDEF
B$QDP_HDR
     12182**DCL     14041--ASSIGN  14042--ASSIGN  14123--ASSIGN  14189--ASSIGN
B$QDP_HDR.DEST_NODE
     12203**DCL     14067>>ASSIGN
B$QDP_HDR.HOP_COUNT
     12198**DCL     14078<<ASSIGN  14078>>ASSIGN  14079>>IF      14211<<ASSIGN  14211>>ASSIGN
B$QDP_HDR.MSGTYP
     12183**DCL     13972>>IF      14107>>IF      14191>>IF
B$QDP_HDR.SOURCE_NODE
     12209**DCL     14068>>ASSIGN
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:280  
BADFNC
     11392**DCL     13609<>CALL    14505<>CALL
BESTQOS IN PROCEDURE UPDATE_ROUTE
     14787**DCL     14792<<ASSIGN  14798>>IF      14803<<ASSIGN  14810>>IF      14815>>ASSIGN  14832>>ASSIGN
CLNK#
     10315**DCL     14415<<ASSIGN  14423<<ASSIGN  14428>>IF      14433>>ASSIGN  14434>>ASSIGN  14441>>ASSIGN
     14443>>ASSIGN
CQOS
     10316**DCL     14414<<ASSIGN  14421>>IF      14422<<ASSIGN
DEST_NODE
     10310**DCL     13670<<ASSIGN  13672<<ASSIGN  13677>>ASSIGN  13690>>ASSIGN  13732<<ASSIGN  13734<<ASSIGN
     13765>>ASSIGN  13771>>IF      13772>>ASSIGN  13773>>ASSIGN  13778>>IF      13803>>IF      13816>>IF
     13833<<ASSIGN  14067<<ASSIGN  14069>>IF      14088>>IF      14090>>ASSIGN  14305<<ASSIGN  14312>>IF
     14324>>IF      14325>>ASSIGN  14338<<ASSIGN  14671<<ASSIGN  14705<<ASSIGN  14707>>IF      14733>>ASSIGN
     14870>>ASSIGN  14877>>IF      14877>>IF      14887>>IF      14987>>IF      15000>>ASSIGN  15027>>IF
DONTSENDOSIDOWN
     14346**LABEL   14288--GOTO    14301--GOTO    14310--GOTO    14336--GOTO    14339--GOTO
DO_ALTRET
     14209**LABEL   14195--CALLALT 14200--CALLALT
DST.ADDRESS_N
     12972**DCL     12973--REDEF
FEPST
     10288**DCL     14822--CALL    14822--CALL    14880--CALL    14880--CALL    14953--CALL    14953--CALL
FEPST.ALT_QOS
     10299**DCL     14816<<ASSIGN
FEPST.CHAN#
     10300**DCL     14879<<ASSIGN  14952<<ASSIGN
FEPST.FCN
     10289**DCL     14812<<ASSIGN  14868<<ASSIGN  14906<<ASSIGN
FEPST.FEP
     10291**DCL     14814<<ASSIGN  14870<<ASSIGN  14908<<ASSIGN
FEPST.LNK_NODE
     10298**DCL     14819<<ASSIGN  14820<<ASSIGN
FEPST.PROB
     10294**DCL     14813<<ASSIGN  14869<<ASSIGN  14907<<ASSIGN
FEPST.QOS
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:281  
     10297**DCL     14815<<ASSIGN  14871<<ASSIGN
FEPST.REASON
     10296**DCL     14719<<ASSIGN  14872<<ASSIGN  14909<<ASSIGN
FEPST.STATE
     10295**DCL     10296--REDEF
FOUNDONE
     10333**DCL     14518<<ASSIGN  14905<<ASSIGN  14919<<ASSIGN  14951>>IF      14990<<ASSIGN
FOUND_LINK
     13748**LABEL   13739--GOTO
FPT$CONNECT
     12768**DCL     13646--IF
FPT$CONNECT.RLCID.GENERATION
     12804**DCL     12805--REDEF
FPT$CONNECT.RLCID.LDCTX
     12805**DCL     12805--REDEF
FPT$CONNECT.TERMINAL_ID.TERM
     12793**DCL     12802--REDEF
FPT@ACK
     10928**DCL     13658--ASSIGN  13799--ASSIGN
FPT@ACK.REASON
     10932**DCL     13654<<ASSIGN  13674<<ASSIGN  13679<<ASSIGN  13692<<ASSIGN  13695<<ASSIGN  13705<<ASSIGN
     13713<<ASSIGN  13798<<ASSIGN
FPT@ACK.UID.UID
     10958**DCL     10958--REDEF   10958--REDEF
FPT@ACK.UID.UIDX.CQ_HNDCTXID
     10959**DCL     13714<<ASSIGN
FPT@TERM_ACK
     11541**DCL     14236--ASSIGN  14354--ASSIGN
FPT_ACK.UID.UID
     11471**DCL     11471--REDEF   11471--REDEF
FPT_CONNECT.DEST
     12664**DCL     13653<>CALL
FPT_CONNECT.DEST.ADDRESS_N
     12694**DCL     12695--REDEF
FPT_CONNECT.DEST.AFI
     12671**DCL     13646>>IF
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:282  
FPT_CONNECT.DSTSNPA
     12750**DCL     13768>>ASSIGN
FPT_CONNECT.DSTSNPA.ADR_STRING
     12750**DCL     12750--REDEF
FPT_CONNECT.LADR.ADDRESS_N
     12746**DCL     12747--REDEF
FPT_CONNECT.RLCID
     12633**DCL     13793>>ASSIGN
FPT_CONNECT.RLCID.FLAGS.HOST_NODE
     12635**DCL     13729>>IF      13766>>ASSIGN
FPT_CONNECT.RLCID.FLAGS.VIRCIR
     12635**DCL     13729>>IF      13769>>ASSIGN
FPT_CONNECT.RLCID.GENERATION
     12633**DCL     12634--REDEF
FPT_CONNECT.RLCID.LDCTX
     12634**DCL     12634--REDEF
FPT_CONNECT.RLCID.NODE
     12633**DCL     13734>>ASSIGN
FPT_CONNECT.SERVICE
     12636**DCL     13763>>ASSIGN
FPT_CONNECT.TERMINAL_ID.TERM
     12622**DCL     12631--REDEF
FPT_CONNECT.TERMINAL_ID.TERM.CHANNEL
     12628**DCL     13767>>ASSIGN
FPT_CONNECT_ACK.REASON
     12841**DCL     13869>>IF
FPT_CONNECT_ACK.UID.UID
     12867**DCL     12867--REDEF   12867--REDEF
FPT_NAK
     13655**LABEL   13675--GOTO    13680--GOTO    13693--GOTO    13696--GOTO    13706--GOTO    13715--GOTO
     13748--ASSIGN
FPT_NAK.UID.UID
     11520**DCL     11520--REDEF   11520--REDEF
FUNCTION
     10328**DCL     13604<<ASSIGN  13605>>IF      13608>>IF      13611>>DOCASE
GHH$LOCK
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:283  
        51**DCL-ENT 13644--CALL    13865--CALL    14280--CALL    14398--CALL    14466--CALL    14559--CALL
     14593--CALL    14627--CALL    14725--CALL
GHH$UNLOCK
        51**DCL-ENT 13665--CALL    13756--CALL    13787--CALL    13811--CALL    13849--CALL    13877--CALL
     13886--CALL    13900--CALL    13909--CALL    14297--CALL    14320--CALL    14372--CALL    14387--CALL
     14410--CALL    14456--CALL    14478--CALL    14488--CALL    14499--CALL    14571--CALL    14606--CALL
     14651--CALL    14749--CALL    14759--CALL
I
     10318**DCL     14333<<DOINDEX 14334>>IF      14334>>IF      14352<<ASSIGN  14355>>IF      14380>>IF
     14430<<DOINDEX 14431>>IF      14431>>IF      14433>>ASSIGN  14434>>ASSIGN  14440>>IF      14441>>ASSIGN
     14443>>ASSIGN  14443>>ASSIGN  14519<<DOINDEX 14520>>ASSIGN  14618<<DOINDEX 14619>>ASSIGN  14790<<DOINDEX
     14794>>ASSIGN  14814>>ASSIGN  14837>>IF      14840>>ASSIGN  14851>>IF      14886<<DOINDEX 14887>>IF
     14888>>ASSIGN  14890>>ASSIGN  14892>>ASSIGN  14893>>ASSIGN  14894>>ASSIGN  14925<<DOINDEX 14926>>IF
     14926>>IF      14928>>ASSIGN  14929>>ASSIGN  14935>>IF      14936>>ASSIGN  14937>>ASSIGN  14940>>ASSIGN
     14940>>ASSIGN  14942>>ASSIGN  14942>>ASSIGN  14945>>ASSIGN  14946>>ASSIGN  14960<<DOINDEX 14961>>ASSIGN
     14962>>ASSIGN  14981<<DOINDEX 14982>>IF      14982>>IF      14986<<DOINDEX 14987>>IF      14988>>ASSIGN
     14989>>ASSIGN  14998<<DOINDEX 14999>>IF      15000>>ASSIGN  15001>>ASSIGN  15002>>ASSIGN  15021<<DOINDEX
     15022>>IF      15022>>IF      15026<<DOINDEX 15027>>IF      15027>>IF      15028>>ASSIGN  15029>>ASSIGN
J
     10319**DCL     14416<<DOINDEX 14417>>IF      14417>>IF      14417>>IF      14417>>IF      14421>>IF
     14422>>ASSIGN  14423>>ASSIGN  14797<<DOINDEX 14798>>IF      14798>>IF      14803>>ASSIGN  14804>>ASSIGN
     14915<<DOINDEX 14916>>IF      14916>>IF      14916>>IF      14928>>ASSIGN  14929>>ASSIGN  14936>>ASSIGN
     14937>>ASSIGN  14937>>ASSIGN  14940>>ASSIGN  14942>>ASSIGN  14976<<DOINDEX 14977>>ASSIGN  15016<<DOINDEX
     15017>>ASSIGN
K
     10321**DCL     14551<<DOINDEX 14552>>IF      14565>>ASSIGN  14585<<DOINDEX 14586>>IF      14596>>ASSIGN
     14598>>ASSIGN  14599>>ASSIGN  14600>>ASSIGN  14635>>ASSIGN  14848<<DOINDEX 14849>>ASSIGN
KL$NODECHG.HOSTNODE
     12158**DCL     14736>>IF
KL$NODECHG.MYNODE
     12156**DCL     14707>>IF      14713>>ASSIGN  14730>>IF
KL$NODECHG.NODE
     12157**DCL     14705>>ASSIGN  14715>>IF
KL$NODECHG.QOS
     12159**DCL     14732>>ASSIGN
KL$OSILINKCHG.MYNODE#
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:284  
     13479**DCL     14668>>IF
KL$OSILINKCHG.NODE#
     13481**DCL     14671>>ASSIGN
KL$OSILINKCHG.QOS
     13483**DCL     14673>>ASSIGN
KL$OSILINKCHG.SNPA
     13509**DCL     14672>>ASSIGN
KL$OSILINKCHG.SNPA.LEN
     13511**DCL     14675>>IF
KL$OSILINKCHG.TERMID.TERM
     13540**DCL     13549--REDEF
KL$OSILINKCHG.TYPE
     13470**DCL     14676>>IF
KL$UPDOSI.FCN
     13250**DCL     14539>>IF      14561>>IF      14580>>IF
KL$UPDOSI.FEP#
     13279**DCL     14537>>IF      14552>>IF      14598>>ASSIGN  14643>>ASSIGN
KL$UPDOSI.HOST#
     13276**DCL     14537>>IF      14640>>ASSIGN
KL$UPDOSI.LNSAP
     13363**DCL     14564>>ASSIGN  14595>>ASSIGN  14634>>ASSIGN
KL$UPDOSI.LNSAP.ADDRESS_N
     13393**DCL     13394--REDEF
KL$UPDOSI.MYNODE#
     13274**DCL     13276--REDEF
KL$UPDOSI.NODE#
     13277**DCL     13279--REDEF
KL$UPDOSI.NSAP
     13307**DCL     14527--ASSIGN  14632>>ASSIGN
KL$UPDOSI.NSAP.ADDRESS_N
     13337**DCL     13338--REDEF
KL$UPDOSI.NSAP.AFI
     13314**DCL     14522>>IF
KL$UPDOSI.NSAP.LEN
     13309**DCL     14522>>IF
KL$UPDOSI.NS_TYPE
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:285  
     13262**DCL     14522>>IF      14536>>IF      14630>>ASSIGN  14633>>IF
KL$UPDOSI.NW_TYPE
     13268**DCL     14631>>ASSIGN
KL$UPDOSI.QOS
     13282**DCL     14565>>ASSIGN  14599>>ASSIGN  14644>>ASSIGN
KL$UPDOSI.SNPA
     13417**DCL     14549>>IF      14597>>ASSIGN  14636>>ASSIGN
KN$LDCT.CONN_TYPE
     11908**DCL     13687<<ASSIGN  13951>>IF      14107>>IF      14289>>IF      14352>>ASSIGN
KN$LDCT.FLAGS.REL
     12092**DCL     14242<<ASSIGN  14245<<ASSIGN  14283>>IF      14310>>IF      14365<<ASSIGN
KN$LDCT.LDCTX
     12049**DCL     14364<>CALL
KN$LDCT.LINK_ID
     12010**DCL     13776<<ASSIGN  13943>>ASSIGN  14098>>ASSIGN  14306>>ASSIGN  14307>>ASSIGN  14400>>ASSIGN
     14468>>ASSIGN
KN$LDCT.RLCID
     11940**DCL     13793<<ASSIGN
KN$LDCT.RLCID.LDCTX
     11968**DCL     11975--REDEF   11983--REDEF
KN$LDCT.RLCID.NODE
     11946**DCL     14305>>ASSIGN
KN$LDCT.STATE
     11922**DCL     13688<<ASSIGN  13867>>IF      13891<<ASSIGN  13952>>IF
KN$LDCT.TRANSPORT_ID
     12002**DCL     12010--REDEF
KN$LDCT.UID
     12032**DCL     12033--REDEF   12042--REDEF   13714--ASSIGN
KN$LDCT.USER_ENTRY$
     12113**DCL     13892<<ASSIGN  14366<<ASSIGN
KN$NETPARM
     10133**DCL         9--PROC    13659<>CALL    13691<>CALL    13750<>CALL    13801<>CALL    13871<>CALL
     13894<>CALL    13936<>CALL    13961<>CALL    13973<>CALL    14003<>CALL    14015<>CALL    14043<>CALL
     14052<>CALL    14128<>CALL    14140<>CALL    14161<>CALL    14195<>CALL    14200<>CALL    14241<>CALL
     14291<>CALL    14350<<ASSIGN  14360<>CALL    14515--ENTRY   14666--ENTRY   14703--ENTRY
KN$NETPARM.DST_ADDR$
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:286  
     10267**DCL     12940--IMP-PTR 13988<<ASSIGN  14039<<ASSIGN  14112<<ASSIGN
KN$NETPARM.ERRCODE
     10240**DCL     13692>>ASSIGN  14004>>IF      14044>>IF      14132>>IF      14144>>IF
KN$NETPARM.FLAGS.CONS
     10210**DCL     13960<<ASSIGN
KN$NETPARM.FPT$
     10252**DCL     12152--IMP-PTR 12597--IMP-PTR 12768--IMP-PTR 12837--IMP-PTR 13239--IMP-PTR 13448--IMP-PTR
     13646>>IF      13646>>IF      13653>>CALL    13658<<ASSIGN  13729>>IF      13729>>IF      13734>>ASSIGN
     13748<<ASSIGN  13763>>ASSIGN  13766>>ASSIGN  13767>>ASSIGN  13768>>ASSIGN  13769>>ASSIGN  13793>>ASSIGN
     13799<<ASSIGN  13869>>IF      13989<<ASSIGN  14236<<ASSIGN  14354<<ASSIGN  14522>>IF      14522>>IF
     14522>>IF      14527>>ASSIGN  14536>>IF      14537>>IF      14537>>IF      14539>>IF      14549>>IF
     14552>>IF      14561>>IF      14564>>ASSIGN  14565>>ASSIGN  14580>>IF      14595>>ASSIGN  14597>>ASSIGN
     14598>>ASSIGN  14599>>ASSIGN  14630>>ASSIGN  14631>>ASSIGN  14632>>ASSIGN  14633>>IF      14634>>ASSIGN
     14636>>ASSIGN  14640>>ASSIGN  14643>>ASSIGN  14644>>ASSIGN  14668>>IF      14671>>ASSIGN  14672>>ASSIGN
     14673>>ASSIGN  14675>>IF      14676>>IF      14705>>ASSIGN  14707>>IF      14713>>ASSIGN  14715>>IF
     14730>>IF      14732>>ASSIGN  14736>>IF
KN$NETPARM.FUNCTION
     10228**DCL     13604>>ASSIGN  13657<<ASSIGN  13689<<ASSIGN  13747<<ASSIGN  13797<<ASSIGN  13870<<ASSIGN
     13893<<ASSIGN  13955<<ASSIGN  13993<<ASSIGN  14038<<ASSIGN  14111<<ASSIGN  14237<<ASSIGN  14290<<ASSIGN
     14353<<ASSIGN
KN$NETPARM.LDCT$
     10134**DCL     11907--IMP-PTR 13687>>ASSIGN  13688>>ASSIGN  13762>>ASSIGN  13776>>ASSIGN  13793>>ASSIGN
     13867>>IF      13891>>ASSIGN  13892>>ASSIGN  13943>>ASSIGN  13951>>IF      13952>>IF      13994>>ASSIGN
     14005<<ASSIGN  14008<<ASSIGN  14016<<ASSIGN  14019<<ASSIGN  14051>>ASSIGN  14053<<ASSIGN  14056<<ASSIGN
     14099>>ASSIGN  14101<<ASSIGN  14107>>IF      14134<<ASSIGN  14146<<ASSIGN  14163<<ASSIGN  14209<<ASSIGN
     14240>>ASSIGN  14242>>ASSIGN  14245>>ASSIGN  14282>>ASSIGN  14283>>IF      14289>>IF      14305>>ASSIGN
     14306>>ASSIGN  14307>>ASSIGN  14310>>IF      14351<<ASSIGN  14352>>ASSIGN  14364>>CALL    14365>>ASSIGN
     14366>>ASSIGN  14400>>ASSIGN  14468>>ASSIGN
KN$NETPARM.MSG$
     10140**DCL     10145--REDEF
KN$NETPARM.MSGSZ
     10151**DCL     14103<<ASSIGN
KN$NETPARM.NHDR$
     10192**DCL     10193--REDEF   12182--IMP-PTR 12259--IMP-PTR 13655<<ASSIGN  13745<<ASSIGN  13795<<ASSIGN
     13956>>ASSIGN  13959<<ASSIGN  13972>>IF      13986>>IF      13987>>ASSIGN  13988>>ASSIGN  13989>>ASSIGN
     13990>>ASSIGN  13992>>ASSIGN  14036>>IF      14037>>ASSIGN  14042>>ASSIGN  14067>>ASSIGN  14068>>ASSIGN
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:287  
     14078>>ASSIGN  14078>>ASSIGN  14079>>IF      14107>>IF      14124>>ASSIGN  14191>>IF      14193>>ASSIGN
     14198>>ASSIGN  14211>>ASSIGN  14211>>ASSIGN  14238<<ASSIGN  14358<<ASSIGN
KN$NETPARM.NHDRSZ
     10198**DCL     13656<<ASSIGN  13746<<ASSIGN  13796<<ASSIGN  13957>>ASSIGN  13958<<ASSIGN  13991>>ASSIGN
     14041>>ASSIGN  14125>>ASSIGN  14194>>ASSIGN  14199>>ASSIGN  14239<<ASSIGN  14357<<ASSIGN
KN$NETPARM.NODE
     10235**DCL     13690<<ASSIGN  13990<<ASSIGN  14037<<ASSIGN  14175<<ASSIGN  14176>>ASSIGN
KN$NETPARM.RECTYPE
     10219**DCL     13934>>IF
KN$NETPARM.SHDR$
     10170**DCL     10171--REDEF   14193<<ASSIGN
KN$NETPARM.SHDRSZ
     10176**DCL     14105<<ASSIGN  14194<<ASSIGN
KN$NETPARM.SLDCT$
     10247**DCL     14240<<ASSIGN
KN$NETPARM.SRC_ADDR$
     10262**DCL     12888--IMP-PTR 13987<<ASSIGN  14040<<ASSIGN  14113<<ASSIGN
KN$NETPARM.THDR$
     10181**DCL     10182--REDEF   13956<<ASSIGN  14042<<ASSIGN  14124<<ASSIGN  14155<<ASSIGN  14198<<ASSIGN
KN$NETPARM.THDRSZ
     10187**DCL     13957<<ASSIGN  13991<<ASSIGN  14041<<ASSIGN  14106<<ASSIGN  14125<<ASSIGN  14129<<ASSIGN
     14141<<ASSIGN  14156<<ASSIGN  14199<<ASSIGN
KN$NETPARM.THDR_C$
     10182**DCL     13992<<ASSIGN
KN$NETPARM.UHDR$
     10156**DCL     10157--REDEF   13646>>IF
KN$NETPARM.UHDRSZ
     10165**DCL     14104<<ASSIGN
KN@NETPARM
     10976**DCL     14839<<ASSIGN  14842<>CALL
KN@NETPARM.FUNCTION
     11071**DCL     14841<<ASSIGN
KN@NETPARM.MSG$
     10983**DCL     10988--REDEF
KN@NETPARM.NHDR$
     11035**DCL     11036--REDEF
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:288  
KN@NETPARM.NODE
     11078**DCL     14840<<ASSIGN
KN@NETPARM.SHDR$
     11013**DCL     11014--REDEF
KN@NETPARM.THDR$
     11024**DCL     11025--REDEF
KN@NETPARM.UHDR$
     10999**DCL     11000--REDEF
KNB$WRITE
     11556**DCL-ENT 13841--CALL    14346--CALL    14822--CALL    14880--CALL    14953--CALL
KNH$SEND
     11555**DCL-ENT 13659--CALL    13750--CALL    13801--CALL    13936--CALL    14161--CALL    14241--CALL
     14360--CALL
KNH$UID.UID
     13001**DCL     13001--REDEF   13001--REDEF
KNH$UID.UIDX.CQ_HNDCTXID
     13002**DCL     13714>>ASSIGN
KNN$DECODE_NSAP
     11560**DCL-ENT 13653--CALL
KNN$LINK
     11642**DCL     13761<<ASSIGN
KNN$LINK.BLKCNT
     11887**DCL     14402<<ASSIGN  14402>>ASSIGN
KNN$LINK.CHAN#
     11876**DCL     13767<<ASSIGN  13839>>ASSIGN  14344>>ASSIGN  14879>>ASSIGN  14952>>ASSIGN
KNN$LINK.DEST.ADDRESS_N
     11829**DCL     11830--REDEF
KNN$LINK.FLAGS.BLOCKED
     11683**DCL     14417>>IF      14429<<ASSIGN  14482>>IF      14493<<ASSIGN
KNN$LINK.FLAGS.CLASS_A
     11678**DCL     14403>>IF      14471>>IF
KNN$LINK.FLAGS.HOST_NODE
     11674**DCL     13699>>IF      13766<<ASSIGN  13772>>ASSIGN
KNN$LINK.FLAGS.VIRCIR
     11687**DCL     13769<<ASSIGN  13823>>IF      14328>>IF      14403>>IF      14471>>IF
KNN$LINK.LADR.ADDRESS_N
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:289  
     11772**DCL     11773--REDEF
KNN$LINK.LDCT$
     11643**DCL     11650--REDEF   13678>>IF      13714>>ASSIGN  13738>>IF      13762<<ASSIGN  13781<<ASSIGN
     13805<<ASSIGN  14092>>IF      14098>>ASSIGN  14101>>ASSIGN  14246<<ASSIGN  14381<<ASSIGN
KNN$LINK.MSGS_IN
     11709**DCL     14167<<ASSIGN  14167>>ASSIGN  14205<<ASSIGN  14205>>ASSIGN
KNN$LINK.MSGS_OUT
     11718**DCL     14168<<ASSIGN  14168>>ASSIGN
KNN$LINK.NODE#
     11658**DCL     13765<<ASSIGN  13823>>IF      14417>>IF      14417>>IF      14417>>IF      14440>>IF
     14730>>IF      14819>>ASSIGN  14908>>ASSIGN  14914>>IF      14916>>IF      14916>>IF      14916>>IF
     14935>>IF
KNN$LINK.QOS
     11702**DCL     13764<<ASSIGN  13834>>ASSIGN  14308>>ASSIGN  14421>>IF      14422>>ASSIGN  14441>>ASSIGN
     14443>>ASSIGN  14443>>ASSIGN  14936>>ASSIGN  14937>>ASSIGN  14940>>ASSIGN  14940>>ASSIGN
KNN$LINK.SNPA
     11858**DCL     13768<<ASSIGN  13832>>ASSIGN  14309>>ASSIGN  14334>>IF      14334>>IF      14356<<ASSIGN
KNN$LINK.SNPA.LEN
     11860**DCL     13823>>IF      14339>>IF
KNN$LINK.UNBLKCNT
     11889**DCL     14470<<ASSIGN  14470>>ASSIGN
KNN$LINK$
     11568**DCL     13737>>ASSIGN  13945>>ASSIGN  14306>>ASSIGN  14334>>IF      14401>>ASSIGN  14417>>IF
     14417>>IF      14421>>IF      14422>>ASSIGN  14434>>ASSIGN  14441>>ASSIGN  14443>>ASSIGN  14469>>ASSIGN
     14729>>ASSIGN  14819>>ASSIGN  14831>>ASSIGN  14916>>IF      14929>>ASSIGN  14936>>ASSIGN  14937>>ASSIGN
     14940>>ASSIGN
KNN$OSIROUTE
     13021**DCL     14629<<ASSIGN
KNN$OSIROUTE.LINK.ACTIVE
     13193**DCL     14586>>IF      14600<<ASSIGN  14645<<ASSIGN  14851>>IF      14853<<ASSIGN  14988<<ASSIGN
     14999>>IF      15002<<ASSIGN  15027>>IF      15028<<ASSIGN
KNN$OSIROUTE.LINK.FEP#
     13198**DCL     14537>>IF      14552>>IF      14598<<ASSIGN  14643<<ASSIGN  14851>>IF      14855<<ASSIGN
     14987>>IF      15000<<ASSIGN  15027>>IF
KNN$OSIROUTE.LINK.HOST#
     13205**DCL     14537>>IF      14596<<ASSIGN  14635<<ASSIGN  14640<<ASSIGN
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:290  
KNN$OSIROUTE.LINK.QOS
     13209**DCL     14565<<ASSIGN  14599<<ASSIGN  14644<<ASSIGN  14854<<ASSIGN  14989<<ASSIGN  15001<<ASSIGN
     15029<<ASSIGN
KNN$OSIROUTE.LNSAP
     13133**DCL     14564<<ASSIGN  14595<<ASSIGN  14634<<ASSIGN  14639<<ASSIGN
KNN$OSIROUTE.LNSAP.ADDRESS_N
     13163**DCL     13164--REDEF
KNN$OSIROUTE.NSAP
     13043**DCL     14528--ASSIGN  14632<<ASSIGN
KNN$OSIROUTE.NSAP.ADDRESS_N
     13073**DCL     13074--REDEF
KNN$OSIROUTE.NSAP.AFI
     13050**DCL     14522>>IF      14541<<ASSIGN  14562<<ASSIGN  14620>>IF
KNN$OSIROUTE.NSAP.LEN
     13045**DCL     14522>>IF      14529>>ASSIGN
KNN$OSIROUTE.NS_TYPE
     13174**DCL     14522>>IF      14630<<ASSIGN  14978>>IF      15018>>IF
KNN$OSIROUTE.NW_TYPE
     13180**DCL     14631<<ASSIGN
KNN$OSIROUTE.SNPA
     13100**DCL     14549>>IF      14597<<ASSIGN  14636<<ASSIGN  14641<<ASSIGN
KNN$OSIROUTE.SNPA.ADDRESS
     13107**DCL     14979>>ASSIGN  15019>>ASSIGN
KNN$OSIROUTE.SNPA.LEN
     13102**DCL     14981>>DOINDEX 15021>>DOINDEX
KNN$OSIROUTE$
     13004**DCL     14520>>ASSIGN  14619>>ASSIGN  14849>>ASSIGN  14977>>ASSIGN  15017>>ASSIGN
KNN$RECV
         9**PROC    14366--ASSIGN
KNN$RECVOSI
     11561**DCL-ENT 13973--CALL
KNN$ROUTE.ALT_QOS
     11591**DCL     14833<<ASSIGN  14847<<ASSIGN
KNN$ROUTE.CTX$
     11577**DCL     14877>>IF
KNN$ROUTE.CURRENT_QOS
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:291  
     11588**DCL     14324>>IF      14431>>IF      14441<<ASSIGN  14443<<ASSIGN  14443>>ASSIGN  14714>>ASSIGN
     14810>>IF      14832<<ASSIGN  14846<<ASSIGN  14877>>IF      14926>>IF      14936<<ASSIGN  14940<<ASSIGN
     14940>>ASSIGN  14942>>ASSIGN
KNN$ROUTE.FLAGS.HOST_NODE
     11598**DCL     13682>>IF      13772<<ASSIGN  14126>>IF      14138>>IF      14737<<ASSIGN
KNN$ROUTE.FLAGS.LINK_CONNECTED
     11602**DCL     13682>>IF      13773<<ASSIGN  14126>>IF      14138>>IF      14325<<ASSIGN  14668>>IF
     14715>>IF      14715>>IF
KNN$ROUTE.LINK.ACTIVE
     11622**DCL     14417>>IF      14798>>IF      14892<<ASSIGN  14916>>IF      14946<<ASSIGN  14962<<ASSIGN
KNN$ROUTE.LINK.MSGS_IN
     11630**DCL     14164<<ASSIGN  14164>>ASSIGN  14204<<ASSIGN  14204>>ASSIGN  14893<<ASSIGN
KNN$ROUTE.LINK.MSGS_OUT
     11635**DCL     14165<<ASSIGN  14165>>ASSIGN  14894<<ASSIGN
KNN$ROUTE.LINK.QOS
     11627**DCL     14180<<ASSIGN  14734<<ASSIGN  14798>>IF      14803>>ASSIGN  14888<<ASSIGN  14890<<ASSIGN
     14937<<ASSIGN  14942<<ASSIGN  14945<<ASSIGN  14961<<ASSIGN
KNN$ROUTE.LINK#
     11583**DCL     14431>>IF      14433<<ASSIGN  14810>>IF      14830<<ASSIGN  14844<<ASSIGN  14914>>IF
     14926>>IF      14928<<ASSIGN
KNN$ROUTE.LINK$
     11571**DCL     13678>>IF      13678>>IF      13699>>IF      13714>>ASSIGN  14092>>IF      14092>>IF
     14098>>ASSIGN  14101>>ASSIGN  14167>>ASSIGN  14167>>ASSIGN  14168>>ASSIGN  14168>>ASSIGN  14178>>IF
     14434<<ASSIGN  14831<<ASSIGN  14837>>IF      14845<<ASSIGN  14929<<ASSIGN
KNN$ROUTE$
     11567**DCL     13677>>ASSIGN  13772>>ASSIGN  13773>>ASSIGN  14090>>ASSIGN  14126>>IF      14126>>IF
     14176>>ASSIGN  14203>>ASSIGN  14324>>IF      14325>>ASSIGN  14417>>IF      14431>>IF      14431>>IF
     14433>>ASSIGN  14434>>ASSIGN  14441>>ASSIGN  14443>>ASSIGN  14443>>ASSIGN  14668>>IF      14713>>ASSIGN
     14715>>IF      14733>>ASSIGN  14794>>ASSIGN  14877>>IF      14877>>IF      14888>>ASSIGN  14890>>ASSIGN
     14892>>ASSIGN  14893>>ASSIGN  14894>>ASSIGN  14914>>IF      14916>>IF      14926>>IF      14926>>IF
     14928>>ASSIGN  14929>>ASSIGN  14936>>ASSIGN  14937>>ASSIGN  14940>>ASSIGN  14940>>ASSIGN  14942>>ASSIGN
     14942>>ASSIGN  14945>>ASSIGN  14946>>ASSIGN  14961>>ASSIGN  14962>>ASSIGN
KNN$SENDOSI
     11562**DCL-ENT 14015--CALL    14052--CALL
KNN$SENDTERM_ACK
     11563**DCL-ENT 14364--CALL
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:292  
KNN_LINK$$
     11120**DCL     11568--IMP-PTR 13737>>ASSIGN  13945>>ASSIGN  14306>>ASSIGN  14334>>IF      14401>>ASSIGN
     14417>>IF      14417>>IF      14421>>IF      14422>>ASSIGN  14434>>ASSIGN  14441>>ASSIGN  14443>>ASSIGN
     14469>>ASSIGN  14729>>ASSIGN  14819>>ASSIGN  14831>>ASSIGN  14916>>IF      14929>>ASSIGN  14936>>ASSIGN
     14937>>ASSIGN  14940>>ASSIGN
KNN_LINKS
     11122**DCL     13736>>DOINDEX 14333>>DOINDEX 14416>>DOINDEX 14551>>DOINDEX 14585>>DOINDEX 14728>>DOINDEX
     14797>>DOINDEX 14850>>DOINDEX 14915>>DOINDEX 14986>>DOINDEX 14998>>DOINDEX 15026>>DOINDEX
KNN_LOCK
     11138**DCL     13644<>CALL    13665<>CALL    13756<>CALL    13787<>CALL    13811<>CALL    13849<>CALL
     13865<>CALL    13877<>CALL    13886<>CALL    13900<>CALL    13909<>CALL    14280<>CALL    14297<>CALL
     14320<>CALL    14372<>CALL    14387<>CALL    14398<>CALL    14410<>CALL    14456<>CALL    14466<>CALL
     14478<>CALL    14488<>CALL    14499<>CALL    14559<>CALL    14571<>CALL    14593<>CALL    14606<>CALL
     14627<>CALL    14651<>CALL    14725<>CALL    14749<>CALL    14759<>CALL
KNN_NODES
     11121**DCL     13673>>IF      14069>>IF      14069>>IF      14430>>DOINDEX 14707>>IF      14707>>IF
     14790>>DOINDEX 14886>>DOINDEX 14925>>DOINDEX 14960>>DOINDEX
KNN_OSIMAX#
     11125**DCL     14519>>DOINDEX 14618>>DOINDEX 14848>>DOINDEX 14976>>DOINDEX 15016>>DOINDEX
KNN_OSIROUTE$$
     11123**DCL     13004--IMP-PTR 14520>>ASSIGN  14619>>ASSIGN  14849>>ASSIGN  14977>>ASSIGN  15017>>ASSIGN
KNN_ROUTE$$
     11119**DCL     11567--IMP-PTR 13677>>ASSIGN  13772>>ASSIGN  13773>>ASSIGN  14090>>ASSIGN  14126>>IF
     14126>>IF      14176>>ASSIGN  14203>>ASSIGN  14324>>IF      14325>>ASSIGN  14417>>IF      14431>>IF
     14431>>IF      14433>>ASSIGN  14434>>ASSIGN  14441>>ASSIGN  14443>>ASSIGN  14443>>ASSIGN  14668>>IF
     14713>>ASSIGN  14715>>IF      14733>>ASSIGN  14794>>ASSIGN  14877>>IF      14877>>IF      14888>>ASSIGN
     14890>>ASSIGN  14892>>ASSIGN  14893>>ASSIGN  14894>>ASSIGN  14914>>IF      14916>>IF      14926>>IF
     14926>>IF      14928>>ASSIGN  14929>>ASSIGN  14936>>ASSIGN  14937>>ASSIGN  14940>>ASSIGN  14940>>ASSIGN
     14942>>ASSIGN  14942>>ASSIGN  14945>>ASSIGN  14946>>ASSIGN  14961>>ASSIGN  14962>>ASSIGN
KNS$RECV
     11553**DCL-ENT 14195--CALL
KNT$RECV
     11554**DCL-ENT 14200--CALL    14842--CALL
KNT$RECV_4HOST
     11558**DCL-ENT 13691--CALL    13871--CALL    13894--CALL    13961--CALL    14140--CALL    14291--CALL
KNT$SEND_4HOST
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:293  
     11559**DCL-ENT 14003--CALL    14043--CALL    14128--CALL
KN_NETPARM_INIT
     11158**DCL     14350>>ASSIGN  14839>>ASSIGN
KN_NETPARM_INIT.MSG$
     11165**DCL     11170--REDEF
KN_NETPARM_INIT.NHDR$
     11217**DCL     11218--REDEF
KN_NETPARM_INIT.SHDR$
     11195**DCL     11196--REDEF
KN_NETPARM_INIT.THDR$
     11206**DCL     11207--REDEF
KN_NETPARM_INIT.UHDR$
     11181**DCL     11182--REDEF
KN_NODE#
     11118**DCL     13669>>IF      13833>>ASSIGN  13840>>ASSIGN  14088>>IF      14203>>ASSIGN  14338>>ASSIGN
     14345>>ASSIGN  14820>>ASSIGN  14837>>IF
KN_SCREECH
     11549**DCL     14071>>IF
KN_SCREECH_HOPCOUNT
     11548**DCL     14081>>IF
L
     10320**DCL     14526<<ASSIGN  14850<<DOINDEX 14851>>IF      14851>>IF      14853>>ASSIGN  14854>>ASSIGN
     14855>>ASSIGN
LEN
     10322**DCL     14529<<ASSIGN  14530>>IF      14530>>IF
LINK#
     10313**DCL     13736<<DOINDEX 13737>>ASSIGN  13776>>ASSIGN  13943<<ASSIGN  13944>>ASSIGN  13945>>ASSIGN
     14098<<ASSIGN  14165>>ASSIGN  14165>>ASSIGN  14180>>ASSIGN  14204>>ASSIGN  14204>>ASSIGN  14307<<ASSIGN
     14334>>IF      14400<<ASSIGN  14401>>ASSIGN  14417>>IF      14431>>IF      14468<<ASSIGN  14469>>ASSIGN
     14728<<DOINDEX 14729>>ASSIGN  14734>>ASSIGN  14888>>ASSIGN  14890>>ASSIGN  14892>>ASSIGN  14893>>ASSIGN
     14894>>ASSIGN  14914>>IF      14916>>IF      14926>>IF      14945>>ASSIGN  14946>>ASSIGN  14961>>ASSIGN
     14962>>ASSIGN
LINK$
     10312**DCL     11642--IMP-PTR 13737<<ASSIGN  13738>>IF      13761>>ASSIGN  13762>>ASSIGN  13764>>ASSIGN
     13765>>ASSIGN  13766>>ASSIGN  13767>>ASSIGN  13768>>ASSIGN  13769>>ASSIGN  13772>>ASSIGN  13781>>ASSIGN
     13805>>ASSIGN  13823>>IF      13823>>IF      13823>>IF      13832>>ASSIGN  13834>>ASSIGN  13839>>ASSIGN
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:294  
     13945<<ASSIGN  14205>>ASSIGN  14205>>ASSIGN  14246>>ASSIGN  14306<<ASSIGN  14308>>ASSIGN  14309>>ASSIGN
     14328>>IF      14334>>IF      14339>>IF      14344>>ASSIGN  14356>>ASSIGN  14381>>ASSIGN  14401<<ASSIGN
     14402>>ASSIGN  14402>>ASSIGN  14403>>IF      14403>>IF      14417>>IF      14417>>IF      14429>>ASSIGN
     14440>>IF      14443>>ASSIGN  14469<<ASSIGN  14470>>ASSIGN  14470>>ASSIGN  14471>>IF      14471>>IF
     14482>>IF      14493>>ASSIGN  14729<<ASSIGN  14730>>IF      14879>>ASSIGN  14908>>ASSIGN  14914>>IF
     14916>>IF      14916>>IF      14935>>IF      14940>>ASSIGN  14952>>ASSIGN
LINKIN#
     10314**DCL     13944<<ASSIGN  14164>>ASSIGN  14164>>ASSIGN
LINK_ACTIVE
     14865**PROC    13779--CALL
LINK_DOWN
     14904**PROC    13804--CALL    14313--CALL
NETPARM IN PROCEDURE BLDOSIHDR
     15053**DCL     15038--PROC
NETPARM.MSG$ IN PROCEDURE BLDOSIHDR
     15060**DCL     15065--REDEF
NETPARM.NHDR$ IN PROCEDURE BLDOSIHDR
     15112**DCL     15113--REDEF
NETPARM.SHDR$ IN PROCEDURE BLDOSIHDR
     15090**DCL     15091--REDEF
NETPARM.THDR$ IN PROCEDURE BLDOSIHDR
     15101**DCL     15102--REDEF
NETPARM.UHDR$ IN PROCEDURE BLDOSIHDR
     15076**DCL     15077--REDEF
NWHDR_SZ
     10330**DCL     14123<<ASSIGN  14124>>ASSIGN  14125>>ASSIGN  14189<<ASSIGN  14193>>ASSIGN  14194>>ASSIGN
     14198>>ASSIGN  14199>>ASSIGN
NXTI
     14525**LABEL   14531--EXIT    14547--EXIT    14550--EXIT
NXTJ2 IN PROCEDURE OSILINK_UP
     15000**LABEL   14983--GOTO    14991--GOTO    15003--GOTO
NXTJ3 IN PROCEDURE OSILINK_DOWN
     15028**LABEL   15023--GOTO
OSI$
     10325**DCL     13021--IMP-PTR 14520<<ASSIGN  14522>>IF      14522>>IF      14522>>IF      14528>>ASSIGN
     14529>>ASSIGN  14537>>IF      14537>>IF      14541>>ASSIGN  14549>>IF      14552>>IF      14562>>ASSIGN
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:295  
     14564>>ASSIGN  14565>>ASSIGN  14586>>IF      14595>>ASSIGN  14596>>ASSIGN  14597>>ASSIGN  14598>>ASSIGN
     14599>>ASSIGN  14600>>ASSIGN  14619<<ASSIGN  14620>>IF      14629>>ASSIGN  14630>>ASSIGN  14631>>ASSIGN
     14632>>ASSIGN  14634>>ASSIGN  14635>>ASSIGN  14636>>ASSIGN  14639>>ASSIGN  14640>>ASSIGN  14641>>ASSIGN
     14643>>ASSIGN  14644>>ASSIGN  14645>>ASSIGN  14849<<ASSIGN  14851>>IF      14851>>IF      14853>>ASSIGN
     14854>>ASSIGN  14855>>ASSIGN  14977<<ASSIGN  14978>>IF      14979>>ASSIGN  14981>>DOINDEX 14987>>IF
     14988>>ASSIGN  14989>>ASSIGN  14999>>IF      15000>>ASSIGN  15001>>ASSIGN  15002>>ASSIGN  15017<<ASSIGN
     15018>>IF      15019>>ASSIGN  15021>>DOINDEX 15027>>IF      15027>>IF      15028>>ASSIGN  15029>>ASSIGN
OSILINKCHG
     10778**DCL     13841--CALL    13841--CALL    14346--CALL    14346--CALL
OSILINKCHG.FCN
     10789**DCL     13836<<ASSIGN  14341<<ASSIGN
OSILINKCHG.MYNODE#
     10809**DCL     13840<<ASSIGN  14345<<ASSIGN
OSILINKCHG.QOS
     10813**DCL     13838<<ASSIGN  14343<<ASSIGN
OSILINKCHG.SNPA
     10839**DCL     13837<<ASSIGN  14342<<ASSIGN
OSILINKCHG.TERMID.TERM
     10870**DCL     10879--REDEF
OSILINKCHG.TERMID.TERM.CHANNEL
     10876**DCL     13839<<ASSIGN  14344<<ASSIGN
OSILINK_DOWN
     15013**PROC    14340--CALL    14677--CALL
OSILINK_UP
     14974**PROC    13835--CALL    14679--CALL
OSIROUTE$
     10326**DCL     13560--IMP-PTR 14528<<ASSIGN  14530>>IF
PRTCLERR
     11329**DCL     13868<>CALL    13953<>CALL    14072<>CALL    14082<>CALL
QOS
     10317**DCL     13763<<ASSIGN  13764>>ASSIGN  13834<<ASSIGN  13838>>ASSIGN  14308<<ASSIGN  14343>>ASSIGN
     14673<<ASSIGN  14714<<ASSIGN  14732<<ASSIGN  14732>>ASSIGN  14734>>ASSIGN  14871>>ASSIGN  14888>>ASSIGN
     14989>>ASSIGN  15001>>ASSIGN
QQQ$
     10327**DCL     13994<<ASSIGN  14005>>ASSIGN  14008>>ASSIGN  14016>>ASSIGN  14019>>ASSIGN  14051<<ASSIGN
     14053>>ASSIGN  14056>>ASSIGN  14099<<ASSIGN  14134>>ASSIGN  14146>>ASSIGN  14163>>ASSIGN  14209>>ASSIGN
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:296  
     14282<<ASSIGN  14351>>ASSIGN
RECEIVE_DATA
     13934**LABEL   13606--GOTO
RESTORE_QQQ
     14205**LABEL   14132--GOTO    14144--GOTO    14161--CALLALT
ROUTE
     10569**DCL     13653<>CALL
ROUTE.FEP#
     10609**DCL     13669>>IF      13672>>ASSIGN  13673>>IF
ROUTE.HOST#
     10606**DCL     13670>>ASSIGN
ROUTE.LNSAP.ADDRESS_N
     10723**DCL     10724--REDEF
ROUTE.MYNODE#
     10604**DCL     10606--REDEF
ROUTE.NODE#
     10607**DCL     10609--REDEF
ROUTE.NSAP.ADDRESS_N
     10667**DCL     10668--REDEF
ROUTE.QOS
     10612**DCL     13673>>IF
ROUTE$
     10311**DCL     11570--IMP-PTR 13677<<ASSIGN  13678>>IF      13678>>IF      13682>>IF      13682>>IF
     13699>>IF      13714>>ASSIGN  14090<<ASSIGN  14092>>IF      14092>>IF      14098>>ASSIGN  14101>>ASSIGN
     14138>>IF      14138>>IF      14164>>ASSIGN  14164>>ASSIGN  14165>>ASSIGN  14165>>ASSIGN  14167>>ASSIGN
     14167>>ASSIGN  14168>>ASSIGN  14168>>ASSIGN  14176<<ASSIGN  14178>>IF      14180>>ASSIGN  14203<<ASSIGN
     14204>>ASSIGN  14204>>ASSIGN  14713<<ASSIGN  14714>>ASSIGN  14715>>IF      14733<<ASSIGN  14734>>ASSIGN
     14737>>ASSIGN  14794<<ASSIGN  14798>>IF      14798>>IF      14803>>ASSIGN  14810>>IF      14810>>IF
     14830>>ASSIGN  14831>>ASSIGN  14832>>ASSIGN  14833>>ASSIGN  14837>>IF      14844>>ASSIGN  14845>>ASSIGN
     14846>>ASSIGN  14847>>ASSIGN
SCREECH
     11557**DCL-ENT 13609--CALL    13868--CALL    13953--CALL    14072--CALL    14082--CALL    14505--CALL
SENDESH
     15195**PROC    13820--CALL
SIZE
     10323**DCL     12976--IMP-SIZ 14530>>IF      14530>>IF
PL6.E3A0      #002=KNN$RECV File=KNN$NETWORK.:E05TSI                             WED 07/30/97 01:05 Page:297  
SNPA
     10900**DCL     13832<<ASSIGN  13837>>ASSIGN  14309<<ASSIGN  14342>>ASSIGN  14672<<ASSIGN
SNPA.ADDRESS
     10909**DCL     14980>>ASSIGN  15020>>ASSIGN
SNPA.LEN
     10904**DCL     14981>>DOINDEX 15021>>DOINDEX
SNPATMPLT1
     10334**DCL     10335--REDEF   14979<<ASSIGN  15019<<ASSIGN
SNPATMPLT2.NIBBLES.NIB
     10337**DCL     14982>>IF      15022>>IF
SNPATMPLT3
     10339**DCL     10340--REDEF   14980<<ASSIGN  15020<<ASSIGN
SNPATMPLT4.NIBBLES.NIB
     10342**DCL     14982>>IF      15022>>IF
SOURCE_NODE
     10329**DCL     14068<<ASSIGN  14069>>IF      14126>>IF      14126>>IF      14175>>ASSIGN
SRC.ADDRESS_N
     12920**DCL     12921--REDEF
SVLINK IN PROCEDURE UPDATE_ROUTE
     14786**DCL     14791<<ASSIGN  14804<<ASSIGN  14810>>IF      14818>>IF      14819>>ASSIGN  14828>>IF
     14830>>ASSIGN  14831>>ASSIGN
UPDATE_ROUTE
     14784**PROC    14181--CALL    14742--CALL    14897--CALL    14965--CALL
UPDOSI
     10360**DCL     10569--REDEF
UPDOSI.LNSAP.ADDRESS_N
     10514**DCL     10515--REDEF
UPDOSI.MYNODE#
     10395**DCL     10397--REDEF
UPDOSI.NODE#
     10398**DCL     10400--REDEF
UPDOSI.NSAP.ADDRESS_N
     10458**DCL     10459--REDEF
UPDOSI$
     10324**DCL     13555--IMP-PTR 14527<<ASSIGN  14530>>IF

PL6.E3A0      #003=KNN$SENDTERM_ACK File=KNN$NETWORK.:E05TSI                     WED 07/30/97 01:07 Page:298  
     1905        1        /*T***********************************************************/
     1906        2        /*T*                                                         */
     1907        3        /*T* Copyright (c) Bull HN Information Systems Inc., 1997    */
     1908        4        /*T*                                                         */
     1909        5        /*T***********************************************************/
     1910        6        KNN$SENDTERM_ACK: PROC(ARG);
     1911        7
     1912        8        %INCLUDE GH_SCHD_M;
     1913      152        %INCLUDE GH_GATE_M;
     1914      193        %INCLUDE KNH_MACRO_C;
     1915      476        %INCLUDE KN_DATA_M;
     1916     2262        %INCLUDE K_ADDRESS_M;
     1917     2765        %INCLUDE KNN_NETWORK_M;
     1918     3128
     1919     3129    1   DCL ARG UBIN(16);
     1920     3130    1   DCL LDCT$ PTR;
     1921     3131    1   DCL CTYPE UBIN;
     1922     3132    1   DCL KNH$SEND ENTRY(1) ALTRET;
     1923     3133    1   DCL KNA$RLSLDCT ENTRY(1) ALTRET;
     1924     3134    1   DCL GHS$SET_TMR ENTRY(1);
     1925     3135
     1926     3136        %GH$TMR_BLK(FPTN=KNN$TMRBLK,STCLASS=STATIC);
     1927     3159
     1928     3160        %FPT_TERM_ACK(FPTN=FPT@TERM_ACK,STCLASS=CONSTANT);
     1929     3182
     1930     3183        %KN$NETPARM(NAME=KN_NETPARM_INIT,STCLASS=SYMREF);
     1931     3336        %KN$NETPARM(NAME=KN@NETPARM,STCLASS=AUTO);
     1932     3489
     1933     3490        %GATE(FPTN=KNN_LOCK,STCLASS=SYMREF);
     1934     3509
     1935     3510    1   DCL KN_DCT$$ PTR SYMREF;
     1936     3511    1   DCL KN$LDCT$(0:0) PTR BASED(KN_DCT$$);
     1937     3512        %KN$LDCT(NAME=KN$LDCT,STCLASS="BASED(LDCT$)");
     1938     3757
     1939     3758    1   DCL KNN_LINK$$ PTR SYMREF;
     1940     3759    1   DCL KNN$LINK$(0:0) PTR BASED(KNN_LINK$$);
     1941     3760    1   DCL LINK$ PTR;
PL6.E3A0      #003=KNN$SENDTERM_ACK File=KNN$NETWORK.:E05TSI                     WED 07/30/97 01:07 Page:299  
     1942     3761        %KNN$LINK(STCLASS="BASED(LINK$)");
     1943     4012
     1944     4013    1   DCL ENTSWITCH BIT(1);
     1945     4014
     1946     4015    1      ENTSWITCH = '1'B;
     1947     4016    1      GOTO SKIPLOCK;
     1948     4017
     1949     4018    1   KNN$SENDTERM_ACK_DFR: ENTRY(ARG);
     1950     4019           %LOCK(G=KNN_LOCK);
     1951     4026    1      ENTSWITCH = '0'B;
     1952     4027    1   SKIPLOCK:;
     1953     4028    1      LDCT$ = KN$LDCT$(ARG);
     1954     4029    1      CTYPE = KN$LDCT.CONN_TYPE;
     1955     4030    1      IF ENTSWITCH THEN GOTO JUSTDEFER;
     1956     4031    1      KN@NETPARM = KN_NETPARM_INIT;
     1957     4032    1      KN@NETPARM.LDCT$ = LDCT$;
     1958     4033    1      KN@NETPARM.FPT$ = ADDR(FPT@TERM_ACK);
     1959     4034    1      KN@NETPARM.FUNCTION = %KN_FCN_TERM_ACK;
     1960     4035    1      KN@NETPARM.NHDR$ = ADDR(NIL);
     1961     4036    1      KN@NETPARM.NHDRSZ = 0;
     1962     4037    2      CALL KNH$SEND(KN@NETPARM) WHENALTRETURN DO;
     1963     4038    2   JUSTDEFER:;
     1964     4039    2           KNN$TMRBLK.PROC$ = ENTADDR(KNN$SENDTERM_ACK_DFR);
     1965     4040    2           KNN$TMRBLK.ARG = KN$LDCT.LDCTX;
     1966     4041    2           KNN$TMRBLK.INTERVAL = 15*5;     /*5 SECONDS                           */
     1967     4042    2           CALL GHS$SET_TMR(KNN$TMRBLK);
     1968     4043    2           IF ENTSWITCH THEN RETURN;
     1969     4044                %UNLOCK(G=KNN_LOCK);
     1970     4051    2           RETURN;
     1971     4052    2           END;
     1972     4053    2      IF CTYPE ~= %KN_CNTYPE_CIRCUIT THEN DO;
     1973     4054    2           LINK$ = KNN$LINK$(KN$LDCT.LINK_ID);
     1974     4055    2           KNN$LINK.LDCT$ = ADDR(NIL);
     1975     4056    2           END;
     1976     4057           %UNLOCK(G=KNN_LOCK);
     1977     4064    1      RETURN;
     1978     4065    1   END KNN$SENDTERM_ACK;
PL6.E3A0      #003=KNN$SENDTERM_ACK File=KNN$NETWORK.:E05TSI                     WED 07/30/97 01:07 Page:300  

PL6.E3A0      #003=KNN$SENDTERM_ACK File=KNN$NETWORK.:E05TSI                     WED 07/30/97 01:07 Page:301  
--  Include file information  --

   KNN_NETWORK_M.:E05TOU  is referenced.
   K_ADDRESS_M.:E05TOU  is referenced.
   KN_DATA_M.:E05TOU  is referenced.
   KNH_MACRO_C.:E05TOU  is referenced.
   GH_GATE_M.:E05TOU  cannot be made into a system file and is referenced.
   GH_SCHD_M.:E05TOU  is referenced.
      No diagnostics issued in procedure KNN$SENDTERM_ACK.

   Procedure KNN$SENDTERM_ACK requires 158 words for executable code.
   Procedure KNN$SENDTERM_ACK requires 48 words of local(AUTO) storage.

    No errors detected in file KNN$NETWORK.:E05TSI    .

PL6.E3A0      #003=KNN$SENDTERM_ACK File=KNN$NETWORK.:E05TSI                     WED 07/30/97 01:07 Page:302  

 Object Unit name= KNN$SENDTERM_ACK                           File name= KNN$NETWORK.:E05TOU
 UTS= JUL 30 '97 01:07:54.72 WED                              Compiler= PL-6/E31         Sev=      00
 SharedLib= :SHARED_LCP6_SYSTEM                               Alt SharedLib=


    ****  Control sections  ****

 Sect   Type Bound  Init  Size HexSiz  Section name
    0   Data  even  none    10      A  KNN$SENDTERM_ACK
    1  RoData even  UTS      2      2  KNN$SENDTERM_ACK
    2   Proc  even  none   158     9E  KNN$SENDTERM_ACK
    3  RoData even  none     4      4  KNN$SENDTERM_ACK

    ****  Entry defs  ****

                              Check   Calling
                             calling  sequence
  Sect HexLoc Primary Altret sequence   type   Parms  Name
     2      0   yes            yes      Std        1  KNN$SENDTERM_ACK
     2      A                  yes      Std        1  KNN$SENDTERM_ACK_DFR

  ****  Entry refs  ****

         Check        Calling
        calling       sequence
Altret sequence SRef   type   Args  Name
 yes     yes           Std       1 GHH$LOCK
 yes     yes           Std       1 KNH$SEND
 yes     yes           Std       1 GHH$UNLOCK
         yes           Std       1 GHS$SET_TMR
         yes           Std       1 KNN$SENDTERM_ACK_DFR
                       nStd      0 X6A_AUTO_1
                       nStd      0 X6A_ARET
PL6.E3A0      #003=KNN$SENDTERM_ACK File=KNN$NETWORK.:E05TSI                     WED 07/30/97 01:07 Page:303  

  ****  Data refs  ****

  Flags:  r = read only, s = secondary
Flgs Name                             Flgs Name                             Flgs Name
     KN_NETPARM_INIT                       KNN_LOCK                              KN_DCT$$
     KNN_LINK$$                       r    G$ROS$
PL6.E3A0      #003=KNN$SENDTERM_ACK File=KNN$NETWORK.:E05TSI                     WED 07/30/97 01:07 Page:304  


     1905        1        /*T***********************************************************/
     1906        2        /*T*                                                         */
     1907        3        /*T* Copyright (c) Bull HN Information Systems Inc., 1997    */
     1908        4        /*T*                                                         */
     1909        5        /*T***********************************************************/
     1910        6        KNN$SENDTERM_ACK: PROC(ARG);

      6   2 000000  D380 0000 0000  xent KNN$SENDTERM_ACKLNJ,B5   X6A_AUTO_1
          2 000003       0030 0001                       DC       48,1

     1911        7
     1912        8        %INCLUDE GH_SCHD_M;
     1913      152        %INCLUDE GH_GATE_M;
     1914      193        %INCLUDE KNH_MACRO_C;
     1915      476        %INCLUDE KN_DATA_M;
     1916     2262        %INCLUDE K_ADDRESS_M;
     1917     2765        %INCLUDE KNN_NETWORK_M;
     1918     3128
     1919     3129    1   DCL ARG UBIN(16);
     1920     3130    1   DCL LDCT$ PTR;
     1921     3131    1   DCL CTYPE UBIN;
     1922     3132    1   DCL KNH$SEND ENTRY(1) ALTRET;
     1923     3133    1   DCL KNA$RLSLDCT ENTRY(1) ALTRET;
     1924     3134    1   DCL GHS$SET_TMR ENTRY(1);
     1925     3135
     1926     3136        %GH$TMR_BLK(FPTN=KNN$TMRBLK,STCLASS=STATIC);
     1927     3159
     1928     3160        %FPT_TERM_ACK(FPTN=FPT@TERM_ACK,STCLASS=CONSTANT);
     1929     3182
     1930     3183        %KN$NETPARM(NAME=KN_NETPARM_INIT,STCLASS=SYMREF);
     1931     3336        %KN$NETPARM(NAME=KN@NETPARM,STCLASS=AUTO);
     1932     3489
     1933     3490        %GATE(FPTN=KNN_LOCK,STCLASS=SYMREF);
     1934     3509
     1935     3510    1   DCL KN_DCT$$ PTR SYMREF;
     1936     3511    1   DCL KN$LDCT$(0:0) PTR BASED(KN_DCT$$);
PL6.E3A0      #003=KNN$SENDTERM_ACK File=KNN$NETWORK.:E05TSI                     WED 07/30/97 01:07 Page:305  
     1937     3512        %KN$LDCT(NAME=KN$LDCT,STCLASS="BASED(LDCT$)");
     1938     3757
     1939     3758    1   DCL KNN_LINK$$ PTR SYMREF;
     1940     3759    1   DCL KNN$LINK$(0:0) PTR BASED(KNN_LINK$$);
     1941     3760    1   DCL LINK$ PTR;
     1942     3761        %KNN$LINK(STCLASS="BASED(LINK$)");
     1943     4012
     1944     4013    1   DCL ENTSWITCH BIT(1);
     1945     4014
     1946     4015    1      ENTSWITCH = '1'B;

   4015   2 000005  8947 002C                            LBT,'8000'X       ENTSWITCH,AUTO
   4015   2 000007       8000

     1947     4016    1      GOTO SKIPLOCK;

   4016   2 000008  0F81 0011                            B        s:4026,PREL

     1948     4017
     1949     4018    1   KNN$SENDTERM_ACK_DFR: ENTRY(ARG);

   4018   2 00000A  D380 0000 0000  xent KNN$SENDTERM_AC*LNJ,B5   X6A_AUTO_1
          2 00000D       0030 0001                       DC       48,1

     1950     4019           %LOCK(G=KNN_LOCK);

   4024   2 00000F  BB80 0000 0000  03                   LAB,B3   0
          2 000012  CBF0 0100                            LAB,B4   256,IMO
          2 000014  E380 0000 0000  xent                 LNJ,B6   GHH$LOCK
          2 000017       0001                            DC       s:4026,PREL

     1951     4026    1      ENTSWITCH = '0'B;

   4026   2 000018  8747 002C                            CL       ENTSWITCH,AUTO

   4026   2                              SKIPLOCK        null
     1952     4027    1   SKIPLOCK:;
PL6.E3A0      #003=KNN$SENDTERM_ACK File=KNN$NETWORK.:E05TSI                     WED 07/30/97 01:07 Page:306  
     1953     4028    1      LDCT$ = KN$LDCT$(ARG);

   4028   2 00001A  ECC7 0004            SKIPLOCK        LDB,B6   @ARG,AUTO
          2 00001C  B806                                 LDR,R3   ,B6
          2 00001D  DC80 0000 0000  xsym                 LDB,B5   KN_DCT$$
          2 000020  CCB5                                 LDB,B4   ,B5,R3
          2 000021  CFC7 0006                            STB,B4   LDCT$,AUTO

     1954     4029    1      CTYPE = KN$LDCT.CONN_TYPE;

   4029   2 000023  E284                                 LLH,R6   ,B4
          2 000024  EF47 0008                            STR,R6   CTYPE,AUTO

     1955     4030    1      IF ENTSWITCH THEN GOTO JUSTDEFER;

   4030   2 000026  89C7 002C                            CMZ      ENTSWITCH,AUTO
          2 000028  0801 002A                            BAL      s:4037,PREL

     1956     4031    1      KN@NETPARM = KN_NETPARM_INIT;

   4031   2 00002A  AB80 0000 0000  xsym                 LAB,B2   KN_NETPARM_INIT
          2 00002D  2C00                                 LDV,R2   0
          2 00002E  6C42                                 LDV,R6   66
          2 00002F  BB87                                 LAB,B3   ,AUTO
          2 000030  3C12                                 LDV,R3   18
          2 000031  0008                                 MMM

     1957     4032    1      KN@NETPARM.LDCT$ = LDCT$;

   4032   2 000032  DCC7 0006                            LDB,B5   LDCT$,AUTO
          2 000034  DFC7 0009                            STB,B5   KN@NETPARM,AUTO

     1958     4033    1      KN@NETPARM.FPT$ = ADDR(FPT@TERM_ACK);

   4033   2 000036  CB80 0000 0000  01                   LAB,B4   FPT@TERM_ACK
          2 000039  CFC7 0022                            STB,B4   KN@NETPARM+25,AUTO

PL6.E3A0      #003=KNN$SENDTERM_ACK File=KNN$NETWORK.:E05TSI                     WED 07/30/97 01:07 Page:307  
     1959     4034    1      KN@NETPARM.FUNCTION = %KN_FCN_TERM_ACK;

   4034   2 00003B  6C04                                 LDV,R6   4
          2 00003C  EF47 001D                            STR,R6   KN@NETPARM+20,AUTO

     1960     4035    1      KN@NETPARM.NHDR$ = ADDR(NIL);

   4035   2 00003E  AB80 0000 0000                       LAB,B2   0
          2 000041  AFC7 0017                            STB,B2   KN@NETPARM+14,AUTO

     1961     4036    1      KN@NETPARM.NHDRSZ = 0;

   4036   2 000043  8747 0019                            CL       KN@NETPARM+16,AUTO

     1962     4037    2      CALL KNH$SEND(KN@NETPARM) WHENALTRETURN DO;

   4037   2 000045  9BC7 0009                            LAB,B1   KN@NETPARM,AUTO
          2 000047  9FC7 002E                            STB,B1   ENTSWITCH+2,AUTO
          2 000049  BBC7 002E                            LAB,B3   ENTSWITCH+2,AUTO
          2 00004B  CBF0 0100                            LAB,B4   256,IMO
          2 00004D  E380 0000 0000  xent                 LNJ,B6   KNH$SEND
          2 000050       0003                            DC       s:4037,PREL
          2 000051  0F81 002D                            B        s:4053,PREL

   4037   2                              JUSTDEFER       null
     1963     4038    2   JUSTDEFER:;
     1964     4039    2           KNN$TMRBLK.PROC$ = ENTADDR(KNN$SENDTERM_ACK_DFR);

   4039   2 000053  EBC0 FFB6            JUSTDEFER       LAB,B6   s:4018,PREL
          2 000055  EF80 0000 0000  00                   STB,B6   KNN$TMRBLK

     1965     4040    2           KNN$TMRBLK.ARG = KN$LDCT.LDCTX;

   4040   2 000058  DCC7 0006                            LDB,B5   LDCT$,AUTO
          2 00005A  E845 0007                            LDR,R6   7,B5
          2 00005C  EF00 0000 0002  00                   STR,R6   KNN$TMRBLK+2

PL6.E3A0      #003=KNN$SENDTERM_ACK File=KNN$NETWORK.:E05TSI                     WED 07/30/97 01:07 Page:308  
     1966     4041    2           KNN$TMRBLK.INTERVAL = 15*5;     /*5 SECONDS                           */

   4041   2 00005F  5C4B                                 LDV,R5   75
          2 000060  DF00 0000 0003  00                   STR,R5   KNN$TMRBLK+3

     1967     4042    2           CALL GHS$SET_TMR(KNN$TMRBLK);

   4042   2 000063  BB80 0000 0002  03                   LAB,B3   +2
          2 000066  CBF0 0100                            LAB,B4   256,IMO
          2 000068  E380 0000 0000  xent                 LNJ,B6   GHS$SET_TMR
          2 00006B       0001                            DC       s:4043,PREL

     1968     4043    2           IF ENTSWITCH THEN RETURN;

   4043   2 00006C  89C7 002C                            CMZ      ENTSWITCH,AUTO
          2 00006E  0881 0004                            BAGE     s:4049,PREL

   4043   2 000070  C380 0000 0000  xent                 LNJ,B4   X6A_ARET

     1969     4044                %UNLOCK(G=KNN_LOCK);

   4049   2 000073  BB80 0000 0000  03                   LAB,B3   0
          2 000076  CBF0 0100                            LAB,B4   256,IMO
          2 000078  E380 0000 0000  xent                 LNJ,B6   GHH$UNLOCK
          2 00007B       0001                            DC       s:4051,PREL

     1970     4051    2           RETURN;

   4051   2 00007C  C380 0000 0000  xent                 LNJ,B4   X6A_ARET

     1971     4052    2           END;
     1972     4053    2      IF CTYPE ~= %KN_CNTYPE_CIRCUIT THEN DO;

   4053   2 00007F  E847 0008                            LDR,R6   CTYPE,AUTO
          2 000081  6D07                                 CMV,R6   7
          2 000082  0901 000F                            BE       s:4062,PREL

PL6.E3A0      #003=KNN$SENDTERM_ACK File=KNN$NETWORK.:E05TSI                     WED 07/30/97 01:07 Page:309  
     1973     4054    2           LINK$ = KNN$LINK$(KN$LDCT.LINK_ID);

   4054   2 000084  ECC7 0006                            LDB,B6   LDCT$,AUTO
          2 000086  B846 0003                            LDR,R3   3,B6
          2 000088  DC80 0000 0000  xsym                 LDB,B5   KNN_LINK$$
          2 00008B  CCB5                                 LDB,B4   ,B5,R3
          2 00008C  CFC7 002A                            STB,B4   LINK$,AUTO

     1974     4055    2           KNN$LINK.LDCT$ = ADDR(NIL);

   4055   2 00008E  BB80 0000 0000                       LAB,B3   0
          2 000091  BF84                                 STB,B3   ,B4

     1975     4056    2           END;

     1976     4057           %UNLOCK(G=KNN_LOCK);

   4062   2 000092  BB80 0000 0000  03                   LAB,B3   0
          2 000095  CBF0 0100                            LAB,B4   256,IMO
          2 000097  E380 0000 0000  xent                 LNJ,B6   GHH$UNLOCK
          2 00009A       0001                            DC       s:4064,PREL

     1977     4064    1      RETURN;

   4064   2 00009B  C380 0000 0000  xent                 LNJ,B4   X6A_ARET
     1978     4065    1   END KNN$SENDTERM_ACK;

PL6.E3A0      #003=KNN$SENDTERM_ACK File=KNN$NETWORK.:E05TSI                     WED 07/30/97 01:07 Page:310  
--  Include file information  --

   KNN_NETWORK_M.:E05TOU  is referenced.
   K_ADDRESS_M.:E05TOU  is referenced.
   KN_DATA_M.:E05TOU  is referenced.
   KNH_MACRO_C.:E05TOU  is referenced.
   GH_GATE_M.:E05TOU  cannot be made into a system file and is referenced.
   GH_SCHD_M.:E05TOU  is referenced.
      No diagnostics issued in procedure KNN$SENDTERM_ACK.
PL6.E3A0      #003=KNN$SENDTERM_ACK File=KNN$NETWORK.:E05TSI                     WED 07/30/97 01:07 Page:311  

 **** Variables and constants ****

  ****  Section 000  Data  KNN$SENDTERM_ACK

  ****  Scalars and arrays  ****
HexLoc.c.b A Datatyp(siz) R M Lvl/name                 HexLoc.c.b A Datatyp(siz) R M Lvl/name

     0-0-0/w STRC(160)   r     1 KNN$TMRBLK

  ****  Section 001 RoData KNN$SENDTERM_ACK

  ****  Scalars and arrays  ****
HexLoc.c.b A Datatyp(siz) R M Lvl/name                 HexLoc.c.b A Datatyp(siz) R M Lvl/name

     0-0-0/w STRC(32)    r     1 FPT@TERM_ACK

  ****  Auto variables  ****

  ****  Scalars and arrays  ****
HexLoc.c.b A Datatyp(siz) R M Lvl/name                 HexLoc.c.b A Datatyp(siz) R M Lvl/name

     4-0-0/w PTR         r     1 @ARG                      *0-0-0/w UBIN(16)    r     1 ARG
     8-0-0/w UBIN(16)    r     1 CTYPE                     2C-0-0/b BIT         r     1 ENTSWITCH
     9-0-0/w STRC(528)   r     1 KN@NETPARM                 6-0-0/w PTR         r     1 LDCT$
    2A-0-0/w PTR         r     1 LINK$

  ****  SYMREF variables  ****

  ****  Scalars and arrays  ****
HexLoc.c.b A Datatyp(siz) R M Lvl/name                 HexLoc.c.b A Datatyp(siz) R M Lvl/name

     0-0-0/w PTR         r     1 KNN_LINK$$                 0-0-0/w STRC(48)    r     1 KNN_LOCK
     0-0-0/w PTR         r     1 KN_DCT$$                   0-0-0/w STRC(528)   r     1 KN_NETPARM_INIT

  ****  BASED and DCB variables  ****

  ****  Scalars and arrays  ****
PL6.E3A0      #003=KNN$SENDTERM_ACK File=KNN$NETWORK.:E05TSI                     WED 07/30/97 01:07 Page:312  
HexLoc.c.b A Datatyp(siz) R M Lvl/name                 HexLoc.c.b A Datatyp(siz) R M Lvl/name

     0-0-0/w STRC(256)   r     1 KN$LDCT
     0-0-0/w PTR         r     1 KN$LDCT$(0:0)
     0-0-0/c STRC(608)   r     1 KNN$LINK
     0-0-0/w PTR         r     1 KNN$LINK$(0:0)


   Procedure KNN$SENDTERM_ACK requires 158 words for executable code.
   Procedure KNN$SENDTERM_ACK requires 48 words of local(AUTO) storage.

    No errors detected in file KNN$NETWORK.:E05TSI    .
PL6.E3A0      #003=KNN$SENDTERM_ACK File=KNN$NETWORK.:E05TSI                     WED 07/30/97 01:07 Page:313  
          *** CROSS REFERENCE LISTING ***
**     DENOTES     IDENTIFIER DEFINITION
<<                 IDENTIFIER'S VALUE SET
>>                 IDENTIFIER'S VALUE USED
<>                 IDENTIFIER SET AND/OR USED
--                 IDENTIFIER REFERENCED
PL6.E3A0      #003=KNN$SENDTERM_ACK File=KNN$NETWORK.:E05TSI                     WED 07/30/97 01:07 Page:314  
          MINI XREF LISTING

ARG
      3129**DCL         6--PROC     4018--ENTRY    4028>>ASSIGN
CTYPE
      3131**DCL      4029<<ASSIGN   4053>>IF
ENTSWITCH
      4013**DCL      4015<<ASSIGN   4026<<ASSIGN   4030>>IF       4043>>IF
FPT@TERM_ACK
      3176**DCL      4033--ASSIGN
GHH$LOCK
       192**DCL-ENT  4024--CALL
GHH$UNLOCK
       192**DCL-ENT  4049--CALL     4062--CALL
GHS$SET_TMR
      3134**DCL-ENT  4042--CALL
JUSTDEFER
      4037**LABEL    4030--GOTO
KN$LDCT.CONN_TYPE
      3528**DCL      4029>>ASSIGN
KN$LDCT.LDCTX
      3669**DCL      4040>>ASSIGN
KN$LDCT.LINK_ID
      3630**DCL      4054>>ASSIGN
KN$LDCT.RLCID.LDCTX
      3588**DCL      3595--REDEF    3603--REDEF
KN$LDCT.TRANSPORT_ID
      3622**DCL      3630--REDEF
KN$LDCT.UID
      3652**DCL      3653--REDEF    3662--REDEF
KN$LDCT$
      3511**DCL      4028>>ASSIGN
KN@NETPARM
      3349**DCL      4031<<ASSIGN   4037<>CALL
PL6.E3A0      #003=KNN$SENDTERM_ACK File=KNN$NETWORK.:E05TSI                     WED 07/30/97 01:07 Page:315  
KN@NETPARM.FPT$
      3468**DCL      4033<<ASSIGN
KN@NETPARM.FUNCTION
      3444**DCL      4034<<ASSIGN
KN@NETPARM.LDCT$
      3350**DCL      4032<<ASSIGN
KN@NETPARM.MSG$
      3356**DCL      3361--REDEF
KN@NETPARM.NHDR$
      3408**DCL      3409--REDEF    4035<<ASSIGN
KN@NETPARM.NHDRSZ
      3414**DCL      4036<<ASSIGN
KN@NETPARM.SHDR$
      3386**DCL      3387--REDEF
KN@NETPARM.THDR$
      3397**DCL      3398--REDEF
KN@NETPARM.UHDR$
      3372**DCL      3373--REDEF
KNH$SEND
      3132**DCL-ENT  4037--CALL
KNN$LINK.DEST.ADDRESS_N
      3949**DCL      3950--REDEF
KNN$LINK.LADR.ADDRESS_N
      3892**DCL      3893--REDEF
KNN$LINK.LDCT$
      3763**DCL      3770--REDEF    4055<<ASSIGN
KNN$LINK$
      3759**DCL      4054>>ASSIGN
KNN$SENDTERM_ACK_DFR
      4018**ENTRY    4039--ASSIGN
KNN$TMRBLK
      3150**DCL      4042<>CALL
KNN$TMRBLK.ARG
      3154**DCL      3155--REDEF    4040<<ASSIGN
KNN$TMRBLK.INTERVAL
      3155**DCL      4041<<ASSIGN
PL6.E3A0      #003=KNN$SENDTERM_ACK File=KNN$NETWORK.:E05TSI                     WED 07/30/97 01:07 Page:316  
KNN$TMRBLK.PROC$
      3154**DCL      4039<<ASSIGN
KNN_LINK$$
      3758**DCL      3759--IMP-PTR  4054>>ASSIGN
KNN_LOCK
      3502**DCL      4024<>CALL     4049<>CALL     4062<>CALL
KN_DCT$$
      3510**DCL      3511--IMP-PTR  4028>>ASSIGN
KN_NETPARM_INIT
      3196**DCL      4031>>ASSIGN
KN_NETPARM_INIT.MSG$
      3203**DCL      3208--REDEF
KN_NETPARM_INIT.NHDR$
      3255**DCL      3256--REDEF
KN_NETPARM_INIT.SHDR$
      3233**DCL      3234--REDEF
KN_NETPARM_INIT.THDR$
      3244**DCL      3245--REDEF
KN_NETPARM_INIT.UHDR$
      3219**DCL      3220--REDEF
LDCT$
      3130**DCL      3527--IMP-PTR  4028<<ASSIGN   4029>>ASSIGN   4032>>ASSIGN   4040>>ASSIGN   4054>>ASSIGN
LINK$
      3760**DCL      3762--IMP-PTR  4054<<ASSIGN   4055>>ASSIGN
SKIPLOCK
      4026**LABEL    4016--GOTO
