VERSION E05

PL6.E3A0      #001=KNA$OPEN File=KNA$APE.:E05TSI                                 WED 07/30/97 00:55 Page:1    
        1        1        /*M* KNA$APE - Application Presentation Engine */
        2        2        /*T***********************************************************/
        3        3        /*T*                                                         */
        4        4        /*T* Copyright (c) Bull HN Information Systems Inc., 1997    */
        5        5        /*T*                                                         */
        6        6        /*T***********************************************************/
        7        7        /*X* PLM=3,IND=5,ENU=0,ECU=0 */
        8        8        /*P*
        9        9           NAME: KNA$APE
       10       10           PURPOSE:
       11       11                  This module translates user application requests into the
       12       12             proper Presentation layer communications protocols.
       13       13           DESCRIPTION:
       14       14                  This module contains the routines necessary to field an
       15       15             application's M$s READ, WRITE, OPEN, CLOSE on a DCB associated
       16       16             with another endpoint in the network.
       17       17        */
       18       18        /*F*
       19       19           NAME: KNA$OPEN
       20       20           PURPOSE:
       21       21                  To handle the open of a DCB connected to another program via
       22       22             the communications network.
       23       23           DESCRIPTION:
       24       24                  This routine does a validity check of the M$OPEN and sets up
       25       25             context associated with the user's DCB.  A call is made to the
       26       26             monitor's Session layer to establish contact with the proper
       27       27             endpoint for this DCB.
       28       28         */
       29       29        %EJECT;
PL6.E3A0      #001=KNA$OPEN File=KNA$APE.:E05TSI                                 WED 07/30/97 00:55 Page:2    
       30       30        /*D*
       31       31           NAME: KNA$OPEN
       32       32           CALL:
       33       33                  CALL KNA$OPEN(DCBNUMBER,ERROR) ALTRET;
       34       34
       35       35                  Altreturns if an error is encountered during OPEN.
       36       36           PARAMETERS:
       37       37                  DCBNUMBER - The DCB number of the DCB to be opened.
       38       38                  ERROR - Error code returned if an error is encountered.
       39       39           INTERFACE:
       40       40                  KNA$GETLDCT - To get an LDCT for establishing a Session
       41       41                  KNA$RLSLDCT - Release an LDCT
       42       42                  KNS$SESSION - To establish a Session over the network
       43       43                  GHS$REG - To REG the current user until Session replies
       44       44                  KNA$GETSSN - To get an APE Session context
       45       45                  KNA$RLSSSN - Release an APE Session context
       46       46           ENVIRONMENT:
       47       47                  This routine is called from GFM$MCL with the DCBNUMBER set
       48       48             up and the OPEN FPT parameters already merged into the DCB.
       49       49           INPUT:
       50       50                  G$ROS
       51       51                     DCB table information
       52       52                     Network addresses for this user
       53       53           OUTPUT:
       54       54                  None.
       55       55           DESCRIPTION:
       56       56                  This routine finds the address of the DCB number passed and
       57       57             checks for any conflicts in the DCB parameters set.  If none, the
       58       58             resource information in the DCB is used to access an associated
       59       59             network address kept in the ROSeg.  If an APE context for this
       60       60             network address is not already established one is made and
       61       61             initialized.  If we already have at least one other DCB connected
       62       62             to the desired endpoint we just intialize some flags in the DCB,
       63       63             mark it OPENed, point it to the APE context and return to the user.
       64       64             After the APE context is initialized an LDCT for Session is also
       65       65             allocated and APE makes a call to Session to establish the network
       66       66             connection.  The user is REGged Queued for Access while we await
PL6.E3A0      #001=KNA$OPEN File=KNA$APE.:E05TSI                                 WED 07/30/97 00:55 Page:3    
       67       67             a Session reply.  When Session replies positively an OPEN message
       68       68             is sent to the other end.
       69       69        */
       70       70        %EJECT;
PL6.E3A0      #001=KNA$OPEN File=KNA$APE.:E05TSI                                 WED 07/30/97 00:55 Page:4    
       71       71
       72       72        KNA$OPEN: PROC (DCBNUMBER,ERROR,LGN_,VLP_WINDOW) ALTRET;
       73       73
       74       74        %INCLUDE F_ERRORS_C;
       75      314        %INCLUDE G_LCP6_E;
       76      572        %INCLUDE KNA_MACRO_M;
       77      648        %INCLUDE GH_GATE_M;
       78      689        %INCLUDE KN_DATA_M;
       79     2475        %INCLUDE KNH_MACRO_C;
       80     2758        %INCLUDE GU_LCP6_M;
       81     3686        %INCLUDE KN_ERRORS_C;
       82     3750        %INCLUDE KI_ERRORS_C;
       83     3835        %INCLUDE GH_LCP6_M;
       84     4669        %INCLUDE G_ROS_M;
       85     4751        %INCLUDE G_JIT_M;
       86     5016        %INCLUDE GH_SCHD_E;
       87     5112        %INCLUDE KL_MACRO_C;
       88     8464        %INCLUDE GF_LCP6_M;
       89     8932        %INCLUDE KL_SUPER_C;
       90    11834        %INCLUDE KL_AFCN_C;
       91    11935        %INCLUDE KI_CP6;
       92    13031        %INCLUDE K$RWPARM;
       93    13417        %INCLUDE KV$VDO;
       94    14432        %INCLUDE KV_GLBCNS_E;
       95    14773        %INCLUDE K_SCODE_C;
       96    14858        %KV#VD_ORG_E;
       97    14866        %KV_VDO_ALL_E;
       98    14945
       99    14946        /* Parameter definitions */
      100    14947    1   DCL DCBNUMBER UBIN;
      101    14948        %VLP_ERRCODE (STCLASS="",FPTN=ERROR);
      102    14994    1   DCL LGN_ VECTOR;
      103    14995        %VLP_WINDOW (STCLASS=PARAM);
      104    15039
      105    15040        /* Entry defintions */
      106    15041    1   DCL KNA$GETLDCT ENTRY(1) ALTRET;
      107    15042    1   DCL KNA$RLSLDCT ENTRY(1) ALTRET;
PL6.E3A0      #001=KNA$OPEN File=KNA$APE.:E05TSI                                 WED 07/30/97 00:55 Page:5    
      108    15043    1   DCL KNS$SEND ENTRY(1) ALTRET;
      109    15044    1   DCL KNA$BUILD_VDO ENTRY(3);
      110    15045    1   DCL KNA$CONV_STR ENTRY(2) ALTRET;
      111    15046    1   DCL KNA$GETSSN ENTRY(1) ALTRET;
      112    15047    1   DCL KNA$RLSSSN ENTRY(1) ALTRET;
      113    15048    1   DCL KNA$RLSIOP ENTRY(1) ALTRET;
      114    15049    1   DCL KNA$GETIOP ENTRY(1) ALTRET;
      115    15050    1   DCL KNA$IN ENTRY(1) ALTRET;
      116    15051    1   DCL SCREECH ENTRY(1);
      117    15052    1   DCL KNA$REG_USER ENTRY(2) ALTRET;
      118    15053    1   DCL KNB$GETRESP ENTRY(4) ALTRET;
      119    15054    1   DCL KNA$FCNOU ENTRY(4) ALTRET;
      120    15055
      121    15056        /* Auto */
      122    15057        %K$RWPARM (NAME=RWPARM,STCLASS=AUTO);
      123    15373        %KV$VDO_CLSSTR (NAME=HDR,STCLASS=AUTO);
      124    15416        %KN$NETPARM;
      125    15569        %FPT_CONNECT(STCLASS=AUTO);
      126    15638        %FPT_TERM;
      127    15660    1   DCL CLOSING BIT(1);
      128    15661    1   DCL NEWSTREAM BIT(1);
      129    15662    1   DCL UCSTREAM BIT(1);
      130    15663    1   DCL I SBIN;
      131    15664    1   DCL ERR UBIN(32);
      132    15665    1   DCL IOP$ PTR;
      133    15666    1   DCL STRM UBIN;
      134    15667    1   DCL DCB$ PTR;
      135    15668    1   DCL SSN$ PTR;
      136    15669    1   DCL TEMP$ PTR;
      137    15670    1   DCL OPNDCB$ PTR;
      138    15671    1   DCL RESTYPE CHAR(2);
      139    15672    1   DCL 1 NETWORK_ADDR ALIGNED,
      140    15673    1         2 NODE#  UBIN(8) CALIGNED,
      141    15674    1         2 GENERATION UBIN(8) CALIGNED,
      142    15675    1         2 LDCTX  UBIN CALIGNED;
      143    15676        %KL_SGN (FPTN=SGN,STCLASS=AUTO,LGNSIZ=70);
      144    15769        %KL_SGNRSP (FPTN=SGNRSP,STCLASS="REDEF SGN",RSPSIZ=68);
PL6.E3A0      #001=KNA$OPEN File=KNA$APE.:E05TSI                                 WED 07/30/97 00:55 Page:6    
      145    15905        %VLP_WINDOW (FPTN=WINDOW,STCLASS=AUTO);
      146    15949        %EJECT;
PL6.E3A0      #001=KNA$OPEN File=KNA$APE.:E05TSI                                 WED 07/30/97 00:55 Page:7    
      147    15950        /* Based structures */
      148    15951        %KN$LDCT(STCLASS="BASED(KN$NETPARM.LDCT$)");
      149    16196        %G$ROS (FPTN=G$ROS,STCLASS="BASED(G$ROS$)");
      150    16240        %G$JIT (STCLASS="BASED(G$JIT$)");
      151    16654        %G$JIT_E;
      152    16716        %M$DCB (DCBN=MYDCB,STCLASS="BASED(DCB$)");
      153    16767        %KNA$SSN (STCLASS="BASED(SSN$)");
      154    16850        %KN$IOP (STCLASS=BASED);
      155    17023        %G$DCBTABLE;
      156    17034
      157    17035        /* Pointer references */
      158    17036    1   DCL G$JIT$ PTR SYMREF READONLY;
      159    17037    1   DCL G$ROS$ PTR SYMREF READONLY;
      160    17038
      161    17039        /* Error codes */
      162    17040        %VLP_ERRCODE (FPTN=ENO_IOP, ERR#=%E$NO_IOP,
      163    17041                     STCLASS=CONSTANT, FCG=KN, MID=A, MON='1'B, SEV=G_SEV_ERROR#);
      164    17087        %VLP_ERRCODE (FPTN=ENOLDCT, ERR#=%E$NOLDCT,
      165    17088                     STCLASS=CONSTANT, FCG=KN, MID=A, MON='1'B, SEV=G_SEV_ERROR#);
      166    17134        %VLP_ERRCODE (FPTN=ENOTCTX, ERR#=%E$NOTCTX,
      167    17135                     STCLASS=CONSTANT, FCG=KN, MID=A, MON='1'B, SEV=G_SEV_ERROR#);
      168    17181        %VLP_ERRCODE (FPTN=ENORTE, ERR#=%E$NORTE,
      169    17182                     STCLASS=CONSTANT, FCG=KN, MID=A, MON='1'B, SEV=G_SEV_ERROR#);
      170    17228        %VLP_ERRCODE (FPTN=EBAD_DCB_RES, ERR#=%E$INVRES,
      171    17229                     STCLASS=CONSTANT, FCG=KN, MID=A, MON='1'B, SEV=G_SEV_ERROR#);
      172    17275        %VLP_ERRCODE (FPTN=EBAD_ORG, ERR#=%E$BAD_ORG,
      173    17276                     STCLASS=CONSTANT, FCG=KN, MID=A, MON='1'B, SEV=G_SEV_ERROR#);
      174    17322        %VLP_ERRCODE (FPTN=ENET_ADDR, ERR#=%E$NET_ADDR,
      175    17323                     STCLASS=CONSTANT, FCG=KN, MID=A, MON='1'B, SEV=G_SEV_ERROR#);
      176    17369        %VLP_ERRCODE (FPTN=EAPE_SSN, ERR#=%E$APE_SSN,
      177    17370                     STCLASS=CONSTANT, FCG=KN, MID=A, MON='1'B, SEV=G_SEV_ERROR#);
      178    17416        %VLP_ERRCODE (FPTN=EDCB_CLOSED, ERR#=%E$DCBCLOSED,
      179    17417                     STCLASS=CONSTANT, FCG=KN, MID=A, MON='1'B, SEV=G_SEV_ERROR#);
      180    17463        %VLP_ERRCODE (FPTN=EDCB_OPEN, ERR#=%E$DCBOPEN,
      181    17464                     STCLASS=CONSTANT, FCG=KN, MID=A, MON='1'B, SEV=G_SEV_ERROR#);
      182    17510        %VLP_ERRCODE (FPTN=ERR_ORGNOTCOM, ERR#=%E$ORGNOTCOM,
      183    17511                     STCLASS=CONSTANT, FCG=KN, MID=A, MON='1'B, SEV=G_SEV_ERROR#);
PL6.E3A0      #001=KNA$OPEN File=KNA$APE.:E05TSI                                 WED 07/30/97 00:55 Page:8    
      184    17557
      185    17558        %VLP_SCODE (FPTN=SCR_UNEXP,FCG=KN,MID=A,ERR#=%S$UNEXPRESP,
      186    17559                       MON='1'B,SEV=G_SEV_SCREECH#,STCLASS=CONSTANT);
      187    17620        /*S* SCREECH_CODE: KNA-S$UNEXPRESP
      188    17621             TYPE: SCREECH
      189    17622             MESSAGE: Unexpected respone from lower layers.
      190    17623             REMARKS: The session layer returned something we did not expect.
      191    17624         */
      192    17625
      193    17626        /* Symrefs */
      194    17627        %K$RWPARM (NAME=KNA_RWPARM_CON,STCLASS=SYMREF);
      195    17943        %GATE (FPTN=KNA_LNKSSN,STCLASS=SYMREF);
      196    17962        %VLP_WINDOW (FPTN=KNA_WINDOW,STCLASS=SYMREF);
      197    18006        %KN$NETPARM (NAME=KN_NETPARM_INIT,STCLASS=SYMREF);
      198    18159    1   DCL KNA_WINDOW_TL CHAR(2) SYMREF;
      199    18160    1   DCL KN_NODE# UBIN SYMREF;
      200    18161
      201    18162        /* Constants */
      202    18163    1   DCL NUMBERS CHAR(0) CONSTANT INIT('0123456789');
      203    18164    1   DCL LGNSTR CHAR(SGN.LOGON.LGNSIZ) BASED;
      204    18165        %EJECT;
PL6.E3A0      #001=KNA$OPEN File=KNA$APE.:E05TSI                                 WED 07/30/97 00:55 Page:9    
      205    18166        /*   Get the address of the DCB by indexing into the ROSeg tables and
      206    18167        check DCB parameters.  The only thing to check right now is for a
      207    18168        valid resource of 'HOnn' or 'MEnn'.
      208    18169        */
      209    18170
      210    18171    1      DCB$ = G$ROS.DCBPTR$ -> G$DCBTABLE(DCBNUMBER);
      211    18172
      212    18173    1      IF MYDCB.FCD
      213    18174    2      THEN DO;
      214    18175    2           ERROR = EDCB_OPEN;
      215    18176    2           ALTRETURN;
      216    18177    2           END;
      217    18178        /*E* ERROR: KNA-E$DCBOPEN
      218    18179             MESSAGE: That DCB is already open.
      219    18180        */
      220    18181
      221    18182    1      RESTYPE = SUBSTR(MYDCB.RES,0,2);
      222    18183    1      CALL INDEX(I,' ',MYDCB.RES);
      223    18184    1      IF I = 0 OR I = 1 OR I = 3 OR (I = 4 AND RESTYPE ~= 'UC')
      224    18185    1        OR (I = 2 AND SUBSTR(MYDCB.RES,2,2) ~= '  ')
      225    18186    2      THEN DO;
      226    18187    2   BADRES: ;
      227    18188    2           ERROR = EBAD_DCB_RES;
      228    18189    2           ALTRETURN;
      229    18190    2           END;
      230    18191    1      IF I = 4
      231    18192    2      THEN DO;
      232    18193    2           CALL INDEX(I,SUBSTR(MYDCB.RES,2,1),NUMBERS) ALTRET (BADRES);
      233    18194    2           CALL INDEX(I,SUBSTR(MYDCB.RES,3,1),NUMBERS) ALTRET (BADRES);
      234    18195    2           CALL CHARBIN(STRM,SUBSTR(MYDCB.RES,2,2));
      235    18196    2           END;
      236    18197    1      ELSE
      237    18198    1           STRM = 1;
      238    18199
      239    18200    1      UCSTREAM = '0'B;
      240    18201    1      NEWSTREAM = '1'B;
      241    18202        /*N* DCBS - More validation of parameters and support of further ORGs
PL6.E3A0      #001=KNA$OPEN File=KNA$APE.:E05TSI                                 WED 07/30/97 00:55 Page:10   
      242    18203        must be done here.
      243    18204        */
      244    18205
      245    18206        %EJECT;
PL6.E3A0      #001=KNA$OPEN File=KNA$APE.:E05TSI                                 WED 07/30/97 00:55 Page:11   
      246    18207    2      DO SELECT(RESTYPE);
      247    18208    2           SELECT ('HO');
      248    18209    2           DCB$->MYDCB.DDEV.RES = %G_DDEV_RES_HO#;
      249    18210    2           IF DCB$->MYDCB.RLCID ~= '0'B
      250    18211    2           THEN NETWORK_ADDR = DCB$->MYDCB.RLCID;
      251    18212    2           ELSE NETWORK_ADDR = G$ROS.DCBPTR$->G$DCBTABLE(%G_M$LM#)->MYDCB.RLCID;
      252    18213    2           SELECT ('LG');
      253    18214    2           DCB$->MYDCB.DDEV.RES = %G_DDEV_RES_LG#;
      254    18215    2           IF ADDR(LGN_) = ADDR(NIL)
      255    18216    3           THEN DO;
      256    18217    3                ERROR = EBAD_DCB_RES;
      257    18218    3                ALTRETURN;
      258    18219    3                END;
      259    18220    2           SGN = '0'B;
      260    18221    2           SGN.FCN = IGA_SGN;
      261    18222    2           SGN.TERMINAL_ID.TTYP = %KLTY_PROG#;
      262    18223    2           SGN.TERMINAL_ID.TERMID = G$JIT.UNAME;
      263    18224    2           SGN.USER.SYSID = G$JIT.SYSID;
      264    18225    2           SGN.NMID = G$JIT.USR#;
      265    18226    2           SGN.LOGON.LGNSIZ = VBOUND(LGN_) + 1;
      266    18227    2           SGN.LOGON.LGNTXT = VBASE(LGN_)->LGNSTR;
      267    18228    2           SGN.NODE = KN_NODE#;
      268    18229    2           SGN.TERMINAL_ID.TERM.CHANNEL = G$JIT.SYSID;
      269    18230
      270    18231    2           SELECT ('UC');
      271    18232    2           IF MYDCB.ORG = %G_ORG_SE#
      272    18233    3           THEN DO;
      273    18234    3                ERROR = EBAD_ORG;
      274    18235    3                ALTRETURN;
      275    18236    3                END;
      276    18237        /*E* ERROR: KNA-E$BAD_ORG-E
      277    18238             MESSAGE:ORG = SE is not available to FPRGs.
      278    18239        */
      279    18240
      280    18241    2           I = G$ROS.NUMDCBS;
      281    18242    3           DO WHILE (I>=0);
      282    18243    3                IF DCBADDR(I) ~= ADDR(NIL)
PL6.E3A0      #001=KNA$OPEN File=KNA$APE.:E05TSI                                 WED 07/30/97 00:55 Page:12   
      283    18244    3                THEN IF DCBADDR(I)->MYDCB.FCD AND DCBADDR(I)->MYDCB.STRM = STRM
      284    18245    3                       AND SUBSTR(DCBADDR(I)->MYDCB.RES,0,2) = 'UC'
      285    18246    4                     THEN DO;
      286    18247    4                          NEWSTREAM = '0'B;
      287    18248    5                          DO CASE (MYDCB.ORG);
      288    18249
      289    18250    5                           CASE (%G_ORG_FORM#,%G_ORG_SE#);
      290    18251    5                             IF MYDCB.ORG ~= DCBADDR(I)->MYDCB.ORG
      291    18252    5                             THEN GOTO SET_BAD_ORG;
      292    18253
      293    18254    5                           CASE (ELSE);
      294    18255    5                             IF DCBADDR(I)->MYDCB.ORG = %G_ORG_SE# OR
      295    18256    5                               DCBADDR(I)->MYDCB.ORG = %G_ORG_FORM#
      296    18257    6                             THEN DO;
      297    18258    6   SET_BAD_ORG:                   ;
      298    18259    6                                  ERROR = ERR_ORGNOTCOM;
      299    18260    6                                  ALTRETURN;
      300    18261    6                                  END;
      301    18262    5                             END/*do case*/;
      302    18263    4                          END/*do if same uc stream*/;
      303    18264    3                I = I - 1;
      304    18265    3                END/*do while*/;
      305    18266
      306    18267        /*E* ERROR: KNA-%E$ORGNOTCOM-C
      307    18268             MESSAGE: The ORG is not compatible.
      308    18269             MESSAGE1: Another DCB is already open to the same stream as the one
      309    18270                       you are opening, but one has ORG=FORM and one does not.
      310    18271        */
      311    18272
      312    18273    2           DCB$->MYDCB.DDEV.RES = %G_DDEV_RES_UC#;
      313    18274    2           NETWORK_ADDR = G$ROS.DCBPTR$->G$DCBTABLE(%G_M$ME#)->MYDCB.RLCID;
      314    18275    2           UCSTREAM = '1'B;
      315    18276
      316    18277    2           SELECT ('NA');
      317    18278    2           DCB$->MYDCB.DDEV.RES = %G_DDEV_RES_NA#;
      318    18279    2           NETWORK_ADDR = '0'B;
      319    18280    2           NETWORK_ADDR.NODE# = KN_NODE#;
PL6.E3A0      #001=KNA$OPEN File=KNA$APE.:E05TSI                                 WED 07/30/97 00:55 Page:13   
      320    18281
      321    18282    2           SELECT (ELSE);
      322    18283        /*E*     ERROR: KNA-E$INVRES
      323    18284                 MESSAGE: An invalid resource expressed on OPEN
      324    18285        */
      325    18286
      326    18287    2      ERROR = EBAD_DCB_RES;
      327    18288    2      ALTRETURN;
      328    18289    2           END;
      329    18290
      330    18291    1      IF NETWORK_ADDR.LDCTX = 0 AND RESTYPE ~= 'NA' AND RESTYPE ~= 'LG'
      331    18292    2      THEN DO;
      332    18293
      333    18294
      334    18295    2           ERROR = ENET_ADDR;
      335    18296    2           ALTRETURN;
      336    18297    2           END;
      337    18298        /*E*     ERROR: KNA-E$NET_ADDR
      338    18299                 MESSAGE: No network address has been specified for this resource.
      339    18300        */
      340    18301        %EJECT;
PL6.E3A0      #001=KNA$OPEN File=KNA$APE.:E05TSI                                 WED 07/30/97 00:55 Page:14   
      341    18302        /*
      342    18303             It looks like it is perfectly valid to open this DCB for user
      343    18304        I/O now.  We must check to see if there already is an APE network
      344    18305        connection to the specified network address.  If so, then this DCB
      345    18306        can just be marked OPENed and we can return.  If such a network
      346    18307        connection doesn't exist we'll create it by setting up a Session.
      347    18308             The means we use to find out if there is such a network connection
      348    18309        already is to scan the DCB table for a DCB which is going to the same
      349    18310        place as this one.  If so, we're done.
      350    18311        */
      351    18312
      352    18313        /*N* OPEN - We should probably speed up the recognition of an already
      353    18314        existent network connection by having a pointer in the user's JIT to
      354    18315        APE SSN contexts linked together.  We'll probably need it for other
      355    18316        things anyway.
      356    18317        */
      357    18318
      358    18319    1      OPNDCB$ = ADDR(NIL);
      359    18320
      360    18321    1      IF RESTYPE ~= 'LG'
      361    18322    2      THEN DO;
      362    18323    2   FINDOPNDCB:
      363    18324    3           DO I = 1 TO G$ROS.NUMDCBS;
      364    18325    3                TEMP$ = G$ROS.DCBPTR$ -> G$DCBTABLE(I);
      365    18326
      366    18327    3                IF TEMP$ ~= ADDR(NIL)
      367    18328    3                THEN IF TEMP$ -> MYDCB.FCD = '1'B
      368    18329    3                     THEN IF SUBSTR(TEMP$ -> MYDCB.RES,0,LENGTHC(RESTYPE)) = RESTYPE
             18329                              AND
      369    18330    3                            TEMP$->MYDCB.RLCID = NETWORK_ADDR
      370    18331    4                          THEN DO;
      371    18332    4                               OPNDCB$ = TEMP$;
      372    18333    4                               EXIT FINDOPNDCB;
      373    18334    4                               END;
      374    18335
      375    18336    3                END FINDOPNDCB;            /* DO I = 1 TO G$ROS.NUMDCBS          */
      376    18337    2           END/*do if restype~=LG */;
PL6.E3A0      #001=KNA$OPEN File=KNA$APE.:E05TSI                                 WED 07/30/97 00:55 Page:15   
      377    18338        %EJECT;
PL6.E3A0      #001=KNA$OPEN File=KNA$APE.:E05TSI                                 WED 07/30/97 00:55 Page:16   
      378    18339        /* If a DCB was found which meets the requirements for this DCB's OPEN.
      379    18340        All we have to do is fetch the SSN$ address and increment the OPEN DCB
      380    18341        counter.
      381    18342        */
      382    18343
      383    18344    1      IF OPNDCB$ ~= ADDR(NIL)
      384    18345    2      THEN DO;
      385    18346    2           SSN$ = OPNDCB$ -> MYDCB.SSN$;
      386    18347    2           KNA$SSN.NUMDCBS = KNA$SSN.NUMDCBS+1;
      387    18348    2           END;
      388    18349
      389    18350        /*
      390    18351             We don't already have a SSN context for this network connection.
      391    18352        Now we have to make one so we must get some context blocks and establish
      392    18353        the connection with Session.
      393    18354        */
      394    18355    2      ELSE DO;
      395    18356    2           CALL KNA$GETSSN (SSN$)
      396    18357    3           WHENALTRETURN DO;
      397    18358
      398    18359        /*E*     ERROR: KNA-E$APE_SSN
      399    18360                 MESSAGE: Unable to establish a network Session for this DCB
      400    18361        */
      401    18362
      402    18363    3                ERROR = EAPE_SSN;
      403    18364    3                ALTRETURN;
      404    18365    3                END;
      405    18366
      406    18367    2           KNA$SSN = '0'B;
      407    18368    2           IF DCBNUMBER = %G_M$LM# OR DCBNUMBER = %G_M$ME#
      408    18369    2           THEN
      409    18370    2                KNA$SSN.FLAGS.PRIMARY = '1'B;
      410    18371    2           KNA$SSN.IOPQ$ = ADDR(NIL);
      411    18372    2           KNA$SSN.STATE = %KNA_STATE_WSSNINIT#;
      412    18373    2           KNA$SSN.NUMDCBS = 1;
      413    18374    2           KNA$SSN.USER# = G$JIT.USR#;
      414    18375    2           KNA$SSN.IOPRD$ = ADDR(NIL);
PL6.E3A0      #001=KNA$OPEN File=KNA$APE.:E05TSI                                 WED 07/30/97 00:55 Page:17   
      415    18376    2           KNA$SSN.RLCID = NETWORK_ADDR;
      416    18377
      417    18378        %EJECT;
PL6.E3A0      #001=KNA$OPEN File=KNA$APE.:E05TSI                                 WED 07/30/97 00:55 Page:18   
      418    18379        /*
      419    18380             Now get an LDCT and initialize it for Session
      420    18381        */
      421    18382
      422    18383    2           KN$NETPARM = '0'B;
      423    18384    2           CALL KNA$GETLDCT (KN$NETPARM.LDCT$)
      424    18385    3           WHENALTRETURN DO;
      425    18386
      426    18387        /*E*     ERROR: KNA-E$NOLDCT
      427    18388                 MESSAGE: No LDCT for this network Session is available
      428    18389        */
      429    18390
      430    18391    3                ERROR = ENOLDCT;
      431    18392    3                GOTO RLSSSN_N_ALTRET;
      432    18393    3                END;
      433    18394
      434    18395    2           KNA$SSN.LDCT$ = KN$NETPARM.LDCT$;
      435    18396    2           KN$NETPARM.SLDCT$ = KN$NETPARM.LDCT$;
      436    18397
      437    18398    2           KN$LDCT.USER# = G$JIT.USR#;
      438    18399    2           KN$LDCT.USER_ENTRY$ = ENTADDR(KNA$IN);
      439    18400    2           KN$LDCT.CONN_TYPE = %KN_CNTYPE_APE;
      440    18401    2           KN$LDCT.UID$ = SSN$;
      441    18402
      442    18403        /* If this is a LOGON talk to NODE ADMIN */
      443    18404    2           IF RESTYPE='LG'
      444    18405    3           THEN DO;
      445    18406    3                CALL KNB$GETRESP (ADDR(SGN),SIZEC(SGN),ADDR(SGNRSP),SIZEC(SGNRSP));
      446    18407    3                IF SGNRSP.ERRCODE ~= '0'B
      447    18408    4                THEN DO;
      448    18409    4                     ERROR = SGNRSP.ERRCODE;
      449    18410    4                     GOTO RLSDCT_N_ALTRET;
      450    18411    4                     END;
      451    18412    3                NETWORK_ADDR = SGNRSP.RLCID;
      452    18413    3                END;
      453    18414
      454    18415    2           FPT_CONNECT.RLCID = NETWORK_ADDR;
PL6.E3A0      #001=KNA$OPEN File=KNA$APE.:E05TSI                                 WED 07/30/97 00:55 Page:19   
      455    18416    2           FPT_CONNECT.TERMINAL_ID.TTYP = %KLTY_PROG#;
      456    18417    2           FPT_CONNECT.USER.SYSID = G$JIT.SYSID;
      457    18418    2           IF RESTYPE = 'NA'
      458    18419    3           THEN DO;
      459    18420    3                FPT_CONNECT.TERMINAL_ID.TERMID = G$JIT.UNAME;
      460    18421    3                FPT_CONNECT.RESOURCE = 'NODADM';
      461    18422    3                END;
      462    18423    2           FPT_CONNECT.TYPE = %KN_CON_TYP_SESS;
      463    18424    2           FPT_CONNECT.SERVICE = 0;
      464    18425    2           RWPARM = KNA_RWPARM_CON;
      465    18426    2           RWPARM.STR = MYDCB.STRM;
      466    18427    2           CALL KNA$BUILD_VDO (%KV_VDO_FNC_UPDRELDVC,RWPARM,HDR);
      467    18428    2           KN$NETPARM.UHDR$ = ADDR(HDR);
      468    18429    2           KN$NETPARM.UHDRSZ = RWPARM.UHDRSZ;
      469    18430    2           KN$NETPARM.FPT$ = ADDR(FPT_CONNECT);
      470    18431
      471    18432        %EJECT;
PL6.E3A0      #001=KNA$OPEN File=KNA$APE.:E05TSI                                 WED 07/30/97 00:55 Page:20   
      472    18433        /*
      473    18434             Loop to reattempt Session connection depending upon resource type
      474    18435        errors
      475    18436        */
      476    18437                %LOCK (G=KNA_LNKSSN);
      477    18444
      478    18445    3           DO WHILE ('1'B);
      479    18446    3                KN$NETPARM.FUNCTION = %KN_FCN_INIT;
      480    18447    3                CALL KNS$SEND (KN$NETPARM);
      481    18448
      482    18449    3                IF KN$NETPARM.ERRCODE = 0
      483    18450    3                THEN EXIT;
      484    18451
      485    18452    4                DO SELECT (KN$NETPARM.ERRCODE);
      486    18453
      487    18454    4                     SELECT (%KN_ERR_NOTCTX);
      488    18455    4                     ERROR = ENOTCTX;
      489    18456    4                     GOTO UNLOCK_N_ALTRET;
      490    18457
      491    18458    4                     SELECT (%KN_ERR_NORTE);
      492    18459    4                     ERROR = ENORTE;
      493    18460    4   UNLOCK_N_ALTRET:
      494    18461                          %UNLOCK (G=KNA_LNKSSN);
      495    18468    4   RLSSSN_N_ALTRET:
      496    18469    4                     CALL KNA$RLSLDCT(KN$NETPARM.LDCT$);
      497    18470    4   RLSDCT_N_ALTRET:
      498    18471    4                     CALL KNA$RLSSSN(SSN$);
      499    18472    4                     ALTRETURN;
      500    18473
      501    18474        /*E*     ERROR: KNA-E$NOTCTX
      502    18475                 MESSAGE: No transport context is available.
      503    18476        */
      504    18477
      505    18478        /*E*     ERROR: KNA-E$NORTE
      506    18479                 MESSAGE: No network connection is available
      507    18480        */
      508    18481
PL6.E3A0      #001=KNA$OPEN File=KNA$APE.:E05TSI                                 WED 07/30/97 00:55 Page:21   
      509    18482
      510    18483        /*
      511    18484             Try again when a Circular Queue frees up causing this user to run
      512    18485        again.
      513    18486        */
      514    18487
      515    18488    4                     SELECT (%KN_ERR_NOQ,%KN_ERR_NOQ2);
      516    18489    4                     KNA$SSN.FLAGS.CQ = '1'B;
      517    18490    4                     CALL KNA$REG_USER(%GH_EVCBL,SSN$);
      518    18491    4                     KNA$SSN.FLAGS.CQ = '0'B;
      519    18492
      520    18493    4                     SELECT (ELSE);
      521    18494    4                CALL SCREECH (SCR_UNEXP);
      522    18495    4                ALTRETURN;
      523    18496
      524    18497    4                     END /* End cases */;
      525    18498    3                END;                       /* DO WHILE ('1'B);                   */
      526    18499        %EJECT;
PL6.E3A0      #001=KNA$OPEN File=KNA$APE.:E05TSI                                 WED 07/30/97 00:55 Page:22   
      527    18500        /*
      528    18501             We have made a good contact with Session and he is attempting to
      529    18502        establish the network connection for us.  We must now REG the user and
      530    18503        wait for Session to tell us about success or failure.
      531    18504        */
      532    18505
      533    18506    2           CALL KNA$REG_USER(%GH_EVCW,SSN$);
      534    18507    2           IF KNA$SSN.FLAGS.SSNERR = '1'B
      535    18508    3           THEN DO;
      536    18509    3                ERROR = KNA$SSN.ERROR;
      537    18510
      538    18511    3                IF KNA$SSN.STATE = %KNA_STATE_WSSNINIT#
      539    18512    3                THEN GOTO UNLOCK_N_ALTRET; /* no INIT_ACK, or a failure one.     */
      540    18513    3                GOTO CLOSE_IT;   /* probably a disconnect right after INIT_ACK   */
      541    18514    3                END;
      542    18515
      543    18516    2           KNA$SSN.RLCID = KN$LDCT.RLCID;
      544    18517
      545    18518        /*
      546    18519             We now have a valid network connection for this user.  Send an
      547    18520        OPEN message to the other end and wait for a positive reply before
      548    18521        returning to this user.  Then we are truly open.
      549    18522        */
      550    18523
      551    18524    2           RWPARM = KNA_RWPARM_CON;
      552    18525    2           CALL KNA$FCNOU(%KV_VDO_FNC_OPNSSN_RQS,KNA$SSN,RWPARM,ERR);
      553    18526    2           KNA$SSN.STATE = %KNA_STATE_ACTIVE#;
      554    18527                %UNLOCK (G=KNA_LNKSSN);
      555    18534    2           END/*do if opndcb$ = nil*/;
      556    18535
      557    18536        %EJECT;
PL6.E3A0      #001=KNA$OPEN File=KNA$APE.:E05TSI                                 WED 07/30/97 00:55 Page:23   
      558    18537        /*   Whether we had to get a new set of SSN/LDCT contexts or not we
      559    18538        now come here to finish the final tidbits of DCB opening.
      560    18539        */
      561    18540
      562    18541    1      KNA$SSN.EVENT = MYDCB.EVENT;
      563    18542    1      MYDCB.SSN$ = SSN$;
      564    18543    1      MYDCB.DDEV.CG = KNA$SSN.FLAGS.CG;
      565    18544    1      MYDCB.STRM = STRM;
      566    18545    1      MYDCB.FCD = '1'B;
      567    18546    1      MYDCB.FCI = '1'B;
      568    18547    1      MYDCB.FFLG = 'FF'X;
      569    18548
      570    18549           %LOCK (G=KNA_LNKSSN);
      571    18556    1      IF NEWSTREAM AND STRM ~= 1 AND UCSTREAM
      572    18557    2      THEN DO;
      573    18558    2           RWPARM = KNA_RWPARM_CON;
      574    18559    2           RWPARM.STR = 1;
      575    18560    2           RWPARM.STRID = STRM;
      576    18561    2           CALL KNA$FCNOU(%KV_VDO_FNC_DCLSTR,KNA$SSN,RWPARM,ERR);
      577    18562    2           RWPARM.STR = STRM;
      578    18563    2           IF ADDR(VLP_WINDOW)~= ADDR(NIL)
      579    18564    3           THEN DO;
      580    18565    3                WINDOW = VLP_WINDOW;
      581    18566    3                CALL KNA$CONV_STR(WINDOW,ERROR);
      582    18567    3                END;
      583    18568    2           ELSE
      584    18569    2                WINDOW = KNA_WINDOW;
      585    18570    2           RWPARM.MSG$ = ADDR(WINDOW);
      586    18571    2           RWPARM.MSGSZ = SIZEC(WINDOW);
      587    18572    2           RWPARM.V$ = ADDR(KNA_WINDOW_TL);
      588    18573    2           RWPARM.VSZ = SIZEC (KNA_WINDOW_TL);
      589    18574    2           IF ADDR(VLP_WINDOW) ~= ADDR(NIL)
      590    18575    2             OR MYDCB.ORG = %G_ORG_FORM#
      591    18576    2           THEN CALL KNA$FCNOU(%KV_VDO_FNC_PRM_SET,KNA$SSN,RWPARM,ERR);
      592    18577    2           RWPARM = KNA_RWPARM_CON;
      593    18578    2           RWPARM.STR = STRM;
      594    18579    2           IF MYDCB.ORG = %G_ORG_FORM#
PL6.E3A0      #001=KNA$OPEN File=KNA$APE.:E05TSI                                 WED 07/30/97 00:55 Page:24   
      595    18580    2           THEN
      596    18581    2                RWPARM.ORG = %KV#VD_ORG_FORM;
      597    18582    2           ELSE IF MYDCB.ORG = %G_ORG_X364#
      598    18583    2                THEN
      599    18584    2                     RWPARM.ORG = %KV#VD_ORG_X364;
      600    18585    2                ELSE IF MYDCB.ORG = %G_ORG_SE#
      601    18586    2                     THEN
      602    18587    2                          RWPARM.ORG = %KV#VD_ORG_SE;
      603    18588    2                     ELSE
      604    18589    2                          RWPARM.ORG = %KV#VD_ORG_UR;
      605    18590    2           IOP$ = ADDR(NIL);
      606    18591    2           CALL KNA$GETIOP(IOP$)
      607    18592    3           WHENRETURN DO ;
      608    18593    3                RWPARM.MRKTYP = %KV_VDOMRKTYP_ENDACK;
      609    18594    3                KNA$SSN.IOPQ$ = IOP$;
      610    18595    3                KNA$SSN.FLAGS.RRRPND = '1'B;
      611    18596    3                END;
      612    18597    3           WHENALTRETURN DO;
      613    18598    3                ERROR = ENO_IOP;
      614    18599    3                GOTO KNA_CLOSE;
      615    18600    3                END;
      616    18601    2           CALL KNA$FCNOU(%KV_VDO_FNC_OPNSTR,KNA$SSN,RWPARM,ERR);
      617    18602    2           IF(IOP$ ~= ADDR(NIL))
      618    18603    3           THEN DO;
      619    18604    3                CALL KNA$REG_USER(%GH_EVCW,SSN$)
      620    18605    4                WHENRETURN DO;
      621    18606    4                     ERROR = IOP$->KN$IOP.ERRCODE;
      622    18607    4                     END;
      623    18608    4                WHENALTRETURN DO;
      624    18609    4                     ERROR = KNA$SSN.ERROR;
      625    18610    4                     END;
      626    18611    3                KNA$SSN.IOPQ$ = ADDR(NIL);
      627    18612    3                CALL KNA$RLSIOP(IOP$);
      628    18613    3                IF (ERROR ~= '0'B)
      629    18614    3                THEN GOTO KNA_CLOSE;
      630    18615    3                END;
      631    18616    2           END;
PL6.E3A0      #001=KNA$OPEN File=KNA$APE.:E05TSI                                 WED 07/30/97 00:55 Page:25   
      632    18617           %UNLOCK (G=KNA_LNKSSN);
      633    18624
      634    18625    1      MYDCB.RLCID = KNA$SSN.RLCID;
      635    18626    1      RETURN;
      636    18627        %EJECT;
PL6.E3A0      #001=KNA$OPEN File=KNA$APE.:E05TSI                                 WED 07/30/97 00:55 Page:26   
      637    18628    1   KNA$TRUNC: ENTRY (DCBNUMBER,ERROR) ALTRET;
      638    18629    1      CLOSING = '0'B;
      639    18630    1      GOTO MAINLINE;
      640    18631
      641    18632    1   KNA_CLOSE: ;
      642    18633    1      CLOSING = '1'B;
      643    18634    1      GOTO INTERNAL_CLOSE;
      644    18635
      645    18636    1   KNA$CLOSE: ENTRY (DCBNUMBER,ERROR) ALTRET;
      646    18637    1      CLOSING = '1'B;
      647    18638    1   MAINLINE: ;
      648    18639
      649    18640    1      DCB$ = G$ROS.DCBPTR$->G$DCBTABLE(DCBNUMBER);
      650    18641    1      SSN$ = MYDCB.SSN$;
      651    18642    1      ERROR = '0'B;                        /* so we know whether to ALTRETURN    */
      652    18643
      653    18644    1      IF NOT MYDCB.FCD                     /* Dcb is closed                      */
      654    18645    2      THEN DO;
      655    18646    2           ERROR = EDCB_CLOSED;
      656    18647    2           ALTRETURN;
      657    18648    2           END;
      658    18649        /*E* ERROR: KNA-E$DCBCLOSED
      659    18650             MESSAGE: That DCB is already closed.
      660    18651        */
      661    18652
      662    18653           %LOCK (G=KNA_LNKSSN);
      663    18660
      664    18661                       /* If there is a NOWAIT request kill it if it is for this dcb  */
      665    18662    1      IF KNA$SSN.IOPRD$ ~= ADDR(NIL)
      666    18663    1      THEN
      667    18664    1           IF KNA$SSN.IOPRD$->KN$IOP.DCB$ = DCB$
      668    18665    2           THEN DO;
      669    18666    2                RWPARM = KNA_RWPARM_CON;
      670    18667    2                RWPARM.MRKTYP = %KV_VDOMRKTYP_ENDACK;
      671    18668    2                RWPARM.STR = MYDCB.STRM;
      672    18669    2                CALL KNA$FCNOU(%KV_VDO_FNC_RQSDAT,KNA$SSN,RWPARM,ERR)
      673    18670    3                WHENRETURN DO;
PL6.E3A0      #001=KNA$OPEN File=KNA$APE.:E05TSI                                 WED 07/30/97 00:55 Page:27   
      674    18671    3                     KNA$SSN.FLAGS.RRRPND = '1'B;
      675    18672    3                     CALL KNA$REG_USER(%GH_EVCW,SSN$);
      676    18673    3                     END;
      677    18674    2                IF KNA$SSN.IOPRD$ ~= ADDR(NIL)
      678    18675    2                THEN
      679    18676    2                     CALL KNA$RLSIOP(KNA$SSN.IOPRD$);
      680    18677    2                KNA$SSN.IOPRD$ = ADDR(NIL);
      681    18678    2                END;
      682    18679
      683    18680    1      IF NOT CLOSING THEN GOTO UNLOCK_N_RTN;
      684    18681
      685    18682    1   INTERNAL_CLOSE: ;
      686    18683    1      MYDCB.FCD = '0'B;
      687    18684    1      MYDCB.SSN$ = ADDR(NIL);
      688    18685    1      MYDCB.RLCID = '0'B;
      689    18686    1      KNA$SSN.NUMDCBS = KNA$SSN.NUMDCBS - 1;
      690    18687    1      IF MYDCB.DDEV.RES = %G_DDEV_RES_UC#
      691    18688    2      THEN DO;
      692    18689    2           I = G$ROS.NUMDCBS;
      693    18690    2           NEWSTREAM = '0'B;
      694    18691    3           DO WHILE (I>0);
      695    18692    3                IF DCBADDR(I)~=ADDR(NIL)
      696    18693    3                THEN
      697    18694    3                     IF DCBADDR(I)->MYDCB.FCD
      698    18695    3                       AND MYDCB.STRM = DCBADDR(I)->MYDCB.STRM
      699    18696    3                       AND DCBADDR(I)->MYDCB.DDEV.RES = %G_DDEV_RES_UC#
      700    18697    3                     THEN
      701    18698    3                          NEWSTREAM = '1'B;
      702    18699    3                I = I - 1;
      703    18700    3                END;
      704    18701    2           IF NOT NEWSTREAM
      705    18702    3           THEN DO;
      706    18703    3                RWPARM = KNA_RWPARM_CON;
      707    18704    3                RWPARM.STR = MYDCB.STRM;
      708    18705    3                IF (MYDCB.DISP~=%G_DISP_KEEP#) AND NOT(G$JIT.JUNK.KEEP)
      709    18706    3                THEN RWPARM.VDOFLGS.DLTSTR = '1'B;
      710    18707    3                CALL KNA$FCNOU(%KV_VDO_FNC_CLSSTR,KNA$SSN,RWPARM,ERR);
PL6.E3A0      #001=KNA$OPEN File=KNA$APE.:E05TSI                                 WED 07/30/97 00:55 Page:28   
      711    18708    3                END;
      712    18709    2           END;
      713    18710    1      IF KNA$SSN.FLAGS.MRKPND
      714    18711    2      THEN DO;
      715    18712    2           RWPARM = KNA_RWPARM_CON;
      716    18713    2           RWPARM.MRKTYP = %KV_VDOMRKTYP_MRK;
      717    18714    2           RWPARM.MARKER = KNA$SSN.MARKER;
      718    18715    2           CALL KNA$FCNOU(%KV_VDO_FNC_MRK,KNA$SSN,RWPARM,ERR);
      719    18716    2           KNA$SSN.FLAGS.MRKPND = '0'B;
      720    18717    2           END;
      721    18718    1      IF KNA$SSN.NUMDCBS ~= 0 THEN GOTO UNLOCK_N_RTN;
      722    18719
      723    18720    1   CLOSE_IT: ;                             /* entry for partially failed open    */
      724    18721    1      IF KNA$SSN.STATE = %KNA_STATE_TERM#
      725    18722
      726    18723    1      THEN I = %KN_FCN_TERM_ACK;
      727    18724    1      ELSE I = %KN_FCN_TERM;
      728    18725
      729    18726
      730    18727    1      FPT_TERM = '0'B;
      731    18728    1      KN$NETPARM = KN_NETPARM_INIT;
      732    18729    1      KN$NETPARM.FUNCTION = I;
      733    18730    1      KN$NETPARM.FPT$ = ADDR(FPT_TERM);
      734    18731    1      KN$NETPARM.LDCT$ = KNA$SSN.LDCT$;
      735    18732    1      KN$NETPARM.SLDCT$ = KN$NETPARM.LDCT$;
      736    18733
      737    18734    2      DO WHILE('1'B);
      738    18735    2           CALL KNS$SEND (KN$NETPARM);
      739    18736
      740    18737    2           IF KN$NETPARM.ERRCODE ~= %KN_ERR_NOQ
      741    18738    2           THEN
      742    18739    2                EXIT;
      743    18740
      744    18741    2           CALL KNA$REG_USER (%GH_EVCBL,SSN$);
      745    18742    2           END;
      746    18743    1      IF I = %KN_FCN_TERM
      747    18744    2      THEN DO;
PL6.E3A0      #001=KNA$OPEN File=KNA$APE.:E05TSI                                 WED 07/30/97 00:55 Page:29   
      748    18745    2           KNA$SSN.STATE = %KNA_STATE_WTERM;
      749    18746    2           CALL KNA$REG_USER (%GH_EVCW,SSN$);
      750    18747    2           END;
      751    18748    1      CALL KNA$RLSLDCT (KNA$SSN.LDCT$);
      752    18749           %UNLOCK (G=KNA_LNKSSN);
      753    18756
      754    18757    1      CALL KNA$RLSSSN (SSN$);
      755    18758    1      RETURN;                              /* dont unlock twice                  */
      756    18759    1   UNLOCK_N_RTN: ;
      757    18760           %UNLOCK (G=KNA_LNKSSN);
      758    18767    1      IF ERROR = '0'B THEN RETURN;
      759    18768    1      ALTRETURN;
      760    18769
      761    18770    1   END KNA$OPEN;
      762    18771        %EOD;

PL6.E3A0      #001=KNA$OPEN File=KNA$APE.:E05TSI                                 WED 07/30/97 00:55 Page:30   
--  Include file information  --

   K_SCODE_C.:E05TOU  is referenced.
   KV_GLBCNS_E.:E05TOU  is referenced.
   KV$VDO.:E05TOU  is referenced.
   K$RWPARM.:E05TOU  is referenced.
   KI_CP6.:E05TOU  is referenced.
   KL_AFCN_C.:E05TOU  is referenced.
   KL_SUPER_C.:E05TOU  is referenced.
   GF_LCP6_M.:E05TOU  is referenced.
   KL_MACRO_C.:E05TOU  is referenced.
   GH_SCHD_E.:E05TOU  is referenced.
   G_JIT_M.:E05TOU  is referenced.
   G_ROS_M.:E05TOU  is referenced.
   GH_LCP6_M.:E05TOU  is referenced.
   KI_ERRORS_C.:E05TOU  is referenced.
   KN_ERRORS_C.:E05TOU  is referenced.
   GU_LCP6_M.:E05TOU  is referenced.
   KNH_MACRO_C.:E05TOU  is referenced.
   KN_DATA_M.:E05TOU  is referenced.
   GH_GATE_M.:E05TOU  cannot be made into a system file and is referenced.
   KNA_MACRO_M.:E05TOU  is referenced.
   G_LCP6_E.:E05TOU  is referenced.
   F_ERRORS_C.:E05TOU  is referenced.
      No diagnostics issued in procedure KNA$OPEN.

   Procedure KNA$OPEN requires 2092 words for executable code.
   Procedure KNA$OPEN requires 206 words of local(AUTO) storage.

PL6.E3A0      #001=KNA$OPEN File=KNA$APE.:E05TSI                                 WED 07/30/97 00:55 Page:31   

 Object Unit name= KNA$OPEN                                   File name= KNA$APE.:E05TOU
 UTS= JUL 30 '97 00:55:07.12 WED                              Compiler= PL-6/E31         Sev=      00
 SharedLib= :SHARED_LCP6_SYSTEM                               Alt SharedLib=


    ****  Control sections  ****

 Sect   Type Bound  Init  Size HexSiz  Section name
    0   Data  even  none     4      4  KNA$OPEN
    1  RoData even  UTS     38     26  KNA$OPEN
    2   Proc  even  none  2092    82C  KNA$OPEN
    3  RoData even  none     5      5  KNA$OPEN

    ****  Entry defs  ****

                              Check   Calling
                             calling  sequence
  Sect HexLoc Primary Altret sequence   type   Parms  Name
     2      0   yes    yes     yes      Std        4  KNA$OPEN
     2    613          yes     yes      Std        2  KNA$TRUNC
     2    621          yes     yes      Std        2  KNA$CLOSE
PL6.E3A0      #001=KNA$OPEN File=KNA$APE.:E05TSI                                 WED 07/30/97 00:55 Page:32   

  ****  Entry refs  ****

         Check        Calling
        calling       sequence
Altret sequence SRef   type   Args  Name
 yes     yes           Std       1 KNA$GETSSN
 yes     yes           Std       1 KNA$GETLDCT
 yes     yes           Std       1 KNA$IN
 yes     yes           Std       4 KNB$GETRESP
 yes     yes           Std       1 GHH$UNLOCK
 yes     yes           Std       1 KNA$RLSSSN
         yes           Std       1 SCREECH
 yes     yes           Std       1 GHH$LOCK
 yes     yes           Std       1 KNS$SEND
 yes     yes           Std       4 KNA$FCNOU
 yes     yes           Std       1 KNA$RLSLDCT
 yes     yes           Std       2 KNA$REG_USER
 yes     yes           Std       1 KNA$GETIOP
 yes     yes           Std       1 KNA$RLSIOP
         yes           Std       3 KNA$BUILD_VDO
 yes     yes           Std       2 KNA$CONV_STR
                       nStd      0 X6A_AUTO_N
                       nStd      0 X6A_AALT
                       nStd      0 X6A_ARET

  ****  Data refs  ****

  Flags:  r = read only, s = secondary
Flgs Name                             Flgs Name                             Flgs Name
r    G$JIT$                           r    G$ROS$                                KNA_RWPARM_CON
     KNA_LNKSSN                            KNA_WINDOW                            KN_NETPARM_INIT
     KNA_WINDOW_TL                         KN_NODE#                         r    G$ROS$
PL6.E3A0      #001=KNA$OPEN File=KNA$APE.:E05TSI                                 WED 07/30/97 00:55 Page:33   


        1        1        /*M* KNA$APE - Application Presentation Engine */
        2        2        /*T***********************************************************/
        3        3        /*T*                                                         */
        4        4        /*T* Copyright (c) Bull HN Information Systems Inc., 1997    */
        5        5        /*T*                                                         */
        6        6        /*T***********************************************************/
        7        7        /*X* PLM=3,IND=5,ENU=0,ECU=0 */
        8        8        /*P*
        9        9           NAME: KNA$APE
       10       10           PURPOSE:
       11       11                  This module translates user application requests into the
       12       12             proper Presentation layer communications protocols.
       13       13           DESCRIPTION:
       14       14                  This module contains the routines necessary to field an
       15       15             application's M$s READ, WRITE, OPEN, CLOSE on a DCB associated
       16       16             with another endpoint in the network.
       17       17        */
       18       18        /*F*
       19       19           NAME: KNA$OPEN
       20       20           PURPOSE:
       21       21                  To handle the open of a DCB connected to another program via
       22       22             the communications network.
       23       23           DESCRIPTION:
       24       24                  This routine does a validity check of the M$OPEN and sets up
       25       25             context associated with the user's DCB.  A call is made to the
       26       26             monitor's Session layer to establish contact with the proper
       27       27             endpoint for this DCB.
       28       28         */
       29       29        %EJECT;
PL6.E3A0      #001=KNA$OPEN File=KNA$APE.:E05TSI                                 WED 07/30/97 00:55 Page:34   
       30       30        /*D*
       31       31           NAME: KNA$OPEN
       32       32           CALL:
       33       33                  CALL KNA$OPEN(DCBNUMBER,ERROR) ALTRET;
       34       34
       35       35                  Altreturns if an error is encountered during OPEN.
       36       36           PARAMETERS:
       37       37                  DCBNUMBER - The DCB number of the DCB to be opened.
       38       38                  ERROR - Error code returned if an error is encountered.
       39       39           INTERFACE:
       40       40                  KNA$GETLDCT - To get an LDCT for establishing a Session
       41       41                  KNA$RLSLDCT - Release an LDCT
       42       42                  KNS$SESSION - To establish a Session over the network
       43       43                  GHS$REG - To REG the current user until Session replies
       44       44                  KNA$GETSSN - To get an APE Session context
       45       45                  KNA$RLSSSN - Release an APE Session context
       46       46           ENVIRONMENT:
       47       47                  This routine is called from GFM$MCL with the DCBNUMBER set
       48       48             up and the OPEN FPT parameters already merged into the DCB.
       49       49           INPUT:
       50       50                  G$ROS
       51       51                     DCB table information
       52       52                     Network addresses for this user
       53       53           OUTPUT:
       54       54                  None.
       55       55           DESCRIPTION:
       56       56                  This routine finds the address of the DCB number passed and
       57       57             checks for any conflicts in the DCB parameters set.  If none, the
       58       58             resource information in the DCB is used to access an associated
       59       59             network address kept in the ROSeg.  If an APE context for this
       60       60             network address is not already established one is made and
       61       61             initialized.  If we already have at least one other DCB connected
       62       62             to the desired endpoint we just intialize some flags in the DCB,
       63       63             mark it OPENed, point it to the APE context and return to the user.
       64       64             After the APE context is initialized an LDCT for Session is also
       65       65             allocated and APE makes a call to Session to establish the network
       66       66             connection.  The user is REGged Queued for Access while we await
PL6.E3A0      #001=KNA$OPEN File=KNA$APE.:E05TSI                                 WED 07/30/97 00:55 Page:35   
       67       67             a Session reply.  When Session replies positively an OPEN message
       68       68             is sent to the other end.
       69       69        */
       70       70        %EJECT;
PL6.E3A0      #001=KNA$OPEN File=KNA$APE.:E05TSI                                 WED 07/30/97 00:55 Page:36   
       71       71
       72       72        KNA$OPEN: PROC (DCBNUMBER,ERROR,LGN_,VLP_WINDOW) ALTRET;

     72   2 000000  D380 0000 0000  xent KNA$OPEN        LNJ,B5   X6A_AUTO_N
          2 000003       00CE 0004                       DC       206,4

       73       73
       74       74        %INCLUDE F_ERRORS_C;
       75      314        %INCLUDE G_LCP6_E;
       76      572        %INCLUDE KNA_MACRO_M;
       77      648        %INCLUDE GH_GATE_M;
       78      689        %INCLUDE KN_DATA_M;
       79     2475        %INCLUDE KNH_MACRO_C;
       80     2758        %INCLUDE GU_LCP6_M;
       81     3686        %INCLUDE KN_ERRORS_C;
       82     3750        %INCLUDE KI_ERRORS_C;
       83     3835        %INCLUDE GH_LCP6_M;
       84     4669        %INCLUDE G_ROS_M;
       85     4751        %INCLUDE G_JIT_M;
       86     5016        %INCLUDE GH_SCHD_E;
       87     5112        %INCLUDE KL_MACRO_C;
       88     8464        %INCLUDE GF_LCP6_M;
       89     8932        %INCLUDE KL_SUPER_C;
       90    11834        %INCLUDE KL_AFCN_C;
       91    11935        %INCLUDE KI_CP6;
       92    13031        %INCLUDE K$RWPARM;
       93    13417        %INCLUDE KV$VDO;
       94    14432        %INCLUDE KV_GLBCNS_E;
       95    14773        %INCLUDE K_SCODE_C;
       96    14858        %KV#VD_ORG_E;
       97    14866        %KV_VDO_ALL_E;
       98    14945
       99    14946        /* Parameter definitions */
      100    14947    1   DCL DCBNUMBER UBIN;
      101    14948        %VLP_ERRCODE (STCLASS="",FPTN=ERROR);
      102    14994    1   DCL LGN_ VECTOR;
      103    14995        %VLP_WINDOW (STCLASS=PARAM);
PL6.E3A0      #001=KNA$OPEN File=KNA$APE.:E05TSI                                 WED 07/30/97 00:55 Page:37   
      104    15039
      105    15040        /* Entry defintions */
      106    15041    1   DCL KNA$GETLDCT ENTRY(1) ALTRET;
      107    15042    1   DCL KNA$RLSLDCT ENTRY(1) ALTRET;
      108    15043    1   DCL KNS$SEND ENTRY(1) ALTRET;
      109    15044    1   DCL KNA$BUILD_VDO ENTRY(3);
      110    15045    1   DCL KNA$CONV_STR ENTRY(2) ALTRET;
      111    15046    1   DCL KNA$GETSSN ENTRY(1) ALTRET;
      112    15047    1   DCL KNA$RLSSSN ENTRY(1) ALTRET;
      113    15048    1   DCL KNA$RLSIOP ENTRY(1) ALTRET;
      114    15049    1   DCL KNA$GETIOP ENTRY(1) ALTRET;
      115    15050    1   DCL KNA$IN ENTRY(1) ALTRET;
      116    15051    1   DCL SCREECH ENTRY(1);
      117    15052    1   DCL KNA$REG_USER ENTRY(2) ALTRET;
      118    15053    1   DCL KNB$GETRESP ENTRY(4) ALTRET;
      119    15054    1   DCL KNA$FCNOU ENTRY(4) ALTRET;
      120    15055
      121    15056        /* Auto */
      122    15057        %K$RWPARM (NAME=RWPARM,STCLASS=AUTO);
      123    15373        %KV$VDO_CLSSTR (NAME=HDR,STCLASS=AUTO);
      124    15416        %KN$NETPARM;
      125    15569        %FPT_CONNECT(STCLASS=AUTO);
      126    15638        %FPT_TERM;
      127    15660    1   DCL CLOSING BIT(1);
      128    15661    1   DCL NEWSTREAM BIT(1);
      129    15662    1   DCL UCSTREAM BIT(1);
      130    15663    1   DCL I SBIN;
      131    15664    1   DCL ERR UBIN(32);
      132    15665    1   DCL IOP$ PTR;
      133    15666    1   DCL STRM UBIN;
      134    15667    1   DCL DCB$ PTR;
      135    15668    1   DCL SSN$ PTR;
      136    15669    1   DCL TEMP$ PTR;
      137    15670    1   DCL OPNDCB$ PTR;
      138    15671    1   DCL RESTYPE CHAR(2);
      139    15672    1   DCL 1 NETWORK_ADDR ALIGNED,
      140    15673    1         2 NODE#  UBIN(8) CALIGNED,
PL6.E3A0      #001=KNA$OPEN File=KNA$APE.:E05TSI                                 WED 07/30/97 00:55 Page:38   
      141    15674    1         2 GENERATION UBIN(8) CALIGNED,
      142    15675    1         2 LDCTX  UBIN CALIGNED;
      143    15676        %KL_SGN (FPTN=SGN,STCLASS=AUTO,LGNSIZ=70);
      144    15769        %KL_SGNRSP (FPTN=SGNRSP,STCLASS="REDEF SGN",RSPSIZ=68);
      145    15905        %VLP_WINDOW (FPTN=WINDOW,STCLASS=AUTO);
      146    15949        %EJECT;
PL6.E3A0      #001=KNA$OPEN File=KNA$APE.:E05TSI                                 WED 07/30/97 00:55 Page:39   
      147    15950        /* Based structures */
      148    15951        %KN$LDCT(STCLASS="BASED(KN$NETPARM.LDCT$)");
      149    16196        %G$ROS (FPTN=G$ROS,STCLASS="BASED(G$ROS$)");
      150    16240        %G$JIT (STCLASS="BASED(G$JIT$)");
      151    16654        %G$JIT_E;
      152    16716        %M$DCB (DCBN=MYDCB,STCLASS="BASED(DCB$)");
      153    16767        %KNA$SSN (STCLASS="BASED(SSN$)");
      154    16850        %KN$IOP (STCLASS=BASED);
      155    17023        %G$DCBTABLE;
      156    17034
      157    17035        /* Pointer references */
      158    17036    1   DCL G$JIT$ PTR SYMREF READONLY;
      159    17037    1   DCL G$ROS$ PTR SYMREF READONLY;
      160    17038
      161    17039        /* Error codes */
      162    17040        %VLP_ERRCODE (FPTN=ENO_IOP, ERR#=%E$NO_IOP,
      163    17041                     STCLASS=CONSTANT, FCG=KN, MID=A, MON='1'B, SEV=G_SEV_ERROR#);
      164    17087        %VLP_ERRCODE (FPTN=ENOLDCT, ERR#=%E$NOLDCT,
      165    17088                     STCLASS=CONSTANT, FCG=KN, MID=A, MON='1'B, SEV=G_SEV_ERROR#);
      166    17134        %VLP_ERRCODE (FPTN=ENOTCTX, ERR#=%E$NOTCTX,
      167    17135                     STCLASS=CONSTANT, FCG=KN, MID=A, MON='1'B, SEV=G_SEV_ERROR#);
      168    17181        %VLP_ERRCODE (FPTN=ENORTE, ERR#=%E$NORTE,
      169    17182                     STCLASS=CONSTANT, FCG=KN, MID=A, MON='1'B, SEV=G_SEV_ERROR#);
      170    17228        %VLP_ERRCODE (FPTN=EBAD_DCB_RES, ERR#=%E$INVRES,
      171    17229                     STCLASS=CONSTANT, FCG=KN, MID=A, MON='1'B, SEV=G_SEV_ERROR#);
      172    17275        %VLP_ERRCODE (FPTN=EBAD_ORG, ERR#=%E$BAD_ORG,
      173    17276                     STCLASS=CONSTANT, FCG=KN, MID=A, MON='1'B, SEV=G_SEV_ERROR#);
      174    17322        %VLP_ERRCODE (FPTN=ENET_ADDR, ERR#=%E$NET_ADDR,
      175    17323                     STCLASS=CONSTANT, FCG=KN, MID=A, MON='1'B, SEV=G_SEV_ERROR#);
      176    17369        %VLP_ERRCODE (FPTN=EAPE_SSN, ERR#=%E$APE_SSN,
      177    17370                     STCLASS=CONSTANT, FCG=KN, MID=A, MON='1'B, SEV=G_SEV_ERROR#);
      178    17416        %VLP_ERRCODE (FPTN=EDCB_CLOSED, ERR#=%E$DCBCLOSED,
      179    17417                     STCLASS=CONSTANT, FCG=KN, MID=A, MON='1'B, SEV=G_SEV_ERROR#);
      180    17463        %VLP_ERRCODE (FPTN=EDCB_OPEN, ERR#=%E$DCBOPEN,
      181    17464                     STCLASS=CONSTANT, FCG=KN, MID=A, MON='1'B, SEV=G_SEV_ERROR#);
      182    17510        %VLP_ERRCODE (FPTN=ERR_ORGNOTCOM, ERR#=%E$ORGNOTCOM,
      183    17511                     STCLASS=CONSTANT, FCG=KN, MID=A, MON='1'B, SEV=G_SEV_ERROR#);
PL6.E3A0      #001=KNA$OPEN File=KNA$APE.:E05TSI                                 WED 07/30/97 00:55 Page:40   
      184    17557
      185    17558        %VLP_SCODE (FPTN=SCR_UNEXP,FCG=KN,MID=A,ERR#=%S$UNEXPRESP,
      186    17559                       MON='1'B,SEV=G_SEV_SCREECH#,STCLASS=CONSTANT);
      187    17620        /*S* SCREECH_CODE: KNA-S$UNEXPRESP
      188    17621             TYPE: SCREECH
      189    17622             MESSAGE: Unexpected respone from lower layers.
      190    17623             REMARKS: The session layer returned something we did not expect.
      191    17624         */
      192    17625
      193    17626        /* Symrefs */
      194    17627        %K$RWPARM (NAME=KNA_RWPARM_CON,STCLASS=SYMREF);
      195    17943        %GATE (FPTN=KNA_LNKSSN,STCLASS=SYMREF);
      196    17962        %VLP_WINDOW (FPTN=KNA_WINDOW,STCLASS=SYMREF);
      197    18006        %KN$NETPARM (NAME=KN_NETPARM_INIT,STCLASS=SYMREF);
      198    18159    1   DCL KNA_WINDOW_TL CHAR(2) SYMREF;
      199    18160    1   DCL KN_NODE# UBIN SYMREF;
      200    18161
      201    18162        /* Constants */
      202    18163    1   DCL NUMBERS CHAR(0) CONSTANT INIT('0123456789');
      203    18164    1   DCL LGNSTR CHAR(SGN.LOGON.LGNSIZ) BASED;
      204    18165        %EJECT;
PL6.E3A0      #001=KNA$OPEN File=KNA$APE.:E05TSI                                 WED 07/30/97 00:55 Page:41   
      205    18166        /*   Get the address of the DCB by indexing into the ROSeg tables and
      206    18167        check DCB parameters.  The only thing to check right now is for a
      207    18168        valid resource of 'HOnn' or 'MEnn'.
      208    18169        */
      209    18170
      210    18171    1      DCB$ = G$ROS.DCBPTR$ -> G$DCBTABLE(DCBNUMBER);

  18171   2 000005  EC80 0000 0000  xsym                 LDB,B6   G$ROS$
          2 000008  DC86                                 LDB,B5   ,B6
          2 000009  CCC7 0004                            LDB,B4   @DCBNUMBER,AUTO
          2 00000B  B804                                 LDR,R3   ,B4
          2 00000C  BCB5                                 LDB,B3   ,B5,R3
          2 00000D  BFC7 0074                            STB,B3   DCB$,AUTO

      211    18172
      212    18173    1      IF MYDCB.FCD

  18173   2 00000F  82C3 001F                            LB,'4000'X        31,B3
  18173   2 000011       4000
          2 000012  0581 000A                            BBF      s:18182,PREL

      213    18174    2      THEN DO;

      214    18175    2           ERROR = EDCB_OPEN;

  18175   2 000014  8C80 0000 0012  01                   LDI      EDCB_OPEN
          2 000017  ACC7 0006                            LDB,B2   @ERROR,AUTO
          2 000019  8D02                                 SDI      ,B2

      215    18176    2           ALTRETURN;

  18176   2 00001A  C380 0000 0000  xent                 LNJ,B4   X6A_AALT

      216    18177    2           END;
      217    18178        /*E* ERROR: KNA-E$DCBOPEN
      218    18179             MESSAGE: That DCB is already open.
      219    18180        */
PL6.E3A0      #001=KNA$OPEN File=KNA$APE.:E05TSI                                 WED 07/30/97 00:55 Page:42   
      220    18181
      221    18182    1      RESTYPE = SUBSTR(MYDCB.RES,0,2);

  18182   2 00001D  AB83                                 LAB,B2   ,B3
          2 00001E  2C32                                 LDV,R2   50
          2 00001F  6C02                                 LDV,R6   2
          2 000020  BBC7 007C                            LAB,B3   RESTYPE,AUTO
          2 000022  3C00                                 LDV,R3   0
          2 000023  0008                                 MMM

      222    18183    1      CALL INDEX(I,' ',MYDCB.RES);

  18183   2 000024  DCC7 0074                            LDB,B5   DCB$,AUTO
          2 000026  0028                                 SRH      ;
          2 000027       4178 2000                                ALPHANUM('2000'X,IMO,,1),;
          2 000029       4407 00C2                                BINARY(WINDOW+17,AUTO,,4),;
          2 00002B       4405 0019                                ALPHANUM(25,B5,,4)
          2 00002D  5381 0006                            CBE      s:18183+16,PREL
          2 00002F  6C04                                 LDV,R6   4
          2 000030  EF47 006E                            STR,R6   I,AUTO
          2 000032  0F81 0005                            B        s:18184,PREL
          2 000034  E847 00C3                            LDR,R6   WINDOW+18,AUTO
          2 000036  EF47 006E                            STR,R6   I,AUTO

      223    18184    1      IF I = 0 OR I = 1 OR I = 3 OR (I = 4 AND RESTYPE ~= 'UC')

  18184   2 000038  6901 0021                            BEZ,R6   s:18186,PREL
          2 00003A  6D01                                 CMV,R6   1
          2 00003B  0901 001E                            BE       s:18186,PREL
          2 00003D  6D03                                 CMV,R6   3
          2 00003E  0901 001B                            BE       s:18186,PREL
          2 000040  6D04                                 CMV,R6   4
          2 000041  0981 000B                            BNE      s:18184+21,PREL
          2 000043  BB80 0000 0000  01                   LAB,B3   ENO_IOP
          2 000046  0022                                 ACM      ;
          2 000047       4207 007C                                ALPHANUM(RESTYPE,AUTO,,2,FILL),;
          2 000049       4203 001E                                ALPHANUM(30,B3,,2,FILL)
PL6.E3A0      #001=KNA$OPEN File=KNA$APE.:E05TSI                                 WED 07/30/97 00:55 Page:43   
          2 00004B  5301 000E                            CBNE     s:18186,PREL
          2 00004D  6D02                                 CMV,R6   2
          2 00004E  0981 0014                            BNE      s:18191,PREL
          2 000050  BB80 0000 0000  01                   LAB,B3   ENO_IOP
          2 000053  0022                                 ACM      ;
          2 000054       4205 001A                                ALPHANUM(26,B5,,2,FILL),;
          2 000056       4203 001F                                ALPHANUM(31,B3,,2,FILL)
          2 000058  5381 000A                            CBE      s:18191,PREL

      224    18185    1        OR (I = 2 AND SUBSTR(MYDCB.RES,2,2) ~= '  ')
      225    18186    2      THEN DO;

  18185   2                              BADRES          null
      226    18187    2   BADRES: ;
      227    18188    2           ERROR = EBAD_DCB_RES;

  18188   2 00005A  8C80 0000 0008  01   BADRES          LDI      EBAD_DCB_RES
          2 00005D  ECC7 0006                            LDB,B6   @ERROR,AUTO
          2 00005F  8D06                                 SDI      ,B6

      228    18189    2           ALTRETURN;

  18189   2 000060  C380 0000 0000  xent                 LNJ,B4   X6A_AALT

      229    18190    2           END;
      230    18191    1      IF I = 4

  18191   2 000063  6D04                                 CMV,R6   4
          2 000064  0981 0035                            BNE      s:18198,PREL

      231    18192    2      THEN DO;

      232    18193    2           CALL INDEX(I,SUBSTR(MYDCB.RES,2,1),NUMBERS) ALTRET (BADRES);

  18193   2 000066  BB80 0000 0000  01                   LAB,B3   ENO_IOP
          2 000069  0028                                 SRH      ;
          2 00006A       4105 001A                                ALPHANUM(26,B5,,1),;
PL6.E3A0      #001=KNA$OPEN File=KNA$APE.:E05TSI                                 WED 07/30/97 00:55 Page:44   
          2 00006C       4407 00C2                                BINARY(WINDOW+17,AUTO,,4),;
          2 00006E       4A03 0019                                ALPHANUM(25,B3,,10)
          2 000070  5381 0005                            CBE      s:18193+16,PREL
          2 000072  6C0A                                 LDV,R6   10
          2 000073  EF47 006E                            STR,R6   I,AUTO
          2 000075  0FE5                                 B        s:18186,SPREL
          2 000076  E847 00C3                            LDR,R6   WINDOW+18,AUTO
          2 000078  EF47 006E                            STR,R6   I,AUTO

      233    18194    2           CALL INDEX(I,SUBSTR(MYDCB.RES,3,1),NUMBERS) ALTRET (BADRES);

  18194   2 00007A  BB80 0000 0000  01                   LAB,B3   ENO_IOP
          2 00007D  0028                                 SRH      ;
          2 00007E       C105 001A                                ALPHANUM(26,B5,1,1),;
          2 000080       4407 00C2                                BINARY(WINDOW+17,AUTO,,4),;
          2 000082       4A03 0019                                ALPHANUM(25,B3,,10)
          2 000084  5381 0005                            CBE      s:18194+16,PREL
          2 000086  6C0A                                 LDV,R6   10
          2 000087  EF47 006E                            STR,R6   I,AUTO
          2 000089  0FD1                                 B        s:18186,SPREL
          2 00008A  E847 00C3                            LDR,R6   WINDOW+18,AUTO
          2 00008C  EF47 006E                            STR,R6   I,AUTO

      234    18195    2           CALL CHARBIN(STRM,SUBSTR(MYDCB.RES,2,2));

  18195   2 00008E  002A                                 CDB      ;
          2 00008F       0205 001A                                UNPACKED(26,B5,,2,UNSIGNED),;
          2 000091       0407 00C2                                BINARY(WINDOW+17,AUTO,,4)
          2 000093  437F                                 CSYNC    s:18195+4,SPREL
          2 000094  D847 00C3                            LDR,R5   WINDOW+18,AUTO
          2 000096  DF47 0073                            STR,R5   STRM,AUTO

      235    18196    2           END;

  18196   2 000098  0F81 0004                            B        s:18200,PREL

      236    18197    1      ELSE
PL6.E3A0      #001=KNA$OPEN File=KNA$APE.:E05TSI                                 WED 07/30/97 00:55 Page:45   
      237    18198    1           STRM = 1;

  18198   2 00009A  5C01                                 LDV,R5   1
          2 00009B  DF47 0073                            STR,R5   STRM,AUTO

      238    18199
      239    18200    1      UCSTREAM = '0'B;

  18200   2 00009D  8747 006D                            CL       UCSTREAM,AUTO

      240    18201    1      NEWSTREAM = '1'B;

  18201   2 00009F  8947 006C                            LBT,'8000'X       NEWSTREAM,AUTO
  18201   2 0000A1       8000

      241    18202        /*N* DCBS - More validation of parameters and support of further ORGs
      242    18203        must be done here.
      243    18204        */
      244    18205
      245    18206        %EJECT;
PL6.E3A0      #001=KNA$OPEN File=KNA$APE.:E05TSI                                 WED 07/30/97 00:55 Page:46   
      246    18207    2      DO SELECT(RESTYPE);

  18207   2 0000A2  BB80 0000 0000  01                   LAB,B3   ENO_IOP
          2 0000A5  0022                                 ACM      ;
          2 0000A6       4207 007C                                ALPHANUM(RESTYPE,AUTO,,2,FILL),;
          2 0000A8       4203 0020                                ALPHANUM(32,B3,,2,FILL)
          2 0000AA  7301 002D                            CBL      s:18207+54,PREL
          2 0000AC  BB80 0000 0000  01                   LAB,B3   ENO_IOP
          2 0000AF  0022                                 ACM      ;
          2 0000B0       4207 007C                                ALPHANUM(RESTYPE,AUTO,,2,FILL),;
          2 0000B2       4203 0020                                ALPHANUM(32,B3,,2,FILL)
          2 0000B4  5381 004D                            CBE      s:18214,PREL
          2 0000B6  BB80 0000 0000  01                   LAB,B3   ENO_IOP
          2 0000B9  0022                                 ACM      ;
          2 0000BA       4207 007C                                ALPHANUM(RESTYPE,AUTO,,2,FILL),;
          2 0000BC       4203 001E                                ALPHANUM(30,B3,,2,FILL)
          2 0000BE  7301 000D                            CBL      s:18207+42,PREL
          2 0000C0  BB80 0000 0000  01                   LAB,B3   ENO_IOP
          2 0000C3  0022                                 ACM      ;
          2 0000C4       4207 007C                                ALPHANUM(RESTYPE,AUTO,,2,FILL),;
          2 0000C6       4203 001E                                ALPHANUM(30,B3,,2,FILL)
          2 0000C8  5381 00A2                            CBE      s:18232,PREL
          2 0000CA  0F81 0135                            B        s:18287,PREL
          2 0000CC  BB80 0000 0000  01                   LAB,B3   ENO_IOP
          2 0000CF  0022                                 ACM      ;
          2 0000D0       4207 007C                                ALPHANUM(RESTYPE,AUTO,,2,FILL),;
          2 0000D2       4203 0021                                ALPHANUM(33,B3,,2,FILL)
          2 0000D4  5301 012B                            CBNE     s:18287,PREL
          2 0000D6  0F81 011A                            B        s:18278,PREL
          2 0000D8  BB80 0000 0000  01                   LAB,B3   ENO_IOP
          2 0000DB  0022                                 ACM      ;
          2 0000DC       4207 007C                                ALPHANUM(RESTYPE,AUTO,,2,FILL),;
          2 0000DE       4203 0022                                ALPHANUM(34,B3,,2,FILL)
          2 0000E0  5301 011F                            CBNE     s:18287,PREL
          2 0000E2  0F81 0001                            B        s:18209,PREL

      247    18208    2           SELECT ('HO');
PL6.E3A0      #001=KNA$OPEN File=KNA$APE.:E05TSI                                 WED 07/30/97 00:55 Page:47   

      248    18209    2           DCB$->MYDCB.DDEV.RES = %G_DDEV_RES_HO#;

  18209   2 0000E4  4C01                                 LDV,R4   1
          2 0000E5  CAC5 0003                            SRM,R4,'0007'X    3,B5
          2 0000E7       0007

      249    18210    2           IF DCB$->MYDCB.RLCID ~= '0'B

  18210   2 0000E8  BB80 0000 0000  03                   LAB,B3   0
          2 0000EB  5C01                                 LDV,R5   1
          2 0000EC  0022                                 ACM      ;
          2 0000ED       4405 002D                                ALPHANUM(45,B5,,4,FILL),;
          2 0000EF       4003 0000                                ALPHANUM(0,B3,,R5,FILL)
          2 0000F1  5381 0007                            CBE      s:18212,PREL

      250    18211    2           THEN NETWORK_ADDR = DCB$->MYDCB.RLCID;

  18211   2 0000F3  8CC5 002D                            LDI      45,B5
          2 0000F5  8D47 007D                            SDI      NETWORK_ADDR,AUTO
          2 0000F7  0F81 0111                            B        s:18291,PREL

      251    18212    2           ELSE NETWORK_ADDR = G$ROS.DCBPTR$->G$DCBTABLE(%G_M$LM#)->MYDCB.RLCID;

  18212   2 0000F9  BC86                                 LDB,B3   ,B6
          2 0000FA  ACC3 0004                            LDB,B2   4,B3
          2 0000FC  8CC2 002D                            LDI      45,B2
          2 0000FE  8D47 007D                            SDI      NETWORK_ADDR,AUTO
          2 000100  0F81 0108                            B        s:18291,PREL

      252    18213    2           SELECT ('LG');

      253    18214    2           DCB$->MYDCB.DDEV.RES = %G_DDEV_RES_LG#;

  18214   2 000102  4C03                                 LDV,R4   3
          2 000103  CAC5 0003                            SRM,R4,'0007'X    3,B5
          2 000105       0007
PL6.E3A0      #001=KNA$OPEN File=KNA$APE.:E05TSI                                 WED 07/30/97 00:55 Page:48   

      254    18215    2           IF ADDR(LGN_) = ADDR(NIL)

  18215   2 000106  BCC7 0008                            LDB,B3   @LGN_,AUTO
          2 000108  8DD3                                 CMN      B3
          2 000109  0981 000A                            BNE      s:18220,PREL

      255    18216    3           THEN DO;

      256    18217    3                ERROR = EBAD_DCB_RES;

  18217   2 00010B  8C80 0000 0008  01                   LDI      EBAD_DCB_RES
          2 00010E  ACC7 0006                            LDB,B2   @ERROR,AUTO
          2 000110  8D02                                 SDI      ,B2

      257    18218    3                ALTRETURN;

  18218   2 000111  C380 0000 0000  xent                 LNJ,B4   X6A_AALT

      258    18219    3                END;
      259    18220    2           SGN = '0'B;

  18220   2 000114  5C64                                 LDV,R5   100
          2 000115  0021                                 ALR      ;
          2 000116       4178 0000                                ALPHANUM('0000'X,IMO,,1),;
          2 000118       4007 007F                                ALPHANUM(SGN,AUTO,,R5,FILL)

      260    18221    2           SGN.FCN = IGA_SGN;

  18221   2 00011A  3C02                                 LDV,R3   2
          2 00011B  437F                                 CSYNC    s:18221,SPREL
          2 00011C  B7C7 007F                            STH,R3   SGN,AUTO

      261    18222    2           SGN.TERMINAL_ID.TTYP = %KLTY_PROG#;

  18222   2 00011E  87C7 0081                            CLH      SGN+2,AUTO

PL6.E3A0      #001=KNA$OPEN File=KNA$APE.:E05TSI                                 WED 07/30/97 00:55 Page:49   
      262    18223    2           SGN.TERMINAL_ID.TERMID = G$JIT.UNAME;

  18223   2 000120  AC80 0000 0000  xsym                 LDB,B2   G$JIT$
          2 000123  0021                                 ALR      ;
          2 000124       4C02 000A                                ALPHANUM(10,B2,,12),;
          2 000126       4E07 0082                                ALPHANUM(SGN+3,AUTO,,14,FILL)

      263    18224    2           SGN.USER.SYSID = G$JIT.SYSID;

  18224   2 000128  2C0A                                 LDV,R2   10
          2 000129  6C02                                 LDV,R6   2
          2 00012A  BBC7 0089                            LAB,B3   SGN+10,AUTO
          2 00012C  3C01                                 LDV,R3   1
          2 00012D  437F                                 CSYNC    s:18224+4,SPREL
          2 00012E  0008                                 MMM

      264    18225    2           SGN.NMID = G$JIT.USR#;

  18225   2 00012F  F842 0004                            LDR,R7   4,B2
          2 000131  F570 00FF                            AND,R7   255,IMO
          2 000133  6C00                                 LDV,R6   0
          2 000134  8D47 00C2                            SDI      WINDOW+17,AUTO
          2 000136  ABC7 00C2                            LAB,B2   WINDOW+17,AUTO
          2 000138  2C00                                 LDV,R2   0
          2 000139  6C04                                 LDV,R6   4
          2 00013A  BBC7 008A                            LAB,B3   SGN+11,AUTO
          2 00013C  3C01                                 LDV,R3   1
          2 00013D  0008                                 MMM

      265    18226    2           SGN.LOGON.LGNSIZ = VBOUND(LGN_) + 1;

  18226   2 00013E  DCC7 0008                            LDB,B5   @LGN_,AUTO
          2 000140  E805                                 LDR,R6   ,B5
          2 000141  6E01                                 ADV,R6   1
          2 000142  EAC7 008D                            SRM,R6,'00FF'X    SGN+14,AUTO
          2 000144       00FF

PL6.E3A0      #001=KNA$OPEN File=KNA$APE.:E05TSI                                 WED 07/30/97 00:55 Page:50   
      266    18227    2           SGN.LOGON.LGNTXT = VBASE(LGN_)->LGNSTR;

  18227   2 000145  8CC5 0001                            LDI      1,B5
          2 000147  B856                                 LDR,R3   R6
          2 000148  E570 7FFF                            AND,R6   32767,IMO
          2 00014A  8D47 00C2                            SDI      WINDOW+17,AUTO
          2 00014C  BCC7 00C2                            LDB,B3   WINDOW+17,AUTO
          2 00014E  304F                                 SOR,R3   15
          2 00014F  A847 008D                            LDR,R2   SGN+14,AUTO
          2 000151  A570 00FF                            AND,R2   255,IMO
          2 000153  C852                                 LDR,R4   R2
          2 000154  D870 2046                            LDR,R5   8262,IMO
          2 000156  0021                                 ALR      ;
          2 000157       4033 0000                                ALPHANUM(0,B3,R3,,R4),;
          2 000159       4007 008E                                ALPHANUM(SGN+15,AUTO,,R5,FILL)

      267    18228    2           SGN.NODE = KN_NODE#;

  18228   2 00015B  E800 0000 0000  xsym                 LDR,R6   KN_NODE#
          2 00015E  437F                                 CSYNC    s:18228+2,SPREL
          2 00015F  EAC7 007F                            SRM,R6,'00FF'X    SGN,AUTO
          2 000161       00FF

      268    18229    2           SGN.TERMINAL_ID.TERM.CHANNEL = G$JIT.SYSID;

  18229   2 000162  AC80 0000 0000  xsym                 LDB,B2   G$JIT$
          2 000165  B842 0005                            LDR,R3   5,B2
          2 000167  BF47 0082                            STR,R3   SGN+3,AUTO
          2 000169  0F81 009F                            B        s:18291,PREL

      269    18230
      270    18231    2           SELECT ('UC');

      271    18232    2           IF MYDCB.ORG = %G_ORG_SE#

  18232   2 00016B  C845 001F                            LDR,R4   31,B5
          2 00016D  C570 00FF                            AND,R4   255,IMO
PL6.E3A0      #001=KNA$OPEN File=KNA$APE.:E05TSI                                 WED 07/30/97 00:55 Page:51   
          2 00016F  4D06                                 CMV,R4   6
          2 000170  0981 000A                            BNE      s:18241,PREL

      272    18233    3           THEN DO;

      273    18234    3                ERROR = EBAD_ORG;

  18234   2 000172  8C80 0000 000A  01                   LDI      EBAD_ORG
          2 000175  BCC7 0006                            LDB,B3   @ERROR,AUTO
          2 000177  8D03                                 SDI      ,B3

      274    18235    3                ALTRETURN;

  18235   2 000178  C380 0000 0000  xent                 LNJ,B4   X6A_AALT

      275    18236    3                END;
      276    18237        /*E* ERROR: KNA-E$BAD_ORG-E
      277    18238             MESSAGE:ORG = SE is not available to FPRGs.
      278    18239        */
      279    18240
      280    18241    2           I = G$ROS.NUMDCBS;

  18241   2 00017B  E846 0014                            LDR,R6   20,B6
          2 00017D  EF47 006E                            STR,R6   I,AUTO

      281    18242    3           DO WHILE (I>=0);

  18242   2 00017F  6801 005C                            BLZ,R6   s:18273,PREL

      282    18243    3                IF DCBADDR(I) ~= ADDR(NIL)

  18243   2 000181  EC80 0000 0000  xsym                 LDB,B6   G$ROS$
          2 000184  DC86                                 LDB,B5   ,B6
          2 000185  B847 006E                            LDR,R3   I,AUTO
          2 000187  8DB5                                 CMN      ,B5,R3
          2 000188  0901 004D                            BE       s:18264,PREL

PL6.E3A0      #001=KNA$OPEN File=KNA$APE.:E05TSI                                 WED 07/30/97 00:55 Page:52   
      283    18244    3                THEN IF DCBADDR(I)->MYDCB.FCD AND DCBADDR(I)->MYDCB.STRM = STRM

  18244   2 00018A  CCB5                                 LDB,B4   ,B5,R3
          2 00018B  82C4 001F                            LB,'4000'X        31,B4
          2 00018D       4000
          2 00018E  0581 0047                            BBF      s:18264,PREL
          2 000190  E844 0002                            LDR,R6   2,B4
          2 000192  E570 00FF                            AND,R6   255,IMO
          2 000194  E947 0073                            CMR,R6   STRM,AUTO
          2 000196  0981 003F                            BNE      s:18264,PREL
          2 000198  BB80 0000 0000  01                   LAB,B3   ENO_IOP
          2 00019B  0022                                 ACM      ;
          2 00019C       4204 0019                                ALPHANUM(25,B4,,2,FILL),;
          2 00019E       4203 001E                                ALPHANUM(30,B3,,2,FILL)
          2 0001A0  5301 0035                            CBNE     s:18264,PREL

      284    18245    3                       AND SUBSTR(DCBADDR(I)->MYDCB.RES,0,2) = 'UC'
      285    18246    4                     THEN DO;

      286    18247    4                          NEWSTREAM = '0'B;

  18247   2 0001A2  8747 006C                            CL       NEWSTREAM,AUTO

      287    18248    5                          DO CASE (MYDCB.ORG);

  18248   2 0001A4  BCC7 0074                            LDB,B3   DCB$,AUTO
          2 0001A6  A843 001F                            LDR,R2   31,B3
          2 0001A8  A570 00FF                            AND,R2   255,IMO
          2 0001AA  2D07                                 CMV,R2   7
          2 0001AB  0281 0017                            BGE      s:18255,PREL
          2 0001AD  9820 0000 01B3  02                   LDR,R1   s:18248+15,R2
          2 0001B0  8390 0000 01BA  02                   JMP      s:18251,R1
          2 0001B3       0009                            DC       s:18255,PREL
          2 0001B4       0009                            DC       s:18255,PREL
          2 0001B5       0000                            DC       s:18251,PREL
          2 0001B6       0009                            DC       s:18255,PREL
          2 0001B7       0009                            DC       s:18255,PREL
PL6.E3A0      #001=KNA$OPEN File=KNA$APE.:E05TSI                                 WED 07/30/97 00:55 Page:53   
          2 0001B8       0009                            DC       s:18255,PREL
          2 0001B9       0000                            DC       s:18251,PREL

      288    18249
      289    18250    5                           CASE (%G_ORG_FORM#,%G_ORG_SE#);

      290    18251    5                             IF MYDCB.ORG ~= DCBADDR(I)->MYDCB.ORG

  18251   2 0001BA  D844 001F                            LDR,R5   31,B4
          2 0001BC  D570 00FF                            AND,R5   255,IMO
          2 0001BE  A955                                 CMR,R2   R5
          2 0001BF  0981 000D                            BNE      s:18257,PREL
          2 0001C1  0F81 0014                            B        s:18264,PREL

      291    18252    5                             THEN GOTO SET_BAD_ORG;
      292    18253
      293    18254    5                           CASE (ELSE);

      294    18255    5                             IF DCBADDR(I)->MYDCB.ORG = %G_ORG_SE# OR

  18255   2 0001C3  D844 001F                            LDR,R5   31,B4
          2 0001C5  D570 00FF                            AND,R5   255,IMO
          2 0001C7  5D06                                 CMV,R5   6
          2 0001C8  0901 0004                            BE       s:18257,PREL
          2 0001CA  5D02                                 CMV,R5   2
          2 0001CB  0981 000A                            BNE      s:18264,PREL

      295    18256    5                               DCBADDR(I)->MYDCB.ORG = %G_ORG_FORM#
      296    18257    6                             THEN DO;

      297    18258    6   SET_BAD_ORG:                   ;

  18258   2                              SET_BAD_ORG     null
      298    18259    6                                  ERROR = ERR_ORGNOTCOM;

  18259   2 0001CD  8C80 0000 0014  01   SET_BAD_ORG     LDI      ERR_ORGNOTCOM
          2 0001D0  ACC7 0006                            LDB,B2   @ERROR,AUTO
PL6.E3A0      #001=KNA$OPEN File=KNA$APE.:E05TSI                                 WED 07/30/97 00:55 Page:54   
          2 0001D2  8D02                                 SDI      ,B2

      299    18260    6                                  ALTRETURN;

  18260   2 0001D3  C380 0000 0000  xent                 LNJ,B4   X6A_AALT

      300    18261    6                                  END;
      301    18262    5                             END/*do case*/;

      302    18263    4                          END/*do if same uc stream*/;
      303    18264    3                I = I - 1;

  18264   2 0001D6  88C7 006E                            DEC      I,AUTO

      304    18265    3                END/*do while*/;

  18265   2 0001D8  E847 006E                            LDR,R6   I,AUTO
          2 0001DA  6881 FFA6                            BGEZ,R6  s:18243,PREL

      305    18266
      306    18267        /*E* ERROR: KNA-%E$ORGNOTCOM-C
      307    18268             MESSAGE: The ORG is not compatible.
      308    18269             MESSAGE1: Another DCB is already open to the same stream as the one
      309    18270                       you are opening, but one has ORG=FORM and one does not.
      310    18271        */
      311    18272
      312    18273    2           DCB$->MYDCB.DDEV.RES = %G_DDEV_RES_UC#;

  18273   2 0001DC  5C02                                 LDV,R5   2
          2 0001DD  ECC7 0074                            LDB,B6   DCB$,AUTO
          2 0001DF  DAC6 0003                            SRM,R5,'0007'X    3,B6
          2 0001E1       0007

      313    18274    2           NETWORK_ADDR = G$ROS.DCBPTR$->G$DCBTABLE(%G_M$ME#)->MYDCB.RLCID;

  18274   2 0001E2  DC80 0000 0000  xsym                 LDB,B5   G$ROS$
          2 0001E5  CC85                                 LDB,B4   ,B5
PL6.E3A0      #001=KNA$OPEN File=KNA$APE.:E05TSI                                 WED 07/30/97 00:55 Page:55   
          2 0001E6  BCC4 0006                            LDB,B3   6,B4
          2 0001E8  8CC3 002D                            LDI      45,B3
          2 0001EA  8D47 007D                            SDI      NETWORK_ADDR,AUTO

      314    18275    2           UCSTREAM = '1'B;

  18275   2 0001EC  8947 006D                            LBT,'8000'X       UCSTREAM,AUTO
  18275   2 0001EE       8000
          2 0001EF  0F81 0019                            B        s:18291,PREL

      315    18276
      316    18277    2           SELECT ('NA');

      317    18278    2           DCB$->MYDCB.DDEV.RES = %G_DDEV_RES_NA#;

  18278   2 0001F1  4C04                                 LDV,R4   4
          2 0001F2  CAC5 0003                            SRM,R4,'0007'X    3,B5
          2 0001F4       0007

      318    18279    2           NETWORK_ADDR = '0'B;

  18279   2 0001F5  8747 007D                            CL       NETWORK_ADDR,AUTO
          2 0001F7  8747 007E                            CL       NETWORK_ADDR+1,AUTO

      319    18280    2           NETWORK_ADDR.NODE# = KN_NODE#;

  18280   2 0001F9  B800 0000 0000  xsym                 LDR,R3   KN_NODE#
          2 0001FC  B7C7 007D                            STH,R3   NETWORK_ADDR,AUTO
          2 0001FE  0F81 000A                            B        s:18291,PREL

      320    18281
      321    18282    2           SELECT (ELSE);

      322    18283        /*E*     ERROR: KNA-E$INVRES
      323    18284                 MESSAGE: An invalid resource expressed on OPEN
      324    18285        */
      325    18286
PL6.E3A0      #001=KNA$OPEN File=KNA$APE.:E05TSI                                 WED 07/30/97 00:55 Page:56   
      326    18287    2      ERROR = EBAD_DCB_RES;

  18287   2 000200  8C80 0000 0008  01                   LDI      EBAD_DCB_RES
          2 000203  BCC7 0006                            LDB,B3   @ERROR,AUTO
          2 000205  8D03                                 SDI      ,B3

      327    18288    2      ALTRETURN;

  18288   2 000206  C380 0000 0000  xent                 LNJ,B4   X6A_AALT

      328    18289    2           END;

      329    18290
      330    18291    1      IF NETWORK_ADDR.LDCTX = 0 AND RESTYPE ~= 'NA' AND RESTYPE ~= 'LG'

  18291   2 000209  E847 007E                            LDR,R6   NETWORK_ADDR+1,AUTO
          2 00020B  6981 001E                            BNEZ,R6  s:18319,PREL
          2 00020D  EB80 0000 0000  01                   LAB,B6   ENO_IOP
          2 000210  0022                                 ACM      ;
          2 000211       4207 007C                                ALPHANUM(RESTYPE,AUTO,,2,FILL),;
          2 000213       4206 0021                                ALPHANUM(33,B6,,2,FILL)
          2 000215  5381 0014                            CBE      s:18319,PREL
          2 000217  EB80 0000 0000  01                   LAB,B6   ENO_IOP
          2 00021A  0022                                 ACM      ;
          2 00021B       4207 007C                                ALPHANUM(RESTYPE,AUTO,,2,FILL),;
          2 00021D       4206 0020                                ALPHANUM(32,B6,,2,FILL)
          2 00021F  5381 000A                            CBE      s:18319,PREL

      331    18292    2      THEN DO;

      332    18293
      333    18294
      334    18295    2           ERROR = ENET_ADDR;

  18295   2 000221  8C80 0000 000C  01                   LDI      ENET_ADDR
          2 000224  ECC7 0006                            LDB,B6   @ERROR,AUTO
          2 000226  8D06                                 SDI      ,B6
PL6.E3A0      #001=KNA$OPEN File=KNA$APE.:E05TSI                                 WED 07/30/97 00:55 Page:57   

      335    18296    2           ALTRETURN;

  18296   2 000227  C380 0000 0000  xent                 LNJ,B4   X6A_AALT

      336    18297    2           END;
      337    18298        /*E*     ERROR: KNA-E$NET_ADDR
      338    18299                 MESSAGE: No network address has been specified for this resource.
      339    18300        */
      340    18301        %EJECT;
PL6.E3A0      #001=KNA$OPEN File=KNA$APE.:E05TSI                                 WED 07/30/97 00:55 Page:58   
      341    18302        /*
      342    18303             It looks like it is perfectly valid to open this DCB for user
      343    18304        I/O now.  We must check to see if there already is an APE network
      344    18305        connection to the specified network address.  If so, then this DCB
      345    18306        can just be marked OPENed and we can return.  If such a network
      346    18307        connection doesn't exist we'll create it by setting up a Session.
      347    18308             The means we use to find out if there is such a network connection
      348    18309        already is to scan the DCB table for a DCB which is going to the same
      349    18310        place as this one.  If so, we're done.
      350    18311        */
      351    18312
      352    18313        /*N* OPEN - We should probably speed up the recognition of an already
      353    18314        existent network connection by having a pointer in the user's JIT to
      354    18315        APE SSN contexts linked together.  We'll probably need it for other
      355    18316        things anyway.
      356    18317        */
      357    18318
      358    18319    1      OPNDCB$ = ADDR(NIL);

  18319   2 00022A  EB80 0000 0000                       LAB,B6   0
          2 00022D  EFC7 007A                            STB,B6   OPNDCB$,AUTO

      359    18320
      360    18321    1      IF RESTYPE ~= 'LG'

  18321   2 00022F  DB80 0000 0000  01                   LAB,B5   ENO_IOP
          2 000232  0022                                 ACM      ;
          2 000233       4207 007C                                ALPHANUM(RESTYPE,AUTO,,2,FILL),;
          2 000235       4205 0020                                ALPHANUM(32,B5,,2,FILL)
          2 000237  5381 0036                            CBE      s:18344,PREL

      361    18322    2      THEN DO;

      362    18323    2   FINDOPNDCB:
      363    18324    3           DO I = 1 TO G$ROS.NUMDCBS;

  18324   2 000239  5C01                 FINDOPNDCB      LDV,R5   1
PL6.E3A0      #001=KNA$OPEN File=KNA$APE.:E05TSI                                 WED 07/30/97 00:55 Page:59   
          2 00023A  DF47 006E                            STR,R5   I,AUTO
          2 00023C  0F81 0028                            B        s:18336+2,PREL

      364    18325    3                TEMP$ = G$ROS.DCBPTR$ -> G$DCBTABLE(I);

  18325   2 00023E  EC80 0000 0000  xsym                 LDB,B6   G$ROS$
          2 000241  DC86                                 LDB,B5   ,B6
          2 000242  B847 006E                            LDR,R3   I,AUTO
          2 000244  CCB5                                 LDB,B4   ,B5,R3
          2 000245  CFC7 0078                            STB,B4   TEMP$,AUTO

      365    18326
      366    18327    3                IF TEMP$ ~= ADDR(NIL)

  18327   2 000247  8DC7 0078                            CMN      TEMP$,AUTO
          2 000249  0901 0019                            BE       s:18336,PREL

      367    18328    3                THEN IF TEMP$ -> MYDCB.FCD = '1'B

  18328   2 00024B  82C4 001F                            LB,'4000'X        31,B4
  18328   2 00024D       4000
          2 00024E  0581 0014                            BBF      s:18336,PREL

      368    18329    3                     THEN IF SUBSTR(TEMP$ -> MYDCB.RES,0,LENGTHC(RESTYPE)) = RESTYPE
             18329                              AND

  18329   2 000250  0022                                 ACM      ;
          2 000251       4204 0019                                ALPHANUM(25,B4,,2,FILL),;
          2 000253       4207 007C                                ALPHANUM(RESTYPE,AUTO,,2,FILL)
          2 000255  5301 000D                            CBNE     s:18336,PREL
          2 000257  5C04                                 LDV,R5   4
          2 000258  0022                                 ACM      ;
          2 000259       4404 002D                                ALPHANUM(45,B4,,4,FILL),;
          2 00025B       4007 007D                                ALPHANUM(NETWORK_ADDR,AUTO,,R5,FILL)
          2 00025D  5301 0005                            CBNE     s:18336,PREL

      369    18330    3                            TEMP$->MYDCB.RLCID = NETWORK_ADDR
PL6.E3A0      #001=KNA$OPEN File=KNA$APE.:E05TSI                                 WED 07/30/97 00:55 Page:60   
      370    18331    4                          THEN DO;

      371    18332    4                               OPNDCB$ = TEMP$;

  18332   2 00025F  CFC7 007A                            STB,B4   OPNDCB$,AUTO

      372    18333    4                               EXIT FINDOPNDCB;

  18333   2 000261  0F81 000C                            B        s:18344,PREL

      373    18334    4                               END;
      374    18335
      375    18336    3                END FINDOPNDCB;            /* DO I = 1 TO G$ROS.NUMDCBS          */

  18336   2 000263  8AC7 006E                            INC      I,AUTO
          2 000265  EC80 0000 0000  xsym                 LDB,B6   G$ROS$
          2 000268  E847 006E                            LDR,R6   I,AUTO
          2 00026A  6854                                 BLZ,R6   s:18325,SPREL
          2 00026B  E946 0014                            CMR,R6   20,B6
          2 00026D  03D1                                 BLE      s:18325,SPREL

      376    18337    2           END/*do if restype~=LG */;

      377    18338        %EJECT;
PL6.E3A0      #001=KNA$OPEN File=KNA$APE.:E05TSI                                 WED 07/30/97 00:55 Page:61   
      378    18339        /* If a DCB was found which meets the requirements for this DCB's OPEN.
      379    18340        All we have to do is fetch the SSN$ address and increment the OPEN DCB
      380    18341        counter.
      381    18342        */
      382    18343
      383    18344    1      IF OPNDCB$ ~= ADDR(NIL)

  18344   2 00026E  8DC7 007A                            CMN      OPNDCB$,AUTO
          2 000270  0901 000B                            BE       s:18356,PREL

      384    18345    2      THEN DO;

      385    18346    2           SSN$ = OPNDCB$ -> MYDCB.SSN$;

  18346   2 000272  ECC7 007A                            LDB,B6   OPNDCB$,AUTO
          2 000274  DCC6 0030                            LDB,B5   48,B6
          2 000276  DFC7 0076                            STB,B5   SSN$,AUTO

      386    18347    2           KNA$SSN.NUMDCBS = KNA$SSN.NUMDCBS+1;

  18347   2 000278  8AC5 0006                            INC      6,B5

      387    18348    2           END;

  18348   2 00027A  0F81 0213                            B        s:18541,PREL

      388    18349
      389    18350        /*
      390    18351             We don't already have a SSN context for this network connection.
      391    18352        Now we have to make one so we must get some context blocks and establish
      392    18353        the connection with Session.
      393    18354        */
      394    18355    2      ELSE DO;

      395    18356    2           CALL KNA$GETSSN (SSN$)

  18356   2 00027C  EBC7 0076                            LAB,B6   SSN$,AUTO
PL6.E3A0      #001=KNA$OPEN File=KNA$APE.:E05TSI                                 WED 07/30/97 00:55 Page:62   
          2 00027E  EFC7 00C2                            STB,B6   WINDOW+17,AUTO
          2 000280  BBC7 00C2                            LAB,B3   WINDOW+17,AUTO
          2 000282  CBF0 0100                            LAB,B4   256,IMO
          2 000284  E380 0000 0000  xent                 LNJ,B6   KNA$GETSSN
          2 000287       0003                            DC       s:18363,PREL
          2 000288  0F81 000A                            B        s:18367,PREL

      396    18357    3           WHENALTRETURN DO;

      397    18358
      398    18359        /*E*     ERROR: KNA-E$APE_SSN
      399    18360                 MESSAGE: Unable to establish a network Session for this DCB
      400    18361        */
      401    18362
      402    18363    3                ERROR = EAPE_SSN;

  18363   2 00028A  8C80 0000 000E  01                   LDI      EAPE_SSN
          2 00028D  ECC7 0006                            LDB,B6   @ERROR,AUTO
          2 00028F  8D06                                 SDI      ,B6

      403    18364    3                ALTRETURN;

  18364   2 000290  C380 0000 0000  xent                 LNJ,B4   X6A_AALT

      404    18365    3                END;
      405    18366
      406    18367    2           KNA$SSN = '0'B;

  18367   2 000293  ECC7 0076                            LDB,B6   SSN$,AUTO
          2 000295  5C32                                 LDV,R5   50
          2 000296  0021                                 ALR      ;
          2 000297       4178 0000                                ALPHANUM('0000'X,IMO,,1),;
          2 000299       4006 0000                                ALPHANUM(0,B6,,R5,FILL)

      407    18368    2           IF DCBNUMBER = %G_M$LM# OR DCBNUMBER = %G_M$ME#

  18368   2 00029B  437F                                 CSYNC    s:18367+7,SPREL
PL6.E3A0      #001=KNA$OPEN File=KNA$APE.:E05TSI                                 WED 07/30/97 00:55 Page:63   
          2 00029C  ECC7 0004                            LDB,B6   @DCBNUMBER,AUTO
          2 00029E  E806                                 LDR,R6   ,B6
          2 00029F  6D02                                 CMV,R6   2
          2 0002A0  0901 0004                            BE       s:18370,PREL
          2 0002A2  6D03                                 CMV,R6   3
          2 0002A3  0981 0005                            BNE      s:18371,PREL

      408    18369    2           THEN
      409    18370    2                KNA$SSN.FLAGS.PRIMARY = '1'B;

  18370   2 0002A5  DCC7 0076                            LDB,B5   SSN$,AUTO
          2 0002A7  8905                                 LBT,'0400'X       ,B5
          2 0002A8       0400

      410    18371    2           KNA$SSN.IOPQ$ = ADDR(NIL);

  18371   2 0002A9  DB80 0000 0000                       LAB,B5   0
          2 0002AC  CCC7 0076                            LDB,B4   SSN$,AUTO
          2 0002AE  DFC4 000B                            STB,B5   11,B4

      411    18372    2           KNA$SSN.STATE = %KNA_STATE_WSSNINIT#;

  18372   2 0002B0  DCC7 0076                            LDB,B5   SSN$,AUTO
          2 0002B2  6C01                                 LDV,R6   1
          2 0002B3  EF45 0013                            STR,R6   19,B5

      412    18373    2           KNA$SSN.NUMDCBS = 1;

  18373   2 0002B5  DCC7 0076                            LDB,B5   SSN$,AUTO
          2 0002B7  EF45 0006                            STR,R6   6,B5

      413    18374    2           KNA$SSN.USER# = G$JIT.USR#;

  18374   2 0002B9  DCC7 0076                            LDB,B5   SSN$,AUTO
          2 0002BB  CC80 0000 0000  xsym                 LDB,B4   G$JIT$
          2 0002BE  C844 0004                            LDR,R4   4,B4
          2 0002C0  C570 00FF                            AND,R4   255,IMO
PL6.E3A0      #001=KNA$OPEN File=KNA$APE.:E05TSI                                 WED 07/30/97 00:55 Page:64   
          2 0002C2  CF45 0011                            STR,R4   17,B5

      414    18375    2           KNA$SSN.IOPRD$ = ADDR(NIL);

  18375   2 0002C4  DB80 0000 0000                       LAB,B5   0
          2 0002C7  BCC7 0076                            LDB,B3   SSN$,AUTO
          2 0002C9  DFC3 000D                            STB,B5   13,B3

      415    18376    2           KNA$SSN.RLCID = NETWORK_ADDR;

  18376   2 0002CB  8CC7 007D                            LDI      NETWORK_ADDR,AUTO
          2 0002CD  DCC7 0076                            LDB,B5   SSN$,AUTO
          2 0002CF  8D45 000F                            SDI      15,B5

      416    18377
      417    18378        %EJECT;
PL6.E3A0      #001=KNA$OPEN File=KNA$APE.:E05TSI                                 WED 07/30/97 00:55 Page:65   
      418    18379        /*
      419    18380             Now get an LDCT and initialize it for Session
      420    18381        */
      421    18382
      422    18383    2           KN$NETPARM = '0'B;

  18383   2 0002D1  5C42                                 LDV,R5   66
          2 0002D2  0021                                 ALR      ;
          2 0002D3       4178 0000                                ALPHANUM('0000'X,IMO,,1),;
          2 0002D5       4007 0037                                ALPHANUM(KN$NETPARM,AUTO,,R5,FILL)

      423    18384    2           CALL KNA$GETLDCT (KN$NETPARM.LDCT$)

  18384   2 0002D7  DBC7 0037                            LAB,B5   KN$NETPARM,AUTO
          2 0002D9  437F                                 CSYNC    s:18384+1,SPREL
          2 0002DA  DFC7 00C2                            STB,B5   WINDOW+17,AUTO
          2 0002DC  BBC7 00C2                            LAB,B3   WINDOW+17,AUTO
          2 0002DE  CBF0 0100                            LAB,B4   256,IMO
          2 0002E0  E380 0000 0000  xent                 LNJ,B6   KNA$GETLDCT
          2 0002E3       0003                            DC       s:18391,PREL
          2 0002E4  0F81 0009                            B        s:18395,PREL

      424    18385    3           WHENALTRETURN DO;

      425    18386
      426    18387        /*E*     ERROR: KNA-E$NOLDCT
      427    18388                 MESSAGE: No LDCT for this network Session is available
      428    18389        */
      429    18390
      430    18391    3                ERROR = ENOLDCT;

  18391   2 0002E6  8C80 0000 0002  01                   LDI      ENOLDCT
          2 0002E9  ECC7 0006                            LDB,B6   @ERROR,AUTO
          2 0002EB  8D06                                 SDI      ,B6

      431    18392    3                GOTO RLSSSN_N_ALTRET;

PL6.E3A0      #001=KNA$OPEN File=KNA$APE.:E05TSI                                 WED 07/30/97 00:55 Page:66   
  18392   2 0002EC  0F81 0108                            B        s:18469,PREL

      432    18393    3                END;
      433    18394
      434    18395    2           KNA$SSN.LDCT$ = KN$NETPARM.LDCT$;

  18395   2 0002EE  ECC7 0037                            LDB,B6   KN$NETPARM,AUTO
          2 0002F0  DCC7 0076                            LDB,B5   SSN$,AUTO
          2 0002F2  EFC5 0004                            STB,B6   4,B5

      435    18396    2           KN$NETPARM.SLDCT$ = KN$NETPARM.LDCT$;

  18396   2 0002F4  ECC7 0037                            LDB,B6   KN$NETPARM,AUTO
          2 0002F6  EFC7 004E                            STB,B6   KN$NETPARM+23,AUTO

      436    18397
      437    18398    2           KN$LDCT.USER# = G$JIT.USR#;

  18398   2 0002F8  DC80 0000 0000  xsym                 LDB,B5   G$JIT$
          2 0002FB  E845 0004                            LDR,R6   4,B5
          2 0002FD  E570 00FF                            AND,R6   255,IMO
          2 0002FF  EF46 000E                            STR,R6   14,B6

      438    18399    2           KN$LDCT.USER_ENTRY$ = ENTADDR(KNA$IN);

  18399   2 000301  EB80 0000 0000  xent                 LAB,B6   KNA$IN
          2 000304  CCC7 0037                            LDB,B4   KN$NETPARM,AUTO
          2 000306  EFC4 000C                            STB,B6   12,B4

      439    18400    2           KN$LDCT.CONN_TYPE = %KN_CNTYPE_APE;

  18400   2 000308  6C01                                 LDV,R6   1
          2 000309  ECC7 0037                            LDB,B6   KN$NETPARM,AUTO
          2 00030B  E786                                 STH,R6   ,B6

      440    18401    2           KN$LDCT.UID$ = SSN$;

PL6.E3A0      #001=KNA$OPEN File=KNA$APE.:E05TSI                                 WED 07/30/97 00:55 Page:67   
  18401   2 00030C  ECC7 0076                            LDB,B6   SSN$,AUTO
          2 00030E  CCC7 0037                            LDB,B4   KN$NETPARM,AUTO
          2 000310  EFC4 0005                            STB,B6   5,B4

      441    18402
      442    18403        /* If this is a LOGON talk to NODE ADMIN */
      443    18404    2           IF RESTYPE='LG'

  18404   2 000312  EB80 0000 0000  01                   LAB,B6   ENO_IOP
          2 000315  0022                                 ACM      ;
          2 000316       4207 007C                                ALPHANUM(RESTYPE,AUTO,,2,FILL),;
          2 000318       4206 0020                                ALPHANUM(32,B6,,2,FILL)
          2 00031A  5301 0037                            CBNE     s:18415,PREL

      444    18405    3           THEN DO;

      445    18406    3                CALL KNB$GETRESP (ADDR(SGN),SIZEC(SGN),ADDR(SGNRSP),SIZEC(SGNRSP));

  18406   2 00031C  EBC7 007F                            LAB,B6   SGN,AUTO
          2 00031E  EFC7 00C2                            STB,B6   WINDOW+17,AUTO
          2 000320  CBF0 0064                            LAB,B4   100,IMO
          2 000322  BBC7 007F                            LAB,B3   SGN,AUTO
          2 000324  BFC7 00C4                            STB,B3   WINDOW+19,AUTO
          2 000326  ABF0 0064                            LAB,B2   100,IMO
          2 000328  AFC7 00CC                            STB,B2   WINDOW+27,AUTO
          2 00032A  9BC7 00C4                            LAB,B1   WINDOW+19,AUTO
          2 00032C  9FC7 00CA                            STB,B1   WINDOW+25,AUTO
          2 00032E  CFC7 00C8                            STB,B4   WINDOW+23,AUTO
          2 000330  EBC7 00C2                            LAB,B6   WINDOW+17,AUTO
          2 000332  EFC7 00C6                            STB,B6   WINDOW+21,AUTO
          2 000334  BBC7 00C6                            LAB,B3   WINDOW+21,AUTO
          2 000336  CBF0 0400                            LAB,B4   1024,IMO
          2 000338  E380 0000 0000  xent                 LNJ,B6   KNB$GETRESP
          2 00033B       0001                            DC       s:18407,PREL

      446    18407    3                IF SGNRSP.ERRCODE ~= '0'B

PL6.E3A0      #001=KNA$OPEN File=KNA$APE.:E05TSI                                 WED 07/30/97 00:55 Page:68   
  18407   2 00033C  EB80 0000 0000  03                   LAB,B6   0
          2 00033F  5C01                                 LDV,R5   1
          2 000340  0022                                 ACM      ;
          2 000341       4407 0084                                ALPHANUM(SGN+5,AUTO,,4,FILL),;
          2 000343       4006 0000                                ALPHANUM(0,B6,,R5,FILL)
          2 000345  5381 0008                            CBE      s:18412,PREL

      447    18408    4                THEN DO;

      448    18409    4                     ERROR = SGNRSP.ERRCODE;

  18409   2 000347  8CC7 0084                            LDI      SGN+5,AUTO
          2 000349  ECC7 0006                            LDB,B6   @ERROR,AUTO
          2 00034B  8D06                                 SDI      ,B6

      449    18410    4                     GOTO RLSDCT_N_ALTRET;

  18410   2 00034C  0F81 00B4                            B        s:18471,PREL

      450    18411    4                     END;
      451    18412    3                NETWORK_ADDR = SGNRSP.RLCID;

  18412   2 00034E  8CC7 0082                            LDI      SGN+3,AUTO
          2 000350  8D47 007D                            SDI      NETWORK_ADDR,AUTO

      452    18413    3                END;

      453    18414
      454    18415    2           FPT_CONNECT.RLCID = NETWORK_ADDR;

  18415   2 000352  8CC7 007D                            LDI      NETWORK_ADDR,AUTO
          2 000354  8D47 0065                            SDI      FPT_CONNECT+13,AUTO

      455    18416    2           FPT_CONNECT.TERMINAL_ID.TTYP = %KLTY_PROG#;

  18416   2 000356  87C7 005D                            CLH      FPT_CONNECT+5,AUTO

PL6.E3A0      #001=KNA$OPEN File=KNA$APE.:E05TSI                                 WED 07/30/97 00:55 Page:69   
      456    18417    2           FPT_CONNECT.USER.SYSID = G$JIT.SYSID;

  18417   2 000358  EC80 0000 0000  xsym                 LDB,B6   G$JIT$
          2 00035B  D846 0005                            LDR,R5   5,B6
          2 00035D  DF47 0067                            STR,R5   FPT_CONNECT+15,AUTO

      457    18418    2           IF RESTYPE = 'NA'

  18418   2 00035F  DB80 0000 0000  01                   LAB,B5   ENO_IOP
          2 000362  0022                                 ACM      ;
          2 000363       4207 007C                                ALPHANUM(RESTYPE,AUTO,,2,FILL),;
          2 000365       4205 0021                                ALPHANUM(33,B5,,2,FILL)
          2 000367  5301 000E                            CBNE     s:18423,PREL

      458    18419    3           THEN DO;

      459    18420    3                FPT_CONNECT.TERMINAL_ID.TERMID = G$JIT.UNAME;

  18420   2 000369  0021                                 ALR      ;
          2 00036A       4C06 000A                                ALPHANUM(10,B6,,12),;
          2 00036C       4E07 005E                                ALPHANUM(FPT_CONNECT+6,AUTO,,14,FILL)

      460    18421    3                FPT_CONNECT.RESOURCE = 'NODADM';

  18421   2 00036E  DB80 0000 0000  01                   LAB,B5   ENO_IOP
          2 000371  0021                                 ALR      ;
          2 000372       4605 0023                                ALPHANUM(35,B5,,6),;
          2 000374       4807 0059                                ALPHANUM(FPT_CONNECT+1,AUTO,,8,FILL)

      461    18422    3                END;

      462    18423    2           FPT_CONNECT.TYPE = %KN_CON_TYP_SESS;

  18423   2 000376  4C01                                 LDV,R4   1
          2 000377  437F                                 CSYNC    s:18423,SPREL
          2 000378  CF47 0058                            STR,R4   FPT_CONNECT,AUTO

PL6.E3A0      #001=KNA$OPEN File=KNA$APE.:E05TSI                                 WED 07/30/97 00:55 Page:70   
      463    18424    2           FPT_CONNECT.SERVICE = 0;

  18424   2 00037A  8847 0068                            LBF,'00FF'X       FPT_CONNECT+16,AUTO
  18424   2 00037C       00FF

      464    18425    2           RWPARM = KNA_RWPARM_CON;

  18425   2 00037D  AB80 0000 0000  xsym                 LAB,B2   KNA_RWPARM_CON
          2 000380  2C00                                 LDV,R2   0
          2 000381  6C52                                 LDV,R6   82
          2 000382  BB87                                 LAB,B3   ,AUTO
          2 000383  3C18                                 LDV,R3   24
          2 000384  0008                                 MMM

      465    18426    2           RWPARM.STR = MYDCB.STRM;

  18426   2 000385  DCC7 0074                            LDB,B5   DCB$,AUTO
          2 000387  E845 0002                            LDR,R6   2,B5
          2 000389  EAC7 0029                            SRM,R6,'00FF'X    RWPARM+29,AUTO
          2 00038B       00FF

      466    18427    2           CALL KNA$BUILD_VDO (%KV_VDO_FNC_UPDRELDVC,RWPARM,HDR);

  18427   2 00038C  CBF0 001E                            LAB,B4   30,IMO
          2 00038E  ABC7 0035                            LAB,B2   HDR,AUTO
          2 000390  AFC7 00C6                            STB,B2   WINDOW+21,AUTO
          2 000392  9BC7 000C                            LAB,B1   RWPARM,AUTO
          2 000394  9FC7 00C4                            STB,B1   WINDOW+19,AUTO
          2 000396  CFC7 00C2                            STB,B4   WINDOW+17,AUTO
          2 000398  BBC7 00C2                            LAB,B3   WINDOW+17,AUTO
          2 00039A  CBF0 0300                            LAB,B4   768,IMO
          2 00039C  E380 0000 0000  xent                 LNJ,B6   KNA$BUILD_VDO
          2 00039F       0001                            DC       s:18428,PREL

      467    18428    2           KN$NETPARM.UHDR$ = ADDR(HDR);

  18428   2 0003A0  EBC7 0035                            LAB,B6   HDR,AUTO
PL6.E3A0      #001=KNA$OPEN File=KNA$APE.:E05TSI                                 WED 07/30/97 00:55 Page:71   
          2 0003A2  EFC7 003C                            STB,B6   KN$NETPARM+5,AUTO

      468    18429    2           KN$NETPARM.UHDRSZ = RWPARM.UHDRSZ;

  18429   2 0003A4  E847 0025                            LDR,R6   RWPARM+25,AUTO
          2 0003A6  EF47 003E                            STR,R6   KN$NETPARM+7,AUTO

      469    18430    2           KN$NETPARM.FPT$ = ADDR(FPT_CONNECT);

  18430   2 0003A8  DBC7 0058                            LAB,B5   FPT_CONNECT,AUTO
          2 0003AA  DFC7 0050                            STB,B5   KN$NETPARM+25,AUTO

      470    18431
      471    18432        %EJECT;
PL6.E3A0      #001=KNA$OPEN File=KNA$APE.:E05TSI                                 WED 07/30/97 00:55 Page:72   
      472    18433        /*
      473    18434             Loop to reattempt Session connection depending upon resource type
      474    18435        errors
      475    18436        */
      476    18437                %LOCK (G=KNA_LNKSSN);

  18442   2 0003AC  BB80 0000 0001  03                   LAB,B3   +1
          2 0003AF  CBF0 0100                            LAB,B4   256,IMO
          2 0003B1  E380 0000 0000  xent                 LNJ,B6   GHH$LOCK
          2 0003B4       0001                            DC       s:18446,PREL

      477    18444
      478    18445    3           DO WHILE ('1'B);

      479    18446    3                KN$NETPARM.FUNCTION = %KN_FCN_INIT;

  18446   2 0003B5  6C01                                 LDV,R6   1
          2 0003B6  EF47 004B                            STR,R6   KN$NETPARM+20,AUTO

      480    18447    3                CALL KNS$SEND (KN$NETPARM);

  18447   2 0003B8  EBC7 0037                            LAB,B6   KN$NETPARM,AUTO
          2 0003BA  EFC7 00C2                            STB,B6   WINDOW+17,AUTO
          2 0003BC  BBC7 00C2                            LAB,B3   WINDOW+17,AUTO
          2 0003BE  CBF0 0100                            LAB,B4   256,IMO
          2 0003C0  E380 0000 0000  xent                 LNJ,B6   KNS$SEND
          2 0003C3       0001                            DC       s:18449,PREL

      481    18448
      482    18449    3                IF KN$NETPARM.ERRCODE = 0

  18449   2 0003C4  E847 004D                            LDR,R6   KN$NETPARM+22,AUTO
          2 0003C6  6901 006F                            BEZ,R6   s:18506,PREL

      483    18450    3                THEN EXIT;
      484    18451
      485    18452    4                DO SELECT (KN$NETPARM.ERRCODE);
PL6.E3A0      #001=KNA$OPEN File=KNA$APE.:E05TSI                                 WED 07/30/97 00:55 Page:73   

  18452   2 0003C8  E970 0003                            CMR,R6   3,IMO
          2 0003CA  0201 000E                            BL       s:18452+17,PREL
          2 0003CC  0901 0019                            BE       s:18459,PREL
          2 0003CE  E970 0006                            CMR,R6   6,IMO
          2 0003D0  0201 0059                            BL       s:18494,PREL
          2 0003D2  0901 000B                            BE       s:18455,PREL
          2 0003D4  6D07                                 CMV,R6   7
          2 0003D5  0981 0054                            BNE      s:18494,PREL
          2 0003D7  0F81 0038                            B        s:18489,PREL
          2 0003D9  6D01                                 CMV,R6   1
          2 0003DA  0981 004F                            BNE      s:18494,PREL
          2 0003DC  0F81 0033                            B        s:18489,PREL

      486    18453
      487    18454    4                     SELECT (%KN_ERR_NOTCTX);

      488    18455    4                     ERROR = ENOTCTX;

  18455   2 0003DE  8C80 0000 0004  01                   LDI      ENOTCTX
          2 0003E1  ECC7 0006                            LDB,B6   @ERROR,AUTO
          2 0003E3  8D06                                 SDI      ,B6

      489    18456    4                     GOTO UNLOCK_N_ALTRET;

  18456   2 0003E4  0F81 0007                            B        s:18466,PREL

      490    18457
      491    18458    4                     SELECT (%KN_ERR_NORTE);

      492    18459    4                     ERROR = ENORTE;

  18459   2 0003E6  8C80 0000 0006  01                   LDI      ENORTE
          2 0003E9  ECC7 0006                            LDB,B6   @ERROR,AUTO
          2 0003EB  8D06                                 SDI      ,B6

      493    18460    4   UNLOCK_N_ALTRET:
PL6.E3A0      #001=KNA$OPEN File=KNA$APE.:E05TSI                                 WED 07/30/97 00:55 Page:74   
      494    18461                          %UNLOCK (G=KNA_LNKSSN);

  18466   2 0003EC  BB80 0000 0001  03   UNLOCK_N_ALTRET LAB,B3   +1
          2 0003EF  CBF0 0100                            LAB,B4   256,IMO
          2 0003F1  E380 0000 0000  xent                 LNJ,B6   GHH$UNLOCK
          2 0003F4       0001                            DC       s:18469,PREL

      495    18468    4   RLSSSN_N_ALTRET:
      496    18469    4                     CALL KNA$RLSLDCT(KN$NETPARM.LDCT$);

  18469   2 0003F5  EBC7 0037            RLSSSN_N_ALTRET LAB,B6   KN$NETPARM,AUTO
          2 0003F7  EFC7 00C2                            STB,B6   WINDOW+17,AUTO
          2 0003F9  BBC7 00C2                            LAB,B3   WINDOW+17,AUTO
          2 0003FB  CBF0 0100                            LAB,B4   256,IMO
          2 0003FD  E380 0000 0000  xent                 LNJ,B6   KNA$RLSLDCT
          2 000400       0001                            DC       s:18471,PREL

      497    18470    4   RLSDCT_N_ALTRET:
      498    18471    4                     CALL KNA$RLSSSN(SSN$);

  18471   2 000401  EBC7 0076            RLSDCT_N_ALTRET LAB,B6   SSN$,AUTO
          2 000403  EFC7 00C2                            STB,B6   WINDOW+17,AUTO
          2 000405  BBC7 00C2                            LAB,B3   WINDOW+17,AUTO
          2 000407  CBF0 0100                            LAB,B4   256,IMO
          2 000409  E380 0000 0000  xent                 LNJ,B6   KNA$RLSSSN
          2 00040C       0001                            DC       s:18472,PREL

      499    18472    4                     ALTRETURN;

  18472   2 00040D  C380 0000 0000  xent                 LNJ,B4   X6A_AALT

      500    18473
      501    18474        /*E*     ERROR: KNA-E$NOTCTX
      502    18475                 MESSAGE: No transport context is available.
      503    18476        */
      504    18477
      505    18478        /*E*     ERROR: KNA-E$NORTE
PL6.E3A0      #001=KNA$OPEN File=KNA$APE.:E05TSI                                 WED 07/30/97 00:55 Page:75   
      506    18479                 MESSAGE: No network connection is available
      507    18480        */
      508    18481
      509    18482
      510    18483        /*
      511    18484             Try again when a Circular Queue frees up causing this user to run
      512    18485        again.
      513    18486        */
      514    18487
      515    18488    4                     SELECT (%KN_ERR_NOQ,%KN_ERR_NOQ2);

      516    18489    4                     KNA$SSN.FLAGS.CQ = '1'B;

  18489   2 000410  ECC7 0076                            LDB,B6   SSN$,AUTO
          2 000412  8906                                 LBT,'2000'X       ,B6
          2 000413       2000

      517    18490    4                     CALL KNA$REG_USER(%GH_EVCBL,SSN$);

  18490   2 000414  EBF0 0019                            LAB,B6   25,IMO
          2 000416  DBC7 0076                            LAB,B5   SSN$,AUTO
          2 000418  DFC7 00C4                            STB,B5   WINDOW+19,AUTO
          2 00041A  EFC7 00C2                            STB,B6   WINDOW+17,AUTO
          2 00041C  BBC7 00C2                            LAB,B3   WINDOW+17,AUTO
          2 00041E  CBF0 0200                            LAB,B4   512,IMO
          2 000420  E380 0000 0000  xent                 LNJ,B6   KNA$REG_USER
          2 000423       0001                            DC       s:18491,PREL

      518    18491    4                     KNA$SSN.FLAGS.CQ = '0'B;

  18491   2 000424  ECC7 0076                            LDB,B6   SSN$,AUTO
          2 000426  8806                                 LBF,'2000'X       ,B6
          2 000427       2000
          2 000428  0F81 FF8C                            B        s:18446,PREL

      519    18492
      520    18493    4                     SELECT (ELSE);
PL6.E3A0      #001=KNA$OPEN File=KNA$APE.:E05TSI                                 WED 07/30/97 00:55 Page:76   

      521    18494    4                CALL SCREECH (SCR_UNEXP);

  18494   2 00042A  BB80 0000 0003  03                   LAB,B3   +3
          2 00042D  CBF0 0100                            LAB,B4   256,IMO
          2 00042F  E380 0000 0000  xent                 LNJ,B6   SCREECH
          2 000432       0001                            DC       s:18495,PREL

      522    18495    4                ALTRETURN;

  18495   2 000433  C380 0000 0000  xent                 LNJ,B4   X6A_AALT

      523    18496
      524    18497    4                     END /* End cases */;

      525    18498    3                END;                       /* DO WHILE ('1'B);                   */

      526    18499        %EJECT;
PL6.E3A0      #001=KNA$OPEN File=KNA$APE.:E05TSI                                 WED 07/30/97 00:55 Page:77   
      527    18500        /*
      528    18501             We have made a good contact with Session and he is attempting to
      529    18502        establish the network connection for us.  We must now REG the user and
      530    18503        wait for Session to tell us about success or failure.
      531    18504        */
      532    18505
      533    18506    2           CALL KNA$REG_USER(%GH_EVCW,SSN$);

  18506   2 000436  EBF0 0015                            LAB,B6   21,IMO
          2 000438  DBC7 0076                            LAB,B5   SSN$,AUTO
          2 00043A  DFC7 00C4                            STB,B5   WINDOW+19,AUTO
          2 00043C  EFC7 00C2                            STB,B6   WINDOW+17,AUTO
          2 00043E  BBC7 00C2                            LAB,B3   WINDOW+17,AUTO
          2 000440  CBF0 0200                            LAB,B4   512,IMO
          2 000442  E380 0000 0000  xent                 LNJ,B6   KNA$REG_USER
          2 000445       0001                            DC       s:18507,PREL

      534    18507    2           IF KNA$SSN.FLAGS.SSNERR = '1'B

  18507   2 000446  ECC7 0076                            LDB,B6   SSN$,AUTO
          2 000448  8286                                 LB,'0800'X        ,B6
          2 000449       0800
          2 00044A  0581 000F                            BBF      s:18516,PREL

      535    18508    3           THEN DO;

      536    18509    3                ERROR = KNA$SSN.ERROR;

  18509   2 00044C  8CC6 0001                            LDI      1,B6
          2 00044E  DCC7 0006                            LDB,B5   @ERROR,AUTO
          2 000450  8D05                                 SDI      ,B5

      537    18510
      538    18511    3                IF KNA$SSN.STATE = %KNA_STATE_WSSNINIT#

  18511   2 000451  ECC7 0076                            LDB,B6   SSN$,AUTO
          2 000453  D846 0013                            LDR,R5   19,B6
PL6.E3A0      #001=KNA$OPEN File=KNA$APE.:E05TSI                                 WED 07/30/97 00:55 Page:78   
          2 000455  5D01                                 CMV,R5   1
          2 000456  0901 FF95                            BE       s:18466,PREL

      539    18512    3                THEN GOTO UNLOCK_N_ALTRET; /* no INIT_ACK, or a failure one.     */
      540    18513    3                GOTO CLOSE_IT;   /* probably a disconnect right after INIT_ACK   */

  18513   2 000458  0F81 0325                            B        s:18718,PREL

      541    18514    3                END;
      542    18515
      543    18516    2           KNA$SSN.RLCID = KN$LDCT.RLCID;

  18516   2 00045A  DCC7 0037                            LDB,B5   KN$NETPARM,AUTO
          2 00045C  8CC5 0001                            LDI      1,B5
          2 00045E  8D46 000F                            SDI      15,B6

      544    18517
      545    18518        /*
      546    18519             We now have a valid network connection for this user.  Send an
      547    18520        OPEN message to the other end and wait for a positive reply before
      548    18521        returning to this user.  Then we are truly open.
      549    18522        */
      550    18523
      551    18524    2           RWPARM = KNA_RWPARM_CON;

  18524   2 000460  AB80 0000 0000  xsym                 LAB,B2   KNA_RWPARM_CON
          2 000463  2C00                                 LDV,R2   0
          2 000464  6C52                                 LDV,R6   82
          2 000465  BB87                                 LAB,B3   ,AUTO
          2 000466  3C18                                 LDV,R3   24
          2 000467  0008                                 MMM

      552    18525    2           CALL KNA$FCNOU(%KV_VDO_FNC_OPNSSN_RQS,KNA$SSN,RWPARM,ERR);

  18525   2 000468  EBF0 0010                            LAB,B6   16,IMO
          2 00046A  DBC7 006F                            LAB,B5   ERR,AUTO
          2 00046C  DFC7 00C8                            STB,B5   WINDOW+23,AUTO
PL6.E3A0      #001=KNA$OPEN File=KNA$APE.:E05TSI                                 WED 07/30/97 00:55 Page:79   
          2 00046E  CBC7 000C                            LAB,B4   RWPARM,AUTO
          2 000470  CFC7 00C6                            STB,B4   WINDOW+21,AUTO
          2 000472  ACC7 0076                            LDB,B2   SSN$,AUTO
          2 000474  AFC7 00C4                            STB,B2   WINDOW+19,AUTO
          2 000476  EFC7 00C2                            STB,B6   WINDOW+17,AUTO
          2 000478  BBC7 00C2                            LAB,B3   WINDOW+17,AUTO
          2 00047A  CBF0 0400                            LAB,B4   1024,IMO
          2 00047C  E380 0000 0000  xent                 LNJ,B6   KNA$FCNOU
          2 00047F       0001                            DC       s:18526,PREL

      553    18526    2           KNA$SSN.STATE = %KNA_STATE_ACTIVE#;

  18526   2 000480  ECC7 0076                            LDB,B6   SSN$,AUTO
          2 000482  6C03                                 LDV,R6   3
          2 000483  EF46 0013                            STR,R6   19,B6

      554    18527                %UNLOCK (G=KNA_LNKSSN);

  18532   2 000485  BB80 0000 0001  03                   LAB,B3   +1
          2 000488  CBF0 0100                            LAB,B4   256,IMO
          2 00048A  E380 0000 0000  xent                 LNJ,B6   GHH$UNLOCK
          2 00048D       0001                            DC       s:18541,PREL

      555    18534    2           END/*do if opndcb$ = nil*/;

      556    18535
      557    18536        %EJECT;
PL6.E3A0      #001=KNA$OPEN File=KNA$APE.:E05TSI                                 WED 07/30/97 00:55 Page:80   
      558    18537        /*   Whether we had to get a new set of SSN/LDCT contexts or not we
      559    18538        now come here to finish the final tidbits of DCB opening.
      560    18539        */
      561    18540
      562    18541    1      KNA$SSN.EVENT = MYDCB.EVENT;

  18541   2 00048E  ECC7 0076                            LDB,B6   SSN$,AUTO
          2 000490  DCC7 0074                            LDB,B5   DCB$,AUTO
          2 000492  E845 0025                            LDR,R6   37,B5
          2 000494  EF46 0016                            STR,R6   22,B6

      563    18542    1      MYDCB.SSN$ = SSN$;

  18542   2 000496  ECC7 0076                            LDB,B6   SSN$,AUTO
          2 000498  EFC5 0030                            STB,B6   48,B5

      564    18543    1      MYDCB.DDEV.CG = KNA$SSN.FLAGS.CG;

  18543   2 00049A  CCC7 0076                            LDB,B4   SSN$,AUTO
          2 00049C  E804                                 LDR,R6   ,B4
          2 00049D  6049                                 SOR,R6   9
          2 00049E  EAC5 0003                            SRM,R6,'0008'X    3,B5
          2 0004A0       0008

      565    18544    1      MYDCB.STRM = STRM;

  18544   2 0004A1  E847 0073                            LDR,R6   STRM,AUTO
          2 0004A3  EAC5 0002                            SRM,R6,'00FF'X    2,B5
          2 0004A5       00FF

      566    18545    1      MYDCB.FCD = '1'B;

  18545   2 0004A6  8945 001F                            LBT,'4000'X       31,B5
  18545   2 0004A8       4000

      567    18546    1      MYDCB.FCI = '1'B;

PL6.E3A0      #001=KNA$OPEN File=KNA$APE.:E05TSI                                 WED 07/30/97 00:55 Page:81   
  18546   2 0004A9  8945 001F                            LBT,'8000'X       31,B5
  18546   2 0004AB       8000

      568    18547    1      MYDCB.FFLG = 'FF'X;

  18547   2 0004AC  8945 0003                            LBT,'FF00'X       3,B5
  18547   2 0004AE       FF00

      569    18548
      570    18549           %LOCK (G=KNA_LNKSSN);

  18554   2 0004AF  BB80 0000 0001  03                   LAB,B3   +1
          2 0004B2  CBF0 0100                            LAB,B4   256,IMO
          2 0004B4  E380 0000 0000  xent                 LNJ,B6   GHH$LOCK
          2 0004B7       0001                            DC       s:18556,PREL

      571    18556    1      IF NEWSTREAM AND STRM ~= 1 AND UCSTREAM

  18556   2 0004B8  89C7 006C                            CMZ      NEWSTREAM,AUTO
          2 0004BA  0881 0144                            BAGE     s:18622,PREL
          2 0004BC  E847 0073                            LDR,R6   STRM,AUTO
          2 0004BE  6D01                                 CMV,R6   1
          2 0004BF  0901 013F                            BE       s:18622,PREL
          2 0004C1  89C7 006D                            CMZ      UCSTREAM,AUTO
          2 0004C3  0881 013B                            BAGE     s:18622,PREL

      572    18557    2      THEN DO;

      573    18558    2           RWPARM = KNA_RWPARM_CON;

  18558   2 0004C5  AB80 0000 0000  xsym                 LAB,B2   KNA_RWPARM_CON
          2 0004C8  2C00                                 LDV,R2   0
          2 0004C9  6C52                                 LDV,R6   82
          2 0004CA  BB87                                 LAB,B3   ,AUTO
          2 0004CB  3C18                                 LDV,R3   24
          2 0004CC  0008                                 MMM

PL6.E3A0      #001=KNA$OPEN File=KNA$APE.:E05TSI                                 WED 07/30/97 00:55 Page:82   
      574    18559    2           RWPARM.STR = 1;

  18559   2 0004CD  6C01                                 LDV,R6   1
          2 0004CE  EAC7 0029                            SRM,R6,'00FF'X    RWPARM+29,AUTO
          2 0004D0       00FF

      575    18560    2           RWPARM.STRID = STRM;

  18560   2 0004D1  D847 0073                            LDR,R5   STRM,AUTO
          2 0004D3  D7C7 0028                            STH,R5   RWPARM+28,AUTO

      576    18561    2           CALL KNA$FCNOU(%KV_VDO_FNC_DCLSTR,KNA$SSN,RWPARM,ERR);

  18561   2 0004D5  EBF0 0008                            LAB,B6   8,IMO
          2 0004D7  DBC7 006F                            LAB,B5   ERR,AUTO
          2 0004D9  DFC7 00C8                            STB,B5   WINDOW+23,AUTO
          2 0004DB  CBC7 000C                            LAB,B4   RWPARM,AUTO
          2 0004DD  CFC7 00C6                            STB,B4   WINDOW+21,AUTO
          2 0004DF  ACC7 0076                            LDB,B2   SSN$,AUTO
          2 0004E1  AFC7 00C4                            STB,B2   WINDOW+19,AUTO
          2 0004E3  EFC7 00C2                            STB,B6   WINDOW+17,AUTO
          2 0004E5  BBC7 00C2                            LAB,B3   WINDOW+17,AUTO
          2 0004E7  CBF0 0400                            LAB,B4   1024,IMO
          2 0004E9  E380 0000 0000  xent                 LNJ,B6   KNA$FCNOU
          2 0004EC       0001                            DC       s:18562,PREL

      577    18562    2           RWPARM.STR = STRM;

  18562   2 0004ED  E847 0073                            LDR,R6   STRM,AUTO
          2 0004EF  EAC7 0029                            SRM,R6,'00FF'X    RWPARM+29,AUTO
          2 0004F1       00FF

      578    18563    2           IF ADDR(VLP_WINDOW)~= ADDR(NIL)

  18563   2 0004F2  ECC7 000A                            LDB,B6   @VLP_WINDOW,AUTO
          2 0004F4  8DD6                                 CMN      B6
          2 0004F5  0901 001A                            BE       s:18569,PREL
PL6.E3A0      #001=KNA$OPEN File=KNA$APE.:E05TSI                                 WED 07/30/97 00:55 Page:83   

      579    18564    3           THEN DO;

      580    18565    3                WINDOW = VLP_WINDOW;

  18565   2 0004F7  AB86                                 LAB,B2   ,B6
          2 0004F8  2C00                                 LDV,R2   0
          2 0004F9  6C20                                 LDV,R6   32
          2 0004FA  BBC7 00B1                            LAB,B3   WINDOW,AUTO
          2 0004FC  3C00                                 LDV,R3   0
          2 0004FD  0008                                 MMM

      581    18566    3                CALL KNA$CONV_STR(WINDOW,ERROR);

  18566   2 0004FE  DCC7 0006                            LDB,B5   @ERROR,AUTO
          2 000500  DFC7 00C4                            STB,B5   WINDOW+19,AUTO
          2 000502  CBC7 00B1                            LAB,B4   WINDOW,AUTO
          2 000504  CFC7 00C2                            STB,B4   WINDOW+17,AUTO
          2 000506  BBC7 00C2                            LAB,B3   WINDOW+17,AUTO
          2 000508  CBF0 0200                            LAB,B4   512,IMO
          2 00050A  E380 0000 0000  xent                 LNJ,B6   KNA$CONV_STR
          2 00050D       0001                            DC       s:18567,PREL

      582    18567    3                END;

  18567   2 00050E  0F81 000A                            B        s:18570,PREL

      583    18568    2           ELSE
      584    18569    2                WINDOW = KNA_WINDOW;

  18569   2 000510  AB80 0000 0000  xsym                 LAB,B2   KNA_WINDOW
          2 000513  2C00                                 LDV,R2   0
          2 000514  6C20                                 LDV,R6   32
          2 000515  BBC7 00B1                            LAB,B3   WINDOW,AUTO
          2 000517  3C00                                 LDV,R3   0
          2 000518  0008                                 MMM

PL6.E3A0      #001=KNA$OPEN File=KNA$APE.:E05TSI                                 WED 07/30/97 00:55 Page:84   
      585    18570    2           RWPARM.MSG$ = ADDR(WINDOW);

  18570   2 000519  EBC7 00B1                            LAB,B6   WINDOW,AUTO
          2 00051B  EFC7 000C                            STB,B6   RWPARM,AUTO

      586    18571    2           RWPARM.MSGSZ = SIZEC(WINDOW);

  18571   2 00051D  6C20                                 LDV,R6   32
          2 00051E  EF47 000E                            STR,R6   RWPARM+2,AUTO

      587    18572    2           RWPARM.V$ = ADDR(KNA_WINDOW_TL);

  18572   2 000520  DB80 0000 0000  xsym                 LAB,B5   KNA_WINDOW_TL
          2 000523  DFC7 002D                            STB,B5   RWPARM+33,AUTO

      588    18573    2           RWPARM.VSZ = SIZEC (KNA_WINDOW_TL);

  18573   2 000525  5C02                                 LDV,R5   2
          2 000526  DF47 0031                            STR,R5   RWPARM+37,AUTO

      589    18574    2           IF ADDR(VLP_WINDOW) ~= ADDR(NIL)

  18574   2 000528  CCC7 000A                            LDB,B4   @VLP_WINDOW,AUTO
          2 00052A  8DD4                                 CMN      B4
          2 00052B  0981 000A                            BNE      s:18576,PREL
          2 00052D  BCC7 0074                            LDB,B3   DCB$,AUTO
          2 00052F  C843 001F                            LDR,R4   31,B3
          2 000531  C570 00FF                            AND,R4   255,IMO
          2 000533  4D02                                 CMV,R4   2
          2 000534  0981 0019                            BNE      s:18577,PREL

      590    18575    2             OR MYDCB.ORG = %G_ORG_FORM#
      591    18576    2           THEN CALL KNA$FCNOU(%KV_VDO_FNC_PRM_SET,KNA$SSN,RWPARM,ERR);

  18576   2 000536  BBF0 0013                            LAB,B3   19,IMO
          2 000538  ABC7 006F                            LAB,B2   ERR,AUTO
          2 00053A  AFC7 00C8                            STB,B2   WINDOW+23,AUTO
PL6.E3A0      #001=KNA$OPEN File=KNA$APE.:E05TSI                                 WED 07/30/97 00:55 Page:85   
          2 00053C  9BC7 000C                            LAB,B1   RWPARM,AUTO
          2 00053E  9FC7 00C6                            STB,B1   WINDOW+21,AUTO
          2 000540  ECC7 0076                            LDB,B6   SSN$,AUTO
          2 000542  EFC7 00C4                            STB,B6   WINDOW+19,AUTO
          2 000544  BFC7 00C2                            STB,B3   WINDOW+17,AUTO
          2 000546  BBC7 00C2                            LAB,B3   WINDOW+17,AUTO
          2 000548  CBF0 0400                            LAB,B4   1024,IMO
          2 00054A  E380 0000 0000  xent                 LNJ,B6   KNA$FCNOU
          2 00054D       0001                            DC       s:18577,PREL

      592    18577    2           RWPARM = KNA_RWPARM_CON;

  18577   2 00054E  AB80 0000 0000  xsym                 LAB,B2   KNA_RWPARM_CON
          2 000551  2C00                                 LDV,R2   0
          2 000552  6C52                                 LDV,R6   82
          2 000553  BB87                                 LAB,B3   ,AUTO
          2 000554  3C18                                 LDV,R3   24
          2 000555  0008                                 MMM

      593    18578    2           RWPARM.STR = STRM;

  18578   2 000556  E847 0073                            LDR,R6   STRM,AUTO
          2 000558  EAC7 0029                            SRM,R6,'00FF'X    RWPARM+29,AUTO
          2 00055A       00FF

      594    18579    2           IF MYDCB.ORG = %G_ORG_FORM#

  18579   2 00055B  ECC7 0074                            LDB,B6   DCB$,AUTO
          2 00055D  D846 001F                            LDR,R5   31,B6
          2 00055F  D570 00FF                            AND,R5   255,IMO
          2 000561  5D02                                 CMV,R5   2
          2 000562  0981 0006                            BNE      s:18582,PREL

      595    18580    2           THEN
      596    18581    2                RWPARM.ORG = %KV#VD_ORG_FORM;

  18581   2 000564  4C04                                 LDV,R4   4
PL6.E3A0      #001=KNA$OPEN File=KNA$APE.:E05TSI                                 WED 07/30/97 00:55 Page:86   
          2 000565  C7C7 0028                            STH,R4   RWPARM+28,AUTO
          2 000567  0F81 0014                            B        s:18590,PREL

      597    18582    2           ELSE IF MYDCB.ORG = %G_ORG_X364#

  18582   2 000569  5D07                                 CMV,R5   7
          2 00056A  0981 0006                            BNE      s:18585,PREL

      598    18583    2                THEN
      599    18584    2                     RWPARM.ORG = %KV#VD_ORG_X364;

  18584   2 00056C  4C02                                 LDV,R4   2
          2 00056D  C7C7 0028                            STH,R4   RWPARM+28,AUTO
          2 00056F  0F81 000C                            B        s:18590,PREL

      600    18585    2                ELSE IF MYDCB.ORG = %G_ORG_SE#

  18585   2 000571  5D06                                 CMV,R5   6
          2 000572  0981 0006                            BNE      s:18589,PREL

      601    18586    2                     THEN
      602    18587    2                          RWPARM.ORG = %KV#VD_ORG_SE;

  18587   2 000574  4C05                                 LDV,R4   5
          2 000575  C7C7 0028                            STH,R4   RWPARM+28,AUTO
          2 000577  0F81 0004                            B        s:18590,PREL

      603    18588    2                     ELSE
      604    18589    2                          RWPARM.ORG = %KV#VD_ORG_UR;

  18589   2 000579  4C01                                 LDV,R4   1
          2 00057A  C7C7 0028                            STH,R4   RWPARM+28,AUTO

      605    18590    2           IOP$ = ADDR(NIL);

  18590   2 00057C  DB80 0000 0000                       LAB,B5   0
          2 00057F  DFC7 0071                            STB,B5   IOP$,AUTO
PL6.E3A0      #001=KNA$OPEN File=KNA$APE.:E05TSI                                 WED 07/30/97 00:55 Page:87   

      606    18591    2           CALL KNA$GETIOP(IOP$)

  18591   2 000581  CBC7 0071                            LAB,B4   IOP$,AUTO
          2 000583  CFC7 00C2                            STB,B4   WINDOW+17,AUTO
          2 000585  BBC7 00C2                            LAB,B3   WINDOW+17,AUTO
          2 000587  CBF0 0100                            LAB,B4   256,IMO
          2 000589  E380 0000 0000  xent                 LNJ,B6   KNA$GETIOP
          2 00058C       0010                            DC       s:18598,PREL

      607    18592    3           WHENRETURN DO ;

      608    18593    3                RWPARM.MRKTYP = %KV_VDOMRKTYP_ENDACK;

  18593   2 00058D  6C01                                 LDV,R6   1
          2 00058E  E7C7 0029                            STH,R6   RWPARM+29,AUTO

      609    18594    3                KNA$SSN.IOPQ$ = IOP$;

  18594   2 000590  ECC7 0071                            LDB,B6   IOP$,AUTO
          2 000592  DCC7 0076                            LDB,B5   SSN$,AUTO
          2 000594  EFC5 000B                            STB,B6   11,B5

      610    18595    3                KNA$SSN.FLAGS.RRRPND = '1'B;

  18595   2 000596  ECC7 0076                            LDB,B6   SSN$,AUTO
          2 000598  8906                                 LBT,'0200'X       ,B6
          2 000599       0200

      611    18596    3                END;

  18596   2 00059A  0F81 0009                            B        s:18601,PREL

      612    18597    3           WHENALTRETURN DO;

      613    18598    3                ERROR = ENO_IOP;

PL6.E3A0      #001=KNA$OPEN File=KNA$APE.:E05TSI                                 WED 07/30/97 00:55 Page:88   
  18598   2 00059C  8C80 0000 0000  01                   LDI      ENO_IOP
          2 00059F  ECC7 0006                            LDB,B6   @ERROR,AUTO
          2 0005A1  8D06                                 SDI      ,B6

      614    18599    3                GOTO KNA_CLOSE;

  18599   2 0005A2  0F81 0079                            B        s:18629,PREL

      615    18600    3                END;
      616    18601    2           CALL KNA$FCNOU(%KV_VDO_FNC_OPNSTR,KNA$SSN,RWPARM,ERR);

  18601   2 0005A4  EBF0 0021                            LAB,B6   33,IMO
          2 0005A6  DBC7 006F                            LAB,B5   ERR,AUTO
          2 0005A8  DFC7 00C8                            STB,B5   WINDOW+23,AUTO
          2 0005AA  CBC7 000C                            LAB,B4   RWPARM,AUTO
          2 0005AC  CFC7 00C6                            STB,B4   WINDOW+21,AUTO
          2 0005AE  BCC7 0076                            LDB,B3   SSN$,AUTO
          2 0005B0  BFC7 00C4                            STB,B3   WINDOW+19,AUTO
          2 0005B2  EFC7 00C2                            STB,B6   WINDOW+17,AUTO
          2 0005B4  BBC7 00C2                            LAB,B3   WINDOW+17,AUTO
          2 0005B6  CBF0 0400                            LAB,B4   1024,IMO
          2 0005B8  E380 0000 0000  xent                 LNJ,B6   KNA$FCNOU
          2 0005BB       0001                            DC       s:18602,PREL

      617    18602    2           IF(IOP$ ~= ADDR(NIL))

  18602   2 0005BC  8DC7 0071                            CMN      IOP$,AUTO
          2 0005BE  0901 0040                            BE       s:18622,PREL

      618    18603    3           THEN DO;

      619    18604    3                CALL KNA$REG_USER(%GH_EVCW,SSN$)

  18604   2 0005C0  EBF0 0015                            LAB,B6   21,IMO
          2 0005C2  DBC7 0076                            LAB,B5   SSN$,AUTO
          2 0005C4  DFC7 00C4                            STB,B5   WINDOW+19,AUTO
          2 0005C6  EFC7 00C2                            STB,B6   WINDOW+17,AUTO
PL6.E3A0      #001=KNA$OPEN File=KNA$APE.:E05TSI                                 WED 07/30/97 00:55 Page:89   
          2 0005C8  BBC7 00C2                            LAB,B3   WINDOW+17,AUTO
          2 0005CA  CBF0 0200                            LAB,B4   512,IMO
          2 0005CC  E380 0000 0000  xent                 LNJ,B6   KNA$REG_USER
          2 0005CF       0009                            DC       s:18609,PREL

      620    18605    4                WHENRETURN DO;

      621    18606    4                     ERROR = IOP$->KN$IOP.ERRCODE;

  18606   2 0005D0  ECC7 0071                            LDB,B6   IOP$,AUTO
          2 0005D2  8C86                                 LDI      ,B6
          2 0005D3  DCC7 0006                            LDB,B5   @ERROR,AUTO
          2 0005D5  8D05                                 SDI      ,B5

      622    18607    4                     END;

  18607   2 0005D6  0F81 0008                            B        s:18611,PREL

      623    18608    4                WHENALTRETURN DO;

      624    18609    4                     ERROR = KNA$SSN.ERROR;

  18609   2 0005D8  ECC7 0076                            LDB,B6   SSN$,AUTO
          2 0005DA  8CC6 0001                            LDI      1,B6
          2 0005DC  DCC7 0006                            LDB,B5   @ERROR,AUTO
          2 0005DE  8D05                                 SDI      ,B5

      625    18610    4                     END;

      626    18611    3                KNA$SSN.IOPQ$ = ADDR(NIL);

  18611   2 0005DF  EB80 0000 0000                       LAB,B6   0
          2 0005E2  CCC7 0076                            LDB,B4   SSN$,AUTO
          2 0005E4  EFC4 000B                            STB,B6   11,B4

      627    18612    3                CALL KNA$RLSIOP(IOP$);

PL6.E3A0      #001=KNA$OPEN File=KNA$APE.:E05TSI                                 WED 07/30/97 00:55 Page:90   
  18612   2 0005E6  EBC7 0071                            LAB,B6   IOP$,AUTO
          2 0005E8  EFC7 00C2                            STB,B6   WINDOW+17,AUTO
          2 0005EA  BBC7 00C2                            LAB,B3   WINDOW+17,AUTO
          2 0005EC  CBF0 0100                            LAB,B4   256,IMO
          2 0005EE  E380 0000 0000  xent                 LNJ,B6   KNA$RLSIOP
          2 0005F1       0001                            DC       s:18613,PREL

      628    18613    3                IF (ERROR ~= '0'B)

  18613   2 0005F2  ECC7 0006                            LDB,B6   @ERROR,AUTO
          2 0005F4  DB80 0000 0000  03                   LAB,B5   0
          2 0005F7  5C01                                 LDV,R5   1
          2 0005F8  0022                                 ACM      ;
          2 0005F9       4406 0000                                ALPHANUM(0,B6,,4,FILL),;
          2 0005FB       4005 0000                                ALPHANUM(0,B5,,R5,FILL)
          2 0005FD  5301 001E                            CBNE     s:18629,PREL

      629    18614    3                THEN GOTO KNA_CLOSE;
      630    18615    3                END;

      631    18616    2           END;

      632    18617           %UNLOCK (G=KNA_LNKSSN);

  18622   2 0005FF  BB80 0000 0001  03                   LAB,B3   +1
          2 000602  CBF0 0100                            LAB,B4   256,IMO
          2 000604  E380 0000 0000  xent                 LNJ,B6   GHH$UNLOCK
          2 000607       0001                            DC       s:18625,PREL

      633    18624
      634    18625    1      MYDCB.RLCID = KNA$SSN.RLCID;

  18625   2 000608  ECC7 0076                            LDB,B6   SSN$,AUTO
          2 00060A  8CC6 000F                            LDI      15,B6
          2 00060C  DCC7 0074                            LDB,B5   DCB$,AUTO
          2 00060E  8D45 002D                            SDI      45,B5

PL6.E3A0      #001=KNA$OPEN File=KNA$APE.:E05TSI                                 WED 07/30/97 00:55 Page:91   
      635    18626    1      RETURN;

  18626   2 000610  C380 0000 0000  xent                 LNJ,B4   X6A_ARET

      636    18627        %EJECT;
PL6.E3A0      #001=KNA$OPEN File=KNA$APE.:E05TSI                                 WED 07/30/97 00:55 Page:92   
      637    18628    1   KNA$TRUNC: ENTRY (DCBNUMBER,ERROR) ALTRET;

  18628   2 000613  D380 0000 0000  xent KNA$TRUNC       LNJ,B5   X6A_AUTO_N
          2 000616       00CE 0004                       DC       206,4

      638    18629    1      CLOSING = '0'B;

  18629   2 000618  8747 006B                            CL       CLOSING,AUTO

      639    18630    1      GOTO MAINLINE;

  18630   2 00061A  0F81 000E                            B        s:18637,PREL

  18629   2                              KNA_CLOSE       null
      640    18631
      641    18632    1   KNA_CLOSE: ;
      642    18633    1      CLOSING = '1'B;

  18633   2 00061C  8947 006B            KNA_CLOSE       LBT,'8000'X       CLOSING,AUTO
  18633   2 00061E       8000

      643    18634    1      GOTO INTERNAL_CLOSE;

  18634   2 00061F  0F81 009A                            B        s:18680,PREL

      644    18635
      645    18636    1   KNA$CLOSE: ENTRY (DCBNUMBER,ERROR) ALTRET;

  18636   2 000621  D380 0000 0000  xent KNA$CLOSE       LNJ,B5   X6A_AUTO_N
          2 000624       00CE 0004                       DC       206,4

      646    18637    1      CLOSING = '1'B;

  18637   2 000626  8947 006B                            LBT,'8000'X       CLOSING,AUTO
  18637   2 000628       8000

  18637   2                              MAINLINE        null
PL6.E3A0      #001=KNA$OPEN File=KNA$APE.:E05TSI                                 WED 07/30/97 00:55 Page:93   
      647    18638    1   MAINLINE: ;
      648    18639
      649    18640    1      DCB$ = G$ROS.DCBPTR$->G$DCBTABLE(DCBNUMBER);

  18640   2 000629  EC80 0000 0000  xsym MAINLINE        LDB,B6   G$ROS$
          2 00062C  DC86                                 LDB,B5   ,B6
          2 00062D  CCC7 0004                            LDB,B4   @DCBNUMBER,AUTO
          2 00062F  B804                                 LDR,R3   ,B4
          2 000630  BCB5                                 LDB,B3   ,B5,R3
          2 000631  BFC7 0074                            STB,B3   DCB$,AUTO

      650    18641    1      SSN$ = MYDCB.SSN$;

  18641   2 000633  ACC3 0030                            LDB,B2   48,B3
          2 000635  AFC7 0076                            STB,B2   SSN$,AUTO

      651    18642    1      ERROR = '0'B;                        /* so we know whether to ALTRETURN    */

  18642   2 000637  DCC7 0006                            LDB,B5   @ERROR,AUTO
          2 000639  8705                                 CL       ,B5
          2 00063A  8745 0001                            CL       1,B5

      652    18643
      653    18644    1      IF NOT MYDCB.FCD                     /* Dcb is closed                      */

  18644   2 00063C  82C3 001F                            LB,'4000'X        31,B3
  18644   2 00063E       4000
          2 00063F  0501 0008                            BBT      s:18658,PREL

      654    18645    2      THEN DO;

      655    18646    2           ERROR = EDCB_CLOSED;

  18646   2 000641  8C80 0000 0010  01                   LDI      EDCB_CLOSED
          2 000644  8D05                                 SDI      ,B5

      656    18647    2           ALTRETURN;
PL6.E3A0      #001=KNA$OPEN File=KNA$APE.:E05TSI                                 WED 07/30/97 00:55 Page:94   

  18647   2 000645  C380 0000 0000  xent                 LNJ,B4   X6A_AALT

      657    18648    2           END;
      658    18649        /*E* ERROR: KNA-E$DCBCLOSED
      659    18650             MESSAGE: That DCB is already closed.
      660    18651        */
      661    18652
      662    18653           %LOCK (G=KNA_LNKSSN);

  18658   2 000648  BB80 0000 0001  03                   LAB,B3   +1
          2 00064B  CBF0 0100                            LAB,B4   256,IMO
          2 00064D  E380 0000 0000  xent                 LNJ,B6   GHH$LOCK
          2 000650       0001                            DC       s:18662,PREL

      663    18660
      664    18661                       /* If there is a NOWAIT request kill it if it is for this dcb  */
      665    18662    1      IF KNA$SSN.IOPRD$ ~= ADDR(NIL)

  18662   2 000651  ECC7 0076                            LDB,B6   SSN$,AUTO
          2 000653  8DC6 000D                            CMN      13,B6
          2 000655  0901 0060                            BE       s:18680,PREL

      666    18663    1      THEN
      667    18664    1           IF KNA$SSN.IOPRD$->KN$IOP.DCB$ = DCB$

  18664   2 000657  DCC6 000D                            LDB,B5   13,B6
          2 000659  CCC5 000A                            LDB,B4   10,B5
          2 00065B  CDC7 0074                            CMB,B4   DCB$,AUTO
          2 00065D  0981 0058                            BNE      s:18680,PREL

      668    18665    2           THEN DO;

      669    18666    2                RWPARM = KNA_RWPARM_CON;

  18666   2 00065F  AB80 0000 0000  xsym                 LAB,B2   KNA_RWPARM_CON
          2 000662  2C00                                 LDV,R2   0
PL6.E3A0      #001=KNA$OPEN File=KNA$APE.:E05TSI                                 WED 07/30/97 00:55 Page:95   
          2 000663  6C52                                 LDV,R6   82
          2 000664  BB87                                 LAB,B3   ,AUTO
          2 000665  3C18                                 LDV,R3   24
          2 000666  0008                                 MMM

      670    18667    2                RWPARM.MRKTYP = %KV_VDOMRKTYP_ENDACK;

  18667   2 000667  6C01                                 LDV,R6   1
          2 000668  E7C7 0029                            STH,R6   RWPARM+29,AUTO

      671    18668    2                RWPARM.STR = MYDCB.STRM;

  18668   2 00066A  ECC7 0074                            LDB,B6   DCB$,AUTO
          2 00066C  D846 0002                            LDR,R5   2,B6
          2 00066E  DAC7 0029                            SRM,R5,'00FF'X    RWPARM+29,AUTO
          2 000670       00FF

      672    18669    2                CALL KNA$FCNOU(%KV_VDO_FNC_RQSDAT,KNA$SSN,RWPARM,ERR)

  18669   2 000671  DBF0 0016                            LAB,B5   22,IMO
          2 000673  CBC7 006F                            LAB,B4   ERR,AUTO
          2 000675  CFC7 00C8                            STB,B4   WINDOW+23,AUTO
          2 000677  ABC7 000C                            LAB,B2   RWPARM,AUTO
          2 000679  AFC7 00C6                            STB,B2   WINDOW+21,AUTO
          2 00067B  9CC7 0076                            LDB,B1   SSN$,AUTO
          2 00067D  9FC7 00C4                            STB,B1   WINDOW+19,AUTO
          2 00067F  DFC7 00C2                            STB,B5   WINDOW+17,AUTO
          2 000681  BBC7 00C2                            LAB,B3   WINDOW+17,AUTO
          2 000683  CBF0 0400                            LAB,B4   1024,IMO
          2 000685  E380 0000 0000  xent                 LNJ,B6   KNA$FCNOU
          2 000688       0015                            DC       s:18674,PREL

      673    18670    3                WHENRETURN DO;

      674    18671    3                     KNA$SSN.FLAGS.RRRPND = '1'B;

  18671   2 000689  ECC7 0076                            LDB,B6   SSN$,AUTO
PL6.E3A0      #001=KNA$OPEN File=KNA$APE.:E05TSI                                 WED 07/30/97 00:55 Page:96   
          2 00068B  8906                                 LBT,'0200'X       ,B6
          2 00068C       0200

      675    18672    3                     CALL KNA$REG_USER(%GH_EVCW,SSN$);

  18672   2 00068D  EBF0 0015                            LAB,B6   21,IMO
          2 00068F  DBC7 0076                            LAB,B5   SSN$,AUTO
          2 000691  DFC7 00C4                            STB,B5   WINDOW+19,AUTO
          2 000693  EFC7 00C2                            STB,B6   WINDOW+17,AUTO
          2 000695  BBC7 00C2                            LAB,B3   WINDOW+17,AUTO
          2 000697  CBF0 0200                            LAB,B4   512,IMO
          2 000699  E380 0000 0000  xent                 LNJ,B6   KNA$REG_USER
          2 00069C       0001                            DC       s:18674,PREL

      676    18673    3                     END;

      677    18674    2                IF KNA$SSN.IOPRD$ ~= ADDR(NIL)

  18674   2 00069D  ECC7 0076                            LDB,B6   SSN$,AUTO
          2 00069F  8DC6 000D                            CMN      13,B6
          2 0006A1  0901 000D                            BE       s:18677,PREL

      678    18675    2                THEN
      679    18676    2                     CALL KNA$RLSIOP(KNA$SSN.IOPRD$);

  18676   2 0006A3  DBC6 000D                            LAB,B5   13,B6
          2 0006A5  DFC7 00C2                            STB,B5   WINDOW+17,AUTO
          2 0006A7  BBC7 00C2                            LAB,B3   WINDOW+17,AUTO
          2 0006A9  CBF0 0100                            LAB,B4   256,IMO
          2 0006AB  E380 0000 0000  xent                 LNJ,B6   KNA$RLSIOP
          2 0006AE       0001                            DC       s:18677,PREL

      680    18677    2                KNA$SSN.IOPRD$ = ADDR(NIL);

  18677   2 0006AF  EB80 0000 0000                       LAB,B6   0
          2 0006B2  DCC7 0076                            LDB,B5   SSN$,AUTO
          2 0006B4  EFC5 000D                            STB,B6   13,B5
PL6.E3A0      #001=KNA$OPEN File=KNA$APE.:E05TSI                                 WED 07/30/97 00:55 Page:97   

      681    18678    2                END;

      682    18679
      683    18680    1      IF NOT CLOSING THEN GOTO UNLOCK_N_RTN;

  18680   2 0006B6  89C7 006B                            CMZ      CLOSING,AUTO
          2 0006B8  0881 0157                            BAGE     s:18743,PREL

  18680   2                              INTERNAL_CLOSE  null
      684    18681
      685    18682    1   INTERNAL_CLOSE: ;
      686    18683    1      MYDCB.FCD = '0'B;

  18683   2 0006BA  ECC7 0074            INTERNAL_CLOSE  LDB,B6   DCB$,AUTO
          2 0006BC  8846 001F                            LBF,'4000'X       31,B6
          2 0006BE       4000

      687    18684    1      MYDCB.SSN$ = ADDR(NIL);

  18684   2 0006BF  DB80 0000 0000                       LAB,B5   0
          2 0006C2  DFC6 0030                            STB,B5   48,B6

      688    18685    1      MYDCB.RLCID = '0'B;

  18685   2 0006C4  8746 002D                            CL       45,B6
          2 0006C6  8746 002E                            CL       46,B6

      689    18686    1      KNA$SSN.NUMDCBS = KNA$SSN.NUMDCBS - 1;

  18686   2 0006C8  CCC7 0076                            LDB,B4   SSN$,AUTO
          2 0006CA  88C4 0006                            DEC      6,B4

      690    18687    1      IF MYDCB.DDEV.RES = %G_DDEV_RES_UC#

  18687   2 0006CC  E846 0003                            LDR,R6   3,B6
          2 0006CE  E570 0007                            AND,R6   7,IMO
PL6.E3A0      #001=KNA$OPEN File=KNA$APE.:E05TSI                                 WED 07/30/97 00:55 Page:98   
          2 0006D0  6D02                                 CMV,R6   2
          2 0006D1  0981 0075                            BNE      s:18710,PREL

      691    18688    2      THEN DO;

      692    18689    2           I = G$ROS.NUMDCBS;

  18689   2 0006D3  DC80 0000 0000  xsym                 LDB,B5   G$ROS$
          2 0006D6  D845 0014                            LDR,R5   20,B5
          2 0006D8  DF47 006E                            STR,R5   I,AUTO

      693    18690    2           NEWSTREAM = '0'B;

  18690   2 0006DA  8747 006C                            CL       NEWSTREAM,AUTO

      694    18691    3           DO WHILE (I>0);

  18691   2 0006DC  5A81 002C                            BLEZ,R5  s:18701,PREL

      695    18692    3                IF DCBADDR(I)~=ADDR(NIL)

  18692   2 0006DE  EC80 0000 0000  xsym                 LDB,B6   G$ROS$
          2 0006E1  DC86                                 LDB,B5   ,B6
          2 0006E2  B847 006E                            LDR,R3   I,AUTO
          2 0006E4  8DB5                                 CMN      ,B5,R3
          2 0006E5  0901 001E                            BE       s:18699,PREL

      696    18693    3                THEN
      697    18694    3                     IF DCBADDR(I)->MYDCB.FCD

  18694   2 0006E7  CCB5                                 LDB,B4   ,B5,R3
          2 0006E8  82C4 001F                            LB,'4000'X        31,B4
          2 0006EA       4000
          2 0006EB  0581 0018                            BBF      s:18699,PREL
          2 0006ED  BCC7 0074                            LDB,B3   DCB$,AUTO
          2 0006EF  E843 0002                            LDR,R6   2,B3
          2 0006F1  E570 00FF                            AND,R6   255,IMO
PL6.E3A0      #001=KNA$OPEN File=KNA$APE.:E05TSI                                 WED 07/30/97 00:55 Page:99   
          2 0006F3  D844 0002                            LDR,R5   2,B4
          2 0006F5  D570 00FF                            AND,R5   255,IMO
          2 0006F7  E955                                 CMR,R6   R5
          2 0006F8  0981 000B                            BNE      s:18699,PREL
          2 0006FA  C844 0003                            LDR,R4   3,B4
          2 0006FC  C570 0007                            AND,R4   7,IMO
          2 0006FE  4D02                                 CMV,R4   2
          2 0006FF  0981 0004                            BNE      s:18699,PREL

      698    18695    3                       AND MYDCB.STRM = DCBADDR(I)->MYDCB.STRM
      699    18696    3                       AND DCBADDR(I)->MYDCB.DDEV.RES = %G_DDEV_RES_UC#
      700    18697    3                     THEN
      701    18698    3                          NEWSTREAM = '1'B;

  18698   2 000701  8947 006C                            LBT,'8000'X       NEWSTREAM,AUTO
  18698   2 000703       8000

      702    18699    3                I = I - 1;

  18699   2 000704  88C7 006E                            DEC      I,AUTO

      703    18700    3                END;

  18700   2 000706  E847 006E                            LDR,R6   I,AUTO
          2 000708  6A56                                 BGZ,R6   s:18692,SPREL

      704    18701    2           IF NOT NEWSTREAM

  18701   2 000709  89C7 006C                            CMZ      NEWSTREAM,AUTO
          2 00070B  0801 003B                            BAL      s:18710,PREL

      705    18702    3           THEN DO;

      706    18703    3                RWPARM = KNA_RWPARM_CON;

  18703   2 00070D  AB80 0000 0000  xsym                 LAB,B2   KNA_RWPARM_CON
          2 000710  2C00                                 LDV,R2   0
PL6.E3A0      #001=KNA$OPEN File=KNA$APE.:E05TSI                                 WED 07/30/97 00:55 Page:100  
          2 000711  6C52                                 LDV,R6   82
          2 000712  BB87                                 LAB,B3   ,AUTO
          2 000713  3C18                                 LDV,R3   24
          2 000714  0008                                 MMM

      707    18704    3                RWPARM.STR = MYDCB.STRM;

  18704   2 000715  ECC7 0074                            LDB,B6   DCB$,AUTO
          2 000717  E846 0002                            LDR,R6   2,B6
          2 000719  EAC7 0029                            SRM,R6,'00FF'X    RWPARM+29,AUTO
          2 00071B       00FF

      708    18705    3                IF (MYDCB.DISP~=%G_DISP_KEEP#) AND NOT(G$JIT.JUNK.KEEP)

  18705   2 00071C  E846 001F                            LDR,R6   31,B6
          2 00071E  6048                                 SOR,R6   8
          2 00071F  E570 000F                            AND,R6   15,IMO
          2 000721  6D02                                 CMV,R6   2
          2 000722  0901 000C                            BE       s:18707,PREL
          2 000724  DC80 0000 0000  xsym                 LDB,B5   G$JIT$
          2 000727  82C5 0098                            LB,'4000'X        152,B5
          2 000729       4000
          2 00072A  0501 0004                            BBT      s:18707,PREL

      709    18706    3                THEN RWPARM.VDOFLGS.DLTSTR = '1'B;

  18706   2 00072C  8947 0028                            LBT,'0080'X       RWPARM+28,AUTO
  18706   2 00072E       0080

      710    18707    3                CALL KNA$FCNOU(%KV_VDO_FNC_CLSSTR,KNA$SSN,RWPARM,ERR);

  18707   2 00072F  DBF0 0022                            LAB,B5   34,IMO
          2 000731  CBC7 006F                            LAB,B4   ERR,AUTO
          2 000733  CFC7 00C8                            STB,B4   WINDOW+23,AUTO
          2 000735  ABC7 000C                            LAB,B2   RWPARM,AUTO
          2 000737  AFC7 00C6                            STB,B2   WINDOW+21,AUTO
          2 000739  9CC7 0076                            LDB,B1   SSN$,AUTO
PL6.E3A0      #001=KNA$OPEN File=KNA$APE.:E05TSI                                 WED 07/30/97 00:55 Page:101  
          2 00073B  9FC7 00C4                            STB,B1   WINDOW+19,AUTO
          2 00073D  DFC7 00C2                            STB,B5   WINDOW+17,AUTO
          2 00073F  BBC7 00C2                            LAB,B3   WINDOW+17,AUTO
          2 000741  CBF0 0400                            LAB,B4   1024,IMO
          2 000743  E380 0000 0000  xent                 LNJ,B6   KNA$FCNOU
          2 000746       0001                            DC       s:18710,PREL

      711    18708    3                END;

      712    18709    2           END;

      713    18710    1      IF KNA$SSN.FLAGS.MRKPND

  18710   2 000747  ECC7 0076                            LDB,B6   SSN$,AUTO
          2 000749  8286                                 LB,'0080'X        ,B6
          2 00074A       0080
          2 00074B  0581 002C                            BBF      s:18718,PREL

      714    18711    2      THEN DO;

      715    18712    2           RWPARM = KNA_RWPARM_CON;

  18712   2 00074D  AB80 0000 0000  xsym                 LAB,B2   KNA_RWPARM_CON
          2 000750  2C00                                 LDV,R2   0
          2 000751  6C52                                 LDV,R6   82
          2 000752  BB87                                 LAB,B3   ,AUTO
          2 000753  3C18                                 LDV,R3   24
          2 000754  0008                                 MMM

      716    18713    2           RWPARM.MRKTYP = %KV_VDOMRKTYP_MRK;

  18713   2 000755  6C03                                 LDV,R6   3
          2 000756  E7C7 0029                            STH,R6   RWPARM+29,AUTO

      717    18714    2           RWPARM.MARKER = KNA$SSN.MARKER;

  18714   2 000758  ECC7 0076                            LDB,B6   SSN$,AUTO
PL6.E3A0      #001=KNA$OPEN File=KNA$APE.:E05TSI                                 WED 07/30/97 00:55 Page:102  
          2 00075A  8CC6 0017                            LDI      23,B6
          2 00075C  8D47 0019                            SDI      RWPARM+13,AUTO

      718    18715    2           CALL KNA$FCNOU(%KV_VDO_FNC_MRK,KNA$SSN,RWPARM,ERR);

  18715   2 00075E  DBF0 001F                            LAB,B5   31,IMO
          2 000760  CBC7 006F                            LAB,B4   ERR,AUTO
          2 000762  CFC7 00C8                            STB,B4   WINDOW+23,AUTO
          2 000764  ABC7 000C                            LAB,B2   RWPARM,AUTO
          2 000766  AFC7 00C6                            STB,B2   WINDOW+21,AUTO
          2 000768  EFC7 00C4                            STB,B6   WINDOW+19,AUTO
          2 00076A  DFC7 00C2                            STB,B5   WINDOW+17,AUTO
          2 00076C  BBC7 00C2                            LAB,B3   WINDOW+17,AUTO
          2 00076E  CBF0 0400                            LAB,B4   1024,IMO
          2 000770  E380 0000 0000  xent                 LNJ,B6   KNA$FCNOU
          2 000773       0001                            DC       s:18716,PREL

      719    18716    2           KNA$SSN.FLAGS.MRKPND = '0'B;

  18716   2 000774  ECC7 0076                            LDB,B6   SSN$,AUTO
          2 000776  8806                                 LBF,'0080'X       ,B6
          2 000777       0080

      720    18717    2           END;

      721    18718    1      IF KNA$SSN.NUMDCBS ~= 0 THEN GOTO UNLOCK_N_RTN;

  18718   2 000778  ECC7 0076                            LDB,B6   SSN$,AUTO
          2 00077A  E846 0006                            LDR,R6   6,B6
          2 00077C  6981 0093                            BNEZ,R6  s:18743,PREL

  18718   2                              CLOSE_IT        null
      722    18719
      723    18720    1   CLOSE_IT: ;                             /* entry for partially failed open    */
      724    18721    1      IF KNA$SSN.STATE = %KNA_STATE_TERM#

  18721   2 00077E  E846 0013            CLOSE_IT        LDR,R6   19,B6
PL6.E3A0      #001=KNA$OPEN File=KNA$APE.:E05TSI                                 WED 07/30/97 00:55 Page:103  
          2 000780  6D05                                 CMV,R6   5
          2 000781  0981 0006                            BNE      s:18724,PREL

      725    18722
      726    18723    1      THEN I = %KN_FCN_TERM_ACK;

  18723   2 000783  5C04                                 LDV,R5   4
          2 000784  DF47 006E                            STR,R5   I,AUTO
          2 000786  0F81 0004                            B        s:18727,PREL

      727    18724    1      ELSE I = %KN_FCN_TERM;

  18724   2 000788  5C03                                 LDV,R5   3
          2 000789  DF47 006E                            STR,R5   I,AUTO

      728    18725
      729    18726
      730    18727    1      FPT_TERM = '0'B;

  18727   2 00078B  DB80 0000 0000  00                   LAB,B5   FPT_TERM
          2 00078E  5C08                                 LDV,R5   8
          2 00078F  0021                                 ALR      ;
          2 000790       4178 0000                                ALPHANUM('0000'X,IMO,,1),;
          2 000792       4005 0000                                ALPHANUM(0,B5,,R5,FILL)

      731    18728    1      KN$NETPARM = KN_NETPARM_INIT;

  18728   2 000794  AB80 0000 0000  xsym                 LAB,B2   KN_NETPARM_INIT
          2 000797  2C00                                 LDV,R2   0
          2 000798  6C42                                 LDV,R6   66
          2 000799  BB87                                 LAB,B3   ,AUTO
          2 00079A  3C6E                                 LDV,R3   110
          2 00079B  437F                                 CSYNC    s:18728+6,SPREL
          2 00079C  0008                                 MMM

      732    18729    1      KN$NETPARM.FUNCTION = I;

PL6.E3A0      #001=KNA$OPEN File=KNA$APE.:E05TSI                                 WED 07/30/97 00:55 Page:104  
  18729   2 00079D  E847 006E                            LDR,R6   I,AUTO
          2 00079F  EF47 004B                            STR,R6   KN$NETPARM+20,AUTO

      733    18730    1      KN$NETPARM.FPT$ = ADDR(FPT_TERM);

  18730   2 0007A1  EB80 0000 0000  00                   LAB,B6   FPT_TERM
          2 0007A4  EFC7 0050                            STB,B6   KN$NETPARM+25,AUTO

      734    18731    1      KN$NETPARM.LDCT$ = KNA$SSN.LDCT$;

  18731   2 0007A6  DCC7 0076                            LDB,B5   SSN$,AUTO
          2 0007A8  CCC5 0004                            LDB,B4   4,B5
          2 0007AA  CFC7 0037                            STB,B4   KN$NETPARM,AUTO

      735    18732    1      KN$NETPARM.SLDCT$ = KN$NETPARM.LDCT$;

  18732   2 0007AC  CFC7 004E                            STB,B4   KN$NETPARM+23,AUTO

      736    18733
      737    18734    2      DO WHILE('1'B);

      738    18735    2           CALL KNS$SEND (KN$NETPARM);

  18735   2 0007AE  EBC7 0037                            LAB,B6   KN$NETPARM,AUTO
          2 0007B0  EFC7 00C2                            STB,B6   WINDOW+17,AUTO
          2 0007B2  BBC7 00C2                            LAB,B3   WINDOW+17,AUTO
          2 0007B4  CBF0 0100                            LAB,B4   256,IMO
          2 0007B6  E380 0000 0000  xent                 LNJ,B6   KNS$SEND
          2 0007B9       0001                            DC       s:18737,PREL

      739    18736
      740    18737    2           IF KN$NETPARM.ERRCODE ~= %KN_ERR_NOQ

  18737   2 0007BA  E847 004D                            LDR,R6   KN$NETPARM+22,AUTO
          2 0007BC  6D01                                 CMV,R6   1
          2 0007BD  0981 0012                            BNE      s:18743,PREL

PL6.E3A0      #001=KNA$OPEN File=KNA$APE.:E05TSI                                 WED 07/30/97 00:55 Page:105  
      741    18738    2           THEN
      742    18739    2                EXIT;
      743    18740
      744    18741    2           CALL KNA$REG_USER (%GH_EVCBL,SSN$);

  18741   2 0007BF  EBF0 0019                            LAB,B6   25,IMO
          2 0007C1  DBC7 0076                            LAB,B5   SSN$,AUTO
          2 0007C3  DFC7 00C4                            STB,B5   WINDOW+19,AUTO
          2 0007C5  EFC7 00C2                            STB,B6   WINDOW+17,AUTO
          2 0007C7  BBC7 00C2                            LAB,B3   WINDOW+17,AUTO
          2 0007C9  CBF0 0200                            LAB,B4   512,IMO
          2 0007CB  E380 0000 0000  xent                 LNJ,B6   KNA$REG_USER
          2 0007CE       0001                            DC       s:18742,PREL

      745    18742    2           END;

  18742   2 0007CF  0FDF                                 B        s:18735,SPREL

      746    18743    1      IF I = %KN_FCN_TERM

  18743   2 0007D0  D847 006E                            LDR,R5   I,AUTO
          2 0007D2  5D03                                 CMV,R5   3
          2 0007D3  0981 0016                            BNE      s:18748,PREL

      747    18744    2      THEN DO;

      748    18745    2           KNA$SSN.STATE = %KNA_STATE_WTERM;

  18745   2 0007D5  ECC7 0076                            LDB,B6   SSN$,AUTO
          2 0007D7  4C06                                 LDV,R4   6
          2 0007D8  CF46 0013                            STR,R4   19,B6

      749    18746    2           CALL KNA$REG_USER (%GH_EVCW,SSN$);

  18746   2 0007DA  EBF0 0015                            LAB,B6   21,IMO
          2 0007DC  DBC7 0076                            LAB,B5   SSN$,AUTO
          2 0007DE  DFC7 00C4                            STB,B5   WINDOW+19,AUTO
PL6.E3A0      #001=KNA$OPEN File=KNA$APE.:E05TSI                                 WED 07/30/97 00:55 Page:106  
          2 0007E0  EFC7 00C2                            STB,B6   WINDOW+17,AUTO
          2 0007E2  BBC7 00C2                            LAB,B3   WINDOW+17,AUTO
          2 0007E4  CBF0 0200                            LAB,B4   512,IMO
          2 0007E6  E380 0000 0000  xent                 LNJ,B6   KNA$REG_USER
          2 0007E9       0001                            DC       s:18748,PREL

      750    18747    2           END;

      751    18748    1      CALL KNA$RLSLDCT (KNA$SSN.LDCT$);

  18748   2 0007EA  ECC7 0076                            LDB,B6   SSN$,AUTO
          2 0007EC  DBC6 0004                            LAB,B5   4,B6
          2 0007EE  DFC7 00C2                            STB,B5   WINDOW+17,AUTO
          2 0007F0  BBC7 00C2                            LAB,B3   WINDOW+17,AUTO
          2 0007F2  CBF0 0100                            LAB,B4   256,IMO
          2 0007F4  E380 0000 0000  xent                 LNJ,B6   KNA$RLSLDCT
          2 0007F7       0001                            DC       s:18754,PREL

      752    18749           %UNLOCK (G=KNA_LNKSSN);

  18754   2 0007F8  BB80 0000 0001  03                   LAB,B3   +1
          2 0007FB  CBF0 0100                            LAB,B4   256,IMO
          2 0007FD  E380 0000 0000  xent                 LNJ,B6   GHH$UNLOCK
          2 000800       0001                            DC       s:18757,PREL

      753    18756
      754    18757    1      CALL KNA$RLSSSN (SSN$);

  18757   2 000801  EBC7 0076                            LAB,B6   SSN$,AUTO
          2 000803  EFC7 00C2                            STB,B6   WINDOW+17,AUTO
          2 000805  BBC7 00C2                            LAB,B3   WINDOW+17,AUTO
          2 000807  CBF0 0100                            LAB,B4   256,IMO
          2 000809  E380 0000 0000  xent                 LNJ,B6   KNA$RLSSSN
          2 00080C       0001                            DC       s:18758,PREL

      755    18758    1      RETURN;                              /* dont unlock twice                  */

PL6.E3A0      #001=KNA$OPEN File=KNA$APE.:E05TSI                                 WED 07/30/97 00:55 Page:107  
  18758   2 00080D  C380 0000 0000  xent                 LNJ,B4   X6A_ARET

  18743   2                              UNLOCK_N_RTN    null
      756    18759    1   UNLOCK_N_RTN: ;
      757    18760           %UNLOCK (G=KNA_LNKSSN);

  18765   2 000810  BB80 0000 0001  03   UNLOCK_N_RTN    LAB,B3   +1
          2 000813  CBF0 0100                            LAB,B4   256,IMO
          2 000815  E380 0000 0000  xent                 LNJ,B6   GHH$UNLOCK
          2 000818       0001                            DC       s:18767,PREL

      758    18767    1      IF ERROR = '0'B THEN RETURN;

  18767   2 000819  ECC7 0006                            LDB,B6   @ERROR,AUTO
          2 00081B  DB80 0000 0000  03                   LAB,B5   0
          2 00081E  5C01                                 LDV,R5   1
          2 00081F  0022                                 ACM      ;
          2 000820       4406 0000                                ALPHANUM(0,B6,,4,FILL),;
          2 000822       4005 0000                                ALPHANUM(0,B5,,R5,FILL)
          2 000824  5301 0004                            CBNE     s:18768,PREL

  18767   2 000826  C380 0000 0000  xent                 LNJ,B4   X6A_ARET

      759    18768    1      ALTRETURN;

  18768   2 000829  C380 0000 0000  xent                 LNJ,B4   X6A_AALT
      760    18769
      761    18770    1   END KNA$OPEN;
      762    18771        %EOD;

PL6.E3A0      #001=KNA$OPEN File=KNA$APE.:E05TSI                                 WED 07/30/97 00:55 Page:108  
--  Include file information  --

   K_SCODE_C.:E05TOU  is referenced.
   KV_GLBCNS_E.:E05TOU  is referenced.
   KV$VDO.:E05TOU  is referenced.
   K$RWPARM.:E05TOU  is referenced.
   KI_CP6.:E05TOU  is referenced.
   KL_AFCN_C.:E05TOU  is referenced.
   KL_SUPER_C.:E05TOU  is referenced.
   GF_LCP6_M.:E05TOU  is referenced.
   KL_MACRO_C.:E05TOU  is referenced.
   GH_SCHD_E.:E05TOU  is referenced.
   G_JIT_M.:E05TOU  is referenced.
   G_ROS_M.:E05TOU  is referenced.
   GH_LCP6_M.:E05TOU  is referenced.
   KI_ERRORS_C.:E05TOU  is referenced.
   KN_ERRORS_C.:E05TOU  is referenced.
   GU_LCP6_M.:E05TOU  is referenced.
   KNH_MACRO_C.:E05TOU  is referenced.
   KN_DATA_M.:E05TOU  is referenced.
   GH_GATE_M.:E05TOU  cannot be made into a system file and is referenced.
   KNA_MACRO_M.:E05TOU  is referenced.
   G_LCP6_E.:E05TOU  is referenced.
   F_ERRORS_C.:E05TOU  is referenced.
      No diagnostics issued in procedure KNA$OPEN.
PL6.E3A0      #001=KNA$OPEN File=KNA$APE.:E05TSI                                 WED 07/30/97 00:55 Page:109  

 **** Variables and constants ****

  ****  Section 000  Data  KNA$OPEN

  ****  Scalars and arrays  ****
HexLoc.c.b A Datatyp(siz) R M Lvl/name                 HexLoc.c.b A Datatyp(siz) R M Lvl/name

     0-0-0/w STRC(64)    r     1 FPT_TERM

  ****  Section 001 RoData KNA$OPEN

  ****  Scalars and arrays  ****
HexLoc.c.b A Datatyp(siz) R M Lvl/name                 HexLoc.c.b A Datatyp(siz) R M Lvl/name

     E-0-0/w STRC(32)    r     1 EAPE_SSN                   8-0-0/w STRC(32)    r     1 EBAD_DCB_RES
     A-0-0/w STRC(32)    r     1 EBAD_ORG                  10-0-0/w STRC(32)    r     1 EDCB_CLOSED
    12-0-0/w STRC(32)    r     1 EDCB_OPEN                  C-0-0/w STRC(32)    r     1 ENET_ADDR
     2-0-0/w STRC(32)    r     1 ENOLDCT                    6-0-0/w STRC(32)    r     1 ENORTE
     4-0-0/w STRC(32)    r     1 ENOTCTX                    0-0-0/w STRC(32)    r     1 ENO_IOP
    14-0-0/w STRC(32)    r     1 ERR_ORGNOTCOM             19-0-0/c CHAR(10)    r     1 NUMBERS
    16-0-0/w STRC(48)    r     1 SCR_UNEXP

  ****  Auto variables  ****

  ****  Scalars and arrays  ****
HexLoc.c.b A Datatyp(siz) R M Lvl/name                 HexLoc.c.b A Datatyp(siz) R M Lvl/name

     4-0-0/w PTR         r     1 @DCBNUMBER                 6-0-0/w PTR         r     1 @ERROR
     8-0-0/w PTR         r     1 @LGN_                      A-0-0/w PTR         r     1 @VLP_WINDOW
    6B-0-0/b BIT         r     1 CLOSING                   74-0-0/w PTR         r     1 DCB$
    *0-0-0/w UBIN(16)    r     1 DCBNUMBER                 6F-0-0/w UBIN(32)    r     1 ERR
    *0-0-0/w STRC(32)    r     1 ERROR                     58-0-0/w STRC(304)   r     1 FPT_CONNECT
    35-0-0/w STRC(32)    r     1 HDR                       6E-0-0/w SBIN(16)    r     1 I
    71-0-0/w PTR         r     1 IOP$                      37-0-0/w STRC(528)   r     1 KN$NETPARM
    *0-0-0/w VECT        r     1 LGN_                      7D-0-0/w STRC(32)    r     1 NETWORK_ADDR
    6C-0-0/b BIT         r     1 NEWSTREAM                 7A-0-0/w PTR         r     1 OPNDCB$
    7C-0-0/c CHAR(2)     r     1 RESTYPE                    C-0-0/w STRC(656)   r     1 RWPARM
PL6.E3A0      #001=KNA$OPEN File=KNA$APE.:E05TSI                                 WED 07/30/97 00:55 Page:110  
    7F-0-0/w STRC(800)   r     1 SGN                       7F-0-0/w STRC(800)   r     1 SGNRSP
    76-0-0/w PTR         r     1 SSN$                      73-0-0/w UBIN(16)    r     1 STRM
    78-0-0/w PTR         r     1 TEMP$                     6D-0-0/b BIT         r     1 UCSTREAM
    *0-0-0/w STRC(256)   r     1 VLP_WINDOW                B1-0-0/w STRC(256)   r     1 WINDOW

  ****  SYMREF variables  ****

  ****  Scalars and arrays  ****
HexLoc.c.b A Datatyp(siz) R M Lvl/name                 HexLoc.c.b A Datatyp(siz) R M Lvl/name

     0-0-0/w PTR         r     1 G$JIT$                     0-0-0/w PTR         r     1 G$ROS$
     0-0-0/w STRC(48)    r     1 KNA_LNKSSN                 0-0-0/w STRC(656)   r     1 KNA_RWPARM_CON
     0-0-0/w STRC(256)   r     1 KNA_WINDOW                 0-0-0/c CHAR(2)     r     1 KNA_WINDOW_TL
     0-0-0/w STRC(528)   r     1 KN_NETPARM_INIT            0-0-0/w UBIN(16)    r     1 KN_NODE#

  ****  BASED and DCB variables  ****

  ****  Scalars and arrays  ****
HexLoc.c.b A Datatyp(siz) R M Lvl/name                 HexLoc.c.b A Datatyp(siz) R M Lvl/name

     0-0-0/w PTR         r     1 G$DCBTABLE(0:0)
     0-0-0/w STRC(5616)  r     1 G$JIT                      0-0-0/w STRC(928)   r     1 G$ROS
     0-0-0/w STRC(432)   r     1 KN$IOP                     0-0-0/w STRC(256)   r     1 KN$LDCT
     0-0-0/w STRC(400)   r     1 KNA$SSN                    0-0-0/c ACHR        r     1 LGNSTR
     0-0-0/w ASTR(808)   r     1 MYDCB


   Procedure KNA$OPEN requires 2092 words for executable code.
   Procedure KNA$OPEN requires 206 words of local(AUTO) storage.
PL6.E3A0      #001=KNA$OPEN File=KNA$APE.:E05TSI                                 WED 07/30/97 00:55 Page:111  
          *** CROSS REFERENCE LISTING ***
**     DENOTES     IDENTIFIER DEFINITION
<<                 IDENTIFIER'S VALUE SET
>>                 IDENTIFIER'S VALUE USED
<>                 IDENTIFIER SET AND/OR USED
--                 IDENTIFIER REFERENCED
PL6.E3A0      #001=KNA$OPEN File=KNA$APE.:E05TSI                                 WED 07/30/97 00:55 Page:112  
          MINI XREF LISTING

BADRES
     18185**LABEL   18193--CALLALT 18194--CALLALT
CLOSE_IT
     18718**LABEL   18513--GOTO
CLOSING
     15660**DCL     18629<<ASSIGN  18633<<ASSIGN  18637<<ASSIGN  18680>>IF
DCB$
     15667**DCL     16736--IMP-PTR 18171<<ASSIGN  18173>>IF      18182>>ASSIGN  18183>>CALLBLT 18184>>IF
     18193>>CALLBLT 18194>>CALLBLT 18195>>CALLBLT 18209>>ASSIGN  18210>>IF      18211>>ASSIGN  18214>>ASSIGN
     18232>>IF      18248>>DOCASE  18251>>IF      18273>>ASSIGN  18278>>ASSIGN  18426>>ASSIGN  18541>>ASSIGN
     18542>>ASSIGN  18543>>ASSIGN  18544>>ASSIGN  18545>>ASSIGN  18546>>ASSIGN  18547>>ASSIGN  18574>>IF
     18579>>IF      18582>>IF      18585>>IF      18625>>ASSIGN  18640<<ASSIGN  18641>>ASSIGN  18644>>IF
     18664>>IF      18668>>ASSIGN  18683>>ASSIGN  18684>>ASSIGN  18685>>ASSIGN  18687>>IF      18694>>IF
     18704>>ASSIGN  18705>>IF
DCBNUMBER
     14947**DCL        72--PROC    18171>>ASSIGN  18368>>IF      18368>>IF      18628--ENTRY   18636--ENTRY
     18640>>ASSIGN
EAPE_SSN
     17384**DCL     18363>>ASSIGN
EBAD_DCB_RES
     17243**DCL     18188>>ASSIGN  18217>>ASSIGN  18287>>ASSIGN
EBAD_ORG
     17290**DCL     18234>>ASSIGN
EDCB_CLOSED
     17431**DCL     18646>>ASSIGN
EDCB_OPEN
     17478**DCL     18175>>ASSIGN
ENET_ADDR
     17337**DCL     18295>>ASSIGN
ENOLDCT
     17102**DCL     18391>>ASSIGN
ENORTE
PL6.E3A0      #001=KNA$OPEN File=KNA$APE.:E05TSI                                 WED 07/30/97 00:55 Page:113  
     17196**DCL     18459>>ASSIGN
ENOTCTX
     17149**DCL     18455>>ASSIGN
ENO_IOP
     17055**DCL     18598>>ASSIGN
ERR
     15664**DCL     18525<>CALL    18561<>CALL    18576<>CALL    18601<>CALL    18669<>CALL    18707<>CALL
     18715<>CALL
ERROR
     14962**DCL        72--PROC    18175<<ASSIGN  18188<<ASSIGN  18217<<ASSIGN  18234<<ASSIGN  18259<<ASSIGN
     18287<<ASSIGN  18295<<ASSIGN  18363<<ASSIGN  18391<<ASSIGN  18409<<ASSIGN  18455<<ASSIGN  18459<<ASSIGN
     18509<<ASSIGN  18566<>CALL    18598<<ASSIGN  18606<<ASSIGN  18609<<ASSIGN  18613>>IF      18628--ENTRY
     18636--ENTRY   18642<<ASSIGN  18646<<ASSIGN  18767>>IF
ERR_ORGNOTCOM
     17525**DCL     18259>>ASSIGN
FINDOPNDCB
     18324**LABEL   18333--EXIT
FPT_CONNECT
     15583**DCL     18430--ASSIGN
FPT_CONNECT.RESOURCE
     15589**DCL     18421<<ASSIGN
FPT_CONNECT.RLCID
     15619**DCL     18415<<ASSIGN
FPT_CONNECT.RLCID.GENERATION
     15619**DCL     15620--REDEF
FPT_CONNECT.RLCID.LDCTX
     15620**DCL     15620--REDEF
FPT_CONNECT.SERVICE
     15622**DCL     18424<<ASSIGN
FPT_CONNECT.TERMINAL_ID.TERM
     15608**DCL     15617--REDEF
FPT_CONNECT.TERMINAL_ID.TERMID
     15617**DCL     18420<<ASSIGN
FPT_CONNECT.TERMINAL_ID.TTYP
     15608**DCL     18416<<ASSIGN
FPT_CONNECT.TYPE
PL6.E3A0      #001=KNA$OPEN File=KNA$APE.:E05TSI                                 WED 07/30/97 00:55 Page:114  
     15587**DCL     18423<<ASSIGN
FPT_CONNECT.USER.SYSID
     15621**DCL     18417<<ASSIGN
FPT_TERM
     15652**DCL     18727<<ASSIGN  18730--ASSIGN
G$DCBTABLE
     17029**DCL     18171>>ASSIGN  18212>>ASSIGN  18274>>ASSIGN  18325>>ASSIGN  18640>>ASSIGN
G$JIT.ERRLOG
     16584**DCL     16587--REDEF
G$JIT.JSUNIT
     16323**DCL     16324--REDEF
G$JIT.JUNK.KEEP
     16574**DCL     18705>>IF
G$JIT.MCLS
     16322**DCL     16322--REDEF
G$JIT.SYSID
     16312**DCL     18224>>ASSIGN  18229>>ASSIGN  18417>>ASSIGN
G$JIT.TMRZ
     16591**DCL     16592--REDEF
G$JIT.UNAME
     16313**DCL     18223>>ASSIGN  18420>>ASSIGN
G$JIT.USER_EXTIME
     16315**DCL     16316--REDEF
G$JIT.USER_MEMTIME
     16318**DCL     16318--REDEF
G$JIT.USER_SVTIME
     16317**DCL     16317--REDEF
G$JIT.USR#
     16312**DCL     18225>>ASSIGN  18374>>ASSIGN  18398>>ASSIGN
G$JIT$
     17036**DCL     16254--IMP-PTR 18223>>ASSIGN  18224>>ASSIGN  18225>>ASSIGN  18229>>ASSIGN  18374>>ASSIGN
     18398>>ASSIGN  18417>>ASSIGN  18420>>ASSIGN  18705>>IF
G$ROS.AUTO_DS$
     16219**DCL     16220--REDEF
G$ROS.AUTO_T$
     16220**DCL     16220--REDEF
PL6.E3A0      #001=KNA$OPEN File=KNA$APE.:E05TSI                                 WED 07/30/97 00:55 Page:115  
G$ROS.DCBPTR$
     16215**DCL     18171>>ASSIGN  18212>>ASSIGN  18274>>ASSIGN  18325>>ASSIGN  18640>>ASSIGN
G$ROS.NUMDCBS
     16219**DCL     18241>>ASSIGN  18324>>DOINDEX 18689>>ASSIGN
G$ROS$
     17037**DCL     16210--IMP-PTR 18171>>ASSIGN  18212>>ASSIGN  18241>>ASSIGN  18274>>ASSIGN  18324>>DOINDEX
     18325>>ASSIGN  18640>>ASSIGN  18689>>ASSIGN
GHH$LOCK
       688**DCL-ENT 18442--CALL    18554--CALL    18658--CALL
GHH$UNLOCK
       688**DCL-ENT 18466--CALL    18532--CALL    18622--CALL    18754--CALL    18765--CALL
HDR
     15406**DCL     18427<>CALL    18428--ASSIGN
I
     15663**DCL     18183<<CALLBLT 18184>>IF      18184>>IF      18184>>IF      18184>>IF      18184>>IF
     18191>>IF      18193<<CALLBLT 18194<<CALLBLT 18241<<ASSIGN  18242>>DOWHILE 18243--IF      18244--IF
     18244--IF      18244--IF      18251--IF      18255--IF      18255--IF      18264<<ASSIGN  18264>>ASSIGN
     18324<<DOINDEX 18325>>ASSIGN  18689<<ASSIGN  18691>>DOWHILE 18692--IF      18694--IF      18694--IF
     18694--IF      18699<<ASSIGN  18699>>ASSIGN  18723<<ASSIGN  18724<<ASSIGN  18729>>ASSIGN  18743>>IF
INTERNAL_CLOSE
     18680**LABEL   18634--GOTO
IOP$
     15665**DCL     18590<<ASSIGN  18591<>CALL    18594>>ASSIGN  18602>>IF      18606>>ASSIGN  18612<>CALL
KN$IOP.ARS
     16907**DCL     16908--REDEF   16909--REDEF
KN$IOP.DCB$
     16935**DCL     18664>>IF
KN$IOP.ERRCODE
     16869**DCL     18606>>ASSIGN
KN$IOP.LNK$
     16937**DCL     16938--REDEF
KN$LDCT.CONN_TYPE
     15967**DCL     18400<<ASSIGN
KN$LDCT.RLCID
     15999**DCL     18516>>ASSIGN
KN$LDCT.RLCID.LDCTX
PL6.E3A0      #001=KNA$OPEN File=KNA$APE.:E05TSI                                 WED 07/30/97 00:55 Page:116  
     16027**DCL     16034--REDEF   16042--REDEF
KN$LDCT.TRANSPORT_ID
     16061**DCL     16069--REDEF
KN$LDCT.UID
     16091**DCL     16092--REDEF   16101--REDEF
KN$LDCT.UID$
     16092**DCL     18401<<ASSIGN
KN$LDCT.USER#
     16184**DCL     18398<<ASSIGN
KN$LDCT.USER_ENTRY$
     16172**DCL     18399<<ASSIGN
KN$NETPARM
     15429**DCL     18383<<ASSIGN  18447<>CALL    18728<<ASSIGN  18735<>CALL
KN$NETPARM.ERRCODE
     15536**DCL     18449>>IF      18452>>DOSELCT 18737>>IF
KN$NETPARM.FPT$
     15548**DCL     18430<<ASSIGN  18730<<ASSIGN
KN$NETPARM.FUNCTION
     15524**DCL     18446<<ASSIGN  18729<<ASSIGN
KN$NETPARM.LDCT$
     15430**DCL     15966--IMP-PTR 18384<>CALL    18395>>ASSIGN  18396>>ASSIGN  18398>>ASSIGN  18399>>ASSIGN
     18400>>ASSIGN  18401>>ASSIGN  18469<>CALL    18516>>ASSIGN  18731<<ASSIGN  18732>>ASSIGN
KN$NETPARM.MSG$
     15436**DCL     15441--REDEF
KN$NETPARM.NHDR$
     15488**DCL     15489--REDEF
KN$NETPARM.SHDR$
     15466**DCL     15467--REDEF
KN$NETPARM.SLDCT$
     15543**DCL     18396<<ASSIGN  18732<<ASSIGN
KN$NETPARM.THDR$
     15477**DCL     15478--REDEF
KN$NETPARM.UHDR$
     15452**DCL     15453--REDEF   18428<<ASSIGN
KN$NETPARM.UHDRSZ
     15461**DCL     18429<<ASSIGN
PL6.E3A0      #001=KNA$OPEN File=KNA$APE.:E05TSI                                 WED 07/30/97 00:55 Page:117  
KNA$BUILD_VDO
     15044**DCL-ENT 18427--CALL
KNA$CONV_STR
     15045**DCL-ENT 18566--CALL
KNA$FCNOU
     15054**DCL-ENT 18525--CALL    18561--CALL    18576--CALL    18601--CALL    18669--CALL    18707--CALL
     18715--CALL
KNA$GETIOP
     15049**DCL-ENT 18591--CALL
KNA$GETLDCT
     15041**DCL-ENT 18384--CALL
KNA$GETSSN
     15046**DCL-ENT 18356--CALL
KNA$IN
     15050**DCL-ENT 18399--ASSIGN
KNA$REG_USER
     15052**DCL-ENT 18490--CALL    18506--CALL    18604--CALL    18672--CALL    18741--CALL    18746--CALL
KNA$RLSIOP
     15048**DCL-ENT 18612--CALL    18676--CALL
KNA$RLSLDCT
     15042**DCL-ENT 18469--CALL    18748--CALL
KNA$RLSSSN
     15047**DCL-ENT 18471--CALL    18757--CALL
KNA$SSN
     16780**DCL     18367<<ASSIGN  18525<>CALL    18561<>CALL    18576<>CALL    18601<>CALL    18669<>CALL
     18707<>CALL    18715<>CALL
KNA$SSN.ERROR
     16806**DCL     18509>>ASSIGN  18609>>ASSIGN
KNA$SSN.EVENT
     16848**DCL     18541<<ASSIGN
KNA$SSN.FLAGS.CG
     16784**DCL     18543>>ASSIGN
KNA$SSN.FLAGS.CQ
     16784**DCL     18489<<ASSIGN  18491<<ASSIGN
KNA$SSN.FLAGS.MRKPND
     16788**DCL     18710>>IF      18716<<ASSIGN
PL6.E3A0      #001=KNA$OPEN File=KNA$APE.:E05TSI                                 WED 07/30/97 00:55 Page:118  
KNA$SSN.FLAGS.PRIMARY
     16784**DCL     18370<<ASSIGN
KNA$SSN.FLAGS.RRRPND
     16784**DCL     18595<<ASSIGN  18671<<ASSIGN
KNA$SSN.FLAGS.SSNERR
     16784**DCL     18507>>IF
KNA$SSN.IOPQ$
     16842**DCL     18371<<ASSIGN  18594<<ASSIGN  18611<<ASSIGN
KNA$SSN.IOPRD$
     16842**DCL     16842--REDEF   18375<<ASSIGN  18662>>IF      18664>>IF      18674>>IF      18676<>CALL
     18677<<ASSIGN
KNA$SSN.LDCT$
     16839**DCL     18395<<ASSIGN  18731>>ASSIGN  18748<>CALL
KNA$SSN.MARKER
     16848**DCL     18714>>ASSIGN
KNA$SSN.NUMDCBS
     16839**DCL     18347<<ASSIGN  18347>>ASSIGN  18373<<ASSIGN  18686<<ASSIGN  18686>>ASSIGN  18718>>IF
KNA$SSN.RLCID
     16846**DCL     18376<<ASSIGN  18516<<ASSIGN  18625>>ASSIGN
KNA$SSN.RLCID.NODE#
     16846**DCL     16846--REDEF
KNA$SSN.STATE
     16847**DCL     18372<<ASSIGN  18511>>IF      18526<<ASSIGN  18721>>IF      18745<<ASSIGN
KNA$SSN.USER#
     16847**DCL     18374<<ASSIGN
KNA_CLOSE
     18629**LABEL   18599--GOTO    18614--GOTO
KNA_LNKSSN
     17955**DCL     18442<>CALL    18466<>CALL    18532<>CALL    18554<>CALL    18622<>CALL    18658<>CALL
     18754<>CALL    18765<>CALL
KNA_RWPARM_CON
     17644**DCL     18425>>ASSIGN  18524>>ASSIGN  18558>>ASSIGN  18577>>ASSIGN  18666>>ASSIGN  18703>>ASSIGN
     18712>>ASSIGN
KNA_RWPARM_CON.BLKREC
     17674**DCL     17699--REDEF
KNA_RWPARM_CON.DVE.DVBYTE.VFC
PL6.E3A0      #001=KNA$OPEN File=KNA$APE.:E05TSI                                 WED 07/30/97 00:55 Page:119  
     17714**DCL     17715--REDEF
KNA_RWPARM_CON.DVE.EOMCHAR
     17722**DCL     17726--REDEF
KNA_RWPARM_CON.ERR
     17786**DCL     17791--REDEF
KNA_RWPARM_CON.FC
     17750**DCL     17751--REDEF
KNA_RWPARM_CON.FLDID
     17932**DCL     17933--REDEF
KNA_RWPARM_CON.KEYTYPE
     17939**DCL     17940--REDEF
KNA_RWPARM_CON.MSG$
     17645**DCL     17646--REDEF   17655--REDEF
KNA_RWPARM_CON.MSGID
     17761**DCL     17766--REDEF
KNA_RWPARM_CON.MSGIDXT
     17774**DCL     17778--REDEF
KNA_RWPARM_CON.ORG
     17910**DCL     17911--REDEF
KNA_RWPARM_CON.VDOFLGS
     17912**DCL     17923--REDEF
KNA_WINDOW
     17980**DCL     18569>>ASSIGN
KNA_WINDOW.FWINDOW
     17980**DCL     17980--REDEF   17981--REDEF
KNA_WINDOW_TL
     18159**DCL     18572--ASSIGN  18573--ASSIGN
KNB$GETRESP
     15053**DCL-ENT 18406--CALL
KNS$SEND
     15043**DCL-ENT 18447--CALL    18735--CALL
KN_NETPARM_INIT
     18019**DCL     18728>>ASSIGN
KN_NETPARM_INIT.MSG$
     18026**DCL     18031--REDEF
KN_NETPARM_INIT.NHDR$
PL6.E3A0      #001=KNA$OPEN File=KNA$APE.:E05TSI                                 WED 07/30/97 00:55 Page:120  
     18078**DCL     18079--REDEF
KN_NETPARM_INIT.SHDR$
     18056**DCL     18057--REDEF
KN_NETPARM_INIT.THDR$
     18067**DCL     18068--REDEF
KN_NETPARM_INIT.UHDR$
     18042**DCL     18043--REDEF
KN_NODE#
     18160**DCL     18228>>ASSIGN  18280>>ASSIGN
LGNSTR
     18164**DCL     18227>>ASSIGN
LGN_
     14994**DCL        72--PROC    18215--IF      18226>>ASSIGN  18227>>ASSIGN
MAINLINE
     18637**LABEL   18630--GOTO
MYDCB.DCBNAME.L
     16763**DCL     16763--IMP-SIZ
MYDCB.DDEV.CG
     16746**DCL     18543<<ASSIGN
MYDCB.DDEV.RES
     16746**DCL     18209<<ASSIGN  18214<<ASSIGN  18273<<ASSIGN  18278<<ASSIGN  18687>>IF      18694>>IF
MYDCB.DISP
     16751**DCL     18705>>IF
MYDCB.EOMCHAR
     16754**DCL     16754--REDEF   16755--REDEF
MYDCB.EVENT
     16756**DCL     18541>>ASSIGN
MYDCB.FCD
     16750**DCL     18173>>IF      18244>>IF      18328>>IF      18545<<ASSIGN  18644>>IF      18683<<ASSIGN
     18694>>IF
MYDCB.FCI
     16750**DCL     18546<<ASSIGN
MYDCB.FFLG
     16744**DCL     18547<<ASSIGN
MYDCB.FLDID
     16753**DCL     16753--REDEF
PL6.E3A0      #001=KNA$OPEN File=KNA$APE.:E05TSI                                 WED 07/30/97 00:55 Page:121  
MYDCB.ORG
     16751**DCL     18232>>IF      18248>>DOCASE  18251>>IF      18251>>IF      18255>>IF      18255>>IF
     18574>>IF      18579>>IF      18582>>IF      18585>>IF
MYDCB.RES
     16748**DCL     16749--REDEF   18182>>ASSIGN  18183>>CALLBLT 18184>>IF      18193>>CALLBLT 18194>>CALLBLT
     18195>>CALLBLT 18244>>IF      18329>>IF
MYDCB.RLCID
     16758**DCL     18210>>IF      18211>>ASSIGN  18212>>ASSIGN  18274>>ASSIGN  18329>>IF      18625<<ASSIGN
     18685<<ASSIGN
MYDCB.SSN$
     16763**DCL     18346>>ASSIGN  18542<<ASSIGN  18641>>ASSIGN  18684<<ASSIGN
MYDCB.STRM
     16743**DCL     18244>>IF      18426>>ASSIGN  18544<<ASSIGN  18668>>ASSIGN  18694>>IF      18694>>IF
     18704>>ASSIGN
NETWORK_ADDR
     15672**DCL     18211<<ASSIGN  18212<<ASSIGN  18274<<ASSIGN  18279<<ASSIGN  18329>>IF      18376>>ASSIGN
     18412<<ASSIGN  18415>>ASSIGN
NETWORK_ADDR.LDCTX
     15675**DCL     18291>>IF
NETWORK_ADDR.NODE#
     15673**DCL     18280<<ASSIGN
NEWSTREAM
     15661**DCL     18201<<ASSIGN  18247<<ASSIGN  18556>>IF      18690<<ASSIGN  18698<<ASSIGN  18701>>IF
NUMBERS
     18163**DCL     18193>>CALLBLT 18194>>CALLBLT
OPNDCB$
     15670**DCL     18319<<ASSIGN  18332<<ASSIGN  18344>>IF      18346>>ASSIGN
RESTYPE
     15671**DCL     18182<<ASSIGN  18184>>IF      18207>>DOSELCT 18291>>IF      18291>>IF      18321>>IF
     18329--IF      18329>>IF      18404>>IF      18418>>IF
RLSDCT_N_ALTRET
     18471**LABEL   18410--GOTO
RLSSSN_N_ALTRET
     18469**LABEL   18392--GOTO
RWPARM
     15074**DCL     18425<<ASSIGN  18427<>CALL    18524<<ASSIGN  18525<>CALL    18558<<ASSIGN  18561<>CALL
PL6.E3A0      #001=KNA$OPEN File=KNA$APE.:E05TSI                                 WED 07/30/97 00:55 Page:122  
     18576<>CALL    18577<<ASSIGN  18601<>CALL    18666<<ASSIGN  18669<>CALL    18703<<ASSIGN  18707<>CALL
     18712<<ASSIGN  18715<>CALL
RWPARM.BLKREC
     15104**DCL     15129--REDEF
RWPARM.DVE.DVBYTE.VFC
     15144**DCL     15145--REDEF
RWPARM.DVE.EOMCHAR
     15152**DCL     15156--REDEF
RWPARM.ERR
     15216**DCL     15221--REDEF
RWPARM.FC
     15180**DCL     15181--REDEF
RWPARM.FLDID
     15362**DCL     15363--REDEF
RWPARM.KEYTYPE
     15369**DCL     15370--REDEF
RWPARM.MARKER
     15129**DCL     18714<<ASSIGN
RWPARM.MRKTYP
     15354**DCL     18593<<ASSIGN  18667<<ASSIGN  18713<<ASSIGN
RWPARM.MSG$
     15075**DCL     15076--REDEF   15085--REDEF   18570<<ASSIGN
RWPARM.MSGID
     15191**DCL     15196--REDEF
RWPARM.MSGIDXT
     15204**DCL     15208--REDEF
RWPARM.MSGSZ
     15086**DCL     18571<<ASSIGN
RWPARM.ORG
     15340**DCL     15341--REDEF   18581<<ASSIGN  18584<<ASSIGN  18587<<ASSIGN  18589<<ASSIGN
RWPARM.STR
     15355**DCL     18426<<ASSIGN  18559<<ASSIGN  18562<<ASSIGN  18578<<ASSIGN  18668<<ASSIGN  18704<<ASSIGN
RWPARM.STRID
     15341**DCL     18560<<ASSIGN
RWPARM.UHDRSZ
     15234**DCL     18429>>ASSIGN
PL6.E3A0      #001=KNA$OPEN File=KNA$APE.:E05TSI                                 WED 07/30/97 00:55 Page:123  
RWPARM.V$
     15359**DCL     18572<<ASSIGN
RWPARM.VDOFLGS
     15342**DCL     15353--REDEF
RWPARM.VDOFLGS.DLTSTR
     15346**DCL     18706<<ASSIGN
RWPARM.VSZ
     15361**DCL     18573<<ASSIGN
SCREECH
     15051**DCL-ENT 18494--CALL
SCR_UNEXP
     17586**DCL     18494<>CALL
SET_BAD_ORG
     18258**LABEL   18252--GOTO
SGN
     15691**DCL     15784--REDEF   18220<<ASSIGN  18406--CALL    18406--CALL
SGN.FCN
     15692**DCL     18221<<ASSIGN
SGN.LOGON.LGNSIZ
     15766**DCL     18164--IMP-SIZ 18226<<ASSIGN  18227>>ASSIGN
SGN.LOGON.LGNTXT
     15767**DCL     18227<<ASSIGN
SGN.NMID
     15755**DCL     18225<<ASSIGN
SGN.NODE
     15695**DCL     18228<<ASSIGN
SGN.TERMINAL_ID.TERM
     15718**DCL     15727--REDEF
SGN.TERMINAL_ID.TERM.CHANNEL
     15724**DCL     18229<<ASSIGN
SGN.TERMINAL_ID.TERMID
     15727**DCL     18223<<ASSIGN
SGN.TERMINAL_ID.TTYP
     15718**DCL     18222<<ASSIGN
SGN.USER.SYSID
     15747**DCL     18224<<ASSIGN
PL6.E3A0      #001=KNA$OPEN File=KNA$APE.:E05TSI                                 WED 07/30/97 00:55 Page:124  
SGNRSP
     15784**DCL     18406--CALL    18406--CALL
SGNRSP.ERRCODE
     15840**DCL     18407>>IF      18409>>ASSIGN
SGNRSP.RLCID
     15808**DCL     18412>>ASSIGN
SGNRSP.TERMID.TERM
     15888**DCL     15897--REDEF
SSN$
     15668**DCL     16780--IMP-PTR 18346<<ASSIGN  18347>>ASSIGN  18347>>ASSIGN  18356<>CALL    18367>>ASSIGN
     18370>>ASSIGN  18371>>ASSIGN  18372>>ASSIGN  18373>>ASSIGN  18374>>ASSIGN  18375>>ASSIGN  18376>>ASSIGN
     18395>>ASSIGN  18401>>ASSIGN  18471<>CALL    18489>>ASSIGN  18490<>CALL    18491>>ASSIGN  18506<>CALL
     18507>>IF      18509>>ASSIGN  18511>>IF      18516>>ASSIGN  18525>>CALL    18526>>ASSIGN  18541>>ASSIGN
     18542>>ASSIGN  18543>>ASSIGN  18561>>CALL    18576>>CALL    18594>>ASSIGN  18595>>ASSIGN  18601>>CALL
     18604<>CALL    18609>>ASSIGN  18611>>ASSIGN  18625>>ASSIGN  18641<<ASSIGN  18662>>IF      18664>>IF
     18669>>CALL    18671>>ASSIGN  18672<>CALL    18674>>IF      18676>>CALL    18677>>ASSIGN  18686>>ASSIGN
     18686>>ASSIGN  18707>>CALL    18710>>IF      18714>>ASSIGN  18715>>CALL    18716>>ASSIGN  18718>>IF
     18721>>IF      18731>>ASSIGN  18741<>CALL    18745>>ASSIGN  18746<>CALL    18748>>CALL    18757<>CALL
STRM
     15666**DCL     18195<<CALLBLT 18198<<ASSIGN  18244>>IF      18544>>ASSIGN  18556>>IF      18560>>ASSIGN
     18562>>ASSIGN  18578>>ASSIGN
TEMP$
     15669**DCL     18325<<ASSIGN  18327>>IF      18328>>IF      18329>>IF      18329>>IF      18332>>ASSIGN
UCSTREAM
     15662**DCL     18200<<ASSIGN  18275<<ASSIGN  18556>>IF
UNLOCK_N_ALTRET
     18466**LABEL   18456--GOTO    18512--GOTO
UNLOCK_N_RTN
     18743**LABEL   18680--GOTO    18718--GOTO
VLP_WINDOW
     15013**DCL        72--PROC    18563--IF      18565>>ASSIGN  18574--IF
VLP_WINDOW.FWINDOW
     15013**DCL     15013--REDEF   15014--REDEF
WINDOW
     15923**DCL     18565<<ASSIGN  18566<>CALL    18569<<ASSIGN  18570--ASSIGN  18571--ASSIGN
WINDOW.FWINDOW
PL6.E3A0      #001=KNA$OPEN File=KNA$APE.:E05TSI                                 WED 07/30/97 00:55 Page:125  
     15923**DCL     15923--REDEF   15924--REDEF

PL6.E3A0      #002=KNA$IN File=KNA$APE.:E05TSI                                   WED 07/30/97 00:57 Page:126  
      763        1        /*T***********************************************************/
      764        2        /*T*                                                         */
      765        3        /*T* Copyright (c) Bull HN Information Systems Inc., 1997    */
      766        4        /*T*                                                         */
      767        5        /*T***********************************************************/
      768        6        /*F*
      769        7           NAME: KNA$IN
      770        8           PURPOSE:
      771        9                  To field responses from Session on behalf of the entire
      772       10             Application Presentation Engine code.
      773       11           DESCRIPTION:
      774       12             The address of KNA$IN is put in KN$LDCT.USER_ENTRY$ by KNA$OPEN.
      775       13             KNS$SESSION  will call KN$LDCT.USER_ENTRY$.
      776       14
      777       15                  This routine inspects Session's reason for invoking it and
      778       16             does the appropriate thing.  This may be unreg a user, move data
      779       17             into a user's buffer, etc.
      780       18        */
      781       19        /*D*
      782       20           NAME: KNA$IN
      783       21           CALL:
      784       22                  CALL KNA$IN (INV_FNC,KN$NETPARM,CODE) ALTRET;
      785       23
      786       24                  This routine may ALTRET to indicate to the caller a problem.
      787       25           PARAMETERS:
      788       26                  INV_FNC - Function Session is invoking us for
      789       27                  KN$NETPARM - Structure with all sorts of miscellaneous info
      790       28                  CODE - A reason code associated with some invocations
      791       29           INTERFACE:
      792       30                  GHS$RUE - Report an event on this user
      793       31                  GHH$ASD - Activate a map's Segment Descriptor
      794       32           ENVIRONMENT:
      795       33                  Running on behalf of some unrelated user.
      796       34           DESCRIPTION:
      797       35                  This routine may be invoked for a whole slew of reasons.
      798       36             Session may be communicating: data available, connection established
      799       37             or rejected, connection lost, etc.
PL6.E3A0      #002=KNA$IN File=KNA$APE.:E05TSI                                   WED 07/30/97 00:57 Page:127  
      800       38                  For connection established this routine merely sets some
      801       39             status in the user's SSN context and wakes up the proper user.
      802       40                  For data, this routine checks the function code of the
      803       41             message and handles it.  Typical function codes and actions would
      804       42             be:
      805       43                  WRITE - move data into user's buffer and RUE him
      806       44                  READ - update our throttling info and send RUE the user if
      807       45                         he is currently blocked on a M$WRITE
      808       46        */
      809       47        %EJECT;
PL6.E3A0      #002=KNA$IN File=KNA$APE.:E05TSI                                   WED 07/30/97 00:57 Page:128  
      810       48        KNA$IN: PROC (KN$NETPARM) ALTRET;
      811       49
      812       50        %INCLUDE F_ERRORS_C;
      813      290        %INCLUDE G_LCP6_E;
      814      548        %INCLUDE GH_GATE_M;
      815      589        %INCLUDE GH_SCHD_M;
      816      733        %INCLUDE KN_DATA_M;
      817     2519        %INCLUDE KNH_MACRO_C;
      818     2802        %INCLUDE P_FEP_M;
      819     3240        %INCLUDE KL_MACRO_C;
      820     6592        %INCLUDE K_ID_E;
      821     6642        %K#ENTID_E;
      822     6661        %INCLUDE KI_ERRORS_C;
      823     6746        %INCLUDE KI_SUBS_C;
      824     6882        %INCLUDE KNA_MACRO_M;
      825     6958        %INCLUDE GF_LCP6_M;
      826     7426        %INCLUDE GH_SCHD_E;
      827     7522        %INCLUDE GH_LCP6_M;
      828     8356        %INCLUDE GU_LCP6_M;
      829     9284        %INCLUDE GM_VIRTUAL_E;
      830     9494        %INCLUDE KN_ERRORS_C;
      831     9558        %INCLUDE K$RWPARM;
      832     9944        %INCLUDE KV$VDO;
      833    10959        %INCLUDE K_SCODE_C;
      834    11044
      835    11045        /*     Parameter definitions */
      836    11046        %KN$NETPARM (STCLASS="");
      837    11199
      838    11200        /*     Auto storage */
      839    11201    1   DCL BFR$ CPTR;
      840    11202    1   DCL EVENT UBIN;
      841    11203    1   DCL LSTIOP$ PTR;
      842    11204    1   DCL SSN$ PTR;
      843    11205    1   DCL IOP$ PTR;
      844    11206    1   DCL DATASIZE UBIN;
      845    11207    1   DCL DATAARS UBIN;
      846    11208    1   DCL DATA$ CPTR;
PL6.E3A0      #002=KNA$IN File=KNA$APE.:E05TSI                                   WED 07/30/97 00:57 Page:129  
      847    11209    1   DCL VLP$ PTR;
      848    11210    1   DCL ERR UBIN;
      849    11211    1   DCL TCB_ERR BIT(32);
      850    11212    1   DCL STATE CHAR(4);
      851    11213        %K$RWPARM(NAME=K$RWPARM,STCLASS="");
      852    11529        %K$RWPARM (NAME=OPARM,STCLASS=AUTO);
      853    11845        %G$COMIO (FPTN=COMIO,PARONLY=1,STCLASS=AUTO);
      854    11853        %G$NWIO (FPTN=NWIO,PARONLY=1,STCLASS=AUTO);
      855    11882
      856    11883        /*     External pointers */
      857    11884    1   DCL G$ASDT_MCL$ PTR SYMREF;
      858    11885    1   DCL G$WINDOW1$ PTR SYMREF;
      859    11886    1   DCL G$USRT$ PTR SYMREF;
      860    11887
      861    11888        /*     Based storage */
      862    11889    1   DCL CODE UBIN BASED(KN$NETPARM.FPT$);
      863    11890        %G$USER (FPTN="G$USER(0:0)",STCLASS="BASED(G$USRT$)");
      864    11901    1   DCL DATASTRING CHAR(DATASIZE) BASED;
      865    11902        %M$DCB(DCBN=MYDCB,STCLASS=BASED);
      866    11953        %KN$LDCT (STCLASS="BASED(KN$NETPARM.LDCT$)");
      867    12198        %KN$IOP (STCLASS="BASED(IOP$)");
      868    12371        %G$ASDT_MCL (STCLASS="BASED(G$ASDT_MCL$)");
      869    13065        %KNA$SSN (STCLASS="BASED(SSN$)");
      870    13148        /*     VDO macro invocations  */
      871    13149        %KV_VDO_ALL_E;
      872    13228        %KV$VDO(NAME=KV$VDOHDR,STCLASS="BASED(KN$NETPARM.UHDR$)");
      873    13255        %KV$VDO_EVT(STCLASS="BASED(KN$NETPARM.UHDR$)");
      874    13297        %KV$VDO_RQSDAT;
      875    13345        %KV$VDO_BLKDAT;
      876    13388        /*     Constant */
      877    13389        %VLP_ERRCODE (FPTN=ECNCFAIL,STCLASS=CONSTANT,
      878    13390                       FCG=KN,MID=A,MON='1'B,ERR#=%E$CNCFAIL);
      879    13436        %VLP_ERRCODE (FPTN=ELDSC,STCLASS=CONSTANT,
      880    13437                       FCG=KN,MID=A,MON='1'B,ERR#=%E$LDSC,SEV=G_SEV_ABORT#);
      881    13483        %VLP_ERRCODE (FPTN=EBYD,STCLASS=CONSTANT,
      882    13484                       FCG=KN,MID=A,MON='1'B,ERR#=%E$BYD,SEV=G_SEV_CONT#);
      883    13530        %VLP_SCODE (FPTN=SCR_UNEXP,FCG=KN,MID=A,ERR#=%S$UNEXPRESP,
PL6.E3A0      #002=KNA$IN File=KNA$APE.:E05TSI                                   WED 07/30/97 00:57 Page:130  
      884    13531                       MON='1'B,SEV=G_SEV_SCREECH#,STCLASS=CONSTANT);
      885    13592        %KV$VDO_DAT (NAME=NODAT_VDO,STCLASS=CONSTANT,
      886    13593                       FNC=KV_VDO_FNC_DAT,VLP=YES,LAST=",");
      887    13638        %KV$VDOVLP_ERR (NAME=ERR,LST=YES,LVL=2,STCLASS=CONSTANT,
      888    13639                       FCG=KN,MID=A,ERR#=%E$NODAT,SEV=0,MON='1'B);
      889    13736
      890    13737        /*    Symrefs        */
      891    13738        %GATE(FPTN=KNA_LNKIOP,STCLASS=SYMREF);
      892    13757        %GATE (FPTN=KNA_LNKSSN,STCLASS=SYMREF);
      893    13776
      894    13777        /*     ENTRY definitions
      895    13778        */
      896    13779    1   DCL KNA$FCNO ENTRY(4) ALTRET;
      897    13780    1   DCL KNA$MAP ENTRY(2);
      898    13781    1   DCL GHS$EVENT ENTRY(7);
      899    13782    1   DCL KNA$RLSIOP ENTRY(1) ALTRET;
      900    13783    1   DCL SCREECH ENTRY(1);
      901    13784    1   DCL GHH$ASD ENTRY(2);
      902    13785    1   DCL GHQ$STATE ENTRY(2);
      903    13786    1   DCL GHS$RUE ENTRY(4) ALTRET;
      904    13787    1   DCL GJU$EVENT ENTRY(2);
      905    13788    1   DCL KNS$SEND ENTRY(1) ALTRET;
      906    13789    1   DCL KNA$DECODE_VDO ENTRY(1) ALTRET;
      907    13790
      908    13791        /* Symrefs */
      909    13792        %K$RWPARM (NAME=KNA_RWPARM_CON,STCLASS=SYMREF);
      910    14108        %PS_LCP6STT (STCLASS=SYMREF);
      911    14612        %EJECT;
PL6.E3A0      #002=KNA$IN File=KNA$APE.:E05TSI                                   WED 07/30/97 00:57 Page:131  
      912    14613
      913    14614        /*   Break out what to do by invocation function
      914    14615        */
      915    14616
      916    14617    2      IF KN$NETPARM.FUNCTION ~= %KN_FCN_INIT_ACK THEN DO;
      917    14618                %LOCK (G=KNA_LNKSSN);
      918    14625    2           END;
      919    14626    1      SSN$ = KN$LDCT.UID$;
      920    14627    1   CASE_FCN:
      921    14628    2      DO CASE (KN$NETPARM.FUNCTION);
      922    14629
      923    14630        /*   KN_FCN_INIT_ACK tells us that Session has finished trying to
      924    14631        establish the network connection for us.  We better be in a state to
      925    14632        accept this.  CODE tells us whether the connection attempt actually
      926    14633        succeeded or not.
      927    14634        */
      928    14635
      929    14636    2       CASE (%KN_FCN_INIT_ACK);
      930    14637    2         IF KNA$SSN.STATE ~= %KNA_STATE_WSSNINIT#
      931    14638    2         THEN CALL SCREECH(SCR_UNEXP);
      932    14639
      933    14640    2         IF CODE ~= 0
      934    14641    3         THEN DO;
      935    14642    3              KNA$SSN.ERROR = ECNCFAIL;
      936    14643    3              KNA$SSN.FLAGS.SSNERR = '1'B;
      937    14644    3              END;
      938    14645        /*E* ERROR: KNA-E$CNCFAIL
      939    14646             MESSAGE: The attempt to create the network connection has failed.
      940    14647        */
      941    14648
      942    14649        /*   The connection succeeded, so set the status and wake up our sleepy
      943    14650        user.
      944    14651        */
      945    14652    2         ELSE
      946    14653    2              KNA$SSN.STATE = %KNA_STATE_WSSNOPN#;
      947    14654    2         CALL GHS$RUE(%GH_EVCIC,KNA$SSN.USER#);
      948    14655    2         RETURN;
PL6.E3A0      #002=KNA$IN File=KNA$APE.:E05TSI                                   WED 07/30/97 00:57 Page:132  
      949    14656
      950    14657        %EJECT;
PL6.E3A0      #002=KNA$IN File=KNA$APE.:E05TSI                                   WED 07/30/97 00:57 Page:133  
      951    14658        /*
      952    14659             KN_FCN_DATA involves handling by Presentation function code
      953    14660        the message(s) received.
      954    14661        */
      955    14662    2       CASE (%KN_FCN_DATA);
      956    14663    2         K$RWPARM=KNA_RWPARM_CON;
      957    14664    2         K$RWPARM.UHDR$=KN$NETPARM.UHDR$;
      958    14665    2         K$RWPARM.UHDRSZ = KN$NETPARM.UHDRSZ;
      959    14666
      960    14667    2         IF KV$VDOHDR.FNC = %KV_VDO_FNC_DAT
      961    14668    2         THEN IOP$ = KNA$SSN.IOPRD$;
      962    14669    2         ELSE IOP$=KNA$SSN.IOPQ$;
      963    14670
      964    14671    2         IF IOP$ ~= ADDR(NIL)
      965    14672    3         THEN DO;
      966    14673    3              K$RWPARM.KEYTYPE = KN$IOP.KEYTYPE;
      967    14674    3              K$RWPARM.READMLT = KN$IOP.FLAGS.READMLT;
      968    14675    3              END;
      969    14676    2         CALL KNA$DECODE_VDO(K$RWPARM)
      970    14677    3         WHENALTRETURN DO;
      971    14678    3              CALL PROTOCOL_ERR;
      972    14679    3              EXIT CASE_FCN;
      973    14680    3              END;
      974    14681
      975    14682    3         DO CASE (KV$VDOHDR.FNC);
      976    14683
      977    14684        /*     A WRITE REQUEST contains data for our user.  We will have to
      978    14685        map onto our user's buffer after finding the IO packet for him.
      979    14686        */
      980    14687    3          CASE (%KV_VDO_FNC_DAT,%KV_VDO_FNC_PRM_RSP);
      981    14688
      982    14689        /*
      983    14690          Locate the I/O packet for the stream we just got the buffer for and
      984    14691          screech if we can't find it.
      985    14692                                                                                      */
      986    14693
      987    14694    3            IF IOP$ = ADDR(NIL)
PL6.E3A0      #002=KNA$IN File=KNA$APE.:E05TSI                                   WED 07/30/97 00:57 Page:134  
      988    14695    4            THEN DO;
      989    14696    4                 CALL PROTOCOL_ERR;
      990    14697    4                 EXIT CASE_FCN;
      991    14698    4                 END;
      992    14699        /*
      993    14700          Map onto the users buffer so we can move the data into it
      994    14701                                                                                      */
      995    14702    3            KN$IOP.FLAGS.RDDONE = '1'B;
      996    14703    3            BFR$=VBASE(KN$IOP.BUF_);
      997    14704    3            CALL KNA$MAP(BFR$,KN$IOP.BUFSEGDES);
      998    14705
      999    14706        /*     Now figure out how much data to move into the user's buffer
     1000    14707        and go do it.  The virtual address of the user's buffer (KN$IOP.BUF_)
     1001    14708        has already been adjusted to point into the WINDOW1 segment.
     1002    14709        */
     1003    14710    3            DATA$=K$RWPARM.MSGC$;
     1004    14711    3            DATASIZE=K$RWPARM.MSGSZ;
     1005    14712
     1006    14713    3            IF DATASIZE > VBOUND(KN$IOP.BUF_)+1
     1007    14714    4            THEN DO;
     1008    14715    4                 DATASIZE = VBOUND(KN$IOP.BUF_)+1;
     1009    14716    4                 KN$IOP.FLAGS.TRUNC = '1'B;
     1010    14717    4                 END;
     1011    14718    3            DATAARS = DATASIZE;
     1012    14719
     1013    14720    3            BFR$->DATASTRING = DATA$ -> DATASTRING;
     1014    14721    3            IF KN$IOP.KEY_ ~= VECTOR(NIL)
     1015    14722    4            THEN DO;
     1016    14723    4                 BFR$=VBASE(KN$IOP.KEY_);
     1017    14724    4                 CALL KNA$MAP(BFR$,KN$IOP.KEYSEGDES);
     1018    14725
     1019    14726        /*     Now figure out how much data to move into the user's key buffer
     1020    14727        and go do it.  The virtual address of the user's key buffer (KN$IOP.KEY_)
     1021    14728        has already been adjusted to point into the WINDOW1 segment.
     1022    14729        */
     1023    14730    4                 DATA$=K$RWPARM.KEY$;
     1024    14731    4                 DATASIZE=K$RWPARM.KEYSZ;
PL6.E3A0      #002=KNA$IN File=KNA$APE.:E05TSI                                   WED 07/30/97 00:57 Page:135  
     1025    14732
     1026    14733    4                 IF DATASIZE > VBOUND(KN$IOP.KEY_)+1
     1027    14734    5                 THEN DO;
     1028    14735    5                      DATASIZE = VBOUND(KN$IOP.KEY_)+1;
     1029    14736    5                      KN$IOP.FLAGS.TRUNC = '1'B;
     1030    14737    5                      END;
     1031    14738
     1032    14739    4                 BFR$->DATASTRING = DATA$ -> DATASTRING;
     1033    14740    4                 END;
     1034    14741        /*
     1035    14742          The data has been moved into the buffer.  Now, map over the users
     1036    14743          DCB so we can post status.
     1037    14744                                                                                      */
     1038    14745    3            CALL KNA$MAP(KN$IOP.DCB$,KN$IOP.DCBSEGDES);
     1039    14746
     1040    14747        /* Update the various read counters.
     1041    14748        */
     1042    14749    3            IF KV$VDOHDR.FNC=%KV_VDO_FNC_DAT
     1043    14750    4            THEN DO CASE(KN$IOP.DCB$->MYDCB.DDEV.RES);
     1044    14751    4             CASE(%G_DDEV_RES_HO#);
     1045    14752    4               PS_LCP6STT.BYTES_READ_HOST = PS_LCP6STT.BYTES_READ_HOST + DATAARS;
     1046    14753    4             CASE(%G_DDEV_RES_UC#);
     1047    14754    4               PS_LCP6STT.BYTES_READ_UC = PS_LCP6STT.BYTES_READ_UC + DATAARS;
     1048    14755    4             CASE(%G_DDEV_RES_LG#);
     1049    14756    4               PS_LCP6STT.BYTES_READ_LG = PS_LCP6STT.BYTES_READ_LG + DATAARS;
     1050    14757    4             CASE(%G_DDEV_RES_NA#);
     1051    14758    4               PS_LCP6STT.BYTES_READ_NA = PS_LCP6STT.BYTES_READ_NA + DATAARS;
     1052    14759    4               END/*do case*/;
     1053    14760    3            KN$IOP.DCB$->MYDCB.ARS = DATAARS;
     1054    14761    3            KN$IOP.DCB$->MYDCB.TYC.LD#=KN$IOP.FLAGS.TRUNC;
     1055    14762    3            IF NOT K$RWPARM.EOM_EOR
     1056    14763    3            THEN KN$IOP.DCB$->MYDCB.EOMCHAR=K$RWPARM.DVE.EOMCHAR;
     1057    14764    3            ELSE KN$IOP.DCB$->MYDCB.EOMCHAR=%G_EOM_EOR#;
     1058    14765    3            KN$IOP.DCB$->MYDCB.ACTPOS=K$RWPARM.ACTPOS;
     1059    14766    3            KN$IOP.DCB$->MYDCB.DVBYTE=K$RWPARM.DVE.DVBYTE;
     1060    14767    3            IF KN$IOP.DCB$->MYDCB.ORG = %G_ORG_FORM#
     1061    14768    3            THEN
PL6.E3A0      #002=KNA$IN File=KNA$APE.:E05TSI                                   WED 07/30/97 00:57 Page:136  
     1062    14769    3                 KN$IOP.DCB$->MYDCB.FLDID=K$RWPARM.FLDID;
     1063    14770    3            KN$IOP.ERRCODE = K$RWPARM.MSG_ERRCODE;
     1064    14771    3            KN$IOP.MSGTYPE = K$RWPARM.MSGTYP;
     1065    14772        /*
     1066    14773          RUE the user.  If there were errors, they
     1067    14774          will be reported by KNA$USERIO, who was running on behalf of the
     1068    14775          user, when the user did the MCL.
     1069    14776                                                                                      */
     1070    14777    3   READ_COMP: ;
     1071    14778    3            IF KN$IOP.FLAGS.WAIT
     1072    14779    4            THEN DO;
     1073    14780    4                 IF G$USER.FLG(KNA$SSN.USER#) & %U_SCIO
     1074    14781    4                 THEN CALL GHS$RUE(%GH_EVCIC,KNA$SSN.USER#);
     1075    14782    4                 END;
     1076    14783    4            ELSE DO;                       /* It was a no wait I/O               */
     1077    14784    4                 NWIO = '0'B;
     1078    14785    4                 NWIO.P# = SIZEW(NWIO) - SIZEW(NWIO.P#);
     1079    14786    4                 TCB_ERR = KN$IOP.ERRCODE;
     1080    14787    4                 NWIO.ARS = DATAARS;
     1081    14788    4                 NWIO.DVE.DVBYTE = K$RWPARM.DVE.DVBYTE;
     1082    14789    4                 NWIO.DVE.EOMCHAR = K$RWPARM.DVE.EOMCHAR;
     1083    14790    4                 NWIO.CGPARM.STATION# = K$RWPARM.STATION;
     1084    14791    4                 NWIO.CGPARM.MSGTYP# = K$RWPARM.MSGTYP;
     1085    14792    4                 NWIO.CGPARM.MSGID# = K$RWPARM.MSGID;
     1086    14793    4                 EVENT = KN$IOP.EVENT;
     1087    14794    4                 CALL GHS$EVENT (KNA$SSN.USER#,%GH_USRDMN#,%G_IO_CMP#,EVENT,TCB_ERR,
             14794                          NWIO);
     1088    14795    4                 CALL KNA$RLSIOP(KNA$SSN.IOPRD$);
     1089    14796    4                 KNA$SSN.IOPRD$ = ADDR(NIL);
     1090    14797    4                 END;
     1091    14798        %EJECT;
PL6.E3A0      #002=KNA$IN File=KNA$APE.:E05TSI                                   WED 07/30/97 00:57 Page:137  
     1092    14799        /*   A DCLSTR will cause the MULT_STR bit to be set in KNA$SSN */
     1093    14800    3          CASE (%KV_VDO_FNC_DCLSTR,%KV_VDO_FNC_CLSSTR,%KV_VDO_FNC_OPNSTR);
     1094    14801    3            KNA$SSN.FLAGS.MULT_STR  = '1'B;
     1095    14802
     1096    14803        %EJECT;
PL6.E3A0      #002=KNA$IN File=KNA$APE.:E05TSI                                   WED 07/30/97 00:57 Page:138  
     1097    14804        /*
     1098    14805             A READ (DATA) REQUEST message merely saves the throttling info
     1099    14806        and unREGs our user if he's REGged BLOCKED.
     1100    14807        */
     1101    14808    3          CASE (%KV_VDO_FNC_RQSDAT);
     1102    14809    3            IF KN$NETPARM.UHDR$->KV$VDO_RQSDAT.EOFNO_DAT
     1103    14810    3              AND NOT (KNA$SSN.FLAGS.REGGED AND KNA$SSN.FLAGS.BLOCKED)
     1104    14811    3              AND KNA$SSN.STATE ~= %KNA_STATE_WTERM
     1105    14812    4            THEN DO;
     1106    14813    4                 KN$NETPARM.UHDR$=ADDR(NODAT_VDO);
     1107    14814    4                 KN$NETPARM.UHDRSZ = LENGTHC(NODAT_VDO);
     1108    14815    4                 KN$NETPARM.FUNCTION = %KN_FCN_DATA;
     1109    14816    4                 CALL KNS$SEND(KN$NETPARM) ALTRET(UNLK_N_ALTRET);
     1110    14817    4                 EXIT CASE_FCN;
     1111    14818    4                 END;
     1112    14819    3            IF KN$NETPARM.UHDR$->KV$VDO_RQSDAT.INCMAXNMBRCR
     1113    14820    3            THEN
     1114    14821    3                 KNA$SSN.THRTLVL.MAXNMBRCR = KNA$SSN.THRTLVL.MAXNMBRCR + KN$NETPARM.
             14821                          UHDR$ -> KV$VDO_RQSDAT.MAXNMBRCR;
     1115    14822    3            ELSE
     1116    14823    3                 KNA$SSN.THRTLVL.MAXNMBRCR = KN$NETPARM.UHDR$->KV$VDO_RQSDAT.MAXNMBRCR;
     1117    14824    3            IF KN$NETPARM.UHDR$->KV$VDO_RQSDAT.INCMAXNMBBYT
     1118    14825    4            THEN DO;
     1119    14826    4                 IF KNA$SSN.FLAGS.BLOCKED AND KNA$SSN.FLAGS.REGGED
     1120    14827    5                 THEN DO;
     1121    14828                           %UNLOCK(G=KNA_LNKSSN);
     1122    14835    5                      RETURN;
     1123    14836    5                      END;
     1124    14837    4                 KNA$SSN.THRTLVL.MAXNMBBYT = KNA$SSN.THRTLVL.MAXNMBBYT + KN$NETPARM.
             14837                          UHDR$ -> KV$VDO_RQSDAT.MAXNMBBYT;
     1125    14838    4                 END;
     1126    14839    3            ELSE
     1127    14840    3                 KNA$SSN.THRTLVL.MAXNMBBYT = KN$NETPARM.UHDR$->KV$VDO_RQSDAT.MAXNMBBYT;
     1128    14841    3            KNA$SSN.THRTLVL.MAXRCRBYTSIZ = KN$NETPARM.UHDR$->KV$VDO_RQSDAT.MAXRCRBYTSIZ
             14841                     ;
     1129    14842    3            KNA$SSN.THRTLVL.STR = KN$NETPARM.UHDR$->KV$VDO_RQSDAT.STR;
     1130    14843
PL6.E3A0      #002=KNA$IN File=KNA$APE.:E05TSI                                   WED 07/30/97 00:57 Page:139  
     1131    14844    3            IF KNA$SSN.FLAGS.REGGED = '1'B AND
     1132    14845    3              KNA$SSN.FLAGS.BLOCKED = '1'B
     1133    14846    4            THEN DO;
     1134    14847    4                 CALL GHS$RUE(%GH_EVCUB,KNA$SSN.USER#);
     1135    14848    4                 KNA$SSN.FLAGS.BLOCKED = '0'B;
     1136    14849    4                 END;
     1137    14850    3            IF KNA$SSN.THRTLVL.MAXNMBBYT = 0 OR KNA$SSN.THRTLVL.MAXNMBRCR = 0
     1138    14851    4            THEN DO;
     1139    14852    4                 OPARM = KNA_RWPARM_CON;
     1140    14853    4                 CALL KNA$FCNO(%KV_VDO_FNC_BLKDAT,KNA$SSN,OPARM,KN$NETPARM.ERRCODE)
     1141    14854    5                 WHENALTRETURN DO;
     1142    14855    5   UNLK_N_ALTRET:     ;
     1143    14856                           %UNLOCK (G=KNA_LNKSSN);
     1144    14863    5                      ALTRETURN;
     1145    14864    5                      END;
     1146    14865    4                 END;
     1147    14866    4            ELSE DO;
     1148    14867    4                 IF KNA$SSN.EVENT ~= 0 AND (K$RWPARM.STR = KIDM_USER OR K$RWPARM.STR =
             14867                          KIDM_CP
     1149    14868    4                   OR K$RWPARM.STR ~= KIDM_MON AND KNA$SSN.FLAGS.MULT_STR)
     1150    14869    5                 THEN DO;
     1151    14870    5                      COMIO='0'B;
     1152    14871    5                      COMIO.P#=SIZEW(COMIO)-SIZEW(COMIO.P#);
     1153    14872    5                      COMIO.ARS=KN$NETPARM.UHDR$->KV$VDO_RQSDAT.MAXNMBBYT;
     1154    14873    5                      CALL GHS$EVENT(KNA$SSN.USER#,%GH_USRDMN#,%G_DATA_RQS#,KNA$SSN.
             14873                               EVENT,,COMIO);
     1155    14874    5                      END;
     1156    14875    4                 END;
     1157    14876        %EJECT;
PL6.E3A0      #002=KNA$IN File=KNA$APE.:E05TSI                                   WED 07/30/97 00:57 Page:140  
     1158    14877        /*
     1159    14878             Ignore output block for now
     1160    14879         */
     1161    14880    3          CASE (%KV_VDO_FNC_BLKDAT);
     1162    14881
     1163    14882    3            IF KNA$SSN.EVENT ~= 0 AND (K$RWPARM.STR = KIDM_USER OR K$RWPARM.STR =
             14882                     KIDM_CP
     1164    14883    3              OR K$RWPARM.STR ~= KIDM_MON AND KNA$SSN.FLAGS.MULT_STR)
     1165    14884    4            THEN DO;
     1166    14885    4                 COMIO='0'B;
     1167    14886    4                 COMIO.P#=SIZEW(COMIO)-SIZEW(COMIO.P#);
     1168    14887    4                 COMIO.ARS=KN$NETPARM.UHDR$->KV$VDO_BLKDAT.RCRBYTSIZ;
     1169    14888    4                 CALL GHS$EVENT(KNA$SSN.USER#,%GH_USRDMN#,%G_DATA_AVL#,KNA$SSN.EVENT,,
             14888                          COMIO);
     1170    14889    4                 END;
     1171    14890        %EJECT;
PL6.E3A0      #002=KNA$IN File=KNA$APE.:E05TSI                                   WED 07/30/97 00:57 Page:141  
     1172    14891    3          CASE (%KV_VDO_FNC_DAT_IMD);
     1173    14892    3            IF KV$VDOHDR.STR = KIDM_MON    /* Monitor stream                     */
     1174    14893    4            THEN DO;
     1175    14894    4                 DATASIZE=K$RWPARM.MSGSZ;
     1176    14895    4                 DATA$=K$RWPARM.MSGC$;
     1177    14896
     1178    14897
     1179    14898    4                 CALL GJU$EVENT(KNA$SSN.USER#,DATA$->DATASTRING);
     1180    14899    4                 END;
     1181    14900
     1182    14901        %EJECT;
PL6.E3A0      #002=KNA$IN File=KNA$APE.:E05TSI                                   WED 07/30/97 00:57 Page:142  
     1183    14902    3          CASE (%KV_VDO_FNC_EVT);
     1184    14903    3            IF KNA$SSN.STATE = %KNA_STATE_ACTIVE#
     1185    14904    3            THEN
     1186    14905    3                 IF KV$VDO_EVT.TYP = %KV_EVTTYP_BRK
     1187    14906    3                   AND KV$VDO_EVT.BRKCNT < 4
     1188    14907    3                 THEN
     1189    14908    3                      CALL GHS$RUE(%GH_EVCBK,KNA$SSN.USER#);
     1190    14909    3                 ELSE
     1191    14910    3                      CALL GHS$RUE(%GH_EVCEC,KNA$SSN.USER#);
     1192    14911    3            GOTO CHECK_MRKPND;
     1193    14912        %EJECT;
PL6.E3A0      #002=KNA$IN File=KNA$APE.:E05TSI                                   WED 07/30/97 00:57 Page:143  
     1194    14913    3          CASE (%KV_VDO_FNC_DSC_RQS);
     1195    14914    3            IF KNA$SSN.STATE = %KNA_STATE_ACTIVE#
     1196    14915    3            THEN
     1197    14916    3                 CALL GHS$RUE(%GH_EVDSC,KNA$SSN.USER#);
     1198    14917    3            KNA$SSN.STATE = %KNA_STATE_DSC#;
     1199    14918    3            KNA$SSN.ERROR = ELDSC;
     1200    14919    3            KNA$SSN.FLAGS.SSNERR = '1'B;
     1201    14920    3            GOTO CHECK_MRKPND;
     1202    14921
     1203    14922        %EJECT;
PL6.E3A0      #002=KNA$IN File=KNA$APE.:E05TSI                                   WED 07/30/97 00:57 Page:144  
     1204    14923    3          CASE (%KV_VDO_FNC_CLSSSN_RQS);
     1205    14924    3            KNA$SSN.STATE = %KNA_STATE_DSC#;
     1206    14925    3            CALL GHS$RUE(%GH_EVBRK,KNA$SSN.USER#);
     1207    14926    3            KNA$SSN.ERROR = ELDSC;
     1208    14927    3            IF KNA$SSN.IOPRD$ ~= ADDR(NIL)
     1209    14928    3              AND NOT KNA$SSN.IOPRD$->KN$IOP.FLAGS.RDDONE
     1210    14929    4            THEN DO;
     1211    14930    4                 KNA$SSN.IOPRD$->KN$IOP.ERRCODE = ELDSC;
     1212    14931    4                 IOP$ = KNA$SSN.IOPRD$;
     1213    14932    4                 GOTO READ_COMP;
     1214    14933    4                 END;
     1215    14934
     1216    14935        %EJECT;
PL6.E3A0      #002=KNA$IN File=KNA$APE.:E05TSI                                   WED 07/30/97 00:57 Page:145  
     1217    14936    3          CASE (%KV_VDO_FNC_PRM_SET);
     1218    14937
     1219    14938        %EJECT;
PL6.E3A0      #002=KNA$IN File=KNA$APE.:E05TSI                                   WED 07/30/97 00:57 Page:146  
     1220    14939    3          CASE (%KV_VDO_FNC_RQSMRK);
     1221    14940    3   CHECK_MRKPND: ;
     1222    14941    3            IF K$RWPARM.MRKTYP = %KV_VDOMRKTYP_MRK
     1223    14942    4            THEN DO;
     1224    14943                                           /*  If there is a marker pending send it   */
     1225    14944    4                 IF (KNA$SSN.FLAGS.MRKPND)
     1226    14945    5                 THEN DO;
     1227    14946    5                      OPARM = KNA_RWPARM_CON;
     1228    14947    5                      OPARM.MARKER = KNA$SSN.MARKER;
     1229    14948    5                      OPARM.MRKTYP = %KV_VDOMRKTYP_MRK;
     1230    14949    5                      CALL KNA$FCNO(%KV_VDO_FNC_MRK,KNA$SSN,OPARM,KN$NETPARM.ERRCODE)
     1231    14950    5                        ALTRET (UNLK_N_ALTRET);
     1232    14951    5                      END;
     1233    14952                                            /* Save marker for EXIT, next READ, or
     1234    14953                                                an EVENT. */
     1235    14954    4                 KNA$SSN.MARKER = K$RWPARM.MARKER;
     1236    14955    4                 KNA$SSN.FLAGS.MRKPND = '1'B;
     1237    14956                                            /* Clear marker type so we don't send a
     1238    14957                                                marker back */
     1239    14958    4                 K$RWPARM.MRKTYP = 0;
     1240    14959    4                 END ;                     /* Do Case                            */
     1241    14960        %EJECT;
PL6.E3A0      #002=KNA$IN File=KNA$APE.:E05TSI                                   WED 07/30/97 00:57 Page:147  
     1242    14961    3          CASE (%KV_VDO_FNC_RQSSTT);
     1243    14962    3            CALL GHQ$STATE(KN$LDCT.USER#,STATE);
     1244    14963    3            K$RWPARM.MSG$ = ADDR(STATE);
     1245    14964    3            K$RWPARM.MSGSZ = SIZEC(STATE);
     1246    14965    3            CALL KNA$FCNO (%KV_VDO_FNC_STT,KNA$SSN,K$RWPARM,KN$NETPARM.ERRCODE)
     1247    14966    3              ALTRET (UNLK_N_ALTRET);
     1248    14967
     1249    14968
     1250    14969        %EJECT;
PL6.E3A0      #002=KNA$IN File=KNA$APE.:E05TSI                                   WED 07/30/97 00:57 Page:148  
     1251    14970    3          CASE (%KV_VDO_FNC_MRK);
     1252    14971
     1253    14972    3            IF KNA$SSN.FLAGS.RRRPND AND KNA$SSN.FLAGS.REGGED
     1254    14973    3              AND G$USER.FLG(KNA$SSN.USER#) & %U_SCIO
     1255    14974    4            THEN DO;
     1256    14975    4                 IOP$ = KNA$SSN.IOPQ$;
     1257    14976    4                 IF IOP$ ~= ADDR(NIL)
     1258    14977    5                 THEN DO;
     1259    14978    5                      KN$IOP.ERRCODE = K$RWPARM.MSG_ERRCODE;
     1260    14979    5                      KN$IOP.MSGID = K$RWPARM.MSGID;
     1261    14980    5                      KN$IOP.FLDID = K$RWPARM.FLDID;
     1262    14981    5                      END;
     1263    14982    4                 CALL GHS$RUE (%GH_EVCIC,KNA$SSN.USER#);
     1264    14983    4                 KNA$SSN.FLAGS.RRRPND= '0'B;
     1265    14984    4                 END;
     1266    14985                                 /* Clear marker type so we wont send a marker back   */
     1267    14986    3            K$RWPARM.MRKTYP = 0;
     1268    14987
     1269    14988        %EJECT;
PL6.E3A0      #002=KNA$IN File=KNA$APE.:E05TSI                                   WED 07/30/97 00:57 Page:149  
     1270    14989    3          CASE (ELSE);
     1271    14990    3            CALL PROTOCOL_ERR;
     1272    14991    3            END/* do case (kv$vdohdr.fnc) */;
     1273    14992
     1274    14993    2         IF K$RWPARM.MRKTYP ~= 0
     1275    14994    3         THEN DO;
     1276    14995    3              OPARM = KNA_RWPARM_CON;
     1277    14996    3              OPARM.MRKTYP = K$RWPARM.MRKTYP;
     1278    14997
     1279    14998    4              DO CASE(K$RWPARM.MRKTYP);
     1280    14999
     1281    15000    4               CASE (%KV_VDOMRKTYP_SNDLSTRCRID);
     1282    15001    4                 OPARM.BLKREC = KNA$SSN.BLKREC;
     1283    15002    4                 OPARM.MRKTYP = %KV_VDOMRKTYP_LSTRCRID;
     1284    15003
     1285    15004    4               CASE (%KV_VDOMRKTYP_LSTRCRID);
     1286    15005    4                 KNA$SSN.BLKREC = K$RWPARM.BLKREC;
     1287    15006    4                 GOTO NO_MARKER;
     1288    15007
     1289    15008    4               CASE (%KV_VDOMRKTYP_ENDACK,%KV_VDOMRKTYP_MRK);
     1290    15009    4                 OPARM.MARKER = K$RWPARM.MARKER;
     1291    15010
     1292    15011    4                 END;
     1293    15012
     1294    15013    3              CALL KNA$FCNO (%KV_VDO_FNC_MRK,KNA$SSN,OPARM,KN$NETPARM.ERRCODE)
     1295    15014    4              WHENALTRETURN DO;
     1296    15015    4                   KV$VDOHDR.FNC = %KV_VDO_FNC_RQSMRK;
     1297    15016    4                   GOTO UNLK_N_ALTRET;
     1298    15017    4                   END;
     1299    15018    3   NO_MARKER: ;
     1300    15019    3              END;
     1301    15020        %EJECT;
PL6.E3A0      #002=KNA$IN File=KNA$APE.:E05TSI                                   WED 07/30/97 00:57 Page:150  
     1302    15021    2       CASE (%KN_FCN_UNQ);
     1303    15022    2         IF KNA$SSN.FLAGS.CQ
     1304    15023    3         THEN DO;
     1305    15024    3              CALL GHS$RUE(%GH_EVCUB,KNA$SSN.USER#);
     1306    15025    3              KNA$SSN.FLAGS.CQ = '0'B;
     1307    15026    3              KNA$SSN.FLAGS.REGGED = '0'B;
     1308    15027    3              END;
     1309    15028        %EJECT;
PL6.E3A0      #002=KNA$IN File=KNA$APE.:E05TSI                                   WED 07/30/97 00:57 Page:151  
     1310    15029    2       CASE (%KN_FCN_TERM);
     1311    15030    2         IF KNA$SSN.FLAGS.PRIMARY
     1312    15031    2         THEN
     1313    15032    2              CALL GHS$RUE (%GH_EVDSC,KNA$SSN.USER#);
     1314    15033    2         KNA$SSN.ERROR = ELDSC;
     1315    15034    2         KNA$SSN.FLAGS.SSNERR = '1'B;
     1316    15035    2         KNA$SSN.STATE = %KNA_STATE_TERM#;
     1317    15036    2         IF G$USER.FLG(KNA$SSN.USER#) & %U_SCIO
     1318    15037    2           AND G$USER.MISC$(KNA$SSN.USER#) = KNA$SSN.LDCT$
     1319    15038    2         THEN
     1320    15039    2              CALL GHS$RUE (%GH_EVFC,KNA$SSN.USER#);
     1321    15040
     1322    15041        %EJECT;
PL6.E3A0      #002=KNA$IN File=KNA$APE.:E05TSI                                   WED 07/30/97 00:57 Page:152  
     1323    15042    2       CASE (%KN_FCN_TERM_ACK);
     1324    15043    2         CALL GHS$RUE (%GH_EVCIC,KNA$SSN.USER#);
     1325    15044
     1326    15045        %EJECT;
PL6.E3A0      #002=KNA$IN File=KNA$APE.:E05TSI                                   WED 07/30/97 00:57 Page:153  
     1327    15046    2       CASE (ELSE);
     1328    15047    2         CALL SCREECH (SCR_UNEXP);
     1329    15048    2         END;
     1330    15049           %UNLOCK (G=KNA_LNKSSN);
     1331    15056    1      RETURN;
     1332    15057        %EJECT;
PL6.E3A0      #002=KNA$IN File=KNA$APE.:E05TSI                                   WED 07/30/97 00:57 Page:154  
     1333    15058    1   PROTOCOL_ERR: PROC;
     1334    15059
     1335    15060        /*N* ERROR LOG */
     1336    15061    2      RETURN;
     1337    15062
     1338    15063    2   END PROTOCOL_ERR;
     1339    15064
     1340    15065    1   END KNA$IN;
     1341    15066        %EOD;

PL6.E3A0      #002=KNA$IN File=KNA$APE.:E05TSI                                   WED 07/30/97 00:57 Page:155  
--  Include file information  --

   K_SCODE_C.:E05TOU  is referenced.
   KV$VDO.:E05TOU  is referenced.
   K$RWPARM.:E05TOU  is referenced.
   KN_ERRORS_C.:E05TOU  is referenced.
   GM_VIRTUAL_E.:E05TOU  is referenced.
   GU_LCP6_M.:E05TOU  is referenced.
   GH_LCP6_M.:E05TOU  is referenced.
   GH_SCHD_E.:E05TOU  is referenced.
   GF_LCP6_M.:E05TOU  is referenced.
   KNA_MACRO_M.:E05TOU  is referenced.
   KI_SUBS_C.:E05TOU  is referenced.
   KI_ERRORS_C.:E05TOU  is referenced.
   K_ID_E.:E05TOU  is referenced.
   KL_MACRO_C.:E05TOU  is referenced.
   P_FEP_M.:E05TOU  is referenced.
   KNH_MACRO_C.:E05TOU  is referenced.
   KN_DATA_M.:E05TOU  is referenced.
   GH_SCHD_M.:E05TOU  is referenced.
   GH_GATE_M.:E05TOU  cannot be made into a system file and is referenced.
   G_LCP6_E.:E05TOU  is referenced.
   F_ERRORS_C.:E05TOU  is referenced.
      No diagnostics issued in procedure KNA$IN.

   Procedure KNA$IN requires 1669 words for executable code.
   Procedure KNA$IN requires 140 words of local(AUTO) storage.

PL6.E3A0      #002=KNA$IN File=KNA$APE.:E05TSI                                   WED 07/30/97 00:57 Page:156  

 Object Unit name= KNA$IN                                     File name= KNA$APE.:E05TOU
 UTS= JUL 30 '97 00:57:01.72 WED                              Compiler= PL-6/E31         Sev=      00
 SharedLib= :SHARED_LCP6_SYSTEM                               Alt SharedLib=


    ****  Control sections  ****

 Sect   Type Bound  Init  Size HexSiz  Section name
    0  RoData even  UTS     15      F  KNA$IN
    1   Proc  even  none  1669    685  KNA$IN
    2  RoData even  none     7      7  KNA$IN

    ****  Entry defs  ****

                              Check   Calling
                             calling  sequence
  Sect HexLoc Primary Altret sequence   type   Parms  Name
     1      0   yes    yes     yes      Std        1  KNA$IN
PL6.E3A0      #002=KNA$IN File=KNA$APE.:E05TSI                                   WED 07/30/97 00:57 Page:157  

  ****  Entry refs  ****

         Check        Calling
        calling       sequence
Altret sequence SRef   type   Args  Name
 yes     yes           Std       1 GHH$LOCK
         yes           Std       1 SCREECH
 yes     yes           Std       1 GHH$UNLOCK
 yes     yes           Std       4 GHS$RUE
         yes           Std       2 KNA$MAP
 yes     yes           Std       1 KNA$DECODE_VDO
         yes           Std       7 GHS$EVENT
 yes     yes           Std       1 KNS$SEND
         yes           Std       2 GHQ$STATE
 yes     yes           Std       1 KNA$RLSIOP
 yes     yes           Std       4 KNA$FCNO
         yes           Std       2 GJU$EVENT
                       nStd      0 X6A_AUTO_1
                       nStd      0 X6A_ARET
                       nStd      0 X6A_AALT

  ****  Data refs  ****

  Flags:  r = read only, s = secondary
Flgs Name                             Flgs Name                             Flgs Name
     G$ASDT_MCL$                           G$USRT$                               KNA_LNKSSN
     KNA_RWPARM_CON                        PS_LCP6STT                       r    G$ROS$
PL6.E3A0      #002=KNA$IN File=KNA$APE.:E05TSI                                   WED 07/30/97 00:57 Page:158  


      763        1        /*T***********************************************************/
      764        2        /*T*                                                         */
      765        3        /*T* Copyright (c) Bull HN Information Systems Inc., 1997    */
      766        4        /*T*                                                         */
      767        5        /*T***********************************************************/
      768        6        /*F*
      769        7           NAME: KNA$IN
      770        8           PURPOSE:
      771        9                  To field responses from Session on behalf of the entire
      772       10             Application Presentation Engine code.
      773       11           DESCRIPTION:
      774       12             The address of KNA$IN is put in KN$LDCT.USER_ENTRY$ by KNA$OPEN.
      775       13             KNS$SESSION  will call KN$LDCT.USER_ENTRY$.
      776       14
      777       15                  This routine inspects Session's reason for invoking it and
      778       16             does the appropriate thing.  This may be unreg a user, move data
      779       17             into a user's buffer, etc.
      780       18        */
      781       19        /*D*
      782       20           NAME: KNA$IN
      783       21           CALL:
      784       22                  CALL KNA$IN (INV_FNC,KN$NETPARM,CODE) ALTRET;
      785       23
      786       24                  This routine may ALTRET to indicate to the caller a problem.
      787       25           PARAMETERS:
      788       26                  INV_FNC - Function Session is invoking us for
      789       27                  KN$NETPARM - Structure with all sorts of miscellaneous info
      790       28                  CODE - A reason code associated with some invocations
      791       29           INTERFACE:
      792       30                  GHS$RUE - Report an event on this user
      793       31                  GHH$ASD - Activate a map's Segment Descriptor
      794       32           ENVIRONMENT:
      795       33                  Running on behalf of some unrelated user.
      796       34           DESCRIPTION:
      797       35                  This routine may be invoked for a whole slew of reasons.
      798       36             Session may be communicating: data available, connection established
PL6.E3A0      #002=KNA$IN File=KNA$APE.:E05TSI                                   WED 07/30/97 00:57 Page:159  
      799       37             or rejected, connection lost, etc.
      800       38                  For connection established this routine merely sets some
      801       39             status in the user's SSN context and wakes up the proper user.
      802       40                  For data, this routine checks the function code of the
      803       41             message and handles it.  Typical function codes and actions would
      804       42             be:
      805       43                  WRITE - move data into user's buffer and RUE him
      806       44                  READ - update our throttling info and send RUE the user if
      807       45                         he is currently blocked on a M$WRITE
      808       46        */
      809       47        %EJECT;
PL6.E3A0      #002=KNA$IN File=KNA$APE.:E05TSI                                   WED 07/30/97 00:57 Page:160  
      810       48        KNA$IN: PROC (KN$NETPARM) ALTRET;

     48   1 000000  D380 0000 0000  xent KNA$IN          LNJ,B5   X6A_AUTO_1
          1 000003       008C 0001                       DC       140,1

      811       49
      812       50        %INCLUDE F_ERRORS_C;
      813      290        %INCLUDE G_LCP6_E;
      814      548        %INCLUDE GH_GATE_M;
      815      589        %INCLUDE GH_SCHD_M;
      816      733        %INCLUDE KN_DATA_M;
      817     2519        %INCLUDE KNH_MACRO_C;
      818     2802        %INCLUDE P_FEP_M;
      819     3240        %INCLUDE KL_MACRO_C;
      820     6592        %INCLUDE K_ID_E;
      821     6642        %K#ENTID_E;
      822     6661        %INCLUDE KI_ERRORS_C;
      823     6746        %INCLUDE KI_SUBS_C;
      824     6882        %INCLUDE KNA_MACRO_M;
      825     6958        %INCLUDE GF_LCP6_M;
      826     7426        %INCLUDE GH_SCHD_E;
      827     7522        %INCLUDE GH_LCP6_M;
      828     8356        %INCLUDE GU_LCP6_M;
      829     9284        %INCLUDE GM_VIRTUAL_E;
      830     9494        %INCLUDE KN_ERRORS_C;
      831     9558        %INCLUDE K$RWPARM;
      832     9944        %INCLUDE KV$VDO;
      833    10959        %INCLUDE K_SCODE_C;
      834    11044
      835    11045        /*     Parameter definitions */
      836    11046        %KN$NETPARM (STCLASS="");
      837    11199
      838    11200        /*     Auto storage */
      839    11201    1   DCL BFR$ CPTR;
      840    11202    1   DCL EVENT UBIN;
      841    11203    1   DCL LSTIOP$ PTR;
      842    11204    1   DCL SSN$ PTR;
PL6.E3A0      #002=KNA$IN File=KNA$APE.:E05TSI                                   WED 07/30/97 00:57 Page:161  
      843    11205    1   DCL IOP$ PTR;
      844    11206    1   DCL DATASIZE UBIN;
      845    11207    1   DCL DATAARS UBIN;
      846    11208    1   DCL DATA$ CPTR;
      847    11209    1   DCL VLP$ PTR;
      848    11210    1   DCL ERR UBIN;
      849    11211    1   DCL TCB_ERR BIT(32);
      850    11212    1   DCL STATE CHAR(4);
      851    11213        %K$RWPARM(NAME=K$RWPARM,STCLASS="");
      852    11529        %K$RWPARM (NAME=OPARM,STCLASS=AUTO);
      853    11845        %G$COMIO (FPTN=COMIO,PARONLY=1,STCLASS=AUTO);
      854    11853        %G$NWIO (FPTN=NWIO,PARONLY=1,STCLASS=AUTO);
      855    11882
      856    11883        /*     External pointers */
      857    11884    1   DCL G$ASDT_MCL$ PTR SYMREF;
      858    11885    1   DCL G$WINDOW1$ PTR SYMREF;
      859    11886    1   DCL G$USRT$ PTR SYMREF;
      860    11887
      861    11888        /*     Based storage */
      862    11889    1   DCL CODE UBIN BASED(KN$NETPARM.FPT$);
      863    11890        %G$USER (FPTN="G$USER(0:0)",STCLASS="BASED(G$USRT$)");
      864    11901    1   DCL DATASTRING CHAR(DATASIZE) BASED;
      865    11902        %M$DCB(DCBN=MYDCB,STCLASS=BASED);
      866    11953        %KN$LDCT (STCLASS="BASED(KN$NETPARM.LDCT$)");
      867    12198        %KN$IOP (STCLASS="BASED(IOP$)");
      868    12371        %G$ASDT_MCL (STCLASS="BASED(G$ASDT_MCL$)");
      869    13065        %KNA$SSN (STCLASS="BASED(SSN$)");
      870    13148        /*     VDO macro invocations  */
      871    13149        %KV_VDO_ALL_E;
      872    13228        %KV$VDO(NAME=KV$VDOHDR,STCLASS="BASED(KN$NETPARM.UHDR$)");
      873    13255        %KV$VDO_EVT(STCLASS="BASED(KN$NETPARM.UHDR$)");
      874    13297        %KV$VDO_RQSDAT;
      875    13345        %KV$VDO_BLKDAT;
      876    13388        /*     Constant */
      877    13389        %VLP_ERRCODE (FPTN=ECNCFAIL,STCLASS=CONSTANT,
      878    13390                       FCG=KN,MID=A,MON='1'B,ERR#=%E$CNCFAIL);
      879    13436        %VLP_ERRCODE (FPTN=ELDSC,STCLASS=CONSTANT,
PL6.E3A0      #002=KNA$IN File=KNA$APE.:E05TSI                                   WED 07/30/97 00:57 Page:162  
      880    13437                       FCG=KN,MID=A,MON='1'B,ERR#=%E$LDSC,SEV=G_SEV_ABORT#);
      881    13483        %VLP_ERRCODE (FPTN=EBYD,STCLASS=CONSTANT,
      882    13484                       FCG=KN,MID=A,MON='1'B,ERR#=%E$BYD,SEV=G_SEV_CONT#);
      883    13530        %VLP_SCODE (FPTN=SCR_UNEXP,FCG=KN,MID=A,ERR#=%S$UNEXPRESP,
      884    13531                       MON='1'B,SEV=G_SEV_SCREECH#,STCLASS=CONSTANT);
      885    13592        %KV$VDO_DAT (NAME=NODAT_VDO,STCLASS=CONSTANT,
      886    13593                       FNC=KV_VDO_FNC_DAT,VLP=YES,LAST=",");
      887    13638        %KV$VDOVLP_ERR (NAME=ERR,LST=YES,LVL=2,STCLASS=CONSTANT,
      888    13639                       FCG=KN,MID=A,ERR#=%E$NODAT,SEV=0,MON='1'B);
      889    13736
      890    13737        /*    Symrefs        */
      891    13738        %GATE(FPTN=KNA_LNKIOP,STCLASS=SYMREF);
      892    13757        %GATE (FPTN=KNA_LNKSSN,STCLASS=SYMREF);
      893    13776
      894    13777        /*     ENTRY definitions
      895    13778        */
      896    13779    1   DCL KNA$FCNO ENTRY(4) ALTRET;
      897    13780    1   DCL KNA$MAP ENTRY(2);
      898    13781    1   DCL GHS$EVENT ENTRY(7);
      899    13782    1   DCL KNA$RLSIOP ENTRY(1) ALTRET;
      900    13783    1   DCL SCREECH ENTRY(1);
      901    13784    1   DCL GHH$ASD ENTRY(2);
      902    13785    1   DCL GHQ$STATE ENTRY(2);
      903    13786    1   DCL GHS$RUE ENTRY(4) ALTRET;
      904    13787    1   DCL GJU$EVENT ENTRY(2);
      905    13788    1   DCL KNS$SEND ENTRY(1) ALTRET;
      906    13789    1   DCL KNA$DECODE_VDO ENTRY(1) ALTRET;
      907    13790
      908    13791        /* Symrefs */
      909    13792        %K$RWPARM (NAME=KNA_RWPARM_CON,STCLASS=SYMREF);
      910    14108        %PS_LCP6STT (STCLASS=SYMREF);
      911    14612        %EJECT;
PL6.E3A0      #002=KNA$IN File=KNA$APE.:E05TSI                                   WED 07/30/97 00:57 Page:163  
      912    14613
      913    14614        /*   Break out what to do by invocation function
      914    14615        */
      915    14616
      916    14617    2      IF KN$NETPARM.FUNCTION ~= %KN_FCN_INIT_ACK THEN DO;

  14617   1 000005  ECC7 0004                            LDB,B6   @KN$NETPARM,AUTO
          1 000007  E846 0014                            LDR,R6   20,B6
          1 000009  6D02                                 CMV,R6   2
          1 00000A  0901 000A                            BE       s:14626,PREL

      917    14618                %LOCK (G=KNA_LNKSSN);

  14623   1 00000C  BB80 0000 0000  02                   LAB,B3   0
          1 00000F  CBF0 0100                            LAB,B4   256,IMO
          1 000011  E380 0000 0000  xent                 LNJ,B6   GHH$LOCK
          1 000014       0001                            DC       s:14626,PREL

      918    14625    2           END;

      919    14626    1      SSN$ = KN$LDCT.UID$;

  14626   1 000015  ECC7 0004                            LDB,B6   @KN$NETPARM,AUTO
          1 000017  DC86                                 LDB,B5   ,B6
          1 000018  CCC5 0005                            LDB,B4   5,B5
          1 00001A  CFC7 000B                            STB,B4   SSN$,AUTO

      920    14627    1   CASE_FCN:
      921    14628    2      DO CASE (KN$NETPARM.FUNCTION);

  14628   1 00001C  B846 0014            CASE_FCN        LDR,R3   20,B6
          1 00001E  3D09                                 CMV,R3   9
          1 00001F  0281 064A                            BGE      s:15047,PREL
          1 000021  A830 0000 0027  01                   LDR,R2   CASE_FCN+11,R3
          1 000024  83A0 0000 0030  01                   JMP      s:14637,R2
          1 000027       063A                            DC       s:15047,PREL
          1 000028       063A                            DC       s:15047,PREL
PL6.E3A0      #002=KNA$IN File=KNA$APE.:E05TSI                                   WED 07/30/97 00:57 Page:164  
          1 000029       0000                            DC       s:14637,PREL
          1 00002A       05DC                            DC       s:15030,PREL
          1 00002B       0628                            DC       s:15043,PREL
          1 00002C       0038                            DC       s:14663,PREL
          1 00002D       063A                            DC       s:15047,PREL
          1 00002E       063A                            DC       s:15047,PREL
          1 00002F       05C0                            DC       s:15022,PREL

      922    14629
      923    14630        /*   KN_FCN_INIT_ACK tells us that Session has finished trying to
      924    14631        establish the network connection for us.  We better be in a state to
      925    14632        accept this.  CODE tells us whether the connection attempt actually
      926    14633        succeeded or not.
      927    14634        */
      928    14635
      929    14636    2       CASE (%KN_FCN_INIT_ACK);

      930    14637    2         IF KNA$SSN.STATE ~= %KNA_STATE_WSSNINIT#

  14637   1 000030  E844 0013                            LDR,R6   19,B4
          1 000032  6D01                                 CMV,R6   1
          1 000033  0901 000A                            BE       s:14640,PREL

      931    14638    2         THEN CALL SCREECH(SCR_UNEXP);

  14638   1 000035  BB80 0000 0002  02                   LAB,B3   +2
          1 000038  CBF0 0100                            LAB,B4   256,IMO
          1 00003A  E380 0000 0000  xent                 LNJ,B6   SCREECH
          1 00003D       0001                            DC       s:14640,PREL

      932    14639
      933    14640    2         IF CODE ~= 0

  14640   1 00003E  ECC7 0004                            LDB,B6   @KN$NETPARM,AUTO
          1 000040  DCC6 0019                            LDB,B5   25,B6
          1 000042  E805                                 LDR,R6   ,B5
          1 000043  6901 000C                            BEZ,R6   s:14653,PREL
PL6.E3A0      #002=KNA$IN File=KNA$APE.:E05TSI                                   WED 07/30/97 00:57 Page:165  

      934    14641    3         THEN DO;

      935    14642    3              KNA$SSN.ERROR = ECNCFAIL;

  14642   1 000045  8C80 0000 0000  00                   LDI      ECNCFAIL
          1 000048  CCC7 000B                            LDB,B4   SSN$,AUTO
          1 00004A  8D44 0001                            SDI      1,B4

      936    14643    3              KNA$SSN.FLAGS.SSNERR = '1'B;

  14643   1 00004C  8904                                 LBT,'0800'X       ,B4
  14643   1 00004D       0800

      937    14644    3              END;

  14644   1 00004E  0F81 0006                            B        s:14654,PREL

      938    14645        /*E* ERROR: KNA-E$CNCFAIL
      939    14646             MESSAGE: The attempt to create the network connection has failed.
      940    14647        */
      941    14648
      942    14649        /*   The connection succeeded, so set the status and wake up our sleepy
      943    14650        user.
      944    14651        */
      945    14652    2         ELSE
      946    14653    2              KNA$SSN.STATE = %KNA_STATE_WSSNOPN#;

  14653   1 000050  CCC7 000B                            LDB,B4   SSN$,AUTO
          1 000052  5C02                                 LDV,R5   2
          1 000053  DF44 0013                            STR,R5   19,B4

      947    14654    2         CALL GHS$RUE(%GH_EVCIC,KNA$SSN.USER#);

  14654   1 000055  DBF0 0017                            LAB,B5   23,IMO
          1 000057  BBC4 0011                            LAB,B3   17,B4
          1 000059  BFC7 0082                            STB,B3   NWIO+20,AUTO
PL6.E3A0      #002=KNA$IN File=KNA$APE.:E05TSI                                   WED 07/30/97 00:57 Page:166  
          1 00005B  DFC7 0080                            STB,B5   NWIO+18,AUTO
          1 00005D  BBC7 0080                            LAB,B3   NWIO+18,AUTO
          1 00005F  CBF0 0200                            LAB,B4   512,IMO
          1 000061  E380 0000 0000  xent                 LNJ,B6   GHS$RUE
          1 000064       0001                            DC       s:14655,PREL

      948    14655    2         RETURN;

  14655   1 000065  C380 0000 0000  xent                 LNJ,B4   X6A_ARET

      949    14656
      950    14657        %EJECT;
PL6.E3A0      #002=KNA$IN File=KNA$APE.:E05TSI                                   WED 07/30/97 00:57 Page:167  
      951    14658        /*
      952    14659             KN_FCN_DATA involves handling by Presentation function code
      953    14660        the message(s) received.
      954    14661        */
      955    14662    2       CASE (%KN_FCN_DATA);

      956    14663    2         K$RWPARM=KNA_RWPARM_CON;

  14663   1 000068  AB80 0000 0000  xsym                 LAB,B2   KNA_RWPARM_CON
          1 00006B  2C00                                 LDV,R2   0
          1 00006C  6C52                                 LDV,R6   82
          1 00006D  BB87                                 LAB,B3   ,AUTO
          1 00006E  3C34                                 LDV,R3   52
          1 00006F  0008                                 MMM

      957    14664    2         K$RWPARM.UHDR$=KN$NETPARM.UHDR$;

  14664   1 000070  DCC6 0005                            LDB,B5   5,B6
          1 000072  DFC7 0031                            STB,B5   K$RWPARM+23,AUTO

      958    14665    2         K$RWPARM.UHDRSZ = KN$NETPARM.UHDRSZ;

  14665   1 000074  E846 0007                            LDR,R6   7,B6
          1 000076  EF47 0033                            STR,R6   K$RWPARM+25,AUTO

      959    14666
      960    14667    2         IF KV$VDOHDR.FNC = %KV_VDO_FNC_DAT

  14667   1 000078  CCC6 0005                            LDB,B4   5,B6
          1 00007A  D284                                 LLH,R5   ,B4
          1 00007B  5D05                                 CMV,R5   5
          1 00007C  0981 0009                            BNE      s:14669,PREL

      961    14668    2         THEN IOP$ = KNA$SSN.IOPRD$;

  14668   1 00007E  ACC7 000B                            LDB,B2   SSN$,AUTO
          1 000080  9CC2 000D                            LDB,B1   13,B2
PL6.E3A0      #002=KNA$IN File=KNA$APE.:E05TSI                                   WED 07/30/97 00:57 Page:168  
          1 000082  9FC7 000D                            STB,B1   IOP$,AUTO
          1 000084  0F81 0007                            B        s:14671,PREL

      962    14669    2         ELSE IOP$=KNA$SSN.IOPQ$;

  14669   1 000086  ACC7 000B                            LDB,B2   SSN$,AUTO
          1 000088  9CC2 000B                            LDB,B1   11,B2
          1 00008A  9FC7 000D                            STB,B1   IOP$,AUTO

      963    14670
      964    14671    2         IF IOP$ ~= ADDR(NIL)

  14671   1 00008C  8DC7 000D                            CMN      IOP$,AUTO
          1 00008E  0901 000B                            BE       s:14676,PREL

      965    14672    3         THEN DO;

      966    14673    3              K$RWPARM.KEYTYPE = KN$IOP.KEYTYPE;

  14673   1 000090  C841 0002                            LDR,R4   2,B1
          1 000092  C7C7 0042                            STH,R4   K$RWPARM+40,AUTO

      967    14674    3              K$RWPARM.READMLT = KN$IOP.FLAGS.READMLT;

  14674   1 000094  D841 0003                            LDR,R5   3,B1
          1 000096  5003                                 SOL,R5   3
          1 000097  DAC7 002A                            SRM,R5,'4000'X    K$RWPARM+16,AUTO
          1 000099       4000

      968    14675    3              END;

      969    14676    2         CALL KNA$DECODE_VDO(K$RWPARM)

  14676   1 00009A  CBC7 001A                            LAB,B4   K$RWPARM,AUTO
          1 00009C  CFC7 0080                            STB,B4   NWIO+18,AUTO
          1 00009E  BBC7 0080                            LAB,B3   NWIO+18,AUTO
          1 0000A0  CBF0 0100                            LAB,B4   256,IMO
PL6.E3A0      #002=KNA$IN File=KNA$APE.:E05TSI                                   WED 07/30/97 00:57 Page:169  
          1 0000A2  E380 0000 0000  xent                 LNJ,B6   KNA$DECODE_VDO
          1 0000A5       0003                            DC       s:14678,PREL
          1 0000A6  0F81 0006                            B        s:14682,PREL

      970    14677    3         WHENALTRETURN DO;

      971    14678    3              CALL PROTOCOL_ERR;

  14678   1 0000A8  E3C0 05D6                            LNJ,B6   s:0,PREL
          1 0000AA       0001                            DC       s:14679,PREL

      972    14679    3              EXIT CASE_FCN;

  14679   1 0000AB  0F81 05C7                            B        s:15054,PREL

      973    14680    3              END;
      974    14681
      975    14682    3         DO CASE (KV$VDOHDR.FNC);

  14682   1 0000AD  ECC7 0004                            LDB,B6   @KN$NETPARM,AUTO
          1 0000AF  DCC6 0005                            LDB,B5   5,B6
          1 0000B1  B285                                 LLH,R3   ,B5
          1 0000B2  3D23                                 CMV,R3   35
          1 0000B3  0281 04DC                            BGE      s:14990,PREL
          1 0000B5  A830 0000 00BB  01                   LDR,R2   s:14682+14,R3
          1 0000B8  83A0 0000 00DE  01                   JMP      s:14694,R2
          1 0000BB       04B2                            DC       s:14990,PREL
          1 0000BC       04B2                            DC       s:14990,PREL
          1 0000BD       02F4                            DC       s:14882,PREL
          1 0000BE       03CB                            DC       s:14924,PREL
          1 0000BF       04B2                            DC       s:14990,PREL
          1 0000C0       0000                            DC       s:14694,PREL
          1 0000C1       033B                            DC       s:14892,PREL
          1 0000C2       04B2                            DC       s:14990,PREL
          1 0000C3       01E0                            DC       s:14801,PREL
          1 0000C4       04B2                            DC       s:14990,PREL
          1 0000C5       03A6                            DC       s:14914,PREL
PL6.E3A0      #002=KNA$IN File=KNA$APE.:E05TSI                                   WED 07/30/97 00:57 Page:170  
          1 0000C6       04B2                            DC       s:14990,PREL
          1 0000C7       04B2                            DC       s:14990,PREL
          1 0000C8       036F                            DC       s:14903,PREL
          1 0000C9       04B2                            DC       s:14990,PREL
          1 0000CA       04B2                            DC       s:14990,PREL
          1 0000CB       04B2                            DC       s:14990,PREL
          1 0000CC       04B2                            DC       s:14990,PREL
          1 0000CD       0000                            DC       s:14694,PREL
          1 0000CE       04B5                            DC       s:14993,PREL
          1 0000CF       04B2                            DC       s:14990,PREL
          1 0000D0       04B2                            DC       s:14990,PREL
          1 0000D1       01E6                            DC       s:14809,PREL
          1 0000D2       04B2                            DC       s:14990,PREL
          1 0000D3       043A                            DC       s:14962,PREL
          1 0000D4       04B2                            DC       s:14990,PREL
          1 0000D5       04B2                            DC       s:14990,PREL
          1 0000D6       04B2                            DC       s:14990,PREL
          1 0000D7       04B2                            DC       s:14990,PREL
          1 0000D8       04B2                            DC       s:14990,PREL
          1 0000D9       04B2                            DC       s:14990,PREL
          1 0000DA       046E                            DC       s:14972,PREL
          1 0000DB       03F9                            DC       s:14939,PREL
          1 0000DC       01E0                            DC       s:14801,PREL
          1 0000DD       01E0                            DC       s:14801,PREL

      976    14683
      977    14684        /*     A WRITE REQUEST contains data for our user.  We will have to
      978    14685        map onto our user's buffer after finding the IO packet for him.
      979    14686        */
      980    14687    3          CASE (%KV_VDO_FNC_DAT,%KV_VDO_FNC_PRM_RSP);

      981    14688
      982    14689        /*
      983    14690          Locate the I/O packet for the stream we just got the buffer for and
      984    14691          screech if we can't find it.
      985    14692                                                                                      */
      986    14693
PL6.E3A0      #002=KNA$IN File=KNA$APE.:E05TSI                                   WED 07/30/97 00:57 Page:171  
      987    14694    3            IF IOP$ = ADDR(NIL)

  14694   1 0000DE  8DC7 000D                            CMN      IOP$,AUTO
          1 0000E0  0981 0006                            BNE      s:14702,PREL

      988    14695    4            THEN DO;

      989    14696    4                 CALL PROTOCOL_ERR;

  14696   1 0000E2  E3C0 059C                            LNJ,B6   s:0,PREL
          1 0000E4       0001                            DC       s:14697,PREL

      990    14697    4                 EXIT CASE_FCN;

  14697   1 0000E5  0F81 058D                            B        s:15054,PREL

      991    14698    4                 END;
      992    14699        /*
      993    14700          Map onto the users buffer so we can move the data into it
      994    14701                                                                                      */
      995    14702    3            KN$IOP.FLAGS.RDDONE = '1'B;

  14702   1 0000E7  CCC7 000D                            LDB,B4   IOP$,AUTO
          1 0000E9  8944 0003                            LBT,'2000'X       3,B4
          1 0000EB       2000

      996    14703    3            BFR$=VBASE(KN$IOP.BUF_);

  14703   1 0000EC  8CC4 0005                            LDI      5,B4
          1 0000EE  8D47 0006                            SDI      BFR$,AUTO

      997    14704    3            CALL KNA$MAP(BFR$,KN$IOP.BUFSEGDES);

  14704   1 0000F0  DBC4 0010                            LAB,B5   16,B4
          1 0000F2  DFC7 0082                            STB,B5   NWIO+20,AUTO
          1 0000F4  BBC7 0006                            LAB,B3   BFR$,AUTO
          1 0000F6  BFC7 0080                            STB,B3   NWIO+18,AUTO
PL6.E3A0      #002=KNA$IN File=KNA$APE.:E05TSI                                   WED 07/30/97 00:57 Page:172  
          1 0000F8  BBC7 0080                            LAB,B3   NWIO+18,AUTO
          1 0000FA  CBF0 0200                            LAB,B4   512,IMO
          1 0000FC  E380 0000 0000  xent                 LNJ,B6   KNA$MAP
          1 0000FF       0001                            DC       s:14710,PREL

      998    14705
      999    14706        /*     Now figure out how much data to move into the user's buffer
     1000    14707        and go do it.  The virtual address of the user's buffer (KN$IOP.BUF_)
     1001    14708        has already been adjusted to point into the WINDOW1 segment.
     1002    14709        */
     1003    14710    3            DATA$=K$RWPARM.MSGC$;

  14710   1 000100  8CC7 001A                            LDI      K$RWPARM,AUTO
          1 000102  8D47 0011                            SDI      DATA$,AUTO

     1004    14711    3            DATASIZE=K$RWPARM.MSGSZ;

  14711   1 000104  D847 001C                            LDR,R5   K$RWPARM+2,AUTO
          1 000106  DF47 000F                            STR,R5   DATASIZE,AUTO

     1005    14712
     1006    14713    3            IF DATASIZE > VBOUND(KN$IOP.BUF_)+1

  14713   1 000108  ECC7 000D                            LDB,B6   IOP$,AUTO
          1 00010A  C846 0004                            LDR,R4   4,B6
          1 00010C  4E01                                 ADV,R4   1
          1 00010D  C955                                 CMR,R4   R5
          1 00010E  0281 0007                            BGE      s:14718,PREL

     1007    14714    4            THEN DO;

     1008    14715    4                 DATASIZE = VBOUND(KN$IOP.BUF_)+1;

  14715   1 000110  D854                                 LDR,R5   R4
          1 000111  DF47 000F                            STR,R5   DATASIZE,AUTO

     1009    14716    4                 KN$IOP.FLAGS.TRUNC = '1'B;
PL6.E3A0      #002=KNA$IN File=KNA$APE.:E05TSI                                   WED 07/30/97 00:57 Page:173  

  14716   1 000113  8946 0003                            LBT,'8000'X       3,B6
  14716   1 000115       8000

     1010    14717    4                 END;

     1011    14718    3            DATAARS = DATASIZE;

  14718   1 000116  DF47 0010                            STR,R5   DATAARS,AUTO

     1012    14719
     1013    14720    3            BFR$->DATASTRING = DATA$ -> DATASTRING;

  14720   1 000118  8CC7 0006                            LDI      BFR$,AUTO
          1 00011A  B856                                 LDR,R3   R6
          1 00011B  E570 7FFF                            AND,R6   32767,IMO
          1 00011D  8D47 0080                            SDI      NWIO+18,AUTO
          1 00011F  DCC7 0080                            LDB,B5   NWIO+18,AUTO
          1 000121  304F                                 SOR,R3   15
          1 000122  8CC7 0011                            LDI      DATA$,AUTO
          1 000124  A856                                 LDR,R2   R6
          1 000125  E570 7FFF                            AND,R6   32767,IMO
          1 000127  8D47 0082                            SDI      NWIO+20,AUTO
          1 000129  CCC7 0082                            LDB,B4   NWIO+20,AUTO
          1 00012B  204F                                 SOR,R2   15
          1 00012C  AB84                                 LAB,B2   ,B4
          1 00012D  E855                                 LDR,R6   R5
          1 00012E  BB85                                 LAB,B3   ,B5
          1 00012F  0008                                 MMM

     1014    14721    3            IF KN$IOP.KEY_ ~= VECTOR(NIL)

  14721   1 000130  ECC7 000D                            LDB,B6   IOP$,AUTO
          1 000132  9B80 0000 0000  02                   LAB,B1   0
          1 000135  5C06                                 LDV,R5   6
          1 000136  0022                                 ACM      ;
          1 000137       4606 0007                                ALPHANUM(7,B6,,6,FILL),;
PL6.E3A0      #002=KNA$IN File=KNA$APE.:E05TSI                                   WED 07/30/97 00:57 Page:174  
          1 000139       4001 0004                                ALPHANUM(4,B1,,R5,FILL)
          1 00013B  5381 0046                            CBE      s:14745,PREL

     1015    14722    4            THEN DO;

     1016    14723    4                 BFR$=VBASE(KN$IOP.KEY_);

  14723   1 00013D  8CC6 0008                            LDI      8,B6
          1 00013F  8D47 0006                            SDI      BFR$,AUTO

     1017    14724    4                 CALL KNA$MAP(BFR$,KN$IOP.KEYSEGDES);

  14724   1 000141  9BC6 0012                            LAB,B1   18,B6
          1 000143  9FC7 0082                            STB,B1   NWIO+20,AUTO
          1 000145  EBC7 0006                            LAB,B6   BFR$,AUTO
          1 000147  EFC7 0080                            STB,B6   NWIO+18,AUTO
          1 000149  BBC7 0080                            LAB,B3   NWIO+18,AUTO
          1 00014B  CBF0 0200                            LAB,B4   512,IMO
          1 00014D  E380 0000 0000  xent                 LNJ,B6   KNA$MAP
          1 000150       0001                            DC       s:14730,PREL

     1018    14725
     1019    14726        /*     Now figure out how much data to move into the user's key buffer
     1020    14727        and go do it.  The virtual address of the user's key buffer (KN$IOP.KEY_)
     1021    14728        has already been adjusted to point into the WINDOW1 segment.
     1022    14729        */
     1023    14730    4                 DATA$=K$RWPARM.KEY$;

  14730   1 000151  ECC7 003D                            LDB,B6   K$RWPARM+35,AUTO
          1 000153  EFC7 0011                            STB,B6   DATA$,AUTO

     1024    14731    4                 DATASIZE=K$RWPARM.KEYSZ;

  14731   1 000155  E847 0042                            LDR,R6   K$RWPARM+40,AUTO
          1 000157  E570 00FF                            AND,R6   255,IMO
          1 000159  EF47 000F                            STR,R6   DATASIZE,AUTO

PL6.E3A0      #002=KNA$IN File=KNA$APE.:E05TSI                                   WED 07/30/97 00:57 Page:175  
     1025    14732
     1026    14733    4                 IF DATASIZE > VBOUND(KN$IOP.KEY_)+1

  14733   1 00015B  DCC7 000D                            LDB,B5   IOP$,AUTO
          1 00015D  D845 0007                            LDR,R5   7,B5
          1 00015F  5E01                                 ADV,R5   1
          1 000160  D956                                 CMR,R5   R6
          1 000161  0281 0007                            BGE      s:14739,PREL

     1027    14734    5                 THEN DO;

     1028    14735    5                      DATASIZE = VBOUND(KN$IOP.KEY_)+1;

  14735   1 000163  E855                                 LDR,R6   R5
          1 000164  EF47 000F                            STR,R6   DATASIZE,AUTO

     1029    14736    5                      KN$IOP.FLAGS.TRUNC = '1'B;

  14736   1 000166  8945 0003                            LBT,'8000'X       3,B5
  14736   1 000168       8000

     1030    14737    5                      END;

     1031    14738
     1032    14739    4                 BFR$->DATASTRING = DATA$ -> DATASTRING;

  14739   1 000169  8CC7 0006                            LDI      BFR$,AUTO
          1 00016B  B856                                 LDR,R3   R6
          1 00016C  E570 7FFF                            AND,R6   32767,IMO
          1 00016E  8D47 0080                            SDI      NWIO+18,AUTO
          1 000170  CCC7 0080                            LDB,B4   NWIO+18,AUTO
          1 000172  304F                                 SOR,R3   15
          1 000173  8CC7 0011                            LDI      DATA$,AUTO
          1 000175  A856                                 LDR,R2   R6
          1 000176  E570 7FFF                            AND,R6   32767,IMO
          1 000178  8D47 0082                            SDI      NWIO+20,AUTO
          1 00017A  BCC7 0082                            LDB,B3   NWIO+20,AUTO
PL6.E3A0      #002=KNA$IN File=KNA$APE.:E05TSI                                   WED 07/30/97 00:57 Page:176  
          1 00017C  204F                                 SOR,R2   15
          1 00017D  AB83                                 LAB,B2   ,B3
          1 00017E  E847 000F                            LDR,R6   DATASIZE,AUTO
          1 000180  BB84                                 LAB,B3   ,B4
          1 000181  0008                                 MMM

     1033    14740    4                 END;

     1034    14741        /*
     1035    14742          The data has been moved into the buffer.  Now, map over the users
     1036    14743          DCB so we can post status.
     1037    14744                                                                                      */
     1038    14745    3            CALL KNA$MAP(KN$IOP.DCB$,KN$IOP.DCBSEGDES);

  14745   1 000182  ECC7 000D                            LDB,B6   IOP$,AUTO
          1 000184  DBC6 0014                            LAB,B5   20,B6
          1 000186  DFC7 0082                            STB,B5   NWIO+20,AUTO
          1 000188  ABC6 000A                            LAB,B2   10,B6
          1 00018A  AFC7 0080                            STB,B2   NWIO+18,AUTO
          1 00018C  BBC7 0080                            LAB,B3   NWIO+18,AUTO
          1 00018E  CBF0 0200                            LAB,B4   512,IMO
          1 000190  E380 0000 0000  xent                 LNJ,B6   KNA$MAP
          1 000193       0001                            DC       s:14749,PREL

     1039    14746
     1040    14747        /* Update the various read counters.
     1041    14748        */
     1042    14749    3            IF KV$VDOHDR.FNC=%KV_VDO_FNC_DAT

  14749   1 000194  ECC7 0004                            LDB,B6   @KN$NETPARM,AUTO
          1 000196  DCC6 0005                            LDB,B5   5,B6
          1 000198  E285                                 LLH,R6   ,B5
          1 000199  6D05                                 CMV,R6   5
          1 00019A  0981 0041                            BNE      s:14760,PREL

     1043    14750    4            THEN DO CASE(KN$IOP.DCB$->MYDCB.DDEV.RES);

PL6.E3A0      #002=KNA$IN File=KNA$APE.:E05TSI                                   WED 07/30/97 00:57 Page:177  
  14750   1 00019C  CCC7 000D                            LDB,B4   IOP$,AUTO
          1 00019E  BCC4 000A                            LDB,B3   10,B4
          1 0001A0  B843 0003                            LDR,R3   3,B3
          1 0001A2  B570 0007                            AND,R3   7,IMO
          1 0001A4  3D05                                 CMV,R3   5
          1 0001A5  0281 0036                            BGE      s:14760,PREL
          1 0001A7  A830 0000 01AD  01                   LDR,R2   s:14750+17,R3
          1 0001AA  83A0 0000 01B2  01                   JMP      s:14752,R2
          1 0001AD       002A                            DC       s:14760,PREL
          1 0001AE       0000                            DC       s:14752,PREL
          1 0001AF       000B                            DC       s:14754,PREL
          1 0001B0       0016                            DC       s:14756,PREL
          1 0001B1       0021                            DC       s:14758,PREL

     1044    14751    4             CASE(%G_DDEV_RES_HO#);

     1045    14752    4               PS_LCP6STT.BYTES_READ_HOST = PS_LCP6STT.BYTES_READ_HOST + DATAARS;

  14752   1 0001B2  F847 0010                            LDR,R7   DATAARS,AUTO
          1 0001B4  6C00                                 LDV,R6   0
          1 0001B5  8400 0000 0066  xsym                 AID      PS_LCP6STT+102
          1 0001B8  8D00 0000 0066  xsym                 SDI      PS_LCP6STT+102
          1 0001BB  0F81 0020                            B        s:14760,PREL

     1046    14753    4             CASE(%G_DDEV_RES_UC#);

     1047    14754    4               PS_LCP6STT.BYTES_READ_UC = PS_LCP6STT.BYTES_READ_UC + DATAARS;

  14754   1 0001BD  F847 0010                            LDR,R7   DATAARS,AUTO
          1 0001BF  6C00                                 LDV,R6   0
          1 0001C0  8400 0000 0068  xsym                 AID      PS_LCP6STT+104
          1 0001C3  8D00 0000 0068  xsym                 SDI      PS_LCP6STT+104
          1 0001C6  0F81 0015                            B        s:14760,PREL

     1048    14755    4             CASE(%G_DDEV_RES_LG#);

     1049    14756    4               PS_LCP6STT.BYTES_READ_LG = PS_LCP6STT.BYTES_READ_LG + DATAARS;
PL6.E3A0      #002=KNA$IN File=KNA$APE.:E05TSI                                   WED 07/30/97 00:57 Page:178  

  14756   1 0001C8  F847 0010                            LDR,R7   DATAARS,AUTO
          1 0001CA  6C00                                 LDV,R6   0
          1 0001CB  8400 0000 006A  xsym                 AID      PS_LCP6STT+106
          1 0001CE  8D00 0000 006A  xsym                 SDI      PS_LCP6STT+106
          1 0001D1  0F81 000A                            B        s:14760,PREL

     1050    14757    4             CASE(%G_DDEV_RES_NA#);

     1051    14758    4               PS_LCP6STT.BYTES_READ_NA = PS_LCP6STT.BYTES_READ_NA + DATAARS;

  14758   1 0001D3  F847 0010                            LDR,R7   DATAARS,AUTO
          1 0001D5  6C00                                 LDV,R6   0
          1 0001D6  8400 0000 006C  xsym                 AID      PS_LCP6STT+108
          1 0001D9  8D00 0000 006C  xsym                 SDI      PS_LCP6STT+108

     1052    14759    4               END/*do case*/;

     1053    14760    3            KN$IOP.DCB$->MYDCB.ARS = DATAARS;

  14760   1 0001DC  DCC7 000D                            LDB,B5   IOP$,AUTO
          1 0001DE  CCC5 000A                            LDB,B4   10,B5
          1 0001E0  E847 0010                            LDR,R6   DATAARS,AUTO
          1 0001E2  EF04                                 STR,R6   ,B4

     1054    14761    3            KN$IOP.DCB$->MYDCB.TYC.LD#=KN$IOP.FLAGS.TRUNC;

  14761   1 0001E3  CCC5 000A                            LDB,B4   10,B5
          1 0001E5  D845 0003                            LDR,R5   3,B5
          1 0001E7  DAC4 0001                            SRM,R5,'8000'X    1,B4
          1 0001E9       8000

     1055    14762    3            IF NOT K$RWPARM.EOM_EOR

  14762   1 0001EA  82C7 002A                            LB,'2000'X        K$RWPARM+16,AUTO
  14762   1 0001EC       2000
          1 0001ED  0501 000B                            BBT      s:14764,PREL
PL6.E3A0      #002=KNA$IN File=KNA$APE.:E05TSI                                   WED 07/30/97 00:57 Page:179  

     1056    14763    3            THEN KN$IOP.DCB$->MYDCB.EOMCHAR=K$RWPARM.DVE.EOMCHAR;

  14763   1 0001EF  CCC5 000A                            LDB,B4   10,B5
          1 0001F1  0021                                 ALR      ;
          1 0001F2       C107 0029                                ALPHANUM(K$RWPARM+15,AUTO,1,1),;
          1 0001F4       4204 0022                                ALPHANUM(34,B4,,2,FILL)
          1 0001F6  437F                                 CSYNC    s:14763+6,SPREL
          1 0001F7  0F81 000B                            B        s:14765,PREL

     1057    14764    3            ELSE KN$IOP.DCB$->MYDCB.EOMCHAR=%G_EOM_EOR#;

  14764   1 0001F9  CCC5 000A                            LDB,B4   10,B5
          1 0001FB  AB80 0000 0000  00                   LAB,B2   ECNCFAIL
          1 0001FE  2C1C                                 LDV,R2   28
          1 0001FF  6C02                                 LDV,R6   2
          1 000200  BB84                                 LAB,B3   ,B4
          1 000201  3C44                                 LDV,R3   68
          1 000202  0008                                 MMM

     1058    14765    3            KN$IOP.DCB$->MYDCB.ACTPOS=K$RWPARM.ACTPOS;

  14765   1 000203  DCC7 000D                            LDB,B5   IOP$,AUTO
          1 000205  CCC5 000A                            LDB,B4   10,B5
          1 000207  E847 0041                            LDR,R6   K$RWPARM+39,AUTO
          1 000209  EF44 002F                            STR,R6   47,B4

     1059    14766    3            KN$IOP.DCB$->MYDCB.DVBYTE=K$RWPARM.DVE.DVBYTE;

  14766   1 00020B  CCC5 000A                            LDB,B4   10,B5
          1 00020D  E2C7 0029                            LLH,R6   K$RWPARM+15,AUTO
          1 00020F  6008                                 SOL,R6   8
          1 000210  6048                                 SOR,R6   8
          1 000211  E7C4 0002                            STH,R6   2,B4

     1060    14767    3            IF KN$IOP.DCB$->MYDCB.ORG = %G_ORG_FORM#

PL6.E3A0      #002=KNA$IN File=KNA$APE.:E05TSI                                   WED 07/30/97 00:57 Page:180  
  14767   1 000213  CCC5 000A                            LDB,B4   10,B5
          1 000215  E844 001F                            LDR,R6   31,B4
          1 000217  E570 00FF                            AND,R6   255,IMO
          1 000219  6D02                                 CMV,R6   2
          1 00021A  0981 0005                            BNE      s:14770,PREL

     1061    14768    3            THEN
     1062    14769    3                 KN$IOP.DCB$->MYDCB.FLDID=K$RWPARM.FLDID;

  14769   1 00021C  D847 0040                            LDR,R5   K$RWPARM+38,AUTO
          1 00021E  DF44 0021                            STR,R5   33,B4

     1063    14770    3            KN$IOP.ERRCODE = K$RWPARM.MSG_ERRCODE;

  14770   1 000220  8CC7 0034                            LDI      K$RWPARM+26,AUTO
          1 000222  8D05                                 SDI      ,B5

     1064    14771    3            KN$IOP.MSGTYPE = K$RWPARM.MSGTYP;

  14771   1 000223  AB87                                 LAB,B2   ,AUTO
          1 000224  2C42                                 LDV,R2   66
          1 000225  6C08                                 LDV,R6   8
          1 000226  BB85                                 LAB,B3   ,B5
          1 000227  3C2C                                 LDV,R3   44
          1 000228  0008                                 MMM

  14771   1                              READ_COMP       null
     1065    14772        /*
     1066    14773          RUE the user.  If there were errors, they
     1067    14774          will be reported by KNA$USERIO, who was running on behalf of the
     1068    14775          user, when the user did the MCL.
     1069    14776                                                                                      */
     1070    14777    3   READ_COMP: ;
     1071    14778    3            IF KN$IOP.FLAGS.WAIT

  14778   1 000229  ECC7 000D            READ_COMP       LDB,B6   IOP$,AUTO
          1 00022B  82C6 0003                            LB,'4000'X        3,B6
PL6.E3A0      #002=KNA$IN File=KNA$APE.:E05TSI                                   WED 07/30/97 00:57 Page:181  
          1 00022D       4000
          1 00022E  0581 0025                            BBF      s:14784,PREL

     1072    14779    4            THEN DO;

     1073    14780    4                 IF G$USER.FLG(KNA$SSN.USER#) & %U_SCIO

  14780   1 000230  DCC7 000B                            LDB,B5   SSN$,AUTO
          1 000232  B845 0011                            LDR,R3   17,B5
          1 000234  CC80 0000 0000  xsym                 LDB,B4   G$USRT$
          1 000237  BF47 0080                            STR,R3   NWIO+18,AUTO
          1 000239  3F18                                 MLV,R3   24
          1 00023A  B847 0080                            LDR,R3   NWIO+18,AUTO
          1 00023C  3F18                                 MLV,R3   24
          1 00023D  E834                                 LDR,R6   ,B4,R3
          1 00023E  E570 0800                            AND,R6   2048,IMO
          1 000240  6901 0352                            BEZ,R6   s:14993,PREL

     1074    14781    4                 THEN CALL GHS$RUE(%GH_EVCIC,KNA$SSN.USER#);

  14781   1 000242  BBF0 0017                            LAB,B3   23,IMO
          1 000244  ABC5 0011                            LAB,B2   17,B5
          1 000246  AFC7 0082                            STB,B2   NWIO+20,AUTO
          1 000248  BFC7 0080                            STB,B3   NWIO+18,AUTO
          1 00024A  BBC7 0080                            LAB,B3   NWIO+18,AUTO
          1 00024C  CBF0 0200                            LAB,B4   512,IMO
          1 00024E  E380 0000 0000  xent                 LNJ,B6   GHS$RUE
          1 000251       0001                            DC       s:14782,PREL

     1075    14782    4                 END;

  14782   1 000252  0F81 0340                            B        s:14993,PREL

     1076    14783    4            ELSE DO;                       /* It was a no wait I/O               */

     1077    14784    4                 NWIO = '0'B;

PL6.E3A0      #002=KNA$IN File=KNA$APE.:E05TSI                                   WED 07/30/97 00:57 Page:182  
  14784   1 000254  5C20                                 LDV,R5   32
          1 000255  0021                                 ALR      ;
          1 000256       4178 0000                                ALPHANUM('0000'X,IMO,,1),;
          1 000258       4007 006E                                ALPHANUM(NWIO,AUTO,,R5,FILL)

     1078    14785    4                 NWIO.P# = SIZEW(NWIO) - SIZEW(NWIO.P#);

  14785   1 00025A  6C0F                                 LDV,R6   15
          1 00025B  437F                                 CSYNC    s:14785,SPREL
          1 00025C  EF47 006E                            STR,R6   NWIO,AUTO

     1079    14786    4                 TCB_ERR = KN$IOP.ERRCODE;

  14786   1 00025E  8C86                                 LDI      ,B6
          1 00025F  8D47 0016                            SDI      TCB_ERR,AUTO

     1080    14787    4                 NWIO.ARS = DATAARS;

  14787   1 000261  C847 0010                            LDR,R4   DATAARS,AUTO
          1 000263  CF47 006F                            STR,R4   NWIO+1,AUTO

     1081    14788    4                 NWIO.DVE.DVBYTE = K$RWPARM.DVE.DVBYTE;

  14788   1 000265  B847 0029                            LDR,R3   K$RWPARM+15,AUTO
          1 000267  BAC7 0070                            SRM,R3,'FE00'X    NWIO+2,AUTO
          1 000269       FE00

     1082    14789    4                 NWIO.DVE.EOMCHAR = K$RWPARM.DVE.EOMCHAR;

  14789   1 00026A  BAC7 0070                            SRM,R3,'00FF'X    NWIO+2,AUTO
  14789   1 00026C       00FF

     1083    14790    4                 NWIO.CGPARM.STATION# = K$RWPARM.STATION;

  14790   1 00026D  AB87                                 LAB,B2   ,AUTO
          1 00026E  2C3A                                 LDV,R2   58
          1 00026F  6C08                                 LDV,R6   8
PL6.E3A0      #002=KNA$IN File=KNA$APE.:E05TSI                                   WED 07/30/97 00:57 Page:183  
          1 000270  BBC7 0072                            LAB,B3   NWIO+4,AUTO
          1 000272  3C00                                 LDV,R3   0
          1 000273  0008                                 MMM

     1084    14791    4                 NWIO.CGPARM.MSGTYP# = K$RWPARM.MSGTYP;

  14791   1 000274  AB87                                 LAB,B2   ,AUTO
          1 000275  2C42                                 LDV,R2   66
          1 000276  6C08                                 LDV,R6   8
          1 000277  BBC7 0076                            LAB,B3   NWIO+8,AUTO
          1 000279  3C00                                 LDV,R3   0
          1 00027A  0008                                 MMM

     1085    14792    4                 NWIO.CGPARM.MSGID# = K$RWPARM.MSGID;

  14792   1 00027B  8CC7 002B                            LDI      K$RWPARM+17,AUTO
          1 00027D  8D47 007B                            SDI      NWIO+13,AUTO

     1086    14793    4                 EVENT = KN$IOP.EVENT;

  14793   1 00027F  ECC7 000D                            LDB,B6   IOP$,AUTO
          1 000281  C846 001A                            LDR,R4   26,B6
          1 000283  CF47 0008                            STR,R4   EVENT,AUTO

     1087    14794    4                 CALL GHS$EVENT (KNA$SSN.USER#,%GH_USRDMN#,%G_IO_CMP#,EVENT,TCB_ERR,
             14794                          NWIO);

  14794   1 000285  DBF0 0000                            LAB,B5   0,IMO
          1 000287  CBF0 0005                            LAB,B4   5,IMO
          1 000289  BBC7 006E                            LAB,B3   NWIO,AUTO
          1 00028B  BFC7 008A                            STB,B3   NWIO+28,AUTO
          1 00028D  9BC7 0016                            LAB,B1   TCB_ERR,AUTO
          1 00028F  9FC7 0088                            STB,B1   NWIO+26,AUTO
          1 000291  EBC7 0008                            LAB,B6   EVENT,AUTO
          1 000293  EFC7 0086                            STB,B6   NWIO+24,AUTO
          1 000295  CFC7 0084                            STB,B4   NWIO+22,AUTO
          1 000297  DFC7 0082                            STB,B5   NWIO+20,AUTO
PL6.E3A0      #002=KNA$IN File=KNA$APE.:E05TSI                                   WED 07/30/97 00:57 Page:184  
          1 000299  ECC7 000B                            LDB,B6   SSN$,AUTO
          1 00029B  DBC6 0011                            LAB,B5   17,B6
          1 00029D  DFC7 0080                            STB,B5   NWIO+18,AUTO
          1 00029F  BBC7 0080                            LAB,B3   NWIO+18,AUTO
          1 0002A1  CBF0 0600                            LAB,B4   1536,IMO
          1 0002A3  E380 0000 0000  xent                 LNJ,B6   GHS$EVENT
          1 0002A6       0001                            DC       s:14795,PREL

     1088    14795    4                 CALL KNA$RLSIOP(KNA$SSN.IOPRD$);

  14795   1 0002A7  ECC7 000B                            LDB,B6   SSN$,AUTO
          1 0002A9  DBC6 000D                            LAB,B5   13,B6
          1 0002AB  DFC7 0080                            STB,B5   NWIO+18,AUTO
          1 0002AD  BBC7 0080                            LAB,B3   NWIO+18,AUTO
          1 0002AF  CBF0 0100                            LAB,B4   256,IMO
          1 0002B1  E380 0000 0000  xent                 LNJ,B6   KNA$RLSIOP
          1 0002B4       0001                            DC       s:14796,PREL

     1089    14796    4                 KNA$SSN.IOPRD$ = ADDR(NIL);

  14796   1 0002B5  EB80 0000 0000                       LAB,B6   0
          1 0002B8  DCC7 000B                            LDB,B5   SSN$,AUTO
          1 0002BA  EFC5 000D                            STB,B6   13,B5

     1090    14797    4                 END;

  14797   1 0002BC  0F81 02D6                            B        s:14993,PREL

     1091    14798        %EJECT;
PL6.E3A0      #002=KNA$IN File=KNA$APE.:E05TSI                                   WED 07/30/97 00:57 Page:185  
     1092    14799        /*   A DCLSTR will cause the MULT_STR bit to be set in KNA$SSN */
     1093    14800    3          CASE (%KV_VDO_FNC_DCLSTR,%KV_VDO_FNC_CLSSTR,%KV_VDO_FNC_OPNSTR);

     1094    14801    3            KNA$SSN.FLAGS.MULT_STR  = '1'B;

  14801   1 0002BE  CCC7 000B                            LDB,B4   SSN$,AUTO
          1 0002C0  8904                                 LBT,'0100'X       ,B4
          1 0002C1       0100
          1 0002C2  0F81 02D0                            B        s:14993,PREL

     1095    14802
     1096    14803        %EJECT;
PL6.E3A0      #002=KNA$IN File=KNA$APE.:E05TSI                                   WED 07/30/97 00:57 Page:186  
     1097    14804        /*
     1098    14805             A READ (DATA) REQUEST message merely saves the throttling info
     1099    14806        and unREGs our user if he's REGged BLOCKED.
     1100    14807        */
     1101    14808    3          CASE (%KV_VDO_FNC_RQSDAT);

     1102    14809    3            IF KN$NETPARM.UHDR$->KV$VDO_RQSDAT.EOFNO_DAT

  14809   1 0002C4  82C5 0004                            LB,'0400'X        4,B5
  14809   1 0002C6       0400
          1 0002C7  0581 0024                            BBF      s:14819,PREL
          1 0002C9  CCC7 000B                            LDB,B4   SSN$,AUTO
          1 0002CB  8984                                 CMZ      ,B4
          1 0002CC  0881 0005                            BAGE     s:14809+14,PREL
          1 0002CE  8284                                 LB,'4000'X        ,B4
          1 0002CF       4000
          1 0002D0  0501 001B                            BBT      s:14819,PREL
          1 0002D2  E844 0013                            LDR,R6   19,B4
          1 0002D4  6D06                                 CMV,R6   6
          1 0002D5  0901 0016                            BE       s:14819,PREL

     1103    14810    3              AND NOT (KNA$SSN.FLAGS.REGGED AND KNA$SSN.FLAGS.BLOCKED)
     1104    14811    3              AND KNA$SSN.STATE ~= %KNA_STATE_WTERM
     1105    14812    4            THEN DO;

     1106    14813    4                 KN$NETPARM.UHDR$=ADDR(NODAT_VDO);

  14813   1 0002D7  BB80 0000 0009  00                   LAB,B3   NODAT_VDO
          1 0002DA  BFC6 0005                            STB,B3   5,B6

     1107    14814    4                 KN$NETPARM.UHDRSZ = LENGTHC(NODAT_VDO);

  14814   1 0002DC  6C0A                                 LDV,R6   10
          1 0002DD  EF46 0007                            STR,R6   7,B6

     1108    14815    4                 KN$NETPARM.FUNCTION = %KN_FCN_DATA;

PL6.E3A0      #002=KNA$IN File=KNA$APE.:E05TSI                                   WED 07/30/97 00:57 Page:187  
  14815   1 0002DF  5C05                                 LDV,R5   5
          1 0002E0  DF46 0014                            STR,R5   20,B6

     1109    14816    4                 CALL KNS$SEND(KN$NETPARM) ALTRET(UNLK_N_ALTRET);

  14816   1 0002E2  BBC7 0004                            LAB,B3   @KN$NETPARM,AUTO
          1 0002E4  CBF0 0100                            LAB,B4   256,IMO
          1 0002E6  E380 0000 0000  xent                 LNJ,B6   KNS$SEND
          1 0002E9       0094                            DC       s:14854,PREL

     1110    14817    4                 EXIT CASE_FCN;

  14817   1 0002EA  0F81 0388                            B        s:15054,PREL

     1111    14818    4                 END;
     1112    14819    3            IF KN$NETPARM.UHDR$->KV$VDO_RQSDAT.INCMAXNMBRCR

  14819   1 0002EC  89C5 0004                            CMZ      4,B5
          1 0002EE  0881 000B                            BAGE     s:14823,PREL

     1113    14820    3            THEN
     1114    14821    3                 KNA$SSN.THRTLVL.MAXNMBRCR = KNA$SSN.THRTLVL.MAXNMBRCR + KN$NETPARM.
             14821                          UHDR$ -> KV$VDO_RQSDAT.MAXNMBRCR;

  14821   1 0002F0  CCC7 000B                            LDB,B4   SSN$,AUTO
          1 0002F2  E844 0008                            LDR,R6   8,B4
          1 0002F4  EA45 0002                            ADD,R6   2,B5
          1 0002F6  EF44 0008                            STR,R6   8,B4
          1 0002F8  0F81 0007                            B        s:14824,PREL

     1115    14822    3            ELSE
     1116    14823    3                KNA$SSN.THRTLVL.MAXNMBRCR = KN$NETPARM.UHDR$->KV$VDO_RQSDAT.MAXNMBRCR;

  14823   1 0002FA  CCC7 000B                            LDB,B4   SSN$,AUTO
          1 0002FC  E845 0002                            LDR,R6   2,B5
          1 0002FE  EF44 0008                            STR,R6   8,B4

PL6.E3A0      #002=KNA$IN File=KNA$APE.:E05TSI                                   WED 07/30/97 00:57 Page:188  
     1117    14824    3            IF KN$NETPARM.UHDR$->KV$VDO_RQSDAT.INCMAXNMBBYT

  14824   1 000300  DCC6 0005                            LDB,B5   5,B6
          1 000302  82C5 0004                            LB,'4000'X        4,B5
          1 000304       4000
          1 000305  0581 001C                            BBF      s:14840,PREL

     1118    14825    4            THEN DO;

     1119    14826    4                 IF KNA$SSN.FLAGS.BLOCKED AND KNA$SSN.FLAGS.REGGED

  14826   1 000307  8284                                 LB,'4000'X        ,B4
  14826   1 000308       4000
          1 000309  0581 0010                            BBF      s:14837,PREL
          1 00030B  8984                                 CMZ      ,B4
          1 00030C  0881 000D                            BAGE     s:14837,PREL

     1120    14827    5                 THEN DO;

     1121    14828                           %UNLOCK(G=KNA_LNKSSN);

  14833   1 00030E  BB80 0000 0000  02                   LAB,B3   0
          1 000311  CBF0 0100                            LAB,B4   256,IMO
          1 000313  E380 0000 0000  xent                 LNJ,B6   GHH$UNLOCK
          1 000316       0001                            DC       s:14835,PREL

     1122    14835    5                      RETURN;

  14835   1 000317  C380 0000 0000  xent                 LNJ,B4   X6A_ARET

     1123    14836    5                      END;
     1124    14837    4                 KNA$SSN.THRTLVL.MAXNMBBYT = KNA$SSN.THRTLVL.MAXNMBBYT + KN$NETPARM.
             14837                          UHDR$ -> KV$VDO_RQSDAT.MAXNMBBYT;

  14837   1 00031A  D844 0007                            LDR,R5   7,B4
          1 00031C  DA45 0003                            ADD,R5   3,B5
          1 00031E  DF44 0007                            STR,R5   7,B4
PL6.E3A0      #002=KNA$IN File=KNA$APE.:E05TSI                                   WED 07/30/97 00:57 Page:189  

     1125    14838    4                 END;

  14838   1 000320  0F81 0005                            B        s:14841,PREL

     1126    14839    3            ELSE
     1127    14840    3                KNA$SSN.THRTLVL.MAXNMBBYT = KN$NETPARM.UHDR$->KV$VDO_RQSDAT.MAXNMBBYT;

  14840   1 000322  D845 0003                            LDR,R5   3,B5
          1 000324  DF44 0007                            STR,R5   7,B4

     1128    14841    3           KNA$SSN.THRTLVL.MAXRCRBYTSIZ = KN$NETPARM.UHDR$->KV$VDO_RQSDAT.MAXRCRBYTSIZ
             14841                     ;

  14841   1 000326  DCC6 0005                            LDB,B5   5,B6
          1 000328  C845 0001                            LDR,R4   1,B5
          1 00032A  CF44 0009                            STR,R4   9,B4

     1129    14842    3            KNA$SSN.THRTLVL.STR = KN$NETPARM.UHDR$->KV$VDO_RQSDAT.STR;

  14842   1 00032C  DCC6 0005                            LDB,B5   5,B6
          1 00032E  B805                                 LDR,R3   ,B5
          1 00032F  B570 007F                            AND,R3   127,IMO
          1 000331  BF44 000A                            STR,R3   10,B4

     1130    14843
     1131    14844    3            IF KNA$SSN.FLAGS.REGGED = '1'B AND

  14844   1 000333  8984                                 CMZ      ,B4
          1 000334  0881 0019                            BAGE     s:14850,PREL
          1 000336  8284                                 LB,'4000'X        ,B4
          1 000337       4000
          1 000338  0581 0015                            BBF      s:14850,PREL

     1132    14845    3              KNA$SSN.FLAGS.BLOCKED = '1'B
     1133    14846    4            THEN DO;

PL6.E3A0      #002=KNA$IN File=KNA$APE.:E05TSI                                   WED 07/30/97 00:57 Page:190  
     1134    14847    4                 CALL GHS$RUE(%GH_EVCUB,KNA$SSN.USER#);

  14847   1 00033A  DBF0 001A                            LAB,B5   26,IMO
          1 00033C  BBC4 0011                            LAB,B3   17,B4
          1 00033E  BFC7 0082                            STB,B3   NWIO+20,AUTO
          1 000340  DFC7 0080                            STB,B5   NWIO+18,AUTO
          1 000342  BBC7 0080                            LAB,B3   NWIO+18,AUTO
          1 000344  CBF0 0200                            LAB,B4   512,IMO
          1 000346  E380 0000 0000  xent                 LNJ,B6   GHS$RUE
          1 000349       0001                            DC       s:14848,PREL

     1135    14848    4                 KNA$SSN.FLAGS.BLOCKED = '0'B;

  14848   1 00034A  ECC7 000B                            LDB,B6   SSN$,AUTO
          1 00034C  8806                                 LBF,'4000'X       ,B6
          1 00034D       4000

     1136    14849    4                 END;

     1137    14850    3            IF KNA$SSN.THRTLVL.MAXNMBBYT = 0 OR KNA$SSN.THRTLVL.MAXNMBRCR = 0

  14850   1 00034E  ECC7 000B                            LDB,B6   SSN$,AUTO
          1 000350  E846 0007                            LDR,R6   7,B6
          1 000352  6901 0005                            BEZ,R6   s:14852,PREL
          1 000354  D846 0008                            LDR,R5   8,B6
          1 000356  5981 0034                            BNEZ,R5  s:14867,PREL

     1138    14851    4            THEN DO;

     1139    14852    4                 OPARM = KNA_RWPARM_CON;

  14852   1 000358  AB80 0000 0000  xsym                 LAB,B2   KNA_RWPARM_CON
          1 00035B  2C00                                 LDV,R2   0
          1 00035C  6C52                                 LDV,R6   82
          1 00035D  BBC7 0043                            LAB,B3   OPARM,AUTO
          1 00035F  3C00                                 LDV,R3   0
          1 000360  0008                                 MMM
PL6.E3A0      #002=KNA$IN File=KNA$APE.:E05TSI                                   WED 07/30/97 00:57 Page:191  

     1140    14853    4                 CALL KNA$FCNO(%KV_VDO_FNC_BLKDAT,KNA$SSN,OPARM,KN$NETPARM.ERRCODE)

  14853   1 000361  EBF0 0002                            LAB,B6   2,IMO
          1 000363  DCC7 0004                            LDB,B5   @KN$NETPARM,AUTO
          1 000365  CBC5 0016                            LAB,B4   22,B5
          1 000367  CFC7 0086                            STB,B4   NWIO+24,AUTO
          1 000369  BBC7 0043                            LAB,B3   OPARM,AUTO
          1 00036B  BFC7 0084                            STB,B3   NWIO+22,AUTO
          1 00036D  ACC7 000B                            LDB,B2   SSN$,AUTO
          1 00036F  AFC7 0082                            STB,B2   NWIO+20,AUTO
          1 000371  EFC7 0080                            STB,B6   NWIO+18,AUTO
          1 000373  BBC7 0080                            LAB,B3   NWIO+18,AUTO
          1 000375  CBF0 0400                            LAB,B4   1024,IMO
          1 000377  E380 0000 0000  xent                 LNJ,B6   KNA$FCNO
          1 00037A       0003                            DC       s:14854,PREL
          1 00037B  0F81 000D                            B        s:14865,PREL

     1141    14854    5                 WHENALTRETURN DO;

  14848   1                              UNLK_N_ALTRET   null
     1142    14855    5   UNLK_N_ALTRET:     ;
     1143    14856                           %UNLOCK (G=KNA_LNKSSN);

  14861   1 00037D  BB80 0000 0000  02   UNLK_N_ALTRET   LAB,B3   0
          1 000380  CBF0 0100                            LAB,B4   256,IMO
          1 000382  E380 0000 0000  xent                 LNJ,B6   GHH$UNLOCK
          1 000385       0001                            DC       s:14863,PREL

     1144    14863    5                      ALTRETURN;

  14863   1 000386  C380 0000 0000  xent                 LNJ,B4   X6A_AALT

     1145    14864    5                      END;
     1146    14865    4                 END;

  14865   1 000389  0F81 0209                            B        s:14993,PREL
PL6.E3A0      #002=KNA$IN File=KNA$APE.:E05TSI                                   WED 07/30/97 00:57 Page:192  

     1147    14866    4            ELSE DO;

     1148    14867    4                 IF KNA$SSN.EVENT ~= 0 AND (K$RWPARM.STR = KIDM_USER OR K$RWPARM.STR =
             14867                          KIDM_CP

  14867   1 00038B  C846 0016                            LDR,R4   22,B6
          1 00038D  4901 0205                            BEZ,R4   s:14993,PREL
          1 00038F  B847 0037                            LDR,R3   K$RWPARM+29,AUTO
          1 000391  B570 00FF                            AND,R3   255,IMO
          1 000393  3D02                                 CMV,R3   2
          1 000394  0901 000B                            BE       s:14870,PREL
          1 000396  3D01                                 CMV,R3   1
          1 000397  0901 0008                            BE       s:14870,PREL
          1 000399  3D7F                                 CMV,R3   127
          1 00039A  0901 01F8                            BE       s:14993,PREL
          1 00039C  8286                                 LB,'0100'X        ,B6
          1 00039D       0100
          1 00039E  0581 01F4                            BBF      s:14993,PREL

     1149    14868    4                   OR K$RWPARM.STR ~= KIDM_MON AND KNA$SSN.FLAGS.MULT_STR)
     1150    14869    5                 THEN DO;

     1151    14870    5                      COMIO='0'B;

  14870   1 0003A0  8747 006C                            CL       COMIO,AUTO
          1 0003A2  8747 006D                            CL       COMIO+1,AUTO

     1152    14871    5                      COMIO.P#=SIZEW(COMIO)-SIZEW(COMIO.P#);

  14871   1 0003A4  6C01                                 LDV,R6   1
          1 0003A5  EF47 006C                            STR,R6   COMIO,AUTO

     1153    14872    5                      COMIO.ARS=KN$NETPARM.UHDR$->KV$VDO_RQSDAT.MAXNMBBYT;

  14872   1 0003A7  DCC7 0004                            LDB,B5   @KN$NETPARM,AUTO
          1 0003A9  CCC5 0005                            LDB,B4   5,B5
PL6.E3A0      #002=KNA$IN File=KNA$APE.:E05TSI                                   WED 07/30/97 00:57 Page:193  
          1 0003AB  D844 0003                            LDR,R5   3,B4
          1 0003AD  DF47 006D                            STR,R5   COMIO+1,AUTO

     1154    14873    5                      CALL GHS$EVENT(KNA$SSN.USER#,%GH_USRDMN#,%G_DATA_RQS#,KNA$SSN.
             14873                               EVENT,,COMIO);

  14873   1 0003AF  CBF0 0000                            LAB,B4   0,IMO
          1 0003B1  BBF0 0003                            LAB,B3   3,IMO
          1 0003B3  ABC7 006C                            LAB,B2   COMIO,AUTO
          1 0003B5  AFC7 008A                            STB,B2   NWIO+28,AUTO
          1 0003B7  9B80 0000 0000                       LAB,B1   0
          1 0003BA  9FC7 0088                            STB,B1   NWIO+26,AUTO
          1 0003BC  DBC6 0016                            LAB,B5   22,B6
          1 0003BE  DFC7 0086                            STB,B5   NWIO+24,AUTO
          1 0003C0  BFC7 0084                            STB,B3   NWIO+22,AUTO
          1 0003C2  CFC7 0082                            STB,B4   NWIO+20,AUTO
          1 0003C4  DBC6 0011                            LAB,B5   17,B6
          1 0003C6  DFC7 0080                            STB,B5   NWIO+18,AUTO
          1 0003C8  BBC7 0080                            LAB,B3   NWIO+18,AUTO
          1 0003CA  CBF0 0600                            LAB,B4   1536,IMO
          1 0003CC  E380 0000 0000  xent                 LNJ,B6   GHS$EVENT
          1 0003CF       0001                            DC       s:14875,PREL

     1155    14874    5                      END;

     1156    14875    4                 END;

  14875   1 0003D0  0F81 01C2                            B        s:14993,PREL

     1157    14876        %EJECT;
PL6.E3A0      #002=KNA$IN File=KNA$APE.:E05TSI                                   WED 07/30/97 00:57 Page:194  
     1158    14877        /*
     1159    14878             Ignore output block for now
     1160    14879         */
     1161    14880    3          CASE (%KV_VDO_FNC_BLKDAT);

     1162    14881
     1163    14882    3            IF KNA$SSN.EVENT ~= 0 AND (K$RWPARM.STR = KIDM_USER OR K$RWPARM.STR =
             14882                     KIDM_CP

  14882   1 0003D2  CCC7 000B                            LDB,B4   SSN$,AUTO
          1 0003D4  E844 0016                            LDR,R6   22,B4
          1 0003D6  6901 01BC                            BEZ,R6   s:14993,PREL
          1 0003D8  D847 0037                            LDR,R5   K$RWPARM+29,AUTO
          1 0003DA  D570 00FF                            AND,R5   255,IMO
          1 0003DC  5D02                                 CMV,R5   2
          1 0003DD  0901 000B                            BE       s:14885,PREL
          1 0003DF  5D01                                 CMV,R5   1
          1 0003E0  0901 0008                            BE       s:14885,PREL
          1 0003E2  5D7F                                 CMV,R5   127
          1 0003E3  0901 01AF                            BE       s:14993,PREL
          1 0003E5  8284                                 LB,'0100'X        ,B4
          1 0003E6       0100
          1 0003E7  0581 01AB                            BBF      s:14993,PREL

     1164    14883    3              OR K$RWPARM.STR ~= KIDM_MON AND KNA$SSN.FLAGS.MULT_STR)
     1165    14884    4            THEN DO;

     1166    14885    4                 COMIO='0'B;

  14885   1 0003E9  8747 006C                            CL       COMIO,AUTO
          1 0003EB  8747 006D                            CL       COMIO+1,AUTO

     1167    14886    4                 COMIO.P#=SIZEW(COMIO)-SIZEW(COMIO.P#);

  14886   1 0003ED  6C01                                 LDV,R6   1
          1 0003EE  EF47 006C                            STR,R6   COMIO,AUTO

PL6.E3A0      #002=KNA$IN File=KNA$APE.:E05TSI                                   WED 07/30/97 00:57 Page:195  
     1168    14887    4                 COMIO.ARS=KN$NETPARM.UHDR$->KV$VDO_BLKDAT.RCRBYTSIZ;

  14887   1 0003F0  DCC6 0005                            LDB,B5   5,B6
          1 0003F2  C845 0001                            LDR,R4   1,B5
          1 0003F4  CF47 006D                            STR,R4   COMIO+1,AUTO

     1169    14888    4                 CALL GHS$EVENT(KNA$SSN.USER#,%GH_USRDMN#,%G_DATA_AVL#,KNA$SSN.EVENT,,
             14888                          COMIO);

  14888   1 0003F6  DBF0 0000                            LAB,B5   0,IMO
          1 0003F8  BBF0 0004                            LAB,B3   4,IMO
          1 0003FA  ABC7 006C                            LAB,B2   COMIO,AUTO
          1 0003FC  AFC7 008A                            STB,B2   NWIO+28,AUTO
          1 0003FE  9B80 0000 0000                       LAB,B1   0
          1 000401  9FC7 0088                            STB,B1   NWIO+26,AUTO
          1 000403  EBC4 0016                            LAB,B6   22,B4
          1 000405  EFC7 0086                            STB,B6   NWIO+24,AUTO
          1 000407  BFC7 0084                            STB,B3   NWIO+22,AUTO
          1 000409  DFC7 0082                            STB,B5   NWIO+20,AUTO
          1 00040B  EBC4 0011                            LAB,B6   17,B4
          1 00040D  EFC7 0080                            STB,B6   NWIO+18,AUTO
          1 00040F  BBC7 0080                            LAB,B3   NWIO+18,AUTO
          1 000411  CBF0 0600                            LAB,B4   1536,IMO
          1 000413  E380 0000 0000  xent                 LNJ,B6   GHS$EVENT
          1 000416       0001                            DC       s:14889,PREL

     1170    14889    4                 END;

  14889   1 000417  0F81 017B                            B        s:14993,PREL

     1171    14890        %EJECT;
PL6.E3A0      #002=KNA$IN File=KNA$APE.:E05TSI                                   WED 07/30/97 00:57 Page:196  
     1172    14891    3          CASE (%KV_VDO_FNC_DAT_IMD);

     1173    14892    3            IF KV$VDOHDR.STR = KIDM_MON    /* Monitor stream                     */

  14892   1 000419  E805                                 LDR,R6   ,B5
          1 00041A  E570 007F                            AND,R6   127,IMO
          1 00041C  6D7F                                 CMV,R6   127
          1 00041D  0981 0175                            BNE      s:14993,PREL

     1174    14893    4            THEN DO;

     1175    14894    4                 DATASIZE=K$RWPARM.MSGSZ;

  14894   1 00041F  D847 001C                            LDR,R5   K$RWPARM+2,AUTO
          1 000421  DF47 000F                            STR,R5   DATASIZE,AUTO

     1176    14895    4                 DATA$=K$RWPARM.MSGC$;

  14895   1 000423  8CC7 001A                            LDI      K$RWPARM,AUTO
          1 000425  8D47 0011                            SDI      DATA$,AUTO

     1177    14896
     1178    14897
     1179    14898    4                 CALL GJU$EVENT(KNA$SSN.USER#,DATA$->DATASTRING);

  14898   1 000427  9856                                 LDR,R1   R6
          1 000428  E570 7FFF                            AND,R6   32767,IMO
          1 00042A  8D47 0080                            SDI      NWIO+18,AUTO
          1 00042C  DCC7 0080                            LDB,B5   NWIO+18,AUTO
          1 00042E  104F                                 SOR,R1   15
          1 00042F  DFC7 0086                            STB,B5   NWIO+24,AUTO
          1 000431  8CC7 0086                            LDI      NWIO+24,AUTO
          1 000433  7031                                 DCL,R7   1
          1 000434  8D47 0088                            SDI      NWIO+26,AUTO
          1 000436  F851                                 LDR,R7   R1
          1 000437  6C00                                 LDV,R6   0
          1 000438  8447 0088                            AID      NWIO+26,AUTO
PL6.E3A0      #002=KNA$IN File=KNA$APE.:E05TSI                                   WED 07/30/97 00:57 Page:197  
          1 00043A  7071                                 DCR,R7   1
          1 00043B  8D47 0084                            SDI      NWIO+22,AUTO
          1 00043D  CCC7 000B                            LDB,B4   SSN$,AUTO
          1 00043F  BBC4 0011                            LAB,B3   17,B4
          1 000441  BFC7 0082                            STB,B3   NWIO+20,AUTO
          1 000443  BBC7 0082                            LAB,B3   NWIO+20,AUTO
          1 000445  CBF0 0200                            LAB,B4   512,IMO
          1 000447  E380 0000 0000  xent                 LNJ,B6   GJU$EVENT
          1 00044A       0001                            DC       s:14899,PREL

     1180    14899    4                 END;

  14899   1 00044B  0F81 0147                            B        s:14993,PREL

     1181    14900
     1182    14901        %EJECT;
PL6.E3A0      #002=KNA$IN File=KNA$APE.:E05TSI                                   WED 07/30/97 00:57 Page:198  
     1183    14902    3          CASE (%KV_VDO_FNC_EVT);

     1184    14903    3            IF KNA$SSN.STATE = %KNA_STATE_ACTIVE#

  14903   1 00044D  CCC7 000B                            LDB,B4   SSN$,AUTO
          1 00044F  E844 0013                            LDR,R6   19,B4
          1 000451  6D03                                 CMV,R6   3
          1 000452  0981 002F                            BNE      s:14911,PREL

     1185    14904    3            THEN
     1186    14905    3                 IF KV$VDO_EVT.TYP = %KV_EVTTYP_BRK

  14905   1 000454  D845 0001                            LDR,R5   1,B5
          1 000456  D570 00FF                            AND,R5   255,IMO
          1 000458  5D01                                 CMV,R5   1
          1 000459  0981 0018                            BNE      s:14910,PREL
          1 00045B  C2C5 0001                            LLH,R4   1,B5
          1 00045D  4D04                                 CMV,R4   4
          1 00045E  0281 0013                            BGE      s:14910,PREL

     1187    14906    3                   AND KV$VDO_EVT.BRKCNT < 4
     1188    14907    3                 THEN
     1189    14908    3                      CALL GHS$RUE(%GH_EVCBK,KNA$SSN.USER#);

  14908   1 000460  BBF0 001C                            LAB,B3   28,IMO
          1 000462  ABC4 0011                            LAB,B2   17,B4
          1 000464  AFC7 0082                            STB,B2   NWIO+20,AUTO
          1 000466  BFC7 0080                            STB,B3   NWIO+18,AUTO
          1 000468  BBC7 0080                            LAB,B3   NWIO+18,AUTO
          1 00046A  CBF0 0200                            LAB,B4   512,IMO
          1 00046C  E380 0000 0000  xent                 LNJ,B6   GHS$RUE
          1 00046F       0001                            DC       s:14908+16,PREL
          1 000470  0F81 0011                            B        s:14911,PREL

     1190    14909    3                 ELSE
     1191    14910    3                      CALL GHS$RUE(%GH_EVCEC,KNA$SSN.USER#);

PL6.E3A0      #002=KNA$IN File=KNA$APE.:E05TSI                                   WED 07/30/97 00:57 Page:199  
  14910   1 000472  BBF0 001E                            LAB,B3   30,IMO
          1 000474  ABC4 0011                            LAB,B2   17,B4
          1 000476  AFC7 0082                            STB,B2   NWIO+20,AUTO
          1 000478  BFC7 0080                            STB,B3   NWIO+18,AUTO
          1 00047A  BBC7 0080                            LAB,B3   NWIO+18,AUTO
          1 00047C  CBF0 0200                            LAB,B4   512,IMO
          1 00047E  E380 0000 0000  xent                 LNJ,B6   GHS$RUE
          1 000481       0001                            DC       s:14911,PREL

     1192    14911    3            GOTO CHECK_MRKPND;

  14911   1 000482  0F81 0054                            B        s:14939,PREL

     1193    14912        %EJECT;
PL6.E3A0      #002=KNA$IN File=KNA$APE.:E05TSI                                   WED 07/30/97 00:57 Page:200  
     1194    14913    3          CASE (%KV_VDO_FNC_DSC_RQS);

     1195    14914    3            IF KNA$SSN.STATE = %KNA_STATE_ACTIVE#

  14914   1 000484  CCC7 000B                            LDB,B4   SSN$,AUTO
          1 000486  E844 0013                            LDR,R6   19,B4
          1 000488  6D03                                 CMV,R6   3
          1 000489  0981 0011                            BNE      s:14917,PREL

     1196    14915    3            THEN
     1197    14916    3                 CALL GHS$RUE(%GH_EVDSC,KNA$SSN.USER#);

  14916   1 00048B  BBF0 0020                            LAB,B3   32,IMO
          1 00048D  ABC4 0011                            LAB,B2   17,B4
          1 00048F  AFC7 0082                            STB,B2   NWIO+20,AUTO
          1 000491  BFC7 0080                            STB,B3   NWIO+18,AUTO
          1 000493  BBC7 0080                            LAB,B3   NWIO+18,AUTO
          1 000495  CBF0 0200                            LAB,B4   512,IMO
          1 000497  E380 0000 0000  xent                 LNJ,B6   GHS$RUE
          1 00049A       0001                            DC       s:14917,PREL

     1198    14917    3            KNA$SSN.STATE = %KNA_STATE_DSC#;

  14917   1 00049B  ECC7 000B                            LDB,B6   SSN$,AUTO
          1 00049D  6C04                                 LDV,R6   4
          1 00049E  EF46 0013                            STR,R6   19,B6

     1199    14918    3            KNA$SSN.ERROR = ELDSC;

  14918   1 0004A0  8C80 0000 0002  00                   LDI      ELDSC
          1 0004A3  8D46 0001                            SDI      1,B6

     1200    14919    3            KNA$SSN.FLAGS.SSNERR = '1'B;

  14919   1 0004A5  8906                                 LBT,'0800'X       ,B6
  14919   1 0004A6       0800

PL6.E3A0      #002=KNA$IN File=KNA$APE.:E05TSI                                   WED 07/30/97 00:57 Page:201  
     1201    14920    3            GOTO CHECK_MRKPND;

  14920   1 0004A7  0F81 002F                            B        s:14939,PREL

     1202    14921
     1203    14922        %EJECT;
PL6.E3A0      #002=KNA$IN File=KNA$APE.:E05TSI                                   WED 07/30/97 00:57 Page:202  
     1204    14923    3          CASE (%KV_VDO_FNC_CLSSSN_RQS);

     1205    14924    3            KNA$SSN.STATE = %KNA_STATE_DSC#;

  14924   1 0004A9  CCC7 000B                            LDB,B4   SSN$,AUTO
          1 0004AB  6C04                                 LDV,R6   4
          1 0004AC  EF44 0013                            STR,R6   19,B4

     1206    14925    3            CALL GHS$RUE(%GH_EVBRK,KNA$SSN.USER#);

  14925   1 0004AE  DBF0 0009                            LAB,B5   9,IMO
          1 0004B0  BBC4 0011                            LAB,B3   17,B4
          1 0004B2  BFC7 0082                            STB,B3   NWIO+20,AUTO
          1 0004B4  DFC7 0080                            STB,B5   NWIO+18,AUTO
          1 0004B6  BBC7 0080                            LAB,B3   NWIO+18,AUTO
          1 0004B8  CBF0 0200                            LAB,B4   512,IMO
          1 0004BA  E380 0000 0000  xent                 LNJ,B6   GHS$RUE
          1 0004BD       0001                            DC       s:14926,PREL

     1207    14926    3            KNA$SSN.ERROR = ELDSC;

  14926   1 0004BE  8C80 0000 0002  00                   LDI      ELDSC
          1 0004C1  ECC7 000B                            LDB,B6   SSN$,AUTO
          1 0004C3  8D46 0001                            SDI      1,B6

     1208    14927    3            IF KNA$SSN.IOPRD$ ~= ADDR(NIL)

  14927   1 0004C5  8DC6 000D                            CMN      13,B6
          1 0004C7  0901 00CB                            BE       s:14993,PREL
          1 0004C9  DCC6 000D                            LDB,B5   13,B6
          1 0004CB  82C5 0003                            LB,'2000'X        3,B5
          1 0004CD       2000
          1 0004CE  0501 00C4                            BBT      s:14993,PREL

     1209    14928    3              AND NOT KNA$SSN.IOPRD$->KN$IOP.FLAGS.RDDONE
     1210    14929    4            THEN DO;

PL6.E3A0      #002=KNA$IN File=KNA$APE.:E05TSI                                   WED 07/30/97 00:57 Page:203  
     1211    14930    4                 KNA$SSN.IOPRD$->KN$IOP.ERRCODE = ELDSC;

  14930   1 0004D0  8D05                                 SDI      ,B5

     1212    14931    4                 IOP$ = KNA$SSN.IOPRD$;

  14931   1 0004D1  DCC6 000D                            LDB,B5   13,B6
          1 0004D3  DFC7 000D                            STB,B5   IOP$,AUTO

     1213    14932    4                 GOTO READ_COMP;

  14932   1 0004D5  0F81 FD53                            B        s:14771,PREL

     1214    14933    4                 END;
     1215    14934
     1216    14935        %EJECT;
PL6.E3A0      #002=KNA$IN File=KNA$APE.:E05TSI                                   WED 07/30/97 00:57 Page:204  
     1217    14936    3          CASE (%KV_VDO_FNC_PRM_SET);

     1218    14937
     1219    14938        %EJECT;
PL6.E3A0      #002=KNA$IN File=KNA$APE.:E05TSI                                   WED 07/30/97 00:57 Page:205  
     1220    14939    3          CASE (%KV_VDO_FNC_RQSMRK);

  14936   1                              CHECK_MRKPND    null
     1221    14940    3   CHECK_MRKPND: ;
     1222    14941    3            IF K$RWPARM.MRKTYP = %KV_VDOMRKTYP_MRK

  14941   1 0004D7  E2C7 0037            CHECK_MRKPND    LLH,R6   K$RWPARM+29,AUTO
          1 0004D9  6D03                                 CMV,R6   3
          1 0004DA  0981 00B8                            BNE      s:14993,PREL

     1223    14942    4            THEN DO;

     1224    14943                                           /*  If there is a marker pending send it   */
     1225    14944    4                 IF (KNA$SSN.FLAGS.MRKPND)

  14944   1 0004DC  ECC7 000B                            LDB,B6   SSN$,AUTO
          1 0004DE  8286                                 LB,'0080'X        ,B6
          1 0004DF       0080
          1 0004E0  0581 002B                            BBF      s:14954,PREL

     1226    14945    5                 THEN DO;

     1227    14946    5                      OPARM = KNA_RWPARM_CON;

  14946   1 0004E2  AB80 0000 0000  xsym                 LAB,B2   KNA_RWPARM_CON
          1 0004E5  2C00                                 LDV,R2   0
          1 0004E6  6C52                                 LDV,R6   82
          1 0004E7  BBC7 0043                            LAB,B3   OPARM,AUTO
          1 0004E9  3C00                                 LDV,R3   0
          1 0004EA  0008                                 MMM

     1228    14947    5                      OPARM.MARKER = KNA$SSN.MARKER;

  14947   1 0004EB  ECC7 000B                            LDB,B6   SSN$,AUTO
          1 0004ED  8CC6 0017                            LDI      23,B6
          1 0004EF  8D47 0050                            SDI      OPARM+13,AUTO

PL6.E3A0      #002=KNA$IN File=KNA$APE.:E05TSI                                   WED 07/30/97 00:57 Page:206  
     1229    14948    5                      OPARM.MRKTYP = %KV_VDOMRKTYP_MRK;

  14948   1 0004F1  5C03                                 LDV,R5   3
          1 0004F2  D7C7 0060                            STH,R5   OPARM+29,AUTO

     1230    14949    5                      CALL KNA$FCNO(%KV_VDO_FNC_MRK,KNA$SSN,OPARM,KN$NETPARM.ERRCODE)

  14949   1 0004F4  DBF0 001F                            LAB,B5   31,IMO
          1 0004F6  CCC7 0004                            LDB,B4   @KN$NETPARM,AUTO
          1 0004F8  BBC4 0016                            LAB,B3   22,B4
          1 0004FA  BFC7 0086                            STB,B3   NWIO+24,AUTO
          1 0004FC  ABC7 0043                            LAB,B2   OPARM,AUTO
          1 0004FE  AFC7 0084                            STB,B2   NWIO+22,AUTO
          1 000500  EFC7 0082                            STB,B6   NWIO+20,AUTO
          1 000502  DFC7 0080                            STB,B5   NWIO+18,AUTO
          1 000504  BBC7 0080                            LAB,B3   NWIO+18,AUTO
          1 000506  CBF0 0400                            LAB,B4   1024,IMO
          1 000508  E380 0000 0000  xent                 LNJ,B6   KNA$FCNO
          1 00050B       FE72                            DC       s:14854,PREL

     1231    14950    5                        ALTRET (UNLK_N_ALTRET);
     1232    14951    5                      END;

     1233    14952                                            /* Save marker for EXIT, next READ, or
     1234    14953                                                an EVENT. */
     1235    14954    4                 KNA$SSN.MARKER = K$RWPARM.MARKER;

  14954   1 00050C  8CC7 0027                            LDI      K$RWPARM+13,AUTO
          1 00050E  ECC7 000B                            LDB,B6   SSN$,AUTO
          1 000510  8D46 0017                            SDI      23,B6

     1236    14955    4                 KNA$SSN.FLAGS.MRKPND = '1'B;

  14955   1 000512  8906                                 LBT,'0080'X       ,B6
  14955   1 000513       0080

     1237    14956                                            /* Clear marker type so we don't send a
PL6.E3A0      #002=KNA$IN File=KNA$APE.:E05TSI                                   WED 07/30/97 00:57 Page:207  
     1238    14957                                                marker back */
     1239    14958    4                 K$RWPARM.MRKTYP = 0;

  14958   1 000514  87C7 0037                            CLH      K$RWPARM+29,AUTO

     1240    14959    4                 END ;                     /* Do Case                            */

  14959   1 000516  0F81 007C                            B        s:14993,PREL

     1241    14960        %EJECT;
PL6.E3A0      #002=KNA$IN File=KNA$APE.:E05TSI                                   WED 07/30/97 00:57 Page:208  
     1242    14961    3          CASE (%KV_VDO_FNC_RQSSTT);

     1243    14962    3            CALL GHQ$STATE(KN$LDCT.USER#,STATE);

  14962   1 000518  CC86                                 LDB,B4   ,B6
          1 000519  BBC7 0018                            LAB,B3   STATE,AUTO
          1 00051B  BFC7 0082                            STB,B3   NWIO+20,AUTO
          1 00051D  DBC4 000E                            LAB,B5   14,B4
          1 00051F  DFC7 0080                            STB,B5   NWIO+18,AUTO
          1 000521  BBC7 0080                            LAB,B3   NWIO+18,AUTO
          1 000523  CBF0 0200                            LAB,B4   512,IMO
          1 000525  E380 0000 0000  xent                 LNJ,B6   GHQ$STATE
          1 000528       0001                            DC       s:14963,PREL

     1244    14963    3            K$RWPARM.MSG$ = ADDR(STATE);

  14963   1 000529  EBC7 0018                            LAB,B6   STATE,AUTO
          1 00052B  EFC7 001A                            STB,B6   K$RWPARM,AUTO

     1245    14964    3            K$RWPARM.MSGSZ = SIZEC(STATE);

  14964   1 00052D  6C04                                 LDV,R6   4
          1 00052E  EF47 001C                            STR,R6   K$RWPARM+2,AUTO

     1246    14965    3            CALL KNA$FCNO (%KV_VDO_FNC_STT,KNA$SSN,K$RWPARM,KN$NETPARM.ERRCODE)

  14965   1 000530  DBF0 001D                            LAB,B5   29,IMO
          1 000532  CCC7 0004                            LDB,B4   @KN$NETPARM,AUTO
          1 000534  BBC4 0016                            LAB,B3   22,B4
          1 000536  BFC7 0086                            STB,B3   NWIO+24,AUTO
          1 000538  ABC7 001A                            LAB,B2   K$RWPARM,AUTO
          1 00053A  AFC7 0084                            STB,B2   NWIO+22,AUTO
          1 00053C  9CC7 000B                            LDB,B1   SSN$,AUTO
          1 00053E  9FC7 0082                            STB,B1   NWIO+20,AUTO
          1 000540  DFC7 0080                            STB,B5   NWIO+18,AUTO
          1 000542  BBC7 0080                            LAB,B3   NWIO+18,AUTO
          1 000544  CBF0 0400                            LAB,B4   1024,IMO
PL6.E3A0      #002=KNA$IN File=KNA$APE.:E05TSI                                   WED 07/30/97 00:57 Page:209  
          1 000546  E380 0000 0000  xent                 LNJ,B6   KNA$FCNO
          1 000549       FE34                            DC       s:14854,PREL
          1 00054A  0F81 0048                            B        s:14993,PREL

     1247    14966    3              ALTRET (UNLK_N_ALTRET);
     1248    14967
     1249    14968
     1250    14969        %EJECT;
PL6.E3A0      #002=KNA$IN File=KNA$APE.:E05TSI                                   WED 07/30/97 00:57 Page:210  
     1251    14970    3          CASE (%KV_VDO_FNC_MRK);

     1252    14971
     1253    14972    3            IF KNA$SSN.FLAGS.RRRPND AND KNA$SSN.FLAGS.REGGED

  14972   1 00054C  CCC7 000B                            LDB,B4   SSN$,AUTO
          1 00054E  8284                                 LB,'0200'X        ,B4
          1 00054F       0200
          1 000550  0581 003B                            BBF      s:14986,PREL
          1 000552  8984                                 CMZ      ,B4
          1 000553  0881 0038                            BAGE     s:14986,PREL
          1 000555  9844 0011                            LDR,R1   17,B4
          1 000557  BC80 0000 0000  xsym                 LDB,B3   G$USRT$
          1 00055A  9F47 0080                            STR,R1   NWIO+18,AUTO
          1 00055C  1F18                                 MLV,R1   24
          1 00055D  B847 0080                            LDR,R3   NWIO+18,AUTO
          1 00055F  3F18                                 MLV,R3   24
          1 000560  E833                                 LDR,R6   ,B3,R3
          1 000561  E570 0800                            AND,R6   2048,IMO
          1 000563  6901 0028                            BEZ,R6   s:14986,PREL

     1254    14973    3              AND G$USER.FLG(KNA$SSN.USER#) & %U_SCIO
     1255    14974    4            THEN DO;

     1256    14975    4                 IOP$ = KNA$SSN.IOPQ$;

  14975   1 000565  DCC4 000B                            LDB,B5   11,B4
          1 000567  DFC7 000D                            STB,B5   IOP$,AUTO

     1257    14976    4                 IF IOP$ ~= ADDR(NIL)

  14976   1 000569  8DC7 000D                            CMN      IOP$,AUTO
          1 00056B  0901 000C                            BE       s:14982,PREL

     1258    14977    5                 THEN DO;

     1259    14978    5                      KN$IOP.ERRCODE = K$RWPARM.MSG_ERRCODE;
PL6.E3A0      #002=KNA$IN File=KNA$APE.:E05TSI                                   WED 07/30/97 00:57 Page:211  

  14978   1 00056D  8CC7 0034                            LDI      K$RWPARM+26,AUTO
          1 00056F  8D05                                 SDI      ,B5

     1260    14979    5                      KN$IOP.MSGID = K$RWPARM.MSGID;

  14979   1 000570  8CC7 002B                            LDI      K$RWPARM+17,AUTO
          1 000572  8D45 000C                            SDI      12,B5

     1261    14980    5                      KN$IOP.FLDID = K$RWPARM.FLDID;

  14980   1 000574  D847 0040                            LDR,R5   K$RWPARM+38,AUTO
          1 000576  DF45 0002                            STR,R5   2,B5

     1262    14981    5                      END;

     1263    14982    4                 CALL GHS$RUE (%GH_EVCIC,KNA$SSN.USER#);

  14982   1 000578  BBF0 0017                            LAB,B3   23,IMO
          1 00057A  ABC4 0011                            LAB,B2   17,B4
          1 00057C  AFC7 0082                            STB,B2   NWIO+20,AUTO
          1 00057E  BFC7 0080                            STB,B3   NWIO+18,AUTO
          1 000580  BBC7 0080                            LAB,B3   NWIO+18,AUTO
          1 000582  CBF0 0200                            LAB,B4   512,IMO
          1 000584  E380 0000 0000  xent                 LNJ,B6   GHS$RUE
          1 000587       0001                            DC       s:14983,PREL

     1264    14983    4                 KNA$SSN.FLAGS.RRRPND= '0'B;

  14983   1 000588  ECC7 000B                            LDB,B6   SSN$,AUTO
          1 00058A  8806                                 LBF,'0200'X       ,B6
          1 00058B       0200

     1265    14984    4                 END;

     1266    14985                                 /* Clear marker type so we wont send a marker back   */
     1267    14986    3            K$RWPARM.MRKTYP = 0;
PL6.E3A0      #002=KNA$IN File=KNA$APE.:E05TSI                                   WED 07/30/97 00:57 Page:212  

  14986   1 00058C  87C7 0037                            CLH      K$RWPARM+29,AUTO
          1 00058E  0F81 0004                            B        s:14993,PREL

     1268    14987
     1269    14988        %EJECT;
PL6.E3A0      #002=KNA$IN File=KNA$APE.:E05TSI                                   WED 07/30/97 00:57 Page:213  
     1270    14989    3          CASE (ELSE);

     1271    14990    3            CALL PROTOCOL_ERR;

  14990   1 000590  E3C0 00EE                            LNJ,B6   s:0,PREL
          1 000592       0001                            DC       s:14993,PREL

     1272    14991    3            END/* do case (kv$vdohdr.fnc) */;

     1273    14992
     1274    14993    2         IF K$RWPARM.MRKTYP ~= 0

  14993   1 000593  E2C7 0037                            LLH,R6   K$RWPARM+29,AUTO
          1 000595  6901 00DD                            BEZ,R6   s:15054,PREL

     1275    14994    3         THEN DO;

     1276    14995    3              OPARM = KNA_RWPARM_CON;

  14995   1 000597  AB80 0000 0000  xsym                 LAB,B2   KNA_RWPARM_CON
          1 00059A  2C00                                 LDV,R2   0
          1 00059B  6C52                                 LDV,R6   82
          1 00059C  BBC7 0043                            LAB,B3   OPARM,AUTO
          1 00059E  3C00                                 LDV,R3   0
          1 00059F  0008                                 MMM

     1277    14996    3              OPARM.MRKTYP = K$RWPARM.MRKTYP;

  14996   1 0005A0  E2C7 0037                            LLH,R6   K$RWPARM+29,AUTO
          1 0005A2  E7C7 0060                            STH,R6   OPARM+29,AUTO

     1278    14997
     1279    14998    4              DO CASE(K$RWPARM.MRKTYP);

  14998   1 0005A4  B856                                 LDR,R3   R6
          1 0005A5  3D05                                 CMV,R3   5
          1 0005A6  0281 0023                            BGE      s:15013,PREL
PL6.E3A0      #002=KNA$IN File=KNA$APE.:E05TSI                                   WED 07/30/97 00:57 Page:214  
          1 0005A8  A830 0000 05AE  01                   LDR,R2   s:14998+10,R3
          1 0005AB  83A0 0000 05B3  01                   JMP      s:15001,R2
          1 0005AE       0017                            DC       s:15013,PREL
          1 0005AF       0013                            DC       s:15009,PREL
          1 0005B0       000B                            DC       s:15005,PREL
          1 0005B1       0013                            DC       s:15009,PREL
          1 0005B2       0000                            DC       s:15001,PREL

     1280    14999
     1281    15000    4               CASE (%KV_VDOMRKTYP_SNDLSTRCRID);

     1282    15001    4                 OPARM.BLKREC = KNA$SSN.BLKREC;

  15001   1 0005B3  ECC7 000B                            LDB,B6   SSN$,AUTO
          1 0005B5  8CC6 0014                            LDI      20,B6
          1 0005B7  8D47 0050                            SDI      OPARM+13,AUTO

     1283    15002    4                 OPARM.MRKTYP = %KV_VDOMRKTYP_LSTRCRID;

  15002   1 0005B9  5C02                                 LDV,R5   2
          1 0005BA  D7C7 0060                            STH,R5   OPARM+29,AUTO
          1 0005BC  0F81 000D                            B        s:15013,PREL

     1284    15003
     1285    15004    4               CASE (%KV_VDOMRKTYP_LSTRCRID);

     1286    15005    4                 KNA$SSN.BLKREC = K$RWPARM.BLKREC;

  15005   1 0005BE  8CC7 0027                            LDI      K$RWPARM+13,AUTO
          1 0005C0  ECC7 000B                            LDB,B6   SSN$,AUTO
          1 0005C2  8D46 0014                            SDI      20,B6

     1287    15006    4                 GOTO NO_MARKER;

  15006   1 0005C4  0F81 0029                            B        s:15009,PREL

     1288    15007
PL6.E3A0      #002=KNA$IN File=KNA$APE.:E05TSI                                   WED 07/30/97 00:57 Page:215  
     1289    15008    4               CASE (%KV_VDOMRKTYP_ENDACK,%KV_VDOMRKTYP_MRK);

     1290    15009    4                 OPARM.MARKER = K$RWPARM.MARKER;

  15009   1 0005C6  8CC7 0027                            LDI      K$RWPARM+13,AUTO
          1 0005C8  8D47 0050                            SDI      OPARM+13,AUTO

     1291    15010
     1292    15011    4                 END;

     1293    15012
     1294    15013    3              CALL KNA$FCNO (%KV_VDO_FNC_MRK,KNA$SSN,OPARM,KN$NETPARM.ERRCODE)

  15013   1 0005CA  EBF0 001F                            LAB,B6   31,IMO
          1 0005CC  DCC7 0004                            LDB,B5   @KN$NETPARM,AUTO
          1 0005CE  CBC5 0016                            LAB,B4   22,B5
          1 0005D0  CFC7 0086                            STB,B4   NWIO+24,AUTO
          1 0005D2  BBC7 0043                            LAB,B3   OPARM,AUTO
          1 0005D4  BFC7 0084                            STB,B3   NWIO+22,AUTO
          1 0005D6  ACC7 000B                            LDB,B2   SSN$,AUTO
          1 0005D8  AFC7 0082                            STB,B2   NWIO+20,AUTO
          1 0005DA  EFC7 0080                            STB,B6   NWIO+18,AUTO
          1 0005DC  BBC7 0080                            LAB,B3   NWIO+18,AUTO
          1 0005DE  CBF0 0400                            LAB,B4   1024,IMO
          1 0005E0  E380 0000 0000  xent                 LNJ,B6   KNA$FCNO
          1 0005E3       0003                            DC       s:15015,PREL
          1 0005E4  0F81 0009                            B        s:15009,PREL

     1295    15014    4              WHENALTRETURN DO;

     1296    15015    4                   KV$VDOHDR.FNC = %KV_VDO_FNC_RQSMRK;

  15015   1 0005E6  ECC7 0004                            LDB,B6   @KN$NETPARM,AUTO
          1 0005E8  DCC6 0005                            LDB,B5   5,B6
          1 0005EA  6C20                                 LDV,R6   32
          1 0005EB  E785                                 STH,R6   ,B5

PL6.E3A0      #002=KNA$IN File=KNA$APE.:E05TSI                                   WED 07/30/97 00:57 Page:216  
     1297    15016    4                   GOTO UNLK_N_ALTRET;

  15016   1 0005EC  0F81 FD90                            B        s:14854,PREL

  15009   1                              NO_MARKER       null
     1298    15017    4                   END;
     1299    15018    3   NO_MARKER: ;
     1300    15019    3              END;

  15019   1 0005EE  0F81 0084            NO_MARKER       B        s:15054,PREL

     1301    15020        %EJECT;
PL6.E3A0      #002=KNA$IN File=KNA$APE.:E05TSI                                   WED 07/30/97 00:57 Page:217  
     1302    15021    2       CASE (%KN_FCN_UNQ);

     1303    15022    2         IF KNA$SSN.FLAGS.CQ

  15022   1 0005F0  8284                                 LB,'2000'X        ,B4
  15022   1 0005F1       2000
          1 0005F2  0581 0080                            BBF      s:15054,PREL

     1304    15023    3         THEN DO;

     1305    15024    3              CALL GHS$RUE(%GH_EVCUB,KNA$SSN.USER#);

  15024   1 0005F4  BBF0 001A                            LAB,B3   26,IMO
          1 0005F6  ABC4 0011                            LAB,B2   17,B4
          1 0005F8  AFC7 0082                            STB,B2   NWIO+20,AUTO
          1 0005FA  BFC7 0080                            STB,B3   NWIO+18,AUTO
          1 0005FC  BBC7 0080                            LAB,B3   NWIO+18,AUTO
          1 0005FE  CBF0 0200                            LAB,B4   512,IMO
          1 000600  E380 0000 0000  xent                 LNJ,B6   GHS$RUE
          1 000603       0001                            DC       s:15025,PREL

     1306    15025    3              KNA$SSN.FLAGS.CQ = '0'B;

  15025   1 000604  ECC7 000B                            LDB,B6   SSN$,AUTO
          1 000606  8806                                 LBF,'2000'X       ,B6
          1 000607       2000

     1307    15026    3              KNA$SSN.FLAGS.REGGED = '0'B;

  15026   1 000608  8806                                 LBF,'8000'X       ,B6
  15026   1 000609       8000

     1308    15027    3              END;

  15027   1 00060A  0F81 0068                            B        s:15054,PREL

     1309    15028        %EJECT;
PL6.E3A0      #002=KNA$IN File=KNA$APE.:E05TSI                                   WED 07/30/97 00:57 Page:218  
     1310    15029    2       CASE (%KN_FCN_TERM);

     1311    15030    2         IF KNA$SSN.FLAGS.PRIMARY

  15030   1 00060C  8284                                 LB,'0400'X        ,B4
  15030   1 00060D       0400
          1 00060E  0581 0011                            BBF      s:15033,PREL

     1312    15031    2         THEN
     1313    15032    2              CALL GHS$RUE (%GH_EVDSC,KNA$SSN.USER#);

  15032   1 000610  BBF0 0020                            LAB,B3   32,IMO
          1 000612  ABC4 0011                            LAB,B2   17,B4
          1 000614  AFC7 0082                            STB,B2   NWIO+20,AUTO
          1 000616  BFC7 0080                            STB,B3   NWIO+18,AUTO
          1 000618  BBC7 0080                            LAB,B3   NWIO+18,AUTO
          1 00061A  CBF0 0200                            LAB,B4   512,IMO
          1 00061C  E380 0000 0000  xent                 LNJ,B6   GHS$RUE
          1 00061F       0001                            DC       s:15033,PREL

     1314    15033    2         KNA$SSN.ERROR = ELDSC;

  15033   1 000620  8C80 0000 0002  00                   LDI      ELDSC
          1 000623  ECC7 000B                            LDB,B6   SSN$,AUTO
          1 000625  8D46 0001                            SDI      1,B6

     1315    15034    2         KNA$SSN.FLAGS.SSNERR = '1'B;

  15034   1 000627  8906                                 LBT,'0800'X       ,B6
  15034   1 000628       0800

     1316    15035    2         KNA$SSN.STATE = %KNA_STATE_TERM#;

  15035   1 000629  5C05                                 LDV,R5   5
          1 00062A  DF46 0013                            STR,R5   19,B6

     1317    15036    2         IF G$USER.FLG(KNA$SSN.USER#) & %U_SCIO
PL6.E3A0      #002=KNA$IN File=KNA$APE.:E05TSI                                   WED 07/30/97 00:57 Page:219  

  15036   1 00062C  B846 0011                            LDR,R3   17,B6
          1 00062E  DC80 0000 0000  xsym                 LDB,B5   G$USRT$
          1 000631  BF47 0080                            STR,R3   NWIO+18,AUTO
          1 000633  3F18                                 MLV,R3   24
          1 000634  B847 0080                            LDR,R3   NWIO+18,AUTO
          1 000636  3F18                                 MLV,R3   24
          1 000637  C835                                 LDR,R4   ,B5,R3
          1 000638  C570 0800                            AND,R4   2048,IMO
          1 00063A  4901 0038                            BEZ,R4   s:15054,PREL
          1 00063C  A846 0011                            LDR,R2   17,B6
          1 00063E  CBC5 0005                            LAB,B4   5,B5
          1 000640  2F0C                                 MLV,R2   12
          1 000641  BCA4                                 LDB,B3   ,B4,R2
          1 000642  BDC6 0004                            CMB,B3   4,B6
          1 000644  0981 002E                            BNE      s:15054,PREL

     1318    15037    2           AND G$USER.MISC$(KNA$SSN.USER#) = KNA$SSN.LDCT$
     1319    15038    2         THEN
     1320    15039    2              CALL GHS$RUE (%GH_EVFC,KNA$SSN.USER#);

  15039   1 000646  CBF0 0022                            LAB,B4   34,IMO
          1 000648  BBC6 0011                            LAB,B3   17,B6
          1 00064A  BFC7 0082                            STB,B3   NWIO+20,AUTO
          1 00064C  CFC7 0080                            STB,B4   NWIO+18,AUTO
          1 00064E  BBC7 0080                            LAB,B3   NWIO+18,AUTO
          1 000650  CBF0 0200                            LAB,B4   512,IMO
          1 000652  E380 0000 0000  xent                 LNJ,B6   GHS$RUE
          1 000655       0001                            DC       s:15039+16,PREL
          1 000656  0F81 001C                            B        s:15054,PREL

     1321    15040
     1322    15041        %EJECT;
PL6.E3A0      #002=KNA$IN File=KNA$APE.:E05TSI                                   WED 07/30/97 00:57 Page:220  
     1323    15042    2       CASE (%KN_FCN_TERM_ACK);

     1324    15043    2         CALL GHS$RUE (%GH_EVCIC,KNA$SSN.USER#);

  15043   1 000658  BBF0 0017                            LAB,B3   23,IMO
          1 00065A  ABC4 0011                            LAB,B2   17,B4
          1 00065C  AFC7 0082                            STB,B2   NWIO+20,AUTO
          1 00065E  BFC7 0080                            STB,B3   NWIO+18,AUTO
          1 000660  BBC7 0080                            LAB,B3   NWIO+18,AUTO
          1 000662  CBF0 0200                            LAB,B4   512,IMO
          1 000664  E380 0000 0000  xent                 LNJ,B6   GHS$RUE
          1 000667       0001                            DC       s:15043+16,PREL
          1 000668  0F81 000A                            B        s:15054,PREL

     1325    15044
     1326    15045        %EJECT;
PL6.E3A0      #002=KNA$IN File=KNA$APE.:E05TSI                                   WED 07/30/97 00:57 Page:221  
     1327    15046    2       CASE (ELSE);

     1328    15047    2         CALL SCREECH (SCR_UNEXP);

  15047   1 00066A  BB80 0000 0002  02                   LAB,B3   +2
          1 00066D  CBF0 0100                            LAB,B4   256,IMO
          1 00066F  E380 0000 0000  xent                 LNJ,B6   SCREECH
          1 000672       0001                            DC       s:15054,PREL

     1329    15048    2         END;

     1330    15049           %UNLOCK (G=KNA_LNKSSN);

  15054   1 000673  BB80 0000 0000  02                   LAB,B3   0
          1 000676  CBF0 0100                            LAB,B4   256,IMO
          1 000678  E380 0000 0000  xent                 LNJ,B6   GHH$UNLOCK
          1 00067B       0001                            DC       s:15056,PREL

     1331    15056    1      RETURN;

  15056   1 00067C  C380 0000 0000  xent                 LNJ,B4   X6A_ARET

     1332    15057        %EJECT;
PL6.E3A0      #002=KNA$IN File=KNA$APE.:E05TSI                                   WED 07/30/97 00:57 Page:222  
     1333    15058    1   PROTOCOL_ERR: PROC;

  15058   1 00067F  EFC7 007E            PROTOCOL_ERR    STB,B6   NWIO+16,AUTO

     1334    15059
     1335    15060        /*N* ERROR LOG */
     1336    15061    2      RETURN;

  15061   1 000681  ECC7 007E                            LDB,B6   NWIO+16,AUTO
          1 000683  C3C6 0001                            LNJ,B4   1,B6
     1337    15062
     1338    15063    2   END PROTOCOL_ERR;
     1339    15064
     1340    15065    1   END KNA$IN;
     1341    15066        %EOD;

PL6.E3A0      #002=KNA$IN File=KNA$APE.:E05TSI                                   WED 07/30/97 00:57 Page:223  
--  Include file information  --

   K_SCODE_C.:E05TOU  is referenced.
   KV$VDO.:E05TOU  is referenced.
   K$RWPARM.:E05TOU  is referenced.
   KN_ERRORS_C.:E05TOU  is referenced.
   GM_VIRTUAL_E.:E05TOU  is referenced.
   GU_LCP6_M.:E05TOU  is referenced.
   GH_LCP6_M.:E05TOU  is referenced.
   GH_SCHD_E.:E05TOU  is referenced.
   GF_LCP6_M.:E05TOU  is referenced.
   KNA_MACRO_M.:E05TOU  is referenced.
   KI_SUBS_C.:E05TOU  is referenced.
   KI_ERRORS_C.:E05TOU  is referenced.
   K_ID_E.:E05TOU  is referenced.
   KL_MACRO_C.:E05TOU  is referenced.
   P_FEP_M.:E05TOU  is referenced.
   KNH_MACRO_C.:E05TOU  is referenced.
   KN_DATA_M.:E05TOU  is referenced.
   GH_SCHD_M.:E05TOU  is referenced.
   GH_GATE_M.:E05TOU  cannot be made into a system file and is referenced.
   G_LCP6_E.:E05TOU  is referenced.
   F_ERRORS_C.:E05TOU  is referenced.
      No diagnostics issued in procedure KNA$IN.
PL6.E3A0      #002=KNA$IN File=KNA$APE.:E05TSI                                   WED 07/30/97 00:57 Page:224  

 **** Variables and constants ****

  ****  Section 000 RoData KNA$IN

  ****  Scalars and arrays  ****
HexLoc.c.b A Datatyp(siz) R M Lvl/name                 HexLoc.c.b A Datatyp(siz) R M Lvl/name

     0-0-0/w STRC(32)    r     1 ECNCFAIL                   2-0-0/w STRC(32)    r     1 ELDSC
     9-0-0/w STRC(80)    r     1 NODAT_VDO                  6-0-0/w STRC(48)    r     1 SCR_UNEXP

  ****  Auto variables  ****

  ****  Scalars and arrays  ****
HexLoc.c.b A Datatyp(siz) R M Lvl/name                 HexLoc.c.b A Datatyp(siz) R M Lvl/name

     4-0-0/w PTR         r     1 @KN$NETPARM                6-0-0/w PTR         r     1 BFR$
    6C-0-0/w STRC(32)    r     1 COMIO                     11-0-0/w PTR         r     1 DATA$
    10-0-0/w UBIN(16)    r     1 DATAARS                    F-0-0/w UBIN(16)    r     1 DATASIZE
     8-0-0/w UBIN(16)    r     1 EVENT                      D-0-0/w PTR         r     1 IOP$
    1A-0-0/w STRC(656)   r     1 K$RWPARM                  *0-0-0/w STRC(528)   r     1 KN$NETPARM
    6E-0-0/w STRC(256)   r     1 NWIO                      43-0-0/w STRC(656)   r     1 OPARM
     B-0-0/w PTR         r     1 SSN$                      18-0-0/c CHAR(4)     r     1 STATE
    16-0-0/b BIT (32)    r     1 TCB_ERR

  ****  SYMREF variables  ****

  ****  Scalars and arrays  ****
HexLoc.c.b A Datatyp(siz) R M Lvl/name                 HexLoc.c.b A Datatyp(siz) R M Lvl/name

     0-0-0/w PTR         r     1 G$ASDT_MCL$                0-0-0/w PTR         r     1 G$USRT$
     0-0-0/w STRC(48)    r     1 KNA_LNKSSN                 0-0-0/w STRC(656)   r     1 KNA_RWPARM_CON
     0-0-0/w STRC(2208)  r     1 PS_LCP6STT

  ****  BASED and DCB variables  ****

  ****  Scalars and arrays  ****
HexLoc.c.b A Datatyp(siz) R M Lvl/name                 HexLoc.c.b A Datatyp(siz) R M Lvl/name
PL6.E3A0      #002=KNA$IN File=KNA$APE.:E05TSI                                   WED 07/30/97 00:57 Page:225  

     0-0-0/w UBIN(16)    r     1 CODE                       0-0-0/c ACHR        r     1 DATASTRING
     0-0-0/w STRC(384)   r     1 G$USER(0:0)                0-0-0/w STRC(432)   r     1 KN$IOP
     0-0-0/w STRC(256)   r     1 KN$LDCT                    0-0-0/w STRC(400)   r     1 KNA$SSN
     0-0-0/w STRC(16)    r     1 KV$VDOHDR                  0-0-0/w STRC(48)    r     1 KV$VDO_BLKDAT
     0-0-0/w STRC(32)    r     1 KV$VDO_EVT                 0-0-0/w STRC(80)    r     1 KV$VDO_RQSDAT
     0-0-0/w ASTR(808)   r     1 MYDCB


   Procedure KNA$IN requires 1669 words for executable code.
   Procedure KNA$IN requires 140 words of local(AUTO) storage.
PL6.E3A0      #002=KNA$IN File=KNA$APE.:E05TSI                                   WED 07/30/97 00:57 Page:226  
          *** CROSS REFERENCE LISTING ***
**     DENOTES     IDENTIFIER DEFINITION
<<                 IDENTIFIER'S VALUE SET
>>                 IDENTIFIER'S VALUE USED
<>                 IDENTIFIER SET AND/OR USED
--                 IDENTIFIER REFERENCED
PL6.E3A0      #002=KNA$IN File=KNA$APE.:E05TSI                                   WED 07/30/97 00:57 Page:227  
          MINI XREF LISTING

BFR$
     11201**DCL     14703<<ASSIGN  14704<>CALL    14720>>ASSIGN  14723<<ASSIGN  14724<>CALL    14739>>ASSIGN
CASE_FCN
     14628**LABEL   14679--EXIT    14697--EXIT    14817--EXIT
CHECK_MRKPND
     14936**LABEL   14911--GOTO    14920--GOTO
CODE
     11889**DCL     14640>>IF
COMIO
     11849**DCL     14870<<ASSIGN  14871--ASSIGN  14873<>CALL    14885<<ASSIGN  14886--ASSIGN  14888<>CALL
COMIO.ARS
     11851**DCL     14872<<ASSIGN  14887<<ASSIGN
COMIO.P#
     11849**DCL     14871<<ASSIGN  14871--ASSIGN  14886<<ASSIGN  14886--ASSIGN
DATA$
     11208**DCL     14710<<ASSIGN  14720>>ASSIGN  14730<<ASSIGN  14739>>ASSIGN  14895<<ASSIGN  14898>>CALL
DATAARS
     11207**DCL     14718<<ASSIGN  14752>>ASSIGN  14754>>ASSIGN  14756>>ASSIGN  14758>>ASSIGN  14760>>ASSIGN
     14787>>ASSIGN
DATASIZE
     11206**DCL     11901--IMP-SIZ 14711<<ASSIGN  14713>>IF      14715<<ASSIGN  14718>>ASSIGN  14720>>ASSIGN
     14720>>ASSIGN  14731<<ASSIGN  14733>>IF      14735<<ASSIGN  14739>>ASSIGN  14739>>ASSIGN  14894<<ASSIGN
     14898>>CALL
DATASTRING
     11901**DCL     14720<<ASSIGN  14720>>ASSIGN  14739<<ASSIGN  14739>>ASSIGN  14898<>CALL
ECNCFAIL
     13404**DCL     14642>>ASSIGN
ELDSC
     13451**DCL     14918>>ASSIGN  14926>>ASSIGN  14930>>ASSIGN  15033>>ASSIGN
EVENT
     11202**DCL     14793<<ASSIGN  14794<>CALL
G$ASDT_MCL$
PL6.E3A0      #002=KNA$IN File=KNA$APE.:E05TSI                                   WED 07/30/97 00:57 Page:228  
     11884**DCL     12377--IMP-PTR
G$USER.FLG
     11895**DCL     14780>>IF      14972>>IF      15036>>IF
G$USER.MISC
     11896**DCL     11896--REDEF
G$USER.MISC$
     11896**DCL     15036>>IF
G$USRT$
     11886**DCL     11895--IMP-PTR 14780>>IF      14972>>IF      15036>>IF      15036>>IF
GHH$LOCK
       588**DCL-ENT 14623--CALL
GHH$UNLOCK
       588**DCL-ENT 14833--CALL    14861--CALL    15054--CALL
GHQ$STATE
     13785**DCL-ENT 14962--CALL
GHS$EVENT
     13781**DCL-ENT 14794--CALL    14873--CALL    14888--CALL
GHS$RUE
     13786**DCL-ENT 14654--CALL    14781--CALL    14847--CALL    14908--CALL    14910--CALL    14916--CALL
     14925--CALL    14982--CALL    15024--CALL    15032--CALL    15039--CALL    15043--CALL
GJU$EVENT
     13787**DCL-ENT 14898--CALL
IOP$
     11205**DCL     12199--IMP-PTR 14668<<ASSIGN  14669<<ASSIGN  14671>>IF      14673>>ASSIGN  14674>>ASSIGN
     14694>>IF      14702>>ASSIGN  14703>>ASSIGN  14704>>CALL    14713>>IF      14715>>ASSIGN  14716>>ASSIGN
     14721>>IF      14723>>ASSIGN  14724>>CALL    14733>>IF      14735>>ASSIGN  14736>>ASSIGN  14745>>CALL
     14745>>CALL    14750>>DOCASE  14760>>ASSIGN  14761>>ASSIGN  14761>>ASSIGN  14763>>ASSIGN  14764>>ASSIGN
     14765>>ASSIGN  14766>>ASSIGN  14767>>IF      14769>>ASSIGN  14770>>ASSIGN  14771>>ASSIGN  14778>>IF
     14786>>ASSIGN  14793>>ASSIGN  14931<<ASSIGN  14975<<ASSIGN  14976>>IF      14978>>ASSIGN  14979>>ASSIGN
     14980>>ASSIGN
K$RWPARM
     11230**DCL     14663<<ASSIGN  14676<>CALL    14965<>CALL
K$RWPARM.ACTPOS
     11520**DCL     14765>>ASSIGN
K$RWPARM.BLKREC
     11260**DCL     11285--REDEF   15005>>ASSIGN
PL6.E3A0      #002=KNA$IN File=KNA$APE.:E05TSI                                   WED 07/30/97 00:57 Page:229  
K$RWPARM.DVE.DVBYTE
     11292**DCL     14766>>ASSIGN  14788>>ASSIGN
K$RWPARM.DVE.DVBYTE.VFC
     11300**DCL     11301--REDEF
K$RWPARM.DVE.EOMCHAR
     11308**DCL     11312--REDEF   14763>>ASSIGN  14789>>ASSIGN
K$RWPARM.EOM_EOR
     11329**DCL     14762>>IF
K$RWPARM.ERR
     11372**DCL     11377--REDEF
K$RWPARM.FC
     11336**DCL     11337--REDEF
K$RWPARM.FLDID
     11518**DCL     11519--REDEF   14769>>ASSIGN  14980>>ASSIGN
K$RWPARM.KEY$
     11516**DCL     14730>>ASSIGN
K$RWPARM.KEYSZ
     11527**DCL     14731>>ASSIGN
K$RWPARM.KEYTYPE
     11525**DCL     11526--REDEF   14673<<ASSIGN
K$RWPARM.MARKER
     11285**DCL     14954>>ASSIGN  15009>>ASSIGN
K$RWPARM.MRKTYP
     11510**DCL     14941>>IF      14958<<ASSIGN  14986<<ASSIGN  14993>>IF      14996>>ASSIGN  14998>>DOCASE
K$RWPARM.MSG$
     11231**DCL     11232--REDEF   11241--REDEF   14963<<ASSIGN
K$RWPARM.MSGC$
     11232**DCL     14710>>ASSIGN  14895>>ASSIGN
K$RWPARM.MSGID
     11347**DCL     11352--REDEF   14792>>ASSIGN  14979>>ASSIGN
K$RWPARM.MSGIDXT
     11360**DCL     11364--REDEF
K$RWPARM.MSGSZ
     11242**DCL     14711>>ASSIGN  14894>>ASSIGN  14964<<ASSIGN
K$RWPARM.MSGTYP
     11251**DCL     14771>>ASSIGN  14791>>ASSIGN
PL6.E3A0      #002=KNA$IN File=KNA$APE.:E05TSI                                   WED 07/30/97 00:57 Page:230  
K$RWPARM.MSG_ERRCODE
     11495**DCL     14770>>ASSIGN  14978>>ASSIGN
K$RWPARM.ORG
     11496**DCL     11497--REDEF
K$RWPARM.READMLT
     11320**DCL     14674<<ASSIGN
K$RWPARM.STATION
     11246**DCL     14790>>ASSIGN
K$RWPARM.STR
     11511**DCL     14867>>IF      14867>>IF      14867>>IF      14882>>IF      14882>>IF      14882>>IF
K$RWPARM.UHDR$
     11385**DCL     14664<<ASSIGN
K$RWPARM.UHDRSZ
     11390**DCL     14665<<ASSIGN
K$RWPARM.VDOFLGS
     11498**DCL     11509--REDEF
KN$IOP.ARS
     12255**DCL     12256--REDEF   12257--REDEF
KN$IOP.BUFSEGDES
     12307**DCL     14704<>CALL
KN$IOP.BUF_
     12270**DCL     14703>>ASSIGN  14713>>IF      14715>>ASSIGN
KN$IOP.DCB$
     12283**DCL     14745<>CALL    14750>>DOCASE  14760>>ASSIGN  14761>>ASSIGN  14763>>ASSIGN  14764>>ASSIGN
     14765>>ASSIGN  14766>>ASSIGN  14767>>IF      14769>>ASSIGN
KN$IOP.DCBSEGDES
     12351**DCL     14745<>CALL
KN$IOP.ERRCODE
     12217**DCL     14770<<ASSIGN  14786>>ASSIGN  14930<<ASSIGN  14978<<ASSIGN
KN$IOP.EVENT
     12369**DCL     14793>>ASSIGN
KN$IOP.FLAGS.RDDONE
     12264**DCL     14702<<ASSIGN  14927>>IF
KN$IOP.FLAGS.READMLT
     12266**DCL     14674>>ASSIGN
KN$IOP.FLAGS.TRUNC
PL6.E3A0      #002=KNA$IN File=KNA$APE.:E05TSI                                   WED 07/30/97 00:57 Page:231  
     12262**DCL     14716<<ASSIGN  14736<<ASSIGN  14761>>ASSIGN
KN$IOP.FLAGS.WAIT
     12263**DCL     14778>>IF
KN$IOP.FLDID
     12257**DCL     14980<<ASSIGN
KN$IOP.KEYSEGDES
     12329**DCL     14724<>CALL
KN$IOP.KEYTYPE
     12256**DCL     14673>>ASSIGN
KN$IOP.KEY_
     12277**DCL     14721>>IF      14723>>ASSIGN  14733>>IF      14735>>ASSIGN
KN$IOP.LNK$
     12285**DCL     12286--REDEF
KN$IOP.MSGID
     12284**DCL     14979<<ASSIGN
KN$IOP.MSGTYPE
     12368**DCL     14771<<ASSIGN
KN$LDCT.RLCID.LDCTX
     12029**DCL     12036--REDEF   12044--REDEF
KN$LDCT.TRANSPORT_ID
     12063**DCL     12071--REDEF
KN$LDCT.UID
     12093**DCL     12094--REDEF   12103--REDEF
KN$LDCT.UID$
     12094**DCL     14626>>ASSIGN
KN$LDCT.USER#
     12186**DCL     14962<>CALL
KN$NETPARM
     11059**DCL        48--PROC    14816<>CALL
KN$NETPARM.ERRCODE
     11166**DCL     14853<>CALL    14949<>CALL    14965<>CALL    15013<>CALL
KN$NETPARM.FPT$
     11178**DCL     11889--IMP-PTR 14640>>IF
KN$NETPARM.FUNCTION
     11154**DCL     14617>>IF      14628>>DOCASE  14815<<ASSIGN
KN$NETPARM.LDCT$
PL6.E3A0      #002=KNA$IN File=KNA$APE.:E05TSI                                   WED 07/30/97 00:57 Page:232  
     11060**DCL     11968--IMP-PTR 14626>>ASSIGN  14962>>CALL
KN$NETPARM.MSG$
     11066**DCL     11071--REDEF
KN$NETPARM.NHDR$
     11118**DCL     11119--REDEF
KN$NETPARM.SHDR$
     11096**DCL     11097--REDEF
KN$NETPARM.THDR$
     11107**DCL     11108--REDEF
KN$NETPARM.UHDR$
     11082**DCL     11083--REDEF   13248--IMP-PTR 13288--IMP-PTR 14664>>ASSIGN  14667>>IF      14682>>DOCASE
     14749>>IF      14809>>IF      14813<<ASSIGN  14819>>IF      14821>>ASSIGN  14823>>ASSIGN  14824>>IF
     14837>>ASSIGN  14840>>ASSIGN  14841>>ASSIGN  14842>>ASSIGN  14872>>ASSIGN  14887>>ASSIGN  14892>>IF
     14905>>IF      14905>>IF      15015>>ASSIGN
KN$NETPARM.UHDRSZ
     11091**DCL     14665>>ASSIGN  14814<<ASSIGN
KNA$DECODE_VDO
     13789**DCL-ENT 14676--CALL
KNA$FCNO
     13779**DCL-ENT 14853--CALL    14949--CALL    14965--CALL    15013--CALL
KNA$MAP
     13780**DCL-ENT 14704--CALL    14724--CALL    14745--CALL
KNA$RLSIOP
     13782**DCL-ENT 14795--CALL
KNA$SSN
     13078**DCL     14853<>CALL    14949<>CALL    14965<>CALL    15013<>CALL
KNA$SSN.BLKREC
     13145**DCL     15001>>ASSIGN  15005<<ASSIGN
KNA$SSN.ERROR
     13104**DCL     14642<<ASSIGN  14918<<ASSIGN  14926<<ASSIGN  15033<<ASSIGN
KNA$SSN.EVENT
     13146**DCL     14867>>IF      14873<>CALL    14882>>IF      14888<>CALL
KNA$SSN.FLAGS.BLOCKED
     13082**DCL     14809>>IF      14826>>IF      14844>>IF      14848<<ASSIGN
KNA$SSN.FLAGS.CQ
     13082**DCL     15022>>IF      15025<<ASSIGN
PL6.E3A0      #002=KNA$IN File=KNA$APE.:E05TSI                                   WED 07/30/97 00:57 Page:233  
KNA$SSN.FLAGS.MRKPND
     13086**DCL     14944>>IF      14955<<ASSIGN
KNA$SSN.FLAGS.MULT_STR
     13082**DCL     14801<<ASSIGN  14867>>IF      14882>>IF
KNA$SSN.FLAGS.PRIMARY
     13082**DCL     15030>>IF
KNA$SSN.FLAGS.REGGED
     13082**DCL     14809>>IF      14826>>IF      14844>>IF      14972>>IF      15026<<ASSIGN
KNA$SSN.FLAGS.RRRPND
     13082**DCL     14972>>IF      14983<<ASSIGN
KNA$SSN.FLAGS.SSNERR
     13082**DCL     14643<<ASSIGN  14919<<ASSIGN  15034<<ASSIGN
KNA$SSN.IOPQ$
     13140**DCL     14669>>ASSIGN  14975>>ASSIGN
KNA$SSN.IOPRD$
     13140**DCL     13140--REDEF   14668>>ASSIGN  14795<>CALL    14796<<ASSIGN  14927>>IF      14927>>IF
     14930>>ASSIGN  14931>>ASSIGN
KNA$SSN.LDCT$
     13137**DCL     15036>>IF
KNA$SSN.MARKER
     13146**DCL     14947>>ASSIGN  14954<<ASSIGN
KNA$SSN.RLCID.NODE#
     13144**DCL     13144--REDEF
KNA$SSN.STATE
     13145**DCL     14637>>IF      14653<<ASSIGN  14809>>IF      14903>>IF      14914>>IF      14917<<ASSIGN
     14924<<ASSIGN  15035<<ASSIGN
KNA$SSN.THRTLVL.MAXNMBBYT
     13137**DCL     14837<<ASSIGN  14837>>ASSIGN  14840<<ASSIGN  14850>>IF
KNA$SSN.THRTLVL.MAXNMBRCR
     13137**DCL     14821<<ASSIGN  14821>>ASSIGN  14823<<ASSIGN  14850>>IF
KNA$SSN.THRTLVL.MAXRCRBYTSIZ
     13138**DCL     14841<<ASSIGN
KNA$SSN.THRTLVL.STR
     13138**DCL     14842<<ASSIGN
KNA$SSN.USER#
     13145**DCL     14654<>CALL    14780>>IF      14781<>CALL    14794<>CALL    14847<>CALL    14873<>CALL
PL6.E3A0      #002=KNA$IN File=KNA$APE.:E05TSI                                   WED 07/30/97 00:57 Page:234  
     14888<>CALL    14898<>CALL    14908<>CALL    14910<>CALL    14916<>CALL    14925<>CALL    14972>>IF
     14982<>CALL    15024<>CALL    15032<>CALL    15036>>IF      15036>>IF      15039<>CALL    15043<>CALL
KNA_LNKSSN
     13769**DCL     14623<>CALL    14833<>CALL    14861<>CALL    15054<>CALL
KNA_RWPARM_CON
     13809**DCL     14663>>ASSIGN  14852>>ASSIGN  14946>>ASSIGN  14995>>ASSIGN
KNA_RWPARM_CON.BLKREC
     13839**DCL     13864--REDEF
KNA_RWPARM_CON.DVE.DVBYTE.VFC
     13879**DCL     13880--REDEF
KNA_RWPARM_CON.DVE.EOMCHAR
     13887**DCL     13891--REDEF
KNA_RWPARM_CON.ERR
     13951**DCL     13956--REDEF
KNA_RWPARM_CON.FC
     13915**DCL     13916--REDEF
KNA_RWPARM_CON.FLDID
     14097**DCL     14098--REDEF
KNA_RWPARM_CON.KEYTYPE
     14104**DCL     14105--REDEF
KNA_RWPARM_CON.MSG$
     13810**DCL     13811--REDEF   13820--REDEF
KNA_RWPARM_CON.MSGID
     13926**DCL     13931--REDEF
KNA_RWPARM_CON.MSGIDXT
     13939**DCL     13943--REDEF
KNA_RWPARM_CON.ORG
     14075**DCL     14076--REDEF
KNA_RWPARM_CON.VDOFLGS
     14077**DCL     14088--REDEF
KNS$SEND
     13788**DCL-ENT 14816--CALL
KV$VDOHDR.FNC
     13252**DCL     14667>>IF      14682>>DOCASE  14749>>IF      15015<<ASSIGN
KV$VDOHDR.STR
     13252**DCL     14892>>IF
PL6.E3A0      #002=KNA$IN File=KNA$APE.:E05TSI                                   WED 07/30/97 00:57 Page:235  
KV$VDO_BLKDAT.RCRBYTSIZ
     13385**DCL     14887>>ASSIGN
KV$VDO_EVT.BRKCNT
     13295**DCL     14905>>IF
KV$VDO_EVT.TYP
     13295**DCL     14905>>IF
KV$VDO_RQSDAT.EOFNO_DAT
     13341**DCL     14809>>IF
KV$VDO_RQSDAT.INCMAXNMBBYT
     13339**DCL     14824>>IF
KV$VDO_RQSDAT.INCMAXNMBRCR
     13339**DCL     14819>>IF
KV$VDO_RQSDAT.MAXNMBBYT
     13338**DCL     14837>>ASSIGN  14840>>ASSIGN  14872>>ASSIGN
KV$VDO_RQSDAT.MAXNMBRCR
     13337**DCL     14821>>ASSIGN  14823>>ASSIGN
KV$VDO_RQSDAT.MAXRCRBYTSIZ
     13337**DCL     14841>>ASSIGN
KV$VDO_RQSDAT.STR
     13334**DCL     14842>>ASSIGN
MYDCB.ACTPOS
     11945**DCL     14765<<ASSIGN
MYDCB.ARS
     11926**DCL     14760<<ASSIGN
MYDCB.DCBNAME.L
     11949**DCL     11949--IMP-SIZ
MYDCB.DDEV.RES
     11932**DCL     14750>>DOCASE
MYDCB.DVBYTE
     11927**DCL     14766<<ASSIGN
MYDCB.EOMCHAR
     11940**DCL     11940--REDEF   11941--REDEF   14763<<ASSIGN  14764<<ASSIGN
MYDCB.FLDID
     11939**DCL     11939--REDEF   14769<<ASSIGN
MYDCB.ORG
     11937**DCL     14767>>IF
PL6.E3A0      #002=KNA$IN File=KNA$APE.:E05TSI                                   WED 07/30/97 00:57 Page:236  
MYDCB.RES
     11934**DCL     11935--REDEF
MYDCB.TYC.LD#
     11926**DCL     14761<<ASSIGN
NODAT_VDO
     13626**DCL     14813--ASSIGN  14814--ASSIGN
NO_MARKER
     15009**LABEL   15006--GOTO
NWIO
     11857**DCL     14784<<ASSIGN  14785--ASSIGN  14794<>CALL
NWIO.ARS
     11859**DCL     14787<<ASSIGN
NWIO.CGPARM.MSGID#
     11878**DCL     14792<<ASSIGN
NWIO.CGPARM.MSGTYP#
     11877**DCL     14791<<ASSIGN
NWIO.CGPARM.STATION#
     11877**DCL     14790<<ASSIGN
NWIO.DVE.DVBYTE
     11859**DCL     14788<<ASSIGN
NWIO.DVE.EOMCHAR
     11859**DCL     14789<<ASSIGN
NWIO.P#
     11857**DCL     14785<<ASSIGN  14785--ASSIGN
OPARM
     11546**DCL     14852<<ASSIGN  14853<>CALL    14946<<ASSIGN  14949<>CALL    14995<<ASSIGN  15013<>CALL
OPARM.BLKREC
     11576**DCL     11601--REDEF   15001<<ASSIGN
OPARM.DVE.DVBYTE.VFC
     11616**DCL     11617--REDEF
OPARM.DVE.EOMCHAR
     11624**DCL     11628--REDEF
OPARM.ERR
     11688**DCL     11693--REDEF
OPARM.FC
     11652**DCL     11653--REDEF
PL6.E3A0      #002=KNA$IN File=KNA$APE.:E05TSI                                   WED 07/30/97 00:57 Page:237  
OPARM.FLDID
     11834**DCL     11835--REDEF
OPARM.KEYTYPE
     11841**DCL     11842--REDEF
OPARM.MARKER
     11601**DCL     14947<<ASSIGN  15009<<ASSIGN
OPARM.MRKTYP
     11826**DCL     14948<<ASSIGN  14996<<ASSIGN  15002<<ASSIGN
OPARM.MSG$
     11547**DCL     11548--REDEF   11557--REDEF
OPARM.MSGID
     11663**DCL     11668--REDEF
OPARM.MSGIDXT
     11676**DCL     11680--REDEF
OPARM.ORG
     11812**DCL     11813--REDEF
OPARM.VDOFLGS
     11814**DCL     11825--REDEF
PROTOCOL_ERR
     15058**PROC    14678--CALL    14696--CALL    14990--CALL
PS_LCP6STT.BYTES_READ_HOST
     14519**DCL     14752<<ASSIGN  14752>>ASSIGN
PS_LCP6STT.BYTES_READ_LG
     14529**DCL     14756<<ASSIGN  14756>>ASSIGN
PS_LCP6STT.BYTES_READ_NA
     14534**DCL     14758<<ASSIGN  14758>>ASSIGN
PS_LCP6STT.BYTES_READ_UC
     14524**DCL     14754<<ASSIGN  14754>>ASSIGN
PS_LCP6STT.REQSTATS.DSPMSK
     14374**DCL     14380--REDEF
PS_LCP6STT.REQSTATS.SLCMSK
     14415**DCL     14422--REDEF
READ_COMP
     14771**LABEL   14932--GOTO
SCREECH
     13783**DCL-ENT 14638--CALL    15047--CALL
PL6.E3A0      #002=KNA$IN File=KNA$APE.:E05TSI                                   WED 07/30/97 00:57 Page:238  
SCR_UNEXP
     13558**DCL     14638<>CALL    15047<>CALL
SSN$
     11204**DCL     13078--IMP-PTR 14626<<ASSIGN  14637>>IF      14642>>ASSIGN  14643>>ASSIGN  14653>>ASSIGN
     14654>>CALL    14668>>ASSIGN  14669>>ASSIGN  14780>>IF      14781>>CALL    14794>>CALL    14795>>CALL
     14796>>ASSIGN  14801>>ASSIGN  14809>>IF      14809>>IF      14809>>IF      14821>>ASSIGN  14821>>ASSIGN
     14823>>ASSIGN  14826>>IF      14826>>IF      14837>>ASSIGN  14837>>ASSIGN  14840>>ASSIGN  14841>>ASSIGN
     14842>>ASSIGN  14844>>IF      14844>>IF      14847>>CALL    14848>>ASSIGN  14850>>IF      14850>>IF
     14853>>CALL    14867>>IF      14867>>IF      14873>>CALL    14873>>CALL    14882>>IF      14882>>IF
     14888>>CALL    14888>>CALL    14898>>CALL    14903>>IF      14908>>CALL    14910>>CALL    14914>>IF
     14916>>CALL    14917>>ASSIGN  14918>>ASSIGN  14919>>ASSIGN  14924>>ASSIGN  14925>>CALL    14926>>ASSIGN
     14927>>IF      14927>>IF      14930>>ASSIGN  14931>>ASSIGN  14944>>IF      14947>>ASSIGN  14949>>CALL
     14954>>ASSIGN  14955>>ASSIGN  14965>>CALL    14972>>IF      14972>>IF      14972>>IF      14975>>ASSIGN
     14982>>CALL    14983>>ASSIGN  15001>>ASSIGN  15005>>ASSIGN  15013>>CALL    15022>>IF      15024>>CALL
     15025>>ASSIGN  15026>>ASSIGN  15030>>IF      15032>>CALL    15033>>ASSIGN  15034>>ASSIGN  15035>>ASSIGN
     15036>>IF      15036>>IF      15036>>IF      15039>>CALL    15043>>CALL
STATE
     11212**DCL     14962<>CALL    14963--ASSIGN  14964--ASSIGN
TCB_ERR
     11211**DCL     14786<<ASSIGN  14794<>CALL
UNLK_N_ALTRET
     14848**LABEL   14816--CALLALT 14949--CALLALT 14965--CALLALT 15016--GOTO

PL6.E3A0      #003=KNA$USERIO File=KNA$APE.:E05TSI                               WED 07/30/97 00:58 Page:239  
     1342        1        /*T***********************************************************/
     1343        2        /*T*                                                         */
     1344        3        /*T* Copyright (c) Bull HN Information Systems Inc., 1997    */
     1345        4        /*T*                                                         */
     1346        5        /*T***********************************************************/
     1347        6        /*F*
     1348        7           NAME: KNA$USERIO
     1349        8           PURPOSE:
     1350        9                  This routine handles M$READ/WRITE on behalf of network
     1351       10             connections.
     1352       11           DESCRIPTION:
     1353       12                  This routine takes an application program's M$READ or M$WRITE
     1354       13             and does the proper Presentation Protocol.  A message specifying
     1355       14             a request for data (M$READ) or the data itself (M$WRITE) is sent
     1356       15             via a connection established with the monitor Session layer.
     1357       16        */
     1358       17        /*D*
     1359       18           NAME: KNA$USERIO
     1360       19             This routine handles M$READ/WRITE on behalf of the user.
     1361       20
     1362       21           ENTRY: KNA$READ
     1363       22             Provides an internal interface for the monitor to issue M$READ.
     1364       23
     1365       24           ENTRY: KNA$WRITE
     1366       25             Provides an internal interface for the monitor to issue M$WRITE.
     1367       26
     1368       27           ENTRY: KNA$WRITE_NOW
     1369       28             Provides an internal interface for the monitor to issue M$WRITE
     1370       29             which doesn't do flow control.
     1371       30
     1372       31           CALL:  CALL KNA$routine(DCBNUMBER,UBUF$,ERROR,KNA_PARAMS) ALTRET;
     1373       32
     1374       33                  This routine altreturns if an error is encountered.
     1375       34           PARAMETERS:
     1376       35                  DCBNUMBER - DCB number for the DCB on the M$READ/WRITE
     1377       36                  UBUF$ - User buffer address pulled from the FPT
     1378       37                  ERROR - Error code to be returned
PL6.E3A0      #003=KNA$USERIO File=KNA$APE.:E05TSI                               WED 07/30/97 00:58 Page:240  
     1379       38                  KNA_PARAMS - Structure passed by GFM$MCL for MCL info.
     1380       39                               This parameter is only used by KNA$USERIO.
     1381       40           INTERFACE:
     1382       41                  KNS$SESSION - To send messages on the network
     1383       42                  KNA$GETIOP - To get an I/O packet
     1384       43                  KNA$RLSIOP - To release an I/O packet
     1385       44                  GHS$REGUSER - REG a user on wait I/O situations
     1386       45                  KNA$OPEN - For a default OPEN on the passed DCB
     1387       46           ENVIRONMENT:
     1388       47             The KNA$USERIO routine is called from GFM$MCL, the MCL handler for
     1389       48             file management MCLs.  All the FPT parameters are available to
     1390       49             us in a structure.
     1391       50
     1392       51             The other entry points are called from any where in the monitor running
     1393       52             on behalf of a REGable user.  The DCB passed must be set up the
     1394       53             way that the monitor wishes.  The current use of these routines
     1395       54             is by job step to downline load fprgs and report an fprg
     1396       55             exit/abort condition.
     1397       56
     1398       57           DESCRIPTION:
     1399       58                  Entry from GFM$MCL results in all the user's FPT information
     1400       59             being stored away in AUTO.  Next (or if entry was not from GFM$MCL)
     1401       60             the DCB number passed is validated and a check is made to see if
     1402       61             we have to do a default OPEN.  The user's parameters are checked
     1403       62             to see if we have everything we need to do this operation, such
     1404       63             as keys, buffer, etc.  If this check succeeds then we do either
     1405       64             a READ or a WRITE.
     1406       65
     1407       66                  A WRITE operation causes us to make sure that the other
     1408       67             end of the network connection has given us throttling information
     1409       68             to allow us to send him the specified data.  If not, the user is
     1410       69             REGged until such time as that is the case.  The user's data is
     1411       70             merely passed along via a call to KNS$SESSION if we already have
     1412       71             enough throttling permission to send the data.
     1413       72
     1414       73                  A WRITENOW operation doesn't do flow control and causes a
     1415       74             Presentation function code to be put on the message which
PL6.E3A0      #003=KNA$USERIO File=KNA$APE.:E05TSI                               WED 07/30/97 00:58 Page:241  
     1416       75             directs this message to the other monitor (host).
     1417       76
     1418       77                  A READ operation causes the allocation of an IO packet for
     1419       78             keeping track of the user's buffer.  A message is sent via
     1420       79             Session to tell the guy at the other end of the network connection
     1421       80             that he can send some stuff over.  After this message is sent the
     1422       81             user is REGged until his data arrives.
     1423       82        */
     1424       83        %EJECT;
PL6.E3A0      #003=KNA$USERIO File=KNA$APE.:E05TSI                               WED 07/30/97 00:58 Page:242  
     1425       84        KNA$USERIO: PROC(DCBNUMBER,UBUF$,ERROR,KNA_PARAMS) ALTRET;
     1426       85        %INCLUDE KNA_MACRO_M;
     1427      161        %INCLUDE KN_ERRORS_C;
     1428      225        %INCLUDE KI_ERRORS_C;
     1429      310        %INCLUDE KI_SUBS_C;
     1430      446        %INCLUDE GH_LCP6_M;
     1431     1280        %INCLUDE GH_SCHD_E;
     1432     1376        %INCLUDE GH_SCHD_M;
     1433     1520        %INCLUDE G_HJIT_M;
     1434     1665        %INCLUDE G_ROS_M;
     1435     1747        %INCLUDE G_JIT_M;
     1436     2012        %INCLUDE GH_GATE_M;
     1437     2053        %INCLUDE KN_DATA_M;
     1438     3839        %INCLUDE K_SCODE_C;
     1439     3924        %INCLUDE P_FEP_M;
     1440     4362        %INCLUDE KL_MACRO_C;
     1441     7714        %INCLUDE K_ID_E;
     1442     7764        %K#ENTID_E;
     1443     7783        %INCLUDE GU_LCP6_M;
     1444     8711        %INCLUDE GU_MACROS_M;
     1445     8870        %INCLUDE GF_LCP6_M;
     1446     9338        %INCLUDE G_LCP6_E;
     1447     9596        %GF_MCL_E;                              /* Get the MCL EQUs                   */
     1448     9606        %INCLUDE F_ERRORS_C;
     1449     9846        %INCLUDE UD_ERRORS_C;
     1450     9888        %INCLUDE GM_VIRTUAL_E;
     1451    10098        %INCLUDE KV$VDO;
     1452    11113        %INCLUDE K$RWPARM;
     1453    11499        /* We involke this so the VDH macros work */
     1454    11500        %KV_VDO_ALL_E;
     1455    11579
     1456    11580        /*     Parameters
     1457    11581        */
     1458    11582    1   DCL DCBNUMBER UBIN;
     1459    11583    1   DCL UBUF$ VECTOR;
     1460    11584        %VLP_ERRCODE (FPTN=ERROR,STCLASS="");
     1461    11630        %GUD_HAND_PARAMS (FPTN=KNA_PARAMS,STCLASS="");
PL6.E3A0      #003=KNA$USERIO File=KNA$APE.:E05TSI                               WED 07/30/97 00:58 Page:243  
     1462    11706
     1463    11707        /*     Static storage
     1464    11708        */
     1465    11709        %VLP_ERRCODE (STCLASS=CONSTANT, FCG=KN, MID=A, MON='1'B,
     1466    11710                      FPTN=ENWIO, ERR#=%E$NWIO, SEV=G_SEV_ERROR#);
     1467    11756        %VLP_ERRCODE (STCLASS=CONSTANT, FCG=KN, MID=A, MON='1'B,
     1468    11757                      FPTN=EDCBNUM, ERR#=%E$BADDCB#, SEV=G_SEV_ERROR#);
     1469    11803        %VLP_ERRCODE (STCLASS=CONSTANT, FCG=KN, MID=A, MON='1'B,
     1470    11804                      FPTN=EBADBUF, ERR#=%E$BADVECT2, SEV=G_SEV_ERROR#);
     1471    11850        %VLP_ERRCODE (STCLASS=CONSTANT, FCG=KN, MID=A, MON='1'B,
     1472    11851                      FPTN=ENO_IOP, ERR#=%E$NO_IOP, SEV=G_SEV_ERROR#);
     1473    11897        %VLP_ERRCODE (STCLASS=CONSTANT, FCG=KN, MID=A, MON='1'B,
     1474    11898                      FPTN=ESHORT_BUFFER, ERR#=%E$LD, SEV=G_SEV_CONT#);
     1475    11944        %VLP_ERRCODE (STCLASS=CONSTANT, FCG=KN, MID=A, MON='1'B,
     1476    11945                      FPTN=ENO_DAT, ERR#=%E$NODAT, SEV=G_SEV_CONT#);
     1477    11991        %VLP_ERRCODE (STCLASS=CONSTANT, FCG=KN, MID=A, MON='1'B,
     1478    11992                      FPTN=EBYD, ERR#=%E$BYD, SEV=G_SEV_CONT#);
     1479    12038        %VLP_ERRCODE (STCLASS=CONSTANT, FCG=KN, MID=A, MON='1'B,
     1480    12039                      FPTN=ELDSC, ERR#=%E$LDSC, SEV=G_SEV_ABORT#);
     1481    12085        %VLP_ERRCODE (STCLASS=CONSTANT, FCG=KN, MID=A, MON='1'B,
     1482    12086                      FPTN=EXTRA_READ, ERR#=%E$XTRARD, SEV=G_SEV_CONT#);
     1483    12132        %VLP_SCODE (FPTN=SC_IOP,ERR#=%S$IOP,SEV=G_SEV_SCREECH#,
     1484    12133                    STCLASS=CONSTANT,FCG=KN,MID=A,MON='1'B);
     1485    12194
     1486    12195        /*     AUTO storage
     1487    12196        */
     1488    12197    1   DCL MSGSIZE UBIN;
     1489    12198    1   DCL RESTYPE UBIN;
     1490    12199    1   DCL STR UBIN;                           /* Stream number                      */
     1491    12200    1   DCL PARMSPEC BIT(1);
     1492    12201    1   DCL USRFPT$ PTR;
     1493    12202    1   DCL KEY$ PTR;
     1494    12203    1   DCL KEYSZ UBIN;
     1495    12204    1   DCL LSTIOP$ PTR;
     1496    12205    1   DCL FPT_BUF$ VECTOR;
     1497    12206    1   DCL FPT_CODE UBIN;
     1498    12207    1   DCL DCB$ PTR;
PL6.E3A0      #003=KNA$USERIO File=KNA$APE.:E05TSI                               WED 07/30/97 00:58 Page:244  
     1499    12208    1   DCL SSN$ PTR;
     1500    12209    1   DCL IOP$ PTR;
     1501    12210    1   DCL ASDT_INDEX UBIN;
     1502    12211    1   DCL EVENT UBIN;
     1503    12212    1   DCL 1 TEMP,
     1504    12213    1         2 BYTE_OFF    BIT(1),
     1505    12214    1         2 *           BIT(11),
     1506    12215    1         2 V_WRD_ADDR  UBIN(20) UNAL;
     1507    12216    1   DCL TEMP_CPTR REDEF TEMP CPTR;
     1508    12217    1   DCL VA_ADDR UBIN(32);
     1509    12218    1   DCL FLOW_CONTROL BIT(1);
     1510    12219        %K$RWPARM (NAME=K$RWPARM,STCLASS=AUTO);
     1511    12535        %G$NWIO (FPTN=NWIO,STCLASS=AUTO,PARONLY=1);
     1512    12564    1   DCL ERR UBIN;
     1513    12565    1   DCL TCB_ERR BIT(32);
     1514    12566    1   DCL I SBIN;
     1515    12567    1   DCL FCN UBIN;
     1516    12568    1   DCL ROUTINE EPTR;
     1517    12569        %EJECT;
PL6.E3A0      #003=KNA$USERIO File=KNA$APE.:E05TSI                               WED 07/30/97 00:58 Page:245  
     1518    12570
     1519    12571        /*     BASED
     1520    12572        */
     1521    12573        %G$JIT (STCLASS="BASED(G$JIT$)");
     1522    12987        %M$DCB (DCBN=MYDCB,STCLASS="BASED(DCB$)");
     1523    13038        %G$ROS (FPTN=G$ROS,STCLASS="BASED(G$ROS$)");
     1524    13082        %G$UHJIT (FPTN=G$UHJIT,STCLASS="BASED(G$UHJIT$)");
     1525    16056        %G$MHJIT (FPTN=G$MHJIT,STCLASS="BASED(G$MHJIT$)");
     1526    22930        %G$ECCB(STCLASS=BASED);
     1527    23006        %KNA$SSN (FPTN=KNA$SSN,STCLASS="BASED(SSN$)");
     1528    23089        %G$USER (FPTN=G$U,STCLASS=BASED);
     1529    23100        %G$ASDT;
     1530    23129        %G$DCBTABLE;
     1531    23140        %KN$IOP (NAME=KN$IOP,STCLASS="BASED(IOP$)");
     1532    23313        %G$ASDT_MCL (STCLASS="BASED(G$ASDT_MCL$)");
     1533    24007        %FPT_READ(VECTORS=NO,STCLASS="BASED(USRFPT$)");
     1534    24033        %FPT_WRITE(VECTORS=NO,STCLASS="BASED(USRFPT$)");
     1535    24057    1   DCL B$WORD UBIN BASED ALIGNED;
     1536    24058        %VLP_CG (STCLASS=BASED);
     1537    24078    1   DCL VFC CHAR(1) BASED UNAL;
     1538    24079
     1539    24080        /*     Useful External Pointers and Symrefs
     1540    24081        */
     1541    24082    1   DCL G$JIT$ PTR SYMREF READONLY;
     1542    24083    1   DCL G$ROS$ PTR SYMREF;
     1543    24084    1   DCL G$UHJIT$ PTR SYMREF;
     1544    24085    1   DCL G$MHJIT$ PTR SYMREF;
     1545    24086    1   DCL G$ASDT_MCL$ PTR SYMREF;
     1546    24087        %GATE(FPTN=KNA_LNKIOP,STCLASS=SYMREF);
     1547    24106        %GATE (FPTN=KNA_LNKSSN,STCLASS=SYMREF);
     1548    24125        %K$RWPARM (NAME=KNA_RWPARM_CON,STCLASS=SYMREF);
     1549    24441        %PS_LCP6STT (STCLASS=SYMREF);
     1550    24945
     1551    24946        /*     ENTRY definitions
     1552    24947        */
     1553    24948    1   DCL SCREECH ENTRY(1);
     1554    24949    1   DCL GHS$EVENT ENTRY(7);
PL6.E3A0      #003=KNA$USERIO File=KNA$APE.:E05TSI                               WED 07/30/97 00:58 Page:246  
     1555    24950    1   DCL KNA$FCNOU ENTRY(4) ALTRET;
     1556    24951    1   DCL KNA$FCNO ENTRY(4) ALTRET;
     1557    24952    1   DCL KNA$OPEN ENTRY(4) ALTRET;
     1558    24953    1   DCL KNA$GETIOP ENTRY(1) ALTRET;
     1559    24954    1   DCL KNA$RLSIOP ENTRY(1) ALTRET;
     1560    24955    1   DCL KNA$REG_USER ENTRY(2) ALTRET;
     1561    24956    1   DCL KNA$SAVEMAP ENTRY(2);
     1562    24957        %EJECT;
PL6.E3A0      #003=KNA$USERIO File=KNA$APE.:E05TSI                               WED 07/30/97 00:58 Page:247  
     1563    24958        /*
     1564    24959               This is where the procedure KNA$USERIO begins.  Parameters from
     1565    24960        the FPT are merely moved into local storage and then we go off to the
     1566    24961        mainline code.
     1567    24962        */
     1568    24963    1      VBASE(FPT_BUF$) = KNA_PARAMS.CPTRS.PAR3$;
     1569    24964    1      VBOUND(FPT_BUF$) = KNA_PARAMS.BND.PAR3;
     1570    24965    1      KEY$ = KNA_PARAMS.PTRS.PAR2$;
     1571    24966    1      KEYSZ = KNA_PARAMS.BND.PAR2 + 1;
     1572    24967    1      FPT_CODE = KNA_PARAMS.MCL.CODE;
     1573    24968    1      USRFPT$=KNA_PARAMS.PTRS.PAR1$;
     1574    24969    1      PARMSPEC = '1'B;
     1575    24970    1      FLOW_CONTROL = '1'B;
     1576    24971
     1577    24972    1      IF G$UHJIT.DMN.ID = %G_DMN_DB# OR G$UHJIT.DMN.ID = %G_DMN_DB_SVC#
     1578    24973    1      THEN STR = KIDM_DB;
     1579    24974    1      ELSE STR = KIDM_USER;
     1580    24975
     1581    24976    1      GOTO MAINSTREAM;
     1582    24977
     1583    24978    1   KNA$READ: ENTRY (DCBNUMBER,UBUF$,ERROR,KNA_PARAMS) ALTRET;
     1584    24979    1      FPT_CODE = %G_MCL_READ#;
     1585    24980    1      GOTO SETUP_MON;
     1586    24981
     1587    24982    1   KNA$WRITE: ENTRY (DCBNUMBER,UBUF$,ERROR,KNA_PARAMS) ALTRET;
     1588    24983    1      FLOW_CONTROL = '1'B;
     1589    24984    1      GOTO SETUP_MON_WRITE;
     1590    24985
     1591    24986    1   KNA$WRITE_NOW: ENTRY (DCBNUMBER,UBUF$,ERROR,KNA_PARAMS) ALTRET;
     1592    24987
     1593    24988    1      FLOW_CONTROL = '0'B;
     1594    24989
     1595    24990    1   SETUP_MON_WRITE: ;
     1596    24991    1      FPT_CODE = %G_MCL_WRITE#;
     1597    24992
     1598    24993    1   SETUP_MON: ;
     1599    24994    1      FPT_BUF$ = UBUF$;
PL6.E3A0      #003=KNA$USERIO File=KNA$APE.:E05TSI                               WED 07/30/97 00:58 Page:248  
     1600    24995    1      USRFPT$=ADDR(KNA_PARAMS);
     1601    24996    1      PARMSPEC = '0'B;
     1602    24997    1      STR = KIDM_MON;
     1603    24998    1      KEY$ = ADDR(NIL);
     1604    24999    1      KEYSZ = 0;
     1605    25000    1      GOTO MAINSTREAM;
     1606    25001
     1607    25002        /* Now we must do some validity checks.
     1608    25003        */
     1609    25004    1   MAINSTREAM:
     1610    25005    1      ERROR = '0'B;
     1611    25006    1      IF DCBNUMBER > G$ROS.NUMDCBS OR DCBNUMBER = 0
     1612    25007    2      THEN DO;
     1613    25008    2           ERROR = EDCBNUM;
     1614    25009    2           ALTRETURN;
     1615    25010    2           END;
     1616    25011        /*E* ERROR: KNA-E$BADDCB#
     1617    25012             MESSAGE: An invalid DCB has been passed
     1618    25013        */
     1619    25014
     1620    25015    1      IF USRFPT$~=ADDR(NIL) AND FPT_CODE=%G_MCL_READ#
     1621    25016    1      THEN
     1622    25017    1           IF VBASE(FPT_BUF$)=ADDR(NIL)
     1623    25018    1             OR FPT_READ.V.READMLT AND VBOUND(FPT_BUF$)<127
     1624    25019    2           THEN DO;
     1625    25020    2                ERROR = EBADBUF;
     1626    25021    2                ALTRETURN;
     1627    25022    2                END;
     1628    25023        /*E* ERROR: KNA-E$BADVECT2
     1629    25024             MESSAGE: An invalid buffer vector was specified
     1630    25025             MESSAGE1: M$READ specified BUF=NIL
     1631    25026                       or M$READ with READMLT specified BUF < 256 bytes.
     1632    25027        */
     1633    25028
     1634    25029        /*N*  READ/WRITE - Many more validity checks need to be made depending
     1635    25030        upon options in the DCB.  Also many more things will be passed on the
     1636    25031        FPT.  A good way of resolving the flavor of DCB we have and the validity
PL6.E3A0      #003=KNA$USERIO File=KNA$APE.:E05TSI                               WED 07/30/97 00:58 Page:249  
     1637    25032        of things passed on READ/WRITE FPTs (for instance, no buffer vector
     1638    25033        could actually be legal) has yet to be resolved.  A better understanding
     1639    25034        of what ORGS vs. ACCESSes vs. ASNs vs. FPT parameters needed by the
     1640    25035        users has to be developed first.
     1641    25036        */
     1642    25037
     1643    25038        /*     If the DCB passed to us is not OPEN then we will attempt a
     1644    25039        default OPEN.
     1645    25040        */
     1646    25041    1      DCB$ = G$ROS.DCBPTR$ -> G$DCBTABLE(DCBNUMBER);
     1647    25042    1      IF MYDCB.FCD = '0'B
     1648    25043    2      THEN DO;
     1649    25044    2           MYDCB.ORG = %G_ORG_CONSEC#;
     1650    25045    2           CALL KNA$OPEN(DCBNUMBER,ERROR) ALTRET(CANT_OPEN);
     1651    25046    2           IF ERROR ~= '0'B
     1652    25047    3           THEN DO;
     1653    25048    3   CANT_OPEN:   ALTRETURN;
     1654    25049    3                END;
     1655    25050    2           END;
     1656    25051         %EJECT;
PL6.E3A0      #003=KNA$USERIO File=KNA$APE.:E05TSI                               WED 07/30/97 00:58 Page:250  
     1657    25052           %LOCK (G=KNA_LNKSSN);
     1658    25059    1      SSN$ = MYDCB.SSN$;
     1659    25060
     1660    25061    1      IF KNA$SSN.FLAGS.MRKPND
     1661    25062    1      THEN
     1662    25063    1           CALL SEND_MARKER;
     1663    25064
     1664    25065    1      IF KNA$SSN.STATE ~= %KNA_STATE_ACTIVE#
     1665    25066    2      THEN DO;
     1666    25067    2           ERROR = ELDSC;
     1667    25068    2           GOTO FINISHED;
     1668    25069    2           END;
     1669    25070        /*E* ERROR: KNA-%E$LDSC
     1670    25071             MESSAGE: Disconnect received from endpoint.
     1671    25072             MESSAGE1: The other endpoint is disconnecting.
     1672    25073        */
     1673    25074
     1674    25075    1      MYDCB.TYC = '0'B;
     1675    25076    1      IF STR = KIDM_USER
     1676    25077    1      THEN STR = MYDCB.STRM;
     1677    25078
     1678    25079    1      K$RWPARM = KNA_RWPARM_CON;
     1679    25080
     1680    25081    1      IF PARMSPEC AND KNA_PARAMS.PTRS.PAR4$ ~= ADDR(NIL)
     1681    25082    2      THEN DO;
     1682    25083    2           K$RWPARM.STATION = KNA_PARAMS.PTRS.PAR4$->VLP_CG.STATION#;
     1683    25084    2           K$RWPARM.MSGTYP = KNA_PARAMS.PTRS.PAR4$->VLP_CG.MSGTYP#;
     1684    25085    2           K$RWPARM.MSGID = KNA_PARAMS.PTRS.PAR4$->VLP_CG.MSGID#;
     1685    25086    2           END;
     1686    25087
     1687    25088
     1688    25089        %EJECT;
PL6.E3A0      #003=KNA$USERIO File=KNA$APE.:E05TSI                               WED 07/30/97 00:58 Page:251  
     1689    25090
     1690    25091    1      RESTYPE = MYDCB.DDEV.RES;
     1691    25092    1      IF VBASE(FPT_BUF$) = ADDR(NIL)
     1692    25093    1      THEN
     1693    25094    1           MSGSIZE = 0;
     1694    25095    1      ELSE
     1695    25096    1           MSGSIZE = VBOUND(FPT_BUF$)+1;
     1696    25097        /*     Now do either the WRITE or the READ
     1697    25098        */
     1698    25099    1      IF FPT_CODE = %G_MCL_WRITE#
     1699    25100    2      THEN DO;
     1700    25101
     1701    25102        /* Stay in this loop until we get to send the data out to Session
     1702    25103        */
     1703    25104    3   WRITELOOP: DO WHILE('1'B);
     1704    25105    3                IF USRFPT$ ~= ADDR(NIL)
     1705    25106    3                THEN K$RWPARM.DVE.DVBYTE = FPT_WRITE.V.DVBYTE;
     1706    25107
     1707    25108    3                IF K$RWPARM.DVE.DVBYTE.NODAT
     1708    25109    3                THEN ROUTINE = ENTADDR(KNA$FCNO);
     1709    25110    3                ELSE ROUTINE = ENTADDR(KNA$FCNOU);
     1710    25111
     1711    25112        /* Check to see if the other end only wants to receive part of the message */
     1712    25113    3                IF FLOW_CONTROL AND KNA$SSN.THRTLVL.MAXRCRBYTSIZ < MSGSIZE
     1713    25114    3                  AND KNA$SSN.THRTLVL.MAXNMBRCR >= 1
     1714    25115    3                  AND (KNA$SSN.FLAGS.MULT_STR AND STR~=KIDM_MON
     1715    25116    3                  OR STR = KNA$SSN.THRTLVL.STR
     1716    25117    3                  OR KNA$SSN.THRTLVL.STR = 0)
     1717    25118    4                THEN DO;
     1718    25119    4                     IF KNA$SSN.THRTLVL.MAXRCRBYTSIZ = 0 THEN
     1719    25120    4                          GOTO FINISHED;   /* Outputdiscard says "send nothing"  */
     1720    25121    4                     MSGSIZE = KNA$SSN.THRTLVL.MAXRCRBYTSIZ;
     1721    25122    4                     ERROR = ESHORT_BUFFER;
     1722    25123    4                     END;
     1723    25124        /* If RRR we want an end ack back */
     1724    25125    3                IF K$RWPARM.DVE.DVBYTE.RRR
     1725    25126    3                THEN K$RWPARM.MRKTYP = %KV_VDOMRKTYP_ENDACK;
PL6.E3A0      #003=KNA$USERIO File=KNA$APE.:E05TSI                               WED 07/30/97 00:58 Page:252  
     1726    25127
     1727    25128        /* Check the throttling values to see if we can send the data now.
     1728    25129        */
     1729    25130    3                IF FLOW_CONTROL = '0'B OR
     1730    25131    3                  KNA$SSN.THRTLVL.MAXNMBRCR >=1 AND KNA$SSN.THRTLVL.MAXNMBBYT >=
             25131                           MSGSIZE
     1731    25132    3                  AND (KNA$SSN.FLAGS.MULT_STR AND STR~=KIDM_MON
     1732    25133    3                  OR STR = KNA$SSN.THRTLVL.STR
     1733    25134    3                  OR KNA$SSN.THRTLVL.STR = 0)
     1734    25135    4                THEN DO;
     1735    25136    4                     KNA$SSN.FLAGS.BLOCKED = '0'B;
     1736    25137    4                     IF FLOW_CONTROL
     1737    25138    4                     THEN FCN = %KV_VDO_FNC_DAT;
     1738    25139    4                     ELSE FCN = %KV_VDO_FNC_DAT_IMD;
     1739    25140
     1740    25141    4                     K$RWPARM.STR = STR;
     1741    25142    4                     K$RWPARM.MSGSZ = MSGSIZE;
     1742    25143
     1743    25144    4                     K$RWPARM.MSGC$ = VBASE(FPT_BUF$);
     1744    25145    4                     IF K$RWPARM.DVE.DVBYTE.VFC
     1745    25146    5                     THEN DO;
     1746    25147    5                          K$RWPARM.DVE.VFC = K$RWPARM.MSGC$->VFC;
     1747    25148    5                          K$RWPARM.MSGC$ = PINCRC (K$RWPARM.MSGC$,1);
     1748    25149    5                          K$RWPARM.MSGSZ = K$RWPARM.MSGSZ - 1;
     1749    25150    5                          END;
     1750    25151    4                     ELSE IF USRFPT$ ~= ADDR(NIL) AND MYDCB.DVFC ~= BINASC(0)
     1751    25152    5                          THEN DO;
     1752    25153    5                               K$RWPARM.DVE.DVBYTE.VFC = '1'B;
     1753    25154    5                               K$RWPARM.DVE.VFC = MYDCB.DVFC;
     1754    25155    5                               END;
     1755    25156    4                     K$RWPARM.KEY$ = KEY$;
     1756    25157    4                     K$RWPARM.KEYSZ = KEYSZ;
     1757    25158    4                     IF USRFPT$ ~= ADDR(NIL)
     1758    25159    5                     THEN DO;
     1759    25160    5                          K$RWPARM.KEYTYPE = FPT_WRITE.V.KEYTYPE;
     1760    25161    5                          IF K$RWPARM.KEYTYPE = 0
     1761    25162    5                          THEN K$RWPARM.KEYTYPE = MYDCB.KEYTYPE;
PL6.E3A0      #003=KNA$USERIO File=KNA$APE.:E05TSI                               WED 07/30/97 00:58 Page:253  
     1762    25163    5                          IF FPT_WRITE.V.EOM AND SUBSTR(MYDCB.RES,0,2)~='UC'
     1763    25164    6                          THEN DO;
     1764    25165    6                               K$RWPARM.DVE.EOMCHAR = FPT_WRITE.V.EOMCHAR;
     1765    25166    6                               K$RWPARM.DVE.DVBYTE.VFC = '0'B;
     1766    25167    6                               K$RWPARM.EOM_EOR = '1'B;
     1767    25168    6                               END;
     1768    25169    5                          END;
     1769    25170
     1770    25171    4                     CALL ROUTINE (FCN,KNA$SSN,K$RWPARM,ERR)
     1771    25172    4                       ALTRET (SSN_ERR);
     1772    25173
     1773    25174    4                     IF FLOW_CONTROL
     1774    25175    5                     THEN DO;
     1775    25176    5                          KNA$SSN.THRTLVL.MAXNMBRCR = KNA$SSN.THRTLVL.MAXNMBRCR-1;
     1776    25177    5                          KNA$SSN.THRTLVL.MAXNMBBYT = KNA$SSN.THRTLVL.MAXNMBBYT -
             25177                                   MSGSIZE;
     1777    25178    5                          END;
     1778    25179    4                     EXIT WRITELOOP;
     1779    25180
     1780    25181    4                     END/* End for sending the data now*/;
     1781    25182
     1782    25183        /* If we don't have enough throttling to do this then we'll just
     1783    25184        set a bit saying that we are waiting for a message and REG the
     1784    25185        current user.
     1785    25186        */
     1786    25187    4                ELSE DO;
     1787    25188    4                     IF KNA$SSN.FLAGS.BLOCKED
     1788    25189    4                     THEN GOTO REG_BLOCKED;
     1789    25190
     1790    25191    4                     K$RWPARM.STR = STR;
     1791    25192    4                     K$RWPARM.MAXRCRBYTSIZ = MSGSIZE;
     1792    25193    4                     IF KNA$SSN.THRTLVL.MAXNMBRCR = 0
     1793    25194    4                     THEN K$RWPARM.RSN = %KV_BLKRSN_MAXNMBRCR;
     1794    25195    4                     ELSE K$RWPARM.RSN = %KV_BLKRSN_MAXNMBBYT;
     1795    25196    4                     KNA$SSN.REGRSN = 0;   /* So we can detect getting blocked   */
     1796    25197
     1797    25198    4                     CALL ROUTINE(%KV_VDO_FNC_BLKDAT,KNA$SSN,K$RWPARM,ERR)
PL6.E3A0      #003=KNA$USERIO File=KNA$APE.:E05TSI                               WED 07/30/97 00:58 Page:254  
     1798    25199                                                /* call KNA$FCNO or KNA$FCNOU*/
     1799    25200    4                       ALTRET (SSN_ERR);
     1800    25201
     1801    25202
     1802    25203    4                     KNA$SSN.FLAGS.BLOCKED = '1'B;
     1803    25204    4                     IF KNA$SSN.REGRSN ~= 0
     1804    25205    4                     THEN GOTO WRITELOOP;  /* Start over if we got blocked       */
     1805    25206
     1806    25207    4   REG_BLOCKED:      IF MYDCB.DVBYTE.NODAT
     1807    25208    5                     THEN DO;
     1808    25209    5                          ERROR=ENO_DAT;
     1809    25210    5                          GOTO FINISHED;
     1810    25211    5                          END;
     1811    25212        /*E* ERROR: KNA-%E$NODAT
     1812    25213             MESSAGE: No throttling available for write or no data available for read.
     1813    25214        */
     1814    25215    4                     CALL KNA$REG_USER(%GH_EVCBL,SSN$)
     1815    25216    5                     WHENALTRETURN DO;
     1816    25217    5                          IF STR ~= KIDM_MON
     1817    25218    5                            OR KNA$SSN.STATE ~= %KNA_STATE_ACTIVE#
     1818    25219    6                          THEN DO;
     1819    25220    6                               G$JIT.JUNK.BACKP$='1'B;
     1820    25221    6   SSN_ERR:                    IF KNA$SSN.FLAGS.SSNERR THEN ERROR = KNA$SSN.ERROR;
     1821    25222    6                               ELSE ERROR = EBYD;
     1822    25223    6                               KNA$SSN.FLAGS.BLOCKED = '0'B;
     1823    25224    6                               GOTO FINISHED;
     1824    25225    6                               END/*do if mon*/;
     1825    25226    5                          END/*altret from reg_user*/;
     1826    25227        /*E* ERROR: KNA-%E$BYD
     1827    25228             MESSAGE: Asynchronous event interrupted I/O.
     1828    25229        */
     1829    25230    3                     END;/*do if no throttling*/;
     1830    25231    3                END/* writeloop: do while('1'B)*/;
     1831    25232        %EJECT;
PL6.E3A0      #003=KNA$USERIO File=KNA$APE.:E05TSI                               WED 07/30/97 00:58 Page:255  
     1832    25233
     1833    25234        /* Update the various write counters.
     1834    25235        */
     1835    25236    3           DO CASE(RESTYPE);
     1836    25237    3            CASE(%G_DDEV_RES_HO#);
     1837    25238    3              G$JIT.WRITES_HOST = G$JIT.WRITES_HOST +1;
     1838    25239    3              PS_LCP6STT.WRITES_HOST = PS_LCP6STT.WRITES_HOST +1;
     1839    25240    3              PS_LCP6STT.BYTES_WRT_HOST = PS_LCP6STT.BYTES_WRT_HOST + MSGSIZE;
     1840    25241    3            CASE(%G_DDEV_RES_UC#);
     1841    25242    3              G$JIT.WRITES_UC = G$JIT.WRITES_UC +1;
     1842    25243    3              PS_LCP6STT.WRITES_UC = PS_LCP6STT.WRITES_UC +1;
     1843    25244    3              PS_LCP6STT.BYTES_WRT_UC = PS_LCP6STT.BYTES_WRT_UC + MSGSIZE;
     1844    25245    3            CASE(%G_DDEV_RES_LG#);
     1845    25246    3              PS_LCP6STT.WRITES_LG = PS_LCP6STT.WRITES_LG +1;
     1846    25247    3              PS_LCP6STT.BYTES_WRT_LG = PS_LCP6STT.BYTES_WRT_LG + MSGSIZE;
     1847    25248    3            CASE(%G_DDEV_RES_NA#);
     1848    25249    3              PS_LCP6STT.WRITES_NA = PS_LCP6STT.WRITES_NA +1;
     1849    25250    3              PS_LCP6STT.BYTES_WRT_NA = PS_LCP6STT.BYTES_WRT_NA + MSGSIZE;
     1850    25251    3              END/*do select*/;
     1851    25252
     1852    25253        /* If this is an RRR request grab a IOP packet */
     1853    25254    2           IF K$RWPARM.DVE.DVBYTE.RRR
     1854    25255    3           THEN DO;
     1855    25256    3                CALL KNA$GETIOP(IOP$)
     1856    25257    4                WHENALTRETURN DO;
     1857    25258    4                     ERROR = ENO_IOP;
     1858    25259    4                     GOTO FINISHED;
     1859    25260    4                     END;
     1860    25261    3                KNA$SSN.IOPQ$ = IOP$;
     1861    25262    3                KNA$SSN.FLAGS.RRRPND = '1'B;
     1862    25263    3                CALL KNA$REG_USER(%GH_EVCW,SSN$)
     1863    25264    4                WHENRETURN DO;
     1864    25265    4                     IF KN$IOP.ERRCODE THEN ERROR = KN$IOP.ERRCODE;
     1865    25266    4                     END;
     1866    25267    4                WHENALTRETURN DO;
     1867    25268    4                     IF KNA$SSN.FLAGS.SSNERR THEN ERROR = KNA$SSN.ERROR;
     1868    25269    4                     ELSE ERROR = EBYD;
PL6.E3A0      #003=KNA$USERIO File=KNA$APE.:E05TSI                               WED 07/30/97 00:58 Page:256  
     1869    25270    4                     END;
     1870    25271    3                IF PARMSPEC AND KNA_PARAMS.PTRS.PAR4$ ~= ADDR(NIL)
     1871    25272    3                THEN KNA_PARAMS.PTRS.PAR4$->VLP_CG.MSGID# = KN$IOP.MSGID;
     1872    25273
     1873    25274    3                CALL KNA$RLSIOP (IOP$);
     1874    25275    3                KNA$SSN.IOPQ$ = ADDR(NIL);
     1875    25276    3                END;
     1876    25277    2           END;
     1877    25278        %EJECT;
PL6.E3A0      #003=KNA$USERIO File=KNA$APE.:E05TSI                               WED 07/30/97 00:58 Page:257  
     1878    25279        /*
     1879    25280               Now we come to the READ code.  Here we basically just have to
     1880    25281        get an I/O packet for keeping track of the user's buffer, issue a
     1881    25282        message to the network connection specifying how much we can accept,
     1882    25283        mark this in our SSN context, and REG the user until this is all
     1883    25284        done.
     1884    25285        */
     1885    25286    2      ELSE DO;
     1886    25287        /*
     1887    25288          Verify that there is no other read operation pending on this stream.
     1888    25289          If there is, report an error and return.
     1889    25290                                                                                      */
     1890    25291    2           IF KNA$SSN.IOPRD$ ~= ADDR(NIL)  /* Another read out standing          */
     1891    25292    3           THEN DO;
     1892    25293    3                IF MOD(KNA_LNKSSN.SREG,64)<61
     1893    25294    4                THEN DO;
     1894    25295    4                     ERROR = EXTRA_READ;
     1895    25296    4                     GOTO FINISHED;
     1896    25297    4                     END;
     1897    25298
     1898    25299    3                IOP$ = KNA$SSN.IOPRD$;
     1899    25300    3                K$RWPARM.STR = KN$IOP.DCB$->MYDCB.STRM;
     1900    25301    3                CALL CANCEL_READ ALTRET(SSN_ERR);
     1901    25302    3                K$RWPARM.MRKTYP = 0;
     1902    25303    3                IF KNA$SSN.IOPRD$ = ADDR(NIL) /* Got message                     */
     1903    25304    3                THEN GOTO READ_COMPLETED;
     1904    25305
     1905    25306    3                NWIO = '0'B;
     1906    25307    3                NWIO.P# = SIZEW(NWIO) - SIZEW(NWIO.P#);
     1907    25308    3                TCB_ERR = EXTRA_READ;
     1908    25309    3                EVENT = KN$IOP.EVENT;
     1909    25310    3                CALL GHS$EVENT (KNA$SSN.USER#,%GH_USRDMN#,%G_IO_CMP#,EVENT,TCB_ERR,NWIO
             25310                         );
     1910    25311    3                END/*do if ssn.ioprd$ ~= nil*/;
     1911    25312        /*E* ERROR: KNA-E$XTRARD-0
     1912    25313             MESSAGE: Read errored because of another read issued.
     1913    25314        */
PL6.E3A0      #003=KNA$USERIO File=KNA$APE.:E05TSI                               WED 07/30/97 00:58 Page:258  
     1914    25315
     1915    25316    3           ELSE DO;                        /*when no read is outstanding*/
     1916    25317    3   READ_COMPLETED: ;
     1917    25318    3                CALL KNA$GETIOP(IOP$)
     1918    25319    4                WHENALTRETURN DO;
     1919    25320
     1920    25321    4                     ERROR = ENO_IOP;
     1921    25322    4                     GOTO FINISHED;
     1922    25323    4                     END;
     1923    25324    3                END/*else do*/;
     1924    25325        /*E* ERROR: KNA-E$NO_IOP
     1925    25326             MESSAGE: No I/O packets available for this operation.
     1926    25327        */
     1927    25328
     1928    25329
     1929    25330    2           KN$IOP = '0'B;
     1930    25331    2           IOP$->KN$IOP.FLAGS.INUSE = '1'B;
     1931    25332    2           IOP$->KN$IOP.L.USER# = G$JIT.USR#;
     1932    25333        /*
     1933    25334          Link up the new I/O packet.  If this is the first one on the chain,
     1934    25335          also setup the pointer from APE session context.
     1935    25336                                                                                      */
     1936    25337    2           KNA$SSN.IOPRD$=IOP$;
     1937    25338
     1938    25339    2           KN$IOP.FLAGS.WAIT='1'B;
     1939    25340
     1940    25341    2           KN$IOP.DCB$=DCB$;
     1941    25342    2           CALL KNA$SAVEMAP (DCB$,KN$IOP.DCBSEGDES);
     1942    25343    2           KN$IOP.BUF_ = FPT_BUF$;
     1943    25344    2           CALL KNA$SAVEMAP(VBASE(KN$IOP.BUF_),KN$IOP.BUFSEGDES);
     1944    25345
     1945    25346        /*     Set up for sending a READ REQUEST for the data
     1946    25347        */
     1947    25348    2           K$RWPARM.STR = STR;
     1948    25349    2           K$RWPARM.MAXRCRBYTSIZ = MSGSIZE;
     1949    25350    2           K$RWPARM.MAXNMBRCR=1;
     1950    25351    2           K$RWPARM.MAXNMBBYT=6000;
PL6.E3A0      #003=KNA$USERIO File=KNA$APE.:E05TSI                               WED 07/30/97 00:58 Page:259  
     1951    25352    2           IF USRFPT$ ~= ADDR(NIL)
     1952    25353    3           THEN DO;
     1953    25354    3                KN$IOP.FLAGS.WAIT = FPT_READ.V.WAIT;
     1954    25355    4                IF FPT_READ.V.READMLT THEN DO;
     1955    25356    4                     KN$IOP.FLAGS.READMLT = '1'B;
     1956    25357    4                     K$RWPARM.READMLT = '1'B;
     1957    25358    4                     K$RWPARM.MAXNMBBYT = K$RWPARM.MAXRCRBYTSIZ;
     1958    25359    4                     END;
     1959    25360    3                KN$IOP.EVENT = FPT_READ.V.EVENT;
     1960    25361    3                K$RWPARM.DVE.DVBYTE = FPT_READ.V.DVBYTE;
     1961    25362    3                K$RWPARM.KEYTYPE = FPT_READ.V.KEYTYPE;
     1962    25363    3                IF K$RWPARM.KEYTYPE = 0
     1963    25364    3                THEN K$RWPARM.KEYTYPE = MYDCB.KEYTYPE;
     1964    25365    3                IF FPT_READ.V.KEYS
     1965    25366    4                THEN DO;
     1966    25367    4                     K$RWPARM.KEY$ = KEY$;
     1967    25368    4                     K$RWPARM.KEYSZ = KEYSZ;
     1968    25369    4                     END;
     1969    25370    3                IF FPT_READ.V.KEYR
     1970    25371    4                THEN DO;
     1971    25372    4                     VBASE(KN$IOP.KEY_) = KEY$;
     1972    25373    4                     VBOUND(KN$IOP.KEY_) = KEYSZ - 1;
     1973    25374    4                     CALL KNA$SAVEMAP(VBASE(KN$IOP.KEY_),KN$IOP.KEYSEGDES);
     1974    25375    4                     KN$IOP.KEYTYPE = K$RWPARM.KEYTYPE;
     1975    25376    4                     END;
     1976    25377    3                ELSE KN$IOP.KEY_ = VECTOR(NIL);
     1977    25378    3                END;
     1978    25379
     1979    25380
     1980    25381    2           K$RWPARM.VDOFLGS.WAIT = KN$IOP.FLAGS.WAIT;
     1981    25382
     1982    25383    2           CALL KNA$FCNOU (%KV_VDO_FNC_RQSDAT,KNA$SSN,K$RWPARM,ERR)
     1983    25384    3           WHENALTRETURN DO;
     1984    25385    3                CALL KNA$RLSIOP(IOP$);
     1985    25386    3                KNA$SSN.IOPRD$ = ADDR(NIL);
     1986    25387    3                GOTO SSN_ERR;
     1987    25388    3                END;
PL6.E3A0      #003=KNA$USERIO File=KNA$APE.:E05TSI                               WED 07/30/97 00:58 Page:260  
     1988    25389
     1989    25390
     1990    25391        /* Update the various read counters.
     1991    25392        */
     1992    25393    3           DO CASE(RESTYPE);
     1993    25394    3            CASE(%G_DDEV_RES_HO#);
     1994    25395    3              G$JIT.READS_HOST = G$JIT.READS_HOST +1;
     1995    25396    3              PS_LCP6STT.READS_HOST = PS_LCP6STT.READS_HOST +1;
     1996    25397    3            CASE(%G_DDEV_RES_UC#);
     1997    25398    3              G$JIT.READS_UC = G$JIT.READS_UC +1;
     1998    25399    3              PS_LCP6STT.READS_UC = PS_LCP6STT.READS_UC +1;
     1999    25400    3            CASE(%G_DDEV_RES_LG#);
     2000    25401    3              PS_LCP6STT.READS_LG = PS_LCP6STT.READS_LG +1;
     2001    25402    3            CASE(%G_DDEV_RES_NA#);
     2002    25403    3              PS_LCP6STT.READS_NA = PS_LCP6STT.READS_NA +1;
     2003    25404    3              END/*do case*/;
     2004    25405
     2005    25406        /* If this is a no wait I/O then return.
     2006    25407        */
     2007    25408    2           IF NOT KN$IOP.FLAGS.WAIT
     2008    25409    2           THEN GOTO FINISHED;
     2009    25410        /*     We sent off the message, now we just wait for the user to get
     2010    25411        his data delivered.
     2011    25412        */
     2012    25413    2           IF STR = KIDM_MON
     2013    25414    2             AND (USRFPT$ = ADDR(NIL) OR NOT FPT_READ.V.BRKABLE)
     2014    25415    2           THEN
     2015    25416    2                CALL KNA$REG_USER(%GH_EVCW,SSN$);
     2016    25417    2           ELSE
     2017    25418    2                CALL KNA$REG_USER(%GH_EVCRD,SSN$);
     2018    25419
     2019    25420    2           IF NOT KN$IOP.FLAGS.RDDONE      /* Read did not finish                */
     2020    25421    3           THEN DO;
     2021    25422    3                K$RWPARM.MAXNMBRCR = 0;
     2022    25423    3                IF NOT KNA$SSN.FLAGS.MRKPND AND NOT KNA$SSN.FLAGS.SSNERR
     2023    25424    3                THEN
     2024    25425    3                     CALL CANCEL_READ;
PL6.E3A0      #003=KNA$USERIO File=KNA$APE.:E05TSI                               WED 07/30/97 00:58 Page:261  
     2025    25426    3                IF KN$IOP.FLAGS.RDDONE AND NOT G$MHJIT.CU$->G$U.ASYNCH & %U_ALIBFD
     2026    25427    3                THEN EXIT;
     2027    25428    3                IF KNA$SSN.FLAGS.SSNERR THEN KN$IOP.ERRCODE = KNA$SSN.ERROR;
     2028    25429    3                ELSE KN$IOP.ERRCODE = EBYD;
     2029    25430    3                IF STR ~= KIDM_MON
     2030    25431    3                THEN G$JIT.JUNK.BACKP$='1'B;
     2031    25432    3                END;
     2032    25433    2           IF KNA$SSN.FLAGS.MRKPND
     2033    25434    2           THEN
     2034    25435    2                CALL SEND_MARKER;
     2035    25436
     2036    25437    2           ERROR = KN$IOP.ERRCODE;
     2037    25438    2           IF PARMSPEC AND KNA_PARAMS.PTRS.PAR4$ ~= ADDR(NIL)
     2038    25439    2           THEN KNA_PARAMS.PTRS.PAR4$->VLP_CG.MSGTYP# = KN$IOP.MSGTYPE;
     2039    25440    2           KNA$SSN.IOPRD$=ADDR(NIL);
     2040    25441    2           CALL KNA$RLSIOP(IOP$);
     2041    25442    2           IF MYDCB.TYC.LD# = '1'B
     2042    25443    3           THEN DO;
     2043    25444
     2044    25445        /*E*     ERROR: KNA-E$LD
     2045    25446                 MESSAGE: The supplied buffer was too small
     2046    25447        */
     2047    25448    3                ERROR = ESHORT_BUFFER;
     2048    25449    3                END;
     2049    25450    2           END;
     2050    25451    1   FINISHED:;
     2051    25452           %UNLOCK (G=KNA_LNKSSN);
     2052    25459    1      IF ERROR ~= '0'B
     2053    25460    1      THEN
     2054    25461    1           ALTRETURN;
     2055    25462    1      RETURN;
     2056    25463
     2057    25464    1   CANCEL_READ: PROC ALTRET;
     2058    25465
     2059    25466    2      K$RWPARM.MRKTYP = %KV_VDOMRKTYP_ENDACK;
     2060    25467    2      CALL KNA$FCNOU (%KV_VDO_FNC_RQSDAT,KNA$SSN,K$RWPARM,ERR)
     2061    25468    3      WHENRETURN DO;
PL6.E3A0      #003=KNA$USERIO File=KNA$APE.:E05TSI                               WED 07/30/97 00:58 Page:262  
     2062    25469    3           KNA$SSN.FLAGS.RRRPND = '1'B;
     2063    25470    4           CALL KNA$REG_USER(%GH_EVCW,SSN$) WHENALTRETURN DO;
     2064    25471    4                ALTRETURN;
     2065    25472    4                END;
     2066    25473    3           END;
     2067    25474
     2068    25475    2      RETURN;
     2069    25476    2   END CANCEL_READ;
     2070    25477
     2071    25478    1   SEND_MARKER: PROC;
     2072    25479
     2073    25480    2      K$RWPARM = KNA_RWPARM_CON;
     2074    25481    2      K$RWPARM.MRKTYP = %KV_VDOMRKTYP_MRK;
     2075    25482    2      K$RWPARM.MARKER = KNA$SSN.MARKER;
     2076    25483    2      CALL KNA$FCNOU(%KV_VDO_FNC_MRK,KNA$SSN,K$RWPARM,ERR);
     2077    25484    2      KNA$SSN.FLAGS.MRKPND = '0'B;
     2078    25485    2      RETURN;
     2079    25486    2   END SEND_MARKER;
     2080    25487    1   END KNA$USERIO;

PL6.E3A0      #003=KNA$USERIO File=KNA$APE.:E05TSI                               WED 07/30/97 00:58 Page:263  
--  Include file information  --

   K$RWPARM.:E05TOU  is referenced.
   KV$VDO.:E05TOU  is referenced.
   GM_VIRTUAL_E.:E05TOU  is referenced.
   UD_ERRORS_C.:E05TOU  is referenced.
   F_ERRORS_C.:E05TOU  is referenced.
   G_LCP6_E.:E05TOU  is referenced.
   GF_LCP6_M.:E05TOU  is referenced.
   GU_MACROS_M.:E05TOU  is referenced.
   GU_LCP6_M.:E05TOU  is referenced.
   K_ID_E.:E05TOU  is referenced.
   KL_MACRO_C.:E05TOU  is referenced.
   P_FEP_M.:E05TOU  is referenced.
   K_SCODE_C.:E05TOU  is referenced.
   KN_DATA_M.:E05TOU  is referenced.
   GH_GATE_M.:E05TOU  cannot be made into a system file and is referenced.
   G_JIT_M.:E05TOU  is referenced.
   G_ROS_M.:E05TOU  is referenced.
   G_HJIT_M.:E05TOU  is referenced.
   GH_SCHD_M.:E05TOU  is referenced.
   GH_SCHD_E.:E05TOU  is referenced.
   GH_LCP6_M.:E05TOU  is referenced.
   KI_SUBS_C.:E05TOU  is referenced.
   KI_ERRORS_C.:E05TOU  is referenced.
   KN_ERRORS_C.:E05TOU  is referenced.
   KNA_MACRO_M.:E05TOU  is referenced.
      No diagnostics issued in procedure KNA$USERIO.

   Procedure KNA$USERIO requires 1782 words for executable code.
   Procedure KNA$USERIO requires 118 words of local(AUTO) storage.

    No errors detected in file KNA$APE.:E05TSI    .

PL6.E3A0      #003=KNA$USERIO File=KNA$APE.:E05TSI                               WED 07/30/97 00:58 Page:264  

 Object Unit name= KNA$USERIO                                 File name= KNA$APE.:E05TOU
 UTS= JUL 30 '97 00:58:31.72 WED                              Compiler= PL-6/E31         Sev=      00
 SharedLib= :SHARED_LCP6_SYSTEM                               Alt SharedLib=


    ****  Control sections  ****

 Sect   Type Bound  Init  Size HexSiz  Section name
    0  RoData even  UTS     22     16  KNA$USERIO
    1   Proc  even  none  1782    6F6  KNA$USERIO
    2  RoData even  none     6      6  KNA$USERIO

    ****  Entry defs  ****

                              Check   Calling
                             calling  sequence
  Sect HexLoc Primary Altret sequence   type   Parms  Name
     1      0   yes    yes     yes      Std        4  KNA$USERIO
     1     3C          yes     yes      Std        4  KNA$READ
     1     47          yes     yes      Std        4  KNA$WRITE
     1     51          yes     yes      Std        4  KNA$WRITE_NOW
PL6.E3A0      #003=KNA$USERIO File=KNA$APE.:E05TSI                               WED 07/30/97 00:58 Page:265  

  ****  Entry refs  ****

         Check        Calling
        calling       sequence
Altret sequence SRef   type   Args  Name
 yes     yes           Std       4 KNA$OPEN
 yes     yes           Std       1 GHH$LOCK
 yes     yes           Std       1 GHH$UNLOCK
 yes     yes           Std       4 KNA$FCNO
 yes     yes           Std       4 KNA$FCNOU
         yes           Std       7 GHS$EVENT
 yes     yes           Std       2 KNA$REG_USER
 yes     yes           Std       1 KNA$GETIOP
         yes           Std       2 KNA$SAVEMAP
 yes     yes           Std       1 KNA$RLSIOP
                       nStd      0 X6A_AUTO_N
                       nStd      0 X6A_AALT
                       nStd      0 X6A_ARET

  ****  Data refs  ****

  Flags:  r = read only, s = secondary
Flgs Name                             Flgs Name                             Flgs Name
r    G$JIT$                                G$ROS$                                G$UHJIT$
     G$MHJIT$                              G$ASDT_MCL$                           KNA_LNKSSN
     KNA_RWPARM_CON                        PS_LCP6STT                       r    G$ROS$
PL6.E3A0      #003=KNA$USERIO File=KNA$APE.:E05TSI                               WED 07/30/97 00:58 Page:266  


     1342        1        /*T***********************************************************/
     1343        2        /*T*                                                         */
     1344        3        /*T* Copyright (c) Bull HN Information Systems Inc., 1997    */
     1345        4        /*T*                                                         */
     1346        5        /*T***********************************************************/
     1347        6        /*F*
     1348        7           NAME: KNA$USERIO
     1349        8           PURPOSE:
     1350        9                  This routine handles M$READ/WRITE on behalf of network
     1351       10             connections.
     1352       11           DESCRIPTION:
     1353       12                  This routine takes an application program's M$READ or M$WRITE
     1354       13             and does the proper Presentation Protocol.  A message specifying
     1355       14             a request for data (M$READ) or the data itself (M$WRITE) is sent
     1356       15             via a connection established with the monitor Session layer.
     1357       16        */
     1358       17        /*D*
     1359       18           NAME: KNA$USERIO
     1360       19             This routine handles M$READ/WRITE on behalf of the user.
     1361       20
     1362       21           ENTRY: KNA$READ
     1363       22             Provides an internal interface for the monitor to issue M$READ.
     1364       23
     1365       24           ENTRY: KNA$WRITE
     1366       25             Provides an internal interface for the monitor to issue M$WRITE.
     1367       26
     1368       27           ENTRY: KNA$WRITE_NOW
     1369       28             Provides an internal interface for the monitor to issue M$WRITE
     1370       29             which doesn't do flow control.
     1371       30
     1372       31           CALL:  CALL KNA$routine(DCBNUMBER,UBUF$,ERROR,KNA_PARAMS) ALTRET;
     1373       32
     1374       33                  This routine altreturns if an error is encountered.
     1375       34           PARAMETERS:
     1376       35                  DCBNUMBER - DCB number for the DCB on the M$READ/WRITE
     1377       36                  UBUF$ - User buffer address pulled from the FPT
PL6.E3A0      #003=KNA$USERIO File=KNA$APE.:E05TSI                               WED 07/30/97 00:58 Page:267  
     1378       37                  ERROR - Error code to be returned
     1379       38                  KNA_PARAMS - Structure passed by GFM$MCL for MCL info.
     1380       39                               This parameter is only used by KNA$USERIO.
     1381       40           INTERFACE:
     1382       41                  KNS$SESSION - To send messages on the network
     1383       42                  KNA$GETIOP - To get an I/O packet
     1384       43                  KNA$RLSIOP - To release an I/O packet
     1385       44                  GHS$REGUSER - REG a user on wait I/O situations
     1386       45                  KNA$OPEN - For a default OPEN on the passed DCB
     1387       46           ENVIRONMENT:
     1388       47             The KNA$USERIO routine is called from GFM$MCL, the MCL handler for
     1389       48             file management MCLs.  All the FPT parameters are available to
     1390       49             us in a structure.
     1391       50
     1392       51             The other entry points are called from any where in the monitor running
     1393       52             on behalf of a REGable user.  The DCB passed must be set up the
     1394       53             way that the monitor wishes.  The current use of these routines
     1395       54             is by job step to downline load fprgs and report an fprg
     1396       55             exit/abort condition.
     1397       56
     1398       57           DESCRIPTION:
     1399       58                  Entry from GFM$MCL results in all the user's FPT information
     1400       59             being stored away in AUTO.  Next (or if entry was not from GFM$MCL)
     1401       60             the DCB number passed is validated and a check is made to see if
     1402       61             we have to do a default OPEN.  The user's parameters are checked
     1403       62             to see if we have everything we need to do this operation, such
     1404       63             as keys, buffer, etc.  If this check succeeds then we do either
     1405       64             a READ or a WRITE.
     1406       65
     1407       66                  A WRITE operation causes us to make sure that the other
     1408       67             end of the network connection has given us throttling information
     1409       68             to allow us to send him the specified data.  If not, the user is
     1410       69             REGged until such time as that is the case.  The user's data is
     1411       70             merely passed along via a call to KNS$SESSION if we already have
     1412       71             enough throttling permission to send the data.
     1413       72
     1414       73                  A WRITENOW operation doesn't do flow control and causes a
PL6.E3A0      #003=KNA$USERIO File=KNA$APE.:E05TSI                               WED 07/30/97 00:58 Page:268  
     1415       74             Presentation function code to be put on the message which
     1416       75             directs this message to the other monitor (host).
     1417       76
     1418       77                  A READ operation causes the allocation of an IO packet for
     1419       78             keeping track of the user's buffer.  A message is sent via
     1420       79             Session to tell the guy at the other end of the network connection
     1421       80             that he can send some stuff over.  After this message is sent the
     1422       81             user is REGged until his data arrives.
     1423       82        */
     1424       83        %EJECT;
PL6.E3A0      #003=KNA$USERIO File=KNA$APE.:E05TSI                               WED 07/30/97 00:58 Page:269  
     1425       84        KNA$USERIO: PROC(DCBNUMBER,UBUF$,ERROR,KNA_PARAMS) ALTRET;

     84   1 000000  D380 0000 0000  xent KNA$USERIO      LNJ,B5   X6A_AUTO_N
          1 000003       0076 0004                       DC       118,4

     1426       85        %INCLUDE KNA_MACRO_M;
     1427      161        %INCLUDE KN_ERRORS_C;
     1428      225        %INCLUDE KI_ERRORS_C;
     1429      310        %INCLUDE KI_SUBS_C;
     1430      446        %INCLUDE GH_LCP6_M;
     1431     1280        %INCLUDE GH_SCHD_E;
     1432     1376        %INCLUDE GH_SCHD_M;
     1433     1520        %INCLUDE G_HJIT_M;
     1434     1665        %INCLUDE G_ROS_M;
     1435     1747        %INCLUDE G_JIT_M;
     1436     2012        %INCLUDE GH_GATE_M;
     1437     2053        %INCLUDE KN_DATA_M;
     1438     3839        %INCLUDE K_SCODE_C;
     1439     3924        %INCLUDE P_FEP_M;
     1440     4362        %INCLUDE KL_MACRO_C;
     1441     7714        %INCLUDE K_ID_E;
     1442     7764        %K#ENTID_E;
     1443     7783        %INCLUDE GU_LCP6_M;
     1444     8711        %INCLUDE GU_MACROS_M;
     1445     8870        %INCLUDE GF_LCP6_M;
     1446     9338        %INCLUDE G_LCP6_E;
     1447     9596        %GF_MCL_E;                              /* Get the MCL EQUs                   */
     1448     9606        %INCLUDE F_ERRORS_C;
     1449     9846        %INCLUDE UD_ERRORS_C;
     1450     9888        %INCLUDE GM_VIRTUAL_E;
     1451    10098        %INCLUDE KV$VDO;
     1452    11113        %INCLUDE K$RWPARM;
     1453    11499        /* We involke this so the VDH macros work */
     1454    11500        %KV_VDO_ALL_E;
     1455    11579
     1456    11580        /*     Parameters
     1457    11581        */
PL6.E3A0      #003=KNA$USERIO File=KNA$APE.:E05TSI                               WED 07/30/97 00:58 Page:270  
     1458    11582    1   DCL DCBNUMBER UBIN;
     1459    11583    1   DCL UBUF$ VECTOR;
     1460    11584        %VLP_ERRCODE (FPTN=ERROR,STCLASS="");
     1461    11630        %GUD_HAND_PARAMS (FPTN=KNA_PARAMS,STCLASS="");
     1462    11706
     1463    11707        /*     Static storage
     1464    11708        */
     1465    11709        %VLP_ERRCODE (STCLASS=CONSTANT, FCG=KN, MID=A, MON='1'B,
     1466    11710                      FPTN=ENWIO, ERR#=%E$NWIO, SEV=G_SEV_ERROR#);
     1467    11756        %VLP_ERRCODE (STCLASS=CONSTANT, FCG=KN, MID=A, MON='1'B,
     1468    11757                      FPTN=EDCBNUM, ERR#=%E$BADDCB#, SEV=G_SEV_ERROR#);
     1469    11803        %VLP_ERRCODE (STCLASS=CONSTANT, FCG=KN, MID=A, MON='1'B,
     1470    11804                      FPTN=EBADBUF, ERR#=%E$BADVECT2, SEV=G_SEV_ERROR#);
     1471    11850        %VLP_ERRCODE (STCLASS=CONSTANT, FCG=KN, MID=A, MON='1'B,
     1472    11851                      FPTN=ENO_IOP, ERR#=%E$NO_IOP, SEV=G_SEV_ERROR#);
     1473    11897        %VLP_ERRCODE (STCLASS=CONSTANT, FCG=KN, MID=A, MON='1'B,
     1474    11898                      FPTN=ESHORT_BUFFER, ERR#=%E$LD, SEV=G_SEV_CONT#);
     1475    11944        %VLP_ERRCODE (STCLASS=CONSTANT, FCG=KN, MID=A, MON='1'B,
     1476    11945                      FPTN=ENO_DAT, ERR#=%E$NODAT, SEV=G_SEV_CONT#);
     1477    11991        %VLP_ERRCODE (STCLASS=CONSTANT, FCG=KN, MID=A, MON='1'B,
     1478    11992                      FPTN=EBYD, ERR#=%E$BYD, SEV=G_SEV_CONT#);
     1479    12038        %VLP_ERRCODE (STCLASS=CONSTANT, FCG=KN, MID=A, MON='1'B,
     1480    12039                      FPTN=ELDSC, ERR#=%E$LDSC, SEV=G_SEV_ABORT#);
     1481    12085        %VLP_ERRCODE (STCLASS=CONSTANT, FCG=KN, MID=A, MON='1'B,
     1482    12086                      FPTN=EXTRA_READ, ERR#=%E$XTRARD, SEV=G_SEV_CONT#);
     1483    12132        %VLP_SCODE (FPTN=SC_IOP,ERR#=%S$IOP,SEV=G_SEV_SCREECH#,
     1484    12133                    STCLASS=CONSTANT,FCG=KN,MID=A,MON='1'B);
     1485    12194
     1486    12195        /*     AUTO storage
     1487    12196        */
     1488    12197    1   DCL MSGSIZE UBIN;
     1489    12198    1   DCL RESTYPE UBIN;
     1490    12199    1   DCL STR UBIN;                           /* Stream number                      */
     1491    12200    1   DCL PARMSPEC BIT(1);
     1492    12201    1   DCL USRFPT$ PTR;
     1493    12202    1   DCL KEY$ PTR;
     1494    12203    1   DCL KEYSZ UBIN;
PL6.E3A0      #003=KNA$USERIO File=KNA$APE.:E05TSI                               WED 07/30/97 00:58 Page:271  
     1495    12204    1   DCL LSTIOP$ PTR;
     1496    12205    1   DCL FPT_BUF$ VECTOR;
     1497    12206    1   DCL FPT_CODE UBIN;
     1498    12207    1   DCL DCB$ PTR;
     1499    12208    1   DCL SSN$ PTR;
     1500    12209    1   DCL IOP$ PTR;
     1501    12210    1   DCL ASDT_INDEX UBIN;
     1502    12211    1   DCL EVENT UBIN;
     1503    12212    1   DCL 1 TEMP,
     1504    12213    1         2 BYTE_OFF    BIT(1),
     1505    12214    1         2 *           BIT(11),
     1506    12215    1         2 V_WRD_ADDR  UBIN(20) UNAL;
     1507    12216    1   DCL TEMP_CPTR REDEF TEMP CPTR;
     1508    12217    1   DCL VA_ADDR UBIN(32);
     1509    12218    1   DCL FLOW_CONTROL BIT(1);
     1510    12219        %K$RWPARM (NAME=K$RWPARM,STCLASS=AUTO);
     1511    12535        %G$NWIO (FPTN=NWIO,STCLASS=AUTO,PARONLY=1);
     1512    12564    1   DCL ERR UBIN;
     1513    12565    1   DCL TCB_ERR BIT(32);
     1514    12566    1   DCL I SBIN;
     1515    12567    1   DCL FCN UBIN;
     1516    12568    1   DCL ROUTINE EPTR;
     1517    12569        %EJECT;
PL6.E3A0      #003=KNA$USERIO File=KNA$APE.:E05TSI                               WED 07/30/97 00:58 Page:272  
     1518    12570
     1519    12571        /*     BASED
     1520    12572        */
     1521    12573        %G$JIT (STCLASS="BASED(G$JIT$)");
     1522    12987        %M$DCB (DCBN=MYDCB,STCLASS="BASED(DCB$)");
     1523    13038        %G$ROS (FPTN=G$ROS,STCLASS="BASED(G$ROS$)");
     1524    13082        %G$UHJIT (FPTN=G$UHJIT,STCLASS="BASED(G$UHJIT$)");
     1525    16056        %G$MHJIT (FPTN=G$MHJIT,STCLASS="BASED(G$MHJIT$)");
     1526    22930        %G$ECCB(STCLASS=BASED);
     1527    23006        %KNA$SSN (FPTN=KNA$SSN,STCLASS="BASED(SSN$)");
     1528    23089        %G$USER (FPTN=G$U,STCLASS=BASED);
     1529    23100        %G$ASDT;
     1530    23129        %G$DCBTABLE;
     1531    23140        %KN$IOP (NAME=KN$IOP,STCLASS="BASED(IOP$)");
     1532    23313        %G$ASDT_MCL (STCLASS="BASED(G$ASDT_MCL$)");
     1533    24007        %FPT_READ(VECTORS=NO,STCLASS="BASED(USRFPT$)");
     1534    24033        %FPT_WRITE(VECTORS=NO,STCLASS="BASED(USRFPT$)");
     1535    24057    1   DCL B$WORD UBIN BASED ALIGNED;
     1536    24058        %VLP_CG (STCLASS=BASED);
     1537    24078    1   DCL VFC CHAR(1) BASED UNAL;
     1538    24079
     1539    24080        /*     Useful External Pointers and Symrefs
     1540    24081        */
     1541    24082    1   DCL G$JIT$ PTR SYMREF READONLY;
     1542    24083    1   DCL G$ROS$ PTR SYMREF;
     1543    24084    1   DCL G$UHJIT$ PTR SYMREF;
     1544    24085    1   DCL G$MHJIT$ PTR SYMREF;
     1545    24086    1   DCL G$ASDT_MCL$ PTR SYMREF;
     1546    24087        %GATE(FPTN=KNA_LNKIOP,STCLASS=SYMREF);
     1547    24106        %GATE (FPTN=KNA_LNKSSN,STCLASS=SYMREF);
     1548    24125        %K$RWPARM (NAME=KNA_RWPARM_CON,STCLASS=SYMREF);
     1549    24441        %PS_LCP6STT (STCLASS=SYMREF);
     1550    24945
     1551    24946        /*     ENTRY definitions
     1552    24947        */
     1553    24948    1   DCL SCREECH ENTRY(1);
     1554    24949    1   DCL GHS$EVENT ENTRY(7);
PL6.E3A0      #003=KNA$USERIO File=KNA$APE.:E05TSI                               WED 07/30/97 00:58 Page:273  
     1555    24950    1   DCL KNA$FCNOU ENTRY(4) ALTRET;
     1556    24951    1   DCL KNA$FCNO ENTRY(4) ALTRET;
     1557    24952    1   DCL KNA$OPEN ENTRY(4) ALTRET;
     1558    24953    1   DCL KNA$GETIOP ENTRY(1) ALTRET;
     1559    24954    1   DCL KNA$RLSIOP ENTRY(1) ALTRET;
     1560    24955    1   DCL KNA$REG_USER ENTRY(2) ALTRET;
     1561    24956    1   DCL KNA$SAVEMAP ENTRY(2);
     1562    24957        %EJECT;
PL6.E3A0      #003=KNA$USERIO File=KNA$APE.:E05TSI                               WED 07/30/97 00:58 Page:274  
     1563    24958        /*
     1564    24959               This is where the procedure KNA$USERIO begins.  Parameters from
     1565    24960        the FPT are merely moved into local storage and then we go off to the
     1566    24961        mainline code.
     1567    24962        */
     1568    24963    1      VBASE(FPT_BUF$) = KNA_PARAMS.CPTRS.PAR3$;

  24963   1 000005  ECC7 000A                            LDB,B6   @KNA_PARAMS,AUTO
          1 000007  8CC6 000A                            LDI      10,B6
          1 000009  8D47 0018                            SDI      FPT_BUF$+1,AUTO

     1569    24964    1      VBOUND(FPT_BUF$) = KNA_PARAMS.BND.PAR3;

  24964   1 00000B  D846 0028                            LDR,R5   40,B6
          1 00000D  DF47 0017                            STR,R5   FPT_BUF$,AUTO

     1570    24965    1      KEY$ = KNA_PARAMS.PTRS.PAR2$;

  24965   1 00000F  DCC6 0008                            LDB,B5   8,B6
          1 000011  DFC7 0012                            STB,B5   KEY$,AUTO

     1571    24966    1      KEYSZ = KNA_PARAMS.BND.PAR2 + 1;

  24966   1 000013  C846 0027                            LDR,R4   39,B6
          1 000015  4E01                                 ADV,R4   1
          1 000016  CF47 0014                            STR,R4   KEYSZ,AUTO

     1572    24967    1      FPT_CODE = KNA_PARAMS.MCL.CODE;

  24967   1 000018  B806                                 LDR,R3   ,B6
          1 000019  B570 03FF                            AND,R3   1023,IMO
          1 00001B  BF47 001A                            STR,R3   FPT_CODE,AUTO

     1573    24968    1      USRFPT$=KNA_PARAMS.PTRS.PAR1$;

  24968   1 00001D  CCC6 0006                            LDB,B4   6,B6
          1 00001F  CFC7 0010                            STB,B4   USRFPT$,AUTO
PL6.E3A0      #003=KNA$USERIO File=KNA$APE.:E05TSI                               WED 07/30/97 00:58 Page:275  

     1574    24969    1      PARMSPEC = '1'B;

  24969   1 000021  8947 000F                            LBT,'8000'X       PARMSPEC,AUTO
  24969   1 000023       8000

     1575    24970    1      FLOW_CONTROL = '1'B;

  24970   1 000024  8947 0027                            LBT,'8000'X       FLOW_CONTROL,AUTO
  24970   1 000026       8000

     1576    24971
     1577    24972    1      IF G$UHJIT.DMN.ID = %G_DMN_DB# OR G$UHJIT.DMN.ID = %G_DMN_DB_SVC#

  24972   1 000027  BC80 0000 0000  xsym                 LDB,B3   G$UHJIT$
          1 00002A  A843 007E                            LDR,R2   126,B3
          1 00002C  2D05                                 CMV,R2   5
          1 00002D  0901 0004                            BE       s:24973,PREL
          1 00002F  2D01                                 CMV,R2   1
          1 000030  0981 0006                            BNE      s:24974,PREL

     1578    24973    1      THEN STR = KIDM_DB;

  24973   1 000032  1C03                                 LDV,R1   3
          1 000033  9F47 000E                            STR,R1   STR,AUTO
          1 000035  0F81 0004                            B        s:24976,PREL

     1579    24974    1      ELSE STR = KIDM_USER;

  24974   1 000037  1C02                                 LDV,R1   2
          1 000038  9F47 000E                            STR,R1   STR,AUTO

     1580    24975
     1581    24976    1      GOTO MAINSTREAM;

  24976   1 00003A  0F81 003A                            B        s:25005,PREL

PL6.E3A0      #003=KNA$USERIO File=KNA$APE.:E05TSI                               WED 07/30/97 00:58 Page:276  
     1582    24977
     1583    24978    1   KNA$READ: ENTRY (DCBNUMBER,UBUF$,ERROR,KNA_PARAMS) ALTRET;

  24978   1 00003C  D380 0000 0000  xent KNA$READ        LNJ,B5   X6A_AUTO_N
          1 00003F       0076 0004                       DC       118,4

     1584    24979    1      FPT_CODE = %G_MCL_READ#;

  24979   1 000041  E870 0142                            LDR,R6   322,IMO
          1 000043  EF47 001A                            STR,R6   FPT_CODE,AUTO

     1585    24980    1      GOTO SETUP_MON;

  24980   1 000045  0F81 0016                            B        s:24991,PREL

     1586    24981
     1587    24982    1   KNA$WRITE: ENTRY (DCBNUMBER,UBUF$,ERROR,KNA_PARAMS) ALTRET;

  24982   1 000047  D380 0000 0000  xent KNA$WRITE       LNJ,B5   X6A_AUTO_N
          1 00004A       0076 0004                       DC       118,4

     1588    24983    1      FLOW_CONTROL = '1'B;

  24983   1 00004C  8947 0027                            LBT,'8000'X       FLOW_CONTROL,AUTO
  24983   1 00004E       8000

     1589    24984    1      GOTO SETUP_MON_WRITE;

  24984   1 00004F  0F81 0008                            B        s:24988,PREL

     1590    24985
     1591    24986    1   KNA$WRITE_NOW: ENTRY (DCBNUMBER,UBUF$,ERROR,KNA_PARAMS) ALTRET;

  24986   1 000051  D380 0000 0000  xent KNA$WRITE_NOW   LNJ,B5   X6A_AUTO_N
          1 000054       0076 0004                       DC       118,4

     1592    24987
PL6.E3A0      #003=KNA$USERIO File=KNA$APE.:E05TSI                               WED 07/30/97 00:58 Page:277  
     1593    24988    1      FLOW_CONTROL = '0'B;

  24988   1 000056  8747 0027                            CL       FLOW_CONTROL,AUTO

  24988   1                              SETUP_MON_WRITE null
     1594    24989
     1595    24990    1   SETUP_MON_WRITE: ;
     1596    24991    1      FPT_CODE = %G_MCL_WRITE#;

  24991   1 000058  E870 0143            SETUP_MON_WRITE LDR,R6   323,IMO
          1 00005A  EF47 001A                            STR,R6   FPT_CODE,AUTO

  24991   1                              SETUP_MON       null
     1597    24992
     1598    24993    1   SETUP_MON: ;
     1599    24994    1      FPT_BUF$ = UBUF$;

  24994   1 00005C  ACC7 0006            SETUP_MON       LDB,B2   @UBUF$,AUTO
          1 00005E  2C00                                 LDV,R2   0
          1 00005F  6C06                                 LDV,R6   6
          1 000060  BB87                                 LAB,B3   ,AUTO
          1 000061  3C2E                                 LDV,R3   46
          1 000062  0008                                 MMM

     1600    24995    1      USRFPT$=ADDR(KNA_PARAMS);

  24995   1 000063  ECC7 000A                            LDB,B6   @KNA_PARAMS,AUTO
          1 000065  EFC7 0010                            STB,B6   USRFPT$,AUTO

     1601    24996    1      PARMSPEC = '0'B;

  24996   1 000067  8747 000F                            CL       PARMSPEC,AUTO

     1602    24997    1      STR = KIDM_MON;

  24997   1 000069  6C7F                                 LDV,R6   127
          1 00006A  EF47 000E                            STR,R6   STR,AUTO
PL6.E3A0      #003=KNA$USERIO File=KNA$APE.:E05TSI                               WED 07/30/97 00:58 Page:278  

     1603    24998    1      KEY$ = ADDR(NIL);

  24998   1 00006C  DB80 0000 0000                       LAB,B5   0
          1 00006F  DFC7 0012                            STB,B5   KEY$,AUTO

     1604    24999    1      KEYSZ = 0;

  24999   1 000071  8747 0014                            CL       KEYSZ,AUTO

     1605    25000    1      GOTO MAINSTREAM;

  25000   1 000073  0F81 0001                            B        s:25005,PREL

     1606    25001
     1607    25002        /* Now we must do some validity checks.
     1608    25003        */
     1609    25004    1   MAINSTREAM:
     1610    25005    1      ERROR = '0'B;

  25005   1 000075  CCC7 0008            MAINSTREAM      LDB,B4   @ERROR,AUTO
          1 000077  8704                                 CL       ,B4
          1 000078  8744 0001                            CL       1,B4

     1611    25006    1      IF DCBNUMBER > G$ROS.NUMDCBS OR DCBNUMBER = 0

  25006   1 00007A  BCC7 0004                            LDB,B3   @DCBNUMBER,AUTO
          1 00007C  AC80 0000 0000  xsym                 LDB,B2   G$ROS$
          1 00007F  E803                                 LDR,R6   ,B3
          1 000080  E942 0014                            CMR,R6   20,B2
          1 000082  0301 0003                            BG       s:25008,PREL
          1 000084  6981 0008                            BNEZ,R6  s:25015,PREL

     1612    25007    2      THEN DO;

     1613    25008    2           ERROR = EDCBNUM;

PL6.E3A0      #003=KNA$USERIO File=KNA$APE.:E05TSI                               WED 07/30/97 00:58 Page:279  
  25008   1 000086  8C80 0000 0002  00                   LDI      EDCBNUM
          1 000089  8D04                                 SDI      ,B4

     1614    25009    2           ALTRETURN;

  25009   1 00008A  C380 0000 0000  xent                 LNJ,B4   X6A_AALT

     1615    25010    2           END;
     1616    25011        /*E* ERROR: KNA-E$BADDCB#
     1617    25012             MESSAGE: An invalid DCB has been passed
     1618    25013        */
     1619    25014
     1620    25015    1      IF USRFPT$~=ADDR(NIL) AND FPT_CODE=%G_MCL_READ#

  25015   1 00008D  8DC7 0010                            CMN      USRFPT$,AUTO
          1 00008F  0901 001D                            BE       s:25041,PREL
          1 000091  D847 001A                            LDR,R5   FPT_CODE,AUTO
          1 000093  D970 0142                            CMR,R5   322,IMO
          1 000095  0981 0017                            BNE      s:25041,PREL

     1621    25016    1      THEN
     1622    25017    1           IF VBASE(FPT_BUF$)=ADDR(NIL)

  25017   1 000097  8DC7 0018                            CMN      FPT_BUF$+1,AUTO
          1 000099  0901 000C                            BE       s:25020,PREL
          1 00009B  9CC7 0010                            LDB,B1   USRFPT$,AUTO
          1 00009D  8281                                 LB,'0004'X        ,B1
          1 00009E       0004
          1 00009F  0581 000D                            BBF      s:25041,PREL
          1 0000A1  C847 0017                            LDR,R4   FPT_BUF$,AUTO
          1 0000A3  4D7F                                 CMV,R4   127
          1 0000A4  0281 0008                            BGE      s:25041,PREL

     1623    25018    1             OR FPT_READ.V.READMLT AND VBOUND(FPT_BUF$)<127
     1624    25019    2           THEN DO;

     1625    25020    2                ERROR = EBADBUF;
PL6.E3A0      #003=KNA$USERIO File=KNA$APE.:E05TSI                               WED 07/30/97 00:58 Page:280  

  25020   1 0000A6  8C80 0000 0004  00                   LDI      EBADBUF
          1 0000A9  8D04                                 SDI      ,B4

     1626    25021    2                ALTRETURN;

  25021   1 0000AA  C380 0000 0000  xent                 LNJ,B4   X6A_AALT

     1627    25022    2                END;
     1628    25023        /*E* ERROR: KNA-E$BADVECT2
     1629    25024             MESSAGE: An invalid buffer vector was specified
     1630    25025             MESSAGE1: M$READ specified BUF=NIL
     1631    25026                       or M$READ with READMLT specified BUF < 256 bytes.
     1632    25027        */
     1633    25028
     1634    25029        /*N*  READ/WRITE - Many more validity checks need to be made depending
     1635    25030        upon options in the DCB.  Also many more things will be passed on the
     1636    25031        FPT.  A good way of resolving the flavor of DCB we have and the validity
     1637    25032        of things passed on READ/WRITE FPTs (for instance, no buffer vector
     1638    25033        could actually be legal) has yet to be resolved.  A better understanding
     1639    25034        of what ORGS vs. ACCESSes vs. ASNs vs. FPT parameters needed by the
     1640    25035        users has to be developed first.
     1641    25036        */
     1642    25037
     1643    25038        /*     If the DCB passed to us is not OPEN then we will attempt a
     1644    25039        default OPEN.
     1645    25040        */
     1646    25041    1      DCB$ = G$ROS.DCBPTR$ -> G$DCBTABLE(DCBNUMBER);

  25041   1 0000AD  9C82                                 LDB,B1   ,B2
          1 0000AE  B856                                 LDR,R3   R6
          1 0000AF  ECB1                                 LDB,B6   ,B1,R3
          1 0000B0  EFC7 001B                            STB,B6   DCB$,AUTO

     1647    25042    1      IF MYDCB.FCD = '0'B

  25042   1 0000B2  82C6 001F                            LB,'4000'X        31,B6
PL6.E3A0      #003=KNA$USERIO File=KNA$APE.:E05TSI                               WED 07/30/97 00:58 Page:281  
  25042   1 0000B4       4000
          1 0000B5  0501 0021                            BBT      s:25057,PREL

     1648    25043    2      THEN DO;

     1649    25044    2           MYDCB.ORG = %G_ORG_CONSEC#;

  25044   1 0000B7  5C01                                 LDV,R5   1
          1 0000B8  DAC6 001F                            SRM,R5,'00FF'X    31,B6
          1 0000BA       00FF

     1650    25045    2           CALL KNA$OPEN(DCBNUMBER,ERROR) ALTRET(CANT_OPEN);

  25045   1 0000BB  CFC7 006C                            STB,B4   ROUTINE+6,AUTO
          1 0000BD  BFC7 006A                            STB,B3   ROUTINE+4,AUTO
          1 0000BF  BBC7 006A                            LAB,B3   ROUTINE+4,AUTO
          1 0000C1  CBF0 0200                            LAB,B4   512,IMO
          1 0000C3  E380 0000 0000  xent                 LNJ,B6   KNA$OPEN
          1 0000C6       000E                            DC       s:25047,PREL

     1651    25046    2           IF ERROR ~= '0'B

  25046   1 0000C7  ECC7 0008                            LDB,B6   @ERROR,AUTO
          1 0000C9  DB80 0000 0000  02                   LAB,B5   0
          1 0000CC  5C01                                 LDV,R5   1
          1 0000CD  0022                                 ACM      ;
          1 0000CE       4406 0000                                ALPHANUM(0,B6,,4,FILL),;
          1 0000D0       4005 0000                                ALPHANUM(0,B5,,R5,FILL)
          1 0000D2  5381 0004                            CBE      s:25057,PREL

     1652    25047    3           THEN DO;

     1653    25048    3   CANT_OPEN:   ALTRETURN;

  25048   1 0000D4  C380 0000 0000  xent CANT_OPEN       LNJ,B4   X6A_AALT

     1654    25049    3                END;
PL6.E3A0      #003=KNA$USERIO File=KNA$APE.:E05TSI                               WED 07/30/97 00:58 Page:282  
     1655    25050    2           END;
     1656    25051         %EJECT;
PL6.E3A0      #003=KNA$USERIO File=KNA$APE.:E05TSI                               WED 07/30/97 00:58 Page:283  
     1657    25052           %LOCK (G=KNA_LNKSSN);

  25057   1 0000D7  BB80 0000 0001  02                   LAB,B3   +1
          1 0000DA  CBF0 0100                            LAB,B4   256,IMO
          1 0000DC  E380 0000 0000  xent                 LNJ,B6   GHH$LOCK
          1 0000DF       0001                            DC       s:25059,PREL

     1658    25059    1      SSN$ = MYDCB.SSN$;

  25059   1 0000E0  ECC7 001B                            LDB,B6   DCB$,AUTO
          1 0000E2  DCC6 0030                            LDB,B5   48,B6
          1 0000E4  DFC7 001D                            STB,B5   SSN$,AUTO

     1659    25060
     1660    25061    1      IF KNA$SSN.FLAGS.MRKPND

  25061   1 0000E6  8285                                 LB,'0080'X        ,B5
  25061   1 0000E7       0080
          1 0000E8  0581 0004                            BBF      s:25065,PREL

     1661    25062    1      THEN
     1662    25063    1           CALL SEND_MARKER;

  25063   1 0000EA  E3C0 05DA                            LNJ,B6   s:0,PREL
          1 0000EC       0001                            DC       s:25065,PREL

     1663    25064
     1664    25065    1      IF KNA$SSN.STATE ~= %KNA_STATE_ACTIVE#

  25065   1 0000ED  ECC7 001D                            LDB,B6   SSN$,AUTO
          1 0000EF  E846 0013                            LDR,R6   19,B6
          1 0000F1  6D03                                 CMV,R6   3
          1 0000F2  0901 0009                            BE       s:25075,PREL

     1665    25066    2      THEN DO;

     1666    25067    2           ERROR = ELDSC;
PL6.E3A0      #003=KNA$USERIO File=KNA$APE.:E05TSI                               WED 07/30/97 00:58 Page:284  

  25067   1 0000F4  8C80 0000 000E  00                   LDI      ELDSC
          1 0000F7  DCC7 0008                            LDB,B5   @ERROR,AUTO
          1 0000F9  8D05                                 SDI      ,B5

     1667    25068    2           GOTO FINISHED;

  25068   1 0000FA  0F81 0573                            B        s:25450,PREL

     1668    25069    2           END;
     1669    25070        /*E* ERROR: KNA-%E$LDSC
     1670    25071             MESSAGE: Disconnect received from endpoint.
     1671    25072             MESSAGE1: The other endpoint is disconnecting.
     1672    25073        */
     1673    25074
     1674    25075    1      MYDCB.TYC = '0'B;

  25075   1 0000FC  DCC7 001B                            LDB,B5   DCB$,AUTO
          1 0000FE  8745 0001                            CL       1,B5

     1675    25076    1      IF STR = KIDM_USER

  25076   1 000100  E847 000E                            LDR,R6   STR,AUTO
          1 000102  6D02                                 CMV,R6   2
          1 000103  0981 0009                            BNE      s:25079,PREL

     1676    25077    1      THEN STR = MYDCB.STRM;

  25077   1 000105  ECC7 001B                            LDB,B6   DCB$,AUTO
          1 000107  E846 0002                            LDR,R6   2,B6
          1 000109  E570 00FF                            AND,R6   255,IMO
          1 00010B  EF47 000E                            STR,R6   STR,AUTO

     1677    25078
     1678    25079    1      K$RWPARM = KNA_RWPARM_CON;

  25079   1 00010D  AB80 0000 0000  xsym                 LAB,B2   KNA_RWPARM_CON
PL6.E3A0      #003=KNA$USERIO File=KNA$APE.:E05TSI                               WED 07/30/97 00:58 Page:285  
          1 000110  2C00                                 LDV,R2   0
          1 000111  6C52                                 LDV,R6   82
          1 000112  BB87                                 LAB,B3   ,AUTO
          1 000113  3C50                                 LDV,R3   80
          1 000114  0008                                 MMM

     1679    25080
     1680    25081    1      IF PARMSPEC AND KNA_PARAMS.PTRS.PAR4$ ~= ADDR(NIL)

  25081   1 000115  89C7 000F                            CMZ      PARMSPEC,AUTO
          1 000117  0881 001D                            BAGE     s:25091,PREL
          1 000119  ECC7 000A                            LDB,B6   @KNA_PARAMS,AUTO
          1 00011B  8DC6 000C                            CMN      12,B6
          1 00011D  0901 0017                            BE       s:25091,PREL

     1681    25082    2      THEN DO;

     1682    25083    2           K$RWPARM.STATION = KNA_PARAMS.PTRS.PAR4$->VLP_CG.STATION#;

  25083   1 00011F  DCC6 000C                            LDB,B5   12,B6
          1 000121  AB85                                 LAB,B2   ,B5
          1 000122  2C00                                 LDV,R2   0
          1 000123  6C08                                 LDV,R6   8
          1 000124  BB87                                 LAB,B3   ,AUTO
          1 000125  3C56                                 LDV,R3   86
          1 000126  0008                                 MMM

     1683    25084    2           K$RWPARM.MSGTYP = KNA_PARAMS.PTRS.PAR4$->VLP_CG.MSGTYP#;

  25084   1 000127  CCC6 000C                            LDB,B4   12,B6
          1 000129  AB84                                 LAB,B2   ,B4
          1 00012A  2C08                                 LDV,R2   8
          1 00012B  6C08                                 LDV,R6   8
          1 00012C  BB87                                 LAB,B3   ,AUTO
          1 00012D  3C5E                                 LDV,R3   94
          1 00012E  0008                                 MMM

PL6.E3A0      #003=KNA$USERIO File=KNA$APE.:E05TSI                               WED 07/30/97 00:58 Page:286  
     1684    25085    2           K$RWPARM.MSGID = KNA_PARAMS.PTRS.PAR4$->VLP_CG.MSGID#;

  25085   1 00012F  9CC6 000C                            LDB,B1   12,B6
          1 000131  8CC1 0009                            LDI      9,B1
          1 000133  8D47 0039                            SDI      K$RWPARM+17,AUTO

     1685    25086    2           END;

     1686    25087
     1687    25088
     1688    25089        %EJECT;
PL6.E3A0      #003=KNA$USERIO File=KNA$APE.:E05TSI                               WED 07/30/97 00:58 Page:287  
     1689    25090
     1690    25091    1      RESTYPE = MYDCB.DDEV.RES;

  25091   1 000135  ECC7 001B                            LDB,B6   DCB$,AUTO
          1 000137  E846 0003                            LDR,R6   3,B6
          1 000139  E570 0007                            AND,R6   7,IMO
          1 00013B  EF47 000D                            STR,R6   RESTYPE,AUTO

     1691    25092    1      IF VBASE(FPT_BUF$) = ADDR(NIL)

  25092   1 00013D  8DC7 0018                            CMN      FPT_BUF$+1,AUTO
          1 00013F  0981 0005                            BNE      s:25096,PREL

     1692    25093    1      THEN
     1693    25094    1           MSGSIZE = 0;

  25094   1 000141  8747 000C                            CL       MSGSIZE,AUTO
          1 000143  0F81 0006                            B        s:25099,PREL

     1694    25095    1      ELSE
     1695    25096    1           MSGSIZE = VBOUND(FPT_BUF$)+1;

  25096   1 000145  D847 0017                            LDR,R5   FPT_BUF$,AUTO
          1 000147  5E01                                 ADV,R5   1
          1 000148  DF47 000C                            STR,R5   MSGSIZE,AUTO

     1696    25097        /*     Now do either the WRITE or the READ
     1697    25098        */
     1698    25099    1      IF FPT_CODE = %G_MCL_WRITE#

  25099   1 00014A  D847 001A                            LDR,R5   FPT_CODE,AUTO
          1 00014C  D970 0143                            CMR,R5   323,IMO
          1 00014E  0981 0298                            BNE      s:25291,PREL

     1699    25100    2      THEN DO;

     1700    25101
PL6.E3A0      #003=KNA$USERIO File=KNA$APE.:E05TSI                               WED 07/30/97 00:58 Page:288  
     1701    25102        /* Stay in this loop until we get to send the data out to Session
     1702    25103        */
     1703    25104    3   WRITELOOP: DO WHILE('1'B);

  25104   1                              WRITELOOP       null
     1704    25105    3                IF USRFPT$ ~= ADDR(NIL)

  25105   1 000150  8DC7 0010            WRITELOOP       CMN      USRFPT$,AUTO
          1 000152  0901 0009                            BE       s:25108,PREL

     1705    25106    3                THEN K$RWPARM.DVE.DVBYTE = FPT_WRITE.V.DVBYTE;

  25106   1 000154  ECC7 0010                            LDB,B6   USRFPT$,AUTO
          1 000156  E2C6 0002                            LLH,R6   2,B6
          1 000158  6008                                 SOL,R6   8
          1 000159  6048                                 SOR,R6   8
          1 00015A  E7C7 0037                            STH,R6   K$RWPARM+15,AUTO

     1706    25107
     1707    25108    3                IF K$RWPARM.DVE.DVBYTE.NODAT

  25108   1 00015C  82C7 0037                            LB,'0400'X        K$RWPARM+15,AUTO
  25108   1 00015E       0400
          1 00015F  0581 0008                            BBF      s:25110,PREL

     1708    25109    3                THEN ROUTINE = ENTADDR(KNA$FCNO);

  25109   1 000161  EB80 0000 0000  xent                 LAB,B6   KNA$FCNO
          1 000164  EFC7 0066                            STB,B6   ROUTINE,AUTO
          1 000166  0F81 0006                            B        s:25113,PREL

     1709    25110    3                ELSE ROUTINE = ENTADDR(KNA$FCNOU);

  25110   1 000168  EB80 0000 0000  xent                 LAB,B6   KNA$FCNOU
          1 00016B  EFC7 0066                            STB,B6   ROUTINE,AUTO

     1710    25111
PL6.E3A0      #003=KNA$USERIO File=KNA$APE.:E05TSI                               WED 07/30/97 00:58 Page:289  
     1711    25112        /* Check to see if the other end only wants to receive part of the message */
     1712    25113    3                IF FLOW_CONTROL AND KNA$SSN.THRTLVL.MAXRCRBYTSIZ < MSGSIZE

  25113   1 00016D  89C7 0027                            CMZ      FLOW_CONTROL,AUTO
          1 00016F  0881 002B                            BAGE     s:25125,PREL
          1 000171  DCC7 001D                            LDB,B5   SSN$,AUTO
          1 000173  E845 0009                            LDR,R6   9,B5
          1 000175  E947 000C                            CMR,R6   MSGSIZE,AUTO
          1 000177  0281 0023                            BGE      s:25125,PREL
          1 000179  D845 0008                            LDR,R5   8,B5
          1 00017B  5D01                                 CMV,R5   1
          1 00017C  0201 001E                            BL       s:25125,PREL
          1 00017E  8285                                 LB,'0100'X        ,B5
          1 00017F       0100
          1 000180  0581 0006                            BBF      s:25113+26,PREL
          1 000182  C847 000E                            LDR,R4   STR,AUTO
          1 000184  4D7F                                 CMV,R4   127
          1 000185  0981 000B                            BNE      s:25119,PREL
          1 000187  C847 000E                            LDR,R4   STR,AUTO
          1 000189  C945 000A                            CMR,R4   10,B5
          1 00018B  0901 0005                            BE       s:25119,PREL
          1 00018D  B845 000A                            LDR,R3   10,B5
          1 00018F  3981 000B                            BNEZ,R3  s:25125,PREL

     1713    25114    3                  AND KNA$SSN.THRTLVL.MAXNMBRCR >= 1
     1714    25115    3                  AND (KNA$SSN.FLAGS.MULT_STR AND STR~=KIDM_MON
     1715    25116    3                  OR STR = KNA$SSN.THRTLVL.STR
     1716    25117    3                  OR KNA$SSN.THRTLVL.STR = 0)
     1717    25118    4                THEN DO;

     1718    25119    4                     IF KNA$SSN.THRTLVL.MAXRCRBYTSIZ = 0 THEN

  25119   1 000191  6901 04DC                            BEZ,R6   s:25450,PREL

     1719    25120    4                          GOTO FINISHED;   /* Outputdiscard says "send nothing"  */
     1720    25121    4                     MSGSIZE = KNA$SSN.THRTLVL.MAXRCRBYTSIZ;

PL6.E3A0      #003=KNA$USERIO File=KNA$APE.:E05TSI                               WED 07/30/97 00:58 Page:290  
  25121   1 000193  EF47 000C                            STR,R6   MSGSIZE,AUTO

     1721    25122    4                     ERROR = ESHORT_BUFFER;

  25122   1 000195  8C80 0000 0008  00                   LDI      ESHORT_BUFFER
          1 000198  CCC7 0008                            LDB,B4   @ERROR,AUTO
          1 00019A  8D04                                 SDI      ,B4

     1722    25123    4                     END;

     1723    25124        /* If RRR we want an end ack back */
     1724    25125    3                IF K$RWPARM.DVE.DVBYTE.RRR

  25125   1 00019B  82C7 0037                            LB,'0800'X        K$RWPARM+15,AUTO
  25125   1 00019D       0800
          1 00019E  0581 0004                            BBF      s:25130,PREL

     1725    25126    3                THEN K$RWPARM.MRKTYP = %KV_VDOMRKTYP_ENDACK;

  25126   1 0001A0  6C01                                 LDV,R6   1
          1 0001A1  E7C7 0045                            STH,R6   K$RWPARM+29,AUTO

     1726    25127
     1727    25128        /* Check the throttling values to see if we can send the data now.
     1728    25129        */
     1729    25130    3                IF FLOW_CONTROL = '0'B OR

  25130   1 0001A3  89C7 0027                            CMZ      FLOW_CONTROL,AUTO
          1 0001A5  0881 0021                            BAGE     s:25136,PREL
          1 0001A7  DCC7 001D                            LDB,B5   SSN$,AUTO
          1 0001A9  E845 0008                            LDR,R6   8,B5
          1 0001AB  6D01                                 CMV,R6   1
          1 0001AC  0201 00CC                            BL       s:25188,PREL
          1 0001AE  D845 0007                            LDR,R5   7,B5
          1 0001B0  D947 000C                            CMR,R5   MSGSIZE,AUTO
          1 0001B2  0201 00C6                            BL       s:25188,PREL
          1 0001B4  8285                                 LB,'0100'X        ,B5
PL6.E3A0      #003=KNA$USERIO File=KNA$APE.:E05TSI                               WED 07/30/97 00:58 Page:291  
          1 0001B5       0100
          1 0001B6  0581 0006                            BBF      s:25130+26,PREL
          1 0001B8  C847 000E                            LDR,R4   STR,AUTO
          1 0001BA  4D7F                                 CMV,R4   127
          1 0001BB  0981 000B                            BNE      s:25136,PREL
          1 0001BD  C847 000E                            LDR,R4   STR,AUTO
          1 0001BF  C945 000A                            CMR,R4   10,B5
          1 0001C1  0901 0005                            BE       s:25136,PREL
          1 0001C3  B845 000A                            LDR,R3   10,B5
          1 0001C5  3981 00B3                            BNEZ,R3  s:25188,PREL

     1730    25131    3                  KNA$SSN.THRTLVL.MAXNMBRCR >=1 AND KNA$SSN.THRTLVL.MAXNMBBYT >=
             25131                           MSGSIZE
     1731    25132    3                  AND (KNA$SSN.FLAGS.MULT_STR AND STR~=KIDM_MON
     1732    25133    3                  OR STR = KNA$SSN.THRTLVL.STR
     1733    25134    3                  OR KNA$SSN.THRTLVL.STR = 0)
     1734    25135    4                THEN DO;

     1735    25136    4                     KNA$SSN.FLAGS.BLOCKED = '0'B;

  25136   1 0001C7  DCC7 001D                            LDB,B5   SSN$,AUTO
          1 0001C9  8805                                 LBF,'4000'X       ,B5
          1 0001CA       4000

     1736    25137    4                     IF FLOW_CONTROL

  25137   1 0001CB  89C7 0027                            CMZ      FLOW_CONTROL,AUTO
          1 0001CD  0881 0006                            BAGE     s:25139,PREL

     1737    25138    4                     THEN FCN = %KV_VDO_FNC_DAT;

  25138   1 0001CF  6C05                                 LDV,R6   5
          1 0001D0  EF47 0065                            STR,R6   FCN,AUTO
          1 0001D2  0F81 0004                            B        s:25141,PREL

     1738    25139    4                     ELSE FCN = %KV_VDO_FNC_DAT_IMD;

PL6.E3A0      #003=KNA$USERIO File=KNA$APE.:E05TSI                               WED 07/30/97 00:58 Page:292  
  25139   1 0001D4  6C06                                 LDV,R6   6
          1 0001D5  EF47 0065                            STR,R6   FCN,AUTO

     1739    25140
     1740    25141    4                     K$RWPARM.STR = STR;

  25141   1 0001D7  D847 000E                            LDR,R5   STR,AUTO
          1 0001D9  DAC7 0045                            SRM,R5,'00FF'X    K$RWPARM+29,AUTO
          1 0001DB       00FF

     1741    25142    4                     K$RWPARM.MSGSZ = MSGSIZE;

  25142   1 0001DC  C847 000C                            LDR,R4   MSGSIZE,AUTO
          1 0001DE  CF47 002A                            STR,R4   K$RWPARM+2,AUTO

     1742    25143
     1743    25144    4                     K$RWPARM.MSGC$ = VBASE(FPT_BUF$);

  25144   1 0001E0  8CC7 0018                            LDI      FPT_BUF$+1,AUTO
          1 0001E2  8D47 0028                            SDI      K$RWPARM,AUTO

     1744    25145    4                     IF K$RWPARM.DVE.DVBYTE.VFC

  25145   1 0001E4  82C7 0037                            LB,'4000'X        K$RWPARM+15,AUTO
  25145   1 0001E6       4000
          1 0001E7  0581 001A                            BBF      s:25151,PREL

     1745    25146    5                     THEN DO;

     1746    25147    5                          K$RWPARM.DVE.VFC = K$RWPARM.MSGC$->VFC;

  25147   1 0001E9  B856                                 LDR,R3   R6
          1 0001EA  E570 7FFF                            AND,R6   32767,IMO
          1 0001EC  8D47 006A                            SDI      ROUTINE+4,AUTO
          1 0001EE  DCC7 006A                            LDB,B5   ROUTINE+4,AUTO
          1 0001F0  304F                                 SOR,R3   15
          1 0001F1  A0B5                                 LDH,R2   ,B5,R3
PL6.E3A0      #003=KNA$USERIO File=KNA$APE.:E05TSI                               WED 07/30/97 00:58 Page:293  
          1 0001F2  AAC7 0037                            SRM,R2,'00FF'X    K$RWPARM+15,AUTO
          1 0001F4       00FF

     1747    25148    5                          K$RWPARM.MSGC$ = PINCRC (K$RWPARM.MSGC$,1);

  25148   1 0001F5  8CC7 0028                            LDI      K$RWPARM,AUTO
          1 0001F7  7031                                 DCL,R7   1
          1 0001F8  8470 0000 0001                       AID      1,IMO
          1 0001FB  7071                                 DCR,R7   1
          1 0001FC  8D47 0028                            SDI      K$RWPARM,AUTO

     1748    25149    5                          K$RWPARM.MSGSZ = K$RWPARM.MSGSZ - 1;

  25149   1 0001FE  88C7 002A                            DEC      K$RWPARM+2,AUTO

     1749    25150    5                          END;

  25150   1 000200  0F81 0016                            B        s:25156,PREL

     1750    25151    4                     ELSE IF USRFPT$ ~= ADDR(NIL) AND MYDCB.DVFC ~= BINASC(0)

  25151   1 000202  8DC7 0010                            CMN      USRFPT$,AUTO
          1 000204  0901 0012                            BE       s:25156,PREL
          1 000206  DCC7 001B                            LDB,B5   DCB$,AUTO
          1 000208  B845 0024                            LDR,R3   36,B5
          1 00020A  3008                                 SOL,R3   8
          1 00020B  3068                                 SAR,R3   8
          1 00020C  3D00                                 CMV,R3   0
          1 00020D  0901 0009                            BE       s:25156,PREL

     1751    25152    5                          THEN DO;

     1752    25153    5                               K$RWPARM.DVE.DVBYTE.VFC = '1'B;

  25153   1 00020F  8947 0037                            LBT,'4000'X       K$RWPARM+15,AUTO
  25153   1 000211       4000

PL6.E3A0      #003=KNA$USERIO File=KNA$APE.:E05TSI                               WED 07/30/97 00:58 Page:294  
     1753    25154    5                               K$RWPARM.DVE.VFC = MYDCB.DVFC;

  25154   1 000212  B845 0024                            LDR,R3   36,B5
          1 000214  BAC7 0037                            SRM,R3,'00FF'X    K$RWPARM+15,AUTO
          1 000216       00FF

     1754    25155    5                               END;

     1755    25156    4                     K$RWPARM.KEY$ = KEY$;

  25156   1 000217  DCC7 0012                            LDB,B5   KEY$,AUTO
          1 000219  DFC7 004B                            STB,B5   K$RWPARM+35,AUTO

     1756    25157    4                     K$RWPARM.KEYSZ = KEYSZ;

  25157   1 00021B  B847 0014                            LDR,R3   KEYSZ,AUTO
          1 00021D  BAC7 0050                            SRM,R3,'00FF'X    K$RWPARM+40,AUTO
          1 00021F       00FF

     1757    25158    4                     IF USRFPT$ ~= ADDR(NIL)

  25158   1 000220  8DC7 0010                            CMN      USRFPT$,AUTO
          1 000222  0901 002D                            BE       s:25171,PREL

     1758    25159    5                     THEN DO;

     1759    25160    5                          K$RWPARM.KEYTYPE = FPT_WRITE.V.KEYTYPE;

  25160   1 000224  CCC7 0010                            LDB,B4   USRFPT$,AUTO
          1 000226  A804                                 LDR,R2   ,B4
          1 000227  A570 007F                            AND,R2   127,IMO
          1 000229  A7C7 0050                            STH,R2   K$RWPARM+40,AUTO

     1760    25161    5                          IF K$RWPARM.KEYTYPE = 0

  25161   1 00022B  A2C7 0050                            LLH,R2   K$RWPARM+40,AUTO
          1 00022D  2981 0007                            BNEZ,R2  s:25163,PREL
PL6.E3A0      #003=KNA$USERIO File=KNA$APE.:E05TSI                               WED 07/30/97 00:58 Page:295  

     1761    25162    5                          THEN K$RWPARM.KEYTYPE = MYDCB.KEYTYPE;

  25162   1 00022F  BCC7 001B                            LDB,B3   DCB$,AUTO
          1 000231  92C3 0024                            LLH,R1   36,B3
          1 000233  97C7 0050                            STH,R1   K$RWPARM+40,AUTO

     1762    25163    5                          IF FPT_WRITE.V.EOM AND SUBSTR(MYDCB.RES,0,2)~='UC'

  25163   1 000235  8284                                 LB,'0080'X        ,B4
  25163   1 000236       0080
          1 000237  0581 0018                            BBF      s:25171,PREL
          1 000239  BCC7 001B                            LDB,B3   DCB$,AUTO
          1 00023B  AB80 0000 0000  00                   LAB,B2   0
          1 00023E  0022                                 ACM      ;
          1 00023F       4203 0019                                ALPHANUM(25,B3,,2,FILL),;
          1 000241       4202 0015                                ALPHANUM(21,B2,,2,FILL)
          1 000243  5381 000C                            CBE      s:25171,PREL

     1763    25164    6                          THEN DO;

     1764    25165    6                               K$RWPARM.DVE.EOMCHAR = FPT_WRITE.V.EOMCHAR;

  25165   1 000245  A844 0002                            LDR,R2   2,B4
          1 000247  AAC7 0037                            SRM,R2,'00FF'X    K$RWPARM+15,AUTO
          1 000249       00FF

     1765    25166    6                               K$RWPARM.DVE.DVBYTE.VFC = '0'B;

  25166   1 00024A  8847 0037                            LBF,'4000'X       K$RWPARM+15,AUTO
  25166   1 00024C       4000

     1766    25167    6                               K$RWPARM.EOM_EOR = '1'B;

  25167   1 00024D  8947 0038                            LBT,'2000'X       K$RWPARM+16,AUTO
  25167   1 00024F       2000

PL6.E3A0      #003=KNA$USERIO File=KNA$APE.:E05TSI                               WED 07/30/97 00:58 Page:296  
     1767    25168    6                               END;

     1768    25169    5                          END;

     1769    25170
     1770    25171    4                     CALL ROUTINE (FCN,KNA$SSN,K$RWPARM,ERR)

  25171   1 000250  CBC7 0061                            LAB,B4   ERR,AUTO
          1 000252  CFC7 0070                            STB,B4   ROUTINE+10,AUTO
          1 000254  BBC7 0028                            LAB,B3   K$RWPARM,AUTO
          1 000256  BFC7 006E                            STB,B3   ROUTINE+8,AUTO
          1 000258  ACC7 001D                            LDB,B2   SSN$,AUTO
          1 00025A  AFC7 006C                            STB,B2   ROUTINE+6,AUTO
          1 00025C  9BC7 0065                            LAB,B1   FCN,AUTO
          1 00025E  9FC7 006A                            STB,B1   ROUTINE+4,AUTO
          1 000260  BBC7 006A                            LAB,B3   ROUTINE+4,AUTO
          1 000262  9B86                                 LAB,B1   ,B6
          1 000263  CBF0 0400                            LAB,B4   1024,IMO
          1 000265  E381                                 LNJ,B6   ,B1
          1 000266       0084                            DC       s:25221,PREL

     1771    25172    4                       ALTRET (SSN_ERR);
     1772    25173
     1773    25174    4                     IF FLOW_CONTROL

  25174   1 000267  89C7 0027                            CMZ      FLOW_CONTROL,AUTO
          1 000269  0881 000D                            BAGE     s:25179,PREL

     1774    25175    5                     THEN DO;

     1775    25176    5                          KNA$SSN.THRTLVL.MAXNMBRCR = KNA$SSN.THRTLVL.MAXNMBRCR-1;

  25176   1 00026B  ECC7 001D                            LDB,B6   SSN$,AUTO
          1 00026D  88C6 0008                            DEC      8,B6

     1776    25177    5                          KNA$SSN.THRTLVL.MAXNMBBYT = KNA$SSN.THRTLVL.MAXNMBBYT -
             25177                                   MSGSIZE;
PL6.E3A0      #003=KNA$USERIO File=KNA$APE.:E05TSI                               WED 07/30/97 00:58 Page:297  

  25177   1 00026F  ECC7 001D                            LDB,B6   SSN$,AUTO
          1 000271  E846 0007                            LDR,R6   7,B6
          1 000273  E247 000C                            SUB,R6   MSGSIZE,AUTO
          1 000275  EF46 0007                            STR,R6   7,B6

     1777    25178    5                          END;

     1778    25179    4                     EXIT WRITELOOP;

  25179   1 000277  0F81 008D                            B        s:25236,PREL

     1779    25180
     1780    25181    4                     END/* End for sending the data now*/;
     1781    25182
     1782    25183        /* If we don't have enough throttling to do this then we'll just
     1783    25184        set a bit saying that we are waiting for a message and REG the
     1784    25185        current user.
     1785    25186        */
     1786    25187    4                ELSE DO;

     1787    25188    4                     IF KNA$SSN.FLAGS.BLOCKED

  25188   1 000279  8285                                 LB,'4000'X        ,B5
  25188   1 00027A       4000
          1 00027B  0501 003B                            BBT      s:25207,PREL

     1788    25189    4                     THEN GOTO REG_BLOCKED;
     1789    25190
     1790    25191    4                     K$RWPARM.STR = STR;

  25191   1 00027D  D847 000E                            LDR,R5   STR,AUTO
          1 00027F  DAC7 0045                            SRM,R5,'00FF'X    K$RWPARM+29,AUTO
          1 000281       00FF

     1791    25192    4                     K$RWPARM.MAXRCRBYTSIZ = MSGSIZE;

PL6.E3A0      #003=KNA$USERIO File=KNA$APE.:E05TSI                               WED 07/30/97 00:58 Page:298  
  25192   1 000282  E847 000C                            LDR,R6   MSGSIZE,AUTO
          1 000284  EF47 0048                            STR,R6   K$RWPARM+32,AUTO

     1792    25193    4                     IF KNA$SSN.THRTLVL.MAXNMBRCR = 0

  25193   1 000286  C845 0008                            LDR,R4   8,B5
          1 000288  4981 0007                            BNEZ,R4  s:25195,PREL

     1793    25194    4                     THEN K$RWPARM.RSN = %KV_BLKRSN_MAXNMBRCR;

  25194   1 00028A  3C02                                 LDV,R3   2
          1 00028B  BAC7 0038                            SRM,R3,'00FF'X    K$RWPARM+16,AUTO
          1 00028D       00FF
          1 00028E  0F81 0005                            B        s:25196,PREL

     1794    25195    4                     ELSE K$RWPARM.RSN = %KV_BLKRSN_MAXNMBBYT;

  25195   1 000290  3C01                                 LDV,R3   1
          1 000291  BAC7 0038                            SRM,R3,'00FF'X    K$RWPARM+16,AUTO
          1 000293       00FF

     1795    25196    4                     KNA$SSN.REGRSN = 0;   /* So we can detect getting blocked   */

  25196   1 000294  8745 0012                            CL       18,B5

     1796    25197
     1797    25198    4                     CALL ROUTINE(%KV_VDO_FNC_BLKDAT,KNA$SSN,K$RWPARM,ERR)

  25198   1 000296  DBF0 0002                            LAB,B5   2,IMO
          1 000298  CBC7 0061                            LAB,B4   ERR,AUTO
          1 00029A  CFC7 0070                            STB,B4   ROUTINE+10,AUTO
          1 00029C  BBC7 0028                            LAB,B3   K$RWPARM,AUTO
          1 00029E  BFC7 006E                            STB,B3   ROUTINE+8,AUTO
          1 0002A0  ACC7 001D                            LDB,B2   SSN$,AUTO
          1 0002A2  AFC7 006C                            STB,B2   ROUTINE+6,AUTO
          1 0002A4  DFC7 006A                            STB,B5   ROUTINE+4,AUTO
          1 0002A6  BBC7 006A                            LAB,B3   ROUTINE+4,AUTO
PL6.E3A0      #003=KNA$USERIO File=KNA$APE.:E05TSI                               WED 07/30/97 00:58 Page:299  
          1 0002A8  9B86                                 LAB,B1   ,B6
          1 0002A9  CBF0 0400                            LAB,B4   1024,IMO
          1 0002AB  E381                                 LNJ,B6   ,B1
          1 0002AC       003E                            DC       s:25221,PREL

     1798    25199                                                /* call KNA$FCNO or KNA$FCNOU*/
     1799    25200    4                       ALTRET (SSN_ERR);
     1800    25201
     1801    25202
     1802    25203    4                     KNA$SSN.FLAGS.BLOCKED = '1'B;

  25203   1 0002AD  ECC7 001D                            LDB,B6   SSN$,AUTO
          1 0002AF  8906                                 LBT,'4000'X       ,B6
          1 0002B0       4000

     1803    25204    4                     IF KNA$SSN.REGRSN ~= 0

  25204   1 0002B1  ECC7 001D                            LDB,B6   SSN$,AUTO
          1 0002B3  E846 0012                            LDR,R6   18,B6
          1 0002B5  6981 FE9A                            BNEZ,R6  s:25100,PREL

     1804    25205    4                     THEN GOTO WRITELOOP;  /* Start over if we got blocked       */
     1805    25206
     1806    25207    4   REG_BLOCKED:      IF MYDCB.DVBYTE.NODAT

  25207   1 0002B7  ECC7 001B            REG_BLOCKED     LDB,B6   DCB$,AUTO
          1 0002B9  82C6 0002                            LB,'0400'X        2,B6
          1 0002BB       0400
          1 0002BC  0581 0009                            BBF      s:25215,PREL

     1807    25208    5                     THEN DO;

     1808    25209    5                          ERROR=ENO_DAT;

  25209   1 0002BE  8C80 0000 000A  00                   LDI      ENO_DAT
          1 0002C1  DCC7 0008                            LDB,B5   @ERROR,AUTO
          1 0002C3  8D05                                 SDI      ,B5
PL6.E3A0      #003=KNA$USERIO File=KNA$APE.:E05TSI                               WED 07/30/97 00:58 Page:300  

     1809    25210    5                          GOTO FINISHED;

  25210   1 0002C4  0F81 03A9                            B        s:25450,PREL

     1810    25211    5                          END;
     1811    25212        /*E* ERROR: KNA-%E$NODAT
     1812    25213             MESSAGE: No throttling available for write or no data available for read.
     1813    25214        */
     1814    25215    4                     CALL KNA$REG_USER(%GH_EVCBL,SSN$)

  25215   1 0002C6  DBF0 0019                            LAB,B5   25,IMO
          1 0002C8  CBC7 001D                            LAB,B4   SSN$,AUTO
          1 0002CA  CFC7 006C                            STB,B4   ROUTINE+6,AUTO
          1 0002CC  DFC7 006A                            STB,B5   ROUTINE+4,AUTO
          1 0002CE  BBC7 006A                            LAB,B3   ROUTINE+4,AUTO
          1 0002D0  CBF0 0200                            LAB,B4   512,IMO
          1 0002D2  E380 0000 0000  xent                 LNJ,B6   KNA$REG_USER
          1 0002D5       0003                            DC       s:25217,PREL
          1 0002D6  0F81 002C                            B        s:25231,PREL

     1815    25216    5                     WHENALTRETURN DO;

     1816    25217    5                          IF STR ~= KIDM_MON

  25217   1 0002D8  E847 000E                            LDR,R6   STR,AUTO
          1 0002DA  6D7F                                 CMV,R6   127
          1 0002DB  0981 0008                            BNE      s:25220,PREL
          1 0002DD  ECC7 001D                            LDB,B6   SSN$,AUTO
          1 0002DF  D846 0013                            LDR,R5   19,B6
          1 0002E1  5D03                                 CMV,R5   3
          1 0002E2  0901 0020                            BE       s:25231,PREL

     1817    25218    5                            OR KNA$SSN.STATE ~= %KNA_STATE_ACTIVE#
     1818    25219    6                          THEN DO;

     1819    25220    6                               G$JIT.JUNK.BACKP$='1'B;
PL6.E3A0      #003=KNA$USERIO File=KNA$APE.:E05TSI                               WED 07/30/97 00:58 Page:301  

  25220   1 0002E4  EC80 0000 0000  xsym                 LDB,B6   G$JIT$
          1 0002E7  8946 0098                            LBT,'0100'X       152,B6
          1 0002E9       0100

     1820    25221    6   SSN_ERR:                    IF KNA$SSN.FLAGS.SSNERR THEN ERROR = KNA$SSN.ERROR;

  25221   1 0002EA  ECC7 001D            SSN_ERR         LDB,B6   SSN$,AUTO
          1 0002EC  8286                                 LB,'0800'X        ,B6
          1 0002ED       0800
          1 0002EE  0581 0008                            BBF      s:25222,PREL

  25221   1 0002F0  8CC6 0001                            LDI      1,B6
          1 0002F2  DCC7 0008                            LDB,B5   @ERROR,AUTO
          1 0002F4  8D05                                 SDI      ,B5
          1 0002F5  0F81 0007                            B        s:25223,PREL

     1821    25222    6                               ELSE ERROR = EBYD;

  25222   1 0002F7  8C80 0000 000C  00                   LDI      EBYD
          1 0002FA  DCC7 0008                            LDB,B5   @ERROR,AUTO
          1 0002FC  8D05                                 SDI      ,B5

     1822    25223    6                               KNA$SSN.FLAGS.BLOCKED = '0'B;

  25223   1 0002FD  ECC7 001D                            LDB,B6   SSN$,AUTO
          1 0002FF  8806                                 LBF,'4000'X       ,B6
          1 000300       4000

     1823    25224    6                               GOTO FINISHED;

  25224   1 000301  0F81 036C                            B        s:25450,PREL

     1824    25225    6                               END/*do if mon*/;
     1825    25226    5                          END/*altret from reg_user*/;
     1826    25227        /*E* ERROR: KNA-%E$BYD
     1827    25228             MESSAGE: Asynchronous event interrupted I/O.
PL6.E3A0      #003=KNA$USERIO File=KNA$APE.:E05TSI                               WED 07/30/97 00:58 Page:302  
     1828    25229        */
     1829    25230    3                     END;/*do if no throttling*/;

     1830    25231    3                END/* writeloop: do while('1'B)*/;

  25231   1 000303  0F81 FE4C                            B        s:25100,PREL

     1831    25232        %EJECT;
PL6.E3A0      #003=KNA$USERIO File=KNA$APE.:E05TSI                               WED 07/30/97 00:58 Page:303  
     1832    25233
     1833    25234        /* Update the various write counters.
     1834    25235        */
     1835    25236    3           DO CASE(RESTYPE);

  25236   1 000305  B847 000D                            LDR,R3   RESTYPE,AUTO
          1 000307  3D05                                 CMV,R3   5
          1 000308  0281 005C                            BGE      s:25254,PREL
          1 00030A  A830 0000 0310  01                   LDR,R2   s:25236+11,R3
          1 00030D  83A0 0000 0315  01                   JMP      s:25238,R2
          1 000310       0050                            DC       s:25254,PREL
          1 000311       0000                            DC       s:25238,PREL
          1 000312       0018                            DC       s:25242,PREL
          1 000313       0030                            DC       s:25246,PREL
          1 000314       0041                            DC       s:25249,PREL

     1836    25237    3            CASE(%G_DDEV_RES_HO#);

     1837    25238    3              G$JIT.WRITES_HOST = G$JIT.WRITES_HOST +1;

  25238   1 000315  EC80 0000 0000  xsym                 LDB,B6   G$JIT$
          1 000318  8AC6 0043                            INC      67,B6
          1 00031A  8EC6 0042                            CAD      66,B6

     1838    25239    3              PS_LCP6STT.WRITES_HOST = PS_LCP6STT.WRITES_HOST +1;

  25239   1 00031C  8A80 0000 005F  xsym                 INC      PS_LCP6STT+95
          1 00031F  8E80 0000 005E  xsym                 CAD      PS_LCP6STT+94

     1839    25240    3              PS_LCP6STT.BYTES_WRT_HOST = PS_LCP6STT.BYTES_WRT_HOST + MSGSIZE;

  25240   1 000322  F847 000C                            LDR,R7   MSGSIZE,AUTO
          1 000324  6C00                                 LDV,R6   0
          1 000325  8400 0000 006E  xsym                 AID      PS_LCP6STT+110
          1 000328  8D00 0000 006E  xsym                 SDI      PS_LCP6STT+110
          1 00032B  0F81 0039                            B        s:25254,PREL

PL6.E3A0      #003=KNA$USERIO File=KNA$APE.:E05TSI                               WED 07/30/97 00:58 Page:304  
     1840    25241    3            CASE(%G_DDEV_RES_UC#);

     1841    25242    3              G$JIT.WRITES_UC = G$JIT.WRITES_UC +1;

  25242   1 00032D  EC80 0000 0000  xsym                 LDB,B6   G$JIT$
          1 000330  8AC6 0047                            INC      71,B6
          1 000332  8EC6 0046                            CAD      70,B6

     1842    25243    3              PS_LCP6STT.WRITES_UC = PS_LCP6STT.WRITES_UC +1;

  25243   1 000334  8A80 0000 0061  xsym                 INC      PS_LCP6STT+97
          1 000337  8E80 0000 0060  xsym                 CAD      PS_LCP6STT+96

     1843    25244    3              PS_LCP6STT.BYTES_WRT_UC = PS_LCP6STT.BYTES_WRT_UC + MSGSIZE;

  25244   1 00033A  F847 000C                            LDR,R7   MSGSIZE,AUTO
          1 00033C  6C00                                 LDV,R6   0
          1 00033D  8400 0000 0070  xsym                 AID      PS_LCP6STT+112
          1 000340  8D00 0000 0070  xsym                 SDI      PS_LCP6STT+112
          1 000343  0F81 0021                            B        s:25254,PREL

     1844    25245    3            CASE(%G_DDEV_RES_LG#);

     1845    25246    3              PS_LCP6STT.WRITES_LG = PS_LCP6STT.WRITES_LG +1;

  25246   1 000345  8A80 0000 0063  xsym                 INC      PS_LCP6STT+99
          1 000348  8E80 0000 0062  xsym                 CAD      PS_LCP6STT+98

     1846    25247    3              PS_LCP6STT.BYTES_WRT_LG = PS_LCP6STT.BYTES_WRT_LG + MSGSIZE;

  25247   1 00034B  F847 000C                            LDR,R7   MSGSIZE,AUTO
          1 00034D  6C00                                 LDV,R6   0
          1 00034E  8400 0000 0072  xsym                 AID      PS_LCP6STT+114
          1 000351  8D00 0000 0072  xsym                 SDI      PS_LCP6STT+114
          1 000354  0F81 0010                            B        s:25254,PREL

     1847    25248    3            CASE(%G_DDEV_RES_NA#);
PL6.E3A0      #003=KNA$USERIO File=KNA$APE.:E05TSI                               WED 07/30/97 00:58 Page:305  

     1848    25249    3              PS_LCP6STT.WRITES_NA = PS_LCP6STT.WRITES_NA +1;

  25249   1 000356  8A80 0000 0065  xsym                 INC      PS_LCP6STT+101
          1 000359  8E80 0000 0064  xsym                 CAD      PS_LCP6STT+100

     1849    25250    3              PS_LCP6STT.BYTES_WRT_NA = PS_LCP6STT.BYTES_WRT_NA + MSGSIZE;

  25250   1 00035C  F847 000C                            LDR,R7   MSGSIZE,AUTO
          1 00035E  6C00                                 LDV,R6   0
          1 00035F  8400 0000 0074  xsym                 AID      PS_LCP6STT+116
          1 000362  8D00 0000 0074  xsym                 SDI      PS_LCP6STT+116

     1850    25251    3              END/*do select*/;

     1851    25252
     1852    25253        /* If this is an RRR request grab a IOP packet */
     1853    25254    2           IF K$RWPARM.DVE.DVBYTE.RRR

  25254   1 000365  82C7 0037                            LB,'0800'X        K$RWPARM+15,AUTO
  25254   1 000367       0800
          1 000368  0581 0305                            BBF      s:25450,PREL

     1854    25255    3           THEN DO;

     1855    25256    3                CALL KNA$GETIOP(IOP$)

  25256   1 00036A  EBC7 001F                            LAB,B6   IOP$,AUTO
          1 00036C  EFC7 006A                            STB,B6   ROUTINE+4,AUTO
          1 00036E  BBC7 006A                            LAB,B3   ROUTINE+4,AUTO
          1 000370  CBF0 0100                            LAB,B4   256,IMO
          1 000372  E380 0000 0000  xent                 LNJ,B6   KNA$GETIOP
          1 000375       0003                            DC       s:25258,PREL
          1 000376  0F81 0009                            B        s:25261,PREL

     1856    25257    4                WHENALTRETURN DO;

PL6.E3A0      #003=KNA$USERIO File=KNA$APE.:E05TSI                               WED 07/30/97 00:58 Page:306  
     1857    25258    4                     ERROR = ENO_IOP;

  25258   1 000378  8C80 0000 0006  00                   LDI      ENO_IOP
          1 00037B  ECC7 0008                            LDB,B6   @ERROR,AUTO
          1 00037D  8D06                                 SDI      ,B6

     1858    25259    4                     GOTO FINISHED;

  25259   1 00037E  0F81 02EF                            B        s:25450,PREL

     1859    25260    4                     END;
     1860    25261    3                KNA$SSN.IOPQ$ = IOP$;

  25261   1 000380  ECC7 001F                            LDB,B6   IOP$,AUTO
          1 000382  DCC7 001D                            LDB,B5   SSN$,AUTO
          1 000384  EFC5 000B                            STB,B6   11,B5

     1861    25262    3                KNA$SSN.FLAGS.RRRPND = '1'B;

  25262   1 000386  ECC7 001D                            LDB,B6   SSN$,AUTO
          1 000388  8906                                 LBT,'0200'X       ,B6
          1 000389       0200

     1862    25263    3                CALL KNA$REG_USER(%GH_EVCW,SSN$)

  25263   1 00038A  EBF0 0015                            LAB,B6   21,IMO
          1 00038C  DBC7 001D                            LAB,B5   SSN$,AUTO
          1 00038E  DFC7 006C                            STB,B5   ROUTINE+6,AUTO
          1 000390  EFC7 006A                            STB,B6   ROUTINE+4,AUTO
          1 000392  BBC7 006A                            LAB,B3   ROUTINE+4,AUTO
          1 000394  CBF0 0200                            LAB,B4   512,IMO
          1 000396  E380 0000 0000  xent                 LNJ,B6   KNA$REG_USER
          1 000399       0014                            DC       s:25268,PREL

     1863    25264    4                WHENRETURN DO;

     1864    25265    4                     IF KN$IOP.ERRCODE THEN ERROR = KN$IOP.ERRCODE;
PL6.E3A0      #003=KNA$USERIO File=KNA$APE.:E05TSI                               WED 07/30/97 00:58 Page:307  

  25265   1 00039A  ECC7 001F                            LDB,B6   IOP$,AUTO
          1 00039C  DB80 0000 0000  02                   LAB,B5   0
          1 00039F  5C01                                 LDV,R5   1
          1 0003A0  0022                                 ACM      ;
          1 0003A1       4406 0000                                ALPHANUM(0,B6,,4,FILL),;
          1 0003A3       4005 0000                                ALPHANUM(0,B5,,R5,FILL)
          1 0003A5  5381 0005                            CBE      s:25266,PREL

  25265   1 0003A7  8C86                                 LDI      ,B6
          1 0003A8  DCC7 0008                            LDB,B5   @ERROR,AUTO
          1 0003AA  8D05                                 SDI      ,B5

     1865    25266    4                     END;

  25266   1 0003AB  0F81 0014                            B        s:25271,PREL

     1866    25267    4                WHENALTRETURN DO;

     1867    25268    4                     IF KNA$SSN.FLAGS.SSNERR THEN ERROR = KNA$SSN.ERROR;

  25268   1 0003AD  ECC7 001D                            LDB,B6   SSN$,AUTO
          1 0003AF  8286                                 LB,'0800'X        ,B6
          1 0003B0       0800
          1 0003B1  0581 0008                            BBF      s:25269,PREL

  25268   1 0003B3  8CC6 0001                            LDI      1,B6
          1 0003B5  DCC7 0008                            LDB,B5   @ERROR,AUTO
          1 0003B7  8D05                                 SDI      ,B5
          1 0003B8  0F81 0007                            B        s:25271,PREL

     1868    25269    4                     ELSE ERROR = EBYD;

  25269   1 0003BA  8C80 0000 000C  00                   LDI      EBYD
          1 0003BD  DCC7 0008                            LDB,B5   @ERROR,AUTO
          1 0003BF  8D05                                 SDI      ,B5

PL6.E3A0      #003=KNA$USERIO File=KNA$APE.:E05TSI                               WED 07/30/97 00:58 Page:308  
     1869    25270    4                     END;

     1870    25271    3                IF PARMSPEC AND KNA_PARAMS.PTRS.PAR4$ ~= ADDR(NIL)

  25271   1 0003C0  89C7 000F                            CMZ      PARMSPEC,AUTO
          1 0003C2  0881 000F                            BAGE     s:25274,PREL
          1 0003C4  ECC7 000A                            LDB,B6   @KNA_PARAMS,AUTO
          1 0003C6  8DC6 000C                            CMN      12,B6
          1 0003C8  0901 0009                            BE       s:25274,PREL

     1871    25272    3                THEN KNA_PARAMS.PTRS.PAR4$->VLP_CG.MSGID# = KN$IOP.MSGID;

  25272   1 0003CA  DCC6 000C                            LDB,B5   12,B6
          1 0003CC  CCC7 001F                            LDB,B4   IOP$,AUTO
          1 0003CE  8CC4 000C                            LDI      12,B4
          1 0003D0  8D45 0009                            SDI      9,B5

     1872    25273
     1873    25274    3                CALL KNA$RLSIOP (IOP$);

  25274   1 0003D2  EBC7 001F                            LAB,B6   IOP$,AUTO
          1 0003D4  EFC7 006A                            STB,B6   ROUTINE+4,AUTO
          1 0003D6  BBC7 006A                            LAB,B3   ROUTINE+4,AUTO
          1 0003D8  CBF0 0100                            LAB,B4   256,IMO
          1 0003DA  E380 0000 0000  xent                 LNJ,B6   KNA$RLSIOP
          1 0003DD       0001                            DC       s:25275,PREL

     1874    25275    3                KNA$SSN.IOPQ$ = ADDR(NIL);

  25275   1 0003DE  EB80 0000 0000                       LAB,B6   0
          1 0003E1  DCC7 001D                            LDB,B5   SSN$,AUTO
          1 0003E3  EFC5 000B                            STB,B6   11,B5

     1875    25276    3                END;

     1876    25277    2           END;

PL6.E3A0      #003=KNA$USERIO File=KNA$APE.:E05TSI                               WED 07/30/97 00:58 Page:309  
  25277   1 0003E5  0F81 0288                            B        s:25450,PREL

     1877    25278        %EJECT;
PL6.E3A0      #003=KNA$USERIO File=KNA$APE.:E05TSI                               WED 07/30/97 00:58 Page:310  
     1878    25279        /*
     1879    25280               Now we come to the READ code.  Here we basically just have to
     1880    25281        get an I/O packet for keeping track of the user's buffer, issue a
     1881    25282        message to the network connection specifying how much we can accept,
     1882    25283        mark this in our SSN context, and REG the user until this is all
     1883    25284        done.
     1884    25285        */
     1885    25286    2      ELSE DO;

     1886    25287        /*
     1887    25288          Verify that there is no other read operation pending on this stream.
     1888    25289          If there is, report an error and return.
     1889    25290                                                                                      */
     1890    25291    2           IF KNA$SSN.IOPRD$ ~= ADDR(NIL)  /* Another read out standing          */

  25291   1 0003E7  DCC7 001D                            LDB,B5   SSN$,AUTO
          1 0003E9  8DC5 000D                            CMN      13,B5
          1 0003EB  0901 0060                            BE       s:25316,PREL

     1891    25292    3           THEN DO;

     1892    25293    3                IF MOD(KNA_LNKSSN.SREG,64)<61

  25293   1 0003ED  C800 0000 0002  xsym                 LDR,R4   KNA_LNKSSN+2
          1 0003F0  C570 003F                            AND,R4   63,IMO
          1 0003F2  4D3D                                 CMV,R4   61
          1 0003F3  0881 0009                            BAGE     s:25299,PREL

     1893    25294    4                THEN DO;

     1894    25295    4                     ERROR = EXTRA_READ;

  25295   1 0003F5  8C80 0000 0010  00                   LDI      EXTRA_READ
          1 0003F8  CCC7 0008                            LDB,B4   @ERROR,AUTO
          1 0003FA  8D04                                 SDI      ,B4

     1895    25296    4                     GOTO FINISHED;
PL6.E3A0      #003=KNA$USERIO File=KNA$APE.:E05TSI                               WED 07/30/97 00:58 Page:311  

  25296   1 0003FB  0F81 0272                            B        s:25450,PREL

     1896    25297    4                     END;
     1897    25298
     1898    25299    3                IOP$ = KNA$SSN.IOPRD$;

  25299   1 0003FD  CCC5 000D                            LDB,B4   13,B5
          1 0003FF  CFC7 001F                            STB,B4   IOP$,AUTO

     1899    25300    3                K$RWPARM.STR = KN$IOP.DCB$->MYDCB.STRM;

  25300   1 000401  ACC4 000A                            LDB,B2   10,B4
          1 000403  C842 0002                            LDR,R4   2,B2
          1 000405  CAC7 0045                            SRM,R4,'00FF'X    K$RWPARM+29,AUTO
          1 000407       00FF

     1900    25301    3                CALL CANCEL_READ ALTRET(SSN_ERR);

  25301   1 000408  E3C0 0281                            LNJ,B6   s:0,PREL
          1 00040A       FEE0                            DC       s:25221,PREL

     1901    25302    3                K$RWPARM.MRKTYP = 0;

  25302   1 00040B  87C7 0045                            CLH      K$RWPARM+29,AUTO

     1902    25303    3                IF KNA$SSN.IOPRD$ = ADDR(NIL) /* Got message                     */

  25303   1 00040D  ECC7 001D                            LDB,B6   SSN$,AUTO
          1 00040F  8DC6 000D                            CMN      13,B6
          1 000411  0901 003A                            BE       s:25316,PREL

     1903    25304    3                THEN GOTO READ_COMPLETED;
     1904    25305
     1905    25306    3                NWIO = '0'B;

  25306   1 000413  5C20                                 LDV,R5   32
PL6.E3A0      #003=KNA$USERIO File=KNA$APE.:E05TSI                               WED 07/30/97 00:58 Page:312  
          1 000414  0021                                 ALR      ;
          1 000415       4178 0000                                ALPHANUM('0000'X,IMO,,1),;
          1 000417       4007 0051                                ALPHANUM(NWIO,AUTO,,R5,FILL)

     1906    25307    3                NWIO.P# = SIZEW(NWIO) - SIZEW(NWIO.P#);

  25307   1 000419  6C0F                                 LDV,R6   15
          1 00041A  437F                                 CSYNC    s:25307,SPREL
          1 00041B  EF47 0051                            STR,R6   NWIO,AUTO

     1907    25308    3                TCB_ERR = EXTRA_READ;

  25308   1 00041D  8C80 0000 0010  00                   LDI      EXTRA_READ
          1 000420  8D47 0062                            SDI      TCB_ERR,AUTO

     1908    25309    3                EVENT = KN$IOP.EVENT;

  25309   1 000422  DCC7 001F                            LDB,B5   IOP$,AUTO
          1 000424  C845 001A                            LDR,R4   26,B5
          1 000426  CF47 0022                            STR,R4   EVENT,AUTO

     1909    25310    3               CALL GHS$EVENT (KNA$SSN.USER#,%GH_USRDMN#,%G_IO_CMP#,EVENT,TCB_ERR,NWIO
             25310                         );

  25310   1 000428  CBF0 0000                            LAB,B4   0,IMO
          1 00042A  BBF0 0005                            LAB,B3   5,IMO
          1 00042C  ABC7 0051                            LAB,B2   NWIO,AUTO
          1 00042E  AFC7 0074                            STB,B2   ROUTINE+14,AUTO
          1 000430  9BC7 0062                            LAB,B1   TCB_ERR,AUTO
          1 000432  9FC7 0072                            STB,B1   ROUTINE+12,AUTO
          1 000434  EBC7 0022                            LAB,B6   EVENT,AUTO
          1 000436  EFC7 0070                            STB,B6   ROUTINE+10,AUTO
          1 000438  BFC7 006E                            STB,B3   ROUTINE+8,AUTO
          1 00043A  CFC7 006C                            STB,B4   ROUTINE+6,AUTO
          1 00043C  ECC7 001D                            LDB,B6   SSN$,AUTO
          1 00043E  DBC6 0011                            LAB,B5   17,B6
          1 000440  DFC7 006A                            STB,B5   ROUTINE+4,AUTO
PL6.E3A0      #003=KNA$USERIO File=KNA$APE.:E05TSI                               WED 07/30/97 00:58 Page:313  
          1 000442  BBC7 006A                            LAB,B3   ROUTINE+4,AUTO
          1 000444  CBF0 0600                            LAB,B4   1536,IMO
          1 000446  E380 0000 0000  xent                 LNJ,B6   GHS$EVENT
          1 000449       0001                            DC       s:25311,PREL

     1910    25311    3                END/*do if ssn.ioprd$ ~= nil*/;

  25311   1 00044A  0F81 0017                            B        s:25330,PREL

     1911    25312        /*E* ERROR: KNA-E$XTRARD-0
     1912    25313             MESSAGE: Read errored because of another read issued.
     1913    25314        */
     1914    25315
     1915    25316    3           ELSE DO;                        /*when no read is outstanding*/

  25309   1                              READ_COMPLETED  null
     1916    25317    3   READ_COMPLETED: ;
     1917    25318    3                CALL KNA$GETIOP(IOP$)

  25318   1 00044C  EBC7 001F            READ_COMPLETED  LAB,B6   IOP$,AUTO
          1 00044E  EFC7 006A                            STB,B6   ROUTINE+4,AUTO
          1 000450  BBC7 006A                            LAB,B3   ROUTINE+4,AUTO
          1 000452  CBF0 0100                            LAB,B4   256,IMO
          1 000454  E380 0000 0000  xent                 LNJ,B6   KNA$GETIOP
          1 000457       0003                            DC       s:25321,PREL
          1 000458  0F81 0009                            B        s:25330,PREL

     1918    25319    4                WHENALTRETURN DO;

     1919    25320
     1920    25321    4                     ERROR = ENO_IOP;

  25321   1 00045A  8C80 0000 0006  00                   LDI      ENO_IOP
          1 00045D  ECC7 0008                            LDB,B6   @ERROR,AUTO
          1 00045F  8D06                                 SDI      ,B6

     1921    25322    4                     GOTO FINISHED;
PL6.E3A0      #003=KNA$USERIO File=KNA$APE.:E05TSI                               WED 07/30/97 00:58 Page:314  

  25322   1 000460  0F81 020D                            B        s:25450,PREL

     1922    25323    4                     END;
     1923    25324    3                END/*else do*/;

     1924    25325        /*E* ERROR: KNA-E$NO_IOP
     1925    25326             MESSAGE: No I/O packets available for this operation.
     1926    25327        */
     1927    25328
     1928    25329
     1929    25330    2           KN$IOP = '0'B;

  25330   1 000462  ECC7 001F                            LDB,B6   IOP$,AUTO
          1 000464  5C36                                 LDV,R5   54
          1 000465  0021                                 ALR      ;
          1 000466       4178 0000                                ALPHANUM('0000'X,IMO,,1),;
          1 000468       4006 0000                                ALPHANUM(0,B6,,R5,FILL)

     1930    25331    2           IOP$->KN$IOP.FLAGS.INUSE = '1'B;

  25331   1 00046A  437F                                 CSYNC    s:25330+7,SPREL
          1 00046B  ECC7 001F                            LDB,B6   IOP$,AUTO
          1 00046D  8946 0003                            LBT,'1000'X       3,B6
          1 00046F       1000

     1931    25332    2           IOP$->KN$IOP.L.USER# = G$JIT.USR#;

  25332   1 000470  EC80 0000 0000  xsym                 LDB,B6   G$JIT$
          1 000473  DCC7 001F                            LDB,B5   IOP$,AUTO
          1 000475  E846 0004                            LDR,R6   4,B6
          1 000477  EAC5 000F                            SRM,R6,'00FF'X    15,B5
          1 000479       00FF

     1932    25333        /*
     1933    25334          Link up the new I/O packet.  If this is the first one on the chain,
     1934    25335          also setup the pointer from APE session context.
PL6.E3A0      #003=KNA$USERIO File=KNA$APE.:E05TSI                               WED 07/30/97 00:58 Page:315  
     1935    25336                                                                                      */
     1936    25337    2           KNA$SSN.IOPRD$=IOP$;

  25337   1 00047A  DCC7 001F                            LDB,B5   IOP$,AUTO
          1 00047C  CCC7 001D                            LDB,B4   SSN$,AUTO
          1 00047E  DFC4 000D                            STB,B5   13,B4

     1937    25338
     1938    25339    2           KN$IOP.FLAGS.WAIT='1'B;

  25339   1 000480  DCC7 001F                            LDB,B5   IOP$,AUTO
          1 000482  8945 0003                            LBT,'4000'X       3,B5
          1 000484       4000

     1939    25340
     1940    25341    2           KN$IOP.DCB$=DCB$;

  25341   1 000485  DCC7 001B                            LDB,B5   DCB$,AUTO
          1 000487  CCC7 001F                            LDB,B4   IOP$,AUTO
          1 000489  DFC4 000A                            STB,B5   10,B4

     1941    25342    2           CALL KNA$SAVEMAP (DCB$,KN$IOP.DCBSEGDES);

  25342   1 00048B  DCC7 001F                            LDB,B5   IOP$,AUTO
          1 00048D  CBC5 0014                            LAB,B4   20,B5
          1 00048F  CFC7 006C                            STB,B4   ROUTINE+6,AUTO
          1 000491  BBC7 001B                            LAB,B3   DCB$,AUTO
          1 000493  BFC7 006A                            STB,B3   ROUTINE+4,AUTO
          1 000495  BBC7 006A                            LAB,B3   ROUTINE+4,AUTO
          1 000497  CBF0 0200                            LAB,B4   512,IMO
          1 000499  E380 0000 0000  xent                 LNJ,B6   KNA$SAVEMAP
          1 00049C       0001                            DC       s:25343,PREL

     1942    25343    2           KN$IOP.BUF_ = FPT_BUF$;

  25343   1 00049D  AB87                                 LAB,B2   ,AUTO
          1 00049E  2C2E                                 LDV,R2   46
PL6.E3A0      #003=KNA$USERIO File=KNA$APE.:E05TSI                               WED 07/30/97 00:58 Page:316  
          1 00049F  6C06                                 LDV,R6   6
          1 0004A0  BCC7 001F                            LDB,B3   IOP$,AUTO
          1 0004A2  3C08                                 LDV,R3   8
          1 0004A3  0008                                 MMM

     1943    25344    2           CALL KNA$SAVEMAP(VBASE(KN$IOP.BUF_),KN$IOP.BUFSEGDES);

  25344   1 0004A4  ECC7 001F                            LDB,B6   IOP$,AUTO
          1 0004A6  DBC6 0010                            LAB,B5   16,B6
          1 0004A8  DFC7 006C                            STB,B5   ROUTINE+6,AUTO
          1 0004AA  CBC6 0005                            LAB,B4   5,B6
          1 0004AC  CFC7 006A                            STB,B4   ROUTINE+4,AUTO
          1 0004AE  BBC7 006A                            LAB,B3   ROUTINE+4,AUTO
          1 0004B0  CBF0 0200                            LAB,B4   512,IMO
          1 0004B2  E380 0000 0000  xent                 LNJ,B6   KNA$SAVEMAP
          1 0004B5       0001                            DC       s:25348,PREL

     1944    25345
     1945    25346        /*     Set up for sending a READ REQUEST for the data
     1946    25347        */
     1947    25348    2           K$RWPARM.STR = STR;

  25348   1 0004B6  E847 000E                            LDR,R6   STR,AUTO
          1 0004B8  EAC7 0045                            SRM,R6,'00FF'X    K$RWPARM+29,AUTO
          1 0004BA       00FF

     1948    25349    2           K$RWPARM.MAXRCRBYTSIZ = MSGSIZE;

  25349   1 0004BB  D847 000C                            LDR,R5   MSGSIZE,AUTO
          1 0004BD  DF47 0048                            STR,R5   K$RWPARM+32,AUTO

     1949    25350    2           K$RWPARM.MAXNMBRCR=1;

  25350   1 0004BF  4C01                                 LDV,R4   1
          1 0004C0  CF47 0046                            STR,R4   K$RWPARM+30,AUTO

     1950    25351    2           K$RWPARM.MAXNMBBYT=6000;
PL6.E3A0      #003=KNA$USERIO File=KNA$APE.:E05TSI                               WED 07/30/97 00:58 Page:317  

  25351   1 0004C2  B870 1770                            LDR,R3   6000,IMO
          1 0004C4  BF47 0047                            STR,R3   K$RWPARM+31,AUTO

     1951    25352    2           IF USRFPT$ ~= ADDR(NIL)

  25352   1 0004C6  8DC7 0010                            CMN      USRFPT$,AUTO
          1 0004C8  0901 0077                            BE       s:25381,PREL

     1952    25353    3           THEN DO;

     1953    25354    3                KN$IOP.FLAGS.WAIT = FPT_READ.V.WAIT;

  25354   1 0004CA  ECC7 0010                            LDB,B6   USRFPT$,AUTO
          1 0004CC  A806                                 LDR,R2   ,B6
          1 0004CD  2009                                 SOL,R2   9
          1 0004CE  DCC7 001F                            LDB,B5   IOP$,AUTO
          1 0004D0  AAC5 0003                            SRM,R2,'4000'X    3,B5
          1 0004D2       4000

     1954    25355    4                IF FPT_READ.V.READMLT THEN DO;

  25355   1 0004D3  8286                                 LB,'0004'X        ,B6
  25355   1 0004D4       0004
          1 0004D5  0581 000D                            BBF      s:25360,PREL

     1955    25356    4                     KN$IOP.FLAGS.READMLT = '1'B;

  25356   1 0004D7  DCC7 001F                            LDB,B5   IOP$,AUTO
          1 0004D9  8945 0003                            LBT,'0800'X       3,B5
          1 0004DB       0800

     1956    25357    4                     K$RWPARM.READMLT = '1'B;

  25357   1 0004DC  8947 0038                            LBT,'4000'X       K$RWPARM+16,AUTO
  25357   1 0004DE       4000

PL6.E3A0      #003=KNA$USERIO File=KNA$APE.:E05TSI                               WED 07/30/97 00:58 Page:318  
     1957    25358    4                     K$RWPARM.MAXNMBBYT = K$RWPARM.MAXRCRBYTSIZ;

  25358   1 0004DF  A847 0048                            LDR,R2   K$RWPARM+32,AUTO
          1 0004E1  AF47 0047                            STR,R2   K$RWPARM+31,AUTO

     1958    25359    4                     END;

     1959    25360    3                KN$IOP.EVENT = FPT_READ.V.EVENT;

  25360   1 0004E3  DCC7 001F                            LDB,B5   IOP$,AUTO
          1 0004E5  A846 0001                            LDR,R2   1,B6
          1 0004E7  AF45 001A                            STR,R2   26,B5

     1960    25361    3                K$RWPARM.DVE.DVBYTE = FPT_READ.V.DVBYTE;

  25361   1 0004E9  A2C6 0002                            LLH,R2   2,B6
          1 0004EB  2008                                 SOL,R2   8
          1 0004EC  2048                                 SOR,R2   8
          1 0004ED  A7C7 0037                            STH,R2   K$RWPARM+15,AUTO

     1961    25362    3                K$RWPARM.KEYTYPE = FPT_READ.V.KEYTYPE;

  25362   1 0004EF  A846 0002                            LDR,R2   2,B6
          1 0004F1  A570 00FF                            AND,R2   255,IMO
          1 0004F3  A7C7 0050                            STH,R2   K$RWPARM+40,AUTO

     1962    25363    3                IF K$RWPARM.KEYTYPE = 0

  25363   1 0004F5  A2C7 0050                            LLH,R2   K$RWPARM+40,AUTO
          1 0004F7  2981 0007                            BNEZ,R2  s:25365,PREL

     1963    25364    3                THEN K$RWPARM.KEYTYPE = MYDCB.KEYTYPE;

  25364   1 0004F9  DCC7 001B                            LDB,B5   DCB$,AUTO
          1 0004FB  92C5 0024                            LLH,R1   36,B5
          1 0004FD  97C7 0050                            STH,R1   K$RWPARM+40,AUTO

PL6.E3A0      #003=KNA$USERIO File=KNA$APE.:E05TSI                               WED 07/30/97 00:58 Page:319  
     1964    25365    3                IF FPT_READ.V.KEYS

  25365   1 0004FF  8286                                 LB,'0080'X        ,B6
  25365   1 000500       0080
          1 000501  0581 000A                            BBF      s:25370,PREL

     1965    25366    4                THEN DO;

     1966    25367    4                     K$RWPARM.KEY$ = KEY$;

  25367   1 000503  DCC7 0012                            LDB,B5   KEY$,AUTO
          1 000505  DFC7 004B                            STB,B5   K$RWPARM+35,AUTO

     1967    25368    4                     K$RWPARM.KEYSZ = KEYSZ;

  25368   1 000507  A847 0014                            LDR,R2   KEYSZ,AUTO
          1 000509  AAC7 0050                            SRM,R2,'00FF'X    K$RWPARM+40,AUTO
          1 00050B       00FF

     1968    25369    4                     END;

     1969    25370    3                IF FPT_READ.V.KEYR

  25370   1 00050C  8286                                 LB,'0040'X        ,B6
  25370   1 00050D       0040
          1 00050E  0581 0028                            BBF      s:25377,PREL

     1970    25371    4                THEN DO;

     1971    25372    4                     VBASE(KN$IOP.KEY_) = KEY$;

  25372   1 000510  DCC7 0012                            LDB,B5   KEY$,AUTO
          1 000512  CCC7 001F                            LDB,B4   IOP$,AUTO
          1 000514  DFC4 0008                            STB,B5   8,B4

     1972    25373    4                     VBOUND(KN$IOP.KEY_) = KEYSZ - 1;

PL6.E3A0      #003=KNA$USERIO File=KNA$APE.:E05TSI                               WED 07/30/97 00:58 Page:320  
  25373   1 000516  CCC7 001F                            LDB,B4   IOP$,AUTO
          1 000518  A847 0014                            LDR,R2   KEYSZ,AUTO
          1 00051A  2EFF                                 ADV,R2   -1
          1 00051B  AF44 0007                            STR,R2   7,B4

     1973    25374    4                     CALL KNA$SAVEMAP(VBASE(KN$IOP.KEY_),KN$IOP.KEYSEGDES);

  25374   1 00051D  CCC7 001F                            LDB,B4   IOP$,AUTO
          1 00051F  BBC4 0012                            LAB,B3   18,B4
          1 000521  BFC7 006C                            STB,B3   ROUTINE+6,AUTO
          1 000523  ABC4 0008                            LAB,B2   8,B4
          1 000525  AFC7 006A                            STB,B2   ROUTINE+4,AUTO
          1 000527  BBC7 006A                            LAB,B3   ROUTINE+4,AUTO
          1 000529  CBF0 0200                            LAB,B4   512,IMO
          1 00052B  E380 0000 0000  xent                 LNJ,B6   KNA$SAVEMAP
          1 00052E       0001                            DC       s:25375,PREL

     1974    25375    4                     KN$IOP.KEYTYPE = K$RWPARM.KEYTYPE;

  25375   1 00052F  ECC7 001F                            LDB,B6   IOP$,AUTO
          1 000531  E2C7 0050                            LLH,R6   K$RWPARM+40,AUTO
          1 000533  EF46 0002                            STR,R6   2,B6

     1975    25376    4                     END;

  25376   1 000535  0F81 000A                            B        s:25381,PREL

     1976    25377    3                ELSE KN$IOP.KEY_ = VECTOR(NIL);

  25377   1 000537  AB80 0000 0000  02                   LAB,B2   0
          1 00053A  2C06                                 LDV,R2   6
          1 00053B  6C06                                 LDV,R6   6
          1 00053C  BCC7 001F                            LDB,B3   IOP$,AUTO
          1 00053E  3C0E                                 LDV,R3   14
          1 00053F  0008                                 MMM

     1977    25378    3                END;
PL6.E3A0      #003=KNA$USERIO File=KNA$APE.:E05TSI                               WED 07/30/97 00:58 Page:321  

     1978    25379
     1979    25380
     1980    25381    2           K$RWPARM.VDOFLGS.WAIT = KN$IOP.FLAGS.WAIT;

  25381   1 000540  ECC7 001F                            LDB,B6   IOP$,AUTO
          1 000542  E846 0003                            LDR,R6   3,B6
          1 000544  604A                                 SOR,R6   10
          1 000545  EAC7 0044                            SRM,R6,'0010'X    K$RWPARM+28,AUTO
          1 000547       0010

     1981    25382
     1982    25383    2           CALL KNA$FCNOU (%KV_VDO_FNC_RQSDAT,KNA$SSN,K$RWPARM,ERR)

  25383   1 000548  DBF0 0016                            LAB,B5   22,IMO
          1 00054A  CBC7 0061                            LAB,B4   ERR,AUTO
          1 00054C  CFC7 0070                            STB,B4   ROUTINE+10,AUTO
          1 00054E  BBC7 0028                            LAB,B3   K$RWPARM,AUTO
          1 000550  BFC7 006E                            STB,B3   ROUTINE+8,AUTO
          1 000552  ACC7 001D                            LDB,B2   SSN$,AUTO
          1 000554  AFC7 006C                            STB,B2   ROUTINE+6,AUTO
          1 000556  DFC7 006A                            STB,B5   ROUTINE+4,AUTO
          1 000558  BBC7 006A                            LAB,B3   ROUTINE+4,AUTO
          1 00055A  CBF0 0400                            LAB,B4   1024,IMO
          1 00055C  E380 0000 0000  xent                 LNJ,B6   KNA$FCNOU
          1 00055F       0003                            DC       s:25385,PREL
          1 000560  0F81 0016                            B        s:25393,PREL

     1983    25384    3           WHENALTRETURN DO;

     1984    25385    3                CALL KNA$RLSIOP(IOP$);

  25385   1 000562  EBC7 001F                            LAB,B6   IOP$,AUTO
          1 000564  EFC7 006A                            STB,B6   ROUTINE+4,AUTO
          1 000566  BBC7 006A                            LAB,B3   ROUTINE+4,AUTO
          1 000568  CBF0 0100                            LAB,B4   256,IMO
          1 00056A  E380 0000 0000  xent                 LNJ,B6   KNA$RLSIOP
PL6.E3A0      #003=KNA$USERIO File=KNA$APE.:E05TSI                               WED 07/30/97 00:58 Page:322  
          1 00056D       0001                            DC       s:25386,PREL

     1985    25386    3                KNA$SSN.IOPRD$ = ADDR(NIL);

  25386   1 00056E  EB80 0000 0000                       LAB,B6   0
          1 000571  DCC7 001D                            LDB,B5   SSN$,AUTO
          1 000573  EFC5 000D                            STB,B6   13,B5

     1986    25387    3                GOTO SSN_ERR;

  25387   1 000575  0F81 FD74                            B        s:25221,PREL

     1987    25388    3                END;
     1988    25389
     1989    25390
     1990    25391        /* Update the various read counters.
     1991    25392        */
     1992    25393    3           DO CASE(RESTYPE);

  25393   1 000577  B847 000D                            LDR,R3   RESTYPE,AUTO
          1 000579  3D05                                 CMV,R3   5
          1 00057A  0281 0038                            BGE      s:25408,PREL
          1 00057C  A830 0000 0582  01                   LDR,R2   s:25393+11,R3
          1 00057F  83A0 0000 0587  01                   JMP      s:25395,R2
          1 000582       002C                            DC       s:25408,PREL
          1 000583       0000                            DC       s:25395,PREL
          1 000584       000F                            DC       s:25398,PREL
          1 000585       001E                            DC       s:25401,PREL
          1 000586       0026                            DC       s:25403,PREL

     1993    25394    3            CASE(%G_DDEV_RES_HO#);

     1994    25395    3              G$JIT.READS_HOST = G$JIT.READS_HOST +1;

  25395   1 000587  EC80 0000 0000  xsym                 LDB,B6   G$JIT$
          1 00058A  8AC6 0041                            INC      65,B6
          1 00058C  8EC6 0040                            CAD      64,B6
PL6.E3A0      #003=KNA$USERIO File=KNA$APE.:E05TSI                               WED 07/30/97 00:58 Page:323  

     1995    25396    3              PS_LCP6STT.READS_HOST = PS_LCP6STT.READS_HOST +1;

  25396   1 00058E  8A80 0000 0057  xsym                 INC      PS_LCP6STT+87
          1 000591  8E80 0000 0056  xsym                 CAD      PS_LCP6STT+86
          1 000594  0F81 001E                            B        s:25408,PREL

     1996    25397    3            CASE(%G_DDEV_RES_UC#);

     1997    25398    3              G$JIT.READS_UC = G$JIT.READS_UC +1;

  25398   1 000596  EC80 0000 0000  xsym                 LDB,B6   G$JIT$
          1 000599  8AC6 0045                            INC      69,B6
          1 00059B  8EC6 0044                            CAD      68,B6

     1998    25399    3              PS_LCP6STT.READS_UC = PS_LCP6STT.READS_UC +1;

  25399   1 00059D  8A80 0000 0059  xsym                 INC      PS_LCP6STT+89
          1 0005A0  8E80 0000 0058  xsym                 CAD      PS_LCP6STT+88
          1 0005A3  0F81 000F                            B        s:25408,PREL

     1999    25400    3            CASE(%G_DDEV_RES_LG#);

     2000    25401    3              PS_LCP6STT.READS_LG = PS_LCP6STT.READS_LG +1;

  25401   1 0005A5  8A80 0000 005B  xsym                 INC      PS_LCP6STT+91
          1 0005A8  8E80 0000 005A  xsym                 CAD      PS_LCP6STT+90
          1 0005AB  0F81 0007                            B        s:25408,PREL

     2001    25402    3            CASE(%G_DDEV_RES_NA#);

     2002    25403    3              PS_LCP6STT.READS_NA = PS_LCP6STT.READS_NA +1;

  25403   1 0005AD  8A80 0000 005D  xsym                 INC      PS_LCP6STT+93
          1 0005B0  8E80 0000 005C  xsym                 CAD      PS_LCP6STT+92

     2003    25404    3              END/*do case*/;
PL6.E3A0      #003=KNA$USERIO File=KNA$APE.:E05TSI                               WED 07/30/97 00:58 Page:324  

     2004    25405
     2005    25406        /* If this is a no wait I/O then return.
     2006    25407        */
     2007    25408    2           IF NOT KN$IOP.FLAGS.WAIT

  25408   1 0005B3  ECC7 001F                            LDB,B6   IOP$,AUTO
          1 0005B5  82C6 0003                            LB,'4000'X        3,B6
          1 0005B7       4000
          1 0005B8  0581 00B5                            BBF      s:25450,PREL

     2008    25409    2           THEN GOTO FINISHED;
     2009    25410        /*     We sent off the message, now we just wait for the user to get
     2010    25411        his data delivered.
     2011    25412        */
     2012    25413    2           IF STR = KIDM_MON

  25413   1 0005BA  E847 000E                            LDR,R6   STR,AUTO
          1 0005BC  6D7F                                 CMV,R6   127
          1 0005BD  0981 001D                            BNE      s:25418,PREL
          1 0005BF  8DC7 0010                            CMN      USRFPT$,AUTO
          1 0005C1  0901 0007                            BE       s:25416,PREL
          1 0005C3  DCC7 0010                            LDB,B5   USRFPT$,AUTO
          1 0005C5  8285                                 LB,'0010'X        ,B5
          1 0005C6       0010
          1 0005C7  0501 0013                            BBT      s:25418,PREL

     2013    25414    2             AND (USRFPT$ = ADDR(NIL) OR NOT FPT_READ.V.BRKABLE)
     2014    25415    2           THEN
     2015    25416    2                CALL KNA$REG_USER(%GH_EVCW,SSN$);

  25416   1 0005C9  DBF0 0015                            LAB,B5   21,IMO
          1 0005CB  CBC7 001D                            LAB,B4   SSN$,AUTO
          1 0005CD  CFC7 006C                            STB,B4   ROUTINE+6,AUTO
          1 0005CF  DFC7 006A                            STB,B5   ROUTINE+4,AUTO
          1 0005D1  BBC7 006A                            LAB,B3   ROUTINE+4,AUTO
          1 0005D3  CBF0 0200                            LAB,B4   512,IMO
PL6.E3A0      #003=KNA$USERIO File=KNA$APE.:E05TSI                               WED 07/30/97 00:58 Page:325  
          1 0005D5  E380 0000 0000  xent                 LNJ,B6   KNA$REG_USER
          1 0005D8       0001                            DC       s:25416+16,PREL
          1 0005D9  0F81 0011                            B        s:25420,PREL

     2016    25417    2           ELSE
     2017    25418    2                CALL KNA$REG_USER(%GH_EVCRD,SSN$);

  25418   1 0005DB  DBF0 0016                            LAB,B5   22,IMO
          1 0005DD  CBC7 001D                            LAB,B4   SSN$,AUTO
          1 0005DF  CFC7 006C                            STB,B4   ROUTINE+6,AUTO
          1 0005E1  DFC7 006A                            STB,B5   ROUTINE+4,AUTO
          1 0005E3  BBC7 006A                            LAB,B3   ROUTINE+4,AUTO
          1 0005E5  CBF0 0200                            LAB,B4   512,IMO
          1 0005E7  E380 0000 0000  xent                 LNJ,B6   KNA$REG_USER
          1 0005EA       0001                            DC       s:25420,PREL

     2018    25419
     2019    25420    2           IF NOT KN$IOP.FLAGS.RDDONE      /* Read did not finish                */

  25420   1 0005EB  ECC7 001F                            LDB,B6   IOP$,AUTO
          1 0005ED  82C6 0003                            LB,'2000'X        3,B6
          1 0005EF       2000
          1 0005F0  0501 003C                            BBT      s:25433,PREL

     2020    25421    3           THEN DO;

     2021    25422    3                K$RWPARM.MAXNMBRCR = 0;

  25422   1 0005F2  8747 0046                            CL       K$RWPARM+30,AUTO

     2022    25423    3                IF NOT KNA$SSN.FLAGS.MRKPND AND NOT KNA$SSN.FLAGS.SSNERR

  25423   1 0005F4  DCC7 001D                            LDB,B5   SSN$,AUTO
          1 0005F6  8285                                 LB,'0080'X        ,B5
          1 0005F7       0080
          1 0005F8  0501 0008                            BBT      s:25426,PREL
          1 0005FA  8285                                 LB,'0800'X        ,B5
PL6.E3A0      #003=KNA$USERIO File=KNA$APE.:E05TSI                               WED 07/30/97 00:58 Page:326  
          1 0005FB       0800
          1 0005FC  0501 0004                            BBT      s:25426,PREL

     2023    25424    3                THEN
     2024    25425    3                     CALL CANCEL_READ;

  25425   1 0005FE  E3C0 008B                            LNJ,B6   s:0,PREL
          1 000600       0001                            DC       s:25426,PREL

     2025    25426    3                IF KN$IOP.FLAGS.RDDONE AND NOT G$MHJIT.CU$->G$U.ASYNCH & %U_ALIBFD

  25426   1 000601  ECC7 001F                            LDB,B6   IOP$,AUTO
          1 000603  82C6 0003                            LB,'2000'X        3,B6
          1 000605       2000
          1 000606  0581 000C                            BBF      s:25428,PREL
          1 000608  DC80 0000 0000  xsym                 LDB,B5   G$MHJIT$
          1 00060B  CCC5 0352                            LDB,B4   850,B5
          1 00060D  E844 0001                            LDR,R6   1,B4
          1 00060F  E570 0800                            AND,R6   2048,IMO
          1 000611  6901 001B                            BEZ,R6   s:25433,PREL

     2026    25427    3                THEN EXIT;
     2027    25428    3                IF KNA$SSN.FLAGS.SSNERR THEN KN$IOP.ERRCODE = KNA$SSN.ERROR;

  25428   1 000613  DCC7 001D                            LDB,B5   SSN$,AUTO
          1 000615  8285                                 LB,'0800'X        ,B5
          1 000616       0800
          1 000617  0581 0006                            BBF      s:25429,PREL

  25428   1 000619  8CC5 0001                            LDI      1,B5
          1 00061B  8D06                                 SDI      ,B6
          1 00061C  0F81 0005                            B        s:25430,PREL

     2028    25429    3                ELSE KN$IOP.ERRCODE = EBYD;

  25429   1 00061E  8C80 0000 000C  00                   LDI      EBYD
          1 000621  8D06                                 SDI      ,B6
PL6.E3A0      #003=KNA$USERIO File=KNA$APE.:E05TSI                               WED 07/30/97 00:58 Page:327  

     2029    25430    3                IF STR ~= KIDM_MON

  25430   1 000622  E847 000E                            LDR,R6   STR,AUTO
          1 000624  6D7F                                 CMV,R6   127
          1 000625  0901 0007                            BE       s:25433,PREL

     2030    25431    3                THEN G$JIT.JUNK.BACKP$='1'B;

  25431   1 000627  EC80 0000 0000  xsym                 LDB,B6   G$JIT$
          1 00062A  8946 0098                            LBT,'0100'X       152,B6
          1 00062C       0100

     2031    25432    3                END;

     2032    25433    2           IF KNA$SSN.FLAGS.MRKPND

  25433   1 00062D  ECC7 001D                            LDB,B6   SSN$,AUTO
          1 00062F  8286                                 LB,'0080'X        ,B6
          1 000630       0080
          1 000631  0581 0004                            BBF      s:25437,PREL

     2033    25434    2           THEN
     2034    25435    2                CALL SEND_MARKER;

  25435   1 000633  E3C0 0091                            LNJ,B6   s:0,PREL
          1 000635       0001                            DC       s:25437,PREL

     2035    25436
     2036    25437    2           ERROR = KN$IOP.ERRCODE;

  25437   1 000636  ECC7 001F                            LDB,B6   IOP$,AUTO
          1 000638  8C86                                 LDI      ,B6
          1 000639  DCC7 0008                            LDB,B5   @ERROR,AUTO
          1 00063B  8D05                                 SDI      ,B5

     2037    25438    2           IF PARMSPEC AND KNA_PARAMS.PTRS.PAR4$ ~= ADDR(NIL)
PL6.E3A0      #003=KNA$USERIO File=KNA$APE.:E05TSI                               WED 07/30/97 00:58 Page:328  

  25438   1 00063C  89C7 000F                            CMZ      PARMSPEC,AUTO
          1 00063E  0881 0010                            BAGE     s:25440,PREL
          1 000640  ECC7 000A                            LDB,B6   @KNA_PARAMS,AUTO
          1 000642  8DC6 000C                            CMN      12,B6
          1 000644  0901 000A                            BE       s:25440,PREL

     2038    25439    2           THEN KNA_PARAMS.PTRS.PAR4$->VLP_CG.MSGTYP# = KN$IOP.MSGTYPE;

  25439   1 000646  CCC6 000C                            LDB,B4   12,B6
          1 000648  ACC7 001F                            LDB,B2   IOP$,AUTO
          1 00064A  2C2C                                 LDV,R2   44
          1 00064B  6C08                                 LDV,R6   8
          1 00064C  BB84                                 LAB,B3   ,B4
          1 00064D  3C08                                 LDV,R3   8
          1 00064E  0008                                 MMM

     2039    25440    2           KNA$SSN.IOPRD$=ADDR(NIL);

  25440   1 00064F  EB80 0000 0000                       LAB,B6   0
          1 000652  CCC7 001D                            LDB,B4   SSN$,AUTO
          1 000654  EFC4 000D                            STB,B6   13,B4

     2040    25441    2           CALL KNA$RLSIOP(IOP$);

  25441   1 000656  EBC7 001F                            LAB,B6   IOP$,AUTO
          1 000658  EFC7 006A                            STB,B6   ROUTINE+4,AUTO
          1 00065A  BBC7 006A                            LAB,B3   ROUTINE+4,AUTO
          1 00065C  CBF0 0100                            LAB,B4   256,IMO
          1 00065E  E380 0000 0000  xent                 LNJ,B6   KNA$RLSIOP
          1 000661       0001                            DC       s:25442,PREL

     2041    25442    2           IF MYDCB.TYC.LD# = '1'B

  25442   1 000662  ECC7 001B                            LDB,B6   DCB$,AUTO
          1 000664  89C6 0001                            CMZ      1,B6
          1 000666  0881 0007                            BAGE     s:25450,PREL
PL6.E3A0      #003=KNA$USERIO File=KNA$APE.:E05TSI                               WED 07/30/97 00:58 Page:329  

     2042    25443    3           THEN DO;

     2043    25444
     2044    25445        /*E*     ERROR: KNA-E$LD
     2045    25446                 MESSAGE: The supplied buffer was too small
     2046    25447        */
     2047    25448    3                ERROR = ESHORT_BUFFER;

  25448   1 000668  8C80 0000 0008  00                   LDI      ESHORT_BUFFER
          1 00066B  DCC7 0008                            LDB,B5   @ERROR,AUTO
          1 00066D  8D05                                 SDI      ,B5

     2048    25449    3                END;

     2049    25450    2           END;

  25439   1                              FINISHED        null
     2050    25451    1   FINISHED:;
     2051    25452           %UNLOCK (G=KNA_LNKSSN);

  25457   1 00066E  BB80 0000 0001  02   FINISHED        LAB,B3   +1
          1 000671  CBF0 0100                            LAB,B4   256,IMO
          1 000673  E380 0000 0000  xent                 LNJ,B6   GHH$UNLOCK
          1 000676       0001                            DC       s:25459,PREL

     2052    25459    1      IF ERROR ~= '0'B

  25459   1 000677  ECC7 0008                            LDB,B6   @ERROR,AUTO
          1 000679  DB80 0000 0000  02                   LAB,B5   0
          1 00067C  5C01                                 LDV,R5   1
          1 00067D  0022                                 ACM      ;
          1 00067E       4406 0000                                ALPHANUM(0,B6,,4,FILL),;
          1 000680       4005 0000                                ALPHANUM(0,B5,,R5,FILL)
          1 000682  5381 0004                            CBE      s:25462,PREL

     2053    25460    1      THEN
PL6.E3A0      #003=KNA$USERIO File=KNA$APE.:E05TSI                               WED 07/30/97 00:58 Page:330  
     2054    25461    1           ALTRETURN;

  25461   1 000684  C380 0000 0000  xent                 LNJ,B4   X6A_AALT

     2055    25462    1      RETURN;

  25462   1 000687  C380 0000 0000  xent                 LNJ,B4   X6A_ARET

     2056    25463
     2057    25464    1   CANCEL_READ: PROC ALTRET;

  25464   1 00068A  EFC7 0068            CANCEL_READ     STB,B6   ROUTINE+2,AUTO

     2058    25465
     2059    25466    2      K$RWPARM.MRKTYP = %KV_VDOMRKTYP_ENDACK;

  25466   1 00068C  6C01                                 LDV,R6   1
          1 00068D  E7C7 0045                            STH,R6   K$RWPARM+29,AUTO

     2060    25467    2      CALL KNA$FCNOU (%KV_VDO_FNC_RQSDAT,KNA$SSN,K$RWPARM,ERR)

  25467   1 00068F  DBF0 0016                            LAB,B5   22,IMO
          1 000691  CBC7 0061                            LAB,B4   ERR,AUTO
          1 000693  CFC7 0070                            STB,B4   ROUTINE+10,AUTO
          1 000695  BBC7 0028                            LAB,B3   K$RWPARM,AUTO
          1 000697  BFC7 006E                            STB,B3   ROUTINE+8,AUTO
          1 000699  ACC7 001D                            LDB,B2   SSN$,AUTO
          1 00069B  AFC7 006C                            STB,B2   ROUTINE+6,AUTO
          1 00069D  DFC7 006A                            STB,B5   ROUTINE+4,AUTO
          1 00069F  BBC7 006A                            LAB,B3   ROUTINE+4,AUTO
          1 0006A1  CBF0 0400                            LAB,B4   1024,IMO
          1 0006A3  E380 0000 0000  xent                 LNJ,B6   KNA$FCNOU
          1 0006A6       001B                            DC       s:25475,PREL

     2061    25468    3      WHENRETURN DO;

     2062    25469    3           KNA$SSN.FLAGS.RRRPND = '1'B;
PL6.E3A0      #003=KNA$USERIO File=KNA$APE.:E05TSI                               WED 07/30/97 00:58 Page:331  

  25469   1 0006A7  ECC7 001D                            LDB,B6   SSN$,AUTO
          1 0006A9  8906                                 LBT,'0200'X       ,B6
          1 0006AA       0200

     2063    25470    4           CALL KNA$REG_USER(%GH_EVCW,SSN$) WHENALTRETURN DO;

  25470   1 0006AB  EBF0 0015                            LAB,B6   21,IMO
          1 0006AD  DBC7 001D                            LAB,B5   SSN$,AUTO
          1 0006AF  DFC7 006C                            STB,B5   ROUTINE+6,AUTO
          1 0006B1  EFC7 006A                            STB,B6   ROUTINE+4,AUTO
          1 0006B3  BBC7 006A                            LAB,B3   ROUTINE+4,AUTO
          1 0006B5  CBF0 0200                            LAB,B4   512,IMO
          1 0006B7  E380 0000 0000  xent                 LNJ,B6   KNA$REG_USER
          1 0006BA       0003                            DC       s:25471,PREL
          1 0006BB  0F81 0005                            B        s:25475,PREL

     2064    25471    4                ALTRETURN;

  25471   1 0006BD  ECC7 0068                            LDB,B6   ROUTINE+2,AUTO
          1 0006BF  B806                                 LDR,R3   ,B6
          1 0006C0  C3B6                                 LNJ,B4   ,B6,R3

     2065    25472    4                END;
     2066    25473    3           END;

     2067    25474
     2068    25475    2      RETURN;

  25475   1 0006C1  ECC7 0068                            LDB,B6   ROUTINE+2,AUTO
          1 0006C3  C3C6 0001                            LNJ,B4   1,B6

     2069    25476    2   END CANCEL_READ;
     2070    25477
     2071    25478    1   SEND_MARKER: PROC;

  25478   1 0006C5  EFC7 0068            SEND_MARKER     STB,B6   ROUTINE+2,AUTO
PL6.E3A0      #003=KNA$USERIO File=KNA$APE.:E05TSI                               WED 07/30/97 00:58 Page:332  

     2072    25479
     2073    25480    2      K$RWPARM = KNA_RWPARM_CON;

  25480   1 0006C7  AB80 0000 0000  xsym                 LAB,B2   KNA_RWPARM_CON
          1 0006CA  2C00                                 LDV,R2   0
          1 0006CB  6C52                                 LDV,R6   82
          1 0006CC  BB87                                 LAB,B3   ,AUTO
          1 0006CD  3C50                                 LDV,R3   80
          1 0006CE  0008                                 MMM

     2074    25481    2      K$RWPARM.MRKTYP = %KV_VDOMRKTYP_MRK;

  25481   1 0006CF  6C03                                 LDV,R6   3
          1 0006D0  E7C7 0045                            STH,R6   K$RWPARM+29,AUTO

     2075    25482    2      K$RWPARM.MARKER = KNA$SSN.MARKER;

  25482   1 0006D2  ECC7 001D                            LDB,B6   SSN$,AUTO
          1 0006D4  8CC6 0017                            LDI      23,B6
          1 0006D6  8D47 0035                            SDI      K$RWPARM+13,AUTO

     2076    25483    2      CALL KNA$FCNOU(%KV_VDO_FNC_MRK,KNA$SSN,K$RWPARM,ERR);

  25483   1 0006D8  DBF0 001F                            LAB,B5   31,IMO
          1 0006DA  CBC7 0061                            LAB,B4   ERR,AUTO
          1 0006DC  CFC7 0070                            STB,B4   ROUTINE+10,AUTO
          1 0006DE  ABC7 0028                            LAB,B2   K$RWPARM,AUTO
          1 0006E0  AFC7 006E                            STB,B2   ROUTINE+8,AUTO
          1 0006E2  EFC7 006C                            STB,B6   ROUTINE+6,AUTO
          1 0006E4  DFC7 006A                            STB,B5   ROUTINE+4,AUTO
          1 0006E6  BBC7 006A                            LAB,B3   ROUTINE+4,AUTO
          1 0006E8  CBF0 0400                            LAB,B4   1024,IMO
          1 0006EA  E380 0000 0000  xent                 LNJ,B6   KNA$FCNOU
          1 0006ED       0001                            DC       s:25484,PREL

     2077    25484    2      KNA$SSN.FLAGS.MRKPND = '0'B;
PL6.E3A0      #003=KNA$USERIO File=KNA$APE.:E05TSI                               WED 07/30/97 00:58 Page:333  

  25484   1 0006EE  ECC7 001D                            LDB,B6   SSN$,AUTO
          1 0006F0  8806                                 LBF,'0080'X       ,B6
          1 0006F1       0080

     2078    25485    2      RETURN;

  25485   1 0006F2  ECC7 0068                            LDB,B6   ROUTINE+2,AUTO
          1 0006F4  C3C6 0001                            LNJ,B4   1,B6
     2079    25486    2   END SEND_MARKER;
     2080    25487    1   END KNA$USERIO;

PL6.E3A0      #003=KNA$USERIO File=KNA$APE.:E05TSI                               WED 07/30/97 00:58 Page:334  
--  Include file information  --

   K$RWPARM.:E05TOU  is referenced.
   KV$VDO.:E05TOU  is referenced.
   GM_VIRTUAL_E.:E05TOU  is referenced.
   UD_ERRORS_C.:E05TOU  is referenced.
   F_ERRORS_C.:E05TOU  is referenced.
   G_LCP6_E.:E05TOU  is referenced.
   GF_LCP6_M.:E05TOU  is referenced.
   GU_MACROS_M.:E05TOU  is referenced.
   GU_LCP6_M.:E05TOU  is referenced.
   K_ID_E.:E05TOU  is referenced.
   KL_MACRO_C.:E05TOU  is referenced.
   P_FEP_M.:E05TOU  is referenced.
   K_SCODE_C.:E05TOU  is referenced.
   KN_DATA_M.:E05TOU  is referenced.
   GH_GATE_M.:E05TOU  cannot be made into a system file and is referenced.
   G_JIT_M.:E05TOU  is referenced.
   G_ROS_M.:E05TOU  is referenced.
   G_HJIT_M.:E05TOU  is referenced.
   GH_SCHD_M.:E05TOU  is referenced.
   GH_SCHD_E.:E05TOU  is referenced.
   GH_LCP6_M.:E05TOU  is referenced.
   KI_SUBS_C.:E05TOU  is referenced.
   KI_ERRORS_C.:E05TOU  is referenced.
   KN_ERRORS_C.:E05TOU  is referenced.
   KNA_MACRO_M.:E05TOU  is referenced.
      No diagnostics issued in procedure KNA$USERIO.
PL6.E3A0      #003=KNA$USERIO File=KNA$APE.:E05TSI                               WED 07/30/97 00:58 Page:335  

 **** Variables and constants ****

  ****  Section 000 RoData KNA$USERIO

  ****  Scalars and arrays  ****
HexLoc.c.b A Datatyp(siz) R M Lvl/name                 HexLoc.c.b A Datatyp(siz) R M Lvl/name

     4-0-0/w STRC(32)    r     1 EBADBUF                    C-0-0/w STRC(32)    r     1 EBYD
     2-0-0/w STRC(32)    r     1 EDCBNUM                    E-0-0/w STRC(32)    r     1 ELDSC
     A-0-0/w STRC(32)    r     1 ENO_DAT                    6-0-0/w STRC(32)    r     1 ENO_IOP
     8-0-0/w STRC(32)    r     1 ESHORT_BUFFER             10-0-0/w STRC(32)    r     1 EXTRA_READ

  ****  Auto variables  ****

  ****  Scalars and arrays  ****
HexLoc.c.b A Datatyp(siz) R M Lvl/name                 HexLoc.c.b A Datatyp(siz) R M Lvl/name

     4-0-0/w PTR         r     1 @DCBNUMBER                 8-0-0/w PTR         r     1 @ERROR
     A-0-0/w PTR         r     1 @KNA_PARAMS                6-0-0/w PTR         r     1 @UBUF$
    1B-0-0/w PTR         r     1 DCB$                      *0-0-0/w UBIN(16)    r     1 DCBNUMBER
    61-0-0/w UBIN(16)    r     1 ERR                       *0-0-0/w STRC(32)    r     1 ERROR
    22-0-0/w UBIN(16)    r     1 EVENT                     65-0-0/w UBIN(16)    r     1 FCN
    27-0-0/b BIT         r     1 FLOW_CONTROL              17-0-0/w VECT        r     1 FPT_BUF$
    1A-0-0/w UBIN(16)    r     1 FPT_CODE                  1F-0-0/w PTR         r     1 IOP$
    28-0-0/w STRC(656)   r     1 K$RWPARM                  12-0-0/w PTR         r     1 KEY$
    14-0-0/w UBIN(16)    r     1 KEYSZ                     *0-0-0/w STRC(1280)  r     1 KNA_PARAMS
     C-0-0/w UBIN(16)    r     1 MSGSIZE                   51-0-0/w STRC(256)   r     1 NWIO
     F-0-0/b BIT         r     1 PARMSPEC                   D-0-0/w UBIN(16)    r     1 RESTYPE
    66-0-0/w EPTR        r     1 ROUTINE                   1D-0-0/w PTR         r     1 SSN$
     E-0-0/w UBIN(16)    r     1 STR                       62-0-0/b BIT (32)    r     1 TCB_ERR
    *0-0-0/w VECT        r     1 UBUF$                     10-0-0/w PTR         r     1 USRFPT$

  ****  SYMREF variables  ****

  ****  Scalars and arrays  ****
HexLoc.c.b A Datatyp(siz) R M Lvl/name                 HexLoc.c.b A Datatyp(siz) R M Lvl/name

PL6.E3A0      #003=KNA$USERIO File=KNA$APE.:E05TSI                               WED 07/30/97 00:58 Page:336  
     0-0-0/w PTR         r     1 G$ASDT_MCL$                0-0-0/w PTR         r     1 G$JIT$
     0-0-0/w PTR         r     1 G$MHJIT$                   0-0-0/w PTR         r     1 G$ROS$
     0-0-0/w PTR         r     1 G$UHJIT$                   0-0-0/w STRC(48)    r     1 KNA_LNKSSN
     0-0-0/w STRC(656)   r     1 KNA_RWPARM_CON             0-0-0/w STRC(2208)  r     1 PS_LCP6STT

  ****  BASED and DCB variables  ****

  ****  Scalars and arrays  ****
HexLoc.c.b A Datatyp(siz) R M Lvl/name                 HexLoc.c.b A Datatyp(siz) R M Lvl/name

     0-0-0/w STRC(48)    r     1 FPT_READ                   0-0-0/w STRC(48)    r     1 FPT_WRITE
     0-0-0/w PTR         r     1 G$DCBTABLE(0:0)
     0-0-0/w STRC(5616)  r     1 G$JIT                      0-0-0/w STRC(27232) r     1 G$MHJIT
     0-0-0/w STRC(928)   r     1 G$ROS                      0-0-0/w STRC(384)   r     1 G$U
     0-0-0/w STRC(6480)  r     1 G$UHJIT                    0-0-0/w STRC(432)   r     1 KN$IOP
     0-0-0/w STRC(400)   r     1 KNA$SSN                    0-0-0/w ASTR(808)   r     1 MYDCB
     0-0-0/c CHAR        r     1 VFC                        0-0-0/w STRC(192)   r     1 VLP_CG


   Procedure KNA$USERIO requires 1782 words for executable code.
   Procedure KNA$USERIO requires 118 words of local(AUTO) storage.

    No errors detected in file KNA$APE.:E05TSI    .
PL6.E3A0      #003=KNA$USERIO File=KNA$APE.:E05TSI                               WED 07/30/97 00:58 Page:337  
          *** CROSS REFERENCE LISTING ***
**     DENOTES     IDENTIFIER DEFINITION
<<                 IDENTIFIER'S VALUE SET
>>                 IDENTIFIER'S VALUE USED
<>                 IDENTIFIER SET AND/OR USED
--                 IDENTIFIER REFERENCED
PL6.E3A0      #003=KNA$USERIO File=KNA$APE.:E05TSI                               WED 07/30/97 00:58 Page:338  
          MINI XREF LISTING

CANCEL_READ
     25464**PROC    25301--CALL    25425--CALL
CANT_OPEN
     25048**LABEL   25045--CALLALT
DCB$
     12207**DCL     13007--IMP-PTR 25041<<ASSIGN  25042>>IF      25044>>ASSIGN  25059>>ASSIGN  25075>>ASSIGN
     25077>>ASSIGN  25091>>ASSIGN  25151>>IF      25154>>ASSIGN  25162>>ASSIGN  25163>>IF      25207>>IF
     25341>>ASSIGN  25342<>CALL    25364>>ASSIGN  25442>>IF
DCBNUMBER
     11582**DCL        84--PROC    24978--ENTRY   24982--ENTRY   24986--ENTRY   25006>>IF      25006>>IF
     25041>>ASSIGN  25045<>CALL
EBADBUF
     11818**DCL     25020>>ASSIGN
EBYD
     12006**DCL     25222>>ASSIGN  25269>>ASSIGN  25429>>ASSIGN
EDCBNUM
     11771**DCL     25008>>ASSIGN
ELDSC
     12053**DCL     25067>>ASSIGN
ENO_DAT
     11959**DCL     25209>>ASSIGN
ENO_IOP
     11865**DCL     25258>>ASSIGN  25321>>ASSIGN
ERR
     12564**DCL     25171<>CALL    25198<>CALL    25383<>CALL    25467<>CALL    25483<>CALL
ERROR
     11598**DCL        84--PROC    24978--ENTRY   24982--ENTRY   24986--ENTRY   25005<<ASSIGN  25008<<ASSIGN
     25020<<ASSIGN  25045<>CALL    25046>>IF      25067<<ASSIGN  25122<<ASSIGN  25209<<ASSIGN  25221<<ASSIGN
     25222<<ASSIGN  25258<<ASSIGN  25265<<ASSIGN  25268<<ASSIGN  25269<<ASSIGN  25295<<ASSIGN  25321<<ASSIGN
     25437<<ASSIGN  25448<<ASSIGN  25459>>IF
ESHORT_BUFFER
     11912**DCL     25122>>ASSIGN  25448>>ASSIGN
PL6.E3A0      #003=KNA$USERIO File=KNA$APE.:E05TSI                               WED 07/30/97 00:58 Page:339  
EVENT
     12211**DCL     25309<<ASSIGN  25310<>CALL
EXTRA_READ
     12100**DCL     25295>>ASSIGN  25308>>ASSIGN
FCN
     12567**DCL     25138<<ASSIGN  25139<<ASSIGN  25171<>CALL
FINISHED
     25439**LABEL   25068--GOTO    25120--GOTO    25210--GOTO    25224--GOTO    25259--GOTO    25296--GOTO
     25322--GOTO    25409--GOTO
FLOW_CONTROL
     12218**DCL     24970<<ASSIGN  24983<<ASSIGN  24988<<ASSIGN  25113>>IF      25130>>IF      25137>>IF
     25174>>IF
FPT_BUF$
     12205**DCL     24963<<ASSIGN  24964<<ASSIGN  24994<<ASSIGN  25017>>IF      25017>>IF      25092>>IF
     25096>>ASSIGN  25144>>ASSIGN  25343>>ASSIGN
FPT_CODE
     12206**DCL     24967<<ASSIGN  24979<<ASSIGN  24991<<ASSIGN  25015>>IF      25099>>IF
FPT_READ.V.BRKABLE
     24026**DCL     25413>>IF
FPT_READ.V.DVBYTE
     24027**DCL     25361>>ASSIGN
FPT_READ.V.EVENT
     24027**DCL     25360>>ASSIGN
FPT_READ.V.KEYR
     24025**DCL     25370>>IF
FPT_READ.V.KEYS
     24025**DCL     25365>>IF
FPT_READ.V.KEYTYPE
     24030**DCL     25362>>ASSIGN
FPT_READ.V.READMLT
     24026**DCL     25017>>IF      25355>>IF
FPT_READ.V.WAIT
     24026**DCL     25354>>ASSIGN
FPT_WRITE.V.DVBYTE
     24052**DCL     25106>>ASSIGN
FPT_WRITE.V.EOM
PL6.E3A0      #003=KNA$USERIO File=KNA$APE.:E05TSI                               WED 07/30/97 00:58 Page:340  
     24051**DCL     25163>>IF
FPT_WRITE.V.EOMCHAR
     24055**DCL     25165>>ASSIGN
FPT_WRITE.V.KEYTYPE
     24051**DCL     25160>>ASSIGN
G$ASDT_MCL$
     24086**DCL     23319--IMP-PTR
G$DCBTABLE
     23135**DCL     25041>>ASSIGN
G$ECCB.FLTFLG
     22973**DCL     23004--REDEF
G$JIT.ERRLOG
     12917**DCL     12920--REDEF
G$JIT.JSUNIT
     12656**DCL     12657--REDEF
G$JIT.JUNK.BACKP$
     12909**DCL     25220<<ASSIGN  25431<<ASSIGN
G$JIT.MCLS
     12655**DCL     12655--REDEF
G$JIT.READS_HOST
     12747**DCL     25395<<ASSIGN  25395>>ASSIGN
G$JIT.READS_UC
     12748**DCL     25398<<ASSIGN  25398>>ASSIGN
G$JIT.TMRZ
     12924**DCL     12925--REDEF
G$JIT.USER_EXTIME
     12648**DCL     12649--REDEF
G$JIT.USER_MEMTIME
     12651**DCL     12651--REDEF
G$JIT.USER_SVTIME
     12650**DCL     12650--REDEF
G$JIT.USR#
     12645**DCL     25332>>ASSIGN
G$JIT.WRITES_HOST
     12748**DCL     25238<<ASSIGN  25238>>ASSIGN
G$JIT.WRITES_UC
PL6.E3A0      #003=KNA$USERIO File=KNA$APE.:E05TSI                               WED 07/30/97 00:58 Page:341  
     12749**DCL     25242<<ASSIGN  25242>>ASSIGN
G$JIT$
     24082**DCL     12587--IMP-PTR 25220>>ASSIGN  25238>>ASSIGN  25238>>ASSIGN  25242>>ASSIGN  25242>>ASSIGN
     25332>>ASSIGN  25395>>ASSIGN  25395>>ASSIGN  25398>>ASSIGN  25398>>ASSIGN  25431>>ASSIGN
G$MHJIT.CU$
     22401**DCL     25426>>IF
G$MHJIT.INTCON.HHJIT
     22535**DCL     22535--REDEF
G$MHJIT.INTCON.P$$
     22508**DCL     22508--REDEF
G$MHJIT.ISA_BIGFOOT.P$$
     19453**DCL     19453--REDEF
G$MHJIT.ISA_DBINH.P$$
     20667**DCL     20667--REDEF
G$MHJIT.ISA_IDLE.P$$
     17548**DCL     17548--REDEF
G$MHJIT.ISA_LVL10.P$$
     20970**DCL     20970--REDEF
G$MHJIT.ISA_LVL11.P$$
     21273**DCL     21273--REDEF
G$MHJIT.ISA_LVL12.P$$
     21576**DCL     21576--REDEF
G$MHJIT.ISA_LVL5.P$$
     19756**DCL     19756--REDEF
G$MHJIT.ISA_OV.P$$
     19150**DCL     19150--REDEF
G$MHJIT.ISA_PFS.P$$
     18821**DCL     18821--REDEF
G$MHJIT.ISA_RT_CLOCK.P$$
     22183**DCL     22183--REDEF
G$MHJIT.ISA_SATYR_RCV.P$$
     20060**DCL     20060--REDEF
G$MHJIT.ISA_SATYR_TRN.P$$
     20364**DCL     20364--REDEF
G$MHJIT.ISA_SCHD.P$$
     21879**DCL     21879--REDEF
PL6.E3A0      #003=KNA$USERIO File=KNA$APE.:E05TSI                               WED 07/30/97 00:58 Page:342  
G$MHJIT.ISA_WDOG.P$$
     18929**DCL     18929--REDEF
G$MHJIT.TSA_DB.ISA.P$$
     18151**DCL     18151--REDEF
G$MHJIT.TSA_DB.P$$
     18022**DCL     18022--REDEF   18023--REDEF
G$MHJIT.TSA_HND.ISA.P$$
     22729**DCL     22729--REDEF
G$MHJIT.TSA_HND.P$$
     22600**DCL     22600--REDEF   22601--REDEF
G$MHJIT.TSA_MON.ISA.P$$
     17763**DCL     17763--REDEF
G$MHJIT.TSA_MON.P$$
     17634**DCL     17634--REDEF   17635--REDEF
G$MHJIT.TSA_OV.ISA.P$$
     18539**DCL     18539--REDEF
G$MHJIT.TSA_OV.P$$
     18410**DCL     18410--REDEF   18411--REDEF
G$MHJIT$
     24085**DCL     16073--IMP-PTR 25426>>IF
G$ROS.AUTO_DS$
     13061**DCL     13062--REDEF
G$ROS.AUTO_T$
     13062**DCL     13062--REDEF
G$ROS.DCBPTR$
     13057**DCL     25041>>ASSIGN
G$ROS.NUMDCBS
     13061**DCL     25006>>IF
G$ROS$
     24083**DCL     13052--IMP-PTR 25006>>IF      25041>>ASSIGN
G$U.ASYNCH
     23095**DCL     25426>>IF
G$U.MISC
     23095**DCL     23095--REDEF
G$UHJIT.DMN.ID
     14817**DCL     24972>>IF      24972>>IF
PL6.E3A0      #003=KNA$USERIO File=KNA$APE.:E05TSI                               WED 07/30/97 00:58 Page:343  
G$UHJIT.ISA_USR
     14522**DCL     14817--REDEF
G$UHJIT.ISA_USR.P$$
     14597**DCL     14597--REDEF
G$UHJIT.TSA_CP.ISA.P$$
     15804**DCL     15804--REDEF
G$UHJIT.TSA_CP.P$$
     15675**DCL     15675--REDEF   15676--REDEF
G$UHJIT.TSA_DB.ISA.P$$
     15416**DCL     15416--REDEF
G$UHJIT.TSA_DB.P$$
     15287**DCL     15287--REDEF   15288--REDEF
G$UHJIT.TSA_RTT.P$$
     16050**DCL     16050--REDEF   16051--REDEF
G$UHJIT.TSA_USR.ISA.P$$
     15006**DCL     15006--REDEF
G$UHJIT.TSA_USR.P$$
     14877**DCL     14877--REDEF   14878--REDEF
G$UHJIT$
     24084**DCL     13099--IMP-PTR 24972>>IF      24972>>IF
GHH$LOCK
      2052**DCL-ENT 25057--CALL
GHH$UNLOCK
      2052**DCL-ENT 25457--CALL
GHS$EVENT
     24949**DCL-ENT 25310--CALL
IOP$
     12209**DCL     23141--IMP-PTR 25256<>CALL    25261>>ASSIGN  25265>>IF      25265>>ASSIGN  25272>>ASSIGN
     25274<>CALL    25299<<ASSIGN  25300>>ASSIGN  25309>>ASSIGN  25318<>CALL    25330>>ASSIGN  25331>>ASSIGN
     25332>>ASSIGN  25337>>ASSIGN  25339>>ASSIGN  25341>>ASSIGN  25342>>CALL    25343>>ASSIGN  25344>>CALL
     25344>>CALL    25354>>ASSIGN  25356>>ASSIGN  25360>>ASSIGN  25372>>ASSIGN  25373>>ASSIGN  25374>>CALL
     25374>>CALL    25375>>ASSIGN  25377>>ASSIGN  25381>>ASSIGN  25385<>CALL    25408>>IF      25420>>IF
     25426>>IF      25428>>ASSIGN  25429>>ASSIGN  25437>>ASSIGN  25439>>ASSIGN  25441<>CALL
K$RWPARM
     12236**DCL     25079<<ASSIGN  25171<>CALL    25198<>CALL    25383<>CALL    25467<>CALL    25480<<ASSIGN
     25483<>CALL
PL6.E3A0      #003=KNA$USERIO File=KNA$APE.:E05TSI                               WED 07/30/97 00:58 Page:344  
K$RWPARM.BLKREC
     12266**DCL     12291--REDEF
K$RWPARM.DVE.DVBYTE
     12298**DCL     25106<<ASSIGN  25361<<ASSIGN
K$RWPARM.DVE.DVBYTE.NODAT
     12311**DCL     25108>>IF
K$RWPARM.DVE.DVBYTE.RRR
     12310**DCL     25125>>IF      25254>>IF
K$RWPARM.DVE.DVBYTE.VFC
     12306**DCL     12307--REDEF   25145>>IF      25153<<ASSIGN  25166<<ASSIGN
K$RWPARM.DVE.EOMCHAR
     12314**DCL     12318--REDEF   25165<<ASSIGN
K$RWPARM.DVE.VFC
     12318**DCL     25147<<ASSIGN  25154<<ASSIGN
K$RWPARM.EOM_EOR
     12335**DCL     25167<<ASSIGN
K$RWPARM.ERR
     12378**DCL     12383--REDEF
K$RWPARM.FC
     12342**DCL     12343--REDEF
K$RWPARM.FLDID
     12524**DCL     12525--REDEF
K$RWPARM.KEY$
     12522**DCL     25156<<ASSIGN  25367<<ASSIGN
K$RWPARM.KEYSZ
     12533**DCL     25157<<ASSIGN  25368<<ASSIGN
K$RWPARM.KEYTYPE
     12531**DCL     12532--REDEF   25160<<ASSIGN  25161>>IF      25162<<ASSIGN  25362<<ASSIGN  25363>>IF
     25364<<ASSIGN  25375>>ASSIGN
K$RWPARM.MARKER
     12291**DCL     25482<<ASSIGN
K$RWPARM.MAXNMBBYT
     12519**DCL     25351<<ASSIGN  25358<<ASSIGN
K$RWPARM.MAXNMBRCR
     12518**DCL     25350<<ASSIGN  25422<<ASSIGN
K$RWPARM.MAXRCRBYTSIZ
PL6.E3A0      #003=KNA$USERIO File=KNA$APE.:E05TSI                               WED 07/30/97 00:58 Page:345  
     12520**DCL     25192<<ASSIGN  25349<<ASSIGN  25358>>ASSIGN
K$RWPARM.MRKTYP
     12516**DCL     25126<<ASSIGN  25302<<ASSIGN  25466<<ASSIGN  25481<<ASSIGN
K$RWPARM.MSG$
     12237**DCL     12238--REDEF   12247--REDEF
K$RWPARM.MSGC$
     12238**DCL     25144<<ASSIGN  25147>>ASSIGN  25148<<ASSIGN  25148>>ASSIGN
K$RWPARM.MSGID
     12353**DCL     12358--REDEF   25085<<ASSIGN
K$RWPARM.MSGIDXT
     12366**DCL     12370--REDEF
K$RWPARM.MSGSZ
     12248**DCL     25142<<ASSIGN  25149<<ASSIGN  25149>>ASSIGN
K$RWPARM.MSGTYP
     12257**DCL     25084<<ASSIGN
K$RWPARM.ORG
     12502**DCL     12503--REDEF
K$RWPARM.READMLT
     12326**DCL     25357<<ASSIGN
K$RWPARM.RSN
     12343**DCL     25194<<ASSIGN  25195<<ASSIGN
K$RWPARM.STATION
     12252**DCL     25083<<ASSIGN
K$RWPARM.STR
     12517**DCL     25141<<ASSIGN  25191<<ASSIGN  25300<<ASSIGN  25348<<ASSIGN
K$RWPARM.VDOFLGS
     12504**DCL     12515--REDEF
K$RWPARM.VDOFLGS.WAIT
     12511**DCL     25381<<ASSIGN
KEY$
     12202**DCL     24965<<ASSIGN  24998<<ASSIGN  25156>>ASSIGN  25367>>ASSIGN  25372>>ASSIGN
KEYSZ
     12203**DCL     24966<<ASSIGN  24999<<ASSIGN  25157>>ASSIGN  25368>>ASSIGN  25373>>ASSIGN
KN$IOP
     23141**DCL     25330<<ASSIGN
KN$IOP.ARS
PL6.E3A0      #003=KNA$USERIO File=KNA$APE.:E05TSI                               WED 07/30/97 00:58 Page:346  
     23197**DCL     23198--REDEF   23199--REDEF
KN$IOP.BUFSEGDES
     23249**DCL     25344<>CALL
KN$IOP.BUF_
     23212**DCL     25343<<ASSIGN  25344<>CALL
KN$IOP.DCB$
     23225**DCL     25300>>ASSIGN  25341<<ASSIGN
KN$IOP.DCBSEGDES
     23293**DCL     25342<>CALL
KN$IOP.ERRCODE
     23159**DCL     25265>>IF      25265>>ASSIGN  25428<<ASSIGN  25429<<ASSIGN  25437>>ASSIGN
KN$IOP.EVENT
     23311**DCL     25309>>ASSIGN  25360<<ASSIGN
KN$IOP.FLAGS.INUSE
     23207**DCL     25331<<ASSIGN
KN$IOP.FLAGS.RDDONE
     23206**DCL     25420>>IF      25426>>IF
KN$IOP.FLAGS.READMLT
     23208**DCL     25356<<ASSIGN
KN$IOP.FLAGS.WAIT
     23205**DCL     25339<<ASSIGN  25354<<ASSIGN  25381>>ASSIGN  25408>>IF
KN$IOP.KEYSEGDES
     23271**DCL     25374<>CALL
KN$IOP.KEYTYPE
     23198**DCL     25375<<ASSIGN
KN$IOP.KEY_
     23219**DCL     25372<<ASSIGN  25373<<ASSIGN  25374<>CALL    25377<<ASSIGN
KN$IOP.L.USER#
     23231**DCL     25332<<ASSIGN
KN$IOP.LNK$
     23227**DCL     23228--REDEF
KN$IOP.MSGID
     23226**DCL     25272>>ASSIGN
KN$IOP.MSGTYPE
     23310**DCL     25439>>ASSIGN
KNA$FCNO
PL6.E3A0      #003=KNA$USERIO File=KNA$APE.:E05TSI                               WED 07/30/97 00:58 Page:347  
     24951**DCL-ENT 25109--ASSIGN
KNA$FCNOU
     24950**DCL-ENT 25110--ASSIGN  25383--CALL    25467--CALL    25483--CALL
KNA$GETIOP
     24953**DCL-ENT 25256--CALL    25318--CALL
KNA$OPEN
     24952**DCL-ENT 25045--CALL
KNA$REG_USER
     24955**DCL-ENT 25215--CALL    25263--CALL    25416--CALL    25418--CALL    25470--CALL
KNA$RLSIOP
     24954**DCL-ENT 25274--CALL    25385--CALL    25441--CALL
KNA$SAVEMAP
     24956**DCL-ENT 25342--CALL    25344--CALL    25374--CALL
KNA$SSN
     23019**DCL     25171<>CALL    25198<>CALL    25383<>CALL    25467<>CALL    25483<>CALL
KNA$SSN.ERROR
     23045**DCL     25221>>ASSIGN  25268>>ASSIGN  25428>>ASSIGN
KNA$SSN.FLAGS.BLOCKED
     23023**DCL     25136<<ASSIGN  25188>>IF      25203<<ASSIGN  25223<<ASSIGN
KNA$SSN.FLAGS.MRKPND
     23027**DCL     25061>>IF      25423>>IF      25433>>IF      25484<<ASSIGN
KNA$SSN.FLAGS.MULT_STR
     23023**DCL     25113>>IF      25130>>IF
KNA$SSN.FLAGS.RRRPND
     23023**DCL     25262<<ASSIGN  25469<<ASSIGN
KNA$SSN.FLAGS.SSNERR
     23023**DCL     25221>>IF      25268>>IF      25423>>IF      25428>>IF
KNA$SSN.IOPQ$
     23081**DCL     25261<<ASSIGN  25275<<ASSIGN
KNA$SSN.IOPRD$
     23081**DCL     23081--REDEF   25291>>IF      25299>>ASSIGN  25303>>IF      25337<<ASSIGN  25386<<ASSIGN
     25440<<ASSIGN
KNA$SSN.MARKER
     23087**DCL     25482>>ASSIGN
KNA$SSN.REGRSN
     23086**DCL     25196<<ASSIGN  25204>>IF
PL6.E3A0      #003=KNA$USERIO File=KNA$APE.:E05TSI                               WED 07/30/97 00:58 Page:348  
KNA$SSN.RLCID.NODE#
     23085**DCL     23085--REDEF
KNA$SSN.STATE
     23086**DCL     25065>>IF      25217>>IF
KNA$SSN.THRTLVL.MAXNMBBYT
     23078**DCL     25130>>IF      25177<<ASSIGN  25177>>ASSIGN
KNA$SSN.THRTLVL.MAXNMBRCR
     23078**DCL     25113>>IF      25130>>IF      25176<<ASSIGN  25176>>ASSIGN  25193>>IF
KNA$SSN.THRTLVL.MAXRCRBYTSIZ
     23079**DCL     25113>>IF      25119>>IF      25121>>ASSIGN
KNA$SSN.THRTLVL.STR
     23079**DCL     25113>>IF      25113>>IF      25130>>IF      25130>>IF
KNA$SSN.USER#
     23086**DCL     25310<>CALL
KNA_LNKSSN
     24118**DCL     25057<>CALL    25457<>CALL
KNA_LNKSSN.SREG
     24123**DCL     25293>>IF
KNA_PARAMS
     11631**DCL        84--PROC    24978--ENTRY   24982--ENTRY   24986--ENTRY   24995--ASSIGN
KNA_PARAMS.BND
     11691**DCL     11692--REDEF
KNA_PARAMS.BND.PAR2
     11691**DCL     24966>>ASSIGN
KNA_PARAMS.BND.PAR3
     11691**DCL     24964>>ASSIGN
KNA_PARAMS.CPTRS.PAR3$
     11689**DCL     24963>>ASSIGN
KNA_PARAMS.DESC
     11693**DCL     11694--REDEF
KNA_PARAMS.MCL.CODE
     11638**DCL     11638--REDEF   24967>>ASSIGN
KNA_PARAMS.PTRS
     11687**DCL     11688--REDEF   11690--REDEF   11690--REDEF   11690--REDEF
KNA_PARAMS.PTRS.PAR1$
     11687**DCL     24968>>ASSIGN
PL6.E3A0      #003=KNA$USERIO File=KNA$APE.:E05TSI                               WED 07/30/97 00:58 Page:349  
KNA_PARAMS.PTRS.PAR2$
     11687**DCL     24965>>ASSIGN
KNA_PARAMS.PTRS.PAR4$
     11687**DCL     25081>>IF      25083>>ASSIGN  25084>>ASSIGN  25085>>ASSIGN  25271>>IF      25272>>ASSIGN
     25438>>IF      25439>>ASSIGN
KNA_RWPARM_CON
     24142**DCL     25079>>ASSIGN  25480>>ASSIGN
KNA_RWPARM_CON.BLKREC
     24172**DCL     24197--REDEF
KNA_RWPARM_CON.DVE.DVBYTE.VFC
     24212**DCL     24213--REDEF
KNA_RWPARM_CON.DVE.EOMCHAR
     24220**DCL     24224--REDEF
KNA_RWPARM_CON.ERR
     24284**DCL     24289--REDEF
KNA_RWPARM_CON.FC
     24248**DCL     24249--REDEF
KNA_RWPARM_CON.FLDID
     24430**DCL     24431--REDEF
KNA_RWPARM_CON.KEYTYPE
     24437**DCL     24438--REDEF
KNA_RWPARM_CON.MSG$
     24143**DCL     24144--REDEF   24153--REDEF
KNA_RWPARM_CON.MSGID
     24259**DCL     24264--REDEF
KNA_RWPARM_CON.MSGIDXT
     24272**DCL     24276--REDEF
KNA_RWPARM_CON.ORG
     24408**DCL     24409--REDEF
KNA_RWPARM_CON.VDOFLGS
     24410**DCL     24421--REDEF
MAINSTREAM
     25005**LABEL   24976--GOTO    25000--GOTO
MSGSIZE
     12197**DCL     25094<<ASSIGN  25096<<ASSIGN  25113>>IF      25121<<ASSIGN  25130>>IF      25142>>ASSIGN
     25177>>ASSIGN  25192>>ASSIGN  25240>>ASSIGN  25244>>ASSIGN  25247>>ASSIGN  25250>>ASSIGN  25349>>ASSIGN
PL6.E3A0      #003=KNA$USERIO File=KNA$APE.:E05TSI                               WED 07/30/97 00:58 Page:350  
MYDCB.DCBNAME.L
     13034**DCL     13034--IMP-SIZ
MYDCB.DDEV.RES
     13017**DCL     25091>>ASSIGN
MYDCB.DVBYTE.NODAT
     13013**DCL     25207>>IF
MYDCB.DVFC
     13027**DCL     25151>>IF      25154>>ASSIGN
MYDCB.EOMCHAR
     13025**DCL     13025--REDEF   13026--REDEF
MYDCB.FCD
     13021**DCL     25042>>IF
MYDCB.FLDID
     13024**DCL     13024--REDEF
MYDCB.KEYTYPE
     13027**DCL     25162>>ASSIGN  25364>>ASSIGN
MYDCB.ORG
     13022**DCL     25044<<ASSIGN
MYDCB.RES
     13019**DCL     13020--REDEF   25163>>IF
MYDCB.SSN$
     13034**DCL     25059>>ASSIGN
MYDCB.STRM
     13014**DCL     25077>>ASSIGN  25300>>ASSIGN
MYDCB.TYC
     13011**DCL     25075<<ASSIGN
MYDCB.TYC.LD#
     13011**DCL     25442>>IF
NWIO
     12539**DCL     25306<<ASSIGN  25307--ASSIGN  25310<>CALL
NWIO.P#
     12539**DCL     25307<<ASSIGN  25307--ASSIGN
PARMSPEC
     12200**DCL     24969<<ASSIGN  24996<<ASSIGN  25081>>IF      25271>>IF      25438>>IF
PS_LCP6STT.BYTES_WRT_HOST
     24872**DCL     25240<<ASSIGN  25240>>ASSIGN
PL6.E3A0      #003=KNA$USERIO File=KNA$APE.:E05TSI                               WED 07/30/97 00:58 Page:351  
PS_LCP6STT.BYTES_WRT_LG
     24882**DCL     25247<<ASSIGN  25247>>ASSIGN
PS_LCP6STT.BYTES_WRT_NA
     24887**DCL     25250<<ASSIGN  25250>>ASSIGN
PS_LCP6STT.BYTES_WRT_UC
     24877**DCL     25244<<ASSIGN  25244>>ASSIGN
PS_LCP6STT.READS_HOST
     24812**DCL     25396<<ASSIGN  25396>>ASSIGN
PS_LCP6STT.READS_LG
     24822**DCL     25401<<ASSIGN  25401>>ASSIGN
PS_LCP6STT.READS_NA
     24827**DCL     25403<<ASSIGN  25403>>ASSIGN
PS_LCP6STT.READS_UC
     24817**DCL     25399<<ASSIGN  25399>>ASSIGN
PS_LCP6STT.REQSTATS.DSPMSK
     24707**DCL     24713--REDEF
PS_LCP6STT.REQSTATS.SLCMSK
     24748**DCL     24755--REDEF
PS_LCP6STT.WRITES_HOST
     24832**DCL     25239<<ASSIGN  25239>>ASSIGN
PS_LCP6STT.WRITES_LG
     24842**DCL     25246<<ASSIGN  25246>>ASSIGN
PS_LCP6STT.WRITES_NA
     24847**DCL     25249<<ASSIGN  25249>>ASSIGN
PS_LCP6STT.WRITES_UC
     24837**DCL     25243<<ASSIGN  25243>>ASSIGN
READ_COMPLETED
     25309**LABEL   25304--GOTO
REG_BLOCKED
     25207**LABEL   25189--GOTO
RESTYPE
     12198**DCL     25091<<ASSIGN  25236>>DOCASE  25393>>DOCASE
ROUTINE
     12568**DCL     25109<<ASSIGN  25110<<ASSIGN  25171>>CALL    25198>>CALL
SEND_MARKER
     25478**PROC    25063--CALL    25435--CALL
PL6.E3A0      #003=KNA$USERIO File=KNA$APE.:E05TSI                               WED 07/30/97 00:58 Page:352  
SETUP_MON
     24991**LABEL   24980--GOTO
SETUP_MON_WRITE
     24988**LABEL   24984--GOTO
SSN$
     12208**DCL     23019--IMP-PTR 25059<<ASSIGN  25061>>IF      25065>>IF      25113>>IF      25113>>IF
     25113>>IF      25113>>IF      25113>>IF      25119>>IF      25121>>ASSIGN  25130>>IF      25130>>IF
     25130>>IF      25130>>IF      25130>>IF      25136>>ASSIGN  25171>>CALL    25176>>ASSIGN  25176>>ASSIGN
     25177>>ASSIGN  25177>>ASSIGN  25188>>IF      25193>>IF      25196>>ASSIGN  25198>>CALL    25203>>ASSIGN
     25204>>IF      25215<>CALL    25217>>IF      25221>>IF      25221>>ASSIGN  25223>>ASSIGN  25261>>ASSIGN
     25262>>ASSIGN  25263<>CALL    25268>>IF      25268>>ASSIGN  25275>>ASSIGN  25291>>IF      25299>>ASSIGN
     25303>>IF      25310>>CALL    25337>>ASSIGN  25383>>CALL    25386>>ASSIGN  25416<>CALL    25418<>CALL
     25423>>IF      25423>>IF      25428>>IF      25428>>ASSIGN  25433>>IF      25440>>ASSIGN  25467>>CALL
     25469>>ASSIGN  25470<>CALL    25482>>ASSIGN  25483>>CALL    25484>>ASSIGN
SSN_ERR
     25221**LABEL   25171--CALLALT 25198--CALLALT 25301--CALLALT 25387--GOTO
STR
     12199**DCL     24973<<ASSIGN  24974<<ASSIGN  24997<<ASSIGN  25076>>IF      25077<<ASSIGN  25113>>IF
     25113>>IF      25130>>IF      25130>>IF      25141>>ASSIGN  25191>>ASSIGN  25217>>IF      25348>>ASSIGN
     25413>>IF      25430>>IF
TCB_ERR
     12565**DCL     25308<<ASSIGN  25310<>CALL
TEMP
     12212**DCL     12216--REDEF
UBUF$
     11583**DCL        84--PROC    24978--ENTRY   24982--ENTRY   24986--ENTRY   24994>>ASSIGN
USRFPT$
     12201**DCL     24020--IMP-PTR 24046--IMP-PTR 24968<<ASSIGN  24995<<ASSIGN  25015>>IF      25017>>IF
     25105>>IF      25106>>ASSIGN  25151>>IF      25158>>IF      25160>>ASSIGN  25163>>IF      25165>>ASSIGN
     25352>>IF      25354>>ASSIGN  25355>>IF      25360>>ASSIGN  25361>>ASSIGN  25362>>ASSIGN  25365>>IF
     25370>>IF      25413>>IF      25413>>IF
VFC
     24078**DCL     25147>>ASSIGN
VLP_CG.MSGID#
     24075**DCL     25085>>ASSIGN  25272<<ASSIGN
VLP_CG.MSGTYP#
PL6.E3A0      #003=KNA$USERIO File=KNA$APE.:E05TSI                               WED 07/30/97 00:58 Page:353  
     24074**DCL     25084>>ASSIGN  25439<<ASSIGN
VLP_CG.STATION#
     24074**DCL     25083>>ASSIGN
WRITELOOP
     25104**LABEL   25179--EXIT    25205--GOTO
