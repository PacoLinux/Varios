      *M* FLI_SIL1:  Frame list integrator FPL program.
      *T**************************************************************
      *T*                                                            *
      *T* Copyright (c) Bull HN Information Systems Inc., 1989       *
      *T*                                                            *
      *T**************************************************************
      *X* FAT,CHANCE
       IDENTIFICATION DIVISION.
       PROGRAM-ID.  FLI_FORM.
 
       ENVIRONMENT DIVISION.
       CONFIGURATION SECTION.
       INPUT-OUTPUT SECTION.
       FILE-CONTROL.
           SELECT FID-AND-FRAME-SCREEN ASSIGN TO TERMINAL-IO.
           SELECT PICTURE-SCREEN ASSIGN TO TERMINAL-IO.
           SELECT DETAILS-ON-TOP-SCREEN ASSIGN TO TERMINAL-IO.
           SELECT DETAILS-ON-BOTTOM-SCREEN ASSIGN TO TERMINAL-IO.
           SELECT THE-HOST ASSIGN TO COMMUNICATIONS
                  TYPE IS FLI-MESSAGE-TYPE
                  ID IS FLI-MESSAGE-ID.
 
       DATA DIVISION.
       FILE SECTION.
       FD  FID-AND-FRAME-SCREEN
           FRAME IS FID-AND-FRAME-FRAME.
       FD  PICTURE-SCREEN
           FRAME IS FIELD-ROW-ARRAY-FRAME.
       FD  DETAILS-ON-TOP-SCREEN
           FRAME IS DETAILS-ON-TOP-FRAME.
       FD  DETAILS-ON-BOTTOM-SCREEN
           FRAME IS DETAILS-ON-BOTTOM-FRAME.
       FD  THE-HOST.
       01  HOST-RECORD PIC X(1200).
      /
       WORKING-STORAGE SECTION.
       01  B-COPYRIGHT PIC X(55) VALUE
           "Copyright (c) Bull HN Information Systems Inc., 1989   ".
       01  FLI-MESSAGE-TYPE PIC X(8) VALUE "FLI-xxxx".
       01  FLI-MESSAGE-TYPE-PIECES REDEFINES FLI-MESSAGE-TYPE.
           02  FILLER PIC X(4).
           02  FOIST-FOAH-CHAARICTAHS PIC X(4).
       01  FLI-MESSAGE-ID PIC 9(10) VALUE 0.
       01  FLI-MESSAGE-ID-HIDDEN-AWAY PIC 9(10).
      *  A PIC 999 whatever.
       01  PIC999-WHATEVER PIC 999 COMP-1.
      *  Various indexes.
       01  DEFAULT-INDEX PIC 999 COMP-1.
       01  FRAME-INDEX PIC 999 COMP-1.
       01  PICTURE-STRING-INDEX PIC 999 COMP-1.
       01  SHIP-INDEX PIC 999 COMP-1.
      *  Various column keepers.
       01  COLUMM PIC 999 COMP-1.
       01  COLUMM-OFFICIALLY-SCUN-TO PIC 999 COMP-1.
       01  START-COLUMM PIC 999 COMP-1.
       01  NEW-START-COLUMM PIC 999 COMP-1.
       01  ORIGINAL-START-COLUMM PIC 999 COMP-1.
      *01  OTHER-START-COLUMM PIC 999 COMP-1.
       01  END-COLUMM PIC 999 COMP-1.
       01  LEFT-BRACKET-COLUMM PIC 999 COMP-1.
       01  RIGHT-BRACKET-COLUMM PIC 999 COMP-1.
       01  NEW-NONBLANK-COLUMM PIC 999 COMP-1.
       01  PICK-COLUMM PIC 999 COMP-1.
       01  SPACE-COLUMM PIC 999 COMP-1.
      *  Various row keepers.
       01  ROW PIC 999 COMP-1.
       01  ROW-OFFICIALLY-SCUN-TO PIC 999 COMP-1.
       01  ORIGINAL-ROW PIC 999 COMP-1.
      *01  OTHER-ROW PIC 999 COMP-1.
       01  LEFT-BRACKET-ROW PIC 999 COMP-1.
       01  RIGHT-BRACKET-ROW PIC 999 COMP-1.
      *  Row & column keepers for searching the screen for @'s
      *  when performing a MOVE command.
       01  AT-COLUMM PIC 999 COMP-1.
       01  AT-ROW PIC 999 COMP-1.
      *  Row & column keepers for the FLUSH-whatever routines.
       01  FLUSH-COLUMM PIC 999 COMP-1.
       01  FLUSH-ROW PIC 999 COMP-1.
       01  START-FLUSH-COLUMM PIC 999 COMP-1.
       01  START-FLUSH-ROW PIC 999 COMP-1.
       01  UNFLUSH-COLUMM PIC 999 COMP-1.
       01  UNFLUSH-ROW PIC 999 COMP-1.
      *  Intermediate results, PERFORM indices, etc.
      *  for stuff inside of MOVE-ANDOR-REPEAT-MAYBE.
       01  FIELD-LENGTH PIC 999 COMP-1.
       01  X-POS PIC 999 COMP-1.
       01  X-POS-START PIC 999 COMP-1.
       01  X-POS-START-MINUS-1 PIC 999 COMP-1.
       01  X-POS-STOP PIC 999 COMP-1.
       01  X-POS-STOP-PLUS-1 PIC 999 COMP-1.
       01  Y-POS PIC 999 COMP-1.
       01  X-REPEATS PIC 999 COMP-1.
       01  Y-REPEATS PIC 999 COMP-1.
       01  X-SEPARATION PIC 999 COMP-1.
       01  Y-SEPARATION PIC 999 COMP-1.
       01  X-REPEATS-MINUS-1 PIC 999 COMP-1.
       01  Y-REPEATS-MINUS-1 PIC 999 COMP-1.
       01  X-REPEATS-LIMIT PIC 999 COMP-1.
       01  Y-REPEATS-LIMIT PIC 999 COMP-1.
      *  Keepers for what's under the brackets when a field
      *  gets bracketed, and where that stuff is.
       01  WHATS-UNDER-THE-LB PIC X VALUE "?".
       01  WHATS-UNDER-THE-TEST-LB PIC X VALUE "?".
       01  WHATS-UNDER-THE-RB PIC X VALUE "?".
       01  WHATS-UNDER-THE-TEST-RB PIC X VALUE "?".
       01  LB-ROW PIC 999 COMP-1.
       01  TEST-LB-ROW PIC 999 COMP-1.
       01  RB-ROW PIC 999 COMP-1.
       01  TEST-RB-ROW PIC 999 COMP-1.
       01  LB-COLUMM PIC 999 COMP-1.
       01  TEST-LB-COLUMM PIC 999 COMP-1.
       01  RB-COLUMM PIC 999 COMP-1.
       01  TEST-RB-COLUMM PIC 999 COMP-1.
      *  The OLD-whatever values for various field attributes which
      *  MOVE-ANDOR-REPEAT-MAYBE will change to whatever without
      *  the "old" in front.
       01  OLD-ROW PIC 999 COMP-1.
       01  OLD-START-COLUMM PIC 999 COMP-1.
       01  OLD-PICTURE-STRING-LENGTH PIC 999 COMP-1.
       01  OLD-REPEATS-X PIC 999 COMP-1.
       01  OLD-REPEATS-Y PIC 999 COMP-1.
       01  OLD-SEPARATED-X PIC 999 COMP-1.
       01  OLD-SEPARATED-Y PIC 999 COMP-1.
       01  OLD-IS-CONSTANT-DEFAULT PIC X.
      *  Keepers for text which for some reason or other might
      *  get stomped by host READs and/or WRITEs while we still
      *  need them.
       01  OUR-CURRENT-OLD-NEW PIC X VALUE "?".
       01  OUR-CURRENT-FID PIC X(136) VALUE ALL "?".
       01  OUR-NEW-OLD-NEW PIC X VALUE "?".
       01  OUR-NEW-FID PIC X(136) VALUE ALL "?".
       01  OUR-CURRENT-FRAME-NAME PIC X(30) VALUE ALL "?".
       01  OUR-CURRENT-PICTURE-STRING PIC X(256) VALUE ALL "?".
       01  OUR-CURRENT-PICTURE-STRING-LEN PIC 999.
       01  OUR-CURRENT-SEQUENCE-NUMBER PIC X(10).
       01  OUR-CURRENT-GROUP-SEQUENCE-NUM PIC X(10).
       01  OUR-CURRENT-LEVEL-NUMBER PIC X(2).
      *  Stuff which is eventually used to fill in
      *  ROW-BY-COLUMM-PATTERN.
       01  PATTERN-FILL-CHARACTER PIC X VALUE "?".
       01  PATTERN-START-CHARACTER PIC X VALUE "?".
       01  PATTERN-END-CHARACTER PIC X VALUE "?".
       01  PATTERN-SINGLE-CHARACTER PIC X VALUE "?".
      *  Various max's & min's.
       01  MAX-FRAMES-PER-SCREEN PIC 999 VALUE 18.
      *  Flags & function-flags.
       01  NOPE PIC 9 VALUE 0.
       01  YUP PIC 9 VALUE 1.
       01  ADJACENT-FIELDS-ILLEGAL-FLAG PIC 9 VALUE 0.
       88  ADJACENT-FIELDS-LEGAL VALUE 0.
       88  ADJACENT-FIELDS-ILLEGAL VALUE 1.
       01  DONE-AT-SCREENING-FLAG PIC 9 VALUE 0.
       88  DONE-AT-SCREENING VALUE 1.
       01  DONE-SCREENING-FLAG PIC 9 VALUE 0.
       88  DONE-SCREENING VALUE 1.
       01  REPAINT-FLAG PIC 9 VALUE 0.
       88  REPAINT VALUE 1.
       01  SOMETHING-HAPPENED-FLAG PIC 9 VALUE 0.
       88  NOTHING-HAPPENED VALUE 0.
       88  SOMETHING-HAPPENED VALUE 1.
       01  FID-UP-FLAG PIC 9 VALUE 0.
       88  FID-UP VALUE 1.
       01  GET-FRAME-LIST-FUNCTION-FLAG PIC XX VALUE SPACES.
       88  GET-FRAME-LIST-FUNCTION-ACTIV VALUE "SA".
       88  GET-FRAME-LIST-FUNCTION-ADD VALUE "AF".
       01  HOST-DETAILS-ERROR-FLAG PIC 9 VALUE 0.
       88  HOST-DETAILS-ERROR VALUE 1.
      *01  LOOK-AHEAD-ERROR-FLAG PIC 9 VALUE 0.
      *88  LOOK-AHEAD-ERROR VALUE 1.
       01  PICTURE-STRING-ERROR-FLAG PIC 9 VALUE 0.
       88  PICTURE-STRING-ERROR VALUE 1.
       01  PICK-PICTURE-STRING-ERROR-FLAG PIC 9 VALUE 0.
       88  PICK-PICTURE-STRING-ERROR VALUE 1.
       01  MOVE-REPEAT-WHICH-FLAG PIC XX VALUE SPACES.
       88  MOVE-REPEAT-WHICH-BOTH VALUE "YY".
       88  MOVE-REPEAT-WHICH-TEST VALUE "YN".
       88  MOVE-REPEAT-WHICH-DONE VALUE "NY".
       01  THEY-GOT-AT-RIGHT-FLAG PIC 9 VALUE 0.
       88  THEY-GOT-AT-RIGHT VALUE 1.
       01  THEY-GOT-IT-RIGHT-FLAG PIC 9 VALUE 0.
       88  THEY-GOT-IT-RIGHT VALUE 1.
       01  NICE-MISTER-HOST-IS-A-NAG-FLAG PIC 9 VALUE 0.
       88  NICE-MISTER-HOST-IS-A-NAG VALUE 1.
       01  THE-FIELD-GOT-DELETED-FLAG PIC 9 VALUE 0.
       88  THE-FIELD-GOT-DELETED VALUE 1.
      *01  WE-ALREADY-SAW-THE-OTHER-FLAG PIC 9 VALUE 0.
       88  WE-ALREADY-SAW-THE-OTHER VALUE 1.
       01  WE-GOT-A-FID-OPEN-FLAG PIC 9 VALUE 0.
       88  WE-DONT-GOT-A-FID-OPEN VALUE 0.
       88  WE-GOT-A-FID-OPEN VALUE 1.
       01  WE-GOT-ALL-THE-FIELDS-FLAG PIC 9 VALUE 0.
       88  WE-DONT-GOT-ALL-THE-FIELDS VALUE 0.
       88  WE-GOT-ALL-THE-FIELDS VALUE 1.
       01  WE-GOT-ALL-THE-FRAMES-FLAG PIC 9 VALUE 0.
       88  WE-DONT-GOT-ALL-THE-FRAMES VALUE 0.
       88  WE-GOT-ALL-THE-FRAMES VALUE 1.
       01  WERE-DOING-A-WHAT-FLAG PIC XX VALUE SPACES.
       88  WERE-DOING-AN-ADD VALUE "DA".
       88  WERE-DOING-A-CHANGE VALUE "DC".
       01  WERE-STUCK-ON-FUNCTION-FLAG PIC XX VALUE "SN".
       88  WERE-STUCK-ON-NOTHING VALUE "SN".
       88  WERE-STUCK-ON-AN-ADJACENT VALUE "SA".
       88  WERE-STUCK-ON-A-FELL-OFF VALUE "SF".
       88  WERE-STUCK-ON-AN-OVERLAP VALUE "SO".
       88  WERE-STUCK-ON-AN-OZONE VALUE "SZ".
       88  WERE-STUCK-ON-A-3270 VALUE "S3".
       01  3270-CHECK-FLAG PIC 9 VALUE 0.
       88  3270-CHECK VALUE 1.
      *  Trying to remember which screen "must" be open currently
      *  is hard work, so these flags exist instead.
       01  FID-AND-FRAME-IS-OPEN-FLAG PIC 9 VALUE 0.
       88  FID-AND-FRAME-IS-OPEN VALUE 1.
       01  PICTURE-IS-OPEN-FLAG PIC 9 VALUE 0.
       88  PICTURE-IS-OPEN VALUE 1.
       01  DETAILS-ON-TOP-IS-OPEN-FLAG PIC 9 VALUE 0.
       88  DETAILS-ON-TOP-IS-OPEN VALUE 1.
       01  DETAILS-ON-BOTTOM-IS-OPEN-FLAG PIC 9 VALUE 0.
       88  DETAILS-ON-BOTTOM-IS-OPEN VALUE 1.
 
      *  Internal-type-FUNCTIONs.
       01  FUNCTION-WERE-DOING-AN-ADD PIC XX VALUE "DA".
       01  FUNCTION-WERE-DOING-A-CHANGE PIC XX VALUE "DC".
       01  FUNCTION-STUCK-ON-NOTHING PIC XX VALUE "SN".
       01  FUNCTION-STUCK-ON-AN-ADJACENT PIC XX VALUE "SA".
       01  FUNCTION-STUCK-ON-A-FELL-OFF PIC XX VALUE "SF".
       01  FUNCTION-STUCK-ON-AN-OVERLAP PIC XX VALUE "SO".
       01  FUNCTION-STUCK-ON-AN-OZONE PIC XX VALUE "SZ".
       01  FUNCTION-STUCK-ON-A-3270 PIC XX VALUE "S3".
      *  External-and-Internal-type-FUNCTIONs.
       01  FUNCTION-INITIALIZE-STATION PIC XX VALUE "IS".
       01  FUNCTION-FIND-FPL-AND-MUSH-IT PIC XX VALUE "FF".
       01  FUNCTION-GET-FRAMES PIC XX VALUE "GF".
       01  FUNCTION-ADD-FRAME PIC XX VALUE "AF".
       01  FUNCTION-SET-ACTIVATION PIC XX VALUE "SA".
       01  FUNCTION-LET-ER-RIP PIC XX VALUE "LR".
       01  FUNCTION-LET-ER-RIP-ACK PIC XX VALUE "LA".
       01  FUNCTION-LET-ER-RIP-NACK PIC XX VALUE "LN".
       01  FUNCTION-LET-ER-RIP-RESUME PIC XX VALUE "LK".
       01  FUNCTION-GET-FIELD-DETAILS PIC XX VALUE "GD".
       01  FUNCTION-PUT-FIELD-DETAILS PIC XX VALUE "PD".
       01  FUNCTION-DELETE-FIELD PIC XX VALUE "DF".
       01  FUNCTION-FIND-MUSH-AND-FPL-IT PIC XX VALUE "FM".
       01  FUNCTION-DEINITIALIZE-STATION PIC XX VALUE "DS".
       01  ERROR-EVERYTHINGS-PEACHY PIC 99 VALUE 00.
       01  ERROR-NO-MORE-FRAMES PIC 99 VALUE 01.
       01  ERROR-NO-MORE-FIELDS PIC 99 VALUE 02.
       01  ERROR-NO-DICE PIC 99 VALUE 98.
       01  ERROR-ABANDON-SHIP PIC 99 VALUE 99.
      /
       01  WS-ROW-ARRAY.
           02  ROW-ARRAY PIC X(80) OCCURS 23
               FIELD FIELD-ROW-ARRAY.
       01  WS-ROW-BY-COLUMM-ARRAY REDEFINES WS-ROW-ARRAY.
           02  ROW-ONLY-ARRAY OCCURS 23.
               03  ROW-BY-COLUMM-ARRAY PIC X OCCURS 80.
       01  WS-TOP-XX-ROW-ARRAY REDEFINES WS-ROW-ARRAY.
           02  TOP-XX-ROW-ARRAY PIC X(80) OCCURS 13
               FIELD FIELD-TOP-XX-ROW-ARRAY.
           02  FILLER PIC X(80) OCCURS 10.
       01  WS-BOTTOM-XX-ROW-ARRAY REDEFINES WS-ROW-ARRAY.
           02  FILLER PIC X(80) OCCURS 10.
           02  BOTTOM-XX-ROW-ARRAY PIC X(80) OCCURS 13
               FIELD FIELD-BOTTOM-XX-ROW-ARRAY.
 
       01  WS-ROW-PATTERN.
           02  ROW-PATTERN PIC X(80) OCCURS 23
               FIELD FIELD-ROW-ARRAY.
       01  WS-ROW-BY-COLUMM-PATTERN REDEFINES WS-ROW-PATTERN.
           02  ROW-ONLY-PATTERN OCCURS 23.
               03  ROW-BY-COLUMM-PATTERN PIC X OCCURS 80.
 
       01  WS-ROW-BY-COLUMM-MASTER-X-POS.
           02  ROW-ONLY-MASTER-X-POS OCCURS 23.
               03  ROW-BY-COLUMM-MASTER-X-POS PIC 999 COMP-1 OCCURS 80.
 
       01  WS-ROW-BY-COLUMM-MASTER-Y-POS.
           02  ROW-ONLY-MASTER-Y-POS OCCURS 23.
               03  ROW-BY-COLUMM-MASTER-Y-POS PIC 999 COMP-1 OCCURS 80.
 
       01  WS-DONE-ROW-ARRAY.
           02  DONE-ROW-ARRAY PIC X(80) OCCURS 23
               FIELD FIELD-ROW-ARRAY.
       01  WS-DONE-ROW-BY-COLUMM-ARRAY REDEFINES WS-DONE-ROW-ARRAY.
           02  DONE-ROW-ONLY-ARRAY OCCURS 23.
               03  DONE-ROW-BY-COLUMM-ARRAY PIC X OCCURS 80.
 
       01  WS-TEST-ROW-ARRAY.
           02  TEST-ROW-ARRAY PIC X(80) OCCURS 23
               FIELD FIELD-ROW-ARRAY.
       01  WS-TEST-ROW-BY-COLUMM-ARRAY REDEFINES WS-TEST-ROW-ARRAY.
           02  TEST-ROW-ONLY-ARRAY OCCURS 23.
               03  TEST-ROW-BY-COLUMM-ARRAY PIC X OCCURS 80.
       01  WS-TEST-TOP-XX-ROW-ARRAY REDEFINES WS-TEST-ROW-ARRAY.
           02  TEST-TOP-XX-ROW-ARRAY PIC X(80) OCCURS 13
               FIELD FIELD-TOP-XX-ROW-ARRAY.
           02  FILLER PIC X(80) OCCURS 10.
       01  WS-TEST-BOTTOM-XX-ROW-ARRAY REDEFINES WS-TEST-ROW-ARRAY.
           02  FILLER PIC X(80) OCCURS 10.
           02  TEST-BOTTOM-XX-ROW-ARRAY PIC X(80) OCCURS 13
               FIELD FIELD-BOTTOM-XX-ROW-ARRAY.
 
       01  WS-FRAME-ARRAY.
           02  FRAME-ARRAY OCCURS 18.
               04  IS-FRAME-ACTIVE PIC X
                   FIELD FIELD-IS-FRAME-ACTIVE OF FRAME-RECORD
                   LEGAL ARE "N",
                             "Y"
                   ERROR-MESSAGE IS
                   "N, Y.".
               04  FRAME-NAME PIC X(30)
                   FIELD FIELD-FRAME-NAME OF FRAME-RECORD.
      /
       01  FID-AND-FRAME-COMMAND PIC X(8)
           FIELD FIELD-FID-AND-FRAME-COMMAND
           LEGAL ARE SPACES,
                     "E",
                     "EN",
                     "END",
                     "Q",
                     "QU",
                     "QUI",
                     "QUIT",
                     "X",
                     "AC",
                     "ACT",
                     "ACTI",
                     "ACTIV",
                     "ACTIVA",
                     "ACTIVAT",
                     "ACTIVATE",
                     "ADD",
                     "ADJ",
                     "ADJA",
                     "ADJAC",
                     "ADJACE",
                     "ADJACEN",
                     "ADJACENT",
                     "P",
                     "PA",
                     "PAI",
                     "PAIN",
                     "PAINT",
                     "3",
                     "32",
                     "327",
                     "3270"
           ERROR-MESSAGE IS
           "E[ND], Q[UIT], X, AC[TIVATE], ADD, ADJ[ACENT], P[AINT], 3[27
      -    "0].".
 
       01  DETAILS-COMMAND PIC X(8).
       01  DETAILS-ON-TOP-COMMAND REDEFINES DETAILS-COMMAND PIC X(8)
           FIELD FIELD-DETAILS-COMMAND OF DETAILS-ON-TOP-RECORD
           LEGAL ARE SPACES,
                     "E",
                     "EN",
                     "END",
                     "Q",
                     "QU",
                     "QUI",
                     "QUIT",
                     "X",
                     "PA",
                     "PAI",
                     "PAIN",
                     "PAINT",
                     "SNOT",
                     "ICK",
                     "DEF",
                     "DEFA",
                     "DEFAU",
                     "DEFAUL",
                     "DEFAULT",
                     "DEL",
                     "DELE",
                     "DELET",
                     "DELETE",
                     "L",
                     "LI",
                     "LIK",
                     "LIKE",
                     "M",
                     "MO",
                     "MOV",
                     "MOVE",
      *              "O",
      *              "OT",
      *              "OTH",
      *              "OTHE",
      *              "OTHER",
                     "PI",
                     "PIC",
                     "PICT",
                     "PICTU",
                     "PICTUR",
                     "PICTURE"
           ERROR-MESSAGE IS
           "E[ND], Q[UIT], X, DEF[AULT], DEL[ETE], L[IKE], M[OVE], PA[IN
      -    "T], PI[CTURE].".
       01  DETAILS-ON-BOTTOM-COMMAND REDEFINES DETAILS-COMMAND PIC X(8)
           FIELD FIELD-DETAILS-COMMAND OF DETAILS-ON-BOTTOM-RECORD
           LEGAL ARE SPACES,
                     "E",
                     "EN",
                     "END",
                     "Q",
                     "QU",
                     "QUI",
                     "QUIT",
                     "X",
                     "PA",
                     "PAI",
                     "PAIN",
                     "PAINT",
                     "SNOT",
                     "ICK",
                     "DEF",
                     "DEFA",
                     "DEFAU",
                     "DEFAUL",
                     "DEFAULT",
                     "DEL",
                     "DELE",
                     "DELET",
                     "DELETE",
                     "L",
                     "LI",
                     "LIK",
                     "LIKE",
                     "M",
                     "MO",
                     "MOV",
                     "MOVE",
      *              "O",
      *              "OT",
      *              "OTH",
      *              "OTHE",
      *              "OTHER",
                     "PI",
                     "PIC",
                     "PICT",
                     "PICTU",
                     "PICTUR",
                     "PICTURE"
           ERROR-MESSAGE IS
           "E[ND], Q[UIT], X, DEF[AULT], DEL[ETE], L[IKE], M[OVE], PA[IN
      -    "T], PI[CTURE].".
 
       01  FID-AND-FRAME-OPTION PIC X(54)
           FIELD FIELD-FID-AND-FRAME-OPTION
           LEGAL ARE SPACES,
                     "OF",
                     "OFF",
                     "ON"
           ERROR-MESSAGE IS
           "OF[F], ON.".
 
       01  DETAILS-OPTION PIC X(54).
       01  DETAILS-ON-TOP-OPTION REDEFINES DETAILS-OPTION PIC X(54)
           FIELD FIELD-DETAILS-OPTION OF DETAILS-ON-TOP-RECORD
           LEGAL ARE SPACES,
                     "OF",
                     "OFF",
                     "ON"
           ERROR-MESSAGE IS
           "OF[F], ON.".
       01  DETAILS-ON-BOTTOM-OPTION REDEFINES DETAILS-OPTION PIC X(54)
           FIELD FIELD-DETAILS-OPTION OF DETAILS-ON-BOTTOM-RECORD
           LEGAL ARE SPACES,
                     "OF",
                     "OFF",
                     "ON"
           ERROR-MESSAGE IS
           "OF[F], ON.".
 
       01  TOIMINAL-ATTRIBUTES.
           02  STATION-NAME PIC X(8).
           02  DEVICE-PROFILE PIC X(12).
           02  MAX-ROWS PIC 9(4).
           02  MAX-COLUMMS PIC 9(4).
      /
       01  WHATEVER-HOST-RECORD.
           02  FUNCTION PIC XX.
           02  ERROR-CODE REDEFINES FUNCTION PIC XX.
           02  ERROR-TEXT PIC X(80).
 
       01  INITIALIZE-HOST-RECORD.
           02  FUNCTION PIC XX.
           02  ERROR-CODE REDEFINES FUNCTION PIC XX.
           02  MESSAGE-TYPE PIC X(80).
           02  ERROR-TEXT REDEFINES MESSAGE-TYPE PIC X(80).
 
       01  FID-HOST-RECORD.
           02  FUNCTION PIC XX.
           02  ERROR-CODE REDEFINES FUNCTION PIC XX.
           02  FID.
               03  FIRST-PART PIC X(56)
                   FIELD FIELD-FID-1.
               03  SECOND-PART PIC X(80)
                   FIELD FIELD-FID-2.
           02  ERROR-TEXT REDEFINES FID PIC X(136).
           02  OLD-NEW PIC X
               FIELD FIELD-OLD-NEW
               LEGAL ARE "O", "N", SPACE.
 
       01  FRAME-HOST-RECORD.
           02  FUNCTION PIC XX.
           02  ERROR-CODE REDEFINES FUNCTION PIC XX.
           02  FRAME-NAME PIC X(80).
           02  ERROR-TEXT REDEFINES FRAME-NAME PIC X(80).
           02  IS-FRAME-ACTIVE PIC X.
 
       01  FIELD-HOST-RECORD.
           02  FUNCTION PIC XX.
           02  ERROR-CODE REDEFINES FUNCTION PIC XX.
           02  ERROR-TEXT PIC X(80).
           02  PICTURE-STRING-TYPE PIC X.
           02  PICTURE-STRING-LENGTH PIC 999.
           02  PICTURE-STRING-STRING PIC X(256).
           02  PICTURE-STRING REDEFINES PICTURE-STRING-STRING
               PIC X OCCURS 256.
           02  PICTURE-CLAUSE PIC X(30).
           02  GROUP-SEQUENCE-NUMBER PIC X(10).
           02  GROUP-SEQUENCE-NUMBER-9S REDEFINES GROUP-SEQUENCE-NUMBER
               PIC 9(10).
           02  LIKE-SEQUENCE-NUMBER PIC X(10).
           02  LIKE-SEQUENCE-NUMBER-9S REDEFINES LIKE-SEQUENCE-NUMBER
               PIC 9(10).
           02  SEQUENCE-NUMBER PIC X(10).
           02  SEQUENCE-NUMBER-9S REDEFINES SEQUENCE-NUMBER
               PIC 9(10).
           02  DETAILS-ON-TOP.
               03  POSITION-X PIC 999.
               03  POSITION-Y PIC 999.
               03  FRAME-NAME PIC X(30)
                   FIELD FIELD-FRAME-NAME
                         OF DETAILS-ON-TOP-RECORD.
               03  ORIGIN-X PIC 999.
               03  ORIGIN-Y PIC 999.
               03  IS-ORIGIN-VALID PIC X.
               03  LEVEL-NUMBER PIC X(2).
               03  FIELD-NAME PIC X(30)
                   FIELD FIELD-FIELD-NAME
                         OF DETAILS-ON-TOP-RECORD.
               03  IS-DOWN-NAME-FOR-ABOVE PIC X.
               03  IS-DOWN-NAME-FROM-BELOW PIC X.
               03  IS-INPUT PIC X
                   FIELD FIELD-IS-INPUT
                         OF DETAILS-ON-TOP-RECORD.
               03  IS-OUTPUT PIC X
                   FIELD FIELD-IS-OUTPUT
                         OF DETAILS-ON-TOP-RECORD.
               03  IS-IO-INHERITED PIC X.
               03  IS-ENTRY-REQUIRED PIC X
                   FIELD FIELD-IS-ENTRY-REQUIRED
                         OF DETAILS-ON-TOP-RECORD.
               03  IS-ENTRY-REQUIRED-INHERITED PIC X.
               03  IS-A-O-I-M PIC X
                   FIELD FIELD-IS-A-O-I-M
                         OF DETAILS-ON-TOP-RECORD.
               03  IS-A-O-I-M-INHERITED PIC X.
               03  CLASS-CLAUSE PIC X(30)
                   FIELD FIELD-CLASS-CLAUSE
                         OF DETAILS-ON-TOP-RECORD.
               03  VISUAL-ATTRIBUTE-CLAUSE PIC X(30)
                   FIELD FIELD-VISUAL-ATTRIBUTE-CLAUSE
                         OF DETAILS-ON-TOP-RECORD.
               03  IS-VISUAL-ATTRIBUTE-INHERITED PIC X.
               03  MINIMUM-SIZE-CLAUSE PIC 999
                   FIELD FIELD-MINIMUM-SIZE-CLAUSE
                         OF DETAILS-ON-TOP-RECORD.
               03  FILL-CHARACTER PIC X
                   FIELD FIELD-FILL-CHARACTER
                         OF DETAILS-ON-TOP-RECORD.
               03  SIGN-CLAUSE PIC XX
                   FIELD FIELD-SIGN-CLAUSE
                         OF DETAILS-ON-TOP-RECORD.
               03  IS-SIGN-INHERITED PIC X.
               03  IS-BWZ PIC X
                   FIELD FIELD-IS-BWZ
                         OF DETAILS-ON-TOP-RECORD.
               03  IS-JUSTIFIED-RIGHT PIC X
                   FIELD FIELD-IS-JUSTIFIED-RIGHT
                         OF DETAILS-ON-TOP-RECORD.
               03  REPEATS-X PIC 999
                   FIELD FIELD-REPEATS-X
                         OF DETAILS-ON-TOP-RECORD.
               03  IS-REPEATS-X-INHERITED PIC X.
               03  REPEATS-Y PIC 999
                   FIELD FIELD-REPEATS-Y
                         OF DETAILS-ON-TOP-RECORD.
               03  IS-REPEATS-Y-INHERITED PIC X.
               03  SEPARATED-X PIC 999
                   FIELD FIELD-SEPARATED-X
                         OF DETAILS-ON-TOP-RECORD.
               03  SEPARATED-X-GROUP-DIFFERENCE PIC 999.
               03  SEPARATED-Y PIC 999
                   FIELD FIELD-SEPARATED-Y
                         OF DETAILS-ON-TOP-RECORD.
               03  SEPARATED-Y-GROUP-DIFFERENCE PIC 999.
               03  IS-CONSTANT-DEFAULT PIC X
                   FIELD FIELD-IS-CONSTANT-DEFAULT
                         OF DETAILS-ON-TOP-RECORD.
               03  CONSTANT-DEFAULT-TYPE PIC X.
               03  CONSTANT-DEFAULT-LENGTH PIC 999.
               03  DEFAULT-VALUE-STRING PIC X(256).
               03  DEFAULT-VALUE REDEFINES DEFAULT-VALUE-STRING
                   PIC X OCCURS 256.
               03  CONSTANT-VALUE-STRING REDEFINES DEFAULT-VALUE-STRING
                   PIC X(256).
               03  CONSTANT-VALUE REDEFINES DEFAULT-VALUE-STRING
                   PIC X OCCURS 256.
               03  IS-PROMPT PIC X.
               03  PROMPT-TYPE PIC X
                   FIELD FIELD-PROMPT-TYPE
                         OF DETAILS-ON-TOP-RECORD.
               03  PROMPT-LENGTH PIC 999.
               03  PROMPT-TEXT PIC X(256)
                   FIELD FIELD-PROMPT-TEXT
                         OF DETAILS-ON-TOP-RECORD.
           02  DETAILS-ON-BOTTOM REDEFINES DETAILS-ON-TOP.
               03  POSITION-X PIC 999.
               03  POSITION-Y PIC 999.
               03  FRAME-NAME PIC X(30)
                   FIELD FIELD-FRAME-NAME
                         OF DETAILS-ON-BOTTOM-RECORD.
               03  ORIGIN-X PIC 999.
               03  ORIGIN-Y PIC 999.
               03  IS-ORIGIN-VALID PIC X.
               03  LEVEL-NUMBER PIC X(2).
               03  FIELD-NAME PIC X(30)
                   FIELD FIELD-FIELD-NAME
                         OF DETAILS-ON-BOTTOM-RECORD.
               03  IS-DOWN-NAME-FOR-ABOVE PIC X.
               03  IS-DOWN-NAME-FROM-BELOW PIC X.
               03  IS-INPUT PIC X
                   FIELD FIELD-IS-INPUT
                         OF DETAILS-ON-BOTTOM-RECORD.
               03  IS-OUTPUT PIC X
                   FIELD FIELD-IS-OUTPUT
                         OF DETAILS-ON-BOTTOM-RECORD.
               03  IS-IO-INHERITED PIC X.
               03  IS-ENTRY-REQUIRED PIC X
                   FIELD FIELD-IS-ENTRY-REQUIRED
                         OF DETAILS-ON-BOTTOM-RECORD.
               03  IS-ENTRY-REQUIRED-INHERITED PIC X.
               03  IS-A-O-I-M PIC X
                   FIELD FIELD-IS-A-O-I-M
                         OF DETAILS-ON-BOTTOM-RECORD.
               03  IS-A-O-I-M-INHERITED PIC X.
               03  CLASS-CLAUSE PIC X(30)
                   FIELD FIELD-CLASS-CLAUSE
                         OF DETAILS-ON-BOTTOM-RECORD.
               03  VISUAL-ATTRIBUTE-CLAUSE PIC X(30)
                   FIELD FIELD-VISUAL-ATTRIBUTE-CLAUSE
                         OF DETAILS-ON-BOTTOM-RECORD.
               03  IS-VISUAL-ATTRIBUTE-INHERITED PIC X.
               03  MINIMUM-SIZE-CLAUSE PIC 999
                   FIELD FIELD-MINIMUM-SIZE-CLAUSE
                         OF DETAILS-ON-BOTTOM-RECORD.
               03  FILL-CHARACTER PIC X
                   FIELD FIELD-FILL-CHARACTER
                         OF DETAILS-ON-BOTTOM-RECORD.
               03  SIGN-CLAUSE PIC XX
                   FIELD FIELD-SIGN-CLAUSE
                         OF DETAILS-ON-BOTTOM-RECORD.
               03  IS-SIGN-INHERITED PIC X.
               03  IS-BWZ PIC X
                   FIELD FIELD-IS-BWZ
                         OF DETAILS-ON-BOTTOM-RECORD.
               03  IS-JUSTIFIED-RIGHT PIC X
                   FIELD FIELD-IS-JUSTIFIED-RIGHT
                         OF DETAILS-ON-BOTTOM-RECORD.
               03  REPEATS-X PIC 999
                   FIELD FIELD-REPEATS-X
                         OF DETAILS-ON-BOTTOM-RECORD.
               03  IS-REPEATS-X-INHERITED PIC X.
               03  REPEATS-Y PIC 999
                   FIELD FIELD-REPEATS-Y
                         OF DETAILS-ON-BOTTOM-RECORD.
               03  IS-REPEATS-Y-INHERITED PIC X.
               03  SEPARATED-X PIC 999
                   FIELD FIELD-SEPARATED-X
                         OF DETAILS-ON-BOTTOM-RECORD.
               03  SEPARATED-X-GROUP-DIFFERENCE PIC 999.
               03  SEPARATED-Y PIC 999
                   FIELD FIELD-SEPARATED-Y
                         OF DETAILS-ON-BOTTOM-RECORD.
               03  SEPARATED-Y-GROUP-DIFFERENCE PIC 999.
               03  IS-CONSTANT-DEFAULT PIC X
                   FIELD FIELD-IS-CONSTANT-DEFAULT
                         OF DETAILS-ON-BOTTOM-RECORD.
               03  CONSTANT-DEFAULT-TYPE PIC X.
               03  CONSTANT-DEFAULT-LENGTH PIC 999.
               03  DEFAULT-VALUE-STRING PIC X(256).
               03  IS-PROMPT PIC X.
               03  PROMPT-TYPE PIC X
                   FIELD FIELD-PROMPT-TYPE
                         OF DETAILS-ON-BOTTOM-RECORD.
               03  PROMPT-LENGTH PIC 999.
               03  PROMPT-TEXT PIC X(256)
                   FIELD FIELD-PROMPT-TEXT
                         OF DETAILS-ON-BOTTOM-RECORD.
      /
       01  WHATEVER-ERROR PIC X(72).
       01  FLUSH-LEFT-BRACKET-ERROR PIC X(72)
           VALUE "Misplaced ""["":  scan resumes after *s.".
       01  FLUSH-RIGHT-BRACKET-ERROR PIC X(72)
           VALUE "Misplaced ""]"":  scan resumes after *s.".
       01  FLUSH-ARRAY-CHANGE-ERROR PIC X(72) VALUE
           "Only element(1,1) of an array may be changed:  scan resumes
      -    "after *s.".
       01  FLUSH-ILLEGAL-DELETION-ERROR PIC X(72) VALUE
           "Illegal field deletion attempted:  scan resumes after *s.".
       01  FIELD-FELL-OFF-ERROR PIC X(72) VALUE
           "The *ed field extends off the screen.".
       01  FIELD-OVERLAPS-ERROR PIC X(72) VALUE
           "The *ed field overlaps another field.".
       01  FIELD-OZONE-ERROR PIC X(72) VALUE
           "The current field is completely off the screen.".
       01  FIELD-ADJACENT-ERROR PIC X(72) VALUE
           "The *ed field is immediately adjacent to another field.".
       01  FIELD-3270-ERROR PIC X(72) VALUE
           "One character fields in the rightmost column are illegal for
      -    " 3270s.".
 
       01  PICKING-PROMPT PIC X(72) VALUE ALL "?".
       01  PICKING-DEFAULT-PROMPT PIC X(72) VALUE
           "Please fill in the DEFAULT VALUE.".
       01  PICKING-PICTURE-STRING-PROMPT PIC X(72) VALUE
           "Please overwrite the PICture string with the new PICture str
      -    "ing.".
      /
       FRAME SECTION.
       COPY FLI_FORM_CL1.
      /
       PROCEDURE DIVISION.
 
       DAY-AFTER-DAY.
      *    STOP "FOX, tubhead.".
           ACCEPT TOIMINAL-ATTRIBUTES FROM TERMINAL-ATTRIBUTES.
           MOVE STATION-NAME OF TOIMINAL-ATTRIBUTES
                TO FOIST-FOAH-CHAARICTAHS OF FLI-MESSAGE-TYPE-PIECES.
 
           OPEN I-O THE-HOST.
           PERFORM GET-FID-AND-FRAME-SCREEN.
 
           MOVE FUNCTION-INITIALIZE-STATION
                TO FUNCTION OF INITIALIZE-HOST-RECORD.
           MOVE FLI-MESSAGE-TYPE
                TO MESSAGE-TYPE OF INITIALIZE-HOST-RECORD.
           WRITE HOST-RECORD FROM INITIALIZE-HOST-RECORD.
 
           PERFORM READ-THE-HOST
                   THROUGH READED-THE-HOST.
           MOVE HOST-RECORD TO INITIALIZE-HOST-RECORD.
 
           IF ERROR-CODE IN INITIALIZE-HOST-RECORD = ERROR-NO-DICE
           THEN
             GO TO NEXT-DAY.
 
           PERFORM FILE-AFTER-FILE THROUGH NEXT-FILE
                   UNTIL FID-UP.
 
       NEXT-DAY.
           IF WE-GOT-A-FID-OPEN
           THEN
             PERFORM FILE-AN-OLD-MUSH.
 
           MOVE FUNCTION-DEINITIALIZE-STATION
                TO FUNCTION OF INITIALIZE-HOST-RECORD.
           WRITE HOST-RECORD FROM INITIALIZE-HOST-RECORD.
 
           CLOSE THE-HOST, FID-AND-FRAME-SCREEN.
           STOP RUN.
      /
       FILE-AFTER-FILE.
           MOVE SPACES TO FID-AND-FRAME-COMMAND,
                          FID-AND-FRAME-OPTION.
           PRESENT FID-AND-FRAME-COMMAND,
                   FID-AND-FRAME-OPTION.
           DISPLAY FIELD-FID-AND-FRAME-COMMAND,
                   FIELD-FID-AND-FRAME-OPTION.
 
           IF WE-GOT-A-FID-OPEN
           THEN
             PRESENT FID-HOST-RECORD
             WRITE FID-RECORD
             PRESENT WS-FRAME-ARRAY
             WRITE FRAME-RECORD
           ELSE
             MOVE SPACES TO OLD-NEW OF FID-HOST-RECORD,
                            FID OF FID-HOST-RECORD
             PRESENT FID-HOST-RECORD
             WRITE FID-RECORD.
 
           DISABLE INPUT FOR FRAME-RECORD.
           ENABLE INPUT FOR FID-RECORD.
           READ FID-AND-FRAME-SCREEN.
           VERIFY FID-AND-FRAME-COMMAND,
                  FID-AND-FRAME-OPTION.
           VERIFY FID-HOST-RECORD.
 
           IF FID-AND-FRAME-COMMAND = "E"
           OR FID-AND-FRAME-COMMAND = "EN"
           OR FID-AND-FRAME-COMMAND = "END"
           OR FID-AND-FRAME-COMMAND = "Q"
           OR FID-AND-FRAME-COMMAND = "QU"
           OR FID-AND-FRAME-COMMAND = "QUI"
           OR FID-AND-FRAME-COMMAND = "QUIT"
           OR FID-AND-FRAME-COMMAND = "X"
           THEN
             MOVE YUP TO FID-UP-FLAG
             GO TO NEXT-FILE.
 
           IF FID OF FID-HOST-RECORD NOT = OUR-CURRENT-FID
           OR OLD-NEW OF FID-HOST-RECORD NOT = OUR-CURRENT-OLD-NEW
           OR WE-DONT-GOT-A-FID-OPEN
           THEN
             PERFORM MUSH-A-NEW-FILE.
 
           IF FID-AND-FRAME-COMMAND = "AC"
           OR FID-AND-FRAME-COMMAND = "ACT"
           OR FID-AND-FRAME-COMMAND = "ACTI"
           OR FID-AND-FRAME-COMMAND = "ACTIV"
           OR FID-AND-FRAME-COMMAND = "ACTIVA"
           OR FID-AND-FRAME-COMMAND = "ACTIVAT"
           OR FID-AND-FRAME-COMMAND = "ACTIVATE"
           THEN
             IF WE-GOT-A-FID-OPEN
             THEN
               MOVE FUNCTION-SET-ACTIVATION
                    TO GET-FRAME-LIST-FUNCTION-FLAG
               PERFORM GET-FRAME-LIST
               GO TO NEXT-FILE
             ELSE
               STOP "You don't have a valid file open to ACTIVate FRames
      -             " in."
               GO TO NEXT-FILE.
 
           IF FID-AND-FRAME-COMMAND = "ADD"
           THEN
             IF WE-GOT-A-FID-OPEN
             THEN
               MOVE FUNCTION-ADD-FRAME
                    TO GET-FRAME-LIST-FUNCTION-FLAG
               PERFORM GET-FRAME-LIST
               GO TO NEXT-FILE
             ELSE
               STOP "You don't have a valid file open to ADD FRames to."
               GO TO NEXT-FILE.
 
           IF FID-AND-FRAME-COMMAND = "ADJ"
           OR FID-AND-FRAME-COMMAND = "ADJA"
           OR FID-AND-FRAME-COMMAND = "ADJAC"
           OR FID-AND-FRAME-COMMAND = "ADJACE"
           OR FID-AND-FRAME-COMMAND = "ADJACEN"
           OR FID-AND-FRAME-COMMAND = "ADJACENT"
           THEN
             IF FID-AND-FRAME-OPTION = "OF"
             OR FID-AND-FRAME-OPTION = "OFF"
             THEN
               MOVE NOPE TO ADJACENT-FIELDS-ILLEGAL-FLAG
               GO TO NEXT-FILE
             ELSE
               MOVE YUP TO ADJACENT-FIELDS-ILLEGAL-FLAG
               GO TO NEXT-FILE.
 
           IF FID-AND-FRAME-COMMAND = "P"
           OR FID-AND-FRAME-COMMAND = "PA"
           OR FID-AND-FRAME-COMMAND = "PAI"
           OR FID-AND-FRAME-COMMAND = "PAIN"
           OR FID-AND-FRAME-COMMAND = "PAINT"
           THEN
             IF WE-GOT-A-FID-OPEN
             THEN
               PERFORM SLAP-UP-FIELDS
                       THROUGH SLAPPED-UP-FIELDS
               PERFORM GET-FID-AND-FRAME-SCREEN
               GO TO NEXT-FILE
             ELSE
               STOP "You don't have a valid file open to PAINT with."
               GO TO NEXT-FILE.
 
           IF FID-AND-FRAME-COMMAND = "3"
           OR FID-AND-FRAME-COMMAND = "32"
           OR FID-AND-FRAME-COMMAND = "327"
           OR FID-AND-FRAME-COMMAND = "3270"
           THEN
             IF FID-AND-FRAME-OPTION = "OF"
             OR FID-AND-FRAME-OPTION = "OFF"
             THEN
               MOVE NOPE TO 3270-CHECK-FLAG
               MOVE NOPE TO ADJACENT-FIELDS-ILLEGAL-FLAG
               GO TO NEXT-FILE
             ELSE
               MOVE YUP TO 3270-CHECK-FLAG
               MOVE YUP TO ADJACENT-FIELDS-ILLEGAL-FLAG
               GO TO NEXT-FILE.
 
       NEXT-FILE.
           EXIT.
      /
       MUSH-A-NEW-FILE.
           MOVE OLD-NEW OF FID-HOST-RECORD
                TO OUR-NEW-OLD-NEW.
           MOVE FID OF FID-HOST-RECORD
                TO OUR-NEW-FID.
           IF WE-GOT-A-FID-OPEN
           THEN
             PERFORM FILE-AN-OLD-MUSH.
 
           MOVE FUNCTION-FIND-FPL-AND-MUSH-IT
                TO FUNCTION OF FID-HOST-RECORD.
           MOVE OUR-NEW-OLD-NEW
                TO OLD-NEW OF FID-HOST-RECORD.
           MOVE OUR-NEW-FID
                TO FID OF FID-HOST-RECORD.
           WRITE HOST-RECORD FROM FID-HOST-RECORD.
 
           PERFORM READ-THE-HOST
                   THROUGH READED-THE-HOST.
           MOVE HOST-RECORD TO FID-HOST-RECORD.
 
           MOVE SPACES TO WS-FRAME-ARRAY.
           CLEAR ALL I-O FOR FRAME-RECORD.
 
           IF ERROR-CODE IN FID-HOST-RECORD = ERROR-NO-DICE
           THEN
             MOVE NOPE TO WE-GOT-A-FID-OPEN-FLAG
           ELSE
             MOVE YUP TO WE-GOT-A-FID-OPEN-FLAG
             MOVE OUR-NEW-FID TO OUR-CURRENT-FID
             MOVE OUR-NEW-OLD-NEW TO OUR-CURRENT-OLD-NEW
             IF OLD-NEW OF FID-HOST-RECORD = "O"
             THEN
               MOVE "ACTIVATE" TO FID-AND-FRAME-COMMAND
               MOVE SPACES TO FID-AND-FRAME-OPTION
               PRESENT FID-AND-FRAME-COMMAND,
                       FID-AND-FRAME-OPTION
               DISPLAY FIELD-FID-AND-FRAME-COMMAND,
                       FIELD-FID-AND-FRAME-OPTION
             ELSE
               MOVE "ADD" TO FID-AND-FRAME-COMMAND
               MOVE SPACES TO FID-AND-FRAME-OPTION
               PRESENT FID-AND-FRAME-COMMAND,
                       FID-AND-FRAME-OPTION
               DISPLAY FIELD-FID-AND-FRAME-COMMAND,
                       FIELD-FID-AND-FRAME-OPTION.
 
       FILE-AN-OLD-MUSH.
           MOVE FUNCTION-FIND-MUSH-AND-FPL-IT
                TO FUNCTION OF FID-HOST-RECORD.
           MOVE OUR-CURRENT-OLD-NEW
                TO OLD-NEW OF FID-HOST-RECORD.
           MOVE OUR-CURRENT-FID
                TO FID OF FID-HOST-RECORD.
           WRITE HOST-RECORD FROM FID-HOST-RECORD.
 
           PERFORM READ-THE-HOST
                   THROUGH READED-THE-HOST.
      /
       GET-FRAME-LIST.
           MOVE FUNCTION-GET-FRAMES
                TO FUNCTION OF FID-HOST-RECORD.
           WRITE HOST-RECORD FROM FID-HOST-RECORD.
 
           MOVE 1 TO FRAME-INDEX.
           MOVE NOPE TO WE-GOT-ALL-THE-FRAMES-FLAG.
           PERFORM READ-FOR-FRAME-LIST
                   UNTIL WE-GOT-ALL-THE-FRAMES.
 
       READ-FOR-FRAME-LIST.
           PERFORM READ-THE-HOST
                   THROUGH READED-THE-HOST.
           MOVE HOST-RECORD TO FRAME-HOST-RECORD.
 
           IF ERROR-CODE IN FRAME-HOST-RECORD = ERROR-NO-DICE
           THEN
             MOVE YUP TO WE-GOT-ALL-THE-FRAMES-FLAG
           ELSE
             IF ERROR-CODE IN FRAME-HOST-RECORD = ERROR-NO-MORE-FRAMES
             THEN
               MOVE YUP TO WE-GOT-ALL-THE-FRAMES-FLAG
               PERFORM PROCESS-THIS-PAGE
             ELSE
               IF FRAME-INDEX > MAX-FRAMES-PER-SCREEN
               THEN
                 PERFORM PROCESS-THIS-PAGE
                 PERFORM PROCESS-THIS-LINE
               ELSE
                 PERFORM PROCESS-THIS-LINE.
 
       PROCESS-THIS-LINE.
           ENABLE INPUT FOR FIELD-IS-FRAME-ACTIVE ( FRAME-INDEX ).
           MOVE IS-FRAME-ACTIVE OF FRAME-HOST-RECORD
               TO IS-FRAME-ACTIVE OF FRAME-ARRAY ( FRAME-INDEX ).
           MOVE FRAME-NAME OF FRAME-HOST-RECORD
               TO FRAME-NAME OF FRAME-ARRAY ( FRAME-INDEX ).
           ADD 1 TO FRAME-INDEX.
 
       PROCESS-THIS-PAGE.
           CLEAR ALL I-O FOR FRAME-RECORD,
                             EVEN-MORE-FRAMES-RECORD.
           PRESENT WS-FRAME-ARRAY.
           WRITE FRAME-RECORD.
           IF FRAME-INDEX > MAX-FRAMES-PER-SCREEN
           THEN
             WRITE EVEN-MORE-FRAMES-RECORD.
 
           IF GET-FRAME-LIST-FUNCTION-ACTIV
           THEN
             PERFORM GET-FRAME-ACTIVITY
           ELSE
             PERFORM GET-NEW-FRAMEITIVITY.
 
           IF WE-DONT-GOT-ALL-THE-FRAMES
           THEN
             MOVE SPACES TO WS-FRAME-ARRAY.
 
           MOVE 1 TO FRAME-INDEX.
 
       GET-FRAME-ACTIVITY.
           DISABLE INPUT FOR FID-RECORD,
                             EVEN-MORE-FRAMES-RECORD.
           READ FID-AND-FRAME-SCREEN.
           VERIFY WS-FRAME-ARRAY.
           DISABLE INPUT FOR FRAME-RECORD.
 
           MOVE FUNCTION-SET-ACTIVATION
                TO FUNCTION OF FRAME-HOST-RECORD.
 
           SUBTRACT 1 FROM FRAME-INDEX.
           MOVE FLI-MESSAGE-ID TO FLI-MESSAGE-ID-HIDDEN-AWAY.
           PERFORM SHIP-FRAME-OFF
                   VARYING SHIP-INDEX FROM 1 BY 1
                   UNTIL SHIP-INDEX > FRAME-INDEX.
           MOVE FLI-MESSAGE-ID-HIDDEN-AWAY TO FLI-MESSAGE-ID.
 
       GET-NEW-FRAMEITIVITY.
           IF FRAME-INDEX > MAX-FRAMES-PER-SCREEN
           THEN
             DISABLE INPUT FOR FID-RECORD,
                               FRAME-RECORD
             ENABLE INPUT FOR EVEN-MORE-FRAMES-RECORD
             READ FID-AND-FRAME-SCREEN
             DISABLE INPUT FOR EVEN-MORE-FRAMES-RECORD.
 
           IF ERROR-CODE IN FRAME-HOST-RECORD =
              ERROR-NO-MORE-FRAMES
           THEN
             DISABLE INPUT FOR FID-RECORD,
                               FRAME-RECORD,
                               EVEN-MORE-FRAMES-RECORD
             ENABLE INPUT FOR FIELD-FRAME-ARRAY ( FRAME-INDEX )
             READ FID-AND-FRAME-SCREEN
             VERIFY WS-FRAME-ARRAY
             DISABLE INPUT FOR FRAME-RECORD
 
             MOVE FUNCTION-ADD-FRAME
                  TO FUNCTION OF FRAME-HOST-RECORD
             MOVE FRAME-INDEX TO SHIP-INDEX
             PERFORM SHIP-FRAME-OFF
             PERFORM READ-THE-HOST
                     THROUGH READED-THE-HOST.
 
       SHIP-FRAME-OFF.
           MOVE IS-FRAME-ACTIVE OF FRAME-ARRAY ( SHIP-INDEX )
                TO IS-FRAME-ACTIVE OF FRAME-HOST-RECORD.
      *    STOP IS-FRAME-ACTIVE OF FRAME-ARRAY ( SHIP-INDEX ).
           MOVE FRAME-NAME OF FRAME-ARRAY ( SHIP-INDEX )
                TO FRAME-NAME OF FRAME-HOST-RECORD.
           WRITE HOST-RECORD FROM FRAME-HOST-RECORD.
 
           IF IS-FRAME-ACTIVE OF FRAME-HOST-RECORD = "Y"
           THEN
             MOVE FRAME-NAME OF FRAME-HOST-RECORD
                  TO OUR-CURRENT-FRAME-NAME.
      /
       SLAP-UP-FIELDS.
           MOVE FUNCTION-LET-ER-RIP
                TO FUNCTION OF FIELD-HOST-RECORD.
           WRITE HOST-RECORD FROM FIELD-HOST-RECORD.
           MOVE FLI-MESSAGE-ID TO FLI-MESSAGE-ID-HIDDEN-AWAY.
 
           MOVE SPACES TO WS-ROW-ARRAY.
           MOVE SPACES TO WS-DONE-ROW-ARRAY.
           MOVE SPACES TO WS-ROW-PATTERN.
 
       SLAP-UP-OLD-SLOP.
           MOVE NOPE TO DONE-SCREENING-FLAG.
           MOVE NOPE TO REPAINT-FLAG.
           MOVE NOPE TO WE-GOT-ALL-THE-FIELDS-FLAG.
           PERFORM READ-FOR-FIELDS
                   UNTIL WE-GOT-ALL-THE-FIELDS.
 
           IF ERROR-CODE IN FIELD-HOST-RECORD = ERROR-NO-DICE
           THEN
             GO TO SLAPPED-UP-FIELDS.
 
           IF DONE-SCREENING
           THEN
             IF REPAINT
             THEN
               GO TO SLAP-UP-OLD-SLOP
             ELSE
               GO TO SLAPPED-UP-FIELDS.
 
           MOVE NOPE TO DONE-SCREENING-FLAG.
           MOVE NOPE TO REPAINT-FLAG.
           PERFORM SCREEN-AFTER-SCREEN
                   THROUGH NEXT-SCREEN
                   UNTIL DONE-SCREENING.
 
       SLAPPED-UP-FIELDS.
           EXIT.
      /
       READ-FOR-FIELDS.
           MOVE FLI-MESSAGE-ID-HIDDEN-AWAY TO FLI-MESSAGE-ID.
           PERFORM READ-THE-HOST
                   THROUGH READED-THE-HOST.
           MOVE HOST-RECORD TO FIELD-HOST-RECORD.
 
           IF ERROR-CODE IN FIELD-HOST-RECORD = ERROR-NO-DICE
           THEN
             MOVE YUP TO WE-GOT-ALL-THE-FIELDS-FLAG
           ELSE
             IF ERROR-CODE IN FIELD-HOST-RECORD = ERROR-NO-MORE-FIELDS
             THEN
               MOVE YUP TO WE-GOT-ALL-THE-FIELDS-FLAG
             ELSE
               PERFORM STUFF-A-NEW-FIELD
                       THROUGH STUFFED-A-NEW-FIELD.
 
           IF DONE-SCREENING
           THEN
             MOVE YUP TO WE-GOT-ALL-THE-FIELDS-FLAG.
      /
       STUFF-A-NEW-FIELD.
           MOVE FUNCTION-STUCK-ON-NOTHING
                TO WERE-STUCK-ON-FUNCTION-FLAG.
 
           MOVE POSITION-Y OF DETAILS-ON-TOP TO ROW.
           MOVE POSITION-X OF DETAILS-ON-TOP TO START-COLUMM.
           ADD START-COLUMM,
               PICTURE-STRING-LENGTH,
               -1 GIVING END-COLUMM.
 
           MOVE "YN" TO MOVE-REPEAT-WHICH-FLAG.
           PERFORM REPEAT-STUFF-INTO-NEW-ITEM
                   THROUGH REPEATED-STUFF-INTO-NEW-ITEM.
 
           IF WERE-STUCK-ON-NOTHING
           THEN
             MOVE FUNCTION-LET-ER-RIP-ACK
                  TO FUNCTION OF FIELD-HOST-RECORD
             WRITE HOST-RECORD FROM FIELD-HOST-RECORD
           ELSE
             MOVE FUNCTION-LET-ER-RIP-NACK
                  TO FUNCTION OF FIELD-HOST-RECORD
             WRITE HOST-RECORD FROM FIELD-HOST-RECORD
             PERFORM BRACKET-THE-FIELD
             PERFORM GET-DETAILS-FROM-SCREEN
                     THROUGH GOT-DETAILS-FROM-SCREEN
             PERFORM DEBRACKET-THE-FIELD
             MOVE FUNCTION-LET-ER-RIP-RESUME
                  TO FUNCTION OF FIELD-HOST-RECORD
             WRITE HOST-RECORD FROM FIELD-HOST-RECORD
             IF DONE-SCREENING
             OR THE-FIELD-GOT-DELETED
             THEN
               GO TO STUFFED-A-NEW-FIELD.
 
           MOVE "NY" TO MOVE-REPEAT-WHICH-FLAG.
           PERFORM REPEAT-STUFF-INTO-NEW-ITEM
                   THROUGH REPEATED-STUFF-INTO-NEW-ITEM.
 
           PERFORM GET-PICTURE-SCREEN.
           PRESENT WS-ROW-ARRAY.
           WRITE FIELD-ROW-ARRAY-RECORD.
 
       STUFFED-A-NEW-FIELD.
           EXIT.
      /
       SCREEN-AFTER-SCREEN.
           MOVE WS-DONE-ROW-ARRAY TO WS-ROW-ARRAY.
 
       SCREEN-NEW-SLOP.
           PERFORM GET-PICTURE-SCREEN.
           PRESENT WS-ROW-ARRAY.
           WRITE FIELD-ROW-ARRAY-RECORD.
 
           READ PICTURE-SCREEN.
           VERIFY WS-ROW-ARRAY.
 
           MOVE NOPE TO SOMETHING-HAPPENED-FLAG.
           PERFORM ROW-AFTER-ROW THROUGH NEXT-ROW
                   VARYING ROW FROM 1 BY 1
                   UNTIL ROW > 23.
 
           IF REPAINT
           THEN
             MOVE NOPE TO DONE-SCREENING-FLAG
             MOVE NOPE TO REPAINT-FLAG
             GO TO SCREEN-NEW-SLOP.
 
           IF NOTHING-HAPPENED
           THEN
             MOVE YUP TO DONE-SCREENING-FLAG.
 
       NEXT-SCREEN.
           EXIT.
 
       ROW-AFTER-ROW.
           IF ROW-ARRAY ( ROW ) = DONE-ROW-ARRAY ( ROW )
           THEN
             GO TO NEXT-ROW.
 
           MOVE YUP TO SOMETHING-HAPPENED-FLAG.
 
           PERFORM COLUMM-AFTER-COLUMM THROUGH NEXT-COLUMM
                   VARYING COLUMM FROM 1 BY 1
                   UNTIL COLUMM > 80.
 
           IF DONE-SCREENING
           THEN
             MOVE 23 TO ROW.
 
       NEXT-ROW.
           EXIT.
 
       COLUMM-AFTER-COLUMM.
           IF ROW-BY-COLUMM-ARRAY ( ROW, COLUMM ) NOT =
              DONE-ROW-BY-COLUMM-ARRAY ( ROW, COLUMM )
           THEN
             MOVE ROW TO ROW-OFFICIALLY-SCUN-TO
             MOVE COLUMM TO COLUMM-OFFICIALLY-SCUN-TO
             IF ROW-BY-COLUMM-ARRAY ( ROW, COLUMM ) = SPACE
             THEN
               PERFORM GOT-A-SPACE
                       THROUGH GOTTED-A-SPACE
             ELSE
               IF ROW-BY-COLUMM-ARRAY ( ROW, COLUMM ) = "["
               THEN
                 PERFORM GOT-A-LEFT-BRACKET
                         THROUGH GOTTED-A-LEFT-BRACKET
               ELSE
                 IF ROW-BY-COLUMM-ARRAY ( ROW, COLUMM ) = "]"
                 THEN
                   PERFORM GOT-A-RIGHT-BRACKET
                           THROUGH GOTTED-A-RIGHT-BRACKET
                 ELSE
                   IF DONE-ROW-BY-COLUMM-ARRAY ( ROW, COLUMM ) = SPACE
                   THEN
                     PERFORM GOT-A-NEW-NONBLANK
                             THROUGH GOTTED-A-NEW-NONBLANK
                   ELSE
                     PERFORM GOT-A-NONBLANK
                             THROUGH GOTTED-A-NONBLANK
           ELSE
             GO TO NEXT-COLUMM.
 
           MOVE ROW-OFFICIALLY-SCUN-TO TO ROW.
           MOVE COLUMM-OFFICIALLY-SCUN-TO TO COLUMM.
 
           IF DONE-SCREENING
           THEN
             MOVE 80 TO COLUMM.
 
       NEXT-COLUMM.
           EXIT.
      /
       GOT-A-SPACE.
      *  We found a space where no space has gone before.
      *  This is only legal if a left-side-shortening is being
      *  performed, so there's an error if:
      *    1) we're not over element (1,1);
      *    2) we run out of pattern (looking to the right)
      *       before we find the [.
           MOVE COLUMM TO SPACE-COLUMM.
 
           IF ROW-BY-COLUMM-PATTERN ( ROW, COLUMM ) = "x"
           OR ROW-BY-COLUMM-PATTERN ( ROW, COLUMM ) = "e"
           THEN
             MOVE FLUSH-ARRAY-CHANGE-ERROR TO WHATEVER-ERROR
             GO TO GOTTED-A-SPACE-MUSH.
 
           ADD 1 TO COLUMM.
 
       KEEP-SPACING-AHEAD.
           IF COLUMM > 80
           OR ROW-BY-COLUMM-PATTERN ( ROW, COLUMM ) NOT = "X"
           THEN
             MOVE FLUSH-ILLEGAL-DELETION-ERROR TO WHATEVER-ERROR
             GO TO GOTTED-A-SPACE-MUSH.
 
           IF ROW-BY-COLUMM-ARRAY ( ROW, COLUMM ) = "["
           THEN
             GO TO KEPT-SPACING-AHEAD.
 
           ADD 1 TO COLUMM.
 
           GO TO KEEP-SPACING-AHEAD.
 
       KEPT-SPACING-AHEAD.
           ADD 1 TO COLUMM.
           MOVE ROW-BY-COLUMM-MASTER-X-POS ( ROW, COLUMM )
                TO OLD-START-COLUMM.
           MOVE COLUMM TO START-COLUMM.
 
           PERFORM CHANGE-FIELD
                   THROUGH CHANGED-FIELD.
 
           GO TO GOTTED-A-SPACE.
 
       GOTTED-A-SPACE-MUSH.
           MOVE SPACE-COLUMM TO START-FLUSH-COLUMM.
           PERFORM FLUSH-TO-NEXT-SENSIBLE-FIELD.
 
       GOTTED-A-SPACE.
           EXIT.
      /
       GOT-A-LEFT-BRACKET.
      *  We found a [.
      *  This could be a left-side-lengthening, a
      *  left-side-shortening, or just a vanilla field change.
      *  <Wierdness>
      *  The only way it can be a left-side-shortening is if
      *  the [ is on top of the start of a pattern of "S" or "O"
      *  (a 1-character shortening).  Otherwise, we would have gone
      *  off to GOT-A-BLANK instead.  If this is the case, grab
      *  the OLD-START-COLUMM and vamoose.
      *  UNIMPLEMENTED...UNIMPLEMENTED...UNIMPLEMENTED
      *  The extra-special
      *  wierdness is that this might be a field addition to the
      *  left whose characters are identical to that of the
      *  newly-left-side-shortened field, i.e.:
      *      SXXXXE                 (old pattern)
      *      $$$$99                 (old text)
      *      $$[$99                 (new text)
      *  In this extremely unusual circumstance (sort of like
      *  a field "breakening"), the character under the [ is
      *  assumed to be a $ (it all falls out), and CHANGE-FIELD
      *  is called with START-COLUMM = 1 column after the [ and
      *  OLD-START-COLUMM = the old-start-column.  Then,
      *  ADD-FIELD is called with START-COLUMM = OLD-START-COLUMM.
      *  Note that we have to "back up" in this case in order to
      *  avoid the fact that the CHANGEd field and the ADDed field
      *  actually overlap.
      *  END UNIMPLEMENTED...END UNIMPLEMENTED...END UNIMPLEMENTED
      *  <End wierdness>
      *  If the [ is on top of a pattern of "S" or "O", grab the
      *  OLD-START-COLUMM and vamoose; otherwise, look forward
      *  to the start of a pattern, which should be at
      *  OLD-START-COLUMM.
      *  If the [ is in column 80, then this is really a change to
      *  a field which supposedly starts in column 1 of the next row.
      *  (In this case, it can't be a shortening, but just might be
      *  a very strange lengthening or just a vanilla change.)
      *  For the otherwise case, errors include:
      *    1) finding a pattern under the [;
      *    2) not being on top of element (1,1);
      *    3) finding a ] or a [ or a space before finding a pattern.
           MOVE ROW TO LEFT-BRACKET-ROW.
           MOVE COLUMM TO LEFT-BRACKET-COLUMM.
           MOVE FLUSH-LEFT-BRACKET-ERROR TO WHATEVER-ERROR.
 
           ADD COLUMM, 1 GIVING NEW-START-COLUMM.
 
           IF COLUMM = 80
           THEN
             MOVE 1 TO COLUMM, NEW-START-COLUMM
             ADD 1 TO ROW
             IF ROW > 23
             THEN
               MOVE FLUSH-LEFT-BRACKET-ERROR TO WHATEVER-ERROR
               GO TO GOTTED-A-LEFT-BRACKET-MUSH
             ELSE
               GO TO KEEP-PATTERNING-AHEAD.
 
           IF ROW-BY-COLUMM-PATTERN ( ROW, COLUMM ) = "S"
           OR ROW-BY-COLUMM-PATTERN ( ROW, COLUMM ) = "O"
           THEN
             MOVE COLUMM TO OLD-START-COLUMM
             ADD 1, COLUMM GIVING START-COLUMM
             PERFORM CHANGE-FIELD
                     THROUGH CHANGED-FIELD
             GO TO GOTTED-A-LEFT-BRACKET.
 
           IF ROW-BY-COLUMM-PATTERN ( ROW, COLUMM ) = "X"
           OR ROW-BY-COLUMM-PATTERN ( ROW, COLUMM ) = "E"
           THEN
      *      MOVE ROW-BY-COLUMM-MASTER-X-POS ( ROW, COLUMM )
      *           TO OLD-START-COLUMM
      *      MOVE OLD-START-COLUMM TO ADD-BEFORE-LEFT-BRACKET-COLUMM
      *      MOVE LEFT-BRACKET-COLUMM TO START-COLUMM
      *      ADD 1 TO START-COLUMM
      *
      *      PERFORM CHANGE-FIELD
      *              THROUGH CHANGED-FIELD
      *
      *      MOVE ZERO TO OLD-START-COLUMM
      *      MOVE ADD-BEFORE-LEFT-BRACKET-COLUMM TO START-COLUMM
      *
      *      PERFORM ADD-FIELD
      *              THROUGH ADDED-FIELD
      *
      *      GO TO GOTTED-A-LEFT-BRACKET.
             MOVE FLUSH-LEFT-BRACKET-ERROR TO WHATEVER-ERROR
             GO TO GOTTED-A-LEFT-BRACKET-MUSH.
 
           ADD 1 TO COLUMM.
 
       KEEP-PATTERNING-AHEAD.
           IF ROW-BY-COLUMM-PATTERN ( ROW, COLUMM ) = "x"
           OR ROW-BY-COLUMM-PATTERN ( ROW, COLUMM ) = "s"
           OR ROW-BY-COLUMM-PATTERN ( ROW, COLUMM ) = "e"
           OR ROW-BY-COLUMM-PATTERN ( ROW, COLUMM ) = "o"
           THEN
             MOVE FLUSH-ARRAY-CHANGE-ERROR TO WHATEVER-ERROR
             GO TO GOTTED-A-LEFT-BRACKET-MUSH.
 
           IF ROW-BY-COLUMM-PATTERN ( ROW, COLUMM ) NOT = SPACE
           THEN
             GO TO KEPT-PATTERNING-AHEAD.
 
           IF ROW-BY-COLUMM-ARRAY ( ROW, COLUMM ) = SPACE
           OR ROW-BY-COLUMM-ARRAY ( ROW, COLUMM ) = "]"
           OR ROW-BY-COLUMM-ARRAY ( ROW, COLUMM ) = "["
           THEN
             MOVE FLUSH-LEFT-BRACKET-ERROR TO WHATEVER-ERROR
             GO TO GOTTED-A-LEFT-BRACKET-MUSH.
 
           ADD 1 TO COLUMM.
 
           IF COLUMM > 80
           THEN
             MOVE FLUSH-LEFT-BRACKET-ERROR TO WHATEVER-ERROR
             GO TO GOTTED-A-LEFT-BRACKET-MUSH.
 
           GO TO KEEP-PATTERNING-AHEAD.
 
       KEPT-PATTERNING-AHEAD.
           MOVE ROW-BY-COLUMM-MASTER-X-POS ( ROW, COLUMM )
                TO OLD-START-COLUMM.
           MOVE NEW-START-COLUMM TO START-COLUMM.
 
           PERFORM CHANGE-FIELD
                   THROUGH CHANGED-FIELD.
 
           GO TO GOTTED-A-LEFT-BRACKET.
 
       GOTTED-A-LEFT-BRACKET-MUSH.
           MOVE LEFT-BRACKET-ROW TO ROW.
           MOVE LEFT-BRACKET-COLUMM TO START-FLUSH-COLUMM.
           PERFORM FLUSH-TO-NEXT-SENSIBLE-FIELD.
 
       GOTTED-A-LEFT-BRACKET.
           EXIT.
 
      /
       GOT-A-RIGHT-BRACKET.
      *  We found a ].
      *  This could be a right-side-shortening or just a vanilla
      *  field change.  Note that it can't be a right-side-lengthening
      *  or we would have gone to GOT-A-NONBLANK instead.
      *  We'll look backwards 1 character and hope we're on top
      *  of a pattern (we may already be) and we'll have found both
      *  COLUMM and OLD-COLUMM (note that if there had been a
      *  [, we would have seen it already).
      *  Errors include:
      *    1) not being on top of element (1,1);
      *    2) looking back 1 character and finding no pattern
      *       (can only happen if the ] is on top of an S, s, O, o,
      *       or way out in the middle of nowhere.)
           MOVE ROW TO RIGHT-BRACKET-ROW.
           MOVE COLUMM TO RIGHT-BRACKET-COLUMM.
           MOVE FLUSH-RIGHT-BRACKET-ERROR TO WHATEVER-ERROR.
 
           IF COLUMM = 1
           THEN
             MOVE 80 TO COLUMM
             SUBTRACT 1 FROM ROW
             IF ROW < 1
             THEN
               MOVE FLUSH-RIGHT-BRACKET-ERROR TO WHATEVER-ERROR
               GO TO GOTTED-A-RIGHT-BRACKET-MUSH
             ELSE
               GO TO KEEP-PATTERNING-BACK.
 
           ADD 1 TO COLUMM.
           IF ROW-BY-COLUMM-ARRAY ( ROW, COLUMM ) NOT = SPACE
           AND ( ROW-BY-COLUMM-PATTERN ( ROW, COLUMM ) = "X"
                 OR ROW-BY-COLUMM-PATTERN ( ROW, COLUMM ) = "E" )
           THEN
             MOVE FLUSH-RIGHT-BRACKET-ERROR TO WHATEVER-ERROR
             GO TO GOTTED-A-RIGHT-BRACKET-MUSH.
 
           SUBTRACT 2 FROM COLUMM.
 
       KEEP-PATTERNING-BACK.
           IF ROW-BY-COLUMM-PATTERN ( ROW, COLUMM ) = "x"
           OR ROW-BY-COLUMM-PATTERN ( ROW, COLUMM ) = "s"
           OR ROW-BY-COLUMM-PATTERN ( ROW, COLUMM ) = "e"
           OR ROW-BY-COLUMM-PATTERN ( ROW, COLUMM ) = "o"
           THEN
             MOVE FLUSH-ARRAY-CHANGE-ERROR TO WHATEVER-ERROR
             GO TO GOTTED-A-RIGHT-BRACKET-MUSH.
 
           IF ROW-BY-COLUMM-PATTERN ( ROW, COLUMM ) NOT = "X"
           AND ROW-BY-COLUMM-PATTERN ( ROW, COLUMM ) NOT = "S"
           AND ROW-BY-COLUMM-PATTERN ( ROW, COLUMM ) NOT = "E"
           AND ROW-BY-COLUMM-PATTERN ( ROW, COLUMM ) NOT = "O"
           THEN
             MOVE FLUSH-RIGHT-BRACKET-ERROR TO WHATEVER-ERROR
             GO TO GOTTED-A-RIGHT-BRACKET-MUSH.
 
           MOVE ROW-BY-COLUMM-MASTER-X-POS ( ROW, COLUMM )
                TO OLD-START-COLUMM.
           MOVE OLD-START-COLUMM TO START-COLUMM.
 
           PERFORM CHANGE-FIELD
                   THROUGH CHANGED-FIELD.
 
           GO TO GOTTED-A-RIGHT-BRACKET.
 
       GOTTED-A-RIGHT-BRACKET-MUSH.
           MOVE RIGHT-BRACKET-ROW TO ROW.
           MOVE RIGHT-BRACKET-COLUMM TO START-FLUSH-COLUMM.
           PERFORM FLUSH-TO-NEXT-SENSIBLE-FIELD.
 
       GOTTED-A-RIGHT-BRACKET.
           EXIT.
      /
       GOT-A-NONBLANK.
      *  We found a non-blank which used to be some other non-blank.
      *  We must be on a pattern, so deduce OLD-START-COLUMM and
      *  set START-COLUMM to that.
           MOVE ROW-BY-COLUMM-MASTER-X-POS ( ROW, COLUMM )
                TO OLD-START-COLUMM.
           MOVE OLD-START-COLUMM TO START-COLUMM.
 
           PERFORM CHANGE-FIELD
                   THROUGH CHANGED-FIELD.
 
       GOTTED-A-NONBLANK.
           EXIT.
      /
       GOT-A-NEW-NONBLANK.
      *  We found a non-blank where a space used to be.
      *  Look out:  it could be a field addition or a
      *  right-side-lengthening.
      *  We can't be over a pattern, so start looking right
      *  until we decide it's a field addition by:
      *    1) running off the end of the row;
      *    2) finding a pattern;
      *    3) finding a space or a [
      *       (the [ will eventually be errored);
      *    4) finding a ] and finding that the pattern under the
      *       position 1 character to the left of the new non-blank
      *       isn't a "X" or "E"
      *       (the ] will eventually be errored);
      *  or a right-side-lengthening by:
      *    1) finding a ] and finding that the pattern under the
      *       position 1 character to the left of the new non-blank
      *       is a "X" or "E".
           MOVE COLUMM TO NEW-NONBLANK-COLUMM.
 
           ADD 1 TO COLUMM.
 
       KEEP-NEW-NONBLANKING-AHEAD.
           IF COLUMM > 80
           OR ROW-BY-COLUMM-ARRAY ( ROW, COLUMM ) = SPACE
           OR ROW-BY-COLUMM-ARRAY ( ROW, COLUMM ) = "["
           OR ROW-BY-COLUMM-PATTERN ( ROW, COLUMM ) NOT = SPACE
           THEN
             MOVE ZERO TO OLD-START-COLUMM
             MOVE NEW-NONBLANK-COLUMM TO START-COLUMM
             PERFORM ADD-FIELD
                     THROUGH ADDED-FIELD
             GO TO GOTTED-A-NEW-NONBLANK.
 
           IF ROW-BY-COLUMM-ARRAY ( ROW, COLUMM ) = "]"
           THEN
             MOVE NEW-NONBLANK-COLUMM TO COLUMM
             SUBTRACT 1 FROM COLUMM
             IF ROW-BY-COLUMM-PATTERN ( ROW, COLUMM ) = "E"
             OR ROW-BY-COLUMM-PATTERN ( ROW, COLUMM ) = "O"
             THEN
               MOVE ROW-BY-COLUMM-MASTER-X-POS ( ROW, COLUMM )
                    TO OLD-START-COLUMM
               MOVE OLD-START-COLUMM TO START-COLUMM
               PERFORM CHANGE-FIELD
                       THROUGH CHANGED-FIELD
               GO TO GOTTED-A-NEW-NONBLANK
             ELSE
               MOVE ZERO TO OLD-START-COLUMM
               MOVE NEW-NONBLANK-COLUMM TO START-COLUMM
               PERFORM ADD-FIELD
                       THROUGH ADDED-FIELD
               GO TO GOTTED-A-NEW-NONBLANK.
 
           ADD 1 TO COLUMM.
           GO TO KEEP-NEW-NONBLANKING-AHEAD.
 
       GOTTED-A-NEW-NONBLANK.
           EXIT.
      /
       CHANGE-FIELD.
           MOVE FUNCTION-WERE-DOING-A-CHANGE
                TO WERE-DOING-A-WHAT-FLAG.
 
           MOVE ROW TO POSITION-Y OF DETAILS-ON-TOP.
           MOVE OLD-START-COLUMM TO POSITION-X OF DETAILS-ON-TOP.
           MOVE NOPE TO HOST-DETAILS-ERROR-FLAG.
           PERFORM GET-DETAILS-FROM-HOST
                   THROUGH GOT-DETAILS-FROM-HOST.
           IF HOST-DETAILS-ERROR
           THEN
             GO TO CHANGED-FIELD.
 
           MOVE START-COLUMM TO POSITION-X OF DETAILS-ON-TOP.
           MOVE PICTURE-STRING-LENGTH TO OLD-PICTURE-STRING-LENGTH.
 
           PERFORM GET-PICTURE-STRING
                   THROUGH GOT-PICTURE-STRING.
           IF PICTURE-STRING-ERROR
           THEN
             GO TO CHANGED-FIELD.
 
           PERFORM BRACKET-THE-FIELD.
           PERFORM DEBRACKET-THE-FIELD.
 
           MOVE ROW TO OLD-ROW.
           MOVE REPEATS-X OF DETAILS-ON-TOP TO OLD-REPEATS-X.
           MOVE REPEATS-Y OF DETAILS-ON-TOP TO OLD-REPEATS-Y.
           MOVE SEPARATED-X OF DETAILS-ON-TOP TO OLD-SEPARATED-X.
           MOVE SEPARATED-Y OF DETAILS-ON-TOP TO OLD-SEPARATED-Y.
 
           MOVE "YY" TO MOVE-REPEAT-WHICH-FLAG.
           PERFORM REPEAT-SPACES-INTO-OLD-ITEM
                   THROUGH REPEATED-SPACES-INTO-OLD-ITEM.
 
           ADD OLD-START-COLUMM, OLD-PICTURE-STRING-LENGTH
               GIVING PIC999-WHATEVER.
           IF START-COLUMM < OLD-START-COLUMM
           OR END-COLUMM > PIC999-WHATEVER
           THEN
             MOVE START-COLUMM TO OLD-START-COLUMM
             MOVE PICTURE-STRING-LENGTH TO OLD-PICTURE-STRING-LENGTH
             MOVE 1 TO OLD-REPEATS-X
             MOVE 1 TO OLD-REPEATS-Y
             PERFORM REPEAT-SPACES-INTO-OLD-ITEM
                     THROUGH REPEATED-SPACES-INTO-OLD-ITEM.
 
           MOVE "YN" TO MOVE-REPEAT-WHICH-FLAG.
           PERFORM REPEAT-STUFF-INTO-NEW-ITEM
                   THROUGH REPEATED-STUFF-INTO-NEW-ITEM.
 
           PERFORM BRACKET-THE-FIELD.
 
           PERFORM GET-DETAILS-FROM-SCREEN
                   THROUGH GOT-DETAILS-FROM-SCREEN.
 
           PERFORM DEBRACKET-THE-FIELD.
 
           IF ( DONE-SCREENING AND NOT REPAINT )
           OR THE-FIELD-GOT-DELETED
           THEN
             GO TO CHANGED-FIELD.
 
           MOVE "NY" TO MOVE-REPEAT-WHICH-FLAG.
           PERFORM REPEAT-STUFF-INTO-NEW-ITEM
                   THROUGH REPEATED-STUFF-INTO-NEW-ITEM.
 
           MOVE END-COLUMM TO COLUMM.
 
       CHANGED-FIELD.
           EXIT.
      /
       ADD-FIELD.
           MOVE FUNCTION-WERE-DOING-AN-ADD
                TO WERE-DOING-A-WHAT-FLAG.
 
           MOVE SPACES TO FIELD-HOST-RECORD.
           MOVE ROW TO POSITION-Y OF DETAILS-ON-TOP.
           MOVE START-COLUMM TO POSITION-X OF DETAILS-ON-TOP.
 
           PERFORM GET-PICTURE-STRING
                   THROUGH GOT-PICTURE-STRING.
 
           IF FRAME-NAME OF DETAILS-ON-TOP NOT = SPACES
           THEN
             MOVE FRAME-NAME OF DETAILS-ON-TOP
                  TO OUR-CURRENT-FRAME-NAME.
           MOVE "FILLER" TO FIELD-NAME OF DETAILS-ON-TOP.
           MOVE "Y" TO IS-INPUT OF DETAILS-ON-TOP.
           MOVE "Y" TO IS-OUTPUT OF DETAILS-ON-TOP.
           MOVE OUR-CURRENT-FRAME-NAME
                TO FRAME-NAME OF DETAILS-ON-TOP.
 
           MOVE ROW TO OLD-ROW.
           MOVE START-COLUMM TO OLD-START-COLUMM.
           MOVE PICTURE-STRING-LENGTH TO OLD-PICTURE-STRING-LENGTH.
           MOVE REPEATS-X OF DETAILS-ON-TOP TO OLD-REPEATS-X.
           MOVE REPEATS-Y OF DETAILS-ON-TOP TO OLD-REPEATS-Y.
           MOVE SEPARATED-X OF DETAILS-ON-TOP TO OLD-SEPARATED-X.
           MOVE SEPARATED-Y OF DETAILS-ON-TOP TO OLD-SEPARATED-Y.
 
           PERFORM BRACKET-THE-FIELD.
           PERFORM DEBRACKET-THE-FIELD.
 
           MOVE "YN" TO MOVE-REPEAT-WHICH-FLAG.
           PERFORM REPEAT-SPACES-INTO-OLD-ITEM
                   THROUGH REPEATED-SPACES-INTO-OLD-ITEM.
           PERFORM REPEAT-STUFF-INTO-NEW-ITEM
                   THROUGH REPEATED-STUFF-INTO-NEW-ITEM.
 
           PERFORM BRACKET-THE-FIELD.
 
           PERFORM GET-DETAILS-FROM-SCREEN
                   THROUGH GOT-DETAILS-FROM-SCREEN.
 
           PERFORM DEBRACKET-THE-FIELD.
 
           IF ( DONE-SCREENING AND NOT REPAINT )
           OR THE-FIELD-GOT-DELETED
           THEN
             GO TO ADDED-FIELD.
 
           MOVE "NY" TO MOVE-REPEAT-WHICH-FLAG.
           PERFORM REPEAT-STUFF-INTO-NEW-ITEM
                   THROUGH REPEATED-STUFF-INTO-NEW-ITEM.
 
           MOVE END-COLUMM TO COLUMM.
 
       ADDED-FIELD.
           EXIT.
      /
       GET-PICTURE-STRING.
           MOVE NOPE TO PICTURE-STRING-ERROR-FLAG.
 
           MOVE START-COLUMM TO COLUMM.
           MOVE 1 TO PICTURE-STRING-INDEX.
           MOVE SPACES TO PICTURE-STRING-STRING.
 
       KEEP-GETTING-STRUNG.
           IF COLUMM > 80
           OR ROW-BY-COLUMM-ARRAY ( ROW, COLUMM ) = SPACE
           OR ROW-BY-COLUMM-ARRAY ( ROW, COLUMM ) = "]"
           OR ROW-BY-COLUMM-ARRAY ( ROW, COLUMM ) = "["
           THEN
             GO TO KEPT-GETTING-STRUNG.
 
           IF WERE-DOING-AN-ADD
           THEN
             IF COLUMM > START-COLUMM
                AND ( ROW-BY-COLUMM-PATTERN ( ROW, COLUMM ) = "S"
                      OR ROW-BY-COLUMM-PATTERN ( ROW, COLUMM ) = "O"
                      OR ROW-BY-COLUMM-PATTERN ( ROW, COLUMM ) = "s"
                      OR ROW-BY-COLUMM-PATTERN ( ROW, COLUMM ) = "o" )
             THEN
               GO TO KEPT-GETTING-STRUNG
             ELSE
               NEXT SENTENCE
           ELSE
             IF COLUMM > OLD-START-COLUMM
                AND ( ROW-BY-COLUMM-PATTERN ( ROW, COLUMM ) = "S"
                      OR ROW-BY-COLUMM-PATTERN ( ROW, COLUMM ) = "O"
                      OR ROW-BY-COLUMM-PATTERN ( ROW, COLUMM ) = "s"
                      OR ROW-BY-COLUMM-PATTERN ( ROW, COLUMM ) = "o" )
             THEN
               GO TO KEPT-GETTING-STRUNG.
 
           MOVE ROW-BY-COLUMM-ARRAY ( ROW, COLUMM )
                TO PICTURE-STRING ( PICTURE-STRING-INDEX ).
           IF PICTURE-STRING ( PICTURE-STRING-INDEX ) = "@"
           THEN
             MOVE "&" TO PICTURE-STRING ( PICTURE-STRING-INDEX ).
 
           ADD 1 TO COLUMM.
           ADD 1 TO PICTURE-STRING-INDEX.
           GO TO KEEP-GETTING-STRUNG.
 
       KEPT-GETTING-STRUNG.
           IF COLUMM = START-COLUMM
           THEN
             MOVE START-COLUMM TO START-FLUSH-COLUMM
             PERFORM FLUSH-TO-NEXT-SENSIBLE-FIELD
             GO TO GOT-PICTURE-STRING.
 
           SUBTRACT 1 FROM COLUMM GIVING END-COLUMM.
           SUBTRACT 1 FROM PICTURE-STRING-INDEX
                      GIVING PICTURE-STRING-LENGTH.
 
       GOT-PICTURE-STRING.
           EXIT.
      /
       BRACKET-THE-FIELD.
           IF WERE-STUCK-ON-NOTHING
           THEN
             IF START-COLUMM > 1
             THEN
               MOVE ROW TO LB-ROW
               SUBTRACT 1 FROM START-COLUMM GIVING LB-COLUMM
               IF ROW-BY-COLUMM-ARRAY
                  ( LB-ROW, LB-COLUMM ) = "["
               THEN
                 MOVE DONE-ROW-BY-COLUMM-ARRAY
                      ( LB-ROW, LB-COLUMM )
                      TO WHATS-UNDER-THE-LB
                 MOVE "{"
                      TO ROW-BY-COLUMM-ARRAY
                         ( LB-ROW, LB-COLUMM )
               ELSE
                 MOVE ROW-BY-COLUMM-ARRAY
                      ( LB-ROW, LB-COLUMM )
                      TO WHATS-UNDER-THE-LB
                 MOVE "{"
                      TO ROW-BY-COLUMM-ARRAY
                         ( LB-ROW, LB-COLUMM )
             ELSE
               SUBTRACT 1 FROM ROW GIVING LB-ROW
               IF LB-ROW > 0
               THEN
                 MOVE 80 TO LB-COLUMM
                 IF ROW-BY-COLUMM-ARRAY
                    ( LB-ROW, LB-COLUMM ) = "["
                 THEN
                   MOVE DONE-ROW-BY-COLUMM-ARRAY
                        ( LB-ROW, LB-COLUMM )
                        TO WHATS-UNDER-THE-LB
                   MOVE "{"
                        TO ROW-BY-COLUMM-ARRAY
                           ( LB-ROW, LB-COLUMM )
                 ELSE
                   MOVE ROW-BY-COLUMM-ARRAY
                        ( LB-ROW, LB-COLUMM )
                        TO WHATS-UNDER-THE-LB
                   MOVE "{"
                        TO ROW-BY-COLUMM-ARRAY
                           ( LB-ROW, LB-COLUMM )
               ELSE
                 MOVE ZERO TO LB-ROW
           ELSE
             IF START-COLUMM > 1
             THEN
               MOVE ROW TO TEST-LB-ROW
               SUBTRACT 1 FROM START-COLUMM GIVING TEST-LB-COLUMM
               IF TEST-ROW-BY-COLUMM-ARRAY
                  ( TEST-LB-ROW, TEST-LB-COLUMM ) = "["
               THEN
                 MOVE DONE-ROW-BY-COLUMM-ARRAY
                      ( TEST-LB-ROW, TEST-LB-COLUMM )
                      TO WHATS-UNDER-THE-TEST-LB
                 MOVE "{"
                      TO TEST-ROW-BY-COLUMM-ARRAY
                         ( TEST-LB-ROW, TEST-LB-COLUMM )
               ELSE
                 MOVE TEST-ROW-BY-COLUMM-ARRAY
                      ( TEST-LB-ROW, TEST-LB-COLUMM )
                      TO WHATS-UNDER-THE-TEST-LB
                 MOVE "{"
                      TO TEST-ROW-BY-COLUMM-ARRAY
                         ( TEST-LB-ROW, TEST-LB-COLUMM )
             ELSE
               SUBTRACT 1 FROM ROW GIVING TEST-LB-ROW
               IF TEST-LB-ROW > 0
               THEN
                 MOVE 80 TO TEST-LB-COLUMM
                 IF TEST-ROW-BY-COLUMM-ARRAY
                    ( TEST-LB-ROW, TEST-LB-COLUMM ) = "["
                 THEN
                   MOVE DONE-ROW-BY-COLUMM-ARRAY
                        ( TEST-LB-ROW, TEST-LB-COLUMM )
                        TO WHATS-UNDER-THE-TEST-LB
                   MOVE "{"
                        TO TEST-ROW-BY-COLUMM-ARRAY
                           ( TEST-LB-ROW, TEST-LB-COLUMM )
                 ELSE
                   MOVE TEST-ROW-BY-COLUMM-ARRAY
                        ( TEST-LB-ROW, TEST-LB-COLUMM )
                        TO WHATS-UNDER-THE-TEST-LB
                   MOVE "{"
                        TO TEST-ROW-BY-COLUMM-ARRAY
                           ( TEST-LB-ROW, TEST-LB-COLUMM )
               ELSE
                 MOVE ZERO TO TEST-LB-ROW.
 
           IF WERE-STUCK-ON-NOTHING
           THEN
             IF END-COLUMM < 80
             THEN
               MOVE ROW TO RB-ROW
               ADD 1, END-COLUMM GIVING RB-COLUMM
               IF ROW-BY-COLUMM-ARRAY
                  ( RB-ROW, RB-COLUMM ) = "]"
               THEN
                 MOVE DONE-ROW-BY-COLUMM-ARRAY
                      ( RB-ROW, RB-COLUMM )
                      TO WHATS-UNDER-THE-RB
                 MOVE "}"
                      TO ROW-BY-COLUMM-ARRAY
                         ( RB-ROW, RB-COLUMM )
               ELSE
                 MOVE ROW-BY-COLUMM-ARRAY
                      ( RB-ROW, RB-COLUMM )
                      TO WHATS-UNDER-THE-RB
                 MOVE "}"
                      TO ROW-BY-COLUMM-ARRAY
                         ( RB-ROW, RB-COLUMM )
             ELSE
               ADD 1, ROW GIVING RB-ROW
               IF RB-ROW NOT > 23
               THEN
                 MOVE 1 TO RB-COLUMM
                 IF ROW-BY-COLUMM-ARRAY
                    ( RB-ROW, RB-COLUMM ) = "]"
                 THEN
                   MOVE DONE-ROW-BY-COLUMM-ARRAY
                        ( RB-ROW, RB-COLUMM )
                        TO WHATS-UNDER-THE-RB
                   MOVE "}"
                        TO ROW-BY-COLUMM-ARRAY
                           ( RB-ROW, RB-COLUMM )
                 ELSE
                   MOVE ROW-BY-COLUMM-ARRAY
                        ( RB-ROW, RB-COLUMM )
                        TO WHATS-UNDER-THE-RB
                   MOVE "}"
                        TO ROW-BY-COLUMM-ARRAY
                           ( RB-ROW, RB-COLUMM )
               ELSE
                 MOVE ZERO TO RB-ROW
           ELSE
             IF END-COLUMM < 80
             THEN
               MOVE ROW TO TEST-RB-ROW
               ADD 1, END-COLUMM GIVING TEST-RB-COLUMM
               IF TEST-ROW-BY-COLUMM-ARRAY
                  ( TEST-RB-ROW, TEST-RB-COLUMM ) = "]"
               THEN
                 MOVE DONE-ROW-BY-COLUMM-ARRAY
                      ( TEST-RB-ROW, TEST-RB-COLUMM )
                      TO WHATS-UNDER-THE-TEST-RB
                 MOVE "}"
                      TO TEST-ROW-BY-COLUMM-ARRAY
                         ( TEST-RB-ROW, TEST-RB-COLUMM )
               ELSE
                 MOVE TEST-ROW-BY-COLUMM-ARRAY
                      ( TEST-RB-ROW, TEST-RB-COLUMM )
                      TO WHATS-UNDER-THE-TEST-RB
                 MOVE "}"
                      TO TEST-ROW-BY-COLUMM-ARRAY
                      ( TEST-RB-ROW, TEST-RB-COLUMM )
             ELSE
               ADD 1, ROW GIVING TEST-RB-ROW
               IF TEST-RB-ROW NOT > 23
               THEN
                 MOVE 1 TO TEST-RB-COLUMM
                 IF TEST-ROW-BY-COLUMM-ARRAY
                    ( TEST-RB-ROW, TEST-RB-COLUMM ) = "]"
                 THEN
                   MOVE DONE-ROW-BY-COLUMM-ARRAY
                        ( TEST-RB-ROW, TEST-RB-COLUMM )
                        TO WHATS-UNDER-THE-TEST-RB
                   MOVE "}"
                        TO TEST-ROW-BY-COLUMM-ARRAY
                           ( TEST-RB-ROW, TEST-RB-COLUMM )
                 ELSE
                   MOVE TEST-ROW-BY-COLUMM-ARRAY
                        ( TEST-RB-ROW, TEST-RB-COLUMM )
                        TO WHATS-UNDER-THE-TEST-RB
                   MOVE "}"
                        TO TEST-ROW-BY-COLUMM-ARRAY
                        ( TEST-RB-ROW, TEST-RB-COLUMM )
               ELSE
                 MOVE ZERO TO TEST-RB-ROW.
 
       DEBRACKET-THE-FIELD.
           IF WERE-STUCK-ON-NOTHING
           THEN
             IF LB-ROW NOT = ZERO
             THEN
               MOVE WHATS-UNDER-THE-LB
                    TO ROW-BY-COLUMM-ARRAY
                       ( LB-ROW, LB-COLUMM )
             ELSE
               NEXT SENTENCE
           ELSE
             IF TEST-LB-ROW NOT = ZERO
             THEN
               MOVE WHATS-UNDER-THE-TEST-LB
                    TO TEST-ROW-BY-COLUMM-ARRAY
                       ( TEST-LB-ROW, TEST-LB-COLUMM ).
 
           IF WERE-STUCK-ON-NOTHING
           THEN
             IF RB-ROW NOT = ZERO
             THEN
               MOVE WHATS-UNDER-THE-RB
                    TO ROW-BY-COLUMM-ARRAY
                       ( RB-ROW, RB-COLUMM )
             ELSE
               NEXT SENTENCE
           ELSE
             IF TEST-RB-ROW NOT = ZERO
             THEN
               MOVE WHATS-UNDER-THE-TEST-RB
                    TO TEST-ROW-BY-COLUMM-ARRAY
                       ( TEST-RB-ROW, TEST-RB-COLUMM ).
      /
       GET-DETAILS-FROM-HOST.
           MOVE FUNCTION-GET-FIELD-DETAILS
                TO FUNCTION OF FIELD-HOST-RECORD.
           WRITE HOST-RECORD FROM FIELD-HOST-RECORD.
 
           PERFORM READ-THE-HOST
                   THROUGH READED-THE-HOST.
           MOVE HOST-RECORD TO FIELD-HOST-RECORD.
 
           IF ERROR-CODE IN FIELD-HOST-RECORD = ERROR-NO-DICE
           THEN
             MOVE SPACES TO DETAILS-ON-TOP.
 
       GOT-DETAILS-FROM-HOST.
           EXIT.
      /
       GET-DETAILS-FROM-SCREEN.
           MOVE NOPE TO THEY-GOT-IT-RIGHT-FLAG.
           MOVE NOPE TO NICE-MISTER-HOST-IS-A-NAG-FLAG.
           MOVE NOPE TO THE-FIELD-GOT-DELETED-FLAG.
 
       KEEP-GETTN-DETAILS-FROM-SCREEN.
           MOVE ROW TO OLD-ROW.
           MOVE START-COLUMM TO OLD-START-COLUMM.
           MOVE PICTURE-STRING-LENGTH TO OLD-PICTURE-STRING-LENGTH.
           MOVE REPEATS-X OF DETAILS-ON-TOP TO OLD-REPEATS-X.
           MOVE REPEATS-Y OF DETAILS-ON-TOP TO OLD-REPEATS-Y.
           MOVE SEPARATED-X OF DETAILS-ON-TOP TO OLD-SEPARATED-X.
           MOVE SEPARATED-Y OF DETAILS-ON-TOP TO OLD-SEPARATED-Y.
           MOVE IS-CONSTANT-DEFAULT OF DETAILS-ON-TOP
                TO OLD-IS-CONSTANT-DEFAULT.
 
           PERFORM GET-DETAILS-SCREEN.
 
           MOVE SPACES TO DETAILS-COMMAND,
                          DETAILS-OPTION.
 
           MOVE FUNCTION-PUT-FIELD-DETAILS
                TO FUNCTION OF FIELD-HOST-RECORD.
 
           IF ROW > 12
           THEN
             PRESENT DETAILS-ON-TOP-COMMAND,
                     DETAILS-ON-TOP-OPTION
             PRESENT DETAILS-ON-TOP
             IF WERE-STUCK-ON-NOTHING
             THEN
               PRESENT WS-BOTTOM-XX-ROW-ARRAY
               WRITE DETAILS-ON-TOP-RECORD
               DISABLE INPUT FOR FIELD-BOTTOM-XX-ROW-ARRAY-SG
               READ DETAILS-ON-TOP-SCREEN
               VERIFY DETAILS-ON-TOP-COMMAND
               VERIFY DETAILS-ON-TOP
             ELSE
               PRESENT WS-TEST-BOTTOM-XX-ROW-ARRAY
               WRITE DETAILS-ON-TOP-RECORD
               DISABLE INPUT FOR FIELD-BOTTOM-XX-ROW-ARRAY-SG
               READ DETAILS-ON-TOP-SCREEN
               VERIFY DETAILS-ON-TOP-COMMAND
               VERIFY DETAILS-ON-TOP
           ELSE
             PRESENT DETAILS-ON-BOTTOM-COMMAND,
                     DETAILS-ON-BOTTOM-OPTION
             PRESENT DETAILS-ON-BOTTOM
             IF WERE-STUCK-ON-NOTHING
             THEN
               PRESENT WS-TOP-XX-ROW-ARRAY
               WRITE DETAILS-ON-BOTTOM-RECORD
               DISABLE INPUT FOR FIELD-TOP-XX-ROW-ARRAY-SG
               READ DETAILS-ON-BOTTOM-SCREEN
               VERIFY DETAILS-ON-BOTTOM-COMMAND
               VERIFY DETAILS-ON-BOTTOM
             ELSE
               PRESENT WS-TEST-TOP-XX-ROW-ARRAY
               WRITE DETAILS-ON-BOTTOM-RECORD
               DISABLE INPUT FOR FIELD-TOP-XX-ROW-ARRAY-SG
               READ DETAILS-ON-BOTTOM-SCREEN
               VERIFY DETAILS-ON-BOTTOM-COMMAND
               VERIFY DETAILS-ON-BOTTOM.
 
           IF DETAILS-COMMAND = "E"
           OR DETAILS-COMMAND = "EN"
           OR DETAILS-COMMAND = "END"
           OR DETAILS-COMMAND = "Q"
           OR DETAILS-COMMAND = "QU"
           OR DETAILS-COMMAND = "QUI"
           OR DETAILS-COMMAND = "QUIT"
           OR DETAILS-COMMAND = "X"
           THEN
             MOVE YUP TO DONE-SCREENING-FLAG
             GO TO GOT-DETAILS-FROM-SCREEN.
 
           IF DETAILS-COMMAND = "PA"
           OR DETAILS-COMMAND = "PAI"
           OR DETAILS-COMMAND = "PAIN"
           OR DETAILS-COMMAND = "PAINT"
           THEN
             IF WERE-STUCK-ON-NOTHING
             AND NOT NICE-MISTER-HOST-IS-A-NAG
             THEN
               MOVE YUP TO DONE-SCREENING-FLAG
               MOVE YUP TO REPAINT-FLAG
               GO TO TALK-TO-SOMEBODY
             ELSE
               STOP "You can't return to PAINT mode with an outstanding
      -             "error."
               GO TO TALK-TO-SOMEBODY.
 
           IF DETAILS-COMMAND = "ICK"
           THEN
             PERFORM GET-PICTURE-SCREEN
             MOVE FIELD-HOST-RECORD TO WS-TEST-ROW-ARRAY
             PRESENT WS-TEST-ROW-ARRAY
             WRITE FIELD-ROW-ARRAY-RECORD
             STOP "Tubhead."
             PERFORM GET-DETAILS-SCREEN
             IF ROW > 12
             THEN
               PRESENT DETAILS-ON-TOP
               PRESENT WS-BOTTOM-XX-ROW-ARRAY
               WRITE DETAILS-ON-TOP-RECORD
               GO TO TALK-TO-NICE-MISTER-HOST
             ELSE
               PRESENT DETAILS-ON-BOTTOM
               PRESENT WS-TOP-XX-ROW-ARRAY
               WRITE DETAILS-ON-BOTTOM-RECORD
               GO TO TALK-TO-NICE-MISTER-HOST.
 
           IF DETAILS-COMMAND = "SNOT"
           THEN
             PERFORM GET-PICTURE-SCREEN
             PRESENT WS-ROW-PATTERN
             WRITE FIELD-ROW-ARRAY-RECORD
             STOP "Tubhead."
             PERFORM GET-DETAILS-SCREEN
             IF ROW > 12
             THEN
               PRESENT DETAILS-ON-TOP
               PRESENT WS-BOTTOM-XX-ROW-ARRAY
               WRITE DETAILS-ON-TOP-RECORD
               GO TO TALK-TO-NICE-MISTER-HOST
             ELSE
               PRESENT DETAILS-ON-BOTTOM
               PRESENT WS-TOP-XX-ROW-ARRAY
               WRITE DETAILS-ON-BOTTOM-RECORD
               GO TO TALK-TO-NICE-MISTER-HOST.
 
           IF DETAILS-COMMAND = "DEF"
           OR DETAILS-COMMAND = "DEFA"
           OR DETAILS-COMMAND = "DEFAU"
           OR DETAILS-COMMAND = "DEFAUL"
           OR DETAILS-COMMAND = "DEFAULT"
           THEN
             IF WERE-STUCK-ON-NOTHING
             THEN
               PERFORM PICK-DEFAULT
                       THROUGH PICKED-DEFAULT
               GO TO TALK-TO-NICE-MISTER-SCREEN
             ELSE
               STOP "You can't fill in the DEFAULT VALUE with an outstan
      -             "ding error."
               GO TO TALK-TO-SOMEBODY.
 
 
           IF IS-CONSTANT-DEFAULT OF DETAILS-ON-TOP = "D"
           AND IS-CONSTANT-DEFAULT OF DETAILS-ON-TOP NOT =
               OLD-IS-CONSTANT-DEFAULT
           AND WERE-STUCK-ON-NOTHING
           THEN
             PERFORM PICK-DEFAULT
                     THROUGH PICKED-DEFAULT
             GO TO TALK-TO-NICE-MISTER-SCREEN.
 
           IF DETAILS-COMMAND = "DEL"
           OR DETAILS-COMMAND = "DELE"
           OR DETAILS-COMMAND = "DELET"
           OR DETAILS-COMMAND = "DELETE"
           THEN
             PERFORM DELETE-FIELD
                     THROUGH DELETED-FIELD
             GO TO TALK-TO-NICE-MISTER-HOST.
 
           IF DETAILS-COMMAND = "L"
           OR DETAILS-COMMAND = "LI"
           OR DETAILS-COMMAND = "LIK"
           OR DETAILS-COMMAND = "LIKE"
           THEN
             MOVE NOPE TO THEY-GOT-AT-RIGHT-FLAG
             PERFORM LIKE-FIELD
                     THROUGH LIKED-FIELD
                     UNTIL THEY-GOT-AT-RIGHT
             GO TO TALK-TO-NICE-MISTER-HOST.
 
           IF DETAILS-COMMAND = "M"
           OR DETAILS-COMMAND = "MO"
           OR DETAILS-COMMAND = "MOV"
           OR DETAILS-COMMAND = "MOVE"
           THEN
             MOVE NOPE TO THEY-GOT-AT-RIGHT-FLAG
             PERFORM MOVE-FIELD
                     THROUGH MOVED-FIELD
                     UNTIL THEY-GOT-AT-RIGHT
             GO TO TALK-TO-NICE-MISTER-HOST.
 
      *    IF DETAILS-COMMAND = "O"
      *    OR DETAILS-COMMAND = "OT"
      *    OR DETAILS-COMMAND = "OTH"
      *    OR DETAILS-COMMAND = "OTHE"
      *    OR DETAILS-COMMAND = "OTHER"
      *    THEN
      *      IF WERE-STUCK-ON-AN-OVERLAP
      *      THEN
      *        PERFORM SWAP-WITH-OTHER-OVERLAPPER
      *        GO TO GOT-DETAILS-FROM-SCREEN
      *      ELSE
      *        STOP "What OTHER overlapping field?"
      *        GO TO GOT-DETAILS-FROM-SCREEN.
      *
           IF DETAILS-COMMAND = "PI"
           OR DETAILS-COMMAND = "PIC"
           OR DETAILS-COMMAND = "PICT"
           OR DETAILS-COMMAND = "PICTU"
           OR DETAILS-COMMAND = "PICTUR"
           OR DETAILS-COMMAND = "PICTURE"
           THEN
             IF WERE-STUCK-ON-NOTHING
             THEN
               PERFORM PICK-PICTURE-STRING
                       THROUGH PICKED-PICTURE-STRING
               GO TO TALK-TO-NICE-MISTER-SCREEN
             ELSE
               STOP "You can't repaint the PICture string with an outsta
      -             "nding error."
               GO TO TALK-TO-SOMEBODY.
 
      *  OK.  We just got some details, and if no MOVE or
      *  DELETE command was issued on top of that, we may need
      *  to slosh this field around a bit if the REPEATS stuff
      *  was changed.
       TALK-TO-SOMEBODY.
           IF WERE-STUCK-ON-NOTHING
           AND REPEATS-X OF DETAILS-ON-TOP = OLD-REPEATS-X
           AND SEPARATED-X OF DETAILS-ON-TOP = OLD-SEPARATED-X
           AND REPEATS-Y OF DETAILS-ON-TOP = OLD-REPEATS-Y
           AND SEPARATED-Y OF DETAILS-ON-TOP = OLD-SEPARATED-Y
           THEN
             IF ROW > 12
             THEN
               IF NICE-MISTER-HOST-IS-A-NAG
               OR FIELD-FIELD-NAME
                  OF DETAILS-ON-TOP-RECORD IS AVAILABLE
               OR FIELD-IS-INPUT
                  OF DETAILS-ON-TOP-RECORD IS AVAILABLE
               OR FIELD-IS-OUTPUT
                  OF DETAILS-ON-TOP-RECORD IS AVAILABLE
               OR FIELD-FRAME-NAME
                  OF DETAILS-ON-TOP-RECORD IS AVAILABLE
               OR FIELD-IS-ENTRY-REQUIRED
                  OF DETAILS-ON-TOP-RECORD IS AVAILABLE
               OR FIELD-IS-A-O-I-M
                  OF DETAILS-ON-TOP-RECORD IS AVAILABLE
               OR FIELD-CLASS-CLAUSE
                  OF DETAILS-ON-TOP-RECORD IS AVAILABLE
               OR FIELD-MINIMUM-SIZE-CLAUSE
                  OF DETAILS-ON-TOP-RECORD IS AVAILABLE
               OR FIELD-FILL-CHARACTER
                  OF DETAILS-ON-TOP-RECORD IS AVAILABLE
               OR FIELD-SIGN-CLAUSE
                  OF DETAILS-ON-TOP-RECORD IS AVAILABLE
               OR FIELD-IS-BWZ
                  OF DETAILS-ON-TOP-RECORD IS AVAILABLE
               OR FIELD-IS-CONSTANT-DEFAULT
                  OF DETAILS-ON-TOP-RECORD IS AVAILABLE
               OR FIELD-IS-JUSTIFIED-RIGHT
                  OF DETAILS-ON-TOP-RECORD IS AVAILABLE
               OR FIELD-VISUAL-ATTRIBUTE-CLAUSE
                  OF DETAILS-ON-TOP-RECORD IS AVAILABLE
      *        OR FIELD-REPEATS-X
      *           OF DETAILS-ON-TOP-RECORD IS AVAILABLE
      *        OR FIELD-SEPARATED-X
      *           OF DETAILS-ON-TOP-RECORD IS AVAILABLE
      *        OR FIELD-REPEATS-Y
      *           OF DETAILS-ON-TOP-RECORD IS AVAILABLE
      *        OR FIELD-SEPARATED-Y
      *           OF DETAILS-ON-TOP-RECORD IS AVAILABLE
               OR FIELD-PROMPT-TYPE
                  OF DETAILS-ON-TOP-RECORD IS AVAILABLE
               OR FIELD-PROMPT-TEXT
                  OF DETAILS-ON-TOP-RECORD IS AVAILABLE
               THEN
                 GO TO TALK-TO-NICE-MISTER-HOST
               ELSE
                 MOVE YUP TO THEY-GOT-IT-RIGHT-FLAG
                 GO TO TALK-TO-NICE-MISTER-HOST
             ELSE
               IF NICE-MISTER-HOST-IS-A-NAG
               OR FIELD-FIELD-NAME
                  OF DETAILS-ON-BOTTOM-RECORD IS AVAILABLE
               OR FIELD-IS-INPUT
                  OF DETAILS-ON-BOTTOM-RECORD IS AVAILABLE
               OR FIELD-IS-OUTPUT
                  OF DETAILS-ON-BOTTOM-RECORD IS AVAILABLE
               OR FIELD-FRAME-NAME
                  OF DETAILS-ON-BOTTOM-RECORD IS AVAILABLE
               OR FIELD-IS-ENTRY-REQUIRED
                  OF DETAILS-ON-BOTTOM-RECORD IS AVAILABLE
               OR FIELD-IS-A-O-I-M
                  OF DETAILS-ON-BOTTOM-RECORD IS AVAILABLE
               OR FIELD-CLASS-CLAUSE
                  OF DETAILS-ON-BOTTOM-RECORD IS AVAILABLE
               OR FIELD-MINIMUM-SIZE-CLAUSE
                  OF DETAILS-ON-BOTTOM-RECORD IS AVAILABLE
               OR FIELD-FILL-CHARACTER
                  OF DETAILS-ON-BOTTOM-RECORD IS AVAILABLE
               OR FIELD-SIGN-CLAUSE
                  OF DETAILS-ON-BOTTOM-RECORD IS AVAILABLE
               OR FIELD-IS-BWZ
                  OF DETAILS-ON-BOTTOM-RECORD IS AVAILABLE
               OR FIELD-IS-CONSTANT-DEFAULT
                  OF DETAILS-ON-BOTTOM-RECORD IS AVAILABLE
               OR FIELD-IS-JUSTIFIED-RIGHT
                  OF DETAILS-ON-BOTTOM-RECORD IS AVAILABLE
               OR FIELD-VISUAL-ATTRIBUTE-CLAUSE
                  OF DETAILS-ON-BOTTOM-RECORD IS AVAILABLE
      *        OR FIELD-REPEATS-X
      *           OF DETAILS-ON-BOTTOM-RECORD IS AVAILABLE
      *        OR FIELD-SEPARATED-X
      *           OF DETAILS-ON-BOTTOM-RECORD IS AVAILABLE
      *        OR FIELD-REPEATS-Y
      *           OF DETAILS-ON-BOTTOM-RECORD IS AVAILABLE
      *        OR FIELD-SEPARATED-Y
      *           OF DETAILS-ON-BOTTOM-RECORD IS AVAILABLE
               OR FIELD-PROMPT-TYPE
                  OF DETAILS-ON-BOTTOM-RECORD IS AVAILABLE
               OR FIELD-PROMPT-TEXT
                  OF DETAILS-ON-BOTTOM-RECORD IS AVAILABLE
               THEN
                 GO TO TALK-TO-NICE-MISTER-HOST
               ELSE
                 MOVE YUP TO THEY-GOT-IT-RIGHT-FLAG
                 GO TO TALK-TO-NICE-MISTER-HOST.
 
       TALK-TO-NICE-MISTER-SCREEN.
           PERFORM DEBRACKET-THE-FIELD.
 
           MOVE "YN" TO MOVE-REPEAT-WHICH-FLAG.
 
           IF WERE-STUCK-ON-NOTHING
           THEN
             PERFORM REPEAT-SPACES-INTO-OLD-ITEM
                     THROUGH REPEATED-SPACES-INTO-OLD-ITEM.
 
           PERFORM REPEAT-STUFF-INTO-NEW-ITEM
                   THROUGH REPEATED-STUFF-INTO-NEW-ITEM.
 
           PERFORM BRACKET-THE-FIELD.
 
       TALK-TO-NICE-MISTER-HOST.
           WRITE HOST-RECORD FROM FIELD-HOST-RECORD.
 
           PERFORM READ-THE-HOST
                   THROUGH READED-THE-HOST.
           MOVE HOST-RECORD TO FIELD-HOST-RECORD.
 
           IF ERROR-CODE IN FIELD-HOST-RECORD = ERROR-NO-DICE
           THEN
             MOVE YUP TO NICE-MISTER-HOST-IS-A-NAG-FLAG
             MOVE NOPE TO THEY-GOT-IT-RIGHT-FLAG
             MOVE NOPE TO DONE-SCREENING-FLAG
             MOVE NOPE TO REPAINT-FLAG
           ELSE
             MOVE NOPE TO NICE-MISTER-HOST-IS-A-NAG-FLAG.
 
           IF NOT THEY-GOT-IT-RIGHT
           THEN
             GO TO KEEP-GETTN-DETAILS-FROM-SCREEN.
 
      *    STOP WERE-STUCK-ON-FUNCTION-FLAG.
 
       GOT-DETAILS-FROM-SCREEN.
           EXIT.
      /
       PICK-DEFAULT.
           PERFORM GET-PICTURE-SCREEN.
           APPLY EMPHASIS-ATTRIBUTE TO FIELD-ROW-ARRAY ( ROW ).
 
           IF IS-CONSTANT-DEFAULT OF DETAILS-ON-TOP = "D"
           AND OLD-IS-CONSTANT-DEFAULT = "D"
           THEN
             MOVE 1 TO DEFAULT-INDEX
             PERFORM UNPICKING-DEFAULT
                     VARYING PICK-COLUMM FROM START-COLUMM BY 1
                     UNTIL PICK-COLUMM > END-COLUMM.
           MOVE "D" TO IS-CONSTANT-DEFAULT OF DETAILS-ON-TOP.
           MOVE PICTURE-STRING-LENGTH
                TO CONSTANT-DEFAULT-LENGTH OF DETAILS-ON-TOP.
 
           PRESENT WS-ROW-ARRAY.
           WRITE FIELD-ROW-ARRAY-RECORD.
 
           MOVE PICKING-DEFAULT-PROMPT TO PICKING-PROMPT.
           ACCEPT FIELD-ROW-ARRAY ( ROW ).
           VERIFY WS-TEST-ROW-ARRAY.
 
           MOVE 1 TO DEFAULT-INDEX.
           PERFORM PICKING-DEFAULT
                   VARYING PICK-COLUMM FROM START-COLUMM BY 1
                   UNTIL PICK-COLUMM > END-COLUMM.
 
           APPLY INITIAL-ATTRIBUTE TO FIELD-ROW-ARRAY ( ROW ).
           PERFORM GET-DETAILS-SCREEN.
 
       PICKED-DEFAULT.
           EXIT.
      /
       PICK-PICTURE-STRING.
           PERFORM GET-PICTURE-SCREEN.
           APPLY EMPHASIS-ATTRIBUTE TO FIELD-ROW-ARRAY ( ROW ).
 
       KEEP-PICKING-PICTURE-STRING.
           PRESENT WS-ROW-ARRAY.
           WRITE FIELD-ROW-ARRAY-RECORD.
 
           MOVE PICKING-PICTURE-STRING-PROMPT TO PICKING-PROMPT.
           ACCEPT FIELD-ROW-ARRAY ( ROW ).
           VERIFY WS-TEST-ROW-ARRAY.
 
           MOVE NOPE TO PICK-PICTURE-STRING-ERROR-FLAG.
           MOVE 1 TO PICTURE-STRING-INDEX.
           PERFORM PICKING-PICTURE-STRING
                   VARYING PICK-COLUMM FROM START-COLUMM BY 1
                   UNTIL PICK-COLUMM > END-COLUMM.
 
           IF PICK-PICTURE-STRING-ERROR
           THEN
             STOP "Embedded blanks are not allowed in PICture strings:
      -           "try again."
             GO TO KEEP-PICKING-PICTURE-STRING.
 
           APPLY INITIAL-ATTRIBUTE TO FIELD-ROW-ARRAY ( ROW ).
           PERFORM GET-DETAILS-SCREEN.
 
       PICKED-PICTURE-STRING.
           EXIT.
      /
       UNPICKING-DEFAULT.
           MOVE DEFAULT-VALUE OF DETAILS-ON-TOP ( DEFAULT-INDEX )
                TO ROW-BY-COLUMM-ARRAY ( ROW, PICK-COLUMM ).
 
           ADD 1 TO DEFAULT-INDEX.
 
       PICKING-DEFAULT.
           MOVE TEST-ROW-BY-COLUMM-ARRAY ( ROW, PICK-COLUMM )
                TO DEFAULT-VALUE OF DETAILS-ON-TOP ( DEFAULT-INDEX ).
 
           ADD 1 TO DEFAULT-INDEX.
 
       PICKING-PICTURE-STRING.
           IF TEST-ROW-BY-COLUMM-ARRAY ( ROW, PICK-COLUMM ) = SPACE
           THEN
             MOVE YUP TO PICK-PICTURE-STRING-ERROR-FLAG
             MOVE END-COLUMM TO PICK-COLUMM.
 
           MOVE TEST-ROW-BY-COLUMM-ARRAY ( ROW, PICK-COLUMM )
                TO PICTURE-STRING ( PICTURE-STRING-INDEX ).
 
           ADD 1 TO PICTURE-STRING-INDEX.
 
      /
       DELETE-FIELD.
           MOVE YUP TO THE-FIELD-GOT-DELETED-FLAG.
 
           IF WERE-STUCK-ON-NOTHING
           THEN
             MOVE "YN" TO MOVE-REPEAT-WHICH-FLAG
             PERFORM REPEAT-SPACES-INTO-OLD-ITEM
                     THROUGH REPEATED-SPACES-INTO-OLD-ITEM
           ELSE
             MOVE FUNCTION-STUCK-ON-NOTHING
                  TO WERE-STUCK-ON-FUNCTION-FLAG.
 
           MOVE YUP TO THEY-GOT-IT-RIGHT-FLAG.
 
           MOVE FUNCTION-DELETE-FIELD
                TO FUNCTION OF FIELD-HOST-RECORD.
 
       DELETED-FIELD.
           EXIT.
      /
       LIKE-FIELD.
           PERFORM GET-PICTURE-SCREEN.
           APPLY EMPHASIS-ATTRIBUTE TO FIELD-ROW-ARRAY-RECORD.
 
       KEEP-LIKE-AT-SCREENING.
           IF WERE-STUCK-ON-NOTHING
           THEN
             PRESENT WS-ROW-ARRAY
           ELSE
             PRESENT WS-TEST-ROW-ARRAY.
 
           WRITE FIELD-ROW-ARRAY-RECORD.
 
           READ PICTURE-SCREEN.
           VERIFY WS-TEST-ROW-ARRAY.
 
           MOVE NOPE TO DONE-AT-SCREENING-FLAG.
           MOVE ZERO TO AT-COLUMM.
           PERFORM AT-ROW-AFTER-AT-ROW
                   THROUGH NEXT-AT-ROW
                   VARYING AT-ROW FROM 1 BY 1
                   UNTIL DONE-AT-SCREENING
                         OR AT-ROW > 23.
 
           IF AT-ROW > 23
           THEN
             STOP "The LIKE command requires an ""@"":  try again."
             GO TO KEEP-LIKE-AT-SCREENING.
 
           IF ROW-BY-COLUMM-PATTERN ( AT-ROW, AT-COLUMM ) NOT = "S"
           AND ROW-BY-COLUMM-PATTERN ( AT-ROW, AT-COLUMM ) NOT = "O"
           THEN
             STOP "The LIKE command's ""@"" must be placed on the leftmo
      -           "st character..."
             STOP "...of element (1,1) of a field whose details are know
      -           "n."
             GO TO KEEP-LIKE-AT-SCREENING.
 
      *
      *  This command is a pain.  There are some things we're
      *  not allowed to forget.
      *
           MOVE PICTURE-STRING-LENGTH
                TO OUR-CURRENT-PICTURE-STRING-LEN.
           MOVE PICTURE-STRING-STRING
                TO OUR-CURRENT-PICTURE-STRING.
           MOVE GROUP-SEQUENCE-NUMBER
                TO OUR-CURRENT-GROUP-SEQUENCE-NUM.
           MOVE SEQUENCE-NUMBER
                TO OUR-CURRENT-SEQUENCE-NUMBER.
           MOVE LEVEL-NUMBER OF DETAILS-ON-TOP
                TO OUR-CURRENT-LEVEL-NUMBER.
 
           MOVE AT-ROW TO POSITION-Y OF DETAILS-ON-TOP.
           MOVE AT-COLUMM TO POSITION-X OF DETAILS-ON-TOP.
           PERFORM GET-DETAILS-FROM-HOST
                   THROUGH GOT-DETAILS-FROM-HOST.
      *    STOP "Got details, tubhead.".
 
           MOVE OUR-CURRENT-PICTURE-STRING-LEN
                TO PICTURE-STRING-LENGTH.
           MOVE OUR-CURRENT-PICTURE-STRING
                TO PICTURE-STRING-STRING.
           MOVE OUR-CURRENT-GROUP-SEQUENCE-NUM
                TO GROUP-SEQUENCE-NUMBER.
           MOVE OUR-CURRENT-SEQUENCE-NUMBER
                TO SEQUENCE-NUMBER.
           MOVE OUR-CURRENT-LEVEL-NUMBER
                TO LEVEL-NUMBER OF DETAILS-ON-TOP.
 
           MOVE SEQUENCE-NUMBER TO LIKE-SEQUENCE-NUMBER.
           MOVE ROW TO POSITION-Y OF DETAILS-ON-TOP.
           MOVE START-COLUMM TO POSITION-X OF DETAILS-ON-TOP.
           MOVE FUNCTION-PUT-FIELD-DETAILS
                TO FUNCTION OF FIELD-HOST-RECORD.
 
           PERFORM GET-PICTURE-SCREEN.
           APPLY INITIAL-ATTRIBUTE TO FIELD-ROW-ARRAY-RECORD.
           PERFORM GET-DETAILS-SCREEN.
           MOVE YUP TO THEY-GOT-AT-RIGHT-FLAG.
 
       LIKED-FIELD.
           EXIT.
      /
       MOVE-FIELD.
           PERFORM GET-PICTURE-SCREEN.
           APPLY EMPHASIS-ATTRIBUTE TO FIELD-ROW-ARRAY-RECORD.
 
       KEEP-MOVE-AT-SCREENING.
           IF WERE-STUCK-ON-NOTHING
           THEN
             PRESENT WS-ROW-ARRAY
           ELSE
             PRESENT WS-TEST-ROW-ARRAY.
 
           WRITE FIELD-ROW-ARRAY-RECORD.
 
           READ PICTURE-SCREEN.
           VERIFY WS-TEST-ROW-ARRAY.
 
           MOVE NOPE TO DONE-AT-SCREENING-FLAG.
           MOVE ZERO TO AT-COLUMM.
           PERFORM AT-ROW-AFTER-AT-ROW
                   THROUGH NEXT-AT-ROW
                   VARYING AT-ROW FROM 1 BY 1
                   UNTIL DONE-AT-SCREENING
                         OR AT-ROW > 23.
 
           IF AT-ROW > 23
           THEN
             STOP "The MOVE command requires an ""@"":  try again."
             GO TO KEEP-MOVE-AT-SCREENING.
 
           PERFORM DEBRACKET-THE-FIELD.
 
           MOVE ROW TO OLD-ROW.
           MOVE START-COLUMM TO OLD-START-COLUMM.
           MOVE PICTURE-STRING-LENGTH TO OLD-PICTURE-STRING-LENGTH.
           MOVE AT-ROW TO ROW.
           MOVE AT-COLUMM TO START-COLUMM.
           ADD START-COLUMM, PICTURE-STRING-LENGTH
               GIVING END-COLUMM.
           SUBTRACT 1 FROM END-COLUMM.
 
           MOVE "YN" TO MOVE-REPEAT-WHICH-FLAG.
           IF WERE-STUCK-ON-NOTHING
           THEN
             PERFORM REPEAT-SPACES-INTO-OLD-ITEM
                     THROUGH REPEATED-SPACES-INTO-OLD-ITEM.
           PERFORM REPEAT-STUFF-INTO-NEW-ITEM
                   THROUGH REPEATED-STUFF-INTO-NEW-ITEM.
 
           PERFORM BRACKET-THE-FIELD.
 
           MOVE ROW TO POSITION-Y OF DETAILS-ON-TOP.
           MOVE START-COLUMM TO POSITION-X OF DETAILS-ON-TOP.
 
      *    IF NOT WERE-STUCK-ON-NOTHING
      *    THEN
      *      MOVE OLD-ROW TO ROW
      *      MOVE OLD-START-COLUMM TO START-COLUMM
      *      MOVE OLD-PICTURE-STRING-LENGTH TO PICTURE-STRING-LENGTH
      *      GO TO MOVED-FIELD.
      *
           PERFORM GET-PICTURE-SCREEN.
           APPLY INITIAL-ATTRIBUTE TO FIELD-ROW-ARRAY-RECORD.
           PERFORM GET-DETAILS-SCREEN.
           MOVE YUP TO THEY-GOT-AT-RIGHT-FLAG.
 
       MOVED-FIELD.
           EXIT.
      /
       AT-ROW-AFTER-AT-ROW.
           MOVE 0 TO AT-COLUMM.
 
           INSPECT TEST-ROW-ARRAY ( AT-ROW )
                   TALLYING AT-COLUMM FOR CHARACTERS
                   BEFORE INITIAL "@".
 
      *    STOP AT-COLUMM.
           IF AT-COLUMM < 80
           THEN
             MOVE YUP TO DONE-AT-SCREENING-FLAG
             ADD 1 TO AT-COLUMM
             SUBTRACT 1 FROM AT-ROW.
 
       NEXT-AT-ROW.
           EXIT.
      /
      *SWAP-WITH-OTHER-OVERLAPPER.
      *    IF NOT WE-ALREADY-SAW-THE-OTHER
      *    THEN
      *      MOVE YUP TO WE-ALREADY-SAW-THE-OTHER-FLAG
      *      IF ROW-BY-COLUMM-PATTERN ( ROW, START-COLUMM ) = SPACE
      *      THEN
      *        PERFORM LOOK-AHEAD-TO-OTHER
      *      ELSE
      *        PERFORM LOOK-BACK-TO-OTHER.
      *
      *    MOVE START-COLUMM TO PIC999-WHATEVER.
      *    MOVE OTHER-START-COLUMM TO START-COLUMM.
      *    MOVE PIC999-WHATEVER TO OTHER-START-COLUMM.
      *    MOVE ROW TO PIC999-WHATEVER.
      *    MOVE OTHER-ROW TO ROW.
      *    MOVE PIC999-WHATEVER TO OTHER-ROW.
      *
      *    MOVE START-COLUMM TO POSITION-X OF DETAILS-ON-TOP.
      *    MOVE ROW TO POSITION-Y OF DETAILS-ON-TOP.
      *
      *    PERFORM GET-DETAILS-FROM-HOST.
      *
      *LOOK-AHEAD-TO-OTHER.
      *    MOVE NOPE TO LOOK-AHEAD-ERROR-FLAG.
      *    MOVE COLUMM TO OTHER-START-COLUMM.
      *
      *    PERFORM SO-LOOK-AHEAD-TO-OTHER-ALREADY
      *            UNTIL
      *              ROW-BY-COLUMM-PATTERN ( ROW, OTHER-START-COLUMM )
      *              NOT = SPACE.
      *
      *    IF ROW-BY-COLUMM-PATTERN ( ROW, OTHER-START-COLUMM ) = "s"
      *    OR ROW-BY-COLUMM-PATTERN ( ROW, OTHER-START-COLUMM ) = "o"
      *    THEN
      *      MOVE ROW-BY-COLUMM-MASTER-Y-POS ( ROW, OTHER-START-COLUMM )
      *           TO OTHER-ROW
      *      MOVE ROW-BY-COLUMM-MASTER-X-POS ( ROW, OTHER-START-COLUMM )
      *           TO OTHER-START-COLUMM.
      *
      *SO-LOOK-AHEAD-TO-OTHER-ALREADY.
      *    ADD 1 TO OTHER-START-COLUMM.
      *
      *LOOK-BACK-TO-OTHER.
      *    MOVE NOPE TO LOOK-BACK-ERROR.
      *
      *    MOVE ROW-BY-COLUMM-MASTER-Y-POS ( ROW, COLUMM )
      *         TO OTHER-ROW.
      *    MOVE ROW-BY-COLUMM-MASTER-X-POS ( ROW, COLUMM )
      *         TO OTHER-START-COLUMM.
      /
       REPEAT-SPACES-INTO-OLD-ITEM.
      *  REPEAT-SPACES-INTO-OLD-ITEM repeats spaces defined by:
      *      OLD-ROW
      *      OLD-START-COLUMM
      *      OLD-PICTURE-STRING-LENGTH
      *      OLD-REPEATS-X
      *      OLD-REPEATS-Y
      *      OLD-SEPARATED-X
      *      OLD-SEPARATED-Y
      *  in the appropriate array.
      *
      *  If MOVE-REPEAT-WHICH-FLAG = "YN", repeat spaces into
      *  the normal array only;
      *  if MOVE-REPEAT-WHICH-FLAG = "NY", repeat spaces into
      *  the done array only;
      *  if MOVE-REPEAT-WHICH-FLAG = "YY", repeat spaces into
      *  both the normal and done arrays.
           MOVE FUNCTION-STUCK-ON-NOTHING
                TO WERE-STUCK-ON-FUNCTION-FLAG.
 
           IF MOVE-REPEAT-WHICH-BOTH
           OR MOVE-REPEAT-WHICH-TEST
           THEN
             MOVE WS-ROW-ARRAY TO WS-TEST-ROW-ARRAY.
 
           MOVE PICTURE-STRING-STRING TO OUR-CURRENT-PICTURE-STRING.
           MOVE SPACES TO PICTURE-STRING-STRING.
           MOVE SPACE TO PATTERN-FILL-CHARACTER.
 
           MOVE OLD-ROW TO ORIGINAL-ROW.
           MOVE OLD-START-COLUMM TO ORIGINAL-START-COLUMM.
           MOVE OLD-PICTURE-STRING-LENGTH TO FIELD-LENGTH.
 
           MOVE OLD-REPEATS-X TO X-REPEATS-LIMIT.
           IF X-REPEATS-LIMIT = 0
           THEN
             MOVE 1 TO X-REPEATS-LIMIT.
           MOVE OLD-REPEATS-Y TO Y-REPEATS-LIMIT.
           IF Y-REPEATS-LIMIT = 0
           THEN
             MOVE 1 TO Y-REPEATS-LIMIT.
           MOVE OLD-SEPARATED-X TO X-SEPARATION.
           IF X-SEPARATION = 0
           THEN
             MOVE 1 TO X-SEPARATION.
           MOVE OLD-SEPARATED-Y TO Y-SEPARATION.
           IF Y-SEPARATION = 0
           THEN
             MOVE 1 TO Y-SEPARATION.
 
           PERFORM REPEAT-ONCE THROUGH REPEATED-ONCE
                   VARYING Y-REPEATS FROM 1 BY 1 UNTIL
                           Y-REPEATS > Y-REPEATS-LIMIT
                   AFTER X-REPEATS FROM 1 BY 1 UNTIL
                         X-REPEATS > X-REPEATS-LIMIT.
 
           MOVE OUR-CURRENT-PICTURE-STRING TO PICTURE-STRING-STRING.
 
           IF ( MOVE-REPEAT-WHICH-BOTH
                OR MOVE-REPEAT-WHICH-TEST )
           AND WERE-STUCK-ON-NOTHING
           THEN
             MOVE WS-TEST-ROW-ARRAY TO WS-ROW-ARRAY.
 
       REPEATED-SPACES-INTO-OLD-ITEM.
           EXIT.
 
       REPEAT-STUFF-INTO-NEW-ITEM.
      *  REPEAT-STUFF-INTO-NEW-ITEM repeats spaces defined by:
      *      ROW
      *      START-COLUMM
      *      PICTURE-STRING-LENGTH
      *          and PICTURE-STRING ( 1,...,PICTURE-STRING-LENGTH )
      *      REPEATS-X
      *      REPEATS-Y
      *      SEPARATED-X
      *      SEPARATED-Y
      *  in the appropriate array.
      *
      *  If MOVE-REPEAT-WHICH-FLAG = "YN", repeat spaces into
      *  the normal array only;
      *  if MOVE-REPEAT-WHICH-FLAG = "NY", repeat spaces into
      *  the done array only;
      *  if MOVE-REPEAT-WHICH-FLAG = "YY", repeat spaces into
      *  both the normal and done arrays.
           MOVE FUNCTION-STUCK-ON-NOTHING
                TO WERE-STUCK-ON-FUNCTION-FLAG.
 
           IF MOVE-REPEAT-WHICH-BOTH
           OR MOVE-REPEAT-WHICH-TEST
           THEN
             MOVE WS-ROW-ARRAY TO WS-TEST-ROW-ARRAY.
 
           MOVE "X" TO PATTERN-FILL-CHARACTER.
 
           MOVE ROW TO ORIGINAL-ROW.
           MOVE START-COLUMM TO ORIGINAL-START-COLUMM.
           MOVE PICTURE-STRING-LENGTH TO FIELD-LENGTH.
 
           MOVE REPEATS-X OF DETAILS-ON-TOP TO X-REPEATS-LIMIT.
           IF X-REPEATS-LIMIT = 0
           THEN
             MOVE 1 TO X-REPEATS-LIMIT.
           MOVE REPEATS-Y OF DETAILS-ON-TOP TO Y-REPEATS-LIMIT.
           IF Y-REPEATS-LIMIT = 0
           THEN
             MOVE 1 TO Y-REPEATS-LIMIT.
           MOVE SEPARATED-X OF DETAILS-ON-TOP TO X-SEPARATION.
           IF X-SEPARATION = 0
           THEN
             MOVE 1 TO X-SEPARATION.
           MOVE SEPARATED-Y OF DETAILS-ON-TOP TO Y-SEPARATION.
           IF Y-SEPARATION = 0
           THEN
             MOVE 1 TO Y-SEPARATION.
 
           PERFORM REPEAT-ONCE THROUGH REPEATED-ONCE
                   VARYING Y-REPEATS FROM 1 BY 1 UNTIL
                       Y-REPEATS > Y-REPEATS-LIMIT
                   AFTER X-REPEATS FROM 1 BY 1 UNTIL
                       X-REPEATS > X-REPEATS-LIMIT.
 
           IF ( MOVE-REPEAT-WHICH-BOTH
                OR MOVE-REPEAT-WHICH-TEST )
           AND WERE-STUCK-ON-NOTHING
           THEN
             MOVE WS-TEST-ROW-ARRAY TO WS-ROW-ARRAY.
 
       REPEATED-STUFF-INTO-NEW-ITEM.
           EXIT.
 
       REPEAT-ONCE.
           IF ( MOVE-REPEAT-WHICH-BOTH
                OR MOVE-REPEAT-WHICH-DONE )
           AND PATTERN-FILL-CHARACTER NOT = SPACE
           THEN
             IF X-REPEATS = 1
             AND Y-REPEATS = 1
             THEN
               MOVE "X" TO PATTERN-FILL-CHARACTER
               MOVE "S" TO PATTERN-START-CHARACTER
               MOVE "E" TO PATTERN-END-CHARACTER
               MOVE "O" TO PATTERN-SINGLE-CHARACTER
             ELSE
               MOVE "x" TO PATTERN-FILL-CHARACTER
               MOVE "s" TO PATTERN-START-CHARACTER
               MOVE "e" TO PATTERN-END-CHARACTER
               MOVE "o" TO PATTERN-SINGLE-CHARACTER.
 
           MOVE ZERO TO X-POS-START.
           IF X-REPEATS > 1
           THEN
             ADD X-SEPARATION TO X-POS-START
             ADD FIELD-LENGTH TO X-POS-START
             SUBTRACT 1 FROM X-REPEATS GIVING X-REPEATS-MINUS-1
             MULTIPLY X-REPEATS-MINUS-1 BY X-POS-START.
           ADD ORIGINAL-START-COLUMM TO X-POS-START.
 
           MOVE ZERO TO Y-POS.
           IF Y-REPEATS > 1
           THEN
             ADD Y-SEPARATION TO Y-POS
             SUBTRACT 1 FROM Y-REPEATS GIVING Y-REPEATS-MINUS-1
             MULTIPLY Y-REPEATS-MINUS-1 BY Y-POS.
           ADD ORIGINAL-ROW TO Y-POS.
 
           ADD FIELD-LENGTH, X-POS-START GIVING X-POS-STOP.
           SUBTRACT 1 FROM X-POS-STOP.
 
           IF MOVE-REPEAT-WHICH-BOTH
           THEN
             PERFORM REPEAT-INTO-TEST-ARRAY
                     THROUGH REPEATED-INTO-TEST-ARRAY
             PERFORM REPEAT-INTO-DONE-ARRAY
                     THROUGH REPEATED-INTO-DONE-ARRAY
           ELSE
             IF MOVE-REPEAT-WHICH-TEST
             THEN
               PERFORM REPEAT-INTO-TEST-ARRAY
                       THROUGH REPEATED-INTO-TEST-ARRAY
             ELSE
               PERFORM REPEAT-INTO-DONE-ARRAY
                       THROUGH REPEATED-INTO-DONE-ARRAY.
 
           IF NOT WERE-STUCK-ON-NOTHING
           THEN
             MOVE X-REPEATS-LIMIT TO X-REPEATS
             MOVE Y-REPEATS-LIMIT TO Y-REPEATS.
 
       REPEATED-ONCE.
           EXIT.
 
       REPEAT-INTO-TEST-ARRAY.
           IF X-POS-START > 80
           OR Y-POS > 23
           THEN
             MOVE Y-POS TO START-FLUSH-ROW
             MOVE X-POS-START TO START-FLUSH-COLUMM
             MOVE FUNCTION-STUCK-ON-AN-OZONE
                  TO WERE-STUCK-ON-FUNCTION-FLAG
             MOVE FIELD-OZONE-ERROR TO WHATEVER-ERROR
             PERFORM FLUSH-MOVE-ANDOR-REPEAT-ERROR
             GO TO REPEATED-INTO-TEST-ARRAY
           ELSE
             IF X-POS-STOP > 80
             THEN
               MOVE Y-POS TO START-FLUSH-ROW
               MOVE X-POS-START TO START-FLUSH-COLUMM
               MOVE FUNCTION-STUCK-ON-A-FELL-OFF
                    TO WERE-STUCK-ON-FUNCTION-FLAG
               MOVE FIELD-FELL-OFF-ERROR TO WHATEVER-ERROR
               PERFORM FLUSH-MOVE-ANDOR-REPEAT-ERROR
               GO TO REPEATED-INTO-TEST-ARRAY.
 
           MOVE 1 TO PICTURE-STRING-INDEX.
           MOVE X-POS-START TO X-POS.
 
       KEEP-REPEATING-TEST.
           IF  TEST-ROW-BY-COLUMM-ARRAY ( Y-POS, X-POS ) NOT = SPACE
           AND PATTERN-FILL-CHARACTER NOT = SPACE
           THEN
             MOVE Y-POS TO START-FLUSH-ROW
             MOVE X-POS-START TO START-FLUSH-COLUMM
             MOVE FUNCTION-STUCK-ON-AN-OVERLAP
                  TO WERE-STUCK-ON-FUNCTION-FLAG
             MOVE FIELD-OVERLAPS-ERROR TO WHATEVER-ERROR
             PERFORM FLUSH-MOVE-ANDOR-REPEAT-ERROR
             GO TO REPEATED-INTO-TEST-ARRAY
           ELSE
             MOVE PICTURE-STRING ( PICTURE-STRING-INDEX )
                  TO TEST-ROW-BY-COLUMM-ARRAY ( Y-POS, X-POS )
             ADD 1 TO PICTURE-STRING-INDEX
             ADD 1 TO X-POS
             IF X-POS NOT > X-POS-STOP
             THEN
               GO TO KEEP-REPEATING-TEST.
 
           IF ADJACENT-FIELDS-ILLEGAL
           AND PATTERN-FILL-CHARACTER NOT = SPACE
           THEN
             PERFORM ADJACENT-CHECK
                     THROUGH ADJACENT-CHECKED.
 
       REPEATED-INTO-TEST-ARRAY.
           EXIT.
 
       ADJACENT-CHECK.
           IF X-POS-START > 1
           THEN
             SUBTRACT 1 FROM X-POS-START GIVING X-POS-START-MINUS-1
             IF TEST-ROW-BY-COLUMM-ARRAY ( Y-POS, X-POS-START-MINUS-1 )
                NOT = SPACE
             THEN
               MOVE Y-POS TO START-FLUSH-ROW
               MOVE X-POS-START TO START-FLUSH-COLUMM
               MOVE FUNCTION-STUCK-ON-AN-ADJACENT
                    TO WERE-STUCK-ON-FUNCTION-FLAG
               MOVE FIELD-ADJACENT-ERROR TO WHATEVER-ERROR
               PERFORM FLUSH-MOVE-ANDOR-REPEAT-ERROR
               GO TO ADJACENT-CHECKED.
 
           IF X-POS-STOP < 80
           THEN
             ADD 1, X-POS-STOP GIVING X-POS-STOP-PLUS-1
             IF TEST-ROW-BY-COLUMM-ARRAY ( Y-POS, X-POS-STOP-PLUS-1 )
                NOT = SPACE
             THEN
               MOVE Y-POS TO START-FLUSH-ROW
               MOVE X-POS-START TO START-FLUSH-COLUMM
               MOVE FUNCTION-STUCK-ON-AN-ADJACENT
                    TO WERE-STUCK-ON-FUNCTION-FLAG
               MOVE FIELD-ADJACENT-ERROR TO WHATEVER-ERROR
               PERFORM FLUSH-MOVE-ANDOR-REPEAT-ERROR
               GO TO ADJACENT-CHECKED.
 
           IF 3270-CHECK
           THEN
             IF X-POS-START = 80
             THEN
               MOVE Y-POS TO START-FLUSH-ROW
               MOVE X-POS-START TO START-FLUSH-COLUMM
               MOVE FUNCTION-STUCK-ON-A-3270
                    TO WERE-STUCK-ON-FUNCTION-FLAG
               MOVE FIELD-3270-ERROR TO WHATEVER-ERROR
               PERFORM FLUSH-MOVE-ANDOR-REPEAT-ERROR.
 
       ADJACENT-CHECKED.
           EXIT.
 
       REPEAT-INTO-DONE-ARRAY.
           MOVE 1 TO PICTURE-STRING-INDEX.
           MOVE X-POS-START TO X-POS.
 
       KEEP-REPEATING-DONE.
           MOVE PICTURE-STRING ( PICTURE-STRING-INDEX )
                TO DONE-ROW-BY-COLUMM-ARRAY ( Y-POS, X-POS ).
           MOVE PATTERN-FILL-CHARACTER TO
                ROW-BY-COLUMM-PATTERN ( Y-POS, X-POS ).
           MOVE START-COLUMM
                TO ROW-BY-COLUMM-MASTER-X-POS ( Y-POS, X-POS ).
           MOVE ROW
                TO ROW-BY-COLUMM-MASTER-Y-POS ( Y-POS, X-POS ).
           IF X-POS < X-POS-STOP
           THEN
             ADD 1 TO PICTURE-STRING-INDEX
             ADD 1 TO X-POS
             GO TO KEEP-REPEATING-DONE.
 
           IF PATTERN-FILL-CHARACTER NOT = SPACE
           THEN
             IF PICTURE-STRING-INDEX = 1
             THEN
               MOVE PATTERN-SINGLE-CHARACTER
                    TO ROW-BY-COLUMM-PATTERN ( Y-POS, X-POS )
             ELSE
               SUBTRACT PICTURE-STRING-INDEX FROM X-POS
               ADD 1 TO X-POS
               MOVE PATTERN-START-CHARACTER
                    TO ROW-BY-COLUMM-PATTERN ( Y-POS, X-POS )
               MOVE PATTERN-END-CHARACTER
                    TO ROW-BY-COLUMM-PATTERN ( Y-POS, X-POS-STOP ).
 
       REPEATED-INTO-DONE-ARRAY.
           EXIT.
      /
       FLUSH-TO-NEXT-SENSIBLE-FIELD.
           MOVE START-FLUSH-COLUMM TO COLUMM.
 
           PERFORM SO-FLUSH-TO-SENSIBLE-ALREADY
                   THROUGH SO-FLUSHED-TO-SENSIBLE-ALREADY.
 
           PERFORM GET-PICTURE-SCREEN.
           PRESENT WS-ROW-ARRAY.
           WRITE FIELD-ROW-ARRAY-RECORD.
           STOP WHATEVER-ERROR.
 
           SUBTRACT 1 FROM COLUMM.
           MOVE ROW TO UNFLUSH-ROW.
           PERFORM UNFLUSH-WITH-DONE-STUFF
                   VARYING UNFLUSH-COLUMM FROM START-FLUSH-COLUMM BY 1
                   UNTIL UNFLUSH-COLUMM > COLUMM.
 
       SO-FLUSH-TO-SENSIBLE-ALREADY.
           MOVE "*" TO ROW-BY-COLUMM-ARRAY ( ROW, COLUMM ).
           ADD 1 TO COLUMM.
 
           IF COLUMM > 80
           OR ROW-BY-COLUMM-PATTERN ( ROW, COLUMM ) = SPACE
           OR ROW-BY-COLUMM-PATTERN ( ROW, COLUMM ) = "S"
           OR ROW-BY-COLUMM-PATTERN ( ROW, COLUMM ) = "O"
           OR ROW-BY-COLUMM-PATTERN ( ROW, COLUMM ) = "s"
           OR ROW-BY-COLUMM-PATTERN ( ROW, COLUMM ) = "o"
           THEN
             GO TO SO-FLUSHED-TO-SENSIBLE-ALREADY.
 
           GO TO SO-FLUSH-TO-SENSIBLE-ALREADY.
 
       SO-FLUSHED-TO-SENSIBLE-ALREADY.
           EXIT.
 
       FLUSH-MOVE-ANDOR-REPEAT-ERROR.
           MOVE START-FLUSH-ROW TO FLUSH-ROW.
           MOVE START-FLUSH-COLUMM TO FLUSH-COLUMM.
           MOVE 1 TO PICTURE-STRING-INDEX.
 
           IF START-FLUSH-COLUMM NOT > 80
           AND START-FLUSH-ROW NOT > 23
           THEN
             PERFORM SO-FLUSH-MOVE-REPEAT-ALREADY
                     UNTIL FLUSH-COLUMM > 80
                     OR PICTURE-STRING ( PICTURE-STRING-INDEX ) = SPACE.
 
           PERFORM GET-PICTURE-SCREEN.
           PRESENT WS-TEST-ROW-ARRAY.
           WRITE FIELD-ROW-ARRAY-RECORD.
           STOP WHATEVER-ERROR.
 
      *    SUBTRACT 1 FROM FLUSH-COLUMM.
      *    MOVE FLUSH-ROW TO UNFLUSH-ROW.
      *    PERFORM UNFLUSH-WITH-UNDONE-STUFF
      *            VARYING UNFLUSH-COLUMM FROM START-FLUSH-COLUMM BY 1
      *            UNTIL UNFLUSH-COLUMM > FLUSH-COLUMM.
      *
           MOVE WS-ROW-ARRAY TO WS-TEST-ROW-ARRAY.
 
           MOVE ORIGINAL-ROW TO FLUSH-ROW.
           MOVE ORIGINAL-START-COLUMM TO FLUSH-COLUMM.
           MOVE 1 TO PICTURE-STRING-INDEX.
 
           IF FLUSH-COLUMM NOT > 80
           AND FLUSH-ROW NOT > 23
           THEN
             PERFORM SO-UNFLUSH-ELEMENT-1-1-ALREADY
                     UNTIL FLUSH-COLUMM > 80
                     OR PICTURE-STRING ( PICTURE-STRING-INDEX ) = SPACE.
 
       SO-FLUSH-MOVE-REPEAT-ALREADY.
           MOVE "*"
                TO TEST-ROW-BY-COLUMM-ARRAY ( FLUSH-ROW, FLUSH-COLUMM ).
           ADD 1 TO FLUSH-COLUMM.
           ADD 1 TO PICTURE-STRING-INDEX.
 
       SO-UNFLUSH-ELEMENT-1-1-ALREADY.
           MOVE PICTURE-STRING ( PICTURE-STRING-INDEX )
                TO TEST-ROW-BY-COLUMM-ARRAY ( FLUSH-ROW, FLUSH-COLUMM ).
           ADD 1 TO FLUSH-COLUMM.
           ADD 1 TO PICTURE-STRING-INDEX.
 
       UNFLUSH-WITH-DONE-STUFF.
           MOVE DONE-ROW-BY-COLUMM-ARRAY ( UNFLUSH-ROW, UNFLUSH-COLUMM )
                TO ROW-BY-COLUMM-ARRAY ( UNFLUSH-ROW, UNFLUSH-COLUMM ).
 
      *UNFLUSH-WITH-UNDONE-STUFF.
      *    MOVE ROW-BY-COLUMM-ARRAY ( UNFLUSH-ROW, UNFLUSH-COLUMM )
      *         TO ROW-BY-COLUMM-ARRAY ( UNFLUSH-ROW, UNFLUSH-COLUMM ).
      /
       GET-FID-AND-FRAME-SCREEN.
           IF NOT FID-AND-FRAME-IS-OPEN
           THEN
             IF PICTURE-IS-OPEN
             THEN
               CLOSE PICTURE-SCREEN
               MOVE NOPE TO PICTURE-IS-OPEN-FLAG
               PERFORM OPEN-FID-AND-FRAME-SCREEN
             ELSE
               IF DETAILS-ON-TOP-IS-OPEN
               THEN
                 CLOSE DETAILS-ON-TOP-SCREEN
                 MOVE NOPE TO DETAILS-ON-TOP-IS-OPEN-FLAG
                 PERFORM OPEN-FID-AND-FRAME-SCREEN
               ELSE
                 IF DETAILS-ON-BOTTOM-IS-OPEN
                 THEN
                   CLOSE DETAILS-ON-BOTTOM-SCREEN
                   MOVE NOPE TO DETAILS-ON-BOTTOM-IS-OPEN-FLAG
                   PERFORM OPEN-FID-AND-FRAME-SCREEN
                 ELSE
                   PERFORM OPEN-FID-AND-FRAME-SCREEN.
 
       OPEN-FID-AND-FRAME-SCREEN.
           OPEN I-O FID-AND-FRAME-SCREEN.
           ACTIVATE FID-AND-FRAME-SCREEN.
           MOVE YUP TO FID-AND-FRAME-IS-OPEN-FLAG.
 
       GET-PICTURE-SCREEN.
           IF NOT PICTURE-IS-OPEN
           THEN
             IF FID-AND-FRAME-IS-OPEN
             THEN
               CLOSE FID-AND-FRAME-SCREEN
               MOVE NOPE TO FID-AND-FRAME-IS-OPEN-FLAG
               PERFORM OPEN-PICTURE-SCREEN
             ELSE
               IF DETAILS-ON-TOP-IS-OPEN
               THEN
                 CLOSE DETAILS-ON-TOP-SCREEN
                 MOVE NOPE TO DETAILS-ON-TOP-IS-OPEN-FLAG
                 PERFORM OPEN-PICTURE-SCREEN
               ELSE
                 IF DETAILS-ON-BOTTOM-IS-OPEN
                 THEN
                   CLOSE DETAILS-ON-BOTTOM-SCREEN
                   MOVE NOPE TO DETAILS-ON-BOTTOM-IS-OPEN-FLAG
                   PERFORM OPEN-PICTURE-SCREEN
                 ELSE
                   PERFORM OPEN-PICTURE-SCREEN.
 
       OPEN-PICTURE-SCREEN.
           OPEN I-O PICTURE-SCREEN.
           ACTIVATE PICTURE-SCREEN.
           MOVE YUP TO PICTURE-IS-OPEN-FLAG.
 
       GET-DETAILS-SCREEN.
           IF ( ROW > 12
                AND NOT DETAILS-ON-TOP-IS-OPEN )
           OR ( NOT ROW > 12
                AND NOT DETAILS-ON-BOTTOM-IS-OPEN )
           THEN
             IF FID-AND-FRAME-IS-OPEN
             THEN
               CLOSE FID-AND-FRAME-SCREEN
               MOVE NOPE TO FID-AND-FRAME-IS-OPEN-FLAG
               PERFORM OPEN-DETAILS-SCREEN
             ELSE
               IF PICTURE-IS-OPEN
               THEN
                 CLOSE PICTURE-SCREEN
                 MOVE NOPE TO PICTURE-IS-OPEN-FLAG
                 PERFORM OPEN-DETAILS-SCREEN
               ELSE
                 IF DETAILS-ON-TOP-IS-OPEN
                 THEN
                   CLOSE DETAILS-ON-TOP-SCREEN
                   MOVE NOPE TO DETAILS-ON-TOP-IS-OPEN-FLAG
                   PERFORM OPEN-DETAILS-SCREEN
                 ELSE
                   IF DETAILS-ON-BOTTOM-IS-OPEN
                   THEN
                     CLOSE DETAILS-ON-BOTTOM-SCREEN
                     MOVE NOPE TO DETAILS-ON-BOTTOM-IS-OPEN-FLAG
                     PERFORM OPEN-DETAILS-SCREEN
                   ELSE
                     PERFORM OPEN-DETAILS-SCREEN.
 
       OPEN-DETAILS-SCREEN.
           IF ROW > 12
           THEN
             OPEN I-O DETAILS-ON-TOP-SCREEN
             ACTIVATE DETAILS-ON-TOP-SCREEN
             MOVE YUP TO DETAILS-ON-TOP-IS-OPEN-FLAG
           ELSE
             OPEN I-O DETAILS-ON-BOTTOM-SCREEN
             ACTIVATE DETAILS-ON-BOTTOM-SCREEN
             MOVE YUP TO DETAILS-ON-BOTTOM-IS-OPEN-FLAG.
      /
       READ-THE-HOST.
           READ THE-HOST.
           MOVE HOST-RECORD TO WHATEVER-HOST-RECORD.
           IF ERROR-CODE IN WHATEVER-HOST-RECORD = ERROR-ABANDON-SHIP
           THEN
             STOP ERROR-TEXT IN WHATEVER-HOST-RECORD
             GO READ-THE-HOST.
 
       READED-THE-HOST.
           EXIT.
