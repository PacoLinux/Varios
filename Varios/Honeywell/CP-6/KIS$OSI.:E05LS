VERSION E05

PL6.E3A0      #001=KIS$OSI_OPEN File=KIS$OSI.:E05TSI                             WED 07/30/97 00:39 Page:1    
        1        1        /*M*    KIS$OSI OSI Session layer connection management                 */
        2        2        /*T***********************************************************/
        3        3        /*T*                                                         */
        4        4        /*T* Copyright (c) Bull HN Information Systems Inc., 1997    */
        5        5        /*T*                                                         */
        6        6        /*T***********************************************************/
        7        7        /*X* DDA */
        8        8        /*D*    NAME:   KIS$OSI
        9        9                DESCRIPTION:
       10       10                    This module contains the code to support communication between
       11       11                    application programs regardless of their location in a CP-6
       12       12                    network, or indeed any network connected to a CP-6 network.
       13       13                    For E00, only host-resident applications can use this facility.
       14       14
       15       15                    Applications are of two types, server and client.  A server
       16       16                    provides application-specific services to one or more clients.
       17       17                    A particular run unit may act as a server, a client, or both.
       18       18
       19       19                    This module assumes that the application run unit includes the
       20       20                    XSS$SESSION object unit and any other higher-level protocol XSS
       21       21                    object unit(s) needed.  The module XSS$COMM within XSS$SESSION
       22       22                    sets up the necessary linkages to this monitor code.
       23       23
       24       24                    When an application acts as a server, there is a comgroup
       25       25                    established to hold messages in transit between the server and
       26       26                    its clients.  This 'server comgroup' typically has two stations.
       27       27                    The XSS library code manages a DCB station which is also the
       28       28                    comgroup's AU, while this KIS code manages a terminal station
       29       29                    used by the monitor.
       30       30
       31       31                    As part of its initialization, the XSS code creates the server
       32       32                    comgroup, opens the AU DCB, and issues an M$ATTACH monitor call
       33       33                    to create the monitor terminal station.  As part of the cleanup
       34       34                    when the server application is about to exit, an M$DETACH is
       35       35                    issued to disconnect the monitor terminal station and discard
       36       36                    the monitor context for that server.  Then the AU DCB is closed
       37       37                    and the server comgroup deleted.
PL6.E3A0      #001=KIS$OSI_OPEN File=KIS$OSI.:E05TSI                             WED 07/30/97 00:39 Page:2    
       38       38
       39       39                    When an application acts as a client, the path between the client
       40       40                    and this code is provided by a DCB opened with RES=NC (Network
       41       41                    Connection).  A client may have as many NC DCBS as desired, each
       42       42                    one providing a path to the monitor communication layers for the
       43       43                    support of one ISO Session connection.
       44       44
       45       45                    The usual services are provided for the NC DCB: OPEN, CLOSE,
       46       46                    READ, and WRITE.  All READs and WRITEs must be transparent.
       47       47                    ISO Session connections are set up by READs and WRITEs involving
       48       48                    messages of the ISO Session protocol.  OPEN and CLOSE just set up
       49       49                    or tear down a path between the part of the Session layer linked
       50       50                    with the client application and this part in the monitor.
       51       51
       52       52                    Although it might be possible to set up a private messaging
       53       53                    system using this code and bypassing the XS? protocol layers,
       54       54                    this should not be encouraged.  The security issues resulting
       55       55                    from such a scheme have not yet been considered.  Caveat emptor.
       56       56        */
       57       57        /*F*    NAME:   KIS$OSI_OPEN
       58       58                PURPOSE:  Handle M$OPEN of RES=NC DCB.
       59       59        */
       60       60        /*D*    NAME:   KIS$OSI_OPEN
       61       61                CALL:   CALL KIS$OSI_OPEN ALTRET( label);
       62       62                INPUT:
       63       63                    B$JIT.DCB$ - an unopened DCB specifying RES=NC.
       64       64                    This code assumed reachable only by RES=NC.  Only FCD and
       65       65                    LDCTX are checked; everything else in the DCB is irrelevant.
       66       66                OUTPUT:
       67       67                    On successful call,
       68       68                      A major client slot is allocated and initialized,
       69       69                      An LDCT is allocated and initialized,
       70       70                      B$JIT.DCB$->F$DCB.FCD marked open,
       71       71                      B$JIT.DCB$->F$DCB.DVFC set to the major SCID of the client,
       72       72                      B$JIT.DCB$->F$DCB.LDCTX set to LDCTX of new NK_OSIDCB LDCT.
       73       73                    On unsuccessful call,
       74       74                      B$JIT.ERR is filled in with an appropriate error,
PL6.E3A0      #001=KIS$OSI_OPEN File=KIS$OSI.:E05TSI                             WED 07/30/97 00:39 Page:3    
       75       75                      ALTRETURN is taken.
       76       76
       77       77                DESCRIPTION:
       78       78                    KIS$OSI_OPEN is the routine called when an OSI client
       79       79                    application wishes to set up a path to the communication layers.
       80       80                    It is entered from FSN$OPNDEV when a DCB is M$OPEN'd with RES=NC.
       81       81
       82       82                    OPEN RES=NC just establishes a path from the client to the CP-6
       83       83                    monitor.  No OSI Session-specific information is passed at this
       84       84                    time.  A subsequent M$WRITE through the DCB by the client is
       85       85                    what causes a CONNECT SPDU to be sent through the network.
       86       86
       87       87                    On successful return, F$DCB.DVFC contains the major SCID for
       88       88                    this OSI Session application.  The major SCID plus the minor
       89       89                    SCID supplied later on (as part of the buffer on an M$WRITE)
       90       90                    are mapped to the Transport connection id to send the message.
       91       91                    Likewise, an incoming message is forwarded to the correct
       92       92                    application by mapping the Transport connection id to the
       93       93                    major+minor SCID.
       94       94        */
       95       95        KIS$OSI_OPEN: PROC ALTRET;
       96       96        %INCLUDE B$JIT_C;
       97      410            %B$JIT0;
       98      499            %U$JIT1X;
       99      502            %M$JIT2X;
      100      505            %F$JIT3;
      101      510            %S$JIT4X;
      102      513            %J$JIT5;
      103      601            %A$JIT6X;
      104      604        %INCLUDE CP_6_SUBS;
      105     1144        %INCLUDE HF_LOCK_C;
      106     1158        %INCLUDE KI_ERRORS_C;
      107     1243        %INCLUDE K_ADDRESS_M;
      108     1746        %INCLUDE K_SESSION_M;
      109     1836            %KIS$APPL( NAME=APPL, STCLASS=BASED);
      110     1905        %INCLUDE NK_LDCT_R;
      111     1914        %INCLUDE NK_SUBS;
PL6.E3A0      #001=KIS$OSI_OPEN File=KIS$OSI.:E05TSI                             WED 07/30/97 00:39 Page:4    
      112     1939        %INCLUDE NK$LDCT;
      113     2041            %NK$LDCT( STCLASS="BASED( LDCT$)");
      114     2087        %INCLUDE UM_CP6;
      115     2939        %MACRO ERRCODE( NAME=ERRDUMMY, CODE=0);
      116     2940            %VLP_ERRCODE( FPTN=NAME, STCLASS=CONSTANT, FCG='KI', MID='S',
      117     2941                          MON='1'B, ERR#=CODE, SEV=7);
      118     2942        %MEND;
      119     2943            %ERRCODE( NAME=ERRMAJORTBL, CODE=%E$MAJORTBL);
      120     2991            %ERRCODE( NAME=ERRNCOPEN, CODE=%E$NCOPEN);
      121     3039            %ERRCODE( NAME=ERROSINOLDCT, CODE=%E$OSINOLDCT);
      122     3087        %MACRO F$DCBI( BASED=BASED);
      123     3088        %INCLUDE F$DCB;
      124     3137        %MEND;
      125     3138            %F$DCBI( BASED="BASED( JDCB$)");
      126     3188
      127     3189    1       DCL NKL$GETDCT ENTRY(1) ALTRET;
      128     3190
      129     3191    1       DCL B$JIT$ PTR SYMREF;
      130     3192
      131     3193    1       DCL KIS_MAJOR$ PTR STATIC SYMDEF;  /* initialized by TIGR */
      132     3194    1       DCL KIS_MINOR$ PTR STATIC SYMDEF;  /* initialized by TIGR */
      133     3195    1       DCL KIS_OSILOCK BIT(72) STATIC SYMDEF INIT( '1'B);
      134     3196
      135     3197    1       DCL JDCB$ PTR;
      136     3198    1       DCL LDCT$ PTR;
      137     3199    1       DCL MAJOR$ PTR;
      138     3200    1       DCL SCID SBIN;
      139     3201
      140     3202    1       JDCB$ = B$JIT.DCB$;
      141     3203    2       IF F$DCB.LDCTX ~= 0 OR F$DCB.FCD ~= %NO# THEN DO;
      142     3204                /* looks like the DCB is already open */
      143     3205    2           B$JIT.ERR = ERRNCOPEN;
      144     3206                /*E*  ERROR:  KIS-E$NCOPEN-A
      145     3207                    MESSAGE:  That NC DCB is already open.
      146     3208                */
      147     3209    2           ALTRETURN;
      148     3210    2           END;
PL6.E3A0      #001=KIS$OSI_OPEN File=KIS$OSI.:E05TSI                             WED 07/30/97 00:39 Page:5    
      149     3211            /* look for an unused major client slot */
      150     3212            %LOCK( G=KIS_OSILOCK);
      151     3215    2       IF KIS_MAJOR$->APPL.CLNTHD ~= 0 THEN DO;
      152     3216    2           SCID = KIS_MAJOR$->APPL.CLNTHD;
      153     3217    2           MAJOR$ = PINCRW( KIS_MAJOR$, SCID);
      154     3218    2           KIS_MAJOR$->APPL.CLNTHD = MAJOR$->APPL.Z.LINK;
      155     3219    2           END;
      156     3220    2       ELSE DO;
      157     3221                /* all major client slots are in use */
      158     3222                %UNLOCK( G=KIS_OSILOCK);
      159     3225    2           B$JIT.ERR = ERRMAJORTBL;
      160     3226                /*E*  ERROR:  KIS-E$MAJORTBL-A
      161     3227                    MESSAGE:  No more space in the 'major' Session connection table.
      162     3228                */
      163     3229    2           ALTRETURN;
      164     3230    2           END;
      165     3231    1       CALL NKL$GETDCT( LDCT$)
      166     3232    2       WHENALTRETURN DO;
      167     3233                /* unable to get a new LDCT for the NC DCB */
      168     3234                /* free the major client slot */
      169     3235    2           MAJOR$->APPL.Z.LINK = KIS_MAJOR$->APPL.CLNTHD;
      170     3236    2           KIS_MAJOR$->APPL.CLNTHD = SCID;
      171     3237                %UNLOCK( G=KIS_OSILOCK);
      172     3240    2           B$JIT.ERR = ERROSINOLDCT;
      173     3241                /*E*  ERROR:  KIS-E$OSINOLDCT-A
      174     3242                    MESSAGE:  No more system LDCTs are available.
      175     3243                */
      176     3244    2           ALTRETURN;
      177     3245    2           END;
      178     3246            /* initialize interesting fields of the LDCT */
      179     3247    1       NK$LDCT.DEVNM = 'CLIENT  ';
      180     3248    1       NK$LDCT.RESCOD = %NK_OSIDCB;
      181     3249    1       NK$LDCT.USER = B$JIT.USER;
      182     3250    1       NK$LDCT.JLNKCNT = B$JIT.LNKCNT;
      183     3251    1       NK$LDCT.DCBNO = B$JIT.DCBNO;
      184     3252    1       NK$LDCT.TH.STR = SCID;
      185     3253    1       NK$LDCT.LKFLG.ACTIVE = '1'B;
PL6.E3A0      #001=KIS$OSI_OPEN File=KIS$OSI.:E05TSI                             WED 07/30/97 00:39 Page:6    
      186     3254    1       NK$LDCT.DFLG.INPUT = '1'B;
      187     3255    1       NK$LDCT.DFLG.OUTPUT = '1'B;
      188     3256    1       NK$LDCT.LKFLG.OBLK = '0'B;
      189     3257    1       NK$LDCT.LKFLG.WTMRK = '0'B;
      190     3258            /* ..and initialize the major client slot */
      191     3259    1       MAJOR$->APPL.LDCTX = NK$LDCT.LDCTX;
      192     3260    1       MAJOR$->APPL.Z.LINK = 0;
      193     3261    1       MAJOR$->APPL.Z.USER = B$JIT.USER;
      194     3262            %UNLOCK( G=KIS_OSILOCK);
      195     3265            /* fill in the DCB and mark it open */
      196     3266    1       F$DCB.LDCTX = NK$LDCT.LDCTX;
      197     3267    1       F$DCB.FCD = %YES#;
      198     3268            /* stash away the major SCID for later M$READ/M$WRITE */
      199     3269    1       F$DCB.DVFC = BINASC( SCID);
      200     3270    1       RETURN;
      201     3271
      202     3272    1       END KIS$OSI_OPEN;
      203     3273        %EOD;

PL6.E3A0      #001=KIS$OSI_OPEN File=KIS$OSI.:E05TSI                             WED 07/30/97 00:39 Page:7    
--  Include file information  --

   F$DCB.:E05TOU  is referenced.
   UM_CP6.:E05TOU  is referenced.
   NK$LDCT.:E05TOU  is referenced.
   NK_SUBS.:E05TOU  is referenced.
   NK_LDCT_R.:E05TOU  cannot be made into a system file and is referenced.
   K_SESSION_M.:E05TOU  is referenced.
   K_ADDRESS_M.:E05TOU  is referenced.
   KI_ERRORS_C.:E05TOU  is referenced.
   HF_LOCK_C.:E05TOU  cannot be made into a system file and is referenced.
   CP_6_SUBS.:E05TOU  is referenced.
   B$JIT_C.:E05TOU  is referenced.
      No diagnostics issued in procedure KIS$OSI_OPEN.

   Procedure KIS$OSI_OPEN requires 116 words for executable code.
   Procedure KIS$OSI_OPEN requires 10 words of local(AUTO) storage.

PL6.E3A0      #001=KIS$OSI_OPEN File=KIS$OSI.:E05TSI                             WED 07/30/97 00:39 Page:8    

 Object Unit name= KIS$OSI_OPEN                               File name= KIS$OSI.:E05TOU
 UTS= JUL 30 '97 00:39:56.48 WED                              Compiler= PL-6/E31         Sev=      00
 SharedLib= :SHARED_SYSTEM                                    Alt SharedLib=


    ****  Control sections  ****

 Sect   Type Bound  Init  Size OctSiz  Section name(segment info)
    0  RoData even  UTS      5      5  KIS$OSI_OPEN
    1   Data  even  none     4      4  KIS$OSI_OPEN
    2   Proc  even  none   116    164  KIS$OSI_OPEN
    3  RoData even  none     5      5  KIS$OSI_OPEN

    ****  Entry defs  ****

                              Check   Calling
                             calling  sequence
  Sect OctLoc Primary Altret sequence   type   Parms  Name
     2      0   yes    yes     yes      Std        0  KIS$OSI_OPEN

  ****  Data defs  ****

 Sect OctLoc  Name                           Sect OctLoc  Name
    1      0  KIS_MAJOR$                         1      1  KIS_MINOR$
    1      2  KIS_OSILOCK
PL6.E3A0      #001=KIS$OSI_OPEN File=KIS$OSI.:E05TSI                             WED 07/30/97 00:39 Page:9    

  ****  Entry refs  ****

         Check        Calling
        calling       sequence
Altret sequence SRef   type   Args  Name
         yes           Std       1 HFC$LOCK
         yes           Std       1 HFC$UNLOCK
 yes     yes           Std       1 NKL$GETDCT
                       nStd      0 X66_AUTO_0
                       nStd      0 X66_AALT
                       Std       0 B_CONSPOOL_D
                       nStd      0 X66_ARET

  ****  Data refs  ****

  Flags:  r = read only, s = secondary
Flgs Name                             Flgs Name                             Flgs Name
     N$DCT$$                               B$JIT$                                B_VECTNIL

  ****  Segment refs  ****

  Flags:  r = read only, s = secondary
Flgs Name                             Flgs Name                             Flgs Name
     ISSID
PL6.E3A0      #001=KIS$OSI_OPEN File=KIS$OSI.:E05TSI                             WED 07/30/97 00:39 Page:10   


        1        1        /*M*    KIS$OSI OSI Session layer connection management                 */
        2        2        /*T***********************************************************/
        3        3        /*T*                                                         */
        4        4        /*T* Copyright (c) Bull HN Information Systems Inc., 1997    */
        5        5        /*T*                                                         */
        6        6        /*T***********************************************************/
        7        7        /*X* DDA */
        8        8        /*D*    NAME:   KIS$OSI
        9        9                DESCRIPTION:
       10       10                    This module contains the code to support communication between
       11       11                    application programs regardless of their location in a CP-6
       12       12                    network, or indeed any network connected to a CP-6 network.
       13       13                    For E00, only host-resident applications can use this facility.
       14       14
       15       15                    Applications are of two types, server and client.  A server
       16       16                    provides application-specific services to one or more clients.
       17       17                    A particular run unit may act as a server, a client, or both.
       18       18
       19       19                    This module assumes that the application run unit includes the
       20       20                    XSS$SESSION object unit and any other higher-level protocol XSS
       21       21                    object unit(s) needed.  The module XSS$COMM within XSS$SESSION
       22       22                    sets up the necessary linkages to this monitor code.
       23       23
       24       24                    When an application acts as a server, there is a comgroup
       25       25                    established to hold messages in transit between the server and
       26       26                    its clients.  This 'server comgroup' typically has two stations.
       27       27                    The XSS library code manages a DCB station which is also the
       28       28                    comgroup's AU, while this KIS code manages a terminal station
       29       29                    used by the monitor.
       30       30
       31       31                    As part of its initialization, the XSS code creates the server
       32       32                    comgroup, opens the AU DCB, and issues an M$ATTACH monitor call
       33       33                    to create the monitor terminal station.  As part of the cleanup
       34       34                    when the server application is about to exit, an M$DETACH is
       35       35                    issued to disconnect the monitor terminal station and discard
       36       36                    the monitor context for that server.  Then the AU DCB is closed
PL6.E3A0      #001=KIS$OSI_OPEN File=KIS$OSI.:E05TSI                             WED 07/30/97 00:39 Page:11   
       37       37                    and the server comgroup deleted.
       38       38
       39       39                    When an application acts as a client, the path between the client
       40       40                    and this code is provided by a DCB opened with RES=NC (Network
       41       41                    Connection).  A client may have as many NC DCBS as desired, each
       42       42                    one providing a path to the monitor communication layers for the
       43       43                    support of one ISO Session connection.
       44       44
       45       45                    The usual services are provided for the NC DCB: OPEN, CLOSE,
       46       46                    READ, and WRITE.  All READs and WRITEs must be transparent.
       47       47                    ISO Session connections are set up by READs and WRITEs involving
       48       48                    messages of the ISO Session protocol.  OPEN and CLOSE just set up
       49       49                    or tear down a path between the part of the Session layer linked
       50       50                    with the client application and this part in the monitor.
       51       51
       52       52                    Although it might be possible to set up a private messaging
       53       53                    system using this code and bypassing the XS? protocol layers,
       54       54                    this should not be encouraged.  The security issues resulting
       55       55                    from such a scheme have not yet been considered.  Caveat emptor.
       56       56        */
       57       57        /*F*    NAME:   KIS$OSI_OPEN
       58       58                PURPOSE:  Handle M$OPEN of RES=NC DCB.
       59       59        */
       60       60        /*D*    NAME:   KIS$OSI_OPEN
       61       61                CALL:   CALL KIS$OSI_OPEN ALTRET( label);
       62       62                INPUT:
       63       63                    B$JIT.DCB$ - an unopened DCB specifying RES=NC.
       64       64                    This code assumed reachable only by RES=NC.  Only FCD and
       65       65                    LDCTX are checked; everything else in the DCB is irrelevant.
       66       66                OUTPUT:
       67       67                    On successful call,
       68       68                      A major client slot is allocated and initialized,
       69       69                      An LDCT is allocated and initialized,
       70       70                      B$JIT.DCB$->F$DCB.FCD marked open,
       71       71                      B$JIT.DCB$->F$DCB.DVFC set to the major SCID of the client,
       72       72                      B$JIT.DCB$->F$DCB.LDCTX set to LDCTX of new NK_OSIDCB LDCT.
       73       73                    On unsuccessful call,
PL6.E3A0      #001=KIS$OSI_OPEN File=KIS$OSI.:E05TSI                             WED 07/30/97 00:39 Page:12   
       74       74                      B$JIT.ERR is filled in with an appropriate error,
       75       75                      ALTRETURN is taken.
       76       76
       77       77                DESCRIPTION:
       78       78                    KIS$OSI_OPEN is the routine called when an OSI client
       79       79                    application wishes to set up a path to the communication layers.
       80       80                    It is entered from FSN$OPNDEV when a DCB is M$OPEN'd with RES=NC.
       81       81
       82       82                    OPEN RES=NC just establishes a path from the client to the CP-6
       83       83                    monitor.  No OSI Session-specific information is passed at this
       84       84                    time.  A subsequent M$WRITE through the DCB by the client is
       85       85                    what causes a CONNECT SPDU to be sent through the network.
       86       86
       87       87                    On successful return, F$DCB.DVFC contains the major SCID for
       88       88                    this OSI Session application.  The major SCID plus the minor
       89       89                    SCID supplied later on (as part of the buffer on an M$WRITE)
       90       90                    are mapped to the Transport connection id to send the message.
       91       91                    Likewise, an incoming message is forwarded to the correct
       92       92                    application by mapping the Transport connection id to the
       93       93                    major+minor SCID.
       94       94        */
       95       95        KIS$OSI_OPEN: PROC ALTRET;

     95  2 000000   000000 700200 xent  KIS$OSI_OPEN TSX0  ! X66_AUTO_0
         2 000001   000012 000000                    ZERO    10,0

       96       96        %INCLUDE B$JIT_C;
       97      410            %B$JIT0;
       98      499            %U$JIT1X;
       99      502            %M$JIT2X;
      100      505            %F$JIT3;
      101      510            %S$JIT4X;
      102      513            %J$JIT5;
      103      601            %A$JIT6X;
      104      604        %INCLUDE CP_6_SUBS;
      105     1144        %INCLUDE HF_LOCK_C;
      106     1158        %INCLUDE KI_ERRORS_C;
PL6.E3A0      #001=KIS$OSI_OPEN File=KIS$OSI.:E05TSI                             WED 07/30/97 00:39 Page:13   
      107     1243        %INCLUDE K_ADDRESS_M;
      108     1746        %INCLUDE K_SESSION_M;
      109     1836            %KIS$APPL( NAME=APPL, STCLASS=BASED);
      110     1905        %INCLUDE NK_LDCT_R;
      111     1914        %INCLUDE NK_SUBS;
      112     1939        %INCLUDE NK$LDCT;
      113     2041            %NK$LDCT( STCLASS="BASED( LDCT$)");
      114     2087        %INCLUDE UM_CP6;
      115     2939        %MACRO ERRCODE( NAME=ERRDUMMY, CODE=0);
      116     2940            %VLP_ERRCODE( FPTN=NAME, STCLASS=CONSTANT, FCG='KI', MID='S',
      117     2941                          MON='1'B, ERR#=CODE, SEV=7);
      118     2942        %MEND;
      119     2943            %ERRCODE( NAME=ERRMAJORTBL, CODE=%E$MAJORTBL);
      120     2991            %ERRCODE( NAME=ERRNCOPEN, CODE=%E$NCOPEN);
      121     3039            %ERRCODE( NAME=ERROSINOLDCT, CODE=%E$OSINOLDCT);
      122     3087        %MACRO F$DCBI( BASED=BASED);
      123     3088        %INCLUDE F$DCB;
      124     3137        %MEND;
      125     3138            %F$DCBI( BASED="BASED( JDCB$)");
      126     3188
      127     3189    1       DCL NKL$GETDCT ENTRY(1) ALTRET;
      128     3190
      129     3191    1       DCL B$JIT$ PTR SYMREF;
      130     3192
      131     3193    1       DCL KIS_MAJOR$ PTR STATIC SYMDEF;  /* initialized by TIGR */
      132     3194    1       DCL KIS_MINOR$ PTR STATIC SYMDEF;  /* initialized by TIGR */
      133     3195    1       DCL KIS_OSILOCK BIT(72) STATIC SYMDEF INIT( '1'B);
      134     3196
      135     3197    1       DCL JDCB$ PTR;
      136     3198    1       DCL LDCT$ PTR;
      137     3199    1       DCL MAJOR$ PTR;
      138     3200    1       DCL SCID SBIN;
      139     3201
      140     3202    1       JDCB$ = B$JIT.DCB$;

   3202  2 000002   000000 470400 xsym               LDP0    B$JIT$
         2 000003   000232 236100                    LDQ     154,,PR0
PL6.E3A0      #001=KIS$OSI_OPEN File=KIS$OSI.:E05TSI                             WED 07/30/97 00:39 Page:14   
         2 000004   200003 756100                    STQ     JDCB$,,AUTO

      141     3203    2       IF F$DCB.LDCTX ~= 0 OR F$DCB.FCD ~= %NO# THEN DO;

   3203  2 000005   200003 471500                    LDP1    JDCB$,,AUTO
         2 000006   100051 220100                    LDX0    41,,PR1
         2 000007   000013 601000 2                  TNZ     s:3205
         2 000010   100031 236100                    LDQ     25,,PR1
         2 000011   020000 316007                    CANQ    8192,DL
         2 000012   000016 600000 2                  TZE     s:3213

      142     3204                /* looks like the DCB is already open */
      143     3205    2           B$JIT.ERR = ERRNCOPEN;

   3205  2 000013   000001 236000 0                  LDQ     ERRNCOPEN
         2 000014   000012 756100                    STQ     10,,PR0

      144     3206                /*E*  ERROR:  KIS-E$NCOPEN-A
      145     3207                    MESSAGE:  That NC DCB is already open.
      146     3208                */
      147     3209    2           ALTRETURN;

   3209  2 000015   000000 702200 xent               TSX2  ! X66_AALT

      148     3210    2           END;
      149     3211            /* look for an unused major client slot */
      150     3212            %LOCK( G=KIS_OSILOCK);

   3213  2 000016   000000 630400 3                  EPPR0   0
         2 000017   000017 631400 xsym               EPPR1   B_VECTNIL+15
         2 000020   000000 701000 xent               TSX1    HFC$LOCK
         2 000021   000000 011000                    NOP     0

      151     3215    2       IF KIS_MAJOR$->APPL.CLNTHD ~= 0 THEN DO;

   3215  2 000022   000000 470400 1                  LDP0    KIS_MAJOR$
         2 000023   000000 720100                    LXL0    0,,PR0
PL6.E3A0      #001=KIS$OSI_OPEN File=KIS$OSI.:E05TSI                             WED 07/30/97 00:39 Page:15   
         2 000024   000040 600000 2                  TZE     s:3223

      152     3216    2           SCID = KIS_MAJOR$->APPL.CLNTHD;

   3216  2 000025   000000 236100                    LDQ     0,,PR0
         2 000026   777777 376007                    ANQ     -1,DL
         2 000027   200006 756100                    STQ     SCID,,AUTO

      153     3217    2           MAJOR$ = PINCRW( KIS_MAJOR$, SCID);

   3217  2 000030   000022 736000                    QLS     18
         2 000031   000000 036000 1                  ADLQ    KIS_MAJOR$
         2 000032   200005 756100                    STQ     MAJOR$,,AUTO

      154     3218    2           KIS_MAJOR$->APPL.CLNTHD = MAJOR$->APPL.Z.LINK;

   3218  2 000033   200005 471500                    LDP1    MAJOR$,,AUTO
         2 000034   100000 721100                    LXL1    0,,PR1
         2 000035   000777 361003                    ANX1    511,DU
         2 000036   000000 441100                    SXL1    0,,PR0

      155     3219    2           END;

   3219  2 000037   000050 710000 2                  TRA     s:3231

      156     3220    2       ELSE DO;

      157     3221                /* all major client slots are in use */
      158     3222                %UNLOCK( G=KIS_OSILOCK);

   3223  2 000040   000000 630400 3                  EPPR0   0
         2 000041   000017 631400 xsym               EPPR1   B_VECTNIL+15
         2 000042   000000 701000 xent               TSX1    HFC$UNLOCK
         2 000043   000000 011000                    NOP     0

      159     3225    2           B$JIT.ERR = ERRMAJORTBL;

PL6.E3A0      #001=KIS$OSI_OPEN File=KIS$OSI.:E05TSI                             WED 07/30/97 00:39 Page:16   
   3225  2 000044   000000 236000 0                  LDQ     ERRMAJORTBL
         2 000045   000000 470400 xsym               LDP0    B$JIT$
         2 000046   000012 756100                    STQ     10,,PR0

      160     3226                /*E*  ERROR:  KIS-E$MAJORTBL-A
      161     3227                    MESSAGE:  No more space in the 'major' Session connection table.
      162     3228                */
      163     3229    2           ALTRETURN;

   3229  2 000047   000000 702200 xent               TSX2  ! X66_AALT

      164     3230    2           END;
      165     3231    1       CALL NKL$GETDCT( LDCT$)

   3231  2 000050   200004 630500                    EPPR0   LDCT$,,AUTO
         2 000051   200010 450500                    STP0    SCID+2,,AUTO
         2 000052   200010 630500                    EPPR0   SCID+2,,AUTO
         2 000053   000017 631400 xsym               EPPR1   B_VECTNIL+15
         2 000054   000000 701000 xent               TSX1    NKL$GETDCT
         2 000055   000057 702000 2                  TSX2    s:3235
         2 000056   000076 710000 2                  TRA     s:3247

      166     3232    2       WHENALTRETURN DO;

      167     3233                /* unable to get a new LDCT for the NC DCB */
      168     3234                /* free the major client slot */
      169     3235    2           MAJOR$->APPL.Z.LINK = KIS_MAJOR$->APPL.CLNTHD;

   3235  2 000057   200005 470500                    LDP0    MAJOR$,,AUTO
         2 000060   000000 471400 1                  LDP1    KIS_MAJOR$
         2 000061   100000 236100                    LDQ     0,,PR1
         2 000062   000000 552104                    STBQ    0,'04'O,PR0

      170     3236    2           KIS_MAJOR$->APPL.CLNTHD = SCID;

   3236  2 000063   200006 720100                    LXL0    SCID,,AUTO
         2 000064   000000 471400 1                  LDP1    KIS_MAJOR$
PL6.E3A0      #001=KIS$OSI_OPEN File=KIS$OSI.:E05TSI                             WED 07/30/97 00:39 Page:17   
         2 000065   100000 440100                    SXL0    0,,PR1

      171     3237                %UNLOCK( G=KIS_OSILOCK);

   3238  2 000066   000000 630400 3                  EPPR0   0
         2 000067   000017 631400 xsym               EPPR1   B_VECTNIL+15
         2 000070   000000 701000 xent               TSX1    HFC$UNLOCK
         2 000071   000000 011000                    NOP     0

      172     3240    2           B$JIT.ERR = ERROSINOLDCT;

   3240  2 000072   000002 236000 0                  LDQ     ERROSINOLDCT
         2 000073   000000 470400 xsym               LDP0    B$JIT$
         2 000074   000012 756100                    STQ     10,,PR0

      173     3241                /*E*  ERROR:  KIS-E$OSINOLDCT-A
      174     3242                    MESSAGE:  No more system LDCTs are available.
      175     3243                */
      176     3244    2           ALTRETURN;

   3244  2 000075   000000 702200 xent               TSX2  ! X66_AALT

      177     3245    2           END;
      178     3246            /* initialize interesting fields of the LDCT */
      179     3247    1       NK$LDCT.DEVNM = 'CLIENT  ';

   3247  2 000076   200004 470500                    LDP0    LDCT$,,AUTO
         2 000077   040100 100400                    MLR     fill='040'O
         2 000100   000003 000010 0                  ADSC9   ERROSINOLDCT+1           cn=0,n=8
         2 000101   000002 000010                    ADSC9   2,,PR0                   cn=0,n=8

      180     3248    1       NK$LDCT.RESCOD = %NK_OSIDCB;

   3248  2 000102   200004 470500                    LDP0    LDCT$,,AUTO
         2 000103   000006 236100                    LDQ     6,,PR0
         2 000104   000001 376000 3                  ANQ     1
         2 000105   000014 276007                    ORQ     12,DL
PL6.E3A0      #001=KIS$OSI_OPEN File=KIS$OSI.:E05TSI                             WED 07/30/97 00:39 Page:18   
         2 000106   000006 756100                    STQ     6,,PR0

      181     3249    1       NK$LDCT.USER = B$JIT.USER;

   3249  2 000107   000000 471400 xsym               LDP1    B$JIT$
         2 000110   100000 236100                    LDQ     0,,PR1
         2 000111   000007 552120                    STBQ    7,'20'O,PR0

      182     3250    1       NK$LDCT.JLNKCNT = B$JIT.LNKCNT;

   3250  2 000112   100314 236100                    LDQ     204,,PR1
         2 000113   000026 552104                    STBQ    22,'04'O,PR0

      183     3251    1       NK$LDCT.DCBNO = B$JIT.DCBNO;

   3251  2 000114   100022 236100                    LDQ     18,,PR1
         2 000115   000014 552104                    STBQ    12,'04'O,PR0

      184     3252    1       NK$LDCT.TH.STR = SCID;

   3252  2 000116   200006 236100                    LDQ     SCID,,AUTO
         2 000117   000022 736000                    QLS     18
         2 000120   000016 552120                    STBQ    14,'20'O,PR0

      185     3253    1       NK$LDCT.LKFLG.ACTIVE = '1'B;

   3253  2 000121   000040 236003                    LDQ     32,DU
         2 000122   000011 256100                    ORSQ    9,,PR0

      186     3254    1       NK$LDCT.DFLG.INPUT = '1'B;

   3254  2 000123   400000 236007                    LDQ     -131072,DL
         2 000124   000006 256100                    ORSQ    6,,PR0

      187     3255    1       NK$LDCT.DFLG.OUTPUT = '1'B;

   3255  2 000125   200000 236007                    LDQ     65536,DL
PL6.E3A0      #001=KIS$OSI_OPEN File=KIS$OSI.:E05TSI                             WED 07/30/97 00:39 Page:19   
         2 000126   000006 256100                    ORSQ    6,,PR0

      188     3256    1       NK$LDCT.LKFLG.OBLK = '0'B;

   3256  2 000127   000002 236000 3                  LDQ     2
         2 000130   000011 356100                    ANSQ    9,,PR0

      189     3257    1       NK$LDCT.LKFLG.WTMRK = '0'B;

   3257  2 000131   000003 236000 3                  LDQ     3
         2 000132   000011 356100                    ANSQ    9,,PR0

      190     3258            /* ..and initialize the major client slot */
      191     3259    1       MAJOR$->APPL.LDCTX = NK$LDCT.LDCTX;

   3259  2 000133   000006 220100                    LDX0    6,,PR0
         2 000134   200005 473500                    LDP3    MAJOR$,,AUTO
         2 000135   300000 740100                    STX0    0,,PR3

      192     3260    1       MAJOR$->APPL.Z.LINK = 0;

   3260  2 000136   000000 236003                    LDQ     0,DU
         2 000137   300000 552104                    STBQ    0,'04'O,PR3

      193     3261    1       MAJOR$->APPL.Z.USER = B$JIT.USER;

   3261  2 000140   000000 470400 xsym               LDP0    B$JIT$
         2 000141   000000 236100                    LDQ     0,,PR0
         2 000142   000011 772000                    QRL     9
         2 000143   300000 552110                    STBQ    0,'10'O,PR3

      194     3262            %UNLOCK( G=KIS_OSILOCK);

   3263  2 000144   000000 630400 3                  EPPR0   0
         2 000145   000017 631400 xsym               EPPR1   B_VECTNIL+15
         2 000146   000000 701000 xent               TSX1    HFC$UNLOCK
         2 000147   000000 011000                    NOP     0
PL6.E3A0      #001=KIS$OSI_OPEN File=KIS$OSI.:E05TSI                             WED 07/30/97 00:39 Page:20   

      195     3265            /* fill in the DCB and mark it open */
      196     3266    1       F$DCB.LDCTX = NK$LDCT.LDCTX;

   3266  2 000150   200004 470500                    LDP0    LDCT$,,AUTO
         2 000151   000006 220100                    LDX0    6,,PR0
         2 000152   200003 471500                    LDP1    JDCB$,,AUTO
         2 000153   100051 740100                    STX0    41,,PR1

      197     3267    1       F$DCB.FCD = %YES#;

   3267  2 000154   020000 236007                    LDQ     8192,DL
         2 000155   100031 256100                    ORSQ    25,,PR1

      198     3268            /* stash away the major SCID for later M$READ/M$WRITE */
      199     3269    1       F$DCB.DVFC = BINASC( SCID);

   3269  2 000156   200006 236100                    LDQ     SCID,,AUTO
         2 000157   000033 736000                    QLS     27
         2 000160   000004 276000 3                  ORQ     4
         2 000161   000022 772000                    QRL     18
         2 000162   100044 552110                    STBQ    36,'10'O,PR1

      200     3270    1       RETURN;

   3270  2 000163   000000 702200 xent               TSX2  ! X66_ARET

ERRMAJORTBL
 Sect OctLoc
   0     000   131123 431337                                                    YS..

ERRNCOPEN
 Sect OctLoc
   0     001   131123 431357                                                    YS..

ERROSINOLDCT
 Sect OctLoc
PL6.E3A0      #001=KIS$OSI_OPEN File=KIS$OSI.:E05TSI                             WED 07/30/97 00:39 Page:21   
   0     002   131123 431377                                                    YS..

(unnamed)
 Sect OctLoc
   0     003   103114 111105   116124 040040                                    CLIENT

KIS_OSILOCK
 Sect OctLoc
   1     002   400000 000000   000000 000000                                    ........

(unnamed)
 Sect OctLoc
   3     000   000002 006000   777777 777760   577777 777777   757777 777777    ................
   3     004   000040 040040                                                    .
      201     3271
      202     3272    1       END KIS$OSI_OPEN;
      203     3273        %EOD;

PL6.E3A0      #001=KIS$OSI_OPEN File=KIS$OSI.:E05TSI                             WED 07/30/97 00:39 Page:22   
--  Include file information  --

   F$DCB.:E05TOU  is referenced.
   UM_CP6.:E05TOU  is referenced.
   NK$LDCT.:E05TOU  is referenced.
   NK_SUBS.:E05TOU  is referenced.
   NK_LDCT_R.:E05TOU  cannot be made into a system file and is referenced.
   K_SESSION_M.:E05TOU  is referenced.
   K_ADDRESS_M.:E05TOU  is referenced.
   KI_ERRORS_C.:E05TOU  is referenced.
   HF_LOCK_C.:E05TOU  cannot be made into a system file and is referenced.
   CP_6_SUBS.:E05TOU  is referenced.
   B$JIT_C.:E05TOU  is referenced.
      No diagnostics issued in procedure KIS$OSI_OPEN.
PL6.E3A0      #001=KIS$OSI_OPEN File=KIS$OSI.:E05TSI                             WED 07/30/97 00:39 Page:23   

 **** Variables and constants ****

  ****  Section 000 RoData KIS$OSI_OPEN

  ****  Scalars and arrays  ****
OctLoc.c.b A Datatyp(siz) R M Lvl/name                 OctLoc.c.b A Datatyp(siz) R M Lvl/name

     0-0-0/w STRC        r     1 ERRMAJORTBL                1-0-0/w STRC        r     1 ERRNCOPEN
     2-0-0/w STRC        r     1 ERROSINOLDCT

  ****  Section 001  Data  KIS$OSI_OPEN

  ****  Scalars and arrays  ****
OctLoc.c.b A Datatyp(siz) R M Lvl/name                 OctLoc.c.b A Datatyp(siz) R M Lvl/name

     0-0-0/w PTR         r     1 KIS_MAJOR$                 2-0-0/b BIT (72)    r     1 KIS_OSILOCK

  ****  Auto variables  ****

  ****  Scalars and arrays  ****
OctLoc.c.b A Datatyp(siz) R M Lvl/name                 OctLoc.c.b A Datatyp(siz) R M Lvl/name

     3-0-0/w PTR         r     1 JDCB$                      4-0-0/w PTR         r     1 LDCT$
     5-0-0/w PTR         r     1 MAJOR$                     6-0-0/w SBIN        r     1 SCID

  ****  SYMREF variables  ****

  ****  Scalars and arrays  ****
OctLoc.c.b A Datatyp(siz) R M Lvl/name                 OctLoc.c.b A Datatyp(siz) R M Lvl/name

     0-0-0/w PTR         r     1 B$JIT$                     0-0-0/w PTR         r     1 N$DCT$$

  ****  BASED and DCB variables  ****

  ****  Scalars and arrays  ****
OctLoc.c.b A Datatyp(siz) R M Lvl/name                 OctLoc.c.b A Datatyp(siz) R M Lvl/name

PL6.E3A0      #001=KIS$OSI_OPEN File=KIS$OSI.:E05TSI                             WED 07/30/97 00:39 Page:24   
     0-0-0/w STRC(360)   r     1 APPL                       0-0-0/d STRC(8856)  r     1 B$JIT
     0-0-0/d ASTR(3528)  r     1 F$DCB                      0-0-0/d STRC(864)   r     1 NK$LDCT


   Procedure KIS$OSI_OPEN requires 116 words for executable code.
   Procedure KIS$OSI_OPEN requires 10 words of local(AUTO) storage.
PL6.E3A0      #001=KIS$OSI_OPEN File=KIS$OSI.:E05TSI                             WED 07/30/97 00:39 Page:25   
          *** CROSS REFERENCE LISTING ***
**     DENOTES     IDENTIFIER DEFINITION
<<                 IDENTIFIER'S VALUE SET
>>                 IDENTIFIER'S VALUE USED
<>                 IDENTIFIER SET AND/OR USED
--                 IDENTIFIER REFERENCED
PL6.E3A0      #001=KIS$OSI_OPEN File=KIS$OSI.:E05TSI                             WED 07/30/97 00:39 Page:26   
          MINI XREF LISTING

APPL.CLNTHD
      1863**DCL      1864--REDEF    3215>>IF       3216>>ASSIGN   3218<<ASSIGN   3235>>ASSIGN   3236<<ASSIGN
APPL.LDCTX
      1861**DCL      3259<<ASSIGN
APPL.TCTX
      1860**DCL      1861--REDEF    1862--REDEF
APPL.Z.COOKIE
      1865**DCL      1866--REDEF
APPL.Z.LINK
      1867**DCL      3218>>ASSIGN   3235<<ASSIGN   3260<<ASSIGN
APPL.Z.USER
      1866**DCL      3261<<ASSIGN
B$JIT.DCB$
       506**DCL      3202>>ASSIGN
B$JIT.DCBNO
       497**DCL      3251>>ASSIGN
B$JIT.ERR
       416**DCL      3205<<ASSIGN   3225<<ASSIGN   3240<<ASSIGN
B$JIT.ERR.MID
       417**DCL       417--REDEF
B$JIT.LNKCNT
       535**DCL      3250>>ASSIGN
B$JIT.USER
       416**DCL      3249>>ASSIGN   3261>>ASSIGN
B$JIT$
      3191**DCL       411--IMP-PTR  3202>>ASSIGN   3205>>ASSIGN   3225>>ASSIGN   3240>>ASSIGN   3249>>ASSIGN
      3250>>ASSIGN   3251>>ASSIGN   3261>>ASSIGN
ERRMAJORTBL
      2957**DCL      3225>>ASSIGN
ERRNCOPEN
      3005**DCL      3205>>ASSIGN
ERROSINOLDCT
PL6.E3A0      #001=KIS$OSI_OPEN File=KIS$OSI.:E05TSI                             WED 07/30/97 00:39 Page:27   
      3053**DCL      3240>>ASSIGN
F$DCB.ACTPOS
      3164**DCL      3164--REDEF
F$DCB.ARS
      3139**DCL      3139--REDEF
F$DCB.ATTR
      3157**DCL      3158--REDEF
F$DCB.BORROW
      3172**DCL      3172--REDEF    3172--REDEF    3172--REDEF
F$DCB.DCBNAME.L
      3186**DCL      3186--IMP-SIZ
F$DCB.DVFC
      3160**DCL      3269<<ASSIGN
F$DCB.EOMCHAR
      3143**DCL      3143--REDEF
F$DCB.FCD
      3152**DCL      3203>>IF       3267<<ASSIGN
F$DCB.FLDID
      3167**DCL      3167--REDEF
F$DCB.FORM$
      3161**DCL      3161--REDEF
F$DCB.FSECT
      3177**DCL      3177--REDEF
F$DCB.FSN
      3154**DCL      3154--REDEF    3154--REDEF    3155--REDEF
F$DCB.HEADER$
      3160**DCL      3160--REDEF
F$DCB.IXTNSIZE
      3158**DCL      3158--REDEF
F$DCB.LASTSTA$
      3148**DCL      3148--REDEF
F$DCB.LDCTX
      3161**DCL      3203>>IF       3266<<ASSIGN
F$DCB.LVL
      3173**DCL      3173--REDEF
F$DCB.NAME.C
PL6.E3A0      #001=KIS$OSI_OPEN File=KIS$OSI.:E05TSI                             WED 07/30/97 00:39 Page:28   
      3148**DCL      3148--REDEF
F$DCB.NOEOF
      3169**DCL      3169--REDEF
F$DCB.NRECS
      3159**DCL      3159--REDEF
F$DCB.NRECX
      3178**DCL      3178--REDEF
F$DCB.OHDR
      3170**DCL      3170--REDEF
F$DCB.ORG
      3153**DCL      3153--REDEF
F$DCB.PRECNO
      3176**DCL      3176--REDEF
F$DCB.RCSZ
      3181**DCL      3181--REDEF
F$DCB.RES
      3149**DCL      3149--REDEF
F$DCB.SETX
      3161**DCL      3161--REDEF
F$DCB.TAB$
      3160**DCL      3161--REDEF
F$DCB.TDA
      3175**DCL      3175--REDEF
F$DCB.WSN
      3150**DCL      3150--REDEF
HFC$LOCK
      1157**DCL-ENT  3213--CALL
HFC$UNLOCK
      1157**DCL-ENT  3223--CALL     3238--CALL     3263--CALL
JDCB$
      3197**DCL      3139--IMP-PTR  3202<<ASSIGN   3203>>IF       3203>>IF       3266>>ASSIGN   3267>>ASSIGN
      3269>>ASSIGN
KIS_MAJOR$
      3193**DCL      3215>>IF       3216>>ASSIGN   3217>>ASSIGN   3218>>ASSIGN   3235>>ASSIGN   3236>>ASSIGN
KIS_OSILOCK
      3195**DCL      3213<>CALL     3223<>CALL     3238<>CALL     3263<>CALL
PL6.E3A0      #001=KIS$OSI_OPEN File=KIS$OSI.:E05TSI                             WED 07/30/97 00:39 Page:29   
LDCT$
      3198**DCL      2054--IMP-PTR  3231<>CALL     3247>>ASSIGN   3248>>ASSIGN   3249>>ASSIGN   3250>>ASSIGN
      3251>>ASSIGN   3252>>ASSIGN   3253>>ASSIGN   3254>>ASSIGN   3255>>ASSIGN   3256>>ASSIGN   3257>>ASSIGN
      3259>>ASSIGN   3266>>ASSIGN
MAJOR$
      3199**DCL      3217<<ASSIGN   3218>>ASSIGN   3235>>ASSIGN   3259>>ASSIGN   3260>>ASSIGN   3261>>ASSIGN
N$DCT$$
      1912**DCL      1912--IMP-PTR
NK$LDCT.DCBNO
      2078**DCL      3251<<ASSIGN
NK$LDCT.DDT$
      2056**DCL      2056--REDEF
NK$LDCT.DEVNM
      2056**DCL      3247<<ASSIGN
NK$LDCT.DFLG.INPUT
      2058**DCL      3254<<ASSIGN
NK$LDCT.DFLG.OUTPUT
      2058**DCL      3255<<ASSIGN
NK$LDCT.IOQ$
      2055**DCL      2056--REDEF
NK$LDCT.JLNKCNT
      2085**DCL      3250<<ASSIGN
NK$LDCT.LDCTX
      2057**DCL      2057--REDEF    3259>>ASSIGN   3266>>ASSIGN
NK$LDCT.LKFLG.ABORTED
      2069**DCL      2070--REDEF
NK$LDCT.LKFLG.ACTIVE
      2073**DCL      3253<<ASSIGN
NK$LDCT.LKFLG.OBLK
      2069**DCL      3256<<ASSIGN
NK$LDCT.LKFLG.WTMRK
      2070**DCL      3257<<ASSIGN
NK$LDCT.RESCOD
      2062**DCL      3248<<ASSIGN
NK$LDCT.RLCID.LDCTX
      2079**DCL      2079--REDEF
PL6.E3A0      #001=KIS$OSI_OPEN File=KIS$OSI.:E05TSI                             WED 07/30/97 00:39 Page:30   
NK$LDCT.STA$
      2075**DCL      2076--REDEF
NK$LDCT.SYMB$
      2054**DCL      2054--REDEF    2054--REDEF    2055--REDEF
NK$LDCT.TH.STR
      2080**DCL      3252<<ASSIGN
NK$LDCT.USER
      2064**DCL      3249<<ASSIGN
NKL$GETDCT
      3189**DCL-ENT  3231--CALL
SCID
      3200**DCL      3216<<ASSIGN   3217>>ASSIGN   3236>>ASSIGN   3252>>ASSIGN   3269>>ASSIGN

PL6.E3A0      #002=KIS$OSI_CLOSE File=KIS$OSI.:E05TSI                            WED 07/30/97 00:40 Page:31   
      204        1        /*T***********************************************************/
      205        2        /*T*                                                         */
      206        3        /*T* Copyright (c) Bull HN Information Systems Inc., 1997    */
      207        4        /*T*                                                         */
      208        5        /*T***********************************************************/
      209        6        /*F*    NAME:   KIS$OSI_CLOSE
      210        7                PURPOSE:  Handle M$CLOSE of RES=NC DCB.
      211        8        */
      212        9        /*D*    NAME:   KIS$OSI_CLOSE
      213       10                CALL:   CALL KIS$OSI_CLOSE ALTRET( label);
      214       11                INPUT:
      215       12                    B$JIT.DCB$ - an opened DCB specifying RES=NC.
      216       13                    This code assumed reachable only by RES=NC.  Only FCD, DVFC and
      217       14                    LDCTX are checked; everything else in the DCB is irrelevant.
      218       15                OUTPUT:
      219       16                    On successful call,
      220       17                      Any associated Transport connections are dropped,
      221       18                      The NK_OSIDCB LDCT is released,
      222       19                      The major client slot is released,
      223       20                      B$JIT.DCB$->F$DCB.FCD marked closed.
      224       21                      B$JIT.DCB$->F$DCB.DVFC set to zero.
      225       22                      B$JIT.DCB$->F$DCB.LDCTX set to zero.
      226       23                    On unsuccessful call,
      227       24                      B$JIT.ERROR is filled in with an appropriate error,
      228       25                      ALTRETURN is taken.
      229       26                      The returned error KIS-E$TRANSPORT indicates trouble releasing
      230       27                      an underlying Transport connection; in this case the LDCT is
      231       28                      not released and other information is left around to help debug
      232       29                      the problem.
      233       30                DESCRIPTION:
      234       31                    KIS$OSI_CLOSE is called when an OSI client application no longer
      235       32                    wishes to keep a server connection open.  It is entered from
      236       33                    FSP$CLSDEV when a RES=NC DCB is M$CLOSE'd.
      237       34
      238       35                    If there is an associated Transport connection still open
      239       36                    KIT$SEND is called to abort it.
      240       37        */
PL6.E3A0      #002=KIS$OSI_CLOSE File=KIS$OSI.:E05TSI                            WED 07/30/97 00:40 Page:32   
      241       38        KIS$OSI_CLOSE: PROC ALTRET;
      242       39        %INCLUDE B$JIT_C;
      243      353            %B$JIT0;
      244      442            %U$JIT1X;
      245      445            %M$JIT2X;
      246      448            %F$JIT3;
      247      453            %S$JIT4X;
      248      456            %J$JIT5;
      249      544            %A$JIT6X;
      250      547        %INCLUDE CP_6_SUBS;
      251     1087        %INCLUDE HF_LOCK_C;
      252     1101        %INCLUDE KI_ERRORS_C;
      253     1186        %INCLUDE K_ADDRESS_M;
      254     1689        %INCLUDE K_DATA_R;
      255     2400            %K$RWPARM( NAME=K$RWPARM, STCLASS=AUTO);
      256     2716        %INCLUDE K_INTERFACE_M;
      257     3125        %INCLUDE K_SESSION_M;
      258     3215            %KIS$APPL( NAME=APPL, STCLASS=BASED);
      259     3284        %INCLUDE K_SUBS_C;
      260     3317        %INCLUDE K_TRANSPORT_E;
      261     3642        %INCLUDE NK_LDCT_R;
      262     3651        %INCLUDE NK_SUBS;
      263     3676        %INCLUDE NK$LDCT;
      264     3778            %NK$LDCT( STCLASS="BASED( LDCT$)");
      265     3824        %INCLUDE UM_CP6;
      266     4676        %MACRO ERRCODE( NAME=ERRDUMMY, CODE=0);
      267     4677            %VLP_ERRCODE( FPTN=NAME, STCLASS=CONSTANT, FCG='KI', MID='S',
      268     4678                          MON='1'B, ERR#=CODE, SEV=7);
      269     4679        %MEND;
      270     4680            %ERRCODE( NAME=ERRBADSCID, CODE=%E$BADSCID);
      271     4728            %ERRCODE( NAME=ERRNCCLOSED, CODE=%E$NCCLOSED);
      272     4776            %ERRCODE( NAME=ERRNOTOSIDCB, CODE=%E$NOTOSIDCB);
      273     4824            %ERRCODE( NAME=ERRTRANSPORT, CODE=%E$TRANSPORT);
      274     4872            %ERRCODE( NAME=ERRWRONGLDCT, CODE=%E$WRONGLDCT);
      275     4920        %MACRO F$DCBI( BASED=BASED);
      276     4921        %INCLUDE F$DCB;
      277     4970        %MEND;
PL6.E3A0      #002=KIS$OSI_CLOSE File=KIS$OSI.:E05TSI                            WED 07/30/97 00:40 Page:33   
      278     4971            %F$DCBI( BASED="BASED( JDCB$)");
      279     5021
      280     5022    1       DCL KIA$COMP ENTRY(2);
      281     5023    1       DCL KIT$SEND ENTRY(1) ALTRET;
      282     5024    1       DCL NKL$RELDCT ENTRY(1) ALTRET;
      283     5025    1       DCL SC_PRTCL_SNAP ENTRY CONV(2,0);
      284     5026
      285     5027    1       DCL B$JIT$ PTR SYMREF;
      286     5028    1       DCL KIS_MAJOR$ PTR SYMREF;
      287     5029    1       DCL KIS_MINOR$ PTR SYMREF;
      288     5030    1       DCL KIS_OSILOCK BIT(72) SYMREF;
      289     5031    1       DCL KIS_SSN_MAXMAJOR UBIN SYMREF;
      290     5032
      291     5033    1       DCL JDCB$ PTR;
      292     5034    1       DCL LDCT$ PTR;
      293     5035    1       DCL LINK SBIN;
      294     5036    1       DCL MAJOR$ PTR;
      295     5037    1       DCL MINOR$ PTR;
      296     5038    1       DCL SCID SBIN;
      297     5039
      298     5040    1       JDCB$ = B$JIT.DCB$;
      299     5041    2       IF F$DCB.LDCTX = 0 OR F$DCB.FCD ~= %YES# THEN DO;
      300     5042                /* looks like the DCB is not open */
      301     5043    2           B$JIT.ERR = ERRNCCLOSED;
      302     5044                /*E*  ERROR:  KIS-E$NCCLOSED-A
      303     5045                    MESSAGE:  That NC DCB is already closed.
      304     5046                */
      305     5047    2           ALTRETURN;
      306     5048    2           END;
      307     5049    1       SCID = ASCBIN( F$DCB.DVFC);
      308     5050    2       IF SCID > KIS_SSN_MAXMAJOR THEN DO;
      309     5051                /* no way can that be a legal major client slot index */
      310     5052    2           B$JIT.ERR = ERRBADSCID;
      311     5053                /*E*  ERROR:  KIS-E$BADSCID-A
      312     5054                    MESSAGE:  Bad Session connection identifier.
      313     5055                */
      314     5056    2   SNAP:
PL6.E3A0      #002=KIS$OSI_CLOSE File=KIS$OSI.:E05TSI                            WED 07/30/97 00:40 Page:34   
      315     5057    2           CALL SC_PRTCL_SNAP;
      316     5058    2           ALTRETURN;
      317     5059    2           END;
      318     5060    1       MAJOR$ = PINCRW( KIS_MAJOR$, SCID);
      319     5061    1       LDCT$ = NK$LDCT$( MAJOR$->APPL.LDCTX);
      320     5062    1       IF LDCT$ ~= NK$LDCT$( F$DCB.LDCTX) OR
      321     5063    1               NK$LDCT.USER ~= B$JIT.USER OR
      322     5064    2               NK$LDCT.TH.STR ~= SCID THEN DO;
      323     5065                /* consistency check failed */
      324     5066    2           B$JIT.ERR = ERRWRONGLDCT;
      325     5067                /*E*  ERROR:  KIS-E$WRONGLDCT-A
      326     5068                    MESSAGE:  Internal error.  That LDCT doesn't belong to you.
      327     5069                */
      328     5070    2           GOTO SNAP;
      329     5071    2           END;
      330     5072    2       IF NK$LDCT.RESCOD ~= %NK_OSIDCB THEN DO;
      331     5073                /* incorrect LDCT.RESCOD for this operation */
      332     5074    2           B$JIT.ERR = ERRNOTOSIDCB;
      333     5075                /*E*  ERROR:  KIS-E$NOTOSIDCB-A
      334     5076                    MESSAGE:  Internal error.  That LDCT has the wrong RESCOD.
      335     5077                */
      336     5078    2           GOTO SNAP;
      337     5079    2           END;
      338     5080            /* if there are NoWait reads pending, cancel them */
      339     5081    1       IF F$DCB.FCN.CNT(0) > 0 THEN
      340     5082    2           DO WHILE( NK$LDCT.LKFLG.NOWAIT);
      341     5083    2               K$RWPARM = K_RWPARM_CON;
      342     5084    2               K$RWPARM.MSG_ERRCODE = ERRNCCLOSED;
      343     5085    2               K$RWPARM.TYC = %TYC_EOF;
      344     5086    2               CALL KIA$COMP( NK$LDCT, K$RWPARM);
      345     5087    2               END;
      346     5088    1       K$RWPARM = K_RWPARM_CON;
      347     5089    1       K$RWPARM.FUNCTION = %K_TDISCONNECT_REQ;
      348     5090    1       K$RWPARM.ERR = %K_REASON_NOTSPEC;
      349     5091    1       B$JIT.ERR = '0'B;
      350     5092            %LOCK( G=KIS_OSILOCK);
      351     5095    1       NK$LDCT.LKFLG.ACTIVE = '0'B;
PL6.E3A0      #002=KIS$OSI_CLOSE File=KIS$OSI.:E05TSI                            WED 07/30/97 00:40 Page:35   
      352     5096    1       LINK = MAJOR$->APPL.Z.LINK;
      353     5097    2       IF LINK ~= 0 THEN DO;
      354     5098    2           MINOR$ = PINCRW( KIS_MINOR$, LINK);
      355     5099    3           IF MINOR$->APPL.TCTX ~= 0 THEN DO;
      356     5100                    /* here's a Transport connection that's still open.  Gulp. */
      357     5101    3               K$RWPARM.TCTX# = MINOR$->APPL.TCTX;
      358     5102                    /* try to disconnect it */
      359     5103    3               CALL KIT$SEND( K$RWPARM)
      360     5104    4               WHENRETURN DO;
      361     5105                        /* Whew, it worked */
      362     5106    4                   MINOR$->APPL.TCTX = 0;
      363     5107    4                   END;
      364     5108    4               WHENALTRETURN DO;
      365     5109                        /* Transport was unable to disconnect this one */
      366     5110    4                   IF K$RWPARM.ERR = %K$USER_ERR THEN
      367     5111    4                       B$JIT.ERR = K$RWPARM.MSG_ERRCODE;
      368     5112    5                   ELSE DO;
      369     5113    5                       B$JIT.ERR = ERRTRANSPORT;
      370     5114                            /*E*  ERROR:  KIS-E$TRANSPORT-A
      371     5115                                MESSAGE:  Internal error.  Transport ALTRETURN.
      372     5116                            */
      373     5117                            /* Don't ALTRETURN here.. try to drop other connections */
      374     5118    5                       CALL SC_PRTCL_SNAP;
      375     5119    5                       END;
      376     5120    4                   END;
      377     5121    3               END;
      378     5122    2           END;
      379     5123    2       IF B$JIT.ERR = '0'B THEN DO;
      380     5124                /* the Transport link dropped, or there wasn't one to drop */
      381     5125    2           CALL NKL$RELDCT( LDCT$);
      382     5126                /* release the minor client slot, if any */
      383     5127    3           IF LINK ~= 0 THEN DO;
      384     5128    3               MINOR$->APPL.Z.LINK = KIS_MINOR$->APPL.Z.LINK;
      385     5129    3               KIS_MINOR$->APPL.Z.LINK = MAJOR$->APPL.Z.LINK;
      386     5130    3               END;
      387     5131                /* release the major client slot */
      388     5132    2           MAJOR$->APPL.LDCTX = 0;
PL6.E3A0      #002=KIS$OSI_CLOSE File=KIS$OSI.:E05TSI                            WED 07/30/97 00:40 Page:36   
      389     5133    2           MAJOR$->APPL.Z.USER = 0;
      390     5134    2           MAJOR$->APPL.Z.LINK = KIS_MAJOR$->APPL.CLNTHD;
      391     5135    2           KIS_MAJOR$->APPL.CLNTHD = SCID;
      392     5136    2           END;
      393     5137            %UNLOCK( G=KIS_OSILOCK);
      394     5140            /* mark DCB closed */
      395     5141    1       F$DCB.FCD = %NO#;
      396     5142            /* scrub other DCB fields we used */
      397     5143    1       F$DCB.LDCTX = 0;
      398     5144    1       F$DCB.DVFC = BINASC( 0);
      399     5145    1       IF B$JIT.ERR THEN
      400     5146                /* lower layer error of some kind */
      401     5147    1           ALTRETURN;
      402     5148    1       RETURN;
      403     5149
      404     5150    1       END KIS$OSI_CLOSE;
      405     5151        %EOD;

PL6.E3A0      #002=KIS$OSI_CLOSE File=KIS$OSI.:E05TSI                            WED 07/30/97 00:40 Page:37   
--  Include file information  --

   F$DCB.:E05TOU  is referenced.
   UM_CP6.:E05TOU  is referenced.
   NK$LDCT.:E05TOU  is referenced.
   NK_SUBS.:E05TOU  is referenced.
   NK_LDCT_R.:E05TOU  cannot be made into a system file and is referenced.
   K_TRANSPORT_E.:E05TOU  is referenced.
   K_SUBS_C.:E05TOU  is referenced.
   K_SESSION_M.:E05TOU  is referenced.
   K_INTERFACE_M.:E05TOU  is referenced.
   K$RWPARM.:E05TOU  is referenced.
   K_DATA_R.:E05TOU  cannot be made into a system file and is referenced.
   K_ADDRESS_M.:E05TOU  is referenced.
   KI_ERRORS_C.:E05TOU  is referenced.
   HF_LOCK_C.:E05TOU  cannot be made into a system file and is referenced.
   CP_6_SUBS.:E05TOU  is referenced.
   B$JIT_C.:E05TOU  is referenced.
      No diagnostics issued in procedure KIS$OSI_CLOSE.

   Procedure KIS$OSI_CLOSE requires 178 words for executable code.
   Procedure KIS$OSI_CLOSE requires 52 words of local(AUTO) storage.

PL6.E3A0      #002=KIS$OSI_CLOSE File=KIS$OSI.:E05TSI                            WED 07/30/97 00:40 Page:38   

 Object Unit name= KIS$OSI_CLOSE                              File name= KIS$OSI.:E05TOU
 UTS= JUL 30 '97 00:40:25.44 WED                              Compiler= PL-6/E31         Sev=      00
 SharedLib= :SHARED_SYSTEM                                    Alt SharedLib=


    ****  Control sections  ****

 Sect   Type Bound  Init  Size OctSiz  Section name(segment info)
    0  RoData even  UTS      6      6  KIS$OSI_CLOSE
    1   Proc  even  none   178    262  KIS$OSI_CLOSE
    2  RoData even  none     3      3  KIS$OSI_CLOSE

    ****  Entry defs  ****

                              Check   Calling
                             calling  sequence
  Sect OctLoc Primary Altret sequence   type   Parms  Name
     1      0   yes    yes     yes      Std        0  KIS$OSI_CLOSE

  ****  Entry refs  ****

         Check        Calling
        calling       sequence
Altret sequence SRef   type   Args  Name
         yes           Std       1 HFC$UNLOCK
         yes           Std       2 KIA$COMP
 yes     yes           Std       1 KIT$SEND
         yes           Std       1 HFC$LOCK
 yes     yes           Std       1 NKL$RELDCT
                       nStd      0 X66_AUTO_0
                       nStd      0 X66_AALT
                       Std       0 B_CONSPOOL_D
                       nStd      0 X66_ARET
PL6.E3A0      #002=KIS$OSI_CLOSE File=KIS$OSI.:E05TSI                            WED 07/30/97 00:40 Page:39   

  ****  Data refs  ****

  Flags:  r = read only, s = secondary
Flgs Name                             Flgs Name                             Flgs Name
     SC_PRTCL_SNAP                    r    K_RWPARM_CON                          N$DCT$$
     B$JIT$                                KIS_MAJOR$                            KIS_MINOR$
     KIS_OSILOCK                           KIS_SSN_MAXMAJOR                      B_VECTNIL

  ****  Segment refs  ****

  Flags:  r = read only, s = secondary
Flgs Name                             Flgs Name                             Flgs Name
     ASLENTSID                             ISSID
PL6.E3A0      #002=KIS$OSI_CLOSE File=KIS$OSI.:E05TSI                            WED 07/30/97 00:40 Page:40   


      204        1        /*T***********************************************************/
      205        2        /*T*                                                         */
      206        3        /*T* Copyright (c) Bull HN Information Systems Inc., 1997    */
      207        4        /*T*                                                         */
      208        5        /*T***********************************************************/
      209        6        /*F*    NAME:   KIS$OSI_CLOSE
      210        7                PURPOSE:  Handle M$CLOSE of RES=NC DCB.
      211        8        */
      212        9        /*D*    NAME:   KIS$OSI_CLOSE
      213       10                CALL:   CALL KIS$OSI_CLOSE ALTRET( label);
      214       11                INPUT:
      215       12                    B$JIT.DCB$ - an opened DCB specifying RES=NC.
      216       13                    This code assumed reachable only by RES=NC.  Only FCD, DVFC and
      217       14                    LDCTX are checked; everything else in the DCB is irrelevant.
      218       15                OUTPUT:
      219       16                    On successful call,
      220       17                      Any associated Transport connections are dropped,
      221       18                      The NK_OSIDCB LDCT is released,
      222       19                      The major client slot is released,
      223       20                      B$JIT.DCB$->F$DCB.FCD marked closed.
      224       21                      B$JIT.DCB$->F$DCB.DVFC set to zero.
      225       22                      B$JIT.DCB$->F$DCB.LDCTX set to zero.
      226       23                    On unsuccessful call,
      227       24                      B$JIT.ERROR is filled in with an appropriate error,
      228       25                      ALTRETURN is taken.
      229       26                      The returned error KIS-E$TRANSPORT indicates trouble releasing
      230       27                      an underlying Transport connection; in this case the LDCT is
      231       28                      not released and other information is left around to help debug
      232       29                      the problem.
      233       30                DESCRIPTION:
      234       31                    KIS$OSI_CLOSE is called when an OSI client application no longer
      235       32                    wishes to keep a server connection open.  It is entered from
      236       33                    FSP$CLSDEV when a RES=NC DCB is M$CLOSE'd.
      237       34
      238       35                    If there is an associated Transport connection still open
      239       36                    KIT$SEND is called to abort it.
PL6.E3A0      #002=KIS$OSI_CLOSE File=KIS$OSI.:E05TSI                            WED 07/30/97 00:40 Page:41   
      240       37        */
      241       38        KIS$OSI_CLOSE: PROC ALTRET;

     38  1 000000   000000 700200 xent  KIS$OSI_CLO* TSX0  ! X66_AUTO_0
         1 000001   000064 000000                    ZERO    52,0

      242       39        %INCLUDE B$JIT_C;
      243      353            %B$JIT0;
      244      442            %U$JIT1X;
      245      445            %M$JIT2X;
      246      448            %F$JIT3;
      247      453            %S$JIT4X;
      248      456            %J$JIT5;
      249      544            %A$JIT6X;
      250      547        %INCLUDE CP_6_SUBS;
      251     1087        %INCLUDE HF_LOCK_C;
      252     1101        %INCLUDE KI_ERRORS_C;
      253     1186        %INCLUDE K_ADDRESS_M;
      254     1689        %INCLUDE K_DATA_R;
      255     2400            %K$RWPARM( NAME=K$RWPARM, STCLASS=AUTO);
      256     2716        %INCLUDE K_INTERFACE_M;
      257     3125        %INCLUDE K_SESSION_M;
      258     3215            %KIS$APPL( NAME=APPL, STCLASS=BASED);
      259     3284        %INCLUDE K_SUBS_C;
      260     3317        %INCLUDE K_TRANSPORT_E;
      261     3642        %INCLUDE NK_LDCT_R;
      262     3651        %INCLUDE NK_SUBS;
      263     3676        %INCLUDE NK$LDCT;
      264     3778            %NK$LDCT( STCLASS="BASED( LDCT$)");
      265     3824        %INCLUDE UM_CP6;
      266     4676        %MACRO ERRCODE( NAME=ERRDUMMY, CODE=0);
      267     4677            %VLP_ERRCODE( FPTN=NAME, STCLASS=CONSTANT, FCG='KI', MID='S',
      268     4678                          MON='1'B, ERR#=CODE, SEV=7);
      269     4679        %MEND;
      270     4680            %ERRCODE( NAME=ERRBADSCID, CODE=%E$BADSCID);
      271     4728            %ERRCODE( NAME=ERRNCCLOSED, CODE=%E$NCCLOSED);
      272     4776            %ERRCODE( NAME=ERRNOTOSIDCB, CODE=%E$NOTOSIDCB);
PL6.E3A0      #002=KIS$OSI_CLOSE File=KIS$OSI.:E05TSI                            WED 07/30/97 00:40 Page:42   
      273     4824            %ERRCODE( NAME=ERRTRANSPORT, CODE=%E$TRANSPORT);
      274     4872            %ERRCODE( NAME=ERRWRONGLDCT, CODE=%E$WRONGLDCT);
      275     4920        %MACRO F$DCBI( BASED=BASED);
      276     4921        %INCLUDE F$DCB;
      277     4970        %MEND;
      278     4971            %F$DCBI( BASED="BASED( JDCB$)");
      279     5021
      280     5022    1       DCL KIA$COMP ENTRY(2);
      281     5023    1       DCL KIT$SEND ENTRY(1) ALTRET;
      282     5024    1       DCL NKL$RELDCT ENTRY(1) ALTRET;
      283     5025    1       DCL SC_PRTCL_SNAP ENTRY CONV(2,0);
      284     5026
      285     5027    1       DCL B$JIT$ PTR SYMREF;
      286     5028    1       DCL KIS_MAJOR$ PTR SYMREF;
      287     5029    1       DCL KIS_MINOR$ PTR SYMREF;
      288     5030    1       DCL KIS_OSILOCK BIT(72) SYMREF;
      289     5031    1       DCL KIS_SSN_MAXMAJOR UBIN SYMREF;
      290     5032
      291     5033    1       DCL JDCB$ PTR;
      292     5034    1       DCL LDCT$ PTR;
      293     5035    1       DCL LINK SBIN;
      294     5036    1       DCL MAJOR$ PTR;
      295     5037    1       DCL MINOR$ PTR;
      296     5038    1       DCL SCID SBIN;
      297     5039
      298     5040    1       JDCB$ = B$JIT.DCB$;

   5040  1 000002   000000 470400 xsym               LDP0    B$JIT$
         1 000003   000232 236100                    LDQ     154,,PR0
         1 000004   200054 756100                    STQ     JDCB$,,AUTO

      299     5041    2       IF F$DCB.LDCTX = 0 OR F$DCB.FCD ~= %YES# THEN DO;

   5041  1 000005   200054 471500                    LDP1    JDCB$,,AUTO
         1 000006   100051 220100                    LDX0    41,,PR1
         1 000007   000013 600000 1                  TZE     s:5043
         1 000010   100031 236100                    LDQ     25,,PR1
PL6.E3A0      #002=KIS$OSI_CLOSE File=KIS$OSI.:E05TSI                            WED 07/30/97 00:40 Page:43   
         1 000011   020000 316007                    CANQ    8192,DL
         1 000012   000016 601000 1                  TNZ     s:5049

      300     5042                /* looks like the DCB is not open */
      301     5043    2           B$JIT.ERR = ERRNCCLOSED;

   5043  1 000013   000001 236000 0                  LDQ     ERRNCCLOSED
         1 000014   000012 756100                    STQ     10,,PR0

      302     5044                /*E*  ERROR:  KIS-E$NCCLOSED-A
      303     5045                    MESSAGE:  That NC DCB is already closed.
      304     5046                */
      305     5047    2           ALTRETURN;

   5047  1 000015   000000 702200 xent               TSX2  ! X66_AALT

      306     5048    2           END;
      307     5049    1       SCID = ASCBIN( F$DCB.DVFC);

   5049  1 000016   100044 236100                    LDQ     36,,PR1
         1 000017   000011 772000                    QRL     9
         1 000020   000777 376007                    ANQ     511,DL
         1 000021   200061 756100                    STQ     SCID,,AUTO

      308     5050    2       IF SCID > KIS_SSN_MAXMAJOR THEN DO;

   5050  1 000022   000033 604000 1                  TMI     s:5060
         1 000023   000000 116000 xsym               CMPQ    KIS_SSN_MAXMAJOR
         1 000024   000033 602000 1                  TNC     s:5060
         1 000025   000033 600000 1                  TZE     s:5060

      309     5051                /* no way can that be a legal major client slot index */
      310     5052    2           B$JIT.ERR = ERRBADSCID;

   5052  1 000026   000000 236000 0                  LDQ     ERRBADSCID
         1 000027   000012 756100                    STQ     10,,PR0

PL6.E3A0      #002=KIS$OSI_CLOSE File=KIS$OSI.:E05TSI                            WED 07/30/97 00:40 Page:44   
      311     5053                /*E*  ERROR:  KIS-E$BADSCID-A
      312     5054                    MESSAGE:  Bad Session connection identifier.
      313     5055                */
      314     5056    2   SNAP:
      315     5057    2           CALL SC_PRTCL_SNAP;

   5057  1 000030   000000 713400 xsym  SNAP         CLIMB   SC_PRTCL_SNAP
         1 000031   000000 600000 xsid               climb   nvectors=         0

      316     5058    2           ALTRETURN;

   5058  1 000032   000000 702200 xent               TSX2  ! X66_AALT

      317     5059    2           END;
      318     5060    1       MAJOR$ = PINCRW( KIS_MAJOR$, SCID);

   5060  1 000033   000022 736000                    QLS     18
         1 000034   000000 036000 xsym               ADLQ    KIS_MAJOR$
         1 000035   200057 756100                    STQ     MAJOR$,,AUTO

      319     5061    1       LDCT$ = NK$LDCT$( MAJOR$->APPL.LDCTX);

   5061  1 000036   200057 473500                    LDP3    MAJOR$,,AUTO
         1 000037   300000 221100                    LDX1    0,,PR3
         1 000040   000000 474400 xsym               LDP4    N$DCT$$
         1 000041   400000 236111                    LDQ     0,X1,PR4
         1 000042   200055 756100                    STQ     LDCT$,,AUTO

      320     5062    1       IF LDCT$ ~= NK$LDCT$( F$DCB.LDCTX) OR

   5062  1 000043   100051 220100                    LDX0    41,,PR1
         1 000044   400000 116110                    CMPQ    0,X0,PR4
         1 000045   000060 601000 1                  TNZ     s:5066
         1 000046   200055 475500                    LDP5    LDCT$,,AUTO
         1 000047   500007 236100                    LDQ     7,,PR5
         1 000050   000000 676100                    ERQ     0,,PR0
         1 000051   000777 376003                    ANQ     511,DU
PL6.E3A0      #002=KIS$OSI_CLOSE File=KIS$OSI.:E05TSI                            WED 07/30/97 00:40 Page:45   
         1 000052   000060 601000 1                  TNZ     s:5066
         1 000053   500016 236100                    LDQ     14,,PR5
         1 000054   000022 772000                    QRL     18
         1 000055   000777 376007                    ANQ     511,DL
         1 000056   200061 116100                    CMPQ    SCID,,AUTO
         1 000057   000063 600000 1                  TZE     s:5072

      321     5063    1               NK$LDCT.USER ~= B$JIT.USER OR
      322     5064    2               NK$LDCT.TH.STR ~= SCID THEN DO;

      323     5065                /* consistency check failed */
      324     5066    2           B$JIT.ERR = ERRWRONGLDCT;

   5066  1 000060   000004 236000 0                  LDQ     ERRWRONGLDCT
         1 000061   000012 756100                    STQ     10,,PR0

      325     5067                /*E*  ERROR:  KIS-E$WRONGLDCT-A
      326     5068                    MESSAGE:  Internal error.  That LDCT doesn't belong to you.
      327     5069                */
      328     5070    2           GOTO SNAP;

   5070  1 000062   000030 710000 1                  TRA     SNAP

      329     5071    2           END;
      330     5072    2       IF NK$LDCT.RESCOD ~= %NK_OSIDCB THEN DO;

   5072  1 000063   500006 236100                    LDQ     6,,PR5
         1 000064   000017 376007                    ANQ     15,DL
         1 000065   000014 116007                    CMPQ    12,DL
         1 000066   000072 600000 1                  TZE     s:5081

      331     5073                /* incorrect LDCT.RESCOD for this operation */
      332     5074    2           B$JIT.ERR = ERRNOTOSIDCB;

   5074  1 000067   000002 236000 0                  LDQ     ERRNOTOSIDCB
         1 000070   000012 756100                    STQ     10,,PR0

PL6.E3A0      #002=KIS$OSI_CLOSE File=KIS$OSI.:E05TSI                            WED 07/30/97 00:40 Page:46   
      333     5075                /*E*  ERROR:  KIS-E$NOTOSIDCB-A
      334     5076                    MESSAGE:  Internal error.  That LDCT has the wrong RESCOD.
      335     5077                */
      336     5078    2           GOTO SNAP;

   5078  1 000071   000030 710000 1                  TRA     SNAP

      337     5079    2           END;
      338     5080            /* if there are NoWait reads pending, cancel them */
      339     5081    1       IF F$DCB.FCN.CNT(0) > 0 THEN

   5081  1 000072   100074 236100                    LDQ     60,,PR1
         1 000073   377000 316003                    CANQ    130560,DU
         1 000074   000123 600000 1                  TZE     s:5088

      340     5082    2           DO WHILE( NK$LDCT.LKFLG.NOWAIT);

   5082  1 000075   500011 236100                    LDQ     9,,PR5
         1 000076   000001 316003                    CANQ    1,DU
         1 000077   000123 600000 1                  TZE     s:5088

      341     5083    2               K$RWPARM = K_RWPARM_CON;

   5083  1 000100   000100 100400                    MLR     fill='000'O
         1 000101   000000 000234 xsym               ADSC9   K_RWPARM_CON             cn=0,n=156
         1 000102   200004 000234                    ADSC9   K$RWPARM,,AUTO           cn=0,n=156

      342     5084    2               K$RWPARM.MSG_ERRCODE = ERRNCCLOSED;

   5084  1 000103   000001 236000 0                  LDQ     ERRNCCLOSED
         1 000104   200043 756100                    STQ     K$RWPARM+31,,AUTO

      343     5085    2               K$RWPARM.TYC = %TYC_EOF;

   5085  1 000105   000005 236000 0                  LDQ     ERRWRONGLDCT+1
         1 000106   200012 756100                    STQ     K$RWPARM+6,,AUTO

PL6.E3A0      #002=KIS$OSI_CLOSE File=KIS$OSI.:E05TSI                            WED 07/30/97 00:40 Page:47   
      344     5086    2               CALL KIA$COMP( NK$LDCT, K$RWPARM);

   5086  1 000107   200004 630500                    EPPR0   K$RWPARM,,AUTO
         1 000110   200063 450500                    STP0    SCID+2,,AUTO
         1 000111   200055 236100                    LDQ     LDCT$,,AUTO
         1 000112   200062 756100                    STQ     SCID+1,,AUTO
         1 000113   200062 630500                    EPPR0   SCID+1,,AUTO
         1 000114   000020 631400 xsym               EPPR1   B_VECTNIL+16
         1 000115   000000 701000 xent               TSX1    KIA$COMP
         1 000116   000000 011000                    NOP     0

      345     5087    2               END;

   5087  1 000117   200055 470500                    LDP0    LDCT$,,AUTO
         1 000120   000011 236100                    LDQ     9,,PR0
         1 000121   000001 316003                    CANQ    1,DU
         1 000122   000100 601000 1                  TNZ     s:5083

      346     5088    1       K$RWPARM = K_RWPARM_CON;

   5088  1 000123   000100 100400                    MLR     fill='000'O
         1 000124   000000 000234 xsym               ADSC9   K_RWPARM_CON             cn=0,n=156
         1 000125   200004 000234                    ADSC9   K$RWPARM,,AUTO           cn=0,n=156

      347     5089    1       K$RWPARM.FUNCTION = %K_TDISCONNECT_REQ;

   5089  1 000126   000031 235007                    LDA     25,DL
         1 000127   200024 755100                    STA     K$RWPARM+16,,AUTO

      348     5090    1       K$RWPARM.ERR = %K_REASON_NOTSPEC;

   5090  1 000130   200017 450100                    STZ     K$RWPARM+11,,AUTO

      349     5091    1       B$JIT.ERR = '0'B;

   5091  1 000131   000000 470400 xsym               LDP0    B$JIT$
         1 000132   000012 450100                    STZ     10,,PR0
PL6.E3A0      #002=KIS$OSI_CLOSE File=KIS$OSI.:E05TSI                            WED 07/30/97 00:40 Page:48   

      350     5092            %LOCK( G=KIS_OSILOCK);

   5093  1 000133   000000 630400 2                  EPPR0   0
         1 000134   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 000135   000000 701000 xent               TSX1    HFC$LOCK
         1 000136   000000 011000                    NOP     0

      351     5095    1       NK$LDCT.LKFLG.ACTIVE = '0'B;

   5095  1 000137   200055 470500                    LDP0    LDCT$,,AUTO
         1 000140   000001 236000 2                  LDQ     1
         1 000141   000011 356100                    ANSQ    9,,PR0

      352     5096    1       LINK = MAJOR$->APPL.Z.LINK;

   5096  1 000142   200057 470500                    LDP0    MAJOR$,,AUTO
         1 000143   000000 236100                    LDQ     0,,PR0
         1 000144   000777 376007                    ANQ     511,DL
         1 000145   200056 756100                    STQ     LINK,,AUTO

      353     5097    2       IF LINK ~= 0 THEN DO;

   5097  1 000146   000204 600000 1                  TZE     s:5123

      354     5098    2           MINOR$ = PINCRW( KIS_MINOR$, LINK);

   5098  1 000147   000022 736000                    QLS     18
         1 000150   000000 036000 xsym               ADLQ    KIS_MINOR$
         1 000151   200060 756100                    STQ     MINOR$,,AUTO

      355     5099    3           IF MINOR$->APPL.TCTX ~= 0 THEN DO;

   5099  1 000152   200060 471500                    LDP1    MINOR$,,AUTO
         1 000153   100000 220100                    LDX0    0,,PR1
         1 000154   000204 600000 1                  TZE     s:5123

PL6.E3A0      #002=KIS$OSI_CLOSE File=KIS$OSI.:E05TSI                            WED 07/30/97 00:40 Page:49   
      356     5100                    /* here's a Transport connection that's still open.  Gulp. */
      357     5101    3               K$RWPARM.TCTX# = MINOR$->APPL.TCTX;

   5101  1 000155   200037 740100                    STX0    K$RWPARM+27,,AUTO

      358     5102                    /* try to disconnect it */
      359     5103    3               CALL KIT$SEND( K$RWPARM)

   5103  1 000156   200004 633500                    EPPR3   K$RWPARM,,AUTO
         1 000157   200062 453500                    STP3    SCID+1,,AUTO
         1 000160   200062 630500                    EPPR0   SCID+1,,AUTO
         1 000161   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 000162   000000 701000 xent               TSX1    KIT$SEND
         1 000163   000170 702000 1                  TSX2    s:5110

      360     5104    4               WHENRETURN DO;

      361     5105                        /* Whew, it worked */
      362     5106    4                   MINOR$->APPL.TCTX = 0;

   5106  1 000164   000000 220003                    LDX0    0,DU
         1 000165   200060 470500                    LDP0    MINOR$,,AUTO
         1 000166   000000 740100                    STX0    0,,PR0

      363     5107    4                   END;

   5107  1 000167   000204 710000 1                  TRA     s:5123

      364     5108    4               WHENALTRETURN DO;

      365     5109                        /* Transport was unable to disconnect this one */
      366     5110    4                   IF K$RWPARM.ERR = %K$USER_ERR THEN

   5110  1 000170   200017 235100                    LDA     K$RWPARM+11,,AUTO
         1 000171   000010 115007                    CMPA    8,DL
         1 000172   000177 601000 1                  TNZ     s:5113

PL6.E3A0      #002=KIS$OSI_CLOSE File=KIS$OSI.:E05TSI                            WED 07/30/97 00:40 Page:50   
      367     5111    4                       B$JIT.ERR = K$RWPARM.MSG_ERRCODE;

   5111  1 000173   200043 236100                    LDQ     K$RWPARM+31,,AUTO
         1 000174   000000 470400 xsym               LDP0    B$JIT$
         1 000175   000012 756100                    STQ     10,,PR0
         1 000176   000204 710000 1                  TRA     s:5123

      368     5112    5                   ELSE DO;

      369     5113    5                       B$JIT.ERR = ERRTRANSPORT;

   5113  1 000177   000003 236000 0                  LDQ     ERRTRANSPORT
         1 000200   000000 470400 xsym               LDP0    B$JIT$
         1 000201   000012 756100                    STQ     10,,PR0

      370     5114                            /*E*  ERROR:  KIS-E$TRANSPORT-A
      371     5115                                MESSAGE:  Internal error.  Transport ALTRETURN.
      372     5116                            */
      373     5117                            /* Don't ALTRETURN here.. try to drop other connections */
      374     5118    5                       CALL SC_PRTCL_SNAP;

   5118  1 000202   000000 713400 xsym               CLIMB   SC_PRTCL_SNAP
         1 000203   000000 600000 xsid               climb   nvectors=         0

      375     5119    5                       END;

      376     5120    4                   END;

      377     5121    3               END;

      378     5122    2           END;

      379     5123    2       IF B$JIT.ERR = '0'B THEN DO;

   5123  1 000204   000000 470400 xsym               LDP0    B$JIT$
         1 000205   000012 235100                    LDA     10,,PR0
         1 000206   000242 601000 1                  TNZ     s:5138
PL6.E3A0      #002=KIS$OSI_CLOSE File=KIS$OSI.:E05TSI                            WED 07/30/97 00:40 Page:51   

      380     5124                /* the Transport link dropped, or there wasn't one to drop */
      381     5125    2           CALL NKL$RELDCT( LDCT$);

   5125  1 000207   200055 631500                    EPPR1   LDCT$,,AUTO
         1 000210   200062 451500                    STP1    SCID+1,,AUTO
         1 000211   200062 630500                    EPPR0   SCID+1,,AUTO
         1 000212   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 000213   000000 701000 xent               TSX1    NKL$RELDCT
         1 000214   000000 011000                    NOP     0

      382     5126                /* release the minor client slot, if any */
      383     5127    3           IF LINK ~= 0 THEN DO;

   5127  1 000215   200056 235100                    LDA     LINK,,AUTO
         1 000216   000227 600000 1                  TZE     s:5132

      384     5128    3               MINOR$->APPL.Z.LINK = KIS_MINOR$->APPL.Z.LINK;

   5128  1 000217   000000 470400 xsym               LDP0    KIS_MINOR$
         1 000220   200060 471500                    LDP1    MINOR$,,AUTO
         1 000221   000000 236100                    LDQ     0,,PR0
         1 000222   100000 552104                    STBQ    0,'04'O,PR1

      385     5129    3               KIS_MINOR$->APPL.Z.LINK = MAJOR$->APPL.Z.LINK;

   5129  1 000223   200057 470500                    LDP0    MAJOR$,,AUTO
         1 000224   000000 473400 xsym               LDP3    KIS_MINOR$
         1 000225   000000 236100                    LDQ     0,,PR0
         1 000226   300000 552104                    STBQ    0,'04'O,PR3

      386     5130    3               END;

      387     5131                /* release the major client slot */
      388     5132    2           MAJOR$->APPL.LDCTX = 0;

   5132  1 000227   000000 220003                    LDX0    0,DU
PL6.E3A0      #002=KIS$OSI_CLOSE File=KIS$OSI.:E05TSI                            WED 07/30/97 00:40 Page:52   
         1 000230   200057 470500                    LDP0    MAJOR$,,AUTO
         1 000231   000000 740100                    STX0    0,,PR0

      389     5133    2           MAJOR$->APPL.Z.USER = 0;

   5133  1 000232   000000 236003                    LDQ     0,DU
         1 000233   000000 552110                    STBQ    0,'10'O,PR0

      390     5134    2           MAJOR$->APPL.Z.LINK = KIS_MAJOR$->APPL.CLNTHD;

   5134  1 000234   000000 471400 xsym               LDP1    KIS_MAJOR$
         1 000235   100000 236100                    LDQ     0,,PR1
         1 000236   000000 552104                    STBQ    0,'04'O,PR0

      391     5135    2           KIS_MAJOR$->APPL.CLNTHD = SCID;

   5135  1 000237   200061 721100                    LXL1    SCID,,AUTO
         1 000240   000000 471400 xsym               LDP1    KIS_MAJOR$
         1 000241   100000 441100                    SXL1    0,,PR1

      392     5136    2           END;

      393     5137            %UNLOCK( G=KIS_OSILOCK);

   5138  1 000242   000000 630400 2                  EPPR0   0
         1 000243   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 000244   000000 701000 xent               TSX1    HFC$UNLOCK
         1 000245   000000 011000                    NOP     0

      394     5140            /* mark DCB closed */
      395     5141    1       F$DCB.FCD = %NO#;

   5141  1 000246   200054 470500                    LDP0    JDCB$,,AUTO
         1 000247   000002 236000 2                  LDQ     2
         1 000250   000031 356100                    ANSQ    25,,PR0

      396     5142            /* scrub other DCB fields we used */
PL6.E3A0      #002=KIS$OSI_CLOSE File=KIS$OSI.:E05TSI                            WED 07/30/97 00:40 Page:53   
      397     5143    1       F$DCB.LDCTX = 0;

   5143  1 000251   000000 220003                    LDX0    0,DU
         1 000252   000051 740100                    STX0    41,,PR0

      398     5144    1       F$DCB.DVFC = BINASC( 0);

   5144  1 000253   000000 236003                    LDQ     0,DU
         1 000254   000044 552110                    STBQ    36,'10'O,PR0

      399     5145    1       IF B$JIT.ERR THEN

   5145  1 000255   000000 471400 xsym               LDP1    B$JIT$
         1 000256   100012 235100                    LDA     10,,PR1
         1 000257   000261 600000 1                  TZE     s:5148

      400     5146                /* lower layer error of some kind */
      401     5147    1           ALTRETURN;

   5147  1 000260   000000 702200 xent               TSX2  ! X66_AALT

      402     5148    1       RETURN;

   5148  1 000261   000000 702200 xent               TSX2  ! X66_ARET

ERRBADSCID
 Sect OctLoc
   0     000   131123 431407                                                    YS..

ERRNCCLOSED
 Sect OctLoc
   0     001   131123 431367                                                    YS..

ERRNOTOSIDCB
 Sect OctLoc
   0     002   131123 431427                                                    YS..

PL6.E3A0      #002=KIS$OSI_CLOSE File=KIS$OSI.:E05TSI                            WED 07/30/97 00:40 Page:54   
ERRTRANSPORT
 Sect OctLoc
   0     003   131123 431457                                                    YS..

ERRWRONGLDCT
 Sect OctLoc
   0     004   131123 431417                                                    YS..

(unnamed)
 Sect OctLoc
   0     005   004000 000000                                                    ....

(unnamed)
 Sect OctLoc
   2     000   000000 006000   777737 777777   777777 757777                    ............
      403     5149
      404     5150    1       END KIS$OSI_CLOSE;
      405     5151        %EOD;

PL6.E3A0      #002=KIS$OSI_CLOSE File=KIS$OSI.:E05TSI                            WED 07/30/97 00:40 Page:55   
--  Include file information  --

   F$DCB.:E05TOU  is referenced.
   UM_CP6.:E05TOU  is referenced.
   NK$LDCT.:E05TOU  is referenced.
   NK_SUBS.:E05TOU  is referenced.
   NK_LDCT_R.:E05TOU  cannot be made into a system file and is referenced.
   K_TRANSPORT_E.:E05TOU  is referenced.
   K_SUBS_C.:E05TOU  is referenced.
   K_SESSION_M.:E05TOU  is referenced.
   K_INTERFACE_M.:E05TOU  is referenced.
   K$RWPARM.:E05TOU  is referenced.
   K_DATA_R.:E05TOU  cannot be made into a system file and is referenced.
   K_ADDRESS_M.:E05TOU  is referenced.
   KI_ERRORS_C.:E05TOU  is referenced.
   HF_LOCK_C.:E05TOU  cannot be made into a system file and is referenced.
   CP_6_SUBS.:E05TOU  is referenced.
   B$JIT_C.:E05TOU  is referenced.
      No diagnostics issued in procedure KIS$OSI_CLOSE.
PL6.E3A0      #002=KIS$OSI_CLOSE File=KIS$OSI.:E05TSI                            WED 07/30/97 00:40 Page:56   

 **** Variables and constants ****

  ****  Section 000 RoData KIS$OSI_CLOSE

  ****  Scalars and arrays  ****
OctLoc.c.b A Datatyp(siz) R M Lvl/name                 OctLoc.c.b A Datatyp(siz) R M Lvl/name

     0-0-0/w STRC        r     1 ERRBADSCID                 1-0-0/w STRC        r     1 ERRNCCLOSED
     2-0-0/w STRC        r     1 ERRNOTOSIDCB               3-0-0/w STRC        r     1 ERRTRANSPORT
     4-0-0/w STRC        r     1 ERRWRONGLDCT

  ****  Auto variables  ****

  ****  Scalars and arrays  ****
OctLoc.c.b A Datatyp(siz) R M Lvl/name                 OctLoc.c.b A Datatyp(siz) R M Lvl/name

    54-0-0/w PTR         r     1 JDCB$                      4-0-0/d STRC(1404)  r     1 K$RWPARM
    55-0-0/w PTR         r     1 LDCT$                     56-0-0/w SBIN        r     1 LINK
    57-0-0/w PTR         r     1 MAJOR$                    60-0-0/w PTR         r     1 MINOR$
    61-0-0/w SBIN        r     1 SCID

  ****  SYMREF variables  ****

  ****  Scalars and arrays  ****
OctLoc.c.b A Datatyp(siz) R M Lvl/name                 OctLoc.c.b A Datatyp(siz) R M Lvl/name

     0-0-0/w PTR         r     1 B$JIT$                     0-0-0/w PTR         r     1 KIS_MAJOR$
     0-0-0/w PTR         r     1 KIS_MINOR$                 0-0-0/b BIT (72)    r     1 KIS_OSILOCK
     0-0-0/w UBIN        r     1 KIS_SSN_MAXMAJOR           0-0-0/d STRC(1404)  r     1 K_RWPARM_CON
     0-0-0/w PTR         r     1 N$DCT$$

  ****  BASED and DCB variables  ****

  ****  Scalars and arrays  ****
OctLoc.c.b A Datatyp(siz) R M Lvl/name                 OctLoc.c.b A Datatyp(siz) R M Lvl/name

     0-0-0/w STRC(360)   r     1 APPL                       0-0-0/d STRC(8856)  r     1 B$JIT
PL6.E3A0      #002=KIS$OSI_CLOSE File=KIS$OSI.:E05TSI                            WED 07/30/97 00:40 Page:57   
     0-0-0/d ASTR(3528)  r     1 F$DCB                      0-0-0/d STRC(864)   r     1 NK$LDCT
     0-0-0/w PTR         r     1 NK$LDCT$(0:0)


   Procedure KIS$OSI_CLOSE requires 178 words for executable code.
   Procedure KIS$OSI_CLOSE requires 52 words of local(AUTO) storage.
PL6.E3A0      #002=KIS$OSI_CLOSE File=KIS$OSI.:E05TSI                            WED 07/30/97 00:40 Page:58   
          *** CROSS REFERENCE LISTING ***
**     DENOTES     IDENTIFIER DEFINITION
<<                 IDENTIFIER'S VALUE SET
>>                 IDENTIFIER'S VALUE USED
<>                 IDENTIFIER SET AND/OR USED
--                 IDENTIFIER REFERENCED
PL6.E3A0      #002=KIS$OSI_CLOSE File=KIS$OSI.:E05TSI                            WED 07/30/97 00:40 Page:59   
          MINI XREF LISTING

APPL.CLNTHD
      3242**DCL      3243--REDEF    5134>>ASSIGN   5135<<ASSIGN
APPL.LDCTX
      3240**DCL      5061>>ASSIGN   5132<<ASSIGN
APPL.TCTX
      3239**DCL      3240--REDEF    3241--REDEF    5099>>IF       5101>>ASSIGN   5106<<ASSIGN
APPL.Z.COOKIE
      3244**DCL      3245--REDEF
APPL.Z.LINK
      3246**DCL      5096>>ASSIGN   5128<<ASSIGN   5128>>ASSIGN   5129<<ASSIGN   5129>>ASSIGN   5134<<ASSIGN
APPL.Z.USER
      3245**DCL      5133<<ASSIGN
B$JIT.DCB$
       449**DCL      5040>>ASSIGN
B$JIT.ERR
       359**DCL      5043<<ASSIGN   5052<<ASSIGN   5066<<ASSIGN   5074<<ASSIGN   5091<<ASSIGN   5111<<ASSIGN
      5113<<ASSIGN   5123>>IF       5145>>IF
B$JIT.ERR.MID
       360**DCL       360--REDEF
B$JIT.USER
       359**DCL      5062>>IF
B$JIT$
      5027**DCL       354--IMP-PTR  5040>>ASSIGN   5043>>ASSIGN   5052>>ASSIGN   5062>>IF       5066>>ASSIGN
      5074>>ASSIGN   5091>>ASSIGN   5111>>ASSIGN   5113>>ASSIGN   5123>>IF       5145>>IF
ERRBADSCID
      4694**DCL      5052>>ASSIGN
ERRNCCLOSED
      4742**DCL      5043>>ASSIGN   5084>>ASSIGN
ERRNOTOSIDCB
      4790**DCL      5074>>ASSIGN
ERRTRANSPORT
      4838**DCL      5113>>ASSIGN
PL6.E3A0      #002=KIS$OSI_CLOSE File=KIS$OSI.:E05TSI                            WED 07/30/97 00:40 Page:60   
ERRWRONGLDCT
      4886**DCL      5066>>ASSIGN
F$DCB.ACTPOS
      4997**DCL      4997--REDEF
F$DCB.ARS
      4972**DCL      4972--REDEF
F$DCB.ATTR
      4990**DCL      4991--REDEF
F$DCB.BORROW
      5005**DCL      5005--REDEF    5005--REDEF    5005--REDEF
F$DCB.DCBNAME.L
      5019**DCL      5019--IMP-SIZ
F$DCB.DVFC
      4993**DCL      5049>>ASSIGN   5144<<ASSIGN
F$DCB.EOMCHAR
      4976**DCL      4976--REDEF
F$DCB.FCD
      4985**DCL      5041>>IF       5141<<ASSIGN
F$DCB.FCN.CNT
      5009**DCL      5081>>IF
F$DCB.FLDID
      5000**DCL      5000--REDEF
F$DCB.FORM$
      4994**DCL      4994--REDEF
F$DCB.FSECT
      5010**DCL      5010--REDEF
F$DCB.FSN
      4987**DCL      4987--REDEF    4987--REDEF    4988--REDEF
F$DCB.HEADER$
      4993**DCL      4993--REDEF
F$DCB.IXTNSIZE
      4991**DCL      4991--REDEF
F$DCB.LASTSTA$
      4981**DCL      4981--REDEF
F$DCB.LDCTX
      4994**DCL      5041>>IF       5062>>IF       5143<<ASSIGN
PL6.E3A0      #002=KIS$OSI_CLOSE File=KIS$OSI.:E05TSI                            WED 07/30/97 00:40 Page:61   
F$DCB.LVL
      5006**DCL      5006--REDEF
F$DCB.NAME.C
      4981**DCL      4981--REDEF
F$DCB.NOEOF
      5002**DCL      5002--REDEF
F$DCB.NRECS
      4992**DCL      4992--REDEF
F$DCB.NRECX
      5011**DCL      5011--REDEF
F$DCB.OHDR
      5003**DCL      5003--REDEF
F$DCB.ORG
      4986**DCL      4986--REDEF
F$DCB.PRECNO
      5009**DCL      5009--REDEF
F$DCB.RCSZ
      5014**DCL      5014--REDEF
F$DCB.RES
      4982**DCL      4982--REDEF
F$DCB.SETX
      4994**DCL      4994--REDEF
F$DCB.TAB$
      4993**DCL      4994--REDEF
F$DCB.TDA
      5008**DCL      5008--REDEF
F$DCB.WSN
      4983**DCL      4983--REDEF
HFC$LOCK
      1100**DCL-ENT  5093--CALL
HFC$UNLOCK
      1100**DCL-ENT  5138--CALL
JDCB$
      5033**DCL      4972--IMP-PTR  5040<<ASSIGN   5041>>IF       5041>>IF       5049>>ASSIGN   5062>>IF
      5081>>IF       5141>>ASSIGN   5143>>ASSIGN   5144>>ASSIGN
K$RWPARM
PL6.E3A0      #002=KIS$OSI_CLOSE File=KIS$OSI.:E05TSI                            WED 07/30/97 00:40 Page:62   
      2421**DCL      5083<<ASSIGN   5086<>CALL     5088<<ASSIGN   5103<>CALL
K$RWPARM.BLKREC
      2447**DCL      2472--REDEF
K$RWPARM.BLKREC.BLKU#
      2448**DCL      2450--REDEF
K$RWPARM.BLKREC.RECU#
      2460**DCL      2462--REDEF
K$RWPARM.DVE.DVBYTE.VFC
      2487**DCL      2488--REDEF
K$RWPARM.DVE.EOMCHAR
      2495**DCL      2499--REDEF
K$RWPARM.ERR
      2559**DCL      2564--REDEF    5090<<ASSIGN   5110>>IF
K$RWPARM.FC
      2523**DCL      2524--REDEF
K$RWPARM.FLDID
      2705**DCL      2706--REDEF
K$RWPARM.FPT$
      2586**DCL      2593--REDEF
K$RWPARM.FUNCTION
      2600**DCL      5089<<ASSIGN
K$RWPARM.KEYTYPE
      2712**DCL      2713--REDEF
K$RWPARM.MSG$
      2422**DCL      2428--REDEF
K$RWPARM.MSGID
      2534**DCL      2539--REDEF
K$RWPARM.MSGIDXT
      2547**DCL      2551--REDEF
K$RWPARM.MSG_ERRCODE
      2682**DCL      5084<<ASSIGN   5111>>ASSIGN
K$RWPARM.ORG
      2683**DCL      2684--REDEF
K$RWPARM.TCTX#
      2657**DCL      5101<<ASSIGN
K$RWPARM.THDRSZ
PL6.E3A0      #002=KIS$OSI_CLOSE File=KIS$OSI.:E05TSI                            WED 07/30/97 00:40 Page:63   
      2627**DCL      2631--REDEF
K$RWPARM.TYC
      2443**DCL      5085<<ASSIGN
K$RWPARM.VDOFLGS
      2685**DCL      2696--REDEF
KIA$COMP
      5022**DCL-ENT  5086--CALL
KIS_MAJOR$
      5028**DCL      5060>>ASSIGN   5134>>ASSIGN   5135>>ASSIGN
KIS_MINOR$
      5029**DCL      5098>>ASSIGN   5128>>ASSIGN   5129>>ASSIGN
KIS_OSILOCK
      5030**DCL      5093<>CALL     5138<>CALL
KIS_SSN_MAXMAJOR
      5031**DCL      5050>>IF
KIT$SEND
      5023**DCL-ENT  5103--CALL
K_RWPARM_CON
      2104**DCL      5083>>ASSIGN   5088>>ASSIGN
K_RWPARM_CON.BLKREC
      2130**DCL      2155--REDEF
K_RWPARM_CON.BLKREC.BLKU#
      2131**DCL      2133--REDEF
K_RWPARM_CON.BLKREC.RECU#
      2143**DCL      2145--REDEF
K_RWPARM_CON.DVE.DVBYTE.VFC
      2170**DCL      2171--REDEF
K_RWPARM_CON.DVE.EOMCHAR
      2178**DCL      2182--REDEF
K_RWPARM_CON.ERR
      2242**DCL      2247--REDEF
K_RWPARM_CON.FC
      2206**DCL      2207--REDEF
K_RWPARM_CON.FLDID
      2388**DCL      2389--REDEF
K_RWPARM_CON.FPT$
PL6.E3A0      #002=KIS$OSI_CLOSE File=KIS$OSI.:E05TSI                            WED 07/30/97 00:40 Page:64   
      2269**DCL      2276--REDEF
K_RWPARM_CON.KEYTYPE
      2395**DCL      2396--REDEF
K_RWPARM_CON.MSG$
      2105**DCL      2111--REDEF
K_RWPARM_CON.MSGID
      2217**DCL      2222--REDEF
K_RWPARM_CON.MSGIDXT
      2230**DCL      2234--REDEF
K_RWPARM_CON.ORG
      2366**DCL      2367--REDEF
K_RWPARM_CON.THDRSZ
      2310**DCL      2314--REDEF
K_RWPARM_CON.VDOFLGS
      2368**DCL      2379--REDEF
LDCT$
      5034**DCL      3791--IMP-PTR  5061<<ASSIGN   5062>>IF       5062>>IF       5062>>IF       5072>>IF
      5082>>DOWHILE  5086>>CALL     5095>>ASSIGN   5125<>CALL
LINK
      5035**DCL      5096<<ASSIGN   5097>>IF       5098>>ASSIGN   5127>>IF
MAJOR$
      5036**DCL      5060<<ASSIGN   5061>>ASSIGN   5096>>ASSIGN   5129>>ASSIGN   5132>>ASSIGN   5133>>ASSIGN
      5134>>ASSIGN
MINOR$
      5037**DCL      5098<<ASSIGN   5099>>IF       5101>>ASSIGN   5106>>ASSIGN   5128>>ASSIGN
N$DCT$$
      3649**DCL      3649--IMP-PTR  5061>>ASSIGN   5062>>IF
NK$LDCT
      3791**DCL      5086<>CALL
NK$LDCT.DDT$
      3793**DCL      3793--REDEF
NK$LDCT.IOQ$
      3792**DCL      3793--REDEF
NK$LDCT.LDCTX
      3794**DCL      3794--REDEF
NK$LDCT.LKFLG.ABORTED
PL6.E3A0      #002=KIS$OSI_CLOSE File=KIS$OSI.:E05TSI                            WED 07/30/97 00:40 Page:65   
      3806**DCL      3807--REDEF
NK$LDCT.LKFLG.ACTIVE
      3810**DCL      5095<<ASSIGN
NK$LDCT.LKFLG.NOWAIT
      3812**DCL      5082>>DOWHILE
NK$LDCT.RESCOD
      3799**DCL      5072>>IF
NK$LDCT.RLCID.LDCTX
      3816**DCL      3816--REDEF
NK$LDCT.STA$
      3812**DCL      3813--REDEF
NK$LDCT.SYMB$
      3791**DCL      3791--REDEF    3791--REDEF    3792--REDEF
NK$LDCT.TH.STR
      3817**DCL      5062>>IF
NK$LDCT.USER
      3801**DCL      5062>>IF
NK$LDCT$
      3649**DCL      5061>>ASSIGN   5062>>IF
NKL$RELDCT
      5024**DCL-ENT  5125--CALL
SCID
      5038**DCL      5049<<ASSIGN   5050>>IF       5060>>ASSIGN   5062>>IF       5135>>ASSIGN
SC_PRTCL_SNAP
      5025**DCL-ENT  5057--CALL     5118--CALL
SNAP
      5057**LABEL    5070--GOTO     5078--GOTO

PL6.E3A0      #003=KIS$OSI_WRITE File=KIS$OSI.:E05TSI                            WED 07/30/97 00:41 Page:66   
      406        1        /*T***********************************************************/
      407        2        /*T*                                                         */
      408        3        /*T* Copyright (c) Bull HN Information Systems Inc., 1997    */
      409        4        /*T*                                                         */
      410        5        /*T***********************************************************/
      411        6        /*F*    NAME:   KIS$OSI_WRITE
      412        7                PURPOSE:  Handle M$WRITE of RES=NC DCB.
      413        8        */
      414        9        /*D*    NAME:   KIS$OSI_WRITE
      415       10                CALL:   CALL KIS$OSI_WRITE ALTRET( label);
      416       11                INPUT:
      417       12                    B$JIT.DCB$->F$DCB.DVFC holds the major SCID of the client,
      418       13                    B$PS0$ points at the V area of the M$WRITE FPT,
      419       14                    B$PS2$ points at the BUF area (GLUE plus SPDU/TFPT)
      420       15                OUTPUT:
      421       16                    On successful call,
      422       17                      None.  If a Transport request is being issued, the Transport
      423       18                      FPT present in the user's buffer is just sent to Transport.
      424       19                      If a Session PDU is present in the user's buffer, it is handed
      425       20                      to Transport as a T-DATA or T-EXPEDITED-DATA request.
      426       21                    On unsuccessful call,
      427       22                      B$JIT.ERROR is filled in with an appropriate error,
      428       23                      ALTRETURN is taken.
      429       24                DESCRIPTION:
      430       25                    KIS$OSI_WRITE is called when an OSI client application wishes
      431       26                    to send a message to a server.  It is entered from FSE$FORMAT
      432       27                    when an M$WRITE to a DCB with RES=NC is issued.  BUF_ frames
      433       28                    the GLUE and either a Transport FPT or an OSI Session PDU.
      434       29
      435       30                    The GLUE tells what the message is and how to send it.
      436       31                    GLUE.TRNFNC is what Transport function to use, GLUE.MYSCID is
      437       32                    the minor SCID for this connection, and GLUE.YRSCID is the other
      438       33                    endpoint's minor SCID for this connection, if known (else zero).
      439       34
      440       35                    NOTE: ALL WRITES AND READS THRU RES=NC MUST BE TRANSPARENT.
      441       36                    This is required for (1) optimized handling by FSE, and (2) to
      442       37                    avoid stomping on the DVFC field in the DCB.
PL6.E3A0      #003=KIS$OSI_WRITE File=KIS$OSI.:E05TSI                            WED 07/30/97 00:41 Page:67   
      443       38        */
      444       39        KIS$OSI_WRITE: PROC ALTRET;
      445       40        %INCLUDE CP_6_SUBS;
      446      580        %INCLUDE F$CP6V_C;
      447      806            %FPT$WRITE_V( BASED="BASED( B$PS0$)");
      448      812        %INCLUDE F$JIT_C;
      449     1242        %INCLUDE HF_LOCK_C;
      450     1256        %INCLUDE KI_ERRORS_C;
      451     1341        %INCLUDE K_ADDRESS_M;
      452     1844        %INCLUDE K_DATA_R;
      453     2555            %K$RWPARM( NAME=K$RWPARM, STCLASS=AUTO);
      454     2871        %INCLUDE K_INTERFACE_M;
      455     3280            %K$FPT_CONNECT_OSI;
      456     3617            %K$FPT_TERM_OSI;
      457     3835        %INCLUDE K_SESSION_M;
      458     3925            %KIS$APPL( NAME=APPL, STCLASS=BASED);
      459     3994            %KIS$GLUE( NAME=GLUE, STCLASS="BASED( B$PS2$)");
      460     4024        %INCLUDE K_SUBS_C;
      461     4057        %INCLUDE NK_LDCT_R;
      462     4066        %INCLUDE NK$LDCT;
      463     4168            %NK$LDCT( STCLASS="BASED( LDCT$)");
      464     4214        %INCLUDE UM_CP6;
      465     5066        %MACRO ERRCODE( NAME=ERRDUMMY, CODE=0);
      466     5067            %VLP_ERRCODE( FPTN=NAME, STCLASS=CONSTANT, FCG='KI', MID='S',
      467     5068                          MON='1'B, ERR#=CODE, SEV=7);
      468     5069        %MEND;
      469     5070            %ERRCODE( NAME=ERRBADOSIBUF, CODE=%E$BADOSIBUF);
      470     5118            %ERRCODE( NAME=ERRBADOSIFPT, CODE=%E$BADOSIFPT);
      471     5166            %ERRCODE( NAME=ERRBADSCID, CODE=%E$BADSCID);
      472     5214            %ERRCODE( NAME=ERRMINORTBL, CODE=%E$MINORTBL);
      473     5262            %ERRCODE( NAME=ERRTRANCLOSED, CODE=%E$TRANCLOSED);
      474     5310            %ERRCODE( NAME=ERRTRANOPEN, CODE=%E$TRANOPEN);
      475     5358            %ERRCODE( NAME=ERRTRANSPORT, CODE=%E$TRANSPORT);
      476     5406        %MACRO F$DCBI( BASED=BASED);
      477     5407        %INCLUDE F$DCB;
      478     5456        %MEND;
      479     5457            %F$DCBI( BASED="BASED( JDCB$)");
PL6.E3A0      #003=KIS$OSI_WRITE File=KIS$OSI.:E05TSI                            WED 07/30/97 00:41 Page:68   
      480     5507
      481     5508    1       DCL KIA$OQFL ENTRY(1) ALTRET;
      482     5509    1       DCL KIT$SEND ENTRY(1) ALTRET;
      483     5510    1       DCL HFF$DSIZ ENTRY(2) ALTRET;
      484     5511    1       DCL SC_PRTCL_SNAP ENTRY CONV(2,0);
      485     5512
      486     5513    1       DCL B$JIT$ PTR SYMREF;
      487     5514    1       DCL B$PS0$ PTR SYMREF;  /* points at V area of FPT */
      488     5515    1       DCL B$PS2$ PTR SYMREF;  /* points at BUF within FPT */
      489     5516    1       DCL KIS_MAJOR$ PTR SYMREF;
      490     5517    1       DCL KIS_MINOR$ PTR SYMREF;
      491     5518    1       DCL KIS_SSN_MAXMAJOR UBIN SYMREF;
      492     5519
      493     5520    1       DCL JDCB$ PTR;
      494     5521    1       DCL LEN SBIN;
      495     5522    1       DCL LDCT$ PTR;
      496     5523    1       DCL LINK SBIN;
      497     5524    1       DCL MAJOR$ PTR;
      498     5525    1       DCL MINOR$ PTR;
      499     5526    1       DCL SCID SBIN;
      500     5527
      501     5528    1       JDCB$ = B$JIT.DCB$;
      502     5529            /* get the major SCID for this application */
      503     5530    1       SCID = ASCBIN( F$DCB.DVFC);
      504     5531    2       IF SCID > KIS_SSN_MAXMAJOR THEN DO;
      505     5532                /* no way can this be a legal appl id */
      506     5533    2           B$JIT.ERR = ERRBADSCID;
      507     5534                /*    ERROR:  KIS-E$BADSCID-A
      508     5535                    MESSAGE:  Bad Session connection identifier.
      509     5536                */
      510     5537    2   SNAP:
      511     5538    2           CALL SC_PRTCL_SNAP;
      512     5539    2           ALTRETURN;
      513     5540    2           END;
      514     5541            /* see if SPDU is present and reasonable length */
      515     5542    1       CALL HFF$DSIZ( B$PS2$, LEN)
      516     5543    2       WHENALTRETURN DO;
PL6.E3A0      #003=KIS$OSI_WRITE File=KIS$OSI.:E05TSI                            WED 07/30/97 00:41 Page:69   
      517     5544                /* there's no SPDU present but it's required to be there */
      518     5545    2   BADBUF:
      519     5546    2           B$JIT.ERR = ERRBADOSIBUF;
      520     5547                /*E*  ERROR:  KIS-E$BADOSIBUF-A
      521     5548                    MESSAGE:  Write buffer too short or not present at all.
      522     5549                */
      523     5550    2           ALTRETURN;
      524     5551    2           END;
      525     5552    1       IF LEN < 4 THEN
      526     5553    1           GOTO BADBUF;
      527     5554    1       K$RWPARM = K_RWPARM_CON;
      528     5555    1       K$RWPARM.FUNCTION = GLUE.TRNFNC;
      529     5556    1       MAJOR$ = PINCRW( KIS_MAJOR$, SCID);
      530     5557    2       IF GLUE.TRNFNC ~= %K_TCONNECT_REQ THEN DO;
      531     5558    3           IF MAJOR$->APPL.Z.LINK = 0 THEN DO;
      532     5559    3   NOWAY:
      533     5560    3               B$JIT.ERR = ERRTRANCLOSED;
      534     5561                    /*E*  ERROR:  KIS-E$TRANCLOSED-A
      535     5562                        MESSAGE:  Transport connection doesn't exist.
      536     5563                    */
      537     5564    3               ALTRETURN;
      538     5565    3               END;
      539     5566    3           ELSE DO;
      540     5567    3               MINOR$ = PINCRW( KIS_MINOR$, MAJOR$->APPL.Z.LINK);
      541     5568    3               IF MINOR$->APPL.TCTX = 0 THEN
      542     5569    3                   GOTO NOWAY;
      543     5570    3               END;
      544     5571    2           END;
      545     5572    2       DO CASE( GLUE.TRNFNC);
      546     5573    2           CASE( %K_TCONNECT_REQ);
      547     5574                    /* this is a T-CONNECT Request */
      548     5575    3               IF LEN - 4 ~= SIZEC( K$FPT_CONNECT_OSI) THEN DO;
      549     5576    3                   B$JIT.ERR = ERRBADOSIFPT;
      550     5577                        /*E*  ERROR:  KIS-E$BADOSIFPT-A
      551     5578                            MESSAGE:  Write buffer contains malformed Transport FPT.
      552     5579                        */
      553     5580    3                   GOTO SNAP;
PL6.E3A0      #003=KIS$OSI_WRITE File=KIS$OSI.:E05TSI                            WED 07/30/97 00:41 Page:70   
      554     5581    3                   END;
      555     5582                    /* point at the K$FPT_CONNECT_OSI */
      556     5583    2               K$RWPARM.FPT$ = ADDR( GLUE.DATA);
      557     5584    2               MINOR$ = ADDR( NIL);
      558     5585    2               LINK = MAJOR$->APPL.Z.LINK;
      559     5586    3               IF LINK ~= 0 THEN DO;
      560     5587    3                   MINOR$ = PINCRW( KIS_MINOR$, LINK);
      561     5588    4                   IF MINOR$->APPL.TCTX ~= 0 THEN DO;
      562     5589                            /* would overlay an existing Transport connection */
      563     5590    4                       B$JIT.ERR = ERRTRANOPEN;
      564     5591                            /*E*  ERROR:  KIS-E$TRANOPEN-A
      565     5592                                MESSAGE:  Transport connection already exists.
      566     5593                            */
      567     5594    4                       GOTO SNAP;
      568     5595    4                       END;
      569     5596    3                   END;
      570     5597                    /* allocate a minor client slot for this connection */
      571     5598    3               IF MINOR$ = ADDR( NIL) THEN DO;
      572     5599    3                   LINK = KIS_MINOR$->APPL.Z.LINK;
      573     5600    4                   IF LINK = 0 THEN DO;
      574     5601                            /* all minor client slots are in use */
      575     5602    4                       B$JIT.ERR = ERRMINORTBL;
      576     5603                            /*E*  ERROR:  KIS-E$MINORTBL-A
      577     5604                            MESSAGE:  No more space in the 'minor' Session connection table.
      578     5605                            */
      579     5606    4                       ALTRETURN;
      580     5607    4                       END;
      581     5608    3                   MINOR$ = PINCRW( KIS_MINOR$, LINK);
      582     5609    3                   KIS_MINOR$->APPL.Z.LINK = MINOR$->APPL.Z.LINK;
      583     5610    3                   END;
      584     5611    2               MINOR$->APPL.TCTX = 0;
      585     5612    2               MINOR$->APPL.Z.LINK = 0;
      586     5613    2               MAJOR$->APPL.Z.LINK = LINK;
      587     5614                    /* make sure complete SCID is present in FPT */
      588     5615    2               K$RWPARM.FPT$->K$FPT_CONNECT_OSI.SCID = SCID * 512 + LINK;
      589     5616    2           CASE( %K_TDISCONNECT_REQ);
      590     5617                    /* this is a T-DISCONNECT Request */
PL6.E3A0      #003=KIS$OSI_WRITE File=KIS$OSI.:E05TSI                            WED 07/30/97 00:41 Page:71   
      591     5618    3               IF LEN - 4 ~= SIZEC( K$FPT_TERM_OSI) THEN DO;
      592     5619    3                   B$JIT.ERR = ERRBADOSIFPT;
      593     5620                        /*    ERROR:  KIS-E$BADOSIFPT-A
      594     5621                            MESSAGE:  Write buffer contains malformed Transport FPT.
      595     5622                        */
      596     5623    3                   GOTO SNAP;
      597     5624    3                   END;
      598     5625                    /* point at the K$FPT_TERM_OSI */
      599     5626    2               K$RWPARM.FPT$ = ADDR( GLUE.DATA);
      600     5627    2           CASE( %K_TDATA_REQ,
      601     5628    2                 %K_TEXPD_DATA_REQ);
      602     5629                    /* this is a T-DATA Request or a T-EXPEDITED-DATA Request */
      603     5630                    /* frame the SPDU to send */
      604     5631    2               K$RWPARM.SHDR$ = ADDR( GLUE.DATA);
      605     5632    2               K$RWPARM.SHDRSZ = LEN - 4;
      606     5633    2           END;
      607     5634            /* point at the correct major client slot */
      608     5635    1       MAJOR$ = PINCRW( KIS_MAJOR$, SCID);
      609     5636            /* get the Transport connection id */
      610     5637    1       K$RWPARM.TCTX# = MINOR$->APPL.TCTX;
      611     5638            /* send the mess to Transport */
      612     5639    1       LDCT$ = NK$LDCT$( F$DCB.LDCTX);
      613     5640            %LOCK( G=NK$LDCT.LOCK);
      614     5643    1   TRYSEND:
      615     5644    1       CALL KIT$SEND( K$RWPARM)
      616     5645    2       WHENRETURN DO;
      617     5646                %UNLOCK( G=NK$LDCT.LOCK);
      618     5649    2           END;
      619     5650    2       WHENALTRETURN DO;
      620     5651                /* the Transport layer couldn't handle the message */
      621     5652    3           IF K$RWPARM.ERR = %K$QFULL THEN DO;
      622     5653    3               CALL KIA$OQFL( NK$LDCT)
      623     5654    4               WHENALTRETURN DO;
      624     5655                        %UNLOCK( G=NK$LDCT.LOCK);
      625     5658    4                   GOTO SNAP;
      626     5659    4                   END;
      627     5660    3               GOTO TRYSEND;
PL6.E3A0      #003=KIS$OSI_WRITE File=KIS$OSI.:E05TSI                            WED 07/30/97 00:41 Page:72   
      628     5661    3               END;
      629     5662                %UNLOCK( G=NK$LDCT.LOCK);
      630     5665    3           IF K$RWPARM.ERR = %K$USER_ERR THEN DO;
      631     5666    3               B$JIT.ERR = K$RWPARM.MSG_ERRCODE;
      632     5667    3               ALTRETURN;
      633     5668    3               END;
      634     5669    3           ELSE DO;
      635     5670    3               B$JIT.ERR = ERRTRANSPORT;
      636     5671                    /*    ERROR:  KIS-E$TRANSPORT-A
      637     5672                        MESSAGE:  Internal error.  Transport ALTRETURN.
      638     5673                    */
      639     5674    3               GOTO SNAP;
      640     5675    3               END;
      641     5676    2           END;
      642     5677            /* Omigosh, it worked */
      643     5678    2       IF GLUE.TRNFNC = %K_TCONNECT_REQ THEN DO;
      644     5679    2           MINOR$->APPL.TCTX = K$RWPARM.TCTX#;
      645     5680    2           MINOR$->APPL.Z.COOKIE = GLUE.MYSCID;
      646     5681    2           END;
      647     5682    1       RETURN;
      648     5683
      649     5684    1       END KIS$OSI_WRITE;
      650     5685        %EOD;

PL6.E3A0      #003=KIS$OSI_WRITE File=KIS$OSI.:E05TSI                            WED 07/30/97 00:41 Page:73   
--  Include file information  --

   F$DCB.:E05TOU  is referenced.
   UM_CP6.:E05TOU  is referenced.
   NK$LDCT.:E05TOU  is referenced.
   NK_LDCT_R.:E05TOU  cannot be made into a system file and is referenced.
   K_SUBS_C.:E05TOU  is referenced.
   K_SESSION_M.:E05TOU  is referenced.
   K_INTERFACE_M.:E05TOU  is referenced.
   K$RWPARM.:E05TOU  is referenced.
   K_DATA_R.:E05TOU  cannot be made into a system file and is referenced.
   K_ADDRESS_M.:E05TOU  is referenced.
   KI_ERRORS_C.:E05TOU  is referenced.
   HF_LOCK_C.:E05TOU  cannot be made into a system file and is referenced.
   B$JIT_C.:E05TOU  is referenced.
   F$JIT_C.:E05TOU  cannot be made into a system file and is referenced.
   F$CP6V_C.:E05TOU  is referenced.
   CP_6_SUBS.:E05TOU  is referenced.
      No diagnostics issued in procedure KIS$OSI_WRITE.

   Procedure KIS$OSI_WRITE requires 231 words for executable code.
   Procedure KIS$OSI_WRITE requires 54 words of local(AUTO) storage.

PL6.E3A0      #003=KIS$OSI_WRITE File=KIS$OSI.:E05TSI                            WED 07/30/97 00:41 Page:74   

 Object Unit name= KIS$OSI_WRITE                              File name= KIS$OSI.:E05TOU
 UTS= JUL 30 '97 00:41:06.64 WED                              Compiler= PL-6/E31         Sev=      00
 SharedLib= :SHARED_SYSTEM                                    Alt SharedLib=


    ****  Control sections  ****

 Sect   Type Bound  Init  Size OctSiz  Section name(segment info)
    0  RoData even  UTS      7      7  KIS$OSI_WRITE
    1   Proc  even  none   231    347  KIS$OSI_WRITE
    2  RoData even  none     1      1  KIS$OSI_WRITE

    ****  Entry defs  ****

                              Check   Calling
                             calling  sequence
  Sect OctLoc Primary Altret sequence   type   Parms  Name
     1      0   yes    yes     yes      Std        0  KIS$OSI_WRITE

  ****  Entry refs  ****

         Check        Calling
        calling       sequence
Altret sequence SRef   type   Args  Name
 yes     yes           Std       2 HFF$DSIZ
         yes           Std       1 HFC$UNLOCK
         yes           Std       1 HFC$LOCK
 yes     yes           Std       1 KIT$SEND
 yes     yes           Std       1 KIA$OQFL
                       nStd      0 X66_AUTO_0
                       nStd      0 X66_AALT
                       Std       0 B_CONSPOOL_D
                       nStd      0 X66_ARET
PL6.E3A0      #003=KIS$OSI_WRITE File=KIS$OSI.:E05TSI                            WED 07/30/97 00:41 Page:75   

  ****  Data refs  ****

  Flags:  r = read only, s = secondary
Flgs Name                             Flgs Name                             Flgs Name
     SC_PRTCL_SNAP                    r    K_RWPARM_CON                          N$DCT$$
     B$JIT$                                B$PS0$                                B$PS2$
     KIS_MAJOR$                            KIS_MINOR$                            KIS_SSN_MAXMAJOR
     B_VECTNIL

  ****  Segment refs  ****

  Flags:  r = read only, s = secondary
Flgs Name                             Flgs Name                             Flgs Name
     ASLENTSID                             ISSID
PL6.E3A0      #003=KIS$OSI_WRITE File=KIS$OSI.:E05TSI                            WED 07/30/97 00:41 Page:76   


      406        1        /*T***********************************************************/
      407        2        /*T*                                                         */
      408        3        /*T* Copyright (c) Bull HN Information Systems Inc., 1997    */
      409        4        /*T*                                                         */
      410        5        /*T***********************************************************/
      411        6        /*F*    NAME:   KIS$OSI_WRITE
      412        7                PURPOSE:  Handle M$WRITE of RES=NC DCB.
      413        8        */
      414        9        /*D*    NAME:   KIS$OSI_WRITE
      415       10                CALL:   CALL KIS$OSI_WRITE ALTRET( label);
      416       11                INPUT:
      417       12                    B$JIT.DCB$->F$DCB.DVFC holds the major SCID of the client,
      418       13                    B$PS0$ points at the V area of the M$WRITE FPT,
      419       14                    B$PS2$ points at the BUF area (GLUE plus SPDU/TFPT)
      420       15                OUTPUT:
      421       16                    On successful call,
      422       17                      None.  If a Transport request is being issued, the Transport
      423       18                      FPT present in the user's buffer is just sent to Transport.
      424       19                      If a Session PDU is present in the user's buffer, it is handed
      425       20                      to Transport as a T-DATA or T-EXPEDITED-DATA request.
      426       21                    On unsuccessful call,
      427       22                      B$JIT.ERROR is filled in with an appropriate error,
      428       23                      ALTRETURN is taken.
      429       24                DESCRIPTION:
      430       25                    KIS$OSI_WRITE is called when an OSI client application wishes
      431       26                    to send a message to a server.  It is entered from FSE$FORMAT
      432       27                    when an M$WRITE to a DCB with RES=NC is issued.  BUF_ frames
      433       28                    the GLUE and either a Transport FPT or an OSI Session PDU.
      434       29
      435       30                    The GLUE tells what the message is and how to send it.
      436       31                    GLUE.TRNFNC is what Transport function to use, GLUE.MYSCID is
      437       32                    the minor SCID for this connection, and GLUE.YRSCID is the other
      438       33                    endpoint's minor SCID for this connection, if known (else zero).
      439       34
      440       35                    NOTE: ALL WRITES AND READS THRU RES=NC MUST BE TRANSPARENT.
      441       36                    This is required for (1) optimized handling by FSE, and (2) to
PL6.E3A0      #003=KIS$OSI_WRITE File=KIS$OSI.:E05TSI                            WED 07/30/97 00:41 Page:77   
      442       37                    avoid stomping on the DVFC field in the DCB.
      443       38        */
      444       39        KIS$OSI_WRITE: PROC ALTRET;

     39  1 000000   000000 700200 xent  KIS$OSI_WRI* TSX0  ! X66_AUTO_0
         1 000001   000066 000000                    ZERO    54,0

      445       40        %INCLUDE CP_6_SUBS;
      446      580        %INCLUDE F$CP6V_C;
      447      806            %FPT$WRITE_V( BASED="BASED( B$PS0$)");
      448      812        %INCLUDE F$JIT_C;
      449     1242        %INCLUDE HF_LOCK_C;
      450     1256        %INCLUDE KI_ERRORS_C;
      451     1341        %INCLUDE K_ADDRESS_M;
      452     1844        %INCLUDE K_DATA_R;
      453     2555            %K$RWPARM( NAME=K$RWPARM, STCLASS=AUTO);
      454     2871        %INCLUDE K_INTERFACE_M;
      455     3280            %K$FPT_CONNECT_OSI;
      456     3617            %K$FPT_TERM_OSI;
      457     3835        %INCLUDE K_SESSION_M;
      458     3925            %KIS$APPL( NAME=APPL, STCLASS=BASED);
      459     3994            %KIS$GLUE( NAME=GLUE, STCLASS="BASED( B$PS2$)");
      460     4024        %INCLUDE K_SUBS_C;
      461     4057        %INCLUDE NK_LDCT_R;
      462     4066        %INCLUDE NK$LDCT;
      463     4168            %NK$LDCT( STCLASS="BASED( LDCT$)");
      464     4214        %INCLUDE UM_CP6;
      465     5066        %MACRO ERRCODE( NAME=ERRDUMMY, CODE=0);
      466     5067            %VLP_ERRCODE( FPTN=NAME, STCLASS=CONSTANT, FCG='KI', MID='S',
      467     5068                          MON='1'B, ERR#=CODE, SEV=7);
      468     5069        %MEND;
      469     5070            %ERRCODE( NAME=ERRBADOSIBUF, CODE=%E$BADOSIBUF);
      470     5118            %ERRCODE( NAME=ERRBADOSIFPT, CODE=%E$BADOSIFPT);
      471     5166            %ERRCODE( NAME=ERRBADSCID, CODE=%E$BADSCID);
      472     5214            %ERRCODE( NAME=ERRMINORTBL, CODE=%E$MINORTBL);
      473     5262            %ERRCODE( NAME=ERRTRANCLOSED, CODE=%E$TRANCLOSED);
      474     5310            %ERRCODE( NAME=ERRTRANOPEN, CODE=%E$TRANOPEN);
PL6.E3A0      #003=KIS$OSI_WRITE File=KIS$OSI.:E05TSI                            WED 07/30/97 00:41 Page:78   
      475     5358            %ERRCODE( NAME=ERRTRANSPORT, CODE=%E$TRANSPORT);
      476     5406        %MACRO F$DCBI( BASED=BASED);
      477     5407        %INCLUDE F$DCB;
      478     5456        %MEND;
      479     5457            %F$DCBI( BASED="BASED( JDCB$)");
      480     5507
      481     5508    1       DCL KIA$OQFL ENTRY(1) ALTRET;
      482     5509    1       DCL KIT$SEND ENTRY(1) ALTRET;
      483     5510    1       DCL HFF$DSIZ ENTRY(2) ALTRET;
      484     5511    1       DCL SC_PRTCL_SNAP ENTRY CONV(2,0);
      485     5512
      486     5513    1       DCL B$JIT$ PTR SYMREF;
      487     5514    1       DCL B$PS0$ PTR SYMREF;  /* points at V area of FPT */
      488     5515    1       DCL B$PS2$ PTR SYMREF;  /* points at BUF within FPT */
      489     5516    1       DCL KIS_MAJOR$ PTR SYMREF;
      490     5517    1       DCL KIS_MINOR$ PTR SYMREF;
      491     5518    1       DCL KIS_SSN_MAXMAJOR UBIN SYMREF;
      492     5519
      493     5520    1       DCL JDCB$ PTR;
      494     5521    1       DCL LEN SBIN;
      495     5522    1       DCL LDCT$ PTR;
      496     5523    1       DCL LINK SBIN;
      497     5524    1       DCL MAJOR$ PTR;
      498     5525    1       DCL MINOR$ PTR;
      499     5526    1       DCL SCID SBIN;
      500     5527
      501     5528    1       JDCB$ = B$JIT.DCB$;

   5528  1 000002   000000 470400 xsym               LDP0    B$JIT$
         1 000003   000232 236100                    LDQ     154,,PR0
         1 000004   200054 756100                    STQ     JDCB$,,AUTO

      502     5529            /* get the major SCID for this application */
      503     5530    1       SCID = ASCBIN( F$DCB.DVFC);

   5530  1 000005   200054 471500                    LDP1    JDCB$,,AUTO
         1 000006   100044 236100                    LDQ     36,,PR1
PL6.E3A0      #003=KIS$OSI_WRITE File=KIS$OSI.:E05TSI                            WED 07/30/97 00:41 Page:79   
         1 000007   000011 772000                    QRL     9
         1 000010   000777 376007                    ANQ     511,DL
         1 000011   200062 756100                    STQ     SCID,,AUTO

      504     5531    2       IF SCID > KIS_SSN_MAXMAJOR THEN DO;

   5531  1 000012   000023 604000 1                  TMI     s:5542
         1 000013   000000 116000 xsym               CMPQ    KIS_SSN_MAXMAJOR
         1 000014   000023 602000 1                  TNC     s:5542
         1 000015   000023 600000 1                  TZE     s:5542

      505     5532                /* no way can this be a legal appl id */
      506     5533    2           B$JIT.ERR = ERRBADSCID;

   5533  1 000016   000002 236000 0                  LDQ     ERRBADSCID
         1 000017   000012 756100                    STQ     10,,PR0

      507     5534                /*    ERROR:  KIS-E$BADSCID-A
      508     5535                    MESSAGE:  Bad Session connection identifier.
      509     5536                */
      510     5537    2   SNAP:
      511     5538    2           CALL SC_PRTCL_SNAP;

   5538  1 000020   000000 713400 xsym  SNAP         CLIMB   SC_PRTCL_SNAP
         1 000021   000000 600000 xsid               climb   nvectors=         0

      512     5539    2           ALTRETURN;

   5539  1 000022   000000 702200 xent               TSX2  ! X66_AALT

      513     5540    2           END;
      514     5541            /* see if SPDU is present and reasonable length */
      515     5542    1       CALL HFF$DSIZ( B$PS2$, LEN)

   5542  1 000023   200055 633500                    EPPR3   LEN,,AUTO
         1 000024   200065 453500                    STP3    SCID+3,,AUTO
         1 000025   000000 236000 2                  LDQ     0
PL6.E3A0      #003=KIS$OSI_WRITE File=KIS$OSI.:E05TSI                            WED 07/30/97 00:41 Page:80   
         1 000026   200064 756100                    STQ     SCID+2,,AUTO
         1 000027   200064 630500                    EPPR0   SCID+2,,AUTO
         1 000030   000020 631400 xsym               EPPR1   B_VECTNIL+16
         1 000031   000000 701000 xent               TSX1    HFF$DSIZ
         1 000032   000034 702000 1                  TSX2    BADBUF
         1 000033   000040 710000 1                  TRA     s:5552

      516     5543    2       WHENALTRETURN DO;

      517     5544                /* there's no SPDU present but it's required to be there */
      518     5545    2   BADBUF:
      519     5546    2           B$JIT.ERR = ERRBADOSIBUF;

   5546  1 000034   000000 236000 0     BADBUF       LDQ     ERRBADOSIBUF
         1 000035   000000 470400 xsym               LDP0    B$JIT$
         1 000036   000012 756100                    STQ     10,,PR0

      520     5547                /*E*  ERROR:  KIS-E$BADOSIBUF-A
      521     5548                    MESSAGE:  Write buffer too short or not present at all.
      522     5549                */
      523     5550    2           ALTRETURN;

   5550  1 000037   000000 702200 xent               TSX2  ! X66_AALT

      524     5551    2           END;
      525     5552    1       IF LEN < 4 THEN

   5552  1 000040   200055 235100                    LDA     LEN,,AUTO
         1 000041   000004 115007                    CMPA    4,DL
         1 000042   000034 604000 1                  TMI     BADBUF

      526     5553    1           GOTO BADBUF;
      527     5554    1       K$RWPARM = K_RWPARM_CON;

   5554  1 000043   000100 100400                    MLR     fill='000'O
         1 000044   000000 000234 xsym               ADSC9   K_RWPARM_CON             cn=0,n=156
         1 000045   200004 000234                    ADSC9   K$RWPARM,,AUTO           cn=0,n=156
PL6.E3A0      #003=KIS$OSI_WRITE File=KIS$OSI.:E05TSI                            WED 07/30/97 00:41 Page:81   

      528     5555    1       K$RWPARM.FUNCTION = GLUE.TRNFNC;

   5555  1 000046   000000 470400 xsym               LDP0    B$PS2$
         1 000047   000000 236100                    LDQ     0,,PR0
         1 000050   000022 772000                    QRL     18
         1 000051   000777 376007                    ANQ     511,DL
         1 000052   200024 756100                    STQ     K$RWPARM+16,,AUTO

      529     5556    1       MAJOR$ = PINCRW( KIS_MAJOR$, SCID);

   5556  1 000053   200062 236100                    LDQ     SCID,,AUTO
         1 000054   000022 736000                    QLS     18
         1 000055   000000 036000 xsym               ADLQ    KIS_MAJOR$
         1 000056   200060 756100                    STQ     MAJOR$,,AUTO

      530     5557    2       IF GLUE.TRNFNC ~= %K_TCONNECT_REQ THEN DO;

   5557  1 000057   000000 236100                    LDQ     0,,PR0
         1 000060   000777 376003                    ANQ     511,DU
         1 000061   000025 116003                    CMPQ    21,DU
         1 000062   000103 600000 1                  TZE     s:5572

      531     5558    3           IF MAJOR$->APPL.Z.LINK = 0 THEN DO;

   5558  1 000063   200060 471500                    LDP1    MAJOR$,,AUTO
         1 000064   100000 236100                    LDQ     0,,PR1
         1 000065   000777 316007                    CANQ    511,DL
         1 000066   000073 601000 1                  TNZ     s:5567

      532     5559    3   NOWAY:
      533     5560    3               B$JIT.ERR = ERRTRANCLOSED;

   5560  1 000067   000004 236000 0     NOWAY        LDQ     ERRTRANCLOSED
         1 000070   000000 470400 xsym               LDP0    B$JIT$
         1 000071   000012 756100                    STQ     10,,PR0

PL6.E3A0      #003=KIS$OSI_WRITE File=KIS$OSI.:E05TSI                            WED 07/30/97 00:41 Page:82   
      534     5561                    /*E*  ERROR:  KIS-E$TRANCLOSED-A
      535     5562                        MESSAGE:  Transport connection doesn't exist.
      536     5563                    */
      537     5564    3               ALTRETURN;

   5564  1 000072   000000 702200 xent               TSX2  ! X66_AALT

      538     5565    3               END;
      539     5566    3           ELSE DO;

      540     5567    3               MINOR$ = PINCRW( KIS_MINOR$, MAJOR$->APPL.Z.LINK);

   5567  1 000073   100000 720100                    LXL0    0,,PR1
         1 000074   000777 360003                    ANX0    511,DU
         1 000075   000000 636010                    EAQ     0,X0
         1 000076   000000 036000 xsym               ADLQ    KIS_MINOR$
         1 000077   200061 756100                    STQ     MINOR$,,AUTO

      541     5568    3               IF MINOR$->APPL.TCTX = 0 THEN

   5568  1 000100   200061 473500                    LDP3    MINOR$,,AUTO
         1 000101   300000 221100                    LDX1    0,,PR3
         1 000102   000067 600000 1                  TZE     NOWAY

      542     5569    3                   GOTO NOWAY;
      543     5570    3               END;

      544     5571    2           END;

      545     5572    2       DO CASE( GLUE.TRNFNC);

   5572  1 000103   000000 236100                    LDQ     0,,PR0
         1 000104   000022 772000                    QRL     18
         1 000105   000777 376007                    ANQ     511,DL
         1 000106   000025 136007                    SBLQ    21,DL
         1 000107   000005 116007                    CMPQ    5,DL
         1 000110   000112 602006 1                  TNC     s:5572+7,QL
PL6.E3A0      #003=KIS$OSI_WRITE File=KIS$OSI.:E05TSI                            WED 07/30/97 00:41 Page:83   
         1 000111   000227 710000 1                  TRA     s:5635
         1 000112   000117 710000 1                  TRA     s:5575
         1 000113   000227 710000 1                  TRA     s:5635
         1 000114   000222 710000 1                  TRA     s:5631
         1 000115   000222 710000 1                  TRA     s:5631
         1 000116   000210 710000 1                  TRA     s:5618

      546     5573    2           CASE( %K_TCONNECT_REQ);

      547     5574                    /* this is a T-CONNECT Request */
      548     5575    3               IF LEN - 4 ~= SIZEC( K$FPT_CONNECT_OSI) THEN DO;

   5575  1 000117   000220 115007                    CMPA    144,DL
         1 000120   000125 600000 1                  TZE     s:5583

      549     5576    3                   B$JIT.ERR = ERRBADOSIFPT;

   5576  1 000121   000001 236000 0                  LDQ     ERRBADOSIFPT
         1 000122   000000 471400 xsym               LDP1    B$JIT$
         1 000123   100012 756100                    STQ     10,,PR1

      550     5577                        /*E*  ERROR:  KIS-E$BADOSIFPT-A
      551     5578                            MESSAGE:  Write buffer contains malformed Transport FPT.
      552     5579                        */
      553     5580    3                   GOTO SNAP;

   5580  1 000124   000020 710000 1                  TRA     SNAP

      554     5581    3                   END;
      555     5582                    /* point at the K$FPT_CONNECT_OSI */
      556     5583    2               K$RWPARM.FPT$ = ADDR( GLUE.DATA);

   5583  1 000125   000000 236000 xsym               LDQ     B$PS2$
         1 000126   000001 036003                    ADLQ    1,DU
         1 000127   200023 756100                    STQ     K$RWPARM+15,,AUTO

      557     5584    2               MINOR$ = ADDR( NIL);
PL6.E3A0      #003=KIS$OSI_WRITE File=KIS$OSI.:E05TSI                            WED 07/30/97 00:41 Page:84   

   5584  1 000130   000001 236000 xsym               LDQ     B_VECTNIL+1
         1 000131   200061 756100                    STQ     MINOR$,,AUTO

      558     5585    2               LINK = MAJOR$->APPL.Z.LINK;

   5585  1 000132   200060 471500                    LDP1    MAJOR$,,AUTO
         1 000133   100000 236100                    LDQ     0,,PR1
         1 000134   000777 376007                    ANQ     511,DL
         1 000135   200057 756100                    STQ     LINK,,AUTO

      559     5586    3               IF LINK ~= 0 THEN DO;

   5586  1 000136   000151 600000 1                  TZE     s:5598

      560     5587    3                   MINOR$ = PINCRW( KIS_MINOR$, LINK);

   5587  1 000137   000022 736000                    QLS     18
         1 000140   000000 036000 xsym               ADLQ    KIS_MINOR$
         1 000141   200061 756100                    STQ     MINOR$,,AUTO

      561     5588    4                   IF MINOR$->APPL.TCTX ~= 0 THEN DO;

   5588  1 000142   200061 473500                    LDP3    MINOR$,,AUTO
         1 000143   300000 220100                    LDX0    0,,PR3
         1 000144   000151 600000 1                  TZE     s:5598

      562     5589                            /* would overlay an existing Transport connection */
      563     5590    4                       B$JIT.ERR = ERRTRANOPEN;

   5590  1 000145   000005 236000 0                  LDQ     ERRTRANOPEN
         1 000146   000000 474400 xsym               LDP4    B$JIT$
         1 000147   400012 756100                    STQ     10,,PR4

      564     5591                            /*E*  ERROR:  KIS-E$TRANOPEN-A
      565     5592                                MESSAGE:  Transport connection already exists.
      566     5593                            */
PL6.E3A0      #003=KIS$OSI_WRITE File=KIS$OSI.:E05TSI                            WED 07/30/97 00:41 Page:85   
      567     5594    4                       GOTO SNAP;

   5594  1 000150   000020 710000 1                  TRA     SNAP

      568     5595    4                       END;
      569     5596    3                   END;
      570     5597                    /* allocate a minor client slot for this connection */
      571     5598    3               IF MINOR$ = ADDR( NIL) THEN DO;

   5598  1 000151   200061 236100                    LDQ     MINOR$,,AUTO
         1 000152   000001 116000 xsym               CMPQ    B_VECTNIL+1
         1 000153   000173 601000 1                  TNZ     s:5611

      572     5599    3                   LINK = KIS_MINOR$->APPL.Z.LINK;

   5599  1 000154   000000 473400 xsym               LDP3    KIS_MINOR$
         1 000155   300000 236100                    LDQ     0,,PR3
         1 000156   000777 376007                    ANQ     511,DL
         1 000157   200057 756100                    STQ     LINK,,AUTO

      573     5600    4                   IF LINK = 0 THEN DO;

   5600  1 000160   000165 601000 1                  TNZ     s:5608

      574     5601                            /* all minor client slots are in use */
      575     5602    4                       B$JIT.ERR = ERRMINORTBL;

   5602  1 000161   000003 236000 0                  LDQ     ERRMINORTBL
         1 000162   000000 474400 xsym               LDP4    B$JIT$
         1 000163   400012 756100                    STQ     10,,PR4

      576     5603                            /*E*  ERROR:  KIS-E$MINORTBL-A
      577     5604                            MESSAGE: No more space in the 'minor' Session connection table.
      578     5605                            */
      579     5606    4                       ALTRETURN;

   5606  1 000164   000000 702200 xent               TSX2  ! X66_AALT
PL6.E3A0      #003=KIS$OSI_WRITE File=KIS$OSI.:E05TSI                            WED 07/30/97 00:41 Page:86   

      580     5607    4                       END;
      581     5608    3                   MINOR$ = PINCRW( KIS_MINOR$, LINK);

   5608  1 000165   000022 736000                    QLS     18
         1 000166   000000 036000 xsym               ADLQ    KIS_MINOR$
         1 000167   200061 756100                    STQ     MINOR$,,AUTO

      582     5609    3                   KIS_MINOR$->APPL.Z.LINK = MINOR$->APPL.Z.LINK;

   5609  1 000170   200061 474500                    LDP4    MINOR$,,AUTO
         1 000171   400000 236100                    LDQ     0,,PR4
         1 000172   300000 552104                    STBQ    0,'04'O,PR3

      583     5610    3                   END;

      584     5611    2               MINOR$->APPL.TCTX = 0;

   5611  1 000173   000000 220003                    LDX0    0,DU
         1 000174   200061 470500                    LDP0    MINOR$,,AUTO
         1 000175   000000 740100                    STX0    0,,PR0

      585     5612    2               MINOR$->APPL.Z.LINK = 0;

   5612  1 000176   000000 236003                    LDQ     0,DU
         1 000177   000000 552104                    STBQ    0,'04'O,PR0

      586     5613    2               MAJOR$->APPL.Z.LINK = LINK;

   5613  1 000200   200057 236100                    LDQ     LINK,,AUTO
         1 000201   100000 552104                    STBQ    0,'04'O,PR1

      587     5614                    /* make sure complete SCID is present in FPT */
      588     5615    2               K$RWPARM.FPT$->K$FPT_CONNECT_OSI.SCID = SCID * 512 + LINK;

   5615  1 000202   200062 236100                    LDQ     SCID,,AUTO
         1 000203   000011 736000                    QLS     9
PL6.E3A0      #003=KIS$OSI_WRITE File=KIS$OSI.:E05TSI                            WED 07/30/97 00:41 Page:87   
         1 000204   200057 036100                    ADLQ    LINK,,AUTO
         1 000205   200023 473500                    LDP3    K$RWPARM+15,,AUTO
         1 000206   300005 756100                    STQ     5,,PR3
         1 000207   000227 710000 1                  TRA     s:5635

      589     5616    2           CASE( %K_TDISCONNECT_REQ);

      590     5617                    /* this is a T-DISCONNECT Request */
      591     5618    3               IF LEN - 4 ~= SIZEC( K$FPT_TERM_OSI) THEN DO;

   5618  1 000210   000174 115007                    CMPA    124,DL
         1 000211   000216 600000 1                  TZE     s:5626

      592     5619    3                   B$JIT.ERR = ERRBADOSIFPT;

   5619  1 000212   000001 236000 0                  LDQ     ERRBADOSIFPT
         1 000213   000000 471400 xsym               LDP1    B$JIT$
         1 000214   100012 756100                    STQ     10,,PR1

      593     5620                        /*    ERROR:  KIS-E$BADOSIFPT-A
      594     5621                            MESSAGE:  Write buffer contains malformed Transport FPT.
      595     5622                        */
      596     5623    3                   GOTO SNAP;

   5623  1 000215   000020 710000 1                  TRA     SNAP

      597     5624    3                   END;
      598     5625                    /* point at the K$FPT_TERM_OSI */
      599     5626    2               K$RWPARM.FPT$ = ADDR( GLUE.DATA);

   5626  1 000216   000000 236000 xsym               LDQ     B$PS2$
         1 000217   000001 036003                    ADLQ    1,DU
         1 000220   200023 756100                    STQ     K$RWPARM+15,,AUTO
         1 000221   000227 710000 1                  TRA     s:5635

      600     5627    2           CASE( %K_TDATA_REQ,

PL6.E3A0      #003=KIS$OSI_WRITE File=KIS$OSI.:E05TSI                            WED 07/30/97 00:41 Page:88   
      601     5628    2                 %K_TEXPD_DATA_REQ);
      602     5629                    /* this is a T-DATA Request or a T-EXPEDITED-DATA Request */
      603     5630                    /* frame the SPDU to send */
      604     5631    2               K$RWPARM.SHDR$ = ADDR( GLUE.DATA);

   5631  1 000222   000000 236000 xsym               LDQ     B$PS2$
         1 000223   000001 036003                    ADLQ    1,DU
         1 000224   200026 756100                    STQ     K$RWPARM+18,,AUTO

      605     5632    2               K$RWPARM.SHDRSZ = LEN - 4;

   5632  1 000225   000004 135007                    SBLA    4,DL
         1 000226   200027 755100                    STA     K$RWPARM+19,,AUTO

      606     5633    2           END;

      607     5634            /* point at the correct major client slot */
      608     5635    1       MAJOR$ = PINCRW( KIS_MAJOR$, SCID);

   5635  1 000227   200062 236100                    LDQ     SCID,,AUTO
         1 000230   000022 736000                    QLS     18
         1 000231   000000 036000 xsym               ADLQ    KIS_MAJOR$
         1 000232   200060 756100                    STQ     MAJOR$,,AUTO

      609     5636            /* get the Transport connection id */
      610     5637    1       K$RWPARM.TCTX# = MINOR$->APPL.TCTX;

   5637  1 000233   200061 470500                    LDP0    MINOR$,,AUTO
         1 000234   000000 220100                    LDX0    0,,PR0
         1 000235   200037 740100                    STX0    K$RWPARM+27,,AUTO

      611     5638            /* send the mess to Transport */
      612     5639    1       LDCT$ = NK$LDCT$( F$DCB.LDCTX);

   5639  1 000236   200054 471500                    LDP1    JDCB$,,AUTO
         1 000237   100051 221100                    LDX1    41,,PR1
         1 000240   000000 473400 xsym               LDP3    N$DCT$$
PL6.E3A0      #003=KIS$OSI_WRITE File=KIS$OSI.:E05TSI                            WED 07/30/97 00:41 Page:89   
         1 000241   300000 236111                    LDQ     0,X1,PR3
         1 000242   200056 756100                    STQ     LDCT$,,AUTO

      613     5640            %LOCK( G=NK$LDCT.LOCK);

   5641  1 000243   000020 036003                    ADLQ    16,DU
         1 000244   200064 756100                    STQ     SCID+2,,AUTO
         1 000245   200064 630500                    EPPR0   SCID+2,,AUTO
         1 000246   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 000247   000000 701000 xent               TSX1    HFC$LOCK
         1 000250   000000 011000                    NOP     0

      614     5643    1   TRYSEND:
      615     5644    1       CALL KIT$SEND( K$RWPARM)

   5644  1 000251   200004 630500       TRYSEND      EPPR0   K$RWPARM,,AUTO
         1 000252   200064 450500                    STP0    SCID+2,,AUTO
         1 000253   200064 630500                    EPPR0   SCID+2,,AUTO
         1 000254   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 000255   000000 701000 xent               TSX1    KIT$SEND
         1 000256   000267 702000 1                  TSX2    s:5652

      616     5645    2       WHENRETURN DO;

      617     5646                %UNLOCK( G=NK$LDCT.LOCK);

   5647  1 000257   200056 236100                    LDQ     LDCT$,,AUTO
         1 000260   000020 036003                    ADLQ    16,DU
         1 000261   200064 756100                    STQ     SCID+2,,AUTO
         1 000262   200064 630500                    EPPR0   SCID+2,,AUTO
         1 000263   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 000264   000000 701000 xent               TSX1    HFC$UNLOCK
         1 000265   000000 011000                    NOP     0

      618     5649    2           END;

   5649  1 000266   000332 710000 1                  TRA     s:5678
PL6.E3A0      #003=KIS$OSI_WRITE File=KIS$OSI.:E05TSI                            WED 07/30/97 00:41 Page:90   

      619     5650    2       WHENALTRETURN DO;

      620     5651                /* the Transport layer couldn't handle the message */
      621     5652    3           IF K$RWPARM.ERR = %K$QFULL THEN DO;

   5652  1 000267   200017 235100                    LDA     K$RWPARM+11,,AUTO
         1 000270   000001 115007                    CMPA    1,DL
         1 000271   000310 601000 1                  TNZ     s:5663

      622     5653    3               CALL KIA$OQFL( NK$LDCT)

   5653  1 000272   200056 630500                    EPPR0   LDCT$,,AUTO
         1 000273   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 000274   000000 701000 xent               TSX1    KIA$OQFL
         1 000275   000277 702000 1                  TSX2    s:5656
         1 000276   000307 710000 1                  TRA     s:5660

      623     5654    4               WHENALTRETURN DO;

      624     5655                        %UNLOCK( G=NK$LDCT.LOCK);

   5656  1 000277   200056 236100                    LDQ     LDCT$,,AUTO
         1 000300   000020 036003                    ADLQ    16,DU
         1 000301   200064 756100                    STQ     SCID+2,,AUTO
         1 000302   200064 630500                    EPPR0   SCID+2,,AUTO
         1 000303   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 000304   000000 701000 xent               TSX1    HFC$UNLOCK
         1 000305   000000 011000                    NOP     0

      625     5658    4                   GOTO SNAP;

   5658  1 000306   000020 710000 1                  TRA     SNAP

      626     5659    4                   END;
      627     5660    3               GOTO TRYSEND;

PL6.E3A0      #003=KIS$OSI_WRITE File=KIS$OSI.:E05TSI                            WED 07/30/97 00:41 Page:91   
   5660  1 000307   000251 710000 1                  TRA     TRYSEND

      628     5661    3               END;
      629     5662                %UNLOCK( G=NK$LDCT.LOCK);

   5663  1 000310   200056 236100                    LDQ     LDCT$,,AUTO
         1 000311   000020 036003                    ADLQ    16,DU
         1 000312   200064 756100                    STQ     SCID+2,,AUTO
         1 000313   200064 630500                    EPPR0   SCID+2,,AUTO
         1 000314   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 000315   000000 701000 xent               TSX1    HFC$UNLOCK
         1 000316   000000 011000                    NOP     0

      630     5665    3           IF K$RWPARM.ERR = %K$USER_ERR THEN DO;

   5665  1 000317   200017 235100                    LDA     K$RWPARM+11,,AUTO
         1 000320   000010 115007                    CMPA    8,DL
         1 000321   000326 601000 1                  TNZ     s:5670

      631     5666    3               B$JIT.ERR = K$RWPARM.MSG_ERRCODE;

   5666  1 000322   200043 236100                    LDQ     K$RWPARM+31,,AUTO
         1 000323   000000 470400 xsym               LDP0    B$JIT$
         1 000324   000012 756100                    STQ     10,,PR0

      632     5667    3               ALTRETURN;

   5667  1 000325   000000 702200 xent               TSX2  ! X66_AALT

      633     5668    3               END;
      634     5669    3           ELSE DO;

      635     5670    3               B$JIT.ERR = ERRTRANSPORT;

   5670  1 000326   000006 236000 0                  LDQ     ERRTRANSPORT
         1 000327   000000 470400 xsym               LDP0    B$JIT$
         1 000330   000012 756100                    STQ     10,,PR0
PL6.E3A0      #003=KIS$OSI_WRITE File=KIS$OSI.:E05TSI                            WED 07/30/97 00:41 Page:92   

      636     5671                    /*    ERROR:  KIS-E$TRANSPORT-A
      637     5672                        MESSAGE:  Internal error.  Transport ALTRETURN.
      638     5673                    */
      639     5674    3               GOTO SNAP;

   5674  1 000331   000020 710000 1                  TRA     SNAP

      640     5675    3               END;
      641     5676    2           END;
      642     5677            /* Omigosh, it worked */
      643     5678    2       IF GLUE.TRNFNC = %K_TCONNECT_REQ THEN DO;

   5678  1 000332   000000 470400 xsym               LDP0    B$PS2$
         1 000333   000000 236100                    LDQ     0,,PR0
         1 000334   000777 376003                    ANQ     511,DU
         1 000335   000025 116003                    CMPQ    21,DU
         1 000336   000346 601000 1                  TNZ     s:5682

      644     5679    2           MINOR$->APPL.TCTX = K$RWPARM.TCTX#;

   5679  1 000337   200037 220100                    LDX0    K$RWPARM+27,,AUTO
         1 000340   200061 471500                    LDP1    MINOR$,,AUTO
         1 000341   100000 740100                    STX0    0,,PR1

      645     5680    2           MINOR$->APPL.Z.COOKIE = GLUE.MYSCID;

   5680  1 000342   000000 470400 xsym               LDP0    B$PS2$
         1 000343   000000 236100                    LDQ     0,,PR0
         1 000344   000022 772000                    QRL     18
         1 000345   100000 552110                    STBQ    0,'10'O,PR1

      646     5681    2           END;

      647     5682    1       RETURN;

   5682  1 000346   000000 702200 xent               TSX2  ! X66_ARET
PL6.E3A0      #003=KIS$OSI_WRITE File=KIS$OSI.:E05TSI                            WED 07/30/97 00:41 Page:93   

ERRBADOSIBUF
 Sect OctLoc
   0     000   131123 431477                                                    YS..

ERRBADOSIFPT
 Sect OctLoc
   0     001   131123 431507                                                    YS..

ERRBADSCID
 Sect OctLoc
   0     002   131123 431407                                                    YS..

ERRMINORTBL
 Sect OctLoc
   0     003   131123 431327                                                    YS..

ERRTRANCLOSED
 Sect OctLoc
   0     004   131123 431437                                                    YS..

ERRTRANOPEN
 Sect OctLoc
   0     005   131123 431447                                                    YS..

ERRTRANSPORT
 Sect OctLoc
   0     006   131123 431457                                                    YS..

(unnamed)
 Sect OctLoc
   2     000   000000 006000                                                    ....
      648     5683
      649     5684    1       END KIS$OSI_WRITE;
      650     5685        %EOD;

PL6.E3A0      #003=KIS$OSI_WRITE File=KIS$OSI.:E05TSI                            WED 07/30/97 00:41 Page:94   
--  Include file information  --

   F$DCB.:E05TOU  is referenced.
   UM_CP6.:E05TOU  is referenced.
   NK$LDCT.:E05TOU  is referenced.
   NK_LDCT_R.:E05TOU  cannot be made into a system file and is referenced.
   K_SUBS_C.:E05TOU  is referenced.
   K_SESSION_M.:E05TOU  is referenced.
   K_INTERFACE_M.:E05TOU  is referenced.
   K$RWPARM.:E05TOU  is referenced.
   K_DATA_R.:E05TOU  cannot be made into a system file and is referenced.
   K_ADDRESS_M.:E05TOU  is referenced.
   KI_ERRORS_C.:E05TOU  is referenced.
   HF_LOCK_C.:E05TOU  cannot be made into a system file and is referenced.
   B$JIT_C.:E05TOU  is referenced.
   F$JIT_C.:E05TOU  cannot be made into a system file and is referenced.
   F$CP6V_C.:E05TOU  is referenced.
   CP_6_SUBS.:E05TOU  is referenced.
      No diagnostics issued in procedure KIS$OSI_WRITE.
PL6.E3A0      #003=KIS$OSI_WRITE File=KIS$OSI.:E05TSI                            WED 07/30/97 00:41 Page:95   

 **** Variables and constants ****

  ****  Section 000 RoData KIS$OSI_WRITE

  ****  Scalars and arrays  ****
OctLoc.c.b A Datatyp(siz) R M Lvl/name                 OctLoc.c.b A Datatyp(siz) R M Lvl/name

     0-0-0/w STRC        r     1 ERRBADOSIBUF               1-0-0/w STRC        r     1 ERRBADOSIFPT
     2-0-0/w STRC        r     1 ERRBADSCID                 3-0-0/w STRC        r     1 ERRMINORTBL
     4-0-0/w STRC        r     1 ERRTRANCLOSED              5-0-0/w STRC        r     1 ERRTRANOPEN
     6-0-0/w STRC        r     1 ERRTRANSPORT

  ****  Auto variables  ****

  ****  Scalars and arrays  ****
OctLoc.c.b A Datatyp(siz) R M Lvl/name                 OctLoc.c.b A Datatyp(siz) R M Lvl/name

    54-0-0/w PTR         r     1 JDCB$                      4-0-0/d STRC(1404)  r     1 K$RWPARM
    56-0-0/w PTR         r     1 LDCT$                     55-0-0/w SBIN        r     1 LEN
    57-0-0/w SBIN        r     1 LINK                      60-0-0/w PTR         r     1 MAJOR$
    61-0-0/w PTR         r     1 MINOR$                    62-0-0/w SBIN        r     1 SCID

  ****  SYMREF variables  ****

  ****  Scalars and arrays  ****
OctLoc.c.b A Datatyp(siz) R M Lvl/name                 OctLoc.c.b A Datatyp(siz) R M Lvl/name

     0-0-0/w PTR         r     1 B$JIT$                     0-0-0/w PTR         r     1 B$PS0$
     0-0-0/w PTR         r     1 B$PS2$                     0-0-0/w PTR         r     1 KIS_MAJOR$
     0-0-0/w PTR         r     1 KIS_MINOR$                 0-0-0/w UBIN        r     1 KIS_SSN_MAXMAJOR
     0-0-0/d STRC(1404)  r     1 K_RWPARM_CON               0-0-0/w PTR         r     1 N$DCT$$

  ****  BASED and DCB variables  ****

  ****  Scalars and arrays  ****
OctLoc.c.b A Datatyp(siz) R M Lvl/name                 OctLoc.c.b A Datatyp(siz) R M Lvl/name

PL6.E3A0      #003=KIS$OSI_WRITE File=KIS$OSI.:E05TSI                            WED 07/30/97 00:41 Page:96   
     0-0-0/w STRC(360)   r     1 APPL                       0-0-0/d STRC(8856)  r     1 B$JIT
     0-0-0/d ASTR(3528)  r     1 F$DCB                      0-0-0/w STRC(72)    r     1 GLUE
     0-0-0/w STRC(1260)  r     1 K$FPT_CONNECT_OSI          0-0-0/w STRC(1080)  r     1 K$FPT_TERM_OSI
     0-0-0/d STRC(864)   r     1 NK$LDCT
     0-0-0/w PTR         r     1 NK$LDCT$(0:0)


   Procedure KIS$OSI_WRITE requires 231 words for executable code.
   Procedure KIS$OSI_WRITE requires 54 words of local(AUTO) storage.
PL6.E3A0      #003=KIS$OSI_WRITE File=KIS$OSI.:E05TSI                            WED 07/30/97 00:41 Page:97   
          *** CROSS REFERENCE LISTING ***
**     DENOTES     IDENTIFIER DEFINITION
<<                 IDENTIFIER'S VALUE SET
>>                 IDENTIFIER'S VALUE USED
<>                 IDENTIFIER SET AND/OR USED
--                 IDENTIFIER REFERENCED
PL6.E3A0      #003=KIS$OSI_WRITE File=KIS$OSI.:E05TSI                            WED 07/30/97 00:41 Page:98   
          MINI XREF LISTING

APPL.CLNTHD
      3952**DCL      3953--REDEF
APPL.TCTX
      3949**DCL      3950--REDEF    3951--REDEF    5568>>IF       5588>>IF       5611<<ASSIGN   5637>>ASSIGN
      5679<<ASSIGN
APPL.Z.COOKIE
      3954**DCL      3955--REDEF    5680<<ASSIGN
APPL.Z.LINK
      3956**DCL      5558>>IF       5567>>ASSIGN   5585>>ASSIGN   5599>>ASSIGN   5609<<ASSIGN   5609>>ASSIGN
      5612<<ASSIGN   5613<<ASSIGN
B$JIT.DCB$
      1229**DCL      5528>>ASSIGN
B$JIT.ERR
      1139**DCL      5533<<ASSIGN   5546<<ASSIGN   5560<<ASSIGN   5576<<ASSIGN   5590<<ASSIGN   5602<<ASSIGN
      5619<<ASSIGN   5666<<ASSIGN   5670<<ASSIGN
B$JIT.ERR.MID
      1140**DCL      1140--REDEF
B$JIT$
      5513**DCL      1134--IMP-PTR  5528>>ASSIGN   5533>>ASSIGN   5546>>ASSIGN   5560>>ASSIGN   5576>>ASSIGN
      5590>>ASSIGN   5602>>ASSIGN   5619>>ASSIGN   5666>>ASSIGN   5670>>ASSIGN
B$PS0$
      5514**DCL       807--IMP-PTR
B$PS2$
      5515**DCL      4011--IMP-PTR  5542<>CALL     5555>>ASSIGN   5557>>IF       5572>>DOCASE   5583>>ASSIGN
      5626>>ASSIGN   5631>>ASSIGN   5678>>IF       5680>>ASSIGN
BADBUF
      5546**LABEL    5553--GOTO
ERRBADOSIBUF
      5084**DCL      5546>>ASSIGN
ERRBADOSIFPT
      5132**DCL      5576>>ASSIGN   5619>>ASSIGN
ERRBADSCID
PL6.E3A0      #003=KIS$OSI_WRITE File=KIS$OSI.:E05TSI                            WED 07/30/97 00:41 Page:99   
      5180**DCL      5533>>ASSIGN
ERRMINORTBL
      5228**DCL      5602>>ASSIGN
ERRTRANCLOSED
      5276**DCL      5560>>ASSIGN
ERRTRANOPEN
      5324**DCL      5590>>ASSIGN
ERRTRANSPORT
      5372**DCL      5670>>ASSIGN
F$DCB.ACTPOS
      5483**DCL      5483--REDEF
F$DCB.ARS
      5458**DCL      5458--REDEF
F$DCB.ATTR
      5476**DCL      5477--REDEF
F$DCB.BORROW
      5491**DCL      5491--REDEF    5491--REDEF    5491--REDEF
F$DCB.DCBNAME.L
      5505**DCL      5505--IMP-SIZ
F$DCB.DVFC
      5479**DCL      5530>>ASSIGN
F$DCB.EOMCHAR
      5462**DCL      5462--REDEF
F$DCB.FLDID
      5486**DCL      5486--REDEF
F$DCB.FORM$
      5480**DCL      5480--REDEF
F$DCB.FSECT
      5496**DCL      5496--REDEF
F$DCB.FSN
      5473**DCL      5473--REDEF    5473--REDEF    5474--REDEF
F$DCB.HEADER$
      5479**DCL      5479--REDEF
F$DCB.IXTNSIZE
      5477**DCL      5477--REDEF
F$DCB.LASTSTA$
PL6.E3A0      #003=KIS$OSI_WRITE File=KIS$OSI.:E05TSI                            WED 07/30/97 00:41 Page:100  
      5467**DCL      5467--REDEF
F$DCB.LDCTX
      5480**DCL      5639>>ASSIGN
F$DCB.LVL
      5492**DCL      5492--REDEF
F$DCB.NAME.C
      5467**DCL      5467--REDEF
F$DCB.NOEOF
      5488**DCL      5488--REDEF
F$DCB.NRECS
      5478**DCL      5478--REDEF
F$DCB.NRECX
      5497**DCL      5497--REDEF
F$DCB.OHDR
      5489**DCL      5489--REDEF
F$DCB.ORG
      5472**DCL      5472--REDEF
F$DCB.PRECNO
      5495**DCL      5495--REDEF
F$DCB.RCSZ
      5500**DCL      5500--REDEF
F$DCB.RES
      5468**DCL      5468--REDEF
F$DCB.SETX
      5480**DCL      5480--REDEF
F$DCB.TAB$
      5479**DCL      5480--REDEF
F$DCB.TDA
      5494**DCL      5494--REDEF
F$DCB.WSN
      5469**DCL      5469--REDEF
FPT$WRITE_V.DVBYTE.VFC
       809**DCL       809--REDEF
GLUE.DATA
      4022**DCL      5583--ASSIGN   5626--ASSIGN   5631--ASSIGN
GLUE.MYSCID
PL6.E3A0      #003=KIS$OSI_WRITE File=KIS$OSI.:E05TSI                            WED 07/30/97 00:41 Page:101  
      4018**DCL      5680>>ASSIGN
GLUE.TRNFNC
      4019**DCL      5555>>ASSIGN   5557>>IF       5572>>DOCASE   5678>>IF
HFC$LOCK
      1255**DCL-ENT  5641--CALL
HFC$UNLOCK
      1255**DCL-ENT  5647--CALL     5656--CALL     5663--CALL
HFF$DSIZ
      5510**DCL-ENT  5542--CALL
JDCB$
      5520**DCL      5458--IMP-PTR  5528<<ASSIGN   5530>>ASSIGN   5639>>ASSIGN
K$FPT_CONNECT_OSI
      3297**DCL      5575--IF
K$FPT_CONNECT_OSI.DST_NSAP.ADDRESS_N
      3603**DCL      3604--REDEF
K$FPT_CONNECT_OSI.SCID
      3407**DCL      5615<<ASSIGN
K$FPT_CONNECT_OSI.SRC_NSAP.ADDRESS_N
      3543**DCL      3544--REDEF
K$FPT_CONNECT_OSI.TPDUSIZE
      3306**DCL      3307--REDEF
K$FPT_TERM_OSI
      3633**DCL      5618--IF
K$FPT_TERM_OSI.DST_NSAP.ADDRESS_N
      3825**DCL      3826--REDEF
K$FPT_TERM_OSI.SRC_NSAP.ADDRESS_N
      3768**DCL      3769--REDEF
K$RWPARM
      2576**DCL      5554<<ASSIGN   5644<>CALL
K$RWPARM.BLKREC
      2602**DCL      2627--REDEF
K$RWPARM.BLKREC.BLKU#
      2603**DCL      2605--REDEF
K$RWPARM.BLKREC.RECU#
      2615**DCL      2617--REDEF
K$RWPARM.DVE.DVBYTE.VFC
PL6.E3A0      #003=KIS$OSI_WRITE File=KIS$OSI.:E05TSI                            WED 07/30/97 00:41 Page:102  
      2642**DCL      2643--REDEF
K$RWPARM.DVE.EOMCHAR
      2650**DCL      2654--REDEF
K$RWPARM.ERR
      2714**DCL      2719--REDEF    5652>>IF       5665>>IF
K$RWPARM.FC
      2678**DCL      2679--REDEF
K$RWPARM.FLDID
      2860**DCL      2861--REDEF
K$RWPARM.FPT$
      2741**DCL      2748--REDEF    5583<<ASSIGN   5615>>ASSIGN   5626<<ASSIGN
K$RWPARM.FUNCTION
      2755**DCL      5555<<ASSIGN
K$RWPARM.KEYTYPE
      2867**DCL      2868--REDEF
K$RWPARM.MSG$
      2577**DCL      2583--REDEF
K$RWPARM.MSGID
      2689**DCL      2694--REDEF
K$RWPARM.MSGIDXT
      2702**DCL      2706--REDEF
K$RWPARM.MSG_ERRCODE
      2837**DCL      5666>>ASSIGN
K$RWPARM.ORG
      2838**DCL      2839--REDEF
K$RWPARM.SHDR$
      2770**DCL      5631<<ASSIGN
K$RWPARM.SHDRSZ
      2774**DCL      5632<<ASSIGN
K$RWPARM.TCTX#
      2812**DCL      5637<<ASSIGN   5679>>ASSIGN
K$RWPARM.THDRSZ
      2782**DCL      2786--REDEF
K$RWPARM.VDOFLGS
      2840**DCL      2851--REDEF
KIA$OQFL
PL6.E3A0      #003=KIS$OSI_WRITE File=KIS$OSI.:E05TSI                            WED 07/30/97 00:41 Page:103  
      5508**DCL-ENT  5653--CALL
KIS_MAJOR$
      5516**DCL      5556>>ASSIGN   5635>>ASSIGN
KIS_MINOR$
      5517**DCL      5567>>ASSIGN   5587>>ASSIGN   5599>>ASSIGN   5608>>ASSIGN   5609>>ASSIGN
KIS_SSN_MAXMAJOR
      5518**DCL      5531>>IF
KIT$SEND
      5509**DCL-ENT  5644--CALL
K_RWPARM_CON
      2259**DCL      5554>>ASSIGN
K_RWPARM_CON.BLKREC
      2285**DCL      2310--REDEF
K_RWPARM_CON.BLKREC.BLKU#
      2286**DCL      2288--REDEF
K_RWPARM_CON.BLKREC.RECU#
      2298**DCL      2300--REDEF
K_RWPARM_CON.DVE.DVBYTE.VFC
      2325**DCL      2326--REDEF
K_RWPARM_CON.DVE.EOMCHAR
      2333**DCL      2337--REDEF
K_RWPARM_CON.ERR
      2397**DCL      2402--REDEF
K_RWPARM_CON.FC
      2361**DCL      2362--REDEF
K_RWPARM_CON.FLDID
      2543**DCL      2544--REDEF
K_RWPARM_CON.FPT$
      2424**DCL      2431--REDEF
K_RWPARM_CON.KEYTYPE
      2550**DCL      2551--REDEF
K_RWPARM_CON.MSG$
      2260**DCL      2266--REDEF
K_RWPARM_CON.MSGID
      2372**DCL      2377--REDEF
K_RWPARM_CON.MSGIDXT
PL6.E3A0      #003=KIS$OSI_WRITE File=KIS$OSI.:E05TSI                            WED 07/30/97 00:41 Page:104  
      2385**DCL      2389--REDEF
K_RWPARM_CON.ORG
      2521**DCL      2522--REDEF
K_RWPARM_CON.THDRSZ
      2465**DCL      2469--REDEF
K_RWPARM_CON.VDOFLGS
      2523**DCL      2534--REDEF
LDCT$
      5522**DCL      4181--IMP-PTR  5639<<ASSIGN   5641>>CALL     5647>>CALL     5653>>CALL     5656>>CALL
      5663>>CALL
LEN
      5521**DCL      5542<>CALL     5552>>IF       5575>>IF       5618>>IF       5632>>ASSIGN
LINK
      5523**DCL      5585<<ASSIGN   5586>>IF       5587>>ASSIGN   5599<<ASSIGN   5600>>IF       5608>>ASSIGN
      5613>>ASSIGN   5615>>ASSIGN
MAJOR$
      5524**DCL      5556<<ASSIGN   5558>>IF       5567>>ASSIGN   5585>>ASSIGN   5613>>ASSIGN   5635<<ASSIGN
MINOR$
      5525**DCL      5567<<ASSIGN   5568>>IF       5584<<ASSIGN   5587<<ASSIGN   5588>>IF       5598>>IF
      5608<<ASSIGN   5609>>ASSIGN   5611>>ASSIGN   5612>>ASSIGN   5637>>ASSIGN   5679>>ASSIGN   5680>>ASSIGN
N$DCT$$
      4064**DCL      4064--IMP-PTR  5639>>ASSIGN
NK$LDCT
      4181**DCL      5653<>CALL
NK$LDCT.DDT$
      4183**DCL      4183--REDEF
NK$LDCT.IOQ$
      4182**DCL      4183--REDEF
NK$LDCT.LDCTX
      4184**DCL      4184--REDEF
NK$LDCT.LKFLG.ABORTED
      4196**DCL      4197--REDEF
NK$LDCT.LOCK
      4209**DCL      5641<>CALL     5647<>CALL     5656<>CALL     5663<>CALL
NK$LDCT.RLCID.LDCTX
      4206**DCL      4206--REDEF
PL6.E3A0      #003=KIS$OSI_WRITE File=KIS$OSI.:E05TSI                            WED 07/30/97 00:41 Page:105  
NK$LDCT.STA$
      4202**DCL      4203--REDEF
NK$LDCT.SYMB$
      4181**DCL      4181--REDEF    4181--REDEF    4182--REDEF
NK$LDCT$
      4064**DCL      5639>>ASSIGN
NOWAY
      5560**LABEL    5569--GOTO
SCID
      5526**DCL      5530<<ASSIGN   5531>>IF       5556>>ASSIGN   5615>>ASSIGN   5635>>ASSIGN
SC_PRTCL_SNAP
      5511**DCL-ENT  5538--CALL
SNAP
      5538**LABEL    5580--GOTO     5594--GOTO     5623--GOTO     5658--GOTO     5674--GOTO
TRYSEND
      5644**LABEL    5660--GOTO

PL6.E3A0      #004=KIS$OSI_READ File=KIS$OSI.:E05TSI                             WED 07/30/97 00:41 Page:106  
      651        1        /*T***********************************************************/
      652        2        /*T*                                                         */
      653        3        /*T* Copyright (c) Bull HN Information Systems Inc., 1997    */
      654        4        /*T*                                                         */
      655        5        /*T***********************************************************/
      656        6        /*F*    NAME:   KIS$OSI_READ
      657        7
      658        8                PURPOSE:  Handle M$READ of RES=NC DCB.
      659        9        */
      660       10        /*D*    NAME:   KIS$OSI_READ
      661       11                CALL:   CALL KIS$OSI_READ ALTRET( label);
      662       12                INPUT:
      663       13                    B$JIT.DCB$->F$DCB the NC DCB itself,
      664       14                    B$PS0$ points at the V area of the READ FPT,
      665       15                    B$PS2$ points at the BUF area of the READ FPT.
      666       16                OUTPUT:
      667       17                    On successful call,
      668       18                      TBD.
      669       19                    On unsuccessful call,
      670       20                      TBD.
      671       21                DESCRIPTION:
      672       22                    KIS$OSI_READ is called when an OSI client application wishes
      673       23                    to wait for an incoming message from a server on an already-
      674       24                    open connection, or to receive notification when an incoming
      675       25                    message has arrived.  It is entered from FSE$FORMAT when an
      676       26                    M$READ to a DCB with RES=NC is issued.
      677       27
      678       28                    The code splits on whether or not the application issued a
      679       29                    'wait' read.  If WAIT=YES, the application is REG'd waiting
      680       30                    for an incoming message.  On normal RETURN from SSR$REG the
      681       31                    message that arrived is moved to the user's buffer, thus
      682       32                    satisfying the read.
      683       33
      684       34                    If WAIT=NO, we set up to have the read satisfied later.
      685       35
      686       36                    NOTE: ALL WRITES AND READS THRU RES=NC MUST BE TRANSPARENT.
      687       37                    This is required for (1) optimized handling by FSE, and (2) to
PL6.E3A0      #004=KIS$OSI_READ File=KIS$OSI.:E05TSI                             WED 07/30/97 00:41 Page:107  
      688       38                    avoid stomping on the DVFC field in the DCB.
      689       39        */
      690       40        KIS$OSI_READ: PROC ALTRET;
      691       41        %INCLUDE B$USER;
      692      257            %B$USERREFS;
      693      261        %INCLUDE B_STRINGS_C;
      694      390        %INCLUDE CP_6_SUBS;
      695      930        %INCLUDE F$CP6V_C;
      696     1156            %FPT$READ_V( BASED="BASED( B$PS0$)");
      697     1163        %INCLUDE F$JIT_C;
      698     1593        %INCLUDE F_ERRORS_C;
      699     1833        %INCLUDE HF_LOCK_C;
      700     1847        %INCLUDE KI_ERRORS_C;
      701     1932        %INCLUDE KI$MHDR;
      702     2073            %KI$QMHDR;
      703     2122        %INCLUDE K_ADDRESS_M;
      704     2625        %INCLUDE K_DATA_R;
      705     3336            %K$RWPARM( NAME=K$RWPARM, STCLASS=AUTO);
      706     3652        %INCLUDE K_INTERFACE_M;
      707     4061        %INCLUDE K_SESSION_M;
      708     4151            %KIS$APPL( NAME=APPL, STCLASS=BASED);
      709     4220        %INCLUDE K_SUBS_C;
      710     4253        %INCLUDE NK_LDCT_R;
      711     4262        %INCLUDE NK_SUBS;
      712     4287        %INCLUDE NK$LDCT;
      713     4389            %NK$LDCT( STCLASS="BASED( LDCT$)");
      714     4435        %INCLUDE SS_SCHED_C;
      715     4668        %INCLUDE UM_CP6;
      716     5520        %MACRO ERRCODE( NAME=ERRDUMMY, CODE=0);
      717     5521            %VLP_ERRCODE( FPTN=NAME, STCLASS=CONSTANT, FCG='KI', MID='S',
      718     5522                          MON='1'B, ERR#=CODE, SEV=7);
      719     5523        %MEND;
      720     5524            %ERRCODE( NAME=ERRBADBUFFER, CODE=%E$BADBUFFER);
      721     5572            %ERRCODE( NAME=ERRBADSCID, CODE=%E$BADSCID);
      722     5620            %ERRCODE( NAME=ERRCANTREG, CODE=%E$CANTREG);
      723     5668            %ERRCODE( NAME=ERREOD, CODE=%E$EOD);
      724     5716            %ERRCODE( NAME=ERROSILDSC, CODE=%E$OSILDSC);
PL6.E3A0      #004=KIS$OSI_READ File=KIS$OSI.:E05TSI                             WED 07/30/97 00:41 Page:108  
      725     5764            %ERRCODE( NAME=ERRNOREAD, CODE=%E$NOREAD);
      726     5812            %ERRCODE( NAME=ERRTRANCLOSED, CODE=%E$TRANCLOSED);
      727     5860            %ERRCODE( NAME=ERRTRANSPORT, CODE=%E$TRANSPORT);
      728     5908            %ERRCODE( NAME=ERRXTRARD, CODE=%E$XTRARD);
      729     5956        %MACRO F$DCBI( BASED=BASED);
      730     5957        %INCLUDE F$DCB;
      731     6006        %MEND;
      732     6007            %F$DCBI( BASED="BASED( JDCB$)");
      733     6057
      734     6058    1       DCL FMO$GETDOMAIN ENTRY(1);
      735     6059    1       DCL HFF$DSIZ ENTRY(2) ALTRET;
      736     6060    1       DCL HFF$TRAPALT ENTRY ALTRET;
      737     6061    1       DCL HFF$WRITE1 ENTRY(1) ALTRET;
      738     6062    1       DCL KIA$COMP ENTRY(2);
      739     6063    1       DCL KIA$OQFL ENTRY(1) ALTRET;
      740     6064    1       DCL KIQ$MAPFEP ENTRY(1);
      741     6065    1       DCL KIT$SEND ENTRY(1) ALTRET;
      742     6066    1       DCL MMS$SETUP_BUF ENTRY(5) ALTRET;
      743     6067    1       DCL SSR$REG ENTRY(3) ALTRET;
      744     6068    1       DCL SC_PRTCL_SNAP ENTRY CONV(2,0);
      745     6069
      746     6070    1       DCL B$CGCTXT$ PTR SYMREF;
      747     6071    1       DCL B$JIT$ PTR SYMREF;
      748     6072    1       DCL B$PS0$ PTR SYMREF;  /* points at V area within FPT */
      749     6073    1       DCL B$PS2$ PTR SYMREF;  /* points at BUF within FPT */
      750     6074    1       DCL KIS_MAJOR$ PTR SYMREF;
      751     6075    1       DCL KIS_MINOR$ PTR SYMREF;
      752     6076    1       DCL KIS_SSN_MAXMAJOR UBIN SYMREF;
      753     6077    1       DCL NI_MFGATE BIT(72) SYMREF;
      754     6078
      755     6079    1       DCL BUFFER CHAR( LEN) BASED( B$PS2$) CALIGNED;
      756     6080    1       DCL DMN UBIN;
      757     6081    1       DCL 1 FEPIO,
      758     6082    1            2 EVENT SBIN,
      759     6083    1            2 KEYX SBIN(18) UNAL,
      760     6084    1            2 BUFX SBIN(18) UNAL,
      761     6085    1            2 BPP(0:1) BIT(18) UNAL,
PL6.E3A0      #004=KIS$OSI_READ File=KIS$OSI.:E05TSI                             WED 07/30/97 00:41 Page:109  
      762     6086    1            2 KPP(0:1) BIT(18) UNAL;
      763     6087    1       DCL 1 FEPSIZ,
      764     6088    1            2 BUF UBIN(18) UNAL,
      765     6089    1            2 KEY UBIN(18) UNAL;
      766     6090    1       DCL JDCB$ PTR;
      767     6091    1       DCL LDCT$ PTR;
      768     6092    1       DCL LEN UBIN;
      769     6093    1       DCL MAJOR$ PTR;
      770     6094    1       DCL MINOR$ PTR;
      771     6095    1       DCL MESSAGE CHAR( K$RWPARM.MSGSZ) BASED( K$RWPARM.MSG$) CALIGNED;
      772     6096    1       DCL 1 NOWAIT,
      773     6097    1            2 KEYTYP UBIN(6) UNAL,
      774     6098    1            2 DMN UBIN(3) UNAL,
      775     6099    1            2 STREAM UBIN(9) UNAL,
      776     6100    1            2 DCB# UBIN(9) UNAL,
      777     6101    1            2 * UBIN(9) UNAL;
      778     6102    1       DCL 1 PTW(0:1),
      779     6103    1            2 PP BIT(18) ALIGNED;
      780     6104    1       DCL R$ PTR;
      781     6105    1       DCL SCID SBIN;
      782     6106
      783     6107    1       JDCB$ = B$JIT.DCB$;
      784     6108    1       LDCT$ = NK$LDCT$( F$DCB.LDCTX);
      785     6109            /* The remainder of this module attempts to duplicate the MFC_READ case
      786     6110               of KIA$UCIOND and friends.                                          */
      787     6111    2       IF NK$LDCT.DFLG.OLDSC THEN DO;
      788     6112                /*N* I don't see how this can happen */
      789     6113    2           B$JIT.ERR = ERROSILDSC;
      790     6114                /*E*  ERROR:  KIS-E$OSILDSC-A
      791     6115                    MESSAGE:  Internal error.  Your network path has vanished.
      792     6116                */
      793     6117    2   SNAP:
      794     6118    2           CALL SC_PRTCL_SNAP;
      795     6119    2           ALTRETURN;
      796     6120    2           END;
      797     6121            %LOCK( G=NK$LDCT.LOCK);
      798     6124            /* if WAIT=YES and there are other no-wait reads pending, cancel them */
PL6.E3A0      #004=KIS$OSI_READ File=KIS$OSI.:E05TSI                             WED 07/30/97 00:41 Page:110  
      799     6125    2       IF F$DCB.WAIT ~= 0 AND F$DCB.FCN.CNT(0) ~= 0 THEN DO;
      800     6126    2   CANCEL:
      801     6127    3           DO WHILE( NK$LDCT.LKFLG.NOWAIT);
      802     6128    3               K$RWPARM = K_RWPARM_CON;
      803     6129    3               K$RWPARM.MSG_ERRCODE = ERRXTRARD;
      804     6130    3               K$RWPARM.TYC = %TYC_XTRARD;
      805     6131    3               CALL KIA$COMP( NK$LDCT, K$RWPARM);
      806     6132    3               END;
      807     6133    2           END;
      808     6134    1       K$RWPARM = K_RWPARM_CON;
      809     6135    2       IF F$DCB.WAIT = 1 THEN DO;
      810     6136                /* this is a 'wait' read request */
      811     6137                /* Note: the following call to SSR unlocks the gate */
      812     6138    2           CALL SSR$REG( %SS_CW, NK$LDCT)
      813     6139    3           WHENALTRETURN DO;
      814     6140                    /* problem REG'ing the user */
      815     6141                    %LOCK( G=NK$LDCT.LOCK);
      816     6144    3               IF NK$LDCT.IP$ ~= ADDR( NIL) THEN
      817     6145    3                   GOTO READ_IT;
      818     6146    3   BRKCK:
      819     6147                    %UNLOCK( G=NK$LDCT.LOCK);
      820     6150    3               CALL SC_PRTCL_SNAP;
      821     6151    3               IF K$RWPARM.ERR ~= 0 THEN
      822     6152    3                   ALTRETURN;
      823     6153    3               B$JIT.ERR = ERRCANTREG;
      824     6154                    /*E*  ERROR:  KIS-E$CANTREG-A
      825     6155                        MESSAGE:  Internal error.  Funny wait-read REG ALTRETURN.
      826     6156                    */
      827     6157    3               ALTRETURN;
      828     6158    3               END;
      829     6159                %LOCK( G=NK$LDCT.LOCK);
      830     6162    2   READ_IT:
      831     6163    2           K$RWPARM.IP$ = NK$LDCT.IP$;
      832     6164    2           NK$LDCT.IP$ = ADDR( NIL);
      833     6165    3           IF K$RWPARM.IP$ = ADDR( NIL) THEN DO;
      834     6166                    %UNLOCK( G=NK$LDCT.LOCK);
      835     6169    3               B$JIT.ERR = ERRNOREAD;
PL6.E3A0      #004=KIS$OSI_READ File=KIS$OSI.:E05TSI                             WED 07/30/97 00:41 Page:111  
      836     6170                    /*E*  ERROR:  KIS-E$NOREAD-A
      837     6171                        MESSAGE:  Internal error.  Message lost.
      838     6172                    */
      839     6173    3               GOTO SNAP;
      840     6174    3               END;
      841     6175                /*N* document this */
      842     6176    2           CALL KIQ$MAPFEP( NK$LDCT.IPFEI#);
      843     6177    2           K$RWPARM.MSG$ = PINCRC( K$RWPARM.IP$, K$RWPARM.IP$->KI$QMHDR.OFFSET);
      844     6178    2           K$RWPARM.MSGSZ = K$RWPARM.IP$->KI$QMHDR.SIZE;
      845     6179    2           K$RWPARM.TYC = '0'B;
      846     6180                /* set up to move data into user buffer */
      847     6181    2           CALL HFF$DSIZ( B$PS2$, LEN) ALTRET( BAD_BUFFER);
      848     6182    3           IF K$RWPARM.MSGSZ > LEN THEN DO;
      849     6183                    /* received message larger than user buffer; note truncated */
      850     6184    3               K$RWPARM.TYC = %TYC_LD | %TYC_EGV;
      851     6185    3               K$RWPARM.MSGSZ = LEN;
      852     6186    3               END;
      853     6187    3           IF K$RWPARM.MSG$ ~= ADDR( NIL) THEN DO;
      854     6188                    /* set up to trap bad user buffer */
      855     6189    3               CALL HFF$TRAPALT ALTRET( BAD_BUFFER);
      856     6190                    /* try to move the message */
      857     6191    3               BUFFER = MESSAGE;
      858     6192                    /* it worked; save moved length in DCB */
      859     6193    3               F$DCB.ARS = K$RWPARM.MSGSZ;
      860     6194    3               END;
      861     6195    2           B$JIT.ERR = K$RWPARM.MSG_ERRCODE;
      862     6196    2           K$RWPARM.LDCT$ = LDCT$;
      863     6197    2           K$RWPARM.FUNCTION = %K_READDONE;
      864     6198    2           CALL KIT$SEND( K$RWPARM) ALTRET( BRKCK);
      865     6199                %UNLOCK( G=NK$LDCT.LOCK);
      866     6202    2           RETURN;
      867     6203    2           END;
      868     6204            /* otherwise, this is a no-wait read request */
      869     6205            %UNLOCK( G=NK$LDCT.LOCK);
      870     6208            /*N* All of the following needs to be better documented */
      871     6209            /* set up the buffer area of the DCB */
      872     6210    1       FEPSIZ.BUF = F$DCB.UBYTES;
PL6.E3A0      #004=KIS$OSI_READ File=KIS$OSI.:E05TSI                             WED 07/30/97 00:41 Page:112  
      873     6211    1       CALL MMS$SETUP_BUF( %USERWSQ, F$DCB.UB$, F$DCB.UBYTES, R$, PTW);
      874     6212    1       FEPIO.BUFX = POFFC( R$, B$CGCTXT$);
      875     6213    1       FEPIO.BPP(0) = PTW.PP(0);
      876     6214    1       FEPIO.BPP(1) = PTW.PP(1);
      877     6215            /* save the DCB# of the user specified DCB and the event */
      878     6216    1       FEPIO.EVENT = FPT$READ_V.EVENT;
      879     6217    1       NOWAIT.DCB# = B$JIT.DCBNO;
      880     6218    1       NOWAIT.STREAM = K$RWPARM.STR;
      881     6219    1       CALL FMO$GETDOMAIN( DMN);
      882     6220    1       NOWAIT.DMN = DMN;
      883     6221            /* make sure we have write access */
      884     6222    1       CALL HFF$WRITE1( 2) ALTRET( BAD_BUFFER);
      885     6223            /* set up to get the TCTX */
      886     6224    1       SCID = ASCBIN( F$DCB.DVFC);
      887     6225    2       IF SCID > KIS_SSN_MAXMAJOR THEN DO;
      888     6226                /* no way can this be a legal appl id */
      889     6227    2           B$JIT.ERR = ERRBADSCID;
      890     6228                /*    ERROR:  KIS-E$BADSCID-A
      891     6229                    MESSAGE:  Bad Session connection identifier.
      892     6230                */
      893     6231    2           GOTO SNAP;
      894     6232    2           END;
      895     6233    1       MINOR$ = ADDR( NIL);
      896     6234    1       MAJOR$ = PINCRW( KIS_MAJOR$, SCID);
      897     6235    2       IF MAJOR$->APPL.Z.LINK ~= 0 THEN DO;
      898     6236    2           MINOR$ = PINCRW( KIS_MINOR$, MAJOR$->APPL.Z.LINK);
      899     6237    3           IF MINOR$->APPL.TCTX = 0 THEN DO;
      900     6238    3               B$JIT.ERR = ERRTRANCLOSED;
      901     6239                    /*    ERROR:  KIS-E$TRANCLOSED-A
      902     6240                        MESSAGE:  Transport connection doesn't exist.
      903     6241                    */
      904     6242    3               ALTRETURN;
      905     6243    3               END;
      906     6244    2           END;
      907     6245            %LOCK( G=NK$LDCT.LOCK);
      908     6248    2       IF NK$LDCT.LKFLG.NOWAIT THEN DO;
      909     6249                /* at least one other no-wait read pending */
PL6.E3A0      #004=KIS$OSI_READ File=KIS$OSI.:E05TSI                             WED 07/30/97 00:41 Page:113  
      910     6250    2           IF FEPSIZ ~= F$DCB.FEPSIZ OR NK$LDCT.NOWAIT ~= NOWAIT THEN
      911     6251    2               GOTO CANCEL;
      912     6252    3           IF F$DCB.FCN.CNT(0) >= 3 THEN DO;
      913     6253                    /* too many reads outstanding.. have to cancel one of 'em */
      914     6254    3               K$RWPARM = K_RWPARM_CON;
      915     6255    3               K$RWPARM.MSG_ERRCODE = ERRXTRARD;
      916     6256    3               K$RWPARM.TYC = %TYC_XTRARD;
      917     6257    3               CALL KIA$COMP( NK$LDCT, K$RWPARM);
      918     6258    3               END;
      919     6259    2           END;
      920     6260    2       ELSE DO;
      921     6261    2           NK$LDCT.NOWAIT = NOWAIT;
      922     6262    2           F$DCB.FEPSIZ = FEPSIZ;
      923     6263    2           END;
      924     6264    1       NK$LDCT.LKFLG.NOWAIT = '1'B;
      925     6265            /* increment the user's MF count */
      926     6266            %LOCK( G=NI_MFGATE);
      927     6269    1       S$CU$->B$U.MF = S$CU$->B$U.MF + 1;
      928     6270    1       S$CU$->B$U.CMF = S$CU$->B$U.CMF + 1;
      929     6271            %UNLOCK( G=NI_MFGATE);
      930     6274    1       IF F$DCB.FCN.CNT(0) = 1 THEN
      931     6275    1           F$DCB.FEPIO2 = FEPIO;
      932     6276    1       ELSE
      933     6277    1           IF F$DCB.FCN.CNT(0) < 1 THEN
      934     6278    1               F$DCB.FEPIO = FEPIO;
      935     6279    1           ELSE
      936     6280    1               F$DCB.FEPIO3 = FEPIO;
      937     6281    1       F$DCB.FCN.CNT(0) = F$DCB.FCN.CNT(0) + 1;
      938     6282    2       IF MINOR$ ~= ADDR( NIL) THEN DO;
      939     6283                /* let Transport know we can handle another input record now */
      940     6284    2           K$RWPARM.FUNCTION = %K_TCREDIT;
      941     6285    2           K$RWPARM.SSN_CRDT = 1;
      942     6286    2           K$RWPARM.TCTX# = MINOR$->APPL.TCTX;
      943     6287    2   TRYSEND:
      944     6288    2           CALL KIT$SEND( K$RWPARM)
      945     6289    3           WHENALTRETURN DO;
      946     6290                    /* Transport couldn't deal with the credit msg */
PL6.E3A0      #004=KIS$OSI_READ File=KIS$OSI.:E05TSI                             WED 07/30/97 00:41 Page:114  
      947     6291    4               IF K$RWPARM.ERR = %K$QFULL THEN DO;
      948     6292    4                   CALL KIA$OQFL( NK$LDCT) ALTRET( SNAP);
      949     6293    4                   GOTO TRYSEND;
      950     6294    4                   END;
      951     6295    3               IF K$RWPARM.ERR = %K$USER_ERR THEN
      952     6296    3                   B$JIT.ERR = K$RWPARM.MSG_ERRCODE;
      953     6297    4               ELSE DO;
      954     6298    4                   B$JIT.ERR = ERRTRANSPORT;
      955     6299                        /*    ERROR:  KIS-E$TRANSPORT-A
      956     6300                            MESSAGE:  Internal error.  Transport ALTRETURN.
      957     6301                        */
      958     6302    4                   CALL SC_PRTCL_SNAP;
      959     6303    4                   END;
      960     6304    3               END;
      961     6305    2           END;
      962     6306            /* all done for now... */
      963     6307            %UNLOCK( G=NK$LDCT.LOCK);
      964     6310    1       IF B$JIT.ERR = '0'B THEN
      965     6311    1           RETURN;
      966     6312    1       ALTRETURN;
      967     6313    1   BAD_BUFFER:
      968     6314            /* no longer trap bad user buffer */
      969     6315    1       CALL HFF$TRAPALT;
      970     6316            %UNLOCK( G=NK$LDCT.LOCK);
      971     6319    1       B$JIT.ERR = ERRBADBUFFER;
      972     6320            /*E*  ERROR:  KIS-E$BADBUFFER-A
      973     6321                MESSAGE:  Read buffer is inaccessible.
      974     6322            */
      975     6323    1       ALTRETURN;
      976     6324        %EJECT;
PL6.E3A0      #004=KIS$OSI_READ File=KIS$OSI.:E05TSI                             WED 07/30/97 00:41 Page:115  
      977     6325        /*F*    NAME:   KIS$OSI_TRUNC
      978     6326
      979     6327                PURPOSE:  Handle M$TRUNC of RES=NC DCB.
      980     6328        */
      981     6329        /*D*    NAME:   KIS$OSI_TRUNC
      982     6330                CALL:   CALL KIS$OSI_TRUNC ALTRET( label);
      983     6331                INPUT:
      984     6332                    B$JIT.DCB$->F$DCB the NC DCB itself.
      985     6333                OUTPUT:
      986     6334                    none.
      987     6335                DESCRIPTION:
      988     6336                    KIS$OSI_TRUNC is called from FMF$TRUNC in order to cancel
      989     6337                    the NoWait reads on an NC DCB.  The most common (only?)
      990     6338                    situation in which this needs to be done is when an OSI
      991     6339                    client application does an M$LINK/M$YC.  The NoWait reads
      992     6340                    issued by the Session library need to be COMP'd, and this
      993     6341                    involves interaction with the Transport layer to prevent
      994     6342                    more data from arriving while the application is off doing
      995     6343                    something else.
      996     6344        */
      997     6345    1   KIS$OSI_TRUNC: ENTRY ALTRET;
      998     6346
      999     6347    1       JDCB$ = B$JIT.DCB$;
     1000     6348    1       LDCT$ = NK$LDCT$( F$DCB.LDCTX);
     1001     6349    1       SCID = ASCBIN( F$DCB.DVFC);
     1002     6350    1       MINOR$ = ADDR( NIL);
     1003     6351    1       MAJOR$ = PINCRW( KIS_MAJOR$, SCID);
     1004     6352    1       IF MAJOR$->APPL.Z.LINK ~= 0 THEN
     1005     6353    1           MINOR$ = PINCRW( KIS_MINOR$, MAJOR$->APPL.Z.LINK);
     1006     6354            %LOCK( G=NK$LDCT.LOCK);
     1007     6357    2       IF NK$LDCT.LKFLG.NOWAIT THEN DO;
     1008     6358                /* there are NoWait read(s) outstanding */
     1009     6359    2           IF MINOR$ = ADDR( NIL) OR MINOR$->APPL.TCTX = 0 THEN
     1010     6360    2               GOTO DONETRAN;
     1011     6361    2           K$RWPARM = K_RWPARM_CON;
     1012     6362    2           K$RWPARM.FUNCTION = %K_TCREDIT;
     1013     6363    2           K$RWPARM.SSN_CRDT = 0;
PL6.E3A0      #004=KIS$OSI_READ File=KIS$OSI.:E05TSI                             WED 07/30/97 00:41 Page:116  
     1014     6364    2           K$RWPARM.TCTX# = MINOR$->APPL.TCTX;
     1015     6365    2   TRYTRUNC:
     1016     6366    2           CALL KIT$SEND( K$RWPARM)
     1017     6367    3           WHENALTRETURN DO;
     1018     6368    4               IF K$RWPARM.ERR = %K$QFULL THEN DO;
     1019     6369    4                   CALL KIA$OQFL( NK$LDCT) ALTRET( SNAP);
     1020     6370    4                   GOTO TRYTRUNC;
     1021     6371    4                   END;
     1022     6372    3               GOTO SNAP;
     1023     6373    3               END;
     1024     6374    2           NK$LDCT.LKFLG.WTMRK = '1'B;
     1025     6375    2   TRUNCLOOP:
     1026     6376    2           CALL SSR$REG( %SS_CW, NK$LDCT);  /* which unlocks ldct.lock */
     1027     6377                %LOCK( G=NK$LDCT.LOCK);
     1028     6380    2           IF NK$LDCT.LKFLG.WTMRK THEN
     1029     6381    2               GOTO TRUNCLOOP;
     1030     6382    2   DONETRAN:
     1031     6383    3           DO WHILE( NK$LDCT.LKFLG.NOWAIT);
     1032     6384                    /* COMP any remaining NoWait reads */
     1033     6385    3               K$RWPARM = K_RWPARM_CON;
     1034     6386    3               K$RWPARM.MSG_ERRCODE = ERREOD;
     1035     6387    3               K$RWPARM.TYC = %TYC_EOD;
     1036     6388    3               CALL KIA$COMP( NK$LDCT, K$RWPARM);
     1037     6389    3               END;
     1038     6390    2           END;
     1039     6391            %UNLOCK( G=NK$LDCT.LOCK);
     1040     6394    1       RETURN;
     1041     6395
     1042     6396    1       END KIS$OSI_READ;
     1043     6397        %EOD;

PL6.E3A0      #004=KIS$OSI_READ File=KIS$OSI.:E05TSI                             WED 07/30/97 00:41 Page:117  
--  Include file information  --

   F$DCB.:E05TOU  is referenced.
   UM_CP6.:E05TOU  is referenced.
   SS_SCHED_C.:E05TOU  is referenced.
   NK$LDCT.:E05TOU  is referenced.
   NK_SUBS.:E05TOU  is referenced.
   NK_LDCT_R.:E05TOU  cannot be made into a system file and is referenced.
   K_SUBS_C.:E05TOU  is referenced.
   K_SESSION_M.:E05TOU  is referenced.
   K_INTERFACE_M.:E05TOU  is referenced.
   K$RWPARM.:E05TOU  is referenced.
   K_DATA_R.:E05TOU  cannot be made into a system file and is referenced.
   K_ADDRESS_M.:E05TOU  is referenced.
   KI$MHDR.:E05TOU  is referenced.
   KI_ERRORS_C.:E05TOU  is referenced.
   HF_LOCK_C.:E05TOU  cannot be made into a system file and is referenced.
   F_ERRORS_C.:E05TOU  is referenced.
   B$JIT_C.:E05TOU  is referenced.
   F$JIT_C.:E05TOU  cannot be made into a system file and is referenced.
   F$CP6V_C.:E05TOU  is referenced.
   CP_6_SUBS.:E05TOU  is referenced.
   B_STRINGS_C.:E05TOU  is referenced.
   B$USER.:E05TOU  cannot be made into a system file and is referenced.
      No diagnostics issued in procedure KIS$OSI_READ.

   Procedure KIS$OSI_READ requires 565 words for executable code.
   Procedure KIS$OSI_READ requires 66 words of local(AUTO) storage.

PL6.E3A0      #004=KIS$OSI_READ File=KIS$OSI.:E05TSI                             WED 07/30/97 00:41 Page:118  

 Object Unit name= KIS$OSI_READ                               File name= KIS$OSI.:E05TOU
 UTS= JUL 30 '97 00:41:58.76 WED                              Compiler= PL-6/E31         Sev=      00
 SharedLib= :SHARED_SYSTEM                                    Alt SharedLib=


    ****  Control sections  ****

 Sect   Type Bound  Init  Size OctSiz  Section name(segment info)
    0  RoData even  UTS     12     14  KIS$OSI_READ
    1   Proc  even  none   565   1065  KIS$OSI_READ
    2  RoData even  none     7      7  KIS$OSI_READ

    ****  Entry defs  ****

                              Check   Calling
                             calling  sequence
  Sect OctLoc Primary Altret sequence   type   Parms  Name
     1      0   yes    yes     yes      Std        0  KIS$OSI_READ
     1    674          yes     yes      Std        0  KIS$OSI_TRUNC
PL6.E3A0      #004=KIS$OSI_READ File=KIS$OSI.:E05TSI                             WED 07/30/97 00:41 Page:119  

  ****  Entry refs  ****

         Check        Calling
        calling       sequence
Altret sequence SRef   type   Args  Name
 yes     yes           Std       3 SSR$REG
         yes           Std       1 HFC$UNLOCK
 yes     yes           Std       5 MMS$SETUP_BUF
         yes           Std       1 FMO$GETDOMAIN
 yes     yes           Std       2 HFF$DSIZ
 yes     yes           Std       1 HFF$WRITE1
 yes     yes           Std       0 HFF$TRAPALT
         yes           Std       1 HFC$LOCK
         yes           Std       2 KIA$COMP
         yes           Std       1 KIQ$MAPFEP
 yes     yes           Std       1 KIT$SEND
 yes     yes           Std       1 KIA$OQFL
                       Std       0 B_CONSPOOL_D
                       nStd      0 X66_AUTO_0
                       nStd      0 X66_AALT
                       nStd      0 X66_ARET

  ****  Data refs  ****

  Flags:  r = read only, s = secondary
Flgs Name                             Flgs Name                             Flgs Name
     SC_PRTCL_SNAP                         S$CU$                            r    K_RWPARM_CON
     N$DCT$$                               B$CGCTXT$                             B$JIT$
     B$PS0$                                B$PS2$                                KIS_MAJOR$
     KIS_MINOR$                            KIS_SSN_MAXMAJOR                      NI_MFGATE
     B_VECTNIL
PL6.E3A0      #004=KIS$OSI_READ File=KIS$OSI.:E05TSI                             WED 07/30/97 00:41 Page:120  

  ****  Segment refs  ****

  Flags:  r = read only, s = secondary
Flgs Name                             Flgs Name                             Flgs Name
     ASLENTSID                             ISSID
PL6.E3A0      #004=KIS$OSI_READ File=KIS$OSI.:E05TSI                             WED 07/30/97 00:41 Page:121  


      651        1        /*T***********************************************************/
      652        2        /*T*                                                         */
      653        3        /*T* Copyright (c) Bull HN Information Systems Inc., 1997    */
      654        4        /*T*                                                         */
      655        5        /*T***********************************************************/
      656        6        /*F*    NAME:   KIS$OSI_READ
      657        7
      658        8                PURPOSE:  Handle M$READ of RES=NC DCB.
      659        9        */
      660       10        /*D*    NAME:   KIS$OSI_READ
      661       11                CALL:   CALL KIS$OSI_READ ALTRET( label);
      662       12                INPUT:
      663       13                    B$JIT.DCB$->F$DCB the NC DCB itself,
      664       14                    B$PS0$ points at the V area of the READ FPT,
      665       15                    B$PS2$ points at the BUF area of the READ FPT.
      666       16                OUTPUT:
      667       17                    On successful call,
      668       18                      TBD.
      669       19                    On unsuccessful call,
      670       20                      TBD.
      671       21                DESCRIPTION:
      672       22                    KIS$OSI_READ is called when an OSI client application wishes
      673       23                    to wait for an incoming message from a server on an already-
      674       24                    open connection, or to receive notification when an incoming
      675       25                    message has arrived.  It is entered from FSE$FORMAT when an
      676       26                    M$READ to a DCB with RES=NC is issued.
      677       27
      678       28                    The code splits on whether or not the application issued a
      679       29                    'wait' read.  If WAIT=YES, the application is REG'd waiting
      680       30                    for an incoming message.  On normal RETURN from SSR$REG the
      681       31                    message that arrived is moved to the user's buffer, thus
      682       32                    satisfying the read.
      683       33
      684       34                    If WAIT=NO, we set up to have the read satisfied later.
      685       35
      686       36                    NOTE: ALL WRITES AND READS THRU RES=NC MUST BE TRANSPARENT.
PL6.E3A0      #004=KIS$OSI_READ File=KIS$OSI.:E05TSI                             WED 07/30/97 00:41 Page:122  
      687       37                    This is required for (1) optimized handling by FSE, and (2) to
      688       38                    avoid stomping on the DVFC field in the DCB.
      689       39        */
      690       40        KIS$OSI_READ: PROC ALTRET;

     40  1 000000   000000 700200 xent  KIS$OSI_READ TSX0  ! X66_AUTO_0
         1 000001   000102 000000                    ZERO    66,0

      691       41        %INCLUDE B$USER;
      692      257            %B$USERREFS;
      693      261        %INCLUDE B_STRINGS_C;
      694      390        %INCLUDE CP_6_SUBS;
      695      930        %INCLUDE F$CP6V_C;
      696     1156            %FPT$READ_V( BASED="BASED( B$PS0$)");
      697     1163        %INCLUDE F$JIT_C;
      698     1593        %INCLUDE F_ERRORS_C;
      699     1833        %INCLUDE HF_LOCK_C;
      700     1847        %INCLUDE KI_ERRORS_C;
      701     1932        %INCLUDE KI$MHDR;
      702     2073            %KI$QMHDR;
      703     2122        %INCLUDE K_ADDRESS_M;
      704     2625        %INCLUDE K_DATA_R;
      705     3336            %K$RWPARM( NAME=K$RWPARM, STCLASS=AUTO);
      706     3652        %INCLUDE K_INTERFACE_M;
      707     4061        %INCLUDE K_SESSION_M;
      708     4151            %KIS$APPL( NAME=APPL, STCLASS=BASED);
      709     4220        %INCLUDE K_SUBS_C;
      710     4253        %INCLUDE NK_LDCT_R;
      711     4262        %INCLUDE NK_SUBS;
      712     4287        %INCLUDE NK$LDCT;
      713     4389            %NK$LDCT( STCLASS="BASED( LDCT$)");
      714     4435        %INCLUDE SS_SCHED_C;
      715     4668        %INCLUDE UM_CP6;
      716     5520        %MACRO ERRCODE( NAME=ERRDUMMY, CODE=0);
      717     5521            %VLP_ERRCODE( FPTN=NAME, STCLASS=CONSTANT, FCG='KI', MID='S',
      718     5522                          MON='1'B, ERR#=CODE, SEV=7);
      719     5523        %MEND;
PL6.E3A0      #004=KIS$OSI_READ File=KIS$OSI.:E05TSI                             WED 07/30/97 00:41 Page:123  
      720     5524            %ERRCODE( NAME=ERRBADBUFFER, CODE=%E$BADBUFFER);
      721     5572            %ERRCODE( NAME=ERRBADSCID, CODE=%E$BADSCID);
      722     5620            %ERRCODE( NAME=ERRCANTREG, CODE=%E$CANTREG);
      723     5668            %ERRCODE( NAME=ERREOD, CODE=%E$EOD);
      724     5716            %ERRCODE( NAME=ERROSILDSC, CODE=%E$OSILDSC);
      725     5764            %ERRCODE( NAME=ERRNOREAD, CODE=%E$NOREAD);
      726     5812            %ERRCODE( NAME=ERRTRANCLOSED, CODE=%E$TRANCLOSED);
      727     5860            %ERRCODE( NAME=ERRTRANSPORT, CODE=%E$TRANSPORT);
      728     5908            %ERRCODE( NAME=ERRXTRARD, CODE=%E$XTRARD);
      729     5956        %MACRO F$DCBI( BASED=BASED);
      730     5957        %INCLUDE F$DCB;
      731     6006        %MEND;
      732     6007            %F$DCBI( BASED="BASED( JDCB$)");
      733     6057
      734     6058    1       DCL FMO$GETDOMAIN ENTRY(1);
      735     6059    1       DCL HFF$DSIZ ENTRY(2) ALTRET;
      736     6060    1       DCL HFF$TRAPALT ENTRY ALTRET;
      737     6061    1       DCL HFF$WRITE1 ENTRY(1) ALTRET;
      738     6062    1       DCL KIA$COMP ENTRY(2);
      739     6063    1       DCL KIA$OQFL ENTRY(1) ALTRET;
      740     6064    1       DCL KIQ$MAPFEP ENTRY(1);
      741     6065    1       DCL KIT$SEND ENTRY(1) ALTRET;
      742     6066    1       DCL MMS$SETUP_BUF ENTRY(5) ALTRET;
      743     6067    1       DCL SSR$REG ENTRY(3) ALTRET;
      744     6068    1       DCL SC_PRTCL_SNAP ENTRY CONV(2,0);
      745     6069
      746     6070    1       DCL B$CGCTXT$ PTR SYMREF;
      747     6071    1       DCL B$JIT$ PTR SYMREF;
      748     6072    1       DCL B$PS0$ PTR SYMREF;  /* points at V area within FPT */
      749     6073    1       DCL B$PS2$ PTR SYMREF;  /* points at BUF within FPT */
      750     6074    1       DCL KIS_MAJOR$ PTR SYMREF;
      751     6075    1       DCL KIS_MINOR$ PTR SYMREF;
      752     6076    1       DCL KIS_SSN_MAXMAJOR UBIN SYMREF;
      753     6077    1       DCL NI_MFGATE BIT(72) SYMREF;
      754     6078
      755     6079    1       DCL BUFFER CHAR( LEN) BASED( B$PS2$) CALIGNED;
      756     6080    1       DCL DMN UBIN;
PL6.E3A0      #004=KIS$OSI_READ File=KIS$OSI.:E05TSI                             WED 07/30/97 00:41 Page:124  
      757     6081    1       DCL 1 FEPIO,
      758     6082    1            2 EVENT SBIN,
      759     6083    1            2 KEYX SBIN(18) UNAL,
      760     6084    1            2 BUFX SBIN(18) UNAL,
      761     6085    1            2 BPP(0:1) BIT(18) UNAL,
      762     6086    1            2 KPP(0:1) BIT(18) UNAL;
      763     6087    1       DCL 1 FEPSIZ,
      764     6088    1            2 BUF UBIN(18) UNAL,
      765     6089    1            2 KEY UBIN(18) UNAL;
      766     6090    1       DCL JDCB$ PTR;
      767     6091    1       DCL LDCT$ PTR;
      768     6092    1       DCL LEN UBIN;
      769     6093    1       DCL MAJOR$ PTR;
      770     6094    1       DCL MINOR$ PTR;
      771     6095    1       DCL MESSAGE CHAR( K$RWPARM.MSGSZ) BASED( K$RWPARM.MSG$) CALIGNED;
      772     6096    1       DCL 1 NOWAIT,
      773     6097    1            2 KEYTYP UBIN(6) UNAL,
      774     6098    1            2 DMN UBIN(3) UNAL,
      775     6099    1            2 STREAM UBIN(9) UNAL,
      776     6100    1            2 DCB# UBIN(9) UNAL,
      777     6101    1            2 * UBIN(9) UNAL;
      778     6102    1       DCL 1 PTW(0:1),
      779     6103    1            2 PP BIT(18) ALIGNED;
      780     6104    1       DCL R$ PTR;
      781     6105    1       DCL SCID SBIN;
      782     6106
      783     6107    1       JDCB$ = B$JIT.DCB$;

   6107  1 000002   000000 470400 xsym               LDP0    B$JIT$
         1 000003   000232 236100                    LDQ     154,,PR0
         1 000004   200062 756100                    STQ     JDCB$,,AUTO

      784     6108    1       LDCT$ = NK$LDCT$( F$DCB.LDCTX);

   6108  1 000005   200062 471500                    LDP1    JDCB$,,AUTO
         1 000006   100051 220100                    LDX0    41,,PR1
         1 000007   000000 473400 xsym               LDP3    N$DCT$$
PL6.E3A0      #004=KIS$OSI_READ File=KIS$OSI.:E05TSI                             WED 07/30/97 00:41 Page:125  
         1 000010   300000 236110                    LDQ     0,X0,PR3
         1 000011   200063 756100                    STQ     LDCT$,,AUTO

      785     6109            /* The remainder of this module attempts to duplicate the MFC_READ case
      786     6110               of KIA$UCIOND and friends.                                          */
      787     6111    2       IF NK$LDCT.DFLG.OLDSC THEN DO;

   6111  1 000012   200063 474500                    LDP4    LDCT$,,AUTO
         1 000013   400006 236100                    LDQ     6,,PR4
         1 000014   010000 316007                    CANQ    4096,DL
         1 000015   000023 600000 1                  TZE     s:6122

      788     6112                /*N* I don't see how this can happen */
      789     6113    2           B$JIT.ERR = ERROSILDSC;

   6113  1 000016   000004 236000 0                  LDQ     ERROSILDSC
         1 000017   000012 756100                    STQ     10,,PR0

      790     6114                /*E*  ERROR:  KIS-E$OSILDSC-A
      791     6115                    MESSAGE:  Internal error.  Your network path has vanished.
      792     6116                */
      793     6117    2   SNAP:
      794     6118    2           CALL SC_PRTCL_SNAP;

   6118  1 000020   000000 713400 xsym  SNAP         CLIMB   SC_PRTCL_SNAP
         1 000021   000000 600000 xsid               climb   nvectors=         0

      795     6119    2           ALTRETURN;

   6119  1 000022   000000 702200 xent               TSX2  ! X66_AALT

      796     6120    2           END;
      797     6121            %LOCK( G=NK$LDCT.LOCK);

   6122  1 000023   200063 236100                    LDQ     LDCT$,,AUTO
         1 000024   000020 036003                    ADLQ    16,DU
         1 000025   200074 756100                    STQ     SCID+1,,AUTO
PL6.E3A0      #004=KIS$OSI_READ File=KIS$OSI.:E05TSI                             WED 07/30/97 00:41 Page:126  
         1 000026   200074 630500                    EPPR0   SCID+1,,AUTO
         1 000027   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 000030   000000 701000 xent               TSX1    HFC$LOCK
         1 000031   000000 011000                    NOP     0

      798     6124            /* if WAIT=YES and there are other no-wait reads pending, cancel them */
      799     6125    2       IF F$DCB.WAIT ~= 0 AND F$DCB.FCN.CNT(0) ~= 0 THEN DO;

   6125  1 000032   200062 470500                    LDP0    JDCB$,,AUTO
         1 000033   000064 236100                    LDQ     52,,PR0
         1 000034   000020 316007                    CANQ    16,DL
         1 000035   000070 600000 1                  TZE     s:6134
         1 000036   000074 236100                    LDQ     60,,PR0
         1 000037   377000 316003                    CANQ    130560,DU
         1 000040   000070 600000 1                  TZE     s:6134

      800     6126    2   CANCEL:
      801     6127    3           DO WHILE( NK$LDCT.LKFLG.NOWAIT);

   6127  1 000041   200063 470500       CANCEL       LDP0    LDCT$,,AUTO
         1 000042   000011 236100                    LDQ     9,,PR0
         1 000043   000001 316003                    CANQ    1,DU
         1 000044   000070 600000 1                  TZE     s:6134

      802     6128    3               K$RWPARM = K_RWPARM_CON;

   6128  1 000045   000100 100400                    MLR     fill='000'O
         1 000046   000000 000234 xsym               ADSC9   K_RWPARM_CON             cn=0,n=156
         1 000047   200004 000234                    ADSC9   K$RWPARM,,AUTO           cn=0,n=156

      803     6129    3               K$RWPARM.MSG_ERRCODE = ERRXTRARD;

   6129  1 000050   000010 236000 0                  LDQ     ERRXTRARD
         1 000051   200043 756100                    STQ     K$RWPARM+31,,AUTO

      804     6130    3               K$RWPARM.TYC = %TYC_XTRARD;

PL6.E3A0      #004=KIS$OSI_READ File=KIS$OSI.:E05TSI                             WED 07/30/97 00:41 Page:127  
   6130  1 000052   000011 236000 0                  LDQ     ERRXTRARD+1
         1 000053   200012 756100                    STQ     K$RWPARM+6,,AUTO

      805     6131    3               CALL KIA$COMP( NK$LDCT, K$RWPARM);

   6131  1 000054   200004 630500                    EPPR0   K$RWPARM,,AUTO
         1 000055   200075 450500                    STP0    SCID+2,,AUTO
         1 000056   200063 236100                    LDQ     LDCT$,,AUTO
         1 000057   200074 756100                    STQ     SCID+1,,AUTO
         1 000060   200074 630500                    EPPR0   SCID+1,,AUTO
         1 000061   000020 631400 xsym               EPPR1   B_VECTNIL+16
         1 000062   000000 701000 xent               TSX1    KIA$COMP
         1 000063   000000 011000                    NOP     0

      806     6132    3               END;

   6132  1 000064   200063 470500                    LDP0    LDCT$,,AUTO
         1 000065   000011 236100                    LDQ     9,,PR0
         1 000066   000001 316003                    CANQ    1,DU
         1 000067   000045 601000 1                  TNZ     s:6128

      807     6133    2           END;

      808     6134    1       K$RWPARM = K_RWPARM_CON;

   6134  1 000070   000100 100400                    MLR     fill='000'O
         1 000071   000000 000234 xsym               ADSC9   K_RWPARM_CON             cn=0,n=156
         1 000072   200004 000234                    ADSC9   K$RWPARM,,AUTO           cn=0,n=156

      809     6135    2       IF F$DCB.WAIT = 1 THEN DO;

   6135  1 000073   200062 470500                    LDP0    JDCB$,,AUTO
         1 000074   000064 236100                    LDQ     52,,PR0
         1 000075   000020 376007                    ANQ     16,DL
         1 000076   000020 116007                    CMPQ    16,DL
         1 000077   000304 601000 1                  TNZ     s:6206

PL6.E3A0      #004=KIS$OSI_READ File=KIS$OSI.:E05TSI                             WED 07/30/97 00:41 Page:128  
      810     6136                /* this is a 'wait' read request */
      811     6137                /* Note: the following call to SSR unlocks the gate */
      812     6138    2           CALL SSR$REG( %SS_CW, NK$LDCT)

   6138  1 000100   200063 236100                    LDQ     LDCT$,,AUTO
         1 000101   000001 235000 2                  LDA     1
         1 000102   200074 757100                    STAQ    SCID+1,,AUTO
         1 000103   200074 630500                    EPPR0   SCID+1,,AUTO
         1 000104   000020 631400 xsym               EPPR1   B_VECTNIL+16
         1 000105   000000 701000 xent               TSX1    SSR$REG
         1 000106   000110 702000 1                  TSX2    s:6142
         1 000107   000143 710000 1                  TRA     s:6160

      813     6139    3           WHENALTRETURN DO;

      814     6140                    /* problem REG'ing the user */
      815     6141                    %LOCK( G=NK$LDCT.LOCK);

   6142  1 000110   200063 236100                    LDQ     LDCT$,,AUTO
         1 000111   000020 036003                    ADLQ    16,DU
         1 000112   200074 756100                    STQ     SCID+1,,AUTO
         1 000113   200074 630500                    EPPR0   SCID+1,,AUTO
         1 000114   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 000115   000000 701000 xent               TSX1    HFC$LOCK
         1 000116   000000 011000                    NOP     0

      816     6144    3               IF NK$LDCT.IP$ ~= ADDR( NIL) THEN

   6144  1 000117   200063 470500                    LDP0    LDCT$,,AUTO
         1 000120   000013 236100                    LDQ     11,,PR0
         1 000121   000001 116000 xsym               CMPQ    B_VECTNIL+1
         1 000122   000152 601000 1                  TNZ     READ_IT

      817     6145    3                   GOTO READ_IT;
      818     6146    3   BRKCK:
      819     6147                    %UNLOCK( G=NK$LDCT.LOCK);

PL6.E3A0      #004=KIS$OSI_READ File=KIS$OSI.:E05TSI                             WED 07/30/97 00:41 Page:129  
   6148  1 000123   200063 236100       BRKCK        LDQ     LDCT$,,AUTO
         1 000124   000020 036003                    ADLQ    16,DU
         1 000125   200074 756100                    STQ     SCID+1,,AUTO
         1 000126   200074 630500                    EPPR0   SCID+1,,AUTO
         1 000127   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 000130   000000 701000 xent               TSX1    HFC$UNLOCK
         1 000131   000000 011000                    NOP     0

      820     6150    3               CALL SC_PRTCL_SNAP;

   6150  1 000132   000000 713400 xsym               CLIMB   SC_PRTCL_SNAP
         1 000133   000000 600000 xsid               climb   nvectors=         0

      821     6151    3               IF K$RWPARM.ERR ~= 0 THEN

   6151  1 000134   200017 235100                    LDA     K$RWPARM+11,,AUTO
         1 000135   000137 600000 1                  TZE     s:6153

      822     6152    3                   ALTRETURN;

   6152  1 000136   000000 702200 xent               TSX2  ! X66_AALT

      823     6153    3               B$JIT.ERR = ERRCANTREG;

   6153  1 000137   000002 236000 0                  LDQ     ERRCANTREG
         1 000140   000000 470400 xsym               LDP0    B$JIT$
         1 000141   000012 756100                    STQ     10,,PR0

      824     6154                    /*E*  ERROR:  KIS-E$CANTREG-A
      825     6155                        MESSAGE:  Internal error.  Funny wait-read REG ALTRETURN.
      826     6156                    */
      827     6157    3               ALTRETURN;

   6157  1 000142   000000 702200 xent               TSX2  ! X66_AALT

      828     6158    3               END;
      829     6159                %LOCK( G=NK$LDCT.LOCK);
PL6.E3A0      #004=KIS$OSI_READ File=KIS$OSI.:E05TSI                             WED 07/30/97 00:41 Page:130  

   6160  1 000143   200063 236100                    LDQ     LDCT$,,AUTO
         1 000144   000020 036003                    ADLQ    16,DU
         1 000145   200074 756100                    STQ     SCID+1,,AUTO
         1 000146   200074 630500                    EPPR0   SCID+1,,AUTO
         1 000147   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 000150   000000 701000 xent               TSX1    HFC$LOCK
         1 000151   000000 011000                    NOP     0

      830     6162    2   READ_IT:
      831     6163    2           K$RWPARM.IP$ = NK$LDCT.IP$;

   6163  1 000152   200063 470500       READ_IT      LDP0    LDCT$,,AUTO
         1 000153   000013 236100                    LDQ     11,,PR0
         1 000154   200016 756100                    STQ     K$RWPARM+10,,AUTO

      832     6164    2           NK$LDCT.IP$ = ADDR( NIL);

   6164  1 000155   000001 236000 xsym               LDQ     B_VECTNIL+1
         1 000156   000013 756100                    STQ     11,,PR0

      833     6165    3           IF K$RWPARM.IP$ = ADDR( NIL) THEN DO;

   6165  1 000157   200016 236100                    LDQ     K$RWPARM+10,,AUTO
         1 000160   000001 116000 xsym               CMPQ    B_VECTNIL+1
         1 000161   000175 601000 1                  TNZ     s:6176

      834     6166                    %UNLOCK( G=NK$LDCT.LOCK);

   6167  1 000162   200063 236100                    LDQ     LDCT$,,AUTO
         1 000163   000020 036003                    ADLQ    16,DU
         1 000164   200074 756100                    STQ     SCID+1,,AUTO
         1 000165   200074 630500                    EPPR0   SCID+1,,AUTO
         1 000166   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 000167   000000 701000 xent               TSX1    HFC$UNLOCK
         1 000170   000000 011000                    NOP     0

PL6.E3A0      #004=KIS$OSI_READ File=KIS$OSI.:E05TSI                             WED 07/30/97 00:41 Page:131  
      835     6169    3               B$JIT.ERR = ERRNOREAD;

   6169  1 000171   000005 236000 0                  LDQ     ERRNOREAD
         1 000172   000000 470400 xsym               LDP0    B$JIT$
         1 000173   000012 756100                    STQ     10,,PR0

      836     6170                    /*E*  ERROR:  KIS-E$NOREAD-A
      837     6171                        MESSAGE:  Internal error.  Message lost.
      838     6172                    */
      839     6173    3               GOTO SNAP;

   6173  1 000174   000020 710000 1                  TRA     SNAP

      840     6174    3               END;
      841     6175                /*N* document this */
      842     6176    2           CALL KIQ$MAPFEP( NK$LDCT.IPFEI#);

   6176  1 000175   200063 236100                    LDQ     LDCT$,,AUTO
         1 000176   000002 036000 2                  ADLQ    2
         1 000177   200074 756100                    STQ     SCID+1,,AUTO
         1 000200   200074 630500                    EPPR0   SCID+1,,AUTO
         1 000201   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 000202   000000 701000 xent               TSX1    KIQ$MAPFEP
         1 000203   000000 011000                    NOP     0

      843     6177    2           K$RWPARM.MSG$ = PINCRC( K$RWPARM.IP$, K$RWPARM.IP$->KI$QMHDR.OFFSET);

   6177  1 000204   200016 470500                    LDP0    K$RWPARM+10,,AUTO
         1 000205   000001 236100                    LDQ     1,,PR0
         1 000206   000022 772000                    QRL     18
         1 000207   000020 736000                    QLS     16
         1 000210   200016 036100                    ADLQ    K$RWPARM+10,,AUTO
         1 000211   200004 756100                    STQ     K$RWPARM,,AUTO

      844     6178    2           K$RWPARM.MSGSZ = K$RWPARM.IP$->KI$QMHDR.SIZE;

   6178  1 000212   000001 236100                    LDQ     1,,PR0
PL6.E3A0      #004=KIS$OSI_READ File=KIS$OSI.:E05TSI                             WED 07/30/97 00:41 Page:132  
         1 000213   777777 376007                    ANQ     -1,DL
         1 000214   200005 756100                    STQ     K$RWPARM+1,,AUTO

      845     6179    2           K$RWPARM.TYC = '0'B;

   6179  1 000215   200012 450100                    STZ     K$RWPARM+6,,AUTO

      846     6180                /* set up to move data into user buffer */
      847     6181    2           CALL HFF$DSIZ( B$PS2$, LEN) ALTRET( BAD_BUFFER);

   6181  1 000216   200064 631500                    EPPR1   LEN,,AUTO
         1 000217   200075 451500                    STP1    SCID+2,,AUTO
         1 000220   000003 236000 2                  LDQ     3
         1 000221   200074 756100                    STQ     SCID+1,,AUTO
         1 000222   200074 630500                    EPPR0   SCID+1,,AUTO
         1 000223   000020 631400 xsym               EPPR1   B_VECTNIL+16
         1 000224   000000 701000 xent               TSX1    HFF$DSIZ
         1 000225   000656 702000 1                  TSX2    BAD_BUFFER

      848     6182    3           IF K$RWPARM.MSGSZ > LEN THEN DO;

   6182  1 000226   200064 236100                    LDQ     LEN,,AUTO
         1 000227   000237 604000 1                  TMI     s:6187
         1 000230   200005 116100                    CMPQ    K$RWPARM+1,,AUTO
         1 000231   000237 605000 1                  TPL     s:6187

      849     6183                    /* received message larger than user buffer; note truncated */
      850     6184    3               K$RWPARM.TYC = %TYC_LD | %TYC_EGV;

   6184  1 000232   000012 236000 0                  LDQ     ERRXTRARD+2
         1 000233   000030 276000 xsym               ORQ     B_VECTNIL+24
         1 000234   200012 756100                    STQ     K$RWPARM+6,,AUTO

      851     6185    3               K$RWPARM.MSGSZ = LEN;

   6185  1 000235   200064 235100                    LDA     LEN,,AUTO
         1 000236   200005 755100                    STA     K$RWPARM+1,,AUTO
PL6.E3A0      #004=KIS$OSI_READ File=KIS$OSI.:E05TSI                             WED 07/30/97 00:41 Page:133  

      852     6186    3               END;

      853     6187    3           IF K$RWPARM.MSG$ ~= ADDR( NIL) THEN DO;

   6187  1 000237   200004 236100                    LDQ     K$RWPARM,,AUTO
         1 000240   000001 116000 xsym               CMPQ    B_VECTNIL+1
         1 000241   000257 600000 1                  TZE     s:6195

      854     6188                    /* set up to trap bad user buffer */
      855     6189    3               CALL HFF$TRAPALT ALTRET( BAD_BUFFER);

   6189  1 000242   000002 631400 xsym               EPPR1   B_VECTNIL+2
         1 000243   000000 701000 xent               TSX1    HFF$TRAPALT
         1 000244   000656 702000 1                  TSX2    BAD_BUFFER

      856     6190                    /* try to move the message */
      857     6191    3               BUFFER = MESSAGE;

   6191  1 000245   200004 470500                    LDP0    K$RWPARM,,AUTO
         1 000246   200005 720100                    LXL0    K$RWPARM+1,,AUTO
         1 000247   000000 471400 xsym               LDP1    B$PS2$
         1 000250   200064 721100                    LXL1    LEN,,AUTO
         1 000251   040140 100540                    MLR     fill='040'O
         1 000252   000000 000010                    ADSC9   0,,PR0                   cn=0,n=*X0
         1 000253   100000 000011                    ADSC9   0,,PR1                   cn=0,n=*X1

      858     6192                    /* it worked; save moved length in DCB */
      859     6193    3               F$DCB.ARS = K$RWPARM.MSGSZ;

   6193  1 000254   200062 470500                    LDP0    JDCB$,,AUTO
         1 000255   200005 235100                    LDA     K$RWPARM+1,,AUTO
         1 000256   000000 755100                    STA     0,,PR0

      860     6194    3               END;

      861     6195    2           B$JIT.ERR = K$RWPARM.MSG_ERRCODE;
PL6.E3A0      #004=KIS$OSI_READ File=KIS$OSI.:E05TSI                             WED 07/30/97 00:41 Page:134  

   6195  1 000257   200043 236100                    LDQ     K$RWPARM+31,,AUTO
         1 000260   000000 470400 xsym               LDP0    B$JIT$
         1 000261   000012 756100                    STQ     10,,PR0

      862     6196    2           K$RWPARM.LDCT$ = LDCT$;

   6196  1 000262   200063 236100                    LDQ     LDCT$,,AUTO
         1 000263   200022 756100                    STQ     K$RWPARM+14,,AUTO

      863     6197    2           K$RWPARM.FUNCTION = %K_READDONE;

   6197  1 000264   000011 235007                    LDA     9,DL
         1 000265   200024 755100                    STA     K$RWPARM+16,,AUTO

      864     6198    2           CALL KIT$SEND( K$RWPARM) ALTRET( BRKCK);

   6198  1 000266   200004 631500                    EPPR1   K$RWPARM,,AUTO
         1 000267   200074 451500                    STP1    SCID+1,,AUTO
         1 000270   200074 630500                    EPPR0   SCID+1,,AUTO
         1 000271   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 000272   000000 701000 xent               TSX1    KIT$SEND
         1 000273   000123 702000 1                  TSX2    BRKCK

      865     6199                %UNLOCK( G=NK$LDCT.LOCK);

   6200  1 000274   200063 236100                    LDQ     LDCT$,,AUTO
         1 000275   000020 036003                    ADLQ    16,DU
         1 000276   200074 756100                    STQ     SCID+1,,AUTO
         1 000277   200074 630500                    EPPR0   SCID+1,,AUTO
         1 000300   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 000301   000000 701000 xent               TSX1    HFC$UNLOCK
         1 000302   000000 011000                    NOP     0

      866     6202    2           RETURN;

   6202  1 000303   000000 702200 xent               TSX2  ! X66_ARET
PL6.E3A0      #004=KIS$OSI_READ File=KIS$OSI.:E05TSI                             WED 07/30/97 00:41 Page:135  

      867     6203    2           END;
      868     6204            /* otherwise, this is a no-wait read request */
      869     6205            %UNLOCK( G=NK$LDCT.LOCK);

   6206  1 000304   200063 236100                    LDQ     LDCT$,,AUTO
         1 000305   000020 036003                    ADLQ    16,DU
         1 000306   200074 756100                    STQ     SCID+1,,AUTO
         1 000307   200074 630500                    EPPR0   SCID+1,,AUTO
         1 000310   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 000311   000000 701000 xent               TSX1    HFC$UNLOCK
         1 000312   000000 011000                    NOP     0

      870     6208            /*N* All of the following needs to be better documented */
      871     6209            /* set up the buffer area of the DCB */
      872     6210    1       FEPSIZ.BUF = F$DCB.UBYTES;

   6210  1 000313   200062 470500                    LDP0    JDCB$,,AUTO
         1 000314   000076 720100                    LXL0    62,,PR0
         1 000315   200061 740100                    STX0    FEPSIZ,,AUTO

      873     6211    1       CALL MMS$SETUP_BUF( %USERWSQ, F$DCB.UB$, F$DCB.UBYTES, R$, PTW);

   6211  1 000316   200070 631500                    EPPR1   PTW,,AUTO
         1 000317   200100 451500                    STP1    SCID+5,,AUTO
         1 000320   200072 633500                    EPPR3   R$,,AUTO
         1 000321   200077 453500                    STP3    SCID+4,,AUTO
         1 000322   200062 236100                    LDQ     JDCB$,,AUTO
         1 000323   000076 036003                    ADLQ    62,DU
         1 000324   200076 756100                    STQ     SCID+3,,AUTO
         1 000325   200062 236100                    LDQ     JDCB$,,AUTO
         1 000326   000075 036003                    ADLQ    61,DU
         1 000327   000004 235000 2                  LDA     4
         1 000330   200074 757100                    STAQ    SCID+1,,AUTO
         1 000331   200074 630500                    EPPR0   SCID+1,,AUTO
         1 000332   000023 631400 xsym               EPPR1   B_VECTNIL+19
         1 000333   000000 701000 xent               TSX1    MMS$SETUP_BUF
PL6.E3A0      #004=KIS$OSI_READ File=KIS$OSI.:E05TSI                             WED 07/30/97 00:41 Page:136  
         1 000334   000000 011000                    NOP     0

      874     6212    1       FEPIO.BUFX = POFFC( R$, B$CGCTXT$);

   6212  1 000335   000000 236000 xsym               LDQ     B$CGCTXT$
         1 000336   000020 772000                    QRL     16
         1 000337   200074 756100                    STQ     SCID+1,,AUTO
         1 000340   200072 236100                    LDQ     R$,,AUTO
         1 000341   000020 772000                    QRL     16
         1 000342   200074 136100                    SBLQ    SCID+1,,AUTO
         1 000343   000000 620006                    EAX0    0,QL
         1 000344   200056 440100                    SXL0    FEPIO+1,,AUTO

      875     6213    1       FEPIO.BPP(0) = PTW.PP(0);

   6213  1 000345   200070 221100                    LDX1    PTW,,AUTO
         1 000346   200057 741100                    STX1    FEPIO+2,,AUTO

      876     6214    1       FEPIO.BPP(1) = PTW.PP(1);

   6214  1 000347   200071 222100                    LDX2    PTW+1,,AUTO
         1 000350   200057 442100                    SXL2    FEPIO+2,,AUTO

      877     6215            /* save the DCB# of the user specified DCB and the event */
      878     6216    1       FEPIO.EVENT = FPT$READ_V.EVENT;

   6216  1 000351   000000 470400 xsym               LDP0    B$PS0$
         1 000352   000001 235100                    LDA     1,,PR0
         1 000353   200055 755100                    STA     FEPIO,,AUTO

      879     6217    1       NOWAIT.DCB# = B$JIT.DCBNO;

   6217  1 000354   000000 471400 xsym               LDP1    B$JIT$
         1 000355   100022 236100                    LDQ     18,,PR1
         1 000356   000011 736000                    QLS     9
         1 000357   200067 552110                    STBQ    NOWAIT,'10'O,AUTO

PL6.E3A0      #004=KIS$OSI_READ File=KIS$OSI.:E05TSI                             WED 07/30/97 00:41 Page:137  
      880     6218    1       NOWAIT.STREAM = K$RWPARM.STR;

   6218  1 000360   200044 236100                    LDQ     K$RWPARM+32,,AUTO
         1 000361   000022 736000                    QLS     18
         1 000362   200067 552120                    STBQ    NOWAIT,'20'O,AUTO

      881     6219    1       CALL FMO$GETDOMAIN( DMN);

   6219  1 000363   200054 633500                    EPPR3   DMN,,AUTO
         1 000364   200074 453500                    STP3    SCID+1,,AUTO
         1 000365   200074 630500                    EPPR0   SCID+1,,AUTO
         1 000366   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 000367   000000 701000 xent               TSX1    FMO$GETDOMAIN
         1 000370   000000 011000                    NOP     0

      882     6220    1       NOWAIT.DMN = DMN;

   6220  1 000371   200054 236100                    LDQ     DMN,,AUTO
         1 000372   000033 736000                    QLS     27
         1 000373   200067 676100                    ERQ     NOWAIT,,AUTO
         1 000374   007000 376003                    ANQ     3584,DU
         1 000375   200067 656100                    ERSQ    NOWAIT,,AUTO

      883     6221            /* make sure we have write access */
      884     6222    1       CALL HFF$WRITE1( 2) ALTRET( BAD_BUFFER);

   6222  1 000376   000005 630400 2                  EPPR0   5
         1 000377   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 000400   000000 701000 xent               TSX1    HFF$WRITE1
         1 000401   000656 702000 1                  TSX2    BAD_BUFFER

      885     6223            /* set up to get the TCTX */
      886     6224    1       SCID = ASCBIN( F$DCB.DVFC);

   6224  1 000402   200062 470500                    LDP0    JDCB$,,AUTO
         1 000403   000044 236100                    LDQ     36,,PR0
         1 000404   000011 772000                    QRL     9
PL6.E3A0      #004=KIS$OSI_READ File=KIS$OSI.:E05TSI                             WED 07/30/97 00:41 Page:138  
         1 000405   000777 376007                    ANQ     511,DL
         1 000406   200073 756100                    STQ     SCID,,AUTO

      887     6225    2       IF SCID > KIS_SSN_MAXMAJOR THEN DO;

   6225  1 000407   000417 604000 1                  TMI     s:6233
         1 000410   000000 116000 xsym               CMPQ    KIS_SSN_MAXMAJOR
         1 000411   000417 602000 1                  TNC     s:6233
         1 000412   000417 600000 1                  TZE     s:6233

      888     6226                /* no way can this be a legal appl id */
      889     6227    2           B$JIT.ERR = ERRBADSCID;

   6227  1 000413   000001 236000 0                  LDQ     ERRBADSCID
         1 000414   000000 471400 xsym               LDP1    B$JIT$
         1 000415   100012 756100                    STQ     10,,PR1

      890     6228                /*    ERROR:  KIS-E$BADSCID-A
      891     6229                    MESSAGE:  Bad Session connection identifier.
      892     6230                */
      893     6231    2           GOTO SNAP;

   6231  1 000416   000020 710000 1                  TRA     SNAP

      894     6232    2           END;
      895     6233    1       MINOR$ = ADDR( NIL);

   6233  1 000417   000001 236000 xsym               LDQ     B_VECTNIL+1
         1 000420   200066 756100                    STQ     MINOR$,,AUTO

      896     6234    1       MAJOR$ = PINCRW( KIS_MAJOR$, SCID);

   6234  1 000421   200073 236100                    LDQ     SCID,,AUTO
         1 000422   000022 736000                    QLS     18
         1 000423   000000 036000 xsym               ADLQ    KIS_MAJOR$
         1 000424   200065 756100                    STQ     MAJOR$,,AUTO

PL6.E3A0      #004=KIS$OSI_READ File=KIS$OSI.:E05TSI                             WED 07/30/97 00:41 Page:139  
      897     6235    2       IF MAJOR$->APPL.Z.LINK ~= 0 THEN DO;

   6235  1 000425   200065 471500                    LDP1    MAJOR$,,AUTO
         1 000426   100000 236100                    LDQ     0,,PR1
         1 000427   000777 316007                    CANQ    511,DL
         1 000430   000445 600000 1                  TZE     s:6246

      898     6236    2           MINOR$ = PINCRW( KIS_MINOR$, MAJOR$->APPL.Z.LINK);

   6236  1 000431   100000 720100                    LXL0    0,,PR1
         1 000432   000777 360003                    ANX0    511,DU
         1 000433   000000 636010                    EAQ     0,X0
         1 000434   000000 036000 xsym               ADLQ    KIS_MINOR$
         1 000435   200066 756100                    STQ     MINOR$,,AUTO

      899     6237    3           IF MINOR$->APPL.TCTX = 0 THEN DO;

   6237  1 000436   200066 473500                    LDP3    MINOR$,,AUTO
         1 000437   300000 221100                    LDX1    0,,PR3
         1 000440   000445 601000 1                  TNZ     s:6246

      900     6238    3               B$JIT.ERR = ERRTRANCLOSED;

   6238  1 000441   000006 236000 0                  LDQ     ERRTRANCLOSED
         1 000442   000000 474400 xsym               LDP4    B$JIT$
         1 000443   400012 756100                    STQ     10,,PR4

      901     6239                    /*    ERROR:  KIS-E$TRANCLOSED-A
      902     6240                        MESSAGE:  Transport connection doesn't exist.
      903     6241                    */
      904     6242    3               ALTRETURN;

   6242  1 000444   000000 702200 xent               TSX2  ! X66_AALT

      905     6243    3               END;
      906     6244    2           END;
      907     6245            %LOCK( G=NK$LDCT.LOCK);
PL6.E3A0      #004=KIS$OSI_READ File=KIS$OSI.:E05TSI                             WED 07/30/97 00:41 Page:140  

   6246  1 000445   200063 236100                    LDQ     LDCT$,,AUTO
         1 000446   000020 036003                    ADLQ    16,DU
         1 000447   200074 756100                    STQ     SCID+1,,AUTO
         1 000450   200074 630500                    EPPR0   SCID+1,,AUTO
         1 000451   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 000452   000000 701000 xent               TSX1    HFC$LOCK
         1 000453   000000 011000                    NOP     0

      908     6248    2       IF NK$LDCT.LKFLG.NOWAIT THEN DO;

   6248  1 000454   200063 470500                    LDP0    LDCT$,,AUTO
         1 000455   000011 236100                    LDQ     9,,PR0
         1 000456   000001 316003                    CANQ    1,DU
         1 000457   000514 600000 1                  TZE     s:6261

      909     6249                /* at least one other no-wait read pending */
      910     6250    2           IF FEPSIZ ~= F$DCB.FEPSIZ OR NK$LDCT.NOWAIT ~= NOWAIT THEN

   6250  1 000460   200062 471500                    LDP1    JDCB$,,AUTO
         1 000461   200061 236100                    LDQ     FEPSIZ,,AUTO
         1 000462   100106 116100                    CMPQ    70,,PR1
         1 000463   000041 601000 1                  TNZ     CANCEL
         1 000464   000100 106500                    CMPC    fill='000'O
         1 000465   000010 000003                    ADSC9   8,,PR0                   cn=0,n=3
         1 000466   200067 000004                    ADSC9   NOWAIT,,AUTO             cn=0,n=4
         1 000467   000041 601000 1                  TNZ     CANCEL

      911     6251    2               GOTO CANCEL;
      912     6252    3           IF F$DCB.FCN.CNT(0) >= 3 THEN DO;

   6252  1 000470   100074 236100                    LDQ     60,,PR1
         1 000471   377000 376003                    ANQ     130560,DU
         1 000472   003000 116003                    CMPQ    1536,DU
         1 000473   000521 602000 1                  TNC     s:6264

      913     6253                    /* too many reads outstanding.. have to cancel one of 'em */
PL6.E3A0      #004=KIS$OSI_READ File=KIS$OSI.:E05TSI                             WED 07/30/97 00:41 Page:141  
      914     6254    3               K$RWPARM = K_RWPARM_CON;

   6254  1 000474   000100 100400                    MLR     fill='000'O
         1 000475   000000 000234 xsym               ADSC9   K_RWPARM_CON             cn=0,n=156
         1 000476   200004 000234                    ADSC9   K$RWPARM,,AUTO           cn=0,n=156

      915     6255    3               K$RWPARM.MSG_ERRCODE = ERRXTRARD;

   6255  1 000477   000010 236000 0                  LDQ     ERRXTRARD
         1 000500   200043 756100                    STQ     K$RWPARM+31,,AUTO

      916     6256    3               K$RWPARM.TYC = %TYC_XTRARD;

   6256  1 000501   000011 236000 0                  LDQ     ERRXTRARD+1
         1 000502   200012 756100                    STQ     K$RWPARM+6,,AUTO

      917     6257    3               CALL KIA$COMP( NK$LDCT, K$RWPARM);

   6257  1 000503   200004 633500                    EPPR3   K$RWPARM,,AUTO
         1 000504   200075 453500                    STP3    SCID+2,,AUTO
         1 000505   200063 236100                    LDQ     LDCT$,,AUTO
         1 000506   200074 756100                    STQ     SCID+1,,AUTO
         1 000507   200074 630500                    EPPR0   SCID+1,,AUTO
         1 000510   000020 631400 xsym               EPPR1   B_VECTNIL+16
         1 000511   000000 701000 xent               TSX1    KIA$COMP
         1 000512   000000 011000                    NOP     0

      918     6258    3               END;

      919     6259    2           END;

   6259  1 000513   000521 710000 1                  TRA     s:6264

      920     6260    2       ELSE DO;

      921     6261    2           NK$LDCT.NOWAIT = NOWAIT;

PL6.E3A0      #004=KIS$OSI_READ File=KIS$OSI.:E05TSI                             WED 07/30/97 00:41 Page:142  
   6261  1 000514   200067 236100                    LDQ     NOWAIT,,AUTO
         1 000515   000010 552170                    STBQ    8,'70'O,PR0

      922     6262    2           F$DCB.FEPSIZ = FEPSIZ;

   6262  1 000516   200061 236100                    LDQ     FEPSIZ,,AUTO
         1 000517   200062 471500                    LDP1    JDCB$,,AUTO
         1 000520   100106 756100                    STQ     70,,PR1

      923     6263    2           END;

      924     6264    1       NK$LDCT.LKFLG.NOWAIT = '1'B;

   6264  1 000521   200063 470500                    LDP0    LDCT$,,AUTO
         1 000522   000001 236003                    LDQ     1,DU
         1 000523   000011 256100                    ORSQ    9,,PR0

      925     6265            /* increment the user's MF count */
      926     6266            %LOCK( G=NI_MFGATE);

   6267  1 000524   000006 630400 2                  EPPR0   6
         1 000525   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 000526   000000 701000 xent               TSX1    HFC$LOCK
         1 000527   000000 011000                    NOP     0

      927     6269    1       S$CU$->B$U.MF = S$CU$->B$U.MF + 1;

   6269  1 000530   000000 470400 xsym               LDP0    S$CU$
         1 000531   000006 236100                    LDQ     6,,PR0
         1 000532   001000 036003                    ADLQ    512,DU
         1 000533   000006 552140                    STBQ    6,'40'O,PR0

      928     6270    1       S$CU$->B$U.CMF = S$CU$->B$U.CMF + 1;

   6270  1 000534   000007 236100                    LDQ     7,,PR0
         1 000535   000001 036007                    ADLQ    1,DL
         1 000536   000007 752101                    STCQ    7,'01'O,PR0
PL6.E3A0      #004=KIS$OSI_READ File=KIS$OSI.:E05TSI                             WED 07/30/97 00:41 Page:143  

      929     6271            %UNLOCK( G=NI_MFGATE);

   6272  1 000537   000006 630400 2                  EPPR0   6
         1 000540   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 000541   000000 701000 xent               TSX1    HFC$UNLOCK
         1 000542   000000 011000                    NOP     0

      930     6274    1       IF F$DCB.FCN.CNT(0) = 1 THEN

   6274  1 000543   200062 470500                    LDP0    JDCB$,,AUTO
         1 000544   000074 236100                    LDQ     60,,PR0
         1 000545   377000 376003                    ANQ     130560,DU
         1 000546   001000 116003                    CMPQ    512,DU
         1 000547   000554 601000 1                  TNZ     s:6277

      931     6275    1           F$DCB.FEPIO2 = FEPIO;

   6275  1 000550   000100 100500                    MLR     fill='000'O
         1 000551   200055 000020                    ADSC9   FEPIO,,AUTO              cn=0,n=16
         1 000552   000127 000020                    ADSC9   87,,PR0                  cn=0,n=16
         1 000553   000566 710000 1                  TRA     s:6281

      932     6276    1       ELSE
      933     6277    1           IF F$DCB.FCN.CNT(0) < 1 THEN

   6277  1 000554   000074 236100                    LDQ     60,,PR0
         1 000555   377000 316003                    CANQ    130560,DU
         1 000556   000563 601000 1                  TNZ     s:6280

      934     6278    1               F$DCB.FEPIO = FEPIO;

   6278  1 000557   000100 100500                    MLR     fill='000'O
         1 000560   200055 000020                    ADSC9   FEPIO,,AUTO              cn=0,n=16
         1 000561   000110 000020                    ADSC9   72,,PR0                  cn=0,n=16
         1 000562   000566 710000 1                  TRA     s:6281

PL6.E3A0      #004=KIS$OSI_READ File=KIS$OSI.:E05TSI                             WED 07/30/97 00:41 Page:144  
      935     6279    1           ELSE
      936     6280    1               F$DCB.FEPIO3 = FEPIO;

   6280  1 000563   000100 100500                    MLR     fill='000'O
         1 000564   200055 000020                    ADSC9   FEPIO,,AUTO              cn=0,n=16
         1 000565   000133 000020                    ADSC9   91,,PR0                  cn=0,n=16

      937     6281    1       F$DCB.FCN.CNT(0) = F$DCB.FCN.CNT(0) + 1;

   6281  1 000566   000074 236100                    LDQ     60,,PR0
         1 000567   000033 772000                    QRL     27
         1 000570   000377 376007                    ANQ     255,DL
         1 000571   000001 036007                    ADLQ    1,DL
         1 000572   000033 736000                    QLS     27
         1 000573   000074 676100                    ERQ     60,,PR0
         1 000574   377000 376003                    ANQ     130560,DU
         1 000575   000074 656100                    ERSQ    60,,PR0

      938     6282    2       IF MINOR$ ~= ADDR( NIL) THEN DO;

   6282  1 000576   200066 236100                    LDQ     MINOR$,,AUTO
         1 000577   000001 116000 xsym               CMPQ    B_VECTNIL+1
         1 000600   000642 600000 1                  TZE     s:6308

      939     6283                /* let Transport know we can handle another input record now */
      940     6284    2           K$RWPARM.FUNCTION = %K_TCREDIT;

   6284  1 000601   000032 235007                    LDA     26,DL
         1 000602   200024 755100                    STA     K$RWPARM+16,,AUTO

      941     6285    2           K$RWPARM.SSN_CRDT = 1;

   6285  1 000603   000001 235007                    LDA     1,DL
         1 000604   200031 755100                    STA     K$RWPARM+21,,AUTO

      942     6286    2           K$RWPARM.TCTX# = MINOR$->APPL.TCTX;

PL6.E3A0      #004=KIS$OSI_READ File=KIS$OSI.:E05TSI                             WED 07/30/97 00:41 Page:145  
   6286  1 000605   200066 471500                    LDP1    MINOR$,,AUTO
         1 000606   100000 220100                    LDX0    0,,PR1
         1 000607   200037 740100                    STX0    K$RWPARM+27,,AUTO

      943     6287    2   TRYSEND:
      944     6288    2           CALL KIT$SEND( K$RWPARM)

   6288  1 000610   200004 630500       TRYSEND      EPPR0   K$RWPARM,,AUTO
         1 000611   200074 450500                    STP0    SCID+1,,AUTO
         1 000612   200074 630500                    EPPR0   SCID+1,,AUTO
         1 000613   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 000614   000000 701000 xent               TSX1    KIT$SEND
         1 000615   000617 702000 1                  TSX2    s:6291
         1 000616   000642 710000 1                  TRA     s:6308

      945     6289    3           WHENALTRETURN DO;

      946     6290                    /* Transport couldn't deal with the credit msg */
      947     6291    4               IF K$RWPARM.ERR = %K$QFULL THEN DO;

   6291  1 000617   200017 235100                    LDA     K$RWPARM+11,,AUTO
         1 000620   000001 115007                    CMPA    1,DL
         1 000621   000627 601000 1                  TNZ     s:6295

      948     6292    4                   CALL KIA$OQFL( NK$LDCT) ALTRET( SNAP);

   6292  1 000622   200063 630500                    EPPR0   LDCT$,,AUTO
         1 000623   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 000624   000000 701000 xent               TSX1    KIA$OQFL
         1 000625   000020 702000 1                  TSX2    SNAP

      949     6293    4                   GOTO TRYSEND;

   6293  1 000626   000610 710000 1                  TRA     TRYSEND

      950     6294    4                   END;
      951     6295    3               IF K$RWPARM.ERR = %K$USER_ERR THEN
PL6.E3A0      #004=KIS$OSI_READ File=KIS$OSI.:E05TSI                             WED 07/30/97 00:41 Page:146  

   6295  1 000627   000010 115007                    CMPA    8,DL
         1 000630   000635 601000 1                  TNZ     s:6298

      952     6296    3                   B$JIT.ERR = K$RWPARM.MSG_ERRCODE;

   6296  1 000631   200043 236100                    LDQ     K$RWPARM+31,,AUTO
         1 000632   000000 470400 xsym               LDP0    B$JIT$
         1 000633   000012 756100                    STQ     10,,PR0
         1 000634   000642 710000 1                  TRA     s:6308

      953     6297    4               ELSE DO;

      954     6298    4                   B$JIT.ERR = ERRTRANSPORT;

   6298  1 000635   000007 236000 0                  LDQ     ERRTRANSPORT
         1 000636   000000 470400 xsym               LDP0    B$JIT$
         1 000637   000012 756100                    STQ     10,,PR0

      955     6299                        /*    ERROR:  KIS-E$TRANSPORT-A
      956     6300                            MESSAGE:  Internal error.  Transport ALTRETURN.
      957     6301                        */
      958     6302    4                   CALL SC_PRTCL_SNAP;

   6302  1 000640   000000 713400 xsym               CLIMB   SC_PRTCL_SNAP
         1 000641   000000 600000 xsid               climb   nvectors=         0

      959     6303    4                   END;

      960     6304    3               END;

      961     6305    2           END;

      962     6306            /* all done for now... */
      963     6307            %UNLOCK( G=NK$LDCT.LOCK);

   6308  1 000642   200063 236100                    LDQ     LDCT$,,AUTO
PL6.E3A0      #004=KIS$OSI_READ File=KIS$OSI.:E05TSI                             WED 07/30/97 00:41 Page:147  
         1 000643   000020 036003                    ADLQ    16,DU
         1 000644   200074 756100                    STQ     SCID+1,,AUTO
         1 000645   200074 630500                    EPPR0   SCID+1,,AUTO
         1 000646   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 000647   000000 701000 xent               TSX1    HFC$UNLOCK
         1 000650   000000 011000                    NOP     0

      964     6310    1       IF B$JIT.ERR = '0'B THEN

   6310  1 000651   000000 470400 xsym               LDP0    B$JIT$
         1 000652   000012 235100                    LDA     10,,PR0
         1 000653   000655 601000 1                  TNZ     s:6312

      965     6311    1           RETURN;

   6311  1 000654   000000 702200 xent               TSX2  ! X66_ARET

      966     6312    1       ALTRETURN;

   6312  1 000655   000000 702200 xent               TSX2  ! X66_AALT

      967     6313    1   BAD_BUFFER:
      968     6314            /* no longer trap bad user buffer */
      969     6315    1       CALL HFF$TRAPALT;

   6315  1 000656   000002 631400 xsym  BAD_BUFFER   EPPR1   B_VECTNIL+2
         1 000657   000000 701000 xent               TSX1    HFF$TRAPALT
         1 000660   000000 011000                    NOP     0

      970     6316            %UNLOCK( G=NK$LDCT.LOCK);

   6317  1 000661   200063 236100                    LDQ     LDCT$,,AUTO
         1 000662   000020 036003                    ADLQ    16,DU
         1 000663   200074 756100                    STQ     SCID+1,,AUTO
         1 000664   200074 630500                    EPPR0   SCID+1,,AUTO
         1 000665   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 000666   000000 701000 xent               TSX1    HFC$UNLOCK
PL6.E3A0      #004=KIS$OSI_READ File=KIS$OSI.:E05TSI                             WED 07/30/97 00:41 Page:148  
         1 000667   000000 011000                    NOP     0

      971     6319    1       B$JIT.ERR = ERRBADBUFFER;

   6319  1 000670   000000 236000 0                  LDQ     ERRBADBUFFER
         1 000671   000000 470400 xsym               LDP0    B$JIT$
         1 000672   000012 756100                    STQ     10,,PR0

      972     6320            /*E*  ERROR:  KIS-E$BADBUFFER-A
      973     6321                MESSAGE:  Read buffer is inaccessible.
      974     6322            */
      975     6323    1       ALTRETURN;

   6323  1 000673   000000 702200 xent               TSX2  ! X66_AALT

      976     6324        %EJECT;
PL6.E3A0      #004=KIS$OSI_READ File=KIS$OSI.:E05TSI                             WED 07/30/97 00:41 Page:149  
      977     6325        /*F*    NAME:   KIS$OSI_TRUNC
      978     6326
      979     6327                PURPOSE:  Handle M$TRUNC of RES=NC DCB.
      980     6328        */
      981     6329        /*D*    NAME:   KIS$OSI_TRUNC
      982     6330                CALL:   CALL KIS$OSI_TRUNC ALTRET( label);
      983     6331                INPUT:
      984     6332                    B$JIT.DCB$->F$DCB the NC DCB itself.
      985     6333                OUTPUT:
      986     6334                    none.
      987     6335                DESCRIPTION:
      988     6336                    KIS$OSI_TRUNC is called from FMF$TRUNC in order to cancel
      989     6337                    the NoWait reads on an NC DCB.  The most common (only?)
      990     6338                    situation in which this needs to be done is when an OSI
      991     6339                    client application does an M$LINK/M$YC.  The NoWait reads
      992     6340                    issued by the Session library need to be COMP'd, and this
      993     6341                    involves interaction with the Transport layer to prevent
      994     6342                    more data from arriving while the application is off doing
      995     6343                    something else.
      996     6344        */
      997     6345    1   KIS$OSI_TRUNC: ENTRY ALTRET;

   6345  1 000674   000000 700200 xent  KIS$OSI_TRU* TSX0  ! X66_AUTO_0
         1 000675   000102 000000                    ZERO    66,0

      998     6346
      999     6347    1       JDCB$ = B$JIT.DCB$;

   6347  1 000676   000000 470400 xsym               LDP0    B$JIT$
         1 000677   000232 236100                    LDQ     154,,PR0
         1 000700   200062 756100                    STQ     JDCB$,,AUTO

     1000     6348    1       LDCT$ = NK$LDCT$( F$DCB.LDCTX);

   6348  1 000701   200062 471500                    LDP1    JDCB$,,AUTO
         1 000702   100051 220100                    LDX0    41,,PR1
         1 000703   000000 473400 xsym               LDP3    N$DCT$$
PL6.E3A0      #004=KIS$OSI_READ File=KIS$OSI.:E05TSI                             WED 07/30/97 00:41 Page:150  
         1 000704   300000 236110                    LDQ     0,X0,PR3
         1 000705   200063 756100                    STQ     LDCT$,,AUTO

     1001     6349    1       SCID = ASCBIN( F$DCB.DVFC);

   6349  1 000706   100044 236100                    LDQ     36,,PR1
         1 000707   000011 772000                    QRL     9
         1 000710   000777 376007                    ANQ     511,DL
         1 000711   200073 756100                    STQ     SCID,,AUTO

     1002     6350    1       MINOR$ = ADDR( NIL);

   6350  1 000712   000001 236000 xsym               LDQ     B_VECTNIL+1
         1 000713   200066 756100                    STQ     MINOR$,,AUTO

     1003     6351    1       MAJOR$ = PINCRW( KIS_MAJOR$, SCID);

   6351  1 000714   200073 236100                    LDQ     SCID,,AUTO
         1 000715   000022 736000                    QLS     18
         1 000716   000000 036000 xsym               ADLQ    KIS_MAJOR$
         1 000717   200065 756100                    STQ     MAJOR$,,AUTO

     1004     6352    1       IF MAJOR$->APPL.Z.LINK ~= 0 THEN

   6352  1 000720   200065 474500                    LDP4    MAJOR$,,AUTO
         1 000721   400000 236100                    LDQ     0,,PR4
         1 000722   000777 316007                    CANQ    511,DL
         1 000723   000731 600000 1                  TZE     s:6355

     1005     6353    1           MINOR$ = PINCRW( KIS_MINOR$, MAJOR$->APPL.Z.LINK);

   6353  1 000724   400000 721100                    LXL1    0,,PR4
         1 000725   000777 361003                    ANX1    511,DU
         1 000726   000000 636011                    EAQ     0,X1
         1 000727   000000 036000 xsym               ADLQ    KIS_MINOR$
         1 000730   200066 756100                    STQ     MINOR$,,AUTO

PL6.E3A0      #004=KIS$OSI_READ File=KIS$OSI.:E05TSI                             WED 07/30/97 00:41 Page:151  
     1006     6354            %LOCK( G=NK$LDCT.LOCK);

   6355  1 000731   200063 236100                    LDQ     LDCT$,,AUTO
         1 000732   000020 036003                    ADLQ    16,DU
         1 000733   200074 756100                    STQ     SCID+1,,AUTO
         1 000734   200074 630500                    EPPR0   SCID+1,,AUTO
         1 000735   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 000736   000000 701000 xent               TSX1    HFC$LOCK
         1 000737   000000 011000                    NOP     0

     1007     6357    2       IF NK$LDCT.LKFLG.NOWAIT THEN DO;

   6357  1 000740   200063 470500                    LDP0    LDCT$,,AUTO
         1 000741   000011 236100                    LDQ     9,,PR0
         1 000742   000001 316003                    CANQ    1,DU
         1 000743   001055 600000 1                  TZE     s:6392

     1008     6358                /* there are NoWait read(s) outstanding */
     1009     6359    2           IF MINOR$ = ADDR( NIL) OR MINOR$->APPL.TCTX = 0 THEN

   6359  1 000744   200066 236100                    LDQ     MINOR$,,AUTO
         1 000745   000001 116000 xsym               CMPQ    B_VECTNIL+1
         1 000746   001027 600000 1                  TZE     DONETRAN
         1 000747   200066 471500                    LDP1    MINOR$,,AUTO
         1 000750   100000 220100                    LDX0    0,,PR1
         1 000751   001027 600000 1                  TZE     DONETRAN

     1010     6360    2               GOTO DONETRAN;
     1011     6361    2           K$RWPARM = K_RWPARM_CON;

   6361  1 000752   000100 100400                    MLR     fill='000'O
         1 000753   000000 000234 xsym               ADSC9   K_RWPARM_CON             cn=0,n=156
         1 000754   200004 000234                    ADSC9   K$RWPARM,,AUTO           cn=0,n=156

     1012     6362    2           K$RWPARM.FUNCTION = %K_TCREDIT;

   6362  1 000755   000032 235007                    LDA     26,DL
PL6.E3A0      #004=KIS$OSI_READ File=KIS$OSI.:E05TSI                             WED 07/30/97 00:41 Page:152  
         1 000756   200024 755100                    STA     K$RWPARM+16,,AUTO

     1013     6363    2           K$RWPARM.SSN_CRDT = 0;

   6363  1 000757   200031 450100                    STZ     K$RWPARM+21,,AUTO

     1014     6364    2           K$RWPARM.TCTX# = MINOR$->APPL.TCTX;

   6364  1 000760   100000 220100                    LDX0    0,,PR1
         1 000761   200037 740100                    STX0    K$RWPARM+27,,AUTO

     1015     6365    2   TRYTRUNC:
     1016     6366    2           CALL KIT$SEND( K$RWPARM)

   6366  1 000762   200004 630500       TRYTRUNC     EPPR0   K$RWPARM,,AUTO
         1 000763   200074 450500                    STP0    SCID+1,,AUTO
         1 000764   200074 630500                    EPPR0   SCID+1,,AUTO
         1 000765   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 000766   000000 701000 xent               TSX1    KIT$SEND
         1 000767   000771 702000 1                  TSX2    s:6368
         1 000770   001002 710000 1                  TRA     s:6374

     1017     6367    3           WHENALTRETURN DO;

     1018     6368    4               IF K$RWPARM.ERR = %K$QFULL THEN DO;

   6368  1 000771   200017 235100                    LDA     K$RWPARM+11,,AUTO
         1 000772   000001 115007                    CMPA    1,DL
         1 000773   001001 601000 1                  TNZ     s:6372

     1019     6369    4                   CALL KIA$OQFL( NK$LDCT) ALTRET( SNAP);

   6369  1 000774   200063 630500                    EPPR0   LDCT$,,AUTO
         1 000775   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 000776   000000 701000 xent               TSX1    KIA$OQFL
         1 000777   000020 702000 1                  TSX2    SNAP

PL6.E3A0      #004=KIS$OSI_READ File=KIS$OSI.:E05TSI                             WED 07/30/97 00:41 Page:153  
     1020     6370    4                   GOTO TRYTRUNC;

   6370  1 001000   000762 710000 1                  TRA     TRYTRUNC

     1021     6371    4                   END;
     1022     6372    3               GOTO SNAP;

   6372  1 001001   000020 710000 1                  TRA     SNAP

     1023     6373    3               END;
     1024     6374    2           NK$LDCT.LKFLG.WTMRK = '1'B;

   6374  1 001002   200063 470500                    LDP0    LDCT$,,AUTO
         1 001003   020000 236003                    LDQ     8192,DU
         1 001004   000011 256100                    ORSQ    9,,PR0

     1025     6375    2   TRUNCLOOP:
     1026     6376    2           CALL SSR$REG( %SS_CW, NK$LDCT);  /* which unlocks ldct.lock */

   6376  1 001005   200063 236100       TRUNCLOOP    LDQ     LDCT$,,AUTO
         1 001006   000001 235000 2                  LDA     1
         1 001007   200074 757100                    STAQ    SCID+1,,AUTO
         1 001010   200074 630500                    EPPR0   SCID+1,,AUTO
         1 001011   000020 631400 xsym               EPPR1   B_VECTNIL+16
         1 001012   000000 701000 xent               TSX1    SSR$REG
         1 001013   000000 011000                    NOP     0

     1027     6377                %LOCK( G=NK$LDCT.LOCK);

   6378  1 001014   200063 236100                    LDQ     LDCT$,,AUTO
         1 001015   000020 036003                    ADLQ    16,DU
         1 001016   200074 756100                    STQ     SCID+1,,AUTO
         1 001017   200074 630500                    EPPR0   SCID+1,,AUTO
         1 001020   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 001021   000000 701000 xent               TSX1    HFC$LOCK
         1 001022   000000 011000                    NOP     0

PL6.E3A0      #004=KIS$OSI_READ File=KIS$OSI.:E05TSI                             WED 07/30/97 00:41 Page:154  
     1028     6380    2           IF NK$LDCT.LKFLG.WTMRK THEN

   6380  1 001023   200063 470500                    LDP0    LDCT$,,AUTO
         1 001024   000011 236100                    LDQ     9,,PR0
         1 001025   020000 316003                    CANQ    8192,DU
         1 001026   001005 601000 1                  TNZ     TRUNCLOOP

     1029     6381    2               GOTO TRUNCLOOP;
     1030     6382    2   DONETRAN:
     1031     6383    3           DO WHILE( NK$LDCT.LKFLG.NOWAIT);

   6383  1 001027   000011 236100       DONETRAN     LDQ     9,,PR0
         1 001030   000001 316003                    CANQ    1,DU
         1 001031   001055 600000 1                  TZE     s:6392

     1032     6384                    /* COMP any remaining NoWait reads */
     1033     6385    3               K$RWPARM = K_RWPARM_CON;

   6385  1 001032   000100 100400                    MLR     fill='000'O
         1 001033   000000 000234 xsym               ADSC9   K_RWPARM_CON             cn=0,n=156
         1 001034   200004 000234                    ADSC9   K$RWPARM,,AUTO           cn=0,n=156

     1034     6386    3               K$RWPARM.MSG_ERRCODE = ERREOD;

   6386  1 001035   000003 236000 0                  LDQ     ERREOD
         1 001036   200043 756100                    STQ     K$RWPARM+31,,AUTO

     1035     6387    3               K$RWPARM.TYC = %TYC_EOD;

   6387  1 001037   000013 236000 0                  LDQ     ERRXTRARD+3
         1 001040   200012 756100                    STQ     K$RWPARM+6,,AUTO

     1036     6388    3               CALL KIA$COMP( NK$LDCT, K$RWPARM);

   6388  1 001041   200004 630500                    EPPR0   K$RWPARM,,AUTO
         1 001042   200075 450500                    STP0    SCID+2,,AUTO
         1 001043   200063 236100                    LDQ     LDCT$,,AUTO
PL6.E3A0      #004=KIS$OSI_READ File=KIS$OSI.:E05TSI                             WED 07/30/97 00:41 Page:155  
         1 001044   200074 756100                    STQ     SCID+1,,AUTO
         1 001045   200074 630500                    EPPR0   SCID+1,,AUTO
         1 001046   000020 631400 xsym               EPPR1   B_VECTNIL+16
         1 001047   000000 701000 xent               TSX1    KIA$COMP
         1 001050   000000 011000                    NOP     0

     1037     6389    3               END;

   6389  1 001051   200063 470500                    LDP0    LDCT$,,AUTO
         1 001052   000011 236100                    LDQ     9,,PR0
         1 001053   000001 316003                    CANQ    1,DU
         1 001054   001032 601000 1                  TNZ     s:6385

     1038     6390    2           END;

     1039     6391            %UNLOCK( G=NK$LDCT.LOCK);

   6392  1 001055   200063 236100                    LDQ     LDCT$,,AUTO
         1 001056   000020 036003                    ADLQ    16,DU
         1 001057   200074 756100                    STQ     SCID+1,,AUTO
         1 001060   200074 630500                    EPPR0   SCID+1,,AUTO
         1 001061   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 001062   000000 701000 xent               TSX1    HFC$UNLOCK
         1 001063   000000 011000                    NOP     0

     1040     6394    1       RETURN;

   6394  1 001064   000000 702200 xent               TSX2  ! X66_ARET

ERRBADBUFFER
 Sect OctLoc
   0     000   131123 431347                                                    YS..

ERRBADSCID
 Sect OctLoc
   0     001   131123 431407                                                    YS..

PL6.E3A0      #004=KIS$OSI_READ File=KIS$OSI.:E05TSI                             WED 07/30/97 00:41 Page:156  
ERRCANTREG
 Sect OctLoc
   0     002   131123 431527                                                    YS..

ERREOD
 Sect OctLoc
   0     003   131123 400127                                                    YS.W

ERROSILDSC
 Sect OctLoc
   0     004   131123 431557                                                    YS..

ERRNOREAD
 Sect OctLoc
   0     005   131123 431467                                                    YS..

ERRTRANCLOSED
 Sect OctLoc
   0     006   131123 431437                                                    YS..

ERRTRANSPORT
 Sect OctLoc
   0     007   131123 431457                                                    YS..

ERRXTRARD
 Sect OctLoc
   0     010   131123 400237                                                    YS..

(unnamed)
 Sect OctLoc
   0     011   000000 200000   002000 000000   000200 000000                    ............

(unnamed)
 Sect OctLoc
   2     000   000000 000047   000000 006000   000014 400000   000000 006000    ...'............
   2     004   000012 006000   000004 006000   000000 006000                    ............
     1041     6395
PL6.E3A0      #004=KIS$OSI_READ File=KIS$OSI.:E05TSI                             WED 07/30/97 00:41 Page:157  
     1042     6396    1       END KIS$OSI_READ;
     1043     6397        %EOD;

PL6.E3A0      #004=KIS$OSI_READ File=KIS$OSI.:E05TSI                             WED 07/30/97 00:41 Page:158  
--  Include file information  --

   F$DCB.:E05TOU  is referenced.
   UM_CP6.:E05TOU  is referenced.
   SS_SCHED_C.:E05TOU  is referenced.
   NK$LDCT.:E05TOU  is referenced.
   NK_SUBS.:E05TOU  is referenced.
   NK_LDCT_R.:E05TOU  cannot be made into a system file and is referenced.
   K_SUBS_C.:E05TOU  is referenced.
   K_SESSION_M.:E05TOU  is referenced.
   K_INTERFACE_M.:E05TOU  is referenced.
   K$RWPARM.:E05TOU  is referenced.
   K_DATA_R.:E05TOU  cannot be made into a system file and is referenced.
   K_ADDRESS_M.:E05TOU  is referenced.
   KI$MHDR.:E05TOU  is referenced.
   KI_ERRORS_C.:E05TOU  is referenced.
   HF_LOCK_C.:E05TOU  cannot be made into a system file and is referenced.
   F_ERRORS_C.:E05TOU  is referenced.
   B$JIT_C.:E05TOU  is referenced.
   F$JIT_C.:E05TOU  cannot be made into a system file and is referenced.
   F$CP6V_C.:E05TOU  is referenced.
   CP_6_SUBS.:E05TOU  is referenced.
   B_STRINGS_C.:E05TOU  is referenced.
   B$USER.:E05TOU  cannot be made into a system file and is referenced.
      No diagnostics issued in procedure KIS$OSI_READ.
PL6.E3A0      #004=KIS$OSI_READ File=KIS$OSI.:E05TSI                             WED 07/30/97 00:41 Page:159  

 **** Variables and constants ****

  ****  Section 000 RoData KIS$OSI_READ

  ****  Scalars and arrays  ****
OctLoc.c.b A Datatyp(siz) R M Lvl/name                 OctLoc.c.b A Datatyp(siz) R M Lvl/name

     0-0-0/w STRC        r     1 ERRBADBUFFER               1-0-0/w STRC        r     1 ERRBADSCID
     2-0-0/w STRC        r     1 ERRCANTREG                 3-0-0/w STRC        r     1 ERREOD
     5-0-0/w STRC        r     1 ERRNOREAD                  4-0-0/w STRC        r     1 ERROSILDSC
     6-0-0/w STRC        r     1 ERRTRANCLOSED              7-0-0/w STRC        r     1 ERRTRANSPORT
    10-0-0/w STRC        r     1 ERRXTRARD

  ****  Auto variables  ****

  ****  Scalars and arrays  ****
OctLoc.c.b A Datatyp(siz) R M Lvl/name                 OctLoc.c.b A Datatyp(siz) R M Lvl/name

    54-0-0/w UBIN        r     1 DMN                       55-0-0/w STRC(144)   r     1 FEPIO
    61-0-0/b STRC        r     1 FEPSIZ                    62-0-0/w PTR         r     1 JDCB$
     4-0-0/d STRC(1404)  r     1 K$RWPARM                  63-0-0/w PTR         r     1 LDCT$
    64-0-0/w UBIN        r     1 LEN                       65-0-0/w PTR         r     1 MAJOR$
    66-0-0/w PTR         r     1 MINOR$                    67-0-0/b STRC        r     1 NOWAIT
    70-0-0/w STRC        r     1 PTW(0:1)                  72-0-0/w PTR         r     1 R$
    73-0-0/w SBIN        r     1 SCID

  ****  SYMREF variables  ****

  ****  Scalars and arrays  ****
OctLoc.c.b A Datatyp(siz) R M Lvl/name                 OctLoc.c.b A Datatyp(siz) R M Lvl/name

     0-0-0/w PTR         r     1 B$CGCTXT$                  0-0-0/w PTR         r     1 B$JIT$
     0-0-0/w PTR         r     1 B$PS0$                     0-0-0/w PTR         r     1 B$PS2$
     0-0-0/w PTR         r     1 KIS_MAJOR$                 0-0-0/w PTR         r     1 KIS_MINOR$
     0-0-0/w UBIN        r     1 KIS_SSN_MAXMAJOR           0-0-0/d STRC(1404)  r     1 K_RWPARM_CON
     0-0-0/w PTR         r     1 N$DCT$$                    0-0-0/b BIT (72)    r     1 NI_MFGATE
     0-0-0/w PTR         r     1 S$CU$
PL6.E3A0      #004=KIS$OSI_READ File=KIS$OSI.:E05TSI                             WED 07/30/97 00:41 Page:160  

  ****  BASED and DCB variables  ****

  ****  Scalars and arrays  ****
OctLoc.c.b A Datatyp(siz) R M Lvl/name                 OctLoc.c.b A Datatyp(siz) R M Lvl/name

     0-0-0/w STRC(360)   r     1 APPL                       0-0-0/d STRC(8856)  r     1 B$JIT
     0-0-0/d STRC(576)   r     1 B$U                        0-0-0/c ACHR        r     1 BUFFER
     0-0-0/d ASTR(3528)  r     1 F$DCB                      0-0-0/d STRC(216)   r     1 FPT$READ_V
     0-0-0/w STRC(144)   r     1 KI$QMHDR                   0-0-0/c ACHR        r     1 MESSAGE
     0-0-0/d STRC(864)   r     1 NK$LDCT
     0-0-0/w PTR         r     1 NK$LDCT$(0:0)


   Procedure KIS$OSI_READ requires 565 words for executable code.
   Procedure KIS$OSI_READ requires 66 words of local(AUTO) storage.
PL6.E3A0      #004=KIS$OSI_READ File=KIS$OSI.:E05TSI                             WED 07/30/97 00:41 Page:161  
          *** CROSS REFERENCE LISTING ***
**     DENOTES     IDENTIFIER DEFINITION
<<                 IDENTIFIER'S VALUE SET
>>                 IDENTIFIER'S VALUE USED
<>                 IDENTIFIER SET AND/OR USED
--                 IDENTIFIER REFERENCED
PL6.E3A0      #004=KIS$OSI_READ File=KIS$OSI.:E05TSI                             WED 07/30/97 00:41 Page:162  
          MINI XREF LISTING

APPL.CLNTHD
      4178**DCL      4179--REDEF
APPL.TCTX
      4175**DCL      4176--REDEF    4177--REDEF    6237>>IF       6286>>ASSIGN   6359>>IF       6364>>ASSIGN
APPL.Z.COOKIE
      4180**DCL      4181--REDEF
APPL.Z.LINK
      4182**DCL      6235>>IF       6236>>ASSIGN   6352>>IF       6353>>ASSIGN
B$CGCTXT$
      6070**DCL      6212>>ASSIGN
B$DO.ECCINFO
       192**DCL       193--REDEF
B$JIT.DCB$
      1580**DCL      6107>>ASSIGN   6347>>ASSIGN
B$JIT.DCBNO
      1571**DCL      6217>>ASSIGN
B$JIT.ERR
      1490**DCL      6113<<ASSIGN   6153<<ASSIGN   6169<<ASSIGN   6195<<ASSIGN   6227<<ASSIGN   6238<<ASSIGN
      6296<<ASSIGN   6298<<ASSIGN   6310>>IF       6319<<ASSIGN
B$JIT.ERR.MID
      1491**DCL      1491--REDEF
B$JIT$
      6071**DCL      1485--IMP-PTR  6107>>ASSIGN   6113>>ASSIGN   6153>>ASSIGN   6169>>ASSIGN   6195>>ASSIGN
      6217>>ASSIGN   6227>>ASSIGN   6238>>ASSIGN   6296>>ASSIGN   6298>>ASSIGN   6310>>IF       6319>>ASSIGN
      6347>>ASSIGN
B$PS0$
      6072**DCL      1157--IMP-PTR  6216>>ASSIGN
B$PS2$
      6073**DCL      6079--IMP-PTR  6181<>CALL     6191>>ASSIGN
B$U.CMF
       154**DCL      6270<<ASSIGN   6270>>ASSIGN
B$U.MF
PL6.E3A0      #004=KIS$OSI_READ File=KIS$OSI.:E05TSI                             WED 07/30/97 00:41 Page:163  
       147**DCL      6269<<ASSIGN   6269>>ASSIGN
B$U.MISC
       171**DCL       172--REDEF
B$USER.MISC
       247**DCL       248--REDEF
BAD_BUFFER
      6315**LABEL    6181--CALLALT  6189--CALLALT  6222--CALLALT
BRKCK
      6148**LABEL    6198--CALLALT
BUFFER
      6079**DCL      6191<<ASSIGN
CANCEL
      6127**LABEL    6251--GOTO
DMN
      6080**DCL      6219<>CALL     6220>>ASSIGN
DONETRAN
      6383**LABEL    6360--GOTO
ERRBADBUFFER
      5538**DCL      6319>>ASSIGN
ERRBADSCID
      5586**DCL      6227>>ASSIGN
ERRCANTREG
      5634**DCL      6153>>ASSIGN
ERREOD
      5682**DCL      6386>>ASSIGN
ERRNOREAD
      5778**DCL      6169>>ASSIGN
ERROSILDSC
      5730**DCL      6113>>ASSIGN
ERRTRANCLOSED
      5826**DCL      6238>>ASSIGN
ERRTRANSPORT
      5874**DCL      6298>>ASSIGN
ERRXTRARD
      5922**DCL      6129>>ASSIGN   6255>>ASSIGN
F$DCB.ACTPOS
PL6.E3A0      #004=KIS$OSI_READ File=KIS$OSI.:E05TSI                             WED 07/30/97 00:41 Page:164  
      6033**DCL      6033--REDEF
F$DCB.ARS
      6008**DCL      6008--REDEF    6193<<ASSIGN
F$DCB.ATTR
      6026**DCL      6027--REDEF
F$DCB.BORROW
      6041**DCL      6041--REDEF    6041--REDEF    6041--REDEF
F$DCB.DCBNAME.L
      6055**DCL      6055--IMP-SIZ
F$DCB.DVFC
      6029**DCL      6224>>ASSIGN   6349>>ASSIGN
F$DCB.EOMCHAR
      6012**DCL      6012--REDEF
F$DCB.FCN.CNT
      6045**DCL      6125>>IF       6252>>IF       6274>>IF       6277>>IF       6281<<ASSIGN   6281>>ASSIGN
F$DCB.FEPIO
      6051**DCL      6278<<ASSIGN
F$DCB.FEPIO2
      6054**DCL      6275<<ASSIGN
F$DCB.FEPIO3
      6054**DCL      6280<<ASSIGN
F$DCB.FEPSIZ
      6050**DCL      6250>>IF       6262<<ASSIGN
F$DCB.FLDID
      6036**DCL      6036--REDEF
F$DCB.FORM$
      6030**DCL      6030--REDEF
F$DCB.FSECT
      6046**DCL      6046--REDEF
F$DCB.FSN
      6023**DCL      6023--REDEF    6023--REDEF    6024--REDEF
F$DCB.HEADER$
      6029**DCL      6029--REDEF
F$DCB.IXTNSIZE
      6027**DCL      6027--REDEF
F$DCB.LASTSTA$
PL6.E3A0      #004=KIS$OSI_READ File=KIS$OSI.:E05TSI                             WED 07/30/97 00:41 Page:165  
      6017**DCL      6017--REDEF
F$DCB.LDCTX
      6030**DCL      6108>>ASSIGN   6348>>ASSIGN
F$DCB.LVL
      6042**DCL      6042--REDEF
F$DCB.NAME.C
      6017**DCL      6017--REDEF
F$DCB.NOEOF
      6038**DCL      6038--REDEF
F$DCB.NRECS
      6028**DCL      6028--REDEF
F$DCB.NRECX
      6047**DCL      6047--REDEF
F$DCB.OHDR
      6039**DCL      6039--REDEF
F$DCB.ORG
      6022**DCL      6022--REDEF
F$DCB.PRECNO
      6045**DCL      6045--REDEF
F$DCB.RCSZ
      6050**DCL      6050--REDEF
F$DCB.RES
      6018**DCL      6018--REDEF
F$DCB.SETX
      6030**DCL      6030--REDEF
F$DCB.TAB$
      6029**DCL      6030--REDEF
F$DCB.TDA
      6044**DCL      6044--REDEF
F$DCB.UB$
      6046**DCL      6211<>CALL
F$DCB.UBYTES
      6046**DCL      6210>>ASSIGN   6211<>CALL
F$DCB.WAIT
      6040**DCL      6125>>IF       6135>>IF
F$DCB.WSN
PL6.E3A0      #004=KIS$OSI_READ File=KIS$OSI.:E05TSI                             WED 07/30/97 00:41 Page:166  
      6019**DCL      6019--REDEF
FEPIO
      6081**DCL      6275>>ASSIGN   6278>>ASSIGN   6280>>ASSIGN
FEPIO.BPP
      6085**DCL      6213<<ASSIGN   6214<<ASSIGN
FEPIO.BUFX
      6084**DCL      6212<<ASSIGN
FEPIO.EVENT
      6082**DCL      6216<<ASSIGN
FEPSIZ
      6087**DCL      6250>>IF       6262>>ASSIGN
FEPSIZ.BUF
      6088**DCL      6210<<ASSIGN
FMO$GETDOMAIN
      6058**DCL-ENT  6219--CALL
FPT$READ_V.DVBYTE.REREAD
      1159**DCL      1160--REDEF
FPT$READ_V.EVENT
      1159**DCL      6216>>ASSIGN
FPT$READ_V.INDX
      1159**DCL      1159--REDEF
HFC$LOCK
      1846**DCL-ENT  6122--CALL     6142--CALL     6160--CALL     6246--CALL     6267--CALL     6355--CALL
      6378--CALL
HFC$UNLOCK
      1846**DCL-ENT  6148--CALL     6167--CALL     6200--CALL     6206--CALL     6272--CALL     6308--CALL
      6317--CALL     6392--CALL
HFF$DSIZ
      6059**DCL-ENT  6181--CALL
HFF$TRAPALT
      6060**DCL-ENT  6189--CALL     6315--CALL
HFF$WRITE1
      6061**DCL-ENT  6222--CALL
JDCB$
      6090**DCL      6008--IMP-PTR  6107<<ASSIGN   6108>>ASSIGN   6125>>IF       6125>>IF       6135>>IF
      6193>>ASSIGN   6210>>ASSIGN   6211>>CALL     6211>>CALL     6224>>ASSIGN   6250>>IF       6252>>IF
PL6.E3A0      #004=KIS$OSI_READ File=KIS$OSI.:E05TSI                             WED 07/30/97 00:41 Page:167  
      6262>>ASSIGN   6274>>IF       6275>>ASSIGN   6277>>IF       6278>>ASSIGN   6280>>ASSIGN   6281>>ASSIGN
      6281>>ASSIGN   6347<<ASSIGN   6348>>ASSIGN   6349>>ASSIGN
K$RWPARM
      3357**DCL      6128<<ASSIGN   6131<>CALL     6134<<ASSIGN   6198<>CALL     6254<<ASSIGN   6257<>CALL
      6288<>CALL     6361<<ASSIGN   6366<>CALL     6385<<ASSIGN   6388<>CALL
K$RWPARM.BLKREC
      3383**DCL      3408--REDEF
K$RWPARM.BLKREC.BLKU#
      3384**DCL      3386--REDEF
K$RWPARM.BLKREC.RECU#
      3396**DCL      3398--REDEF
K$RWPARM.DVE.DVBYTE.VFC
      3423**DCL      3424--REDEF
K$RWPARM.DVE.EOMCHAR
      3431**DCL      3435--REDEF
K$RWPARM.ERR
      3495**DCL      3500--REDEF    6151>>IF       6291>>IF       6295>>IF       6368>>IF
K$RWPARM.FC
      3459**DCL      3460--REDEF
K$RWPARM.FLDID
      3641**DCL      3642--REDEF
K$RWPARM.FPT$
      3522**DCL      3529--REDEF
K$RWPARM.FUNCTION
      3536**DCL      6197<<ASSIGN   6284<<ASSIGN   6362<<ASSIGN
K$RWPARM.IP$
      3487**DCL      6163<<ASSIGN   6165>>IF       6177>>ASSIGN   6177>>ASSIGN   6178>>ASSIGN
K$RWPARM.KEYTYPE
      3648**DCL      3649--REDEF
K$RWPARM.LDCT$
      3518**DCL      6196<<ASSIGN
K$RWPARM.MSG$
      3358**DCL      3364--REDEF    6095--IMP-PTR  6177<<ASSIGN   6187>>IF       6191>>ASSIGN
K$RWPARM.MSGID
      3470**DCL      3475--REDEF
K$RWPARM.MSGIDXT
PL6.E3A0      #004=KIS$OSI_READ File=KIS$OSI.:E05TSI                             WED 07/30/97 00:41 Page:168  
      3483**DCL      3487--REDEF
K$RWPARM.MSGSZ
      3365**DCL      6095--IMP-SIZ  6178<<ASSIGN   6182>>IF       6185<<ASSIGN   6191>>ASSIGN   6193>>ASSIGN
K$RWPARM.MSG_ERRCODE
      3618**DCL      6129<<ASSIGN   6195>>ASSIGN   6255<<ASSIGN   6296>>ASSIGN   6386<<ASSIGN
K$RWPARM.ORG
      3619**DCL      3620--REDEF
K$RWPARM.SSN_CRDT
      3567**DCL      6285<<ASSIGN   6363<<ASSIGN
K$RWPARM.STR
      3634**DCL      6218>>ASSIGN
K$RWPARM.TCTX#
      3593**DCL      6286<<ASSIGN   6364<<ASSIGN
K$RWPARM.THDRSZ
      3563**DCL      3567--REDEF
K$RWPARM.TYC
      3379**DCL      6130<<ASSIGN   6179<<ASSIGN   6184<<ASSIGN   6256<<ASSIGN   6387<<ASSIGN
K$RWPARM.VDOFLGS
      3621**DCL      3632--REDEF
KI$QMHDR.FPTSZ
      2109**DCL      2110--REDEF
KI$QMHDR.MSGSZ
      2115**DCL      2116--REDEF
KI$QMHDR.OFFSET
      2103**DCL      6177>>ASSIGN
KI$QMHDR.SIZE
      2104**DCL      6178>>ASSIGN
KI$QMHDR.UID
      2105**DCL      2106--REDEF
KIA$COMP
      6062**DCL-ENT  6131--CALL     6257--CALL     6388--CALL
KIA$OQFL
      6063**DCL-ENT  6292--CALL     6369--CALL
KIQ$MAPFEP
      6064**DCL-ENT  6176--CALL
KIS_MAJOR$
PL6.E3A0      #004=KIS$OSI_READ File=KIS$OSI.:E05TSI                             WED 07/30/97 00:41 Page:169  
      6074**DCL      6234>>ASSIGN   6351>>ASSIGN
KIS_MINOR$
      6075**DCL      6236>>ASSIGN   6353>>ASSIGN
KIS_SSN_MAXMAJOR
      6076**DCL      6225>>IF
KIT$SEND
      6065**DCL-ENT  6198--CALL     6288--CALL     6366--CALL
K_RWPARM_CON
      3040**DCL      6128>>ASSIGN   6134>>ASSIGN   6254>>ASSIGN   6361>>ASSIGN   6385>>ASSIGN
K_RWPARM_CON.BLKREC
      3066**DCL      3091--REDEF
K_RWPARM_CON.BLKREC.BLKU#
      3067**DCL      3069--REDEF
K_RWPARM_CON.BLKREC.RECU#
      3079**DCL      3081--REDEF
K_RWPARM_CON.DVE.DVBYTE.VFC
      3106**DCL      3107--REDEF
K_RWPARM_CON.DVE.EOMCHAR
      3114**DCL      3118--REDEF
K_RWPARM_CON.ERR
      3178**DCL      3183--REDEF
K_RWPARM_CON.FC
      3142**DCL      3143--REDEF
K_RWPARM_CON.FLDID
      3324**DCL      3325--REDEF
K_RWPARM_CON.FPT$
      3205**DCL      3212--REDEF
K_RWPARM_CON.KEYTYPE
      3331**DCL      3332--REDEF
K_RWPARM_CON.MSG$
      3041**DCL      3047--REDEF
K_RWPARM_CON.MSGID
      3153**DCL      3158--REDEF
K_RWPARM_CON.MSGIDXT
      3166**DCL      3170--REDEF
K_RWPARM_CON.ORG
PL6.E3A0      #004=KIS$OSI_READ File=KIS$OSI.:E05TSI                             WED 07/30/97 00:41 Page:170  
      3302**DCL      3303--REDEF
K_RWPARM_CON.THDRSZ
      3246**DCL      3250--REDEF
K_RWPARM_CON.VDOFLGS
      3304**DCL      3315--REDEF
LDCT$
      6091**DCL      4402--IMP-PTR  6108<<ASSIGN   6111>>IF       6122>>CALL     6127>>DOWHILE  6131>>CALL
      6138>>CALL     6142>>CALL     6144>>IF       6148>>CALL     6160>>CALL     6163>>ASSIGN   6164>>ASSIGN
      6167>>CALL     6176>>CALL     6196>>ASSIGN   6200>>CALL     6206>>CALL     6246>>CALL     6248>>IF
      6250>>IF       6257>>CALL     6261>>ASSIGN   6264>>ASSIGN   6292>>CALL     6308>>CALL     6317>>CALL
      6348<<ASSIGN   6355>>CALL     6357>>IF       6369>>CALL     6374>>ASSIGN   6376>>CALL     6378>>CALL
      6380>>IF       6383>>DOWHILE  6388>>CALL     6392>>CALL
LEN
      6092**DCL      6079--IMP-SIZ  6181<>CALL     6182>>IF       6185>>ASSIGN   6191>>ASSIGN
MAJOR$
      6093**DCL      6234<<ASSIGN   6235>>IF       6236>>ASSIGN   6351<<ASSIGN   6352>>IF       6353>>ASSIGN
MESSAGE
      6095**DCL      6191>>ASSIGN
MINOR$
      6094**DCL      6233<<ASSIGN   6236<<ASSIGN   6237>>IF       6282>>IF       6286>>ASSIGN   6350<<ASSIGN
      6353<<ASSIGN   6359>>IF       6359>>IF       6364>>ASSIGN
MMS$SETUP_BUF
      6066**DCL-ENT  6211--CALL
N$DCT$$
      4260**DCL      4260--IMP-PTR  6108>>ASSIGN   6348>>ASSIGN
NI_MFGATE
      6077**DCL      6267<>CALL     6272<>CALL
NK$LDCT
      4402**DCL      6131<>CALL     6138<>CALL     6257<>CALL     6292<>CALL     6369<>CALL     6376<>CALL
      6388<>CALL
NK$LDCT.DDT$
      4404**DCL      4404--REDEF
NK$LDCT.DFLG.OLDSC
      4407**DCL      6111>>IF
NK$LDCT.IOQ$
      4403**DCL      4404--REDEF
PL6.E3A0      #004=KIS$OSI_READ File=KIS$OSI.:E05TSI                             WED 07/30/97 00:41 Page:171  
NK$LDCT.IP$
      4424**DCL      6144>>IF       6163>>ASSIGN   6164<<ASSIGN
NK$LDCT.IPFEI#
      4425**DCL      6176<>CALL
NK$LDCT.LDCTX
      4405**DCL      4405--REDEF
NK$LDCT.LKFLG.ABORTED
      4417**DCL      4418--REDEF
NK$LDCT.LKFLG.NOWAIT
      4423**DCL      6127>>DOWHILE  6248>>IF       6264<<ASSIGN   6357>>IF       6383>>DOWHILE
NK$LDCT.LKFLG.WTMRK
      4418**DCL      6374<<ASSIGN   6380>>IF
NK$LDCT.LOCK
      4430**DCL      6122<>CALL     6142<>CALL     6148<>CALL     6160<>CALL     6167<>CALL     6200<>CALL
      6206<>CALL     6246<>CALL     6308<>CALL     6317<>CALL     6355<>CALL     6378<>CALL     6392<>CALL
NK$LDCT.NOWAIT
      4413**DCL      6250>>IF       6261<<ASSIGN
NK$LDCT.RLCID.LDCTX
      4427**DCL      4427--REDEF
NK$LDCT.STA$
      4423**DCL      4424--REDEF
NK$LDCT.SYMB$
      4402**DCL      4402--REDEF    4402--REDEF    4403--REDEF
NK$LDCT$
      4260**DCL      6108>>ASSIGN   6348>>ASSIGN
NOWAIT
      6096**DCL      6250>>IF       6261>>ASSIGN
NOWAIT.DCB#
      6100**DCL      6217<<ASSIGN
NOWAIT.DMN
      6098**DCL      6220<<ASSIGN
NOWAIT.STREAM
      6099**DCL      6218<<ASSIGN
PTW
      6102**DCL      6211<>CALL
PTW.PP
PL6.E3A0      #004=KIS$OSI_READ File=KIS$OSI.:E05TSI                             WED 07/30/97 00:41 Page:172  
      6103**DCL      6213>>ASSIGN   6214>>ASSIGN
R$
      6104**DCL      6211<>CALL     6212>>ASSIGN
READ_IT
      6163**LABEL    6145--GOTO
S$CU$
       258**DCL      6269>>ASSIGN   6269>>ASSIGN   6270>>ASSIGN   6270>>ASSIGN
SCID
      6105**DCL      6224<<ASSIGN   6225>>IF       6234>>ASSIGN   6349<<ASSIGN   6351>>ASSIGN
SC_PRTCL_SNAP
      6068**DCL-ENT  6118--CALL     6150--CALL     6302--CALL
SNAP
      6118**LABEL    6173--GOTO     6231--GOTO     6292--CALLALT  6369--CALLALT  6372--GOTO
SSR$REG
      6067**DCL-ENT  6138--CALL     6376--CALL
TRUNCLOOP
      6376**LABEL    6381--GOTO
TRYSEND
      6288**LABEL    6293--GOTO
TRYTRUNC
      6366**LABEL    6370--GOTO

PL6.E3A0      #005=KIS$OSI_ATTACH File=KIS$OSI.:E05TSI                           WED 07/30/97 00:42 Page:173  
     1044        1        /*T***********************************************************/
     1045        2        /*T*                                                         */
     1046        3        /*T* Copyright (c) Bull HN Information Systems Inc., 1997    */
     1047        4        /*T*                                                         */
     1048        5        /*T***********************************************************/
     1049        6        /*F*    NAME:   KIS$OSI_ATTACH
     1050        7                PURPOSE:  Handle M$ATTACH of monitor terminal station to server CG.
     1051        8        */
     1052        9        /*D*    NAME:   KIS$OSI_ATTACH
     1053       10                CALL:   CALL KIS$OSI_ATTACH ALTRET( label);
     1054       11                INPUT:
     1055       12                    B$JIT.DCB$ - CG AU DCB already open to the server comgroup,
     1056       13                    B$JIT.DCB$->F$DCB.NAME is the SSAP (name) of the application,
     1057       14                    B$JIT.DCB$->F$DCB.ACCT to make sure CG is in system account.
     1058       15                    B$PS1$ points at the TSAP area of the ATTACH FPT.
     1059       16                    This code reached by KCP$PMMES which has already performed some
     1060       17                    validation.
     1061       18                OUTPUT:
     1062       19                    On successfull call,
     1063       20                      A major server slot is allocated and initialized,
     1064       21                      An NK_OSISTA LDCT is allocated and initialized,
     1065       22                      A monitor terminal station is connected to the server CG,
     1066       23                      A read is issued to the CG (which will be left pending),
     1067       24                      B$JIT.DCB$->F$DCB.DVFC set to major SCID for this application.
     1068       25                    On unsuccessfull call,
     1069       26                      B$JIT.ERR is filled in with an appropriate error,
     1070       27                      ALTRETURN is taken.
     1071       28                DESCRIPTION:
     1072       29                    KIS$OSI_ATTACH is called when an OSI server application decides
     1073       30                    to allow incoming connections from OSI clients.  It is entered
     1074       31                    from KCP$PMMES when the server issues an M$ATTACH.
     1075       32
     1076       33                    By the time this code is reached, KCP has determined that the
     1077       34                    DCB is open as AU to a comgroup.  We have to do more validation
     1078       35                    here before proceeding.  The CG file name is taken to be the
     1079       36                    SSAP of the application, so must fit the ISO rules for length of
     1080       37                    an SSAP.  The CG account must be the system-specified account.
PL6.E3A0      #005=KIS$OSI_ATTACH File=KIS$OSI.:E05TSI                           WED 07/30/97 00:42 Page:174  
     1081       38
     1082       39                    A monitor terminal station is connected to the server comgroup
     1083       40                    with KCO$TRMCON.  Then KQG$GET is called to issue a get to the
     1084       41                    comgroup.  Since there are no messages for the monitor station
     1085       42                    yet, the get will be left pending within CG code.  Eventually
     1086       43                    the server will write a message into the comgroup aimed at the
     1087       44                    monitor terminal station, which will make KCO$GOTMSG call
     1088       45                    KCD$WRITE which calls KIS$OSI_SEND which will write the message
     1089       46                    into the network and reissue the get (or words to that effect).
     1090       47
     1091       48                    The major SCID for this application is stored in F$DCB.DVFC.
     1092       49
     1093       50                    The TSAP of the server is saved for use of incoming connects.
     1094       51                    This means that any client attempting to call the server must
     1095       52                    know its TSAP.  A Directory Service handles details like this.
     1096       53        */
     1097       54        KIS$OSI_ATTACH: PROC ALTRET;
     1098       55        %INCLUDE B$JIT_C;
     1099      369            %B$JIT0;
     1100      458            %U$JIT1X;
     1101      461            %M$JIT2X;
     1102      464            %F$JIT3;
     1103      469            %S$JIT4X;
     1104      472            %J$JIT5;
     1105      560            %A$JIT6X;
     1106      563        %INCLUDE CP_6_SUBS;
     1107     1103        %INCLUDE HF_LOCK_C;
     1108     1117        %INCLUDE KC_CP6;
     1109     1677            %B$CGAUCI( FPTN=KIS_OSITRM, STCLASS=CONSTANT,
     1110     1678                       INFOSZ=0, NM='MONITOR', AC=':OSICG');
     1111     1700            %B$CGAUCI( STCLASS=AUTO);
     1112     1722            %VLP_TSAP( FPTN=TSAP, STCLASS="BASED( B$PS1$)");
     1113     1749        %INCLUDE KC$CGBLK;
     1114     1797            %KC$CGID( STCLASS=AUTO);
     1115     1823        %INCLUDE K_ADDRESS_M;
     1116     2326        %INCLUDE KI_ERRORS_C;
     1117     2411        %INCLUDE K_SESSION_M;
PL6.E3A0      #005=KIS$OSI_ATTACH File=KIS$OSI.:E05TSI                           WED 07/30/97 00:42 Page:175  
     1118     2501            %KIS$APPL( NAME=APPL, STCLASS=BASED);
     1119     2570        %INCLUDE K$RWPARM;
     1120     2956            %K$RWPARM( NAME=K$RWPARM, STCLASS=AUTO);
     1121     3272            %K$RWPARM( NAME=K_RWPARM_CON, STCLASS="SYMREF READONLY");
     1122     3588        %INCLUDE NK_SUBS;
     1123     3613        %INCLUDE NK$LDCT;
     1124     3715            %NK$LDCT( STCLASS="BASED( LDCT$)");
     1125     3761        %INCLUDE UM_CP6;
     1126     4613        %MACRO ERRCODE( NAME=ERRDUMMY, CODE=0);
     1127     4614            %VLP_ERRCODE( FPTN=NAME, STCLASS=CONSTANT, FCG='KI', MID='S',
     1128     4615                          MON='1'B, ERR#=CODE, SEV=7);
     1129     4616        %MEND;
     1130     4617            %ERRCODE( NAME=ERRBADOSIACCT, CODE=%E$BADOSIACCT);
     1131     4665            %ERRCODE( NAME=ERRDUMMY, CODE=0);
     1132     4713            %ERRCODE( NAME=ERRMAJORTBL, CODE=%E$MAJORTBL);
     1133     4761            %ERRCODE( NAME=ERROSIGET, CODE=%E$OSIGETERR);
     1134     4809            %ERRCODE( NAME=ERROSINOLDCT, CODE=%E$OSINOLDCT);
     1135     4857            %ERRCODE( NAME=ERRSRVRNAME, CODE=%E$SRVRNAME);
     1136     4905        %MACRO F$DCBI( BASED=BASED);
     1137     4906        %INCLUDE F$DCB;
     1138     4955        %MEND;
     1139     4956            %F$DCBI( BASED="BASED( JDCB$)");
     1140     5006
     1141     5007    1       DCL KCO$TRMCON ENTRY(4) ALTRET;
     1142     5008    1       DCL KCO$TRMGO ENTRY(1) ALTRET;
     1143     5009    1       DCL KQG$GET ENTRY(2) ALTRET;
     1144     5010    1       DCL NKL$GETDCT ENTRY(1) ALTRET;
     1145     5011    1       DCL SSS$BLOCK ENTRY;
     1146     5012    1       DCL SC_PRTCL_SNAP ENTRY CONV(2,0);
     1147     5013
     1148     5014    1       DCL B$JIT$ PTR SYMREF;
     1149     5015    1       DCL B$PS1$ PTR SYMREF;  /* points at TSAP area of M$ATTACH fpt */
     1150     5016    1       DCL KIS_MAJOR$ PTR SYMREF;
     1151     5017    1       DCL KIS_OSILOCK BIT(72) SYMREF;
     1152     5018
     1153     5019    1       DCL CONERR UBIN;
     1154     5020    1       DCL JDCB$ PTR;
PL6.E3A0      #005=KIS$OSI_ATTACH File=KIS$OSI.:E05TSI                           WED 07/30/97 00:42 Page:176  
     1155     5021    1       DCL LDCT$ PTR;
     1156     5022    1       DCL MAJOR$ PTR;
     1157     5023    1       DCL OSIACCT CHAR(8) CONSTANT INIT( ':OSICG  ');
     1158     5024    1       DCL SCID SBIN;
     1159     5025
     1160     5026    1       JDCB$ = B$JIT.DCB$;
     1161     5027            /* check SSAP for conformance to ISO rules */
     1162     5028    2       IF F$DCB.NAME.L = 0 OR F$DCB.NAME.L > 16 THEN DO;
     1163     5029                /* unreasonable length for a server application name to be */
     1164     5030    2           B$JIT.ERR = ERRSRVRNAME;
     1165     5031                /*E*  ERROR:  KIS-E$SRVRNAME-A
     1166     5032                    MESSAGE:  Server name must be from 1 to 16 characters long.
     1167     5033                */
     1168     5034    2           ALTRETURN;
     1169     5035    2           END;
     1170     5036    2       IF F$DCB.ACCT ~= OSIACCT THEN DO;
     1171     5037                /* server application CGs have to be in a special account */
     1172     5038    2           B$JIT.ERR = ERRBADOSIACCT;
     1173     5039                /*E*  ERROR:  KIS-E$BADOSIACCT-A
     1174     5040                    MESSAGE:  Server comgroup must reside in account :OSICG.
     1175     5041                */
     1176     5042    2           ALTRETURN;
     1177     5043    2           END;
     1178     5044    1       CALL SSS$BLOCK;  /* to master so LOCK/UNLOCK on same CPU (cf. KCO) */
     1179     5045            %LOCK( G=KIS_OSILOCK);
     1180     5048            /* allocate a major server slot */
     1181     5049    2       IF KIS_MAJOR$->APPL.SRVRHD ~= 0 THEN DO;
     1182     5050    2           SCID = KIS_MAJOR$->APPL.SRVRHD;
     1183     5051    2           MAJOR$ = PINCRW( KIS_MAJOR$, SCID);
     1184     5052    2           KIS_MAJOR$->APPL.SRVRHD = MAJOR$->APPL.Z.LINK;
     1185     5053    2           END;
     1186     5054    2       ELSE DO;
     1187     5055                /* no appl slots available */
     1188     5056                %UNLOCK( G=KIS_OSILOCK);
     1189     5059    2           B$JIT.ERR = ERRMAJORTBL;
     1190     5060                /*    ERROR:  KIS-E$MAJORTBL-A
     1191     5061                    MESSAGE:  No more space in the 'major' Session connection table.
PL6.E3A0      #005=KIS$OSI_ATTACH File=KIS$OSI.:E05TSI                           WED 07/30/97 00:42 Page:177  
     1192     5062                */
     1193     5063    2           ALTRETURN;
     1194     5064    2           END;
     1195     5065            /* allocate an LDCT for the monitor terminal station */
     1196     5066    1       CALL NKL$GETDCT( LDCT$)
     1197     5067    2       WHENALTRETURN DO;
     1198     5068                /* no workee */
     1199     5069                /* free the major server slot */
     1200     5070    2           MAJOR$->APPL.Z.LINK = KIS_MAJOR$->APPL.SRVRHD;
     1201     5071    2           KIS_MAJOR$->APPL.SRVRHD = SCID;
     1202     5072                %UNLOCK( G=KIS_OSILOCK);
     1203     5075    2           B$JIT.ERR = ERROSINOLDCT;
     1204     5076                /*    ERROR:  KIS-E$OSINOLDCT-A
     1205     5077                    MESSAGE:  No more system LDCTs are available.
     1206     5078                */
     1207     5079    2           ALTRETURN;
     1208     5080    2           END;
     1209     5081            /* fill in the LDCT */
     1210     5082    1       NK$LDCT.DEVNM = 'MONITOR ';
     1211     5083            /* fill in the KC$CGID structure for connecting the station */
     1212     5084    1       KC$CGID.ACCT# = OSIACCT;
     1213     5085    1       KC$CGID.PSN# = ' ';
     1214     5086    1       KC$CGID.NAME#.CNT = F$DCB.NAME.L;
     1215     5087    1       KC$CGID.NAME#.TXT = F$DCB.NAME.C;
     1216     5088            /* try to connect the monitor terminal station */
     1217     5089    1       B$CGAUCI = KIS_OSITRM;
     1218     5090    1       CALL KCO$TRMCON( LDCT$, KC$CGID, B$CGAUCI, CONERR)
     1219     5091    2       WHENALTRETURN DO;
     1220     5092                /* unable to connect monitor terminal station to server CG */
     1221     5093                %UNLOCK( G=KIS_OSILOCK);
     1222     5096    2           B$JIT.ERR = ERRDUMMY;
     1223     5097    2           B$JIT.ERR.CODE = CONERR;
     1224     5098                /*E*  ERROR:  KIS-E$NOCG-A
     1225     5099                    MESSAGE:  Internal error.  Server comgroup does not exist.
     1226     5100                */
     1227     5101                /*E*  ERROR:  KIS-E$DUPNM-A
     1228     5102                    MESSAGE:  Internal error.  Station name in use.
PL6.E3A0      #005=KIS$OSI_ATTACH File=KIS$OSI.:E05TSI                           WED 07/30/97 00:42 Page:178  
     1229     5103                */
     1230     5104                /*E*  ERROR:  KIS-E$STAILLGL-A
     1231     5105                    MESSAGE:  Internal error.  Station name illegal.
     1232     5106                */
     1233     5107                /*E*  ERROR:  KIS-E$CGCXT-A
     1234     5108                    MESSAGE:  Internal error.  No room in comgroup to connect station.
     1235     5109                */
     1236     5110                /*E*  ERROR:  KIS-E$NTRMSTA-A
     1237     5111                    MESSAGE:  Internal error.  Station name illegal for terminal.
     1238     5112                */
     1239     5113                /*E*  ERROR:  KIS-E$STABAD-A
     1240     5114                    MESSAGE:  Internal error.  Station name has illegal characters.
     1241     5115                */
     1242     5116    2   SNAP:
     1243     5117    2           CALL SC_PRTCL_SNAP;
     1244     5118    2           ALTRETURN;
     1245     5119    2           END;
     1246     5120            /* the monitor terminal station has been connected */
     1247     5121            /* fill in more of the LDCT */
     1248     5122    1       NK$LDCT.RESCOD = %NK_OSISTA;
     1249     5123    1       NK$LDCT.USER = B$JIT.USER;
     1250     5124    1       NK$LDCT.JLNKCNT = B$JIT.LNKCNT;
     1251     5125    1       NK$LDCT.TH.STR = SCID;
     1252     5126    1       NK$LDCT.LKFLG.ACTIVE = '1'B;
     1253     5127    1       NK$LDCT.LKFLG.OBLK = '0'B;
     1254     5128    1       NK$LDCT.DFLG.INPUT = '1'B;
     1255     5129    1       NK$LDCT.DFLG.OUTPUT = '1'B;
     1256     5130    1       NK$LDCT.RLCID.LDCTXB = '777777'O;  /* so we can de-activate later */
     1257     5131            /* finish init of monitor terminal station */
     1258     5132    1       CALL KCO$TRMGO( LDCT$);
     1259     5133            /* fill in the major server slot */
     1260     5134    1       MAJOR$->APPL.LDCTX = NK$LDCT.LDCTX;
     1261     5135    1       MAJOR$->APPL.Z.LINK = 0;
     1262     5136    1       MAJOR$->APPL.Z.USER = B$JIT.USER;
     1263     5137    1       MAJOR$->APPL.TSAP = TSAP;
     1264     5138    1       MAJOR$->APPL.AUDCT = F$DCB.LDCTX;
     1265     5139            %UNLOCK( G=KIS_OSILOCK);
PL6.E3A0      #005=KIS$OSI_ATTACH File=KIS$OSI.:E05TSI                           WED 07/30/97 00:42 Page:179  
     1266     5142            /* fill in the major SCID */
     1267     5143    1       F$DCB.DVFC = BINASC( SCID);
     1268     5144            /* now issue a get to the comgroup */
     1269     5145    1       K$RWPARM = K_RWPARM_CON;
     1270     5146    1       CALL KQG$GET( NK$LDCT, K$RWPARM)
     1271     5147    2       WHENALTRETURN DO;
     1272     5148                /* this isn't supposed to happen */
     1273     5149    2           B$JIT.ERR = ERROSIGET;
     1274     5150                /*E*  ERROR:  KIS-E$OSIGETERR-A
     1275     5151                    MESSAGE:  Internal error.  GET failed.
     1276     5152                */
     1277     5153    2           GOTO SNAP;
     1278     5154    2           END;
     1279     5155            /* otherwise, the get has been left pending and KIS$OSI_SEND
     1280     5156               will be entered later from KCO/KCD when the get is satisfied. */
     1281     5157    1       RETURN;
     1282     5158
     1283     5159    1       END KIS$OSI_ATTACH;
     1284     5160        %EOD;

PL6.E3A0      #005=KIS$OSI_ATTACH File=KIS$OSI.:E05TSI                           WED 07/30/97 00:42 Page:180  
--  Include file information  --

   F$DCB.:E05TOU  is referenced.
   UM_CP6.:E05TOU  is referenced.
   NK$LDCT.:E05TOU  is referenced.
   NK_SUBS.:E05TOU  is referenced.
   K$RWPARM.:E05TOU  is referenced.
   K_SESSION_M.:E05TOU  is referenced.
   KI_ERRORS_C.:E05TOU  is referenced.
   K_ADDRESS_M.:E05TOU  is referenced.
   KC$CGBLK.:E05TOU  is referenced.
   KC_CP6.:E05TOU  is referenced.
   HF_LOCK_C.:E05TOU  cannot be made into a system file and is referenced.
   CP_6_SUBS.:E05TOU  is referenced.
   B$JIT_C.:E05TOU  is referenced.
      No diagnostics issued in procedure KIS$OSI_ATTACH.

   Procedure KIS$OSI_ATTACH requires 208 words for executable code.
   Procedure KIS$OSI_ATTACH requires 74 words of local(AUTO) storage.

PL6.E3A0      #005=KIS$OSI_ATTACH File=KIS$OSI.:E05TSI                           WED 07/30/97 00:42 Page:181  

 Object Unit name= KIS$OSI_ATTACH                             File name= KIS$OSI.:E05TOU
 UTS= JUL 30 '97 00:42:56.88 WED                              Compiler= PL-6/E31         Sev=      00
 SharedLib= :SHARED_SYSTEM                                    Alt SharedLib=


    ****  Control sections  ****

 Sect   Type Bound  Init  Size OctSiz  Section name(segment info)
    0  RoData even  UTS     19     23  KIS$OSI_ATTACH
    1   Proc  even  none   208    320  KIS$OSI_ATTACH
    2  RoData even  none     4      4  KIS$OSI_ATTACH

    ****  Entry defs  ****

                              Check   Calling
                             calling  sequence
  Sect OctLoc Primary Altret sequence   type   Parms  Name
     1      0   yes    yes     yes      Std        0  KIS$OSI_ATTACH

  ****  Entry refs  ****

         Check        Calling
        calling       sequence
Altret sequence SRef   type   Args  Name
         yes           Std       0 SSS$BLOCK
         yes           Std       1 HFC$LOCK
         yes           Std       1 HFC$UNLOCK
 yes     yes           Std       2 KQG$GET
 yes     yes           Std       1 NKL$GETDCT
 yes     yes           Std       4 KCO$TRMCON
 yes     yes           Std       1 KCO$TRMGO
                       nStd      0 X66_AUTO_0
                       nStd      0 X66_AALT
                       Std       0 B_CONSPOOL_D
                       nStd      0 X66_ARET
PL6.E3A0      #005=KIS$OSI_ATTACH File=KIS$OSI.:E05TSI                           WED 07/30/97 00:42 Page:182  

  ****  Data refs  ****

  Flags:  r = read only, s = secondary
Flgs Name                             Flgs Name                             Flgs Name
     SC_PRTCL_SNAP                    r    K_RWPARM_CON                          B$JIT$
     B$PS1$                                KIS_MAJOR$                            KIS_OSILOCK
     B_VECTNIL

  ****  Segment refs  ****

  Flags:  r = read only, s = secondary
Flgs Name                             Flgs Name                             Flgs Name
     ASLENTSID                             ISSID
PL6.E3A0      #005=KIS$OSI_ATTACH File=KIS$OSI.:E05TSI                           WED 07/30/97 00:42 Page:183  


     1044        1        /*T***********************************************************/
     1045        2        /*T*                                                         */
     1046        3        /*T* Copyright (c) Bull HN Information Systems Inc., 1997    */
     1047        4        /*T*                                                         */
     1048        5        /*T***********************************************************/
     1049        6        /*F*    NAME:   KIS$OSI_ATTACH
     1050        7                PURPOSE:  Handle M$ATTACH of monitor terminal station to server CG.
     1051        8        */
     1052        9        /*D*    NAME:   KIS$OSI_ATTACH
     1053       10                CALL:   CALL KIS$OSI_ATTACH ALTRET( label);
     1054       11                INPUT:
     1055       12                    B$JIT.DCB$ - CG AU DCB already open to the server comgroup,
     1056       13                    B$JIT.DCB$->F$DCB.NAME is the SSAP (name) of the application,
     1057       14                    B$JIT.DCB$->F$DCB.ACCT to make sure CG is in system account.
     1058       15                    B$PS1$ points at the TSAP area of the ATTACH FPT.
     1059       16                    This code reached by KCP$PMMES which has already performed some
     1060       17                    validation.
     1061       18                OUTPUT:
     1062       19                    On successfull call,
     1063       20                      A major server slot is allocated and initialized,
     1064       21                      An NK_OSISTA LDCT is allocated and initialized,
     1065       22                      A monitor terminal station is connected to the server CG,
     1066       23                      A read is issued to the CG (which will be left pending),
     1067       24                      B$JIT.DCB$->F$DCB.DVFC set to major SCID for this application.
     1068       25                    On unsuccessfull call,
     1069       26                      B$JIT.ERR is filled in with an appropriate error,
     1070       27                      ALTRETURN is taken.
     1071       28                DESCRIPTION:
     1072       29                    KIS$OSI_ATTACH is called when an OSI server application decides
     1073       30                    to allow incoming connections from OSI clients.  It is entered
     1074       31                    from KCP$PMMES when the server issues an M$ATTACH.
     1075       32
     1076       33                    By the time this code is reached, KCP has determined that the
     1077       34                    DCB is open as AU to a comgroup.  We have to do more validation
     1078       35                    here before proceeding.  The CG file name is taken to be the
     1079       36                    SSAP of the application, so must fit the ISO rules for length of
PL6.E3A0      #005=KIS$OSI_ATTACH File=KIS$OSI.:E05TSI                           WED 07/30/97 00:42 Page:184  
     1080       37                    an SSAP.  The CG account must be the system-specified account.
     1081       38
     1082       39                    A monitor terminal station is connected to the server comgroup
     1083       40                    with KCO$TRMCON.  Then KQG$GET is called to issue a get to the
     1084       41                    comgroup.  Since there are no messages for the monitor station
     1085       42                    yet, the get will be left pending within CG code.  Eventually
     1086       43                    the server will write a message into the comgroup aimed at the
     1087       44                    monitor terminal station, which will make KCO$GOTMSG call
     1088       45                    KCD$WRITE which calls KIS$OSI_SEND which will write the message
     1089       46                    into the network and reissue the get (or words to that effect).
     1090       47
     1091       48                    The major SCID for this application is stored in F$DCB.DVFC.
     1092       49
     1093       50                    The TSAP of the server is saved for use of incoming connects.
     1094       51                    This means that any client attempting to call the server must
     1095       52                    know its TSAP.  A Directory Service handles details like this.
     1096       53        */
     1097       54        KIS$OSI_ATTACH: PROC ALTRET;

     54  1 000000   000000 700200 xent  KIS$OSI_ATT* TSX0  ! X66_AUTO_0
         1 000001   000112 000000                    ZERO    74,0

     1098       55        %INCLUDE B$JIT_C;
     1099      369            %B$JIT0;
     1100      458            %U$JIT1X;
     1101      461            %M$JIT2X;
     1102      464            %F$JIT3;
     1103      469            %S$JIT4X;
     1104      472            %J$JIT5;
     1105      560            %A$JIT6X;
     1106      563        %INCLUDE CP_6_SUBS;
     1107     1103        %INCLUDE HF_LOCK_C;
     1108     1117        %INCLUDE KC_CP6;
     1109     1677            %B$CGAUCI( FPTN=KIS_OSITRM, STCLASS=CONSTANT,
     1110     1678                       INFOSZ=0, NM='MONITOR', AC=':OSICG');
     1111     1700            %B$CGAUCI( STCLASS=AUTO);
     1112     1722            %VLP_TSAP( FPTN=TSAP, STCLASS="BASED( B$PS1$)");
PL6.E3A0      #005=KIS$OSI_ATTACH File=KIS$OSI.:E05TSI                           WED 07/30/97 00:42 Page:185  
     1113     1749        %INCLUDE KC$CGBLK;
     1114     1797            %KC$CGID( STCLASS=AUTO);
     1115     1823        %INCLUDE K_ADDRESS_M;
     1116     2326        %INCLUDE KI_ERRORS_C;
     1117     2411        %INCLUDE K_SESSION_M;
     1118     2501            %KIS$APPL( NAME=APPL, STCLASS=BASED);
     1119     2570        %INCLUDE K$RWPARM;
     1120     2956            %K$RWPARM( NAME=K$RWPARM, STCLASS=AUTO);
     1121     3272            %K$RWPARM( NAME=K_RWPARM_CON, STCLASS="SYMREF READONLY");
     1122     3588        %INCLUDE NK_SUBS;
     1123     3613        %INCLUDE NK$LDCT;
     1124     3715            %NK$LDCT( STCLASS="BASED( LDCT$)");
     1125     3761        %INCLUDE UM_CP6;
     1126     4613        %MACRO ERRCODE( NAME=ERRDUMMY, CODE=0);
     1127     4614            %VLP_ERRCODE( FPTN=NAME, STCLASS=CONSTANT, FCG='KI', MID='S',
     1128     4615                          MON='1'B, ERR#=CODE, SEV=7);
     1129     4616        %MEND;
     1130     4617            %ERRCODE( NAME=ERRBADOSIACCT, CODE=%E$BADOSIACCT);
     1131     4665            %ERRCODE( NAME=ERRDUMMY, CODE=0);
     1132     4713            %ERRCODE( NAME=ERRMAJORTBL, CODE=%E$MAJORTBL);
     1133     4761            %ERRCODE( NAME=ERROSIGET, CODE=%E$OSIGETERR);
     1134     4809            %ERRCODE( NAME=ERROSINOLDCT, CODE=%E$OSINOLDCT);
     1135     4857            %ERRCODE( NAME=ERRSRVRNAME, CODE=%E$SRVRNAME);
     1136     4905        %MACRO F$DCBI( BASED=BASED);
     1137     4906        %INCLUDE F$DCB;
     1138     4955        %MEND;
     1139     4956            %F$DCBI( BASED="BASED( JDCB$)");
     1140     5006
     1141     5007    1       DCL KCO$TRMCON ENTRY(4) ALTRET;
     1142     5008    1       DCL KCO$TRMGO ENTRY(1) ALTRET;
     1143     5009    1       DCL KQG$GET ENTRY(2) ALTRET;
     1144     5010    1       DCL NKL$GETDCT ENTRY(1) ALTRET;
     1145     5011    1       DCL SSS$BLOCK ENTRY;
     1146     5012    1       DCL SC_PRTCL_SNAP ENTRY CONV(2,0);
     1147     5013
     1148     5014    1       DCL B$JIT$ PTR SYMREF;
     1149     5015    1       DCL B$PS1$ PTR SYMREF;  /* points at TSAP area of M$ATTACH fpt */
PL6.E3A0      #005=KIS$OSI_ATTACH File=KIS$OSI.:E05TSI                           WED 07/30/97 00:42 Page:186  
     1150     5016    1       DCL KIS_MAJOR$ PTR SYMREF;
     1151     5017    1       DCL KIS_OSILOCK BIT(72) SYMREF;
     1152     5018
     1153     5019    1       DCL CONERR UBIN;
     1154     5020    1       DCL JDCB$ PTR;
     1155     5021    1       DCL LDCT$ PTR;
     1156     5022    1       DCL MAJOR$ PTR;
     1157     5023    1       DCL OSIACCT CHAR(8) CONSTANT INIT( ':OSICG  ');
     1158     5024    1       DCL SCID SBIN;
     1159     5025
     1160     5026    1       JDCB$ = B$JIT.DCB$;

   5026  1 000002   000000 470400 xsym               LDP0    B$JIT$
         1 000003   000232 236100                    LDQ     154,,PR0
         1 000004   200101 756100                    STQ     JDCB$,,AUTO

     1161     5027            /* check SSAP for conformance to ISO rules */
     1162     5028    2       IF F$DCB.NAME.L = 0 OR F$DCB.NAME.L > 16 THEN DO;

   5028  1 000005   200101 471500                    LDP1    JDCB$,,AUTO
         1 000006   100010 236100                    LDQ     8,,PR1
         1 000007   777000 316003                    CANQ    -512,DU
         1 000010   000015 600000 1                  TZE     s:5030
         1 000011   100010 236100                    LDQ     8,,PR1
         1 000012   777000 376003                    ANQ     -512,DU
         1 000013   021000 116003                    CMPQ    8704,DU
         1 000014   000020 602000 1                  TNC     s:5036

     1163     5029                /* unreasonable length for a server application name to be */
     1164     5030    2           B$JIT.ERR = ERRSRVRNAME;

   5030  1 000015   000016 236000 0                  LDQ     ERRSRVRNAME
         1 000016   000012 756100                    STQ     10,,PR0

     1165     5031                /*E*  ERROR:  KIS-E$SRVRNAME-A
     1166     5032                    MESSAGE:  Server name must be from 1 to 16 characters long.
     1167     5033                */
PL6.E3A0      #005=KIS$OSI_ATTACH File=KIS$OSI.:E05TSI                           WED 07/30/97 00:42 Page:187  
     1168     5034    2           ALTRETURN;

   5034  1 000017   000000 702200 xent               TSX2  ! X66_AALT

     1169     5035    2           END;
     1170     5036    2       IF F$DCB.ACCT ~= OSIACCT THEN DO;

   5036  1 000020   040000 106500                    CMPC    fill='040'O
         1 000021   100020 000010                    ADSC9   16,,PR1                  cn=0,n=8
         1 000022   000017 000010 0                  ADSC9   OSIACCT                  cn=0,n=8
         1 000023   000027 600000 1                  TZE     s:5044

     1171     5037                /* server application CGs have to be in a special account */
     1172     5038    2           B$JIT.ERR = ERRBADOSIACCT;

   5038  1 000024   000011 236000 0                  LDQ     ERRBADOSIACCT
         1 000025   000012 756100                    STQ     10,,PR0

     1173     5039                /*E*  ERROR:  KIS-E$BADOSIACCT-A
     1174     5040                    MESSAGE:  Server comgroup must reside in account :OSICG.
     1175     5041                */
     1176     5042    2           ALTRETURN;

   5042  1 000026   000000 702200 xent               TSX2  ! X66_AALT

     1177     5043    2           END;
     1178     5044    1       CALL SSS$BLOCK;  /* to master so LOCK/UNLOCK on same CPU (cf. KCO) */

   5044  1 000027   000002 631400 xsym               EPPR1   B_VECTNIL+2
         1 000030   000000 701000 xent               TSX1    SSS$BLOCK
         1 000031   000000 011000                    NOP     0

     1179     5045            %LOCK( G=KIS_OSILOCK);

   5046  1 000032   000000 630400 2                  EPPR0   0
         1 000033   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 000034   000000 701000 xent               TSX1    HFC$LOCK
PL6.E3A0      #005=KIS$OSI_ATTACH File=KIS$OSI.:E05TSI                           WED 07/30/97 00:42 Page:188  
         1 000035   000000 011000                    NOP     0

     1180     5048            /* allocate a major server slot */
     1181     5049    2       IF KIS_MAJOR$->APPL.SRVRHD ~= 0 THEN DO;

   5049  1 000036   000000 470400 xsym               LDP0    KIS_MAJOR$
         1 000037   000000 220100                    LDX0    0,,PR0
         1 000040   000054 600000 1                  TZE     s:5057

     1182     5050    2           SCID = KIS_MAJOR$->APPL.SRVRHD;

   5050  1 000041   000000 236100                    LDQ     0,,PR0
         1 000042   000022 772000                    QRL     18
         1 000043   200104 756100                    STQ     SCID,,AUTO

     1183     5051    2           MAJOR$ = PINCRW( KIS_MAJOR$, SCID);

   5051  1 000044   000022 736000                    QLS     18
         1 000045   000000 036000 xsym               ADLQ    KIS_MAJOR$
         1 000046   200103 756100                    STQ     MAJOR$,,AUTO

     1184     5052    2           KIS_MAJOR$->APPL.SRVRHD = MAJOR$->APPL.Z.LINK;

   5052  1 000047   200103 471500                    LDP1    MAJOR$,,AUTO
         1 000050   100000 721100                    LXL1    0,,PR1
         1 000051   000777 361003                    ANX1    511,DU
         1 000052   000000 741100                    STX1    0,,PR0

     1185     5053    2           END;

   5053  1 000053   000064 710000 1                  TRA     s:5066

     1186     5054    2       ELSE DO;

     1187     5055                /* no appl slots available */
     1188     5056                %UNLOCK( G=KIS_OSILOCK);

PL6.E3A0      #005=KIS$OSI_ATTACH File=KIS$OSI.:E05TSI                           WED 07/30/97 00:42 Page:189  
   5057  1 000054   000000 630400 2                  EPPR0   0
         1 000055   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 000056   000000 701000 xent               TSX1    HFC$UNLOCK
         1 000057   000000 011000                    NOP     0

     1189     5059    2           B$JIT.ERR = ERRMAJORTBL;

   5059  1 000060   000013 236000 0                  LDQ     ERRMAJORTBL
         1 000061   000000 470400 xsym               LDP0    B$JIT$
         1 000062   000012 756100                    STQ     10,,PR0

     1190     5060                /*    ERROR:  KIS-E$MAJORTBL-A
     1191     5061                    MESSAGE:  No more space in the 'major' Session connection table.
     1192     5062                */
     1193     5063    2           ALTRETURN;

   5063  1 000063   000000 702200 xent               TSX2  ! X66_AALT

     1194     5064    2           END;
     1195     5065            /* allocate an LDCT for the monitor terminal station */
     1196     5066    1       CALL NKL$GETDCT( LDCT$)

   5066  1 000064   200102 630500                    EPPR0   LDCT$,,AUTO
         1 000065   200106 450500                    STP0    SCID+2,,AUTO
         1 000066   200106 630500                    EPPR0   SCID+2,,AUTO
         1 000067   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 000070   000000 701000 xent               TSX1    NKL$GETDCT
         1 000071   000073 702000 1                  TSX2    s:5070
         1 000072   000113 710000 1                  TRA     s:5082

     1197     5067    2       WHENALTRETURN DO;

     1198     5068                /* no workee */
     1199     5069                /* free the major server slot */
     1200     5070    2           MAJOR$->APPL.Z.LINK = KIS_MAJOR$->APPL.SRVRHD;

   5070  1 000073   200103 470500                    LDP0    MAJOR$,,AUTO
PL6.E3A0      #005=KIS$OSI_ATTACH File=KIS$OSI.:E05TSI                           WED 07/30/97 00:42 Page:190  
         1 000074   000000 471400 xsym               LDP1    KIS_MAJOR$
         1 000075   100000 236100                    LDQ     0,,PR1
         1 000076   000022 772000                    QRL     18
         1 000077   000000 552104                    STBQ    0,'04'O,PR0

     1201     5071    2           KIS_MAJOR$->APPL.SRVRHD = SCID;

   5071  1 000100   200104 720100                    LXL0    SCID,,AUTO
         1 000101   000000 471400 xsym               LDP1    KIS_MAJOR$
         1 000102   100000 740100                    STX0    0,,PR1

     1202     5072                %UNLOCK( G=KIS_OSILOCK);

   5073  1 000103   000000 630400 2                  EPPR0   0
         1 000104   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 000105   000000 701000 xent               TSX1    HFC$UNLOCK
         1 000106   000000 011000                    NOP     0

     1203     5075    2           B$JIT.ERR = ERROSINOLDCT;

   5075  1 000107   000015 236000 0                  LDQ     ERROSINOLDCT
         1 000110   000000 470400 xsym               LDP0    B$JIT$
         1 000111   000012 756100                    STQ     10,,PR0

     1204     5076                /*    ERROR:  KIS-E$OSINOLDCT-A
     1205     5077                    MESSAGE:  No more system LDCTs are available.
     1206     5078                */
     1207     5079    2           ALTRETURN;

   5079  1 000112   000000 702200 xent               TSX2  ! X66_AALT

     1208     5080    2           END;
     1209     5081            /* fill in the LDCT */
     1210     5082    1       NK$LDCT.DEVNM = 'MONITOR ';

   5082  1 000113   200102 470500                    LDP0    LDCT$,,AUTO
         1 000114   040100 100400                    MLR     fill='040'O
PL6.E3A0      #005=KIS$OSI_ATTACH File=KIS$OSI.:E05TSI                           WED 07/30/97 00:42 Page:191  
         1 000115   000021 000010 0                  ADSC9   OSIACCT+2                cn=0,n=8
         1 000116   000002 000010                    ADSC9   2,,PR0                   cn=0,n=8

     1211     5083            /* fill in the KC$CGID structure for connecting the station */
     1212     5084    1       KC$CGID.ACCT# = OSIACCT;

   5084  1 000117   040100 100400                    MLR     fill='040'O
         1 000120   000017 000010 0                  ADSC9   OSIACCT                  cn=0,n=8
         1 000121   200014 000010                    ADSC9   KC$CGID,,AUTO            cn=0,n=8

     1213     5085    1       KC$CGID.PSN# = ' ';

   5085  1 000122   040100 100400                    MLR     fill='040'O
         1 000123   000035 000001 xsym               ADSC9   B_VECTNIL+29             cn=0,n=1
         1 000124   200016 000006                    ADSC9   KC$CGID+2,,AUTO          cn=0,n=6

     1214     5086    1       KC$CGID.NAME#.CNT = F$DCB.NAME.L;

   5086  1 000125   200101 470500                    LDP0    JDCB$,,AUTO
         1 000126   000010 236100                    LDQ     8,,PR0
         1 000127   200020 552140                    STBQ    KC$CGID+4,'40'O,AUTO

     1215     5087    1       KC$CGID.NAME#.TXT = F$DCB.NAME.C;

   5087  1 000130   040100 100500                    MLR     fill='040'O
         1 000131   000010 200037                    ADSC9   8,,PR0                   cn=1,n=31
         1 000132   200020 200037                    ADSC9   KC$CGID+4,,AUTO          cn=1,n=31

     1216     5088            /* try to connect the monitor terminal station */
     1217     5089    1       B$CGAUCI = KIS_OSITRM;

   5089  1 000133   000100 100400                    MLR     fill='000'O
         1 000134   000000 000044 0                  ADSC9   KIS_OSITRM               cn=0,n=36
         1 000135   200003 000044                    ADSC9   B$CGAUCI,,AUTO           cn=0,n=36

     1218     5090    1       CALL KCO$TRMCON( LDCT$, KC$CGID, B$CGAUCI, CONERR)

PL6.E3A0      #005=KIS$OSI_ATTACH File=KIS$OSI.:E05TSI                           WED 07/30/97 00:42 Page:192  
   5090  1 000136   200100 631500                    EPPR1   CONERR,,AUTO
         1 000137   200111 451500                    STP1    SCID+5,,AUTO
         1 000140   200003 633500                    EPPR3   B$CGAUCI,,AUTO
         1 000141   200110 453500                    STP3    SCID+4,,AUTO
         1 000142   200014 634500                    EPPR4   KC$CGID,,AUTO
         1 000143   200107 454500                    STP4    SCID+3,,AUTO
         1 000144   200102 635500                    EPPR5   LDCT$,,AUTO
         1 000145   200106 455500                    STP5    SCID+2,,AUTO
         1 000146   200106 630500                    EPPR0   SCID+2,,AUTO
         1 000147   000022 631400 xsym               EPPR1   B_VECTNIL+18
         1 000150   000000 701000 xent               TSX1    KCO$TRMCON
         1 000151   000153 702000 1                  TSX2    s:5094
         1 000152   000172 710000 1                  TRA     s:5122

     1219     5091    2       WHENALTRETURN DO;

     1220     5092                /* unable to connect monitor terminal station to server CG */
     1221     5093                %UNLOCK( G=KIS_OSILOCK);

   5094  1 000153   000000 630400 2                  EPPR0   0
         1 000154   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 000155   000000 701000 xent               TSX1    HFC$UNLOCK
         1 000156   000000 011000                    NOP     0

     1222     5096    2           B$JIT.ERR = ERRDUMMY;

   5096  1 000157   000012 236000 0                  LDQ     ERRDUMMY
         1 000160   000000 470400 xsym               LDP0    B$JIT$
         1 000161   000012 756100                    STQ     10,,PR0

     1223     5097    2           B$JIT.ERR.CODE = CONERR;

   5097  1 000162   200100 236100                    LDQ     CONERR,,AUTO
         1 000163   000003 736000                    QLS     3
         1 000164   000012 676100                    ERQ     10,,PR0
         1 000165   377770 376007                    ANQ     131064,DL
         1 000166   000012 656100                    ERSQ    10,,PR0
PL6.E3A0      #005=KIS$OSI_ATTACH File=KIS$OSI.:E05TSI                           WED 07/30/97 00:42 Page:193  

     1224     5098                /*E*  ERROR:  KIS-E$NOCG-A
     1225     5099                    MESSAGE:  Internal error.  Server comgroup does not exist.
     1226     5100                */
     1227     5101                /*E*  ERROR:  KIS-E$DUPNM-A
     1228     5102                    MESSAGE:  Internal error.  Station name in use.
     1229     5103                */
     1230     5104                /*E*  ERROR:  KIS-E$STAILLGL-A
     1231     5105                    MESSAGE:  Internal error.  Station name illegal.
     1232     5106                */
     1233     5107                /*E*  ERROR:  KIS-E$CGCXT-A
     1234     5108                    MESSAGE:  Internal error.  No room in comgroup to connect station.
     1235     5109                */
     1236     5110                /*E*  ERROR:  KIS-E$NTRMSTA-A
     1237     5111                    MESSAGE:  Internal error.  Station name illegal for terminal.
     1238     5112                */
     1239     5113                /*E*  ERROR:  KIS-E$STABAD-A
     1240     5114                    MESSAGE:  Internal error.  Station name has illegal characters.
     1241     5115                */
     1242     5116    2   SNAP:
     1243     5117    2           CALL SC_PRTCL_SNAP;

   5117  1 000167   000000 713400 xsym  SNAP         CLIMB   SC_PRTCL_SNAP
         1 000170   000000 600000 xsid               climb   nvectors=         0

     1244     5118    2           ALTRETURN;

   5118  1 000171   000000 702200 xent               TSX2  ! X66_AALT

     1245     5119    2           END;
     1246     5120            /* the monitor terminal station has been connected */
     1247     5121            /* fill in more of the LDCT */
     1248     5122    1       NK$LDCT.RESCOD = %NK_OSISTA;

   5122  1 000172   200102 470500                    LDP0    LDCT$,,AUTO
         1 000173   000006 236100                    LDQ     6,,PR0
         1 000174   000001 376000 2                  ANQ     1
PL6.E3A0      #005=KIS$OSI_ATTACH File=KIS$OSI.:E05TSI                           WED 07/30/97 00:42 Page:194  
         1 000175   000015 276007                    ORQ     13,DL
         1 000176   000006 756100                    STQ     6,,PR0

     1249     5123    1       NK$LDCT.USER = B$JIT.USER;

   5123  1 000177   000000 470400 xsym               LDP0    B$JIT$
         1 000200   200102 471500                    LDP1    LDCT$,,AUTO
         1 000201   000000 236100                    LDQ     0,,PR0
         1 000202   100007 552120                    STBQ    7,'20'O,PR1

     1250     5124    1       NK$LDCT.JLNKCNT = B$JIT.LNKCNT;

   5124  1 000203   200102 471500                    LDP1    LDCT$,,AUTO
         1 000204   000314 236100                    LDQ     204,,PR0
         1 000205   100026 552104                    STBQ    22,'04'O,PR1

     1251     5125    1       NK$LDCT.TH.STR = SCID;

   5125  1 000206   200102 471500                    LDP1    LDCT$,,AUTO
         1 000207   200104 236100                    LDQ     SCID,,AUTO
         1 000210   000022 736000                    QLS     18
         1 000211   100016 552120                    STBQ    14,'20'O,PR1

     1252     5126    1       NK$LDCT.LKFLG.ACTIVE = '1'B;

   5126  1 000212   200102 471500                    LDP1    LDCT$,,AUTO
         1 000213   000040 236003                    LDQ     32,DU
         1 000214   100011 256100                    ORSQ    9,,PR1

     1253     5127    1       NK$LDCT.LKFLG.OBLK = '0'B;

   5127  1 000215   200102 471500                    LDP1    LDCT$,,AUTO
         1 000216   000002 236000 2                  LDQ     2
         1 000217   100011 356100                    ANSQ    9,,PR1

     1254     5128    1       NK$LDCT.DFLG.INPUT = '1'B;

PL6.E3A0      #005=KIS$OSI_ATTACH File=KIS$OSI.:E05TSI                           WED 07/30/97 00:42 Page:195  
   5128  1 000220   200102 471500                    LDP1    LDCT$,,AUTO
         1 000221   400000 236007                    LDQ     -131072,DL
         1 000222   100006 256100                    ORSQ    6,,PR1

     1255     5129    1       NK$LDCT.DFLG.OUTPUT = '1'B;

   5129  1 000223   200102 471500                    LDP1    LDCT$,,AUTO
         1 000224   200000 236007                    LDQ     65536,DL
         1 000225   100006 256100                    ORSQ    6,,PR1

     1256     5130    1       NK$LDCT.RLCID.LDCTXB = '777777'O;  /* so we can de-activate later */

   5130  1 000226   777777 220003                    LDX0    -1,DU
         1 000227   200102 471500                    LDP1    LDCT$,,AUTO
         1 000230   100015 440100                    SXL0    13,,PR1

     1257     5131            /* finish init of monitor terminal station */
     1258     5132    1       CALL KCO$TRMGO( LDCT$);

   5132  1 000231   200102 631500                    EPPR1   LDCT$,,AUTO
         1 000232   200106 451500                    STP1    SCID+2,,AUTO
         1 000233   200106 630500                    EPPR0   SCID+2,,AUTO
         1 000234   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 000235   000000 701000 xent               TSX1    KCO$TRMGO
         1 000236   000000 011000                    NOP     0

     1259     5133            /* fill in the major server slot */
     1260     5134    1       MAJOR$->APPL.LDCTX = NK$LDCT.LDCTX;

   5134  1 000237   200102 470500                    LDP0    LDCT$,,AUTO
         1 000240   000006 220100                    LDX0    6,,PR0
         1 000241   200103 471500                    LDP1    MAJOR$,,AUTO
         1 000242   100000 740100                    STX0    0,,PR1

     1261     5135    1       MAJOR$->APPL.Z.LINK = 0;

   5135  1 000243   000000 236003                    LDQ     0,DU
PL6.E3A0      #005=KIS$OSI_ATTACH File=KIS$OSI.:E05TSI                           WED 07/30/97 00:42 Page:196  
         1 000244   100000 552104                    STBQ    0,'04'O,PR1

     1262     5136    1       MAJOR$->APPL.Z.USER = B$JIT.USER;

   5136  1 000245   000000 470400 xsym               LDP0    B$JIT$
         1 000246   000000 236100                    LDQ     0,,PR0
         1 000247   000011 772000                    QRL     9
         1 000250   100000 552110                    STBQ    0,'10'O,PR1

     1263     5137    1       MAJOR$->APPL.TSAP = TSAP;

   5137  1 000251   000000 470400 xsym               LDP0    B$PS1$
         1 000252   000100 100500                    MLR     fill='000'O
         1 000253   000000 000002                    ADSC9   0,,PR0                   cn=0,n=2
         1 000254   200106 000004                    ADSC9   SCID+2,,AUTO             cn=0,n=4
         1 000255   200106 220100                    LDX0    SCID+2,,AUTO
         1 000256   000002 621010                    EAX1    2,X0
         1 000257   000100 100540                    MLR     fill='000'O
         1 000260   000000 000011                    ADSC9   0,,PR0                   cn=0,n=*X1
         1 000261   100001 000042                    ADSC9   1,,PR1                   cn=0,n=34

     1264     5138    1       MAJOR$->APPL.AUDCT = F$DCB.LDCTX;

   5138  1 000262   200101 473500                    LDP3    JDCB$,,AUTO
         1 000263   300051 220100                    LDX0    41,,PR3
         1 000264   100011 440100                    SXL0    9,,PR1

     1265     5139            %UNLOCK( G=KIS_OSILOCK);

   5140  1 000265   000000 630400 2                  EPPR0   0
         1 000266   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 000267   000000 701000 xent               TSX1    HFC$UNLOCK
         1 000270   000000 011000                    NOP     0

     1266     5142            /* fill in the major SCID */
     1267     5143    1       F$DCB.DVFC = BINASC( SCID);

PL6.E3A0      #005=KIS$OSI_ATTACH File=KIS$OSI.:E05TSI                           WED 07/30/97 00:42 Page:197  
   5143  1 000271   200104 236100                    LDQ     SCID,,AUTO
         1 000272   000033 736000                    QLS     27
         1 000273   000003 276000 2                  ORQ     3
         1 000274   200101 470500                    LDP0    JDCB$,,AUTO
         1 000275   000022 772000                    QRL     18
         1 000276   000044 552110                    STBQ    36,'10'O,PR0

     1268     5144            /* now issue a get to the comgroup */
     1269     5145    1       K$RWPARM = K_RWPARM_CON;

   5145  1 000277   000100 100400                    MLR     fill='000'O
         1 000300   000000 000234 xsym               ADSC9   K_RWPARM_CON             cn=0,n=156
         1 000301   200030 000234                    ADSC9   K$RWPARM,,AUTO           cn=0,n=156

     1270     5146    1       CALL KQG$GET( NK$LDCT, K$RWPARM)

   5146  1 000302   200030 631500                    EPPR1   K$RWPARM,,AUTO
         1 000303   200107 451500                    STP1    SCID+3,,AUTO
         1 000304   200102 236100                    LDQ     LDCT$,,AUTO
         1 000305   200106 756100                    STQ     SCID+2,,AUTO
         1 000306   200106 630500                    EPPR0   SCID+2,,AUTO
         1 000307   000020 631400 xsym               EPPR1   B_VECTNIL+16
         1 000310   000000 701000 xent               TSX1    KQG$GET
         1 000311   000313 702000 1                  TSX2    s:5149
         1 000312   000317 710000 1                  TRA     s:5157

     1271     5147    2       WHENALTRETURN DO;

     1272     5148                /* this isn't supposed to happen */
     1273     5149    2           B$JIT.ERR = ERROSIGET;

   5149  1 000313   000014 236000 0                  LDQ     ERROSIGET
         1 000314   000000 470400 xsym               LDP0    B$JIT$
         1 000315   000012 756100                    STQ     10,,PR0

     1274     5150                /*E*  ERROR:  KIS-E$OSIGETERR-A
     1275     5151                    MESSAGE:  Internal error.  GET failed.
PL6.E3A0      #005=KIS$OSI_ATTACH File=KIS$OSI.:E05TSI                           WED 07/30/97 00:42 Page:198  
     1276     5152                */
     1277     5153    2           GOTO SNAP;

   5153  1 000316   000167 710000 1                  TRA     SNAP

     1278     5154    2           END;
     1279     5155            /* otherwise, the get has been left pending and KIS$OSI_SEND
     1280     5156               will be entered later from KCO/KCD when the get is satisfied. */
     1281     5157    1       RETURN;

   5157  1 000317   000000 702200 xent               TSX2  ! X66_ARET

KIS_OSITRM
 Sect OctLoc
   0     000   000000 000000   000000 000000   000000 000000   072117 123111    ............:OSI
   0     004   103107 040040   115117 116111   124117 122040   040040 040040    CG  MONITOR
   0     010   000000 000000                                                    ....

ERRBADOSIACCT
 Sect OctLoc
   0     011   131123 431547                                                    YS..

ERRDUMMY
 Sect OctLoc
   0     012   131123 400007                                                    YS..

ERRMAJORTBL
 Sect OctLoc
   0     013   131123 431337                                                    YS..

ERROSIGET
 Sect OctLoc
   0     014   131123 431517                                                    YS..

ERROSINOLDCT
 Sect OctLoc
   0     015   131123 431377                                                    YS..
PL6.E3A0      #005=KIS$OSI_ATTACH File=KIS$OSI.:E05TSI                           WED 07/30/97 00:42 Page:199  

ERRSRVRNAME
 Sect OctLoc
   0     016   131123 431537                                                    YS..

OSIACCT
 Sect OctLoc
   0     017   072117 123111   103107 040040                                    :OSICG

(unnamed)
 Sect OctLoc
   0     021   115117 116111   124117 122040                                    MONITOR

(unnamed)
 Sect OctLoc
   2     000   000000 006000   777777 777760   577777 777777   000040 040040    .............
     1282     5158
     1283     5159    1       END KIS$OSI_ATTACH;
     1284     5160        %EOD;

PL6.E3A0      #005=KIS$OSI_ATTACH File=KIS$OSI.:E05TSI                           WED 07/30/97 00:42 Page:200  
--  Include file information  --

   F$DCB.:E05TOU  is referenced.
   UM_CP6.:E05TOU  is referenced.
   NK$LDCT.:E05TOU  is referenced.
   NK_SUBS.:E05TOU  is referenced.
   K$RWPARM.:E05TOU  is referenced.
   K_SESSION_M.:E05TOU  is referenced.
   KI_ERRORS_C.:E05TOU  is referenced.
   K_ADDRESS_M.:E05TOU  is referenced.
   KC$CGBLK.:E05TOU  is referenced.
   KC_CP6.:E05TOU  is referenced.
   HF_LOCK_C.:E05TOU  cannot be made into a system file and is referenced.
   CP_6_SUBS.:E05TOU  is referenced.
   B$JIT_C.:E05TOU  is referenced.
      No diagnostics issued in procedure KIS$OSI_ATTACH.
PL6.E3A0      #005=KIS$OSI_ATTACH File=KIS$OSI.:E05TSI                           WED 07/30/97 00:42 Page:201  

 **** Variables and constants ****

  ****  Section 000 RoData KIS$OSI_ATTACH

  ****  Scalars and arrays  ****
OctLoc.c.b A Datatyp(siz) R M Lvl/name                 OctLoc.c.b A Datatyp(siz) R M Lvl/name

    11-0-0/w STRC        r     1 ERRBADOSIACCT             12-0-0/w STRC        r     1 ERRDUMMY
    13-0-0/w STRC        r     1 ERRMAJORTBL               14-0-0/w STRC        r     1 ERROSIGET
    15-0-0/w STRC        r     1 ERROSINOLDCT              16-0-0/w STRC        r     1 ERRSRVRNAME
     0-0-0/w STRC(324)   r     1 KIS_OSITRM                17-0-0/c CHAR(8)     r     1 OSIACCT

  ****  Auto variables  ****

  ****  Scalars and arrays  ****
OctLoc.c.b A Datatyp(siz) R M Lvl/name                 OctLoc.c.b A Datatyp(siz) R M Lvl/name

     3-0-0/w STRC(324)   r     1 B$CGAUCI                 100-0-0/w UBIN        r     1 CONERR
   101-0-0/w PTR         r     1 JDCB$                     30-0-0/d STRC(1404)  r     1 K$RWPARM
    14-0-0/w STRC(432)   r     1 KC$CGID                  102-0-0/w PTR         r     1 LDCT$
   103-0-0/w PTR         r     1 MAJOR$                   104-0-0/w SBIN        r     1 SCID

  ****  SYMREF variables  ****

  ****  Scalars and arrays  ****
OctLoc.c.b A Datatyp(siz) R M Lvl/name                 OctLoc.c.b A Datatyp(siz) R M Lvl/name

     0-0-0/w PTR         r     1 B$JIT$                     0-0-0/w PTR         r     1 B$PS1$
     0-0-0/w PTR         r     1 KIS_MAJOR$                 0-0-0/b BIT (72)    r     1 KIS_OSILOCK
     0-0-0/d STRC(1404)  r     1 K_RWPARM_CON

  ****  BASED and DCB variables  ****

  ****  Scalars and arrays  ****
OctLoc.c.b A Datatyp(siz) R M Lvl/name                 OctLoc.c.b A Datatyp(siz) R M Lvl/name

     0-0-0/w STRC(360)   r     1 APPL                       0-0-0/d STRC(8856)  r     1 B$JIT
PL6.E3A0      #005=KIS$OSI_ATTACH File=KIS$OSI.:E05TSI                           WED 07/30/97 00:42 Page:202  
     0-0-0/d ASTR(3528)  r     1 F$DCB                      0-0-0/d STRC(864)   r     1 NK$LDCT
     0-0-0/c ASTR(18)    r     1 TSAP


   Procedure KIS$OSI_ATTACH requires 208 words for executable code.
   Procedure KIS$OSI_ATTACH requires 74 words of local(AUTO) storage.
PL6.E3A0      #005=KIS$OSI_ATTACH File=KIS$OSI.:E05TSI                           WED 07/30/97 00:42 Page:203  
          *** CROSS REFERENCE LISTING ***
**     DENOTES     IDENTIFIER DEFINITION
<<                 IDENTIFIER'S VALUE SET
>>                 IDENTIFIER'S VALUE USED
<>                 IDENTIFIER SET AND/OR USED
--                 IDENTIFIER REFERENCED
PL6.E3A0      #005=KIS$OSI_ATTACH File=KIS$OSI.:E05TSI                           WED 07/30/97 00:42 Page:204  
          MINI XREF LISTING

APPL.AUDCT
      2568**DCL      5138<<ASSIGN
APPL.CLNTHD
      2528**DCL      2529--REDEF
APPL.LDCTX
      2526**DCL      5134<<ASSIGN
APPL.SRVRHD
      2527**DCL      5049>>IF       5050>>ASSIGN   5052<<ASSIGN   5070>>ASSIGN   5071<<ASSIGN
APPL.TCTX
      2525**DCL      2526--REDEF    2527--REDEF
APPL.TSAP
      2551**DCL      5137<<ASSIGN
APPL.Z.COOKIE
      2530**DCL      2531--REDEF
APPL.Z.LINK
      2532**DCL      5052>>ASSIGN   5070<<ASSIGN   5135<<ASSIGN
APPL.Z.USER
      2531**DCL      5136<<ASSIGN
B$CGAUCI
      1712**DCL      5089<<ASSIGN   5090<>CALL
B$CGAUCI.ATTR
      1719**DCL      1719--REDEF
B$JIT.DCB$
       465**DCL      5026>>ASSIGN
B$JIT.ERR
       375**DCL      5030<<ASSIGN   5038<<ASSIGN   5059<<ASSIGN   5075<<ASSIGN   5096<<ASSIGN   5149<<ASSIGN
B$JIT.ERR.CODE
       376**DCL      5097<<ASSIGN
B$JIT.ERR.MID
       376**DCL       376--REDEF
B$JIT.LNKCNT
       494**DCL      5124>>ASSIGN
PL6.E3A0      #005=KIS$OSI_ATTACH File=KIS$OSI.:E05TSI                           WED 07/30/97 00:42 Page:205  
B$JIT.USER
       375**DCL      5123>>ASSIGN   5136>>ASSIGN
B$JIT$
      5014**DCL       370--IMP-PTR  5026>>ASSIGN   5030>>ASSIGN   5038>>ASSIGN   5059>>ASSIGN   5075>>ASSIGN
      5096>>ASSIGN   5097>>ASSIGN   5123>>ASSIGN   5124>>ASSIGN   5136>>ASSIGN   5149>>ASSIGN
B$PS1$
      5015**DCL      1747--IMP-PTR  5137>>ASSIGN   5137>>ASSIGN
CONERR
      5019**DCL      5090<>CALL     5097>>ASSIGN
ERRBADOSIACCT
      4631**DCL      5038>>ASSIGN
ERRDUMMY
      4679**DCL      5096>>ASSIGN
ERRMAJORTBL
      4727**DCL      5059>>ASSIGN
ERROSIGET
      4775**DCL      5149>>ASSIGN
ERROSINOLDCT
      4823**DCL      5075>>ASSIGN
ERRSRVRNAME
      4871**DCL      5030>>ASSIGN
F$DCB.ACCT
      4967**DCL      5036>>IF
F$DCB.ACTPOS
      4982**DCL      4982--REDEF
F$DCB.ARS
      4957**DCL      4957--REDEF
F$DCB.ATTR
      4975**DCL      4976--REDEF
F$DCB.BORROW
      4990**DCL      4990--REDEF    4990--REDEF    4990--REDEF
F$DCB.DCBNAME.L
      5004**DCL      5004--IMP-SIZ
F$DCB.DVFC
      4978**DCL      5143<<ASSIGN
F$DCB.EOMCHAR
PL6.E3A0      #005=KIS$OSI_ATTACH File=KIS$OSI.:E05TSI                           WED 07/30/97 00:42 Page:206  
      4961**DCL      4961--REDEF
F$DCB.FLDID
      4985**DCL      4985--REDEF
F$DCB.FORM$
      4979**DCL      4979--REDEF
F$DCB.FSECT
      4995**DCL      4995--REDEF
F$DCB.FSN
      4972**DCL      4972--REDEF    4972--REDEF    4973--REDEF
F$DCB.HEADER$
      4978**DCL      4978--REDEF
F$DCB.IXTNSIZE
      4976**DCL      4976--REDEF
F$DCB.LASTSTA$
      4966**DCL      4966--REDEF
F$DCB.LDCTX
      4979**DCL      5138>>ASSIGN
F$DCB.LVL
      4991**DCL      4991--REDEF
F$DCB.NAME.C
      4966**DCL      4966--REDEF    5087>>ASSIGN
F$DCB.NAME.L
      4966**DCL      5028>>IF       5028>>IF       5086>>ASSIGN
F$DCB.NOEOF
      4987**DCL      4987--REDEF
F$DCB.NRECS
      4977**DCL      4977--REDEF
F$DCB.NRECX
      4996**DCL      4996--REDEF
F$DCB.OHDR
      4988**DCL      4988--REDEF
F$DCB.ORG
      4971**DCL      4971--REDEF
F$DCB.PRECNO
      4994**DCL      4994--REDEF
F$DCB.RCSZ
PL6.E3A0      #005=KIS$OSI_ATTACH File=KIS$OSI.:E05TSI                           WED 07/30/97 00:42 Page:207  
      4999**DCL      4999--REDEF
F$DCB.RES
      4967**DCL      4967--REDEF
F$DCB.SETX
      4979**DCL      4979--REDEF
F$DCB.TAB$
      4978**DCL      4979--REDEF
F$DCB.TDA
      4993**DCL      4993--REDEF
F$DCB.WSN
      4968**DCL      4968--REDEF
HFC$LOCK
      1116**DCL-ENT  5046--CALL
HFC$UNLOCK
      1116**DCL-ENT  5057--CALL     5073--CALL     5094--CALL     5140--CALL
JDCB$
      5020**DCL      4957--IMP-PTR  5026<<ASSIGN   5028>>IF       5028>>IF       5036>>IF       5086>>ASSIGN
      5087>>ASSIGN   5138>>ASSIGN   5143>>ASSIGN
K$RWPARM
      2977**DCL      5145<<ASSIGN   5146<>CALL
K$RWPARM.BLKREC
      3003**DCL      3028--REDEF
K$RWPARM.BLKREC.BLKU#
      3004**DCL      3006--REDEF
K$RWPARM.BLKREC.RECU#
      3016**DCL      3018--REDEF
K$RWPARM.DVE.DVBYTE.VFC
      3043**DCL      3044--REDEF
K$RWPARM.DVE.EOMCHAR
      3051**DCL      3055--REDEF
K$RWPARM.ERR
      3115**DCL      3120--REDEF
K$RWPARM.FC
      3079**DCL      3080--REDEF
K$RWPARM.FLDID
      3261**DCL      3262--REDEF
PL6.E3A0      #005=KIS$OSI_ATTACH File=KIS$OSI.:E05TSI                           WED 07/30/97 00:42 Page:208  
K$RWPARM.FPT$
      3142**DCL      3149--REDEF
K$RWPARM.KEYTYPE
      3268**DCL      3269--REDEF
K$RWPARM.MSG$
      2978**DCL      2984--REDEF
K$RWPARM.MSGID
      3090**DCL      3095--REDEF
K$RWPARM.MSGIDXT
      3103**DCL      3107--REDEF
K$RWPARM.ORG
      3239**DCL      3240--REDEF
K$RWPARM.THDRSZ
      3183**DCL      3187--REDEF
K$RWPARM.VDOFLGS
      3241**DCL      3252--REDEF
KC$CGID
      1812**DCL      5090<>CALL
KC$CGID.ACCT#
      1816**DCL      5084<<ASSIGN
KC$CGID.NAME#.CNT
      1820**DCL      5086<<ASSIGN
KC$CGID.NAME#.TXT
      1821**DCL      5087<<ASSIGN
KC$CGID.PSN#
      1817**DCL      5085<<ASSIGN
KCO$TRMCON
      5007**DCL-ENT  5090--CALL
KCO$TRMGO
      5008**DCL-ENT  5132--CALL
KIS_MAJOR$
      5016**DCL      5049>>IF       5050>>ASSIGN   5051>>ASSIGN   5052>>ASSIGN   5070>>ASSIGN   5071>>ASSIGN
KIS_OSILOCK
      5017**DCL      5046<>CALL     5057<>CALL     5073<>CALL     5094<>CALL     5140<>CALL
KIS_OSITRM
      1690**DCL      5089>>ASSIGN
PL6.E3A0      #005=KIS$OSI_ATTACH File=KIS$OSI.:E05TSI                           WED 07/30/97 00:42 Page:209  
KIS_OSITRM.ATTR
      1697**DCL      1697--REDEF
KQG$GET
      5009**DCL-ENT  5146--CALL
K_RWPARM_CON
      3293**DCL      5145>>ASSIGN
K_RWPARM_CON.BLKREC
      3319**DCL      3344--REDEF
K_RWPARM_CON.BLKREC.BLKU#
      3320**DCL      3322--REDEF
K_RWPARM_CON.BLKREC.RECU#
      3332**DCL      3334--REDEF
K_RWPARM_CON.DVE.DVBYTE.VFC
      3359**DCL      3360--REDEF
K_RWPARM_CON.DVE.EOMCHAR
      3367**DCL      3371--REDEF
K_RWPARM_CON.ERR
      3431**DCL      3436--REDEF
K_RWPARM_CON.FC
      3395**DCL      3396--REDEF
K_RWPARM_CON.FLDID
      3577**DCL      3578--REDEF
K_RWPARM_CON.FPT$
      3458**DCL      3465--REDEF
K_RWPARM_CON.KEYTYPE
      3584**DCL      3585--REDEF
K_RWPARM_CON.MSG$
      3294**DCL      3300--REDEF
K_RWPARM_CON.MSGID
      3406**DCL      3411--REDEF
K_RWPARM_CON.MSGIDXT
      3419**DCL      3423--REDEF
K_RWPARM_CON.ORG
      3555**DCL      3556--REDEF
K_RWPARM_CON.THDRSZ
      3499**DCL      3503--REDEF
PL6.E3A0      #005=KIS$OSI_ATTACH File=KIS$OSI.:E05TSI                           WED 07/30/97 00:42 Page:210  
K_RWPARM_CON.VDOFLGS
      3557**DCL      3568--REDEF
LDCT$
      5021**DCL      3728--IMP-PTR  5066<>CALL     5082>>ASSIGN   5090<>CALL     5122>>ASSIGN   5123>>ASSIGN
      5124>>ASSIGN   5125>>ASSIGN   5126>>ASSIGN   5127>>ASSIGN   5128>>ASSIGN   5129>>ASSIGN   5130>>ASSIGN
      5132<>CALL     5134>>ASSIGN   5146>>CALL
MAJOR$
      5022**DCL      5051<<ASSIGN   5052>>ASSIGN   5070>>ASSIGN   5134>>ASSIGN   5135>>ASSIGN   5136>>ASSIGN
      5137>>ASSIGN   5138>>ASSIGN
NK$LDCT
      3728**DCL      5146<>CALL
NK$LDCT.DDT$
      3730**DCL      3730--REDEF
NK$LDCT.DEVNM
      3730**DCL      5082<<ASSIGN
NK$LDCT.DFLG.INPUT
      3732**DCL      5128<<ASSIGN
NK$LDCT.DFLG.OUTPUT
      3732**DCL      5129<<ASSIGN
NK$LDCT.IOQ$
      3729**DCL      3730--REDEF
NK$LDCT.JLNKCNT
      3759**DCL      5124<<ASSIGN
NK$LDCT.LDCTX
      3731**DCL      3731--REDEF    5134>>ASSIGN
NK$LDCT.LKFLG.ABORTED
      3743**DCL      3744--REDEF
NK$LDCT.LKFLG.ACTIVE
      3747**DCL      5126<<ASSIGN
NK$LDCT.LKFLG.OBLK
      3743**DCL      5127<<ASSIGN
NK$LDCT.RESCOD
      3736**DCL      5122<<ASSIGN
NK$LDCT.RLCID.LDCTX
      3753**DCL      3753--REDEF
NK$LDCT.RLCID.LDCTXB
PL6.E3A0      #005=KIS$OSI_ATTACH File=KIS$OSI.:E05TSI                           WED 07/30/97 00:42 Page:211  
      3753**DCL      5130<<ASSIGN
NK$LDCT.STA$
      3749**DCL      3750--REDEF
NK$LDCT.SYMB$
      3728**DCL      3728--REDEF    3728--REDEF    3729--REDEF
NK$LDCT.TH.STR
      3754**DCL      5125<<ASSIGN
NK$LDCT.USER
      3738**DCL      5123<<ASSIGN
NKL$GETDCT
      5010**DCL-ENT  5066--CALL
OSIACCT
      5023**DCL      5036>>IF       5084>>ASSIGN
SCID
      5024**DCL      5050<<ASSIGN   5051>>ASSIGN   5071>>ASSIGN   5125>>ASSIGN   5143>>ASSIGN
SC_PRTCL_SNAP
      5012**DCL-ENT  5117--CALL
SNAP
      5117**LABEL    5153--GOTO
SSS$BLOCK
      5011**DCL-ENT  5044--CALL
TSAP
      1747**DCL      5137>>ASSIGN
TSAP.L#
      1747**DCL      1747--IMP-SIZ  5137>>ASSIGN

PL6.E3A0      #006=KIS$OSI_DETACH File=KIS$OSI.:E05TSI                           WED 07/30/97 00:43 Page:212  
     1285        1        /*T***********************************************************/
     1286        2        /*T*                                                         */
     1287        3        /*T* Copyright (c) Bull HN Information Systems Inc., 1997    */
     1288        4        /*T*                                                         */
     1289        5        /*T***********************************************************/
     1290        6        /*F*    NAME:   KIS$OSI_DETACH
     1291        7                PURPOSE:  Handle M$DETACH of monitor terminal station from server CG.
     1292        8        */
     1293        9        /*D*    NAME:   KIS$OSI_DETACH
     1294       10                CALL:   CALL M$OSI_DETACH ALTRET( label);
     1295       11                INPUT:
     1296       12                    B$JIT.DCB$ - a CG AU DCB already open to the server comgroup.
     1297       13                    B$JIT.DCB$->F$DCB.DVFC holds the major SCID of the application.
     1298       14                OUTPUT:
     1299       15                    On successful call,
     1300       16                      B$JIT.DCB$->F$DCB.DVFC set to zero.
     1301       17                    On unsuccessful call,
     1302       18                      B$JIT.ERROR is filled in with an appropriate error,
     1303       19                      ALTRETURN is taken.
     1304       20                DESCRIPTION:
     1305       21                    KIS$OSI_DETACH is called when an OSI server application decides
     1306       22                    to close down any existing connections from OSI clients and
     1307       23                    disallow new connections.  It is entered from KCP$PMMES when the
     1308       24                    server issues an M$DETACH.
     1309       25
     1310       26                    By the time this code is reached, KCP has determined that the
     1311       27                    DCB is open as AU to a comgroup.
     1312       28
     1313       29                    This module sets up and then calls KQC$CLOSESTA, which cleans up
     1314       30                    comgroup context for the detaching station.  KQC$CLOSESTA calls
     1315       31                    KIS$OSI_DACT so the underlying Transport connection(s) can be
     1316       32                    torn down.  See KIS$OSI_DACT later in this file.
     1317       33        */
     1318       34        KIS$OSI_DETACH: PROC ALTRET;
     1319       35        %INCLUDE B$JIT_C;
     1320      349            %B$JIT0;
     1321      438            %U$JIT1X;
PL6.E3A0      #006=KIS$OSI_DETACH File=KIS$OSI.:E05TSI                           WED 07/30/97 00:43 Page:213  
     1322      441            %M$JIT2X;
     1323      444            %F$JIT3;
     1324      449            %S$JIT4X;
     1325      452            %J$JIT5;
     1326      540            %A$JIT6X;
     1327      543        %INCLUDE CP_6_SUBS;
     1328     1083        %INCLUDE HF_LOCK_C;
     1329     1097        %INCLUDE KQ_SUBS_C;
     1330     1397        %INCLUDE KQ_MAC_C;
     1331     3947            %KQ_STA( FPTN=KQ$STA, STCLASS="BASED( STA$)");
     1332     4286        %INCLUDE K_ADDRESS_M;
     1333     4789        %INCLUDE K_INTERFACE_M;
     1334     5198        %INCLUDE K_SESSION_M;
     1335     5288            %KIS$APPL( NAME=APPL, STCLASS=BASED);
     1336     5357        %INCLUDE NK_LDCT_R;
     1337     5366        %INCLUDE NK_SUBS;
     1338     5391        %INCLUDE NK$LDCT;
     1339     5493            %NK$LDCT( STCLASS="BASED( LDCT$)");
     1340     5539        %MACRO F$DCBI( BASED=BASED);
     1341     5540        %INCLUDE F$DCB;
     1342     5589        %MEND;
     1343     5590            %F$DCBI( BASED="BASED( JDCB$)");
     1344     5640
     1345     5641    1       DCL KQC$CLOSESTA ENTRY(1) ALTRET;
     1346     5642
     1347     5643    1       DCL B$JIT$ PTR SYMREF;
     1348     5644    1       DCL KIS_MAJOR$ PTR SYMREF;
     1349     5645    1       DCL KIS_OSILOCK BIT(72) SYMREF;
     1350     5646
     1351     5647    1       DCL JDCB$ PTR;
     1352     5648    1       DCL LDCT$ PTR;
     1353     5649    1       DCL MAJOR$ PTR;
     1354     5650    1       DCL SCID SBIN;
     1355     5651    1       DCL STA$ PTR;
     1356     5652
     1357     5653    1       JDCB$ = B$JIT.DCB$;
     1358     5654    1       SCID = ASCBIN( F$DCB.DVFC);
PL6.E3A0      #006=KIS$OSI_DETACH File=KIS$OSI.:E05TSI                           WED 07/30/97 00:43 Page:214  
     1359     5655    1       MAJOR$ = PINCRW( KIS_MAJOR$, SCID);
     1360     5656    1       LDCT$ = NK$LDCT$( MAJOR$->APPL.LDCTX);
     1361     5657    1       STA$ = NK$LDCT.STA$;
     1362     5658            %LOCK( G=KIS_OSILOCK);
     1363     5661    2       IF NK$LDCT.LKFLG.ACTIVE THEN DO;
     1364     5662                %UNLOCK( G=KIS_OSILOCK);
     1365     5665    2           CALL KQC$CLOSESTA( KQ$STA)
     1366     5666    3           WHENALTRETURN DO;
     1367     5667                    /* never ALTRETs */
     1368     5668    3               END;
     1369     5669    2           END;
     1370     5670    1       ELSE
     1371     5671                %UNLOCK( G=KIS_OSILOCK);
     1372     5674    1       IF B$JIT.ERR ~= '0'B THEN
     1373     5675                /* some kind of error in lower layer */
     1374     5676    1           ALTRETURN;
     1375     5677            /* scrub other DCB fields we used */
     1376     5678    1       F$DCB.DVFC = BINASC( 0);
     1377     5679    1       RETURN;
     1378     5680
     1379     5681    1       END KIS$OSI_DETACH;
     1380     5682        %EOD;

PL6.E3A0      #006=KIS$OSI_DETACH File=KIS$OSI.:E05TSI                           WED 07/30/97 00:43 Page:215  
--  Include file information  --

   F$DCB.:E05TOU  is referenced.
   NK$LDCT.:E05TOU  is referenced.
   NK_SUBS.:E05TOU  is referenced.
   NK_LDCT_R.:E05TOU  cannot be made into a system file and is referenced.
   K_SESSION_M.:E05TOU  is referenced.
   K_INTERFACE_M.:E05TOU  is referenced.
   K_ADDRESS_M.:E05TOU  is referenced.
   KQ_MAC_C.:E05TOU  is referenced.
   KQ_SUBS_C.:E05TOU  is referenced.
   HF_LOCK_C.:E05TOU  cannot be made into a system file and is referenced.
   CP_6_SUBS.:E05TOU  is referenced.
   B$JIT_C.:E05TOU  is referenced.
      No diagnostics issued in procedure KIS$OSI_DETACH.

   Procedure KIS$OSI_DETACH requires 51 words for executable code.
   Procedure KIS$OSI_DETACH requires 8 words of local(AUTO) storage.

PL6.E3A0      #006=KIS$OSI_DETACH File=KIS$OSI.:E05TSI                           WED 07/30/97 00:43 Page:216  

 Object Unit name= KIS$OSI_DETACH                             File name= KIS$OSI.:E05TOU
 UTS= JUL 30 '97 00:43:38.36 WED                              Compiler= PL-6/E31         Sev=      00
 SharedLib= :SHARED_SYSTEM                                    Alt SharedLib=


    ****  Control sections  ****

 Sect   Type Bound  Init  Size OctSiz  Section name(segment info)
    0   Proc  even  none    51     63  KIS$OSI_DETACH
    1  RoData even  none     1      1  KIS$OSI_DETACH

    ****  Entry defs  ****

                              Check   Calling
                             calling  sequence
  Sect OctLoc Primary Altret sequence   type   Parms  Name
     0      0   yes    yes     yes      Std        0  KIS$OSI_DETACH

  ****  Entry refs  ****

         Check        Calling
        calling       sequence
Altret sequence SRef   type   Args  Name
         yes           Std       1 HFC$LOCK
         yes           Std       1 HFC$UNLOCK
 yes     yes           Std       1 KQC$CLOSESTA
                       nStd      0 X66_AUTO_0
                       Std       0 B_CONSPOOL_D
                       nStd      0 X66_AALT
                       nStd      0 X66_ARET
PL6.E3A0      #006=KIS$OSI_DETACH File=KIS$OSI.:E05TSI                           WED 07/30/97 00:43 Page:217  

  ****  Data refs  ****

  Flags:  r = read only, s = secondary
Flgs Name                             Flgs Name                             Flgs Name
     N$DCT$$                               B$JIT$                                KIS_MAJOR$
     KIS_OSILOCK                           B_VECTNIL

  ****  Segment refs  ****

  Flags:  r = read only, s = secondary
Flgs Name                             Flgs Name                             Flgs Name
     ISSID
PL6.E3A0      #006=KIS$OSI_DETACH File=KIS$OSI.:E05TSI                           WED 07/30/97 00:43 Page:218  


     1285        1        /*T***********************************************************/
     1286        2        /*T*                                                         */
     1287        3        /*T* Copyright (c) Bull HN Information Systems Inc., 1997    */
     1288        4        /*T*                                                         */
     1289        5        /*T***********************************************************/
     1290        6        /*F*    NAME:   KIS$OSI_DETACH
     1291        7                PURPOSE:  Handle M$DETACH of monitor terminal station from server CG.
     1292        8        */
     1293        9        /*D*    NAME:   KIS$OSI_DETACH
     1294       10                CALL:   CALL M$OSI_DETACH ALTRET( label);
     1295       11                INPUT:
     1296       12                    B$JIT.DCB$ - a CG AU DCB already open to the server comgroup.
     1297       13                    B$JIT.DCB$->F$DCB.DVFC holds the major SCID of the application.
     1298       14                OUTPUT:
     1299       15                    On successful call,
     1300       16                      B$JIT.DCB$->F$DCB.DVFC set to zero.
     1301       17                    On unsuccessful call,
     1302       18                      B$JIT.ERROR is filled in with an appropriate error,
     1303       19                      ALTRETURN is taken.
     1304       20                DESCRIPTION:
     1305       21                    KIS$OSI_DETACH is called when an OSI server application decides
     1306       22                    to close down any existing connections from OSI clients and
     1307       23                    disallow new connections.  It is entered from KCP$PMMES when the
     1308       24                    server issues an M$DETACH.
     1309       25
     1310       26                    By the time this code is reached, KCP has determined that the
     1311       27                    DCB is open as AU to a comgroup.
     1312       28
     1313       29                    This module sets up and then calls KQC$CLOSESTA, which cleans up
     1314       30                    comgroup context for the detaching station.  KQC$CLOSESTA calls
     1315       31                    KIS$OSI_DACT so the underlying Transport connection(s) can be
     1316       32                    torn down.  See KIS$OSI_DACT later in this file.
     1317       33        */
     1318       34        KIS$OSI_DETACH: PROC ALTRET;

     34  0 000000   000000 700200 xent  KIS$OSI_DET* TSX0  ! X66_AUTO_0
PL6.E3A0      #006=KIS$OSI_DETACH File=KIS$OSI.:E05TSI                           WED 07/30/97 00:43 Page:219  
         0 000001   000010 000000                    ZERO    8,0

     1319       35        %INCLUDE B$JIT_C;
     1320      349            %B$JIT0;
     1321      438            %U$JIT1X;
     1322      441            %M$JIT2X;
     1323      444            %F$JIT3;
     1324      449            %S$JIT4X;
     1325      452            %J$JIT5;
     1326      540            %A$JIT6X;
     1327      543        %INCLUDE CP_6_SUBS;
     1328     1083        %INCLUDE HF_LOCK_C;
     1329     1097        %INCLUDE KQ_SUBS_C;
     1330     1397        %INCLUDE KQ_MAC_C;
     1331     3947            %KQ_STA( FPTN=KQ$STA, STCLASS="BASED( STA$)");
     1332     4286        %INCLUDE K_ADDRESS_M;
     1333     4789        %INCLUDE K_INTERFACE_M;
     1334     5198        %INCLUDE K_SESSION_M;
     1335     5288            %KIS$APPL( NAME=APPL, STCLASS=BASED);
     1336     5357        %INCLUDE NK_LDCT_R;
     1337     5366        %INCLUDE NK_SUBS;
     1338     5391        %INCLUDE NK$LDCT;
     1339     5493            %NK$LDCT( STCLASS="BASED( LDCT$)");
     1340     5539        %MACRO F$DCBI( BASED=BASED);
     1341     5540        %INCLUDE F$DCB;
     1342     5589        %MEND;
     1343     5590            %F$DCBI( BASED="BASED( JDCB$)");
     1344     5640
     1345     5641    1       DCL KQC$CLOSESTA ENTRY(1) ALTRET;
     1346     5642
     1347     5643    1       DCL B$JIT$ PTR SYMREF;
     1348     5644    1       DCL KIS_MAJOR$ PTR SYMREF;
     1349     5645    1       DCL KIS_OSILOCK BIT(72) SYMREF;
     1350     5646
     1351     5647    1       DCL JDCB$ PTR;
     1352     5648    1       DCL LDCT$ PTR;
     1353     5649    1       DCL MAJOR$ PTR;
PL6.E3A0      #006=KIS$OSI_DETACH File=KIS$OSI.:E05TSI                           WED 07/30/97 00:43 Page:220  
     1354     5650    1       DCL SCID SBIN;
     1355     5651    1       DCL STA$ PTR;
     1356     5652
     1357     5653    1       JDCB$ = B$JIT.DCB$;

   5653  0 000002   000000 470400 xsym               LDP0    B$JIT$
         0 000003   000232 236100                    LDQ     154,,PR0
         0 000004   200003 756100                    STQ     JDCB$,,AUTO

     1358     5654    1       SCID = ASCBIN( F$DCB.DVFC);

   5654  0 000005   200003 471500                    LDP1    JDCB$,,AUTO
         0 000006   100044 236100                    LDQ     36,,PR1
         0 000007   000011 772000                    QRL     9
         0 000010   000777 376007                    ANQ     511,DL
         0 000011   200006 756100                    STQ     SCID,,AUTO

     1359     5655    1       MAJOR$ = PINCRW( KIS_MAJOR$, SCID);

   5655  0 000012   000022 736000                    QLS     18
         0 000013   000000 036000 xsym               ADLQ    KIS_MAJOR$
         0 000014   200005 756100                    STQ     MAJOR$,,AUTO

     1360     5656    1       LDCT$ = NK$LDCT$( MAJOR$->APPL.LDCTX);

   5656  0 000015   200005 473500                    LDP3    MAJOR$,,AUTO
         0 000016   300000 220100                    LDX0    0,,PR3
         0 000017   000000 474400 xsym               LDP4    N$DCT$$
         0 000020   400000 236110                    LDQ     0,X0,PR4
         0 000021   200004 756100                    STQ     LDCT$,,AUTO

     1361     5657    1       STA$ = NK$LDCT.STA$;

   5657  0 000022   200004 475500                    LDP5    LDCT$,,AUTO
         0 000023   500012 236100                    LDQ     10,,PR5
         0 000024   200007 756100                    STQ     STA$,,AUTO

PL6.E3A0      #006=KIS$OSI_DETACH File=KIS$OSI.:E05TSI                           WED 07/30/97 00:43 Page:221  
     1362     5658            %LOCK( G=KIS_OSILOCK);

   5659  0 000025   000000 630400 1                  EPPR0   0
         0 000026   000017 631400 xsym               EPPR1   B_VECTNIL+15
         0 000027   000000 701000 xent               TSX1    HFC$LOCK
         0 000030   000000 011000                    NOP     0

     1363     5661    2       IF NK$LDCT.LKFLG.ACTIVE THEN DO;

   5661  0 000031   200004 470500                    LDP0    LDCT$,,AUTO
         0 000032   000011 236100                    LDQ     9,,PR0
         0 000033   000040 316003                    CANQ    32,DU
         0 000034   000047 600000 0                  TZE     s:5672

     1364     5662                %UNLOCK( G=KIS_OSILOCK);

   5663  0 000035   000000 630400 1                  EPPR0   0
         0 000036   000017 631400 xsym               EPPR1   B_VECTNIL+15
         0 000037   000000 701000 xent               TSX1    HFC$UNLOCK
         0 000040   000000 011000                    NOP     0

     1365     5665    2           CALL KQC$CLOSESTA( KQ$STA)

   5665  0 000041   200007 630500                    EPPR0   STA$,,AUTO
         0 000042   000017 631400 xsym               EPPR1   B_VECTNIL+15
         0 000043   000000 701000 xent               TSX1    KQC$CLOSESTA
         0 000044   000046 702000 0                  TSX2    s:5669
         0 000045   000046 710000 0                  TRA     s:5669

     1366     5666    3           WHENALTRETURN DO;

     1367     5667                    /* never ALTRETs */
     1368     5668    3               END;

     1369     5669    2           END;

   5669  0 000046   000053 710000 0                  TRA     s:5674
PL6.E3A0      #006=KIS$OSI_DETACH File=KIS$OSI.:E05TSI                           WED 07/30/97 00:43 Page:222  

     1370     5670    1       ELSE
     1371     5671                %UNLOCK( G=KIS_OSILOCK);

   5672  0 000047   000000 630400 1                  EPPR0   0
         0 000050   000017 631400 xsym               EPPR1   B_VECTNIL+15
         0 000051   000000 701000 xent               TSX1    HFC$UNLOCK
         0 000052   000000 011000                    NOP     0

     1372     5674    1       IF B$JIT.ERR ~= '0'B THEN

   5674  0 000053   000000 470400 xsym               LDP0    B$JIT$
         0 000054   000012 235100                    LDA     10,,PR0
         0 000055   000057 600000 0                  TZE     s:5678

     1373     5675                /* some kind of error in lower layer */
     1374     5676    1           ALTRETURN;

   5676  0 000056   000000 702200 xent               TSX2  ! X66_AALT

     1375     5677            /* scrub other DCB fields we used */
     1376     5678    1       F$DCB.DVFC = BINASC( 0);

   5678  0 000057   200003 471500                    LDP1    JDCB$,,AUTO
         0 000060   000000 236003                    LDQ     0,DU
         0 000061   100044 552110                    STBQ    36,'10'O,PR1

     1377     5679    1       RETURN;

   5679  0 000062   000000 702200 xent               TSX2  ! X66_ARET

(unnamed)
 Sect OctLoc
   1     000   000000 006000                                                    ....
     1378     5680
     1379     5681    1       END KIS$OSI_DETACH;
     1380     5682        %EOD;
PL6.E3A0      #006=KIS$OSI_DETACH File=KIS$OSI.:E05TSI                           WED 07/30/97 00:43 Page:223  

PL6.E3A0      #006=KIS$OSI_DETACH File=KIS$OSI.:E05TSI                           WED 07/30/97 00:43 Page:224  
--  Include file information  --

   F$DCB.:E05TOU  is referenced.
   NK$LDCT.:E05TOU  is referenced.
   NK_SUBS.:E05TOU  is referenced.
   NK_LDCT_R.:E05TOU  cannot be made into a system file and is referenced.
   K_SESSION_M.:E05TOU  is referenced.
   K_INTERFACE_M.:E05TOU  is referenced.
   K_ADDRESS_M.:E05TOU  is referenced.
   KQ_MAC_C.:E05TOU  is referenced.
   KQ_SUBS_C.:E05TOU  is referenced.
   HF_LOCK_C.:E05TOU  cannot be made into a system file and is referenced.
   CP_6_SUBS.:E05TOU  is referenced.
   B$JIT_C.:E05TOU  is referenced.
      No diagnostics issued in procedure KIS$OSI_DETACH.
PL6.E3A0      #006=KIS$OSI_DETACH File=KIS$OSI.:E05TSI                           WED 07/30/97 00:43 Page:225  

 **** Variables and constants ****

  ****  Auto variables  ****

  ****  Scalars and arrays  ****
OctLoc.c.b A Datatyp(siz) R M Lvl/name                 OctLoc.c.b A Datatyp(siz) R M Lvl/name

     3-0-0/w PTR         r     1 JDCB$                      4-0-0/w PTR         r     1 LDCT$
     5-0-0/w PTR         r     1 MAJOR$                     6-0-0/w SBIN        r     1 SCID
     7-0-0/w PTR         r     1 STA$

  ****  SYMREF variables  ****

  ****  Scalars and arrays  ****
OctLoc.c.b A Datatyp(siz) R M Lvl/name                 OctLoc.c.b A Datatyp(siz) R M Lvl/name

     0-0-0/w PTR         r     1 B$JIT$                     0-0-0/w PTR         r     1 KIS_MAJOR$
     0-0-0/b BIT (72)    r     1 KIS_OSILOCK                0-0-0/w PTR         r     1 N$DCT$$

  ****  BASED and DCB variables  ****

  ****  Scalars and arrays  ****
OctLoc.c.b A Datatyp(siz) R M Lvl/name                 OctLoc.c.b A Datatyp(siz) R M Lvl/name

     0-0-0/w STRC(360)   r     1 APPL                       0-0-0/d STRC(8856)  r     1 B$JIT
     0-0-0/d ASTR(3528)  r     1 F$DCB                      0-0-0/d STRC(1296)  r     1 KQ$STA
     0-0-0/d STRC(864)   r     1 NK$LDCT
     0-0-0/w PTR         r     1 NK$LDCT$(0:0)


   Procedure KIS$OSI_DETACH requires 51 words for executable code.
   Procedure KIS$OSI_DETACH requires 8 words of local(AUTO) storage.
PL6.E3A0      #006=KIS$OSI_DETACH File=KIS$OSI.:E05TSI                           WED 07/30/97 00:43 Page:226  
          *** CROSS REFERENCE LISTING ***
**     DENOTES     IDENTIFIER DEFINITION
<<                 IDENTIFIER'S VALUE SET
>>                 IDENTIFIER'S VALUE USED
<>                 IDENTIFIER SET AND/OR USED
--                 IDENTIFIER REFERENCED
PL6.E3A0      #006=KIS$OSI_DETACH File=KIS$OSI.:E05TSI                           WED 07/30/97 00:43 Page:227  
          MINI XREF LISTING

APPL.CLNTHD
      5315**DCL      5316--REDEF
APPL.LDCTX
      5313**DCL      5656>>ASSIGN
APPL.TCTX
      5312**DCL      5313--REDEF    5314--REDEF
APPL.Z.COOKIE
      5317**DCL      5318--REDEF
B$JIT.DCB$
       445**DCL      5653>>ASSIGN
B$JIT.ERR
       355**DCL      5674>>IF
B$JIT.ERR.MID
       356**DCL       356--REDEF
B$JIT$
      5643**DCL       350--IMP-PTR  5653>>ASSIGN   5674>>IF
F$DCB.ACTPOS
      5616**DCL      5616--REDEF
F$DCB.ARS
      5591**DCL      5591--REDEF
F$DCB.ATTR
      5609**DCL      5610--REDEF
F$DCB.BORROW
      5624**DCL      5624--REDEF    5624--REDEF    5624--REDEF
F$DCB.DCBNAME.L
      5638**DCL      5638--IMP-SIZ
F$DCB.DVFC
      5612**DCL      5654>>ASSIGN   5678<<ASSIGN
F$DCB.EOMCHAR
      5595**DCL      5595--REDEF
F$DCB.FLDID
      5619**DCL      5619--REDEF
PL6.E3A0      #006=KIS$OSI_DETACH File=KIS$OSI.:E05TSI                           WED 07/30/97 00:43 Page:228  
F$DCB.FORM$
      5613**DCL      5613--REDEF
F$DCB.FSECT
      5629**DCL      5629--REDEF
F$DCB.FSN
      5606**DCL      5606--REDEF    5606--REDEF    5607--REDEF
F$DCB.HEADER$
      5612**DCL      5612--REDEF
F$DCB.IXTNSIZE
      5610**DCL      5610--REDEF
F$DCB.LASTSTA$
      5600**DCL      5600--REDEF
F$DCB.LVL
      5625**DCL      5625--REDEF
F$DCB.NAME.C
      5600**DCL      5600--REDEF
F$DCB.NOEOF
      5621**DCL      5621--REDEF
F$DCB.NRECS
      5611**DCL      5611--REDEF
F$DCB.NRECX
      5630**DCL      5630--REDEF
F$DCB.OHDR
      5622**DCL      5622--REDEF
F$DCB.ORG
      5605**DCL      5605--REDEF
F$DCB.PRECNO
      5628**DCL      5628--REDEF
F$DCB.RCSZ
      5633**DCL      5633--REDEF
F$DCB.RES
      5601**DCL      5601--REDEF
F$DCB.SETX
      5613**DCL      5613--REDEF
F$DCB.TAB$
      5612**DCL      5613--REDEF
PL6.E3A0      #006=KIS$OSI_DETACH File=KIS$OSI.:E05TSI                           WED 07/30/97 00:43 Page:229  
F$DCB.TDA
      5627**DCL      5627--REDEF
F$DCB.WSN
      5602**DCL      5602--REDEF
HFC$LOCK
      1096**DCL-ENT  5659--CALL
HFC$UNLOCK
      1096**DCL-ENT  5663--CALL     5672--CALL
JDCB$
      5647**DCL      5591--IMP-PTR  5653<<ASSIGN   5654>>ASSIGN   5678>>ASSIGN
KIS_MAJOR$
      5644**DCL      5655>>ASSIGN
KIS_OSILOCK
      5645**DCL      5659<>CALL     5663<>CALL     5672<>CALL
KQ$STA
      3961**DCL      5665<>CALL
KQ$STA.ACTTYC
      4013**DCL      4017--REDEF
KQ$STA.DCBLNK$
      4020**DCL      4023--REDEF    4027--REDEF
KQ$STA.EVCNT
      4106**DCL      4109--REDEF
KQ$STA.EVNT
      4072**DCL      4076--REDEF    4079--REDEF
KQ$STA.OPNBLKED
      4133**DCL      4136--REDEF
KQ$STA.OPNREJ
      4139**DCL      4141--REDEF
KQ$STA.SUCCREAD
      4062**DCL      4066--REDEF
KQ$STA.TCOUNT
      4191**DCL      4197--REDEF
KQ$STA.VGOT$
      4176**DCL      4180--REDEF    4184--REDEF
KQC$CLOSESTA
      5641**DCL-ENT  5665--CALL
PL6.E3A0      #006=KIS$OSI_DETACH File=KIS$OSI.:E05TSI                           WED 07/30/97 00:43 Page:230  
LDCT$
      5648**DCL      5506--IMP-PTR  5656<<ASSIGN   5657>>ASSIGN   5661>>IF
MAJOR$
      5649**DCL      5655<<ASSIGN   5656>>ASSIGN
N$DCT$$
      5364**DCL      5364--IMP-PTR  5656>>ASSIGN
NK$LDCT.DDT$
      5508**DCL      5508--REDEF
NK$LDCT.IOQ$
      5507**DCL      5508--REDEF
NK$LDCT.LDCTX
      5509**DCL      5509--REDEF
NK$LDCT.LKFLG.ABORTED
      5521**DCL      5522--REDEF
NK$LDCT.LKFLG.ACTIVE
      5525**DCL      5661>>IF
NK$LDCT.RLCID.LDCTX
      5531**DCL      5531--REDEF
NK$LDCT.STA$
      5527**DCL      5528--REDEF    5657>>ASSIGN
NK$LDCT.SYMB$
      5506**DCL      5506--REDEF    5506--REDEF    5507--REDEF
NK$LDCT$
      5364**DCL      5656>>ASSIGN
SCID
      5650**DCL      5654<<ASSIGN   5655>>ASSIGN
STA$
      5651**DCL      3961--IMP-PTR  5657<<ASSIGN   5665>>CALL

PL6.E3A0      #007=KIS$OSI_DACT File=KIS$OSI.:E05TSI                             WED 07/30/97 00:44 Page:231  
     1381        1        /*T***********************************************************/
     1382        2        /*T*                                                         */
     1383        3        /*T* Copyright (c) Bull HN Information Systems Inc., 1997    */
     1384        4        /*T*                                                         */
     1385        5        /*T***********************************************************/
     1386        6        /*F*    NAME:   KIS$OSI_DACT
     1387        7                PURPOSE:  Clean up for de-activation of monitor terminal station.
     1388        8        */
     1389        9        /*D*    NAME:   KIS$OSI_DACT
     1390       10                CALL:   CALL KIS$OSI_DACT( LDCT);
     1391       11                INPUT:
     1392       12                    LDCT - NK_OSISTA LDCT for the monitor terminal station
     1393       13                OUTPUT:
     1394       14                    On successful call,
     1395       15                      Any associated Transport connections are dropped,
     1396       16                      The NK_OSISTA LDCT is released,
     1397       17                      The major server slot is scrubbed.
     1398       18                    On unsuccessful call,
     1399       19                      B$JIT.ERR is filled in with an appropriate error.
     1400       20                      (Note no ALTRETURN.)
     1401       21                      The returned error KIS-E$TRANSPORT indicates trouble releasing
     1402       22                      an underlying Transport connection; in this case the LDCT is
     1403       23                      not released and other information is left around to help debug
     1404       24                      the problem.
     1405       25                DESCRIPTION:
     1406       26                    This routine is called from KQC$CLOSESTA as part of a deactivate-
     1407       27                    and-disconnect of the monitor terminal station of a server CG.
     1408       28                    This occurs either as a result of the server issuing an M$DETACH
     1409       29                    or the server exiting or aborting without M$DETACHing first.
     1410       30
     1411       31                    By the time we get here nothing is left in CG-land pertaining to
     1412       32                    this station, so we can release the LDCT with impunity.  Right.
     1413       33        */
     1414       34        KIS$OSI_DACT: PROC( NK$LDCT);
     1415       35        %INCLUDE B$JIT_C;
     1416      349            %B$JIT0;
     1417      438            %U$JIT1X;
PL6.E3A0      #007=KIS$OSI_DACT File=KIS$OSI.:E05TSI                             WED 07/30/97 00:44 Page:232  
     1418      441            %M$JIT2X;
     1419      444            %F$JIT3;
     1420      449            %S$JIT4X;
     1421      452            %J$JIT5;
     1422      540            %A$JIT6X;
     1423      543        %INCLUDE HF_LOCK_C;
     1424      557        %INCLUDE KI_ERRORS_C;
     1425      642        %INCLUDE K_DATA_R;
     1426     1353            %K$RWPARM( NAME=K$RWPARM, STCLASS=AUTO);
     1427     1669        %INCLUDE K_ADDRESS_M;
     1428     2172        %INCLUDE K_INTERFACE_M;
     1429     2581        %INCLUDE K_SESSION_M;
     1430     2671            %KIS$APPL( NAME=APPL, STCLASS=BASED);
     1431     2740        %INCLUDE K_SUBS_C;
     1432     2773        %INCLUDE K_TRANSPORT_E;
     1433     3098        %INCLUDE NK_LDCT_R;
     1434     3107        %INCLUDE NK_SUBS;
     1435     3132        %INCLUDE NK$LDCT;
     1436     3234            %NK$LDCT( STCLASS="");
     1437     3280        %INCLUDE UM_CP6;
     1438     4132        %MACRO ERRCODE( NAME=ERRDUMMY, CODE=0);
     1439     4133            %VLP_ERRCODE( FPTN=NAME, STCLASS=CONSTANT, FCG='KI', MID='S',
     1440     4134                          MON='1'B, ERR#=CODE, SEV=7);
     1441     4135        %MEND;
     1442     4136            %ERRCODE( NAME=ERRTRANSPORT, CODE=%E$TRANSPORT);
     1443     4184
     1444     4185    1       DCL NKL$RELDCT ENTRY(1) ALTRET;
     1445     4186    1       DCL KIT$SEND ENTRY(1) ALTRET;
     1446     4187    1       DCL SC_PRTCL_SNAP ENTRY CONV(2,0);
     1447     4188
     1448     4189    1       DCL B$JIT$ PTR SYMREF;
     1449     4190    1       DCL KIS_MAJOR$ PTR SYMREF;
     1450     4191    1       DCL KIS_MINOR$ PTR SYMREF;
     1451     4192    1       DCL KIS_OSILOCK BIT(72) SYMREF;
     1452     4193
     1453     4194    1       DCL JITERR BIT(36);
     1454     4195    1       DCL LINK SBIN;
PL6.E3A0      #007=KIS$OSI_DACT File=KIS$OSI.:E05TSI                             WED 07/30/97 00:44 Page:233  
     1455     4196    1       DCL MAJOR$ PTR;
     1456     4197    1       DCL MINOR$ PTR;
     1457     4198    1       DCL SCID SBIN;
     1458     4199
     1459     4200            %LOCK( G=KIS_OSILOCK);
     1460     4203    2       IF NOT NK$LDCT.LKFLG.ACTIVE THEN DO;
     1461     4204                %UNLOCK( G=KIS_OSILOCK);
     1462     4207    2           RETURN;
     1463     4208    2           END;
     1464     4209    1       SCID = NK$LDCT.TH.STR;
     1465     4210    1       MAJOR$ = PINCRW( KIS_MAJOR$, SCID);
     1466     4211    1       K$RWPARM = K_RWPARM_CON;
     1467     4212    1       K$RWPARM.FUNCTION = %K_TDISCONNECT_REQ;
     1468     4213    1       K$RWPARM.ERR = %K_REASON_NOTSPEC;
     1469     4214    1       NK$LDCT.LKFLG.ACTIVE = '0'B;
     1470     4215    1       LINK = MAJOR$->APPL.Z.LINK;
     1471     4216    1       JITERR = B$JIT.ERR;  /* save extant B$JIT.ERR, if any */
     1472     4217    1       B$JIT.ERR = '0'B;  /* zap so Transport error can be seen */
     1473     4218    2       DO WHILE( LINK ~= 0);
     1474     4219    2           MINOR$ = PINCRW( KIS_MINOR$, LINK);
     1475     4220    3           IF MINOR$->APPL.TCTX ~= 0 THEN DO;
     1476     4221                    /* here's a Transport connection that's still open.  Gulp. */
     1477     4222    3               K$RWPARM.TCTX# = MINOR$->APPL.TCTX;
     1478     4223                    /* try to disconnect it */
     1479     4224    3               CALL KIT$SEND( K$RWPARM)
     1480     4225    4               WHENRETURN DO;
     1481     4226                        /* Whew, it worked */
     1482     4227    4                   MINOR$->APPL.TCTX = 0;
     1483     4228    4                   END;
     1484     4229    4               WHENALTRETURN DO;
     1485     4230                        /* Transport was unable to disconnect this one */
     1486     4231    4                   IF K$RWPARM.ERR = %K$USER_ERR THEN
     1487     4232    4                       B$JIT.ERR = K$RWPARM.MSG_ERRCODE;
     1488     4233    5                   ELSE DO;
     1489     4234    5                       B$JIT.ERR = ERRTRANSPORT;
     1490     4235                            /*    ERROR:  KIS-E$TRANSPORT-A
     1491     4236                                MESSAGE:  Internal error.  Transport ALTRETURN.
PL6.E3A0      #007=KIS$OSI_DACT File=KIS$OSI.:E05TSI                             WED 07/30/97 00:44 Page:234  
     1492     4237                            */
     1493     4238    5                       END;
     1494     4239    4                   END;
     1495     4240    3               END;
     1496     4241    2           LINK = MINOR$->APPL.Z.LINK;
     1497     4242    2           END;
     1498     4243            /* if problem in Transport, SNAP now */
     1499     4244    1       IF B$JIT.ERR ~= '0'B THEN
     1500     4245    1           CALL SC_PRTCL_SNAP;
     1501     4246            /* if B$JIT.ERR was nonzero on entry to OSI_DACT, restore it
     1502     4247               otherwise leave B$JIT.ERR as returned by Transport */
     1503     4248    1       IF JITERR ~= '0'B THEN
     1504     4249    1           B$JIT.ERR = JITERR;
     1505     4250            /* in any case, release LDCT and slots */
     1506     4251    1       CALL NKL$RELDCT( NK$LDCT$( NK$LDCT.LDCTX));
     1507     4252            /* release the minor server slots, if any */
     1508     4253    2       IF MAJOR$->APPL.Z.LINK ~= 0 THEN DO;
     1509     4254                /* (assumes MINOR$ still points at last item on chain) */
     1510     4255    2           MINOR$->APPL.Z.LINK = KIS_MINOR$->APPL.Z.LINK;
     1511     4256    2           KIS_MINOR$->APPL.Z.LINK = MAJOR$->APPL.Z.LINK;
     1512     4257    2           END;
     1513     4258            /* release the major server slot */
     1514     4259    1       MAJOR$->APPL.LDCTX = 0;
     1515     4260    1       MAJOR$->APPL.TSAP.LEN = 0;
     1516     4261    1       MAJOR$->APPL.TSAP.TSAP = ' ';
     1517     4262    1       MAJOR$->APPL.AUDCT = 0;
     1518     4263    1       MAJOR$->APPL.Z.USER = 0;
     1519     4264    1       MAJOR$->APPL.Z.LINK = KIS_MAJOR$->APPL.SRVRHD;
     1520     4265    1       KIS_MAJOR$->APPL.SRVRHD = SCID;
     1521     4266            %UNLOCK( G=KIS_OSILOCK);
     1522     4269    1       RETURN;
     1523     4270
     1524     4271    1       END KIS$OSI_DACT;
     1525     4272        %EOD;

PL6.E3A0      #007=KIS$OSI_DACT File=KIS$OSI.:E05TSI                             WED 07/30/97 00:44 Page:235  
--  Include file information  --

   UM_CP6.:E05TOU  is referenced.
   NK$LDCT.:E05TOU  is referenced.
   NK_SUBS.:E05TOU  is referenced.
   NK_LDCT_R.:E05TOU  cannot be made into a system file and is referenced.
   K_TRANSPORT_E.:E05TOU  is referenced.
   K_SUBS_C.:E05TOU  is referenced.
   K_SESSION_M.:E05TOU  is referenced.
   K_INTERFACE_M.:E05TOU  is referenced.
   K_ADDRESS_M.:E05TOU  is referenced.
   K$RWPARM.:E05TOU  is referenced.
   K_DATA_R.:E05TOU  cannot be made into a system file and is referenced.
   KI_ERRORS_C.:E05TOU  is referenced.
   HF_LOCK_C.:E05TOU  cannot be made into a system file and is referenced.
   B$JIT_C.:E05TOU  is referenced.
      No diagnostics issued in procedure KIS$OSI_DACT.

   Procedure KIS$OSI_DACT requires 124 words for executable code.
   Procedure KIS$OSI_DACT requires 52 words of local(AUTO) storage.

PL6.E3A0      #007=KIS$OSI_DACT File=KIS$OSI.:E05TSI                             WED 07/30/97 00:44 Page:236  

 Object Unit name= KIS$OSI_DACT                               File name= KIS$OSI.:E05TOU
 UTS= JUL 30 '97 00:44:05.40 WED                              Compiler= PL-6/E31         Sev=      00
 SharedLib= :SHARED_SYSTEM                                    Alt SharedLib=


    ****  Control sections  ****

 Sect   Type Bound  Init  Size OctSiz  Section name(segment info)
    0  RoData even  UTS      1      1  KIS$OSI_DACT
    1   Proc  even  none   124    174  KIS$OSI_DACT
    2  RoData even  none     2      2  KIS$OSI_DACT

    ****  Entry defs  ****

                              Check   Calling
                             calling  sequence
  Sect OctLoc Primary Altret sequence   type   Parms  Name
     1      0   yes            yes      Std        1  KIS$OSI_DACT

  ****  Entry refs  ****

         Check        Calling
        calling       sequence
Altret sequence SRef   type   Args  Name
         yes           Std       1 HFC$LOCK
         yes           Std       1 HFC$UNLOCK
 yes     yes           Std       1 KIT$SEND
 yes     yes           Std       1 NKL$RELDCT
                       nStd      0 X66_AUTO_1
                       Std       0 B_CONSPOOL_D
                       nStd      0 X66_ARET
PL6.E3A0      #007=KIS$OSI_DACT File=KIS$OSI.:E05TSI                             WED 07/30/97 00:44 Page:237  

  ****  Data refs  ****

  Flags:  r = read only, s = secondary
Flgs Name                             Flgs Name                             Flgs Name
     SC_PRTCL_SNAP                    r    K_RWPARM_CON                          N$DCT$$
     B$JIT$                                KIS_MAJOR$                            KIS_MINOR$
     KIS_OSILOCK                           B_VECTNIL

  ****  Segment refs  ****

  Flags:  r = read only, s = secondary
Flgs Name                             Flgs Name                             Flgs Name
     ASLENTSID                             ISSID
PL6.E3A0      #007=KIS$OSI_DACT File=KIS$OSI.:E05TSI                             WED 07/30/97 00:44 Page:238  


     1381        1        /*T***********************************************************/
     1382        2        /*T*                                                         */
     1383        3        /*T* Copyright (c) Bull HN Information Systems Inc., 1997    */
     1384        4        /*T*                                                         */
     1385        5        /*T***********************************************************/
     1386        6        /*F*    NAME:   KIS$OSI_DACT
     1387        7                PURPOSE:  Clean up for de-activation of monitor terminal station.
     1388        8        */
     1389        9        /*D*    NAME:   KIS$OSI_DACT
     1390       10                CALL:   CALL KIS$OSI_DACT( LDCT);
     1391       11                INPUT:
     1392       12                    LDCT - NK_OSISTA LDCT for the monitor terminal station
     1393       13                OUTPUT:
     1394       14                    On successful call,
     1395       15                      Any associated Transport connections are dropped,
     1396       16                      The NK_OSISTA LDCT is released,
     1397       17                      The major server slot is scrubbed.
     1398       18                    On unsuccessful call,
     1399       19                      B$JIT.ERR is filled in with an appropriate error.
     1400       20                      (Note no ALTRETURN.)
     1401       21                      The returned error KIS-E$TRANSPORT indicates trouble releasing
     1402       22                      an underlying Transport connection; in this case the LDCT is
     1403       23                      not released and other information is left around to help debug
     1404       24                      the problem.
     1405       25                DESCRIPTION:
     1406       26                    This routine is called from KQC$CLOSESTA as part of a deactivate-
     1407       27                    and-disconnect of the monitor terminal station of a server CG.
     1408       28                    This occurs either as a result of the server issuing an M$DETACH
     1409       29                    or the server exiting or aborting without M$DETACHing first.
     1410       30
     1411       31                    By the time we get here nothing is left in CG-land pertaining to
     1412       32                    this station, so we can release the LDCT with impunity.  Right.
     1413       33        */
     1414       34        KIS$OSI_DACT: PROC( NK$LDCT);

     34  1 000000   000000 700200 xent  KIS$OSI_DACT TSX0  ! X66_AUTO_1
PL6.E3A0      #007=KIS$OSI_DACT File=KIS$OSI.:E05TSI                             WED 07/30/97 00:44 Page:239  
         1 000001   000064 000001                    ZERO    52,1

     1415       35        %INCLUDE B$JIT_C;
     1416      349            %B$JIT0;
     1417      438            %U$JIT1X;
     1418      441            %M$JIT2X;
     1419      444            %F$JIT3;
     1420      449            %S$JIT4X;
     1421      452            %J$JIT5;
     1422      540            %A$JIT6X;
     1423      543        %INCLUDE HF_LOCK_C;
     1424      557        %INCLUDE KI_ERRORS_C;
     1425      642        %INCLUDE K_DATA_R;
     1426     1353            %K$RWPARM( NAME=K$RWPARM, STCLASS=AUTO);
     1427     1669        %INCLUDE K_ADDRESS_M;
     1428     2172        %INCLUDE K_INTERFACE_M;
     1429     2581        %INCLUDE K_SESSION_M;
     1430     2671            %KIS$APPL( NAME=APPL, STCLASS=BASED);
     1431     2740        %INCLUDE K_SUBS_C;
     1432     2773        %INCLUDE K_TRANSPORT_E;
     1433     3098        %INCLUDE NK_LDCT_R;
     1434     3107        %INCLUDE NK_SUBS;
     1435     3132        %INCLUDE NK$LDCT;
     1436     3234            %NK$LDCT( STCLASS="");
     1437     3280        %INCLUDE UM_CP6;
     1438     4132        %MACRO ERRCODE( NAME=ERRDUMMY, CODE=0);
     1439     4133            %VLP_ERRCODE( FPTN=NAME, STCLASS=CONSTANT, FCG='KI', MID='S',
     1440     4134                          MON='1'B, ERR#=CODE, SEV=7);
     1441     4135        %MEND;
     1442     4136            %ERRCODE( NAME=ERRTRANSPORT, CODE=%E$TRANSPORT);
     1443     4184
     1444     4185    1       DCL NKL$RELDCT ENTRY(1) ALTRET;
     1445     4186    1       DCL KIT$SEND ENTRY(1) ALTRET;
     1446     4187    1       DCL SC_PRTCL_SNAP ENTRY CONV(2,0);
     1447     4188
     1448     4189    1       DCL B$JIT$ PTR SYMREF;
     1449     4190    1       DCL KIS_MAJOR$ PTR SYMREF;
PL6.E3A0      #007=KIS$OSI_DACT File=KIS$OSI.:E05TSI                             WED 07/30/97 00:44 Page:240  
     1450     4191    1       DCL KIS_MINOR$ PTR SYMREF;
     1451     4192    1       DCL KIS_OSILOCK BIT(72) SYMREF;
     1452     4193
     1453     4194    1       DCL JITERR BIT(36);
     1454     4195    1       DCL LINK SBIN;
     1455     4196    1       DCL MAJOR$ PTR;
     1456     4197    1       DCL MINOR$ PTR;
     1457     4198    1       DCL SCID SBIN;
     1458     4199
     1459     4200            %LOCK( G=KIS_OSILOCK);

   4201  1 000002   000000 630400 2                  EPPR0   0
         1 000003   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 000004   000000 701000 xent               TSX1    HFC$LOCK
         1 000005   000000 011000                    NOP     0

     1460     4203    2       IF NOT NK$LDCT.LKFLG.ACTIVE THEN DO;

   4203  1 000006   200003 470500                    LDP0    @NK$LDCT,,AUTO
         1 000007   000011 236100                    LDQ     9,,PR0
         1 000010   000040 316003                    CANQ    32,DU
         1 000011   000017 601000 1                  TNZ     s:4209

     1461     4204                %UNLOCK( G=KIS_OSILOCK);

   4205  1 000012   000000 630400 2                  EPPR0   0
         1 000013   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 000014   000000 701000 xent               TSX1    HFC$UNLOCK
         1 000015   000000 011000                    NOP     0

     1462     4207    2           RETURN;

   4207  1 000016   000000 702200 xent               TSX2  ! X66_ARET

     1463     4208    2           END;
     1464     4209    1       SCID = NK$LDCT.TH.STR;

PL6.E3A0      #007=KIS$OSI_DACT File=KIS$OSI.:E05TSI                             WED 07/30/97 00:44 Page:241  
   4209  1 000017   000016 236100                    LDQ     14,,PR0
         1 000020   000022 772000                    QRL     18
         1 000021   000777 376007                    ANQ     511,DL
         1 000022   200060 756100                    STQ     SCID,,AUTO

     1465     4210    1       MAJOR$ = PINCRW( KIS_MAJOR$, SCID);

   4210  1 000023   000022 736000                    QLS     18
         1 000024   000000 036000 xsym               ADLQ    KIS_MAJOR$
         1 000025   200056 756100                    STQ     MAJOR$,,AUTO

     1466     4211    1       K$RWPARM = K_RWPARM_CON;

   4211  1 000026   000100 100400                    MLR     fill='000'O
         1 000027   000000 000234 xsym               ADSC9   K_RWPARM_CON             cn=0,n=156
         1 000030   200004 000234                    ADSC9   K$RWPARM,,AUTO           cn=0,n=156

     1467     4212    1       K$RWPARM.FUNCTION = %K_TDISCONNECT_REQ;

   4212  1 000031   000031 235007                    LDA     25,DL
         1 000032   200024 755100                    STA     K$RWPARM+16,,AUTO

     1468     4213    1       K$RWPARM.ERR = %K_REASON_NOTSPEC;

   4213  1 000033   200017 450100                    STZ     K$RWPARM+11,,AUTO

     1469     4214    1       NK$LDCT.LKFLG.ACTIVE = '0'B;

   4214  1 000034   000001 236000 2                  LDQ     1
         1 000035   000011 356100                    ANSQ    9,,PR0

     1470     4215    1       LINK = MAJOR$->APPL.Z.LINK;

   4215  1 000036   200056 471500                    LDP1    MAJOR$,,AUTO
         1 000037   100000 236100                    LDQ     0,,PR1
         1 000040   000777 376007                    ANQ     511,DL
         1 000041   200055 756100                    STQ     LINK,,AUTO
PL6.E3A0      #007=KIS$OSI_DACT File=KIS$OSI.:E05TSI                             WED 07/30/97 00:44 Page:242  

     1471     4216    1       JITERR = B$JIT.ERR;  /* save extant B$JIT.ERR, if any */

   4216  1 000042   000000 473400 xsym               LDP3    B$JIT$
         1 000043   300012 236100                    LDQ     10,,PR3
         1 000044   200054 756100                    STQ     JITERR,,AUTO

     1472     4217    1       B$JIT.ERR = '0'B;  /* zap so Transport error can be seen */

   4217  1 000045   300012 450100                    STZ     10,,PR3

     1473     4218    2       DO WHILE( LINK ~= 0);

   4218  1 000046   200055 235100                    LDA     LINK,,AUTO
         1 000047   000111 600000 1                  TZE     s:4244

     1474     4219    2           MINOR$ = PINCRW( KIS_MINOR$, LINK);

   4219  1 000050   200055 236100                    LDQ     LINK,,AUTO
         1 000051   000022 736000                    QLS     18
         1 000052   000000 036000 xsym               ADLQ    KIS_MINOR$
         1 000053   200057 756100                    STQ     MINOR$,,AUTO

     1475     4220    3           IF MINOR$->APPL.TCTX ~= 0 THEN DO;

   4220  1 000054   200057 470500                    LDP0    MINOR$,,AUTO
         1 000055   000000 220100                    LDX0    0,,PR0
         1 000056   000104 600000 1                  TZE     s:4241

     1476     4221                    /* here's a Transport connection that's still open.  Gulp. */
     1477     4222    3               K$RWPARM.TCTX# = MINOR$->APPL.TCTX;

   4222  1 000057   200037 740100                    STX0    K$RWPARM+27,,AUTO

     1478     4223                    /* try to disconnect it */
     1479     4224    3               CALL KIT$SEND( K$RWPARM)

PL6.E3A0      #007=KIS$OSI_DACT File=KIS$OSI.:E05TSI                             WED 07/30/97 00:44 Page:243  
   4224  1 000060   200004 631500                    EPPR1   K$RWPARM,,AUTO
         1 000061   200062 451500                    STP1    SCID+2,,AUTO
         1 000062   200062 630500                    EPPR0   SCID+2,,AUTO
         1 000063   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 000064   000000 701000 xent               TSX1    KIT$SEND
         1 000065   000072 702000 1                  TSX2    s:4231

     1480     4225    4               WHENRETURN DO;

     1481     4226                        /* Whew, it worked */
     1482     4227    4                   MINOR$->APPL.TCTX = 0;

   4227  1 000066   000000 220003                    LDX0    0,DU
         1 000067   200057 470500                    LDP0    MINOR$,,AUTO
         1 000070   000000 740100                    STX0    0,,PR0

     1483     4228    4                   END;

   4228  1 000071   000104 710000 1                  TRA     s:4241

     1484     4229    4               WHENALTRETURN DO;

     1485     4230                        /* Transport was unable to disconnect this one */
     1486     4231    4                   IF K$RWPARM.ERR = %K$USER_ERR THEN

   4231  1 000072   200017 235100                    LDA     K$RWPARM+11,,AUTO
         1 000073   000010 115007                    CMPA    8,DL
         1 000074   000101 601000 1                  TNZ     s:4234

     1487     4232    4                       B$JIT.ERR = K$RWPARM.MSG_ERRCODE;

   4232  1 000075   200043 236100                    LDQ     K$RWPARM+31,,AUTO
         1 000076   000000 470400 xsym               LDP0    B$JIT$
         1 000077   000012 756100                    STQ     10,,PR0
         1 000100   000104 710000 1                  TRA     s:4241

     1488     4233    5                   ELSE DO;
PL6.E3A0      #007=KIS$OSI_DACT File=KIS$OSI.:E05TSI                             WED 07/30/97 00:44 Page:244  

     1489     4234    5                       B$JIT.ERR = ERRTRANSPORT;

   4234  1 000101   000000 236000 0                  LDQ     ERRTRANSPORT
         1 000102   000000 470400 xsym               LDP0    B$JIT$
         1 000103   000012 756100                    STQ     10,,PR0

     1490     4235                            /*    ERROR:  KIS-E$TRANSPORT-A
     1491     4236                                MESSAGE:  Internal error.  Transport ALTRETURN.
     1492     4237                            */
     1493     4238    5                       END;

     1494     4239    4                   END;

     1495     4240    3               END;

     1496     4241    2           LINK = MINOR$->APPL.Z.LINK;

   4241  1 000104   200057 470500                    LDP0    MINOR$,,AUTO
         1 000105   000000 236100                    LDQ     0,,PR0
         1 000106   000777 376007                    ANQ     511,DL
         1 000107   200055 756100                    STQ     LINK,,AUTO

     1497     4242    2           END;

   4242  1 000110   000050 601000 1                  TNZ     s:4219

     1498     4243            /* if problem in Transport, SNAP now */
     1499     4244    1       IF B$JIT.ERR ~= '0'B THEN

   4244  1 000111   000000 470400 xsym               LDP0    B$JIT$
         1 000112   000012 235100                    LDA     10,,PR0
         1 000113   000116 600000 1                  TZE     s:4248

     1500     4245    1           CALL SC_PRTCL_SNAP;

   4245  1 000114   000000 713400 xsym               CLIMB   SC_PRTCL_SNAP
PL6.E3A0      #007=KIS$OSI_DACT File=KIS$OSI.:E05TSI                             WED 07/30/97 00:44 Page:245  
         1 000115   000000 600000 xsid               climb   nvectors=         0

     1501     4246            /* if B$JIT.ERR was nonzero on entry to OSI_DACT, restore it
     1502     4247               otherwise leave B$JIT.ERR as returned by Transport */
     1503     4248    1       IF JITERR ~= '0'B THEN

   4248  1 000116   200054 235100                    LDA     JITERR,,AUTO
         1 000117   000123 600000 1                  TZE     s:4251

     1504     4249    1           B$JIT.ERR = JITERR;

   4249  1 000120   200054 236100                    LDQ     JITERR,,AUTO
         1 000121   000000 470400 xsym               LDP0    B$JIT$
         1 000122   000012 756100                    STQ     10,,PR0

     1505     4250            /* in any case, release LDCT and slots */
     1506     4251    1       CALL NKL$RELDCT( NK$LDCT$( NK$LDCT.LDCTX));

   4251  1 000123   200003 470500                    LDP0    @NK$LDCT,,AUTO
         1 000124   000006 220100                    LDX0    6,,PR0
         1 000125   000000 636010                    EAQ     0,X0
         1 000126   000000 036000 xsym               ADLQ    N$DCT$$
         1 000127   200062 756100                    STQ     SCID+2,,AUTO
         1 000130   200062 630500                    EPPR0   SCID+2,,AUTO
         1 000131   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 000132   000000 701000 xent               TSX1    NKL$RELDCT
         1 000133   000000 011000                    NOP     0

     1507     4252            /* release the minor server slots, if any */
     1508     4253    2       IF MAJOR$->APPL.Z.LINK ~= 0 THEN DO;

   4253  1 000134   200056 470500                    LDP0    MAJOR$,,AUTO
         1 000135   000000 236100                    LDQ     0,,PR0
         1 000136   000777 316007                    CANQ    511,DL
         1 000137   000147 600000 1                  TZE     s:4259

     1509     4254                /* (assumes MINOR$ still points at last item on chain) */
PL6.E3A0      #007=KIS$OSI_DACT File=KIS$OSI.:E05TSI                             WED 07/30/97 00:44 Page:246  
     1510     4255    2           MINOR$->APPL.Z.LINK = KIS_MINOR$->APPL.Z.LINK;

   4255  1 000140   000000 471400 xsym               LDP1    KIS_MINOR$
         1 000141   200057 473500                    LDP3    MINOR$,,AUTO
         1 000142   100000 236100                    LDQ     0,,PR1
         1 000143   300000 552104                    STBQ    0,'04'O,PR3

     1511     4256    2           KIS_MINOR$->APPL.Z.LINK = MAJOR$->APPL.Z.LINK;

   4256  1 000144   000000 471400 xsym               LDP1    KIS_MINOR$
         1 000145   000000 236100                    LDQ     0,,PR0
         1 000146   100000 552104                    STBQ    0,'04'O,PR1

     1512     4257    2           END;

     1513     4258            /* release the major server slot */
     1514     4259    1       MAJOR$->APPL.LDCTX = 0;

   4259  1 000147   000000 220003                    LDX0    0,DU
         1 000150   000000 740100                    STX0    0,,PR0

     1515     4260    1       MAJOR$->APPL.TSAP.LEN = 0;

   4260  1 000151   000001 740100                    STX0    1,,PR0

     1516     4261    1       MAJOR$->APPL.TSAP.TSAP = ' ';

   4261  1 000152   040100 100400                    MLR     fill='040'O
         1 000153   000035 000001 xsym               ADSC9   B_VECTNIL+29             cn=0,n=1
         1 000154   000001 400040                    ADSC9   1,,PR0                   cn=2,n=32

     1517     4262    1       MAJOR$->APPL.AUDCT = 0;

   4262  1 000155   000011 440100                    SXL0    9,,PR0

     1518     4263    1       MAJOR$->APPL.Z.USER = 0;

PL6.E3A0      #007=KIS$OSI_DACT File=KIS$OSI.:E05TSI                             WED 07/30/97 00:44 Page:247  
   4263  1 000156   000000 236003                    LDQ     0,DU
         1 000157   000000 552110                    STBQ    0,'10'O,PR0

     1519     4264    1       MAJOR$->APPL.Z.LINK = KIS_MAJOR$->APPL.SRVRHD;

   4264  1 000160   000000 471400 xsym               LDP1    KIS_MAJOR$
         1 000161   100000 236100                    LDQ     0,,PR1
         1 000162   000022 772000                    QRL     18
         1 000163   000000 552104                    STBQ    0,'04'O,PR0

     1520     4265    1       KIS_MAJOR$->APPL.SRVRHD = SCID;

   4265  1 000164   200060 721100                    LXL1    SCID,,AUTO
         1 000165   000000 471400 xsym               LDP1    KIS_MAJOR$
         1 000166   100000 741100                    STX1    0,,PR1

     1521     4266            %UNLOCK( G=KIS_OSILOCK);

   4267  1 000167   000000 630400 2                  EPPR0   0
         1 000170   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 000171   000000 701000 xent               TSX1    HFC$UNLOCK
         1 000172   000000 011000                    NOP     0

     1522     4269    1       RETURN;

   4269  1 000173   000000 702200 xent               TSX2  ! X66_ARET

ERRTRANSPORT
 Sect OctLoc
   0     000   131123 431457                                                    YS..

(unnamed)
 Sect OctLoc
   2     000   000000 006000   777737 777777                                    ........
     1523     4270
     1524     4271    1       END KIS$OSI_DACT;
     1525     4272        %EOD;
PL6.E3A0      #007=KIS$OSI_DACT File=KIS$OSI.:E05TSI                             WED 07/30/97 00:44 Page:248  

PL6.E3A0      #007=KIS$OSI_DACT File=KIS$OSI.:E05TSI                             WED 07/30/97 00:44 Page:249  
--  Include file information  --

   UM_CP6.:E05TOU  is referenced.
   NK$LDCT.:E05TOU  is referenced.
   NK_SUBS.:E05TOU  is referenced.
   NK_LDCT_R.:E05TOU  cannot be made into a system file and is referenced.
   K_TRANSPORT_E.:E05TOU  is referenced.
   K_SUBS_C.:E05TOU  is referenced.
   K_SESSION_M.:E05TOU  is referenced.
   K_INTERFACE_M.:E05TOU  is referenced.
   K_ADDRESS_M.:E05TOU  is referenced.
   K$RWPARM.:E05TOU  is referenced.
   K_DATA_R.:E05TOU  cannot be made into a system file and is referenced.
   KI_ERRORS_C.:E05TOU  is referenced.
   HF_LOCK_C.:E05TOU  cannot be made into a system file and is referenced.
   B$JIT_C.:E05TOU  is referenced.
      No diagnostics issued in procedure KIS$OSI_DACT.
PL6.E3A0      #007=KIS$OSI_DACT File=KIS$OSI.:E05TSI                             WED 07/30/97 00:44 Page:250  

 **** Variables and constants ****

  ****  Section 000 RoData KIS$OSI_DACT

  ****  Scalars and arrays  ****
OctLoc.c.b A Datatyp(siz) R M Lvl/name                 OctLoc.c.b A Datatyp(siz) R M Lvl/name

     0-0-0/w STRC        r     1 ERRTRANSPORT

  ****  Auto variables  ****

  ****  Scalars and arrays  ****
OctLoc.c.b A Datatyp(siz) R M Lvl/name                 OctLoc.c.b A Datatyp(siz) R M Lvl/name

     3-0-0/w PTR         r     1 @NK$LDCT                  54-0-0/b BIT         r     1 JITERR
     4-0-0/d STRC(1404)  r     1 K$RWPARM                  55-0-0/w SBIN        r     1 LINK
    56-0-0/w PTR         r     1 MAJOR$                    57-0-0/w PTR         r     1 MINOR$
    *0-0-0/d STRC(864)   r     1 NK$LDCT                   60-0-0/w SBIN        r     1 SCID

  ****  SYMREF variables  ****

  ****  Scalars and arrays  ****
OctLoc.c.b A Datatyp(siz) R M Lvl/name                 OctLoc.c.b A Datatyp(siz) R M Lvl/name

     0-0-0/w PTR         r     1 B$JIT$                     0-0-0/w PTR         r     1 KIS_MAJOR$
     0-0-0/w PTR         r     1 KIS_MINOR$                 0-0-0/b BIT (72)    r     1 KIS_OSILOCK
     0-0-0/d STRC(1404)  r     1 K_RWPARM_CON               0-0-0/w PTR         r     1 N$DCT$$

  ****  BASED and DCB variables  ****

  ****  Scalars and arrays  ****
OctLoc.c.b A Datatyp(siz) R M Lvl/name                 OctLoc.c.b A Datatyp(siz) R M Lvl/name

     0-0-0/w STRC(360)   r     1 APPL                       0-0-0/d STRC(8856)  r     1 B$JIT
     0-0-0/w PTR         r     1 NK$LDCT$(0:0)

PL6.E3A0      #007=KIS$OSI_DACT File=KIS$OSI.:E05TSI                             WED 07/30/97 00:44 Page:251  

   Procedure KIS$OSI_DACT requires 124 words for executable code.
   Procedure KIS$OSI_DACT requires 52 words of local(AUTO) storage.
PL6.E3A0      #007=KIS$OSI_DACT File=KIS$OSI.:E05TSI                             WED 07/30/97 00:44 Page:252  
          *** CROSS REFERENCE LISTING ***
**     DENOTES     IDENTIFIER DEFINITION
<<                 IDENTIFIER'S VALUE SET
>>                 IDENTIFIER'S VALUE USED
<>                 IDENTIFIER SET AND/OR USED
--                 IDENTIFIER REFERENCED
PL6.E3A0      #007=KIS$OSI_DACT File=KIS$OSI.:E05TSI                             WED 07/30/97 00:44 Page:253  
          MINI XREF LISTING

APPL.AUDCT
      2738**DCL      4262<<ASSIGN
APPL.CLNTHD
      2698**DCL      2699--REDEF
APPL.LDCTX
      2696**DCL      4259<<ASSIGN
APPL.SRVRHD
      2697**DCL      4264>>ASSIGN   4265<<ASSIGN
APPL.TCTX
      2695**DCL      2696--REDEF    2697--REDEF    4220>>IF       4222>>ASSIGN   4227<<ASSIGN
APPL.TSAP.LEN
      2723**DCL      4260<<ASSIGN
APPL.TSAP.TSAP
      2731**DCL      4261<<ASSIGN
APPL.Z.COOKIE
      2700**DCL      2701--REDEF
APPL.Z.LINK
      2702**DCL      4215>>ASSIGN   4241>>ASSIGN   4253>>IF       4255<<ASSIGN   4255>>ASSIGN   4256<<ASSIGN
      4256>>ASSIGN   4264<<ASSIGN
APPL.Z.USER
      2701**DCL      4263<<ASSIGN
B$JIT.ERR
       355**DCL      4216>>ASSIGN   4217<<ASSIGN   4232<<ASSIGN   4234<<ASSIGN   4244>>IF       4249<<ASSIGN
B$JIT.ERR.MID
       356**DCL       356--REDEF
B$JIT$
      4189**DCL       350--IMP-PTR  4216>>ASSIGN   4217>>ASSIGN   4232>>ASSIGN   4234>>ASSIGN   4244>>IF
      4249>>ASSIGN
ERRTRANSPORT
      4150**DCL      4234>>ASSIGN
HFC$LOCK
       556**DCL-ENT  4201--CALL
PL6.E3A0      #007=KIS$OSI_DACT File=KIS$OSI.:E05TSI                             WED 07/30/97 00:44 Page:254  
HFC$UNLOCK
       556**DCL-ENT  4205--CALL     4267--CALL
JITERR
      4194**DCL      4216<<ASSIGN   4248>>IF       4249>>ASSIGN
K$RWPARM
      1374**DCL      4211<<ASSIGN   4224<>CALL
K$RWPARM.BLKREC
      1400**DCL      1425--REDEF
K$RWPARM.BLKREC.BLKU#
      1401**DCL      1403--REDEF
K$RWPARM.BLKREC.RECU#
      1413**DCL      1415--REDEF
K$RWPARM.DVE.DVBYTE.VFC
      1440**DCL      1441--REDEF
K$RWPARM.DVE.EOMCHAR
      1448**DCL      1452--REDEF
K$RWPARM.ERR
      1512**DCL      1517--REDEF    4213<<ASSIGN   4231>>IF
K$RWPARM.FC
      1476**DCL      1477--REDEF
K$RWPARM.FLDID
      1658**DCL      1659--REDEF
K$RWPARM.FPT$
      1539**DCL      1546--REDEF
K$RWPARM.FUNCTION
      1553**DCL      4212<<ASSIGN
K$RWPARM.KEYTYPE
      1665**DCL      1666--REDEF
K$RWPARM.MSG$
      1375**DCL      1381--REDEF
K$RWPARM.MSGID
      1487**DCL      1492--REDEF
K$RWPARM.MSGIDXT
      1500**DCL      1504--REDEF
K$RWPARM.MSG_ERRCODE
      1635**DCL      4232>>ASSIGN
PL6.E3A0      #007=KIS$OSI_DACT File=KIS$OSI.:E05TSI                             WED 07/30/97 00:44 Page:255  
K$RWPARM.ORG
      1636**DCL      1637--REDEF
K$RWPARM.TCTX#
      1610**DCL      4222<<ASSIGN
K$RWPARM.THDRSZ
      1580**DCL      1584--REDEF
K$RWPARM.VDOFLGS
      1638**DCL      1649--REDEF
KIS_MAJOR$
      4190**DCL      4210>>ASSIGN   4264>>ASSIGN   4265>>ASSIGN
KIS_MINOR$
      4191**DCL      4219>>ASSIGN   4255>>ASSIGN   4256>>ASSIGN
KIS_OSILOCK
      4192**DCL      4201<>CALL     4205<>CALL     4267<>CALL
KIT$SEND
      4186**DCL-ENT  4224--CALL
K_RWPARM_CON
      1057**DCL      4211>>ASSIGN
K_RWPARM_CON.BLKREC
      1083**DCL      1108--REDEF
K_RWPARM_CON.BLKREC.BLKU#
      1084**DCL      1086--REDEF
K_RWPARM_CON.BLKREC.RECU#
      1096**DCL      1098--REDEF
K_RWPARM_CON.DVE.DVBYTE.VFC
      1123**DCL      1124--REDEF
K_RWPARM_CON.DVE.EOMCHAR
      1131**DCL      1135--REDEF
K_RWPARM_CON.ERR
      1195**DCL      1200--REDEF
K_RWPARM_CON.FC
      1159**DCL      1160--REDEF
K_RWPARM_CON.FLDID
      1341**DCL      1342--REDEF
K_RWPARM_CON.FPT$
      1222**DCL      1229--REDEF
PL6.E3A0      #007=KIS$OSI_DACT File=KIS$OSI.:E05TSI                             WED 07/30/97 00:44 Page:256  
K_RWPARM_CON.KEYTYPE
      1348**DCL      1349--REDEF
K_RWPARM_CON.MSG$
      1058**DCL      1064--REDEF
K_RWPARM_CON.MSGID
      1170**DCL      1175--REDEF
K_RWPARM_CON.MSGIDXT
      1183**DCL      1187--REDEF
K_RWPARM_CON.ORG
      1319**DCL      1320--REDEF
K_RWPARM_CON.THDRSZ
      1263**DCL      1267--REDEF
K_RWPARM_CON.VDOFLGS
      1321**DCL      1332--REDEF
LINK
      4195**DCL      4215<<ASSIGN   4218>>DOWHILE  4219>>ASSIGN   4241<<ASSIGN
MAJOR$
      4196**DCL      4210<<ASSIGN   4215>>ASSIGN   4253>>IF       4256>>ASSIGN   4259>>ASSIGN   4260>>ASSIGN
      4261>>ASSIGN   4262>>ASSIGN   4263>>ASSIGN   4264>>ASSIGN
MINOR$
      4197**DCL      4219<<ASSIGN   4220>>IF       4222>>ASSIGN   4227>>ASSIGN   4241>>ASSIGN   4255>>ASSIGN
N$DCT$$
      3105**DCL      3105--IMP-PTR  4251>>CALL
NK$LDCT
      3247**DCL        34--PROC
NK$LDCT.DDT$
      3249**DCL      3249--REDEF
NK$LDCT.IOQ$
      3248**DCL      3249--REDEF
NK$LDCT.LDCTX
      3250**DCL      3250--REDEF    4251>>CALL
NK$LDCT.LKFLG.ABORTED
      3262**DCL      3263--REDEF
NK$LDCT.LKFLG.ACTIVE
      3266**DCL      4203>>IF       4214<<ASSIGN
NK$LDCT.RLCID.LDCTX
PL6.E3A0      #007=KIS$OSI_DACT File=KIS$OSI.:E05TSI                             WED 07/30/97 00:44 Page:257  
      3272**DCL      3272--REDEF
NK$LDCT.STA$
      3268**DCL      3269--REDEF
NK$LDCT.SYMB$
      3247**DCL      3247--REDEF    3247--REDEF    3248--REDEF
NK$LDCT.TH.STR
      3273**DCL      4209>>ASSIGN
NK$LDCT$
      3105**DCL      4251<>CALL
NKL$RELDCT
      4185**DCL-ENT  4251--CALL
SCID
      4198**DCL      4209<<ASSIGN   4210>>ASSIGN   4265>>ASSIGN
SC_PRTCL_SNAP
      4187**DCL-ENT  4245--CALL

PL6.E3A0      #008=KIS$OSI_SEND File=KIS$OSI.:E05TSI                             WED 07/30/97 00:44 Page:258  
     1526        1        /*T***********************************************************/
     1527        2        /*T*                                                         */
     1528        3        /*T* Copyright (c) Bull HN Information Systems Inc., 1997    */
     1529        4        /*T*                                                         */
     1530        5        /*T***********************************************************/
     1531        6        /*F*    NAME:   KIS$OSI_SEND
     1532        7                PURPOSE:  Scoop up any outgoing messages from server comgroup.
     1533        8        */
     1534        9        /*D*    NAME:   KIS$OSI_SEND
     1535       10                CALL:   CALL KIS$OSI_SEND( NK$LDCT, K$RWPARM) ALTRET( label);
     1536       11                INPUT:
     1537       12                    NK$LDCT - the NK_OSISTA LDCT for this application,
     1538       13                    K$RWPARM - parameters for the message to be sent.
     1539       14                OUTPUT:
     1540       15                    On successful call,
     1541       16                      None.  The message is written into the network.
     1542       17                    On unsuccessful call,
     1543       18                      K$RWPARM.ERR is set to an appropriate error code,
     1544       19                      ALTRETURN is taken.
     1545       20                      If Transport is unable to forward the message, we attempt to
     1546       21                      reissue the CG read anyway.
     1547       22                DESCRIPTION:
     1548       23                    KIS$OSI_SEND is called from KCD$WRITE when a message has been
     1549       24                    written into the server comgroup aimed at the monitor terminal
     1550       25                    station.  The message is dumped into the network and the CG
     1551       26                    read is reissued.
     1552       27        */
     1553       28        KIS$OSI_SEND: PROC( NK$LDCT, K$RWPARM) ALTRET;
     1554       29        %INCLUDE B_STRINGS_C;
     1555      158        %INCLUDE CP_6;
     1556     5717        %INCLUDE CP_6_SUBS;
     1557     6257            %B$NWIO( NAME=NWIO, STCLASS=AUTO, PARONLY=1);
     1558     6338            %SUB_EXC;
     1559     6385        %INCLUDE HF_LOCK_C;
     1560     6399        %INCLUDE K_ADDRESS_M;
     1561     6902        %INCLUDE K_INTERFACE_M;
     1562     7311            %K$FPT_CONNECT_OSI;
PL6.E3A0      #008=KIS$OSI_SEND File=KIS$OSI.:E05TSI                             WED 07/30/97 00:44 Page:259  
     1563     7648        %INCLUDE K_SESSION_M;
     1564     7738            %KIS$APPL( NAME=APPL, STCLASS=BASED);
     1565     7807            %KIS$GLUE( NAME=GLUE, STCLASS="BASED( K$RWPARM.MSG$)");
     1566     7837        %INCLUDE K_DATA_R;
     1567     8548            %K$RWPARM( NAME=K$RWPARM, STCLASS="");
     1568     8864            %K$RWPARM( NAME=OSIPARM, STCLASS=AUTO);
     1569     9180        %INCLUDE K_SUBS_C;
     1570     9213        %INCLUDE NK_SUBS;
     1571     9238        %INCLUDE NK$LDCT;
     1572     9340            %NK$LDCT( STCLASS="");
     1573     9386        %INCLUDE SS_SCHED_C;
     1574     9619        %EQU XSS_EVID = 23111251;  /* that's 'XSS' as an integer... */
     1575     9620
     1576     9621    1       DCL KIA$OQFL ENTRY(1) ALTRET;
     1577     9622    1       DCL KIT$SEND ENTRY(1) ALTRET;
     1578     9623    1       DCL SSR$RUE ENTRY(4);
     1579     9624    1       DCL SSV$EVENT ENTRY(7);
     1580     9625    1       DCL SC_PRTCL_SNAP ENTRY CONV(2,0);
     1581     9626
     1582     9627    1       DCL KIS_MAJOR$ PTR SYMREF;
     1583     9628    1       DCL KIS_MINOR$ PTR SYMREF;
     1584     9629
     1585     9630    1       DCL I UBIN;
     1586     9631    1       DCL MAJOR$ PTR;
     1587     9632    1       DCL MINOR$ PTR;
     1588     9633    1       DCL SCID SBIN;
     1589     9634
     1590     9635    1       K$RWPARM.ERR = 0;
     1591     9636            /* set up for passing the message on to Transport */
     1592     9637    1       OSIPARM = K_RWPARM_CON;
     1593     9638    1       OSIPARM.FUNCTION = GLUE.TRNFNC;
     1594     9639            /* get the major and minor SCIDs */
     1595     9640    1       SCID = NK$LDCT.TH.STR;
     1596     9641    1       I = GLUE.MAGIC;
     1597     9642    1       MAJOR$ = PINCRW( KIS_MAJOR$, SCID);
     1598     9643    1       MINOR$ = PINCRW( KIS_MINOR$, I);
     1599     9644    1       MINOR$->APPL.Z.COOKIE = GLUE.MYSCID;
PL6.E3A0      #008=KIS$OSI_SEND File=KIS$OSI.:E05TSI                             WED 07/30/97 00:44 Page:260  
     1600     9645    2       DO CASE( GLUE.TRNFNC);
     1601     9646    2           CASE( %K_TCREDIT);
     1602     9647                    /* This is an idiot credit message from the library */
     1603     9648    2               OSIPARM.SSN_CRDT = 1;
     1604     9649    2           CASE( %K_TCONNECT_RSP);
     1605     9650                    /* This is a T-CONNECT Response */
     1606     9651    2               OSIPARM.FPT$ = ADDR( GLUE.DATA);
     1607     9652    2               OSIPARM.FPT$->K$FPT_CONNECT_OSI.SCID = SCID * 512 + I;
     1608     9653    2           CASE( %K_TDISCONNECT_REQ);
     1609     9654                    /* This is a T-DISCONNECT Req */
     1610     9655    2               OSIPARM.FPT$ = ADDR( GLUE.DATA);
     1611     9656    2           CASE( %K_TDATA_REQ,
     1612     9657    2                 %K_TEXPD_DATA_REQ);
     1613     9658                    /* This is a T-DATA Request or T-EXPEDITED-DATA Request */
     1614     9659    2               OSIPARM.SHDR$ = ADDR( GLUE.DATA);
     1615     9660    2               OSIPARM.SHDRSZ = K$RWPARM.MSGSZ - 4;
     1616     9661    2           END;
     1617     9662            /* determine which Transport connection */
     1618     9663    1       OSIPARM.TCTX# = MINOR$->APPL.TCTX;
     1619     9664            /* send the message on to Transport */
     1620     9665            %LOCK( G=NK$LDCT.LOCK);
     1621     9668    1   TRYSEND:
     1622     9669    1       CALL KIT$SEND( OSIPARM)
     1623     9670    2       WHENRETURN DO;
     1624     9671                %UNLOCK( G=NK$LDCT.LOCK);
     1625     9674    2           IF GLUE.TRNFNC = %K_TDISCONNECT_REQ THEN
     1626     9675    2               MINOR$->APPL.TCTX = 0;  /* successful disconnect */
     1627     9676    2           END;
     1628     9677    2       WHENALTRETURN DO;
     1629     9678                /* Transport has filled in OSIPARM.ERR */
     1630     9679    3           IF OSIPARM.ERR = %K$QFULL THEN DO;
     1631     9680    3               CALL KIA$OQFL( NK$LDCT)
     1632     9681    4               WHENALTRETURN DO;
     1633     9682                        %UNLOCK( G=NK$LDCT.LOCK);
     1634     9685    4                   GOTO SNAP;
     1635     9686    4                   END;
     1636     9687    3               GOTO TRYSEND;
PL6.E3A0      #008=KIS$OSI_SEND File=KIS$OSI.:E05TSI                             WED 07/30/97 00:44 Page:261  
     1637     9688    3               END;
     1638     9689                %UNLOCK( G=NK$LDCT.LOCK);
     1639     9692    2           IF OSIPARM.ERR ~= %K$USER_ERR THEN
     1640     9693    2   SNAP:
     1641     9694    2               CALL SC_PRTCL_SNAP;
     1642     9695    2           END;
     1643     9696    2       IF OSIPARM.ERR ~= 0 THEN DO;
     1644     9697                /* must have been Transport-reported error */
     1645     9698                /* This will be given to the Session library as a no-wait
     1646     9699                   read event.  We don't care about decrementing Transport
     1647     9700                   credits because the event will abort the application. */
     1648     9701    2           NWIO = '0'B;
     1649     9702    2           NWIO.P# = SIZEW( NWIO) - SIZEW( NWIO.P#);
     1650     9703    2           NWIO.TYC = %TYC_LAST;
     1651     9704    2           IF OSIPARM.ERR = %K$USER_ERR THEN
     1652     9705    2               NWIO.IOERRCODE = OSIPARM.MSG_ERRCODE;
     1653     9706    2           ELSE
     1654     9707    2               NWIO.IOERRCODE = '0'B;
     1655     9708    2           CALL SSV$EVENT( MAJOR$->APPL.Z.USER, %USERWSR, %SUBC_IO#,
     1656     9709    2                   %XSS_EVID*512 + MINOR$->APPL.Z.COOKIE,
     1657     9710    2                   OSIPARM.ERR, ADDR( NWIO));
     1658     9711    2           CALL SSR$RUE( %SS_FPEVNT, MAJOR$->APPL.Z.USER);
     1659     9712    2           END;
     1660     9713            /* now let CG-land reissue the read for us... */
     1661     9714    1       RETURN;
     1662     9715
     1663     9716    1       END KIS$OSI_SEND;
     1664     9717        %EOD;

PL6.E3A0      #008=KIS$OSI_SEND File=KIS$OSI.:E05TSI                             WED 07/30/97 00:44 Page:262  
--  Include file information  --

   SS_SCHED_C.:E05TOU  is referenced.
   NK$LDCT.:E05TOU  is referenced.
   NK_SUBS.:E05TOU  is referenced.
   K_SUBS_C.:E05TOU  is referenced.
   K$RWPARM.:E05TOU  is referenced.
   K_DATA_R.:E05TOU  cannot be made into a system file and is referenced.
   K_SESSION_M.:E05TOU  is referenced.
   K_INTERFACE_M.:E05TOU  is referenced.
   K_ADDRESS_M.:E05TOU  is referenced.
   HF_LOCK_C.:E05TOU  cannot be made into a system file and is referenced.
   CP_6_SUBS.:E05TOU  is referenced.
   CP_6_C.:E05TOU  is referenced.
   CP_6.:E05TOU  cannot be made into a system file and is referenced.
   B_STRINGS_C.:E05TOU  is referenced.
      No diagnostics issued in procedure KIS$OSI_SEND.

   Procedure KIS$OSI_SEND requires 174 words for executable code.
   Procedure KIS$OSI_SEND requires 70 words of local(AUTO) storage.

PL6.E3A0      #008=KIS$OSI_SEND File=KIS$OSI.:E05TSI                             WED 07/30/97 00:44 Page:263  

 Object Unit name= KIS$OSI_SEND                               File name= KIS$OSI.:E05TOU
 UTS= JUL 30 '97 00:44:33.32 WED                              Compiler= PL-6/E31         Sev=      00
 SharedLib= :SHARED_SYSTEM                                    Alt SharedLib=


    ****  Control sections  ****

 Sect   Type Bound  Init  Size OctSiz  Section name(segment info)
    0   DCB   even  none     0      0  M$UC
    1   Proc  even  none   174    256  KIS$OSI_SEND
    2  RoData even  none     5      5  KIS$OSI_SEND

    ****  Entry defs  ****

                              Check   Calling
                             calling  sequence
  Sect OctLoc Primary Altret sequence   type   Parms  Name
     1      0   yes    yes     yes      Std        2  KIS$OSI_SEND

  ****  Entry refs  ****

         Check        Calling
        calling       sequence
Altret sequence SRef   type   Args  Name
         yes           Std       1 HFC$LOCK
 yes     yes           Std       1 KIT$SEND
         yes           Std       1 HFC$UNLOCK
         yes           Std       7 SSV$EVENT
 yes     yes           Std       1 KIA$OQFL
         yes           Std       4 SSR$RUE
                       Std       0 B_CONSPOOL_D
                       nStd      0 X66_AUTO_2
                       nStd      0 X66_ARET
PL6.E3A0      #008=KIS$OSI_SEND File=KIS$OSI.:E05TSI                             WED 07/30/97 00:44 Page:264  

  ****  Data refs  ****

  Flags:  r = read only, s = secondary
Flgs Name                             Flgs Name                             Flgs Name
     SC_PRTCL_SNAP                         M$UC                             r    K_RWPARM_CON
     KIS_MAJOR$                            KIS_MINOR$                            B_VECTNIL

  ****  Segment refs  ****

  Flags:  r = read only, s = secondary
Flgs Name                             Flgs Name                             Flgs Name
     ASLENTSID                             ISSID
PL6.E3A0      #008=KIS$OSI_SEND File=KIS$OSI.:E05TSI                             WED 07/30/97 00:44 Page:265  


     1526        1        /*T***********************************************************/
     1527        2        /*T*                                                         */
     1528        3        /*T* Copyright (c) Bull HN Information Systems Inc., 1997    */
     1529        4        /*T*                                                         */
     1530        5        /*T***********************************************************/
     1531        6        /*F*    NAME:   KIS$OSI_SEND
     1532        7                PURPOSE:  Scoop up any outgoing messages from server comgroup.
     1533        8        */
     1534        9        /*D*    NAME:   KIS$OSI_SEND
     1535       10                CALL:   CALL KIS$OSI_SEND( NK$LDCT, K$RWPARM) ALTRET( label);
     1536       11                INPUT:
     1537       12                    NK$LDCT - the NK_OSISTA LDCT for this application,
     1538       13                    K$RWPARM - parameters for the message to be sent.
     1539       14                OUTPUT:
     1540       15                    On successful call,
     1541       16                      None.  The message is written into the network.
     1542       17                    On unsuccessful call,
     1543       18                      K$RWPARM.ERR is set to an appropriate error code,
     1544       19                      ALTRETURN is taken.
     1545       20                      If Transport is unable to forward the message, we attempt to
     1546       21                      reissue the CG read anyway.
     1547       22                DESCRIPTION:
     1548       23                    KIS$OSI_SEND is called from KCD$WRITE when a message has been
     1549       24                    written into the server comgroup aimed at the monitor terminal
     1550       25                    station.  The message is dumped into the network and the CG
     1551       26                    read is reissued.
     1552       27        */
     1553       28        KIS$OSI_SEND: PROC( NK$LDCT, K$RWPARM) ALTRET;

     28  1 000000   000000 700200 xent  KIS$OSI_SEND TSX0  ! X66_AUTO_2
         1 000001   000106 000002                    ZERO    70,2

     1554       29        %INCLUDE B_STRINGS_C;
     1555      158        %INCLUDE CP_6;
     1556     5717        %INCLUDE CP_6_SUBS;
     1557     6257            %B$NWIO( NAME=NWIO, STCLASS=AUTO, PARONLY=1);
PL6.E3A0      #008=KIS$OSI_SEND File=KIS$OSI.:E05TSI                             WED 07/30/97 00:44 Page:266  
     1558     6338            %SUB_EXC;
     1559     6385        %INCLUDE HF_LOCK_C;
     1560     6399        %INCLUDE K_ADDRESS_M;
     1561     6902        %INCLUDE K_INTERFACE_M;
     1562     7311            %K$FPT_CONNECT_OSI;
     1563     7648        %INCLUDE K_SESSION_M;
     1564     7738            %KIS$APPL( NAME=APPL, STCLASS=BASED);
     1565     7807            %KIS$GLUE( NAME=GLUE, STCLASS="BASED( K$RWPARM.MSG$)");
     1566     7837        %INCLUDE K_DATA_R;
     1567     8548            %K$RWPARM( NAME=K$RWPARM, STCLASS="");
     1568     8864            %K$RWPARM( NAME=OSIPARM, STCLASS=AUTO);
     1569     9180        %INCLUDE K_SUBS_C;
     1570     9213        %INCLUDE NK_SUBS;
     1571     9238        %INCLUDE NK$LDCT;
     1572     9340            %NK$LDCT( STCLASS="");
     1573     9386        %INCLUDE SS_SCHED_C;
     1574     9619        %EQU XSS_EVID = 23111251;  /* that's 'XSS' as an integer... */
     1575     9620
     1576     9621    1       DCL KIA$OQFL ENTRY(1) ALTRET;
     1577     9622    1       DCL KIT$SEND ENTRY(1) ALTRET;
     1578     9623    1       DCL SSR$RUE ENTRY(4);
     1579     9624    1       DCL SSV$EVENT ENTRY(7);
     1580     9625    1       DCL SC_PRTCL_SNAP ENTRY CONV(2,0);
     1581     9626
     1582     9627    1       DCL KIS_MAJOR$ PTR SYMREF;
     1583     9628    1       DCL KIS_MINOR$ PTR SYMREF;
     1584     9629
     1585     9630    1       DCL I UBIN;
     1586     9631    1       DCL MAJOR$ PTR;
     1587     9632    1       DCL MINOR$ PTR;
     1588     9633    1       DCL SCID SBIN;
     1589     9634
     1590     9635    1       K$RWPARM.ERR = 0;

   9635  1 000002   200004 470500                    LDP0    @K$RWPARM,,AUTO
         1 000003   000013 450100                    STZ     11,,PR0

PL6.E3A0      #008=KIS$OSI_SEND File=KIS$OSI.:E05TSI                             WED 07/30/97 00:44 Page:267  
     1591     9636            /* set up for passing the message on to Transport */
     1592     9637    1       OSIPARM = K_RWPARM_CON;

   9637  1 000004   000100 100400                    MLR     fill='000'O
         1 000005   000000 000234 xsym               ADSC9   K_RWPARM_CON             cn=0,n=156
         1 000006   200022 000234                    ADSC9   OSIPARM,,AUTO            cn=0,n=156

     1593     9638    1       OSIPARM.FUNCTION = GLUE.TRNFNC;

   9638  1 000007   000000 471500                    LDP1    0,,PR0
         1 000010   100000 236100                    LDQ     0,,PR1
         1 000011   000022 772000                    QRL     18
         1 000012   000777 376007                    ANQ     511,DL
         1 000013   200042 756100                    STQ     OSIPARM+16,,AUTO

     1594     9639            /* get the major and minor SCIDs */
     1595     9640    1       SCID = NK$LDCT.TH.STR;

   9640  1 000014   200003 471500                    LDP1    @NK$LDCT,,AUTO
         1 000015   100016 236100                    LDQ     14,,PR1
         1 000016   000022 772000                    QRL     18
         1 000017   000777 376007                    ANQ     511,DL
         1 000020   200075 756100                    STQ     SCID,,AUTO

     1596     9641    1       I = GLUE.MAGIC;

   9641  1 000021   000000 473500                    LDP3    0,,PR0
         1 000022   300000 236100                    LDQ     0,,PR3
         1 000023   000777 376007                    ANQ     511,DL
         1 000024   200072 756100                    STQ     I,,AUTO

     1597     9642    1       MAJOR$ = PINCRW( KIS_MAJOR$, SCID);

   9642  1 000025   200075 236100                    LDQ     SCID,,AUTO
         1 000026   000022 736000                    QLS     18
         1 000027   000000 036000 xsym               ADLQ    KIS_MAJOR$
         1 000030   200073 756100                    STQ     MAJOR$,,AUTO
PL6.E3A0      #008=KIS$OSI_SEND File=KIS$OSI.:E05TSI                             WED 07/30/97 00:44 Page:268  

     1598     9643    1       MINOR$ = PINCRW( KIS_MINOR$, I);

   9643  1 000031   200072 236100                    LDQ     I,,AUTO
         1 000032   000022 736000                    QLS     18
         1 000033   000000 036000 xsym               ADLQ    KIS_MINOR$
         1 000034   200074 756100                    STQ     MINOR$,,AUTO

     1599     9644    1       MINOR$->APPL.Z.COOKIE = GLUE.MYSCID;

   9644  1 000035   200074 474500                    LDP4    MINOR$,,AUTO
         1 000036   300000 236100                    LDQ     0,,PR3
         1 000037   000022 772000                    QRL     18
         1 000040   400000 552110                    STBQ    0,'10'O,PR4

     1600     9645    2       DO CASE( GLUE.TRNFNC);

   9645  1 000041   000000 473500                    LDP3    0,,PR0
         1 000042   300000 236100                    LDQ     0,,PR3
         1 000043   000022 772000                    QRL     18
         1 000044   000777 376007                    ANQ     511,DL
         1 000045   000026 136007                    SBLQ    22,DL
         1 000046   000005 116007                    CMPQ    5,DL
         1 000047   000051 602006 1                  TNC     s:9645+8,QL
         1 000050   000100 710000 1                  TRA     s:9663
         1 000051   000061 710000 1                  TRA     s:9651
         1 000052   000073 710000 1                  TRA     s:9659
         1 000053   000073 710000 1                  TRA     s:9659
         1 000054   000070 710000 1                  TRA     s:9655
         1 000055   000056 710000 1                  TRA     s:9648

     1601     9646    2           CASE( %K_TCREDIT);

     1602     9647                    /* This is an idiot credit message from the library */
     1603     9648    2               OSIPARM.SSN_CRDT = 1;

   9648  1 000056   000001 235007                    LDA     1,DL
PL6.E3A0      #008=KIS$OSI_SEND File=KIS$OSI.:E05TSI                             WED 07/30/97 00:44 Page:269  
         1 000057   200047 755100                    STA     OSIPARM+21,,AUTO
         1 000060   000100 710000 1                  TRA     s:9663

     1604     9649    2           CASE( %K_TCONNECT_RSP);

     1605     9650                    /* This is a T-CONNECT Response */
     1606     9651    2               OSIPARM.FPT$ = ADDR( GLUE.DATA);

   9651  1 000061   300001 635500                    EPPR5   1,,PR3
         1 000062   200041 455500                    STP5    OSIPARM+15,,AUTO

     1607     9652    2               OSIPARM.FPT$->K$FPT_CONNECT_OSI.SCID = SCID * 512 + I;

   9652  1 000063   200075 236100                    LDQ     SCID,,AUTO
         1 000064   000011 736000                    QLS     9
         1 000065   200072 036100                    ADLQ    I,,AUTO
         1 000066   500005 756100                    STQ     5,,PR5
         1 000067   000100 710000 1                  TRA     s:9663

     1608     9653    2           CASE( %K_TDISCONNECT_REQ);

     1609     9654                    /* This is a T-DISCONNECT Req */
     1610     9655    2               OSIPARM.FPT$ = ADDR( GLUE.DATA);

   9655  1 000070   300001 635500                    EPPR5   1,,PR3
         1 000071   200041 455500                    STP5    OSIPARM+15,,AUTO
         1 000072   000100 710000 1                  TRA     s:9663

     1611     9656    2           CASE( %K_TDATA_REQ,

     1612     9657    2                 %K_TEXPD_DATA_REQ);
     1613     9658                    /* This is a T-DATA Request or T-EXPEDITED-DATA Request */
     1614     9659    2               OSIPARM.SHDR$ = ADDR( GLUE.DATA);

   9659  1 000073   300001 635500                    EPPR5   1,,PR3
         1 000074   200044 455500                    STP5    OSIPARM+18,,AUTO

PL6.E3A0      #008=KIS$OSI_SEND File=KIS$OSI.:E05TSI                             WED 07/30/97 00:44 Page:270  
     1615     9660    2               OSIPARM.SHDRSZ = K$RWPARM.MSGSZ - 4;

   9660  1 000075   000001 235100                    LDA     1,,PR0
         1 000076   000004 135007                    SBLA    4,DL
         1 000077   200045 755100                    STA     OSIPARM+19,,AUTO

     1616     9661    2           END;

     1617     9662            /* determine which Transport connection */
     1618     9663    1       OSIPARM.TCTX# = MINOR$->APPL.TCTX;

   9663  1 000100   400000 220100                    LDX0    0,,PR4
         1 000101   200055 740100                    STX0    OSIPARM+27,,AUTO

     1619     9664            /* send the message on to Transport */
     1620     9665            %LOCK( G=NK$LDCT.LOCK);

   9666  1 000102   200003 236100                    LDQ     @NK$LDCT,,AUTO
         1 000103   000020 036003                    ADLQ    16,DU
         1 000104   200076 756100                    STQ     SCID+1,,AUTO
         1 000105   200076 630500                    EPPR0   SCID+1,,AUTO
         1 000106   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 000107   000000 701000 xent               TSX1    HFC$LOCK
         1 000110   000000 011000                    NOP     0

     1621     9668    1   TRYSEND:
     1622     9669    1       CALL KIT$SEND( OSIPARM)

   9669  1 000111   200022 630500       TRYSEND      EPPR0   OSIPARM,,AUTO
         1 000112   200076 450500                    STP0    SCID+1,,AUTO
         1 000113   200076 630500                    EPPR0   SCID+1,,AUTO
         1 000114   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 000115   000000 701000 xent               TSX1    KIT$SEND
         1 000116   000140 702000 1                  TSX2    s:9679

     1623     9670    2       WHENRETURN DO;

PL6.E3A0      #008=KIS$OSI_SEND File=KIS$OSI.:E05TSI                             WED 07/30/97 00:44 Page:271  
     1624     9671                %UNLOCK( G=NK$LDCT.LOCK);

   9672  1 000117   200003 236100                    LDQ     @NK$LDCT,,AUTO
         1 000120   000020 036003                    ADLQ    16,DU
         1 000121   200076 756100                    STQ     SCID+1,,AUTO
         1 000122   200076 630500                    EPPR0   SCID+1,,AUTO
         1 000123   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 000124   000000 701000 xent               TSX1    HFC$UNLOCK
         1 000125   000000 011000                    NOP     0

     1625     9674    2           IF GLUE.TRNFNC = %K_TDISCONNECT_REQ THEN

   9674  1 000126   200004 470500                    LDP0    @K$RWPARM,,AUTO
         1 000127   000000 471500                    LDP1    0,,PR0
         1 000130   100000 236100                    LDQ     0,,PR1
         1 000131   000777 376003                    ANQ     511,DU
         1 000132   000031 116003                    CMPQ    25,DU
         1 000133   000137 601000 1                  TNZ     s:9676

     1626     9675    2               MINOR$->APPL.TCTX = 0;  /* successful disconnect */

   9675  1 000134   000000 220003                    LDX0    0,DU
         1 000135   200074 473500                    LDP3    MINOR$,,AUTO
         1 000136   300000 740100                    STX0    0,,PR3

     1627     9676    2           END;

   9676  1 000137   000175 710000 1                  TRA     s:9696

     1628     9677    2       WHENALTRETURN DO;

     1629     9678                /* Transport has filled in OSIPARM.ERR */
     1630     9679    3           IF OSIPARM.ERR = %K$QFULL THEN DO;

   9679  1 000140   200035 235100                    LDA     OSIPARM+11,,AUTO
         1 000141   000001 115007                    CMPA    1,DL
         1 000142   000161 601000 1                  TNZ     s:9690
PL6.E3A0      #008=KIS$OSI_SEND File=KIS$OSI.:E05TSI                             WED 07/30/97 00:44 Page:272  

     1631     9680    3               CALL KIA$OQFL( NK$LDCT)

   9680  1 000143   200003 630500                    EPPR0   @NK$LDCT,,AUTO
         1 000144   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 000145   000000 701000 xent               TSX1    KIA$OQFL
         1 000146   000150 702000 1                  TSX2    s:9683
         1 000147   000160 710000 1                  TRA     s:9687

     1632     9681    4               WHENALTRETURN DO;

     1633     9682                        %UNLOCK( G=NK$LDCT.LOCK);

   9683  1 000150   200003 236100                    LDQ     @NK$LDCT,,AUTO
         1 000151   000020 036003                    ADLQ    16,DU
         1 000152   200076 756100                    STQ     SCID+1,,AUTO
         1 000153   200076 630500                    EPPR0   SCID+1,,AUTO
         1 000154   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 000155   000000 701000 xent               TSX1    HFC$UNLOCK
         1 000156   000000 011000                    NOP     0

     1634     9685    4                   GOTO SNAP;

   9685  1 000157   000173 710000 1                  TRA     SNAP

     1635     9686    4                   END;
     1636     9687    3               GOTO TRYSEND;

   9687  1 000160   000111 710000 1                  TRA     TRYSEND

     1637     9688    3               END;
     1638     9689                %UNLOCK( G=NK$LDCT.LOCK);

   9690  1 000161   200003 236100                    LDQ     @NK$LDCT,,AUTO
         1 000162   000020 036003                    ADLQ    16,DU
         1 000163   200076 756100                    STQ     SCID+1,,AUTO
         1 000164   200076 630500                    EPPR0   SCID+1,,AUTO
PL6.E3A0      #008=KIS$OSI_SEND File=KIS$OSI.:E05TSI                             WED 07/30/97 00:44 Page:273  
         1 000165   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 000166   000000 701000 xent               TSX1    HFC$UNLOCK
         1 000167   000000 011000                    NOP     0

     1639     9692    2           IF OSIPARM.ERR ~= %K$USER_ERR THEN

   9692  1 000170   200035 235100                    LDA     OSIPARM+11,,AUTO
         1 000171   000010 115007                    CMPA    8,DL
         1 000172   000175 600000 1                  TZE     s:9696

     1640     9693    2   SNAP:
     1641     9694    2               CALL SC_PRTCL_SNAP;

   9694  1 000173   000000 713400 xsym  SNAP         CLIMB   SC_PRTCL_SNAP
         1 000174   000000 600000 xsid               climb   nvectors=         0

     1642     9695    2           END;

     1643     9696    2       IF OSIPARM.ERR ~= 0 THEN DO;

   9696  1 000175   200035 235100                    LDA     OSIPARM+11,,AUTO
         1 000176   000255 600000 1                  TZE     s:9714

     1644     9697                /* must have been Transport-reported error */
     1645     9698                /* This will be given to the Session library as a no-wait
     1646     9699                   read event.  We don't care about decrementing Transport
     1647     9700                   credits because the event will abort the application. */
     1648     9701    2           NWIO = '0'B;

   9701  1 000177   000100 100400                    MLR     fill='000'O
         1 000200   000002 000001 xsym               ADSC9   B_VECTNIL+2              cn=0,n=1
         1 000201   200005 000064                    ADSC9   NWIO,,AUTO               cn=0,n=52

     1649     9702    2           NWIO.P# = SIZEW( NWIO) - SIZEW( NWIO.P#);

   9702  1 000202   000014 236007                    LDQ     12,DL
         1 000203   200005 756100                    STQ     NWIO,,AUTO
PL6.E3A0      #008=KIS$OSI_SEND File=KIS$OSI.:E05TSI                             WED 07/30/97 00:44 Page:274  

     1650     9703    2           NWIO.TYC = %TYC_LAST;

   9703  1 000204   000017 236000 xsym               LDQ     B_VECTNIL+15
         1 000205   200006 756100                    STQ     NWIO+1,,AUTO

     1651     9704    2           IF OSIPARM.ERR = %K$USER_ERR THEN

   9704  1 000206   000010 115007                    CMPA    8,DL
         1 000207   000213 601000 1                  TNZ     s:9707

     1652     9705    2               NWIO.IOERRCODE = OSIPARM.MSG_ERRCODE;

   9705  1 000210   200061 236100                    LDQ     OSIPARM+31,,AUTO
         1 000211   200021 756100                    STQ     NWIO+12,,AUTO
         1 000212   000214 710000 1                  TRA     s:9708

     1653     9706    2           ELSE
     1654     9707    2               NWIO.IOERRCODE = '0'B;

   9707  1 000213   200021 450100                    STZ     NWIO+12,,AUTO

     1655     9708    2           CALL SSV$EVENT( MAJOR$->APPL.Z.USER, %USERWSR, %SUBC_IO#,

   9708  1 000214   200074 470500                    LDP0    MINOR$,,AUTO
         1 000215   000000 236100                    LDQ     0,,PR0
         1 000216   000011 772000                    QRL     9
         1 000217   000777 376007                    ANQ     511,DL
         1 000220   000000 036000 2                  ADLQ    0
         1 000221   200076 756100                    STQ     SCID+1,,AUTO
         1 000222   200005 631500                    EPPR1   NWIO,,AUTO
         1 000223   200077 451500                    STP1    SCID+2,,AUTO
         1 000224   200077 633500                    EPPR3   SCID+2,,AUTO
         1 000225   200105 453500                    STP3    SCID+8,,AUTO
         1 000226   200035 634500                    EPPR4   OSIPARM+11,,AUTO
         1 000227   200104 454500                    STP4    SCID+7,,AUTO
         1 000230   200076 635500                    EPPR5   SCID+1,,AUTO
PL6.E3A0      #008=KIS$OSI_SEND File=KIS$OSI.:E05TSI                             WED 07/30/97 00:44 Page:275  
         1 000231   200103 455500                    STP5    SCID+6,,AUTO
         1 000232   000001 236000 2                  LDQ     1
         1 000233   200102 756100                    STQ     SCID+5,,AUTO
         1 000234   000002 236000 2                  LDQ     2
         1 000235   200101 756100                    STQ     SCID+4,,AUTO
         1 000236   200073 236100                    LDQ     MAJOR$,,AUTO
         1 000237   400000 036007                    ADLQ    -131072,DL
         1 000240   200100 756100                    STQ     SCID+3,,AUTO
         1 000241   200100 630500                    EPPR0   SCID+3,,AUTO
         1 000242   000024 631400 xsym               EPPR1   B_VECTNIL+20
         1 000243   000000 701000 xent               TSX1    SSV$EVENT
         1 000244   000000 011000                    NOP     0

     1656     9709    2                   %XSS_EVID*512 + MINOR$->APPL.Z.COOKIE,
     1657     9710    2                   OSIPARM.ERR, ADDR( NWIO));
     1658     9711    2           CALL SSR$RUE( %SS_FPEVNT, MAJOR$->APPL.Z.USER);

   9711  1 000245   200073 236100                    LDQ     MAJOR$,,AUTO
         1 000246   400000 036007                    ADLQ    -131072,DL
         1 000247   000004 235000 2                  LDA     4
         1 000250   200076 757100                    STAQ    SCID+1,,AUTO
         1 000251   200076 630500                    EPPR0   SCID+1,,AUTO
         1 000252   000020 631400 xsym               EPPR1   B_VECTNIL+16
         1 000253   000000 701000 xent               TSX1    SSR$RUE
         1 000254   000000 011000                    NOP     0

     1659     9712    2           END;

     1660     9713            /* now let CG-land reissue the read for us... */
     1661     9714    1       RETURN;

   9714  1 000255   000000 702200 xent               TSX2  ! X66_ARET

(unnamed)
 Sect OctLoc
   2     000   130123 123000   000003 006000   000011 006000   000000 000053    XSS............+
   2     004   000003 006000                                                    ....
PL6.E3A0      #008=KIS$OSI_SEND File=KIS$OSI.:E05TSI                             WED 07/30/97 00:44 Page:276  
     1662     9715
     1663     9716    1       END KIS$OSI_SEND;
     1664     9717        %EOD;

PL6.E3A0      #008=KIS$OSI_SEND File=KIS$OSI.:E05TSI                             WED 07/30/97 00:44 Page:277  
--  Include file information  --

   SS_SCHED_C.:E05TOU  is referenced.
   NK$LDCT.:E05TOU  is referenced.
   NK_SUBS.:E05TOU  is referenced.
   K_SUBS_C.:E05TOU  is referenced.
   K$RWPARM.:E05TOU  is referenced.
   K_DATA_R.:E05TOU  cannot be made into a system file and is referenced.
   K_SESSION_M.:E05TOU  is referenced.
   K_INTERFACE_M.:E05TOU  is referenced.
   K_ADDRESS_M.:E05TOU  is referenced.
   HF_LOCK_C.:E05TOU  cannot be made into a system file and is referenced.
   CP_6_SUBS.:E05TOU  is referenced.
   CP_6_C.:E05TOU  is referenced.
   CP_6.:E05TOU  cannot be made into a system file and is referenced.
   B_STRINGS_C.:E05TOU  is referenced.
      No diagnostics issued in procedure KIS$OSI_SEND.
PL6.E3A0      #008=KIS$OSI_SEND File=KIS$OSI.:E05TSI                             WED 07/30/97 00:44 Page:278  

 **** Variables and constants ****

  ****  Auto variables  ****

  ****  Scalars and arrays  ****
OctLoc.c.b A Datatyp(siz) R M Lvl/name                 OctLoc.c.b A Datatyp(siz) R M Lvl/name

     4-0-0/w PTR         r     1 @K$RWPARM                  3-0-0/w PTR         r     1 @NK$LDCT
    72-0-0/w UBIN        r     1 I                         *0-0-0/d STRC(1404)  r     1 K$RWPARM
    73-0-0/w PTR         r     1 MAJOR$                    74-0-0/w PTR         r     1 MINOR$
    *0-0-0/d STRC(864)   r     1 NK$LDCT                    5-0-0/w STRC(468)   r     1 NWIO
    22-0-0/d STRC(1404)  r     1 OSIPARM                   75-0-0/w SBIN        r     1 SCID

  ****  SYMREF variables  ****

  ****  Scalars and arrays  ****
OctLoc.c.b A Datatyp(siz) R M Lvl/name                 OctLoc.c.b A Datatyp(siz) R M Lvl/name

     0-0-0/w PTR         r     1 KIS_MAJOR$                 0-0-0/w PTR         r     1 KIS_MINOR$
     0-0-0/d STRC(1404)  r     1 K_RWPARM_CON

  ****  BASED and DCB variables  ****

  ****  Scalars and arrays  ****
OctLoc.c.b A Datatyp(siz) R M Lvl/name                 OctLoc.c.b A Datatyp(siz) R M Lvl/name

     0-0-0/w STRC(360)   r     1 APPL                       0-0-0/w STRC(72)    r     1 GLUE
     0-0-0/w STRC(1260)  r     1 K$FPT_CONNECT_OSI


   Procedure KIS$OSI_SEND requires 174 words for executable code.
   Procedure KIS$OSI_SEND requires 70 words of local(AUTO) storage.
PL6.E3A0      #008=KIS$OSI_SEND File=KIS$OSI.:E05TSI                             WED 07/30/97 00:44 Page:279  
          *** CROSS REFERENCE LISTING ***
**     DENOTES     IDENTIFIER DEFINITION
<<                 IDENTIFIER'S VALUE SET
>>                 IDENTIFIER'S VALUE USED
<>                 IDENTIFIER SET AND/OR USED
--                 IDENTIFIER REFERENCED
PL6.E3A0      #008=KIS$OSI_SEND File=KIS$OSI.:E05TSI                             WED 07/30/97 00:44 Page:280  
          MINI XREF LISTING

APPL.CLNTHD
      7765**DCL      7766--REDEF
APPL.TCTX
      7762**DCL      7763--REDEF    7764--REDEF    9663>>ASSIGN   9675<<ASSIGN
APPL.Z.COOKIE
      7767**DCL      7768--REDEF    9644<<ASSIGN   9708>>CALL
APPL.Z.USER
      7768**DCL      9708<>CALL     9711<>CALL
GLUE.DATA
      7835**DCL      9651--ASSIGN   9655--ASSIGN   9659--ASSIGN
GLUE.MAGIC
      7834**DCL      9641>>ASSIGN
GLUE.MYSCID
      7831**DCL      9644>>ASSIGN
GLUE.TRNFNC
      7832**DCL      9638>>ASSIGN   9645>>DOCASE   9674>>IF
HFC$LOCK
      6398**DCL-ENT  9666--CALL
HFC$UNLOCK
      6398**DCL-ENT  9672--CALL     9683--CALL     9690--CALL
I
      9630**DCL      9641<<ASSIGN   9643>>ASSIGN   9652>>ASSIGN
K$FPT_CONNECT_OSI.DST_NSAP.ADDRESS_N
      7634**DCL      7635--REDEF
K$FPT_CONNECT_OSI.SCID
      7438**DCL      9652<<ASSIGN
K$FPT_CONNECT_OSI.SRC_NSAP.ADDRESS_N
      7574**DCL      7575--REDEF
K$FPT_CONNECT_OSI.TPDUSIZE
      7337**DCL      7338--REDEF
K$RWPARM
      8569**DCL        28--PROC
PL6.E3A0      #008=KIS$OSI_SEND File=KIS$OSI.:E05TSI                             WED 07/30/97 00:44 Page:281  
K$RWPARM.BLKREC
      8595**DCL      8620--REDEF
K$RWPARM.BLKREC.BLKU#
      8596**DCL      8598--REDEF
K$RWPARM.BLKREC.RECU#
      8608**DCL      8610--REDEF
K$RWPARM.DVE.DVBYTE.VFC
      8635**DCL      8636--REDEF
K$RWPARM.DVE.EOMCHAR
      8643**DCL      8647--REDEF
K$RWPARM.ERR
      8707**DCL      8712--REDEF    9635<<ASSIGN
K$RWPARM.FC
      8671**DCL      8672--REDEF
K$RWPARM.FLDID
      8853**DCL      8854--REDEF
K$RWPARM.FPT$
      8734**DCL      8741--REDEF
K$RWPARM.KEYTYPE
      8860**DCL      8861--REDEF
K$RWPARM.MSG$
      8570**DCL      7824--IMP-PTR  8576--REDEF    9638>>ASSIGN   9641>>ASSIGN   9644>>ASSIGN   9645>>DOCASE
      9651>>ASSIGN   9655>>ASSIGN   9659>>ASSIGN   9674>>IF
K$RWPARM.MSGID
      8682**DCL      8687--REDEF
K$RWPARM.MSGIDXT
      8695**DCL      8699--REDEF
K$RWPARM.MSGSZ
      8577**DCL      9660>>ASSIGN
K$RWPARM.ORG
      8831**DCL      8832--REDEF
K$RWPARM.THDRSZ
      8775**DCL      8779--REDEF
K$RWPARM.VDOFLGS
      8833**DCL      8844--REDEF
KIA$OQFL
PL6.E3A0      #008=KIS$OSI_SEND File=KIS$OSI.:E05TSI                             WED 07/30/97 00:44 Page:282  
      9621**DCL-ENT  9680--CALL
KIS_MAJOR$
      9627**DCL      9642>>ASSIGN
KIS_MINOR$
      9628**DCL      9643>>ASSIGN
KIT$SEND
      9622**DCL-ENT  9669--CALL
K_RWPARM_CON
      8252**DCL      9637>>ASSIGN
K_RWPARM_CON.BLKREC
      8278**DCL      8303--REDEF
K_RWPARM_CON.BLKREC.BLKU#
      8279**DCL      8281--REDEF
K_RWPARM_CON.BLKREC.RECU#
      8291**DCL      8293--REDEF
K_RWPARM_CON.DVE.DVBYTE.VFC
      8318**DCL      8319--REDEF
K_RWPARM_CON.DVE.EOMCHAR
      8326**DCL      8330--REDEF
K_RWPARM_CON.ERR
      8390**DCL      8395--REDEF
K_RWPARM_CON.FC
      8354**DCL      8355--REDEF
K_RWPARM_CON.FLDID
      8536**DCL      8537--REDEF
K_RWPARM_CON.FPT$
      8417**DCL      8424--REDEF
K_RWPARM_CON.KEYTYPE
      8543**DCL      8544--REDEF
K_RWPARM_CON.MSG$
      8253**DCL      8259--REDEF
K_RWPARM_CON.MSGID
      8365**DCL      8370--REDEF
K_RWPARM_CON.MSGIDXT
      8378**DCL      8382--REDEF
K_RWPARM_CON.ORG
PL6.E3A0      #008=KIS$OSI_SEND File=KIS$OSI.:E05TSI                             WED 07/30/97 00:44 Page:283  
      8514**DCL      8515--REDEF
K_RWPARM_CON.THDRSZ
      8458**DCL      8462--REDEF
K_RWPARM_CON.VDOFLGS
      8516**DCL      8527--REDEF
MAJOR$
      9631**DCL      9642<<ASSIGN   9708>>CALL     9711>>CALL
MINOR$
      9632**DCL      9643<<ASSIGN   9644>>ASSIGN   9663>>ASSIGN   9675>>ASSIGN   9708>>CALL
NK$LDCT
      9353**DCL        28--PROC     9680<>CALL
NK$LDCT.DDT$
      9355**DCL      9355--REDEF
NK$LDCT.IOQ$
      9354**DCL      9355--REDEF
NK$LDCT.LDCTX
      9356**DCL      9356--REDEF
NK$LDCT.LKFLG.ABORTED
      9368**DCL      9369--REDEF
NK$LDCT.LOCK
      9381**DCL      9666<>CALL     9672<>CALL     9683<>CALL     9690<>CALL
NK$LDCT.RLCID.LDCTX
      9378**DCL      9378--REDEF
NK$LDCT.STA$
      9374**DCL      9375--REDEF
NK$LDCT.SYMB$
      9353**DCL      9353--REDEF    9353--REDEF    9354--REDEF
NK$LDCT.TH.STR
      9379**DCL      9640>>ASSIGN
NWIO
      6261**DCL      9701<<ASSIGN   9702--ASSIGN   9708--CALL
NWIO.CGPARM.MSGIDXT
      6287**DCL      6290--REDEF
NWIO.IOERRCODE
      6306**DCL      9705<<ASSIGN   9707<<ASSIGN
NWIO.P#
PL6.E3A0      #008=KIS$OSI_SEND File=KIS$OSI.:E05TSI                             WED 07/30/97 00:44 Page:284  
      6263**DCL      9702<<ASSIGN   9702--ASSIGN
NWIO.TYC
      6263**DCL      9703<<ASSIGN
OSIPARM
      8885**DCL      9637<<ASSIGN   9669<>CALL
OSIPARM.BLKREC
      8911**DCL      8936--REDEF
OSIPARM.BLKREC.BLKU#
      8912**DCL      8914--REDEF
OSIPARM.BLKREC.RECU#
      8924**DCL      8926--REDEF
OSIPARM.DVE.DVBYTE.VFC
      8951**DCL      8952--REDEF
OSIPARM.DVE.EOMCHAR
      8959**DCL      8963--REDEF
OSIPARM.ERR
      9023**DCL      9028--REDEF    9679>>IF       9692>>IF       9696>>IF       9704>>IF       9708<>CALL
OSIPARM.FC
      8987**DCL      8988--REDEF
OSIPARM.FLDID
      9169**DCL      9170--REDEF
OSIPARM.FPT$
      9050**DCL      9057--REDEF    9651<<ASSIGN   9652>>ASSIGN   9655<<ASSIGN
OSIPARM.FUNCTION
      9064**DCL      9638<<ASSIGN
OSIPARM.KEYTYPE
      9176**DCL      9177--REDEF
OSIPARM.MSG$
      8886**DCL      8892--REDEF
OSIPARM.MSGID
      8998**DCL      9003--REDEF
OSIPARM.MSGIDXT
      9011**DCL      9015--REDEF
OSIPARM.MSG_ERRCODE
      9146**DCL      9705>>ASSIGN
OSIPARM.ORG
PL6.E3A0      #008=KIS$OSI_SEND File=KIS$OSI.:E05TSI                             WED 07/30/97 00:44 Page:285  
      9147**DCL      9148--REDEF
OSIPARM.SHDR$
      9079**DCL      9659<<ASSIGN
OSIPARM.SHDRSZ
      9083**DCL      9660<<ASSIGN
OSIPARM.SSN_CRDT
      9095**DCL      9648<<ASSIGN
OSIPARM.TCTX#
      9121**DCL      9663<<ASSIGN
OSIPARM.THDRSZ
      9091**DCL      9095--REDEF
OSIPARM.VDOFLGS
      9149**DCL      9160--REDEF
SCID
      9633**DCL      9640<<ASSIGN   9642>>ASSIGN   9652>>ASSIGN
SC_PRTCL_SNAP
      9625**DCL-ENT  9694--CALL
SNAP
      9694**LABEL    9685--GOTO
SSR$RUE
      9623**DCL-ENT  9711--CALL
SSV$EVENT
      9624**DCL-ENT  9708--CALL
TRYSEND
      9669**LABEL    9687--GOTO

PL6.E3A0      #009=KIS$OSI_RECV File=KIS$OSI.:E05TSI                             WED 07/30/97 00:45 Page:286  
     1665        1        /*T***********************************************************/
     1666        2        /*T*                                                         */
     1667        3        /*T* Copyright (c) Bull HN Information Systems Inc., 1997    */
     1668        4        /*T*                                                         */
     1669        5        /*T***********************************************************/
     1670        6        /*F*    NAME:   KIS$OSI_RECV
     1671        7                PURPOSE:  Field incoming message to OSI Session application.
     1672        8        */
     1673        9        /*D*    NAME:   KIS$OSI_RECV
     1674       10                CALL:   CALL KIS$OSI_RECV( K$RWPARM) ALTRET( label);
     1675       11                INPUT:
     1676       12                    K$RWPARM.SHDR$ points at the SPDU.
     1677       13                    K$RWPARM.SHDRSZ says how long the SPDU is.
     1678       14                    K$RWPARM.FUNCTION says what Transport indication/confirm it is.
     1679       15                    K$RWPARM.TCTX$ points to Transport context for this connection.
     1680       16                OUTPUT:
     1681       17                    On successful call,
     1682       18                      TBD.
     1683       19                    On unsuccessful call,
     1684       20                      K$RWPARM.ERR is filled in with the appropriate error,
     1685       21                      ALTRETURN is taken.
     1686       22                DESCRIPTION:
     1687       23                    KIS$OSI_RECV is called at interrupt by the host Transport layer
     1688       24                    when an incoming message has been received.  Incoming messages
     1689       25                    for both clients and servers are handled here.
     1690       26
     1691       27                    The application the message is destined for is identified by the
     1692       28                    major+minor SCID lifted from the Transport context.  The major
     1693       29                    SCID indicates a particular major slot which among other things
     1694       30                    identifies the LDCT for the application.  The RESCOD of this LDCT
     1695       31                    tells whether the message is for a server or a client.
     1696       32
     1697       33                    The Transport function code is inspected to figure out what to
     1698       34                    hand to the application.  If T-DATA or T-EXPEDITED-DATA then we
     1699       35                    just pass the accompanying Session PDU on.  Otherwise, we have
     1700       36                    to construct a Transport FPT and pass it on.  In this case, what's
     1701       37                    passed on is in an AUTO buffer rather than what was given to us
PL6.E3A0      #009=KIS$OSI_RECV File=KIS$OSI.:E05TSI                             WED 07/30/97 00:45 Page:287  
     1702       38                    by Transport.
     1703       39
     1704       40                    If the message is for a server then we just act as though we're
     1705       41                    a FEP-connected terminal station and call KQP$PUT to transfer
     1706       42                    the message from the ICQ into the server comgroup, directed at
     1707       43                    the AU DCB station.
     1708       44
     1709       45                    If the message is for a client, then either he's blocked waiting
     1710       46                    for an incoming message or he isn't (determined by the WAIT flag
     1711       47                    on the last M$READ issued on the NC DCB).  If blocked, we wake
     1712       48                    him up, satisfying his M$READ.  If not blocked, we queue an event
     1713       49                    for him.
     1714       50        */
     1715       51        KIS$OSI_RECV: PROC( K$RWPARM) ALTRET;
     1716       52        %INCLUDE B$USER;
     1717      268        %INCLUDE B_SEGIDS_C;
     1718      807        %INCLUDE B_STRINGS_C;
     1719      936        %INCLUDE CP_6;
     1720     6495            %B$NWIO( NAME=NWIO, STCLASS=AUTO, PARONLY=1);
     1721     6576            %SUB_EXC;
     1722     6623        %INCLUDE CP_6_SUBS;
     1723     7163        %INCLUDE HF_LOCK_C;
     1724     7177        %INCLUDE KI$MHDR;
     1725     7318            %KI$QMHDR;
     1726     7367        %INCLUDE K_ADDRESS_M;
     1727     7870            %K$TSAP( NAME=TSAP, STCLASS=AUTO);
     1728     7905        %INCLUDE K_INTERFACE_M;
     1729     8314            %K$FPT_CONNECT_OSI;
     1730     8651            %K$FPT_CONNECT_OSI( NAME=TCONFPT, STCLASS="BASED( FPT$)");
     1731     8988            %K$FPT_TERM_OSI;
     1732     9206            %K$FPT_TERM_OSI( NAME=TDISFPT, STCLASS="BASED( FPT$)");
     1733     9424        %INCLUDE KI_MACROS_C;
     1734    10032            %KI$TCTX( STCLASS="BASED( K$RWPARM.TCTX$)");
     1735    10590        %INCLUDE KQ_SUBS_C;
     1736    10890        %INCLUDE K_SESSION_M;
     1737    10980            %KIS$APPL( NAME=APPL, STCLASS=BASED);
     1738    11049            %KIS$GLUE( NAME=GLUE, STCLASS="BASED( GLUE$)");
PL6.E3A0      #009=KIS$OSI_RECV File=KIS$OSI.:E05TSI                             WED 07/30/97 00:45 Page:288  
     1739    11079        %INCLUDE K_SUBS_C;
     1740    11112        %INCLUDE K_TRANSPORT_E;
     1741    11437        %INCLUDE K$RWPARM;
     1742    11823            %K$RWPARM( NAME=K$RWPARM, STCLASS="");
     1743    12139            %K$RWPARM( NAME=RWPARM, STCLASS=AUTO);
     1744    12455            %K$RWPARM( NAME=K_RWPARM_CON, STCLASS="SYMREF READONLY");
     1745    12771        %INCLUDE NK_LDCT_R;
     1746    12780        %INCLUDE NK_SUBS;
     1747    12805        %INCLUDE NK$LDCT;
     1748    12907            %NK$LDCT( STCLASS="BASED( LDCT$)");
     1749    12953        %INCLUDE SS_SCHED_C;
     1750    13186        %MACRO F$DCBI( BASED=BASED);
     1751    13187        %INCLUDE F$DCB;
     1752    13236        %MEND;
     1753    13237            %F$DCBI( BASED="BASED( DCB$)");
     1754    13287
     1755    13288    1       DCL KIA$COMP ENTRY(2);
     1756    13289    1       DCL KIT$SEND ENTRY(1) ALTRET;
     1757    13290    1       DCL KQG$CANCEL ENTRY(1) ALTRET;
     1758    13291    1       DCL KQG$GET ENTRY(2) ALTRET;
     1759    13292    1       DCL KQP$PUT ENTRY(2) ALTRET;
     1760    13293    1       DCL SSR$RUE ENTRY(4);
     1761    13294    1       DCL SC_PRTCL_SCREECH ENTRY CONV(2,0);
     1762    13295    1       DCL SC_PRTCL_SNAP ENTRY CONV(2,0);
     1763    13296    1       DCL SC_WRONGLDCT ENTRY CONV(2,0);
     1764    13297
     1765    13298    1       DCL B$USRT$ PTR SYMREF;
     1766    13299    1       DCL KIS_MAJOR$ PTR SYMREF;
     1767    13300    1       DCL KIS_MINOR$ PTR SYMREF;
     1768    13301    1       DCL KIS_OSILOCK BIT(72) SYMREF;
     1769    13302    1       DCL KIS_SSN_MAXMAJOR UBIN SYMREF;
     1770    13303    1       DCL KIS_SSN_MAXMINOR UBIN SYMREF;
     1771    13304    1       DCL KIS_SSN_SERVERS UBIN SYMREF;
     1772    13305    1       DCL K_SC_USER$ PTR SYMREF;
     1773    13306
     1774    13307    1       DCL BYTES CHAR( TSAP.LEN) BASED UNAL;
     1775    13308    1       DCL DCB$ PTR;
PL6.E3A0      #009=KIS$OSI_RECV File=KIS$OSI.:E05TSI                             WED 07/30/97 00:45 Page:289  
     1776    13309    1       DCL FPT$ PTR;
     1777    13310    1       DCL 1 GLUEBUF,
     1778    13311    1            2 * UBIN,
     1779    13312                 %K$FPT_CONNECT_OSI( NAME=*, LVL=2, STCLASS=AUTO);
     1780    13649    1       DCL GLUE$ PTR;
     1781    13650    1       DCL I UBIN;
     1782    13651    1       DCL LDCT$ PTR;
     1783    13652    1       DCL LINK SBIN;
     1784    13653    1       DCL MAJOR$ PTR;
     1785    13654    1       DCL MINOR$ PTR;
     1786    13655    1       DCL PUTERR UBIN;
     1787    13656    1       DCL P$ PTR;
     1788    13657    1       DCL PTR$ PTR;
     1789    13658    1       DCL SAFE CHAR(4) UNAL;
     1790    13659    1       DCL SAFEBYTES CHAR(4) BASED CALIGNED;
     1791    13660    1       DCL SCID SBIN;
     1792    13661    1       DCL SERVERAU CHAR(8) CONSTANT INIT( 'SERVER');
     1793    13662    1       DCL SQUIRRELED BIT(1) ALIGNED;
     1794    13663    1       DCL TEMP SBIN;
     1795    13664    1       DCL UBIN9 UBIN(9) BASED CALIGNED;
     1796    13665    1       DCL UBIN36 UBIN(36) BASED ALIGNED;
     1797    13666    1       DCL USRT$ PTR;
     1798    13667
     1799    13668    2       IF K$RWPARM.FUNCTION = %K_TCONNECT_IND THEN DO;
     1800    13669    2           TSAP = KI$TCTX.SSN.DST_TSAP;
     1801    13670    2           SCID = -1;
     1802    13671                /* Determine which application is being called */
     1803    13672                %LOCK( G=KIS_OSILOCK);
     1804    13675    2           MAJOR$ = PINCRW( KIS_MAJOR$, 1);
     1805    13676    2   MAJOR_LOOP:
     1806    13677    3           DO I = 1 TO KIS_SSN_SERVERS;
     1807    13678    3               IF MAJOR$->APPL.LDCTX ~= 0 THEN
     1808    13679    3                   IF MAJOR$->APPL.TSAP.LEN = TSAP.LEN THEN
     1809    13680    3                       IF ADDR( MAJOR$->APPL.TSAP.TSAP)->BYTES =
     1810    13681    4                               ADDR( TSAP.TSAP)->BYTES THEN DO;
     1811    13682                                /* TSAP matches, so aimed at this application */
     1812    13683    4                           SCID = POFFW( MAJOR$, KIS_MAJOR$);
PL6.E3A0      #009=KIS$OSI_RECV File=KIS$OSI.:E05TSI                             WED 07/30/97 00:45 Page:290  
     1813    13684    4                           EXIT MAJOR_LOOP;
     1814    13685    4                           END;
     1815    13686    3               MAJOR$ = PINCRW( MAJOR$, 10);
     1816    13687    3               END;
     1817    13688    3           IF SCID ~= -1 THEN DO;
     1818    13689    3               TEMP = -1;
     1819    13690                    /* find a free minor server slot for this connection */
     1820    13691    3               PTR$ = MAJOR$;
     1821    13692    3               LINK = MAJOR$->APPL.Z.LINK;
     1822    13693    3   MINOR_LOOP:
     1823    13694    4               DO WHILE( LINK ~= 0);
     1824    13695                        /* see if an unused link on this server's chain can be used */
     1825    13696    4                   PTR$ = PINCRW( KIS_MINOR$, LINK);
     1826    13697    5                   IF PTR$->APPL.TCTX = 0 THEN DO;
     1827    13698    5                       TEMP = LINK;
     1828    13699    5                       MINOR$ = PTR$;
     1829    13700    5                       EXIT MINOR_LOOP;
     1830    13701    5                       END;
     1831    13702    4                   LINK = PTR$->APPL.Z.LINK;
     1832    13703    4                   END;
     1833    13704    4               IF TEMP = -1 THEN DO;
     1834    13705                        /* nope.. have to allocate a new minor server slot */
     1835    13706    4                   LINK = KIS_MINOR$->APPL.Z.LINK;
     1836    13707    5                   IF LINK ~= 0 THEN DO;
     1837    13708                            /* o.k. there is one available */
     1838    13709    5                       MINOR$ = PINCRW( KIS_MINOR$, LINK);
     1839    13710    5                       KIS_MINOR$->APPL.Z.LINK = MINOR$->APPL.Z.LINK;
     1840    13711    5                       TEMP = LINK;
     1841    13712    5                       END;
     1842    13713    4                   END;
     1843    13714    4               IF TEMP ~= -1 THEN DO;
     1844    13715                        /* we found one somewhere... */
     1845    13716    4                   MINOR$->APPL.TCTX = K$RWPARM.TCTX#;
     1846    13717    4                   MINOR$->APPL.Z.LINK = 0;
     1847    13718    4                   IF PTR$ ~= MINOR$ THEN
     1848    13719    4                       PTR$->APPL.Z.LINK = LINK;  /* append to chain */
     1849    13720    4                   END;
PL6.E3A0      #009=KIS$OSI_RECV File=KIS$OSI.:E05TSI                             WED 07/30/97 00:45 Page:291  
     1850    13721    3               END;
     1851    13722                %UNLOCK( G=KIS_OSILOCK);
     1852    13725    3           IF SCID = -1 OR TEMP = -1 THEN DO;
     1853    13726                    /* refuse this connection */
     1854    13727    3               IF SCID = -1 THEN
     1855    13728    3                   K$RWPARM.ERR = %K_REASON_ADDRESS_UNKNOWN;
     1856    13729    3               ELSE
     1857    13730    3                   IF TEMP = -1 THEN
     1858    13731    3                       K$RWPARM.ERR = %K_REASON_CONGESTION;
     1859    13732    3   SEND_DISCONNECT:
     1860    13733    3               K$RWPARM.FUNCTION = %K_TDISCONNECT_REQ;
     1861    13734                    /* have Transport disconnect this guy; no FPT used */
     1862    13735                    /* K$RWPARM.TCTX# still valid */
     1863    13736    3               CALL KIT$SEND( K$RWPARM)
     1864    13737    4               WHENALTRETURN DO;
     1865    13738                        /* Transport has filled in K$RWPARM.ERR */
     1866    13739    4                   CALL SC_PRTCL_SNAP;
     1867    13740    4                   END;
     1868    13741                    /* We're done here */
     1869    13742    3               RETURN;
     1870    13743    3               END;
     1871    13744                /* otherwise, we now have a new minor SCID */
     1872    13745    2           I = TEMP;
     1873    13746    2           END;
     1874    13747    2       ELSE DO;
     1875    13748                /* Not a connect; determine who this msg is destined for */
     1876    13749    2           SCID = KI$TCTX.SSN.SCID / 512;
     1877    13750    3           IF SCID > KIS_SSN_MAXMAJOR THEN DO;
     1878    13751                    /* no way can this be a legal SCID */
     1879    13752    3   SNAP:
     1880    13753    3               CALL SC_PRTCL_SNAP;
     1881    13754    3               RETURN;
     1882    13755    3               END;
     1883    13756    2           MAJOR$ = PINCRW( KIS_MAJOR$, SCID);
     1884    13757    2           I = MOD( KI$TCTX.SSN.SCID, 512);
     1885    13758    3           IF I > KIS_SSN_MAXMINOR THEN DO;
     1886    13759                    /* no way can this be a legal SCID */
PL6.E3A0      #009=KIS$OSI_RECV File=KIS$OSI.:E05TSI                             WED 07/30/97 00:45 Page:292  
     1887    13760    3               GOTO SNAP;
     1888    13761    3               END;
     1889    13762                /* consistency check... */
     1890    13763    2           MINOR$ = PINCRW( KIS_MINOR$, I);
     1891    13764    3           IF MINOR$->APPL.TCTX = 0 THEN DO;
     1892    13765                    /* Session thinks this slot was disconnected */
     1893    13766    3               IF K$RWPARM.FUNCTION = %K_TDISCONNECT_IND THEN
     1894    13767                        /* that's fine.. so does Transport */
     1895    13768    3                   RETURN;
     1896    13769    3               GOTO SNAP;
     1897    13770    3               END;
     1898    13771    2           END;
     1899    13772            /* point at the GLUE and the TFPT/SPDU */
     1900    13773    1       GLUE$ = ADDR( GLUEBUF);
     1901    13774    1       GLUE = '0'B;
     1902    13775    1       GLUE.YRSCID = MINOR$->APPL.Z.COOKIE;
     1903    13776    1       GLUE.MAGIC = I;
     1904    13777    1       GLUE.TRNFNC = K$RWPARM.FUNCTION;
     1905    13778    1       FPT$ = ADDR( GLUE.DATA);
     1906    13779    1       SQUIRRELED = '0'B;
     1907    13780            /* what kind of Transport function is this? */
     1908    13781    2       DO CASE( K$RWPARM.FUNCTION);
     1909    13782    2           CASE( %K_TCONNECT_IND,
     1910    13783    2                 %K_TCONNECT_CFM);
     1911    13784                    /* build FPT_CONNECT_OSI from internal Transport context */
     1912    13785    2               TCONFPT = KI$TCTX.SSN;
     1913    13786                    /* this is the message to give to the application */
     1914    13787    2               K$RWPARM.MSG$ = GLUE$;
     1915    13788    2               K$RWPARM.MSGSZ = 4 + SIZEC( K$FPT_CONNECT_OSI);
     1916    13789    2           CASE( %K_TDISCONNECT_IND);
     1917    13790                    /* build FPT_TERM_OSI from internal Transport tables */
     1918    13791    2               TDISFPT.REASON = K$RWPARM.ERR;
     1919    13792    2               TDISFPT.SRC_TSAP = KI$TCTX.SSN.SRC_TSAP;
     1920    13793    2               TDISFPT.DST_TSAP = KI$TCTX.SSN.DST_TSAP;
     1921    13794                    /* this is the message to give to the application */
     1922    13795    2               K$RWPARM.MSG$ = GLUE$;
     1923    13796    2               K$RWPARM.MSGSZ = 4 + SIZEC( K$FPT_TERM_OSI);
PL6.E3A0      #009=KIS$OSI_RECV File=KIS$OSI.:E05TSI                             WED 07/30/97 00:45 Page:293  
     1924    13797    2           CASE( %K_TDATA_IND,
     1925    13798    2                 %K_TEXPD_DATA_IND);
     1926    13799                    /* Normal data; just pass the SPDU on to the application */
     1927    13800    2               K$RWPARM.MSG$ = PINCRC( K$RWPARM.SHDR$, -4);
     1928    13801    2               K$RWPARM.MSGSZ = 4 + K$RWPARM.SHDRSZ;
     1929    13802                    /* squirrel away the 4 bytes preceding the Session header.. */
     1930    13803    2               SAFE = K$RWPARM.MSG$->SAFEBYTES;
     1931    13804                    /* ..and replace 'em with the glue */
     1932    13805    2               K$RWPARM.MSG$->SAFEBYTES = GLUE$->SAFEBYTES;
     1933    13806    2               SQUIRRELED = '1'B;
     1934    13807    2           CASE( %K_TCREDIT_ACK);
     1935    13808    2               ;  /* nothing to do, here */
     1936    13809    2           CASE( %K_TFLOW_STOP,
     1937    13810    2                 %K_TFLOW_START);
     1938    13811    2               K$RWPARM.MSG$ = GLUE$;
     1939    13812    2               K$RWPARM.MSGSZ = 4;
     1940    13813    2           CASE( ELSE);
     1941    13814    2               CALL SC_PRTCL_SNAP;
     1942    13815    2               RETURN;
     1943    13816    2           END;
     1944    13817            /* from here on, the CQ may have been written on as part of the squirrely
     1945    13818               code above.. so we can't just ALTRETURN if things are fouled up, nor
     1946    13819               can we just RETURN when done.  We have to branch to DONE or GETOUT to
     1947    13820               clean up the CQ before RETURNing or ALTRETURNing, respectively. */
     1948    13821    1       K$RWPARM.SHDR$ = ADDR( NIL);
     1949    13822    1       K$RWPARM.SHDRSZ = 0;
     1950    13823    1       LDCT$ = NK$LDCT$( MAJOR$->APPL.LDCTX);
     1951    13824    2       IF LDCT$ = ADDR( NIL) THEN DO;
     1952    13825                /* something's fouled up.. OSI LDCT has been released, or worse */
     1953    13826    2   WRONGLDCT:
     1954    13827    2           IF SQUIRRELED THEN
     1955    13828                    /* restore squirreled-away bytes */
     1956    13829    2               K$RWPARM.MSG$->SAFEBYTES = SAFE;
     1957    13830                /* save user number of user we want to dump.. */
     1958    13831    2           K_SC_USER$->UBIN9 = MAJOR$->APPL.Z.USER;
     1959    13832                /* ...and screech */
     1960    13833    2           CALL SC_WRONGLDCT;
PL6.E3A0      #009=KIS$OSI_RECV File=KIS$OSI.:E05TSI                             WED 07/30/97 00:45 Page:294  
     1961    13834                /*S*  SCREECH_CODE:  KIS-S$WRONGLDCT
     1962    13835                      TYPE:          Snap
     1963    13836                      MESSAGE:       LDCT for an OSI Server has been lost.
     1964    13837                      REMARKS:  Whenever a message is received by the Host monitor
     1965    13838                                part of an OSI Session connection, a sanity check is
     1966    13839                                performed.  This ensures that both LDCTs allocated
     1967    13840                                when the server started up, are still around and
     1968    13841                                allocated to the user who started the server.
     1969    13842                */
     1970    13843    2            IF K$RWPARM.FUNCTION = %K_TCONNECT_IND THEN GOTO SEND_DISCONNECT;
     1971    13844    2           RETURN;
     1972    13845    2           END;
     1973    13846    1       IF NK$LDCT.USER ~= MAJOR$->APPL.Z.USER THEN
     1974    13847    1           GOTO WRONGLDCT;
     1975    13848            /* now switch based on the RESCOD of the LDCT */
     1976    13849    2       DO CASE( NK$LDCT.RESCOD);
     1977    13850    2           CASE( %NK_OSIDCB);
     1978    13851                    /* This message is destined for a client application */
     1979    13852                    %LOCK( G=NK$LDCT.LOCK);
     1980    13855    3               IF K$RWPARM.FUNCTION = %K_TCREDIT_ACK THEN DO;
     1981    13856    3                   NK$LDCT.LKFLG.WTMRK = '0'B;
     1982    13857                        %UNLOCK( G=NK$LDCT.LOCK);
     1983    13860    3                   CALL SSR$RUE( %SS_CIC, NK$LDCT.USER);
     1984    13861    3                   RETURN;
     1985    13862    3                   END;
     1986    13863    2               IF K$RWPARM.FUNCTION = %K_TFLOW_STOP THEN
     1987    13864    2                   NK$LDCT.LKFLG.OBLK = '1'B;
     1988    13865    3               IF K$RWPARM.FUNCTION = %K_TFLOW_START THEN DO;
     1989    13866    3                   NK$LDCT.LKFLG.OBLK = '0'B;
     1990    13867    3                   USRT$ = ADDR( B$USRT$->B$USER( NK$LDCT.USER));
     1991    13868    3                   IF USRT$->B$U.FLG & %U_SCIO AND
     1992    13869    3                           USRT$->B$U.MISC$ = ADDR( NK$LDCT) AND
     1993    13870    3                           USRT$->B$U.US = %SS_STOB THEN
     1994    13871    3                       CALL SSR$RUE( %SS_CUB, NK$LDCT.USER);
     1995    13872    3                   END;
     1996    13873    3               IF NK$LDCT.LKFLG.NOWAIT THEN DO;
     1997    13874    3                   CALL KIA$COMP( NK$LDCT, K$RWPARM);
PL6.E3A0      #009=KIS$OSI_RECV File=KIS$OSI.:E05TSI                             WED 07/30/97 00:45 Page:295  
     1998    13875                        %UNLOCK( G=NK$LDCT.LOCK);
     1999    13878    3                   GOTO DONE;
     2000    13879    3                   END;
     2001    13880                    %UNLOCK( G=NK$LDCT.LOCK);
     2002    13883                    /* there's no read pending for this message! */
     2003    13884    2               IF K$RWPARM.FUNCTION ~= %K_TDISCONNECT_IND THEN
     2004    13885    2                   CALL SC_PRTCL_SNAP;
     2005    13886    2           CASE( %NK_OSISTA);
     2006    13887                    /* This message is destined for a server application */
     2007    13888    2               LDCT$ = NK$LDCT$( MAJOR$->APPL.AUDCT);  /* get AU DCB STA ptr */
     2008    13889    2               IF LDCT$ = ADDR( NIL) THEN
     2009    13890                        /* unable to locate the AU DCB's LDCT */
     2010    13891    2                   GOTO WRONGLDCT;
     2011    13892    2               IF NK$LDCT.USER ~= MAJOR$->APPL.Z.USER THEN
     2012    13893    2                   GOTO WRONGLDCT;
     2013    13894    2               LDCT$ = NK$LDCT$( MAJOR$->APPL.LDCTX);  /* restore OSI STA ptr */
     2014    13895    2               K$RWPARM.STATION = SERVERAU;
     2015    13896                    /* the following code mimics case KV_VDO_FNC_DAT of KCF$FEIN */
     2016    13897                    /* get ready to stuff the message into the server CG */
     2017    13898    3               IF NK$LDCT.DFLG.PPND THEN DO;
     2018    13899    3                   K$RWPARM.ERR = %K$DEFER_IO;
     2019    13900    3                   GOTO GETOUT;
     2020    13901    3                   END;
     2021    13902                    /* cancel the GET now in progress, if we can */
     2022    13903    2               IF NOT NK$LDCT.LKFLG.OBLK THEN
     2023    13904    2                   CALL KQG$CANCEL( NK$LDCT)
     2024    13905    3                   WHENALTRETURN DO;
     2025    13906                            /* can't cancel because GET is currently being satisfied */
     2026    13907    3                       IF K$RWPARM.FUNCTION = %K_TCONNECT_IND THEN
     2027    13908                                /* forget the minor SCID we just found */
     2028    13909    3                           MINOR$->APPL.TCTX = 0;
     2029    13910                            /* We'll leave this message in CQ and try again later */
     2030    13911    3                       K$RWPARM.ERR = %K$WAIT_READ;
     2031    13912    3                       GOTO GETOUT;
     2032    13913    3                       END;
     2033    13914                    /* stuff the incoming message into the CG */
     2034    13915    2               NK$LDCT.DFLG.PPND = '1'B;
PL6.E3A0      #009=KIS$OSI_RECV File=KIS$OSI.:E05TSI                             WED 07/30/97 00:45 Page:296  
     2035    13916    2               IF K$RWPARM.FUNCTION ~= %K_TDISCONNECT_IND THEN
     2036    13917    2                   NK$LDCT.IPFEI# = K$RWPARM.IP$->KI$QMHDR.FEI#;
     2037    13918    2               NK$LDCT.IP$ = K$RWPARM.IP$;
     2038    13919    2               CALL KQP$PUT( NK$LDCT, K$RWPARM)
     2039    13920    3               WHENRETURN DO;
     2040    13921                        /* Yay... the PUT worked */
     2041    13922    3                   NK$LDCT.IP$ = ADDR( NIL);
     2042    13923    4                   DO INHIBIT;
     2043    13924    4                       NK$LDCT.DFLG.PPND = '0'B;
     2044    13925    4                       NK$LDCT.IP$ = ADDR( NIL);
     2045    13926    4                       END;
     2046    13927    3                   END;
     2047    13928    3               WHENALTRETURN DO;
     2048    13929                        /* Oops.. the PUT failed */
     2049    13930    3                   PUTERR = K$RWPARM.ERR;
     2050    13931    3                   K$RWPARM.ERR = 0;
     2051    13932    4                   DO CASE( PUTERR);
     2052    13933    4                       CASE( %KQPE_NOMBLK#);
     2053    13934    5                           DO INHIBIT;
     2054    13935    5                               NK$LDCT.DFLG.PPND = '0'B;
     2055    13936    5                               NK$LDCT.IP$ = ADDR( NIL);
     2056    13937    5                               END;
     2057    13938    4                           K$RWPARM.ERR = %K$DEFER_IO;
     2058    13939    4                           GOTO GETOUT;
     2059    13940    4                       CASE( %KQPE_NOBUF#);
     2060    13941    4                           K$RWPARM.ERR = %K$WAIT_READ;
     2061    13942    4                           GOTO GETOUT;
     2062    13943    4                       CASE( %KQPE_QFUL#);
     2063    13944    5                           DO INHIBIT;
     2064    13945    5                               NK$LDCT.DFLG.PPND = '0'B;
     2065    13946    5                               NK$LDCT.IP$ = ADDR( NIL);
     2066    13947    5                               END;
     2067    13948                                /*N* This just drops the message on the floor! */
     2068    13949    4                       CASE( ELSE);
     2069    13950                                /* we're in deep yogurt indeed... */
     2070    13951    4                           CALL SC_PRTCL_SCREECH;
     2071    13952    4                       END;
PL6.E3A0      #009=KIS$OSI_RECV File=KIS$OSI.:E05TSI                             WED 07/30/97 00:45 Page:297  
     2072    13953    3                   END;
     2073    13954    2               IF K$RWPARM.FUNCTION = %K_TFLOW_STOP THEN
     2074    13955    2                   NK$LDCT.LKFLG.OBLK = '1'B;
     2075    13956    2               IF K$RWPARM.FUNCTION = %K_TFLOW_START THEN
     2076    13957    2                   NK$LDCT.LKFLG.OBLK = '0'B;
     2077    13958                    /* re-issue the GET */
     2078    13959    3               IF NOT NK$LDCT.LKFLG.OBLK THEN DO;
     2079    13960    3                   RWPARM = K_RWPARM_CON;
     2080    13961    3                   CALL KQG$GET( NK$LDCT, RWPARM)
     2081    13962    4                   WHENALTRETURN DO;
     2082    13963                            /* well geez, this is unexpected */
     2083    13964    4                       CALL SC_PRTCL_SCREECH;
     2084    13965    4                       END;
     2085    13966    3                   END;
     2086    13967    2           CASE( ELSE);
     2087    13968                    /* something's fouled up.. bad RESCOD */
     2088    13969    2               CALL SC_PRTCL_SCREECH;
     2089    13970    2           END;
     2090    13971    1   DONE:
     2091    13972    1       IF K$RWPARM.FUNCTION = %K_TDISCONNECT_IND THEN
     2092    13973                /* we've successfully delivered a T-DISCONNECT Indication,
     2093    13974                   so mark this slot free */
     2094    13975    1           MINOR$->APPL.TCTX = 0;
     2095    13976    1       IF SQUIRRELED THEN
     2096    13977                /* restore squirreled-away bytes */
     2097    13978    1           K$RWPARM.MSG$->SAFEBYTES = SAFE;
     2098    13979    1       RETURN;
     2099    13980    1   GETOUT:
     2100    13981    1       IF SQUIRRELED THEN
     2101    13982                /* restore squirreled-away bytes */
     2102    13983    1           K$RWPARM.MSG$->SAFEBYTES = SAFE;
     2103    13984    1       ALTRETURN;
     2104    13985
     2105    13986    1       END KIS$OSI_RECV;

PL6.E3A0      #009=KIS$OSI_RECV File=KIS$OSI.:E05TSI                             WED 07/30/97 00:45 Page:298  
--  Include file information  --

   F$DCB.:E05TOU  is referenced.
   SS_SCHED_C.:E05TOU  is referenced.
   NK$LDCT.:E05TOU  is referenced.
   NK_SUBS.:E05TOU  is referenced.
   NK_LDCT_R.:E05TOU  cannot be made into a system file and is referenced.
   K$RWPARM.:E05TOU  is referenced.
   K_TRANSPORT_E.:E05TOU  is referenced.
   K_SUBS_C.:E05TOU  is referenced.
   K_SESSION_M.:E05TOU  is referenced.
   KQ_SUBS_C.:E05TOU  is referenced.
   KI_MACROS_C.:E05TOU  is referenced.
   K_INTERFACE_M.:E05TOU  is referenced.
   K_ADDRESS_M.:E05TOU  is referenced.
   KI$MHDR.:E05TOU  is referenced.
   HF_LOCK_C.:E05TOU  cannot be made into a system file and is referenced.
   CP_6_SUBS.:E05TOU  is referenced.
   CP_6_C.:E05TOU  is referenced.
   CP_6.:E05TOU  cannot be made into a system file and is referenced.
   B_STRINGS_C.:E05TOU  is referenced.
   B_SEGIDS_C.:E05TOU  is referenced.
   B$USER.:E05TOU  cannot be made into a system file and is referenced.
      No diagnostics issued in procedure KIS$OSI_RECV.

   Procedure KIS$OSI_RECV requires 565 words for executable code.
   Procedure KIS$OSI_RECV requires 120 words of local(AUTO) storage.

    No errors detected in file KIS$OSI.:E05TSI    .

PL6.E3A0      #009=KIS$OSI_RECV File=KIS$OSI.:E05TSI                             WED 07/30/97 00:45 Page:299  

 Object Unit name= KIS$OSI_RECV                               File name= KIS$OSI.:E05TOU
 UTS= JUL 30 '97 00:45:19.84 WED                              Compiler= PL-6/E31         Sev=      00
 SharedLib= :SHARED_SYSTEM                                    Alt SharedLib=


    ****  Control sections  ****

 Sect   Type Bound  Init  Size OctSiz  Section name(segment info)
    0   DCB   even  none     0      0  M$UC
    1  RoData even  UTS      3      3  KIS$OSI_RECV
    2   Proc  even  none   565   1065  KIS$OSI_RECV
    3  RoData even  none     7      7  KIS$OSI_RECV

    ****  Entry defs  ****

                              Check   Calling
                             calling  sequence
  Sect OctLoc Primary Altret sequence   type   Parms  Name
     2      0   yes    yes     yes      Std        1  KIS$OSI_RECV

  ****  Entry refs  ****

         Check        Calling
        calling       sequence
Altret sequence SRef   type   Args  Name
         yes           Std       1 HFC$LOCK
         yes           Std       1 HFC$UNLOCK
 yes     yes           Std       2 KQG$GET
 yes     yes           Std       1 KIT$SEND
         yes           Std       2 KIA$COMP
 yes     yes           Std       1 KQG$CANCEL
 yes     yes           Std       2 KQP$PUT
         yes           Std       4 SSR$RUE
                       nStd      0 X66_AUTO_1
                       Std       0 B_CONSPOOL_D
                       nStd      0 X66_ARET
                       nStd      0 X66_AALT
PL6.E3A0      #009=KIS$OSI_RECV File=KIS$OSI.:E05TSI                             WED 07/30/97 00:45 Page:300  

  ****  Data refs  ****

  Flags:  r = read only, s = secondary
Flgs Name                             Flgs Name                             Flgs Name
     SC_PRTCL_SNAP                         SC_WRONGLDCT                          SC_PRTCL_SCREECH
     M$UC                             r    K_RWPARM_CON                          N$DCT$$
     B$USRT$                               KIS_MAJOR$                            KIS_MINOR$
     KIS_OSILOCK                           KIS_SSN_MAXMAJOR                      KIS_SSN_MAXMINOR
     KIS_SSN_SERVERS                       K_SC_USER$                            B_VECTNIL

  ****  Segment refs  ****

  Flags:  r = read only, s = secondary
Flgs Name                             Flgs Name                             Flgs Name
     ASLENTSID                             ISSID
PL6.E3A0      #009=KIS$OSI_RECV File=KIS$OSI.:E05TSI                             WED 07/30/97 00:45 Page:301  


     1665        1        /*T***********************************************************/
     1666        2        /*T*                                                         */
     1667        3        /*T* Copyright (c) Bull HN Information Systems Inc., 1997    */
     1668        4        /*T*                                                         */
     1669        5        /*T***********************************************************/
     1670        6        /*F*    NAME:   KIS$OSI_RECV
     1671        7                PURPOSE:  Field incoming message to OSI Session application.
     1672        8        */
     1673        9        /*D*    NAME:   KIS$OSI_RECV
     1674       10                CALL:   CALL KIS$OSI_RECV( K$RWPARM) ALTRET( label);
     1675       11                INPUT:
     1676       12                    K$RWPARM.SHDR$ points at the SPDU.
     1677       13                    K$RWPARM.SHDRSZ says how long the SPDU is.
     1678       14                    K$RWPARM.FUNCTION says what Transport indication/confirm it is.
     1679       15                    K$RWPARM.TCTX$ points to Transport context for this connection.
     1680       16                OUTPUT:
     1681       17                    On successful call,
     1682       18                      TBD.
     1683       19                    On unsuccessful call,
     1684       20                      K$RWPARM.ERR is filled in with the appropriate error,
     1685       21                      ALTRETURN is taken.
     1686       22                DESCRIPTION:
     1687       23                    KIS$OSI_RECV is called at interrupt by the host Transport layer
     1688       24                    when an incoming message has been received.  Incoming messages
     1689       25                    for both clients and servers are handled here.
     1690       26
     1691       27                    The application the message is destined for is identified by the
     1692       28                    major+minor SCID lifted from the Transport context.  The major
     1693       29                    SCID indicates a particular major slot which among other things
     1694       30                    identifies the LDCT for the application.  The RESCOD of this LDCT
     1695       31                    tells whether the message is for a server or a client.
     1696       32
     1697       33                    The Transport function code is inspected to figure out what to
     1698       34                    hand to the application.  If T-DATA or T-EXPEDITED-DATA then we
     1699       35                    just pass the accompanying Session PDU on.  Otherwise, we have
     1700       36                    to construct a Transport FPT and pass it on.  In this case, what's
PL6.E3A0      #009=KIS$OSI_RECV File=KIS$OSI.:E05TSI                             WED 07/30/97 00:45 Page:302  
     1701       37                    passed on is in an AUTO buffer rather than what was given to us
     1702       38                    by Transport.
     1703       39
     1704       40                    If the message is for a server then we just act as though we're
     1705       41                    a FEP-connected terminal station and call KQP$PUT to transfer
     1706       42                    the message from the ICQ into the server comgroup, directed at
     1707       43                    the AU DCB station.
     1708       44
     1709       45                    If the message is for a client, then either he's blocked waiting
     1710       46                    for an incoming message or he isn't (determined by the WAIT flag
     1711       47                    on the last M$READ issued on the NC DCB).  If blocked, we wake
     1712       48                    him up, satisfying his M$READ.  If not blocked, we queue an event
     1713       49                    for him.
     1714       50        */
     1715       51        KIS$OSI_RECV: PROC( K$RWPARM) ALTRET;

     51  2 000000   000000 700200 xent  KIS$OSI_RECV TSX0  ! X66_AUTO_1
         2 000001   000170 000001                    ZERO    120,1

     1716       52        %INCLUDE B$USER;
     1717      268        %INCLUDE B_SEGIDS_C;
     1718      807        %INCLUDE B_STRINGS_C;
     1719      936        %INCLUDE CP_6;
     1720     6495            %B$NWIO( NAME=NWIO, STCLASS=AUTO, PARONLY=1);
     1721     6576            %SUB_EXC;
     1722     6623        %INCLUDE CP_6_SUBS;
     1723     7163        %INCLUDE HF_LOCK_C;
     1724     7177        %INCLUDE KI$MHDR;
     1725     7318            %KI$QMHDR;
     1726     7367        %INCLUDE K_ADDRESS_M;
     1727     7870            %K$TSAP( NAME=TSAP, STCLASS=AUTO);
     1728     7905        %INCLUDE K_INTERFACE_M;
     1729     8314            %K$FPT_CONNECT_OSI;
     1730     8651            %K$FPT_CONNECT_OSI( NAME=TCONFPT, STCLASS="BASED( FPT$)");
     1731     8988            %K$FPT_TERM_OSI;
     1732     9206            %K$FPT_TERM_OSI( NAME=TDISFPT, STCLASS="BASED( FPT$)");
     1733     9424        %INCLUDE KI_MACROS_C;
PL6.E3A0      #009=KIS$OSI_RECV File=KIS$OSI.:E05TSI                             WED 07/30/97 00:45 Page:303  
     1734    10032            %KI$TCTX( STCLASS="BASED( K$RWPARM.TCTX$)");
     1735    10590        %INCLUDE KQ_SUBS_C;
     1736    10890        %INCLUDE K_SESSION_M;
     1737    10980            %KIS$APPL( NAME=APPL, STCLASS=BASED);
     1738    11049            %KIS$GLUE( NAME=GLUE, STCLASS="BASED( GLUE$)");
     1739    11079        %INCLUDE K_SUBS_C;
     1740    11112        %INCLUDE K_TRANSPORT_E;
     1741    11437        %INCLUDE K$RWPARM;
     1742    11823            %K$RWPARM( NAME=K$RWPARM, STCLASS="");
     1743    12139            %K$RWPARM( NAME=RWPARM, STCLASS=AUTO);
     1744    12455            %K$RWPARM( NAME=K_RWPARM_CON, STCLASS="SYMREF READONLY");
     1745    12771        %INCLUDE NK_LDCT_R;
     1746    12780        %INCLUDE NK_SUBS;
     1747    12805        %INCLUDE NK$LDCT;
     1748    12907            %NK$LDCT( STCLASS="BASED( LDCT$)");
     1749    12953        %INCLUDE SS_SCHED_C;
     1750    13186        %MACRO F$DCBI( BASED=BASED);
     1751    13187        %INCLUDE F$DCB;
     1752    13236        %MEND;
     1753    13237            %F$DCBI( BASED="BASED( DCB$)");
     1754    13287
     1755    13288    1       DCL KIA$COMP ENTRY(2);
     1756    13289    1       DCL KIT$SEND ENTRY(1) ALTRET;
     1757    13290    1       DCL KQG$CANCEL ENTRY(1) ALTRET;
     1758    13291    1       DCL KQG$GET ENTRY(2) ALTRET;
     1759    13292    1       DCL KQP$PUT ENTRY(2) ALTRET;
     1760    13293    1       DCL SSR$RUE ENTRY(4);
     1761    13294    1       DCL SC_PRTCL_SCREECH ENTRY CONV(2,0);
     1762    13295    1       DCL SC_PRTCL_SNAP ENTRY CONV(2,0);
     1763    13296    1       DCL SC_WRONGLDCT ENTRY CONV(2,0);
     1764    13297
     1765    13298    1       DCL B$USRT$ PTR SYMREF;
     1766    13299    1       DCL KIS_MAJOR$ PTR SYMREF;
     1767    13300    1       DCL KIS_MINOR$ PTR SYMREF;
     1768    13301    1       DCL KIS_OSILOCK BIT(72) SYMREF;
     1769    13302    1       DCL KIS_SSN_MAXMAJOR UBIN SYMREF;
     1770    13303    1       DCL KIS_SSN_MAXMINOR UBIN SYMREF;
PL6.E3A0      #009=KIS$OSI_RECV File=KIS$OSI.:E05TSI                             WED 07/30/97 00:45 Page:304  
     1771    13304    1       DCL KIS_SSN_SERVERS UBIN SYMREF;
     1772    13305    1       DCL K_SC_USER$ PTR SYMREF;
     1773    13306
     1774    13307    1       DCL BYTES CHAR( TSAP.LEN) BASED UNAL;
     1775    13308    1       DCL DCB$ PTR;
     1776    13309    1       DCL FPT$ PTR;
     1777    13310    1       DCL 1 GLUEBUF,
     1778    13311    1            2 * UBIN,
     1779    13312                 %K$FPT_CONNECT_OSI( NAME=*, LVL=2, STCLASS=AUTO);
     1780    13649    1       DCL GLUE$ PTR;
     1781    13650    1       DCL I UBIN;
     1782    13651    1       DCL LDCT$ PTR;
     1783    13652    1       DCL LINK SBIN;
     1784    13653    1       DCL MAJOR$ PTR;
     1785    13654    1       DCL MINOR$ PTR;
     1786    13655    1       DCL PUTERR UBIN;
     1787    13656    1       DCL P$ PTR;
     1788    13657    1       DCL PTR$ PTR;
     1789    13658    1       DCL SAFE CHAR(4) UNAL;
     1790    13659    1       DCL SAFEBYTES CHAR(4) BASED CALIGNED;
     1791    13660    1       DCL SCID SBIN;
     1792    13661    1       DCL SERVERAU CHAR(8) CONSTANT INIT( 'SERVER');
     1793    13662    1       DCL SQUIRRELED BIT(1) ALIGNED;
     1794    13663    1       DCL TEMP SBIN;
     1795    13664    1       DCL UBIN9 UBIN(9) BASED CALIGNED;
     1796    13665    1       DCL UBIN36 UBIN(36) BASED ALIGNED;
     1797    13666    1       DCL USRT$ PTR;
     1798    13667
     1799    13668    2       IF K$RWPARM.FUNCTION = %K_TCONNECT_IND THEN DO;

  13668  2 000002   200003 470500                    LDP0    @K$RWPARM,,AUTO
         2 000003   000020 235100                    LDA     16,,PR0
         2 000004   000025 115007                    CMPA    21,DL
         2 000005   000217 601000 2                  TNZ     s:13749

     1800    13669    2           TSAP = KI$TCTX.SSN.DST_TSAP;

PL6.E3A0      #009=KIS$OSI_RECV File=KIS$OSI.:E05TSI                             WED 07/30/97 00:45 Page:305  
  13669  2 000006   000017 471500                    LDP1    15,,PR0
         2 000007   000100 100500                    MLR     fill='000'O
         2 000010   100031 000042                    ADSC9   25,,PR1                  cn=0,n=34
         2 000011   200021 000042                    ADSC9   TSAP,,AUTO               cn=0,n=34

     1801    13670    2           SCID = -1;

  13670  2 000012   000001 335007                    LCA     1,DL
         2 000013   200162 755100                    STA     SCID,,AUTO

     1802    13671                /* Determine which application is being called */
     1803    13672                %LOCK( G=KIS_OSILOCK);

  13673  2 000014   000000 630400 3                  EPPR0   0
         2 000015   000017 631400 xsym               EPPR1   B_VECTNIL+15
         2 000016   000000 701000 xent               TSX1    HFC$LOCK
         2 000017   000000 011000                    NOP     0

     1804    13675    2           MAJOR$ = PINCRW( KIS_MAJOR$, 1);

  13675  2 000020   000000 236000 xsym               LDQ     KIS_MAJOR$
         2 000021   000001 036003                    ADLQ    1,DU
         2 000022   200154 756100                    STQ     MAJOR$,,AUTO

     1805    13676    2   MAJOR_LOOP:
     1806    13677    3           DO I = 1 TO KIS_SSN_SERVERS;

  13677  2 000023   000001 235007       MAJOR_LOOP   LDA     1,DL
         2 000024   200151 755100                    STA     I,,AUTO
         2 000025   000057 710000 2                  TRA     s:13687+3

     1807    13678    3               IF MAJOR$->APPL.LDCTX ~= 0 THEN

  13678  2 000026   200154 470500                    LDP0    MAJOR$,,AUTO
         2 000027   000000 220100                    LDX0    0,,PR0
         2 000030   000051 600000 2                  TZE     s:13686

PL6.E3A0      #009=KIS$OSI_RECV File=KIS$OSI.:E05TSI                             WED 07/30/97 00:45 Page:306  
     1808    13679    3                   IF MAJOR$->APPL.TSAP.LEN = TSAP.LEN THEN

  13679  2 000031   000001 221100                    LDX1    1,,PR0
         2 000032   200021 101100                    CMPX1   TSAP,,AUTO
         2 000033   000051 601000 2                  TNZ     s:13686

     1809    13680    3                       IF ADDR( MAJOR$->APPL.TSAP.TSAP)->BYTES =

  13680  2 000034   200021 222100                    LDX2    TSAP,,AUTO
         2 000035   040140 106540                    CMPC    fill='040'O
         2 000036   000001 400012                    ADSC9   1,,PR0                   cn=2,n=*X2
         2 000037   200021 400012                    ADSC9   TSAP,,AUTO               cn=2,n=*X2
         2 000040   000051 601000 2                  TNZ     s:13686

     1810    13681    4                               ADDR( TSAP.TSAP)->BYTES THEN DO;

     1811    13682                                /* TSAP matches, so aimed at this application */
     1812    13683    4                           SCID = POFFW( MAJOR$, KIS_MAJOR$);

  13683  2 000041   000000 235000 xsym               LDA     KIS_MAJOR$
         2 000042   000022 771000                    ARL     18
         2 000043   200166 755100                    STA     USRT$+1,,AUTO
         2 000044   200154 236100                    LDQ     MAJOR$,,AUTO
         2 000045   000022 772000                    QRL     18
         2 000046   200166 136100                    SBLQ    USRT$+1,,AUTO
         2 000047   200162 756100                    STQ     SCID,,AUTO

     1813    13684    4                           EXIT MAJOR_LOOP;

  13684  2 000050   000062 710000 2                  TRA     s:13688

     1814    13685    4                           END;
     1815    13686    3               MAJOR$ = PINCRW( MAJOR$, 10);

  13686  2 000051   200154 236100                    LDQ     MAJOR$,,AUTO
         2 000052   000012 036003                    ADLQ    10,DU
         2 000053   200154 756100                    STQ     MAJOR$,,AUTO
PL6.E3A0      #009=KIS$OSI_RECV File=KIS$OSI.:E05TSI                             WED 07/30/97 00:45 Page:307  

     1816    13687    3               END;

  13687  2 000054   200151 235100                    LDA     I,,AUTO
         2 000055   000001 035007                    ADLA    1,DL
         2 000056   200151 755100                    STA     I,,AUTO
         2 000057   000000 236000 xsym               LDQ     KIS_SSN_SERVERS
         2 000060   200151 116100                    CMPQ    I,,AUTO
         2 000061   000026 603000 2                  TRC     s:13678

     1817    13688    3           IF SCID ~= -1 THEN DO;

  13688  2 000062   200162 235100                    LDA     SCID,,AUTO
         2 000063   000027 115000 xsym               CMPA    B_VECTNIL+23
         2 000064   000154 600000 2                  TZE     s:13723

     1818    13689    3               TEMP = -1;

  13689  2 000065   000001 336007                    LCQ     1,DL
         2 000066   200164 756100                    STQ     TEMP,,AUTO

     1819    13690                    /* find a free minor server slot for this connection */
     1820    13691    3               PTR$ = MAJOR$;

  13691  2 000067   200154 236100                    LDQ     MAJOR$,,AUTO
         2 000070   200160 756100                    STQ     PTR$,,AUTO

     1821    13692    3               LINK = MAJOR$->APPL.Z.LINK;

  13692  2 000071   200154 470500                    LDP0    MAJOR$,,AUTO
         2 000072   000000 236100                    LDQ     0,,PR0
         2 000073   000777 376007                    ANQ     511,DL
         2 000074   200153 756100                    STQ     LINK,,AUTO

     1822    13693    3   MINOR_LOOP:
     1823    13694    4               DO WHILE( LINK ~= 0);

PL6.E3A0      #009=KIS$OSI_RECV File=KIS$OSI.:E05TSI                             WED 07/30/97 00:45 Page:308  
  13694  2 000075   000115 600000 2     MINOR_LOOP   TZE     s:13704

     1824    13695                        /* see if an unused link on this server's chain can be used */
     1825    13696    4                   PTR$ = PINCRW( KIS_MINOR$, LINK);

  13696  2 000076   200153 236100                    LDQ     LINK,,AUTO
         2 000077   000022 736000                    QLS     18
         2 000100   000000 036000 xsym               ADLQ    KIS_MINOR$
         2 000101   200160 756100                    STQ     PTR$,,AUTO

     1826    13697    5                   IF PTR$->APPL.TCTX = 0 THEN DO;

  13697  2 000102   200160 470500                    LDP0    PTR$,,AUTO
         2 000103   000000 220100                    LDX0    0,,PR0
         2 000104   000111 601000 2                  TNZ     s:13702

     1827    13698    5                       TEMP = LINK;

  13698  2 000105   200153 235100                    LDA     LINK,,AUTO
         2 000106   200164 755100                    STA     TEMP,,AUTO

     1828    13699    5                       MINOR$ = PTR$;

  13699  2 000107   200155 756100                    STQ     MINOR$,,AUTO

     1829    13700    5                       EXIT MINOR_LOOP;

  13700  2 000110   000115 710000 2                  TRA     s:13704

     1830    13701    5                       END;
     1831    13702    4                   LINK = PTR$->APPL.Z.LINK;

  13702  2 000111   000000 236100                    LDQ     0,,PR0
         2 000112   000777 376007                    ANQ     511,DL
         2 000113   200153 756100                    STQ     LINK,,AUTO

     1832    13703    4                   END;
PL6.E3A0      #009=KIS$OSI_RECV File=KIS$OSI.:E05TSI                             WED 07/30/97 00:45 Page:309  

  13703  2 000114   000076 601000 2                  TNZ     s:13696

     1833    13704    4               IF TEMP = -1 THEN DO;

  13704  2 000115   200164 235100                    LDA     TEMP,,AUTO
         2 000116   000027 115000 xsym               CMPA    B_VECTNIL+23
         2 000117   000135 601000 2                  TNZ     s:13714

     1834    13705                        /* nope.. have to allocate a new minor server slot */
     1835    13706    4                   LINK = KIS_MINOR$->APPL.Z.LINK;

  13706  2 000120   000000 470400 xsym               LDP0    KIS_MINOR$
         2 000121   000000 236100                    LDQ     0,,PR0
         2 000122   000777 376007                    ANQ     511,DL
         2 000123   200153 756100                    STQ     LINK,,AUTO

     1836    13707    5                   IF LINK ~= 0 THEN DO;

  13707  2 000124   000135 600000 2                  TZE     s:13714

     1837    13708                            /* o.k. there is one available */
     1838    13709    5                       MINOR$ = PINCRW( KIS_MINOR$, LINK);

  13709  2 000125   000022 736000                    QLS     18
         2 000126   000000 036000 xsym               ADLQ    KIS_MINOR$
         2 000127   200155 756100                    STQ     MINOR$,,AUTO

     1839    13710    5                       KIS_MINOR$->APPL.Z.LINK = MINOR$->APPL.Z.LINK;

  13710  2 000130   200155 471500                    LDP1    MINOR$,,AUTO
         2 000131   100000 236100                    LDQ     0,,PR1
         2 000132   000000 552104                    STBQ    0,'04'O,PR0

     1840    13711    5                       TEMP = LINK;

  13711  2 000133   200153 236100                    LDQ     LINK,,AUTO
PL6.E3A0      #009=KIS$OSI_RECV File=KIS$OSI.:E05TSI                             WED 07/30/97 00:45 Page:310  
         2 000134   200164 756100                    STQ     TEMP,,AUTO

     1841    13712    5                       END;

     1842    13713    4                   END;

     1843    13714    4               IF TEMP ~= -1 THEN DO;

  13714  2 000135   200164 235100                    LDA     TEMP,,AUTO
         2 000136   000027 115000 xsym               CMPA    B_VECTNIL+23
         2 000137   000154 600000 2                  TZE     s:13723

     1844    13715                        /* we found one somewhere... */
     1845    13716    4                   MINOR$->APPL.TCTX = K$RWPARM.TCTX#;

  13716  2 000140   200003 470500                    LDP0    @K$RWPARM,,AUTO
         2 000141   000033 220100                    LDX0    27,,PR0
         2 000142   200155 471500                    LDP1    MINOR$,,AUTO
         2 000143   100000 740100                    STX0    0,,PR1

     1846    13717    4                   MINOR$->APPL.Z.LINK = 0;

  13717  2 000144   000000 236003                    LDQ     0,DU
         2 000145   100000 552104                    STBQ    0,'04'O,PR1

     1847    13718    4                   IF PTR$ ~= MINOR$ THEN

  13718  2 000146   200160 236100                    LDQ     PTR$,,AUTO
         2 000147   200155 116100                    CMPQ    MINOR$,,AUTO
         2 000150   000154 600000 2                  TZE     s:13723

     1848    13719    4                       PTR$->APPL.Z.LINK = LINK;  /* append to chain */

  13719  2 000151   200160 473500                    LDP3    PTR$,,AUTO
         2 000152   200153 236100                    LDQ     LINK,,AUTO
         2 000153   300000 552104                    STBQ    0,'04'O,PR3

PL6.E3A0      #009=KIS$OSI_RECV File=KIS$OSI.:E05TSI                             WED 07/30/97 00:45 Page:311  
     1849    13720    4                   END;

     1850    13721    3               END;

     1851    13722                %UNLOCK( G=KIS_OSILOCK);

  13723  2 000154   000000 630400 3                  EPPR0   0
         2 000155   000017 631400 xsym               EPPR1   B_VECTNIL+15
         2 000156   000000 701000 xent               TSX1    HFC$UNLOCK
         2 000157   000000 011000                    NOP     0

     1852    13725    3           IF SCID = -1 OR TEMP = -1 THEN DO;

  13725  2 000160   200162 235100                    LDA     SCID,,AUTO
         2 000161   000027 115000 xsym               CMPA    B_VECTNIL+23
         2 000162   000166 600000 2                  TZE     s:13727
         2 000163   200164 236100                    LDQ     TEMP,,AUTO
         2 000164   000027 116000 xsym               CMPQ    B_VECTNIL+23
         2 000165   000215 601000 2                  TNZ     s:13745

     1853    13726                    /* refuse this connection */
     1854    13727    3               IF SCID = -1 THEN

  13727  2 000166   000027 115000 xsym               CMPA    B_VECTNIL+23
         2 000167   000174 601000 2                  TNZ     s:13730

     1855    13728    3                   K$RWPARM.ERR = %K_REASON_ADDRESS_UNKNOWN;

  13728  2 000170   000003 236007                    LDQ     3,DL
         2 000171   200003 470500                    LDP0    @K$RWPARM,,AUTO
         2 000172   000013 756100                    STQ     11,,PR0
         2 000173   000202 710000 2                  TRA     SEND_DISCONNECT

     1856    13729    3               ELSE
     1857    13730    3                   IF TEMP = -1 THEN

  13730  2 000174   200164 236100                    LDQ     TEMP,,AUTO
PL6.E3A0      #009=KIS$OSI_RECV File=KIS$OSI.:E05TSI                             WED 07/30/97 00:45 Page:312  
         2 000175   000027 116000 xsym               CMPQ    B_VECTNIL+23
         2 000176   000202 601000 2                  TNZ     SEND_DISCONNECT

     1858    13731    3                       K$RWPARM.ERR = %K_REASON_CONGESTION;

  13731  2 000177   000001 235007                    LDA     1,DL
         2 000200   200003 470500                    LDP0    @K$RWPARM,,AUTO
         2 000201   000013 755100                    STA     11,,PR0

     1859    13732    3   SEND_DISCONNECT:
     1860    13733    3               K$RWPARM.FUNCTION = %K_TDISCONNECT_REQ;

  13733  2 000202   000031 235007       SEND_DISCON* LDA     25,DL
         2 000203   200003 470500                    LDP0    @K$RWPARM,,AUTO
         2 000204   000020 755100                    STA     16,,PR0

     1861    13734                    /* have Transport disconnect this guy; no FPT used */
     1862    13735                    /* K$RWPARM.TCTX# still valid */
     1863    13736    3               CALL KIT$SEND( K$RWPARM)

  13736  2 000205   200003 630500                    EPPR0   @K$RWPARM,,AUTO
         2 000206   000017 631400 xsym               EPPR1   B_VECTNIL+15
         2 000207   000000 701000 xent               TSX1    KIT$SEND
         2 000210   000212 702000 2                  TSX2    s:13739
         2 000211   000214 710000 2                  TRA     s:13742

     1864    13737    4               WHENALTRETURN DO;

     1865    13738                        /* Transport has filled in K$RWPARM.ERR */
     1866    13739    4                   CALL SC_PRTCL_SNAP;

  13739  2 000212   000000 713400 xsym               CLIMB   SC_PRTCL_SNAP
         2 000213   000000 600000 xsid               climb   nvectors=         0

     1867    13740    4                   END;

     1868    13741                    /* We're done here */
PL6.E3A0      #009=KIS$OSI_RECV File=KIS$OSI.:E05TSI                             WED 07/30/97 00:45 Page:313  
     1869    13742    3               RETURN;

  13742  2 000214   000000 702200 xent               TSX2  ! X66_ARET

     1870    13743    3               END;
     1871    13744                /* otherwise, we now have a new minor SCID */
     1872    13745    2           I = TEMP;

  13745  2 000215   200151 756100                    STQ     I,,AUTO

     1873    13746    2           END;

  13746  2 000216   000261 710000 2                  TRA     s:13773

     1874    13747    2       ELSE DO;

     1875    13748                /* Not a connect; determine who this msg is destined for */
     1876    13749    2           SCID = KI$TCTX.SSN.SCID / 512;

  13749  2 000217   000017 471500                    LDP1    15,,PR0
         2 000220   100017 236100                    LDQ     15,,PR1
         2 000221   001000 506007                    DIV     512,DL
         2 000222   200162 756100                    STQ     SCID,,AUTO

     1877    13750    3           IF SCID > KIS_SSN_MAXMAJOR THEN DO;

  13750  2 000223   000000 116003                    CMPQ    0,DU
         2 000224   000233 604000 2                  TMI     s:13756
         2 000225   000000 116000 xsym               CMPQ    KIS_SSN_MAXMAJOR
         2 000226   000233 602000 2                  TNC     s:13756
         2 000227   000233 600000 2                  TZE     s:13756

     1878    13751                    /* no way can this be a legal SCID */
     1879    13752    3   SNAP:
     1880    13753    3               CALL SC_PRTCL_SNAP;

  13753  2 000230   000000 713400 xsym  SNAP         CLIMB   SC_PRTCL_SNAP
PL6.E3A0      #009=KIS$OSI_RECV File=KIS$OSI.:E05TSI                             WED 07/30/97 00:45 Page:314  
         2 000231   000000 600000 xsid               climb   nvectors=         0

     1881    13754    3               RETURN;

  13754  2 000232   000000 702200 xent               TSX2  ! X66_ARET

     1882    13755    3               END;
     1883    13756    2           MAJOR$ = PINCRW( KIS_MAJOR$, SCID);

  13756  2 000233   000022 736000                    QLS     18
         2 000234   000000 036000 xsym               ADLQ    KIS_MAJOR$
         2 000235   200154 756100                    STQ     MAJOR$,,AUTO

     1884    13757    2           I = MOD( KI$TCTX.SSN.SCID, 512);

  13757  2 000236   100017 236100                    LDQ     15,,PR1
         2 000237   001000 506007                    DIV     512,DL
         2 000240   200151 755100                    STA     I,,AUTO

     1885    13758    3           IF I > KIS_SSN_MAXMINOR THEN DO;

  13758  2 000241   000000 236000 xsym               LDQ     KIS_SSN_MAXMINOR
         2 000242   200151 116100                    CMPQ    I,,AUTO
         2 000243   000245 603000 2                  TRC     s:13763

     1886    13759                    /* no way can this be a legal SCID */
     1887    13760    3               GOTO SNAP;

  13760  2 000244   000230 710000 2                  TRA     SNAP

     1888    13761    3               END;
     1889    13762                /* consistency check... */
     1890    13763    2           MINOR$ = PINCRW( KIS_MINOR$, I);

  13763  2 000245   200151 236100                    LDQ     I,,AUTO
         2 000246   000022 736000                    QLS     18
         2 000247   000000 036000 xsym               ADLQ    KIS_MINOR$
PL6.E3A0      #009=KIS$OSI_RECV File=KIS$OSI.:E05TSI                             WED 07/30/97 00:45 Page:315  
         2 000250   200155 756100                    STQ     MINOR$,,AUTO

     1891    13764    3           IF MINOR$->APPL.TCTX = 0 THEN DO;

  13764  2 000251   200155 473500                    LDP3    MINOR$,,AUTO
         2 000252   300000 220100                    LDX0    0,,PR3
         2 000253   000261 601000 2                  TNZ     s:13773

     1892    13765                    /* Session thinks this slot was disconnected */
     1893    13766    3               IF K$RWPARM.FUNCTION = %K_TDISCONNECT_IND THEN

  13766  2 000254   000020 235100                    LDA     16,,PR0
         2 000255   000031 115007                    CMPA    25,DL
         2 000256   000260 601000 2                  TNZ     s:13769

     1894    13767                        /* that's fine.. so does Transport */
     1895    13768    3                   RETURN;

  13768  2 000257   000000 702200 xent               TSX2  ! X66_ARET

     1896    13769    3               GOTO SNAP;

  13769  2 000260   000230 710000 2                  TRA     SNAP

     1897    13770    3               END;
     1898    13771    2           END;
     1899    13772            /* point at the GLUE and the TFPT/SPDU */
     1900    13773    1       GLUE$ = ADDR( GLUEBUF);

  13773  2 000261   200104 630500                    EPPR0   GLUEBUF,,AUTO
         2 000262   200150 450500                    STP0    GLUE$,,AUTO

     1901    13774    1       GLUE = '0'B;

  13774  2 000263   000000 450100                    STZ     0,,PR0
         2 000264   000001 450100                    STZ     1,,PR0

PL6.E3A0      #009=KIS$OSI_RECV File=KIS$OSI.:E05TSI                             WED 07/30/97 00:45 Page:316  
     1902    13775    1       GLUE.YRSCID = MINOR$->APPL.Z.COOKIE;

  13775  2 000265   200155 471500                    LDP1    MINOR$,,AUTO
         2 000266   100000 236100                    LDQ     0,,PR1
         2 000267   000000 552110                    STBQ    0,'10'O,PR0

     1903    13776    1       GLUE.MAGIC = I;

  13776  2 000270   200151 236100                    LDQ     I,,AUTO
         2 000271   000000 552104                    STBQ    0,'04'O,PR0

     1904    13777    1       GLUE.TRNFNC = K$RWPARM.FUNCTION;

  13777  2 000272   200003 473500                    LDP3    @K$RWPARM,,AUTO
         2 000273   300020 236100                    LDQ     16,,PR3
         2 000274   000022 736000                    QLS     18
         2 000275   000000 552120                    STBQ    0,'20'O,PR0

     1905    13778    1       FPT$ = ADDR( GLUE.DATA);

  13778  2 000276   200150 236100                    LDQ     GLUE$,,AUTO
         2 000277   000001 036003                    ADLQ    1,DU
         2 000300   200103 756100                    STQ     FPT$,,AUTO

     1906    13779    1       SQUIRRELED = '0'B;

  13779  2 000301   200163 450100                    STZ     SQUIRRELED,,AUTO

     1907    13780            /* what kind of Transport function is this? */
     1908    13781    2       DO CASE( K$RWPARM.FUNCTION);

  13781  2 000302   300020 235100                    LDA     16,,PR3
         2 000303   000025 135007                    SBLA    21,DL
         2 000304   000010 115007                    CMPA    8,DL
         2 000305   000307 602005 2                  TNC     s:13781+5,AL
         2 000306   000376 710000 2                  TRA     s:13814
         2 000307   000317 710000 2                  TRA     s:13785
PL6.E3A0      #009=KIS$OSI_RECV File=KIS$OSI.:E05TSI                             WED 07/30/97 00:45 Page:317  
         2 000310   000317 710000 2                  TRA     s:13785
         2 000311   000351 710000 2                  TRA     s:13800
         2 000312   000351 710000 2                  TRA     s:13800
         2 000313   000331 710000 2                  TRA     s:13791
         2 000314   000401 710000 2                  TRA     s:13821
         2 000315   000371 710000 2                  TRA     s:13811
         2 000316   000371 710000 2                  TRA     s:13811

     1909    13782    2           CASE( %K_TCONNECT_IND,

     1910    13783    2                 %K_TCONNECT_CFM);
     1911    13784                    /* build FPT_CONNECT_OSI from internal Transport context */
     1912    13785    2               TCONFPT = KI$TCTX.SSN;

  13785  2 000317   300017 474500                    LDP4    15,,PR3
         2 000320   200103 475500                    LDP5    FPT$,,AUTO
         2 000321   000100 100500                    MLR     fill='000'O
         2 000322   400012 000214                    ADSC9   10,,PR4                  cn=0,n=140
         2 000323   500000 000214                    ADSC9   0,,PR5                   cn=0,n=140

     1913    13786                    /* this is the message to give to the application */
     1914    13787    2               K$RWPARM.MSG$ = GLUE$;

  13787  2 000324   200150 236100                    LDQ     GLUE$,,AUTO
         2 000325   300000 756100                    STQ     0,,PR3

     1915    13788    2               K$RWPARM.MSGSZ = 4 + SIZEC( K$FPT_CONNECT_OSI);

  13788  2 000326   000220 235007                    LDA     144,DL
         2 000327   300001 755100                    STA     1,,PR3
         2 000330   000401 710000 2                  TRA     s:13821

     1916    13789    2           CASE( %K_TDISCONNECT_IND);

     1917    13790                    /* build FPT_TERM_OSI from internal Transport tables */
     1918    13791    2               TDISFPT.REASON = K$RWPARM.ERR;

PL6.E3A0      #009=KIS$OSI_RECV File=KIS$OSI.:E05TSI                             WED 07/30/97 00:45 Page:318  
  13791  2 000331   200103 474500                    LDP4    FPT$,,AUTO
         2 000332   300013 235100                    LDA     11,,PR3
         2 000333   400000 755100                    STA     0,,PR4

     1919    13792    2               TDISFPT.SRC_TSAP = KI$TCTX.SSN.SRC_TSAP;

  13792  2 000334   300017 475500                    LDP5    15,,PR3
         2 000335   000100 100500                    MLR     fill='000'O
         2 000336   500020 000042                    ADSC9   16,,PR5                  cn=0,n=34
         2 000337   400001 000042                    ADSC9   1,,PR4                   cn=0,n=34

     1920    13793    2               TDISFPT.DST_TSAP = KI$TCTX.SSN.DST_TSAP;

  13793  2 000340   300017 475500                    LDP5    15,,PR3
         2 000341   000100 100500                    MLR     fill='000'O
         2 000342   500031 000042                    ADSC9   25,,PR5                  cn=0,n=34
         2 000343   400012 000042                    ADSC9   10,,PR4                  cn=0,n=34

     1921    13794                    /* this is the message to give to the application */
     1922    13795    2               K$RWPARM.MSG$ = GLUE$;

  13795  2 000344   200150 236100                    LDQ     GLUE$,,AUTO
         2 000345   300000 756100                    STQ     0,,PR3

     1923    13796    2               K$RWPARM.MSGSZ = 4 + SIZEC( K$FPT_TERM_OSI);

  13796  2 000346   000174 235007                    LDA     124,DL
         2 000347   300001 755100                    STA     1,,PR3
         2 000350   000401 710000 2                  TRA     s:13821

     1924    13797    2           CASE( %K_TDATA_IND,

     1925    13798    2                 %K_TEXPD_DATA_IND);
     1926    13799                    /* Normal data; just pass the SPDU on to the application */
     1927    13800    2               K$RWPARM.MSG$ = PINCRC( K$RWPARM.SHDR$, -4);

  13800  2 000351   300022 236100                    LDQ     18,,PR3
PL6.E3A0      #009=KIS$OSI_RECV File=KIS$OSI.:E05TSI                             WED 07/30/97 00:45 Page:319  
         2 000352   777777 036003                    ADLQ    -1,DU
         2 000353   300000 756100                    STQ     0,,PR3

     1928    13801    2               K$RWPARM.MSGSZ = 4 + K$RWPARM.SHDRSZ;

  13801  2 000354   300023 235100                    LDA     19,,PR3
         2 000355   000004 035007                    ADLA    4,DL
         2 000356   300001 755100                    STA     1,,PR3

     1929    13802                    /* squirrel away the 4 bytes preceding the Session header.. */
     1930    13803    2               SAFE = K$RWPARM.MSG$->SAFEBYTES;

  13803  2 000357   300000 474500                    LDP4    0,,PR3
         2 000360   040100 100500                    MLR     fill='040'O
         2 000361   400000 000004                    ADSC9   0,,PR4                   cn=0,n=4
         2 000362   200161 000004                    ADSC9   SAFE,,AUTO               cn=0,n=4

     1931    13804                    /* ..and replace 'em with the glue */
     1932    13805    2               K$RWPARM.MSG$->SAFEBYTES = GLUE$->SAFEBYTES;

  13805  2 000363   040100 100500                    MLR     fill='040'O
         2 000364   000000 000004                    ADSC9   0,,PR0                   cn=0,n=4
         2 000365   400000 000004                    ADSC9   0,,PR4                   cn=0,n=4

     1933    13806    2               SQUIRRELED = '1'B;

  13806  2 000366   400000 236003                    LDQ     -131072,DU
         2 000367   200163 756100                    STQ     SQUIRRELED,,AUTO
         2 000370   000401 710000 2                  TRA     s:13821

     1934    13807    2           CASE( %K_TCREDIT_ACK);

     1935    13808    2               ;  /* nothing to do, here */
     1936    13809    2           CASE( %K_TFLOW_STOP,

     1937    13810    2                 %K_TFLOW_START);
     1938    13811    2               K$RWPARM.MSG$ = GLUE$;
PL6.E3A0      #009=KIS$OSI_RECV File=KIS$OSI.:E05TSI                             WED 07/30/97 00:45 Page:320  

  13811  2 000371   200150 236100                    LDQ     GLUE$,,AUTO
         2 000372   300000 756100                    STQ     0,,PR3

     1939    13812    2               K$RWPARM.MSGSZ = 4;

  13812  2 000373   000004 235007                    LDA     4,DL
         2 000374   300001 755100                    STA     1,,PR3
         2 000375   000401 710000 2                  TRA     s:13821

     1940    13813    2           CASE( ELSE);

     1941    13814    2               CALL SC_PRTCL_SNAP;

  13814  2 000376   000000 713400 xsym               CLIMB   SC_PRTCL_SNAP
         2 000377   000000 600000 xsid               climb   nvectors=         0

     1942    13815    2               RETURN;

  13815  2 000400   000000 702200 xent               TSX2  ! X66_ARET

     1943    13816    2           END;

     1944    13817            /* from here on, the CQ may have been written on as part of the squirrely
     1945    13818               code above.. so we can't just ALTRETURN if things are fouled up, nor
     1946    13819               can we just RETURN when done.  We have to branch to DONE or GETOUT to
     1947    13820               clean up the CQ before RETURNing or ALTRETURNing, respectively. */
     1948    13821    1       K$RWPARM.SHDR$ = ADDR( NIL);

  13821  2 000401   000001 236000 xsym               LDQ     B_VECTNIL+1
         2 000402   300022 756100                    STQ     18,,PR3

     1949    13822    1       K$RWPARM.SHDRSZ = 0;

  13822  2 000403   300023 450100                    STZ     19,,PR3

     1950    13823    1       LDCT$ = NK$LDCT$( MAJOR$->APPL.LDCTX);
PL6.E3A0      #009=KIS$OSI_RECV File=KIS$OSI.:E05TSI                             WED 07/30/97 00:45 Page:321  

  13823  2 000404   200154 474500                    LDP4    MAJOR$,,AUTO
         2 000405   400000 220100                    LDX0    0,,PR4
         2 000406   000000 475400 xsym               LDP5    N$DCT$$
         2 000407   500000 236110                    LDQ     0,X0,PR5
         2 000410   200152 756100                    STQ     LDCT$,,AUTO

     1951    13824    2       IF LDCT$ = ADDR( NIL) THEN DO;

  13824  2 000411   000001 116000 xsym               CMPQ    B_VECTNIL+1
         2 000412   000436 601000 2                  TNZ     s:13846

     1952    13825                /* something's fouled up.. OSI LDCT has been released, or worse */
     1953    13826    2   WRONGLDCT:
     1954    13827    2           IF SQUIRRELED THEN

  13827  2 000413   200163 234100       WRONGLDCT    SZN     SQUIRRELED,,AUTO
         2 000414   000422 605000 2                  TPL     s:13831

     1955    13828                    /* restore squirreled-away bytes */
     1956    13829    2               K$RWPARM.MSG$->SAFEBYTES = SAFE;

  13829  2 000415   200003 470500                    LDP0    @K$RWPARM,,AUTO
         2 000416   000000 471500                    LDP1    0,,PR0
         2 000417   040100 100500                    MLR     fill='040'O
         2 000420   200161 000004                    ADSC9   SAFE,,AUTO               cn=0,n=4
         2 000421   100000 000004                    ADSC9   0,,PR1                   cn=0,n=4

     1957    13830                /* save user number of user we want to dump.. */
     1958    13831    2           K_SC_USER$->UBIN9 = MAJOR$->APPL.Z.USER;

  13831  2 000422   200154 470500                    LDP0    MAJOR$,,AUTO
         2 000423   000000 471400 xsym               LDP1    K_SC_USER$
         2 000424   000100 100500                    MLR     fill='000'O
         2 000425   000000 400001                    ADSC9   0,,PR0                   cn=2,n=1
         2 000426   100000 000001                    ADSC9   0,,PR1                   cn=0,n=1

PL6.E3A0      #009=KIS$OSI_RECV File=KIS$OSI.:E05TSI                             WED 07/30/97 00:45 Page:322  
     1959    13832                /* ...and screech */
     1960    13833    2           CALL SC_WRONGLDCT;

  13833  2 000427   000000 713400 xsym               CLIMB   SC_WRONGLDCT
         2 000430   000000 600000 xsid               climb   nvectors=         0

     1961    13834                /*S*  SCREECH_CODE:  KIS-S$WRONGLDCT
     1962    13835                      TYPE:          Snap
     1963    13836                      MESSAGE:       LDCT for an OSI Server has been lost.
     1964    13837                      REMARKS:  Whenever a message is received by the Host monitor
     1965    13838                                part of an OSI Session connection, a sanity check is
     1966    13839                                performed.  This ensures that both LDCTs allocated
     1967    13840                                when the server started up, are still around and
     1968    13841                                allocated to the user who started the server.
     1969    13842                */
     1970    13843    2            IF K$RWPARM.FUNCTION = %K_TCONNECT_IND THEN GOTO SEND_DISCONNECT;

  13843  2 000431   200003 470500                    LDP0    @K$RWPARM,,AUTO
         2 000432   000020 235100                    LDA     16,,PR0
         2 000433   000025 115007                    CMPA    21,DL
         2 000434   000202 600000 2                  TZE     SEND_DISCONNECT

     1971    13844    2           RETURN;

  13844  2 000435   000000 702200 xent               TSX2  ! X66_ARET

     1972    13845    2           END;
     1973    13846    1       IF NK$LDCT.USER ~= MAJOR$->APPL.Z.USER THEN

  13846  2 000436   400000 236100                    LDQ     0,,PR4
         2 000437   000011 772000                    QRL     9
         2 000440   000777 376007                    ANQ     511,DL
         2 000441   200166 756100                    STQ     USRT$+1,,AUTO
         2 000442   200152 476500                    LDP6    LDCT$,,AUTO
         2 000443   600007 236100                    LDQ     7,,PR6
         2 000444   000022 772000                    QRL     18
         2 000445   000777 376007                    ANQ     511,DL
PL6.E3A0      #009=KIS$OSI_RECV File=KIS$OSI.:E05TSI                             WED 07/30/97 00:45 Page:323  
         2 000446   200166 116100                    CMPQ    USRT$+1,,AUTO
         2 000447   000413 601000 2                  TNZ     WRONGLDCT

     1974    13847    1           GOTO WRONGLDCT;
     1975    13848            /* now switch based on the RESCOD of the LDCT */
     1976    13849    2       DO CASE( NK$LDCT.RESCOD);

  13849  2 000450   600006 236100                    LDQ     6,,PR6
         2 000451   000017 376007                    ANQ     15,DL
         2 000452   000014 136007                    SBLQ    12,DL
         2 000453   000002 116007                    CMPQ    2,DL
         2 000454   000456 602006 2                  TNC     s:13849+6,QL
         2 000455   001035 710000 2                  TRA     s:13969
         2 000456   000460 710000 2                  TRA     s:13853
         2 000457   000623 710000 2                  TRA     s:13888

     1977    13850    2           CASE( %NK_OSIDCB);

     1978    13851                    /* This message is destined for a client application */
     1979    13852                    %LOCK( G=NK$LDCT.LOCK);

  13853  2 000460   200152 236100                    LDQ     LDCT$,,AUTO
         2 000461   000020 036003                    ADLQ    16,DU
         2 000462   200166 756100                    STQ     USRT$+1,,AUTO
         2 000463   200166 630500                    EPPR0   USRT$+1,,AUTO
         2 000464   000017 631400 xsym               EPPR1   B_VECTNIL+15
         2 000465   000000 701000 xent               TSX1    HFC$LOCK
         2 000466   000000 011000                    NOP     0

     1980    13855    3               IF K$RWPARM.FUNCTION = %K_TCREDIT_ACK THEN DO;

  13855  2 000467   200003 470500                    LDP0    @K$RWPARM,,AUTO
         2 000470   000020 235100                    LDA     16,,PR0
         2 000471   000032 115007                    CMPA    26,DL
         2 000472   000516 601000 2                  TNZ     s:13863

     1981    13856    3                   NK$LDCT.LKFLG.WTMRK = '0'B;
PL6.E3A0      #009=KIS$OSI_RECV File=KIS$OSI.:E05TSI                             WED 07/30/97 00:45 Page:324  

  13856  2 000473   200152 471500                    LDP1    LDCT$,,AUTO
         2 000474   000001 236000 3                  LDQ     1
         2 000475   100011 356100                    ANSQ    9,,PR1

     1982    13857                        %UNLOCK( G=NK$LDCT.LOCK);

  13858  2 000476   200152 236100                    LDQ     LDCT$,,AUTO
         2 000477   000020 036003                    ADLQ    16,DU
         2 000500   200166 756100                    STQ     USRT$+1,,AUTO
         2 000501   200166 630500                    EPPR0   USRT$+1,,AUTO
         2 000502   000017 631400 xsym               EPPR1   B_VECTNIL+15
         2 000503   000000 701000 xent               TSX1    HFC$UNLOCK
         2 000504   000000 011000                    NOP     0

     1983    13860    3                   CALL SSR$RUE( %SS_CIC, NK$LDCT.USER);

  13860  2 000505   200152 236100                    LDQ     LDCT$,,AUTO
         2 000506   000002 036000 3                  ADLQ    2
         2 000507   000003 235000 3                  LDA     3
         2 000510   200166 757100                    STAQ    USRT$+1,,AUTO
         2 000511   200166 630500                    EPPR0   USRT$+1,,AUTO
         2 000512   000020 631400 xsym               EPPR1   B_VECTNIL+16
         2 000513   000000 701000 xent               TSX1    SSR$RUE
         2 000514   000000 011000                    NOP     0

     1984    13861    3                   RETURN;

  13861  2 000515   000000 702200 xent               TSX2  ! X66_ARET

     1985    13862    3                   END;
     1986    13863    2               IF K$RWPARM.FUNCTION = %K_TFLOW_STOP THEN

  13863  2 000516   000033 115007                    CMPA    27,DL
         2 000517   000523 601000 2                  TNZ     s:13865

     1987    13864    2                   NK$LDCT.LKFLG.OBLK = '1'B;
PL6.E3A0      #009=KIS$OSI_RECV File=KIS$OSI.:E05TSI                             WED 07/30/97 00:45 Page:325  

  13864  2 000520   200152 471500                    LDP1    LDCT$,,AUTO
         2 000521   200000 236003                    LDQ     65536,DU
         2 000522   100011 256100                    ORSQ    9,,PR1

     1988    13865    3               IF K$RWPARM.FUNCTION = %K_TFLOW_START THEN DO;

  13865  2 000523   000020 235100                    LDA     16,,PR0
         2 000524   000034 115007                    CMPA    28,DL
         2 000525   000562 601000 2                  TNZ     s:13873

     1989    13866    3                   NK$LDCT.LKFLG.OBLK = '0'B;

  13866  2 000526   200152 471500                    LDP1    LDCT$,,AUTO
         2 000527   000004 236000 3                  LDQ     4
         2 000530   100011 356100                    ANSQ    9,,PR1

     1990    13867    3                   USRT$ = ADDR( B$USRT$->B$USER( NK$LDCT.USER));

  13867  2 000531   100007 236100                    LDQ     7,,PR1
         2 000532   000016 772000                    QRL     14
         2 000533   017760 376007                    ANQ     8176,DL
         2 000534   000022 736000                    QLS     18
         2 000535   000000 036000 xsym               ADLQ    B$USRT$
         2 000536   200165 756100                    STQ     USRT$,,AUTO

     1991    13868    3                   IF USRT$->B$U.FLG & %U_SCIO AND

  13868  2 000537   200165 473500                    LDP3    USRT$,,AUTO
         2 000540   300000 236100                    LDQ     0,,PR3
         2 000541   000002 376000 1                  ANQ     SERVERAU+2
         2 000542   000562 600000 2                  TZE     s:13873
         2 000543   300017 236100                    LDQ     15,,PR3
         2 000544   200152 116100                    CMPQ    LDCT$,,AUTO
         2 000545   000562 601000 2                  TNZ     s:13873
         2 000546   300011 236100                    LDQ     9,,PR3
         2 000547   770000 376003                    ANQ     -4096,DU
PL6.E3A0      #009=KIS$OSI_RECV File=KIS$OSI.:E05TSI                             WED 07/30/97 00:45 Page:326  
         2 000550   150000 116003                    CMPQ    53248,DU
         2 000551   000562 601000 2                  TNZ     s:13873

     1992    13869    3                           USRT$->B$U.MISC$ = ADDR( NK$LDCT) AND
     1993    13870    3                           USRT$->B$U.US = %SS_STOB THEN
     1994    13871    3                       CALL SSR$RUE( %SS_CUB, NK$LDCT.USER);

  13871  2 000552   200152 236100                    LDQ     LDCT$,,AUTO
         2 000553   000002 036000 3                  ADLQ    2
         2 000554   000005 235000 3                  LDA     5
         2 000555   200166 757100                    STAQ    USRT$+1,,AUTO
         2 000556   200166 630500                    EPPR0   USRT$+1,,AUTO
         2 000557   000020 631400 xsym               EPPR1   B_VECTNIL+16
         2 000560   000000 701000 xent               TSX1    SSR$RUE
         2 000561   000000 011000                    NOP     0

     1995    13872    3                   END;

     1996    13873    3               IF NK$LDCT.LKFLG.NOWAIT THEN DO;

  13873  2 000562   200152 470500                    LDP0    LDCT$,,AUTO
         2 000563   000011 236100                    LDQ     9,,PR0
         2 000564   000001 316003                    CANQ    1,DU
         2 000565   000605 600000 2                  TZE     s:13881

     1997    13874    3                   CALL KIA$COMP( NK$LDCT, K$RWPARM);

  13874  2 000566   200003 236100                    LDQ     @K$RWPARM,,AUTO
         2 000567   200152 235100                    LDA     LDCT$,,AUTO
         2 000570   200166 757100                    STAQ    USRT$+1,,AUTO
         2 000571   200166 630500                    EPPR0   USRT$+1,,AUTO
         2 000572   000020 631400 xsym               EPPR1   B_VECTNIL+16
         2 000573   000000 701000 xent               TSX1    KIA$COMP
         2 000574   000000 011000                    NOP     0

     1998    13875                        %UNLOCK( G=NK$LDCT.LOCK);

PL6.E3A0      #009=KIS$OSI_RECV File=KIS$OSI.:E05TSI                             WED 07/30/97 00:45 Page:327  
  13876  2 000575   200152 236100                    LDQ     LDCT$,,AUTO
         2 000576   000020 036003                    ADLQ    16,DU
         2 000577   200166 756100                    STQ     USRT$+1,,AUTO
         2 000600   200166 630500                    EPPR0   USRT$+1,,AUTO
         2 000601   000017 631400 xsym               EPPR1   B_VECTNIL+15
         2 000602   000000 701000 xent               TSX1    HFC$UNLOCK
         2 000603   000000 011000                    NOP     0

     1999    13878    3                   GOTO DONE;

  13878  2 000604   001037 710000 2                  TRA     DONE

     2000    13879    3                   END;
     2001    13880                    %UNLOCK( G=NK$LDCT.LOCK);

  13881  2 000605   200152 236100                    LDQ     LDCT$,,AUTO
         2 000606   000020 036003                    ADLQ    16,DU
         2 000607   200166 756100                    STQ     USRT$+1,,AUTO
         2 000610   200166 630500                    EPPR0   USRT$+1,,AUTO
         2 000611   000017 631400 xsym               EPPR1   B_VECTNIL+15
         2 000612   000000 701000 xent               TSX1    HFC$UNLOCK
         2 000613   000000 011000                    NOP     0

     2002    13883                    /* there's no read pending for this message! */
     2003    13884    2               IF K$RWPARM.FUNCTION ~= %K_TDISCONNECT_IND THEN

  13884  2 000614   200003 470500                    LDP0    @K$RWPARM,,AUTO
         2 000615   000020 235100                    LDA     16,,PR0
         2 000616   000031 115007                    CMPA    25,DL
         2 000617   001037 600000 2                  TZE     DONE

     2004    13885    2                   CALL SC_PRTCL_SNAP;

  13885  2 000620   000000 713400 xsym               CLIMB   SC_PRTCL_SNAP
         2 000621   000000 600000 xsid               climb   nvectors=         0
         2 000622   001037 710000 2                  TRA     DONE

PL6.E3A0      #009=KIS$OSI_RECV File=KIS$OSI.:E05TSI                             WED 07/30/97 00:45 Page:328  
     2005    13886    2           CASE( %NK_OSISTA);

     2006    13887                    /* This message is destined for a server application */
     2007    13888    2               LDCT$ = NK$LDCT$( MAJOR$->APPL.AUDCT);  /* get AU DCB STA ptr */

  13888  2 000623   400011 720100                    LXL0    9,,PR4
         2 000624   500000 236110                    LDQ     0,X0,PR5
         2 000625   200152 756100                    STQ     LDCT$,,AUTO

     2008    13889    2               IF LDCT$ = ADDR( NIL) THEN

  13889  2 000626   000001 116000 xsym               CMPQ    B_VECTNIL+1
         2 000627   000413 600000 2                  TZE     WRONGLDCT

     2009    13890                        /* unable to locate the AU DCB's LDCT */
     2010    13891    2                   GOTO WRONGLDCT;
     2011    13892    2               IF NK$LDCT.USER ~= MAJOR$->APPL.Z.USER THEN

  13892  2 000630   400000 236100                    LDQ     0,,PR4
         2 000631   000011 772000                    QRL     9
         2 000632   000777 376007                    ANQ     511,DL
         2 000633   200166 756100                    STQ     USRT$+1,,AUTO
         2 000634   200152 476500                    LDP6    LDCT$,,AUTO
         2 000635   600007 236100                    LDQ     7,,PR6
         2 000636   000022 772000                    QRL     18
         2 000637   000777 376007                    ANQ     511,DL
         2 000640   200166 116100                    CMPQ    USRT$+1,,AUTO
         2 000641   000413 601000 2                  TNZ     WRONGLDCT

     2012    13893    2                   GOTO WRONGLDCT;
     2013    13894    2               LDCT$ = NK$LDCT$( MAJOR$->APPL.LDCTX);  /* restore OSI STA ptr */

  13894  2 000642   400000 220100                    LDX0    0,,PR4
         2 000643   500000 236110                    LDQ     0,X0,PR5
         2 000644   200152 756100                    STQ     LDCT$,,AUTO

     2014    13895    2               K$RWPARM.STATION = SERVERAU;
PL6.E3A0      #009=KIS$OSI_RECV File=KIS$OSI.:E05TSI                             WED 07/30/97 00:45 Page:329  

  13895  2 000645   000000 237000 1                  LDAQ    SERVERAU
         2 000646   300002 757100                    STAQ    2,,PR3

     2015    13896                    /* the following code mimics case KV_VDO_FNC_DAT of KCF$FEIN */
     2016    13897                    /* get ready to stuff the message into the server CG */
     2017    13898    3               IF NK$LDCT.DFLG.PPND THEN DO;

  13898  2 000647   200152 476500                    LDP6    LDCT$,,AUTO
         2 000650   600006 236100                    LDQ     6,,PR6
         2 000651   000040 316007                    CANQ    32,DL
         2 000652   000656 600000 2                  TZE     s:13903

     2018    13899    3                   K$RWPARM.ERR = %K$DEFER_IO;

  13899  2 000653   000003 235007                    LDA     3,DL
         2 000654   300013 755100                    STA     11,,PR3

     2019    13900    3                   GOTO GETOUT;

  13900  2 000655   001055 710000 2                  TRA     GETOUT

     2020    13901    3                   END;
     2021    13902                    /* cancel the GET now in progress, if we can */
     2022    13903    2               IF NOT NK$LDCT.LKFLG.OBLK THEN

  13903  2 000656   600011 236100                    LDQ     9,,PR6
         2 000657   200000 316003                    CANQ    65536,DU
         2 000660   000700 601000 2                  TNZ     s:13915

     2023    13904    2                   CALL KQG$CANCEL( NK$LDCT)

  13904  2 000661   200152 630500                    EPPR0   LDCT$,,AUTO
         2 000662   000017 631400 xsym               EPPR1   B_VECTNIL+15
         2 000663   000000 701000 xent               TSX1    KQG$CANCEL
         2 000664   000666 702000 2                  TSX2    s:13907
         2 000665   000700 710000 2                  TRA     s:13915
PL6.E3A0      #009=KIS$OSI_RECV File=KIS$OSI.:E05TSI                             WED 07/30/97 00:45 Page:330  

     2024    13905    3                   WHENALTRETURN DO;

     2025    13906                            /* can't cancel because GET is currently being satisfied */
     2026    13907    3                       IF K$RWPARM.FUNCTION = %K_TCONNECT_IND THEN

  13907  2 000666   200003 470500                    LDP0    @K$RWPARM,,AUTO
         2 000667   000020 235100                    LDA     16,,PR0
         2 000670   000025 115007                    CMPA    21,DL
         2 000671   000675 601000 2                  TNZ     s:13911

     2027    13908                                /* forget the minor SCID we just found */
     2028    13909    3                           MINOR$->APPL.TCTX = 0;

  13909  2 000672   000000 220003                    LDX0    0,DU
         2 000673   200155 471500                    LDP1    MINOR$,,AUTO
         2 000674   100000 740100                    STX0    0,,PR1

     2029    13910                            /* We'll leave this message in CQ and try again later */
     2030    13911    3                       K$RWPARM.ERR = %K$WAIT_READ;

  13911  2 000675   000006 235007                    LDA     6,DL
         2 000676   000013 755100                    STA     11,,PR0

     2031    13912    3                       GOTO GETOUT;

  13912  2 000677   001055 710000 2                  TRA     GETOUT

     2032    13913    3                       END;
     2033    13914                    /* stuff the incoming message into the CG */
     2034    13915    2               NK$LDCT.DFLG.PPND = '1'B;

  13915  2 000700   200152 470500                    LDP0    LDCT$,,AUTO
         2 000701   000040 236007                    LDQ     32,DL
         2 000702   000006 256100                    ORSQ    6,,PR0

     2035    13916    2               IF K$RWPARM.FUNCTION ~= %K_TDISCONNECT_IND THEN
PL6.E3A0      #009=KIS$OSI_RECV File=KIS$OSI.:E05TSI                             WED 07/30/97 00:45 Page:331  

  13916  2 000703   200003 471500                    LDP1    @K$RWPARM,,AUTO
         2 000704   100020 235100                    LDA     16,,PR1
         2 000705   000031 115007                    CMPA    25,DL
         2 000706   000714 600000 2                  TZE     s:13918

     2036    13917    2                   NK$LDCT.IPFEI# = K$RWPARM.IP$->KI$QMHDR.FEI#;

  13917  2 000707   100012 473500                    LDP3    10,,PR1
         2 000710   300000 236100                    LDQ     0,,PR3
         2 000711   377000 376003                    ANQ     130560,DU
         2 000712   000022 772000                    QRL     18
         2 000713   000014 552110                    STBQ    12,'10'O,PR0

     2037    13918    2               NK$LDCT.IP$ = K$RWPARM.IP$;

  13918  2 000714   100012 236100                    LDQ     10,,PR1
         2 000715   000013 756100                    STQ     11,,PR0

     2038    13919    2               CALL KQP$PUT( NK$LDCT, K$RWPARM)

  13919  2 000716   200003 236100                    LDQ     @K$RWPARM,,AUTO
         2 000717   200152 235100                    LDA     LDCT$,,AUTO
         2 000720   200166 757100                    STAQ    USRT$+1,,AUTO
         2 000721   200166 630500                    EPPR0   USRT$+1,,AUTO
         2 000722   000020 631400 xsym               EPPR1   B_VECTNIL+16
         2 000723   000000 701000 xent               TSX1    KQP$PUT
         2 000724   000735 702000 2                  TSX2    s:13930

     2039    13920    3               WHENRETURN DO;

     2040    13921                        /* Yay... the PUT worked */
     2041    13922    3                   NK$LDCT.IP$ = ADDR( NIL);

  13922  2 000725   000001 236000 xsym               LDQ     B_VECTNIL+1
         2 000726   200152 470500                    LDP0    LDCT$,,AUTO
         2 000727   000013 756100                    STQ     11,,PR0
PL6.E3A0      #009=KIS$OSI_RECV File=KIS$OSI.:E05TSI                             WED 07/30/97 00:45 Page:332  

     2042    13923    4                   DO INHIBIT;

     2043    13924    4                       NK$LDCT.DFLG.PPND = '0'B;

  13924  2 000730   000006 236200 3                  LDQ   ! 6
         2 000731   000006 356300                    ANSQ  ! 6,,PR0

     2044    13925    4                       NK$LDCT.IP$ = ADDR( NIL);

  13925  2 000732   000001 236200 xsym               LDQ   ! B_VECTNIL+1
         2 000733   000013 756300                    STQ   ! 11,,PR0

     2045    13926    4                       END;

     2046    13927    3                   END;

  13927  2 000734   000775 710000 2                  TRA     s:13954

     2047    13928    3               WHENALTRETURN DO;

     2048    13929                        /* Oops.. the PUT failed */
     2049    13930    3                   PUTERR = K$RWPARM.ERR;

  13930  2 000735   200003 470500                    LDP0    @K$RWPARM,,AUTO
         2 000736   000013 235100                    LDA     11,,PR0
         2 000737   200156 755100                    STA     PUTERR,,AUTO

     2050    13931    3                   K$RWPARM.ERR = 0;

  13931  2 000740   000013 450100                    STZ     11,,PR0

     2051    13932    4                   DO CASE( PUTERR);

  13932  2 000741   000006 115007                    CMPA    6,DL
         2 000742   000744 602005 2                  TNC     s:13932+3,AL
         2 000743   000773 710000 2                  TRA     s:13951
PL6.E3A0      #009=KIS$OSI_RECV File=KIS$OSI.:E05TSI                             WED 07/30/97 00:45 Page:333  
         2 000744   000773 710000 2                  TRA     s:13951
         2 000745   000752 710000 2                  TRA     s:13935
         2 000746   000762 710000 2                  TRA     s:13941
         2 000747   000773 710000 2                  TRA     s:13951
         2 000750   000773 710000 2                  TRA     s:13951
         2 000751   000765 710000 2                  TRA     s:13945

     2052    13933    4                       CASE( %KQPE_NOMBLK#);

     2053    13934    5                           DO INHIBIT;

     2054    13935    5                               NK$LDCT.DFLG.PPND = '0'B;

  13935  2 000752   200152 471700                    LDP1  ! LDCT$,,AUTO
         2 000753   000006 236200 3                  LDQ   ! 6
         2 000754   100006 356300                    ANSQ  ! 6,,PR1

     2055    13936    5                               NK$LDCT.IP$ = ADDR( NIL);

  13936  2 000755   000001 236200 xsym               LDQ   ! B_VECTNIL+1
         2 000756   100013 756300                    STQ   ! 11,,PR1

     2056    13937    5                               END;

     2057    13938    4                           K$RWPARM.ERR = %K$DEFER_IO;

  13938  2 000757   000003 235007                    LDA     3,DL
         2 000760   000013 755100                    STA     11,,PR0

     2058    13939    4                           GOTO GETOUT;

  13939  2 000761   001055 710000 2                  TRA     GETOUT

     2059    13940    4                       CASE( %KQPE_NOBUF#);

     2060    13941    4                           K$RWPARM.ERR = %K$WAIT_READ;

PL6.E3A0      #009=KIS$OSI_RECV File=KIS$OSI.:E05TSI                             WED 07/30/97 00:45 Page:334  
  13941  2 000762   000006 236007                    LDQ     6,DL
         2 000763   000013 756100                    STQ     11,,PR0

     2061    13942    4                           GOTO GETOUT;

  13942  2 000764   001055 710000 2                  TRA     GETOUT

     2062    13943    4                       CASE( %KQPE_QFUL#);

     2063    13944    5                           DO INHIBIT;

     2064    13945    5                               NK$LDCT.DFLG.PPND = '0'B;

  13945  2 000765   200152 471700                    LDP1  ! LDCT$,,AUTO
         2 000766   000006 236200 3                  LDQ   ! 6
         2 000767   100006 356300                    ANSQ  ! 6,,PR1

     2065    13946    5                               NK$LDCT.IP$ = ADDR( NIL);

  13946  2 000770   000001 236200 xsym               LDQ   ! B_VECTNIL+1
         2 000771   100013 756300                    STQ   ! 11,,PR1

     2066    13947    5                               END;

  13947  2 000772   000775 710000 2                  TRA     s:13954

     2067    13948                                /*N* This just drops the message on the floor! */
     2068    13949    4                       CASE( ELSE);

     2069    13950                                /* we're in deep yogurt indeed... */
     2070    13951    4                           CALL SC_PRTCL_SCREECH;

  13951  2 000773   000000 713400 xsym               CLIMB   SC_PRTCL_SCREECH
         2 000774   000000 600000 xsid               climb   nvectors=         0

     2071    13952    4                       END;

PL6.E3A0      #009=KIS$OSI_RECV File=KIS$OSI.:E05TSI                             WED 07/30/97 00:45 Page:335  
     2072    13953    3                   END;

     2073    13954    2               IF K$RWPARM.FUNCTION = %K_TFLOW_STOP THEN

  13954  2 000775   200003 470500                    LDP0    @K$RWPARM,,AUTO
         2 000776   000020 235100                    LDA     16,,PR0
         2 000777   000033 115007                    CMPA    27,DL
         2 001000   001004 601000 2                  TNZ     s:13956

     2074    13955    2                   NK$LDCT.LKFLG.OBLK = '1'B;

  13955  2 001001   200152 471500                    LDP1    LDCT$,,AUTO
         2 001002   200000 236003                    LDQ     65536,DU
         2 001003   100011 256100                    ORSQ    9,,PR1

     2075    13956    2               IF K$RWPARM.FUNCTION = %K_TFLOW_START THEN

  13956  2 001004   000020 235100                    LDA     16,,PR0
         2 001005   000034 115007                    CMPA    28,DL
         2 001006   001012 601000 2                  TNZ     s:13959

     2076    13957    2                   NK$LDCT.LKFLG.OBLK = '0'B;

  13957  2 001007   200152 471500                    LDP1    LDCT$,,AUTO
         2 001010   000004 236000 3                  LDQ     4
         2 001011   100011 356100                    ANSQ    9,,PR1

     2077    13958                    /* re-issue the GET */
     2078    13959    3               IF NOT NK$LDCT.LKFLG.OBLK THEN DO;

  13959  2 001012   200152 471500                    LDP1    LDCT$,,AUTO
         2 001013   100011 236100                    LDQ     9,,PR1
         2 001014   200000 316003                    CANQ    65536,DU
         2 001015   001037 601000 2                  TNZ     DONE

     2079    13960    3                   RWPARM = K_RWPARM_CON;

PL6.E3A0      #009=KIS$OSI_RECV File=KIS$OSI.:E05TSI                             WED 07/30/97 00:45 Page:336  
  13960  2 001016   000100 100400                    MLR     fill='000'O
         2 001017   000000 000234 xsym               ADSC9   K_RWPARM_CON             cn=0,n=156
         2 001020   200032 000234                    ADSC9   RWPARM,,AUTO             cn=0,n=156

     2080    13961    3                   CALL KQG$GET( NK$LDCT, RWPARM)

  13961  2 001021   200032 633500                    EPPR3   RWPARM,,AUTO
         2 001022   200167 453500                    STP3    USRT$+2,,AUTO
         2 001023   200152 236100                    LDQ     LDCT$,,AUTO
         2 001024   200166 756100                    STQ     USRT$+1,,AUTO
         2 001025   200166 630500                    EPPR0   USRT$+1,,AUTO
         2 001026   000020 631400 xsym               EPPR1   B_VECTNIL+16
         2 001027   000000 701000 xent               TSX1    KQG$GET
         2 001030   001032 702000 2                  TSX2    s:13964
         2 001031   001034 710000 2                  TRA     s:13966

     2081    13962    4                   WHENALTRETURN DO;

     2082    13963                            /* well geez, this is unexpected */
     2083    13964    4                       CALL SC_PRTCL_SCREECH;

  13964  2 001032   000000 713400 xsym               CLIMB   SC_PRTCL_SCREECH
         2 001033   000000 600000 xsid               climb   nvectors=         0

     2084    13965    4                       END;

     2085    13966    3                   END;

  13966  2 001034   001037 710000 2                  TRA     DONE

     2086    13967    2           CASE( ELSE);

     2087    13968                    /* something's fouled up.. bad RESCOD */
     2088    13969    2               CALL SC_PRTCL_SCREECH;

  13969  2 001035   000000 713400 xsym               CLIMB   SC_PRTCL_SCREECH
         2 001036   000000 600000 xsid               climb   nvectors=         0
PL6.E3A0      #009=KIS$OSI_RECV File=KIS$OSI.:E05TSI                             WED 07/30/97 00:45 Page:337  

     2089    13970    2           END;

     2090    13971    1   DONE:
     2091    13972    1       IF K$RWPARM.FUNCTION = %K_TDISCONNECT_IND THEN

  13972  2 001037   200003 470500       DONE         LDP0    @K$RWPARM,,AUTO
         2 001040   000020 235100                    LDA     16,,PR0
         2 001041   000031 115007                    CMPA    25,DL
         2 001042   001046 601000 2                  TNZ     s:13976

     2092    13973                /* we've successfully delivered a T-DISCONNECT Indication,
     2093    13974                   so mark this slot free */
     2094    13975    1           MINOR$->APPL.TCTX = 0;

  13975  2 001043   000000 220003                    LDX0    0,DU
         2 001044   200155 471500                    LDP1    MINOR$,,AUTO
         2 001045   100000 740100                    STX0    0,,PR1

     2095    13976    1       IF SQUIRRELED THEN

  13976  2 001046   200163 234100                    SZN     SQUIRRELED,,AUTO
         2 001047   001054 605000 2                  TPL     s:13979

     2096    13977                /* restore squirreled-away bytes */
     2097    13978    1           K$RWPARM.MSG$->SAFEBYTES = SAFE;

  13978  2 001050   000000 471500                    LDP1    0,,PR0
         2 001051   040100 100500                    MLR     fill='040'O
         2 001052   200161 000004                    ADSC9   SAFE,,AUTO               cn=0,n=4
         2 001053   100000 000004                    ADSC9   0,,PR1                   cn=0,n=4

     2098    13979    1       RETURN;

  13979  2 001054   000000 702200 xent               TSX2  ! X66_ARET

     2099    13980    1   GETOUT:
PL6.E3A0      #009=KIS$OSI_RECV File=KIS$OSI.:E05TSI                             WED 07/30/97 00:45 Page:338  
     2100    13981    1       IF SQUIRRELED THEN

  13981  2 001055   200163 234100       GETOUT       SZN     SQUIRRELED,,AUTO
         2 001056   001064 605000 2                  TPL     s:13984

     2101    13982                /* restore squirreled-away bytes */
     2102    13983    1           K$RWPARM.MSG$->SAFEBYTES = SAFE;

  13983  2 001057   200003 470500                    LDP0    @K$RWPARM,,AUTO
         2 001060   000000 471500                    LDP1    0,,PR0
         2 001061   040100 100500                    MLR     fill='040'O
         2 001062   200161 000004                    ADSC9   SAFE,,AUTO               cn=0,n=4
         2 001063   100000 000004                    ADSC9   0,,PR1                   cn=0,n=4

     2103    13984    1       ALTRETURN;

  13984  2 001064   000000 702200 xent               TSX2  ! X66_AALT

SERVERAU
 Sect OctLoc
   1     000   123105 122126   105122 040040                                    SERVER

(unnamed)
 Sect OctLoc
   1     002   000000 002000                                                    ....

(unnamed)
 Sect OctLoc
   3     000   000000 006000   757777 777777   000007 200000   000007 006000    ................
   3     004   577777 777777   000012 006000   777777 777737                    ............
     2104    13985
     2105    13986    1       END KIS$OSI_RECV;

PL6.E3A0      #009=KIS$OSI_RECV File=KIS$OSI.:E05TSI                             WED 07/30/97 00:45 Page:339  
--  Include file information  --

   F$DCB.:E05TOU  is referenced.
   SS_SCHED_C.:E05TOU  is referenced.
   NK$LDCT.:E05TOU  is referenced.
   NK_SUBS.:E05TOU  is referenced.
   NK_LDCT_R.:E05TOU  cannot be made into a system file and is referenced.
   K$RWPARM.:E05TOU  is referenced.
   K_TRANSPORT_E.:E05TOU  is referenced.
   K_SUBS_C.:E05TOU  is referenced.
   K_SESSION_M.:E05TOU  is referenced.
   KQ_SUBS_C.:E05TOU  is referenced.
   KI_MACROS_C.:E05TOU  is referenced.
   K_INTERFACE_M.:E05TOU  is referenced.
   K_ADDRESS_M.:E05TOU  is referenced.
   KI$MHDR.:E05TOU  is referenced.
   HF_LOCK_C.:E05TOU  cannot be made into a system file and is referenced.
   CP_6_SUBS.:E05TOU  is referenced.
   CP_6_C.:E05TOU  is referenced.
   CP_6.:E05TOU  cannot be made into a system file and is referenced.
   B_STRINGS_C.:E05TOU  is referenced.
   B_SEGIDS_C.:E05TOU  is referenced.
   B$USER.:E05TOU  cannot be made into a system file and is referenced.
      No diagnostics issued in procedure KIS$OSI_RECV.
PL6.E3A0      #009=KIS$OSI_RECV File=KIS$OSI.:E05TSI                             WED 07/30/97 00:45 Page:340  

 **** Variables and constants ****

  ****  Section 001 RoData KIS$OSI_RECV

  ****  Scalars and arrays  ****
OctLoc.c.b A Datatyp(siz) R M Lvl/name                 OctLoc.c.b A Datatyp(siz) R M Lvl/name

     0-0-0/c CHAR(8)     r     1 SERVERAU

  ****  Auto variables  ****

  ****  Scalars and arrays  ****
OctLoc.c.b A Datatyp(siz) R M Lvl/name                 OctLoc.c.b A Datatyp(siz) R M Lvl/name

     3-0-0/w PTR         r     1 @K$RWPARM                102-0-0/w PTR         r     1 DCB$
   103-0-0/w PTR         r     1 FPT$                     150-0-0/w PTR         r     1 GLUE$
   104-0-0/w STRC(1296)  r     1 GLUEBUF                  151-0-0/w UBIN        r     1 I
    *0-0-0/d STRC(1404)  r     1 K$RWPARM                 152-0-0/w PTR         r     1 LDCT$
   153-0-0/w SBIN        r     1 LINK                     154-0-0/w PTR         r     1 MAJOR$
   155-0-0/w PTR         r     1 MINOR$                   160-0-0/w PTR         r     1 PTR$
   156-0-0/w UBIN        r     1 PUTERR                    32-0-0/d STRC(1404)  r     1 RWPARM
   161-0-0/c CHAR(4)     r     1 SAFE                     162-0-0/w SBIN        r     1 SCID
   163-0-0/w BIT         r     1 SQUIRRELED               164-0-0/w SBIN        r     1 TEMP
    21-0-0/w STRC(306)   r     1 TSAP                     165-0-0/w PTR         r     1 USRT$

  ****  SYMREF variables  ****

  ****  Scalars and arrays  ****
OctLoc.c.b A Datatyp(siz) R M Lvl/name                 OctLoc.c.b A Datatyp(siz) R M Lvl/name

     0-0-0/w PTR         r     1 B$USRT$                    0-0-0/w PTR         r     1 KIS_MAJOR$
     0-0-0/w PTR         r     1 KIS_MINOR$                 0-0-0/b BIT (72)    r     1 KIS_OSILOCK
     0-0-0/w UBIN        r     1 KIS_SSN_MAXMAJOR           0-0-0/w UBIN        r     1 KIS_SSN_MAXMINOR
     0-0-0/w UBIN        r     1 KIS_SSN_SERVERS            0-0-0/d STRC(1404)  r     1 K_RWPARM_CON
     0-0-0/w PTR         r     1 K_SC_USER$                 0-0-0/w PTR         r     1 N$DCT$$

  ****  BASED and DCB variables  ****
PL6.E3A0      #009=KIS$OSI_RECV File=KIS$OSI.:E05TSI                             WED 07/30/97 00:45 Page:341  

  ****  Scalars and arrays  ****
OctLoc.c.b A Datatyp(siz) R M Lvl/name                 OctLoc.c.b A Datatyp(siz) R M Lvl/name

     0-0-0/w STRC(360)   r     1 APPL                       0-0-0/d STRC(576)   r     1 B$U
     0-0-0/w STRC(576)   r     1 B$USER(0:0)                0-0-0/c ACHR        r     1 BYTES
     0-0-0/d ASTR(3528)  r     1 F$DCB                      0-0-0/w STRC(72)    r     1 GLUE
     0-0-0/w STRC(1260)  r     1 K$FPT_CONNECT_OSI          0-0-0/w STRC(1080)  r     1 K$FPT_TERM_OSI
     0-0-0/w STRC(144)   r     1 KI$QMHDR                   0-0-0/w STRC(1620)  r     1 KI$TCTX
     0-0-0/d STRC(864)   r     1 NK$LDCT
     0-0-0/w PTR         r     1 NK$LDCT$(0:0)
     0-0-0/c CHAR(4)     r     1 SAFEBYTES                  0-0-0/w STRC(1260)  r     1 TCONFPT
     0-0-0/w STRC(1080)  r     1 TDISFPT                    0-0-0/c UBIN(9)     r     1 UBIN9


   Procedure KIS$OSI_RECV requires 565 words for executable code.
   Procedure KIS$OSI_RECV requires 120 words of local(AUTO) storage.

    No errors detected in file KIS$OSI.:E05TSI    .
PL6.E3A0      #009=KIS$OSI_RECV File=KIS$OSI.:E05TSI                             WED 07/30/97 00:45 Page:342  
          *** CROSS REFERENCE LISTING ***
**     DENOTES     IDENTIFIER DEFINITION
<<                 IDENTIFIER'S VALUE SET
>>                 IDENTIFIER'S VALUE USED
<>                 IDENTIFIER SET AND/OR USED
--                 IDENTIFIER REFERENCED
PL6.E3A0      #009=KIS$OSI_RECV File=KIS$OSI.:E05TSI                             WED 07/30/97 00:45 Page:343  
          MINI XREF LISTING

APPL.AUDCT
     11047**DCL     13888>>ASSIGN
APPL.CLNTHD
     11007**DCL     11008--REDEF
APPL.LDCTX
     11005**DCL     13678>>IF      13823>>ASSIGN  13894>>ASSIGN
APPL.TCTX
     11004**DCL     11005--REDEF   11006--REDEF   13697>>IF      13716<<ASSIGN  13764>>IF      13909<<ASSIGN
     13975<<ASSIGN
APPL.TSAP.LEN
     11032**DCL     13679>>IF
APPL.TSAP.TSAP
     11040**DCL     13680--IF
APPL.Z.COOKIE
     11009**DCL     11010--REDEF   13775>>ASSIGN
APPL.Z.LINK
     11011**DCL     13692>>ASSIGN  13702>>ASSIGN  13706>>ASSIGN  13710<<ASSIGN  13710>>ASSIGN  13717<<ASSIGN
     13719<<ASSIGN
APPL.Z.USER
     11010**DCL     13831>>ASSIGN  13846>>IF      13892>>IF
B$DO.ECCINFO
       203**DCL       204--REDEF
B$U.FLG
        69**DCL     13868>>IF
B$U.MISC
       182**DCL       183--REDEF
B$U.MISC$
       183**DCL     13868>>IF
B$U.US
       169**DCL     13868>>IF
B$USER
       227**DCL     13867--ASSIGN
PL6.E3A0      #009=KIS$OSI_RECV File=KIS$OSI.:E05TSI                             WED 07/30/97 00:45 Page:344  
B$USER.MISC
       258**DCL       259--REDEF
B$USRT$
     13298**DCL     13867>>ASSIGN
BYTES
     13307**DCL     13680>>IF      13680>>IF
DCB$
     13308**DCL     13238--IMP-PTR
DONE
     13972**LABEL   13878--GOTO
F$DCB.ACTPOS
     13263**DCL     13263--REDEF
F$DCB.ARS
     13238**DCL     13238--REDEF
F$DCB.ATTR
     13256**DCL     13257--REDEF
F$DCB.BORROW
     13271**DCL     13271--REDEF   13271--REDEF   13271--REDEF
F$DCB.DCBNAME.L
     13285**DCL     13285--IMP-SIZ
F$DCB.EOMCHAR
     13242**DCL     13242--REDEF
F$DCB.FLDID
     13266**DCL     13266--REDEF
F$DCB.FORM$
     13260**DCL     13260--REDEF
F$DCB.FSECT
     13276**DCL     13276--REDEF
F$DCB.FSN
     13253**DCL     13253--REDEF   13253--REDEF   13254--REDEF
F$DCB.HEADER$
     13259**DCL     13259--REDEF
F$DCB.IXTNSIZE
     13257**DCL     13257--REDEF
F$DCB.LASTSTA$
     13247**DCL     13247--REDEF
PL6.E3A0      #009=KIS$OSI_RECV File=KIS$OSI.:E05TSI                             WED 07/30/97 00:45 Page:345  
F$DCB.LVL
     13272**DCL     13272--REDEF
F$DCB.NAME.C
     13247**DCL     13247--REDEF
F$DCB.NOEOF
     13268**DCL     13268--REDEF
F$DCB.NRECS
     13258**DCL     13258--REDEF
F$DCB.NRECX
     13277**DCL     13277--REDEF
F$DCB.OHDR
     13269**DCL     13269--REDEF
F$DCB.ORG
     13252**DCL     13252--REDEF
F$DCB.PRECNO
     13275**DCL     13275--REDEF
F$DCB.RCSZ
     13280**DCL     13280--REDEF
F$DCB.RES
     13248**DCL     13248--REDEF
F$DCB.SETX
     13260**DCL     13260--REDEF
F$DCB.TAB$
     13259**DCL     13260--REDEF
F$DCB.TDA
     13274**DCL     13274--REDEF
F$DCB.WSN
     13249**DCL     13249--REDEF
FPT$
     13309**DCL      8668--IMP-PTR  9222--IMP-PTR 13778<<ASSIGN  13785>>ASSIGN  13791>>ASSIGN  13792>>ASSIGN
     13793>>ASSIGN
GETOUT
     13981**LABEL   13900--GOTO    13912--GOTO    13939--GOTO    13942--GOTO
GLUE
     11066**DCL     13774<<ASSIGN
GLUE.DATA
PL6.E3A0      #009=KIS$OSI_RECV File=KIS$OSI.:E05TSI                             WED 07/30/97 00:45 Page:346  
     11077**DCL     13778--ASSIGN
GLUE.MAGIC
     11076**DCL     13776<<ASSIGN
GLUE.TRNFNC
     11074**DCL     13777<<ASSIGN
GLUE.YRSCID
     11075**DCL     13775<<ASSIGN
GLUE$
     13649**DCL     11066--IMP-PTR 13773<<ASSIGN  13774>>ASSIGN  13775>>ASSIGN  13776>>ASSIGN  13777>>ASSIGN
     13778>>ASSIGN  13787>>ASSIGN  13795>>ASSIGN  13805>>ASSIGN  13811>>ASSIGN
GLUEBUF
     13310**DCL     13773--ASSIGN
GLUEBUF.*.DST_NSAP.ADDRESS_N
     13635**DCL     13636--REDEF
GLUEBUF.*.SRC_NSAP.ADDRESS_N
     13575**DCL     13576--REDEF
GLUEBUF.*.TPDUSIZE
     13338**DCL     13339--REDEF
HFC$LOCK
      7176**DCL-ENT 13673--CALL    13853--CALL
HFC$UNLOCK
      7176**DCL-ENT 13723--CALL    13858--CALL    13876--CALL    13881--CALL
I
     13650**DCL     13677<<DOINDEX 13745<<ASSIGN  13757<<ASSIGN  13758>>IF      13763>>ASSIGN  13776>>ASSIGN
K$FPT_CONNECT_OSI
      8331**DCL     13788--ASSIGN
K$FPT_CONNECT_OSI.DST_NSAP.ADDRESS_N
      8637**DCL      8638--REDEF
K$FPT_CONNECT_OSI.SRC_NSAP.ADDRESS_N
      8577**DCL      8578--REDEF
K$FPT_CONNECT_OSI.TPDUSIZE
      8340**DCL      8341--REDEF
K$FPT_TERM_OSI
      9004**DCL     13796--ASSIGN
K$FPT_TERM_OSI.DST_NSAP.ADDRESS_N
      9196**DCL      9197--REDEF
PL6.E3A0      #009=KIS$OSI_RECV File=KIS$OSI.:E05TSI                             WED 07/30/97 00:45 Page:347  
K$FPT_TERM_OSI.SRC_NSAP.ADDRESS_N
      9139**DCL      9140--REDEF
K$RWPARM
     11844**DCL        51--PROC    13736<>CALL    13874<>CALL    13919<>CALL
K$RWPARM.BLKREC
     11870**DCL     11895--REDEF
K$RWPARM.BLKREC.BLKU#
     11871**DCL     11873--REDEF
K$RWPARM.BLKREC.RECU#
     11883**DCL     11885--REDEF
K$RWPARM.DVE.DVBYTE.VFC
     11910**DCL     11911--REDEF
K$RWPARM.DVE.EOMCHAR
     11918**DCL     11922--REDEF
K$RWPARM.ERR
     11982**DCL     11987--REDEF   13728<<ASSIGN  13731<<ASSIGN  13791>>ASSIGN  13899<<ASSIGN  13911<<ASSIGN
     13930>>ASSIGN  13931<<ASSIGN  13938<<ASSIGN  13941<<ASSIGN
K$RWPARM.FC
     11946**DCL     11947--REDEF
K$RWPARM.FLDID
     12128**DCL     12129--REDEF
K$RWPARM.FPT$
     12009**DCL     12016--REDEF
K$RWPARM.FUNCTION
     12023**DCL     13668>>IF      13733<<ASSIGN  13766>>IF      13777>>ASSIGN  13781>>DOCASE  13843>>IF
     13855>>IF      13863>>IF      13865>>IF      13884>>IF      13907>>IF      13916>>IF      13954>>IF
     13956>>IF      13972>>IF
K$RWPARM.IP$
     11974**DCL     13917>>ASSIGN  13918>>ASSIGN
K$RWPARM.KEYTYPE
     12135**DCL     12136--REDEF
K$RWPARM.MSG$
     11845**DCL     11851--REDEF   13787<<ASSIGN  13795<<ASSIGN  13800<<ASSIGN  13803>>ASSIGN  13805>>ASSIGN
     13811<<ASSIGN  13829>>ASSIGN  13978>>ASSIGN  13983>>ASSIGN
K$RWPARM.MSGID
     11957**DCL     11962--REDEF
PL6.E3A0      #009=KIS$OSI_RECV File=KIS$OSI.:E05TSI                             WED 07/30/97 00:45 Page:348  
K$RWPARM.MSGIDXT
     11970**DCL     11974--REDEF
K$RWPARM.MSGSZ
     11852**DCL     13788<<ASSIGN  13796<<ASSIGN  13801<<ASSIGN  13812<<ASSIGN
K$RWPARM.ORG
     12106**DCL     12107--REDEF
K$RWPARM.SHDR$
     12038**DCL     13800>>ASSIGN  13821<<ASSIGN
K$RWPARM.SHDRSZ
     12042**DCL     13801>>ASSIGN  13822<<ASSIGN
K$RWPARM.STATION
     11856**DCL     13895<<ASSIGN
K$RWPARM.TCTX#
     12080**DCL     13716>>ASSIGN
K$RWPARM.TCTX$
     12016**DCL     10033--IMP-PTR 13669>>ASSIGN  13749>>ASSIGN  13757>>ASSIGN  13785>>ASSIGN  13792>>ASSIGN
     13793>>ASSIGN
K$RWPARM.THDRSZ
     12050**DCL     12054--REDEF
K$RWPARM.VDOFLGS
     12108**DCL     12119--REDEF
KI$QMHDR.FEI#
      7321**DCL     13917>>ASSIGN
KI$QMHDR.FPTSZ
      7354**DCL      7355--REDEF
KI$QMHDR.MSGSZ
      7360**DCL      7361--REDEF
KI$QMHDR.UID
      7350**DCL      7351--REDEF
KI$TCTX.SSN
     10185**DCL     13785>>ASSIGN
KI$TCTX.SSN.DST_NSAP.ADDRESS_N
     10489**DCL     10490--REDEF
KI$TCTX.SSN.DST_TSAP
     10357**DCL     13669>>ASSIGN  13793>>ASSIGN
KI$TCTX.SSN.SCID
PL6.E3A0      #009=KIS$OSI_RECV File=KIS$OSI.:E05TSI                             WED 07/30/97 00:45 Page:349  
     10293**DCL     13749>>ASSIGN  13757>>ASSIGN
KI$TCTX.SSN.SRC_NSAP.ADDRESS_N
     10429**DCL     10430--REDEF
KI$TCTX.SSN.SRC_TSAP
     10315**DCL     13792>>ASSIGN
KI$TCTX.SSN.TPDUSIZE
     10192**DCL     10193--REDEF
KIA$COMP
     13288**DCL-ENT 13874--CALL
KIS_MAJOR$
     13299**DCL     13675>>ASSIGN  13683>>ASSIGN  13756>>ASSIGN
KIS_MINOR$
     13300**DCL     13696>>ASSIGN  13706>>ASSIGN  13709>>ASSIGN  13710>>ASSIGN  13763>>ASSIGN
KIS_OSILOCK
     13301**DCL     13673<>CALL    13723<>CALL
KIS_SSN_MAXMAJOR
     13302**DCL     13750>>IF
KIS_SSN_MAXMINOR
     13303**DCL     13758>>IF
KIS_SSN_SERVERS
     13304**DCL     13677>>DOINDEX
KIT$SEND
     13289**DCL-ENT 13736--CALL
KQG$CANCEL
     13290**DCL-ENT 13904--CALL
KQG$GET
     13291**DCL-ENT 13961--CALL
KQP$PUT
     13292**DCL-ENT 13919--CALL
K_RWPARM_CON
     12476**DCL     13960>>ASSIGN
K_RWPARM_CON.BLKREC
     12502**DCL     12527--REDEF
K_RWPARM_CON.BLKREC.BLKU#
     12503**DCL     12505--REDEF
K_RWPARM_CON.BLKREC.RECU#
PL6.E3A0      #009=KIS$OSI_RECV File=KIS$OSI.:E05TSI                             WED 07/30/97 00:45 Page:350  
     12515**DCL     12517--REDEF
K_RWPARM_CON.DVE.DVBYTE.VFC
     12542**DCL     12543--REDEF
K_RWPARM_CON.DVE.EOMCHAR
     12550**DCL     12554--REDEF
K_RWPARM_CON.ERR
     12614**DCL     12619--REDEF
K_RWPARM_CON.FC
     12578**DCL     12579--REDEF
K_RWPARM_CON.FLDID
     12760**DCL     12761--REDEF
K_RWPARM_CON.FPT$
     12641**DCL     12648--REDEF
K_RWPARM_CON.KEYTYPE
     12767**DCL     12768--REDEF
K_RWPARM_CON.MSG$
     12477**DCL     12483--REDEF
K_RWPARM_CON.MSGID
     12589**DCL     12594--REDEF
K_RWPARM_CON.MSGIDXT
     12602**DCL     12606--REDEF
K_RWPARM_CON.ORG
     12738**DCL     12739--REDEF
K_RWPARM_CON.THDRSZ
     12682**DCL     12686--REDEF
K_RWPARM_CON.VDOFLGS
     12740**DCL     12751--REDEF
K_SC_USER$
     13305**DCL     13831>>ASSIGN
LDCT$
     13651**DCL     12920--IMP-PTR 13823<<ASSIGN  13824>>IF      13846>>IF      13849>>DOCASE  13853>>CALL
     13856>>ASSIGN  13858>>CALL    13860>>CALL    13864>>ASSIGN  13866>>ASSIGN  13867>>ASSIGN  13868>>IF
     13871>>CALL    13873>>IF      13874>>CALL    13876>>CALL    13881>>CALL    13888<<ASSIGN  13889>>IF
     13892>>IF      13894<<ASSIGN  13898>>IF      13903>>IF      13904>>CALL    13915>>ASSIGN  13917>>ASSIGN
     13918>>ASSIGN  13919>>CALL    13922>>ASSIGN  13924>>ASSIGN  13925>>ASSIGN  13935>>ASSIGN  13936>>ASSIGN
     13945>>ASSIGN  13946>>ASSIGN  13955>>ASSIGN  13957>>ASSIGN  13959>>IF      13961>>CALL
PL6.E3A0      #009=KIS$OSI_RECV File=KIS$OSI.:E05TSI                             WED 07/30/97 00:45 Page:351  
LINK
     13652**DCL     13692<<ASSIGN  13694>>DOWHILE 13696>>ASSIGN  13698>>ASSIGN  13702<<ASSIGN  13706<<ASSIGN
     13707>>IF      13709>>ASSIGN  13711>>ASSIGN  13719>>ASSIGN
MAJOR$
     13653**DCL     13675<<ASSIGN  13678>>IF      13679>>IF      13680>>IF      13683>>ASSIGN  13686<<ASSIGN
     13686>>ASSIGN  13691>>ASSIGN  13692>>ASSIGN  13756<<ASSIGN  13823>>ASSIGN  13831>>ASSIGN  13846>>IF
     13888>>ASSIGN  13892>>IF      13894>>ASSIGN
MAJOR_LOOP
     13677**LABEL   13684--EXIT
MINOR$
     13654**DCL     13699<<ASSIGN  13709<<ASSIGN  13710>>ASSIGN  13716>>ASSIGN  13717>>ASSIGN  13718>>IF
     13763<<ASSIGN  13764>>IF      13775>>ASSIGN  13909>>ASSIGN  13975>>ASSIGN
MINOR_LOOP
     13694**LABEL   13700--EXIT
N$DCT$$
     12778**DCL     12778--IMP-PTR 13823>>ASSIGN  13888>>ASSIGN  13894>>ASSIGN
NK$LDCT
     12920**DCL     13868--IF      13874<>CALL    13904<>CALL    13919<>CALL    13961<>CALL
NK$LDCT.DDT$
     12922**DCL     12922--REDEF
NK$LDCT.DFLG.PPND
     12928**DCL     13898>>IF      13915<<ASSIGN  13924<<ASSIGN  13935<<ASSIGN  13945<<ASSIGN
NK$LDCT.IOQ$
     12921**DCL     12922--REDEF
NK$LDCT.IP$
     12942**DCL     13918<<ASSIGN  13922<<ASSIGN  13925<<ASSIGN  13936<<ASSIGN  13946<<ASSIGN
NK$LDCT.IPFEI#
     12943**DCL     13917<<ASSIGN
NK$LDCT.LDCTX
     12923**DCL     12923--REDEF
NK$LDCT.LKFLG.ABORTED
     12935**DCL     12936--REDEF
NK$LDCT.LKFLG.NOWAIT
     12941**DCL     13873>>IF
NK$LDCT.LKFLG.OBLK
     12935**DCL     13864<<ASSIGN  13866<<ASSIGN  13903>>IF      13955<<ASSIGN  13957<<ASSIGN  13959>>IF
PL6.E3A0      #009=KIS$OSI_RECV File=KIS$OSI.:E05TSI                             WED 07/30/97 00:45 Page:352  
NK$LDCT.LKFLG.WTMRK
     12936**DCL     13856<<ASSIGN
NK$LDCT.LOCK
     12948**DCL     13853<>CALL    13858<>CALL    13876<>CALL    13881<>CALL
NK$LDCT.RESCOD
     12928**DCL     13849>>DOCASE
NK$LDCT.RLCID.LDCTX
     12945**DCL     12945--REDEF
NK$LDCT.STA$
     12941**DCL     12942--REDEF
NK$LDCT.SYMB$
     12920**DCL     12920--REDEF   12920--REDEF   12921--REDEF
NK$LDCT.USER
     12930**DCL     13846>>IF      13860<>CALL    13867>>ASSIGN  13871<>CALL    13892>>IF
NK$LDCT$
     12778**DCL     13823>>ASSIGN  13888>>ASSIGN  13894>>ASSIGN
NWIO.CGPARM.MSGIDXT
      6525**DCL      6528--REDEF
PTR$
     13657**DCL     13691<<ASSIGN  13696<<ASSIGN  13697>>IF      13699>>ASSIGN  13702>>ASSIGN  13718>>IF
     13719>>ASSIGN
PUTERR
     13655**DCL     13930<<ASSIGN  13932>>DOCASE
RWPARM
     12160**DCL     13960<<ASSIGN  13961<>CALL
RWPARM.BLKREC
     12186**DCL     12211--REDEF
RWPARM.BLKREC.BLKU#
     12187**DCL     12189--REDEF
RWPARM.BLKREC.RECU#
     12199**DCL     12201--REDEF
RWPARM.DVE.DVBYTE.VFC
     12226**DCL     12227--REDEF
RWPARM.DVE.EOMCHAR
     12234**DCL     12238--REDEF
RWPARM.ERR
PL6.E3A0      #009=KIS$OSI_RECV File=KIS$OSI.:E05TSI                             WED 07/30/97 00:45 Page:353  
     12298**DCL     12303--REDEF
RWPARM.FC
     12262**DCL     12263--REDEF
RWPARM.FLDID
     12444**DCL     12445--REDEF
RWPARM.FPT$
     12325**DCL     12332--REDEF
RWPARM.KEYTYPE
     12451**DCL     12452--REDEF
RWPARM.MSG$
     12161**DCL     12167--REDEF
RWPARM.MSGID
     12273**DCL     12278--REDEF
RWPARM.MSGIDXT
     12286**DCL     12290--REDEF
RWPARM.ORG
     12422**DCL     12423--REDEF
RWPARM.THDRSZ
     12366**DCL     12370--REDEF
RWPARM.VDOFLGS
     12424**DCL     12435--REDEF
SAFE
     13658**DCL     13803<<ASSIGN  13829>>ASSIGN  13978>>ASSIGN  13983>>ASSIGN
SAFEBYTES
     13659**DCL     13803>>ASSIGN  13805<<ASSIGN  13805>>ASSIGN  13829<<ASSIGN  13978<<ASSIGN  13983<<ASSIGN
SCID
     13660**DCL     13670<<ASSIGN  13683<<ASSIGN  13688>>IF      13725>>IF      13727>>IF      13749<<ASSIGN
     13750>>IF      13756>>ASSIGN
SC_PRTCL_SCREECH
     13294**DCL-ENT 13951--CALL    13964--CALL    13969--CALL
SC_PRTCL_SNAP
     13295**DCL-ENT 13739--CALL    13753--CALL    13814--CALL    13885--CALL
SC_WRONGLDCT
     13296**DCL-ENT 13833--CALL
SEND_DISCONNECT
     13733**LABEL   13843--GOTO
PL6.E3A0      #009=KIS$OSI_RECV File=KIS$OSI.:E05TSI                             WED 07/30/97 00:45 Page:354  
SERVERAU
     13661**DCL     13895>>ASSIGN
SNAP
     13753**LABEL   13760--GOTO    13769--GOTO
SQUIRRELED
     13662**DCL     13779<<ASSIGN  13806<<ASSIGN  13827>>IF      13976>>IF      13981>>IF
SSR$RUE
     13293**DCL-ENT 13860--CALL    13871--CALL
TCONFPT
      8668**DCL     13785<<ASSIGN
TCONFPT.DST_NSAP.ADDRESS_N
      8974**DCL      8975--REDEF
TCONFPT.SRC_NSAP.ADDRESS_N
      8914**DCL      8915--REDEF
TCONFPT.TPDUSIZE
      8677**DCL      8678--REDEF
TDISFPT.DST_NSAP.ADDRESS_N
      9414**DCL      9415--REDEF
TDISFPT.DST_TSAP
      9287**DCL     13793<<ASSIGN
TDISFPT.REASON
      9223**DCL     13791<<ASSIGN
TDISFPT.SRC_NSAP.ADDRESS_N
      9357**DCL      9358--REDEF
TDISFPT.SRC_TSAP
      9247**DCL     13792<<ASSIGN
TEMP
     13663**DCL     13689<<ASSIGN  13698<<ASSIGN  13704>>IF      13711<<ASSIGN  13714>>IF      13725>>IF
     13730>>IF      13745>>ASSIGN
TSAP
      7886**DCL     13669<<ASSIGN
TSAP.LEN
      7890**DCL     13307--IMP-SIZ 13679>>IF      13680>>IF      13680>>IF
TSAP.TSAP
      7898**DCL     13680--IF
UBIN9
PL6.E3A0      #009=KIS$OSI_RECV File=KIS$OSI.:E05TSI                             WED 07/30/97 00:45 Page:355  
     13664**DCL     13831<<ASSIGN
USRT$
     13666**DCL     13867<<ASSIGN  13868>>IF      13868>>IF      13868>>IF
WRONGLDCT
     13827**LABEL   13847--GOTO    13891--GOTO    13893--GOTO
