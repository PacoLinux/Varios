VERSION E05

PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:1    
        1        1        /*M*  RBT device services called by VDH                            */
        2        2        /*T***********************************************************/
        3        3        /*T*                                                         */
        4        4        /*T* Copyright (c) Bull HN Information Systems Inc., 1997    */
        5        5        /*T*                                                         */
        6        6        /*T***********************************************************/
        7        7        /*X* PLM=6,IND=3,CTI=3,DCI=3,DTI=0,MCI,MOC,DMC       */
        8        8        /*P* NAME:   KZD$DEVMGR
        9        9             PURPOSE: To provide a VDH to RBT interface.                 */
       10       10
       11       11        /*D*  NAME:   KZD$DEVMGR
       12       12              CALL:
       13       13                      CALL KZD$DEVMGR (VDH-parameter);
       14       14              PARAMETER:
       15       15                      VDH-parameter is a VDH->VDH-user parameter block.
       16       16              DESCRIPTION:
       17       17                      This procedure is called by VDH to process user
       18       18                      events.                                              */
       19       19        %EJECT;
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:2    
       20       20
       21       21        KZD$DEVMGR: PROC (PARM) ALTRET;
       22       22
       23       23
       24       24        %INCLUDE KZ$LINCTX;
       25      644        %INCLUDE KZ$NJE_M;
       26      882        %INCLUDE KZ$OTPBFR;
       27      983        %INCLUDE KZ$RBT_M;
       28     1542        %INCLUDE KZ$BSCSTT;
       29     1648        %INCLUDE KH$STT;
       30     1678        %INCLUDE KH$CHN;
       31     1800        %INCLUDE KZ_HASP_C;
       32     2142        %INCLUDE KV_GLBCNS_E;
       33     2483        %INCLUDE KZ_3270_C;
       34     2641        %INCLUDE KZ_PERR_C;
       35     2723        %INCLUDE KZ_CLM_E;
       36     2895        %INCLUDE KV$INT;
       37     3527        %INCLUDE KV$USR;
       38     3839        %INCLUDE KV$VDH;
       39     4270        %INCLUDE KV$GLB;
       40     4689        %INCLUDE KV_GLB_M;
       41     4811        %INCLUDE KV$GLBCTX;
       42     5256        %INCLUDE KV_PRMID_E;
       43     5430        %INCLUDE KL_SUPER_C;
       44     8332        %INCLUDE KL_MACRO_C;
       45    11684        %INCLUDE LCP_6;
       46    15963        %INCLUDE KL_AFCN_C;
       47    16064        %INCLUDE K_ID_E;
       48    16114        %K#ENTID_E;
       49    16133        %K#LYRID_E;
       50    16140        %INCLUDE KHC_MAC_C;
       51    16181
       52    16182        %KV_USR_FNC_E;
       53    16198        %KV_INPOPRX_E;
       54    16210        %KZ_3270_E;
       55    16338        %KV_USR_EVT_ID_E;
       56    16358        %KV_VDH_EVT_ID_E;
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:3    
       57    16364        %KV_PRMID_E;
       58    16520        %KV_STRTYP_E;
       59    16558        %EQU KV_VFU = CHARTEXT('KV$PTR.MVD$->KV$MVD.VFU$->KV$VFU');
       60    16559        /* %SUB KV_VFU = "KV$PTR.MVD$->KV$MVD.VFU$->KV$VFU"; */
       61    16560        %EQU VFU_CHN_BOF = 11;
       62    16561        %EQU VFU_CHN_TOF = 0;
       63    16562        %EQU VFU_CHN_HI_BASE = 6;
       64    16563        %EQU VFU_CHN_REVERSE = 5;
       65    16564        %EQU VFU_CHNX_HI = 11;
       66    16565        %EQU VFU_LINX_HI = 200;
       67    16566
       68    16567
       69    16568        /*    Parameters                   */
       70    16569
       71    16570    1   DCL PARM UBIN;
       72    16571
       73    16572        /*    SYMREF                    */
       74    16573
       75    16574    1   DCL KZR_THRTL_BLK UBIN SYMREF;
       76    16575        %KV$VDH_EVT (NAME=KV_VDH_EVT_CMPOTP,STCLASS=SYMREF);
       77    16610        %KV$VDH_OTPMRK (NAME=KV_VDH_OTPMRK,STCLASS=SYMREF);
       78    16672        %KV$VDH_EVT (NAME=KV_VDH_EVT_RQSOTP,STCLASS=SYMREF);
       79    16707        %KV$VDH_PST(NAME=KV_VDH_PST_CR_VRT, STCLASS=SYMREF);
       80    16781
       81    16782        /*      Entry                    */
       82    16783
       83    16784    1   DCL KVB$GETSYS ENTRY(2) ALTRET;
       84    16785    1   DCL KVB$RLS ENTRY(2) ALTRET;
       85    16786    1   DCL KVB$GET2NSYS ENTRY(2) ALTRET;
       86    16787    1   DCL KVB$RLS2NSYS ENTRY(2) ALTRET;
       87    16788    1   DCL KZR$RELOTPBFR ENTRY(1) ALTRET;
       88    16789    1   DCL KZR$DSC_CONT ENTRY(1) ALTRET;
       89    16790    1   DCL KZR$DFR ENTRY(1) ALTRET;
       90    16791    1   DCL KZR_CNCDSC@ EPTR SYMREF;
       91    16792    1   DCL KHA$ERRLOG ENTRY(2) ALTRET;
       92    16793    1   DCL KHI$DISABLE ENTRY(1);
       93    16794    1   DCL KHI$ENABLE ENTRY;
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:4    
       94    16795    1   DCL KVV$VDI ENTRY(1) ALTRET;
       95    16796
       96    16797        /*    Auto                         */
       97    16798    1   DCL PARM$ PTR;
       98    16799    1   DCL DCTX$ PTR;
       99    16800    1   DCL LCTX$ PTR;
      100    16801    1   DCL BFR$ PTR;
      101    16802    1   DCL TBFR$ PTR;
      102    16803    1   DCL BYTX UBIN;
      103    16804    1   DCL BYTSIZ SBIN;
      104    16805    1   DCL J SBIN;
      105    16806    1   DCL I UBIN;
      106    16807    1   DCL T$ PTR;
      107    16808    1   DCL U$ PTR;
      108    16809    1   DCL K SBIN;
      109    16810    1   DCL L UBIN;
      110    16811    1   DCL M BIT(8);
      111    16812    1   DCL N UBIN;
      112    16813    1   DCL LEV UBIN;
      113    16814    1   DCL IRS BIT(8);
      114    16815    1   DCL SGN$ PTR;
      115    16816    1   DCL SGN_NJE$ CPTR;
      116    16817    1   DCL SGNITYPE BIT(1) ALIGNED;
      117    16818    1   DCL SZ UBIN;
      118    16819    1   DCL PAGLNG UBIN;
      119    16820    1   DCL VFU$ PTR;
      120    16821    1   DCL VFU_LIN$ PTR;
      121    16822    1   DCL VFU_CHNX UBIN;
      122    16823    1   DCL VFU_LINX UBIN;
      123    16824        %FPT_WRSYSLOG (STCLASS="");
      124    16919        %KV$VDH_EVT (STCLASS=AUTO);
      125    16954        %KV$VDH_OTPMRK (STCLASS=AUTO);
      126    17016        %KZ$EVENT (STCLASS=AUTO);
      127    17098        %KV$VDH_OTPLCL (STCLASS="");
      128    17171
      129    17172
      130    17173        /*    Based                        */
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:5    
      131    17174
      132    17175        %KH$CHN;
      133    17299        %KV$USR_DAT (STCLASS="BASED(PARM$)");
      134    17383        %KV$PTR;
      135    17426        %KV$MRD;
      136    17473        %KV$SRD;
      137    17748        %KV$VDI;
      138    17819        %KV$OTPMRK;
      139    17846        %KV$USR_EVT (STCLASS="BASED(PARM$)");
      140    17881        %KV$USR_PST (STCLASS="BASED(PARM$)");
      141    17951        %KV$USR_OTPMRK (STCLASS="BASED(PARM$)");
      142    18013        %KV$USR_SETPRM (STCLASS="BASED(PARM$)");
      143    18075        %KV$MVD;
      144    18119        %KV$TRNTBL;
      145    18177        %KV$VFU;
      146    18224
      147    18225        %KZ$LINCTX (STCLASS="BASED(LCTX$)");
      148    18656        %KZ$OTPBFR (STCLASS="BASED(BFR$)");
      149    18721        %KZ$SDVCTX (NAME=DVCTX,STCLASS="BASED(DCTX$)");
      150    19033        %KZ$HASPBLK (STCLASS=BASED);
      151    19066        %KZ$HASPSCB (STCLASS="BASED(BFR$)");
      152    19089        %KZ$HASPSRCB (NAME="KZ$HASPSRCB(0:0)",STCLASS="BASED(BFR$)");
      153    19113        %KZ$HASPRCB  (STCLASS="BASED(BFR$)");
      154    19131        %KZ$NJE_SIGNON (STCLASS=BASED);
      155    19211        %KZ$SYNCSTAT;
      156    19625        %KZ_HASP_HDR (STCLASS=SYMREF);
      157    19649        %KZ$RBT_E;
      158    19679    1   DCL BYT(0:0) BIT(8) CALIGNED BASED(BFR$);
      159    19680    1   DCL CHR1 CHAR(512) BASED;
      160    19681    1   DCL 1 DV BASED(T$) CALIGNED,
      161    19682    1         2 NUM BIT(8),
      162    19683    1         2 SNUM UBIN(8) UNAL,
      163    19684    1         2 CTL BIT(16);
      164    19685    1   DCL VFUBFR(0:199) BIT(16) ALIGNED BASED(VFU_LIN$);
      165    19686    1   DCL 1 VFU_WORD BASED ALIGNED,
      166    19687    1         2 * BIT(2),
      167    19688    1         2 CHN_LO(0:5) BIT(1) UNAL,
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:6    
      168    19689    1         2 * BIT(2),
      169    19690    1         2 CHN_HI(0:5) BIT(1) UNAL;
      170    19691
      171    19692
      172    19693        /*    Static      */
      173    19694
      174    19695        %FPT_WRSYSLOG (FPTN=FPT@WRSYSLOG,
      175    19696                       FCG='KZ',
      176    19697                       MID='D',
      177    19698                       SEV=%G_WRSYSLOG_SEV_LINE_ABORT#,
      178    19699                       STCLASS=CONSTANT);
      179    19794        %KZ$EVENT (FPTN=KZ_EVENT,STCLASS=CONSTANT);
      180    19876        %KV$VDH_EVT (NAME=KV_VDH_EVT,STCLASS=CONSTANT,ID=KV_VDH_EVT_ID_ATN);
      181    19911        %KV$VDH_OTPLCL (NAME=KV_VDH_OTPLCL,STCLASS=CONSTANT);
      182    19984        %KZ$NJE_SIGNON (NAME=KZ_NJE_SIGNON,STCLASS=CONSTANT);
      183    20064        %KZ$OTPBFR (NAME=KZ_OTPBFR,STCLASS="CONSTANT SYMDEF");
      184    20129    1   DCL VFC(0:4) BIT(8) CONSTANT INIT('D4'X,'61'X,'E2'X,'E3'X,'C1'X);
      185    20130    1   DCL KZD_MINSP_FORPST UBIN CONSTANT SYMDEF INIT(3);
      186    20131    1   DCL ESCSZ(0:5) UBIN CONSTANT INIT(0,0,2,0,1,0);
      187    20132    1   DCL SLCT(0:1) BIT(8) CONSTANT INIT('12'X,'11'X);
      188    20133
      189    20134        /*N*  KLUDGE AREA *** KLUDGE AREA *** KLUDGE AREA *** KLUDGE AREA *** KLUD  *N*/
      190    20135        /*N*  To make some site-specific patches easier, here's where we're         *N*/
      191    20136        /*N*  stashing away some CONSTANT SYMDEF values for HASP/2780/3780.         *N*/
      192    20137        /*N*  These "defaults" should be made into SUPER options on                 *N*/
      193    20138        /*N*  TERM/PROFILE/DEVICE creation commands.                                *N*/
      194    20139    1   DCL KZ_SNDEMCHR BIT(1) ALIGNED CONSTANT SYMDEF INIT('1'B);
      195    20140    1   DCL KZ_SLCCHR2780PNC BIT(8) ALIGNED CONSTANT SYMDEF INIT('F4'X);
      196    20141    1   DCL KZ_SLCCHR3780PNC1 BIT(8) ALIGNED CONSTANT SYMDEF INIT('12'X);
      197    20142    1   DCL KZ_SLCCHR3780PNC2 BIT(8) ALIGNED CONSTANT SYMDEF INIT('13'X);
      198    20143    1   DCL KZ_SLCCHR3780PRN BIT(8) ALIGNED CONSTANT SYMDEF INIT('11'X);
      199    20144        /*N*  KLUDGE AREA *** KLUDGE AREA *** KLUDGE AREA *** KLUDGE AREA *** KLUD  *N*/
      200    20145        %EJECT;
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:7    
      201    20146    1         PARM$ = ADDR(PARM);
      202    20147    1         CALL INITPRM;
      203    20148                          /* Eh?  $$CURRTIME GS$DV_LATEST_POLL(B2)                    */
      204    20149
      205    20150              %DISABLE (DISLVL=LEV,INHLVL=KZ$LINCTX.INHLVL);
      206    20154        %EJECT;
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:8    
      207    20155    1   FNC_CASE:
      208    20156    2         DO CASE( KV$USR_DAT.FNC);
      209    20157
      210    20158
      211    20159
      212    20160    2          CASE(%KV_USR_FNC_GETOTPBFR);
      213    20161        /*D*     When VDH calls with KV_USR_FNC_GETOTPBFR, either there is no
      214    20162                 output block, or the current buffer is full.  If there is no
      215    20163                 block, one is obtained, and initialized.  If the current
      216    20164                 buffer is full, and its a HASP line, the SCB count field is
      217    20165                 set and, if there is room for at least a one byte string in the
      218    20166                 current block, the buffer size is set to the minimum of remaining
      219    20167                 block size or 63.
      220    20168
      221    20169                 If there is not room for a one byte string in the current block,
      222    20170                 or its not a HASP line, the current block is output and a new
      223    20171                 one obtained and initialized.
      224    20172                                                                           */
      225    20173
      226    20174    2            IF DVCTX.MGR_TYPE = %KZ_S_DMCONSOLE# THEN
      227    20175    2               DCTX$ = DVCTX.LNK$;
      228    20176    2            IF BFR$ = ADDR(NIL) THEN
      229    20177    2               CALL GET_BFR ALTRET(NOBUF);
      230    20178    3            ELSE DO;
      231    20179    3               CALL CMPBYTSIZ;
      232    20180    3               BYTSIZ = J;
      233    20181    3               IF KZ$LINCTX.PRO.PROTYP = %KLPT_HASP#
      234    20182    4                  OR KZ$LINCTX.PRO.PROTYP = %KLPT_NJE# THEN DO;
      235    20183    4                  IF BYTSIZ < 2 THEN
      236    20184                          /* If one record in block, let it span into next  */
      237    20185    4                     IF DVCTX.LASTRCBX = SIZEC(KZ$OTPBFR)+
      238    20186    4                        SIZEC(KZ$HASPBLK)-3 THEN
      239    20187    4                        CALL FINOTPBF2 ALTRET(NOBUF);
      240    20188    5                     ELSE DO;
      241    20189    5                        CALL SET_SCB;
      242    20190    5                        CALL DONE ALTRET(NOBUF);
      243    20191    5                        GOTO GETOTP1;
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:9    
      244    20192    5                        END;
      245    20193    5                  ELSE DO;
      246    20194    5                     CALL SET_SCB;
      247    20195    5                     IF BYTSIZ > 63 THEN
      248    20196    5                        BYTSIZ = 63;
      249    20197    5   GETOTP1:          DVCTX.LASTSCBX = BYTX;
      250    20198    5                     BYTX = BYTX + 1;
      251    20199    5                     END;
      252    20200    4                  END;
      253    20201    3               ELSE
      254    20202    3                  IF DVCTX.LASTRCBX <= SIZEC(KZ$OTPBFR)+2 THEN
      255    20203    3                     CALL FINOTPBF2 ALTRET(NOBUF);
      256    20204    3                  ELSE
      257    20205    3                     CALL DONE ALTRET(NOBUF);
      258    20206    3               END;
      259    20207        %EJECT;
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:10   
      260    20208    2          CASE(%KV_USR_FNC_SETPRM);
      261    20209    3            DO CASE(KV$USR_SETPRM.PRMID);
      262    20210    3             CASE(%KV_PRMID_PRFNAM);
      263    20211        /*          T$ = PINCRW(KV$USR_SETPRM.VAL_.ADR$,38);
      264    20212                    DVCTX.RCB_CODE = DV.NUM;
      265    20213                    DVCTX.SUSBIT_MASK = DV.CTL;            */
      266    20214    3             CASE(%KV_PRMID_BIN);
      267    20215    3               DVCTX.FLAGS.BINARY_OK = BINBIT(KV$USR_SETPRM.VAL,1);
      268    20216    3             CASE(%KV_PRMID_INPUT);
      269    20217    3               DVCTX.MGR_TYPE_B = DVCTX.MGR_TYPE_B | BINBIT(KV$USR_SETPRM.VAL,8);
      270    20218    3             CASE(%KV_PRMID_OUTPUT);
      271    20219    3               DVCTX.MGR_TYPE_B = DVCTX.MGR_TYPE_B | BINBIT(KV$USR_SETPRM.VAL*2,8);
      272    20220    3             CASE(%KV_PRMID_PRINTTYPE);
      273    20221    3               DVCTX.ACCESS_METHOD = KV$USR_SETPRM.VAL;
      274    20222    3             CASE(%KV_PRMID_VFU);
      275    20223    3               IF DVCTX.RCB_CODE ~= 'E5'X
      276    20224    3                  OR DVCTX.FLAGS.EVFU_LOADED THEN
      277    20225    3                  EXIT FNC_CASE;
      278    20226    3               PAGLNG = KV$PTR.SRD$->KV$SRD.LNG;
      279    20227    3               IF PAGLNG < 1 OR PAGLNG > %VFU_LINX_HI THEN
      280    20228    3                  PAGLNG = 1;
      281    20229    3               SZ = SIZEW(KZ$OTPBFR)+PAGLNG+2;
      282    20230    3               CALL KVB$GET2NSYS (SZ,VFU$) ALTRET(NOBUF);
      283    20231    3               VFU$->KZ$OTPBFR = KZ_OTPBFR;
      284    20232    3               VFU$->KZ$OTPBFR.BFRSIZ = SZ;
      285    20233    3               VFU$->KZ$OTPBFR.DEV$ = DCTX$;
      286    20234    3               VFU_LIN$ = PINCRW(VFU$,SIZEW(KZ$OTPBFR));
      287    20235                    /* ESC '7' signals the start of a VFU record. */
      288    20236    3               VFUBFR(0) = '27F7'X;
      289    20237    4               DO VFU_LINX = 1 TO PAGLNG;
      290    20238    4                  ADDR(VFUBFR(VFU_LINX))->VFU_WORD = '4040'X;
      291    20239    4                  END;
      292    20240        /*          DO VFU_CHNX = 0 TO %VFU_CHNX_HI;
      293    20241                       IF %KV_VFU.LIN(VFU_CHNX) > 0 THEN DO;
      294    20242                          IF VFU_CHNX < %VFU_CHN_HI_BASE THEN
      295    20243         ADDR(VFUBFR(%KV_VFU.LIN(VFU_CHNX)))->VFU_WORD.CHN_LO(%VFU_CHN_REVERSE-VFU_CHNX) = '
             20243        1'B;
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:11   
      296    20244                          ELSE
      297    20245         ADDR(VFUBFR(%KV_VFU.LIN(VFU_CHNX)))->VFU_WORD.CHN_HI(%VFU_CHN_REVERSE-(VFU_CHNX-%VF
             20245        U_CHN_HI_BASE)) = '1'B;
      298    20246                          VFU_LINX = %KV_VFU.NXT(VFU_CHNX);
      299    20247                          DO WHILE (VFU_LINX ~= 0);
      300    20248                             IF VFU_CHNX < %VFU_CHN_HI_BASE THEN
      301    20249         ADDR(VFUBFR(%KV_VFU.LIN(VFU_LINX)))->VFU_WORD.CHN_LO(%VFU_CHN_REVERSE-VFU_CHNX) = '
             20249        1'B;
      302    20250                             ELSE
      303    20251         ADDR(VFUBFR(%KV_VFU.LIN(VFU_LINX)))->VFU_WORD.CHN_HI(%VFU_CHN_REVERSE-(VFU_CHNX-%VF
             20251        U_CHN_HI_BASE)) = '1'B;
      304    20252                             VFU_LINX = %KV_VFU.NXT(VFU_LINX);
      305    20253                             END;
      306    20254                          END;
      307    20255                       END;
      308    20256
      309    20257                    ADDR(VFUBFR(1))->VFU_WORD.CHN_LO(%VFU_CHN_REVERSE-%VFU_CHN_TOF) = '1'B;
      310    20258         ADDR(VFUBFR(PAGLNG))->VFU_WORD.CHN_HI(%VFU_CHN_REVERSE-(%VFU_CHN_BOF-%VFU_CHN_HI_BA
             20258        SE)) = '1'B;
      311    20259        */
      312    20260    3               VFUBFR(1) = 'C17C'X;  /* 'A@' = Top-Of-Form */
      313    20261    3               VFUBFR(PAGLNG) = '7C4A'X;  /* '@<cent-sign>' = Channel 12 */
      314    20262                    /* ESC '8' signals the end of a VFU record. */
      315    20263    3               VFUBFR(PAGLNG+1) = '27F8'X;
      316    20264    3               VFU$->KZ$OTPBFR.DATA_SIZ = (PAGLNG*2)+4;
      317    20265    3               TBFR$ = BFR$;
      318    20266    3               BFR$ = VFU$;
      319    20267    3               CALL QUEUE_BFR;
      320    20268    3               BFR$ = TBFR$;
      321    20269    3               DVCTX.FLAGS.EVFU_LOADED = '1'B;
      322    20270    3             CASE(%KV_PRMID_FIRSTLINE);
      323    20271    4               IF %KV_VDI.UN_KNWPST THEN DO;
      324    20272    4                  DVCTX.FLAGS.EVFU_LOADED = '0'B;
      325    20273    4                  %KV_VDI.UN_KNWPST = '0'B;
      326    20274    4                  END;
      327    20275    3             END;
      328    20276        %EJECT;
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:12   
      329    20277    2          CASE(%KV_USR_FNC_OTPMRK);
      330    20278
      331    20279        /*D*     When VDH calls with KV_USR_FNC_OTPMRK, we are to add a
      332    20280                 marker entry in the current output block.  If the marker
      333    20281                 is not MSTRTR type and there is a marker previously saved in
      334    20282                 the current block of type NOT MSTRTR this marker data is
      335    20283                 inserted into its place.  Otherwise,  This marker must be
      336    20284                 added to the list of markers in this block.  If there is no
      337    20285                 space for it, the current record is completed and the block
      338    20286                 is output.  If the marker is marked as CMPOTP, the block
      339    20287                 containing it is output, as we will not receive any more data
      340    20288                 until this block is released after being sent.
      341    20289                                                                           */
      342    20290    2            IF DVCTX.MGR_TYPE = %KZ_S_DMCONSOLE# THEN
      343    20291    2               DCTX$ = DVCTX.LNK$;
      344    20292
      345    20293    2            IF KV$USR_OTPMRK.DAT.MSTRTR AND
      346    20294    2               NOT KZ$LINCTX.PRO.RRR
      347    20295    2               OR DVCTX.MGR_TYPE = %KZ_S_DMINPUT#
      348    20296    3            THEN DO;
      349    20297                       /* Not SECURE:  immediately ACK all MSTRTR markers. */
      350    20298                       /* or input-only: just ACK everything. */
      351    20299    3               KV$VDH_OTPMRK = KV_VDH_OTPMRK;
      352    20300    3               KV$VDH_OTPMRK.DAT = KV$USR_OTPMRK.DAT;
      353    20301    3               CALL KVV$VDI (KV$VDH_OTPMRK);
      354    20302    3               EXIT FNC_CASE;
      355    20303    3               END;
      356    20304
      357    20305    2            IF BFR$=ADDR(NIL) THEN
      358    20306    2               CALL GET_BFR ALTRET(NOBUF);
      359    20307    2            IF NOT KV$USR_OTPMRK.DAT.MSTRTR AND KZ$OTPBFR.MRKCNT~=0 THEN
      360    20308    3            DO I = 1 TO KZ$OTPBFR.MRKCNT;
      361    20309    3               T$=PINCRW(BFR$,KZ$OTPBFR.BFRSIZ - SIZEW(KV$OTPMRK)*I);
      362    20310    4               IF NOT T$->KV$OTPMRK.MSTRTR THEN DO;
      363    20311    4                  T$->KV$OTPMRK=KV$USR_OTPMRK.DAT;
      364    20312    4                  GOTO MRKRX;
      365    20313    4                  END;
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:13   
      366    20314    3               END;
      367    20315
      368    20316    3            IF KZ$OTPBFR.MRKCNT = 2 THEN DO;
      369    20317    3               CALL FINOTPBFR ALTRET(NOBUF);
      370    20318    3               END;
      371    20319
      372    20320    2            KZ$OTPBFR.MRKCNT=KZ$OTPBFR.MRKCNT+1;
      373    20321    2            T$=PINCRW(BFR$,KZ$OTPBFR.BFRSIZ-SIZEW(KV$OTPMRK)*KZ$OTPBFR.MRKCNT);
      374    20322    2            T$->KV$OTPMRK=KV$USR_OTPMRK.DAT;
      375    20323
      376    20324    3            IF KV$USR_OTPMRK.CMPOTP THEN DO;
      377    20325                      /* Process this OTPMRK thru data stream - we'll recieve
      378    20326                         no more data until the pipe is clear         */
      379    20327    3   OTPMRK0:    CALL FINOTPBFR ALTRET(NOBUF);
      380    20328    3               END;
      381    20329    2   MRKRX:   ;
      382    20330        %EJECT;
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:14   
      383    20331    2          CASE(%KV_USR_FNC_PST);
      384    20332
      385    20333        /*D*     When VDH calls with KV_USR_FNC_PST, we are at an end of record
      386    20334                 and some positioning information must be output.  If it is a
      387    20335                 HASP line, the SCB for the current string is set.  If the
      388    20336                 positioning requires Top Of Form the required number of top
      389    20337                 skip to top of page VFC records is output, with appropriate
      390    20338                 one byte blank records.
      391    20339
      392    20340                 Upspace n lines is done in the same manner generating blank
      393    20341                 records with Space n Lines After Printing controls.
      394    20342
      395    20343                 Position n columns on the same line allows us to do blank
      396    20344                 compression for both HASP and 2780/3780 lines.  The appropriate
      397    20345                 SCB is generated to skip over n blanks.
      398    20346
      399    20347                 If the posiiton causes a skip back to column one of the same
      400    20348                 line, the current record is ended and given a VFC of upspace
      401    20349                 zero after print.  If the position is backkwards, but not to
      402    20350                 column one,  The proper place to insert an SCB is computed
      403    20351                 and the current buffer pointer and size set to that place. */
      404    20352
      405    20353
      406    20354    2            IF DVCTX.MGR_TYPE = %KZ_S_DMCONSOLE# THEN
      407    20355    2               DCTX$ = DVCTX.LNK$;
      408    20356    2            IF BFR$=ADDR(NIL) THEN
      409    20357    2               CALL GET_BFR ALTRET(NOBUF);
      410    20358    2            IF KZ$LINCTX.PRO.PROTYP = %KLPT_HASP#
      411    20359    3               OR KZ$LINCTX.PRO.PROTYP = %KLPT_NJE# THEN DO;
      412    20360    3               CALL SET_SCB;
      413    20361    3               DVCTX.LASTSCBX = BYTX;
      414    20362    3               BYTX=BYTX+1;
      415    20363    3               END;
      416    20364
      417    20365    2            CALL CMPBYTSIZ;
      418    20366
      419    20367                 /* Output SKA 1 for top of page requests                  */
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:15   
      420    20368
      421    20369    3            IF KV$USR_PST.TOPPAGCNT > 0 THEN DO;
      422    20370    4               DO K = 1 TO KV$USR_PST.TOPPAGCNT;
      423    20371    5                  IF DVCTX.ACCESS_METHOD = %KZ_S_ACSPRINT# THEN DO;
      424    20372    5                     M='91'X;
      425    20373    5                     N=1;
      426    20374    5                     END;
      427    20375    5                  ELSE DO;
      428    20376    5                     M='80'X;
      429    20377    5                     N=%KV_MRD.LNG-%KV_MRD.DVCLIN+1;
      430    20378    5                     END;
      431    20379    5                  DO WHILE N ~= 0;
      432    20380    5                     IF KZ$LINCTX.PRO.PROTYP = %KLPT_HASP#
      433    20381    6                        OR KZ$LINCTX.PRO.PROTYP = %KLPT_NJE# THEN DO;
      434    20382    6                        KZ$HASPSRCB(DVCTX.LASTRCBX+1) = M;
      435    20383    6                        IF DVCTX.LASTSCBX = DVCTX.LASTRCBX + 2 THEN
      436    20384    6                           CALL BLDBLNKSTR ALTRET(NOBUF);
      437    20385    6                        CALL ENDSTR;
      438    20386    6                        END;
      439    20387    6                     ELSE DO;
      440    20388    6                        I=4;          /* Skip to channel 1 VFC */
      441    20389    6                        CALL BLDUPSPCREC ALTRET(NOBUF);
      442    20390    6                        END;
      443    20391    5                     CALL CHKEOB ALTRET(NOBUF);
      444    20392    5                     N=N-1;
      445    20393    5                     END;
      446    20394    4                  END;
      447    20395    3               %KV_MRD.DVCLIN = 1;
      448    20396    3               %KV_MRD.DVCCLM = 1;
      449    20397    3               END;
      450    20398
      451    20399                 /* Position to proper line on page                        */
      452    20400
      453    20401    2            K = KV$USR_PST.PHSPST.LIN - %KV_MRD.DVCLIN;
      454    20402    3            DO WHILE (K > 0);
      455    20403    3               IF DVCTX.ACCESS_METHOD = %KZ_S_ACSPRINT# THEN
      456    20404    3                  IF K > 3 THEN
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:16   
      457    20405    3                     I = 3;
      458    20406    3                  ELSE
      459    20407    3                     I = K;
      460    20408    3               ELSE
      461    20409    3                  I=1;                /* Punch multiple records as req'd */
      462    20410    3               IF KZ$LINCTX.PRO.PROTYP = %KLPT_HASP#
      463    20411    4                  OR KZ$LINCTX.PRO.PROTYP = %KLPT_NJE# THEN DO;
      464    20412    4                  KZ$HASPSRCB(DVCTX.LASTRCBX+1) = '80'X;
      465    20413    4                  IF DVCTX.ACCESS_METHOD = %KZ_S_ACSPRINT# THEN
      466    20414    4                     KZ$HASPSRCB.S.UPSP_CT(DVCTX.LASTRCBX+1) = I;
      467    20415    4                  IF DVCTX.LASTSCBX = DVCTX.LASTRCBX + 2 THEN
      468    20416    4                     CALL BLDBLNKSTR ALTRET(NOBUF);
      469    20417    4                  CALL ENDSTR;
      470    20418    4                  END;
      471    20419    4               ELSE DO;
      472    20420    4                  CALL BLDUPSPCREC ALTRET(NOBUF);
      473    20421    4                  END;
      474    20422    3               K=K-I;
      475    20423    3               CALL CHKEOB ALTRET(NOBUF);
      476    20424    3               %KV_MRD.DVCCLM = 1;
      477    20425    3               %KV_MRD.DVCLIN=KV$USR_PST.PHSPST.LIN;
      478    20426    3               END;
      479    20427
      480    20428
      481    20429    2            K = KV$USR_PST.PHSPST.CLM - %KV_MRD.DVCCLM;
      482    20430    3            DO WHILE (K < 0);
      483    20431
      484    20432                    /* If overprint finish preceeding record with upspace 0
      485    20433                       and set column pointer back to one.                 */
      486    20434
      487    20435    3               IF KZ$LINCTX.PRO.PROTYP = %KLPT_HASP#
      488    20436    3                  OR KZ$LINCTX.PRO.PROTYP = %KLPT_NJE# THEN
      489    20437    4                  IF DVCTX.LASTSCBX > DVCTX.LASTRCBX + 3 THEN DO;
      490    20438    4                     KZ$HASPSRCB(DVCTX.LASTRCBX+1) = '80'X;
      491    20439    4                     CALL ENDSTR;
      492    20440    4                     END;
      493    20441    3                  ELSE;
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:17   
      494    20442    3               ELSE
      495    20443    4                  IF BYTX > DVCTX.LASTRCBX + 2 THEN DO;
      496    20444    4                     I=0;
      497    20445    4                     CALL BLDUPSPCREC ALTRET(NOBUF);
      498    20446    4                     END;
      499    20447    3                  ELSE;
      500    20448    3               %KV_MRD.DVCCLM = 1;
      501    20449    3               K = KV$USR_PST.PHSPST.CLM - 1;
      502    20450    3               END;
      503    20451    3            DO WHILE (K > 0);
      504    20452    3               IF K > 31 THEN
      505    20453    3                  I = 31;
      506    20454    3               ELSE
      507    20455    3                  I = K;
      508    20456    3               IF KZ$LINCTX.PRO.COMPRESS = %KLCO_NO# OR
      509    20457    4                  KZ$LINCTX.PRO.PROTYP = %KLPT_2780# THEN DO;
      510    20458    5                  IF J < I+5 THEN DO;
      511    20459    5                     CALL DONE ALTRET(NOBUF);
      512    20460    5                     CALL CMPBYTSIZ;
      513    20461    5                     END;
      514    20462    5                  DO L = 1 TO I;
      515    20463    5                     BYT(BYTX) = ASCBIT(%KV_MVD.TRNTBL$->KV$TRNTBL.SP_CHR);
      516    20464    5                     BYTX = BYTX + 1;
      517    20465    5                     END;
      518    20466    4                  IF KZ$LINCTX.PRO.PROTYP = %KLPT_HASP#
      519    20467    5                     OR KZ$LINCTX.PRO.PROTYP = %KLPT_NJE# THEN DO;
      520    20468    5                     J=J-I-1;
      521    20469    5                     CALL SET_SCB;
      522    20470    5                     DVCTX.LASTSCBX = BYTX;
      523    20471    5                     BYTX = BYTX + 1;
      524    20472    5                     END;
      525    20473    5                  ELSE DO;
      526    20474    5                     J=J-I;
      527    20475    5                     END;
      528    20476    4                  END;
      529    20477    4               ELSE DO;
      530    20478    4                  IF KZ$LINCTX.PRO.PROTYP = %KLPT_HASP#
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:18   
      531    20479    5                     OR KZ$LINCTX.PRO.PROTYP = %KLPT_NJE# THEN DO;
      532    20480
      533    20481                          /* Set ~END + char count                         */
      534    20482
      535    20483    5                     KZ$HASPSCB(DVCTX.LASTSCBX) = '80'X|BINBIT(I,8);
      536    20484    5                     J = J - 1;
      537    20485    5                     DVCTX.LASTSCBX = DVCTX.LASTSCBX + 1;
      538    20486    5                     BYTX = BYTX + 1;
      539    20487    5                     END;
      540    20488    5                  ELSE DO;
      541    20489    5                     BYT(BYTX) = '1D'X;
      542    20490    5                     BYT(BYTX+1) = '40'X | BINBIT(I,8);
      543    20491    5                     J = J - 2;
      544    20492    5                     BYTX = BYTX +2;
      545    20493    5                     END;
      546    20494    4                  END;
      547    20495    3               K = K - I;
      548    20496    3               END;
      549    20497
      550    20498
      551    20499
      552    20500    2            CALL CHKEOB ALTRET(NOBUF);
      553    20501    2            %KV_MRD.DVCCLM = KV$USR_PST.PHSPST.CLM;
      554    20502    2            IF ( KZ$LINCTX.PRO.PROTYP = %KLPT_HASP#
      555    20503    2               OR KZ$LINCTX.PRO.PROTYP = %KLPT_NJE# )
      556    20504    2               AND BYTSIZ > 63 THEN
      557    20505    2               BYTSIZ = 63;
      558    20506        %EJECT;
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:19   
      559    20507                    /* Request Input Data                                  */
      560    20508    2          CASE(%KV_USR_FNC_RQSDAT);
      561    20509
      562    20510        /*D*     When function is KV_USR_FNC_RQSDAT, VDH is setting the
      563    20511                 USRRQSDAT.RED flag as he is ready to accept more input data.
      564    20512                                                                           */
      565    20513
      566    20514                    /* Process the items on the defer list  */
      567    20515    2            CALL KZR$DFR(DVCTX);
      568    20516        %EJECT;
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:20   
      569    20517                          /* Event                                         */
      570    20518    2          CASE(%KV_USR_FNC_EVT);
      571    20519    3            DO CASE(KV$USR_EVT.ID);
      572    20520
      573    20521
      574    20522                       /* Logon accepted                                   */
      575    20523
      576    20524    3             CASE(%KV_USR_EVT_ID_LGNACP);
      577    20525
      578    20526    3               KZ_HASP_HDR.STTBFR$->KZ$SYNCSTAT.ACTSTR = KZ_HASP_HDR.STTBFR$->
             20526                        KZ$SYNCSTAT.ACTSTR+1;
      579    20527    3               DVCTX.STATE=%KZ_S_SCONNECTED#;
      580    20528
      581    20529    4               IF DVCTX.MGR_TYPE = %KZ_S_DMCONSOLE# THEN DO;
      582    20530
      583    20531                          /* Build an output context block for the console */
      584    20532
      585    20533    4                  SZ = SIZEW(DVCTX);
      586    20534    4                  CALL KVB$GETSYS (SZ,BFR$) ALTRET(NOBUF);
      587    20535
      588    20536                       /* Consoles are initially open and have PTS */
      589    20537
      590    20538    4                  DVCTX.SUSBIT_MASK = '0040'X;
      591    20539    4                  DVCTX.STATE = %KZ_S_SOPEN#;
      592    20540    4                  BFR$->DVCTX = DVCTX; /* Copy Input context */
      593    20541    4                  BFR$->DVCTX.LNK$ = DVCTX.LNK$;
      594    20542    4                  DVCTX.LNK$ = BFR$; /* Link onto Input  */
      595    20543    5                  IF KZ$LINCTX.PRO.PROTYP = %KLPT_NJE# THEN DO;
      596    20544    5                     BFR$->DVCTX.RCB_CODE = '9A'X;
      597    20545    5                     DVCTX.RCB_CODE = '9A'X;
      598    20546    5                     END;
      599    20547    5                  ELSE DO;
      600    20548    6                     IF KZ$LINCTX.PRO.SLAVE THEN DO;
      601    20549    6                        BFR$->DVCTX.RCB_CODE = '92'X;
      602    20550    6                        DVCTX.RCB_CODE = '91'X;
      603    20551    6                        END;
      604    20552    6                     ELSE DO;
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:21   
      605    20553    6                        BFR$->DVCTX.RCB_CODE = '91'X;
      606    20554    6                        DVCTX.RCB_CODE = '92'X;
      607    20555    6                        END;
      608    20556    5                     END;
      609    20557
      610    20558                       /* Initialize Input context block  */
      611    20559
      612    20560    4                  DVCTX.FLAGS.PTS_IN = '1'B;
      613    20561    4                  BFR$->DVCTX.FLAGS.PTS_OUT = '1'B;
      614    20562    4                  BFR$->DVCTX.FLAGS.SUSPEND_OUT = '0'B;
      615    20563    4                  BFR$=ADDR(NIL);
      616    20564
      617    20565    4                  KZ_HASP_HDR.STTBFR$->KZ$SYNCSTAT.ACTSTR = KZ_HASP_HDR.STTBFR$->
             20565                           KZ$SYNCSTAT.ACTSTR+1;
      618    20566
      619    20567    4                  END;
      620    20568
      621    20569    3   CTLGNS:     KZ$LINCTX.POLSIZ = KZ$LINCTX.POLSIZ-1;
      622    20570    4               IF KZ$LINCTX.POLSIZ = 0 AND KZ$LINCTX.POLX ~= 0 THEN DO;
      623    20571
      624    20572                       /* All devices have been logged on.  If a logon reject
      625    20573                          occured, kill the line.                          */
      626    20574
      627    20575    4                  IF KZ$LINCTX.FLAGS.RJCT THEN
      628    20576    4                     CALL REPCLMEVT (%KZ#CLM_EVENT_KILLED);
      629    20577    5                  ELSE DO;
      630    20578    6                     IF KZ$LINCTX.PRO.RMTSS$ ~= ADDR(NIL) THEN DO;
      631    20579                          /* Build a SIGNON record as first record to send */
      632    20580    6                        IF DVCTX.MGR_TYPE = %KZ_S_DMCONSOLE# THEN
      633    20581    6                           DCTX$ = DVCTX.LNK$;
      634    20582    6                        CALL GET_BFR ALTRET(NOBUF);
      635    20583    6                        %KV_MRD.MINSP_FORPST = 0;
      636    20584    6                        %KV_VDI.OTPBFR_.ADR$ = BFR$;
      637    20585    6                        IF KZ$LINCTX.PRO.PROTYP = %KLPT_HASP#
      638    20586    7                           OR KZ$LINCTX.PRO.PROTYP = %KLPT_NJE# THEN DO;
      639    20587    7                           TBFR$ = PINCRW(BFR$,SIZEW(KZ$OTPBFR));
      640    20588    8                           IF KZ$LINCTX.PRO.PROTYP = %KLPT_HASP# THEN DO;
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:22   
      641    20589    8                              TBFR$->KZ$HASPBLK.FLG = 'F0C1'X;
      642    20590    8                              %KV_VDI.OTPBFR_.BYTX = BYTX-1;
      643    20591    8                              %KV_VDI.OTPBFR_.BYTSIZ = 80;
      644    20592    8                              END;
      645    20593    8                           ELSE DO;
      646    20594        /*                        SGN_NJE$ = PINCRC(TBFR$,LENGTHC(KZ$HASPBLK.BCB)+LENGTHC(KZ
             20594        $HASPBLK.FCS));
      647    20595                                  SGN_NJE$->KZ$NJE_SIGNON = KZ_NJE_SIGNON;
      648    20596                                  SGN_NJE$->KZ$NJE_SIGNON.NCC.IREST = 100;
      649    20597                              SGN_NJE$->KZ$NJE_SIGNON.NCC.IBFSZ = KZ$LINCTX.PRO.BLKBYTES; */
      650    20598    8                              TBFR$->KZ$NJE_SIGNON = KZ_NJE_SIGNON;
      651    20599    8                              TBFR$->KZ$NJE_SIGNON.NCC.IREST = 100;
      652    20600    8                              TBFR$->KZ$NJE_SIGNON.NCC.IBFSZ = KZ$LINCTX.PRO.BLKBYTES;
      653    20601    8                              %KV_VDI.OTPBFR_.BYTX = BYTX-1+LENGTHC(KZ$NJE_SIGNON.NCC.
             20601                                       IDL);
      654    20602    8                              %KV_VDI.OTPBFR_.BYTSIZ = LENGTHC(KZ$NJE_SIGNON.NCC.INODE)
             20602                                       ;
      655    20603    8                              END;
      656    20604    7                           KZ$LINCTX.CURDEV$ = ADDR(KZ$LINCTX.CTRHD$);
      657    20605    8                           DO WHILE KZ$LINCTX.CURDEV$->DVCTX.LNK$ ~= DCTX$;
      658    20606    8                              KZ$LINCTX.CURDEV$ = KZ$LINCTX.CURDEV$->DVCTX.LNK$;
      659    20607    8                              END;
      660    20608    7                           END;
      661    20609    7                        ELSE DO;
      662    20610    7                           %KV_VDI.OTPBFR_.BYTX = SIZEC(KZ$OTPBFR);
      663    20611    7                           %KV_VDI.OTPBFR_.BYTSIZ = 80;
      664    20612    7                           BYTX = SIZEC(KZ$OTPBFR);
      665    20613    7                           KZ$OTPBFR.FLAGS.LAST# = '1'B;
      666    20614    7                           KZ$LINCTX.FLAGS.SND = '1'B;
      667    20615    7                           KZ$LINCTX.CURDEV$ = DCTX$;
      668    20616    7                           END;
      669    20617    6                        DVCTX.LASTSCBX = BYTX-2; /* fake out FNC_PST */
      670    20618    6                        %KV_MRD.DVCCLM = 1;
      671    20619    6                        %KV_SRD.VRTPSTOK = '1'B;
      672    20620    6                        KV$VDH_OTPLCL = KV_VDH_OTPLCL;
      673    20621    6                        KV$VDH_OTPLCL.BFR_.ADR$ = KZ$LINCTX.PRO.RMTSS$;
      674    20622    6                        KV$VDH_OTPLCL.BFR_.BYTSIZ = %KV_VDI.OTPBFR_.BYTSIZ;
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:23   
      675    20623    6                        CALL KVV$VDI (KV$VDH_OTPLCL);
      676    20624    7                        IF KZ$LINCTX.PRO.PROTYP = %KLPT_NJE# THEN DO;
      677    20625    7                           KZ$OTPBFR.DATA_SIZ = LENGTHC(KZ$NJE_SIGNON);
      678    20626    7                           DVCTX.LASTRCBX = BYTX+LENGTHC(KZ$NJE_SIGNON.NCC);
      679    20627    7                           END;
      680    20628    7                        ELSE DO;
      681    20629    7                           KZ$OTPBFR.DATA_SIZ = LENGTHC(KZ$HASPBLK)+80-1;
      682    20630    7                           DVCTX.LASTRCBX = BYTX+80;
      683    20631    7                           END;
      684    20632    6                        DVCTX.LASTSCBX = DVCTX.LASTRCBX+2;
      685    20633    6                        BYTX = DVCTX.LASTSCBX+1;
      686    20634    6                        %KV_VDI.OTPBFR_.BYTX = BYTX;
      687    20635    6                        %KV_VDI.OTPBFR_.BYTSIZ = 4;
      688    20636    6                        CALL KVV$VDI (KV_VDH_PST_CR_VRT); /* Position back to col 1 */
      689    20637                             %KV$CMPOTP;
             20642    7           IF KV$PTR.VDI$->KV$VDI.OTPCNDPND THEN DO;
             20643    7              CALL KVV$VDI(KV_VDH_EVT_CMPOTP);
             20644    7              END;                         /* END IF                             */
      690    20646    7                        IF KZ$LINCTX.PRO.PROTYP = %KLPT_NJE# THEN DO;
      691    20647                             /* For NJE, we don't know whether we'll need a type-I or
      692    20648                                a type-J record (or both!) at this point.  We'll save
      693    20649                                the type-I we made above back in the old RMTSS$ space,
      694    20650                                and send it off as an I and/or J later. */
      695    20651        /*                      KZ$LINCTX.PRO.RMTSS$->KZ$NJE_SIGNON = SGN_NJE$->KZ$NJE_SIGNO
             20651        N; */
      696    20652    7                           KZ$LINCTX.PRO.RMTSS$->KZ$NJE_SIGNON = TBFR$->KZ$NJE_SIGNON;
      697    20653    7                           SZ = KZ$OTPBFR.BFRSIZ;
      698    20654    7                           CALL INIT_BFR;
      699    20655    7                           END;
      700    20656    7                        ELSE DO;
      701    20657    7                           CALL QSGNON_BFR;
      702    20658    7                           BFR$ = ADDR(NIL);
      703    20659    7                           END;
      704    20660    6                        END; /* SIGNON string stuff */
      705    20661    5                     CALL REPCLMEVT (%KZ#CLM_EVENT_LGNCMP);
      706    20662    5                     END;
      707    20663    4                  %KV_MRD.MINSP_FORPST=KZD_MINSP_FORPST;
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:24   
      708    20664    4                  END;
      709    20665        %EJECT;
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:25   
      710    20666                          /* Logon reject                                  */
      711    20667
      712    20668    3             CASE(%KV_USR_EVT_ID_LGNRJC);
      713    20669
      714    20670                          /* Logon reject is error-logged                             */
      715    20671
      716    20672    3               FPT_WRSYSLOG=FPT@WRSYSLOG;
      717    20673    3               FPT_WRSYSLOG.V.ERRCODE.ERR# = %E$RBTLGNRJC;
      718    20674    3               FPT_WRSYSLOG.V.TERMID=KZ$LINCTX.LINID;
      719    20675    3               FPT_WRSYSLOG.V.VALUES(0) = KV$USR_EVT.PRM;
      720    20676    3               FPT_WRSYSLOG.BUF_=VECTOR(DVCTX.LCLENDPNTID);
      721    20677    3               CALL KHA$ERRLOG (FPT_WRSYSLOG);
      722    20678
      723    20679        /*E*  ERROR:        KZD-E$RBTLGNRJC-7
      724    20680              MESSAGE:      Logon reject, V(0)=reason, Data=termid.
      725    20681              DESCRIPTION:  VDH reported LGNRJC.  The reason, from KV_REASON_C
      726    20682                            is in VALUES(0), and the device TERMID is in the
      727    20683                            data buffer.                                   */
      728    20684
      729    20685                    /* Set reject flag and go count logon accepts/rejects so
      730    20686                       that logon can complete.                            */
      731    20687
      732    20688    3               KZ$LINCTX.FLAGS.RJCT='1'B;
      733    20689    3               GOTO CTLGNS;
      734    20690        %EJECT;
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:26   
      735    20691    3             CASE(%KV_USR_EVT_ID_OPN);
      736    20692
      737    20693                   /* Path has been opened                                 */
      738    20694
      739    20695    4               DO CASE( DVCTX.MGR_TYPE);
      740    20696    4                CASE(%KZ_S_DMOUTPUT# );
      741    20697    5                  DO CASE( DVCTX.STATE);
      742    20698
      743    20699                              /* Open Output                         */
      744    20700
      745    20701    5                   CASE(%KZ_S_SCONNECTED# );
      746    20702    5                     IF KZ$LINCTX.PRO.PROTYP = %KLPT_HASP#
      747    20703    6                        OR KZ$LINCTX.PRO.PROTYP = %KLPT_NJE# THEN DO;
      748    20704    6                        IF BFR$ = ADDR(NIL) THEN
      749    20705    6                           CALL GET_BFR ALTRET(NOBUF);
      750    20706
      751    20707                                /* Build Request PTS record      */
      752    20708
      753    20709    6                        KZ$OTPBFR.DATA_SIZ=SIZEC(KZ$HASPBLK)+1;
      754    20710    6                        CALL QCNTL_BFR;
      755    20711    6                        DVCTX.FLAGS.SUSPEND_IN = '0'B;
      756    20712    6                        DVCTX.FLAGS.SUSPEND_OUT = '0'B;
      757    20713    6                        BFR$ = PINCRW(BFR$,SIZEW(KZ$OTPBFR));
      758    20714    6                        BFR$->KZ$HASPBLK.FLG.RCB = '90'X;
      759    20715    6                        BFR$->KZ$HASPBLK.FLG.SRCB = DVCTX.RCB_CODE;
      760    20716    6                        BFR$->KZ$HASPBLK.TXT(0) = 0;
      761    20717    6                        BFR$->KZ$HASPBLK.TXT(1) = 0;
      762    20718    6                        BFR$ = ADDR(NIL);
      763    20719    6                        DVCTX.STATE = %KZ_S_SAWAITING_PTS#;
      764    20720    6                        END;
      765    20721    6                     ELSE DO;
      766    20722    6                        KZ$LINCTX.FLAGS.SND = '1'B;
      767    20723    6                        DVCTX.STATE = %KZ_S_SOPEN#;
      768    20724    6                        DVCTX.FLAGS.PTS_OUT = '1'B;
      769    20725    6                        DVCTX.FLAGS.FIRST ='1'B;
      770    20726    6                        END;
      771    20727    5                     %KV_MRD.DVCCLM=1;
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:27   
      772    20728    5                     %KV_SRD.VRTPSTOK='1'B;
      773    20729    5                   CASE(ELSE);
      774    20730    5                     IF DVCTX.STATE = %KZ_S_SCLS_AWAITING_PTS# THEN
      775    20731    5                        DVCTX.STATE = %KZ_S_SAWAITING_PTS#;
      776    20732    5                     ELSE
      777    20733    5                        GOTO BADSTATE;
      778    20734    5                   END;
      779    20735
      780    20736                              /* Open Input                           */
      781    20737
      782    20738    4                CASE(%KZ_S_DMINPUT# );
      783    20739    4                  IF DVCTX.STATE ~= %KZ_S_SAWAITING_PTS# THEN
      784    20740    4                     GOTO BADSTATE;
      785    20741    4                  IF KZ$LINCTX.PRO.PROTYP = %KLPT_HASP#
      786    20742    5                     OR KZ$LINCTX.PRO.PROTYP = %KLPT_NJE# THEN DO;
      787    20743    5                     IF BFR$ = ADDR(NIL) THEN
      788    20744    5                        CALL GET_BFR ALTRET(NOBUF);
      789    20745
      790    20746                             /* Build Grant PTS record */
      791    20747
      792    20748    5                     KZ$OTPBFR.DATA_SIZ=SIZEC(KZ$HASPBLK)+1;
      793    20749    5                     CALL QCNTL_BFR;
      794    20750    5                     BFR$ = PINCRW(BFR$,SIZEW(KZ$OTPBFR));
      795    20751    5                     BFR$->KZ$HASPBLK.FLG.RCB = 'A0'X;
      796    20752    5                     BFR$->KZ$HASPBLK.FLG.SRCB = DVCTX.RCB_CODE;
      797    20753    5                     BFR$->KZ$HASPBLK.TXT(0) = 0;
      798    20754    5                     BFR$->KZ$HASPBLK.TXT(1) = 0;
      799    20755    5                     BFR$ = ADDR(NIL);
      800    20756    5                     END;
      801    20757    4                  DVCTX.STATE = %KZ_S_SOPEN#;
      802    20758    4                  DVCTX.FLAGS.PTS_IN = '1'B;
      803    20759    4                  DVCTX.FLAGS.SUSPEND_IN = '0'B;
      804    20760    4                  DVCTX.FLAGS.SUSPEND_OUT = '0'B;
      805    20761    4                END;
      806    20762
      807    20763        %EJECT;
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:28   
      808    20764
      809    20765                          /* Close request                                            */
      810    20766
      811    20767    3             CASE(%KV_USR_EVT_ID_CLS);
      812    20768
      813    20769    4               DO CASE(DVCTX.MGR_TYPE);
      814    20770    4                CASE(%KZ_S_DMOUTPUT# );
      815    20771
      816    20772                          /* Close output device                                      */
      817    20773
      818    20774    5                  IF DVCTX.STATE = %KZ_S_SOPEN# THEN DO;
      819    20775    5                     IF BFR$ ~= ADDR(NIL) AND
      820    20776    5                        NOT KZ$LINCTX.PRO.RRR
      821    20777    6                     THEN DO;
      822    20778                             /* Not SECURE:  send remaining record with ETX. */
      823    20779    6                        KZ$OTPBFR.FLAGS.LAST# = '1'B;
      824    20780    6                        CALL SVPRM;
      825    20781                             %KV$CMPOTP;
             20786    7           IF KV$PTR.VDI$->KV$VDI.OTPCNDPND THEN DO;
             20787    7              CALL KVV$VDI(KV_VDH_EVT_CMPOTP);
             20788    7              END;                         /* END IF                             */
      826    20790    6                        CALL INITPRM;
      827    20791    6                        END;
      828    20792    6                     ELSE DO;
      829    20793    6                        CALL SVPRM;
      830    20794                             %KV$CMPOTP;
             20799    7           IF KV$PTR.VDI$->KV$VDI.OTPCNDPND THEN DO;
             20800    7              CALL KVV$VDI(KV_VDH_EVT_CMPOTP);
             20801    7              END;                         /* END IF                             */
      831    20803    6                        CALL INITPRM;
      832    20804                             /* Send zero-length record to signal EOF. */
      833    20805    6                        CALL BLDEOFRC ALTRET(NOBUF);
      834    20806    6                        END;
      835    20807    5                     DVCTX.STATE = %KZ_S_SCONNECTED#;
      836    20808    5                     END;
      837    20809    4                  ELSE
      838    20810    5                     IF DVCTX.STATE = %KZ_S_SAWAITING_PTS# THEN DO;
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:29   
      839    20811                             /* Device opened by host awaiting PTS.  Put
      840    20812                                it in AWAITING PTS which means closed by
      841    20813                                host, if permission shows up later, send
      842    20814                                EOF then.                              */
      843    20815    5                        DVCTX.STATE=%KZ_S_SCLS_AWAITING_PTS#;
      844    20816    5                        CALL DQ;
      845    20817    5                        CALL KZR$DFR(DVCTX);
      846    20818    6                        IF BFR$ ~= ADDR(NIL) THEN DO;
      847    20819    6                           KZ$OTPBFR.TYP = %KZ#BFRTYP_OTP;
      848    20820    6                           CALL KZR$RELOTPBFR(KZ$OTPBFR);
      849    20821    6                           BFR$ = ADDR(NIL);
      850    20822    6                           END;
      851    20823    5                        END;
      852    20824    5                     ELSE DO;
      853    20825    5                        GOTO BADSTATE;
      854    20826    5                        END;
      855    20827
      856    20828                           /* Close Input                                  */
      857    20829
      858    20830    4                CASE(%KZ_S_DMINPUT# );
      859    20831    4                  IF DVCTX.STATE = %KZ_S_SOPEN# OR
      860    20832    5                     DVCTX.STATE = %KZ_S_SAWAITING_CLOSE# THEN DO;
      861    20833    5                     IF KZ$LINCTX.PRO.PROTYP ~= %KLPT_HASP#
      862    20834    5                        AND KZ$LINCTX.PRO.PROTYP ~= %KLPT_NJE# THEN
      863    20835    5                        KZ$LINCTX.CURDEV$=ADDR(NIL);
      864    20836    5                     ELSE
      865    20837    6                        IF KZ$LINCTX.PRO.PROTYP = %KLPT_NJE# THEN DO;
      866    20838    6                           IF BFR$ = ADDR(NIL) THEN
      867    20839    6                              CALL GET_BFR ALTRET(NOBUF);
      868    20840
      869    20841                                   /* Build a Completed Stream record */
      870    20842
      871    20843    6                           KZ$OTPBFR.DATA_SIZ=SIZEC(KZ$HASPBLK)+1;
      872    20844    6                           CALL QCNTL_BFR;
      873    20845    6                           BFR$ = PINCRW(BFR$,SIZEW(KZ$OTPBFR));
      874    20846    6                           BFR$->KZ$HASPBLK.FLG.RCB = 'C0'X;
      875    20847    6                           BFR$->KZ$HASPBLK.FLG.SRCB = DVCTX.RCB_CODE;
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:30   
      876    20848    6                           BFR$->KZ$HASPBLK.TXT(0) = 0;
      877    20849    6                           BFR$->KZ$HASPBLK.TXT(1) = 0;
      878    20850    6                           BFR$ = ADDR(NIL);
      879    20851    6                           END;
      880    20852    6                     IF DVCTX.FLAGS.BRKRQD THEN DO;
      881    20853
      882    20854                                  /* Send an Attention event to indicate input
      883    20855                                     ready.                               */
      884    20856
      885    20857    6                        DVCTX.STATE = %KZ_S_SAWAITING_PTS#;
      886    20858    6                        KV$VDH_EVT=KV_VDH_EVT;
      887    20859    6                        KV$VDH_EVT.PRM=1;     /*BRK count */
      888    20860    6                        CALL KVV$VDI (KV$VDH_EVT);
      889    20861    6                        DVCTX.FLAGS.BRKRQD = '0'B;
      890    20862    6                        END;
      891    20863    5                     ELSE
      892    20864    5                        DVCTX.STATE = %KZ_S_SCONNECTED#;
      893    20865    5                     END;
      894    20866
      895    20867    4                END;
      896    20868        %EJECT;
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:31   
      897    20869                  /* Initiate disconnect                                   */
      898    20870
      899    20871    3             CASE(%KV_USR_EVT_ID_DSC);
      900    20872
      901    20873    3               IF NOT KZ$LINCTX.FLAGS.DSC THEN
      902    20874    3                  CALL REPCLMEVT (%KZ#CLM_EVENT_KILLED);
      903    20875        %EJECT;
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:32   
      904    20876                  /* VDH is ready to release VDI context                   */
      905    20877
      906    20878    3             CASE(%KV_USR_EVT_ID_RLSVDI);
      907    20879    3               DVCTX.DSC.VDH_FINAL = '1'B;
      908    20880    3               CALL DQ;
      909    20881    3               CALL KZR$DFR (DVCTX);
      910    20882    4               IF BFR$ ~= ADDR(NIL) THEN DO;
      911    20883    4                  I=KZ$OTPBFR.BFRSIZ;
      912    20884    4                  CALL KVB$RLS2NSYS (I,BFR$);
      913    20885    4                  END;
      914    20886                    /* Find the device context on the line chain           */
      915    20887    3               U$=ADDR(NIL);
      916    20888    3               T$= KZ$LINCTX.CTRHD$;
      917    20889    4               DO WHILE (T$ ~= DCTX$);
      918    20890    4                  U$ = T$;
      919    20891    4                  T$ = T$->DVCTX.LNK$;
      920    20892    4                  IF T$ = ADDR(NIL) THEN
      921    20893    4                     GOTO BADSTATE;
      922    20894    4                  END;
      923    20895    3               KZ_HASP_HDR.STTBFR$->KZ$SYNCSTAT.ACTSTR = KZ_HASP_HDR.STTBFR$->
             20895                        KZ$SYNCSTAT.ACTSTR-1;
      924    20896    3               KZ$LINCTX.CURDEV$=ADDR(NIL);
      925    20897    4               IF (DVCTX.MGR_TYPE = %KZ_S_DMCONSOLE#) THEN DO;
      926    20898    4                  KZ_HASP_HDR.STTBFR$->KZ$SYNCSTAT.ACTSTR = KZ_HASP_HDR.STTBFR$->
             20898                           KZ$SYNCSTAT.ACTSTR-1;
      927    20899    4                  T$ = DVCTX.LNK$;
      928    20900    5                  IF T$ ~= ADDR(NIL) THEN DO;
      929    20901    5                     DVCTX.LNK$=T$->DVCTX.LNK$;
      930    20902    5                     CALL KVB$RLS (SIZEW(DVCTX),T$);
      931    20903    5                     END;
      932    20904    4                  END;
      933    20905    3               CALL REPCLMEVT_DEV (%KZ#CLM_EVENT_DEVDSC);
      934    20906    3               IF U$ ~= ADDR(NIL) THEN
      935    20907    3                  U$->DVCTX.LNK$ = DVCTX.LNK$;
      936    20908    3               ELSE
      937    20909    3                  KZ$LINCTX.CTRHD$=DVCTX.LNK$;
      938    20910    3               CALL KVB$RLS (SIZEW(DVCTX),DCTX$);
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:33   
      939    20911    3               IF KZ$LINCTX.CTRHD$ = ADDR(NIL) THEN
      940    20912    3                  CALL REPCLMEVT (%KZ#CLM_EVENT_LINDSC);
      941    20913        %EJECT;
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:34   
      942    20914                  /* VDH is running at background level                    */
      943    20915
      944    20916    3             CASE(%KV_USR_EVT_ID_SCH);
      945    20917    3               CALL KZR$DFR(DVCTX);
      946    20918    3               IF DVCTX.DFR.DSCI THEN
      947    20919    3                  CALL KZR$DSC_CONT(DVCTX);
      948    20920    4               ELSE DO;
      949    20921    4                  IF DVCTX.STATE = %KZ_S_SCONNECTED# AND
      950    20922    5                     DVCTX.FLAGS.BRKRQD THEN DO;
      951    20923    5                     KV$VDH_EVT=KV_VDH_EVT;
      952    20924    5                     KV$VDH_EVT.PRM=1;
      953    20925    5                     CALL KVV$VDI (KV$VDH_EVT);
      954    20926    5                     DVCTX.FLAGS.BRKRQD='0'B;
      955    20927    5                     DVCTX.STATE = %KZ_S_SAWAITING_PTS#;
      956    20928    5                     END;
      957    20929    5                  IF DVCTX.DFR.EOFREC THEN DO;
      958    20930    5                     CALL BLDEOFRC;
      959    20931    5                     DVCTX.STATE = %KZ_S_SCONNECTED#;
      960    20932    5                     DVCTX.DFR.EOFREC = '0'B;
      961    20933    5                     END;
      962    20934    4                  END;
      963    20935
      964    20936    3             END /* Case */;
      965    20937    2          END FNC_CASE;
      966    20938        %EJECT;
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:35   
      967    20939                          /* Path time update                                         */
      968    20940
      969    20941    1   BADSTATE: ;
      970    20942              %ENABLE (DISLVL=LEV,INHLVL=KZ$LINCTX.INHLVL);
      971    20948    1         CALL SVPRM;
      972    20949
      973    20950    1         RETURN;
      974    20951
      975    20952              /*    Log "Out of MEMory" error and kill the line.    */
      976    20953
      977    20954    1   NOBUF:
      978    20955    1         FPT_WRSYSLOG=FPT@WRSYSLOG;
      979    20956    1         FPT_WRSYSLOG.V.ERRCODE.ERR# = %E$NOBFR;
      980    20957    1         FPT_WRSYSLOG.V.TERMID = KZ$LINCTX.LINID;
      981    20958    1         FPT_WRSYSLOG.V.VALUES (0) = SZ;
      982    20959    1         CALL KHA$ERRLOG (FPT_WRSYSLOG);
      983    20960        /*E*  ERROR:        KZD-E$NOBFR-6
      984    20961              MESSAGE:      Insufficient BISYNC MEMory (a NETCON parameter).
      985    20962              DESCRIPTION:  A KVB call ALTRETed to indicate that BISYNC is out of
      986    20963                            MEMory.  Since a necessary I/O buffer or device context
      987    20964                            could not be allocated, the HASP/2780/3780 TERMinal
      988    20965                            associated with the request has been disconnected.
      989    20966                            V0 = Size of buffer, in words, which could not be allocated.
      990    20967        */
      991    20968
      992    20969    1         CALL REPCLMEVT (%KZ#CLM_EVENT_KILLED);
      993    20970              /*  Zero out BYTSIZ so VDH won't continue to call us with output,
      994    20971                  or to call us asking for an output buffer.  */
      995    20972    1         BYTSIZ=0;
      996    20973    1         GOTO BADSTATE;
      997    20974
      998    20975        %EJECT;
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:36   
      999    20976        /*    Initialize from VDI data   */
     1000    20977
     1001    20978    1   INITPRM: PROC;
     1002    20979
     1003    20980    2         BFR$ = %KV_VDI.OTPBFR_.ADR$;
     1004    20981    2         BYTX = %KV_VDI.OTPBFR_.BYTX;
     1005    20982    2         BYTSIZ = %KV_VDI.OTPBFR_.BYTSIZ;
     1006    20983    2         DCTX$ = %KV_VDI.USRCTX$;
     1007    20984    2         LCTX$ = DVCTX.LIN$;
     1008    20985    2         IF KZ$LINCTX.PRO.PROTYP = %KLPT_3780# THEN
     1009    20986    2            IRS=KZ$LINCTX.PRO.IRSCHR;  /* Default '1E'X */
     1010    20987    2         ELSE
     1011    20988    2            IRS='1F'X;
     1012    20989    2         RETURN;
     1013    20990    2   END INITPRM;
     1014    20991
     1015    20992        /*    Save VDI parameters                                          */
     1016    20993
     1017    20994    1   SVPRM: PROC;
     1018    20995
     1019    20996    2         %KV_VDI.OTPBFR_.ADR$=BFR$;
     1020    20997    2         %KV_VDI.OTPBFR_.BYTX=BYTX;
     1021    20998    2         %KV_VDI.OTPBFR_.BYTSIZ=BYTSIZ;
     1022    20999    2         RETURN;
     1023    21000    2   END;
     1024    21001
     1025    21002        %EJECT;
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:37   
     1026    21003        /*D*  NAME: KZD$SNDSIGNON
     1027    21004              CALL:
     1028    21005                    CALL KZD$SNDSIGNON (KZ$SDVCTX);
     1029    21006              PARAMETER:
     1030    21007                    KZ$SDVCTX of the device to send the initial SIGNON
     1031    21008                    through.
     1032    21009              DESCRIPTION:
     1033    21010                    This entry places a I-type SIGNON response record on the
     1034    21011                    specified device's output queue.
     1035    21012                                                                           */
     1036    21013    1   KZD$SNDSIGNON: ENTRY (PARM) ALTRET;
     1037    21014    1         SGNITYPE = '1'B;
     1038    21015    1         GOTO SIGNON_COMMON;
     1039    21016
     1040    21017        /*D*  NAME: KZD$ACKSIGNON
     1041    21018              CALL:
     1042    21019                    CALL KZD$ACKSIGNON (KZ$SDVCTX);
     1043    21020              PARAMETER:
     1044    21021                    KZ$SDVCTX of the device to send the SIGNON acknowledgement
     1045    21022                    through.
     1046    21023              DESCRIPTION:
     1047    21024                    This entry places a J-type SIGNON response record on the
     1048    21025                    specified device's output queue.
     1049    21026                                                                           */
     1050    21027    1   KZD$ACKSIGNON: ENTRY (PARM) ALTRET;
     1051    21028    1         SGNITYPE = '0'B;
     1052    21029
     1053    21030    1   SIGNON_COMMON:
     1054    21031    1         DCTX$ = ADDR(PARM);
     1055    21032    1         IF DVCTX.MGR_TYPE = %KZ_S_DMCONSOLE# THEN
     1056    21033    1            DCTX$ = DVCTX.LNK$;
     1057    21034    1         LCTX$ = DVCTX.LIN$;
     1058    21035              %DISABLE (DISLVL=LEV,INHLVL=KZ$LINCTX.INHLVL);
     1059    21039    1         SZ = SIZEW(KZ$OTPBFR)+SIZEW(KZ$HASPBLK)+SIZEW(KZ$NJE_SIGNON);
     1060    21040    1         CALL KVB$GET2NSYS (SZ,SGN$) ALTRET(NOBUF);
     1061    21041    1         SGN$->KZ$OTPBFR = KZ_OTPBFR;
     1062    21042    1         SGN$->KZ$OTPBFR.BFRSIZ = SZ;
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:38   
     1063    21043    1         SGN$->KZ$OTPBFR.DEV$ = DCTX$;
     1064    21044        /*    SGN_NJE$ = ADDR(PINCRW(SGN$,SIZEW(KZ$OTPBFR))->KZ$HASPBLK.FLG.RCB); */
     1065    21045        /*    SGN_NJE$->KZ$NJE_SIGNON = KZ$LINCTX.PRO.RMTSS$->KZ$NJE_SIGNON; */
     1066    21046    1         SGN_NJE$ = PINCRW(SGN$,SIZEW(KZ$OTPBFR));
     1067    21047    1         SGN_NJE$->KZ$NJE_SIGNON = KZ$LINCTX.PRO.RMTSS$->KZ$NJE_SIGNON;
     1068    21048    2         IF SGNITYPE THEN DO;
     1069    21049              /* RMTSS$ points to an already-set-up I-type SIGNON */
     1070    21050    2            END;
     1071    21051    2         ELSE DO;
     1072    21052              /* Change RMTSS$'s I-type into a J-type */
     1073    21053        /*       SGN_NJE$->KZ$NJE_SIGNON.NCC.SRCB = 'D1'X; \* EBCDIC 'J' *\ */
     1074    21054        /*       SGN_NJE$->KZ$NJE_SIGNON.NCC.IEVNT = -1; */
     1075    21055    2            SGN_NJE$->KZ$NJE_SIGNON.NCC.SRCB = 'D1'X; /* EBCDIC 'J' */
     1076    21056    2            SGN_NJE$->KZ$NJE_SIGNON.NCC.IEVNT = -1;
     1077    21057    2            END;
     1078    21058        /*    SGN$->KZ$OTPBFR.DATA_SIZ = LENGTHC(KZ$NJE_SIGNON.NCC.IDL)+LENGTHC(KZ$HASPBLK.B
             21058        CB)+LENGTHC(KZ$HASPBLK.FCS); */
     1079    21059    1         SGN$->KZ$OTPBFR.DATA_SIZ = SGN_NJE$->KZ$NJE_SIGNON.NCC.IDL;
     1080    21060    1         BFR$ = SGN$;
     1081    21061    1         CALL QSGNON_BFR;
     1082    21062              %ENABLE (DISLVL=LEV,INHLVL=KZ$LINCTX.INHLVL);
     1083    21068    1         RETURN;
     1084    21069        %EJECT;
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:39   
     1085    21070        /*D*  NAME: KZD$TRNCOTPBLK
     1086    21071              CALL:
     1087    21072                    CALL KZD$TRNCOTPBLK;
     1088    21073              PARAMETER:
     1089    21074                    There is no parameter.  The context is specified by the
     1090    21075                    current VDI block.
     1091    21076              DESCRIPTION:
     1092    21077                    This entry places the current partially filled output block
     1093    21078                    on the output queue.
     1094    21079                                                                           */
     1095    21080
     1096    21081    1   KZD$TRNCOTPBLK: ENTRY ALTRET;
     1097    21082
     1098    21083    1         CALL INITPRM;
     1099    21084              %DISABLE (DISLVL=LEV,INHLVL=KZ$LINCTX.INHLVL);
     1100    21088    1         IF DVCTX.MGR_TYPE = %KZ_S_DMCONSOLE# THEN
     1101    21089    1            DCTX$ = DVCTX.LNK$;
     1102    21090              %KV$CMPOTP;
             21095    2           IF KV$PTR.VDI$->KV$VDI.OTPCNDPND THEN DO;
             21096    2              CALL KVV$VDI(KV_VDH_EVT_CMPOTP);
             21097    2              END;                         /* END IF                             */
     1103    21099    1         CALL INITPRM;
     1104    21100    1         IF DVCTX.MGR_TYPE = %KZ_S_DMCONSOLE# THEN
     1105    21101    1            DCTX$=DVCTX.LNK$;
     1106    21102    1         IF BYTX > SIZEC(KZ$OTPBFR)+SIZEC(KZ$HASPBLK) THEN
     1107    21103    1            GOTO OTPMRK0;
     1108    21104    1         GOTO BADSTATE;               /* Save VDI parameters and return */
     1109    21105
     1110    21106        %EJECT;
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:40   
     1111    21107
     1112    21108
     1113    21109        /*    Terminate output block.  Move any incomplete record to the
     1114    21110              beginning of the next output block.  ALTRET if unable to get
     1115    21111              the next output block.                                         */
     1116    21112
     1117    21113    1   DONE: PROC ALTRET;
     1118    21114
     1119    21115    2         IF ( ( KZ$LINCTX.PRO.PROTYP = %KLPT_HASP#
     1120    21116    2            OR KZ$LINCTX.PRO.PROTYP = %KLPT_NJE# )
     1121    21117    2            AND BYTX <= SIZEC(KZ$OTPBFR)+SIZEC(KZ$HASPBLK)+1 )
     1122    21118    3            OR BYTX <= SIZEC(KZ$OTPBFR)+1 THEN DO;
     1123    21119    4            IF KZ$OTPBFR.MRKCNT > 0 THEN DO;
     1124    21120    5               IF DVCTX.OTPHD$ = ADDR(NIL) AND NOT DVCTX.FLAGS.OTPBSY THEN DO;
     1125    21121    5                  KZ$OTPBFR.FLAGS.RELOTPBFR = '1'B;
     1126    21122    5                  CALL KZR$RELOTPBFR(KZ$OTPBFR);
     1127    21123    5                  END;
     1128    21124    4               ELSE
     1129    21125    4                  CALL QUEUE_BFR;
     1130    21126    4               CALL GET_BFR ALTRET(NOBUF);
     1131    21127    4               END;
     1132    21128    4            ELSE DO;
     1133    21129    4               SZ = KZ$OTPBFR.BFRSIZ;
     1134    21130    4               CALL INIT_BFR;
     1135    21131    4               END;
     1136    21132
     1137    21133    3            END;
     1138    21134    3         ELSE DO;
     1139    21135
     1140    21136    3   DONE1:
     1141    21137    3            SZ = SIZEW(KZ$OTPBFR)+(KZ$LINCTX.PRO.BLKBYTES+1)/2+2*SIZEW(KV$OTPMRK);
     1142    21138    3            CALL KVB$GET2NSYS (SZ,TBFR$) ALTRET(NOBUF);
     1143    21139    3            TBFR$->KZ$OTPBFR.BFRSIZ = SZ;
     1144    21140    3            J = BYTX - DVCTX.LASTRCBX;
     1145    21141    3            IF KZ$LINCTX.PRO.PROTYP = %KLPT_HASP#
     1146    21142    3               OR KZ$LINCTX.PRO.PROTYP = %KLPT_NJE# THEN
     1147    21143    4               IF J > 3 THEN DO;
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:41   
     1148    21144    4                  L=SIZEC(KZ$OTPBFR)+SIZEC(KZ$HASPBLK)-3;
     1149    21145    4                  GOTO DONE2;
     1150    21146    4                  END;
     1151    21147    3               ELSE
     1152    21148    3                  J=0;
     1153    21149    4            ELSE DO;
     1154    21150    4               L=SIZEC(KZ$OTPBFR);
     1155    21151    4               IF (DVCTX.ACCESS_METHOD = %KZ_S_ACSPRINT# AND
     1156    21152    4                  J > 2) OR
     1157    21153    4                  (DVCTX.ACCESS_METHOD = %KZ_S_ACSCARD# AND
     1158    21154    4                  J > 0) THEN
     1159    21155
     1160    21156                       /* Transfer from current buffer to new buffer   */
     1161    21157
     1162    21158    4   DONE2:         CALL INSERT(TBFR$->CHR1,
     1163    21159    4                     L,
     1164    21160    4                     J,
     1165    21161    4                     SUBSTR(BFR$->CHR1,
     1166    21162    4                     DVCTX.LASTRCBX,
     1167    21163    4                     J));
     1168    21164    4               ELSE
     1169    21165    4                  J=0;
     1170    21166    4               END;
     1171    21167    3            BYTX = DVCTX.LASTRCBX;
     1172    21168    3            IF KZ$LINCTX.PRO.PROTYP = %KLPT_HASP#
     1173    21169    3               OR KZ$LINCTX.PRO.PROTYP = %KLPT_NJE# THEN
     1174    21170    3               KZ$HASPRCB(BYTX) = '0'B; /* End of block RCB */
     1175    21171    3            ELSE
     1176    21172    3               IF KZ$LINCTX.PRO.PROTYP = %KLPT_2780# THEN
     1177    21173    3                  BYTX=BYTX-2;        /* Remove last .1F for MLCP */
     1178    21174    3               ELSE
     1179    21175    3                  BYTX=BYTX-1;
     1180    21176
     1181    21177    3            KZ$OTPBFR.DATA_SIZ=BYTX-SIZEC(KZ$OTPBFR)+1;
     1182    21178    3            KZ$OTPBFR.FLAGS.CNT# = '1'B;
     1183    21179    4            IF KZ$OTPBFR.DATA_SIZ > 0 THEN DO;
     1184    21180    4               DVCTX.FLAGS.FIRST ='0'B;  /*Shipping first block       */
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:42   
     1185    21181
     1186    21182                    /* Throttle on block size to avoid eating up memory with
     1187    21183                       devices that have only one short record per block.   */
     1188    21184
     1189    21185    4               DVCTX.OTPBYTES = DVCTX.OTPBYTES + KZ$LINCTX.PRO.BLKBYTES;
     1190    21186    4               END;
     1191    21187    3            IF DVCTX.OTPBYTES >= KZ$LINCTX.CHN$->KH$CHN.BLOCK AND
     1192    21188    4               NOT DVCTX.FLAGS.THROTL THEN DO;
     1193    21189    4               DVCTX.FLAGS.THROTL = '1'B;
     1194    21190                       %KV$RQSOTP(RQSOTP = NO);   /* Stop output */
             21196    5           IF KV$PTR.VDI$->KV$VDI.RQSOTP THEN DO;
             21197    5              KV$PTR.VDI$->KV$VDI.RQSOTP = '0'B;
             21198    5              IF KV$PTR.VDI$->KV$VDI.SSNCNT>1
             21199    5              THEN CALL KVV$VDI (KV_VDH_EVT_RQSOTP);
             21200    5              END;
     1195    21208
     1196    21209    4               END;
     1197    21210
     1198    21211    3            CALL QUEUE_BFR;
     1199    21212
     1200    21213    3            BFR$ = TBFR$;
     1201    21214    3            SZ = KZ$OTPBFR.BFRSIZ;
     1202    21215    3            CALL INIT_BFR;
     1203    21216    4            IF J ~= 0 THEN DO;
     1204    21217    4               BYTX = DVCTX.LASTRCBX+J;
     1205    21218    4               DVCTX.LASTSCBX = BYTX -1;
     1206    21219    4               CALL CMPBYTSIZ;
     1207    21220    4               IF ( KZ$LINCTX.PRO.PROTYP = %KLPT_HASP#
     1208    21221    4                  OR KZ$LINCTX.PRO.PROTYP = %KLPT_NJE# )
     1209    21222    4                  AND J > 63 THEN
     1210    21223    4                  BYTSIZ=63;
     1211    21224    4               ELSE
     1212    21225    4                  BYTSIZ=J;
     1213    21226    4               END;
     1214    21227
     1215    21228    3            END;
     1216    21229    2         RETURN;
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:43   
     1217    21230
     1218    21231        /*    Send off block ending in EOF record.                        */
     1219    21232
     1220    21233    2   DONE_EOF: ENTRY ALTRET;
     1221    21234    2         GOTO DONE1;
     1222    21235
     1223    21236    2   NOBUF: ALTRETURN;
     1224    21237    2   END;
     1225    21238        %EJECT;
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:44   
     1226    21239        /*    Get an output buffer.  ALTRET if none available.            */
     1227    21240
     1228    21241    1   GET_BFR: PROC ALTRET;
     1229    21242
     1230    21243    2         SZ = SIZEW(KZ$OTPBFR)+(KZ$LINCTX.PRO.BLKBYTES+1)/2+2*SIZEW(KV$OTPMRK);
     1231    21244    2         CALL KVB$GET2NSYS (SZ,BFR$) ALTRET(NOBUF);
     1232    21245
     1233    21246    2   INIT_BFR: ENTRY ALTRET;
     1234    21247
     1235    21248    2         KZ$OTPBFR = KZ_OTPBFR;
     1236    21249    2         KZ$OTPBFR.BFRSIZ = SZ;
     1237    21250    2         KZ$OTPBFR.DEV$ = DCTX$;
     1238    21251    2         DVCTX.BLKRECS=KZ$LINCTX.PRO.BLKRECS;
     1239    21252    2         IF KZ$LINCTX.PRO.PROTYP = %KLPT_HASP#
     1240    21253    3            OR KZ$LINCTX.PRO.PROTYP = %KLPT_NJE# THEN DO;
     1241    21254    3            BYTX = SIZEC(KZ$OTPBFR)+SIZEC(KZ$HASPBLK);
     1242    21255    3            BYTSIZ = 63;
     1243    21256    3            DVCTX.LASTSCBX=BYTX-1;
     1244    21257    3            DVCTX.LASTRCBX=BYTX-3;
     1245    21258    3            END;
     1246    21259    3         ELSE DO;
     1247    21260    3            DVCTX.LASTRCBX=SIZEC(KZ$OTPBFR);
     1248    21261    3            IF KZ$LINCTX.PRO.SLAVE THEN
     1249    21262    3               BYTX = DVCTX.LASTRCBX;
     1250    21263    4            ELSE DO;
     1251    21264    4               IF KZ$LINCTX.PRO.SLC AND
     1252    21265    5                  (DVCTX.FLAGS.FIRST OR KZ$LINCTX.PRO.SLCALLBLK) THEN DO;
     1253    21266    6                  IF KZ$LINCTX.PRO.PROTYP = %KLPT_3780# THEN DO;
     1254    21267    6                     IF DVCTX.ACCESS_METHOD = %KZ_S_ACSCARD# THEN
     1255    21268    6                        BYT(SIZEC(KZ$OTPBFR)) = KZ_SLCCHR3780PNC1 /* Default '12'X */;
     1256    21269    6                     ELSE
     1257    21270    6                        BYT(SIZEC(KZ$OTPBFR)) = KZ_SLCCHR3780PRN /* Default '11'X */;
     1258    21271    6                     DVCTX.LASTRCBX = SIZEC(KZ$OTPBFR)+1;
     1259    21272    6                     END;
     1260    21273    6                  ELSE DO;
     1261    21274    7                     IF DVCTX.ACCESS_METHOD = %KZ_S_ACSCARD# THEN DO;
     1262    21275    7                        BYT(SIZEC(KZ$OTPBFR)) = '27'X;
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:45   
     1263    21276    7                        BYT(SIZEC(KZ$OTPBFR)+1) = KZ_SLCCHR2780PNC /* Default 'F4'X */;
     1264    21277    7                        DVCTX.LASTRCBX = SIZEC(KZ$OTPBFR)+2;
     1265    21278    7                        END;
     1266    21279    6                     END;
     1267    21280    5                  END;
     1268    21281    4               IF DVCTX.ACCESS_METHOD = %KZ_S_ACSCARD# THEN
     1269    21282    4                  BYTX = DVCTX.LASTRCBX;
     1270    21283    4               ELSE
     1271    21284    4                  BYTX = DVCTX.LASTRCBX+2;
     1272    21285    4               END;
     1273    21286                 /*  To calculate the number of bytes available in the
     1274    21287                     current output block being built, the total number
     1275    21288                     of bytes in the block is decremented by BYTX (the
     1276    21289                     index of the byte into which the next output character
     1277    21290                     would go, if room were available) minus the size of
     1278    21291                     the KZ$OTPBFR structure (since BYTX includes this size,
     1279    21292                     i.e., BYTX is initially set to SIZEC(KZ$OTPBFR)).
     1280    21293                     Since HASP blocks will also be sent with DLE-STX as
     1281    21294                     their first two bytes (added by the MLCP), an additional
     1282    21295                     2 bytes is subtracted for HASP/NJE.  */
     1283    21296    3            BYTSIZ = KZ$LINCTX.PRO.BLKBYTES-(BYTX-SIZEC(KZ$OTPBFR));
     1284    21297    3            IF KZ$LINCTX.PRO.PROTYP = %KLPT_HASP#
     1285    21298    3               OR KZ$LINCTX.PRO.PROTYP = %KLPT_NJE# THEN
     1286    21299    3               BYTSIZ = BYTSIZ - 3;
     1287    21300    3            IF BYTSIZ < 0 THEN
     1288    21301    3               BYTSIZ = 0;
     1289    21302    3            END;
     1290    21303    2         RETURN;
     1291    21304    2   NOBUF: ALTRETURN;
     1292    21305    2   END;
     1293    21306
     1294    21307        /*    Add a block to the device output queue.
     1295    21308                 Set device PTS_OUT to insure it can be selected for output.
     1296    21309                 Set LAST to cause PTS_OUT to be reset after its selected. */
     1297    21310
     1298    21311
     1299    21312    1   QCNTL_BFR: PROC;
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:46   
     1300    21313
     1301    21314    2         KZ$OTPBFR.FLAGS.HALT='1'B;
     1302    21315
     1303    21316    2   QSGNON_BFR: ENTRY;
     1304    21317
     1305    21318    2         DVCTX.FLAGS.PTS_OUT='1'B;
     1306    21319    2   QUEUE_BFR: ENTRY;
     1307    21320
     1308    21321    2         IF DVCTX.OTPHD$=ADDR(NIL) THEN
     1309    21322    2            DVCTX.OTPHD$=BFR$;
     1310    21323    2         ELSE
     1311    21324    2            DVCTX.OTPTL$->KZ$OTPBFR.LNK$=BFR$;
     1312    21325    2         DVCTX.OTPTL$ = BFR$;
     1313    21326    2         KZ$OTPBFR.LNK$=ADDR(NIL);
     1314    21327    2         DVCTX.LINE_RECORDS_OUT=DVCTX.LINE_RECORDS_OUT+1;
     1315    21328    2         DVCTX.LINE_BYTES_OUT=DVCTX.LINE_BYTES_OUT+KZ$OTPBFR.DATA_SIZ;
     1316    21329    2         RETURN;
     1317    21330    2   END QCNTL_BFR;
     1318    21331
     1319    21332
     1320    21333        /*    Compute bytes remaining in output block                      */
     1321    21334
     1322    21335    1   CMPBYTSIZ: PROC;
     1323    21336
     1324    21337
     1325    21338              /*  See comments in GET_BFR where BYTSIZ is calculated.  */
     1326    21339    2         J = KZ$LINCTX.PRO.BLKBYTES-(BYTX-SIZEC(KZ$OTPBFR))-4;
     1327    21340    2         IF KZ$LINCTX.PRO.PROTYP = %KLPT_HASP#
     1328    21341    2            OR KZ$LINCTX.PRO.PROTYP = %KLPT_NJE# THEN
     1329    21342    2            J = J - 3;
     1330    21343    2         IF J < 0 THEN
     1331    21344    2            J = 0;
     1332    21345    2         RETURN;
     1333    21346    2   END CMPBYTSIZ;
     1334    21347
     1335    21348        /*    Note end of HASP string.  Make zero SCB and set indices.  */
     1336    21349
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:47   
     1337    21350    1   ENDSTR: PROC;
     1338    21351
     1339    21352    2         KZ$HASPRCB(DVCTX.LASTRCBX) = DVCTX.RCB_CODE;
     1340    21353    2         DVCTX.HOST_RECORDS_OUT=DVCTX.HOST_RECORDS_OUT+1;
     1341    21354    2         DVCTX.HOST_BYTES_OUT=DVCTX.HOST_BYTES_OUT+(DVCTX.LASTSCBX-DVCTX.LASTRCBX);
     1342    21355    2         KZ$HASPSCB(DVCTX.LASTSCBX)='0'B;
     1343    21356    2         DVCTX.LASTRCBX=DVCTX.LASTSCBX+1;
     1344    21357    2         DVCTX.LASTSCBX=DVCTX.LASTSCBX+3;
     1345    21358    2         BYTX=DVCTX.LASTSCBX+1;
     1346    21359    2         RETURN;
     1347    21360    2   END ENDSTR;
     1348    21361
     1349    21362        /*    Finish current output buffer.                                */
     1350    21363
     1351    21364    1   FINOTPBFR: PROC ALTRET;
     1352    21365
     1353    21366              /* Have VDH complete output, (positioning).  */
     1354    21367
     1355    21368    2         CALL SVPRM;
     1356    21369              %KV$CMPOTP;
             21374    3           IF KV$PTR.VDI$->KV$VDI.OTPCNDPND THEN DO;
             21375    3              CALL KVV$VDI(KV_VDH_EVT_CMPOTP);
             21376    3              END;                         /* END IF                             */
     1357    21378    2         CALL INITPRM;
     1358    21379    2         IF DVCTX.MGR_TYPE = %KZ_S_DMCONSOLE# THEN
     1359    21380    2            DCTX$=DVCTX.LNK$;
     1360    21381
     1361    21382        /*
     1362    21383              Finish the output without forcing VDH to complete.  Used to
     1363    21384              make record span blocks if its too large to fit in one block.
     1364    21385        */
     1365    21386
     1366    21387    2   FINOTPBF2: ENTRY ALTRET;
     1367    21388
     1368    21389    2         %KV_MRD.DVCCLM = 1;
     1369    21390    2         IF KZ$LINCTX.PRO.PROTYP = %KLPT_HASP#
     1370    21391    3            OR KZ$LINCTX.PRO.PROTYP = %KLPT_NJE# THEN DO;
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:48   
     1371    21392    3            CALL SET_SCB;
     1372    21393    4            IF BYTX > DVCTX.LASTRCBX+2 THEN DO;
     1373    21394    4               BYT(BYTX) = '0'B; /* Last SCB   */
     1374    21395    4               BYTX = BYTX+1;
     1375    21396    4               KZ$HASPRCB(DVCTX.LASTRCBX)=DVCTX.RCB_CODE;
     1376    21397    4               KZ$HASPSRCB(DVCTX.LASTRCBX+1)='80'X; /* No space */
     1377    21398    4               DVCTX.LASTRCBX = BYTX;
     1378    21399    4               END;
     1379    21400    3            END;
     1380    21401    3         ELSE DO;
     1381    21402    3            J = BITBIN(KZ$LINCTX.PRO.SLAVE) + KZ$LINCTX.PRO.PROTYP*2;
     1382    21403    4            IF DVCTX.ACCESS_METHOD = %KZ_S_ACSPRINT# THEN DO;
     1383    21404    5               IF BYTX > DVCTX.LASTRCBX+2 THEN DO;
     1384    21405    5                  BYT(DVCTX.LASTRCBX)='27'X;
     1385    21406    5                  BYT(DVCTX.LASTRCBX+1)='D4'X;  /* esc M  */
     1386    21407    5                  GOTO FINOTP0;
     1387    21408    5                  END;
     1388    21409    4               ELSE;
     1389    21410    4               BYTX=DVCTX.LASTRCBX;
     1390    21411    4               END;
     1391    21412    4            ELSE DO;                  /* punch */
     1392    21413    5               IF BYTX = DVCTX.LASTRCBX THEN DO;
     1393    21414    5                  IF DVCTX.FLAGS.FIRST AND
     1394    21415    6                     DVCTX.LASTRCBX = SIZEC(KZ$OTPBFR)+ESCSZ(J) THEN DO;
     1395    21416    6                     BYTX=SIZEC(KZ$OTPBFR);
     1396    21417    6                     DVCTX.LASTRCBX=SIZEC(KZ$OTPBFR);
     1397    21418    6                     END;
     1398    21419    5                  END;
     1399    21420    5               ELSE DO;
     1400    21421    5                  IF KZ$LINCTX.PRO.PROTYP = %KLPT_2780# AND
     1401    21422    5                     (KZ$LINCTX.PRO.EMCHR ~= '0'B) AND
     1402    21423    6                     BYTX - DVCTX.LASTRCBX < 80 THEN DO;
     1403    21424    6                     BYT(BYTX)=KZ$LINCTX.PRO.EMCHR /* Default '19'X */;
     1404    21425    6                     BYTX=BYTX+1;
     1405    21426    6                     END;
     1406    21427    5   FINOTP0:       BYT(BYTX)=IRS;
     1407    21428    5                  BYTX=BYTX+1;
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:49   
     1408    21429    5                  DVCTX.LASTRCBX=BYTX;
     1409    21430    5                  END;
     1410    21431    4               END;
     1411    21432    3            END;
     1412    21433    2         CALL DONE ALTRET(NOBUF);
     1413    21434    2         RETURN;
     1414    21435    2   NOBUF: ALTRETURN;
     1415    21436    2   END;
     1416    21437
     1417    21438        /*    Put the appropriate esc-vfc characters into a 2780/3780 record.
     1418    21439              Make it a one blank character record if its empty.           */
     1419    21440
     1420    21441    1   BLDUPSPCREC: PROC ALTRET;
     1421    21442
     1422    21443              /* Select VFC character based on I.                         */
     1423    21444
     1424    21445    2         DVCTX.HOST_RECORDS_OUT=DVCTX.HOST_RECORDS_OUT+1;
     1425    21446    2         DVCTX.HOST_BYTES_OUT=DVCTX.HOST_BYTES_OUT+(BYTX-DVCTX.LASTRCBX);
     1426    21447    3         IF DVCTX.ACCESS_METHOD = %KZ_S_ACSPRINT# THEN DO;
     1427    21448    3            BYT(DVCTX.LASTRCBX) = '27'X; /* ESC      */
     1428    21449    3            BYT(DVCTX.LASTRCBX+1) = VFC(I);
     1429    21450    3            IF BYTX = DVCTX.LASTRCBX+2 THEN
     1430    21451    3               CALL BLDBLNKSTR ALTRET(NOBUF);
     1431    21452    3            BYT(BYTX)=IRS;
     1432    21453    3            DVCTX.LASTRCBX=BYTX+1;
     1433    21454    3            BYTX=BYTX+3;
     1434    21455    3            END;
     1435    21456    3         ELSE DO;
     1436    21457    3            IF BYTX = DVCTX.LASTRCBX THEN
     1437    21458    3               CALL BLDBLNKSTR ALTRET(NOBUF);
     1438    21459    3            IF KZ$LINCTX.PRO.PROTYP = %KLPT_2780# AND
     1439    21460    3               (KZ$LINCTX.PRO.EMCHR ~= '0'B) AND
     1440    21461    4               BYTX - DVCTX.LASTRCBX < 80 THEN DO;
     1441    21462    4               BYT(BYTX)=KZ$LINCTX.PRO.EMCHR /* Default '19'X */;
     1442    21463    4               BYTX=BYTX+1;
     1443    21464    4               END;
     1444    21465    3            BYT(BYTX)=IRS;
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:50   
     1445    21466    3            DVCTX.LASTRCBX=BYTX+1;
     1446    21467    3            BYTX=BYTX+1;
     1447    21468    3            END;
     1448    21469    2         DVCTX.BLKRECS=DVCTX.BLKRECS-1;
     1449    21470    2         IF DVCTX.BLKRECS = 0 THEN
     1450    21471    2            CALL DONE ALTRET(NOBUF);
     1451    21472    2         RETURN;
     1452    21473    2   NOBUF: ALTRETURN;
     1453    21474    2   END;
     1454    21475
     1455    21476        /*    Check space remaining and number of records in the block.   */
     1456    21477
     1457    21478    1   CHKEOB: PROC ALTRET;
     1458    21479
     1459    21480    2         CALL CMPBYTSIZ;
     1460    21481    2         BYTSIZ = J;
     1461    21482    3         IF BYTSIZ < 5 THEN DO;
     1462    21483    3            CALL DONE ALTRET(NOBUF);
     1463    21484    3            CALL CMPBYTSIZ;
     1464    21485    3            BYTSIZ = J;
     1465    21486    3            END;
     1466    21487    2         RETURN;
     1467    21488    2   NOBUF: ALTRETURN;
     1468    21489    2   END;
     1469    21490
     1470    21491
     1471    21492        /*    Set SCB to cleanup current HASP string                       */
     1472    21493
     1473    21494    1   SET_SCB: PROC;
     1474    21495
     1475    21496    3         IF BYTX - DVCTX.LASTSCBX > 1 THEN DO;
     1476    21497    3            IF BYTX-DVCTX.LASTSCBX > 64 THEN CALL M$XXX;
     1477    21498
     1478    21499                 /* Set ~END, ~IDENT and char count.                       */
     1479    21500
     1480    21501    3            KZ$HASPSCB(DVCTX.LASTSCBX)=BINBIT(BYTX-DVCTX.LASTSCBX-1,8)|'C0'X;
     1481    21502    3            END;
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:51   
     1482    21503    2         ELSE
     1483    21504    2            BYTX = DVCTX.LASTSCBX;
     1484    21505    2         RETURN;
     1485    21506    2   END SET_SCB;
     1486    21507
     1487    21508
     1488    21509        /*    Build string of one blank character                          */
     1489    21510
     1490    21511    1   BLDBLNKSTR: PROC ALTRET;
     1491    21512
     1492    21513
     1493    21514    3         IF J < 5 THEN DO;
     1494    21515    3            CALL DONE ALTRET(NOBUF);
     1495    21516    3            J = BYTSIZ;
     1496    21517    3            END;
     1497    21518    2         IF KZ$LINCTX.PRO.PROTYP = %KLPT_HASP#
     1498    21519    3            OR KZ$LINCTX.PRO.PROTYP = %KLPT_NJE# THEN DO;
     1499    21520    3            KZ$HASPSCB(DVCTX.LASTSCBX) = 'C1'X;
     1500    21521    3            KZ$HASPSCB(DVCTX.LASTSCBX+1) = ASCBIT(%KV_MVD.TRNTBL$->KV$TRNTBL.SP_CHR);
     1501    21522    3            DVCTX.LASTSCBX = DVCTX.LASTSCBX + 2;
     1502    21523    3            BYTX = DVCTX.LASTSCBX+1;
     1503    21524    3            END;
     1504    21525    3         ELSE DO;
     1505    21526    3            BYT(BYTX) = ASCBIT(%KV_MVD.TRNTBL$->KV$TRNTBL.SP_CHR);
     1506    21527    3            BYTX = BYTX+1;
     1507    21528    3            J = J-3;
     1508    21529    3            END;
     1509    21530    2         RETURN;
     1510    21531    2   NOBUF: ALTRETURN;
     1511    21532    2   END;
     1512    21533
     1513    21534        /*    Build a zero length record (EOF)                             */
     1514    21535
     1515    21536    1   BLDEOFRC: PROC ALTRET;
     1516    21537    2         IF BFR$ = ADDR(NIL) THEN
     1517    21538    2            CALL GET_BFR ALTRET(NOBUF);
     1518    21539
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:52   
     1519    21540    2   BLDEOF1: CALL CMPBYTSIZ;
     1520    21541    3         IF J < 2 THEN DO;
     1521    21542    3            CALL DONE ALTRET(NOBUF);
     1522    21543    3            J=BYTSIZ;
     1523    21544    3            GOTO BLDEOF1;
     1524    21545    3            END;
     1525    21546    2         IF KZ$LINCTX.PRO.PROTYP = %KLPT_HASP#
     1526    21547    3            OR KZ$LINCTX.PRO.PROTYP = %KLPT_NJE# THEN DO;
     1527    21548    3            CALL SET_SCB;
     1528    21549    3   BLDEOF2: BYT(BYTX) = '0'B;         /* Last SCB   */
     1529    21550    3            BYTX = BYTX+1;
     1530    21551    3            KZ$HASPRCB(DVCTX.LASTRCBX)=DVCTX.RCB_CODE;
     1531    21552    3            KZ$HASPSRCB(DVCTX.LASTRCBX+1)='80'X; /* No space */
     1532    21553    3            I = BYTX -DVCTX.LASTRCBX;
     1533    21554    3            DVCTX.LASTRCBX = BYTX;
     1534    21555    4            IF I > 3 THEN DO;
     1535    21556    4               BYTX = BYTX +2;
     1536    21557    4               GOTO BLDEOF2;
     1537    21558    4               END;
     1538    21559    3            KZ$OTPBFR.FLAGS.LAST#='1'B;
     1539    21560    3            CALL DONE_EOF ALTRET(NOBUF);
     1540    21561    3            END;
     1541    21562    3         ELSE DO;
     1542    21563    3            I=1;
     1543    21564    3            KZ$OTPBFR.FLAGS.LAST#='1'B;
     1544    21565    3            CALL BLDUPSPCREC ALTRET(NOBUF);
     1545    21566                 /*  If LAST# is reset, we've already sent the buffer.  */
     1546    21567    3            IF KZ$OTPBFR.FLAGS.LAST# THEN
     1547    21568    3               CALL DONE_EOF ALTRET(NOBUF);
     1548    21569    3            END;
     1549    21570    2         I=KZ$OTPBFR.BFRSIZ;
     1550    21571    2         CALL KVB$RLS2NSYS (I,BFR$); /* Release last buffer */
     1551    21572    2         BFR$=ADDR(NIL);
     1552    21573    2         RETURN;
     1553    21574    2   NOBUF: ALTRETURN;
     1554    21575    2   END;
     1555    21576
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:53   
     1556    21577
     1557    21578        /*    Report event to CLM                                          */
     1558    21579
     1559    21580    1   REPCLMEVT: PROC (EVENT);
     1560    21581
     1561    21582    2   DCL EVENT UBIN;
     1562    21583
     1563    21584    2   DCL P$ PTR;
     1564    21585
     1565    21586    2         P$=ADDR(KZ$LINCTX.LINID);
     1566    21587    2   REPCLM01: KZ$EVENT=KZ_EVENT;
     1567    21588    2         KZ$EVENT.TERMID$=P$;
     1568    21589    2         KZ$EVENT.EVENT=EVENT;
     1569    21590    2         KZ$EVENT.LINCTX$=LCTX$;
     1570    21591    2         CALL KZR_CNCDSC@ (KZ$EVENT);
     1571    21592    2         RETURN;
     1572    21593    2   REPCLMEVT_DEV: ENTRY (EVENT);
     1573    21594    2         P$=ADDR(DVCTX.LCLENDPNTID);
     1574    21595    2         GOTO REPCLM01;
     1575    21596    2   END;
     1576    21597
     1577    21598
     1578    21599        %EJECT;
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:54   
     1579    21600
     1580    21601        /*D*  NAME: KZD$BLDEOF
     1581    21602              CALL:
     1582    21603                    CALL KZD$BLDEOF (Device-context);
     1583    21604              PARAMETER:
     1584    21605                    Device-context is a device context block
     1585    21606              DESCRIPTION:
     1586    21607                    This procedure builds a zero length record indicating an
     1587    21608                    EOF, and adds it onto the device output queue.  It cannot
     1588    21609                    be called if VDH is building output records for the device,
     1589    21610                    that is, if the device state is OPEN.
     1590    21611                                                                           */
     1591    21612    1   KZD$BLDEOF: ENTRY (PARM) ALTRET;
     1592    21613
     1593    21614    1         DCTX$=ADDR(PARM);
     1594    21615    1         LCTX$=DVCTX.LIN$;
     1595    21616    1         BFR$=ADDR(NIL);
     1596    21617    1         CALL BLDEOFRC;
     1597    21618    1         RETURN;
     1598    21619        /*D*   NAME:KZD$DQ;
     1599    21620               PURPOSE:
     1600    21621                  To provide a procedure to defer output buffers
     1601    21622        */
     1602    21623    1   KZD$DQ: ENTRY (PARM) ALTRET;
     1603    21624    1         DCTX$=ADDR(PARM);
     1604    21625    1         CALL DQ;
     1605    21626    1         RETURN;
     1606    21627        /*      Move output buffers to defer queue    */
     1607    21628    1   DQ:   PROC ALTRET;
     1608    21629    3         IF DVCTX.OTPHD$ ~= ADDR(NIL) THEN DO;
     1609    21630    3            IF DVCTX.DFRHD$ = ADDR(NIL) THEN
     1610    21631    3               DVCTX.DFRHD$=DVCTX.OTPHD$;
     1611    21632    3            ELSE
     1612    21633    3               DVCTX.DFRTL$->KZ$OTPBFR.LNK$=DVCTX.OTPHD$;
     1613    21634    3            DVCTX.DFRTL$=DVCTX.OTPTL$;
     1614    21635    3            DVCTX.OTPHD$=ADDR(NIL);
     1615    21636    3            DVCTX.OTPTL$= ADDR(NIL);
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:55   
     1616    21637    3            END;
     1617    21638    2         RETURN;
     1618    21639    2   END;
     1619    21640    1   END;

PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:56   
--  Include file information  --

   KHC_MAC_C.:E05TOU  is referenced.
   K_ID_E.:E05TOU  is referenced.
   KL_AFCN_C.:E05TOU  is referenced.
   G_LCP6_E.:E05TOU  is referenced.
   GT_LCP6_M.:E05TOU  is referenced.
   KI_CP6.:E05TOU  is referenced.
   GF_LCP6_M.:E05TOU  is referenced.
   GM_LCP6_M.:E05TOU  is referenced.
   GU_LCP6_M.:E05TOU  is referenced.
   GJ_LCP6_M.:E05TOU  is referenced.
   GH_LCP6_M.:E05TOU  is referenced.
   LCP_6.:E05TOU  cannot be made into a system file and is referenced.
   KL_MACRO_C.:E05TOU  is referenced.
   KL_SUPER_C.:E05TOU  is referenced.
   KV_PRMID_E.:E05TOU  is referenced.
   KV$GLBCTX.:E05TOU  is referenced.
   KV_GLB_M.:E05TOU  is referenced.
   KV$GLB.:E05TOU  is referenced.
   KV$VDH.:E05TOU  is referenced.
   KV$USR.:E05TOU  is referenced.
   KV$INT.:E05TOU  is referenced.
   KZ_CLM_E.:E05TOU  is referenced.
   KZ_PERR_C.:E05TOU  is referenced.
   KZ_3270_C.:E05TOU  is referenced.
   KV_GLBCNS_E.:E05TOU  is referenced.
   KZ_HASP_C.:E05TOU  is referenced.
   KH$CHN.:E05TOU  is referenced.
   KH$STT.:E05TOU  is referenced.
   KV$BPC.:E05TOU  is referenced.
   KZ$BSCSTT.:E05TOU  is referenced.
   KZ$RBT_M.:E05TOU  is referenced.
   KZ$OTPBFR.:E05TOU  is referenced.
   KZ$NJE_M.:E05TOU  is referenced.
   KZ$LINCTX.:E05TOU  is referenced.
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:57   
      No diagnostics issued in procedure KZD$DEVMGR.

   Procedure KZD$DEVMGR requires 4583 words for executable code.
   Procedure KZD$DEVMGR requires 104 words of local(AUTO) storage.

    No errors detected in file KZD$DEVMGR.:E05TSI    .

PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:58   

 Object Unit name= KZD$DEVMGR                                 File name= KZD$DEVMGR.:E05TOU
 UTS= JUL 30 '97 02:50:37.52 WED                              Compiler= PL-6/E31         Sev=      00
 SharedLib= :SHARED_LCP6_SYSTEM                               Alt SharedLib=


    ****  Control sections  ****

 Sect   Type Bound  Init  Size HexSiz  Section name
    0  RoData even  UTS     86     56  KZD$DEVMGR
    1   Proc  even  none  4583   11E7  KZD$DEVMGR
    2  RoData even  none     6      6  KZD$DEVMGR

    ****  Entry defs  ****

                              Check   Calling
                             calling  sequence
  Sect HexLoc Primary Altret sequence   type   Parms  Name
     1      0   yes    yes     yes      Std        1  KZD$DEVMGR
     1    AC4          yes     yes      Std        1  KZD$SNDSIGNON
     1    ACE          yes     yes      Std        1  KZD$ACKSIGNON
     1    B8A          yes     yes      Std        0  KZD$TRNCOTPBLK
     1   1195          yes     yes      Std        1  KZD$BLDEOF
     1   11AD          yes     yes      Std        1  KZD$DQ

  ****  Data defs  ****

 Sect HexLoc  Name                           Sect HexLoc  Name
    0     3E  KZ_OTPBFR                          0     49  KZD_MINSP_FORPST
    0     51  KZ_SNDEMCHR                        0     52  KZ_SLCCHR2780PNC
    0     53  KZ_SLCCHR3780PNC1                  0     54  KZ_SLCCHR3780PNC2
    0     55  KZ_SLCCHR3780PRN
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:59   

  ****  Entry refs  ****

         Check        Calling
        calling       sequence
Altret sequence SRef   type   Args  Name
 yes     yes           Std       2 KVB$GET2NSYS
 yes     yes           Std       1 KZR$RELOTPBFR
 yes     yes           Std       1 KZR$DSC_CONT
 yes     yes           Std       2 KVB$RLS2NSYS
 yes     yes           Std       2 KVB$GETSYS
         yes           Std       1 KHI$DISABLE
 yes     yes           Std       2 KVB$RLS
         yes           Std       0 KHI$ENABLE
 yes     yes           Std       2 KHA$ERRLOG
 yes     yes           Std       1 KZR$DFR
 yes     yes           Std       1 KVV$VDI
                       nStd      0 X6A_AUTO_1
                       nStd      0 X6B_BLR
                       nStd      0 X6A_ARET

  ****  Data refs  ****

  Flags:  r = read only, s = secondary
Flgs Name                             Flgs Name                             Flgs Name
     KV_VDH_EVT_CMPOTP                     KV_VDH_OTPMRK                         KV_VDH_EVT_RQSOTP
     KV_VDH_PST_CR_VRT                     KZR_CNCDSC@                           KV$PTR$
     KZ_HASP_HDR                      r    G$ROS$
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:60   


        1        1        /*M*  RBT device services called by VDH                            */
        2        2        /*T***********************************************************/
        3        3        /*T*                                                         */
        4        4        /*T* Copyright (c) Bull HN Information Systems Inc., 1997    */
        5        5        /*T*                                                         */
        6        6        /*T***********************************************************/
        7        7        /*X* PLM=6,IND=3,CTI=3,DCI=3,DTI=0,MCI,MOC,DMC       */
        8        8        /*P* NAME:   KZD$DEVMGR
        9        9             PURPOSE: To provide a VDH to RBT interface.                 */
       10       10
       11       11        /*D*  NAME:   KZD$DEVMGR
       12       12              CALL:
       13       13                      CALL KZD$DEVMGR (VDH-parameter);
       14       14              PARAMETER:
       15       15                      VDH-parameter is a VDH->VDH-user parameter block.
       16       16              DESCRIPTION:
       17       17                      This procedure is called by VDH to process user
       18       18                      events.                                              */
       19       19        %EJECT;
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:61   
       20       20
       21       21        KZD$DEVMGR: PROC (PARM) ALTRET;

     21   1 000000  D380 0000 0000  xent KZD$DEVMGR      LNJ,B5   X6A_AUTO_1
          1 000003       0068 0001                       DC       104,1

       22       22
       23       23
       24       24        %INCLUDE KZ$LINCTX;
       25      644        %INCLUDE KZ$NJE_M;
       26      882        %INCLUDE KZ$OTPBFR;
       27      983        %INCLUDE KZ$RBT_M;
       28     1542        %INCLUDE KZ$BSCSTT;
       29     1648        %INCLUDE KH$STT;
       30     1678        %INCLUDE KH$CHN;
       31     1800        %INCLUDE KZ_HASP_C;
       32     2142        %INCLUDE KV_GLBCNS_E;
       33     2483        %INCLUDE KZ_3270_C;
       34     2641        %INCLUDE KZ_PERR_C;
       35     2723        %INCLUDE KZ_CLM_E;
       36     2895        %INCLUDE KV$INT;
       37     3527        %INCLUDE KV$USR;
       38     3839        %INCLUDE KV$VDH;
       39     4270        %INCLUDE KV$GLB;
       40     4689        %INCLUDE KV_GLB_M;
       41     4811        %INCLUDE KV$GLBCTX;
       42     5256        %INCLUDE KV_PRMID_E;
       43     5430        %INCLUDE KL_SUPER_C;
       44     8332        %INCLUDE KL_MACRO_C;
       45    11684        %INCLUDE LCP_6;
       46    15963        %INCLUDE KL_AFCN_C;
       47    16064        %INCLUDE K_ID_E;
       48    16114        %K#ENTID_E;
       49    16133        %K#LYRID_E;
       50    16140        %INCLUDE KHC_MAC_C;
       51    16181
       52    16182        %KV_USR_FNC_E;
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:62   
       53    16198        %KV_INPOPRX_E;
       54    16210        %KZ_3270_E;
       55    16338        %KV_USR_EVT_ID_E;
       56    16358        %KV_VDH_EVT_ID_E;
       57    16364        %KV_PRMID_E;
       58    16520        %KV_STRTYP_E;
       59    16558        %EQU KV_VFU = CHARTEXT('KV$PTR.MVD$->KV$MVD.VFU$->KV$VFU');
       60    16559        /* %SUB KV_VFU = "KV$PTR.MVD$->KV$MVD.VFU$->KV$VFU"; */
       61    16560        %EQU VFU_CHN_BOF = 11;
       62    16561        %EQU VFU_CHN_TOF = 0;
       63    16562        %EQU VFU_CHN_HI_BASE = 6;
       64    16563        %EQU VFU_CHN_REVERSE = 5;
       65    16564        %EQU VFU_CHNX_HI = 11;
       66    16565        %EQU VFU_LINX_HI = 200;
       67    16566
       68    16567
       69    16568        /*    Parameters                   */
       70    16569
       71    16570    1   DCL PARM UBIN;
       72    16571
       73    16572        /*    SYMREF                    */
       74    16573
       75    16574    1   DCL KZR_THRTL_BLK UBIN SYMREF;
       76    16575        %KV$VDH_EVT (NAME=KV_VDH_EVT_CMPOTP,STCLASS=SYMREF);
       77    16610        %KV$VDH_OTPMRK (NAME=KV_VDH_OTPMRK,STCLASS=SYMREF);
       78    16672        %KV$VDH_EVT (NAME=KV_VDH_EVT_RQSOTP,STCLASS=SYMREF);
       79    16707        %KV$VDH_PST(NAME=KV_VDH_PST_CR_VRT, STCLASS=SYMREF);
       80    16781
       81    16782        /*      Entry                    */
       82    16783
       83    16784    1   DCL KVB$GETSYS ENTRY(2) ALTRET;
       84    16785    1   DCL KVB$RLS ENTRY(2) ALTRET;
       85    16786    1   DCL KVB$GET2NSYS ENTRY(2) ALTRET;
       86    16787    1   DCL KVB$RLS2NSYS ENTRY(2) ALTRET;
       87    16788    1   DCL KZR$RELOTPBFR ENTRY(1) ALTRET;
       88    16789    1   DCL KZR$DSC_CONT ENTRY(1) ALTRET;
       89    16790    1   DCL KZR$DFR ENTRY(1) ALTRET;
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:63   
       90    16791    1   DCL KZR_CNCDSC@ EPTR SYMREF;
       91    16792    1   DCL KHA$ERRLOG ENTRY(2) ALTRET;
       92    16793    1   DCL KHI$DISABLE ENTRY(1);
       93    16794    1   DCL KHI$ENABLE ENTRY;
       94    16795    1   DCL KVV$VDI ENTRY(1) ALTRET;
       95    16796
       96    16797        /*    Auto                         */
       97    16798    1   DCL PARM$ PTR;
       98    16799    1   DCL DCTX$ PTR;
       99    16800    1   DCL LCTX$ PTR;
      100    16801    1   DCL BFR$ PTR;
      101    16802    1   DCL TBFR$ PTR;
      102    16803    1   DCL BYTX UBIN;
      103    16804    1   DCL BYTSIZ SBIN;
      104    16805    1   DCL J SBIN;
      105    16806    1   DCL I UBIN;
      106    16807    1   DCL T$ PTR;
      107    16808    1   DCL U$ PTR;
      108    16809    1   DCL K SBIN;
      109    16810    1   DCL L UBIN;
      110    16811    1   DCL M BIT(8);
      111    16812    1   DCL N UBIN;
      112    16813    1   DCL LEV UBIN;
      113    16814    1   DCL IRS BIT(8);
      114    16815    1   DCL SGN$ PTR;
      115    16816    1   DCL SGN_NJE$ CPTR;
      116    16817    1   DCL SGNITYPE BIT(1) ALIGNED;
      117    16818    1   DCL SZ UBIN;
      118    16819    1   DCL PAGLNG UBIN;
      119    16820    1   DCL VFU$ PTR;
      120    16821    1   DCL VFU_LIN$ PTR;
      121    16822    1   DCL VFU_CHNX UBIN;
      122    16823    1   DCL VFU_LINX UBIN;
      123    16824        %FPT_WRSYSLOG (STCLASS="");
      124    16919        %KV$VDH_EVT (STCLASS=AUTO);
      125    16954        %KV$VDH_OTPMRK (STCLASS=AUTO);
      126    17016        %KZ$EVENT (STCLASS=AUTO);
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:64   
      127    17098        %KV$VDH_OTPLCL (STCLASS="");
      128    17171
      129    17172
      130    17173        /*    Based                        */
      131    17174
      132    17175        %KH$CHN;
      133    17299        %KV$USR_DAT (STCLASS="BASED(PARM$)");
      134    17383        %KV$PTR;
      135    17426        %KV$MRD;
      136    17473        %KV$SRD;
      137    17748        %KV$VDI;
      138    17819        %KV$OTPMRK;
      139    17846        %KV$USR_EVT (STCLASS="BASED(PARM$)");
      140    17881        %KV$USR_PST (STCLASS="BASED(PARM$)");
      141    17951        %KV$USR_OTPMRK (STCLASS="BASED(PARM$)");
      142    18013        %KV$USR_SETPRM (STCLASS="BASED(PARM$)");
      143    18075        %KV$MVD;
      144    18119        %KV$TRNTBL;
      145    18177        %KV$VFU;
      146    18224
      147    18225        %KZ$LINCTX (STCLASS="BASED(LCTX$)");
      148    18656        %KZ$OTPBFR (STCLASS="BASED(BFR$)");
      149    18721        %KZ$SDVCTX (NAME=DVCTX,STCLASS="BASED(DCTX$)");
      150    19033        %KZ$HASPBLK (STCLASS=BASED);
      151    19066        %KZ$HASPSCB (STCLASS="BASED(BFR$)");
      152    19089        %KZ$HASPSRCB (NAME="KZ$HASPSRCB(0:0)",STCLASS="BASED(BFR$)");
      153    19113        %KZ$HASPRCB  (STCLASS="BASED(BFR$)");
      154    19131        %KZ$NJE_SIGNON (STCLASS=BASED);
      155    19211        %KZ$SYNCSTAT;
      156    19625        %KZ_HASP_HDR (STCLASS=SYMREF);
      157    19649        %KZ$RBT_E;
      158    19679    1   DCL BYT(0:0) BIT(8) CALIGNED BASED(BFR$);
      159    19680    1   DCL CHR1 CHAR(512) BASED;
      160    19681    1   DCL 1 DV BASED(T$) CALIGNED,
      161    19682    1         2 NUM BIT(8),
      162    19683    1         2 SNUM UBIN(8) UNAL,
      163    19684    1         2 CTL BIT(16);
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:65   
      164    19685    1   DCL VFUBFR(0:199) BIT(16) ALIGNED BASED(VFU_LIN$);
      165    19686    1   DCL 1 VFU_WORD BASED ALIGNED,
      166    19687    1         2 * BIT(2),
      167    19688    1         2 CHN_LO(0:5) BIT(1) UNAL,
      168    19689    1         2 * BIT(2),
      169    19690    1         2 CHN_HI(0:5) BIT(1) UNAL;
      170    19691
      171    19692
      172    19693        /*    Static      */
      173    19694
      174    19695        %FPT_WRSYSLOG (FPTN=FPT@WRSYSLOG,
      175    19696                       FCG='KZ',
      176    19697                       MID='D',
      177    19698                       SEV=%G_WRSYSLOG_SEV_LINE_ABORT#,
      178    19699                       STCLASS=CONSTANT);
      179    19794        %KZ$EVENT (FPTN=KZ_EVENT,STCLASS=CONSTANT);
      180    19876        %KV$VDH_EVT (NAME=KV_VDH_EVT,STCLASS=CONSTANT,ID=KV_VDH_EVT_ID_ATN);
      181    19911        %KV$VDH_OTPLCL (NAME=KV_VDH_OTPLCL,STCLASS=CONSTANT);
      182    19984        %KZ$NJE_SIGNON (NAME=KZ_NJE_SIGNON,STCLASS=CONSTANT);
      183    20064        %KZ$OTPBFR (NAME=KZ_OTPBFR,STCLASS="CONSTANT SYMDEF");
      184    20129    1   DCL VFC(0:4) BIT(8) CONSTANT INIT('D4'X,'61'X,'E2'X,'E3'X,'C1'X);
      185    20130    1   DCL KZD_MINSP_FORPST UBIN CONSTANT SYMDEF INIT(3);
      186    20131    1   DCL ESCSZ(0:5) UBIN CONSTANT INIT(0,0,2,0,1,0);
      187    20132    1   DCL SLCT(0:1) BIT(8) CONSTANT INIT('12'X,'11'X);
      188    20133
      189    20134        /*N*  KLUDGE AREA *** KLUDGE AREA *** KLUDGE AREA *** KLUDGE AREA *** KLUD  *N*/
      190    20135        /*N*  To make some site-specific patches easier, here's where we're         *N*/
      191    20136        /*N*  stashing away some CONSTANT SYMDEF values for HASP/2780/3780.         *N*/
      192    20137        /*N*  These "defaults" should be made into SUPER options on                 *N*/
      193    20138        /*N*  TERM/PROFILE/DEVICE creation commands.                                *N*/
      194    20139    1   DCL KZ_SNDEMCHR BIT(1) ALIGNED CONSTANT SYMDEF INIT('1'B);
      195    20140    1   DCL KZ_SLCCHR2780PNC BIT(8) ALIGNED CONSTANT SYMDEF INIT('F4'X);
      196    20141    1   DCL KZ_SLCCHR3780PNC1 BIT(8) ALIGNED CONSTANT SYMDEF INIT('12'X);
      197    20142    1   DCL KZ_SLCCHR3780PNC2 BIT(8) ALIGNED CONSTANT SYMDEF INIT('13'X);
      198    20143    1   DCL KZ_SLCCHR3780PRN BIT(8) ALIGNED CONSTANT SYMDEF INIT('11'X);
      199    20144        /*N*  KLUDGE AREA *** KLUDGE AREA *** KLUDGE AREA *** KLUDGE AREA *** KLUD  *N*/
      200    20145        %EJECT;
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:66   
      201    20146    1         PARM$ = ADDR(PARM);

  20146   1 000005  ECC7 0004                            LDB,B6   @PARM,AUTO
          1 000007  EFC7 0006                            STB,B6   PARM$,AUTO

      202    20147    1         CALL INITPRM;

  20147   1 000009  E3C0 0A71                            LNJ,B6   s:0,PREL
          1 00000B       0001                            DC       s:20151,PREL

      203    20148                          /* Eh?  $$CURRTIME GS$DV_LATEST_POLL(B2)                    */
      204    20149
      205    20150              %DISABLE (DISLVL=LEV,INHLVL=KZ$LINCTX.INHLVL);

  20151   1 00000C  ECC7 000A                            LDB,B6   LCTX$,AUTO
          1 00000E  E846 0035                            LDR,R6   53,B6
          1 000010  EF47 001C                            STR,R6   LEV,AUTO

  20152   1 000012  DBC7 001C                            LAB,B5   LEV,AUTO
          1 000014  DFC7 0064                            STB,B5   P$+6,AUTO
          1 000016  BBC7 0064                            LAB,B3   P$+6,AUTO
          1 000018  CBF0 0100                            LAB,B4   256,IMO
          1 00001A  E380 0000 0000  xent                 LNJ,B6   KHI$DISABLE
          1 00001D       0001                            DC       s:20156,PREL

      206    20154        %EJECT;
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:67   
      207    20155    1   FNC_CASE:
      208    20156    2         DO CASE( KV$USR_DAT.FNC);

  20156   1 00001E  ECC7 0006            FNC_CASE        LDB,B6   PARM$,AUTO
          1 000020  B286                                 LLH,R3   ,B6
          1 000021  3EFC                                 ADV,R3   -4
          1 000022  3D0C                                 CMV,R3   12
          1 000023  0281 0A14                            BGE      s:20937,PREL
          1 000025  A830 0000 002B  01                   LDR,R2   FNC_CASE+13,R3
          1 000028  83A0 0000 0037  01                   JMP      s:20174,R2
          1 00002B       04B7                            DC       s:20519,PREL
          1 00002C       0A01                            DC       s:20937,PREL
          1 00002D       0A01                            DC       s:20937,PREL
          1 00002E       0000                            DC       s:20174,PREL
          1 00002F       0A01                            DC       s:20937,PREL
          1 000030       0A01                            DC       s:20937,PREL
          1 000031       01B4                            DC       s:20290,PREL
          1 000032       0A01                            DC       s:20937,PREL
          1 000033       025E                            DC       s:20354,PREL
          1 000034       04AD                            DC       s:20515,PREL
          1 000035       0A01                            DC       s:20937,PREL
          1 000036       0061                            DC       s:20209,PREL

      209    20157
      210    20158
      211    20159
      212    20160    2          CASE(%KV_USR_FNC_GETOTPBFR);

      213    20161        /*D*     When VDH calls with KV_USR_FNC_GETOTPBFR, either there is no
      214    20162                 output block, or the current buffer is full.  If there is no
      215    20163                 block, one is obtained, and initialized.  If the current
      216    20164                 buffer is full, and its a HASP line, the SCB count field is
      217    20165                 set and, if there is room for at least a one byte string in the
      218    20166                 current block, the buffer size is set to the minimum of remaining
      219    20167                 block size or 63.
      220    20168
      221    20169                 If there is not room for a one byte string in the current block,
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:68   
      222    20170                 or its not a HASP line, the current block is output and a new
      223    20171                 one obtained and initialized.
      224    20172                                                                           */
      225    20173
      226    20174    2            IF DVCTX.MGR_TYPE = %KZ_S_DMCONSOLE# THEN

  20174   1 000037  DCC7 0008                            LDB,B5   DCTX$,AUTO
          1 000039  E2C5 0022                            LLH,R6   34,B5
          1 00003B  6D03                                 CMV,R6   3
          1 00003C  0981 0004                            BNE      s:20176,PREL

      227    20175    2               DCTX$ = DVCTX.LNK$;

  20175   1 00003E  CC85                                 LDB,B4   ,B5
          1 00003F  CFC7 0008                            STB,B4   DCTX$,AUTO

      228    20176    2            IF BFR$ = ADDR(NIL) THEN

  20176   1 000041  8DC7 000C                            CMN      BFR$,AUTO
          1 000043  0981 0006                            BNE      s:20179,PREL

      229    20177    2               CALL GET_BFR ALTRET(NOBUF);

  20177   1 000045  E3C0 0CDD                            LNJ,B6   s:0,PREL
          1 000047       0A05                            DC       s:20955,PREL
          1 000048  0F81 09EF                            B        s:20937,PREL

      230    20178    3            ELSE DO;

      231    20179    3               CALL CMPBYTSIZ;

  20179   1 00004A  E3C0 0DF7                            LNJ,B6   s:0,PREL
          1 00004C       0001                            DC       s:20180,PREL

      232    20180    3               BYTSIZ = J;

  20180   1 00004D  E847 0012                            LDR,R6   J,AUTO
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:69   
          1 00004F  EF47 0011                            STR,R6   BYTSIZ,AUTO

      233    20181    3               IF KZ$LINCTX.PRO.PROTYP = %KLPT_HASP#

  20181   1 000051  ECC7 000A                            LDB,B6   LCTX$,AUTO
          1 000053  D846 003A                            LDR,R5   58,B6
          1 000055  5D03                                 CMV,R5   3
          1 000056  0901 0004                            BE       s:20183,PREL
          1 000058  5D07                                 CMV,R5   7
          1 000059  0981 002D                            BNE      s:20202,PREL

      234    20182    4                  OR KZ$LINCTX.PRO.PROTYP = %KLPT_NJE# THEN DO;

      235    20183    4                  IF BYTSIZ < 2 THEN

  20183   1 00005B  6D02                                 CMV,R6   2
          1 00005C  0881 0015                            BAGE     s:20194,PREL

      236    20184                          /* If one record in block, let it span into next  */
      237    20185    4                     IF DVCTX.LASTRCBX = SIZEC(KZ$OTPBFR)+

  20185   1 00005E  DCC7 0008                            LDB,B5   DCTX$,AUTO
          1 000060  C845 0021                            LDR,R4   33,B5
          1 000062  4D13                                 CMV,R4   19
          1 000063  0981 0006                            BNE      s:20189,PREL

      238    20186    4                        SIZEC(KZ$HASPBLK)-3 THEN
      239    20187    4                        CALL FINOTPBF2 ALTRET(NOBUF);

  20187   1 000065  E3C0 0E53                            LNJ,B6   s:0,PREL
          1 000067       09E5                            DC       s:20955,PREL
          1 000068  0F81 09CF                            B        s:20937,PREL

      240    20188    5                     ELSE DO;

      241    20189    5                        CALL SET_SCB;

PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:70   
  20189   1 00006A  E3C0 0FCA                            LNJ,B6   s:0,PREL
          1 00006C       0001                            DC       s:20190,PREL

      242    20190    5                        CALL DONE ALTRET(NOBUF);

  20190   1 00006D  E3C0 0B65                            LNJ,B6   s:0,PREL
          1 00006F       09DD                            DC       s:20955,PREL

      243    20191    5                        GOTO GETOTP1;

  20191   1 000070  0F81 000C                            B        s:20197,PREL

      244    20192    5                        END;
      245    20193    5                  ELSE DO;

      246    20194    5                     CALL SET_SCB;

  20194   1 000072  E3C0 0FC2                            LNJ,B6   s:0,PREL
          1 000074       0001                            DC       s:20195,PREL

      247    20195    5                     IF BYTSIZ > 63 THEN

  20195   1 000075  E847 0011                            LDR,R6   BYTSIZ,AUTO
          1 000077  6D3F                                 CMV,R6   63
          1 000078  0A81 0004                            BALE     s:20197,PREL

      248    20196    5                        BYTSIZ = 63;

  20196   1 00007A  6C3F                                 LDV,R6   63
          1 00007B  EF47 0011                            STR,R6   BYTSIZ,AUTO

      249    20197    5   GETOTP1:          DVCTX.LASTSCBX = BYTX;

  20197   1 00007D  ECC7 0008            GETOTP1         LDB,B6   DCTX$,AUTO
          1 00007F  E847 0010                            LDR,R6   BYTX,AUTO
          1 000081  EF46 0020                            STR,R6   32,B6

PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:71   
      250    20198    5                     BYTX = BYTX + 1;

  20198   1 000083  8AC7 0010                            INC      BYTX,AUTO

      251    20199    5                     END;

      252    20200    4                  END;

  20200   1 000085  0F81 09B2                            B        s:20937,PREL

      253    20201    3               ELSE
      254    20202    3                  IF DVCTX.LASTRCBX <= SIZEC(KZ$OTPBFR)+2 THEN

  20202   1 000087  DCC7 0008                            LDB,B5   DCTX$,AUTO
          1 000089  C845 0021                            LDR,R4   33,B5
          1 00008B  4D12                                 CMV,R4   18
          1 00008C  0301 0006                            BG       s:20205,PREL

      255    20203    3                     CALL FINOTPBF2 ALTRET(NOBUF);

  20203   1 00008E  E3C0 0E2A                            LNJ,B6   s:0,PREL
          1 000090       09BC                            DC       s:20955,PREL
          1 000091  0F81 09A6                            B        s:20937,PREL

      256    20204    3                  ELSE
      257    20205    3                     CALL DONE ALTRET(NOBUF);

  20205   1 000093  E3C0 0B3F                            LNJ,B6   s:0,PREL
          1 000095       09B7                            DC       s:20955,PREL

      258    20206    3               END;

  20206   1 000096  0F81 09A1                            B        s:20937,PREL

      259    20207        %EJECT;
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:72   
      260    20208    2          CASE(%KV_USR_FNC_SETPRM);

      261    20209    3            DO CASE(KV$USR_SETPRM.PRMID);

  20209   1 000098  9846 0001                            LDR,R1   1,B6
          1 00009A  1EEE                                 ADV,R1   -18
          1 00009B  1D70                                 CMV,R1   112
          1 00009C  0281 099B                            BGE      s:20937,PREL
          1 00009E  B810 0000 00A4  01                   LDR,R3   s:20209+12,R1
          1 0000A1  83B0 0000 0114  01                   JMP      s:20215,R3
          1 0000A4       0031                            DC       s:20223,PREL
          1 0000A5       00D5                            DC       s:20275,PREL
          1 0000A6       00D5                            DC       s:20275,PREL
          1 0000A7       00D5                            DC       s:20275,PREL
          1 0000A8       00D5                            DC       s:20275,PREL
          1 0000A9       00D5                            DC       s:20275,PREL
          1 0000AA       00D5                            DC       s:20275,PREL
          1 0000AB       00D5                            DC       s:20275,PREL
          1 0000AC       00D5                            DC       s:20275,PREL
          1 0000AD       00D5                            DC       s:20275,PREL
          1 0000AE       00D5                            DC       s:20275,PREL
          1 0000AF       00D5                            DC       s:20275,PREL
          1 0000B0       00D5                            DC       s:20275,PREL
          1 0000B1       00D5                            DC       s:20275,PREL
          1 0000B2       00D5                            DC       s:20275,PREL
          1 0000B3       00D5                            DC       s:20275,PREL
          1 0000B4       00D5                            DC       s:20275,PREL
          1 0000B5       00D5                            DC       s:20275,PREL
          1 0000B6       00D5                            DC       s:20275,PREL
          1 0000B7       00D5                            DC       s:20275,PREL
          1 0000B8       00D5                            DC       s:20275,PREL
          1 0000B9       00D5                            DC       s:20275,PREL
          1 0000BA       00D5                            DC       s:20275,PREL
          1 0000BB       00D5                            DC       s:20275,PREL
          1 0000BC       00D5                            DC       s:20275,PREL
          1 0000BD       00D5                            DC       s:20275,PREL
          1 0000BE       00D5                            DC       s:20275,PREL
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:73   
          1 0000BF       00D5                            DC       s:20275,PREL
          1 0000C0       00D5                            DC       s:20275,PREL
          1 0000C1       00D5                            DC       s:20275,PREL
          1 0000C2       00D5                            DC       s:20275,PREL
          1 0000C3       00D5                            DC       s:20275,PREL
          1 0000C4       00D5                            DC       s:20275,PREL
          1 0000C5       00D5                            DC       s:20275,PREL
          1 0000C6       00D5                            DC       s:20275,PREL
          1 0000C7       00D5                            DC       s:20275,PREL
          1 0000C8       00D5                            DC       s:20275,PREL
          1 0000C9       00D5                            DC       s:20275,PREL
          1 0000CA       00D5                            DC       s:20275,PREL
          1 0000CB       00D5                            DC       s:20275,PREL
          1 0000CC       00D5                            DC       s:20275,PREL
          1 0000CD       00D5                            DC       s:20275,PREL
          1 0000CE       00D5                            DC       s:20275,PREL
          1 0000CF       00D5                            DC       s:20275,PREL
          1 0000D0       00D5                            DC       s:20275,PREL
          1 0000D1       00D5                            DC       s:20275,PREL
          1 0000D2       00D5                            DC       s:20275,PREL
          1 0000D3       00D5                            DC       s:20275,PREL
          1 0000D4       00D5                            DC       s:20275,PREL
          1 0000D5       00D5                            DC       s:20275,PREL
          1 0000D6       00D5                            DC       s:20275,PREL
          1 0000D7       00D5                            DC       s:20275,PREL
          1 0000D8       00D5                            DC       s:20275,PREL
          1 0000D9       00D5                            DC       s:20275,PREL
          1 0000DA       00D5                            DC       s:20275,PREL
          1 0000DB       00D5                            DC       s:20275,PREL
          1 0000DC       00D5                            DC       s:20275,PREL
          1 0000DD       00D5                            DC       s:20275,PREL
          1 0000DE       00D5                            DC       s:20275,PREL
          1 0000DF       00D5                            DC       s:20275,PREL
          1 0000E0       00D5                            DC       s:20275,PREL
          1 0000E1       00D5                            DC       s:20275,PREL
          1 0000E2       00D5                            DC       s:20275,PREL
          1 0000E3       00D5                            DC       s:20275,PREL
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:74   
          1 0000E4       00D5                            DC       s:20275,PREL
          1 0000E5       00D5                            DC       s:20275,PREL
          1 0000E6       00D5                            DC       s:20275,PREL
          1 0000E7       00D5                            DC       s:20275,PREL
          1 0000E8       00D5                            DC       s:20275,PREL
          1 0000E9       00D5                            DC       s:20275,PREL
          1 0000EA       00D5                            DC       s:20275,PREL
          1 0000EB       00D5                            DC       s:20275,PREL
          1 0000EC       00D5                            DC       s:20275,PREL
          1 0000ED       00D5                            DC       s:20275,PREL
          1 0000EE       00D5                            DC       s:20275,PREL
          1 0000EF       00D5                            DC       s:20275,PREL
          1 0000F0       00D5                            DC       s:20275,PREL
          1 0000F1       00D5                            DC       s:20275,PREL
          1 0000F2       00D5                            DC       s:20275,PREL
          1 0000F3       00D5                            DC       s:20275,PREL
          1 0000F4       00D5                            DC       s:20275,PREL
          1 0000F5       00D5                            DC       s:20275,PREL
          1 0000F6       00D5                            DC       s:20275,PREL
          1 0000F7       00D5                            DC       s:20275,PREL
          1 0000F8       00D5                            DC       s:20275,PREL
          1 0000F9       00D5                            DC       s:20275,PREL
          1 0000FA       00D5                            DC       s:20275,PREL
          1 0000FB       00D5                            DC       s:20275,PREL
          1 0000FC       00D5                            DC       s:20275,PREL
          1 0000FD       00D5                            DC       s:20275,PREL
          1 0000FE       00D5                            DC       s:20275,PREL
          1 0000FF       00D5                            DC       s:20275,PREL
          1 000100       00D5                            DC       s:20275,PREL
          1 000101       00D5                            DC       s:20275,PREL
          1 000102       00D5                            DC       s:20275,PREL
          1 000103       00D5                            DC       s:20275,PREL
          1 000104       0000                            DC       s:20215,PREL
          1 000105       00D5                            DC       s:20275,PREL
          1 000106       00D5                            DC       s:20275,PREL
          1 000107       000B                            DC       s:20217,PREL
          1 000108       0019                            DC       s:20219,PREL
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:75   
          1 000109       0028                            DC       s:20221,PREL
          1 00010A       00D5                            DC       s:20275,PREL
          1 00010B       00D5                            DC       s:20275,PREL
          1 00010C       00D5                            DC       s:20275,PREL
          1 00010D       00D5                            DC       s:20275,PREL
          1 00010E       00D5                            DC       s:20275,PREL
          1 00010F       00D5                            DC       s:20275,PREL
          1 000110       00D5                            DC       s:20275,PREL
          1 000111       00D5                            DC       s:20275,PREL
          1 000112       00D5                            DC       s:20275,PREL
          1 000113       00C3                            DC       s:20271,PREL

      262    20210    3             CASE(%KV_PRMID_PRFNAM);

      263    20211        /*          T$ = PINCRW(KV$USR_SETPRM.VAL_.ADR$,38);
      264    20212                    DVCTX.RCB_CODE = DV.NUM;
      265    20213                    DVCTX.SUSBIT_MASK = DV.CTL;            */
      266    20214    3             CASE(%KV_PRMID_BIN);

      267    20215    3               DVCTX.FLAGS.BINARY_OK = BINBIT(KV$USR_SETPRM.VAL,1);

  20215   1 000114  E846 0002                            LDR,R6   2,B6
          1 000116  600F                                 SOL,R6   15
          1 000117  6046                                 SOR,R6   6
          1 000118  DCC7 0008                            LDB,B5   DCTX$,AUTO
          1 00011A  EAC5 001E                            SRM,R6,'0200'X    30,B5
          1 00011C       0200
          1 00011D  0F81 091A                            B        s:20937,PREL

      268    20216    3             CASE(%KV_PRMID_INPUT);

      269    20217    3               DVCTX.MGR_TYPE_B = DVCTX.MGR_TYPE_B | BINBIT(KV$USR_SETPRM.VAL,8);

  20217   1 00011F  E846 0002                            LDR,R6   2,B6
          1 000121  6008                                 SOL,R6   8
          1 000122  DCC7 0008                            LDB,B5   DCTX$,AUTO
          1 000124  D2C5 0022                            LLH,R5   34,B5
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:76   
          1 000126  5008                                 SOL,R5   8
          1 000127  D456                                 OR,R5    R6
          1 000128  5048                                 SOR,R5   8
          1 000129  D7C5 0022                            STH,R5   34,B5
          1 00012B  0F81 090C                            B        s:20937,PREL

      270    20218    3             CASE(%KV_PRMID_OUTPUT);

      271    20219    3               DVCTX.MGR_TYPE_B = DVCTX.MGR_TYPE_B | BINBIT(KV$USR_SETPRM.VAL*2,8);

  20219   1 00012D  E846 0002                            LDR,R6   2,B6
          1 00012F  6001                                 SOL,R6   1
          1 000130  6008                                 SOL,R6   8
          1 000131  DCC7 0008                            LDB,B5   DCTX$,AUTO
          1 000133  D2C5 0022                            LLH,R5   34,B5
          1 000135  5008                                 SOL,R5   8
          1 000136  D456                                 OR,R5    R6
          1 000137  5048                                 SOR,R5   8
          1 000138  D7C5 0022                            STH,R5   34,B5
          1 00013A  0F81 08FD                            B        s:20937,PREL

      272    20220    3             CASE(%KV_PRMID_PRINTTYPE);

      273    20221    3               DVCTX.ACCESS_METHOD = KV$USR_SETPRM.VAL;

  20221   1 00013C  E846 0002                            LDR,R6   2,B6
          1 00013E  DCC7 0008                            LDB,B5   DCTX$,AUTO
          1 000140  EAC5 0022                            SRM,R6,'00FF'X    34,B5
          1 000142       00FF
          1 000143  0F81 08F4                            B        s:20937,PREL

      274    20222    3             CASE(%KV_PRMID_VFU);

      275    20223    3               IF DVCTX.RCB_CODE ~= 'E5'X

  20223   1 000145  DCC7 0008                            LDB,B5   DCTX$,AUTO
          1 000147  E2C5 0024                            LLH,R6   36,B5
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:77   
          1 000149  6008                                 SOL,R6   8
          1 00014A  E970 E500                            CMR,R6   -6912,IMO
          1 00014C  0981 08EB                            BNE      s:20937,PREL
          1 00014E  82C5 001E                            LB,'0080'X        30,B5
          1 000150       0080
          1 000151  0501 08E6                            BBT      s:20937,PREL

      276    20224    3                  OR DVCTX.FLAGS.EVFU_LOADED THEN
      277    20225    3                  EXIT FNC_CASE;
      278    20226    3               PAGLNG = KV$PTR.SRD$->KV$SRD.LNG;

  20226   1 000153  CC80 0000 0000  xsym                 LDB,B4   KV$PTR$
          1 000156  BCC4 000A                            LDB,B3   10,B4
          1 000158  D2C3 000E                            LLH,R5   14,B3
          1 00015A  DF47 0024                            STR,R5   PAGLNG,AUTO

      279    20227    3               IF PAGLNG < 1 OR PAGLNG > %VFU_LINX_HI THEN

  20227   1 00015C  5D01                                 CMV,R5   1
          1 00015D  0201 0005                            BL       s:20228,PREL
          1 00015F  D970 00C8                            CMR,R5   200,IMO
          1 000161  0381 0004                            BLE      s:20229,PREL

      280    20228    3                  PAGLNG = 1;

  20228   1 000163  5C01                                 LDV,R5   1
          1 000164  DF47 0024                            STR,R5   PAGLNG,AUTO

      281    20229    3               SZ = SIZEW(KZ$OTPBFR)+PAGLNG+2;

  20229   1 000166  5E0A                                 ADV,R5   10
          1 000167  DF47 0023                            STR,R5   SZ,AUTO

      282    20230    3               CALL KVB$GET2NSYS (SZ,VFU$) ALTRET(NOBUF);

  20230   1 000169  BBC7 0025                            LAB,B3   VFU$,AUTO
          1 00016B  BFC7 0066                            STB,B3   P$+8,AUTO
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:78   
          1 00016D  ABC7 0023                            LAB,B2   SZ,AUTO
          1 00016F  AFC7 0064                            STB,B2   P$+6,AUTO
          1 000171  BBC7 0064                            LAB,B3   P$+6,AUTO
          1 000173  CBF0 0200                            LAB,B4   512,IMO
          1 000175  E380 0000 0000  xent                 LNJ,B6   KVB$GET2NSYS
          1 000178       08D4                            DC       s:20955,PREL

      283    20231    3               VFU$->KZ$OTPBFR = KZ_OTPBFR;

  20231   1 000179  AB80 0000 0000  00                   LAB,B2   FPT@WRSYSLOG
          1 00017C  2C7C                                 LDV,R2   124
          1 00017D  6C10                                 LDV,R6   16
          1 00017E  BCC7 0025                            LDB,B3   VFU$,AUTO
          1 000180  3C00                                 LDV,R3   0
          1 000181  0008                                 MMM

      284    20232    3               VFU$->KZ$OTPBFR.BFRSIZ = SZ;

  20232   1 000182  ECC7 0025                            LDB,B6   VFU$,AUTO
          1 000184  E847 0023                            LDR,R6   SZ,AUTO
          1 000186  EF46 0004                            STR,R6   4,B6

      285    20233    3               VFU$->KZ$OTPBFR.DEV$ = DCTX$;

  20233   1 000188  ECC7 0008                            LDB,B6   DCTX$,AUTO
          1 00018A  DCC7 0025                            LDB,B5   VFU$,AUTO
          1 00018C  EFC5 0006                            STB,B6   6,B5

      286    20234    3               VFU_LIN$ = PINCRW(VFU$,SIZEW(KZ$OTPBFR));

  20234   1 00018E  ECC7 0025                            LDB,B6   VFU$,AUTO
          1 000190  DBC6 0008                            LAB,B5   8,B6
          1 000192  DFC7 0027                            STB,B5   VFU_LIN$,AUTO

      287    20235                    /* ESC '7' signals the start of a VFU record. */
      288    20236    3               VFUBFR(0) = '27F7'X;

PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:79   
  20236   1 000194  E870 27F7                            LDR,R6   10231,IMO
          1 000196  EF05                                 STR,R6   ,B5

      289    20237    4               DO VFU_LINX = 1 TO PAGLNG;

  20237   1 000197  5C01                                 LDV,R5   1
          1 000198  DF47 002A                            STR,R5   VFU_LINX,AUTO
          1 00019A  0F81 000A                            B        s:20239+2,PREL

      290    20238    4                  ADDR(VFUBFR(VFU_LINX))->VFU_WORD = '4040'X;

  20238   1 00019C  ECC7 0027                            LDB,B6   VFU_LIN$,AUTO
          1 00019E  B847 002A                            LDR,R3   VFU_LINX,AUTO
          1 0001A0  E870 4040                            LDR,R6   16448,IMO
          1 0001A2  EF36                                 STR,R6   ,B6,R3

      291    20239    4                  END;

  20239   1 0001A3  8AC7 002A                            INC      VFU_LINX,AUTO
          1 0001A5  E847 002A                            LDR,R6   VFU_LINX,AUTO
          1 0001A7  E947 0024                            CMR,R6   PAGLNG,AUTO
          1 0001A9  03F3                                 BLE      s:20238,SPREL

      292    20240        /*          DO VFU_CHNX = 0 TO %VFU_CHNX_HI;
      293    20241                       IF %KV_VFU.LIN(VFU_CHNX) > 0 THEN DO;
      294    20242                          IF VFU_CHNX < %VFU_CHN_HI_BASE THEN
      295    20243        ADDR(VFUBFR(%KV_VFU.LIN(VFU_CHNX)))->VFU_WORD.CHN_LO(%VFU_CHN_REVERSE-VFU_CHNX) = '
             20243        1'B;
      296    20244                          ELSE
      297    20245        ADDR(VFUBFR(%KV_VFU.LIN(VFU_CHNX)))->VFU_WORD.CHN_HI(%VFU_CHN_REVERSE-(VFU_CHNX-%VF
             20245        U_CHN_HI_BASE)) = '1'B;
      298    20246                          VFU_LINX = %KV_VFU.NXT(VFU_CHNX);
      299    20247                          DO WHILE (VFU_LINX ~= 0);
      300    20248                             IF VFU_CHNX < %VFU_CHN_HI_BASE THEN
      301    20249        ADDR(VFUBFR(%KV_VFU.LIN(VFU_LINX)))->VFU_WORD.CHN_LO(%VFU_CHN_REVERSE-VFU_CHNX) = '
             20249        1'B;
      302    20250                             ELSE
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:80   
      303    20251        ADDR(VFUBFR(%KV_VFU.LIN(VFU_LINX)))->VFU_WORD.CHN_HI(%VFU_CHN_REVERSE-(VFU_CHNX-%VF
             20251        U_CHN_HI_BASE)) = '1'B;
      304    20252                             VFU_LINX = %KV_VFU.NXT(VFU_LINX);
      305    20253                             END;
      306    20254                          END;
      307    20255                       END;
      308    20256
      309    20257                    ADDR(VFUBFR(1))->VFU_WORD.CHN_LO(%VFU_CHN_REVERSE-%VFU_CHN_TOF) = '1'B;
      310    20258        ADDR(VFUBFR(PAGLNG))->VFU_WORD.CHN_HI(%VFU_CHN_REVERSE-(%VFU_CHN_BOF-%VFU_CHN_HI_BA
             20258        SE)) = '1'B;
      311    20259        */
      312    20260    3               VFUBFR(1) = 'C17C'X;  /* 'A@' = Top-Of-Form */

  20260   1 0001AA  ECC7 0027                            LDB,B6   VFU_LIN$,AUTO
          1 0001AC  D870 C17C                            LDR,R5   -16004,IMO
          1 0001AE  DF46 0001                            STR,R5   1,B6

      313    20261    3               VFUBFR(PAGLNG) = '7C4A'X;  /* '@<cent-sign>' = Channel 12 */

  20261   1 0001B0  B847 0024                            LDR,R3   PAGLNG,AUTO
          1 0001B2  C870 7C4A                            LDR,R4   31818,IMO
          1 0001B4  CF36                                 STR,R4   ,B6,R3

      314    20262                    /* ESC '8' signals the end of a VFU record. */
      315    20263    3               VFUBFR(PAGLNG+1) = '27F8'X;

  20263   1 0001B5  3E01                                 ADV,R3   1
          1 0001B6  A870 27F8                            LDR,R2   10232,IMO
          1 0001B8  AF36                                 STR,R2   ,B6,R3

      316    20264    3               VFU$->KZ$OTPBFR.DATA_SIZ = (PAGLNG*2)+4;

  20264   1 0001B9  DCC7 0025                            LDB,B5   VFU$,AUTO
          1 0001BB  9847 0024                            LDR,R1   PAGLNG,AUTO
          1 0001BD  1001                                 SOL,R1   1
          1 0001BE  1E04                                 ADV,R1   4
          1 0001BF  9F45 0003                            STR,R1   3,B5
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:81   

      317    20265    3               TBFR$ = BFR$;

  20265   1 0001C1  DCC7 000C                            LDB,B5   BFR$,AUTO
          1 0001C3  DFC7 000E                            STB,B5   TBFR$,AUTO

      318    20266    3               BFR$ = VFU$;

  20266   1 0001C5  CCC7 0025                            LDB,B4   VFU$,AUTO
          1 0001C7  CFC7 000C                            STB,B4   BFR$,AUTO

      319    20267    3               CALL QUEUE_BFR;

  20267   1 0001C9  E3C0 0C48                            LNJ,B6   s:0,PREL
          1 0001CB       0001                            DC       s:20268,PREL

      320    20268    3               BFR$ = TBFR$;

  20268   1 0001CC  ECC7 000E                            LDB,B6   TBFR$,AUTO
          1 0001CE  EFC7 000C                            STB,B6   BFR$,AUTO

      321    20269    3               DVCTX.FLAGS.EVFU_LOADED = '1'B;

  20269   1 0001D0  DCC7 0008                            LDB,B5   DCTX$,AUTO
          1 0001D2  8945 001E                            LBT,'0080'X       30,B5
          1 0001D4       0080
          1 0001D5  0F81 0862                            B        s:20937,PREL

      322    20270    3             CASE(%KV_PRMID_FIRSTLINE);

      323    20271    4               IF %KV_VDI.UN_KNWPST THEN DO;

  20271   1 0001D7  DC80 0000 0000  xsym                 LDB,B5   KV$PTR$
          1 0001DA  CC85                                 LDB,B4   ,B5
          1 0001DB  82C4 001D                            LB,'1000'X        29,B4
          1 0001DD       1000
          1 0001DE  0581 0859                            BBF      s:20937,PREL
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:82   

      324    20272    4                  DVCTX.FLAGS.EVFU_LOADED = '0'B;

  20272   1 0001E0  BCC7 0008                            LDB,B3   DCTX$,AUTO
          1 0001E2  8843 001E                            LBF,'0080'X       30,B3
          1 0001E4       0080

      325    20273    4                  %KV_VDI.UN_KNWPST = '0'B;

  20273   1 0001E5  CC85                                 LDB,B4   ,B5
          1 0001E6  8844 001D                            LBF,'1000'X       29,B4
          1 0001E8       1000

      326    20274    4                  END;

      327    20275    3             END;

  20275   1 0001E9  0F81 084E                            B        s:20937,PREL

      328    20276        %EJECT;
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:83   
      329    20277    2          CASE(%KV_USR_FNC_OTPMRK);

      330    20278
      331    20279        /*D*     When VDH calls with KV_USR_FNC_OTPMRK, we are to add a
      332    20280                 marker entry in the current output block.  If the marker
      333    20281                 is not MSTRTR type and there is a marker previously saved in
      334    20282                 the current block of type NOT MSTRTR this marker data is
      335    20283                 inserted into its place.  Otherwise,  This marker must be
      336    20284                 added to the list of markers in this block.  If there is no
      337    20285                 space for it, the current record is completed and the block
      338    20286                 is output.  If the marker is marked as CMPOTP, the block
      339    20287                 containing it is output, as we will not receive any more data
      340    20288                 until this block is released after being sent.
      341    20289                                                                           */
      342    20290    2            IF DVCTX.MGR_TYPE = %KZ_S_DMCONSOLE# THEN

  20290   1 0001EB  DCC7 0008                            LDB,B5   DCTX$,AUTO
          1 0001ED  E2C5 0022                            LLH,R6   34,B5
          1 0001EF  6D03                                 CMV,R6   3
          1 0001F0  0981 0004                            BNE      s:20293,PREL

      343    20291    2               DCTX$ = DVCTX.LNK$;

  20291   1 0001F2  CC85                                 LDB,B4   ,B5
          1 0001F3  CFC7 0008                            STB,B4   DCTX$,AUTO

      344    20292
      345    20293    2            IF KV$USR_OTPMRK.DAT.MSTRTR AND

  20293   1 0001F5  89C6 0001                            CMZ      1,B6
          1 0001F7  0881 0008                            BAGE     s:20293+11,PREL
          1 0001F9  DCC7 000A                            LDB,B5   LCTX$,AUTO
          1 0001FB  82C5 004B                            LB,'0040'X        75,B5
          1 0001FD       0040
          1 0001FE  0581 0008                            BBF      s:20299,PREL
          1 000200  DCC7 0008                            LDB,B5   DCTX$,AUTO
          1 000202  E2C5 0022                            LLH,R6   34,B5
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:84   
          1 000204  6D01                                 CMV,R6   1
          1 000205  0981 0020                            BNE      s:20305,PREL

      346    20294    2               NOT KZ$LINCTX.PRO.RRR
      347    20295    2               OR DVCTX.MGR_TYPE = %KZ_S_DMINPUT#
      348    20296    3            THEN DO;

      349    20297                       /* Not SECURE:  immediately ACK all MSTRTR markers. */
      350    20298                       /* or input-only: just ACK everything. */
      351    20299    3               KV$VDH_OTPMRK = KV_VDH_OTPMRK;

  20299   1 000207  AB80 0000 0000  xsym                 LAB,B2   KV_VDH_OTPMRK
          1 00020A  2C00                                 LDV,R2   0
          1 00020B  6C0A                                 LDV,R6   10
          1 00020C  BBC7 0042                            LAB,B3   KV$VDH_OTPMRK,AUTO
          1 00020E  3C00                                 LDV,R3   0
          1 00020F  0008                                 MMM

      352    20300    3               KV$VDH_OTPMRK.DAT = KV$USR_OTPMRK.DAT;

  20300   1 000210  ACC7 0006                            LDB,B2   PARM$,AUTO
          1 000212  2C02                                 LDV,R2   2
          1 000213  6C06                                 LDV,R6   6
          1 000214  BBC7 0043                            LAB,B3   KV$VDH_OTPMRK+1,AUTO
          1 000216  3C00                                 LDV,R3   0
          1 000217  0008                                 MMM

      353    20301    3               CALL KVV$VDI (KV$VDH_OTPMRK);

  20301   1 000218  EBC7 0042                            LAB,B6   KV$VDH_OTPMRK,AUTO
          1 00021A  EFC7 0064                            STB,B6   P$+6,AUTO
          1 00021C  BBC7 0064                            LAB,B3   P$+6,AUTO
          1 00021E  CBF0 0100                            LAB,B4   256,IMO
          1 000220  E380 0000 0000  xent                 LNJ,B6   KVV$VDI
          1 000223       0001                            DC       s:20302,PREL

      354    20302    3               EXIT FNC_CASE;
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:85   

  20302   1 000224  0F81 0813                            B        s:20937,PREL

      355    20303    3               END;
      356    20304
      357    20305    2            IF BFR$=ADDR(NIL) THEN

  20305   1 000226  8DC7 000C                            CMN      BFR$,AUTO
          1 000228  0981 0004                            BNE      s:20307,PREL

      358    20306    2               CALL GET_BFR ALTRET(NOBUF);

  20306   1 00022A  E3C0 0AF8                            LNJ,B6   s:0,PREL
          1 00022C       0820                            DC       s:20955,PREL

      359    20307    2            IF NOT KV$USR_OTPMRK.DAT.MSTRTR AND KZ$OTPBFR.MRKCNT~=0 THEN

  20307   1 00022D  ECC7 0006                            LDB,B6   PARM$,AUTO
          1 00022F  89C6 0001                            CMZ      1,B6
          1 000231  0801 002F                            BAL      s:20316,PREL
          1 000233  DCC7 000C                            LDB,B5   BFR$,AUTO
          1 000235  82C5 0005                            LB,'00FF'X        5,B5
          1 000237       00FF
          1 000238  0581 0028                            BBF      s:20316,PREL

      360    20308    3            DO I = 1 TO KZ$OTPBFR.MRKCNT;

  20308   1 00023A  6C01                                 LDV,R6   1
          1 00023B  EF47 0013                            STR,R6   I,AUTO
          1 00023D  0F81 001A                            B        s:20314+2,PREL

      361    20309    3               T$=PINCRW(BFR$,KZ$OTPBFR.BFRSIZ - SIZEW(KV$OTPMRK)*I);

  20309   1 00023F  ECC7 000C                            LDB,B6   BFR$,AUTO
          1 000241  E847 0013                            LDR,R6   I,AUTO
          1 000243  6FFD                                 MLV,R6   -3
          1 000244  EA46 0004                            ADD,R6   4,B6
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:86   
          1 000246  B856                                 LDR,R3   R6
          1 000247  DBB6                                 LAB,B5   ,B6,R3
          1 000248  DFC7 0014                            STB,B5   T$,AUTO

      362    20310    4               IF NOT T$->KV$OTPMRK.MSTRTR THEN DO;

  20310   1 00024A  8985                                 CMZ      ,B5
          1 00024B  0801 000A                            BAL      s:20314,PREL

      363    20311    4                  T$->KV$OTPMRK=KV$USR_OTPMRK.DAT;

  20311   1 00024D  ACC7 0006                            LDB,B2   PARM$,AUTO
          1 00024F  2C02                                 LDV,R2   2
          1 000250  6C06                                 LDV,R6   6
          1 000251  BB85                                 LAB,B3   ,B5
          1 000252  3C00                                 LDV,R3   0
          1 000253  0008                                 MMM

      364    20312    4                  GOTO MRKRX;

  20312   1 000254  0F81 003E                            B        s:20328,PREL

      365    20313    4                  END;
      366    20314    3               END;

  20314   1 000256  8AC7 0013                            INC      I,AUTO
          1 000258  ECC7 000C                            LDB,B6   BFR$,AUTO
          1 00025A  E846 0005                            LDR,R6   5,B6
          1 00025C  E570 00FF                            AND,R6   255,IMO
          1 00025E  E947 0013                            CMR,R6   I,AUTO
          1 000260  02DF                                 BGE      s:20309,SPREL

      367    20315
      368    20316    3            IF KZ$OTPBFR.MRKCNT = 2 THEN DO;

  20316   1 000261  ECC7 000C                            LDB,B6   BFR$,AUTO
          1 000263  E846 0005                            LDR,R6   5,B6
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:87   
          1 000265  E570 00FF                            AND,R6   255,IMO
          1 000267  6D02                                 CMV,R6   2
          1 000268  0981 0004                            BNE      s:20320,PREL

      369    20317    3               CALL FINOTPBFR ALTRET(NOBUF);

  20317   1 00026A  E3C0 0C29                            LNJ,B6   s:0,PREL
          1 00026C       07E0                            DC       s:20955,PREL

      370    20318    3               END;

      371    20319
      372    20320    2            KZ$OTPBFR.MRKCNT=KZ$OTPBFR.MRKCNT+1;

  20320   1 00026D  ECC7 000C                            LDB,B6   BFR$,AUTO
          1 00026F  E846 0005                            LDR,R6   5,B6
          1 000271  EA70 0001                            ADD,R6   1,IMO
          1 000273  EAC6 0005                            SRM,R6,'00FF'X    5,B6
          1 000275       00FF

      373    20321    2            T$=PINCRW(BFR$,KZ$OTPBFR.BFRSIZ-SIZEW(KV$OTPMRK)*KZ$OTPBFR.MRKCNT);

  20321   1 000276  ECC7 000C                            LDB,B6   BFR$,AUTO
          1 000278  E846 0005                            LDR,R6   5,B6
          1 00027A  E570 00FF                            AND,R6   255,IMO
          1 00027C  6FFD                                 MLV,R6   -3
          1 00027D  EA46 0004                            ADD,R6   4,B6
          1 00027F  B856                                 LDR,R3   R6
          1 000280  DBB6                                 LAB,B5   ,B6,R3
          1 000281  DFC7 0014                            STB,B5   T$,AUTO

      374    20322    2            T$->KV$OTPMRK=KV$USR_OTPMRK.DAT;

  20322   1 000283  ACC7 0006                            LDB,B2   PARM$,AUTO
          1 000285  2C02                                 LDV,R2   2
          1 000286  6C06                                 LDV,R6   6
          1 000287  BB85                                 LAB,B3   ,B5
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:88   
          1 000288  3C00                                 LDV,R3   0
          1 000289  0008                                 MMM

      375    20323
      376    20324    3            IF KV$USR_OTPMRK.CMPOTP THEN DO;

  20324   1 00028A  ECC7 0006                            LDB,B6   PARM$,AUTO
          1 00028C  8286                                 LB,'0080'X        ,B6
          1 00028D       0080
          1 00028E  0581 0004                            BBF      s:20328,PREL

      377    20325                      /* Process this OTPMRK thru data stream - we'll recieve
      378    20326                         no more data until the pipe is clear         */
      379    20327    3   OTPMRK0:    CALL FINOTPBFR ALTRET(NOBUF);

  20327   1 000290  E3C0 0C03            OTPMRK0         LNJ,B6   s:0,PREL
          1 000292       07BA                            DC       s:20955,PREL

      380    20328    3               END;

  20324   1 000293  0F81 07A4            MRKRX           B        s:20937,PREL

      381    20329    2   MRKRX:   ;
      382    20330        %EJECT;
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:89   
      383    20331    2          CASE(%KV_USR_FNC_PST);

      384    20332
      385    20333        /*D*     When VDH calls with KV_USR_FNC_PST, we are at an end of record
      386    20334                 and some positioning information must be output.  If it is a
      387    20335                 HASP line, the SCB for the current string is set.  If the
      388    20336                 positioning requires Top Of Form the required number of top
      389    20337                 skip to top of page VFC records is output, with appropriate
      390    20338                 one byte blank records.
      391    20339
      392    20340                 Upspace n lines is done in the same manner generating blank
      393    20341                 records with Space n Lines After Printing controls.
      394    20342
      395    20343                 Position n columns on the same line allows us to do blank
      396    20344                 compression for both HASP and 2780/3780 lines.  The appropriate
      397    20345                 SCB is generated to skip over n blanks.
      398    20346
      399    20347                 If the posiiton causes a skip back to column one of the same
      400    20348                 line, the current record is ended and given a VFC of upspace
      401    20349                 zero after print.  If the position is backkwards, but not to
      402    20350                 column one,  The proper place to insert an SCB is computed
      403    20351                 and the current buffer pointer and size set to that place. */
      404    20352
      405    20353
      406    20354    2            IF DVCTX.MGR_TYPE = %KZ_S_DMCONSOLE# THEN

  20354   1 000295  DCC7 0008                            LDB,B5   DCTX$,AUTO
          1 000297  E2C5 0022                            LLH,R6   34,B5
          1 000299  6D03                                 CMV,R6   3
          1 00029A  0981 0004                            BNE      s:20356,PREL

      407    20355    2               DCTX$ = DVCTX.LNK$;

  20355   1 00029C  CC85                                 LDB,B4   ,B5
          1 00029D  CFC7 0008                            STB,B4   DCTX$,AUTO

      408    20356    2            IF BFR$=ADDR(NIL) THEN
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:90   

  20356   1 00029F  8DC7 000C                            CMN      BFR$,AUTO
          1 0002A1  0981 0004                            BNE      s:20358,PREL

      409    20357    2               CALL GET_BFR ALTRET(NOBUF);

  20357   1 0002A3  E3C0 0A7F                            LNJ,B6   s:0,PREL
          1 0002A5       07A7                            DC       s:20955,PREL

      410    20358    2            IF KZ$LINCTX.PRO.PROTYP = %KLPT_HASP#

  20358   1 0002A6  ECC7 000A                            LDB,B6   LCTX$,AUTO
          1 0002A8  E846 003A                            LDR,R6   58,B6
          1 0002AA  6D03                                 CMV,R6   3
          1 0002AB  0901 0004                            BE       s:20360,PREL
          1 0002AD  6D07                                 CMV,R6   7
          1 0002AE  0981 000C                            BNE      s:20365,PREL

      411    20359    3               OR KZ$LINCTX.PRO.PROTYP = %KLPT_NJE# THEN DO;

      412    20360    3               CALL SET_SCB;

  20360   1 0002B0  E3C0 0D84                            LNJ,B6   s:0,PREL
          1 0002B2       0001                            DC       s:20361,PREL

      413    20361    3               DVCTX.LASTSCBX = BYTX;

  20361   1 0002B3  ECC7 0008                            LDB,B6   DCTX$,AUTO
          1 0002B5  E847 0010                            LDR,R6   BYTX,AUTO
          1 0002B7  EF46 0020                            STR,R6   32,B6

      414    20362    3               BYTX=BYTX+1;

  20362   1 0002B9  8AC7 0010                            INC      BYTX,AUTO

      415    20363    3               END;

PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:91   
      416    20364
      417    20365    2            CALL CMPBYTSIZ;

  20365   1 0002BB  E3C0 0B86                            LNJ,B6   s:0,PREL
          1 0002BD       0001                            DC       s:20369,PREL

      418    20366
      419    20367                 /* Output SKA 1 for top of page requests                  */
      420    20368
      421    20369    3            IF KV$USR_PST.TOPPAGCNT > 0 THEN DO;

  20369   1 0002BE  ECC7 0006                            LDB,B6   PARM$,AUTO
          1 0002C0  8286                                 LB,'00FF'X        ,B6
          1 0002C1       00FF
          1 0002C2  0581 0078                            BBF      s:20401,PREL

      422    20370    4               DO K = 1 TO KV$USR_PST.TOPPAGCNT;

  20370   1 0002C4  6C01                                 LDV,R6   1
          1 0002C5  EF47 0018                            STR,R6   K,AUTO
          1 0002C7  0F81 005E                            B        s:20394+2,PREL

      423    20371    5                  IF DVCTX.ACCESS_METHOD = %KZ_S_ACSPRINT# THEN DO;

  20371   1 0002C9  ECC7 0008                            LDB,B6   DCTX$,AUTO
          1 0002CB  E846 0022                            LDR,R6   34,B6
          1 0002CD  E570 00FF                            AND,R6   255,IMO
          1 0002CF  6D01                                 CMV,R6   1
          1 0002D0  0981 000B                            BNE      s:20376,PREL

      424    20372    5                     M='91'X;

  20372   1 0002D2  D870 9100                            LDR,R5   -28416,IMO
          1 0002D4  5048                                 SOR,R5   8
          1 0002D5  D7C7 001A                            STH,R5   M,AUTO

      425    20373    5                     N=1;
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:92   

  20373   1 0002D7  5C01                                 LDV,R5   1
          1 0002D8  DF47 001B                            STR,R5   N,AUTO

      426    20374    5                     END;

  20374   1 0002DA  0F81 0012                            B        s:20379,PREL

      427    20375    5                  ELSE DO;

      428    20376    5                     M='80'X;

  20376   1 0002DC  D870 8000                            LDR,R5   -32768,IMO
          1 0002DE  5048                                 SOR,R5   8
          1 0002DF  D7C7 001A                            STH,R5   M,AUTO

      429    20377    5                     N=%KV_MRD.LNG-%KV_MRD.DVCLIN+1;

  20377   1 0002E1  DC80 0000 0000  xsym                 LDB,B5   KV$PTR$
          1 0002E4  CCC5 0008                            LDB,B4   8,B5
          1 0002E6  D2C4 0015                            LLH,R5   21,B4
          1 0002E8  D244 001D                            SUB,R5   29,B4
          1 0002EA  5E01                                 ADV,R5   1
          1 0002EB  DF47 001B                            STR,R5   N,AUTO

      430    20378    5                     END;

      431    20379    5                  DO WHILE N ~= 0;

  20379   1 0002ED  5901 0036                            BEZ,R5   s:20394,PREL

      432    20380    5                     IF KZ$LINCTX.PRO.PROTYP = %KLPT_HASP#

  20380   1 0002EF  ECC7 000A                            LDB,B6   LCTX$,AUTO
          1 0002F1  E846 003A                            LDR,R6   58,B6
          1 0002F3  6D03                                 CMV,R6   3
          1 0002F4  0901 0004                            BE       s:20382,PREL
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:93   
          1 0002F6  6D07                                 CMV,R6   7
          1 0002F7  0981 001E                            BNE      s:20388,PREL

      433    20381    6                        OR KZ$LINCTX.PRO.PROTYP = %KLPT_NJE# THEN DO;

      434    20382    6                        KZ$HASPSRCB(DVCTX.LASTRCBX+1) = M;

  20382   1 0002F9  DCC7 0008                            LDB,B5   DCTX$,AUTO
          1 0002FB  B845 0021                            LDR,R3   33,B5
          1 0002FD  D2C7 001A                            LLH,R5   M,AUTO
          1 0002FF  5008                                 SOL,R5   8
          1 000300  5048                                 SOR,R5   8
          1 000301  CCC7 000C                            LDB,B4   BFR$,AUTO
          1 000303  3E01                                 ADV,R3   1
          1 000304  D7B4                                 STH,R5   ,B4,R3

      435    20383    6                        IF DVCTX.LASTSCBX = DVCTX.LASTRCBX + 2 THEN

  20383   1 000305  DCC7 0008                            LDB,B5   DCTX$,AUTO
          1 000307  E845 0021                            LDR,R6   33,B5
          1 000309  6E02                                 ADV,R6   2
          1 00030A  E945 0020                            CMR,R6   32,B5
          1 00030C  0981 0004                            BNE      s:20385,PREL

      436    20384    6                           CALL BLDBLNKSTR ALTRET(NOBUF);

  20384   1 00030E  E3C0 0D58                            LNJ,B6   s:0,PREL
          1 000310       073C                            DC       s:20955,PREL

      437    20385    6                        CALL ENDSTR;

  20385   1 000311  E3C0 0B4E                            LNJ,B6   s:0,PREL
          1 000313       0001                            DC       s:20386,PREL

      438    20386    6                        END;

  20386   1 000314  0F81 0007                            B        s:20391,PREL
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:94   

      439    20387    6                     ELSE DO;

      440    20388    6                        I=4;          /* Skip to channel 1 VFC */

  20388   1 000316  5C04                                 LDV,R5   4
          1 000317  DF47 0013                            STR,R5   I,AUTO

      441    20389    6                        CALL BLDUPSPCREC ALTRET(NOBUF);

  20389   1 000319  E3C0 0C64                            LNJ,B6   s:0,PREL
          1 00031B       0731                            DC       s:20955,PREL

      442    20390    6                        END;

      443    20391    5                     CALL CHKEOB ALTRET(NOBUF);

  20391   1 00031C  E3C0 0CFA                            LNJ,B6   s:0,PREL
          1 00031E       072E                            DC       s:20955,PREL

      444    20392    5                     N=N-1;

  20392   1 00031F  88C7 001B                            DEC      N,AUTO

      445    20393    5                     END;

  20393   1 000321  E847 001B                            LDR,R6   N,AUTO
          1 000323  69CC                                 BNEZ,R6  s:20380,SPREL

      446    20394    4                  END;

  20394   1 000324  8AC7 0018                            INC      K,AUTO
          1 000326  ECC7 0006                            LDB,B6   PARM$,AUTO
          1 000328  E806                                 LDR,R6   ,B6
          1 000329  E570 00FF                            AND,R6   255,IMO
          1 00032B  E947 0018                            CMR,R6   K,AUTO
          1 00032D  0881 FF9B                            BAGE     s:20371,PREL
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:95   

      447    20395    3               %KV_MRD.DVCLIN = 1;

  20395   1 00032F  DC80 0000 0000  xsym                 LDB,B5   KV$PTR$
          1 000332  CCC5 0008                            LDB,B4   8,B5
          1 000334  5C01                                 LDV,R5   1
          1 000335  DF44 001D                            STR,R5   29,B4

      448    20396    3               %KV_MRD.DVCCLM = 1;

  20396   1 000337  CCC5 0008                            LDB,B4   8,B5
          1 000339  DF44 001E                            STR,R5   30,B4

      449    20397    3               END;

      450    20398
      451    20399                 /* Position to proper line on page                        */
      452    20400
      453    20401    2            K = KV$USR_PST.PHSPST.LIN - %KV_MRD.DVCLIN;

  20401   1 00033B  DC80 0000 0000  xsym                 LDB,B5   KV$PTR$
          1 00033E  CCC5 0008                            LDB,B4   8,B5
          1 000340  E846 0001                            LDR,R6   1,B6
          1 000342  E244 001D                            SUB,R6   29,B4
          1 000344  EF47 0018                            STR,R6   K,AUTO

      454    20402    3            DO WHILE (K > 0);

  20402   1 000346  6A81 007E                            BLEZ,R6  s:20429,PREL

      455    20403    3               IF DVCTX.ACCESS_METHOD = %KZ_S_ACSPRINT# THEN

  20403   1 000348  ECC7 0008                            LDB,B6   DCTX$,AUTO
          1 00034A  E846 0022                            LDR,R6   34,B6
          1 00034C  E570 00FF                            AND,R6   255,IMO
          1 00034E  6D01                                 CMV,R6   1
          1 00034F  0981 000F                            BNE      s:20409,PREL
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:96   

      456    20404    3                  IF K > 3 THEN

  20404   1 000351  D847 0018                            LDR,R5   K,AUTO
          1 000353  5D03                                 CMV,R5   3
          1 000354  0A81 0006                            BALE     s:20407,PREL

      457    20405    3                     I = 3;

  20405   1 000356  4C03                                 LDV,R4   3
          1 000357  CF47 0013                            STR,R4   I,AUTO
          1 000359  0F81 0008                            B        s:20410,PREL

      458    20406    3                  ELSE
      459    20407    3                     I = K;

  20407   1 00035B  DF47 0013                            STR,R5   I,AUTO
          1 00035D  0F81 0004                            B        s:20410,PREL

      460    20408    3               ELSE
      461    20409    3                  I=1;                /* Punch multiple records as req'd */

  20409   1 00035F  5C01                                 LDV,R5   1
          1 000360  DF47 0013                            STR,R5   I,AUTO

      462    20410    3               IF KZ$LINCTX.PRO.PROTYP = %KLPT_HASP#

  20410   1 000362  DCC7 000A                            LDB,B5   LCTX$,AUTO
          1 000364  D845 003A                            LDR,R5   58,B5
          1 000366  5D03                                 CMV,R5   3
          1 000367  0901 0004                            BE       s:20412,PREL
          1 000369  5D07                                 CMV,R5   7
          1 00036A  0981 003A                            BNE      s:20420,PREL

      463    20411    4                  OR KZ$LINCTX.PRO.PROTYP = %KLPT_NJE# THEN DO;

      464    20412    4                  KZ$HASPSRCB(DVCTX.LASTRCBX+1) = '80'X;
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:97   

  20412   1 00036C  B846 0021                            LDR,R3   33,B6
          1 00036E  C870 8000                            LDR,R4   -32768,IMO
          1 000370  4048                                 SOR,R4   8
          1 000371  CCC7 000C                            LDB,B4   BFR$,AUTO
          1 000373  3E01                                 ADV,R3   1
          1 000374  C7B4                                 STH,R4   ,B4,R3

      465    20413    4                  IF DVCTX.ACCESS_METHOD = %KZ_S_ACSPRINT# THEN

  20413   1 000375  ECC7 0008                            LDB,B6   DCTX$,AUTO
          1 000377  E846 0022                            LDR,R6   34,B6
          1 000379  E570 00FF                            AND,R6   255,IMO
          1 00037B  6D01                                 CMV,R6   1
          1 00037C  0981 0017                            BNE      s:20415,PREL

      466    20414    4                     KZ$HASPSRCB.S.UPSP_CT(DVCTX.LASTRCBX+1) = I;

  20414   1 00037E  B846 0021                            LDR,R3   33,B6
          1 000380  F847 0013                            LDR,R7   I,AUTO
          1 000382  6C00                                 LDV,R6   0
          1 000383  709E                                 DOL,R7   30
          1 000384  8D47 0064                            SDI      P$+6,AUTO
          1 000386  BF47 0066                            STR,R3   P$+8,AUTO
          1 000388  ABC7 0064                            LAB,B2   P$+6,AUTO
          1 00038A  2C00                                 LDV,R2   0
          1 00038B  6C20                                 LDV,R6   32
          1 00038C  BCC7 000C                            LDB,B3   BFR$,AUTO
          1 00038E  3003                                 SOL,R3   3
          1 00038F  3E0E                                 ADV,R3   14
          1 000390  7C02                                 LDV,R7   2
          1 000391  D380 0000 0000  xent                 LNJ,B5   X6B_BLR

      467    20415    4                  IF DVCTX.LASTSCBX = DVCTX.LASTRCBX + 2 THEN

  20415   1 000394  ECC7 0008                            LDB,B6   DCTX$,AUTO
          1 000396  E846 0021                            LDR,R6   33,B6
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:98   
          1 000398  6E02                                 ADV,R6   2
          1 000399  E946 0020                            CMR,R6   32,B6
          1 00039B  0981 0004                            BNE      s:20417,PREL

      468    20416    4                     CALL BLDBLNKSTR ALTRET(NOBUF);

  20416   1 00039D  E3C0 0CC9                            LNJ,B6   s:0,PREL
          1 00039F       06AD                            DC       s:20955,PREL

      469    20417    4                  CALL ENDSTR;

  20417   1 0003A0  E3C0 0ABF                            LNJ,B6   s:0,PREL
          1 0003A2       0001                            DC       s:20418,PREL

      470    20418    4                  END;

  20418   1 0003A3  0F81 0004                            B        s:20422,PREL

      471    20419    4               ELSE DO;

      472    20420    4                  CALL BLDUPSPCREC ALTRET(NOBUF);

  20420   1 0003A5  E3C0 0BD8                            LNJ,B6   s:0,PREL
          1 0003A7       06A5                            DC       s:20955,PREL

      473    20421    4                  END;

      474    20422    3               K=K-I;

  20422   1 0003A8  E847 0018                            LDR,R6   K,AUTO
          1 0003AA  E247 0013                            SUB,R6   I,AUTO
          1 0003AC  EF47 0018                            STR,R6   K,AUTO

      475    20423    3               CALL CHKEOB ALTRET(NOBUF);

  20423   1 0003AE  E3C0 0C68                            LNJ,B6   s:0,PREL
          1 0003B0       069C                            DC       s:20955,PREL
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:99   

      476    20424    3               %KV_MRD.DVCCLM = 1;

  20424   1 0003B1  EC80 0000 0000  xsym                 LDB,B6   KV$PTR$
          1 0003B4  DCC6 0008                            LDB,B5   8,B6
          1 0003B6  6C01                                 LDV,R6   1
          1 0003B7  EF45 001E                            STR,R6   30,B5

      477    20425    3               %KV_MRD.DVCLIN=KV$USR_PST.PHSPST.LIN;

  20425   1 0003B9  DCC6 0008                            LDB,B5   8,B6
          1 0003BB  CCC7 0006                            LDB,B4   PARM$,AUTO
          1 0003BD  D844 0001                            LDR,R5   1,B4
          1 0003BF  DF45 001D                            STR,R5   29,B5

      478    20426    3               END;

  20426   1 0003C1  D847 0018                            LDR,R5   K,AUTO
          1 0003C3  5A01 FF84                            BGZ,R5   s:20403,PREL

      479    20427
      480    20428
      481    20429    2            K = KV$USR_PST.PHSPST.CLM - %KV_MRD.DVCCLM;

  20429   1 0003C5  EC80 0000 0000  xsym                 LDB,B6   KV$PTR$
          1 0003C8  DCC6 0008                            LDB,B5   8,B6
          1 0003CA  CCC7 0006                            LDB,B4   PARM$,AUTO
          1 0003CC  E844 0002                            LDR,R6   2,B4
          1 0003CE  E245 001E                            SUB,R6   30,B5
          1 0003D0  EF47 0018                            STR,R6   K,AUTO

      482    20430    3            DO WHILE (K < 0);

  20430   1 0003D2  6881 0040                            BGEZ,R6  s:20451,PREL

      483    20431
      484    20432                    /* If overprint finish preceeding record with upspace 0
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:100  
      485    20433                       and set column pointer back to one.                 */
      486    20434
      487    20435    3               IF KZ$LINCTX.PRO.PROTYP = %KLPT_HASP#

  20435   1 0003D4  ECC7 000A                            LDB,B6   LCTX$,AUTO
          1 0003D6  E846 003A                            LDR,R6   58,B6
          1 0003D8  6D03                                 CMV,R6   3
          1 0003D9  0901 0004                            BE       s:20437,PREL
          1 0003DB  6D07                                 CMV,R6   7
          1 0003DC  0981 0018                            BNE      s:20443,PREL

      488    20436    3                  OR KZ$LINCTX.PRO.PROTYP = %KLPT_NJE# THEN
      489    20437    4                  IF DVCTX.LASTSCBX > DVCTX.LASTRCBX + 3 THEN DO;

  20437   1 0003DE  DCC7 0008                            LDB,B5   DCTX$,AUTO
          1 0003E0  D845 0021                            LDR,R5   33,B5
          1 0003E2  5E03                                 ADV,R5   3
          1 0003E3  D945 0020                            CMR,R5   32,B5
          1 0003E5  0281 001D                            BGE      s:20448,PREL

      490    20438    4                     KZ$HASPSRCB(DVCTX.LASTRCBX+1) = '80'X;

  20438   1 0003E7  B845 0021                            LDR,R3   33,B5
          1 0003E9  C870 8000                            LDR,R4   -32768,IMO
          1 0003EB  4048                                 SOR,R4   8
          1 0003EC  CCC7 000C                            LDB,B4   BFR$,AUTO
          1 0003EE  3E01                                 ADV,R3   1
          1 0003EF  C7B4                                 STH,R4   ,B4,R3

      491    20439    4                     CALL ENDSTR;

  20439   1 0003F0  E3C0 0A6F                            LNJ,B6   s:0,PREL
          1 0003F2       0001                            DC       s:20440,PREL

      492    20440    4                     END;

  20440   1 0003F3  0F81 000F                            B        s:20448,PREL
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:101  

      493    20441    3                  ELSE;
      494    20442    3               ELSE
      495    20443    4                  IF BYTX > DVCTX.LASTRCBX + 2 THEN DO;

  20443   1 0003F5  DCC7 0008                            LDB,B5   DCTX$,AUTO
          1 0003F7  D845 0021                            LDR,R5   33,B5
          1 0003F9  5E02                                 ADV,R5   2
          1 0003FA  D947 0010                            CMR,R5   BYTX,AUTO
          1 0003FC  0281 0006                            BGE      s:20448,PREL

      496    20444    4                     I=0;

  20444   1 0003FE  8747 0013                            CL       I,AUTO

      497    20445    4                     CALL BLDUPSPCREC ALTRET(NOBUF);

  20445   1 000400  E3C0 0B7D                            LNJ,B6   s:0,PREL
          1 000402       064A                            DC       s:20955,PREL

      498    20446    4                     END;

      499    20447    3                  ELSE;
      500    20448    3               %KV_MRD.DVCCLM = 1;

  20448   1 000403  EC80 0000 0000  xsym                 LDB,B6   KV$PTR$
          1 000406  DCC6 0008                            LDB,B5   8,B6
          1 000408  6C01                                 LDV,R6   1
          1 000409  EF45 001E                            STR,R6   30,B5

      501    20449    3               K = KV$USR_PST.PHSPST.CLM - 1;

  20449   1 00040B  DCC7 0006                            LDB,B5   PARM$,AUTO
          1 00040D  D845 0002                            LDR,R5   2,B5
          1 00040F  5EFF                                 ADV,R5   -1
          1 000410  DF47 0018                            STR,R5   K,AUTO

PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:102  
      502    20450    3               END;

  20450   1 000412  5842                                 BLZ,R5   s:20435,SPREL

      503    20451    3            DO WHILE (K > 0);

  20451   1 000413  E847 0018                            LDR,R6   K,AUTO
          1 000415  6A81 00AC                            BLEZ,R6  s:20500,PREL

      504    20452    3               IF K > 31 THEN

  20452   1 000417  E847 0018                            LDR,R6   K,AUTO
          1 000419  6D1F                                 CMV,R6   31
          1 00041A  0A81 0006                            BALE     s:20455,PREL

      505    20453    3                  I = 31;

  20453   1 00041C  5C1F                                 LDV,R5   31
          1 00041D  DF47 0013                            STR,R5   I,AUTO
          1 00041F  0F81 0003                            B        s:20456,PREL

      506    20454    3               ELSE
      507    20455    3                  I = K;

  20455   1 000421  EF47 0013                            STR,R6   I,AUTO

      508    20456    3               IF KZ$LINCTX.PRO.COMPRESS = %KLCO_NO# OR

  20456   1 000423  ECC7 000A                            LDB,B6   LCTX$,AUTO
          1 000425  D846 0040                            LDR,R5   64,B6
          1 000427  5901 0006                            BEZ,R5   s:20458,PREL
          1 000429  C846 003A                            LDR,R4   58,B6
          1 00042B  4D01                                 CMV,R4   1
          1 00042C  0981 0054                            BNE      s:20478,PREL

      509    20457    4                  KZ$LINCTX.PRO.PROTYP = %KLPT_2780# THEN DO;

PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:103  
      510    20458    5                  IF J < I+5 THEN DO;

  20458   1 00042E  C847 0013                            LDR,R4   I,AUTO
          1 000430  4E05                                 ADV,R4   5
          1 000431  4801 0005                            BLZ,R4   s:20459,PREL
          1 000433  C947 0012                            CMR,R4   J,AUTO
          1 000435  0A81 0007                            BALE     s:20462,PREL

      511    20459    5                     CALL DONE ALTRET(NOBUF);

  20459   1 000437  E3C0 079B                            LNJ,B6   s:0,PREL
          1 000439       0613                            DC       s:20955,PREL

      512    20460    5                     CALL CMPBYTSIZ;

  20460   1 00043A  E3C0 0A07                            LNJ,B6   s:0,PREL
          1 00043C       0001                            DC       s:20462,PREL

      513    20461    5                     END;

      514    20462    5                  DO L = 1 TO I;

  20462   1 00043D  6C01                                 LDV,R6   1
          1 00043E  EF47 0019                            STR,R6   L,AUTO
          1 000440  0F81 0015                            B        s:20465+2,PREL

      515    20463    5                     BYT(BYTX) = ASCBIT(%KV_MVD.TRNTBL$->KV$TRNTBL.SP_CHR);

  20463   1 000442  EC80 0000 0000  xsym                 LDB,B6   KV$PTR$
          1 000445  DCC6 0006                            LDB,B5   6,B6
          1 000447  CCC5 000E                            LDB,B4   14,B5
          1 000449  E844 001D                            LDR,R6   29,B4
          1 00044B  6008                                 SOL,R6   8
          1 00044C  6048                                 SOR,R6   8
          1 00044D  BCC7 000C                            LDB,B3   BFR$,AUTO
          1 00044F  B847 0010                            LDR,R3   BYTX,AUTO
          1 000451  E7B3                                 STH,R6   ,B3,R3
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:104  

      516    20464    5                     BYTX = BYTX + 1;

  20464   1 000452  8AC7 0010                            INC      BYTX,AUTO

      517    20465    5                     END;

  20465   1 000454  8AC7 0019                            INC      L,AUTO
          1 000456  E847 0019                            LDR,R6   L,AUTO
          1 000458  E947 0013                            CMR,R6   I,AUTO
          1 00045A  03E8                                 BLE      s:20463,SPREL

      518    20466    4                  IF KZ$LINCTX.PRO.PROTYP = %KLPT_HASP#

  20466   1 00045B  ECC7 000A                            LDB,B6   LCTX$,AUTO
          1 00045D  D846 003A                            LDR,R5   58,B6
          1 00045F  5D03                                 CMV,R5   3
          1 000460  0901 0004                            BE       s:20468,PREL
          1 000462  5D07                                 CMV,R5   7
          1 000463  0981 0015                            BNE      s:20474,PREL

      519    20467    5                     OR KZ$LINCTX.PRO.PROTYP = %KLPT_NJE# THEN DO;

      520    20468    5                     J=J-I-1;

  20468   1 000465  C847 0012                            LDR,R4   J,AUTO
          1 000467  C247 0013                            SUB,R4   I,AUTO
          1 000469  4EFF                                 ADV,R4   -1
          1 00046A  CF47 0012                            STR,R4   J,AUTO

      521    20469    5                     CALL SET_SCB;

  20469   1 00046C  E3C0 0BC8                            LNJ,B6   s:0,PREL
          1 00046E       0001                            DC       s:20470,PREL

      522    20470    5                     DVCTX.LASTSCBX = BYTX;

PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:105  
  20470   1 00046F  ECC7 0008                            LDB,B6   DCTX$,AUTO
          1 000471  E847 0010                            LDR,R6   BYTX,AUTO
          1 000473  EF46 0020                            STR,R6   32,B6

      523    20471    5                     BYTX = BYTX + 1;

  20471   1 000475  8AC7 0010                            INC      BYTX,AUTO

      524    20472    5                     END;

  20472   1 000477  0F81 0042                            B        s:20495,PREL

      525    20473    5                  ELSE DO;

      526    20474    5                     J=J-I;

  20474   1 000479  C847 0012                            LDR,R4   J,AUTO
          1 00047B  C247 0013                            SUB,R4   I,AUTO
          1 00047D  CF47 0012                            STR,R4   J,AUTO

      527    20475    5                     END;

      528    20476    4                  END;

  20476   1 00047F  0F81 003A                            B        s:20495,PREL

      529    20477    4               ELSE DO;

      530    20478    4                  IF KZ$LINCTX.PRO.PROTYP = %KLPT_HASP#

  20478   1 000481  4D03                                 CMV,R4   3
          1 000482  0901 0004                            BE       s:20483,PREL
          1 000484  4D07                                 CMV,R4   7
          1 000485  0981 0018                            BNE      s:20489,PREL

      531    20479    5                     OR KZ$LINCTX.PRO.PROTYP = %KLPT_NJE# THEN DO;

PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:106  
      532    20480
      533    20481                          /* Set ~END + char count                         */
      534    20482
      535    20483    5                     KZ$HASPSCB(DVCTX.LASTSCBX) = '80'X|BINBIT(I,8);

  20483   1 000487  DCC7 0008                            LDB,B5   DCTX$,AUTO
          1 000489  B845 0020                            LDR,R3   32,B5
          1 00048B  A847 0013                            LDR,R2   I,AUTO
          1 00048D  2008                                 SOL,R2   8
          1 00048E  A470 8000                            OR,R2    -32768,IMO
          1 000490  2048                                 SOR,R2   8
          1 000491  CCC7 000C                            LDB,B4   BFR$,AUTO
          1 000493  A7B4                                 STH,R2   ,B4,R3

      536    20484    5                     J = J - 1;

  20484   1 000494  88C7 0012                            DEC      J,AUTO

      537    20485    5                     DVCTX.LASTSCBX = DVCTX.LASTSCBX + 1;

  20485   1 000496  DCC7 0008                            LDB,B5   DCTX$,AUTO
          1 000498  8AC5 0020                            INC      32,B5

      538    20486    5                     BYTX = BYTX + 1;

  20486   1 00049A  8AC7 0010                            INC      BYTX,AUTO

      539    20487    5                     END;

  20487   1 00049C  0F81 001D                            B        s:20495,PREL

      540    20488    5                  ELSE DO;

      541    20489    5                     BYT(BYTX) = '1D'X;

  20489   1 00049E  B870 1D00                            LDR,R3   7424,IMO
          1 0004A0  3048                                 SOR,R3   8
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:107  
          1 0004A1  DCC7 000C                            LDB,B5   BFR$,AUTO
          1 0004A3  A847 0010                            LDR,R2   BYTX,AUTO
          1 0004A5  B7A5                                 STH,R3   ,B5,R2

      542    20490    5                     BYT(BYTX+1) = '40'X | BINBIT(I,8);

  20490   1 0004A6  D847 0013                            LDR,R5   I,AUTO
          1 0004A8  5008                                 SOL,R5   8
          1 0004A9  D470 4000                            OR,R5    16384,IMO
          1 0004AB  5048                                 SOR,R5   8
          1 0004AC  DCC7 000C                            LDB,B5   BFR$,AUTO
          1 0004AE  2E01                                 ADV,R2   1
          1 0004AF  D7A5                                 STH,R5   ,B5,R2

      543    20491    5                     J = J - 2;

  20491   1 0004B0  D847 0012                            LDR,R5   J,AUTO
          1 0004B2  5EFE                                 ADV,R5   -2
          1 0004B3  DF47 0012                            STR,R5   J,AUTO

      544    20492    5                     BYTX = BYTX +2;

  20492   1 0004B5  C847 0010                            LDR,R4   BYTX,AUTO
          1 0004B7  4E02                                 ADV,R4   2
          1 0004B8  CF47 0010                            STR,R4   BYTX,AUTO

      545    20493    5                     END;

      546    20494    4                  END;

      547    20495    3               K = K - I;

  20495   1 0004BA  E847 0018                            LDR,R6   K,AUTO
          1 0004BC  E247 0013                            SUB,R6   I,AUTO
          1 0004BE  EF47 0018                            STR,R6   K,AUTO

      548    20496    3               END;
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:108  

  20496   1 0004C0  6A01 FF56                            BGZ,R6   s:20452,PREL

      549    20497
      550    20498
      551    20499
      552    20500    2            CALL CHKEOB ALTRET(NOBUF);

  20500   1 0004C2  E3C0 0B54                            LNJ,B6   s:0,PREL
          1 0004C4       0588                            DC       s:20955,PREL

      553    20501    2            %KV_MRD.DVCCLM = KV$USR_PST.PHSPST.CLM;

  20501   1 0004C5  EC80 0000 0000  xsym                 LDB,B6   KV$PTR$
          1 0004C8  DCC6 0008                            LDB,B5   8,B6
          1 0004CA  CCC7 0006                            LDB,B4   PARM$,AUTO
          1 0004CC  E844 0002                            LDR,R6   2,B4
          1 0004CE  EF45 001E                            STR,R6   30,B5

      554    20502    2            IF ( KZ$LINCTX.PRO.PROTYP = %KLPT_HASP#

  20502   1 0004D0  DCC7 000A                            LDB,B5   LCTX$,AUTO
          1 0004D2  E845 003A                            LDR,R6   58,B5
          1 0004D4  6D03                                 CMV,R6   3
          1 0004D5  0901 0004                            BE       s:20502+10,PREL
          1 0004D7  6D07                                 CMV,R6   7
          1 0004D8  0981 055F                            BNE      s:20937,PREL
          1 0004DA  D847 0011                            LDR,R5   BYTSIZ,AUTO
          1 0004DC  5D3F                                 CMV,R5   63
          1 0004DD  0A81 055A                            BALE     s:20937,PREL

      555    20503    2               OR KZ$LINCTX.PRO.PROTYP = %KLPT_NJE# )
      556    20504    2               AND BYTSIZ > 63 THEN
      557    20505    2               BYTSIZ = 63;

  20505   1 0004DF  5C3F                                 LDV,R5   63
          1 0004E0  DF47 0011                            STR,R5   BYTSIZ,AUTO
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:109  
          1 0004E2  0F81 0555                            B        s:20937,PREL

      558    20506        %EJECT;
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:110  
      559    20507                    /* Request Input Data                                  */
      560    20508    2          CASE(%KV_USR_FNC_RQSDAT);

      561    20509
      562    20510        /*D*     When function is KV_USR_FNC_RQSDAT, VDH is setting the
      563    20511                 USRRQSDAT.RED flag as he is ready to accept more input data.
      564    20512                                                                           */
      565    20513
      566    20514                    /* Process the items on the defer list  */
      567    20515    2            CALL KZR$DFR(DVCTX);

  20515   1 0004E4  BBC7 0008                            LAB,B3   DCTX$,AUTO
          1 0004E6  CBF0 0100                            LAB,B4   256,IMO
          1 0004E8  E380 0000 0000  xent                 LNJ,B6   KZR$DFR
          1 0004EB       0001                            DC       s:20515+8,PREL
          1 0004EC  0F81 054B                            B        s:20937,PREL

      568    20516        %EJECT;
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:111  
      569    20517                          /* Event                                         */
      570    20518    2          CASE(%KV_USR_FNC_EVT);

      571    20519    3            DO CASE(KV$USR_EVT.ID);

  20519   1 0004EE  9806                                 LDR,R1   ,B6
          1 0004EF  9570 007F                            AND,R1   127,IMO
          1 0004F1  1D10                                 CMV,R1   16
          1 0004F2  0281 0545                            BGE      s:20937,PREL
          1 0004F4  B810 0000 04FA  01                   LDR,R3   s:20519+12,R1
          1 0004F7  83B0 0000 050A  01                   JMP      s:20526,R3
          1 0004FA       052E                            DC       s:20937,PREL
          1 0004FB       052E                            DC       s:20937,PREL
          1 0004FC       0319                            DC       s:20769,PREL
          1 0004FD       052E                            DC       s:20937,PREL
          1 0004FE       041B                            DC       s:20873,PREL
          1 0004FF       052E                            DC       s:20937,PREL
          1 000500       052E                            DC       s:20937,PREL
          1 000501       052E                            DC       s:20937,PREL
          1 000502       0000                            DC       s:20526,PREL
          1 000503       01FF                            DC       s:20672,PREL
          1 000504       023C                            DC       s:20695,PREL
          1 000505       052E                            DC       s:20937,PREL
          1 000506       04E0                            DC       s:20917,PREL
          1 000507       052E                            DC       s:20937,PREL
          1 000508       052E                            DC       s:20937,PREL
          1 000509       042B                            DC       s:20879,PREL

      572    20520
      573    20521
      574    20522                       /* Logon accepted                                   */
      575    20523
      576    20524    3             CASE(%KV_USR_EVT_ID_LGNACP);

      577    20525
      578    20526    3               KZ_HASP_HDR.STTBFR$->KZ$SYNCSTAT.ACTSTR = KZ_HASP_HDR.STTBFR$->
             20526                        KZ$SYNCSTAT.ACTSTR+1;
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:112  

  20526   1 00050A  DC80 0000 0006  xsym                 LDB,B5   KZ_HASP_HDR+6
          1 00050D  8AC5 0083                            INC      131,B5
          1 00050F  8EC5 0082                            CAD      130,B5

      579    20527    3               DVCTX.STATE=%KZ_S_SCONNECTED#;

  20527   1 000511  6C02                                 LDV,R6   2
          1 000512  CCC7 0008                            LDB,B4   DCTX$,AUTO
          1 000514  E7C4 000A                            STH,R6   10,B4

      580    20528
      581    20529    4               IF DVCTX.MGR_TYPE = %KZ_S_DMCONSOLE# THEN DO;

  20529   1 000516  D2C4 0022                            LLH,R5   34,B4
          1 000518  5D03                                 CMV,R5   3
          1 000519  0981 007C                            BNE      s:20567,PREL

      582    20530
      583    20531                          /* Build an output context block for the console */
      584    20532
      585    20533    4                  SZ = SIZEW(DVCTX);

  20533   1 00051B  4C3A                                 LDV,R4   58
          1 00051C  CF47 0023                            STR,R4   SZ,AUTO

      586    20534    4                  CALL KVB$GETSYS (SZ,BFR$) ALTRET(NOBUF);

  20534   1 00051E  BBC7 000C                            LAB,B3   BFR$,AUTO
          1 000520  BFC7 0066                            STB,B3   P$+8,AUTO
          1 000522  ABC7 0023                            LAB,B2   SZ,AUTO
          1 000524  AFC7 0064                            STB,B2   P$+6,AUTO
          1 000526  BBC7 0064                            LAB,B3   P$+6,AUTO
          1 000528  CBF0 0200                            LAB,B4   512,IMO
          1 00052A  E380 0000 0000  xent                 LNJ,B6   KVB$GETSYS
          1 00052D       051F                            DC       s:20955,PREL

PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:113  
      587    20535
      588    20536                       /* Consoles are initially open and have PTS */
      589    20537
      590    20538    4                  DVCTX.SUSBIT_MASK = '0040'X;

  20538   1 00052E  ECC7 0008                            LDB,B6   DCTX$,AUTO
          1 000530  6C40                                 LDV,R6   64
          1 000531  EF46 0023                            STR,R6   35,B6

      591    20539    4                  DVCTX.STATE = %KZ_S_SOPEN#;

  20539   1 000533  5C04                                 LDV,R5   4
          1 000534  D7C6 000A                            STH,R5   10,B6

      592    20540    4                  BFR$->DVCTX = DVCTX; /* Copy Input context */

  20540   1 000536  AB86                                 LAB,B2   ,B6
          1 000537  2C00                                 LDV,R2   0
          1 000538  6C74                                 LDV,R6   116
          1 000539  BCC7 000C                            LDB,B3   BFR$,AUTO
          1 00053B  3C00                                 LDV,R3   0
          1 00053C  0008                                 MMM

      593    20541    4                  BFR$->DVCTX.LNK$ = DVCTX.LNK$;

  20541   1 00053D  DCC7 0008                            LDB,B5   DCTX$,AUTO
          1 00053F  CC85                                 LDB,B4   ,B5
          1 000540  BCC7 000C                            LDB,B3   BFR$,AUTO
          1 000542  CF83                                 STB,B4   ,B3

      594    20542    4                  DVCTX.LNK$ = BFR$; /* Link onto Input  */

  20542   1 000543  DCC7 000C                            LDB,B5   BFR$,AUTO
          1 000545  CCC7 0008                            LDB,B4   DCTX$,AUTO
          1 000547  DF84                                 STB,B5   ,B4

      595    20543    5                  IF KZ$LINCTX.PRO.PROTYP = %KLPT_NJE# THEN DO;
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:114  

  20543   1 000548  DCC7 000A                            LDB,B5   LCTX$,AUTO
          1 00054A  E845 003A                            LDR,R6   58,B5
          1 00054C  6D07                                 CMV,R6   7
          1 00054D  0981 0011                            BNE      s:20548,PREL

      596    20544    5                     BFR$->DVCTX.RCB_CODE = '9A'X;

  20544   1 00054F  C870 9A00                            LDR,R4   -26112,IMO
          1 000551  4048                                 SOR,R4   8
          1 000552  CCC7 000C                            LDB,B4   BFR$,AUTO
          1 000554  C7C4 0024                            STH,R4   36,B4

      597    20545    5                     DVCTX.RCB_CODE = '9A'X;

  20545   1 000556  E870 9A00                            LDR,R6   -26112,IMO
          1 000558  6048                                 SOR,R6   8
          1 000559  BCC7 0008                            LDB,B3   DCTX$,AUTO
          1 00055B  E7C3 0024                            STH,R6   36,B3

      598    20546    5                     END;

  20546   1 00055D  0F81 0023                            B        s:20560,PREL

      599    20547    5                  ELSE DO;

      600    20548    6                     IF KZ$LINCTX.PRO.SLAVE THEN DO;

  20548   1 00055F  89C5 004B                            CMZ      75,B5
          1 000561  0881 0011                            BAGE     s:20553,PREL

      601    20549    6                        BFR$->DVCTX.RCB_CODE = '92'X;

  20549   1 000563  C870 9200                            LDR,R4   -28160,IMO
          1 000565  4048                                 SOR,R4   8
          1 000566  CCC7 000C                            LDB,B4   BFR$,AUTO
          1 000568  C7C4 0024                            STH,R4   36,B4
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:115  

      602    20550    6                        DVCTX.RCB_CODE = '91'X;

  20550   1 00056A  E870 9100                            LDR,R6   -28416,IMO
          1 00056C  6048                                 SOR,R6   8
          1 00056D  BCC7 0008                            LDB,B3   DCTX$,AUTO
          1 00056F  E7C3 0024                            STH,R6   36,B3

      603    20551    6                        END;

  20551   1 000571  0F81 000F                            B        s:20560,PREL

      604    20552    6                     ELSE DO;

      605    20553    6                        BFR$->DVCTX.RCB_CODE = '91'X;

  20553   1 000573  C870 9100                            LDR,R4   -28416,IMO
          1 000575  4048                                 SOR,R4   8
          1 000576  CCC7 000C                            LDB,B4   BFR$,AUTO
          1 000578  C7C4 0024                            STH,R4   36,B4

      606    20554    6                        DVCTX.RCB_CODE = '92'X;

  20554   1 00057A  E870 9200                            LDR,R6   -28160,IMO
          1 00057C  6048                                 SOR,R6   8
          1 00057D  BCC7 0008                            LDB,B3   DCTX$,AUTO
          1 00057F  E7C3 0024                            STH,R6   36,B3

      607    20555    6                        END;

      608    20556    5                     END;

      609    20557
      610    20558                       /* Initialize Input context block  */
      611    20559
      612    20560    4                  DVCTX.FLAGS.PTS_IN = '1'B;

PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:116  
  20560   1 000581  8943 001E                            LBT,'2000'X       30,B3
  20560   1 000583       2000

      613    20561    4                  BFR$->DVCTX.FLAGS.PTS_OUT = '1'B;

  20561   1 000584  8944 001E                            LBT,'1000'X       30,B4
  20561   1 000586       1000

      614    20562    4                  BFR$->DVCTX.FLAGS.SUSPEND_OUT = '0'B;

  20562   1 000587  8844 001E                            LBF,'4000'X       30,B4
  20562   1 000589       4000

      615    20563    4                  BFR$=ADDR(NIL);

  20563   1 00058A  9B80 0000 0000                       LAB,B1   0
          1 00058D  9FC7 000C                            STB,B1   BFR$,AUTO

      616    20564
      617    20565    4                  KZ_HASP_HDR.STTBFR$->KZ$SYNCSTAT.ACTSTR = KZ_HASP_HDR.STTBFR$->
             20565                           KZ$SYNCSTAT.ACTSTR+1;

  20565   1 00058F  CC80 0000 0006  xsym                 LDB,B4   KZ_HASP_HDR+6
          1 000592  8AC4 0083                            INC      131,B4
          1 000594  8EC4 0082                            CAD      130,B4

      618    20566
      619    20567    4                  END;

      620    20568
      621    20569    3   CTLGNS:     KZ$LINCTX.POLSIZ = KZ$LINCTX.POLSIZ-1;

  20569   1 000596  ECC7 000A            CTLGNS          LDB,B6   LCTX$,AUTO
          1 000598  88C6 0065                            DEC      101,B6

      622    20570    4               IF KZ$LINCTX.POLSIZ = 0 AND KZ$LINCTX.POLX ~= 0 THEN DO;

PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:117  
  20570   1 00059A  E846 0065                            LDR,R6   101,B6
          1 00059C  6981 049B                            BNEZ,R6  s:20937,PREL
          1 00059E  82C6 006C                            LB,'00FF'X        108,B6
          1 0005A0       00FF
          1 0005A1  0581 0496                            BBF      s:20937,PREL

      623    20571
      624    20572                       /* All devices have been logged on.  If a logon reject
      625    20573                          occured, kill the line.                          */
      626    20574
      627    20575    4                  IF KZ$LINCTX.FLAGS.RJCT THEN

  20575   1 0005A3  82C6 0034                            LB,'0001'X        52,B6
  20575   1 0005A5       0001
          1 0005A6  0581 000A                            BBF      s:20578,PREL

      628    20576    4                     CALL REPCLMEVT (%KZ#CLM_EVENT_KILLED);

  20576   1 0005A8  DBF0 0007                            LAB,B5   7,IMO
          1 0005AA  DFC7 005C                            STB,B5   KV$VDH_OTPLCL+7,AUTO
          1 0005AC  E3C0 0BB0                            LNJ,B6   s:0,PREL
          1 0005AE       0001                            DC       s:20576+7,PREL
          1 0005AF  0F81 014D                            B        s:20663,PREL

      629    20577    5                  ELSE DO;

      630    20578    6                     IF KZ$LINCTX.PRO.RMTSS$ ~= ADDR(NIL) THEN DO;

  20578   1 0005B1  8DC6 0043                            CMN      67,B6
          1 0005B3  0901 0142                            BE       s:20661,PREL

      631    20579                          /* Build a SIGNON record as first record to send */
      632    20580    6                        IF DVCTX.MGR_TYPE = %KZ_S_DMCONSOLE# THEN

  20580   1 0005B5  DCC7 0008                            LDB,B5   DCTX$,AUTO
          1 0005B7  D2C5 0022                            LLH,R5   34,B5
          1 0005B9  5D03                                 CMV,R5   3
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:118  
          1 0005BA  0981 0004                            BNE      s:20582,PREL

      633    20581    6                           DCTX$ = DVCTX.LNK$;

  20581   1 0005BC  CC85                                 LDB,B4   ,B5
          1 0005BD  CFC7 0008                            STB,B4   DCTX$,AUTO

      634    20582    6                        CALL GET_BFR ALTRET(NOBUF);

  20582   1 0005BF  E3C0 0763                            LNJ,B6   s:0,PREL
          1 0005C1       048B                            DC       s:20955,PREL

      635    20583    6                        %KV_MRD.MINSP_FORPST = 0;

  20583   1 0005C2  EC80 0000 0000  xsym                 LDB,B6   KV$PTR$
          1 0005C5  DCC6 0008                            LDB,B5   8,B6
          1 0005C7  87C5 000C                            CLH      12,B5

      636    20584    6                        %KV_VDI.OTPBFR_.ADR$ = BFR$;

  20584   1 0005C9  DC86                                 LDB,B5   ,B6
          1 0005CA  CCC7 000C                            LDB,B4   BFR$,AUTO
          1 0005CC  CFC5 000A                            STB,B4   10,B5

      637    20585    6                        IF KZ$LINCTX.PRO.PROTYP = %KLPT_HASP#

  20585   1 0005CE  DCC7 000A                            LDB,B5   LCTX$,AUTO
          1 0005D0  E845 003A                            LDR,R6   58,B5
          1 0005D2  6D03                                 CMV,R6   3
          1 0005D3  0901 0004                            BE       s:20587,PREL
          1 0005D5  6D07                                 CMV,R6   7
          1 0005D6  0981 0064                            BNE      s:20610,PREL

      638    20586    7                           OR KZ$LINCTX.PRO.PROTYP = %KLPT_NJE# THEN DO;

      639    20587    7                           TBFR$ = PINCRW(BFR$,SIZEW(KZ$OTPBFR));

PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:119  
  20587   1 0005D8  CCC7 000C                            LDB,B4   BFR$,AUTO
          1 0005DA  BBC4 0008                            LAB,B3   8,B4
          1 0005DC  BFC7 000E                            STB,B3   TBFR$,AUTO

      640    20588    8                           IF KZ$LINCTX.PRO.PROTYP = %KLPT_HASP# THEN DO;

  20588   1 0005DE  6D03                                 CMV,R6   3
          1 0005DF  0981 0017                            BNE      s:20598,PREL

      641    20589    8                              TBFR$->KZ$HASPBLK.FLG = 'F0C1'X;

  20589   1 0005E1  5C02                                 LDV,R5   2
          1 0005E2  0021                                 ALR      ;
          1 0005E3       4278 F0C1                                ALPHANUM('F0C1'X,IMO,,2),;
          1 0005E5       C003 0001                                ALPHANUM(1,B3,1,R5,FILL)

      642    20590    8                              %KV_VDI.OTPBFR_.BYTX = BYTX-1;

  20590   1 0005E7  437F                                 CSYNC    s:20589+5,SPREL
          1 0005E8  EC80 0000 0000  xsym                 LDB,B6   KV$PTR$
          1 0005EB  DC86                                 LDB,B5   ,B6
          1 0005EC  E847 0010                            LDR,R6   BYTX,AUTO
          1 0005EE  6EFF                                 ADV,R6   -1
          1 0005EF  EF45 000C                            STR,R6   12,B5

      643    20591    8                              %KV_VDI.OTPBFR_.BYTSIZ = 80;

  20591   1 0005F1  DC86                                 LDB,B5   ,B6
          1 0005F2  4C50                                 LDV,R4   80
          1 0005F3  CF45 000D                            STR,R4   13,B5

      644    20592    8                              END;

  20592   1 0005F5  0F81 002F                            B        s:20604,PREL

      645    20593    8                           ELSE DO;

PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:120  
      646    20594        /*                       SGN_NJE$ = PINCRC(TBFR$,LENGTHC(KZ$HASPBLK.BCB)+LENGTHC(KZ
             20594        $HASPBLK.FCS));
      647    20595                                  SGN_NJE$->KZ$NJE_SIGNON = KZ_NJE_SIGNON;
      648    20596                                  SGN_NJE$->KZ$NJE_SIGNON.NCC.IREST = 100;
      649    20597                             SGN_NJE$->KZ$NJE_SIGNON.NCC.IBFSZ = KZ$LINCTX.PRO.BLKBYTES; */
      650    20598    8                              TBFR$->KZ$NJE_SIGNON = KZ_NJE_SIGNON;

  20598   1 0005F7  AB80 0000 0000  00                   LAB,B2   FPT@WRSYSLOG
          1 0005FA  2C54                                 LDV,R2   84
          1 0005FB  6C28                                 LDV,R6   40
          1 0005FC  3C00                                 LDV,R3   0
          1 0005FD  0008                                 MMM

      651    20599    8                              TBFR$->KZ$NJE_SIGNON.NCC.IREST = 100;

  20599   1 0005FE  8CF0 0000 0064                       LDI      100,IMO
          1 000601  7090                                 DOL,R7   16
          1 000602  8D47 0064                            SDI      P$+6,AUTO
          1 000604  ABC7 0064                            LAB,B2   P$+6,AUTO
          1 000606  2C00                                 LDV,R2   0
          1 000607  6C20                                 LDV,R6   32
          1 000608  BCC7 000E                            LDB,B3   TBFR$,AUTO
          1 00060A  BBC3 0009                            LAB,B3   9,B3
          1 00060C  3C08                                 LDV,R3   8
          1 00060D  7C10                                 LDV,R7   16
          1 00060E  D380 0000 0000  xent                 LNJ,B5   X6B_BLR

      652    20600    8                              TBFR$->KZ$NJE_SIGNON.NCC.IBFSZ = KZ$LINCTX.PRO.BLKBYTES;

  20600   1 000611  ACC7 000A                            LDB,B2   LCTX$,AUTO
          1 000613  2C78                                 LDV,R2   120
          1 000614  6C02                                 LDV,R6   2
          1 000615  BCC7 000E                            LDB,B3   TBFR$,AUTO
          1 000617  3C15                                 LDV,R3   21
          1 000618  0008                                 MMM

      653    20601    8                              %KV_VDI.OTPBFR_.BYTX = BYTX-1+LENGTHC(KZ$NJE_SIGNON.NCC.
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:121  
             20601                                       IDL);

  20601   1 000619  EC80 0000 0000  xsym                 LDB,B6   KV$PTR$
          1 00061C  DC86                                 LDB,B5   ,B6
          1 00061D  E847 0010                            LDR,R6   BYTX,AUTO
          1 00061F  EF45 000C                            STR,R6   12,B5

      654    20602    8                             %KV_VDI.OTPBFR_.BYTSIZ = LENGTHC(KZ$NJE_SIGNON.NCC.INODE)
             20602                                       ;

  20602   1 000621  DC86                                 LDB,B5   ,B6
          1 000622  5C08                                 LDV,R5   8
          1 000623  DF45 000D                            STR,R5   13,B5

      655    20603    8                              END;

      656    20604    7                           KZ$LINCTX.CURDEV$ = ADDR(KZ$LINCTX.CTRHD$);

  20604   1 000625  DCC7 000A                            LDB,B5   LCTX$,AUTO
          1 000627  DFC5 0050                            STB,B5   80,B5

      657    20605    8                           DO WHILE KZ$LINCTX.CURDEV$->DVCTX.LNK$ ~= DCTX$;

  20605   1 000629  CC85                                 LDB,B4   ,B5
          1 00062A  CDC7 0008                            CMB,B4   DCTX$,AUTO
          1 00062C  0901 0024                            BE       s:20617,PREL

      658    20606    8                              KZ$LINCTX.CURDEV$ = KZ$LINCTX.CURDEV$->DVCTX.LNK$;

  20606   1 00062E  ECC7 000A                            LDB,B6   LCTX$,AUTO
          1 000630  DCC6 0050                            LDB,B5   80,B6
          1 000632  CC85                                 LDB,B4   ,B5
          1 000633  CFC6 0050                            STB,B4   80,B6

      659    20607    8                              END;

  20607   1 000635  DC84                                 LDB,B5   ,B4
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:122  
          1 000636  DDC7 0008                            CMB,B5   DCTX$,AUTO
          1 000638  09F6                                 BNE      s:20606,SPREL

      660    20608    7                           END;

  20608   1 000639  0F81 0017                            B        s:20617,PREL

      661    20609    7                        ELSE DO;

      662    20610    7                           %KV_VDI.OTPBFR_.BYTX = SIZEC(KZ$OTPBFR);

  20610   1 00063B  CC86                                 LDB,B4   ,B6
          1 00063C  5C10                                 LDV,R5   16
          1 00063D  DF44 000C                            STR,R5   12,B4

      663    20611    7                           %KV_VDI.OTPBFR_.BYTSIZ = 80;

  20611   1 00063F  CC86                                 LDB,B4   ,B6
          1 000640  6C50                                 LDV,R6   80
          1 000641  EF44 000D                            STR,R6   13,B4

      664    20612    7                           BYTX = SIZEC(KZ$OTPBFR);

  20612   1 000643  DF47 0010                            STR,R5   BYTX,AUTO

      665    20613    7                           KZ$OTPBFR.FLAGS.LAST# = '1'B;

  20613   1 000645  CCC7 000C                            LDB,B4   BFR$,AUTO
          1 000647  8944 0002                            LBT,'0040'X       2,B4
          1 000649       0040

      666    20614    7                           KZ$LINCTX.FLAGS.SND = '1'B;

  20614   1 00064A  8945 0034                            LBT,'0004'X       52,B5
  20614   1 00064C       0004

      667    20615    7                           KZ$LINCTX.CURDEV$ = DCTX$;
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:123  

  20615   1 00064D  CCC7 0008                            LDB,B4   DCTX$,AUTO
          1 00064F  CFC5 0050                            STB,B4   80,B5

      668    20616    7                           END;

      669    20617    6                        DVCTX.LASTSCBX = BYTX-2; /* fake out FNC_PST */

  20617   1 000651  ECC7 0008                            LDB,B6   DCTX$,AUTO
          1 000653  E847 0010                            LDR,R6   BYTX,AUTO
          1 000655  6EFE                                 ADV,R6   -2
          1 000656  EF46 0020                            STR,R6   32,B6

      670    20618    6                        %KV_MRD.DVCCLM = 1;

  20618   1 000658  DC80 0000 0000  xsym                 LDB,B5   KV$PTR$
          1 00065B  CCC5 0008                            LDB,B4   8,B5
          1 00065D  5C01                                 LDV,R5   1
          1 00065E  DF44 001E                            STR,R5   30,B4

      671    20619    6                        %KV_SRD.VRTPSTOK = '1'B;

  20619   1 000660  CCC5 000A                            LDB,B4   10,B5
          1 000662  8944 000E                            LBT,'0010'X       14,B4
          1 000664       0010

      672    20620    6                        KV$VDH_OTPLCL = KV_VDH_OTPLCL;

  20620   1 000665  AB80 0000 0000  00                   LAB,B2   FPT@WRSYSLOG
          1 000668  2C4A                                 LDV,R2   74
          1 000669  6C0A                                 LDV,R6   10
          1 00066A  BBC7 0055                            LAB,B3   KV$VDH_OTPLCL,AUTO
          1 00066C  3C00                                 LDV,R3   0
          1 00066D  0008                                 MMM

      673    20621    6                        KV$VDH_OTPLCL.BFR_.ADR$ = KZ$LINCTX.PRO.RMTSS$;

PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:124  
  20621   1 00066E  ECC7 000A                            LDB,B6   LCTX$,AUTO
          1 000670  DCC6 0043                            LDB,B5   67,B6
          1 000672  DFC7 0056                            STB,B5   KV$VDH_OTPLCL+1,AUTO

      674    20622    6                        KV$VDH_OTPLCL.BFR_.BYTSIZ = %KV_VDI.OTPBFR_.BYTSIZ;

  20622   1 000674  CC80 0000 0000  xsym                 LDB,B4   KV$PTR$
          1 000677  BC84                                 LDB,B3   ,B4
          1 000678  E843 000D                            LDR,R6   13,B3
          1 00067A  EF47 0059                            STR,R6   KV$VDH_OTPLCL+4,AUTO

      675    20623    6                        CALL KVV$VDI (KV$VDH_OTPLCL);

  20623   1 00067C  BBC7 0055                            LAB,B3   KV$VDH_OTPLCL,AUTO
          1 00067E  BFC7 0064                            STB,B3   P$+6,AUTO
          1 000680  BBC7 0064                            LAB,B3   P$+6,AUTO
          1 000682  CBF0 0100                            LAB,B4   256,IMO
          1 000684  E380 0000 0000  xent                 LNJ,B6   KVV$VDI
          1 000687       0001                            DC       s:20624,PREL

      676    20624    7                        IF KZ$LINCTX.PRO.PROTYP = %KLPT_NJE# THEN DO;

  20624   1 000688  ECC7 000A                            LDB,B6   LCTX$,AUTO
          1 00068A  E846 003A                            LDR,R6   58,B6
          1 00068C  6D07                                 CMV,R6   7
          1 00068D  0981 000F                            BNE      s:20629,PREL

      677    20625    7                           KZ$OTPBFR.DATA_SIZ = LENGTHC(KZ$NJE_SIGNON);

  20625   1 00068F  DCC7 000C                            LDB,B5   BFR$,AUTO
          1 000691  5C28                                 LDV,R5   40
          1 000692  DF45 0003                            STR,R5   3,B5

      678    20626    7                           DVCTX.LASTRCBX = BYTX+LENGTHC(KZ$NJE_SIGNON.NCC);

  20626   1 000694  DCC7 0008                            LDB,B5   DCTX$,AUTO
          1 000696  E847 0010                            LDR,R6   BYTX,AUTO
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:125  
          1 000698  6E25                                 ADV,R6   37
          1 000699  EF45 0021                            STR,R6   33,B5

      679    20627    7                           END;

  20627   1 00069B  0F81 000D                            B        s:20632,PREL

      680    20628    7                        ELSE DO;

      681    20629    7                           KZ$OTPBFR.DATA_SIZ = LENGTHC(KZ$HASPBLK)+80-1;

  20629   1 00069D  DCC7 000C                            LDB,B5   BFR$,AUTO
          1 00069F  5C55                                 LDV,R5   85
          1 0006A0  DF45 0003                            STR,R5   3,B5

      682    20630    7                           DVCTX.LASTRCBX = BYTX+80;

  20630   1 0006A2  DCC7 0008                            LDB,B5   DCTX$,AUTO
          1 0006A4  E847 0010                            LDR,R6   BYTX,AUTO
          1 0006A6  6E50                                 ADV,R6   80
          1 0006A7  EF45 0021                            STR,R6   33,B5

      683    20631    7                           END;

      684    20632    6                        DVCTX.LASTSCBX = DVCTX.LASTRCBX+2;

  20632   1 0006A9  6E02                                 ADV,R6   2
          1 0006AA  EF45 0020                            STR,R6   32,B5

      685    20633    6                        BYTX = DVCTX.LASTSCBX+1;

  20633   1 0006AC  6E01                                 ADV,R6   1
          1 0006AD  EF47 0010                            STR,R6   BYTX,AUTO

      686    20634    6                        %KV_VDI.OTPBFR_.BYTX = BYTX;

  20634   1 0006AF  CC80 0000 0000  xsym                 LDB,B4   KV$PTR$
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:126  
          1 0006B2  BC84                                 LDB,B3   ,B4
          1 0006B3  EF43 000C                            STR,R6   12,B3

      687    20635    6                        %KV_VDI.OTPBFR_.BYTSIZ = 4;

  20635   1 0006B5  BC84                                 LDB,B3   ,B4
          1 0006B6  5C04                                 LDV,R5   4
          1 0006B7  DF43 000D                            STR,R5   13,B3

      688    20636    6                        CALL KVV$VDI (KV_VDH_PST_CR_VRT); /* Position back to col 1 */

  20636   1 0006B9  BB80 0000 0000  02                   LAB,B3   0
          1 0006BC  CBF0 0100                            LAB,B4   256,IMO
          1 0006BE  E380 0000 0000  xent                 LNJ,B6   KVV$VDI
          1 0006C1       0001                            DC       s:20642,PREL

      689    20637                             %KV$CMPOTP;
             20642    7           IF KV$PTR.VDI$->KV$VDI.OTPCNDPND THEN DO;

  20642   1 0006C2  EC80 0000 0000  xsym                 LDB,B6   KV$PTR$
          1 0006C5  DC86                                 LDB,B5   ,B6
          1 0006C6  E845 001A                            LDR,R6   26,B5
          1 0006C8  6901 000A                            BEZ,R6   s:20646,PREL

             20643    7              CALL KVV$VDI(KV_VDH_EVT_CMPOTP);

  20643   1 0006CA  BB80 0000 0002  02                   LAB,B3   +2
          1 0006CD  CBF0 0100                            LAB,B4   256,IMO
          1 0006CF  E380 0000 0000  xent                 LNJ,B6   KVV$VDI
          1 0006D2       0001                            DC       s:20646,PREL

             20644    7              END;                         /* END IF                             */

      690    20646    7                        IF KZ$LINCTX.PRO.PROTYP = %KLPT_NJE# THEN DO;

  20646   1 0006D3  ECC7 000A                            LDB,B6   LCTX$,AUTO
          1 0006D5  E846 003A                            LDR,R6   58,B6
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:127  
          1 0006D7  6D07                                 CMV,R6   7
          1 0006D8  0981 0015                            BNE      s:20657,PREL

      691    20647                             /* For NJE, we don't know whether we'll need a type-I or
      692    20648                                a type-J record (or both!) at this point.  We'll save
      693    20649                                the type-I we made above back in the old RMTSS$ space,
      694    20650                                and send it off as an I and/or J later. */
      695    20651        /*                     KZ$LINCTX.PRO.RMTSS$->KZ$NJE_SIGNON = SGN_NJE$->KZ$NJE_SIGNO
             20651        N; */
      696    20652    7                           KZ$LINCTX.PRO.RMTSS$->KZ$NJE_SIGNON = TBFR$->KZ$NJE_SIGNON;

  20652   1 0006DA  DCC6 0043                            LDB,B5   67,B6
          1 0006DC  ACC7 000E                            LDB,B2   TBFR$,AUTO
          1 0006DE  2C00                                 LDV,R2   0
          1 0006DF  6C28                                 LDV,R6   40
          1 0006E0  BB85                                 LAB,B3   ,B5
          1 0006E1  3C00                                 LDV,R3   0
          1 0006E2  0008                                 MMM

      697    20653    7                           SZ = KZ$OTPBFR.BFRSIZ;

  20653   1 0006E3  ECC7 000C                            LDB,B6   BFR$,AUTO
          1 0006E5  E846 0004                            LDR,R6   4,B6
          1 0006E7  EF47 0023                            STR,R6   SZ,AUTO

      698    20654    7                           CALL INIT_BFR;

  20654   1 0006E9  E3C0 0656                            LNJ,B6   s:0,PREL
          1 0006EB       0001                            DC       s:20655,PREL

      699    20655    7                           END;

  20655   1 0006EC  0F81 0009                            B        s:20661,PREL

      700    20656    7                        ELSE DO;

      701    20657    7                           CALL QSGNON_BFR;
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:128  

  20657   1 0006EE  E3C0 071A                            LNJ,B6   s:0,PREL
          1 0006F0       0001                            DC       s:20658,PREL

      702    20658    7                           BFR$ = ADDR(NIL);

  20658   1 0006F1  EB80 0000 0000                       LAB,B6   0
          1 0006F4  EFC7 000C                            STB,B6   BFR$,AUTO

      703    20659    7                           END;

      704    20660    6                        END; /* SIGNON string stuff */

      705    20661    5                     CALL REPCLMEVT (%KZ#CLM_EVENT_LGNCMP);

  20661   1 0006F6  EBF0 0004                            LAB,B6   4,IMO
          1 0006F8  EFC7 005C                            STB,B6   KV$VDH_OTPLCL+7,AUTO
          1 0006FA  E3C0 0A62                            LNJ,B6   s:0,PREL
          1 0006FC       0001                            DC       s:20663,PREL

      706    20662    5                     END;

      707    20663    4                  %KV_MRD.MINSP_FORPST=KZD_MINSP_FORPST;

  20663   1 0006FD  EC80 0000 0000  xsym                 LDB,B6   KV$PTR$
          1 000700  DCC6 0008                            LDB,B5   8,B6
          1 000702  E800 0000 0049  00                   LDR,R6   KZD_MINSP_FORPST
          1 000705  E7C5 000C                            STH,R6   12,B5

      708    20664    4                  END;

  20664   1 000707  0F81 0330                            B        s:20937,PREL

      709    20665        %EJECT;
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:129  
      710    20666                          /* Logon reject                                  */
      711    20667
      712    20668    3             CASE(%KV_USR_EVT_ID_LGNRJC);

      713    20669
      714    20670                          /* Logon reject is error-logged                             */
      715    20671
      716    20672    3               FPT_WRSYSLOG=FPT@WRSYSLOG;

  20672   1 000709  AB80 0000 0000  00                   LAB,B2   FPT@WRSYSLOG
          1 00070C  2C00                                 LDV,R2   0
          1 00070D  6C2A                                 LDV,R6   42
          1 00070E  BB87                                 LAB,B3   ,AUTO
          1 00070F  3C56                                 LDV,R3   86
          1 000710  0008                                 MMM

      717    20673    3               FPT_WRSYSLOG.V.ERRCODE.ERR# = %E$RBTLGNRJC;

  20673   1 000711  E870 0360                            LDR,R6   864,IMO
          1 000713  EAC7 0032                            SRM,R6,'FFF8'X    FPT_WRSYSLOG+7,AUTO
          1 000715       FFF8

      718    20674    3               FPT_WRSYSLOG.V.TERMID=KZ$LINCTX.LINID;

  20674   1 000716  ACC7 000A                            LDB,B2   LCTX$,AUTO
          1 000718  2C08                                 LDV,R2   8
          1 000719  6C10                                 LDV,R6   16
          1 00071A  BB87                                 LAB,B3   ,AUTO
          1 00071B  3C66                                 LDV,R3   102
          1 00071C  0008                                 MMM

      719    20675    3               FPT_WRSYSLOG.V.VALUES(0) = KV$USR_EVT.PRM;

  20675   1 00071D  ECC7 0006                            LDB,B6   PARM$,AUTO
          1 00071F  E846 0001                            LDR,R6   1,B6
          1 000721  EF47 003B                            STR,R6   FPT_WRSYSLOG+16,AUTO

PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:130  
      720    20676    3               FPT_WRSYSLOG.BUF_=VECTOR(DVCTX.LCLENDPNTID);

  20676   1 000723  DCC7 0008                            LDB,B5   DCTX$,AUTO
          1 000725  CBC5 0002                            LAB,B4   2,B5
          1 000727  CFC7 0065                            STB,B4   P$+7,AUTO
          1 000729  5C0F                                 LDV,R5   15
          1 00072A  DF47 0064                            STR,R5   P$+6,AUTO
          1 00072C  ABC7 0064                            LAB,B2   P$+6,AUTO
          1 00072E  2C00                                 LDV,R2   0
          1 00072F  6C06                                 LDV,R6   6
          1 000730  BB87                                 LAB,B3   ,AUTO
          1 000731  3C5C                                 LDV,R3   92
          1 000732  0008                                 MMM

      721    20677    3               CALL KHA$ERRLOG (FPT_WRSYSLOG);

  20677   1 000733  EBC7 002B                            LAB,B6   FPT_WRSYSLOG,AUTO
          1 000735  EFC7 0064                            STB,B6   P$+6,AUTO
          1 000737  BBC7 0064                            LAB,B3   P$+6,AUTO
          1 000739  CBF0 0100                            LAB,B4   256,IMO
          1 00073B  E380 0000 0000  xent                 LNJ,B6   KHA$ERRLOG
          1 00073E       0001                            DC       s:20688,PREL

      722    20678
      723    20679        /*E*  ERROR:        KZD-E$RBTLGNRJC-7
      724    20680              MESSAGE:      Logon reject, V(0)=reason, Data=termid.
      725    20681              DESCRIPTION:  VDH reported LGNRJC.  The reason, from KV_REASON_C
      726    20682                            is in VALUES(0), and the device TERMID is in the
      727    20683                            data buffer.                                   */
      728    20684
      729    20685                    /* Set reject flag and go count logon accepts/rejects so
      730    20686                       that logon can complete.                            */
      731    20687
      732    20688    3               KZ$LINCTX.FLAGS.RJCT='1'B;

  20688   1 00073F  ECC7 000A                            LDB,B6   LCTX$,AUTO
          1 000741  8946 0034                            LBT,'0001'X       52,B6
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:131  
          1 000743       0001

      733    20689    3               GOTO CTLGNS;

  20689   1 000744  0F81 FE51                            B        s:20567,PREL

      734    20690        %EJECT;
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:132  
      735    20691    3             CASE(%KV_USR_EVT_ID_OPN);

      736    20692
      737    20693                   /* Path has been opened                                 */
      738    20694
      739    20695    4               DO CASE( DVCTX.MGR_TYPE);

  20695   1 000746  DCC7 0008                            LDB,B5   DCTX$,AUTO
          1 000748  A2C5 0022                            LLH,R2   34,B5
          1 00074A  2D03                                 CMV,R2   3
          1 00074B  0281 02EC                            BGE      s:20937,PREL
          1 00074D  B820 0000 0753  01                   LDR,R3   s:20695+13,R2
          1 000750  83B0 0000 0756  01                   JMP      s:20697,R3
          1 000753       00CB                            DC       s:20761,PREL
          1 000754       007C                            DC       s:20739,PREL
          1 000755       0000                            DC       s:20697,PREL

      740    20696    4                CASE(%KZ_S_DMOUTPUT# );

      741    20697    5                  DO CASE( DVCTX.STATE);

  20697   1 000756  B2C5 000A                            LLH,R3   10,B5
          1 000758  3D03                                 CMV,R3   3
          1 000759  0281 0070                            BGE      s:20730,PREL
          1 00075B  A830 0000 0761  01                   LDR,R2   s:20697+11,R3
          1 00075E  83A0 0000 0764  01                   JMP      s:20702,R2
          1 000761       0066                            DC       s:20730,PREL
          1 000762       0066                            DC       s:20730,PREL
          1 000763       0000                            DC       s:20702,PREL

      742    20698
      743    20699                              /* Open Output                         */
      744    20700
      745    20701    5                   CASE(%KZ_S_SCONNECTED# );

      746    20702    5                     IF KZ$LINCTX.PRO.PROTYP = %KLPT_HASP#

PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:133  
  20702   1 000764  CCC7 000A                            LDB,B4   LCTX$,AUTO
          1 000766  E844 003A                            LDR,R6   58,B4
          1 000768  6D03                                 CMV,R6   3
          1 000769  0901 0004                            BE       s:20704,PREL
          1 00076B  6D07                                 CMV,R6   7
          1 00076C  0981 0042                            BNE      s:20722,PREL

      747    20703    6                        OR KZ$LINCTX.PRO.PROTYP = %KLPT_NJE# THEN DO;

      748    20704    6                        IF BFR$ = ADDR(NIL) THEN

  20704   1 00076E  8DC7 000C                            CMN      BFR$,AUTO
          1 000770  0981 0004                            BNE      s:20709,PREL

      749    20705    6                           CALL GET_BFR ALTRET(NOBUF);

  20705   1 000772  E3C0 05B0                            LNJ,B6   s:0,PREL
          1 000774       02D8                            DC       s:20955,PREL

      750    20706
      751    20707                                /* Build Request PTS record      */
      752    20708
      753    20709    6                        KZ$OTPBFR.DATA_SIZ=SIZEC(KZ$HASPBLK)+1;

  20709   1 000775  ECC7 000C                            LDB,B6   BFR$,AUTO
          1 000777  6C07                                 LDV,R6   7
          1 000778  EF46 0003                            STR,R6   3,B6

      754    20710    6                        CALL QCNTL_BFR;

  20710   1 00077A  E3C0 0684                            LNJ,B6   s:0,PREL
          1 00077C       0001                            DC       s:20711,PREL

      755    20711    6                        DVCTX.FLAGS.SUSPEND_IN = '0'B;

  20711   1 00077D  ECC7 0008                            LDB,B6   DCTX$,AUTO
          1 00077F  8846 001E                            LBF,'8000'X       30,B6
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:134  
          1 000781       8000

      756    20712    6                        DVCTX.FLAGS.SUSPEND_OUT = '0'B;

  20712   1 000782  8846 001E                            LBF,'4000'X       30,B6
  20712   1 000784       4000

      757    20713    6                        BFR$ = PINCRW(BFR$,SIZEW(KZ$OTPBFR));

  20713   1 000785  DCC7 000C                            LDB,B5   BFR$,AUTO
          1 000787  CBC5 0008                            LAB,B4   8,B5
          1 000789  CFC7 000C                            STB,B4   BFR$,AUTO

      758    20714    6                        BFR$->KZ$HASPBLK.FLG.RCB = '90'X;

  20714   1 00078B  E870 0090                            LDR,R6   144,IMO
          1 00078D  EAC4 0001                            SRM,R6,'00FF'X    1,B4
          1 00078F       00FF

      759    20715    6                        BFR$->KZ$HASPBLK.FLG.SRCB = DVCTX.RCB_CODE;

  20715   1 000790  ECC7 0008                            LDB,B6   DCTX$,AUTO
          1 000792  D2C6 0024                            LLH,R5   36,B6
          1 000794  5008                                 SOL,R5   8
          1 000795  5048                                 SOR,R5   8
          1 000796  DCC7 000C                            LDB,B5   BFR$,AUTO
          1 000798  D7C5 0002                            STH,R5   2,B5

      760    20716    6                        BFR$->KZ$HASPBLK.TXT(0) = 0;

  20716   1 00079A  ECC7 000C                            LDB,B6   BFR$,AUTO
          1 00079C  8846 0002                            LBF,'00FF'X       2,B6
          1 00079E       00FF

      761    20717    6                        BFR$->KZ$HASPBLK.TXT(1) = 0;

  20717   1 00079F  ECC7 000C                            LDB,B6   BFR$,AUTO
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:135  
          1 0007A1  87C6 0003                            CLH      3,B6

      762    20718    6                        BFR$ = ADDR(NIL);

  20718   1 0007A3  EB80 0000 0000                       LAB,B6   0
          1 0007A6  EFC7 000C                            STB,B6   BFR$,AUTO

      763    20719    6                        DVCTX.STATE = %KZ_S_SAWAITING_PTS#;

  20719   1 0007A8  5C03                                 LDV,R5   3
          1 0007A9  DCC7 0008                            LDB,B5   DCTX$,AUTO
          1 0007AB  D7C5 000A                            STH,R5   10,B5

      764    20720    6                        END;

  20720   1 0007AD  0F81 000D                            B        s:20727,PREL

      765    20721    6                     ELSE DO;

      766    20722    6                        KZ$LINCTX.FLAGS.SND = '1'B;

  20722   1 0007AF  8944 0034                            LBT,'0004'X       52,B4
  20722   1 0007B1       0004

      767    20723    6                        DVCTX.STATE = %KZ_S_SOPEN#;

  20723   1 0007B2  5C04                                 LDV,R5   4
          1 0007B3  D7C5 000A                            STH,R5   10,B5

      768    20724    6                        DVCTX.FLAGS.PTS_OUT = '1'B;

  20724   1 0007B5  8945 001E                            LBT,'1000'X       30,B5
  20724   1 0007B7       1000

      769    20725    6                        DVCTX.FLAGS.FIRST ='1'B;

  20725   1 0007B8  8945 001E                            LBT,'0040'X       30,B5
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:136  
  20725   1 0007BA       0040

      770    20726    6                        END;

      771    20727    5                     %KV_MRD.DVCCLM=1;

  20727   1 0007BB  EC80 0000 0000  xsym                 LDB,B6   KV$PTR$
          1 0007BE  CCC6 0008                            LDB,B4   8,B6
          1 0007C0  6C01                                 LDV,R6   1
          1 0007C1  EF44 001E                            STR,R6   30,B4

      772    20728    5                     %KV_SRD.VRTPSTOK='1'B;

  20728   1 0007C3  CCC6 000A                            LDB,B4   10,B6
          1 0007C5  8944 000E                            LBT,'0010'X       14,B4
          1 0007C7       0010
          1 0007C8  0F81 026F                            B        s:20937,PREL

      773    20729    5                   CASE(ELSE);

      774    20730    5                     IF DVCTX.STATE = %KZ_S_SCLS_AWAITING_PTS# THEN

  20730   1 0007CA  3D07                                 CMV,R3   7
          1 0007CB  0981 026C                            BNE      s:20937,PREL

      775    20731    5                        DVCTX.STATE = %KZ_S_SAWAITING_PTS#;

  20731   1 0007CD  6C03                                 LDV,R6   3
          1 0007CE  E7C5 000A                            STH,R6   10,B5
          1 0007D0  0F81 0267                            B        s:20937,PREL

      776    20732    5                     ELSE
      777    20733    5                        GOTO BADSTATE;
      778    20734    5                   END;

      779    20735
      780    20736                              /* Open Input                           */
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:137  
      781    20737
      782    20738    4                CASE(%KZ_S_DMINPUT# );

      783    20739    4                  IF DVCTX.STATE ~= %KZ_S_SAWAITING_PTS# THEN

  20739   1 0007D2  E2C5 000A                            LLH,R6   10,B5
          1 0007D4  6D03                                 CMV,R6   3
          1 0007D5  0981 0262                            BNE      s:20937,PREL

      784    20740    4                     GOTO BADSTATE;
      785    20741    4                  IF KZ$LINCTX.PRO.PROTYP = %KLPT_HASP#

  20741   1 0007D7  CCC7 000A                            LDB,B4   LCTX$,AUTO
          1 0007D9  D844 003A                            LDR,R5   58,B4
          1 0007DB  5D03                                 CMV,R5   3
          1 0007DC  0901 0004                            BE       s:20743,PREL
          1 0007DE  5D07                                 CMV,R5   7
          1 0007DF  0981 0033                            BNE      s:20757,PREL

      786    20742    5                     OR KZ$LINCTX.PRO.PROTYP = %KLPT_NJE# THEN DO;

      787    20743    5                     IF BFR$ = ADDR(NIL) THEN

  20743   1 0007E1  8DC7 000C                            CMN      BFR$,AUTO
          1 0007E3  0981 0004                            BNE      s:20748,PREL

      788    20744    5                        CALL GET_BFR ALTRET(NOBUF);

  20744   1 0007E5  E3C0 053D                            LNJ,B6   s:0,PREL
          1 0007E7       0265                            DC       s:20955,PREL

      789    20745
      790    20746                             /* Build Grant PTS record */
      791    20747
      792    20748    5                     KZ$OTPBFR.DATA_SIZ=SIZEC(KZ$HASPBLK)+1;

  20748   1 0007E8  ECC7 000C                            LDB,B6   BFR$,AUTO
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:138  
          1 0007EA  6C07                                 LDV,R6   7
          1 0007EB  EF46 0003                            STR,R6   3,B6

      793    20749    5                     CALL QCNTL_BFR;

  20749   1 0007ED  E3C0 0611                            LNJ,B6   s:0,PREL
          1 0007EF       0001                            DC       s:20750,PREL

      794    20750    5                     BFR$ = PINCRW(BFR$,SIZEW(KZ$OTPBFR));

  20750   1 0007F0  ECC7 000C                            LDB,B6   BFR$,AUTO
          1 0007F2  DBC6 0008                            LAB,B5   8,B6
          1 0007F4  DFC7 000C                            STB,B5   BFR$,AUTO

      795    20751    5                     BFR$->KZ$HASPBLK.FLG.RCB = 'A0'X;

  20751   1 0007F6  E870 00A0                            LDR,R6   160,IMO
          1 0007F8  EAC5 0001                            SRM,R6,'00FF'X    1,B5
          1 0007FA       00FF

      796    20752    5                     BFR$->KZ$HASPBLK.FLG.SRCB = DVCTX.RCB_CODE;

  20752   1 0007FB  ECC7 0008                            LDB,B6   DCTX$,AUTO
          1 0007FD  D2C6 0024                            LLH,R5   36,B6
          1 0007FF  5008                                 SOL,R5   8
          1 000800  5048                                 SOR,R5   8
          1 000801  DCC7 000C                            LDB,B5   BFR$,AUTO
          1 000803  D7C5 0002                            STH,R5   2,B5

      797    20753    5                     BFR$->KZ$HASPBLK.TXT(0) = 0;

  20753   1 000805  ECC7 000C                            LDB,B6   BFR$,AUTO
          1 000807  8846 0002                            LBF,'00FF'X       2,B6
          1 000809       00FF

      798    20754    5                     BFR$->KZ$HASPBLK.TXT(1) = 0;

PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:139  
  20754   1 00080A  ECC7 000C                            LDB,B6   BFR$,AUTO
          1 00080C  87C6 0003                            CLH      3,B6

      799    20755    5                     BFR$ = ADDR(NIL);

  20755   1 00080E  EB80 0000 0000                       LAB,B6   0
          1 000811  EFC7 000C                            STB,B6   BFR$,AUTO

      800    20756    5                     END;

      801    20757    4                  DVCTX.STATE = %KZ_S_SOPEN#;

  20757   1 000813  6C04                                 LDV,R6   4
          1 000814  ECC7 0008                            LDB,B6   DCTX$,AUTO
          1 000816  E7C6 000A                            STH,R6   10,B6

      802    20758    4                  DVCTX.FLAGS.PTS_IN = '1'B;

  20758   1 000818  8946 001E                            LBT,'2000'X       30,B6
  20758   1 00081A       2000

      803    20759    4                  DVCTX.FLAGS.SUSPEND_IN = '0'B;

  20759   1 00081B  8846 001E                            LBF,'8000'X       30,B6
  20759   1 00081D       8000

      804    20760    4                  DVCTX.FLAGS.SUSPEND_OUT = '0'B;

  20760   1 00081E  8846 001E                            LBF,'4000'X       30,B6
  20760   1 000820       4000

      805    20761    4                END;

  20761   1 000821  0F81 0216                            B        s:20937,PREL

      806    20762
      807    20763        %EJECT;
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:140  
      808    20764
      809    20765                          /* Close request                                            */
      810    20766
      811    20767    3             CASE(%KV_USR_EVT_ID_CLS);

      812    20768
      813    20769    4               DO CASE(DVCTX.MGR_TYPE);

  20769   1 000823  DCC7 0008                            LDB,B5   DCTX$,AUTO
          1 000825  A2C5 0022                            LLH,R2   34,B5
          1 000827  2D03                                 CMV,R2   3
          1 000828  0281 020F                            BGE      s:20937,PREL
          1 00082A  B820 0000 0830  01                   LDR,R3   s:20769+13,R2
          1 00082D  83B0 0000 0833  01                   JMP      s:20774,R3
          1 000830       00F0                            DC       s:20867,PREL
          1 000831       007A                            DC       s:20831,PREL
          1 000832       0000                            DC       s:20774,PREL

      814    20770    4                CASE(%KZ_S_DMOUTPUT# );

      815    20771
      816    20772                          /* Close output device                                      */
      817    20773
      818    20774    5                  IF DVCTX.STATE = %KZ_S_SOPEN# THEN DO;

  20774   1 000833  E2C5 000A                            LLH,R6   10,B5
          1 000835  6D04                                 CMV,R6   4
          1 000836  0981 004B                            BNE      s:20810,PREL

      819    20775    5                     IF BFR$ ~= ADDR(NIL) AND

  20775   1 000838  8DC7 000C                            CMN      BFR$,AUTO
          1 00083A  0901 0026                            BE       s:20793,PREL
          1 00083C  CCC7 000A                            LDB,B4   LCTX$,AUTO
          1 00083E  82C4 004B                            LB,'0040'X        75,B4
          1 000840       0040
          1 000841  0501 001F                            BBT      s:20793,PREL
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:141  

      820    20776    5                        NOT KZ$LINCTX.PRO.RRR
      821    20777    6                     THEN DO;

      822    20778                             /* Not SECURE:  send remaining record with ETX. */
      823    20779    6                        KZ$OTPBFR.FLAGS.LAST# = '1'B;

  20779   1 000843  BCC7 000C                            LDB,B3   BFR$,AUTO
          1 000845  8943 0002                            LBT,'0040'X       2,B3
          1 000847       0040

      824    20780    6                        CALL SVPRM;

  20780   1 000848  E3C0 0263                            LNJ,B6   s:0,PREL
          1 00084A       0001                            DC       s:20786,PREL

      825    20781                             %KV$CMPOTP;
             20786    7           IF KV$PTR.VDI$->KV$VDI.OTPCNDPND THEN DO;

  20786   1 00084B  EC80 0000 0000  xsym                 LDB,B6   KV$PTR$
          1 00084E  DC86                                 LDB,B5   ,B6
          1 00084F  E845 001A                            LDR,R6   26,B5
          1 000851  6901 000A                            BEZ,R6   s:20790,PREL

             20787    7              CALL KVV$VDI(KV_VDH_EVT_CMPOTP);

  20787   1 000853  BB80 0000 0002  02                   LAB,B3   +2
          1 000856  CBF0 0100                            LAB,B4   256,IMO
          1 000858  E380 0000 0000  xent                 LNJ,B6   KVV$VDI
          1 00085B       0001                            DC       s:20790,PREL

             20788    7              END;                         /* END IF                             */

      826    20790    6                        CALL INITPRM;

  20790   1 00085C  E3C0 021E                            LNJ,B6   s:0,PREL
          1 00085E       0001                            DC       s:20791,PREL
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:142  

      827    20791    6                        END;

  20791   1 00085F  0F81 001B                            B        s:20807,PREL

      828    20792    6                     ELSE DO;

      829    20793    6                        CALL SVPRM;

  20793   1 000861  E3C0 024A                            LNJ,B6   s:0,PREL
          1 000863       0001                            DC       s:20799,PREL

      830    20794                             %KV$CMPOTP;
             20799    7           IF KV$PTR.VDI$->KV$VDI.OTPCNDPND THEN DO;

  20799   1 000864  EC80 0000 0000  xsym                 LDB,B6   KV$PTR$
          1 000867  DC86                                 LDB,B5   ,B6
          1 000868  E845 001A                            LDR,R6   26,B5
          1 00086A  6901 000A                            BEZ,R6   s:20803,PREL

             20800    7              CALL KVV$VDI(KV_VDH_EVT_CMPOTP);

  20800   1 00086C  BB80 0000 0002  02                   LAB,B3   +2
          1 00086F  CBF0 0100                            LAB,B4   256,IMO
          1 000871  E380 0000 0000  xent                 LNJ,B6   KVV$VDI
          1 000874       0001                            DC       s:20803,PREL

             20801    7              END;                         /* END IF                             */

      831    20803    6                        CALL INITPRM;

  20803   1 000875  E3C0 0205                            LNJ,B6   s:0,PREL
          1 000877       0001                            DC       s:20805,PREL

      832    20804                             /* Send zero-length record to signal EOF. */
      833    20805    6                        CALL BLDEOFRC ALTRET(NOBUF);

PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:143  
  20805   1 000878  E3C0 084C                            LNJ,B6   s:0,PREL
          1 00087A       01D2                            DC       s:20955,PREL

      834    20806    6                        END;

      835    20807    5                     DVCTX.STATE = %KZ_S_SCONNECTED#;

  20807   1 00087B  6C02                                 LDV,R6   2
          1 00087C  ECC7 0008                            LDB,B6   DCTX$,AUTO
          1 00087E  E7C6 000A                            STH,R6   10,B6

      836    20808    5                     END;

  20808   1 000880  0F81 01B7                            B        s:20937,PREL

      837    20809    4                  ELSE
      838    20810    5                     IF DVCTX.STATE = %KZ_S_SAWAITING_PTS# THEN DO;

  20810   1 000882  6D03                                 CMV,R6   3
          1 000883  0981 0027                            BNE      s:20825,PREL

      839    20811                             /* Device opened by host awaiting PTS.  Put
      840    20812                                it in AWAITING PTS which means closed by
      841    20813                                host, if permission shows up later, send
      842    20814                                EOF then.                              */
      843    20815    5                        DVCTX.STATE=%KZ_S_SCLS_AWAITING_PTS#;

  20815   1 000885  5C07                                 LDV,R5   7
          1 000886  D7C5 000A                            STH,R5   10,B5

      844    20816    5                        CALL DQ;

  20816   1 000888  E3C0 0933                            LNJ,B6   s:0,PREL
          1 00088A       0001                            DC       s:20817,PREL

      845    20817    5                        CALL KZR$DFR(DVCTX);

PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:144  
  20817   1 00088B  BBC7 0008                            LAB,B3   DCTX$,AUTO
          1 00088D  CBF0 0100                            LAB,B4   256,IMO
          1 00088F  E380 0000 0000  xent                 LNJ,B6   KZR$DFR
          1 000892       0001                            DC       s:20818,PREL

      846    20818    6                        IF BFR$ ~= ADDR(NIL) THEN DO;

  20818   1 000893  8DC7 000C                            CMN      BFR$,AUTO
          1 000895  0901 01A2                            BE       s:20937,PREL

      847    20819    6                           KZ$OTPBFR.TYP = %KZ#BFRTYP_OTP;

  20819   1 000897  6C02                                 LDV,R6   2
          1 000898  ECC7 000C                            LDB,B6   BFR$,AUTO
          1 00089A  E7C6 0002                            STH,R6   2,B6

      848    20820    6                           CALL KZR$RELOTPBFR(KZ$OTPBFR);

  20820   1 00089C  BBC7 000C                            LAB,B3   BFR$,AUTO
          1 00089E  CBF0 0100                            LAB,B4   256,IMO
          1 0008A0  E380 0000 0000  xent                 LNJ,B6   KZR$RELOTPBFR
          1 0008A3       0001                            DC       s:20821,PREL

      849    20821    6                           BFR$ = ADDR(NIL);

  20821   1 0008A4  EB80 0000 0000                       LAB,B6   0
          1 0008A7  EFC7 000C                            STB,B6   BFR$,AUTO

      850    20822    6                           END;

      851    20823    5                        END;

  20823   1 0008A9  0F81 018E                            B        s:20937,PREL

      852    20824    5                     ELSE DO;

      853    20825    5                        GOTO BADSTATE;
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:145  

  20825   1 0008AB  0F81 018C                            B        s:20937,PREL

      854    20826    5                        END;
      855    20827
      856    20828                           /* Close Input                                  */
      857    20829
      858    20830    4                CASE(%KZ_S_DMINPUT# );

      859    20831    4                  IF DVCTX.STATE = %KZ_S_SOPEN# OR

  20831   1 0008AD  E2C5 000A                            LLH,R6   10,B5
          1 0008AF  6D04                                 CMV,R6   4
          1 0008B0  0901 0004                            BE       s:20833,PREL
          1 0008B2  6D05                                 CMV,R6   5
          1 0008B3  0981 0184                            BNE      s:20937,PREL

      860    20832    5                     DVCTX.STATE = %KZ_S_SAWAITING_CLOSE# THEN DO;

      861    20833    5                     IF KZ$LINCTX.PRO.PROTYP ~= %KLPT_HASP#

  20833   1 0008B5  CCC7 000A                            LDB,B4   LCTX$,AUTO
          1 0008B7  D844 003A                            LDR,R5   58,B4
          1 0008B9  5D03                                 CMV,R5   3
          1 0008BA  0901 000B                            BE       s:20837,PREL
          1 0008BC  5D07                                 CMV,R5   7
          1 0008BD  0901 0008                            BE       s:20837,PREL

      862    20834    5                        AND KZ$LINCTX.PRO.PROTYP ~= %KLPT_NJE# THEN
      863    20835    5                        KZ$LINCTX.CURDEV$=ADDR(NIL);

  20835   1 0008BF  BB80 0000 0000                       LAB,B3   0
          1 0008C2  BFC4 0050                            STB,B3   80,B4
          1 0008C4  0F81 0036                            B        s:20852,PREL

      864    20836    5                     ELSE
      865    20837    6                        IF KZ$LINCTX.PRO.PROTYP = %KLPT_NJE# THEN DO;
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:146  

  20837   1 0008C6  5D07                                 CMV,R5   7
          1 0008C7  0981 0033                            BNE      s:20852,PREL

      866    20838    6                           IF BFR$ = ADDR(NIL) THEN

  20838   1 0008C9  8DC7 000C                            CMN      BFR$,AUTO
          1 0008CB  0981 0004                            BNE      s:20843,PREL

      867    20839    6                              CALL GET_BFR ALTRET(NOBUF);

  20839   1 0008CD  E3C0 0455                            LNJ,B6   s:0,PREL
          1 0008CF       017D                            DC       s:20955,PREL

      868    20840
      869    20841                                   /* Build a Completed Stream record */
      870    20842
      871    20843    6                           KZ$OTPBFR.DATA_SIZ=SIZEC(KZ$HASPBLK)+1;

  20843   1 0008D0  ECC7 000C                            LDB,B6   BFR$,AUTO
          1 0008D2  6C07                                 LDV,R6   7
          1 0008D3  EF46 0003                            STR,R6   3,B6

      872    20844    6                           CALL QCNTL_BFR;

  20844   1 0008D5  E3C0 0529                            LNJ,B6   s:0,PREL
          1 0008D7       0001                            DC       s:20845,PREL

      873    20845    6                           BFR$ = PINCRW(BFR$,SIZEW(KZ$OTPBFR));

  20845   1 0008D8  ECC7 000C                            LDB,B6   BFR$,AUTO
          1 0008DA  DBC6 0008                            LAB,B5   8,B6
          1 0008DC  DFC7 000C                            STB,B5   BFR$,AUTO

      874    20846    6                           BFR$->KZ$HASPBLK.FLG.RCB = 'C0'X;

  20846   1 0008DE  E870 00C0                            LDR,R6   192,IMO
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:147  
          1 0008E0  EAC5 0001                            SRM,R6,'00FF'X    1,B5
          1 0008E2       00FF

      875    20847    6                           BFR$->KZ$HASPBLK.FLG.SRCB = DVCTX.RCB_CODE;

  20847   1 0008E3  ECC7 0008                            LDB,B6   DCTX$,AUTO
          1 0008E5  D2C6 0024                            LLH,R5   36,B6
          1 0008E7  5008                                 SOL,R5   8
          1 0008E8  5048                                 SOR,R5   8
          1 0008E9  DCC7 000C                            LDB,B5   BFR$,AUTO
          1 0008EB  D7C5 0002                            STH,R5   2,B5

      876    20848    6                           BFR$->KZ$HASPBLK.TXT(0) = 0;

  20848   1 0008ED  ECC7 000C                            LDB,B6   BFR$,AUTO
          1 0008EF  8846 0002                            LBF,'00FF'X       2,B6
          1 0008F1       00FF

      877    20849    6                           BFR$->KZ$HASPBLK.TXT(1) = 0;

  20849   1 0008F2  ECC7 000C                            LDB,B6   BFR$,AUTO
          1 0008F4  87C6 0003                            CLH      3,B6

      878    20850    6                           BFR$ = ADDR(NIL);

  20850   1 0008F6  EB80 0000 0000                       LAB,B6   0
          1 0008F9  EFC7 000C                            STB,B6   BFR$,AUTO

      879    20851    6                           END;

      880    20852    6                     IF DVCTX.FLAGS.BRKRQD THEN DO;

  20852   1 0008FB  ECC7 0008                            LDB,B6   DCTX$,AUTO
          1 0008FD  82C6 001E                            LB,'0100'X        30,B6
          1 0008FF       0100
          1 000900  0581 001F                            BBF      s:20864,PREL

PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:148  
      881    20853
      882    20854                                  /* Send an Attention event to indicate input
      883    20855                                     ready.                               */
      884    20856
      885    20857    6                        DVCTX.STATE = %KZ_S_SAWAITING_PTS#;

  20857   1 000902  6C03                                 LDV,R6   3
          1 000903  E7C6 000A                            STH,R6   10,B6

      886    20858    6                        KV$VDH_EVT=KV_VDH_EVT;

  20858   1 000905  8C80 0000 0023  00                   LDI      KV_VDH_EVT
          1 000908  8D47 0040                            SDI      KV$VDH_EVT,AUTO

      887    20859    6                        KV$VDH_EVT.PRM=1;     /*BRK count */

  20859   1 00090A  5C01                                 LDV,R5   1
          1 00090B  DF47 0041                            STR,R5   KV$VDH_EVT+1,AUTO

      888    20860    6                        CALL KVV$VDI (KV$VDH_EVT);

  20860   1 00090D  DBC7 0040                            LAB,B5   KV$VDH_EVT,AUTO
          1 00090F  DFC7 0064                            STB,B5   P$+6,AUTO
          1 000911  BBC7 0064                            LAB,B3   P$+6,AUTO
          1 000913  CBF0 0100                            LAB,B4   256,IMO
          1 000915  E380 0000 0000  xent                 LNJ,B6   KVV$VDI
          1 000918       0001                            DC       s:20861,PREL

      889    20861    6                        DVCTX.FLAGS.BRKRQD = '0'B;

  20861   1 000919  ECC7 0008                            LDB,B6   DCTX$,AUTO
          1 00091B  8846 001E                            LBF,'0100'X       30,B6
          1 00091D       0100

      890    20862    6                        END;

  20862   1 00091E  0F81 0119                            B        s:20937,PREL
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:149  

      891    20863    5                     ELSE
      892    20864    5                        DVCTX.STATE = %KZ_S_SCONNECTED#;

  20864   1 000920  6C02                                 LDV,R6   2
          1 000921  E7C6 000A                            STH,R6   10,B6

      893    20865    5                     END;

      894    20866
      895    20867    4                END;

  20867   1 000923  0F81 0114                            B        s:20937,PREL

      896    20868        %EJECT;
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:150  
      897    20869                  /* Initiate disconnect                                   */
      898    20870
      899    20871    3             CASE(%KV_USR_EVT_ID_DSC);

      900    20872
      901    20873    3               IF NOT KZ$LINCTX.FLAGS.DSC THEN

  20873   1 000925  DCC7 000A                            LDB,B5   LCTX$,AUTO
          1 000927  82C5 0034                            LB,'1000'X        52,B5
          1 000929       1000
          1 00092A  0501 010D                            BBT      s:20937,PREL

      902    20874    3                  CALL REPCLMEVT (%KZ#CLM_EVENT_KILLED);

  20874   1 00092C  CBF0 0007                            LAB,B4   7,IMO
          1 00092E  CFC7 005C                            STB,B4   KV$VDH_OTPLCL+7,AUTO
          1 000930  E3C0 082C                            LNJ,B6   s:0,PREL
          1 000932       0001                            DC       s:20874+7,PREL
          1 000933  0F81 0104                            B        s:20937,PREL

      903    20875        %EJECT;
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:151  
      904    20876                  /* VDH is ready to release VDI context                   */
      905    20877
      906    20878    3             CASE(%KV_USR_EVT_ID_RLSVDI);

      907    20879    3               DVCTX.DSC.VDH_FINAL = '1'B;

  20879   1 000935  DCC7 0008                            LDB,B5   DCTX$,AUTO
          1 000937  8945 001E                            LBT,'0002'X       30,B5
          1 000939       0002

      908    20880    3               CALL DQ;

  20880   1 00093A  E3C0 0881                            LNJ,B6   s:0,PREL
          1 00093C       0001                            DC       s:20881,PREL

      909    20881    3               CALL KZR$DFR (DVCTX);

  20881   1 00093D  BBC7 0008                            LAB,B3   DCTX$,AUTO
          1 00093F  CBF0 0100                            LAB,B4   256,IMO
          1 000941  E380 0000 0000  xent                 LNJ,B6   KZR$DFR
          1 000944       0001                            DC       s:20882,PREL

      910    20882    4               IF BFR$ ~= ADDR(NIL) THEN DO;

  20882   1 000945  8DC7 000C                            CMN      BFR$,AUTO
          1 000947  0901 0017                            BE       s:20887,PREL

      911    20883    4                  I=KZ$OTPBFR.BFRSIZ;

  20883   1 000949  ECC7 000C                            LDB,B6   BFR$,AUTO
          1 00094B  E846 0004                            LDR,R6   4,B6
          1 00094D  EF47 0013                            STR,R6   I,AUTO

      912    20884    4                  CALL KVB$RLS2NSYS (I,BFR$);

  20884   1 00094F  DBC7 000C                            LAB,B5   BFR$,AUTO
          1 000951  DFC7 0066                            STB,B5   P$+8,AUTO
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:152  
          1 000953  CBC7 0013                            LAB,B4   I,AUTO
          1 000955  CFC7 0064                            STB,B4   P$+6,AUTO
          1 000957  BBC7 0064                            LAB,B3   P$+6,AUTO
          1 000959  CBF0 0200                            LAB,B4   512,IMO
          1 00095B  E380 0000 0000  xent                 LNJ,B6   KVB$RLS2NSYS
          1 00095E       0001                            DC       s:20887,PREL

      913    20885    4                  END;

      914    20886                    /* Find the device context on the line chain           */
      915    20887    3               U$=ADDR(NIL);

  20887   1 00095F  EB80 0000 0000                       LAB,B6   0
          1 000962  EFC7 0016                            STB,B6   U$,AUTO

      916    20888    3               T$= KZ$LINCTX.CTRHD$;

  20888   1 000964  DCC7 000A                            LDB,B5   LCTX$,AUTO
          1 000966  CC85                                 LDB,B4   ,B5
          1 000967  CFC7 0014                            STB,B4   T$,AUTO

      917    20889    4               DO WHILE (T$ ~= DCTX$);

  20889   1 000969  CDC7 0008                            CMB,B4   DCTX$,AUTO
          1 00096B  0901 000F                            BE       s:20895,PREL

      918    20890    4                  U$ = T$;

  20890   1 00096D  ECC7 0014                            LDB,B6   T$,AUTO
          1 00096F  EFC7 0016                            STB,B6   U$,AUTO

      919    20891    4                  T$ = T$->DVCTX.LNK$;

  20891   1 000971  DC86                                 LDB,B5   ,B6
          1 000972  DFC7 0014                            STB,B5   T$,AUTO

      920    20892    4                  IF T$ = ADDR(NIL) THEN
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:153  

  20892   1 000974  8DC7 0014                            CMN      T$,AUTO
          1 000976  0901 00C1                            BE       s:20937,PREL

      921    20893    4                     GOTO BADSTATE;
      922    20894    4                  END;

  20894   1 000978  DDC7 0008                            CMB,B5   DCTX$,AUTO
          1 00097A  09F3                                 BNE      s:20890,SPREL

      923    20895    3               KZ_HASP_HDR.STTBFR$->KZ$SYNCSTAT.ACTSTR = KZ_HASP_HDR.STTBFR$->
             20895                        KZ$SYNCSTAT.ACTSTR-1;

  20895   1 00097B  DC80 0000 0006  xsym                 LDB,B5   KZ_HASP_HDR+6
          1 00097E  8CC5 0082                            LDI      130,B5
          1 000980  8470 FFFF FFFF                       AID      -1,IMO
          1 000983  8D45 0082                            SDI      130,B5

      924    20896    3               KZ$LINCTX.CURDEV$=ADDR(NIL);

  20896   1 000985  CB80 0000 0000                       LAB,B4   0
          1 000988  BCC7 000A                            LDB,B3   LCTX$,AUTO
          1 00098A  CFC3 0050                            STB,B4   80,B3

      925    20897    4               IF (DVCTX.MGR_TYPE = %KZ_S_DMCONSOLE#) THEN DO;

  20897   1 00098C  ACC7 0008                            LDB,B2   DCTX$,AUTO
          1 00098E  E2C2 0022                            LLH,R6   34,B2
          1 000990  6D03                                 CMV,R6   3
          1 000991  0981 0021                            BNE      s:20905,PREL

      926    20898    4                  KZ_HASP_HDR.STTBFR$->KZ$SYNCSTAT.ACTSTR = KZ_HASP_HDR.STTBFR$->
             20898                           KZ$SYNCSTAT.ACTSTR-1;

  20898   1 000993  8CC5 0082                            LDI      130,B5
          1 000995  8470 FFFF FFFF                       AID      -1,IMO
          1 000998  8D45 0082                            SDI      130,B5
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:154  

      927    20899    4                  T$ = DVCTX.LNK$;

  20899   1 00099A  CC82                                 LDB,B4   ,B2
          1 00099B  CFC7 0014                            STB,B4   T$,AUTO

      928    20900    5                  IF T$ ~= ADDR(NIL) THEN DO;

  20900   1 00099D  8DC7 0014                            CMN      T$,AUTO
          1 00099F  0901 0013                            BE       s:20905,PREL

      929    20901    5                     DVCTX.LNK$=T$->DVCTX.LNK$;

  20901   1 0009A1  9C84                                 LDB,B1   ,B4
          1 0009A2  9F82                                 STB,B1   ,B2

      930    20902    5                     CALL KVB$RLS (SIZEW(DVCTX),T$);

  20902   1 0009A3  DBF0 003A                            LAB,B5   58,IMO
          1 0009A5  CBC7 0014                            LAB,B4   T$,AUTO
          1 0009A7  CFC7 0066                            STB,B4   P$+8,AUTO
          1 0009A9  DFC7 0064                            STB,B5   P$+6,AUTO
          1 0009AB  BBC7 0064                            LAB,B3   P$+6,AUTO
          1 0009AD  CBF0 0200                            LAB,B4   512,IMO
          1 0009AF  E380 0000 0000  xent                 LNJ,B6   KVB$RLS
          1 0009B2       0001                            DC       s:20905,PREL

      931    20903    5                     END;

      932    20904    4                  END;

      933    20905    3               CALL REPCLMEVT_DEV (%KZ#CLM_EVENT_DEVDSC);

  20905   1 0009B3  EBF0 000B                            LAB,B6   11,IMO
          1 0009B5  EFC7 005C                            STB,B6   KV$VDH_OTPLCL+7,AUTO
          1 0009B7  E3C0 07D4                            LNJ,B6   s:0,PREL
          1 0009B9       0001                            DC       s:20906,PREL
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:155  

      934    20906    3               IF U$ ~= ADDR(NIL) THEN

  20906   1 0009BA  8DC7 0016                            CMN      U$,AUTO
          1 0009BC  0901 0009                            BE       s:20909,PREL

      935    20907    3                  U$->DVCTX.LNK$ = DVCTX.LNK$;

  20907   1 0009BE  ECC7 0008                            LDB,B6   DCTX$,AUTO
          1 0009C0  DC86                                 LDB,B5   ,B6
          1 0009C1  CCC7 0016                            LDB,B4   U$,AUTO
          1 0009C3  DF84                                 STB,B5   ,B4
          1 0009C4  0F81 0007                            B        s:20910,PREL

      936    20908    3               ELSE
      937    20909    3                  KZ$LINCTX.CTRHD$=DVCTX.LNK$;

  20909   1 0009C6  ECC7 0008                            LDB,B6   DCTX$,AUTO
          1 0009C8  DC86                                 LDB,B5   ,B6
          1 0009C9  CCC7 000A                            LDB,B4   LCTX$,AUTO
          1 0009CB  DF84                                 STB,B5   ,B4

      938    20910    3               CALL KVB$RLS (SIZEW(DVCTX),DCTX$);

  20910   1 0009CC  EBF0 003A                            LAB,B6   58,IMO
          1 0009CE  DBC7 0008                            LAB,B5   DCTX$,AUTO
          1 0009D0  DFC7 0066                            STB,B5   P$+8,AUTO
          1 0009D2  EFC7 0064                            STB,B6   P$+6,AUTO
          1 0009D4  BBC7 0064                            LAB,B3   P$+6,AUTO
          1 0009D6  CBF0 0200                            LAB,B4   512,IMO
          1 0009D8  E380 0000 0000  xent                 LNJ,B6   KVB$RLS
          1 0009DB       0001                            DC       s:20911,PREL

      939    20911    3               IF KZ$LINCTX.CTRHD$ = ADDR(NIL) THEN

  20911   1 0009DC  ECC7 000A                            LDB,B6   LCTX$,AUTO
          1 0009DE  8D86                                 CMN      ,B6
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:156  
          1 0009DF  0981 0058                            BNE      s:20937,PREL

      940    20912    3                  CALL REPCLMEVT (%KZ#CLM_EVENT_LINDSC);

  20912   1 0009E1  DBF0 000A                            LAB,B5   10,IMO
          1 0009E3  DFC7 005C                            STB,B5   KV$VDH_OTPLCL+7,AUTO
          1 0009E5  E3C0 0777                            LNJ,B6   s:0,PREL
          1 0009E7       0001                            DC       s:20912+7,PREL
          1 0009E8  0F81 004F                            B        s:20937,PREL

      941    20913        %EJECT;
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:157  
      942    20914                  /* VDH is running at background level                    */
      943    20915
      944    20916    3             CASE(%KV_USR_EVT_ID_SCH);

      945    20917    3               CALL KZR$DFR(DVCTX);

  20917   1 0009EA  BBC7 0008                            LAB,B3   DCTX$,AUTO
          1 0009EC  CBF0 0100                            LAB,B4   256,IMO
          1 0009EE  E380 0000 0000  xent                 LNJ,B6   KZR$DFR
          1 0009F1       0001                            DC       s:20918,PREL

      946    20918    3               IF DVCTX.DFR.DSCI THEN

  20918   1 0009F2  ECC7 0008                            LDB,B6   DCTX$,AUTO
          1 0009F4  89C6 001F                            CMZ      31,B6
          1 0009F6  0881 000B                            BAGE     s:20921,PREL

      947    20919    3                  CALL KZR$DSC_CONT(DVCTX);

  20919   1 0009F8  BBC7 0008                            LAB,B3   DCTX$,AUTO
          1 0009FA  CBF0 0100                            LAB,B4   256,IMO
          1 0009FC  E380 0000 0000  xent                 LNJ,B6   KZR$DSC_CONT
          1 0009FF       0001                            DC       s:20919+8,PREL
          1 000A00  0F81 0037                            B        s:20937,PREL

      948    20920    4               ELSE DO;

      949    20921    4                  IF DVCTX.STATE = %KZ_S_SCONNECTED# AND

  20921   1 000A02  E2C6 000A                            LLH,R6   10,B6
          1 000A04  6D02                                 CMV,R6   2
          1 000A05  0981 0022                            BNE      s:20929,PREL
          1 000A07  82C6 001E                            LB,'0100'X        30,B6
          1 000A09       0100
          1 000A0A  0581 001D                            BBF      s:20929,PREL

      950    20922    5                     DVCTX.FLAGS.BRKRQD THEN DO;
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:158  

      951    20923    5                     KV$VDH_EVT=KV_VDH_EVT;

  20923   1 000A0C  8C80 0000 0023  00                   LDI      KV_VDH_EVT
          1 000A0F  8D47 0040                            SDI      KV$VDH_EVT,AUTO

      952    20924    5                     KV$VDH_EVT.PRM=1;

  20924   1 000A11  5C01                                 LDV,R5   1
          1 000A12  DF47 0041                            STR,R5   KV$VDH_EVT+1,AUTO

      953    20925    5                     CALL KVV$VDI (KV$VDH_EVT);

  20925   1 000A14  DBC7 0040                            LAB,B5   KV$VDH_EVT,AUTO
          1 000A16  DFC7 0064                            STB,B5   P$+6,AUTO
          1 000A18  BBC7 0064                            LAB,B3   P$+6,AUTO
          1 000A1A  CBF0 0100                            LAB,B4   256,IMO
          1 000A1C  E380 0000 0000  xent                 LNJ,B6   KVV$VDI
          1 000A1F       0001                            DC       s:20926,PREL

      954    20926    5                     DVCTX.FLAGS.BRKRQD='0'B;

  20926   1 000A20  ECC7 0008                            LDB,B6   DCTX$,AUTO
          1 000A22  8846 001E                            LBF,'0100'X       30,B6
          1 000A24       0100

      955    20927    5                     DVCTX.STATE = %KZ_S_SAWAITING_PTS#;

  20927   1 000A25  6C03                                 LDV,R6   3
          1 000A26  E7C6 000A                            STH,R6   10,B6

      956    20928    5                     END;

      957    20929    5                  IF DVCTX.DFR.EOFREC THEN DO;

  20929   1 000A28  82C6 001F                            LB,'4000'X        31,B6
  20929   1 000A2A       4000
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:159  
          1 000A2B  0581 000C                            BBF      s:20937,PREL

      958    20930    5                     CALL BLDEOFRC;

  20930   1 000A2D  E3C0 0697                            LNJ,B6   s:0,PREL
          1 000A2F       0001                            DC       s:20931,PREL

      959    20931    5                     DVCTX.STATE = %KZ_S_SCONNECTED#;

  20931   1 000A30  6C02                                 LDV,R6   2
          1 000A31  ECC7 0008                            LDB,B6   DCTX$,AUTO
          1 000A33  E7C6 000A                            STH,R6   10,B6

      960    20932    5                     DVCTX.DFR.EOFREC = '0'B;

  20932   1 000A35  8846 001F                            LBF,'4000'X       31,B6
  20932   1 000A37       4000

      961    20933    5                     END;

      962    20934    4                  END;

      963    20935
      964    20936    3             END /* Case */;

      965    20937    2          END FNC_CASE;

  20927   1                              BADSTATE        null
      966    20938        %EJECT;
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:160  
      967    20939                          /* Path time update                                         */
      968    20940
      969    20941    1   BADSTATE: ;
      970    20942              %ENABLE (DISLVL=LEV,INHLVL=KZ$LINCTX.INHLVL);

  20943   1 000A38  ECC7 000A            BADSTATE        LDB,B6   LCTX$,AUTO
          1 000A3A  E847 001C                            LDR,R6   LEV,AUTO
          1 000A3C  E946 0035                            CMR,R6   53,B6
          1 000A3E  0901 0007                            BE       s:20948,PREL

  20945   1 000A40  CBF0 0000                            LAB,B4   0,IMO
          1 000A42  E380 0000 0000  xent                 LNJ,B6   KHI$ENABLE
          1 000A45       0001                            DC       s:20948,PREL

      971    20948    1         CALL SVPRM;

  20948   1 000A46  E3C0 0065                            LNJ,B6   s:0,PREL
          1 000A48       0001                            DC       s:20950,PREL

      972    20949
      973    20950    1         RETURN;

  20950   1 000A49  C380 0000 0000  xent                 LNJ,B4   X6A_ARET

      974    20951
      975    20952              /*    Log "Out of MEMory" error and kill the line.    */
      976    20953
      977    20954    1   NOBUF:
      978    20955    1         FPT_WRSYSLOG=FPT@WRSYSLOG;

  20955   1 000A4C  AB80 0000 0000  00   NOBUF           LAB,B2   FPT@WRSYSLOG
          1 000A4F  2C00                                 LDV,R2   0
          1 000A50  6C2A                                 LDV,R6   42
          1 000A51  BB87                                 LAB,B3   ,AUTO
          1 000A52  3C56                                 LDV,R3   86
          1 000A53  0008                                 MMM

PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:161  
      979    20956    1         FPT_WRSYSLOG.V.ERRCODE.ERR# = %E$NOBFR;

  20956   1 000A54  E870 0380                            LDR,R6   896,IMO
          1 000A56  EAC7 0032                            SRM,R6,'FFF8'X    FPT_WRSYSLOG+7,AUTO
          1 000A58       FFF8

      980    20957    1         FPT_WRSYSLOG.V.TERMID = KZ$LINCTX.LINID;

  20957   1 000A59  ACC7 000A                            LDB,B2   LCTX$,AUTO
          1 000A5B  2C08                                 LDV,R2   8
          1 000A5C  6C10                                 LDV,R6   16
          1 000A5D  BB87                                 LAB,B3   ,AUTO
          1 000A5E  3C66                                 LDV,R3   102
          1 000A5F  0008                                 MMM

      981    20958    1         FPT_WRSYSLOG.V.VALUES (0) = SZ;

  20958   1 000A60  E847 0023                            LDR,R6   SZ,AUTO
          1 000A62  EF47 003B                            STR,R6   FPT_WRSYSLOG+16,AUTO

      982    20959    1         CALL KHA$ERRLOG (FPT_WRSYSLOG);

  20959   1 000A64  EBC7 002B                            LAB,B6   FPT_WRSYSLOG,AUTO
          1 000A66  EFC7 0064                            STB,B6   P$+6,AUTO
          1 000A68  BBC7 0064                            LAB,B3   P$+6,AUTO
          1 000A6A  CBF0 0100                            LAB,B4   256,IMO
          1 000A6C  E380 0000 0000  xent                 LNJ,B6   KHA$ERRLOG
          1 000A6F       0001                            DC       s:20969,PREL

      983    20960        /*E*  ERROR:        KZD-E$NOBFR-6
      984    20961              MESSAGE:      Insufficient BISYNC MEMory (a NETCON parameter).
      985    20962              DESCRIPTION:  A KVB call ALTRETed to indicate that BISYNC is out of
      986    20963                            MEMory.  Since a necessary I/O buffer or device context
      987    20964                            could not be allocated, the HASP/2780/3780 TERMinal
      988    20965                            associated with the request has been disconnected.
      989    20966                            V0 = Size of buffer, in words, which could not be allocated.
      990    20967        */
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:162  
      991    20968
      992    20969    1         CALL REPCLMEVT (%KZ#CLM_EVENT_KILLED);

  20969   1 000A70  EBF0 0007                            LAB,B6   7,IMO
          1 000A72  EFC7 005C                            STB,B6   KV$VDH_OTPLCL+7,AUTO
          1 000A74  E3C0 06E8                            LNJ,B6   s:0,PREL
          1 000A76       0001                            DC       s:20972,PREL

      993    20970              /*  Zero out BYTSIZ so VDH won't continue to call us with output,
      994    20971                  or to call us asking for an output buffer.  */
      995    20972    1         BYTSIZ=0;

  20972   1 000A77  8747 0011                            CL       BYTSIZ,AUTO

      996    20973    1         GOTO BADSTATE;

  20973   1 000A79  0F81 FFBE                            B        s:20937,PREL

      997    20974
      998    20975        %EJECT;
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:163  
      999    20976        /*    Initialize from VDI data   */
     1000    20977
     1001    20978    1   INITPRM: PROC;

  20978   1 000A7B  EFC7 005C            INITPRM         STB,B6   KV$VDH_OTPLCL+7,AUTO

     1002    20979
     1003    20980    2         BFR$ = %KV_VDI.OTPBFR_.ADR$;

  20980   1 000A7D  DC80 0000 0000  xsym                 LDB,B5   KV$PTR$
          1 000A80  CC85                                 LDB,B4   ,B5
          1 000A81  BCC4 000A                            LDB,B3   10,B4
          1 000A83  BFC7 000C                            STB,B3   BFR$,AUTO

     1004    20981    2         BYTX = %KV_VDI.OTPBFR_.BYTX;

  20981   1 000A85  CC85                                 LDB,B4   ,B5
          1 000A86  E844 000C                            LDR,R6   12,B4
          1 000A88  EF47 0010                            STR,R6   BYTX,AUTO

     1005    20982    2         BYTSIZ = %KV_VDI.OTPBFR_.BYTSIZ;

  20982   1 000A8A  D844 000D                            LDR,R5   13,B4
          1 000A8C  DF47 0011                            STR,R5   BYTSIZ,AUTO

     1006    20983    2         DCTX$ = %KV_VDI.USRCTX$;

  20983   1 000A8E  ACC4 0002                            LDB,B2   2,B4
          1 000A90  AFC7 0008                            STB,B2   DCTX$,AUTO

     1007    20984    2         LCTX$ = DVCTX.LIN$;

  20984   1 000A92  CCC2 000D                            LDB,B4   13,B2
          1 000A94  CFC7 000A                            STB,B4   LCTX$,AUTO

     1008    20985    2         IF KZ$LINCTX.PRO.PROTYP = %KLPT_3780# THEN

PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:164  
  20985   1 000A96  C844 003A                            LDR,R4   58,B4
          1 000A98  4D02                                 CMV,R4   2
          1 000A99  0981 0009                            BNE      s:20988,PREL

     1009    20986    2            IRS=KZ$LINCTX.PRO.IRSCHR;  /* Default '1E'X */

  20986   1 000A9B  B844 0042                            LDR,R3   66,B4
          1 000A9D  3008                                 SOL,R3   8
          1 000A9E  3048                                 SOR,R3   8
          1 000A9F  B7C7 001D                            STH,R3   IRS,AUTO
          1 000AA1  0F81 0006                            B        s:20989,PREL

     1010    20987    2         ELSE
     1011    20988    2            IRS='1F'X;

  20988   1 000AA3  B870 1F00                            LDR,R3   7936,IMO
          1 000AA5  3048                                 SOR,R3   8
          1 000AA6  B7C7 001D                            STH,R3   IRS,AUTO

     1012    20989    2         RETURN;

  20989   1 000AA8  ECC7 005C                            LDB,B6   KV$VDH_OTPLCL+7,AUTO
          1 000AAA  C3C6 0001                            LNJ,B4   1,B6

     1013    20990    2   END INITPRM;
     1014    20991
     1015    20992        /*    Save VDI parameters                                          */
     1016    20993
     1017    20994    1   SVPRM: PROC;

  20994   1 000AAC  EFC7 005C            SVPRM           STB,B6   KV$VDH_OTPLCL+7,AUTO

     1018    20995
     1019    20996    2         %KV_VDI.OTPBFR_.ADR$=BFR$;

  20996   1 000AAE  DC80 0000 0000  xsym                 LDB,B5   KV$PTR$
          1 000AB1  CC85                                 LDB,B4   ,B5
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:165  
          1 000AB2  BCC7 000C                            LDB,B3   BFR$,AUTO
          1 000AB4  BFC4 000A                            STB,B3   10,B4

     1020    20997    2         %KV_VDI.OTPBFR_.BYTX=BYTX;

  20997   1 000AB6  EC85                                 LDB,B6   ,B5
          1 000AB7  E847 0010                            LDR,R6   BYTX,AUTO
          1 000AB9  EF46 000C                            STR,R6   12,B6

     1021    20998    2         %KV_VDI.OTPBFR_.BYTSIZ=BYTSIZ;

  20998   1 000ABB  EC85                                 LDB,B6   ,B5
          1 000ABC  D847 0011                            LDR,R5   BYTSIZ,AUTO
          1 000ABE  DF46 000D                            STR,R5   13,B6

     1022    20999    2         RETURN;

  20999   1 000AC0  ECC7 005C                            LDB,B6   KV$VDH_OTPLCL+7,AUTO
          1 000AC2  C3C6 0001                            LNJ,B4   1,B6

     1023    21000    2   END;
     1024    21001
     1025    21002        %EJECT;
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:166  
     1026    21003        /*D*  NAME: KZD$SNDSIGNON
     1027    21004              CALL:
     1028    21005                    CALL KZD$SNDSIGNON (KZ$SDVCTX);
     1029    21006              PARAMETER:
     1030    21007                    KZ$SDVCTX of the device to send the initial SIGNON
     1031    21008                    through.
     1032    21009              DESCRIPTION:
     1033    21010                    This entry places a I-type SIGNON response record on the
     1034    21011                    specified device's output queue.
     1035    21012                                                                           */
     1036    21013    1   KZD$SNDSIGNON: ENTRY (PARM) ALTRET;

  21013   1 000AC4  D380 0000 0000  xent KZD$SNDSIGNON   LNJ,B5   X6A_AUTO_1
          1 000AC7       0068 0001                       DC       104,1

     1037    21014    1         SGNITYPE = '1'B;

  21014   1 000AC9  8947 0022                            LBT,'8000'X       SGNITYPE,AUTO
  21014   1 000ACB       8000

     1038    21015    1         GOTO SIGNON_COMMON;

  21015   1 000ACC  0F81 0008                            B        s:21031,PREL

     1039    21016
     1040    21017        /*D*  NAME: KZD$ACKSIGNON
     1041    21018              CALL:
     1042    21019                    CALL KZD$ACKSIGNON (KZ$SDVCTX);
     1043    21020              PARAMETER:
     1044    21021                    KZ$SDVCTX of the device to send the SIGNON acknowledgement
     1045    21022                    through.
     1046    21023              DESCRIPTION:
     1047    21024                    This entry places a J-type SIGNON response record on the
     1048    21025                    specified device's output queue.
     1049    21026                                                                           */
     1050    21027    1   KZD$ACKSIGNON: ENTRY (PARM) ALTRET;

PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:167  
  21027   1 000ACE  D380 0000 0000  xent KZD$ACKSIGNON   LNJ,B5   X6A_AUTO_1
          1 000AD1       0068 0001                       DC       104,1

     1051    21028    1         SGNITYPE = '0'B;

  21028   1 000AD3  8747 0022                            CL       SGNITYPE,AUTO

     1052    21029
     1053    21030    1   SIGNON_COMMON:
     1054    21031    1         DCTX$ = ADDR(PARM);

  21031   1 000AD5  ECC7 0004            SIGNON_COMMON   LDB,B6   @PARM,AUTO
          1 000AD7  EFC7 0008                            STB,B6   DCTX$,AUTO

     1055    21032    1         IF DVCTX.MGR_TYPE = %KZ_S_DMCONSOLE# THEN

  21032   1 000AD9  E2C6 0022                            LLH,R6   34,B6
          1 000ADB  6D03                                 CMV,R6   3
          1 000ADC  0981 0004                            BNE      s:21034,PREL

     1056    21033    1            DCTX$ = DVCTX.LNK$;

  21033   1 000ADE  DC86                                 LDB,B5   ,B6
          1 000ADF  DFC7 0008                            STB,B5   DCTX$,AUTO

     1057    21034    1         LCTX$ = DVCTX.LIN$;

  21034   1 000AE1  DCC7 0008                            LDB,B5   DCTX$,AUTO
          1 000AE3  CCC5 000D                            LDB,B4   13,B5
          1 000AE5  CFC7 000A                            STB,B4   LCTX$,AUTO

     1058    21035              %DISABLE (DISLVL=LEV,INHLVL=KZ$LINCTX.INHLVL);

  21036   1 000AE7  D844 0035                            LDR,R5   53,B4
          1 000AE9  DF47 001C                            STR,R5   LEV,AUTO

  21037   1 000AEB  BBC7 001C                            LAB,B3   LEV,AUTO
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:168  
          1 000AED  BFC7 0064                            STB,B3   P$+6,AUTO
          1 000AEF  BBC7 0064                            LAB,B3   P$+6,AUTO
          1 000AF1  CBF0 0100                            LAB,B4   256,IMO
          1 000AF3  E380 0000 0000  xent                 LNJ,B6   KHI$DISABLE
          1 000AF6       0001                            DC       s:21039,PREL

     1059    21039    1         SZ = SIZEW(KZ$OTPBFR)+SIZEW(KZ$HASPBLK)+SIZEW(KZ$NJE_SIGNON);

  21039   1 000AF7  6C1F                                 LDV,R6   31
          1 000AF8  EF47 0023                            STR,R6   SZ,AUTO

     1060    21040    1         CALL KVB$GET2NSYS (SZ,SGN$) ALTRET(NOBUF);

  21040   1 000AFA  EBC7 001E                            LAB,B6   SGN$,AUTO
          1 000AFC  EFC7 0066                            STB,B6   P$+8,AUTO
          1 000AFE  DBC7 0023                            LAB,B5   SZ,AUTO
          1 000B00  DFC7 0064                            STB,B5   P$+6,AUTO
          1 000B02  BBC7 0064                            LAB,B3   P$+6,AUTO
          1 000B04  CBF0 0200                            LAB,B4   512,IMO
          1 000B06  E380 0000 0000  xent                 LNJ,B6   KVB$GET2NSYS
          1 000B09       FF43                            DC       s:20955,PREL

     1061    21041    1         SGN$->KZ$OTPBFR = KZ_OTPBFR;

  21041   1 000B0A  AB80 0000 0000  00                   LAB,B2   FPT@WRSYSLOG
          1 000B0D  2C7C                                 LDV,R2   124
          1 000B0E  6C10                                 LDV,R6   16
          1 000B0F  BCC7 001E                            LDB,B3   SGN$,AUTO
          1 000B11  3C00                                 LDV,R3   0
          1 000B12  0008                                 MMM

     1062    21042    1         SGN$->KZ$OTPBFR.BFRSIZ = SZ;

  21042   1 000B13  ECC7 001E                            LDB,B6   SGN$,AUTO
          1 000B15  E847 0023                            LDR,R6   SZ,AUTO
          1 000B17  EF46 0004                            STR,R6   4,B6

PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:169  
     1063    21043    1         SGN$->KZ$OTPBFR.DEV$ = DCTX$;

  21043   1 000B19  ECC7 0008                            LDB,B6   DCTX$,AUTO
          1 000B1B  DCC7 001E                            LDB,B5   SGN$,AUTO
          1 000B1D  EFC5 0006                            STB,B6   6,B5

     1064    21044        /*    SGN_NJE$ = ADDR(PINCRW(SGN$,SIZEW(KZ$OTPBFR))->KZ$HASPBLK.FLG.RCB); */
     1065    21045        /*    SGN_NJE$->KZ$NJE_SIGNON = KZ$LINCTX.PRO.RMTSS$->KZ$NJE_SIGNON; */
     1066    21046    1         SGN_NJE$ = PINCRW(SGN$,SIZEW(KZ$OTPBFR));

  21046   1 000B1F  ECC7 001E                            LDB,B6   SGN$,AUTO
          1 000B21  DBC6 0008                            LAB,B5   8,B6
          1 000B23  DFC7 0020                            STB,B5   SGN_NJE$,AUTO

     1067    21047    1         SGN_NJE$->KZ$NJE_SIGNON = KZ$LINCTX.PRO.RMTSS$->KZ$NJE_SIGNON;

  21047   1 000B25  8CC7 0020                            LDI      SGN_NJE$,AUTO
          1 000B27  B856                                 LDR,R3   R6
          1 000B28  E570 7FFF                            AND,R6   32767,IMO
          1 000B2A  8D47 0064                            SDI      P$+6,AUTO
          1 000B2C  CCC7 0064                            LDB,B4   P$+6,AUTO
          1 000B2E  304F                                 SOR,R3   15
          1 000B2F  BCC7 000A                            LDB,B3   LCTX$,AUTO
          1 000B31  ACC3 0043                            LDB,B2   67,B3
          1 000B33  2C00                                 LDV,R2   0
          1 000B34  6C28                                 LDV,R6   40
          1 000B35  BB84                                 LAB,B3   ,B4
          1 000B36  0008                                 MMM

     1068    21048    2         IF SGNITYPE THEN DO;

  21048   1 000B37  89C7 0022                            CMZ      SGNITYPE,AUTO
          1 000B39  0881 0003                            BAGE     s:21055,PREL

     1069    21049              /* RMTSS$ points to an already-set-up I-type SIGNON */
     1070    21050    2            END;

PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:170  
  21050   1 000B3B  0F81 0026                            B        s:21059,PREL

     1071    21051    2         ELSE DO;

     1072    21052              /* Change RMTSS$'s I-type into a J-type */
     1073    21053        /*       SGN_NJE$->KZ$NJE_SIGNON.NCC.SRCB = 'D1'X; \* EBCDIC 'J' *\ */
     1074    21054        /*       SGN_NJE$->KZ$NJE_SIGNON.NCC.IEVNT = -1; */
     1075    21055    2            SGN_NJE$->KZ$NJE_SIGNON.NCC.SRCB = 'D1'X; /* EBCDIC 'J' */

  21055   1 000B3D  8CC7 0020                            LDI      SGN_NJE$,AUTO
          1 000B3F  B856                                 LDR,R3   R6
          1 000B40  E570 7FFF                            AND,R6   32767,IMO
          1 000B42  8D47 0064                            SDI      P$+6,AUTO
          1 000B44  ECC7 0064                            LDB,B6   P$+6,AUTO
          1 000B46  304F                                 SOR,R3   15
          1 000B47  D870 D100                            LDR,R5   -12032,IMO
          1 000B49  5048                                 SOR,R5   8
          1 000B4A  3E04                                 ADV,R3   4
          1 000B4B  D7B6                                 STH,R5   ,B6,R3

     1076    21056    2            SGN_NJE$->KZ$NJE_SIGNON.NCC.IEVNT = -1;

  21056   1 000B4C  8CC7 0020                            LDI      SGN_NJE$,AUTO
          1 000B4E  B856                                 LDR,R3   R6
          1 000B4F  E570 7FFF                            AND,R6   32767,IMO
          1 000B51  8D47 0064                            SDI      P$+6,AUTO
          1 000B53  ECC7 0064                            LDB,B6   P$+6,AUTO
          1 000B55  304F                                 SOR,R3   15
          1 000B56  8CF0 FFFF FFFF                       LDI      -1,IMO
          1 000B59  8D47 0066                            SDI      P$+8,AUTO
          1 000B5B  ABC7 0064                            LAB,B2   P$+6,AUTO
          1 000B5D  2C04                                 LDV,R2   4
          1 000B5E  6C04                                 LDV,R6   4
          1 000B5F  BB86                                 LAB,B3   ,B6
          1 000B60  3E0F                                 ADV,R3   15
          1 000B61  0008                                 MMM

PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:171  
     1077    21057    2            END;

     1078    21058        /*   SGN$->KZ$OTPBFR.DATA_SIZ = LENGTHC(KZ$NJE_SIGNON.NCC.IDL)+LENGTHC(KZ$HASPBLK.B
             21058        CB)+LENGTHC(KZ$HASPBLK.FCS); */
     1079    21059    1         SGN$->KZ$OTPBFR.DATA_SIZ = SGN_NJE$->KZ$NJE_SIGNON.NCC.IDL;

  21059   1 000B62  8CC7 0020                            LDI      SGN_NJE$,AUTO
          1 000B64  B856                                 LDR,R3   R6
          1 000B65  E570 7FFF                            AND,R6   32767,IMO
          1 000B67  8D47 0064                            SDI      P$+6,AUTO
          1 000B69  ECC7 0064                            LDB,B6   P$+6,AUTO
          1 000B6B  304F                                 SOR,R3   15
          1 000B6C  DCC7 001E                            LDB,B5   SGN$,AUTO
          1 000B6E  3E05                                 ADV,R3   5
          1 000B6F  D2B6                                 LLH,R5   ,B6,R3
          1 000B70  DF45 0003                            STR,R5   3,B5

     1080    21060    1         BFR$ = SGN$;

  21060   1 000B72  DCC7 001E                            LDB,B5   SGN$,AUTO
          1 000B74  DFC7 000C                            STB,B5   BFR$,AUTO

     1081    21061    1         CALL QSGNON_BFR;

  21061   1 000B76  E3C0 0292                            LNJ,B6   s:0,PREL
          1 000B78       0001                            DC       s:21063,PREL

     1082    21062              %ENABLE (DISLVL=LEV,INHLVL=KZ$LINCTX.INHLVL);

  21063   1 000B79  ECC7 000A                            LDB,B6   LCTX$,AUTO
          1 000B7B  E847 001C                            LDR,R6   LEV,AUTO
          1 000B7D  E946 0035                            CMR,R6   53,B6
          1 000B7F  0901 0007                            BE       s:21068,PREL

  21065   1 000B81  CBF0 0000                            LAB,B4   0,IMO
          1 000B83  E380 0000 0000  xent                 LNJ,B6   KHI$ENABLE
          1 000B86       0001                            DC       s:21068,PREL
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:172  

     1083    21068    1         RETURN;

  21068   1 000B87  C380 0000 0000  xent                 LNJ,B4   X6A_ARET

     1084    21069        %EJECT;
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:173  
     1085    21070        /*D*  NAME: KZD$TRNCOTPBLK
     1086    21071              CALL:
     1087    21072                    CALL KZD$TRNCOTPBLK;
     1088    21073              PARAMETER:
     1089    21074                    There is no parameter.  The context is specified by the
     1090    21075                    current VDI block.
     1091    21076              DESCRIPTION:
     1092    21077                    This entry places the current partially filled output block
     1093    21078                    on the output queue.
     1094    21079                                                                           */
     1095    21080
     1096    21081    1   KZD$TRNCOTPBLK: ENTRY ALTRET;

  21081   1 000B8A  D380 0000 0000  xent KZD$TRNCOTPBLK  LNJ,B5   X6A_AUTO_1
          1 000B8D       0068 0001                       DC       104,1

     1097    21082
     1098    21083    1         CALL INITPRM;

  21083   1 000B8F  E3C0 FEEB                            LNJ,B6   s:0,PREL
          1 000B91       0001                            DC       s:21085,PREL

     1099    21084              %DISABLE (DISLVL=LEV,INHLVL=KZ$LINCTX.INHLVL);

  21085   1 000B92  ECC7 000A                            LDB,B6   LCTX$,AUTO
          1 000B94  E846 0035                            LDR,R6   53,B6
          1 000B96  EF47 001C                            STR,R6   LEV,AUTO

  21086   1 000B98  DBC7 001C                            LAB,B5   LEV,AUTO
          1 000B9A  DFC7 0064                            STB,B5   P$+6,AUTO
          1 000B9C  BBC7 0064                            LAB,B3   P$+6,AUTO
          1 000B9E  CBF0 0100                            LAB,B4   256,IMO
          1 000BA0  E380 0000 0000  xent                 LNJ,B6   KHI$DISABLE
          1 000BA3       0001                            DC       s:21088,PREL

     1100    21088    1         IF DVCTX.MGR_TYPE = %KZ_S_DMCONSOLE# THEN

PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:174  
  21088   1 000BA4  ECC7 0008                            LDB,B6   DCTX$,AUTO
          1 000BA6  E2C6 0022                            LLH,R6   34,B6
          1 000BA8  6D03                                 CMV,R6   3
          1 000BA9  0981 0004                            BNE      s:21095,PREL

     1101    21089    1            DCTX$ = DVCTX.LNK$;

  21089   1 000BAB  DC86                                 LDB,B5   ,B6
          1 000BAC  DFC7 0008                            STB,B5   DCTX$,AUTO

     1102    21090              %KV$CMPOTP;
             21095    2           IF KV$PTR.VDI$->KV$VDI.OTPCNDPND THEN DO;

  21095   1 000BAE  EC80 0000 0000  xsym                 LDB,B6   KV$PTR$
          1 000BB1  DC86                                 LDB,B5   ,B6
          1 000BB2  E845 001A                            LDR,R6   26,B5
          1 000BB4  6901 000A                            BEZ,R6   s:21099,PREL

             21096    2              CALL KVV$VDI(KV_VDH_EVT_CMPOTP);

  21096   1 000BB6  BB80 0000 0002  02                   LAB,B3   +2
          1 000BB9  CBF0 0100                            LAB,B4   256,IMO
          1 000BBB  E380 0000 0000  xent                 LNJ,B6   KVV$VDI
          1 000BBE       0001                            DC       s:21099,PREL

             21097    2              END;                         /* END IF                             */

     1103    21099    1         CALL INITPRM;

  21099   1 000BBF  E3C0 FEBB                            LNJ,B6   s:0,PREL
          1 000BC1       0001                            DC       s:21100,PREL

     1104    21100    1         IF DVCTX.MGR_TYPE = %KZ_S_DMCONSOLE# THEN

  21100   1 000BC2  ECC7 0008                            LDB,B6   DCTX$,AUTO
          1 000BC4  E2C6 0022                            LLH,R6   34,B6
          1 000BC6  6D03                                 CMV,R6   3
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:175  
          1 000BC7  0981 0004                            BNE      s:21102,PREL

     1105    21101    1            DCTX$=DVCTX.LNK$;

  21101   1 000BC9  DC86                                 LDB,B5   ,B6
          1 000BCA  DFC7 0008                            STB,B5   DCTX$,AUTO

     1106    21102    1         IF BYTX > SIZEC(KZ$OTPBFR)+SIZEC(KZ$HASPBLK) THEN

  21102   1 000BCC  E847 0010                            LDR,R6   BYTX,AUTO
          1 000BCE  6D16                                 CMV,R6   22
          1 000BCF  0301 F6C0                            BG       s:20327,PREL

     1107    21103    1            GOTO OTPMRK0;
     1108    21104    1         GOTO BADSTATE;               /* Save VDI parameters and return */

  21104   1 000BD1  0F81 FE66                            B        s:20937,PREL

     1109    21105
     1110    21106        %EJECT;
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:176  
     1111    21107
     1112    21108
     1113    21109        /*    Terminate output block.  Move any incomplete record to the
     1114    21110              beginning of the next output block.  ALTRET if unable to get
     1115    21111              the next output block.                                         */
     1116    21112
     1117    21113    1   DONE: PROC ALTRET;

  21113   1 000BD3  EFC7 0060            DONE            STB,B6   P$+2,AUTO

     1118    21114
     1119    21115    2         IF ( ( KZ$LINCTX.PRO.PROTYP = %KLPT_HASP#

  21115   1 000BD5  DCC7 000A                            LDB,B5   LCTX$,AUTO
          1 000BD7  E845 003A                            LDR,R6   58,B5
          1 000BD9  6D03                                 CMV,R6   3
          1 000BDA  0901 0004                            BE       s:21115+10,PREL
          1 000BDC  6D07                                 CMV,R6   7
          1 000BDD  0981 0006                            BNE      s:21115+15,PREL
          1 000BDF  D847 0010                            LDR,R5   BYTX,AUTO
          1 000BE1  5D17                                 CMV,R5   23
          1 000BE2  0381 0006                            BLE      s:21119,PREL
          1 000BE4  D847 0010                            LDR,R5   BYTX,AUTO
          1 000BE6  5D11                                 CMV,R5   17
          1 000BE7  0301 0031                            BG       s:21134,PREL

     1120    21116    2            OR KZ$LINCTX.PRO.PROTYP = %KLPT_NJE# )
     1121    21117    2            AND BYTX <= SIZEC(KZ$OTPBFR)+SIZEC(KZ$HASPBLK)+1 )
     1122    21118    3            OR BYTX <= SIZEC(KZ$OTPBFR)+1 THEN DO;

     1123    21119    4            IF KZ$OTPBFR.MRKCNT > 0 THEN DO;

  21119   1 000BE9  CCC7 000C                            LDB,B4   BFR$,AUTO
          1 000BEB  82C4 0005                            LB,'00FF'X        5,B4
          1 000BED       00FF
          1 000BEE  0581 0021                            BBF      s:21129,PREL

PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:177  
     1124    21120    5               IF DVCTX.OTPHD$ = ADDR(NIL) AND NOT DVCTX.FLAGS.OTPBSY THEN DO;

  21120   1 000BF0  BCC7 0008                            LDB,B3   DCTX$,AUTO
          1 000BF2  8DC3 000F                            CMN      15,B3
          1 000BF4  0981 0013                            BNE      s:21125,PREL
          1 000BF6  82C3 001E                            LB,'0020'X        30,B3
          1 000BF8       0020
          1 000BF9  0501 000E                            BBT      s:21125,PREL

     1125    21121    5                  KZ$OTPBFR.FLAGS.RELOTPBFR = '1'B;

  21121   1 000BFB  8944 0002                            LBT,'0002'X       2,B4
  21121   1 000BFD       0002

     1126    21122    5                  CALL KZR$RELOTPBFR(KZ$OTPBFR);

  21122   1 000BFE  BBC7 000C                            LAB,B3   BFR$,AUTO
          1 000C00  CBF0 0100                            LAB,B4   256,IMO
          1 000C02  E380 0000 0000  xent                 LNJ,B6   KZR$RELOTPBFR
          1 000C05       0001                            DC       s:21123,PREL

     1127    21123    5                  END;

  21123   1 000C06  0F81 0004                            B        s:21126,PREL

     1128    21124    4               ELSE
     1129    21125    4                  CALL QUEUE_BFR;

  21125   1 000C08  E3C0 0209                            LNJ,B6   s:0,PREL
          1 000C0A       0001                            DC       s:21126,PREL

     1130    21126    4               CALL GET_BFR ALTRET(NOBUF);

  21126   1 000C0B  E3C0 0117                            LNJ,B6   s:0,PREL
          1 000C0D       0112                            DC       s:21236,PREL

     1131    21127    4               END;
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:178  

  21127   1 000C0E  0F81 0108                            B        s:21229,PREL

     1132    21128    4            ELSE DO;

     1133    21129    4               SZ = KZ$OTPBFR.BFRSIZ;

  21129   1 000C10  C844 0004                            LDR,R4   4,B4
          1 000C12  CF47 0023                            STR,R4   SZ,AUTO

     1134    21130    4               CALL INIT_BFR;

  21130   1 000C14  E3C0 012B                            LNJ,B6   s:0,PREL
          1 000C16       0001                            DC       s:21133,PREL

     1135    21131    4               END;

     1136    21132
     1137    21133    3            END;

  21133   1 000C17  0F81 00FF                            B        s:21229,PREL

     1138    21134    3         ELSE DO;

     1139    21135
     1140    21136    3   DONE1:
     1141    21137    3            SZ = SIZEW(KZ$OTPBFR)+(KZ$LINCTX.PRO.BLKBYTES+1)/2+2*SIZEW(KV$OTPMRK);

  21137   1 000C19  ECC7 000A            DONE1           LDB,B6   LCTX$,AUTO
          1 000C1B  E846 003C                            LDR,R6   60,B6
          1 000C1D  6E01                                 ADV,R6   1
          1 000C1E  6041                                 SOR,R6   1
          1 000C1F  6E0E                                 ADV,R6   14
          1 000C20  EF47 0023                            STR,R6   SZ,AUTO

     1142    21138    3            CALL KVB$GET2NSYS (SZ,TBFR$) ALTRET(NOBUF);

PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:179  
  21138   1 000C22  DBC7 000E                            LAB,B5   TBFR$,AUTO
          1 000C24  DFC7 0066                            STB,B5   P$+8,AUTO
          1 000C26  CBC7 0023                            LAB,B4   SZ,AUTO
          1 000C28  CFC7 0064                            STB,B4   P$+6,AUTO
          1 000C2A  BBC7 0064                            LAB,B3   P$+6,AUTO
          1 000C2C  CBF0 0200                            LAB,B4   512,IMO
          1 000C2E  E380 0000 0000  xent                 LNJ,B6   KVB$GET2NSYS
          1 000C31       00EE                            DC       s:21236,PREL

     1143    21139    3            TBFR$->KZ$OTPBFR.BFRSIZ = SZ;

  21139   1 000C32  ECC7 000E                            LDB,B6   TBFR$,AUTO
          1 000C34  E847 0023                            LDR,R6   SZ,AUTO
          1 000C36  EF46 0004                            STR,R6   4,B6

     1144    21140    3            J = BYTX - DVCTX.LASTRCBX;

  21140   1 000C38  ECC7 0008                            LDB,B6   DCTX$,AUTO
          1 000C3A  E847 0010                            LDR,R6   BYTX,AUTO
          1 000C3C  E246 0021                            SUB,R6   33,B6
          1 000C3E  EF47 0012                            STR,R6   J,AUTO

     1145    21141    3            IF KZ$LINCTX.PRO.PROTYP = %KLPT_HASP#

  21141   1 000C40  DCC7 000A                            LDB,B5   LCTX$,AUTO
          1 000C42  D845 003A                            LDR,R5   58,B5
          1 000C44  5D03                                 CMV,R5   3
          1 000C45  0901 0004                            BE       s:21143,PREL
          1 000C47  5D07                                 CMV,R5   7
          1 000C48  0981 000D                            BNE      s:21150,PREL

     1146    21142    3               OR KZ$LINCTX.PRO.PROTYP = %KLPT_NJE# THEN
     1147    21143    4               IF J > 3 THEN DO;

  21143   1 000C4A  6D03                                 CMV,R6   3
          1 000C4B  0A81 0006                            BALE     s:21148,PREL

PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:180  
     1148    21144    4                  L=SIZEC(KZ$OTPBFR)+SIZEC(KZ$HASPBLK)-3;

  21144   1 000C4D  4C13                                 LDV,R4   19
          1 000C4E  CF47 0019                            STR,R4   L,AUTO

     1149    21145    4                  GOTO DONE2;

  21145   1 000C50  0F81 0019                            B        s:21158,PREL

     1150    21146    4                  END;
     1151    21147    3               ELSE
     1152    21148    3                  J=0;

  21148   1 000C52  8747 0012                            CL       J,AUTO
          1 000C54  0F81 0022                            B        s:21167,PREL

     1153    21149    4            ELSE DO;

     1154    21150    4               L=SIZEC(KZ$OTPBFR);

  21150   1 000C56  4C10                                 LDV,R4   16
          1 000C57  CF47 0019                            STR,R4   L,AUTO

     1155    21151    4               IF (DVCTX.ACCESS_METHOD = %KZ_S_ACSPRINT# AND

  21151   1 000C59  B846 0022                            LDR,R3   34,B6
          1 000C5B  B570 00FF                            AND,R3   255,IMO
          1 000C5D  3D01                                 CMV,R3   1
          1 000C5E  0981 0004                            BNE      s:21151+10,PREL
          1 000C60  6D02                                 CMV,R6   2
          1 000C61  0A01 0008                            BAG      s:21158,PREL
          1 000C63  82C6 0022                            LB,'00FF'X        34,B6
          1 000C65       00FF
          1 000C66  0501 000E                            BBT      s:21165,PREL
          1 000C68  6A81 000C                            BLEZ,R6  s:21165,PREL

     1156    21152    4                  J > 2) OR
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:181  
     1157    21153    4                  (DVCTX.ACCESS_METHOD = %KZ_S_ACSCARD# AND
     1158    21154    4                  J > 0) THEN
     1159    21155
     1160    21156                       /* Transfer from current buffer to new buffer   */
     1161    21157
     1162    21158    4   DONE2:         CALL INSERT(TBFR$->CHR1,

  21158   1 000C6A  B846 0021            DONE2           LDR,R3   33,B6
          1 000C6C  ACC7 000C                            LDB,B2   BFR$,AUTO
          1 000C6E  A853                                 LDR,R2   R3
          1 000C6F  BCC7 000E                            LDB,B3   TBFR$,AUTO
          1 000C71  B854                                 LDR,R3   R4
          1 000C72  0008                                 MMM
          1 000C73  0F81 0003                            B        s:21167,PREL

     1163    21159    4                     L,
     1164    21160    4                     J,
     1165    21161    4                     SUBSTR(BFR$->CHR1,
     1166    21162    4                     DVCTX.LASTRCBX,
     1167    21163    4                     J));
     1168    21164    4               ELSE
     1169    21165    4                  J=0;

  21165   1 000C75  8747 0012                            CL       J,AUTO

     1170    21166    4               END;

     1171    21167    3            BYTX = DVCTX.LASTRCBX;

  21167   1 000C77  ECC7 0008                            LDB,B6   DCTX$,AUTO
          1 000C79  E846 0021                            LDR,R6   33,B6
          1 000C7B  EF47 0010                            STR,R6   BYTX,AUTO

     1172    21168    3            IF KZ$LINCTX.PRO.PROTYP = %KLPT_HASP#

  21168   1 000C7D  DCC7 000A                            LDB,B5   LCTX$,AUTO
          1 000C7F  D845 003A                            LDR,R5   58,B5
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:182  
          1 000C81  5D03                                 CMV,R5   3
          1 000C82  0901 0004                            BE       s:21170,PREL
          1 000C84  5D07                                 CMV,R5   7
          1 000C85  0981 0007                            BNE      s:21172,PREL

     1173    21169    3               OR KZ$LINCTX.PRO.PROTYP = %KLPT_NJE# THEN
     1174    21170    3               KZ$HASPRCB(BYTX) = '0'B; /* End of block RCB */

  21170   1 000C87  CCC7 000C                            LDB,B4   BFR$,AUTO
          1 000C89  B856                                 LDR,R3   R6
          1 000C8A  87B4                                 CLH      ,B4,R3
          1 000C8B  0F81 000B                            B        s:21177,PREL

     1175    21171    3            ELSE
     1176    21172    3               IF KZ$LINCTX.PRO.PROTYP = %KLPT_2780# THEN

  21172   1 000C8D  5D01                                 CMV,R5   1
          1 000C8E  0981 0006                            BNE      s:21175,PREL

     1177    21173    3                  BYTX=BYTX-2;        /* Remove last .1F for MLCP */

  21173   1 000C90  6EFE                                 ADV,R6   -2
          1 000C91  EF47 0010                            STR,R6   BYTX,AUTO
          1 000C93  0F81 0003                            B        s:21177,PREL

     1178    21174    3               ELSE
     1179    21175    3                  BYTX=BYTX-1;

  21175   1 000C95  88C7 0010                            DEC      BYTX,AUTO

     1180    21176
     1181    21177    3            KZ$OTPBFR.DATA_SIZ=BYTX-SIZEC(KZ$OTPBFR)+1;

  21177   1 000C97  ECC7 000C                            LDB,B6   BFR$,AUTO
          1 000C99  E847 0010                            LDR,R6   BYTX,AUTO
          1 000C9B  6EF1                                 ADV,R6   -15
          1 000C9C  EF46 0003                            STR,R6   3,B6
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:183  

     1182    21178    3            KZ$OTPBFR.FLAGS.CNT# = '1'B;

  21178   1 000C9E  ECC7 000C                            LDB,B6   BFR$,AUTO
          1 000CA0  8946 0002                            LBT,'0020'X       2,B6
          1 000CA2       0020

     1183    21179    4            IF KZ$OTPBFR.DATA_SIZ > 0 THEN DO;

  21179   1 000CA3  ECC7 000C                            LDB,B6   BFR$,AUTO
          1 000CA5  D846 0003                            LDR,R5   3,B6
          1 000CA7  5901 000C                            BEZ,R5   s:21187,PREL

     1184    21180    4               DVCTX.FLAGS.FIRST ='0'B;  /*Shipping first block       */

  21180   1 000CA9  CCC7 0008                            LDB,B4   DCTX$,AUTO
          1 000CAB  8844 001E                            LBF,'0040'X       30,B4
          1 000CAD       0040

     1185    21181
     1186    21182                    /* Throttle on block size to avoid eating up memory with
     1187    21183                       devices that have only one short record per block.   */
     1188    21184
     1189    21185    4               DVCTX.OTPBYTES = DVCTX.OTPBYTES + KZ$LINCTX.PRO.BLKBYTES;

  21185   1 000CAE  D844 0017                            LDR,R5   23,B4
          1 000CB0  DA45 003C                            ADD,R5   60,B5
          1 000CB2  DF44 0017                            STR,R5   23,B4

     1190    21186    4               END;

     1191    21187    3            IF DVCTX.OTPBYTES >= KZ$LINCTX.CHN$->KH$CHN.BLOCK AND

  21187   1 000CB4  CCC5 0002                            LDB,B4   2,B5
          1 000CB6  BCC7 0008                            LDB,B3   DCTX$,AUTO
          1 000CB8  D843 0017                            LDR,R5   23,B3
          1 000CBA  D944 0010                            CMR,R5   16,B4
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:184  
          1 000CBC  0201 0024                            BL       s:21211,PREL
          1 000CBE  82C3 001E                            LB,'0010'X        30,B3
          1 000CC0       0010
          1 000CC1  0501 001F                            BBT      s:21211,PREL

     1192    21188    4               NOT DVCTX.FLAGS.THROTL THEN DO;

     1193    21189    4               DVCTX.FLAGS.THROTL = '1'B;

  21189   1 000CC3  8943 001E                            LBT,'0010'X       30,B3
  21189   1 000CC5       0010

     1194    21190                       %KV$RQSOTP(RQSOTP = NO);   /* Stop output */
             21196    5           IF KV$PTR.VDI$->KV$VDI.RQSOTP THEN DO;

  21196   1 000CC6  CC80 0000 0000  xsym                 LDB,B4   KV$PTR$
          1 000CC9  AC84                                 LDB,B2   ,B4
          1 000CCA  82C2 0019                            LB,'0008'X        25,B2
          1 000CCC       0008
          1 000CCD  0581 0013                            BBF      s:21211,PREL

             21197    5              KV$PTR.VDI$->KV$VDI.RQSOTP = '0'B;

  21197   1 000CCF  8842 0019                            LBF,'0008'X       25,B2
  21197   1 000CD1       0008

             21198    5              IF KV$PTR.VDI$->KV$VDI.SSNCNT>1

  21198   1 000CD2  AC84                                 LDB,B2   ,B4
          1 000CD3  D842 000E                            LDR,R5   14,B2
          1 000CD5  5D01                                 CMV,R5   1
          1 000CD6  0381 000A                            BLE      s:21211,PREL

             21199    5              THEN CALL KVV$VDI (KV_VDH_EVT_RQSOTP);

  21199   1 000CD8  BB80 0000 0004  02                   LAB,B3   +4
          1 000CDB  CBF0 0100                            LAB,B4   256,IMO
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:185  
          1 000CDD  E380 0000 0000  xent                 LNJ,B6   KVV$VDI
          1 000CE0       0001                            DC       s:21211,PREL

             21200    5              END;

     1195    21208
     1196    21209    4               END;

     1197    21210
     1198    21211    3            CALL QUEUE_BFR;

  21211   1 000CE1  E3C0 0130                            LNJ,B6   s:0,PREL
          1 000CE3       0001                            DC       s:21213,PREL

     1199    21212
     1200    21213    3            BFR$ = TBFR$;

  21213   1 000CE4  ECC7 000E                            LDB,B6   TBFR$,AUTO
          1 000CE6  EFC7 000C                            STB,B6   BFR$,AUTO

     1201    21214    3            SZ = KZ$OTPBFR.BFRSIZ;

  21214   1 000CE8  E846 0004                            LDR,R6   4,B6
          1 000CEA  EF47 0023                            STR,R6   SZ,AUTO

     1202    21215    3            CALL INIT_BFR;

  21215   1 000CEC  E3C0 0053                            LNJ,B6   s:0,PREL
          1 000CEE       0001                            DC       s:21216,PREL

     1203    21216    4            IF J ~= 0 THEN DO;

  21216   1 000CEF  E847 0012                            LDR,R6   J,AUTO
          1 000CF1  6901 0025                            BEZ,R6   s:21229,PREL

     1204    21217    4               BYTX = DVCTX.LASTRCBX+J;

PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:186  
  21217   1 000CF3  ECC7 0008                            LDB,B6   DCTX$,AUTO
          1 000CF5  EA46 0021                            ADD,R6   33,B6
          1 000CF7  EF47 0010                            STR,R6   BYTX,AUTO

     1205    21218    4               DVCTX.LASTSCBX = BYTX -1;

  21218   1 000CF9  6EFF                                 ADV,R6   -1
          1 000CFA  EF46 0020                            STR,R6   32,B6

     1206    21219    4               CALL CMPBYTSIZ;

  21219   1 000CFC  E3C0 0145                            LNJ,B6   s:0,PREL
          1 000CFE       0001                            DC       s:21220,PREL

     1207    21220    4               IF ( KZ$LINCTX.PRO.PROTYP = %KLPT_HASP#

  21220   1 000CFF  ECC7 000A                            LDB,B6   LCTX$,AUTO
          1 000D01  E846 003A                            LDR,R6   58,B6
          1 000D03  6D03                                 CMV,R6   3
          1 000D04  0901 0004                            BE       s:21220+10,PREL
          1 000D06  6D07                                 CMV,R6   7
          1 000D07  0981 000B                            BNE      s:21225,PREL
          1 000D09  D847 0012                            LDR,R5   J,AUTO
          1 000D0B  5D3F                                 CMV,R5   63
          1 000D0C  0A81 0006                            BALE     s:21225,PREL

     1208    21221    4                  OR KZ$LINCTX.PRO.PROTYP = %KLPT_NJE# )
     1209    21222    4                  AND J > 63 THEN
     1210    21223    4                  BYTSIZ=63;

  21223   1 000D0E  4C3F                                 LDV,R4   63
          1 000D0F  CF47 0011                            STR,R4   BYTSIZ,AUTO
          1 000D11  0F81 0005                            B        s:21229,PREL

     1211    21224    4               ELSE
     1212    21225    4                  BYTSIZ=J;

PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:187  
  21225   1 000D13  D847 0012                            LDR,R5   J,AUTO
          1 000D15  DF47 0011                            STR,R5   BYTSIZ,AUTO

     1213    21226    4               END;

     1214    21227
     1215    21228    3            END;

     1216    21229    2         RETURN;

  21229   1 000D17  ECC7 0060                            LDB,B6   P$+2,AUTO
          1 000D19  C3C6 0001                            LNJ,B4   1,B6

     1217    21230
     1218    21231        /*    Send off block ending in EOF record.                        */
     1219    21232
     1220    21233    2   DONE_EOF: ENTRY ALTRET;

  21233   1 000D1B  EFC7 0060            DONE_EOF        STB,B6   P$+2,AUTO

     1221    21234    2         GOTO DONE1;

  21234   1 000D1D  0F81 FEFB                            B        s:21134,PREL

     1222    21235
     1223    21236    2   NOBUF: ALTRETURN;

  21236   1 000D1F  ECC7 0060            NOBUF           LDB,B6   P$+2,AUTO
          1 000D21  B806                                 LDR,R3   ,B6
          1 000D22  C3B6                                 LNJ,B4   ,B6,R3

     1224    21237    2   END;
     1225    21238        %EJECT;
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:188  
     1226    21239        /*    Get an output buffer.  ALTRET if none available.            */
     1227    21240
     1228    21241    1   GET_BFR: PROC ALTRET;

  21241   1 000D23  EFC7 0062            GET_BFR         STB,B6   P$+4,AUTO

     1229    21242
     1230    21243    2         SZ = SIZEW(KZ$OTPBFR)+(KZ$LINCTX.PRO.BLKBYTES+1)/2+2*SIZEW(KV$OTPMRK);

  21243   1 000D25  DCC7 000A                            LDB,B5   LCTX$,AUTO
          1 000D27  E845 003C                            LDR,R6   60,B5
          1 000D29  6E01                                 ADV,R6   1
          1 000D2A  6041                                 SOR,R6   1
          1 000D2B  6E0E                                 ADV,R6   14
          1 000D2C  EF47 0023                            STR,R6   SZ,AUTO

     1231    21244    2         CALL KVB$GET2NSYS (SZ,BFR$) ALTRET(NOBUF);

  21244   1 000D2E  CBC7 000C                            LAB,B4   BFR$,AUTO
          1 000D30  CFC7 0066                            STB,B4   P$+8,AUTO
          1 000D32  BBC7 0023                            LAB,B3   SZ,AUTO
          1 000D34  BFC7 0064                            STB,B3   P$+6,AUTO
          1 000D36  BBC7 0064                            LAB,B3   P$+6,AUTO
          1 000D38  CBF0 0200                            LAB,B4   512,IMO
          1 000D3A  E380 0000 0000  xent                 LNJ,B6   KVB$GET2NSYS
          1 000D3D       00BE                            DC       s:21304,PREL
          1 000D3E  0F81 0003                            B        s:21248,PREL

     1232    21245
     1233    21246    2   INIT_BFR: ENTRY ALTRET;

  21246   1 000D40  EFC7 0062            INIT_BFR        STB,B6   P$+4,AUTO

     1234    21247
     1235    21248    2         KZ$OTPBFR = KZ_OTPBFR;

  21248   1 000D42  AB80 0000 0000  00                   LAB,B2   FPT@WRSYSLOG
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:189  
          1 000D45  2C7C                                 LDV,R2   124
          1 000D46  6C10                                 LDV,R6   16
          1 000D47  BCC7 000C                            LDB,B3   BFR$,AUTO
          1 000D49  3C00                                 LDV,R3   0
          1 000D4A  0008                                 MMM

     1236    21249    2         KZ$OTPBFR.BFRSIZ = SZ;

  21249   1 000D4B  ECC7 000C                            LDB,B6   BFR$,AUTO
          1 000D4D  E847 0023                            LDR,R6   SZ,AUTO
          1 000D4F  EF46 0004                            STR,R6   4,B6

     1237    21250    2         KZ$OTPBFR.DEV$ = DCTX$;

  21250   1 000D51  ECC7 0008                            LDB,B6   DCTX$,AUTO
          1 000D53  DCC7 000C                            LDB,B5   BFR$,AUTO
          1 000D55  EFC5 0006                            STB,B6   6,B5

     1238    21251    2         DVCTX.BLKRECS=KZ$LINCTX.PRO.BLKRECS;

  21251   1 000D57  ECC7 0008                            LDB,B6   DCTX$,AUTO
          1 000D59  DCC7 000A                            LDB,B5   LCTX$,AUTO
          1 000D5B  E845 003B                            LDR,R6   59,B5
          1 000D5D  EF46 001D                            STR,R6   29,B6

     1239    21252    2         IF KZ$LINCTX.PRO.PROTYP = %KLPT_HASP#

  21252   1 000D5F  D845 003A                            LDR,R5   58,B5
          1 000D61  5D03                                 CMV,R5   3
          1 000D62  0901 0004                            BE       s:21254,PREL
          1 000D64  5D07                                 CMV,R5   7
          1 000D65  0981 0011                            BNE      s:21260,PREL

     1240    21253    3            OR KZ$LINCTX.PRO.PROTYP = %KLPT_NJE# THEN DO;

     1241    21254    3            BYTX = SIZEC(KZ$OTPBFR)+SIZEC(KZ$HASPBLK);

PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:190  
  21254   1 000D67  4C16                                 LDV,R4   22
          1 000D68  CF47 0010                            STR,R4   BYTX,AUTO

     1242    21255    3            BYTSIZ = 63;

  21255   1 000D6A  3C3F                                 LDV,R3   63
          1 000D6B  BF47 0011                            STR,R3   BYTSIZ,AUTO

     1243    21256    3            DVCTX.LASTSCBX=BYTX-1;

  21256   1 000D6D  4EFF                                 ADV,R4   -1
          1 000D6E  CF46 0020                            STR,R4   32,B6

     1244    21257    3            DVCTX.LASTRCBX=BYTX-3;

  21257   1 000D70  D847 0010                            LDR,R5   BYTX,AUTO
          1 000D72  5EFD                                 ADV,R5   -3
          1 000D73  DF46 0021                            STR,R5   33,B6

     1245    21258    3            END;

  21258   1 000D75  0F81 0081                            B        s:21303,PREL

     1246    21259    3         ELSE DO;

     1247    21260    3            DVCTX.LASTRCBX=SIZEC(KZ$OTPBFR);

  21260   1 000D77  4C10                                 LDV,R4   16
          1 000D78  CF46 0021                            STR,R4   33,B6

     1248    21261    3            IF KZ$LINCTX.PRO.SLAVE THEN

  21261   1 000D7A  89C5 004B                            CMZ      75,B5
          1 000D7C  0881 0005                            BAGE     s:21264,PREL

     1249    21262    3               BYTX = DVCTX.LASTRCBX;

PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:191  
  21262   1 000D7E  CF47 0010                            STR,R4   BYTX,AUTO
          1 000D80  0F81 0060                            B        s:21296,PREL

     1250    21263    4            ELSE DO;

     1251    21264    4               IF KZ$LINCTX.PRO.SLC AND

  21264   1 000D82  82C5 004B                            LB,'0020'X        75,B5
  21264   1 000D84       0020
          1 000D85  0581 004B                            BBF      s:21281,PREL
          1 000D87  82C6 001E                            LB,'0040'X        30,B6
          1 000D89       0040
          1 000D8A  0501 0006                            BBT      s:21266,PREL
          1 000D8C  82C5 004B                            LB,'0010'X        75,B5
          1 000D8E       0010
          1 000D8F  0581 0041                            BBF      s:21281,PREL

     1252    21265    5                  (DVCTX.FLAGS.FIRST OR KZ$LINCTX.PRO.SLCALLBLK) THEN DO;

     1253    21266    6                  IF KZ$LINCTX.PRO.PROTYP = %KLPT_3780# THEN DO;

  21266   1 000D91  D845 003A                            LDR,R5   58,B5
          1 000D93  5D02                                 CMV,R5   2
          1 000D94  0981 0021                            BNE      s:21274,PREL

     1254    21267    6                     IF DVCTX.ACCESS_METHOD = %KZ_S_ACSCARD# THEN

  21267   1 000D96  82C6 0022                            LB,'00FF'X        34,B6
  21267   1 000D98       00FF
          1 000D99  0501 000C                            BBT      s:21270,PREL

     1255    21268    6                        BYT(SIZEC(KZ$OTPBFR)) = KZ_SLCCHR3780PNC1 /* Default '12'X */;

  21268   1 000D9B  B280 0000 0053  00                   LLH,R3   KZ_SLCCHR3780PNC1
          1 000D9E  3008                                 SOL,R3   8
          1 000D9F  3048                                 SOR,R3   8
          1 000DA0  CCC7 000C                            LDB,B4   BFR$,AUTO
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:192  
          1 000DA2  B7C4 0008                            STH,R3   8,B4
          1 000DA4  0F81 000A                            B        s:21271,PREL

     1256    21269    6                     ELSE
     1257    21270    6                        BYT(SIZEC(KZ$OTPBFR)) = KZ_SLCCHR3780PRN /* Default '11'X */;

  21270   1 000DA6  B280 0000 0055  00                   LLH,R3   KZ_SLCCHR3780PRN
          1 000DA9  3008                                 SOL,R3   8
          1 000DAA  3048                                 SOR,R3   8
          1 000DAB  CCC7 000C                            LDB,B4   BFR$,AUTO
          1 000DAD  B7C4 0008                            STH,R3   8,B4

     1258    21271    6                     DVCTX.LASTRCBX = SIZEC(KZ$OTPBFR)+1;

  21271   1 000DAF  ECC7 0008                            LDB,B6   DCTX$,AUTO
          1 000DB1  6C11                                 LDV,R6   17
          1 000DB2  EF46 0021                            STR,R6   33,B6

     1259    21272    6                     END;

  21272   1 000DB4  0F81 001C                            B        s:21281,PREL

     1260    21273    6                  ELSE DO;

     1261    21274    7                     IF DVCTX.ACCESS_METHOD = %KZ_S_ACSCARD# THEN DO;

  21274   1 000DB6  82C6 0022                            LB,'00FF'X        34,B6
  21274   1 000DB8       00FF
          1 000DB9  0501 0017                            BBT      s:21281,PREL

     1262    21275    7                        BYT(SIZEC(KZ$OTPBFR)) = '27'X;

  21275   1 000DBB  B870 2700                            LDR,R3   9984,IMO
          1 000DBD  3048                                 SOR,R3   8
          1 000DBE  CCC7 000C                            LDB,B4   BFR$,AUTO
          1 000DC0  B7C4 0008                            STH,R3   8,B4

PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:193  
     1263    21276    7                       BYT(SIZEC(KZ$OTPBFR)+1) = KZ_SLCCHR2780PNC /* Default 'F4'X */;

  21276   1 000DC2  E280 0000 0052  00                   LLH,R6   KZ_SLCCHR2780PNC
          1 000DC5  6008                                 SOL,R6   8
          1 000DC6  6048                                 SOR,R6   8
          1 000DC7  ECC7 000C                            LDB,B6   BFR$,AUTO
          1 000DC9  EAC6 0008                            SRM,R6,'00FF'X    8,B6
          1 000DCB       00FF

     1264    21277    7                        DVCTX.LASTRCBX = SIZEC(KZ$OTPBFR)+2;

  21277   1 000DCC  ECC7 0008                            LDB,B6   DCTX$,AUTO
          1 000DCE  6C12                                 LDV,R6   18
          1 000DCF  EF46 0021                            STR,R6   33,B6

     1265    21278    7                        END;

     1266    21279    6                     END;

     1267    21280    5                  END;

     1268    21281    4               IF DVCTX.ACCESS_METHOD = %KZ_S_ACSCARD# THEN

  21281   1 000DD1  82C6 0022                            LB,'00FF'X        34,B6
  21281   1 000DD3       00FF
          1 000DD4  0501 0007                            BBT      s:21284,PREL

     1269    21282    4                  BYTX = DVCTX.LASTRCBX;

  21282   1 000DD6  E846 0021                            LDR,R6   33,B6
          1 000DD8  EF47 0010                            STR,R6   BYTX,AUTO
          1 000DDA  0F81 0006                            B        s:21296,PREL

     1270    21283    4               ELSE
     1271    21284    4                  BYTX = DVCTX.LASTRCBX+2;

  21284   1 000DDC  E846 0021                            LDR,R6   33,B6
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:194  
          1 000DDE  6E02                                 ADV,R6   2
          1 000DDF  EF47 0010                            STR,R6   BYTX,AUTO

     1272    21285    4               END;

     1273    21286                 /*  To calculate the number of bytes available in the
     1274    21287                     current output block being built, the total number
     1275    21288                     of bytes in the block is decremented by BYTX (the
     1276    21289                     index of the byte into which the next output character
     1277    21290                     would go, if room were available) minus the size of
     1278    21291                     the KZ$OTPBFR structure (since BYTX includes this size,
     1279    21292                     i.e., BYTX is initially set to SIZEC(KZ$OTPBFR)).
     1280    21293                     Since HASP blocks will also be sent with DLE-STX as
     1281    21294                     their first two bytes (added by the MLCP), an additional
     1282    21295                     2 bytes is subtracted for HASP/NJE.  */
     1283    21296    3            BYTSIZ = KZ$LINCTX.PRO.BLKBYTES-(BYTX-SIZEC(KZ$OTPBFR));

  21296   1 000DE1  E845 003C                            LDR,R6   60,B5
          1 000DE3  E247 0010                            SUB,R6   BYTX,AUTO
          1 000DE5  6E10                                 ADV,R6   16
          1 000DE6  EF47 0011                            STR,R6   BYTSIZ,AUTO

     1284    21297    3            IF KZ$LINCTX.PRO.PROTYP = %KLPT_HASP#

  21297   1 000DE8  D845 003A                            LDR,R5   58,B5
          1 000DEA  5D03                                 CMV,R5   3
          1 000DEB  0901 0004                            BE       s:21299,PREL
          1 000DED  5D07                                 CMV,R5   7
          1 000DEE  0981 0004                            BNE      s:21300,PREL

     1285    21298    3               OR KZ$LINCTX.PRO.PROTYP = %KLPT_NJE# THEN
     1286    21299    3               BYTSIZ = BYTSIZ - 3;

  21299   1 000DF0  6EFD                                 ADV,R6   -3
          1 000DF1  EF47 0011                            STR,R6   BYTSIZ,AUTO

     1287    21300    3            IF BYTSIZ < 0 THEN
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:195  

  21300   1 000DF3  6881 0003                            BGEZ,R6  s:21303,PREL

     1288    21301    3               BYTSIZ = 0;

  21301   1 000DF5  8747 0011                            CL       BYTSIZ,AUTO

     1289    21302    3            END;

     1290    21303    2         RETURN;

  21303   1 000DF7  ECC7 0062                            LDB,B6   P$+4,AUTO
          1 000DF9  C3C6 0001                            LNJ,B4   1,B6

     1291    21304    2   NOBUF: ALTRETURN;

  21304   1 000DFB  ECC7 0062            NOBUF           LDB,B6   P$+4,AUTO
          1 000DFD  B806                                 LDR,R3   ,B6
          1 000DFE  C3B6                                 LNJ,B4   ,B6,R3

     1292    21305    2   END;
     1293    21306
     1294    21307        /*    Add a block to the device output queue.
     1295    21308                 Set device PTS_OUT to insure it can be selected for output.
     1296    21309                 Set LAST to cause PTS_OUT to be reset after its selected. */
     1297    21310
     1298    21311
     1299    21312    1   QCNTL_BFR: PROC;

  21312   1 000DFF  EFC7 0062            QCNTL_BFR       STB,B6   P$+4,AUTO

     1300    21313
     1301    21314    2         KZ$OTPBFR.FLAGS.HALT='1'B;

  21314   1 000E01  6C08                                 LDV,R6   8
          1 000E02  DCC7 000C                            LDB,B5   BFR$,AUTO
          1 000E04  EAC5 0002                            SRM,R6,'000C'X    2,B5
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:196  
          1 000E06       000C
          1 000E07  0F81 0003                            B        s:21318,PREL

     1302    21315
     1303    21316    2   QSGNON_BFR: ENTRY;

  21316   1 000E09  EFC7 0062            QSGNON_BFR      STB,B6   P$+4,AUTO

     1304    21317
     1305    21318    2         DVCTX.FLAGS.PTS_OUT='1'B;

  21318   1 000E0B  ECC7 0008                            LDB,B6   DCTX$,AUTO
          1 000E0D  8946 001E                            LBT,'1000'X       30,B6
          1 000E0F       1000
          1 000E10  0F81 0003                            B        s:21321,PREL

     1306    21319    2   QUEUE_BFR: ENTRY;

  21319   1 000E12  EFC7 0062            QUEUE_BFR       STB,B6   P$+4,AUTO

     1307    21320
     1308    21321    2         IF DVCTX.OTPHD$=ADDR(NIL) THEN

  21321   1 000E14  ECC7 0008                            LDB,B6   DCTX$,AUTO
          1 000E16  8DC6 000F                            CMN      15,B6
          1 000E18  0981 0007                            BNE      s:21324,PREL

     1309    21322    2            DVCTX.OTPHD$=BFR$;

  21322   1 000E1A  DCC7 000C                            LDB,B5   BFR$,AUTO
          1 000E1C  DFC6 000F                            STB,B5   15,B6
          1 000E1E  0F81 0006                            B        s:21325,PREL

     1310    21323    2         ELSE
     1311    21324    2            DVCTX.OTPTL$->KZ$OTPBFR.LNK$=BFR$;

  21324   1 000E20  DCC6 0011                            LDB,B5   17,B6
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:197  
          1 000E22  CCC7 000C                            LDB,B4   BFR$,AUTO
          1 000E24  CF85                                 STB,B4   ,B5

     1312    21325    2         DVCTX.OTPTL$ = BFR$;

  21325   1 000E25  ECC7 000C                            LDB,B6   BFR$,AUTO
          1 000E27  DCC7 0008                            LDB,B5   DCTX$,AUTO
          1 000E29  EFC5 0011                            STB,B6   17,B5

     1313    21326    2         KZ$OTPBFR.LNK$=ADDR(NIL);

  21326   1 000E2B  CB80 0000 0000                       LAB,B4   0
          1 000E2E  CF86                                 STB,B4   ,B6

     1314    21327    2         DVCTX.LINE_RECORDS_OUT=DVCTX.LINE_RECORDS_OUT+1;

  21327   1 000E2F  ECC7 0008                            LDB,B6   DCTX$,AUTO
          1 000E31  8AC6 002D                            INC      45,B6
          1 000E33  8EC6 002C                            CAD      44,B6

     1315    21328    2         DVCTX.LINE_BYTES_OUT=DVCTX.LINE_BYTES_OUT+KZ$OTPBFR.DATA_SIZ;

  21328   1 000E35  DCC7 000C                            LDB,B5   BFR$,AUTO
          1 000E37  F845 0003                            LDR,R7   3,B5
          1 000E39  6C00                                 LDV,R6   0
          1 000E3A  8446 0034                            AID      52,B6
          1 000E3C  8D46 0034                            SDI      52,B6

     1316    21329    2         RETURN;

  21329   1 000E3E  ECC7 0062                            LDB,B6   P$+4,AUTO
          1 000E40  C3C6 0001                            LNJ,B4   1,B6

     1317    21330    2   END QCNTL_BFR;
     1318    21331
     1319    21332
     1320    21333        /*    Compute bytes remaining in output block                      */
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:198  
     1321    21334
     1322    21335    1   CMPBYTSIZ: PROC;

  21335   1 000E42  EFC7 0062            CMPBYTSIZ       STB,B6   P$+4,AUTO

     1323    21336
     1324    21337
     1325    21338              /*  See comments in GET_BFR where BYTSIZ is calculated.  */
     1326    21339    2         J = KZ$LINCTX.PRO.BLKBYTES-(BYTX-SIZEC(KZ$OTPBFR))-4;

  21339   1 000E44  DCC7 000A                            LDB,B5   LCTX$,AUTO
          1 000E46  E845 003C                            LDR,R6   60,B5
          1 000E48  E247 0010                            SUB,R6   BYTX,AUTO
          1 000E4A  6E0C                                 ADV,R6   12
          1 000E4B  EF47 0012                            STR,R6   J,AUTO

     1327    21340    2         IF KZ$LINCTX.PRO.PROTYP = %KLPT_HASP#

  21340   1 000E4D  D845 003A                            LDR,R5   58,B5
          1 000E4F  5D03                                 CMV,R5   3
          1 000E50  0901 0004                            BE       s:21342,PREL
          1 000E52  5D07                                 CMV,R5   7
          1 000E53  0981 0004                            BNE      s:21343,PREL

     1328    21341    2            OR KZ$LINCTX.PRO.PROTYP = %KLPT_NJE# THEN
     1329    21342    2            J = J - 3;

  21342   1 000E55  6EFD                                 ADV,R6   -3
          1 000E56  EF47 0012                            STR,R6   J,AUTO

     1330    21343    2         IF J < 0 THEN

  21343   1 000E58  6881 0003                            BGEZ,R6  s:21345,PREL

     1331    21344    2            J = 0;

  21344   1 000E5A  8747 0012                            CL       J,AUTO
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:199  

     1332    21345    2         RETURN;

  21345   1 000E5C  ECC7 0062                            LDB,B6   P$+4,AUTO
          1 000E5E  C3C6 0001                            LNJ,B4   1,B6

     1333    21346    2   END CMPBYTSIZ;
     1334    21347
     1335    21348        /*    Note end of HASP string.  Make zero SCB and set indices.  */
     1336    21349
     1337    21350    1   ENDSTR: PROC;

  21350   1 000E60  EFC7 005A            ENDSTR          STB,B6   KV$VDH_OTPLCL+5,AUTO

     1338    21351
     1339    21352    2         KZ$HASPRCB(DVCTX.LASTRCBX) = DVCTX.RCB_CODE;

  21352   1 000E62  DCC7 0008                            LDB,B5   DCTX$,AUTO
          1 000E64  B845 0021                            LDR,R3   33,B5
          1 000E66  E2C5 0024                            LLH,R6   36,B5
          1 000E68  6008                                 SOL,R6   8
          1 000E69  6048                                 SOR,R6   8
          1 000E6A  CCC7 000C                            LDB,B4   BFR$,AUTO
          1 000E6C  E7B4                                 STH,R6   ,B4,R3

     1340    21353    2         DVCTX.HOST_RECORDS_OUT=DVCTX.HOST_RECORDS_OUT+1;

  21353   1 000E6D  ECC7 0008                            LDB,B6   DCTX$,AUTO
          1 000E6F  8AC6 0029                            INC      41,B6
          1 000E71  8EC6 0028                            CAD      40,B6

     1341    21354    2         DVCTX.HOST_BYTES_OUT=DVCTX.HOST_BYTES_OUT+(DVCTX.LASTSCBX-DVCTX.LASTRCBX);

  21354   1 000E73  E846 0020                            LDR,R6   32,B6
          1 000E75  E246 0021                            SUB,R6   33,B6
          1 000E77  70F0                                 DAR,R7   16
          1 000E78  8446 0030                            AID      48,B6
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:200  
          1 000E7A  8D46 0030                            SDI      48,B6

     1342    21355    2         KZ$HASPSCB(DVCTX.LASTSCBX)='0'B;

  21355   1 000E7C  B846 0020                            LDR,R3   32,B6
          1 000E7E  DCC7 000C                            LDB,B5   BFR$,AUTO
          1 000E80  87B5                                 CLH      ,B5,R3

     1343    21356    2         DVCTX.LASTRCBX=DVCTX.LASTSCBX+1;

  21356   1 000E81  ECC7 0008                            LDB,B6   DCTX$,AUTO
          1 000E83  E846 0020                            LDR,R6   32,B6
          1 000E85  6E01                                 ADV,R6   1
          1 000E86  EF46 0021                            STR,R6   33,B6

     1344    21357    2         DVCTX.LASTSCBX=DVCTX.LASTSCBX+3;

  21357   1 000E88  D846 0020                            LDR,R5   32,B6
          1 000E8A  5E03                                 ADV,R5   3
          1 000E8B  DF46 0020                            STR,R5   32,B6

     1345    21358    2         BYTX=DVCTX.LASTSCBX+1;

  21358   1 000E8D  5E01                                 ADV,R5   1
          1 000E8E  DF47 0010                            STR,R5   BYTX,AUTO

     1346    21359    2         RETURN;

  21359   1 000E90  ECC7 005A                            LDB,B6   KV$VDH_OTPLCL+5,AUTO
          1 000E92  C3C6 0001                            LNJ,B4   1,B6

     1347    21360    2   END ENDSTR;
     1348    21361
     1349    21362        /*    Finish current output buffer.                                */
     1350    21363
     1351    21364    1   FINOTPBFR: PROC ALTRET;

PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:201  
  21364   1 000E94  EFC7 005A            FINOTPBFR       STB,B6   KV$VDH_OTPLCL+5,AUTO

     1352    21365
     1353    21366              /* Have VDH complete output, (positioning).  */
     1354    21367
     1355    21368    2         CALL SVPRM;

  21368   1 000E96  E3C0 FC15                            LNJ,B6   s:0,PREL
          1 000E98       0001                            DC       s:21374,PREL

     1356    21369              %KV$CMPOTP;
             21374    3           IF KV$PTR.VDI$->KV$VDI.OTPCNDPND THEN DO;

  21374   1 000E99  EC80 0000 0000  xsym                 LDB,B6   KV$PTR$
          1 000E9C  DC86                                 LDB,B5   ,B6
          1 000E9D  E845 001A                            LDR,R6   26,B5
          1 000E9F  6901 000A                            BEZ,R6   s:21378,PREL

             21375    3              CALL KVV$VDI(KV_VDH_EVT_CMPOTP);

  21375   1 000EA1  BB80 0000 0002  02                   LAB,B3   +2
          1 000EA4  CBF0 0100                            LAB,B4   256,IMO
          1 000EA6  E380 0000 0000  xent                 LNJ,B6   KVV$VDI
          1 000EA9       0001                            DC       s:21378,PREL

             21376    3              END;                         /* END IF                             */

     1357    21378    2         CALL INITPRM;

  21378   1 000EAA  E3C0 FBD0                            LNJ,B6   s:0,PREL
          1 000EAC       0001                            DC       s:21379,PREL

     1358    21379    2         IF DVCTX.MGR_TYPE = %KZ_S_DMCONSOLE# THEN

  21379   1 000EAD  ECC7 0008                            LDB,B6   DCTX$,AUTO
          1 000EAF  E2C6 0022                            LLH,R6   34,B6
          1 000EB1  6D03                                 CMV,R6   3
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:202  
          1 000EB2  0981 0004                            BNE      s:21380+3,PREL

     1359    21380    2            DCTX$=DVCTX.LNK$;

  21380   1 000EB4  DC86                                 LDB,B5   ,B6
          1 000EB5  DFC7 0008                            STB,B5   DCTX$,AUTO
          1 000EB7  0F81 0003                            B        s:21389,PREL

     1360    21381
     1361    21382        /*
     1362    21383              Finish the output without forcing VDH to complete.  Used to
     1363    21384              make record span blocks if its too large to fit in one block.
     1364    21385        */
     1365    21386
     1366    21387    2   FINOTPBF2: ENTRY ALTRET;

  21387   1 000EB9  EFC7 005A            FINOTPBF2       STB,B6   KV$VDH_OTPLCL+5,AUTO

     1367    21388
     1368    21389    2         %KV_MRD.DVCCLM = 1;

  21389   1 000EBB  EC80 0000 0000  xsym                 LDB,B6   KV$PTR$
          1 000EBE  DCC6 0008                            LDB,B5   8,B6
          1 000EC0  6C01                                 LDV,R6   1
          1 000EC1  EF45 001E                            STR,R6   30,B5

     1369    21390    2         IF KZ$LINCTX.PRO.PROTYP = %KLPT_HASP#

  21390   1 000EC3  DCC7 000A                            LDB,B5   LCTX$,AUTO
          1 000EC5  D845 003A                            LDR,R5   58,B5
          1 000EC7  5D03                                 CMV,R5   3
          1 000EC8  0901 0004                            BE       s:21392,PREL
          1 000ECA  5D07                                 CMV,R5   7
          1 000ECB  0981 0032                            BNE      s:21402,PREL

     1370    21391    3            OR KZ$LINCTX.PRO.PROTYP = %KLPT_NJE# THEN DO;

PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:203  
     1371    21392    3            CALL SET_SCB;

  21392   1 000ECD  E3C0 0167                            LNJ,B6   s:0,PREL
          1 000ECF       0001                            DC       s:21393,PREL

     1372    21393    4            IF BYTX > DVCTX.LASTRCBX+2 THEN DO;

  21393   1 000ED0  ECC7 0008                            LDB,B6   DCTX$,AUTO
          1 000ED2  E846 0021                            LDR,R6   33,B6
          1 000ED4  6E02                                 ADV,R6   2
          1 000ED5  E947 0010                            CMR,R6   BYTX,AUTO
          1 000ED7  0281 009B                            BGE      s:21433,PREL

     1373    21394    4               BYT(BYTX) = '0'B; /* Last SCB   */

  21394   1 000ED9  DCC7 000C                            LDB,B5   BFR$,AUTO
          1 000EDB  B847 0010                            LDR,R3   BYTX,AUTO
          1 000EDD  87B5                                 CLH      ,B5,R3

     1374    21395    4               BYTX = BYTX+1;

  21395   1 000EDE  8AC7 0010                            INC      BYTX,AUTO

     1375    21396    4               KZ$HASPRCB(DVCTX.LASTRCBX)=DVCTX.RCB_CODE;

  21396   1 000EE0  ECC7 0008                            LDB,B6   DCTX$,AUTO
          1 000EE2  B846 0021                            LDR,R3   33,B6
          1 000EE4  E2C6 0024                            LLH,R6   36,B6
          1 000EE6  6008                                 SOL,R6   8
          1 000EE7  6048                                 SOR,R6   8
          1 000EE8  DCC7 000C                            LDB,B5   BFR$,AUTO
          1 000EEA  E7B5                                 STH,R6   ,B5,R3

     1376    21397    4               KZ$HASPSRCB(DVCTX.LASTRCBX+1)='80'X; /* No space */

  21397   1 000EEB  ECC7 0008                            LDB,B6   DCTX$,AUTO
          1 000EED  B846 0021                            LDR,R3   33,B6
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:204  
          1 000EEF  E870 8000                            LDR,R6   -32768,IMO
          1 000EF1  6048                                 SOR,R6   8
          1 000EF2  DCC7 000C                            LDB,B5   BFR$,AUTO
          1 000EF4  3E01                                 ADV,R3   1
          1 000EF5  E7B5                                 STH,R6   ,B5,R3

     1377    21398    4               DVCTX.LASTRCBX = BYTX;

  21398   1 000EF6  ECC7 0008                            LDB,B6   DCTX$,AUTO
          1 000EF8  E847 0010                            LDR,R6   BYTX,AUTO
          1 000EFA  EF46 0021                            STR,R6   33,B6

     1378    21399    4               END;

     1379    21400    3            END;

  21400   1 000EFC  0F81 0076                            B        s:21433,PREL

     1380    21401    3         ELSE DO;

     1381    21402    3            J = BITBIN(KZ$LINCTX.PRO.SLAVE) + KZ$LINCTX.PRO.PROTYP*2;

  21402   1 000EFE  C845 004B                            LDR,R4   75,B5
          1 000F00  404F                                 SOR,R4   15
          1 000F01  5001                                 SOL,R5   1
          1 000F02  DA54                                 ADD,R5   R4
          1 000F03  DF47 0012                            STR,R5   J,AUTO

     1382    21403    4            IF DVCTX.ACCESS_METHOD = %KZ_S_ACSPRINT# THEN DO;

  21403   1 000F05  CCC7 0008                            LDB,B4   DCTX$,AUTO
          1 000F07  B844 0022                            LDR,R3   34,B4
          1 000F09  B570 00FF                            AND,R3   255,IMO
          1 000F0B  3D01                                 CMV,R3   1
          1 000F0C  0981 0023                            BNE      s:21413,PREL

     1383    21404    5               IF BYTX > DVCTX.LASTRCBX+2 THEN DO;
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:205  

  21404   1 000F0E  A844 0021                            LDR,R2   33,B4
          1 000F10  2E02                                 ADV,R2   2
          1 000F11  A947 0010                            CMR,R2   BYTX,AUTO
          1 000F13  0281 0016                            BGE      s:21410,PREL

     1384    21405    5                  BYT(DVCTX.LASTRCBX)='27'X;

  21405   1 000F15  9844 0021                            LDR,R1   33,B4
          1 000F17  E870 2700                            LDR,R6   9984,IMO
          1 000F19  6048                                 SOR,R6   8
          1 000F1A  BCC7 000C                            LDB,B3   BFR$,AUTO
          1 000F1C  E793                                 STH,R6   ,B3,R1

     1385    21406    5                  BYT(DVCTX.LASTRCBX+1)='D4'X;  /* esc M  */

  21406   1 000F1D  ECC7 0008                            LDB,B6   DCTX$,AUTO
          1 000F1F  B846 0021                            LDR,R3   33,B6
          1 000F21  E870 D400                            LDR,R6   -11264,IMO
          1 000F23  6048                                 SOR,R6   8
          1 000F24  CCC7 000C                            LDB,B4   BFR$,AUTO
          1 000F26  3E01                                 ADV,R3   1
          1 000F27  E7B4                                 STH,R6   ,B4,R3

     1386    21407    5                  GOTO FINOTP0;

  21407   1 000F28  0F81 0039                            B        s:21426,PREL

     1387    21408    5                  END;
     1388    21409    4               ELSE;
     1389    21410    4               BYTX=DVCTX.LASTRCBX;

  21410   1 000F2A  9844 0021                            LDR,R1   33,B4
          1 000F2C  9F47 0010                            STR,R1   BYTX,AUTO

     1390    21411    4               END;

PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:206  
  21411   1 000F2E  0F81 0044                            B        s:21433,PREL

     1391    21412    4            ELSE DO;                  /* punch */

     1392    21413    5               IF BYTX = DVCTX.LASTRCBX THEN DO;

  21413   1 000F30  A847 0010                            LDR,R2   BYTX,AUTO
          1 000F32  A944 0021                            CMR,R2   33,B4
          1 000F34  0981 0016                            BNE      s:21421,PREL

     1393    21414    5                  IF DVCTX.FLAGS.FIRST AND

  21414   1 000F36  82C4 001E                            LB,'0040'X        30,B4
  21414   1 000F38       0040
          1 000F39  0581 0039                            BBF      s:21433,PREL
          1 000F3B  9855                                 LDR,R1   R5
          1 000F3C  E810 0000 004A  00                   LDR,R6   ESCSZ,R1
          1 000F3F  6E10                                 ADV,R6   16
          1 000F40  E944 0021                            CMR,R6   33,B4
          1 000F42  0981 0030                            BNE      s:21433,PREL

     1394    21415    6                     DVCTX.LASTRCBX = SIZEC(KZ$OTPBFR)+ESCSZ(J) THEN DO;

     1395    21416    6                     BYTX=SIZEC(KZ$OTPBFR);

  21416   1 000F44  2C10                                 LDV,R2   16
          1 000F45  AF47 0010                            STR,R2   BYTX,AUTO

     1396    21417    6                     DVCTX.LASTRCBX=SIZEC(KZ$OTPBFR);

  21417   1 000F47  AF44 0021                            STR,R2   33,B4

     1397    21418    6                     END;

     1398    21419    5                  END;

  21419   1 000F49  0F81 0029                            B        s:21433,PREL
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:207  

     1399    21420    5               ELSE DO;

     1400    21421    5                  IF KZ$LINCTX.PRO.PROTYP = %KLPT_2780# AND

  21421   1 000F4B  9845 003A                            LDR,R1   58,B5
          1 000F4D  1D01                                 CMV,R1   1
          1 000F4E  0981 0013                            BNE      s:21426,PREL
          1 000F50  E2C5 0042                            LLH,R6   66,B5
          1 000F52  6008                                 SOL,R6   8
          1 000F53  6901 000E                            BEZ,R6   s:21426,PREL
          1 000F55  A244 0021                            SUB,R2   33,B4
          1 000F57  2D50                                 CMV,R2   80
          1 000F58  0881 0009                            BAGE     s:21426,PREL

     1401    21422    5                     (KZ$LINCTX.PRO.EMCHR ~= '0'B) AND
     1402    21423    6                     BYTX - DVCTX.LASTRCBX < 80 THEN DO;

     1403    21424    6                     BYT(BYTX)=KZ$LINCTX.PRO.EMCHR /* Default '19'X */;

  21424   1 000F5A  6048                                 SOR,R6   8
          1 000F5B  BCC7 000C                            LDB,B3   BFR$,AUTO
          1 000F5D  A847 0010                            LDR,R2   BYTX,AUTO
          1 000F5F  E7A3                                 STH,R6   ,B3,R2

     1404    21425    6                     BYTX=BYTX+1;

  21425   1 000F60  8AC7 0010                            INC      BYTX,AUTO

     1405    21426    6                     END;

     1406    21427    5   FINOTP0:       BYT(BYTX)=IRS;

  21427   1 000F62  E2C7 001D            FINOTP0         LLH,R6   IRS,AUTO
          1 000F64  6008                                 SOL,R6   8
          1 000F65  6048                                 SOR,R6   8
          1 000F66  ECC7 000C                            LDB,B6   BFR$,AUTO
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:208  
          1 000F68  B847 0010                            LDR,R3   BYTX,AUTO
          1 000F6A  E7B6                                 STH,R6   ,B6,R3

     1407    21428    5                  BYTX=BYTX+1;

  21428   1 000F6B  8AC7 0010                            INC      BYTX,AUTO

     1408    21429    5                  DVCTX.LASTRCBX=BYTX;

  21429   1 000F6D  ECC7 0008                            LDB,B6   DCTX$,AUTO
          1 000F6F  E847 0010                            LDR,R6   BYTX,AUTO
          1 000F71  EF46 0021                            STR,R6   33,B6

     1409    21430    5                  END;

     1410    21431    4               END;

     1411    21432    3            END;

     1412    21433    2         CALL DONE ALTRET(NOBUF);

  21433   1 000F73  E3C0 FC5F                            LNJ,B6   s:0,PREL
          1 000F75       0005                            DC       s:21435,PREL

     1413    21434    2         RETURN;

  21434   1 000F76  ECC7 005A                            LDB,B6   KV$VDH_OTPLCL+5,AUTO
          1 000F78  C3C6 0001                            LNJ,B4   1,B6

     1414    21435    2   NOBUF: ALTRETURN;

  21435   1 000F7A  ECC7 005A            NOBUF           LDB,B6   KV$VDH_OTPLCL+5,AUTO
          1 000F7C  B806                                 LDR,R3   ,B6
          1 000F7D  C3B6                                 LNJ,B4   ,B6,R3

     1415    21436    2   END;
     1416    21437
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:209  
     1417    21438        /*    Put the appropriate esc-vfc characters into a 2780/3780 record.
     1418    21439              Make it a one blank character record if its empty.           */
     1419    21440
     1420    21441    1   BLDUPSPCREC: PROC ALTRET;

  21441   1 000F7E  EFC7 005C            BLDUPSPCREC     STB,B6   KV$VDH_OTPLCL+7,AUTO

     1421    21442
     1422    21443              /* Select VFC character based on I.                         */
     1423    21444
     1424    21445    2         DVCTX.HOST_RECORDS_OUT=DVCTX.HOST_RECORDS_OUT+1;

  21445   1 000F80  DCC7 0008                            LDB,B5   DCTX$,AUTO
          1 000F82  8AC5 0029                            INC      41,B5
          1 000F84  8EC5 0028                            CAD      40,B5

     1425    21446    2         DVCTX.HOST_BYTES_OUT=DVCTX.HOST_BYTES_OUT+(BYTX-DVCTX.LASTRCBX);

  21446   1 000F86  E847 0010                            LDR,R6   BYTX,AUTO
          1 000F88  E245 0021                            SUB,R6   33,B5
          1 000F8A  70F0                                 DAR,R7   16
          1 000F8B  8445 0030                            AID      48,B5
          1 000F8D  8D45 0030                            SDI      48,B5

     1426    21447    3         IF DVCTX.ACCESS_METHOD = %KZ_S_ACSPRINT# THEN DO;

  21447   1 000F8F  D845 0022                            LDR,R5   34,B5
          1 000F91  D570 00FF                            AND,R5   255,IMO
          1 000F93  5D01                                 CMV,R5   1
          1 000F94  0981 0039                            BNE      s:21457,PREL

     1427    21448    3            BYT(DVCTX.LASTRCBX) = '27'X; /* ESC      */

  21448   1 000F96  B845 0021                            LDR,R3   33,B5
          1 000F98  C870 2700                            LDR,R4   9984,IMO
          1 000F9A  4048                                 SOR,R4   8
          1 000F9B  ECC7 000C                            LDB,B6   BFR$,AUTO
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:210  
          1 000F9D  C7B6                                 STH,R4   ,B6,R3

     1428    21449    3            BYT(DVCTX.LASTRCBX+1) = VFC(I);

  21449   1 000F9E  ECC7 0008                            LDB,B6   DCTX$,AUTO
          1 000FA0  B846 0021                            LDR,R3   33,B6
          1 000FA2  A847 0013                            LDR,R2   I,AUTO
          1 000FA4  E2A0 0000 0046  00                   LLH,R6   VFC,R2
          1 000FA7  6008                                 SOL,R6   8
          1 000FA8  6048                                 SOR,R6   8
          1 000FA9  DCC7 000C                            LDB,B5   BFR$,AUTO
          1 000FAB  3E01                                 ADV,R3   1
          1 000FAC  E7B5                                 STH,R6   ,B5,R3

     1429    21450    3            IF BYTX = DVCTX.LASTRCBX+2 THEN

  21450   1 000FAD  ECC7 0008                            LDB,B6   DCTX$,AUTO
          1 000FAF  E846 0021                            LDR,R6   33,B6
          1 000FB1  6E02                                 ADV,R6   2
          1 000FB2  E947 0010                            CMR,R6   BYTX,AUTO
          1 000FB4  0981 0004                            BNE      s:21452,PREL

     1430    21451    3               CALL BLDBLNKSTR ALTRET(NOBUF);

  21451   1 000FB6  E3C0 00B0                            LNJ,B6   s:0,PREL
          1 000FB8       005B                            DC       s:21473,PREL

     1431    21452    3            BYT(BYTX)=IRS;

  21452   1 000FB9  E2C7 001D                            LLH,R6   IRS,AUTO
          1 000FBB  6008                                 SOL,R6   8
          1 000FBC  6048                                 SOR,R6   8
          1 000FBD  ECC7 000C                            LDB,B6   BFR$,AUTO
          1 000FBF  B847 0010                            LDR,R3   BYTX,AUTO
          1 000FC1  E7B6                                 STH,R6   ,B6,R3

     1432    21453    3            DVCTX.LASTRCBX=BYTX+1;
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:211  

  21453   1 000FC2  ECC7 0008                            LDB,B6   DCTX$,AUTO
          1 000FC4  3E01                                 ADV,R3   1
          1 000FC5  BF46 0021                            STR,R3   33,B6

     1433    21454    3            BYTX=BYTX+3;

  21454   1 000FC7  E847 0010                            LDR,R6   BYTX,AUTO
          1 000FC9  6E03                                 ADV,R6   3
          1 000FCA  EF47 0010                            STR,R6   BYTX,AUTO

     1434    21455    3            END;

  21455   1 000FCC  0F81 0037                            B        s:21469,PREL

     1435    21456    3         ELSE DO;

     1436    21457    3            IF BYTX = DVCTX.LASTRCBX THEN

  21457   1 000FCE  C847 0010                            LDR,R4   BYTX,AUTO
          1 000FD0  C945 0021                            CMR,R4   33,B5
          1 000FD2  0981 0004                            BNE      s:21459,PREL

     1437    21458    3               CALL BLDBLNKSTR ALTRET(NOBUF);

  21458   1 000FD4  E3C0 0092                            LNJ,B6   s:0,PREL
          1 000FD6       003D                            DC       s:21473,PREL

     1438    21459    3            IF KZ$LINCTX.PRO.PROTYP = %KLPT_2780# AND

  21459   1 000FD7  ECC7 000A                            LDB,B6   LCTX$,AUTO
          1 000FD9  E846 003A                            LDR,R6   58,B6
          1 000FDB  6D01                                 CMV,R6   1
          1 000FDC  0981 0017                            BNE      s:21465,PREL
          1 000FDE  D2C6 0042                            LLH,R5   66,B6
          1 000FE0  5008                                 SOL,R5   8
          1 000FE1  5901 0012                            BEZ,R5   s:21465,PREL
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:212  
          1 000FE3  DCC7 0008                            LDB,B5   DCTX$,AUTO
          1 000FE5  C847 0010                            LDR,R4   BYTX,AUTO
          1 000FE7  C245 0021                            SUB,R4   33,B5
          1 000FE9  4D50                                 CMV,R4   80
          1 000FEA  0881 0009                            BAGE     s:21465,PREL

     1439    21460    3               (KZ$LINCTX.PRO.EMCHR ~= '0'B) AND
     1440    21461    4               BYTX - DVCTX.LASTRCBX < 80 THEN DO;

     1441    21462    4               BYT(BYTX)=KZ$LINCTX.PRO.EMCHR /* Default '19'X */;

  21462   1 000FEC  5048                                 SOR,R5   8
          1 000FED  CCC7 000C                            LDB,B4   BFR$,AUTO
          1 000FEF  B847 0010                            LDR,R3   BYTX,AUTO
          1 000FF1  D7B4                                 STH,R5   ,B4,R3

     1442    21463    4               BYTX=BYTX+1;

  21463   1 000FF2  8AC7 0010                            INC      BYTX,AUTO

     1443    21464    4               END;

     1444    21465    3            BYT(BYTX)=IRS;

  21465   1 000FF4  E2C7 001D                            LLH,R6   IRS,AUTO
          1 000FF6  6008                                 SOL,R6   8
          1 000FF7  6048                                 SOR,R6   8
          1 000FF8  DCC7 000C                            LDB,B5   BFR$,AUTO
          1 000FFA  B847 0010                            LDR,R3   BYTX,AUTO
          1 000FFC  E7B5                                 STH,R6   ,B5,R3

     1445    21466    3            DVCTX.LASTRCBX=BYTX+1;

  21466   1 000FFD  DCC7 0008                            LDB,B5   DCTX$,AUTO
          1 000FFF  3E01                                 ADV,R3   1
          1 001000  BF45 0021                            STR,R3   33,B5

PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:213  
     1446    21467    3            BYTX=BYTX+1;

  21467   1 001002  8AC7 0010                            INC      BYTX,AUTO

     1447    21468    3            END;

     1448    21469    2         DVCTX.BLKRECS=DVCTX.BLKRECS-1;

  21469   1 001004  ECC7 0008                            LDB,B6   DCTX$,AUTO
          1 001006  88C6 001D                            DEC      29,B6

     1449    21470    2         IF DVCTX.BLKRECS = 0 THEN

  21470   1 001008  E846 001D                            LDR,R6   29,B6
          1 00100A  6981 0004                            BNEZ,R6  s:21472,PREL

     1450    21471    2            CALL DONE ALTRET(NOBUF);

  21471   1 00100C  E3C0 FBC6                            LNJ,B6   s:0,PREL
          1 00100E       0005                            DC       s:21473,PREL

     1451    21472    2         RETURN;

  21472   1 00100F  ECC7 005C                            LDB,B6   KV$VDH_OTPLCL+7,AUTO
          1 001011  C3C6 0001                            LNJ,B4   1,B6

     1452    21473    2   NOBUF: ALTRETURN;

  21473   1 001013  ECC7 005C            NOBUF           LDB,B6   KV$VDH_OTPLCL+7,AUTO
          1 001015  B806                                 LDR,R3   ,B6
          1 001016  C3B6                                 LNJ,B4   ,B6,R3

     1453    21474    2   END;
     1454    21475
     1455    21476        /*    Check space remaining and number of records in the block.   */
     1456    21477
     1457    21478    1   CHKEOB: PROC ALTRET;
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:214  

  21478   1 001017  EFC7 005A            CHKEOB          STB,B6   KV$VDH_OTPLCL+5,AUTO

     1458    21479
     1459    21480    2         CALL CMPBYTSIZ;

  21480   1 001019  E3C0 FE28                            LNJ,B6   s:0,PREL
          1 00101B       0001                            DC       s:21481,PREL

     1460    21481    2         BYTSIZ = J;

  21481   1 00101C  E847 0012                            LDR,R6   J,AUTO
          1 00101E  EF47 0011                            STR,R6   BYTSIZ,AUTO

     1461    21482    3         IF BYTSIZ < 5 THEN DO;

  21482   1 001020  6D05                                 CMV,R6   5
          1 001021  0881 000B                            BAGE     s:21487,PREL

     1462    21483    3            CALL DONE ALTRET(NOBUF);

  21483   1 001023  E3C0 FBAF                            LNJ,B6   s:0,PREL
          1 001025       000C                            DC       s:21488,PREL

     1463    21484    3            CALL CMPBYTSIZ;

  21484   1 001026  E3C0 FE1B                            LNJ,B6   s:0,PREL
          1 001028       0001                            DC       s:21485,PREL

     1464    21485    3            BYTSIZ = J;

  21485   1 001029  E847 0012                            LDR,R6   J,AUTO
          1 00102B  EF47 0011                            STR,R6   BYTSIZ,AUTO

     1465    21486    3            END;

     1466    21487    2         RETURN;
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:215  

  21487   1 00102D  ECC7 005A                            LDB,B6   KV$VDH_OTPLCL+5,AUTO
          1 00102F  C3C6 0001                            LNJ,B4   1,B6

     1467    21488    2   NOBUF: ALTRETURN;

  21488   1 001031  ECC7 005A            NOBUF           LDB,B6   KV$VDH_OTPLCL+5,AUTO
          1 001033  B806                                 LDR,R3   ,B6
          1 001034  C3B6                                 LNJ,B4   ,B6,R3

     1468    21489    2   END;
     1469    21490
     1470    21491
     1471    21492        /*    Set SCB to cleanup current HASP string                       */
     1472    21493
     1473    21494    1   SET_SCB: PROC;

  21494   1 001035  EFC7 005C            SET_SCB         STB,B6   KV$VDH_OTPLCL+7,AUTO

     1474    21495
     1475    21496    3         IF BYTX - DVCTX.LASTSCBX > 1 THEN DO;

  21496   1 001037  DCC7 0008                            LDB,B5   DCTX$,AUTO
          1 001039  E847 0010                            LDR,R6   BYTX,AUTO
          1 00103B  E245 0020                            SUB,R6   32,B5
          1 00103D  6D01                                 CMV,R6   1
          1 00103E  0A81 0020                            BALE     s:21504,PREL

     1476    21497    3            IF BYTX-DVCTX.LASTSCBX > 64 THEN CALL M$XXX;

  21497   1 001040  E847 0010                            LDR,R6   BYTX,AUTO
          1 001042  E245 0020                            SUB,R6   32,B5
          1 001044  6D40                                 CMV,R6   64
          1 001045  0A81 0005                            BALE     s:21501,PREL

  21497   1 001047  B870 0082                            LDR,R3   130,IMO
          1 001049  0001                                 MCL
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:216  
          1 00104A       0000                            DC       s:21497+10,PREL

     1477    21498
     1478    21499                 /* Set ~END, ~IDENT and char count.                       */
     1479    21500
     1480    21501    3            KZ$HASPSCB(DVCTX.LASTSCBX)=BINBIT(BYTX-DVCTX.LASTSCBX-1,8)|'C0'X;

  21501   1 00104B  ECC7 0008                            LDB,B6   DCTX$,AUTO
          1 00104D  B846 0020                            LDR,R3   32,B6
          1 00104F  BF47 0064                            STR,R3   P$+6,AUTO
          1 001051  B247 0010                            SUB,R3   BYTX,AUTO
          1 001053  8653                                 CPL      R3
          1 001054  3008                                 SOL,R3   8
          1 001055  B470 C000                            OR,R3    -16384,IMO
          1 001057  3048                                 SOR,R3   8
          1 001058  DCC7 000C                            LDB,B5   BFR$,AUTO
          1 00105A  A847 0064                            LDR,R2   P$+6,AUTO
          1 00105C  B7A5                                 STH,R3   ,B5,R2

     1481    21502    3            END;

  21502   1 00105D  0F81 0005                            B        s:21505,PREL

     1482    21503    2         ELSE
     1483    21504    2            BYTX = DVCTX.LASTSCBX;

  21504   1 00105F  E845 0020                            LDR,R6   32,B5
          1 001061  EF47 0010                            STR,R6   BYTX,AUTO

     1484    21505    2         RETURN;

  21505   1 001063  ECC7 005C                            LDB,B6   KV$VDH_OTPLCL+7,AUTO
          1 001065  C3C6 0001                            LNJ,B4   1,B6

     1485    21506    2   END SET_SCB;
     1486    21507
     1487    21508
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:217  
     1488    21509        /*    Build string of one blank character                          */
     1489    21510
     1490    21511    1   BLDBLNKSTR: PROC ALTRET;

  21511   1 001067  EFC7 005E            BLDBLNKSTR      STB,B6   @EVENT+2,AUTO

     1491    21512
     1492    21513
     1493    21514    3         IF J < 5 THEN DO;

  21514   1 001069  E847 0012                            LDR,R6   J,AUTO
          1 00106B  6D05                                 CMV,R6   5
          1 00106C  0881 0008                            BAGE     s:21518,PREL

     1494    21515    3            CALL DONE ALTRET(NOBUF);

  21515   1 00106E  E3C0 FB64                            LNJ,B6   s:0,PREL
          1 001070       0051                            DC       s:21531,PREL

     1495    21516    3            J = BYTSIZ;

  21516   1 001071  E847 0011                            LDR,R6   BYTSIZ,AUTO
          1 001073  EF47 0012                            STR,R6   J,AUTO

     1496    21517    3            END;

     1497    21518    2         IF KZ$LINCTX.PRO.PROTYP = %KLPT_HASP#

  21518   1 001075  ECC7 000A                            LDB,B6   LCTX$,AUTO
          1 001077  D846 003A                            LDR,R5   58,B6
          1 001079  5D03                                 CMV,R5   3
          1 00107A  0901 0004                            BE       s:21520,PREL
          1 00107C  5D07                                 CMV,R5   7
          1 00107D  0981 002A                            BNE      s:21526,PREL

     1498    21519    3            OR KZ$LINCTX.PRO.PROTYP = %KLPT_NJE# THEN DO;

PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:218  
     1499    21520    3            KZ$HASPSCB(DVCTX.LASTSCBX) = 'C1'X;

  21520   1 00107F  DCC7 0008                            LDB,B5   DCTX$,AUTO
          1 001081  B845 0020                            LDR,R3   32,B5
          1 001083  C870 C100                            LDR,R4   -16128,IMO
          1 001085  4048                                 SOR,R4   8
          1 001086  CCC7 000C                            LDB,B4   BFR$,AUTO
          1 001088  C7B4                                 STH,R4   ,B4,R3

     1500    21521    3            KZ$HASPSCB(DVCTX.LASTSCBX+1) = ASCBIT(%KV_MVD.TRNTBL$->KV$TRNTBL.SP_CHR);

  21521   1 001089  DCC7 0008                            LDB,B5   DCTX$,AUTO
          1 00108B  B845 0020                            LDR,R3   32,B5
          1 00108D  CC80 0000 0000  xsym                 LDB,B4   KV$PTR$
          1 001090  BCC4 0006                            LDB,B3   6,B4
          1 001092  ACC3 000E                            LDB,B2   14,B3
          1 001094  D842 001D                            LDR,R5   29,B2
          1 001096  5008                                 SOL,R5   8
          1 001097  5048                                 SOR,R5   8
          1 001098  9CC7 000C                            LDB,B1   BFR$,AUTO
          1 00109A  3E01                                 ADV,R3   1
          1 00109B  D7B1                                 STH,R5   ,B1,R3

     1501    21522    3            DVCTX.LASTSCBX = DVCTX.LASTSCBX + 2;

  21522   1 00109C  DCC7 0008                            LDB,B5   DCTX$,AUTO
          1 00109E  D845 0020                            LDR,R5   32,B5
          1 0010A0  5E02                                 ADV,R5   2
          1 0010A1  DF45 0020                            STR,R5   32,B5

     1502    21523    3            BYTX = DVCTX.LASTSCBX+1;

  21523   1 0010A3  5E01                                 ADV,R5   1
          1 0010A4  DF47 0010                            STR,R5   BYTX,AUTO

     1503    21524    3            END;

PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:219  
  21524   1 0010A6  0F81 0016                            B        s:21530,PREL

     1504    21525    3         ELSE DO;

     1505    21526    3            BYT(BYTX) = ASCBIT(%KV_MVD.TRNTBL$->KV$TRNTBL.SP_CHR);

  21526   1 0010A8  DC80 0000 0000  xsym                 LDB,B5   KV$PTR$
          1 0010AB  CCC5 0006                            LDB,B4   6,B5
          1 0010AD  BCC4 000E                            LDB,B3   14,B4
          1 0010AF  C843 001D                            LDR,R4   29,B3
          1 0010B1  4008                                 SOL,R4   8
          1 0010B2  4048                                 SOR,R4   8
          1 0010B3  ACC7 000C                            LDB,B2   BFR$,AUTO
          1 0010B5  B847 0010                            LDR,R3   BYTX,AUTO
          1 0010B7  C7B2                                 STH,R4   ,B2,R3

     1506    21527    3            BYTX = BYTX+1;

  21527   1 0010B8  8AC7 0010                            INC      BYTX,AUTO

     1507    21528    3            J = J-3;

  21528   1 0010BA  6EFD                                 ADV,R6   -3
          1 0010BB  EF47 0012                            STR,R6   J,AUTO

     1508    21529    3            END;

     1509    21530    2         RETURN;

  21530   1 0010BD  ECC7 005E                            LDB,B6   @EVENT+2,AUTO
          1 0010BF  C3C6 0001                            LNJ,B4   1,B6

     1510    21531    2   NOBUF: ALTRETURN;

  21531   1 0010C1  ECC7 005E            NOBUF           LDB,B6   @EVENT+2,AUTO
          1 0010C3  B806                                 LDR,R3   ,B6
          1 0010C4  C3B6                                 LNJ,B4   ,B6,R3
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:220  

     1511    21532    2   END;
     1512    21533
     1513    21534        /*    Build a zero length record (EOF)                             */
     1514    21535
     1515    21536    1   BLDEOFRC: PROC ALTRET;

  21536   1 0010C5  EFC7 005A            BLDEOFRC        STB,B6   KV$VDH_OTPLCL+5,AUTO

     1516    21537    2         IF BFR$ = ADDR(NIL) THEN

  21537   1 0010C7  8DC7 000C                            CMN      BFR$,AUTO
          1 0010C9  0981 0004                            BNE      s:21540,PREL

     1517    21538    2            CALL GET_BFR ALTRET(NOBUF);

  21538   1 0010CB  E3C0 FC57                            LNJ,B6   s:0,PREL
          1 0010CD       008C                            DC       s:21574,PREL

     1518    21539
     1519    21540    2   BLDEOF1: CALL CMPBYTSIZ;

  21540   1 0010CE  E3C0 FD73            BLDEOF1         LNJ,B6   s:0,PREL
          1 0010D0       0001                            DC       s:21541,PREL

     1520    21541    3         IF J < 2 THEN DO;

  21541   1 0010D1  E847 0012                            LDR,R6   J,AUTO
          1 0010D3  6D02                                 CMV,R6   2
          1 0010D4  0881 0009                            BAGE     s:21546,PREL

     1521    21542    3            CALL DONE ALTRET(NOBUF);

  21542   1 0010D6  E3C0 FAFC                            LNJ,B6   s:0,PREL
          1 0010D8       0081                            DC       s:21574,PREL

     1522    21543    3            J=BYTSIZ;
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:221  

  21543   1 0010D9  E847 0011                            LDR,R6   BYTSIZ,AUTO
          1 0010DB  EF47 0012                            STR,R6   J,AUTO

     1523    21544    3            GOTO BLDEOF1;

  21544   1 0010DD  0FF1                                 B        s:21540,SPREL

     1524    21545    3            END;
     1525    21546    2         IF KZ$LINCTX.PRO.PROTYP = %KLPT_HASP#

  21546   1 0010DE  ECC7 000A                            LDB,B6   LCTX$,AUTO
          1 0010E0  D846 003A                            LDR,R5   58,B6
          1 0010E2  5D03                                 CMV,R5   3
          1 0010E3  0901 0004                            BE       s:21548,PREL
          1 0010E5  5D07                                 CMV,R5   7
          1 0010E6  0981 003E                            BNE      s:21563,PREL

     1526    21547    3            OR KZ$LINCTX.PRO.PROTYP = %KLPT_NJE# THEN DO;

     1527    21548    3            CALL SET_SCB;

  21548   1 0010E8  E3C0 FF4C                            LNJ,B6   s:0,PREL
          1 0010EA       0001                            DC       s:21549,PREL

     1528    21549    3   BLDEOF2: BYT(BYTX) = '0'B;         /* Last SCB   */

  21549   1 0010EB  ECC7 000C            BLDEOF2         LDB,B6   BFR$,AUTO
          1 0010ED  B847 0010                            LDR,R3   BYTX,AUTO
          1 0010EF  87B6                                 CLH      ,B6,R3

     1529    21550    3            BYTX = BYTX+1;

  21550   1 0010F0  8AC7 0010                            INC      BYTX,AUTO

     1530    21551    3            KZ$HASPRCB(DVCTX.LASTRCBX)=DVCTX.RCB_CODE;

PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:222  
  21551   1 0010F2  ECC7 0008                            LDB,B6   DCTX$,AUTO
          1 0010F4  B846 0021                            LDR,R3   33,B6
          1 0010F6  E2C6 0024                            LLH,R6   36,B6
          1 0010F8  6008                                 SOL,R6   8
          1 0010F9  6048                                 SOR,R6   8
          1 0010FA  DCC7 000C                            LDB,B5   BFR$,AUTO
          1 0010FC  E7B5                                 STH,R6   ,B5,R3

     1531    21552    3            KZ$HASPSRCB(DVCTX.LASTRCBX+1)='80'X; /* No space */

  21552   1 0010FD  ECC7 0008                            LDB,B6   DCTX$,AUTO
          1 0010FF  B846 0021                            LDR,R3   33,B6
          1 001101  E870 8000                            LDR,R6   -32768,IMO
          1 001103  6048                                 SOR,R6   8
          1 001104  DCC7 000C                            LDB,B5   BFR$,AUTO
          1 001106  3E01                                 ADV,R3   1
          1 001107  E7B5                                 STH,R6   ,B5,R3

     1532    21553    3            I = BYTX -DVCTX.LASTRCBX;

  21553   1 001108  ECC7 0008                            LDB,B6   DCTX$,AUTO
          1 00110A  E847 0010                            LDR,R6   BYTX,AUTO
          1 00110C  E246 0021                            SUB,R6   33,B6
          1 00110E  EF47 0013                            STR,R6   I,AUTO

     1533    21554    3            DVCTX.LASTRCBX = BYTX;

  21554   1 001110  D847 0010                            LDR,R5   BYTX,AUTO
          1 001112  DF46 0021                            STR,R5   33,B6

     1534    21555    4            IF I > 3 THEN DO;

  21555   1 001114  6D03                                 CMV,R6   3
          1 001115  0381 0005                            BLE      s:21559,PREL

     1535    21556    4               BYTX = BYTX +2;

PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:223  
  21556   1 001117  5E02                                 ADV,R5   2
          1 001118  DF47 0010                            STR,R5   BYTX,AUTO

     1536    21557    4               GOTO BLDEOF2;

  21557   1 00111A  0FD1                                 B        s:21549,SPREL

     1537    21558    4               END;
     1538    21559    3            KZ$OTPBFR.FLAGS.LAST#='1'B;

  21559   1 00111B  DCC7 000C                            LDB,B5   BFR$,AUTO
          1 00111D  8945 0002                            LBT,'0040'X       2,B5
          1 00111F       0040

     1539    21560    3            CALL DONE_EOF ALTRET(NOBUF);

  21560   1 001120  E3C0 FBFA                            LNJ,B6   s:0,PREL
          1 001122       0037                            DC       s:21574,PREL

     1540    21561    3            END;

  21561   1 001123  0F81 0016                            B        s:21570,PREL

     1541    21562    3         ELSE DO;

     1542    21563    3            I=1;

  21563   1 001125  4C01                                 LDV,R4   1
          1 001126  CF47 0013                            STR,R4   I,AUTO

     1543    21564    3            KZ$OTPBFR.FLAGS.LAST#='1'B;

  21564   1 001128  DCC7 000C                            LDB,B5   BFR$,AUTO
          1 00112A  8945 0002                            LBT,'0040'X       2,B5
          1 00112C       0040

     1544    21565    3            CALL BLDUPSPCREC ALTRET(NOBUF);
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:224  

  21565   1 00112D  E3C0 FE50                            LNJ,B6   s:0,PREL
          1 00112F       002A                            DC       s:21574,PREL

     1545    21566                 /*  If LAST# is reset, we've already sent the buffer.  */
     1546    21567    3            IF KZ$OTPBFR.FLAGS.LAST# THEN

  21567   1 001130  ECC7 000C                            LDB,B6   BFR$,AUTO
          1 001132  82C6 0002                            LB,'0040'X        2,B6
          1 001134       0040
          1 001135  0581 0004                            BBF      s:21570,PREL

     1547    21568    3               CALL DONE_EOF ALTRET(NOBUF);

  21568   1 001137  E3C0 FBE3                            LNJ,B6   s:0,PREL
          1 001139       0020                            DC       s:21574,PREL

     1548    21569    3            END;

     1549    21570    2         I=KZ$OTPBFR.BFRSIZ;

  21570   1 00113A  ECC7 000C                            LDB,B6   BFR$,AUTO
          1 00113C  E846 0004                            LDR,R6   4,B6
          1 00113E  EF47 0013                            STR,R6   I,AUTO

     1550    21571    2         CALL KVB$RLS2NSYS (I,BFR$); /* Release last buffer */

  21571   1 001140  DBC7 000C                            LAB,B5   BFR$,AUTO
          1 001142  DFC7 0066                            STB,B5   P$+8,AUTO
          1 001144  CBC7 0013                            LAB,B4   I,AUTO
          1 001146  CFC7 0064                            STB,B4   P$+6,AUTO
          1 001148  BBC7 0064                            LAB,B3   P$+6,AUTO
          1 00114A  CBF0 0200                            LAB,B4   512,IMO
          1 00114C  E380 0000 0000  xent                 LNJ,B6   KVB$RLS2NSYS
          1 00114F       0001                            DC       s:21572,PREL

     1551    21572    2         BFR$=ADDR(NIL);
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:225  

  21572   1 001150  EB80 0000 0000                       LAB,B6   0
          1 001153  EFC7 000C                            STB,B6   BFR$,AUTO

     1552    21573    2         RETURN;

  21573   1 001155  ECC7 005A                            LDB,B6   KV$VDH_OTPLCL+5,AUTO
          1 001157  C3C6 0001                            LNJ,B4   1,B6

     1553    21574    2   NOBUF: ALTRETURN;

  21574   1 001159  ECC7 005A            NOBUF           LDB,B6   KV$VDH_OTPLCL+5,AUTO
          1 00115B  B806                                 LDR,R3   ,B6
          1 00115C  C3B6                                 LNJ,B4   ,B6,R3

     1554    21575    2   END;
     1555    21576
     1556    21577
     1557    21578        /*    Report event to CLM                                          */
     1558    21579
     1559    21580    1   REPCLMEVT: PROC (EVENT);

  21580   1 00115D  EFC7 005A            REPCLMEVT       STB,B6   KV$VDH_OTPLCL+5,AUTO

     1560    21581
     1561    21582    2   DCL EVENT UBIN;
     1562    21583
     1563    21584    2   DCL P$ PTR;
     1564    21585
     1565    21586    2         P$=ADDR(KZ$LINCTX.LINID);

  21586   1 00115F  DCC7 000A                            LDB,B5   LCTX$,AUTO
          1 001161  CBC5 0004                            LAB,B4   4,B5
          1 001163  CFC7 005E                            STB,B4   P$,AUTO

     1566    21587    2   REPCLM01: KZ$EVENT=KZ_EVENT;

PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:226  
  21587   1 001165  AB80 0000 0000  00   REPCLM01        LAB,B2   FPT@WRSYSLOG
          1 001168  2C2A                                 LDV,R2   42
          1 001169  6C1C                                 LDV,R6   28
          1 00116A  BBC7 0047                            LAB,B3   KZ$EVENT,AUTO
          1 00116C  3C00                                 LDV,R3   0
          1 00116D  0008                                 MMM

     1567    21588    2         KZ$EVENT.TERMID$=P$;

  21588   1 00116E  ECC7 005E                            LDB,B6   P$,AUTO
          1 001170  EFC7 004C                            STB,B6   KZ$EVENT+5,AUTO

     1568    21589    2         KZ$EVENT.EVENT=EVENT;

  21589   1 001172  DCC7 005C                            LDB,B5   @EVENT,AUTO
          1 001174  E805                                 LDR,R6   ,B5
          1 001175  EF47 0047                            STR,R6   KZ$EVENT,AUTO

     1569    21590    2         KZ$EVENT.LINCTX$=LCTX$;

  21590   1 001177  CCC7 000A                            LDB,B4   LCTX$,AUTO
          1 001179  CFC7 004A                            STB,B4   KZ$EVENT+3,AUTO

     1570    21591    2         CALL KZR_CNCDSC@ (KZ$EVENT);

  21591   1 00117B  BBC7 0047                            LAB,B3   KZ$EVENT,AUTO
          1 00117D  BFC7 0064                            STB,B3   P$+6,AUTO
          1 00117F  BBC7 0064                            LAB,B3   P$+6,AUTO
          1 001181  9C80 0000 0000  xsym                 LDB,B1   KZR_CNCDSC@
          1 001184  CBF0 0100                            LAB,B4   256,IMO
          1 001186  E381                                 LNJ,B6   ,B1
          1 001187       0001                            DC       s:21592,PREL

     1571    21592    2         RETURN;

  21592   1 001188  ECC7 005A                            LDB,B6   KV$VDH_OTPLCL+5,AUTO
          1 00118A  C3C6 0001                            LNJ,B4   1,B6
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:227  

     1572    21593    2   REPCLMEVT_DEV: ENTRY (EVENT);

  21593   1 00118C  EFC7 005A            REPCLMEVT_DEV   STB,B6   KV$VDH_OTPLCL+5,AUTO

     1573    21594    2         P$=ADDR(DVCTX.LCLENDPNTID);

  21594   1 00118E  DCC7 0008                            LDB,B5   DCTX$,AUTO
          1 001190  CBC5 0002                            LAB,B4   2,B5
          1 001192  CFC7 005E                            STB,B4   P$,AUTO

     1574    21595    2         GOTO REPCLM01;

  21595   1 001194  0FD1                                 B        s:21587,SPREL

     1575    21596    2   END;
     1576    21597
     1577    21598
     1578    21599        %EJECT;
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:228  
     1579    21600
     1580    21601        /*D*  NAME: KZD$BLDEOF
     1581    21602              CALL:
     1582    21603                    CALL KZD$BLDEOF (Device-context);
     1583    21604              PARAMETER:
     1584    21605                    Device-context is a device context block
     1585    21606              DESCRIPTION:
     1586    21607                    This procedure builds a zero length record indicating an
     1587    21608                    EOF, and adds it onto the device output queue.  It cannot
     1588    21609                    be called if VDH is building output records for the device,
     1589    21610                    that is, if the device state is OPEN.
     1590    21611                                                                           */
     1591    21612    1   KZD$BLDEOF: ENTRY (PARM) ALTRET;

  21612   1 001195  D380 0000 0000  xent KZD$BLDEOF      LNJ,B5   X6A_AUTO_1
          1 001198       0068 0001                       DC       104,1

     1592    21613
     1593    21614    1         DCTX$=ADDR(PARM);

  21614   1 00119A  ECC7 0004                            LDB,B6   @PARM,AUTO
          1 00119C  EFC7 0008                            STB,B6   DCTX$,AUTO

     1594    21615    1         LCTX$=DVCTX.LIN$;

  21615   1 00119E  DCC6 000D                            LDB,B5   13,B6
          1 0011A0  DFC7 000A                            STB,B5   LCTX$,AUTO

     1595    21616    1         BFR$=ADDR(NIL);

  21616   1 0011A2  CB80 0000 0000                       LAB,B4   0
          1 0011A5  CFC7 000C                            STB,B4   BFR$,AUTO

     1596    21617    1         CALL BLDEOFRC;

  21617   1 0011A7  E3C0 FF1D                            LNJ,B6   s:0,PREL
          1 0011A9       0001                            DC       s:21618,PREL
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:229  

     1597    21618    1         RETURN;

  21618   1 0011AA  C380 0000 0000  xent                 LNJ,B4   X6A_ARET

     1598    21619        /*D*   NAME:KZD$DQ;
     1599    21620               PURPOSE:
     1600    21621                  To provide a procedure to defer output buffers
     1601    21622        */
     1602    21623    1   KZD$DQ: ENTRY (PARM) ALTRET;

  21623   1 0011AD  D380 0000 0000  xent KZD$DQ          LNJ,B5   X6A_AUTO_1
          1 0011B0       0068 0001                       DC       104,1

     1603    21624    1         DCTX$=ADDR(PARM);

  21624   1 0011B2  ECC7 0004                            LDB,B6   @PARM,AUTO
          1 0011B4  EFC7 0008                            STB,B6   DCTX$,AUTO

     1604    21625    1         CALL DQ;

  21625   1 0011B6  E3C0 0005                            LNJ,B6   s:0,PREL
          1 0011B8       0001                            DC       s:21626,PREL

     1605    21626    1         RETURN;

  21626   1 0011B9  C380 0000 0000  xent                 LNJ,B4   X6A_ARET

     1606    21627        /*      Move output buffers to defer queue    */
     1607    21628    1   DQ:   PROC ALTRET;

  21628   1 0011BC  EFC7 005A            DQ              STB,B6   KV$VDH_OTPLCL+5,AUTO

     1608    21629    3         IF DVCTX.OTPHD$ ~= ADDR(NIL) THEN DO;

  21629   1 0011BE  DCC7 0008                            LDB,B5   DCTX$,AUTO
          1 0011C0  8DC5 000F                            CMN      15,B5
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:230  
          1 0011C2  0901 0020                            BE       s:21638,PREL

     1609    21630    3            IF DVCTX.DFRHD$ = ADDR(NIL) THEN

  21630   1 0011C4  8DC5 0013                            CMN      19,B5
          1 0011C6  0981 0007                            BNE      s:21633,PREL

     1610    21631    3               DVCTX.DFRHD$=DVCTX.OTPHD$;

  21631   1 0011C8  CCC5 000F                            LDB,B4   15,B5
          1 0011CA  CFC5 0013                            STB,B4   19,B5
          1 0011CC  0F81 0006                            B        s:21634,PREL

     1611    21632    3            ELSE
     1612    21633    3               DVCTX.DFRTL$->KZ$OTPBFR.LNK$=DVCTX.OTPHD$;

  21633   1 0011CE  CCC5 0015                            LDB,B4   21,B5
          1 0011D0  BCC5 000F                            LDB,B3   15,B5
          1 0011D2  BF84                                 STB,B3   ,B4

     1613    21634    3            DVCTX.DFRTL$=DVCTX.OTPTL$;

  21634   1 0011D3  ECC7 0008                            LDB,B6   DCTX$,AUTO
          1 0011D5  DCC6 0011                            LDB,B5   17,B6
          1 0011D7  DFC6 0015                            STB,B5   21,B6

     1614    21635    3            DVCTX.OTPHD$=ADDR(NIL);

  21635   1 0011D9  CB80 0000 0000                       LAB,B4   0
          1 0011DC  CFC6 000F                            STB,B4   15,B6

     1615    21636    3            DVCTX.OTPTL$= ADDR(NIL);

  21636   1 0011DE  BB80 0000 0000                       LAB,B3   0
          1 0011E1  BFC6 0011                            STB,B3   17,B6

     1616    21637    3            END;
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:231  

     1617    21638    2         RETURN;

  21638   1 0011E3  ECC7 005A                            LDB,B6   KV$VDH_OTPLCL+5,AUTO
          1 0011E5  C3C6 0001                            LNJ,B4   1,B6
     1618    21639    2   END;
     1619    21640    1   END;

PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:232  
--  Include file information  --

   KHC_MAC_C.:E05TOU  is referenced.
   K_ID_E.:E05TOU  is referenced.
   KL_AFCN_C.:E05TOU  is referenced.
   G_LCP6_E.:E05TOU  is referenced.
   GT_LCP6_M.:E05TOU  is referenced.
   KI_CP6.:E05TOU  is referenced.
   GF_LCP6_M.:E05TOU  is referenced.
   GM_LCP6_M.:E05TOU  is referenced.
   GU_LCP6_M.:E05TOU  is referenced.
   GJ_LCP6_M.:E05TOU  is referenced.
   GH_LCP6_M.:E05TOU  is referenced.
   LCP_6.:E05TOU  cannot be made into a system file and is referenced.
   KL_MACRO_C.:E05TOU  is referenced.
   KL_SUPER_C.:E05TOU  is referenced.
   KV_PRMID_E.:E05TOU  is referenced.
   KV$GLBCTX.:E05TOU  is referenced.
   KV_GLB_M.:E05TOU  is referenced.
   KV$GLB.:E05TOU  is referenced.
   KV$VDH.:E05TOU  is referenced.
   KV$USR.:E05TOU  is referenced.
   KV$INT.:E05TOU  is referenced.
   KZ_CLM_E.:E05TOU  is referenced.
   KZ_PERR_C.:E05TOU  is referenced.
   KZ_3270_C.:E05TOU  is referenced.
   KV_GLBCNS_E.:E05TOU  is referenced.
   KZ_HASP_C.:E05TOU  is referenced.
   KH$CHN.:E05TOU  is referenced.
   KH$STT.:E05TOU  is referenced.
   KV$BPC.:E05TOU  is referenced.
   KZ$BSCSTT.:E05TOU  is referenced.
   KZ$RBT_M.:E05TOU  is referenced.
   KZ$OTPBFR.:E05TOU  is referenced.
   KZ$NJE_M.:E05TOU  is referenced.
   KZ$LINCTX.:E05TOU  is referenced.
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:233  
      No diagnostics issued in procedure KZD$DEVMGR.
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:234  

 **** Variables and constants ****

  ****  Section 000 RoData KZD$DEVMGR

  ****  Scalars and arrays  ****
HexLoc.c.b A Datatyp(siz) R M Lvl/name                 HexLoc.c.b A Datatyp(siz) R M Lvl/name

    4A-0-0/w UBIN(16)    r     1 ESCSZ(0:5)                 0-0-0/w STRC(336)   r     1 FPT@WRSYSLOG
    23-0-0/w STRC(32)    r     1 KV_VDH_EVT                25-0-0/w STRC(80)    r     1 KV_VDH_OTPLCL
    49-0-0/w UBIN(16)    r     1 KZD_MINSP_FORPST          15-0-0/w STRC(224)   r     1 KZ_EVENT
    2A-0-0/c STRC(320)   r     1 KZ_NJE_SIGNON             3E-0-0/w STRC(128)   r     1 KZ_OTPBFR
    52-0-0/w BIT (8)     r     1 KZ_SLCCHR2780PNC          53-0-0/w BIT (8)     r     1 KZ_SLCCHR3780PNC1
    55-0-0/w BIT (8)     r     1 KZ_SLCCHR3780PRN          46-0-0/b BIT (8)     r     1 VFC(0:4)

  ****  Auto variables  ****

  ****  Scalars and arrays  ****
HexLoc.c.b A Datatyp(siz) R M Lvl/name                 HexLoc.c.b A Datatyp(siz) R M Lvl/name

    5C-0-0/w PTR         r     1 @EVENT                     4-0-0/w PTR         r     1 @PARM
     C-0-0/w PTR         r     1 BFR$                      11-0-0/w SBIN(16)    r     1 BYTSIZ
    10-0-0/w UBIN(16)    r     1 BYTX                       8-0-0/w PTR         r     1 DCTX$
    *0-0-0/w UBIN(16)    r     1 EVENT                     2B-0-0/w STRC(336)   r     1 FPT_WRSYSLOG
    13-0-0/w UBIN(16)    r     1 I                         1D-0-0/b BIT (8)     r     1 IRS
    12-0-0/w SBIN(16)    r     1 J                         18-0-0/w SBIN(16)    r     1 K
    40-0-0/w STRC(32)    r     1 KV$VDH_EVT                55-0-0/w STRC(80)    r     1 KV$VDH_OTPLCL
    42-0-0/w STRC(80)    r     1 KV$VDH_OTPMRK             47-0-0/w STRC(224)   r     1 KZ$EVENT
    19-0-0/w UBIN(16)    r     1 L                          A-0-0/w PTR         r     1 LCTX$
    1C-0-0/w UBIN(16)    r     1 LEV                       1A-0-0/b BIT (8)     r     1 M
    1B-0-0/w UBIN(16)    r     1 N                         5E-0-0/w PTR         r     1 P$
    24-0-0/w UBIN(16)    r     1 PAGLNG                    *0-0-0/w UBIN(16)    r     1 PARM
     6-0-0/w PTR         r     1 PARM$                     1E-0-0/w PTR         r     1 SGN$
    22-0-0/w BIT         r     1 SGNITYPE                  20-0-0/w PTR         r     1 SGN_NJE$
    23-0-0/w UBIN(16)    r     1 SZ                        14-0-0/w PTR         r     1 T$
     E-0-0/w PTR         r     1 TBFR$                     16-0-0/w PTR         r     1 U$
    25-0-0/w PTR         r     1 VFU$                      27-0-0/w PTR         r     1 VFU_LIN$
    2A-0-0/w UBIN(16)    r     1 VFU_LINX
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:235  

  ****  SYMREF variables  ****

  ****  Scalars and arrays  ****
HexLoc.c.b A Datatyp(siz) R M Lvl/name                 HexLoc.c.b A Datatyp(siz) R M Lvl/name

     0-0-0/w PTR         r     1 KV$PTR$                    0-0-0/w STRC(32)    r     1 KV_VDH_EVT_CMPOTP
     0-0-0/w STRC(32)    r     1 KV_VDH_EVT_RQSOTP          0-0-0/w STRC(80)    r     1 KV_VDH_OTPMRK
     0-0-0/w STRC(64)    r     1 KV_VDH_PST_CR_VRT          0-0-0/w EPTR        r     1 KZR_CNCDSC@
     0-0-0/w STRC(272)   r     1 KZ_HASP_HDR

  ****  BASED and DCB variables  ****

  ****  Scalars and arrays  ****
HexLoc.c.b A Datatyp(siz) R M Lvl/name                 HexLoc.c.b A Datatyp(siz) R M Lvl/name

     0-0-0/c BIT (8)     r     1 BYT(0:0)                   0-0-0/c CHAR(512)   r     1 CHR1
     0-0-0/w STRC(928)   r     1 DVCTX                      0-0-0/w STRC(512)   r     1 KH$CHN
     0-0-0/w STRC(512)   r     1 KV$MRD                     0-0-0/w STRC(512)   r     1 KV$MVD
     0-0-0/w STRC(48)    r     1 KV$OTPMRK                  0-0-0/w STRC(480)   r     1 KV$PTR
     0-0-0/w STRC(496)   r     1 KV$SRD                     0-0-0/w STRC(499)   r     1 KV$TRNTBL
     0-0-0/w STRC(128)   r     1 KV$USR_DAT                 0-0-0/w STRC(32)    r     1 KV$USR_EVT
     0-0-0/w STRC(64)    r     1 KV$USR_OTPMRK              0-0-0/w STRC(64)    r     1 KV$USR_PST
     0-0-0/w STRC(128)   r     1 KV$USR_SETPRM              0-0-0/w STRC(512)   r     1 KV$VDI
     0-0-0/w STRC(48)    r     1 KZ$HASPBLK
     0-0-0/c STRC(8)     r     1 KZ$HASPRCB(0:511)
     0-0-0/c STRC(8)     r     1 KZ$HASPSCB(0:511)
     0-0-0/c STRC(8)     r     1 KZ$HASPSRCB(0:0)
     0-0-0/w STRC(2192)  r     1 KZ$LINCTX                  0-0-0/c STRC(320)   r     1 KZ$NJE_SIGNON
     0-0-0/w STRC(128)   r     1 KZ$OTPBFR                  0-0-0/w STRC(2144)  r     1 KZ$SYNCSTAT
     0-0-0/w BIT (16)    r     1 VFUBFR(0:199)              0-0-0/w STRC(16)    r     1 VFU_WORD


   Procedure KZD$DEVMGR requires 4583 words for executable code.
   Procedure KZD$DEVMGR requires 104 words of local(AUTO) storage.
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:236  

    No errors detected in file KZD$DEVMGR.:E05TSI    .
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:237  
          *** CROSS REFERENCE LISTING ***
**     DENOTES     IDENTIFIER DEFINITION
<<                 IDENTIFIER'S VALUE SET
>>                 IDENTIFIER'S VALUE USED
<>                 IDENTIFIER SET AND/OR USED
--                 IDENTIFIER REFERENCED
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:238  
          MINI XREF LISTING

BADSTATE
     20927**LABEL   20733--GOTO    20740--GOTO    20825--GOTO    20893--GOTO    20973--GOTO    21104--GOTO
BFR$
     16801**DCL     18667--IMP-PTR 19079--IMP-PTR 19102--IMP-PTR 19126--IMP-PTR 19679--IMP-PTR 20176>>IF
     20265>>ASSIGN  20266<<ASSIGN  20268<<ASSIGN  20305>>IF      20307>>IF      20308>>DOINDEX 20309>>ASSIGN
     20309>>ASSIGN  20316>>IF      20320>>ASSIGN  20320>>ASSIGN  20321>>ASSIGN  20321>>ASSIGN  20321>>ASSIGN
     20356>>IF      20382>>ASSIGN  20412>>ASSIGN  20414>>ASSIGN  20438>>ASSIGN  20463>>ASSIGN  20483>>ASSIGN
     20489>>ASSIGN  20490>>ASSIGN  20534<>CALL    20540>>ASSIGN  20541>>ASSIGN  20542>>ASSIGN  20544>>ASSIGN
     20549>>ASSIGN  20553>>ASSIGN  20561>>ASSIGN  20562>>ASSIGN  20563<<ASSIGN  20584>>ASSIGN  20587>>ASSIGN
     20613>>ASSIGN  20625>>ASSIGN  20629>>ASSIGN  20653>>ASSIGN  20658<<ASSIGN  20704>>IF      20709>>ASSIGN
     20713<<ASSIGN  20713>>ASSIGN  20714>>ASSIGN  20715>>ASSIGN  20716>>ASSIGN  20717>>ASSIGN  20718<<ASSIGN
     20743>>IF      20748>>ASSIGN  20750<<ASSIGN  20750>>ASSIGN  20751>>ASSIGN  20752>>ASSIGN  20753>>ASSIGN
     20754>>ASSIGN  20755<<ASSIGN  20775>>IF      20779>>ASSIGN  20818>>IF      20819>>ASSIGN  20820>>CALL
     20821<<ASSIGN  20838>>IF      20843>>ASSIGN  20845<<ASSIGN  20845>>ASSIGN  20846>>ASSIGN  20847>>ASSIGN
     20848>>ASSIGN  20849>>ASSIGN  20850<<ASSIGN  20882>>IF      20883>>ASSIGN  20884<>CALL    20980<<ASSIGN
     20996>>ASSIGN  21060<<ASSIGN  21119>>IF      21121>>ASSIGN  21122>>CALL    21129>>ASSIGN  21158>>CALLBLT
     21170>>ASSIGN  21177>>ASSIGN  21178>>ASSIGN  21179>>IF      21213<<ASSIGN  21214>>ASSIGN  21244<>CALL
     21248>>ASSIGN  21249>>ASSIGN  21250>>ASSIGN  21268>>ASSIGN  21270>>ASSIGN  21275>>ASSIGN  21276>>ASSIGN
     21314>>ASSIGN  21322>>ASSIGN  21324>>ASSIGN  21325>>ASSIGN  21326>>ASSIGN  21328>>ASSIGN  21352>>ASSIGN
     21355>>ASSIGN  21394>>ASSIGN  21396>>ASSIGN  21397>>ASSIGN  21405>>ASSIGN  21406>>ASSIGN  21424>>ASSIGN
     21427>>ASSIGN  21448>>ASSIGN  21449>>ASSIGN  21452>>ASSIGN  21462>>ASSIGN  21465>>ASSIGN  21501>>ASSIGN
     21520>>ASSIGN  21521>>ASSIGN  21526>>ASSIGN  21537>>IF      21549>>ASSIGN  21551>>ASSIGN  21552>>ASSIGN
     21559>>ASSIGN  21564>>ASSIGN  21567>>IF      21570>>ASSIGN  21571<>CALL    21572<<ASSIGN  21616<<ASSIGN
BLDBLNKSTR
     21511**PROC    20384--CALL    20416--CALL    21451--CALL    21458--CALL
BLDEOF1 IN PROCEDURE BLDEOFRC
     21540**LABEL   21544--GOTO
BLDEOF2 IN PROCEDURE BLDEOFRC
     21549**LABEL   21557--GOTO
BLDEOFRC
     21536**PROC    20805--CALL    20930--CALL    21617--CALL
BLDUPSPCREC
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:239  
     21441**PROC    20389--CALL    20420--CALL    20445--CALL    21565--CALL
BYT
     19679**DCL     20463<<ASSIGN  20489<<ASSIGN  20490<<ASSIGN  21268<<ASSIGN  21270<<ASSIGN  21275<<ASSIGN
     21276<<ASSIGN  21394<<ASSIGN  21405<<ASSIGN  21406<<ASSIGN  21424<<ASSIGN  21427<<ASSIGN  21448<<ASSIGN
     21449<<ASSIGN  21452<<ASSIGN  21462<<ASSIGN  21465<<ASSIGN  21526<<ASSIGN  21549<<ASSIGN
BYTSIZ
     16804**DCL     20180<<ASSIGN  20183>>IF      20195>>IF      20196<<ASSIGN  20502>>IF      20505<<ASSIGN
     20972<<ASSIGN  20982<<ASSIGN  20998>>ASSIGN  21223<<ASSIGN  21225<<ASSIGN  21255<<ASSIGN  21296<<ASSIGN
     21299<<ASSIGN  21299>>ASSIGN  21300>>IF      21301<<ASSIGN  21481<<ASSIGN  21482>>IF      21485<<ASSIGN
     21516>>ASSIGN  21543>>ASSIGN
BYTX
     16803**DCL     20197>>ASSIGN  20198<<ASSIGN  20198>>ASSIGN  20361>>ASSIGN  20362<<ASSIGN  20362>>ASSIGN
     20443>>IF      20463>>ASSIGN  20464<<ASSIGN  20464>>ASSIGN  20470>>ASSIGN  20471<<ASSIGN  20471>>ASSIGN
     20486<<ASSIGN  20486>>ASSIGN  20489>>ASSIGN  20490>>ASSIGN  20492<<ASSIGN  20492>>ASSIGN  20590>>ASSIGN
     20601>>ASSIGN  20612<<ASSIGN  20617>>ASSIGN  20626>>ASSIGN  20630>>ASSIGN  20633<<ASSIGN  20634>>ASSIGN
     20981<<ASSIGN  20997>>ASSIGN  21102>>IF      21115>>IF      21115>>IF      21140>>ASSIGN  21167<<ASSIGN
     21170>>ASSIGN  21173<<ASSIGN  21173>>ASSIGN  21175<<ASSIGN  21175>>ASSIGN  21177>>ASSIGN  21217<<ASSIGN
     21218>>ASSIGN  21254<<ASSIGN  21256>>ASSIGN  21257>>ASSIGN  21262<<ASSIGN  21282<<ASSIGN  21284<<ASSIGN
     21296>>ASSIGN  21339>>ASSIGN  21358<<ASSIGN  21393>>IF      21394>>ASSIGN  21395<<ASSIGN  21395>>ASSIGN
     21398>>ASSIGN  21404>>IF      21410<<ASSIGN  21413>>IF      21416<<ASSIGN  21421>>IF      21424>>ASSIGN
     21425<<ASSIGN  21425>>ASSIGN  21427>>ASSIGN  21428<<ASSIGN  21428>>ASSIGN  21429>>ASSIGN  21446>>ASSIGN
     21450>>IF      21452>>ASSIGN  21453>>ASSIGN  21454<<ASSIGN  21454>>ASSIGN  21457>>IF      21459>>IF
     21462>>ASSIGN  21463<<ASSIGN  21463>>ASSIGN  21465>>ASSIGN  21466>>ASSIGN  21467<<ASSIGN  21467>>ASSIGN
     21496>>IF      21497>>IF      21501>>ASSIGN  21504<<ASSIGN  21523<<ASSIGN  21526>>ASSIGN  21527<<ASSIGN
     21527>>ASSIGN  21549>>ASSIGN  21550<<ASSIGN  21550>>ASSIGN  21553>>ASSIGN  21554>>ASSIGN  21556<<ASSIGN
     21556>>ASSIGN
CHKEOB
     21478**PROC    20391--CALL    20423--CALL    20500--CALL
CHR1
     19680**DCL     21158<<CALLBLT 21158>>CALLBLT
CMPBYTSIZ
     21335**PROC    20179--CALL    20365--CALL    20460--CALL    21219--CALL    21480--CALL    21484--CALL
     21540--CALL
CTLGNS
     20569**LABEL   20689--GOTO
DCTX$
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:240  
     16799**DCL     18734--IMP-PTR 20174>>IF      20175<<ASSIGN  20175>>ASSIGN  20185>>IF      20197>>ASSIGN
     20202>>IF      20215>>ASSIGN  20217>>ASSIGN  20217>>ASSIGN  20219>>ASSIGN  20219>>ASSIGN  20221>>ASSIGN
     20223>>IF      20223>>IF      20233>>ASSIGN  20269>>ASSIGN  20272>>ASSIGN  20290>>IF      20291<<ASSIGN
     20291>>ASSIGN  20293>>IF      20354>>IF      20355<<ASSIGN  20355>>ASSIGN  20361>>ASSIGN  20371>>IF
     20382>>ASSIGN  20383>>IF      20383>>IF      20403>>IF      20412>>ASSIGN  20413>>IF      20414>>ASSIGN
     20415>>IF      20415>>IF      20437>>IF      20437>>IF      20438>>ASSIGN  20443>>IF      20470>>ASSIGN
     20483>>ASSIGN  20485>>ASSIGN  20485>>ASSIGN  20515>>CALL    20527>>ASSIGN  20529>>IF      20538>>ASSIGN
     20539>>ASSIGN  20540>>ASSIGN  20541>>ASSIGN  20542>>ASSIGN  20545>>ASSIGN  20550>>ASSIGN  20554>>ASSIGN
     20560>>ASSIGN  20580>>IF      20581<<ASSIGN  20581>>ASSIGN  20605>>DOWHILE 20615>>ASSIGN  20617>>ASSIGN
     20626>>ASSIGN  20630>>ASSIGN  20632>>ASSIGN  20632>>ASSIGN  20633>>ASSIGN  20676>>ASSIGN  20695>>DOCASE
     20697>>DOCASE  20711>>ASSIGN  20712>>ASSIGN  20715>>ASSIGN  20719>>ASSIGN  20723>>ASSIGN  20724>>ASSIGN
     20725>>ASSIGN  20730>>IF      20731>>ASSIGN  20739>>IF      20752>>ASSIGN  20757>>ASSIGN  20758>>ASSIGN
     20759>>ASSIGN  20760>>ASSIGN  20769>>DOCASE  20774>>IF      20807>>ASSIGN  20810>>IF      20815>>ASSIGN
     20817>>CALL    20831>>IF      20831>>IF      20847>>ASSIGN  20852>>IF      20857>>ASSIGN  20861>>ASSIGN
     20864>>ASSIGN  20879>>ASSIGN  20881>>CALL    20889>>DOWHILE 20897>>IF      20899>>ASSIGN  20901>>ASSIGN
     20907>>ASSIGN  20909>>ASSIGN  20910<>CALL    20917>>CALL    20918>>IF      20919>>CALL    20921>>IF
     20921>>IF      20926>>ASSIGN  20927>>ASSIGN  20929>>IF      20931>>ASSIGN  20932>>ASSIGN  20983<<ASSIGN
     20984>>ASSIGN  21031<<ASSIGN  21032>>IF      21033<<ASSIGN  21033>>ASSIGN  21034>>ASSIGN  21043>>ASSIGN
     21088>>IF      21089<<ASSIGN  21089>>ASSIGN  21100>>IF      21101<<ASSIGN  21101>>ASSIGN  21120>>IF
     21120>>IF      21140>>ASSIGN  21151>>IF      21151>>IF      21158>>CALLBLT 21167>>ASSIGN  21180>>ASSIGN
     21185>>ASSIGN  21185>>ASSIGN  21187>>IF      21187>>IF      21189>>ASSIGN  21217>>ASSIGN  21218>>ASSIGN
     21250>>ASSIGN  21251>>ASSIGN  21256>>ASSIGN  21257>>ASSIGN  21260>>ASSIGN  21262>>ASSIGN  21264>>IF
     21267>>IF      21271>>ASSIGN  21274>>IF      21277>>ASSIGN  21281>>IF      21282>>ASSIGN  21284>>ASSIGN
     21318>>ASSIGN  21321>>IF      21322>>ASSIGN  21324>>ASSIGN  21325>>ASSIGN  21327>>ASSIGN  21327>>ASSIGN
     21328>>ASSIGN  21328>>ASSIGN  21352>>ASSIGN  21352>>ASSIGN  21353>>ASSIGN  21353>>ASSIGN  21354>>ASSIGN
     21354>>ASSIGN  21354>>ASSIGN  21354>>ASSIGN  21355>>ASSIGN  21356>>ASSIGN  21356>>ASSIGN  21357>>ASSIGN
     21357>>ASSIGN  21358>>ASSIGN  21379>>IF      21380<<ASSIGN  21380>>ASSIGN  21393>>IF      21396>>ASSIGN
     21396>>ASSIGN  21397>>ASSIGN  21398>>ASSIGN  21403>>IF      21404>>IF      21405>>ASSIGN  21406>>ASSIGN
     21410>>ASSIGN  21413>>IF      21414>>IF      21414>>IF      21417>>ASSIGN  21421>>IF      21429>>ASSIGN
     21445>>ASSIGN  21445>>ASSIGN  21446>>ASSIGN  21446>>ASSIGN  21446>>ASSIGN  21447>>IF      21448>>ASSIGN
     21449>>ASSIGN  21450>>IF      21453>>ASSIGN  21457>>IF      21459>>IF      21466>>ASSIGN  21469>>ASSIGN
     21469>>ASSIGN  21470>>IF      21496>>IF      21497>>IF      21501>>ASSIGN  21501>>ASSIGN  21504>>ASSIGN
     21520>>ASSIGN  21521>>ASSIGN  21522>>ASSIGN  21522>>ASSIGN  21523>>ASSIGN  21551>>ASSIGN  21551>>ASSIGN
     21552>>ASSIGN  21553>>ASSIGN  21554>>ASSIGN  21594>>ASSIGN  21614<<ASSIGN  21615>>ASSIGN  21624<<ASSIGN
     21629>>IF      21630>>IF      21631>>ASSIGN  21631>>ASSIGN  21633>>ASSIGN  21633>>ASSIGN  21634>>ASSIGN
     21634>>ASSIGN  21635>>ASSIGN  21636>>ASSIGN
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:241  
DONE
     21113**PROC    20190--CALL    20205--CALL    20459--CALL    21433--CALL    21471--CALL    21483--CALL
     21515--CALL    21542--CALL
DONE1 IN PROCEDURE DONE
     21137**LABEL   21234--GOTO
DONE2 IN PROCEDURE DONE
     21158**LABEL   21145--GOTO
DONE_EOF IN PROCEDURE DONE
     21233**ENTRY   21560--CALL    21568--CALL
DQ
     21628**PROC    20816--CALL    20880--CALL    21625--CALL
DVCTX
     18734**DCL     20515<>CALL    20533--ASSIGN  20540<<ASSIGN  20540>>ASSIGN  20817<>CALL    20881<>CALL
     20902--CALL    20910--CALL    20917<>CALL    20919<>CALL
DVCTX.ACCESS_METHOD
     18961**DCL     20221<<ASSIGN  20371>>IF      20403>>IF      20413>>IF      21151>>IF      21151>>IF
     21267>>IF      21274>>IF      21281>>IF      21403>>IF      21447>>IF
DVCTX.BLKRECS
     18836**DCL     21251<<ASSIGN  21469<<ASSIGN  21469>>ASSIGN  21470>>IF
DVCTX.DFR.DSCI
     18939**DCL     20918>>IF
DVCTX.DFR.EOFREC
     18940**DCL     20929>>IF      20932<<ASSIGN
DVCTX.DFRHD$
     18801**DCL     21630>>IF      21631<<ASSIGN
DVCTX.DFRTL$
     18806**DCL     21633>>ASSIGN  21634<<ASSIGN
DVCTX.DSC.VDH_FINAL
     18928**DCL     20879<<ASSIGN
DVCTX.FLAGS.BINARY_OK
     18887**DCL     20215<<ASSIGN
DVCTX.FLAGS.BRKRQD
     18893**DCL     20852>>IF      20861<<ASSIGN  20921>>IF      20926<<ASSIGN
DVCTX.FLAGS.EVFU_LOADED
     18901**DCL     20223>>IF      20269<<ASSIGN  20272<<ASSIGN
DVCTX.FLAGS.FIRST
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:242  
     18906**DCL     20725<<ASSIGN  21180<<ASSIGN  21264>>IF      21414>>IF
DVCTX.FLAGS.OTPBSY
     18910**DCL     21120>>IF
DVCTX.FLAGS.PTS_IN
     18864**DCL     20560<<ASSIGN  20758<<ASSIGN
DVCTX.FLAGS.PTS_OUT
     18870**DCL     20561<<ASSIGN  20724<<ASSIGN  21318<<ASSIGN
DVCTX.FLAGS.SUSPEND_IN
     18851**DCL     20711<<ASSIGN  20759<<ASSIGN
DVCTX.FLAGS.SUSPEND_OUT
     18858**DCL     20562<<ASSIGN  20712<<ASSIGN  20760<<ASSIGN
DVCTX.FLAGS.THROTL
     18914**DCL     21187>>IF      21189<<ASSIGN
DVCTX.HOST_BYTES_OUT
     19007**DCL     21354<<ASSIGN  21354>>ASSIGN  21446<<ASSIGN  21446>>ASSIGN
DVCTX.HOST_RECORDS_OUT
     18987**DCL     21353<<ASSIGN  21353>>ASSIGN  21445<<ASSIGN  21445>>ASSIGN
DVCTX.LASTRCBX
     18948**DCL     20185>>IF      20202>>IF      20382>>ASSIGN  20383>>IF      20412>>ASSIGN  20414>>ASSIGN
     20415>>IF      20437>>IF      20438>>ASSIGN  20443>>IF      20626<<ASSIGN  20630<<ASSIGN  20632>>ASSIGN
     21140>>ASSIGN  21158>>CALLBLT 21167>>ASSIGN  21217>>ASSIGN  21257<<ASSIGN  21260<<ASSIGN  21262>>ASSIGN
     21271<<ASSIGN  21277<<ASSIGN  21282>>ASSIGN  21284>>ASSIGN  21352>>ASSIGN  21354>>ASSIGN  21356<<ASSIGN
     21393>>IF      21396>>ASSIGN  21397>>ASSIGN  21398<<ASSIGN  21404>>IF      21405>>ASSIGN  21406>>ASSIGN
     21410>>ASSIGN  21413>>IF      21414>>IF      21417<<ASSIGN  21421>>IF      21429<<ASSIGN  21446>>ASSIGN
     21448>>ASSIGN  21449>>ASSIGN  21450>>IF      21453<<ASSIGN  21457>>IF      21459>>IF      21466<<ASSIGN
     21551>>ASSIGN  21552>>ASSIGN  21553>>ASSIGN  21554<<ASSIGN
DVCTX.LASTSCBX
     18943**DCL     20197<<ASSIGN  20361<<ASSIGN  20383>>IF      20415>>IF      20437>>IF      20470<<ASSIGN
     20483>>ASSIGN  20485<<ASSIGN  20485>>ASSIGN  20617<<ASSIGN  20632<<ASSIGN  20633>>ASSIGN  21218<<ASSIGN
     21256<<ASSIGN  21354>>ASSIGN  21355>>ASSIGN  21356>>ASSIGN  21357<<ASSIGN  21357>>ASSIGN  21358>>ASSIGN
     21496>>IF      21497>>IF      21501>>ASSIGN  21501>>ASSIGN  21504>>ASSIGN  21520>>ASSIGN  21521>>ASSIGN
     21522<<ASSIGN  21522>>ASSIGN  21523>>ASSIGN
DVCTX.LCLENDPNTID
     18756**DCL     20676--ASSIGN  21594--ASSIGN
DVCTX.LCLENDPNTID.TERM
     18758**DCL     18767--REDEF
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:243  
DVCTX.LIN$
     18785**DCL     20984>>ASSIGN  21034>>ASSIGN  21615>>ASSIGN
DVCTX.LINE_BYTES_OUT
     19017**DCL     21328<<ASSIGN  21328>>ASSIGN
DVCTX.LINE_RECORDS_OUT
     18997**DCL     21327<<ASSIGN  21327>>ASSIGN
DVCTX.LNK$
     18735**DCL     20175>>ASSIGN  20291>>ASSIGN  20355>>ASSIGN  20541<<ASSIGN  20541>>ASSIGN  20542<<ASSIGN
     20581>>ASSIGN  20605>>DOWHILE 20606>>ASSIGN  20891>>ASSIGN  20899>>ASSIGN  20901<<ASSIGN  20901>>ASSIGN
     20907<<ASSIGN  20907>>ASSIGN  20909>>ASSIGN  21033>>ASSIGN  21089>>ASSIGN  21101>>ASSIGN  21380>>ASSIGN
DVCTX.MGR_TYPE
     18953**DCL     18955--REDEF   20174>>IF      20290>>IF      20293>>IF      20354>>IF      20529>>IF
     20580>>IF      20695>>DOCASE  20769>>DOCASE  20897>>IF      21032>>IF      21088>>IF      21100>>IF
     21379>>IF
DVCTX.MGR_TYPE_B
     18955**DCL     20217<<ASSIGN  20217>>ASSIGN  20219<<ASSIGN  20219>>ASSIGN
DVCTX.OTPBYTES
     18810**DCL     21185<<ASSIGN  21185>>ASSIGN  21187>>IF
DVCTX.OTPHD$
     18790**DCL     21120>>IF      21321>>IF      21322<<ASSIGN  21629>>IF      21631>>ASSIGN  21633>>ASSIGN
     21635<<ASSIGN
DVCTX.OTPTL$
     18796**DCL     21324>>ASSIGN  21325<<ASSIGN  21634>>ASSIGN  21636<<ASSIGN
DVCTX.RCB_CODE
     18971**DCL     20223>>IF      20544<<ASSIGN  20545<<ASSIGN  20549<<ASSIGN  20550<<ASSIGN  20553<<ASSIGN
     20554<<ASSIGN  20715>>ASSIGN  20752>>ASSIGN  20847>>ASSIGN  21352>>ASSIGN  21396>>ASSIGN  21551>>ASSIGN
DVCTX.STATE
     18773**DCL     20527<<ASSIGN  20539<<ASSIGN  20697>>DOCASE  20719<<ASSIGN  20723<<ASSIGN  20730>>IF
     20731<<ASSIGN  20739>>IF      20757<<ASSIGN  20774>>IF      20807<<ASSIGN  20810>>IF      20815<<ASSIGN
     20831>>IF      20831>>IF      20857<<ASSIGN  20864<<ASSIGN  20921>>IF      20927<<ASSIGN  20931<<ASSIGN
DVCTX.SUSBIT_MASK
     18966**DCL     20538<<ASSIGN
ENDSTR
     21350**PROC    20385--CALL    20417--CALL    20439--CALL
ESCSZ
     20131**DCL     21414>>IF
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:244  
EVENT IN PROCEDURE REPCLMEVT
     21582**DCL     21580--PROC    21589>>ASSIGN  21593--ENTRY
FINOTP0 IN PROCEDURE FINOTPBFR
     21427**LABEL   21407--GOTO
FINOTPBF2 IN PROCEDURE FINOTPBFR
     21387**ENTRY   20187--CALL    20203--CALL
FINOTPBFR
     21364**PROC    20317--CALL    20327--CALL
FNC_CASE
     20156**LABEL   20225--EXIT    20302--EXIT
FPT@WRSYSLOG
     19712**DCL     20672>>ASSIGN  20955>>ASSIGN
FPT@WRSYSLOG.V
     19716**DCL     19714--DCLINIT
FPT@WRSYSLOG.V.TERMID.TERM
     19781**DCL     19790--REDEF
FPT_WRSYSLOG
     16837**DCL     20672<<ASSIGN  20677<>CALL    20955<<ASSIGN  20959<>CALL
FPT_WRSYSLOG.BUF_
     16839**DCL     20676<<ASSIGN
FPT_WRSYSLOG.V.ERRCODE.ERR#
     16885**DCL     20673<<ASSIGN  20956<<ASSIGN
FPT_WRSYSLOG.V.TERMID
     16904**DCL     20674<<ASSIGN  20957<<ASSIGN
FPT_WRSYSLOG.V.TERMID.TERM
     16906**DCL     16915--REDEF
FPT_WRSYSLOG.V.VALUES
     16917**DCL     20675<<ASSIGN  20958<<ASSIGN
GETOTP1
     20197**LABEL   20191--GOTO
GET_BFR
     21241**PROC    20177--CALL    20306--CALL    20357--CALL    20582--CALL    20705--CALL    20744--CALL
     20839--CALL    21126--CALL    21538--CALL
I
     16806**DCL     20308<<DOINDEX 20309>>ASSIGN  20388<<ASSIGN  20405<<ASSIGN  20407<<ASSIGN  20409<<ASSIGN
     20414>>ASSIGN  20422>>ASSIGN  20444<<ASSIGN  20453<<ASSIGN  20455<<ASSIGN  20458>>IF      20462>>DOINDEX
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:245  
     20468>>ASSIGN  20474>>ASSIGN  20483>>ASSIGN  20490>>ASSIGN  20495>>ASSIGN  20883<<ASSIGN  20884<>CALL
     21449>>ASSIGN  21553<<ASSIGN  21555>>IF      21563<<ASSIGN  21570<<ASSIGN  21571<>CALL
INITPRM
     20978**PROC    20147--CALL    20790--CALL    20803--CALL    21083--CALL    21099--CALL    21378--CALL
INIT_BFR IN PROCEDURE GET_BFR
     21246**ENTRY   20654--CALL    21130--CALL    21215--CALL
IRS
     16814**DCL     20986<<ASSIGN  20988<<ASSIGN  21427>>ASSIGN  21452>>ASSIGN  21465>>ASSIGN
J
     16805**DCL     20180>>ASSIGN  20458>>IF      20468<<ASSIGN  20468>>ASSIGN  20474<<ASSIGN  20474>>ASSIGN
     20484<<ASSIGN  20484>>ASSIGN  20491<<ASSIGN  20491>>ASSIGN  21140<<ASSIGN  21143>>IF      21148<<ASSIGN
     21151>>IF      21151>>IF      21158>>CALLBLT 21158>>CALLBLT 21165<<ASSIGN  21216>>IF      21217>>ASSIGN
     21220>>IF      21225>>ASSIGN  21339<<ASSIGN  21342<<ASSIGN  21342>>ASSIGN  21343>>IF      21344<<ASSIGN
     21402<<ASSIGN  21414>>IF      21481>>ASSIGN  21485>>ASSIGN  21514>>IF      21516<<ASSIGN  21528<<ASSIGN
     21528>>ASSIGN  21541>>IF      21543<<ASSIGN
K
     16809**DCL     20370<<DOINDEX 20401<<ASSIGN  20402>>DOWHILE 20404>>IF      20407>>ASSIGN  20422<<ASSIGN
     20422>>ASSIGN  20429<<ASSIGN  20430>>DOWHILE 20449<<ASSIGN  20451>>DOWHILE 20452>>IF      20455>>ASSIGN
     20495<<ASSIGN  20495>>ASSIGN
KH$CHN.BLOCK
     17266**DCL     21187>>IF
KH$CHN.TERMID.TERM
     17286**DCL     17295--REDEF
KHA$ERRLOG
     16792**DCL-ENT 20677--CALL    20959--CALL
KHI$DISABLE
     16793**DCL-ENT 20152--CALL    21037--CALL    21086--CALL
KHI$ENABLE
     16794**DCL-ENT 20945--CALL    21065--CALL
KV$MRD.DVCCLM
     17470**DCL     20396<<ASSIGN  20424<<ASSIGN  20429>>ASSIGN  20448<<ASSIGN  20501<<ASSIGN  20618<<ASSIGN
     20727<<ASSIGN  21389<<ASSIGN
KV$MRD.DVCLIN
     17470**DCL     20377>>ASSIGN  20395<<ASSIGN  20401>>ASSIGN  20425<<ASSIGN
KV$MRD.LNG
     17452**DCL     20377>>ASSIGN
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:246  
KV$MRD.MINSP_FORPST
     17450**DCL     20583<<ASSIGN  20663<<ASSIGN
KV$MVD.TRNTBL$
     18099**DCL     20463>>ASSIGN  21521>>ASSIGN  21526>>ASSIGN
KV$OTPMRK
     17838**DCL     20309--ASSIGN  20311<<ASSIGN  20321--ASSIGN  20322<<ASSIGN  21137--ASSIGN  21243--ASSIGN
KV$OTPMRK.ID
     17843**DCL     17843--REDEF   17844--REDEF
KV$OTPMRK.MSTRTR
     17842**DCL     20310>>IF
KV$PTR.INPCNDPND
     17410**DCL     17419--REDEF   17423--REDEF
KV$PTR.LINLST$
     17406**DCL     17407--REDEF
KV$PTR.MRD$
     17405**DCL     20377>>ASSIGN  20377>>ASSIGN  20395>>ASSIGN  20396>>ASSIGN  20401>>ASSIGN  20424>>ASSIGN
     20425>>ASSIGN  20429>>ASSIGN  20448>>ASSIGN  20501>>ASSIGN  20583>>ASSIGN  20618>>ASSIGN  20663>>ASSIGN
     20727>>ASSIGN  21389>>ASSIGN
KV$PTR.MVD$
     17405**DCL     20463>>ASSIGN  21521>>ASSIGN  21526>>ASSIGN
KV$PTR.SRD$
     17406**DCL     20226>>ASSIGN  20619>>ASSIGN  20728>>ASSIGN
KV$PTR.VDI$
     17404**DCL     20271>>IF      20273>>ASSIGN  20584>>ASSIGN  20590>>ASSIGN  20591>>ASSIGN  20601>>ASSIGN
     20602>>ASSIGN  20610>>ASSIGN  20611>>ASSIGN  20622>>ASSIGN  20634>>ASSIGN  20635>>ASSIGN  20642>>IF
     20786>>IF      20799>>IF      20980>>ASSIGN  20981>>ASSIGN  20982>>ASSIGN  20983>>ASSIGN  20996>>ASSIGN
     20997>>ASSIGN  20998>>ASSIGN  21095>>IF      21196>>IF      21197>>ASSIGN  21198>>IF      21374>>IF
KV$PTR$
     17398**DCL     17404--IMP-PTR 20226>>ASSIGN  20271>>IF      20273>>ASSIGN  20377>>ASSIGN  20377>>ASSIGN
     20395>>ASSIGN  20396>>ASSIGN  20401>>ASSIGN  20424>>ASSIGN  20425>>ASSIGN  20429>>ASSIGN  20448>>ASSIGN
     20463>>ASSIGN  20501>>ASSIGN  20583>>ASSIGN  20584>>ASSIGN  20590>>ASSIGN  20591>>ASSIGN  20601>>ASSIGN
     20602>>ASSIGN  20610>>ASSIGN  20611>>ASSIGN  20618>>ASSIGN  20619>>ASSIGN  20622>>ASSIGN  20634>>ASSIGN
     20635>>ASSIGN  20642>>IF      20663>>ASSIGN  20727>>ASSIGN  20728>>ASSIGN  20786>>IF      20799>>IF
     20980>>ASSIGN  20981>>ASSIGN  20982>>ASSIGN  20983>>ASSIGN  20996>>ASSIGN  20997>>ASSIGN  20998>>ASSIGN
     21095>>IF      21196>>IF      21197>>ASSIGN  21198>>IF      21374>>IF      21389>>ASSIGN  21521>>ASSIGN
     21526>>ASSIGN
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:247  
KV$SRD.BTMRHT
     17590**DCL     17595--REDEF
KV$SRD.CRT
     17666**DCL     17671--REDEF
KV$SRD.FLDEND
     17630**DCL     17635--REDEF
KV$SRD.HI_NONBLN
     17700**DCL     17705--REDEF
KV$SRD.LNG
     17598**DCL     20226>>ASSIGN
KV$SRD.ORG
     17522**DCL     17527--REDEF
KV$SRD.SRDEND
     17735**DCL     17740--REDEF
KV$SRD.TOPLFT
     17556**DCL     17561--REDEF
KV$SRD.VRTPSTOK
     17599**DCL     20619<<ASSIGN  20728<<ASSIGN
KV$TRNTBL.OTPESCCHR
     18170**DCL     18170--REDEF
KV$TRNTBL.SP_CHR
     18172**DCL     20463>>ASSIGN  21521>>ASSIGN  21526>>ASSIGN
KV$USR_DAT.FNC
     17319**DCL     20156>>DOCASE
KV$USR_EVT.ID
     17879**DCL     20519>>DOCASE
KV$USR_EVT.PRM
     17879**DCL     20675>>ASSIGN
KV$USR_OTPMRK.CMPOTP
     17984**DCL     20324>>IF
KV$USR_OTPMRK.DAT
     18006**DCL     20300>>ASSIGN  20311>>ASSIGN  20322>>ASSIGN
KV$USR_OTPMRK.DAT.ID
     18009**DCL     18009--REDEF   18010--REDEF
KV$USR_OTPMRK.DAT.MSTRTR
     18008**DCL     20293>>IF      20307>>IF
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:248  
KV$USR_PST.PHSPST
     17941**DCL     17946--REDEF
KV$USR_PST.PHSPST.CLM
     17943**DCL     20429>>ASSIGN  20449>>ASSIGN  20501>>ASSIGN
KV$USR_PST.PHSPST.LIN
     17943**DCL     20401>>ASSIGN  20425>>ASSIGN
KV$USR_PST.TOPPAGCNT
     17914**DCL     20369>>IF      20370>>DOINDEX
KV$USR_SETPRM.PRMID
     18046**DCL     20209>>DOCASE
KV$USR_SETPRM.VAL
     18046**DCL     20215>>ASSIGN  20217>>ASSIGN  20219>>ASSIGN  20221>>ASSIGN
KV$VDH_EVT
     16946**DCL     20858<<ASSIGN  20860<>CALL    20923<<ASSIGN  20925<>CALL
KV$VDH_EVT.PRM
     16952**DCL     20859<<ASSIGN  20924<<ASSIGN
KV$VDH_OTPLCL
     17134**DCL     20620<<ASSIGN  20623<>CALL
KV$VDH_OTPLCL.BFR_.ADR$
     17167**DCL     20621<<ASSIGN
KV$VDH_OTPLCL.BFR_.BYTSIZ
     17167**DCL     20622<<ASSIGN
KV$VDH_OTPMRK
     16981**DCL     20299<<ASSIGN  20301<>CALL
KV$VDH_OTPMRK.DAT
     17008**DCL     20300<<ASSIGN
KV$VDH_OTPMRK.DAT.ID
     17011**DCL     17011--REDEF   17012--REDEF
KV$VDI.OTPBFR_.ADR$
     17795**DCL     20584<<ASSIGN  20980>>ASSIGN  20996<<ASSIGN
KV$VDI.OTPBFR_.BYTSIZ
     17795**DCL     20591<<ASSIGN  20602<<ASSIGN  20611<<ASSIGN  20622>>ASSIGN  20635<<ASSIGN  20982>>ASSIGN
     20998<<ASSIGN
KV$VDI.OTPBFR_.BYTX
     17795**DCL     20590<<ASSIGN  20601<<ASSIGN  20610<<ASSIGN  20634<<ASSIGN  20981>>ASSIGN  20997<<ASSIGN
KV$VDI.OTPCNDPND
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:249  
     17806**DCL     20642>>IF      20786>>IF      20799>>IF      21095>>IF      21374>>IF
KV$VDI.RQSOTP
     17805**DCL     21196>>IF      21197<<ASSIGN
KV$VDI.SSNCNT
     17798**DCL     21198>>IF
KV$VDI.UN_KNWPST
     17808**DCL     20271>>IF      20273<<ASSIGN
KV$VDI.USRCTX$
     17769**DCL     20983>>ASSIGN
KVB$GET2NSYS
     16786**DCL-ENT 20230--CALL    21040--CALL    21138--CALL    21244--CALL
KVB$GETSYS
     16784**DCL-ENT 20534--CALL
KVB$RLS
     16785**DCL-ENT 20902--CALL    20910--CALL
KVB$RLS2NSYS
     16787**DCL-ENT 20884--CALL    21571--CALL
KVV$VDI
     16795**DCL-ENT 20301--CALL    20623--CALL    20636--CALL    20643--CALL    20787--CALL    20800--CALL
     20860--CALL    20925--CALL    21096--CALL    21199--CALL    21375--CALL
KV_VDH_EVT
     19903**DCL     20858>>ASSIGN  20923>>ASSIGN
KV_VDH_EVT_CMPOTP
     16602**DCL     20643<>CALL    20787<>CALL    20800<>CALL    21096<>CALL    21375<>CALL
KV_VDH_EVT_RQSOTP
     16699**DCL     21199<>CALL
KV_VDH_OTPLCL
     19947**DCL     20620>>ASSIGN
KV_VDH_OTPMRK
     16637**DCL     20299>>ASSIGN
KV_VDH_OTPMRK.DAT.ID
     16667**DCL     16667--REDEF   16668--REDEF
KV_VDH_PST_CR_VRT
     16734**DCL     20636<>CALL
KV_VDH_PST_CR_VRT.PSTVAL
     16772**DCL     16777--REDEF
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:250  
KZ$EVENT
     17030**DCL     21587<<ASSIGN  21591<>CALL
KZ$EVENT.EVENT
     17031**DCL     21589<<ASSIGN
KZ$EVENT.LINCTX$
     17037**DCL     21590<<ASSIGN
KZ$EVENT.TERMID$
     17040**DCL     21588<<ASSIGN
KZ$HASPBLK
     19046**DCL     20185--IF      20629--ASSIGN  20709--ASSIGN  20748--ASSIGN  20843--ASSIGN  21039--ASSIGN
     21102--IF      21115--IF      21144--ASSIGN  21254--ASSIGN
KZ$HASPBLK.FLG
     19061**DCL     20589<<ASSIGN
KZ$HASPBLK.FLG.RCB
     19062**DCL     20714<<ASSIGN  20751<<ASSIGN  20846<<ASSIGN
KZ$HASPBLK.FLG.SRCB
     19063**DCL     20715<<ASSIGN  20752<<ASSIGN  20847<<ASSIGN
KZ$HASPBLK.TXT
     19064**DCL     20716<<ASSIGN  20717<<ASSIGN  20753<<ASSIGN  20754<<ASSIGN  20848<<ASSIGN  20849<<ASSIGN
KZ$HASPRCB
     19126**DCL     21170<<ASSIGN  21352<<ASSIGN  21396<<ASSIGN  21551<<ASSIGN
KZ$HASPSCB
     19079**DCL     20483<<ASSIGN  21355<<ASSIGN  21501<<ASSIGN  21520<<ASSIGN  21521<<ASSIGN
KZ$HASPSCB.I
     19081**DCL     19085--REDEF
KZ$HASPSRCB
     19102**DCL     20382<<ASSIGN  20412<<ASSIGN  20438<<ASSIGN  21397<<ASSIGN  21552<<ASSIGN
KZ$HASPSRCB.S.UPSP_CT
     19111**DCL     20414<<ASSIGN
KZ$HASPSRCB.SKIP_TO
     19108**DCL     19109--REDEF
KZ$HASPSRCB.VFC_TYPE
     19104**DCL     19105--REDEF
KZ$LINCTX.CHN$
     18239**DCL     21187>>IF
KZ$LINCTX.CTRHD$
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:251  
     18237**DCL     20604--ASSIGN  20888>>ASSIGN  20909<<ASSIGN  20911>>IF
KZ$LINCTX.CURDEV$
     18535**DCL     20604<<ASSIGN  20605>>DOWHILE 20606<<ASSIGN  20606>>ASSIGN  20615<<ASSIGN  20835<<ASSIGN
     20896<<ASSIGN
KZ$LINCTX.FLAGS.DSC
     18344**DCL     20873>>IF
KZ$LINCTX.FLAGS.RJCT
     18394**DCL     20575>>IF      20688<<ASSIGN
KZ$LINCTX.FLAGS.SND
     18387**DCL     20614<<ASSIGN  20722<<ASSIGN
KZ$LINCTX.INHLVL
     18397**DCL     20151>>ASSIGN  20943>>IF      21036>>ASSIGN  21063>>IF      21085>>ASSIGN
KZ$LINCTX.LINID
     18257**DCL     20674>>ASSIGN  20957>>ASSIGN  21586--ASSIGN
KZ$LINCTX.LINID.TERM
     18259**DCL     18268--REDEF
KZ$LINCTX.OTPCNT
     18524**DCL     18527--REDEF
KZ$LINCTX.POLSIZ
     18570**DCL     18572--REDEF   20569<<ASSIGN  20569>>ASSIGN  20570>>IF
KZ$LINCTX.POLX
     18590**DCL     20570>>IF
KZ$LINCTX.PRO.BLKBYTES
     18427**DCL     20600>>ASSIGN  21137>>ASSIGN  21185>>ASSIGN  21243>>ASSIGN  21296>>ASSIGN  21339>>ASSIGN
KZ$LINCTX.PRO.BLKRECS
     18423**DCL     21251>>ASSIGN
KZ$LINCTX.PRO.COMPRESS
     18440**DCL     20456>>IF
KZ$LINCTX.PRO.EMCHR
     18458**DCL     21421>>IF      21424>>ASSIGN  21459>>IF      21462>>ASSIGN
KZ$LINCTX.PRO.IRSCHR
     18461**DCL     20986>>ASSIGN
KZ$LINCTX.PRO.PROTYP
     18420**DCL     20181>>IF      20181>>IF      20358>>IF      20358>>IF      20380>>IF      20380>>IF
     20410>>IF      20410>>IF      20435>>IF      20435>>IF      20456>>IF      20466>>IF      20466>>IF
     20478>>IF      20478>>IF      20502>>IF      20502>>IF      20543>>IF      20585>>IF      20585>>IF
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:252  
     20588>>IF      20624>>IF      20646>>IF      20702>>IF      20702>>IF      20741>>IF      20741>>IF
     20833>>IF      20833>>IF      20837>>IF      20985>>IF      21115>>IF      21115>>IF      21141>>IF
     21141>>IF      21168>>IF      21168>>IF      21172>>IF      21220>>IF      21220>>IF      21252>>IF
     21252>>IF      21266>>IF      21297>>IF      21297>>IF      21340>>IF      21340>>IF      21390>>IF
     21390>>IF      21402>>ASSIGN  21421>>IF      21459>>IF      21518>>IF      21518>>IF      21546>>IF
     21546>>IF
KZ$LINCTX.PRO.RMTSS$
     18464**DCL     20578>>IF      20621>>ASSIGN  20652>>ASSIGN  21047>>ASSIGN
KZ$LINCTX.PRO.RRR
     18509**DCL     20293>>IF      20775>>IF
KZ$LINCTX.PRO.SLAVE
     18475**DCL     20548>>IF      21261>>IF      21402>>ASSIGN
KZ$LINCTX.PRO.SLC
     18512**DCL     21264>>IF
KZ$LINCTX.PRO.SLCALLBLK
     18515**DCL     21264>>IF
KZ$NJE_SIGNON
     19144**DCL     20598<<ASSIGN  20625--ASSIGN  20652<<ASSIGN  20652>>ASSIGN  21039--ASSIGN  21047<<ASSIGN
     21047>>ASSIGN
KZ$NJE_SIGNON.NCC
     19147**DCL     20626--ASSIGN
KZ$NJE_SIGNON.NCC.IBFSZ
     19188**DCL     20600<<ASSIGN
KZ$NJE_SIGNON.NCC.IDL
     19157**DCL     20601--ASSIGN  21059>>ASSIGN
KZ$NJE_SIGNON.NCC.IEVNT
     19176**DCL     21056<<ASSIGN
KZ$NJE_SIGNON.NCC.ILPAS_INIT
     19195**DCL     19196--REDEF
KZ$NJE_SIGNON.NCC.INODE
     19162**DCL     20602--ASSIGN
KZ$NJE_SIGNON.NCC.INODE_INIT
     19161**DCL     19162--REDEF
KZ$NJE_SIGNON.NCC.INPAS_INIT
     19199**DCL     19200--REDEF
KZ$NJE_SIGNON.NCC.IREST
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:253  
     19182**DCL     20599<<ASSIGN
KZ$NJE_SIGNON.NCC.SRCB
     19151**DCL     21055<<ASSIGN
KZ$OTPBFR
     18667**DCL     20185--IF      20202--IF      20229--ASSIGN  20231<<ASSIGN  20234--ASSIGN  20587--ASSIGN
     20610--ASSIGN  20612--ASSIGN  20713--ASSIGN  20750--ASSIGN  20820<>CALL    20845--ASSIGN  21039--ASSIGN
     21041<<ASSIGN  21046--ASSIGN  21102--IF      21115--IF      21115--IF      21122<>CALL    21137--ASSIGN
     21144--ASSIGN  21150--ASSIGN  21177--ASSIGN  21243--ASSIGN  21248<<ASSIGN  21254--ASSIGN  21260--ASSIGN
     21268--ASSIGN  21270--ASSIGN  21271--ASSIGN  21275--ASSIGN  21276--ASSIGN  21277--ASSIGN  21296--ASSIGN
     21339--ASSIGN  21414--IF      21416--ASSIGN  21417--ASSIGN
KZ$OTPBFR.BFRSIZ
     18710**DCL     20232<<ASSIGN  20309>>ASSIGN  20321>>ASSIGN  20653>>ASSIGN  20883>>ASSIGN  21042<<ASSIGN
     21129>>ASSIGN  21139<<ASSIGN  21214>>ASSIGN  21249<<ASSIGN  21570>>ASSIGN
KZ$OTPBFR.DATA_SIZ
     18708**DCL     20264<<ASSIGN  20625<<ASSIGN  20629<<ASSIGN  20709<<ASSIGN  20748<<ASSIGN  20843<<ASSIGN
     21059<<ASSIGN  21177<<ASSIGN  21179>>IF      21328>>ASSIGN
KZ$OTPBFR.DEV$
     18718**DCL     20233<<ASSIGN  21043<<ASSIGN  21250<<ASSIGN
KZ$OTPBFR.FLAGS.CNT#
     18682**DCL     21178<<ASSIGN
KZ$OTPBFR.FLAGS.HALT
     18688**DCL     21314<<ASSIGN
KZ$OTPBFR.FLAGS.LAST#
     18678**DCL     20613<<ASSIGN  20779<<ASSIGN  21559<<ASSIGN  21564<<ASSIGN  21567>>IF
KZ$OTPBFR.FLAGS.RELOTPBFR
     18693**DCL     21121<<ASSIGN
KZ$OTPBFR.LNK$
     18668**DCL     21324<<ASSIGN  21326<<ASSIGN  21633<<ASSIGN
KZ$OTPBFR.MRKCNT
     18715**DCL     20307>>IF      20308>>DOINDEX 20316>>IF      20320<<ASSIGN  20320>>ASSIGN  20321>>ASSIGN
     21119>>IF
KZ$OTPBFR.TYP
     18670**DCL     20819<<ASSIGN
KZ$SYNCSTAT.ACTSTR
     19616**DCL     20526<<ASSIGN  20526>>ASSIGN  20565<<ASSIGN  20565>>ASSIGN  20895<<ASSIGN  20895>>ASSIGN
     20898<<ASSIGN  20898>>ASSIGN
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:254  
KZ$SYNCSTAT.REQSTATS.DSPMSK
     19502**DCL     19508--REDEF
KZ$SYNCSTAT.REQSTATS.SLCMSK
     19543**DCL     19550--REDEF
KZD_MINSP_FORPST
     20130**DCL     20663>>ASSIGN
KZR$DFR
     16790**DCL-ENT 20515--CALL    20817--CALL    20881--CALL    20917--CALL
KZR$DSC_CONT
     16789**DCL-ENT 20919--CALL
KZR$RELOTPBFR
     16788**DCL-ENT 20820--CALL    21122--CALL
KZR_CNCDSC@
     16791**DCL     21591>>CALL
KZ_EVENT
     19808**DCL     21587>>ASSIGN
KZ_HASP_HDR.STTBFR$
     19641**DCL     20526>>ASSIGN  20526>>ASSIGN  20565>>ASSIGN  20565>>ASSIGN  20895>>ASSIGN  20895>>ASSIGN
     20898>>ASSIGN  20898>>ASSIGN
KZ_NJE_SIGNON
     19997**DCL     20598>>ASSIGN
KZ_NJE_SIGNON.NCC
     20000**DCL     20010--DCLINIT
KZ_NJE_SIGNON.NCC.ILPAS_INIT
     20048**DCL     20049--REDEF
KZ_NJE_SIGNON.NCC.INODE_INIT
     20014**DCL     20015--REDEF
KZ_NJE_SIGNON.NCC.INPAS_INIT
     20052**DCL     20053--REDEF
KZ_OTPBFR
     20075**DCL     20231>>ASSIGN  21041>>ASSIGN  21248>>ASSIGN
KZ_SLCCHR2780PNC
     20140**DCL     21276>>ASSIGN
KZ_SLCCHR3780PNC1
     20141**DCL     21268>>ASSIGN
KZ_SLCCHR3780PRN
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:255  
     20143**DCL     21270>>ASSIGN
L
     16810**DCL     20462<<DOINDEX 21144<<ASSIGN  21150<<ASSIGN  21158>>CALLBLT
LCTX$
     16800**DCL     18236--IMP-PTR 20151>>ASSIGN  20181>>IF      20181>>IF      20293>>IF      20358>>IF
     20358>>IF      20380>>IF      20380>>IF      20410>>IF      20410>>IF      20435>>IF      20435>>IF
     20456>>IF      20456>>IF      20466>>IF      20466>>IF      20478>>IF      20478>>IF      20502>>IF
     20502>>IF      20543>>IF      20548>>IF      20569>>ASSIGN  20569>>ASSIGN  20570>>IF      20570>>IF
     20575>>IF      20578>>IF      20585>>IF      20585>>IF      20588>>IF      20600>>ASSIGN  20604>>ASSIGN
     20604>>ASSIGN  20605>>DOWHILE 20606>>ASSIGN  20606>>ASSIGN  20614>>ASSIGN  20615>>ASSIGN  20621>>ASSIGN
     20624>>IF      20646>>IF      20652>>ASSIGN  20674>>ASSIGN  20688>>ASSIGN  20702>>IF      20702>>IF
     20722>>ASSIGN  20741>>IF      20741>>IF      20775>>IF      20833>>IF      20833>>IF      20835>>ASSIGN
     20837>>IF      20873>>IF      20888>>ASSIGN  20896>>ASSIGN  20909>>ASSIGN  20911>>IF      20943>>IF
     20957>>ASSIGN  20984<<ASSIGN  20985>>IF      20986>>ASSIGN  21034<<ASSIGN  21036>>ASSIGN  21047>>ASSIGN
     21063>>IF      21085>>ASSIGN  21115>>IF      21115>>IF      21137>>ASSIGN  21141>>IF      21141>>IF
     21168>>IF      21168>>IF      21172>>IF      21185>>ASSIGN  21187>>IF      21220>>IF      21220>>IF
     21243>>ASSIGN  21251>>ASSIGN  21252>>IF      21252>>IF      21261>>IF      21264>>IF      21264>>IF
     21266>>IF      21296>>ASSIGN  21297>>IF      21297>>IF      21339>>ASSIGN  21340>>IF      21340>>IF
     21390>>IF      21390>>IF      21402>>ASSIGN  21402>>ASSIGN  21421>>IF      21421>>IF      21424>>ASSIGN
     21459>>IF      21459>>IF      21462>>ASSIGN  21518>>IF      21518>>IF      21546>>IF      21546>>IF
     21586>>ASSIGN  21590>>ASSIGN  21615<<ASSIGN
LEV
     16813**DCL     20151<<ASSIGN  20152<>CALL    20943>>IF      21036<<ASSIGN  21037<>CALL    21063>>IF
     21085<<ASSIGN  21086<>CALL
M
     16811**DCL     20372<<ASSIGN  20376<<ASSIGN  20382>>ASSIGN
M$XXX
     15922**DCL-ENT 21497--CALL
MRKRX
     20324**LABEL   20312--GOTO
N
     16812**DCL     20373<<ASSIGN  20377<<ASSIGN  20379>>DOWHILE 20392<<ASSIGN  20392>>ASSIGN
NOBUF
     20955**LABEL   20177--CALLALT 20187--CALLALT 20190--CALLALT 20203--CALLALT 20205--CALLALT 20230--CALLALT
     20306--CALLALT 20317--CALLALT 20327--CALLALT 20357--CALLALT 20384--CALLALT 20389--CALLALT 20391--CALLALT
     20416--CALLALT 20420--CALLALT 20423--CALLALT 20445--CALLALT 20459--CALLALT 20500--CALLALT 20534--CALLALT
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:256  
     20582--CALLALT 20705--CALLALT 20744--CALLALT 20805--CALLALT 20839--CALLALT 21040--CALLALT
NOBUF IN PROCEDURE BLDBLNKSTR
     21531**LABEL   21515--CALLALT
NOBUF IN PROCEDURE BLDEOFRC
     21574**LABEL   21538--CALLALT 21542--CALLALT 21560--CALLALT 21565--CALLALT 21568--CALLALT
NOBUF IN PROCEDURE BLDUPSPCREC
     21473**LABEL   21451--CALLALT 21458--CALLALT 21471--CALLALT
NOBUF IN PROCEDURE CHKEOB
     21488**LABEL   21483--CALLALT
NOBUF IN PROCEDURE DONE
     21236**LABEL   21126--CALLALT 21138--CALLALT
NOBUF IN PROCEDURE FINOTPBFR
     21435**LABEL   21433--CALLALT
NOBUF IN PROCEDURE GET_BFR
     21304**LABEL   21244--CALLALT
OTPMRK0
     20327**LABEL   21103--GOTO
P$ IN PROCEDURE REPCLMEVT
     21584**DCL     21586<<ASSIGN  21588>>ASSIGN  21594<<ASSIGN
PAGLNG
     16819**DCL     20226<<ASSIGN  20227>>IF      20227>>IF      20228<<ASSIGN  20229>>ASSIGN  20237>>DOINDEX
     20261>>ASSIGN  20263>>ASSIGN  20264>>ASSIGN
PARM
     16570**DCL        21--PROC    20146--ASSIGN  21013--ENTRY   21027--ENTRY   21031--ASSIGN  21612--ENTRY
     21614--ASSIGN  21623--ENTRY   21624--ASSIGN
PARM$
     16798**DCL     17315--IMP-PTR 17873--IMP-PTR 17908--IMP-PTR 17978--IMP-PTR 18040--IMP-PTR 20146<<ASSIGN
     20156>>DOCASE  20209>>DOCASE  20215>>ASSIGN  20217>>ASSIGN  20219>>ASSIGN  20221>>ASSIGN  20293>>IF
     20300>>ASSIGN  20307>>IF      20311>>ASSIGN  20322>>ASSIGN  20324>>IF      20369>>IF      20370>>DOINDEX
     20401>>ASSIGN  20425>>ASSIGN  20429>>ASSIGN  20449>>ASSIGN  20501>>ASSIGN  20519>>DOCASE  20675>>ASSIGN
QCNTL_BFR
     21312**PROC    20710--CALL    20749--CALL    20844--CALL
QSGNON_BFR IN PROCEDURE QCNTL_BFR
     21316**ENTRY   20657--CALL    21061--CALL
QUEUE_BFR IN PROCEDURE QCNTL_BFR
     21319**ENTRY   20267--CALL    21125--CALL    21211--CALL
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:257  
REPCLM01 IN PROCEDURE REPCLMEVT
     21587**LABEL   21595--GOTO
REPCLMEVT
     21580**PROC    20576--CALL    20661--CALL    20874--CALL    20912--CALL    20969--CALL
REPCLMEVT_DEV IN PROCEDURE REPCLMEVT
     21593**ENTRY   20905--CALL
SET_SCB
     21494**PROC    20189--CALL    20194--CALL    20360--CALL    20469--CALL    21392--CALL    21548--CALL
SGN$
     16815**DCL     21040<>CALL    21041>>ASSIGN  21042>>ASSIGN  21043>>ASSIGN  21046>>ASSIGN  21059>>ASSIGN
     21060>>ASSIGN
SGNITYPE
     16817**DCL     21014<<ASSIGN  21028<<ASSIGN  21048>>IF
SGN_NJE$
     16816**DCL     21046<<ASSIGN  21047>>ASSIGN  21055>>ASSIGN  21056>>ASSIGN  21059>>ASSIGN
SIGNON_COMMON
     21031**LABEL   21015--GOTO
SVPRM
     20994**PROC    20780--CALL    20793--CALL    20948--CALL    21368--CALL
SZ
     16818**DCL     20229<<ASSIGN  20230<>CALL    20232>>ASSIGN  20533<<ASSIGN  20534<>CALL    20653<<ASSIGN
     20958>>ASSIGN  21039<<ASSIGN  21040<>CALL    21042>>ASSIGN  21129<<ASSIGN  21137<<ASSIGN  21138<>CALL
     21139>>ASSIGN  21214<<ASSIGN  21243<<ASSIGN  21244<>CALL    21249>>ASSIGN
T$
     16807**DCL     19681--IMP-PTR 20309<<ASSIGN  20310>>IF      20311>>ASSIGN  20321<<ASSIGN  20322>>ASSIGN
     20888<<ASSIGN  20889>>DOWHILE 20890>>ASSIGN  20891<<ASSIGN  20891>>ASSIGN  20892>>IF      20899<<ASSIGN
     20900>>IF      20901>>ASSIGN  20902<>CALL
TBFR$
     16802**DCL     20265<<ASSIGN  20268>>ASSIGN  20587<<ASSIGN  20589>>ASSIGN  20598>>ASSIGN  20599>>ASSIGN
     20600>>ASSIGN  20652>>ASSIGN  21138<>CALL    21139>>ASSIGN  21158>>CALLBLT 21213>>ASSIGN
U$
     16808**DCL     20887<<ASSIGN  20890<<ASSIGN  20906>>IF      20907>>ASSIGN
VFC
     20129**DCL     21449>>ASSIGN
VFU$
     16820**DCL     20230<>CALL    20231>>ASSIGN  20232>>ASSIGN  20233>>ASSIGN  20234>>ASSIGN  20264>>ASSIGN
PL6.E3A0      #001=KZD$DEVMGR File=KZD$DEVMGR.:E05TSI                            WED 07/30/97 02:50 Page:258  
     20266>>ASSIGN
VFUBFR
     19685**DCL     20236<<ASSIGN  20238--ASSIGN  20260<<ASSIGN  20261<<ASSIGN  20263<<ASSIGN
VFU_LIN$
     16821**DCL     19685--IMP-PTR 20234<<ASSIGN  20236>>ASSIGN  20238>>ASSIGN  20260>>ASSIGN  20261>>ASSIGN
     20263>>ASSIGN
VFU_LINX
     16823**DCL     20237<<DOINDEX 20238>>ASSIGN
VFU_WORD
     19686**DCL     20238<<ASSIGN
