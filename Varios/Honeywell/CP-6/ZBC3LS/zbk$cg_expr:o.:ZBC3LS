

CC.C03    File=zbk$cg_expr:c.:ZBC3TSI                                               Fri Aug 22 1997  Page=1  
        1         1             #include <assert.h>
        2         2             #include "em_mnem.h"
        3         3             #include "cg_tree.h"
        4         4             #include "cg_inst.h"
        5         5             #include "cg_funs.h"
        6         6
        7         7                    int zbk_expr_to_reg (EXPR, unsigned long);
        8         8                    ADR zbk_expr_to_byte_adr_len (EXPR, int);
        9         9                    ADR zbk_expr_to_x_adr (EXPR, int);
       10        10                    ADR zbk_expr_is_x_adr (EXPR, int);
       11        11
       12        12             static ADR make_adr_Preg (EXPR, int, long);
       13        13             static EXPR combine_scripts (EXPR);
       14        14             static EXPR remove_offsets (EXPR, long *);
       15        15                    int  zbk_bound_of_expr (EXPR);
       16        16             static EXPR try_one_fourth (EXPR);
       17        17             static EXPR one_fourth (EXPR);
       18        18                    int  zbk_size_of_expr (EXPR);
       19        19
       20        20             extern void zbk_negate_reg (int);
       21        21             extern void zbk_div_unsigned (int, ADR);
       22        22             extern int  zbk_conversion  (EXPR, unsigned long);
       23        23             extern int  zbk_compare_cmx (EXPR, unsigned long);
       24        24             extern int  zbk_compare_txx (EXPR, unsigned long);
       25        25             extern int  zbk_is_holding_reg (unsigned long, EXPR);
       26        26             extern void zbk_hold_reg (int, EXPR);
       27        27
       28        28             extern int inst_load_reg[];
       29        29             extern int inst_store_reg[];
       30        30             extern int temp_size_reg[];
       31        31                    int literal_fun = 0;
       32        32             extern int lfr_reg;
       33        33             extern ADR lfr_temp;
       34        34
       35        35             int zbk_expr_to_reg (EXPR node, unsigned long regset)
       36        36             {
       37        37    1        ADR adr, tadr;
CC.C03    File=zbk$cg_expr:c.:ZBC3TSI                                               Fri Aug 22 1997  Page=2  
       38        38    1        int reg, reg_result, reg_shcnt, inst;
       39        39    1        int Preg, Xreg, byte_ofs, shcnt;
       40        40    1
       41        41    1        /*----- simple (already addressable) expr -----*/
       42        42    1
       43        43    1           if (node_is_leaf(node)) {
       44        44    2        Leaf_1:
       45        45    2              adr = expr_to_word_adr (node);
       46        46    2              reg = zbk_allocate_reg (regset);
       47        47    2              instruc (inst_load_reg[reg], RA, reg, adr);
       48        48    2              zbk_release_adr_xp (adr);
       49        49    2              return (reg);
       50        50    2           }
       51        51    1
       52        52    1           switch (node->opcode) {
       53        53    2
       54        54    2        /*----- indirect load -------------------------*/
       55        55    2
       56        56    2           case op_loi:
       57        57    2              if (node->argval==4 || node->argval==8) goto Leaf_1;
       58        58    2              assert (node->argval==1);
       59        59    2
       60        60    2              if (node->lf->opcode==op_lal || node->lf->opcode==op_lae) {
       61        61    3                 adr = expr_is_word_adr (node->lf);
       62        62    3                 byte_ofs = adr->argval & 3;
       63        63    3                 adr->argval &= -4L;
       64        64    3                 reg = zbk_allocate_reg (regset&=IREGS);
       65        65    3                 instruc (INST_LDa, RA, reg, adr);
       66        66    3                 zbk_release_adr_xp (adr);
       67        67    3
       68        68    3                 if (byte_ofs>0) {
       69        69    4                    instruc (INST_aLS, RN, reg, 9*byte_ofs);
       70        70    4                    adr->argval += byte_ofs;
       71        71    4                 }
       72        72    3                 instruc (INST_aRS, RN, reg, 27);
       73        73    3                 return (reg);
       74        74    3              }
CC.C03    File=zbk$cg_expr:c.:ZBC3TSI                                               Fri Aug 22 1997  Page=3  
       75        75    2              else {
       76        76    3                 tadr = zbk_make_adr_temp (4);
       77        77    3                 adr = expr_is_byte_adr (node->lf);
       78        78    3                 instruc (INST_MLR, ALAL, adr,1, tadr,1);
       79        79    3                 zbk_release_adr_xp (adr);
       80        80    3
       81        81    3                 reg = zbk_allocate_reg (regset&=IREGS);
       82        82    3                 instruc (INST_LDa, RA, reg, tadr);
       83        83    3                 instruc (INST_aRS, RN, reg, 27);
       84        84    3                 return (reg);
       85        85    3              }
       86        86    2
       87        87    2        /*----- reg -----------------------------*/
       88        88    2
       89        89    2           case op_reg:
       90        90    2              assert (node->reg == lfr_reg);
       91        91    2              reg = lfr_reg;
       92        92    2              lfr_reg = 0;
       93        93    2
       94        94    2           copy_reg_to_regset:
       95        95    2              if (regset&(1L<<reg)) return (reg);
       96        96    2              if (reg==REG_Q && (regset&(1L<<REG_A))) {
       97        97    3                 /* copy Q to A */
       98        98    3                 instruc (INST_LLS, N, 36);
       99        99    3                 zbk_release_regn  (REG_Q);
      100       100    3                 reg = zbk_allocate_regn (REG_A);
      101       101    3              }
      102       102    2              else if (reg==REG_A && (regset&(1L<<REG_Q))) {
      103       103    3                 /* copy A to Q */
      104       104    3                 instruc (INST_LRS, N, 36);
      105       105    3                 zbk_release_regn  (REG_A);
      106       106    3                 reg = zbk_allocate_regn (REG_Q);
      107       107    3              }
      108       108    2              else {
      109       109    3                 tadr = zbk_make_adr_temp (temp_size_reg[reg]);
      110       110    3                 instruc (inst_store_reg[reg], RA, reg, tadr);
      111       111    3                 zbk_release_regn (reg);
CC.C03    File=zbk$cg_expr:c.:ZBC3TSI                                               Fri Aug 22 1997  Page=4  
      112       112    3                 reg = zbk_allocate_reg (regset);
      113       113    3                 instruc (inst_load_reg[reg],  RA, reg, tadr);
      114       114    3              }
      115       115    2              return (reg);
      116       116    2
      117       117    2        /*----- signed/unsigned integer arith -----*/
      118       118    2
      119       119    2           case op_adi: inst = INST_ADa;  goto Op_1;
      120       120    2           case op_adu: inst = INST_ADLa; goto Op_1;
      121       121    2           case op_sbi: inst = INST_SBa;  goto Op_1;
      122       122    2           case op_sbu: inst = INST_SBLa; goto Op_1;
      123       123    2           case op_and: inst = INST_ANa;  goto Op_1;
      124       124    2           case op_ior: inst = INST_ORa;  goto Op_1;
      125       125    2           case op_xor: inst = INST_ERa;  goto Op_1;
      126       126    2           Op_1:
      127       127    2              regset &= IREGS;
      128       128    2              if (!node_is_leaf(node->lf) || node_is_leaf(node->rt)) {
      129       129    3                 adr = expr_to_word_adr (node->rt);
      130       130    3                 reg = zbk_expr_to_reg (node->lf, regset);
      131       131    3              } else { /*reversed*/
      132       132    3                 adr = expr_to_word_adr (node->lf);
      133       133    3                 reg = zbk_expr_to_reg (node->rt, regset);
      134       134    3                 if (inst == INST_SBa) {
      135       135    4                    zbk_negate_reg (reg);
      136       136    4                    inst = INST_ADa;
      137       137    4                 }
      138       138    3                 else if (inst == INST_SBLa) {
      139       139    4                    zbk_negate_reg (reg);
      140       140    4                    inst = INST_ADLa;
      141       141    4                 }
      142       142    3              }
      143       143    2              instruc (inst, RA, reg, adr);
      144       144    2              zbk_release_adr_xp (adr);
      145       145    2              return (reg);
      146       146    2
      147       147    2           case op_inc: inst = INST_ADLa; goto Op_5;
      148       148    2           case op_dec: inst = INST_SBLa; goto Op_5;
CC.C03    File=zbk$cg_expr:c.:ZBC3TSI                                               Fri Aug 22 1997  Page=5  
      149       149    2           Op_5:
      150       150    2              regset &= IREGS;
      151       151    2              reg = zbk_expr_to_reg (node->lf, regset);
      152       152    2              instruc (inst, RNT, reg, 1, TAG_DL);
      153       153    2              return (reg);
      154       154    2
      155       155    2           case op_mli: inst = INST_MPY; reg_result = REG_Q; goto Op_2;
      156       156    2           case op_mlu: inst = INST_MPY; reg_result = REG_Q; goto Op_2;
      157       157    2           case op_dvi: inst = INST_DIV; reg_result = REG_Q; goto Op_2;
      158       158    2           case op_dvu: inst =        0; reg_result = REG_Q; goto Op_2;
      159       159    2           case op_rmi: inst = INST_DIV; reg_result = REG_A; goto Op_2;
      160       160    2           case op_rmu: inst =        2; reg_result = REG_Q; goto Op_2;
      161       161    2           Op_2:
      162       162    2              if (!node_is_leaf(node->lf) || node_is_leaf(node->rt)
      163       163    2                    || inst!=INST_MPY) {
      164       164    3                 adr = expr_to_word_adr (node->rt);
      165       165    3                 reg = zbk_expr_to_reg (node->lf, 1L<<REG_Q);
      166       166    3              } else { /*reversed*/
      167       167    3                 adr = expr_to_word_adr (node->lf);
      168       168    3                 reg = zbk_expr_to_reg (node->rt, 1L<<REG_Q);
      169       169    3              }
      170       170    2              zbk_allocate_regn (REG_A);
      171       171    2              if (inst>2)  instruc  (inst, A, adr);
      172       172    2              else   zbk_div_unsigned (inst, adr);
      173       173    2              zbk_release_regn (REG_A + REG_Q - reg_result);
      174       174    2              zbk_release_adr_xp (adr);
      175       175    2              reg = reg_result;
      176       176    2              goto copy_reg_to_regset;
      177       177    2
      178       178    2           case op_ngi:
      179       179    2              regset &= IREGS;
      180       180    2              if (node_is_leaf (node->lf)) {
      181       181    3                 adr = expr_to_word_adr (node->lf);
      182       182    3                 reg = zbk_allocate_reg (regset);
      183       183    3                 instruc (INST_LCa, RA, reg, adr);
      184       184    3                 zbk_release_adr_xp (adr);
      185       185    3              }
CC.C03    File=zbk$cg_expr:c.:ZBC3TSI                                               Fri Aug 22 1997  Page=6  
      186       186    2              else {
      187       187    3                 reg = zbk_expr_to_reg (node->lf, regset);
      188       188    3                 zbk_negate_reg (reg);
      189       189    3              }
      190       190    2              return (reg);
      191       191    2
      192       192    2           case op_com:
      193       193    2              regset &= IREGS;
      194       194    2              reg = zbk_expr_to_reg (node->lf, regset);
      195       195    2              instruc (INST_ERa, RC, reg, -1L);
      196       196    2              return (reg);
      197       197    2
      198       198    2           case op_sli: inst = INST_aLS; goto Op_3;
      199       199    2           case op_slu: inst = INST_aLS; goto Op_3;
      200       200    2           case op_sri: inst = INST_aRS; goto Op_3;
      201       201    2           case op_sru: inst = INST_aRL; goto Op_3;
      202       202    2           case op_rol: inst = INST_aLR; goto Op_3;
      203       203    2           Op_3:
      204       204    2              regset &= IREGS;
      205       205    2              if ((node->rt)->opcode==op_loc) {
      206       206    3                 reg = zbk_expr_to_reg (node->lf, regset);
      207       207    3                 instruc (inst, RN, reg, (node->rt)->argval);
      208       208    3              } else {
      209       209    3                 adr = expr_to_word_adr (node->rt);
      210       210    3                 reg = zbk_expr_to_reg (node->lf, regset);
      211       211    3                 reg_shcnt = zbk_allocate_reg (XREGS|IREGS);
      212       212    3                 instruc (inst_load_reg[reg_shcnt], RA, reg_shcnt, adr);
      213       213    3                 instruc (inst, RX, reg, reg_shcnt);
      214       214    3                 zbk_release_regn (reg_shcnt);
      215       215    3                 zbk_release_adr_xp (adr);
      216       216    3              }
      217       217    2              return (reg);
      218       218    2
      219       219    2           case op_ror:
      220       220    2              regset &= IREGS;
      221       221    2              if ((node->rt)->opcode==op_loc) {
      222       222    3                 reg = zbk_expr_to_reg (node->lf, regset);
CC.C03    File=zbk$cg_expr:c.:ZBC3TSI                                               Fri Aug 22 1997  Page=7  
      223       223    3                 instruc (INST_aLR, RN, reg, 36 - (node->rt)->argval);
      224       224    3              } else {
      225       225    3                 adr = expr_to_word_adr (node->rt);
      226       226    3                 reg = zbk_expr_to_reg (node->lf, regset);
      227       227    3                 reg_shcnt = zbk_allocate_reg (IREGS);
      228       228    3                 instruc (-1,
      229       229    3                    inst_load_reg[reg_shcnt], RA, reg_shcnt, adr,
      230       230    3                    INST_ERa, RNT, reg_shcnt, 077, TAG_DL,
      231       231    3                    INST_aLR, RNX, reg, -27, reg_shcnt,
      232       232    3                    -1);
      233       233    3                 zbk_release_regn (reg_shcnt);
      234       234    3                 zbk_release_adr_xp (adr);
      235       235    3              }
      236       236    2              return (reg);
      237       237    2
      238       238    2        /*----- float & double arith -----*/
      239       239    2
      240       240    2           case op_adf: inst = INST_FAD; goto Op_4;
      241       241    2           case op_sbf: inst = INST_FSB; goto Op_4;
      242       242    2           case op_mlf: inst = INST_FMP; goto Op_4;
      243       243    2           case op_dvf: inst = INST_FDV; goto Op_4;
      244       244    2           Op_4:
      245       245    2              regset &= FREGS;
      246       246    2              if (!node_is_leaf(node->lf) || node_is_leaf(node->rt)) {
      247       247    3                 adr = expr_to_word_adr (node->rt);
      248       248    3                 reg = zbk_expr_to_reg (node->lf, regset);
      249       249    3              } else { /*reversed*/
      250       250    3                 adr = expr_to_word_adr (node->lf);
      251       251    3                 reg = zbk_expr_to_reg (node->rt, regset);
      252       252    3                 if (inst == INST_FSB) {
      253       253    4                    instruc (INST_FNEG, 0L);
      254       254    4                    inst = INST_FAD;
      255       255    4                 }
      256       256    3                 if (inst == INST_FDV) {
      257       257    4                    inst = INST_FDI;
      258       258    4                 }
      259       259    3              }
CC.C03    File=zbk$cg_expr:c.:ZBC3TSI                                               Fri Aug 22 1997  Page=8  
      260       260    2              if (node->argval==8) inst ++;  /* change FAD to DFAD, etc */
      261       261    2              instruc (inst, A, adr);
      262       262    2              zbk_release_adr_xp (adr);
      263       263    2              return (reg);
      264       264    2
      265       265    2           case op_ngf:
      266       266    2              regset &= FREGS;
      267       267    2              reg = zbk_expr_to_reg (node->lf, regset);
      268       268    2              instruc (INST_FNEG, 0L);
      269       269    2              return (reg);
      270       270    2
      271       271    2        /*----- compares / branches -----------------*/
      272       272    2
      273       273    2           case op_cmi:
      274       274    2           case op_cmu:
      275       275    2           case op_cmf:
      276       276    2           case op_cms:
      277       277    2           case op_cmp:
      278       278    2              reg = zbk_compare_cmx (node, regset);
      279       279    2              return (reg);
      280       280    2
      281       281    2           case op_tlt:
      282       282    2           case op_tle:
      283       283    2           case op_teq:
      284       284    2           case op_tne:
      285       285    2           case op_tge:
      286       286    2           case op_tgt:
      287       287    2              reg = zbk_compare_txx (node, regset);
      288       288    2              return (reg);
      289       289    2
      290       290    2        /*----- conversions -------------------------*/
      291       291    2
      292       292    2           case op_cii:
      293       293    2           case op_ciu:
      294       294    2           case op_cif:
      295       295    2           case op_cui:
      296       296    2           case op_cuu:
CC.C03    File=zbk$cg_expr:c.:ZBC3TSI                                               Fri Aug 22 1997  Page=9  
      297       297    2           case op_cuf:
      298       298    2           case op_cfi:
      299       299    2           case op_cfu:
      300       300    2           case op_cff:
      301       301    2              reg = zbk_conversion (node, regset);
      302       302    2              goto copy_reg_to_regset;
      303       303    2
      304       304    2        /*----- pointer arith (materialization) -----*/
      305       305    2
      306       306    2           case op_lpi:   literal_fun = 1;
      307       307    2           case op_lal:
      308       308    2           case op_lae:
      309       309    2           case op_adp:
      310       310    2           case op_ads:
      311       311    2              adr = zbk_expr_is_x_adr (node, 0); /* pick best xtype: 1 or 4 */
      312       312    2              /* if adr is Local/Arg, prefer Preg */
      313       313    2              if ( (adr->pr) && (regset&ALL_PREGS)) regset &= ALL_PREGS;
      314       314    2              /* if adr is External,  prefer Ireg */
      315       315    2              if (!(adr->pr) && (regset&IREGS)) regset &= IREGS;
      316       316    2
      317       317    2              if (regset&ALL_PREGS) {
      318       318    3                 /* materializing in a Preg */
      319       319    3                 Preg = zbk_allocate_reg (regset);
      320       320    3
      321       321    3                 if (adr->xtype>=4) /* word index */ {
      322       322    4                    Xreg = 0;
      323       323    4                 }
      324       324    3                 else /* no index, or byte index */ {
      325       325    4                    Xreg = adr->xr;
      326       326    4                    adr->xr = 0;
      327       327    4                 }
      328       328    3                 byte_ofs = adr->argval&3;
      329       329    3                 adr->argval &= -4L;
      330       330    3
      331       331    3                 instruc (INST_EPPRn, RA, Preg, adr);
      332       332    3                 zbk_release_adr_xp (adr);
      333       333    3
CC.C03    File=zbk$cg_expr:c.:ZBC3TSI                                               Fri Aug 22 1997  Page=10 
      334       334    3                 if (byte_ofs) {
      335       335    4                    if (Xreg)
      336       336    4                       instruc (INST_ADLa, RNT, Xreg, byte_ofs, TAG_DL);
      337       337    4                    else {
      338       338    5                       Xreg = REG_X0;
      339       339    5                       instruc (INST_LXLn, RNT, Xreg, byte_ofs, TAG_DL);
      340       340    5                    }
      341       341    4                 }
      342       342    3                 if (Xreg) {
      343       343    4                    instruc (INST_A9BD, XP, Xreg, Preg);
      344       344    4                    zbk_release_regn (Xreg);
      345       345    4                 }
      346       346    3                 literal_fun = 0;
      347       347    3                 return (Preg);
      348       348    3              }
      349       349    2
      350       350    2              else {
      351       351    3                 /* materializing in an Ireg */
      352       352    3
      353       353    3                 if (adr->pr) {
      354       354    4                    tadr = zbk_make_adr_temp (4);
      355       355    4                    instruc (INST_STPn, RA, adr->pr, tadr);
      356       356    4                    zbk_release_regn (adr->pr);
      357       357    4                 }
      358       358    3                 else {
      359       359    4                    tadr = zbk_make_adr_id_x (adr->argstr, adr->argval, 0);
      360       360    4                    tadr = zbk_make_adr_literal (tadr);
      361       361    4                    adr->argval = 0;
      362       362    4                 }
      363       363    3
      364       364    3                 if (adr->xr) {
      365       365    4                    Xreg = adr->xr;
      366       366    4                    adr->xr = 0;
      367       367    4                    shcnt = (adr->xtype==4)?18:16;
      368       368    4                    if (Xreg<REG_X0) {
      369       369    5                       reg = Xreg;
      370       370    5                    }
CC.C03    File=zbk$cg_expr:c.:ZBC3TSI                                               Fri Aug 22 1997  Page=11 
      371       371    4                    else {
      372       372    5                       reg = zbk_allocate_reg (regset);
      373       373    5                       instruc (INST_EAa, RX, reg, Xreg);
      374       374    5                       shcnt -= 18;
      375       375    5                       zbk_release_regn (Xreg);
      376       376    5                    }
      377       377    4                    if (shcnt)
      378       378    4                       instruc (INST_aLS, RN, reg, shcnt);
      379       379    4
      380       380    4                    instruc (INST_ADLa, RA, reg, tadr);
      381       381    4                 }
      382       382    3                 else {
      383       383    4                    reg = zbk_allocate_reg (regset);
      384       384    4                    instruc (INST_LDa, RA, reg, tadr);
      385       385    4                 }
      386       386    3
      387       387    3                 if (adr->argval)
      388       388    3                    instruc (INST_ADLa, RC, reg, adr->argval<<16);
      389       389    3                 literal_fun = 0;
      390       390    3                 return (reg);
      391       391    3              }
      392       392    2
      393       393    2           case op_sbs:
      394       394    2              inst = INST_SBLa;
      395       395    2              regset &= IREGS;
      396       396    2              if (!node_is_leaf(node->lf) || node_is_leaf(node->rt)) {
      397       397    3                 adr = expr_to_word_adr (node->rt);
      398       398    3                 reg = zbk_expr_to_reg (node->lf, regset);
      399       399    3              } else { /*reversed*/
      400       400    3                 adr = expr_to_word_adr (node->lf);
      401       401    3                 reg = zbk_expr_to_reg (node->rt, regset);
      402       402    3                 zbk_negate_reg (reg);
      403       403    3                 inst = INST_ADLa;
      404       404    3              }
      405       405    2              instruc (inst, RA, reg, adr);
      406       406    2              instruc (INST_aRS, RN, reg, 16);
      407       407    2              zbk_release_adr_xp (adr);
CC.C03    File=zbk$cg_expr:c.:ZBC3TSI                                               Fri Aug 22 1997  Page=12 
      408       408    2              return (reg);
      409       409    2
      410       410    2           default:
      411       411    2              zbk_fatal("zbk_expr_to_reg: node=%d", node->opcode);
      412       412    2           }
      413       413    1        }
      414       414
      415       415             /*-----------------------------------------*/
      416       416
      417       417             ADR zbk_expr_to_byte_adr_len (EXPR node, int len)
      418       418             {
      419       419    1        ADR adr;
      420       420    1           adr = expr_to_byte_adr (node);
      421       421    1           if (adr->opcode==op_con)
      422       422    1              adr = zbk_make_adr_literal (adr);
      423       423    1           adr->argval += zbk_size_of_expr(node) - len;
      424       424    1           return (adr);
      425       425    1        }
      426       426
      427       427             ADR zbk_expr_to_x_adr (EXPR node, int xtype)
      428       428             {
      429       429    1        int reg, Preg, size;
"zbk$cg_expr:c.:ZBC3TSI", line 429: (warning) identifier "Preg" is not used
      430       430    1        ADR adr;
      431       431    1
      432       432    1           switch (node->opcode) {
      433       433    2           case op_loc:
      434       434    2           case op_ldc:
      435       435    2              return (zbk_make_adr_con (node->argval));
      436       436    2           case op_zer:
      437       437    2              return (zbk_make_adr_con (0L));
      438       438    2           case op_zrf:
      439       439    2              return (zbk_make_adr_con (0400000000000L));
      440       440    2           case op_lol:
      441       441    2           case op_ldl:
      442       442    2           case op_loe:
      443       443    2           case op_lde:
CC.C03    File=zbk$cg_expr:c.:ZBC3TSI                                               Fri Aug 22 1997  Page=13 
      444       444    2              return (node);
      445       445    2
      446       446    2           case op_loi:
      447       447    2              return (zbk_expr_is_x_adr (node->lf, xtype));
      448       448    2           case op_lof:
      449       449    2           case op_ldf:
      450       450    2              adr = zbk_expr_is_x_adr (node->lf, xtype);
      451       451    2              adr->argval += node->argval;
      452       452    2              return (adr);
      453       453    2
      454       454    2           case op_lil:
      455       455    2              node->opcode = op_lol;
      456       456    2              return (make_adr_Preg (node, 0, 0));
      457       457    2
      458       458    2           default:
      459       459    2              size = zbk_size_of_expr (node);
      460       460    2              reg = zbk_expr_to_reg (node, (size==4)? WORD_REGS : DWORD_REGS);
      461       461    2              adr = zbk_make_adr_temp (size);
      462       462    2              instruc (inst_store_reg[reg], RA, reg, adr);
      463       463    2              zbk_release_regn (reg);
      464       464    2              if (size==1) adr->argval += 3;  /* KLUDGE! */
      465       465    2              return (adr);
      466       466    2           }
      467       467    1        }
      468       468
      469       469             ADR zbk_expr_is_x_adr (EXPR node, int xtype)
      470       470             {
      471       471    1        ADR adr;
      472       472    1        int Preg, reg;
"zbk$cg_expr:c.:ZBC3TSI", line 472: (warning) identifier "Preg" is not used
      473       473    1        unsigned long word_xregset;
      474       474    1        long ofs;
      475       475    1
      476       476    1           switch (node->opcode) {
      477       477    2           case op_lal:
      478       478    2           case op_lae:
      479       479    2           case op_lpi:
CC.C03    File=zbk$cg_expr:c.:ZBC3TSI                                               Fri Aug 22 1997  Page=14 
      480       480    2              return (node);
      481       481    2           case op_loc:
      482       482    2
      483       483    2           case op_lol:
      484       484    2           case op_loe:
      485       485    2           case op_reg:
      486       486    2              return (make_adr_Preg (node, 0, 0));
      487       487    2
      488       488    2           case op_loi:
      489       489    2              return (make_adr_Preg (node->lf, 1, 0));
      490       490    2           case op_lof:
      491       491    2              return (make_adr_Preg (node->lf, 1, node->argval));
      492       492    2
      493       493    2           case op_lil:
      494       494    2              node->opcode = op_lol;
      495       495    2              return (make_adr_Preg (node, 1, 0));
      496       496    2
      497       497    2           case op_adp:
      498       498    2              adr = zbk_expr_is_x_adr (node->lf, xtype);
      499       499    2              adr->argval += node->argval;
      500       500    2              return (adr);
      501       501    2
      502       502    2           case op_ads:
      503       503    2              node = remove_offsets (node, &ofs);
      504       504    2              node = combine_scripts (node);
      505       505    2              adr = zbk_expr_is_x_adr (node->lf, xtype);
      506       506    2              adr->argval += ofs;
      507       507    2              assert (adr->xr == 0);
      508       508    2
      509       509    2              if (xtype==0) {
      510       510    3                 xtype = (4 <= zbk_bound_of_expr (node->rt))? 4 : 1;
      511       511    3                 adr->xtype = xtype;
      512       512    3                 word_xregset = IREGS;
      513       513    3              }
      514       514    2              else {
      515       515    3                 word_xregset = XREGS|IREGS;
      516       516    3              }
CC.C03    File=zbk$cg_expr:c.:ZBC3TSI                                               Fri Aug 22 1997  Page=15 
      517       517    2
      518       518    2              if (xtype==4) {
      519       519    3                 if (1 == zbk_bound_of_expr (node->rt)) {
      520       520    4                    reg = zbk_expr_to_reg (node->rt, IREGS);
      521       521    4                    adr->xr = zbk_allocate_reg (XREGS);
      522       522    4                    ofs = adr->argval&3;
      523       523    4                    adr->argval &= -4L;
      524       524    4
      525       525    4                    if (ofs) instruc (INST_ADLa, RNT, reg, ofs, TAG_DL);
      526       526    4                    instruc (-1,
      527       527    4                       INST_aRL,  RN,  reg,  2,
      528       528    4                       INST_EAXn, RNT, adr->xr, 0, reg,
      529       529    4                       -1);
      530       530    4                    zbk_release_regn (reg);
      531       531    4                    return (adr);
      532       532    4                 }
      533       533    3
      534       534    3                 node->rt = one_fourth (node->rt);
      535       535    3                 adr->xr = zbk_expr_to_reg (node->rt, word_xregset);
      536       536    3                 /* if it's ALLOWED to be an XREG, then REQUIRE an XREG! */
      537       537    3                 if ((word_xregset&XREGS) && (adr->xr<REG_X0)) {
      538       538    4                    reg = adr->xr;
      539       539    4                    adr->xr = zbk_allocate_reg (XREGS);
      540       540    4                    instruc (INST_EAXn, RX, adr->xr, reg);
      541       541    4                    zbk_release_regn (reg);
      542       542    4                 }
      543       543    3              }
      544       544    2              else {
      545       545    3                 adr->xr = zbk_expr_to_reg (node->rt, IREGS);
      546       546    3              }
      547       547    2              return (adr);
      548       548    2
      549       549    2           default:
      550       550    2              zbk_fatal("zbk_expr_is_x_adr: node=%d", node->opcode);
      551       551    2           }
      552       552    1        }
      553       553
CC.C03    File=zbk$cg_expr:c.:ZBC3TSI                                               Fri Aug 22 1997  Page=16 
      554       554             static ADR make_adr_Preg (EXPR node, int indirect, long ofs)
      555       555             {
      556       556    1           int Preg;
      557       557    1           ADR adr;
      558       558    1
      559       559    1           if (node->opcode==op_lol || node->opcode==op_loe) {
      560       560    2              Preg = zbk_is_holding_reg (PREGS, node);
      561       561    2              if (!Preg) {
      562       562    3                 Preg = zbk_expr_to_reg (node, PREGS);
      563       563    3                 zbk_hold_reg (Preg, node);
      564       564    3              }
      565       565    2           }
      566       566    1           else
      567       567    1              Preg = zbk_expr_to_reg (node, PREGS);
      568       568    1
      569       569    1           adr  = zbk_make_adr_nXP (0, 0, Preg);
      570       570    1
      571       571    1           if (indirect) {
      572       572    2              adr->argval = ofs;
      573       573    2              zbk_release_regn (Preg);
      574       574    2              Preg = zbk_allocate_reg (PREGS);
      575       575    2              instruc (INST_LDPn, RA, Preg, adr);
      576       576    2              adr->pr = Preg;
      577       577    2              adr->argval = 0;
      578       578    2           }
      579       579    1
      580       580    1           return (adr);
      581       581    1        }
      582       582
      583       583             /*---------------------------------------------------------
      584       584             -----     Script handlers      ----------------------------
      585       585             ---------------------------------------------------------*/
      586       586
      587       587             /*
      588       588             Action taken at each recursion level ---
      589       589
      590       590                --- before ---
CC.C03    File=zbk$cg_expr:c.:ZBC3TSI                                               Fri Aug 22 1997  Page=17 
      591       591                          #2:ads
      592       592                       #1:ads   i
      593       593                         p   j
      594       594
      595       595                --- after ----
      596       596                          #2:ads
      597       597                            p  #1:adi
      598       598                                 i   j
      599       599
      600       600             Example: triple-nested subscript ---
      601       601
      602       602                --- before ---
      603       603                          #4:ads
      604       604                       #3:ads   i
      605       605                    #2:ads   j
      606       606                 #1:lal   k
      607       607
      608       608                --- after ----
      609       609                          #4:ads
      610       610                           / #3:adi
      611       611                          /   i #2:adi
      612       612                      #1:lal      j   k
      613       613             */
      614       614             static EXPR combine_scripts (EXPR node)
      615       615             {
      616       616    1        EXPR x;
      617       617    1           if ((node->opcode == op_ads)
      618       618    1              && ((node->lf)->opcode == op_ads)) {
      619       619    2                 node->lf = combine_scripts (node->lf);
      620       620    2                 x = node->lf;
      621       621    2                 node->lf = x->lf;
      622       622    2                 x->opcode = op_adi;
      623       623    2                 x->lf = node->rt;
      624       624    2                 node->rt = x;
      625       625    2           }
      626       626    1           return (node);
      627       627    1        }
CC.C03    File=zbk$cg_expr:c.:ZBC3TSI                                               Fri Aug 22 1997  Page=18 
      628       628
      629       629             /*
      630       630             Locates & removes all adp's from pointer-expression chain,
      631       631             and returns the total offset in a given variable.
      632       632
      633       633             Example: triple-nested subscript ---
      634       634
      635       635                --- before ---
      636       636                                            #7:ads
      637       637                                      #6:adp(1)   i
      638       638                                   #5:ads
      639       639                             #4:adp(2)   j
      640       640                          #3:ads
      641       641                    #2:adp(4)   k
      642       642                 #1:lal
      643       643
      644       644                --- after ----
      645       645                             #7:ads
      646       646                          #5:ads   i
      647       647                       #3:ads   j
      648       648                 #1:lal      k
      649       649                 [returning offset = 7]
      650       650             */
      651       651             static EXPR remove_offsets (EXPR node, long * ofsp)
      652       652             {
      653       653    1        long ofsx, ofsy;
      654       654    1
      655       655    1           if (node->opcode == op_ads) {
      656       656    2              node->lf = remove_offsets (node->lf, &ofsx);
      657       657    2              *ofsp = ofsx;
      658       658    2           }
      659       659    1           else if (node->opcode == op_adp) {
      660       660    2              ofsy = node->argval;
      661       661    2              node = remove_offsets (node->lf, &ofsx);
      662       662    2              *ofsp = ofsx + ofsy;
      663       663    2           }
      664       664    1           else
CC.C03    File=zbk$cg_expr:c.:ZBC3TSI                                               Fri Aug 22 1997  Page=19 
      665       665    1              *ofsp = 0;
      666       666    1           return (node);
      667       667    1        }
      668       668
      669       669             /* returns 1, 4, or 8 == gcd of expr elements */
      670       670             int zbk_bound_of_expr (EXPR node)
      671       671             {
      672       672    1        int lfb, rtb, n;
      673       673    1
      674       674    1           switch (node->opcode) {
      675       675    2           case op_loc:
      676       676    2           case op_ldc:
      677       677    2           case op_lal:
      678       678    2           case op_lae:
      679       679    2              if ((node->argval&7) == 0) return (8);
      680       680    2              if ((node->argval&3) == 0) return (4);
      681       681    2              return (1);
      682       682    2           case op_zer:
      683       683    2              return (8);
      684       684    2
      685       685    2           case op_adi:
      686       686    2           case op_adu:
      687       687    2           case op_sbi:
      688       688    2           case op_sbu:
      689       689    2           case op_sbs:
      690       690    2           case op_adp:
      691       691    2           case op_ads:
      692       692    2              rtb = zbk_bound_of_expr (node->rt);
      693       693    2              if (rtb==1) return (1);
      694       694    2              lfb = zbk_bound_of_expr (node->lf);
      695       695    2              return ((lfb<rtb)? lfb:rtb);
      696       696    2
      697       697    2           case op_mli:
      698       698    2           case op_mlu:
      699       699    2              rtb = zbk_bound_of_expr (node->rt);
      700       700    2              if (rtb!=1) return (rtb);
      701       701    2              return (zbk_bound_of_expr (node->lf));
CC.C03    File=zbk$cg_expr:c.:ZBC3TSI                                               Fri Aug 22 1997  Page=20 
      702       702    2
      703       703    2           case op_dvi:
      704       704    2           case op_dvu:
      705       705    2              return (zbk_bound_of_expr (node->lf));
      706       706    2
      707       707    2           case op_ngi:
      708       708    2              return (zbk_bound_of_expr (node->lf));
      709       709    2
      710       710    2           case op_sli:
      711       711    2           case op_slu:
      712       712    2              if ((node->rt)->opcode != op_loc) return (1);
      713       713    2              n = (node->rt)->argval;
      714       714    2              if (n>=3) return (8);
      715       715    2              if (n==2) return (4);
      716       716    2              return (1);
      717       717    2
      718       718    2           default:
      719       719    2              return (1);
      720       720    2           }
      721       721    1        }
      722       722
      723       723             static EXPR try_one_fourth (EXPR node)
      724       724             {
      725       725    1        EXPR lfn, rtn;
      726       726    1        int n;
      727       727    1
      728       728    1           switch (node->opcode) {
      729       729    2           case op_loc:
      730       730    2           case op_ldc:
      731       731    2              if ((node->argval&3)==0) {
      732       732    3                 node->argval /= 4;
      733       733    3                 return (node);
      734       734    3              }
      735       735    2              return (0);
      736       736    2           case op_zer:
      737       737    2              return (node);
      738       738    2
CC.C03    File=zbk$cg_expr:c.:ZBC3TSI                                               Fri Aug 22 1997  Page=21 
      739       739    2           case op_adi:
      740       740    2           case op_adu:
      741       741    2           case op_sbi:
      742       742    2           case op_sbu:
      743       743    2           case op_sbs:
      744       744    2              if (0==(lfn = try_one_fourth (node->lf))) return (0);
      745       745    2              if (0==(rtn = try_one_fourth (node->rt))) return (0);
      746       746    2              node->lf = lfn;
      747       747    2              node->rt = rtn;
      748       748    2              return (node);
      749       749    2
      750       750    2           case op_mli:
      751       751    2           case op_mlu:
      752       752    2              if (0!=(lfn = try_one_fourth (node->lf))) {
      753       753    3                 if (lfn->opcode==op_loc && lfn->argval==1L)
      754       754    3                    return (node->rt);
      755       755    3                 node->lf = lfn;
      756       756    3                 return (node);
      757       757    3              }
      758       758    2              if (0!=(rtn = try_one_fourth (node->rt))) {
      759       759    3                 if (rtn->opcode==op_loc && rtn->argval==1L)
      760       760    3                    return (node->lf);
      761       761    3                 node->rt = rtn;
      762       762    3                 return (node);
      763       763    3              }
      764       764    2              return (0);
      765       765    2
      766       766    2           case op_dvi:
      767       767    2           case op_dvu:
      768       768    2              if (0!=(lfn = try_one_fourth (node->lf))) {
      769       769    3                 node->lf = lfn;
      770       770    3                 return (node);
      771       771    3              }
      772       772    2              return (0);
      773       773    2
      774       774    2           case op_ngi:
      775       775    2              if (0==(lfn = try_one_fourth (node->lf))) return (0);
CC.C03    File=zbk$cg_expr:c.:ZBC3TSI                                               Fri Aug 22 1997  Page=22 
      776       776    2              node->lf = lfn;
      777       777    2              return (node);
      778       778    2
      779       779    2           case op_sli:
      780       780    2           case op_slu:
      781       781    2              if ((node->rt)->opcode!=op_loc) return (0);
      782       782    2              n = (node->rt)->argval;
      783       783    2              if (n>=3) {
      784       784    3                 (node->rt)->argval -= 2;
      785       785    3                 return (node);
      786       786    3              }
      787       787    2              else if (n==2) return (node->lf);
      788       788    2              else return (0);
      789       789    2
      790       790    2           default:
      791       791    2              return (0);
      792       792    2           }
      793       793    1        }
      794       794
      795       795             static EXPR one_fourth (EXPR node)
      796       796             {
      797       797    1           assert (0!=(node=try_one_fourth(node)));
      798       798    1           return (node);
      799       799    1        }
      800       800
      801       801             int zbk_size_of_expr (EXPR node)
      802       802             {
      803       803    1           switch (node->opcode) {
      804       804    2           case op_lil:
      805       805    2           case op_loc:
      806       806    2           case op_loe:
      807       807    2           case op_lof:
      808       808    2           case op_lol:
      809       809    2           case op_adi:
      810       810    2           case op_adu:
      811       811    2           case op_sbi:
      812       812    2           case op_sbu:
CC.C03    File=zbk$cg_expr:c.:ZBC3TSI                                               Fri Aug 22 1997  Page=23 
      813       813    2           case op_sbs:
      814       814    2           case op_inc:
      815       815    2           case op_dec:
      816       816    2           case op_and:
      817       817    2           case op_ior:
      818       818    2           case op_xor:
      819       819    2           case op_mli:
      820       820    2           case op_mlu:
      821       821    2           case op_dvi:
      822       822    2           case op_dvu:
      823       823    2           case op_rmi:
      824       824    2           case op_rmu:
      825       825    2           case op_ngi:
      826       826    2           case op_com:
      827       827    2           case op_sli:
      828       828    2           case op_slu:
      829       829    2           case op_sri:
      830       830    2           case op_sru:
      831       831    2           case op_rol:
      832       832    2           case op_ror:
      833       833    2           case op_cmp:
      834       834    2           case op_tlt:
      835       835    2           case op_tle:
      836       836    2           case op_teq:
      837       837    2           case op_tne:
      838       838    2           case op_tge:
      839       839    2           case op_tgt:
      840       840    2           case op_lal:
      841       841    2           case op_lae:
      842       842    2           case op_lpi:
      843       843    2           case op_adp:
      844       844    2           case op_ads:
      845       845    2              return (4);
      846       846    2
      847       847    2           case op_ldc:
      848       848    2           case op_lde:
      849       849    2           case op_ldf:
CC.C03    File=zbk$cg_expr:c.:ZBC3TSI                                               Fri Aug 22 1997  Page=24 
      850       850    2           case op_ldl:
      851       851    2              return (8);
      852       852    2
      853       853    2           case op_zer:
      854       854    2           case op_zrf:
      855       855    2           case op_loi:
      856       856    2           case op_lfr:
      857       857    2           case op_adf:
      858       858    2           case op_sbf:
      859       859    2           case op_mlf:
      860       860    2           case op_dvf:
      861       861    2           case op_ngf:
      862       862    2           case op_cmi:
      863       863    2           case op_cmu:
      864       864    2           case op_cmf:
      865       865    2           case op_cms:
      866       866    2              return (node->argval);
      867       867    2
      868       868    2           case op_cii:
      869       869    2           case op_ciu:
      870       870    2           case op_cif:
      871       871    2           case op_cui:
      872       872    2           case op_cuu:
      873       873    2           case op_cuf:
      874       874    2           case op_cfi:
      875       875    2           case op_cfu:
      876       876    2           case op_cff:
      877       877    2              return (node->argval%10);
      878       878    2
      879       879    2           case op_reg:
      880       880    2              return (temp_size_reg[node->reg]);
      881       881    2
      882       882    2           default:
      883       883    2              return (0);
      884       884    2           }
      885       885    1        }
---  Include file information  ---
CC.C03    File=zbk$cg_expr:c.:ZBC3TSI                                               Fri Aug 22 1997  Page=25 

   assert:h.:LIBRARY. is referenced
   em_mnem:h.:ZBC3TOU. is referenced
   zbk$cg_tree:h.:ZBC3TOU. is referenced
   zbk$cg_inst:h.:ZBC3TOU. is referenced
   zbk$cg_funs:h.:ZBC3TOU. is referenced

2 warnings were detected in the file zbk$cg_expr:c.:ZBC3TSI
