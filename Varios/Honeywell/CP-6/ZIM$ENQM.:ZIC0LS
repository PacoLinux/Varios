
PL6.E3A0      #001=ZIM$ENQM File=ZIM$ENQM.:ZIC0TSI                               FRI 09/05/97 12:52 Page:1    
        1        1        /*M*    ZIM$ENQM - Issue or upgrade an M$ENQ on a resource. */
        2        2        /*T***********************************************************/
        3        3        /*T*                                                         */
        4        4        /*T* Copyright (c) Bull HN Information Systems Inc., 1997    */
        5        5        /*T*                                                         */
        6        6        /*T***********************************************************/
        7        7        /*P*
        8        8        NAME:   ZIM$ENQM
        9        9        PURPOSE:To issue M$ENQs on resources.
       10       10        */
       11       11        /*D*
       12       12        NAME:   ZIM$ENQM
       13       13        CALL:   CALL ZIM$ENQM(WAIT) ALTRET;
       14       14        INPUT:  WAIT - Wait on M$ENQ request.  Optional.  Default=yes.
       15       15                GLOBAL.ENQ.VALUE - The resouce to lock.
       16       16                GLOBAL.ENQ.SHARE - The level to lock it at.
       17       17        OUTPUT: GLOBAL.ENQ.LIST.INDX - Index into ENQLIST of entry.
       18       18        DESCRIPTION:
       19       19            The resource identified by the inputs is added to the
       20       20            enq list and is enqueued.  If the list is expanded,
       21       21            GLOBAL.BCB.BUF.ENQINDX is remapped to reflect the new
       22       22            locations.
       23       23        */
       24       24        %EJECT;
PL6.E3A0      #001=ZIM$ENQM File=ZIM$ENQM.:ZIC0TSI                               FRI 09/05/97 12:52 Page:2    
       25       25        ZIM$ENQM: PROC (P_WAIT) ALTRET AVOID($PR5, $PR6, $PR7);
       26       26        %INCLUDE CP_6;
       27      107         %FPT_ENQ(FPTN=FPT$ENQ,STCLASS=BASED);
       28      125         %B$TCB;
       29      128         %B$ALT;
       30      136        %INCLUDE CP_6_SUBS;
       31      676        %INCLUDE ZI$GLOBAL;
       32     1162         %GLOBALS;
       33     1470         %ENQLIST;
       34     1488        %INCLUDE B_ERRORS_C;
       35     2615        %INCLUDE ZI_ERRORS_C;
       36     2941
       37     2942    1   DCL B$TCB$ PTR SYMREF;
       38     2943
       39     2944    1   DCL ZIM$PROL ENTRY ALTRET;
       40     2945    1   DCL ZIM$SHIFT_ENQLIST ENTRY(2);
       41     2946    1   DCL ZIO$GETSEG ENTRY(3) ALTRET;
       42     2947
       43     2948    1   DCL P_WAIT SBIN;
       44     2949
       45     2950    1   DCL INDX SBIN;
       46     2951    1   DCL ERROR UBIN;
       47     2952    1   DCL PTR$ PTR;
       48     2953
       49     2954    1       IF ADDR(P_WAIT)=ADDR(NIL) THEN
       50     2955    1           GLOBAL.ENQ$->FPT$ENQ.V.WAIT_TIME#=-1;
       51     2956    1       ELSE
       52     2957    1           GLOBAL.ENQ$->FPT$ENQ.V.WAIT_TIME#=P_WAIT;
       53     2958
       54     2959    1       CALL BSEARCH
       55     2960    2       WHENRETURN DO;
       56     2961    2           IF GLOBAL.ENQ.SHARE=%NONE# AND
       57     2962    3              NOT ENQLIST.STATUS.MODIFY(INDX) THEN DO;
       58     2963    3               CALL ENQIT ALTRET(ALT);
       59     2964    3               ENQLIST.STATUS.MODIFY(INDX)=%YES#;
       60     2965    3               END;
       61     2966    2           GOTO RET;
PL6.E3A0      #001=ZIM$ENQM File=ZIM$ENQM.:ZIC0TSI                               FRI 09/05/97 12:52 Page:3    
       62     2967    2           END;
       63     2968
       64     2969        /*      Not found in ENQ list.  Add it. */
       65     2970    2       IF GLOBAL.ENQ.LIST.COUNT+1>=GLOBAL.ENQ.LIST.MAXCOUNT THEN DO;
       66     2971        /*          Need more memory for ENQLIST. */
       67     2972    2           CALL ZIO$GETSEG(GLOBAL$,1024,PTR$)
       68     2973    3           WHENALTRETURN DO;
       69     2974    3               GLOBAL.RET.ERROR#=ERR#CAC#MEM;
       70     2975    3               GLOBAL.RET.SYSERR#=B$TCB$->B$TCB.ALT$->B$ALT.ERR;
       71     2976    3               CALL M$ERR;
       72     2977    3               END;
       73     2978    2           GLOBAL.ENQ.LIST.MAXCOUNT= GLOBAL.ENQ.LIST.MAXCOUNT+
       74     2979    2              1024/SIZEW(ENQLIST(0));
       75     2980    3           IF GLOBAL.ENQ.LIST.BASE$=ADDR(NIL) THEN DO;
       76     2981    3               GLOBAL.ENQ.LIST.BASE$=PTR$;
       77     2982    3               ENQLIST$=GLOBAL.ENQ.LIST.BASE$;
       78     2983    3               END;
       79     2984    2           END;
       80     2985
       81     2986    1       CALL ENQIT ALTRET(ALT);
       82     2987    1       IF INDX<=GLOBAL.ENQ.LIST.COUNT THEN
       83     2988        /*          Move other entries out of the way. */
       84     2989    1           CALL ZIM$SHIFT_ENQLIST(INDX,1);
       85     2990
       86     2991    1       GLOBAL.ENQ.LIST.COUNT=GLOBAL.ENQ.LIST.COUNT+1;
       87     2992    1       ENQLIST(INDX)='0'B;
       88     2993    1       ENQLIST.VALUE(INDX)=GLOBAL.ENQ.VALUE;
       89     2994    1       IF GLOBAL.ENQ.SHARE=%NONE# THEN
       90     2995    1           ENQLIST.STATUS.MODIFY(INDX)=%YES#;
       91     2996    1       GOTO RET;
       92     2997        %EJECT;
PL6.E3A0      #001=ZIM$ENQM File=ZIM$ENQM.:ZIC0TSI                               FRI 09/05/97 12:52 Page:4    
       93     2998    1   ZIM$ENQ_FIND: ENTRY ALTRET;
       94     2999
       95     3000    1       CALL BSEARCH ALTRET(ALT);
       96     3001    1       GOTO RET;
       97     3002        %EJECT;
PL6.E3A0      #001=ZIM$ENQM File=ZIM$ENQM.:ZIC0TSI                               FRI 09/05/97 12:52 Page:5    
       98     3003        /*D*
       99     3004        NAME:   ZIM$ENQMOD
      100     3005        CALL:   CALL ZIM$ENQMOD
      101     3006        INPUT:  GLOBAL.ENQ.LIST.INDX - The entry being upgraded.
      102     3007        DESCRIPTION:
      103     3008            If the index to an ENQ entry is known, this routine can
      104     3009            be called to upgrade the ENQ to reflect a modified page.
      105     3010        */
      106     3011
      107     3012    1   ZIM$ENQMOD: ENTRY ALTRET;
      108     3013    1       GLOBAL.ENQ$->FPT$ENQ.V.WAIT_TIME#=-1;
      109     3014    1       ENQLIST$=GLOBAL.ENQ.LIST.BASE$;
      110     3015    1       GLOBAL.ENQ.VALUE=ENQLIST.VALUE(GLOBAL.ENQ.LIST.INDX);
      111     3016    1       GLOBAL.ENQ.SHARE=%NONE#;
      112     3017    1       ENQLIST.STATUS.MODIFY(GLOBAL.ENQ.LIST.INDX)='1'B;
      113     3018    1       CALL ENQIT ALTRET(ALT);
      114     3019    1   RET:RETURN;
      115     3020    1   ALT:ALTRETURN;
      116     3021        %EJECT;
PL6.E3A0      #001=ZIM$ENQM File=ZIM$ENQM.:ZIC0TSI                               FRI 09/05/97 12:52 Page:6    
      117     3022        /*I*
      118     3023        NAME:   BSEARCH
      119     3024        PURPOSE:Does a binary search on the ENQLIST table.
      120     3025        DESCRIPTION:
      121     3026            If GLOBAL.ENQ.VALUE is found in the table, the routine
      122     3027            RETURNs with INDX set to the index of the entry.  If
      123     3028            it is not found, the routine ALTRETURNs with INDX
      124     3029            set to the position in the table where the entry belongs.
      125     3030        */
      126     3031
      127     3032    1   BSEARCH: PROC ALTRET;
      128     3033
      129     3034    2   DCL MIDDLE SBIN;
      130     3035    2   DCL HIGH SBIN;
      131     3036
      132     3037    2       ENQLIST$=GLOBAL.ENQ.LIST.BASE$;
      133     3038
      134     3039    2       INDX=1;
      135     3040    2       HIGH=GLOBAL.ENQ.LIST.COUNT;
      136     3041    3       DO WHILE(INDX<=HIGH);
      137     3042    3           MIDDLE=(INDX+HIGH)/2;
      138     3043    3           IF ENQLIST.VALUE(MIDDLE)<GLOBAL.ENQ.VALUE THEN
      139     3044    3               INDX=MIDDLE+1;
      140     3045    3           ELSE
      141     3046    3               IF ENQLIST.VALUE(MIDDLE)>GLOBAL.ENQ.VALUE THEN
      142     3047    3                   HIGH=MIDDLE-1;
      143     3048    4               ELSE DO;
      144     3049    4                   INDX=MIDDLE;
      145     3050    4                   GLOBAL.ENQ.LIST.INDX=INDX;
      146     3051    4                   RETURN;
      147     3052    4                   END;
      148     3053    3           END; /* WHILE */
      149     3054
      150     3055        /*      Entry not found.  Return where it would go. */
      151     3056    2       GLOBAL.ENQ.LIST.INDX=INDX;
      152     3057    2   ALT:ALTRETURN;
      153     3058    2   END BSEARCH;
PL6.E3A0      #001=ZIM$ENQM File=ZIM$ENQM.:ZIC0TSI                               FRI 09/05/97 12:52 Page:7    
      154     3059        %EJECT;
PL6.E3A0      #001=ZIM$ENQM File=ZIM$ENQM.:ZIC0TSI                               FRI 09/05/97 12:52 Page:8    
      155     3060        /*I*
      156     3061        NAME:   ENQIT
      157     3062        PURPOSE:Issue the actual M$ENQ and handle errors.
      158     3063        */
      159     3064    1   ENQIT: PROC ALTRET;
      160     3065    2       GLOBAL.ENQ$->FPT$ENQ.V.DCB#=GLOBAL.ENQ.VALUE.DCB#;
      161     3066    2       GLOBAL.ENQ$->FPT$ENQ.V.SHARE#=GLOBAL.ENQ.SHARE;
      162     3067    2       GLOBAL.RNAME.VALUE=GLOBAL.ENQ.VALUE.RNAME;
      163     3068    2       CALL M$ENQ(GLOBAL.ENQ$->FPT$ENQ) ALTRET(ER_ENQ);
      164     3069    2       GLOBAL.STATS.CURR.ENQS=GLOBAL.STATS.CURR.ENQS+1;
      165     3070    2       RETURN;
      166     3071    2   ER_ENQ: ;
      167     3072    2       IF B$TCB$->B$TCB.ALT$->B$ALT.ERR.ERR#=%E$ENQ_LIMIT OR
      168     3073    3          B$TCB$->B$TCB.ALT$->B$ALT.ERR.ERR#=%E$DSFULL THEN DO;
      169     3074    3           GLOBAL.RET.ERROR#=ERR#IO#MAXENQ;
      170     3075    3           GLOBAL.RET.SYSERR#=B$TCB$->B$TCB.ALT$->B$ALT.ERR;
      171     3076    3           CALL M$ERR;
      172     3077    3           END;
      173     3078    2       ELSE
      174     3079    2           IF B$TCB$->B$TCB.ALT$->B$ALT.ERR.ERR#=%E$DLOCK OR
      175     3080    2              B$TCB$->B$TCB.ALT$->B$ALT.ERR.ERR#=%E$TIMELIMIT THEN
      176     3081    2               IF GLOBAL.ENQ$->FPT$ENQ.V.WAIT_TIME#~=0 AND
      177     3082    3                  GLOBAL.TJRNL.DCB#~=0 THEN DO;
      178     3083    3                   GLOBAL.STATS.CURR.LOCKS=GLOBAL.STATS.CURR.LOCKS+1;
      179     3084    3                   CALL ZIM$PROL
      180     3085    4                   WHENALTRETURN DO;
      181     3086    4                       CALL M$ERR;
      182     3087    4                       END;
      183     3088    3                   GOTO ALT;
      184     3089    3                   END;
      185     3090    3               ELSE DO;
      186     3091    3                   ERROR=ERR#CAC#RTRV;
      187     3092    3                   GOTO ALT;
      188     3093    3                   END;
      189     3094
      190     3095    2       ERROR=ERR#IO#CAC;
      191     3096    2       GLOBAL.RET.SYSERR#=B$TCB$->B$TCB.ALT$->B$ALT.ERR;
PL6.E3A0      #001=ZIM$ENQM File=ZIM$ENQM.:ZIC0TSI                               FRI 09/05/97 12:52 Page:9    
      192     3097    2       GLOBAL.RET.DCB#=GLOBAL.ENQ$->FPT$ENQ.V.DCB#;
      193     3098    2   ALT: ;
      194     3099            %DBALT;
      195     3113    2   END ENQIT;
      196     3114    1   END ZIM$ENQM;
      197     3115        %EOD;

PL6.E3A0      #001=ZIM$ENQM File=ZIM$ENQM.:ZIC0TSI                               FRI 09/05/97 12:52 Page:10   
--  Include file information  --

   ZI_ERRORS_C.:ZIC0TOU  is referenced.
   B_ERRORS_C.:LIB_E05  is referenced.
   ZI$GLOBAL.:ZIC0TOU  is referenced.
   CP_6_SUBS.:LIB_E05  is referenced.
   CP_6.:LIB_E05  cannot be made into a system file and is referenced.
   B$JIT_C.:E05TOU  was found in the system file and is never referenced.
   CP_6_C.:E05TOU  was found in the system file and is referenced.
      No diagnostics issued in procedure ZIM$ENQM.

   Procedure ZIM$ENQM requires 271 words for executable code.
   Procedure ZIM$ENQM requires 16 words of local(AUTO) storage.

PL6.E3A0      #001=ZIM$ENQM File=ZIM$ENQM.:ZIC0TSI                               FRI 09/05/97 12:52 Page:11   

 Object Unit name= ZIM$ENQM                                   File name= ZIM$ENQM.:ZIC0TOU
 UTS= SEP 05 '97 12:52:46.80 FRI                              Compiler= PL-6/E31         Sev=      00
 SharedLib= :SHARED_SYSTEM                                    Alt SharedLib=


    ****  Control sections  ****

 Sect   Type Bound  Init  Size OctSiz  Section name(segment info)
    0   DCB   even  none     0      0  M$UC
    1   Proc  even  none   271    417  ZIM$ENQM
    2  RoData even  none     9     11  ZIM$ENQM

    ****  Entry defs  ****

                              Check   Calling
                             calling  sequence
  Sect OctLoc Primary Altret sequence   type   Parms  Name
     1      0   yes    yes     yes      XStd       1  ZIM$ENQM
     1    154          yes     yes      XStd       0  ZIM$ENQ_FIND
     1    161          yes     yes      XStd       0  ZIM$ENQMOD

  ****  Entry refs  ****

         Check        Calling
        calling       sequence
Altret sequence SRef   type   Args  Name
 yes     yes           XStd      3 ZIO$GETSEG
         yes           XStd      2 ZIM$SHIFT_ENQLIST
         yes           XStd      0 ZIB$ERR
 yes     yes           XStd      0 ZIM$PROL
                       nStd      0 X66_AUTO_1
                       nStd      0 X66_ARET
                       nStd      0 X66_AALT
PL6.E3A0      #001=ZIM$ENQM File=ZIM$ENQM.:ZIC0TSI                               FRI 09/05/97 12:52 Page:12   

  ****  Data refs  ****

  Flags:  r = read only, s = secondary
Flgs Name                             Flgs Name                             Flgs Name
     M$UC                             r    GLOBAL$                               B$TCB$

  ****  Segment refs  ****

  Flags:  r = read only, s = secondary
Flgs Name                             Flgs Name                             Flgs Name
     NULLSID                               ISSID
PL6.E3A0      #001=ZIM$ENQM File=ZIM$ENQM.:ZIC0TSI                               FRI 09/05/97 12:52 Page:13   


        1        1        /*M*    ZIM$ENQM - Issue or upgrade an M$ENQ on a resource. */
        2        2        /*T***********************************************************/
        3        3        /*T*                                                         */
        4        4        /*T* Copyright (c) Bull HN Information Systems Inc., 1997    */
        5        5        /*T*                                                         */
        6        6        /*T***********************************************************/
        7        7        /*P*
        8        8        NAME:   ZIM$ENQM
        9        9        PURPOSE:To issue M$ENQs on resources.
       10       10        */
       11       11        /*D*
       12       12        NAME:   ZIM$ENQM
       13       13        CALL:   CALL ZIM$ENQM(WAIT) ALTRET;
       14       14        INPUT:  WAIT - Wait on M$ENQ request.  Optional.  Default=yes.
       15       15                GLOBAL.ENQ.VALUE - The resouce to lock.
       16       16                GLOBAL.ENQ.SHARE - The level to lock it at.
       17       17        OUTPUT: GLOBAL.ENQ.LIST.INDX - Index into ENQLIST of entry.
       18       18        DESCRIPTION:
       19       19            The resource identified by the inputs is added to the
       20       20            enq list and is enqueued.  If the list is expanded,
       21       21            GLOBAL.BCB.BUF.ENQINDX is remapped to reflect the new
       22       22            locations.
       23       23        */
       24       24        %EJECT;
PL6.E3A0      #001=ZIM$ENQM File=ZIM$ENQM.:ZIC0TSI                               FRI 09/05/97 12:52 Page:14   
       25       25        ZIM$ENQM: PROC (P_WAIT) ALTRET AVOID($PR5, $PR6, $PR7);

     25  1 000000   000000 700200 xent  ZIM$ENQM     TSX0  ! X66_AUTO_1
         1 000001   000020 000001                    ZERO    16,1

       26       26        %INCLUDE CP_6;
       27      107         %FPT_ENQ(FPTN=FPT$ENQ,STCLASS=BASED);
       28      125         %B$TCB;
       29      128         %B$ALT;
       30      136        %INCLUDE CP_6_SUBS;
       31      676        %INCLUDE ZI$GLOBAL;
       32     1162         %GLOBALS;
       33     1470         %ENQLIST;
       34     1488        %INCLUDE B_ERRORS_C;
       35     2615        %INCLUDE ZI_ERRORS_C;
       36     2941
       37     2942    1   DCL B$TCB$ PTR SYMREF;
       38     2943
       39     2944    1   DCL ZIM$PROL ENTRY ALTRET;
       40     2945    1   DCL ZIM$SHIFT_ENQLIST ENTRY(2);
       41     2946    1   DCL ZIO$GETSEG ENTRY(3) ALTRET;
       42     2947
       43     2948    1   DCL P_WAIT SBIN;
       44     2949
       45     2950    1   DCL INDX SBIN;
       46     2951    1   DCL ERROR UBIN;
       47     2952    1   DCL PTR$ PTR;
       48     2953
       49     2954    1       IF ADDR(P_WAIT)=ADDR(NIL) THEN

   2954  1 000002   200003 236100                    LDQ     @P_WAIT,,AUTO
         1 000003   000000 116000 2                  CMPQ    0
         1 000004   000012 601000 1                  TNZ     s:2957

       50     2955    1           GLOBAL.ENQ$->FPT$ENQ.V.WAIT_TIME#=-1;

   2955  1 000005   000000 470400 xsym               LDP0    GLOBAL$
PL6.E3A0      #001=ZIM$ENQM File=ZIM$ENQM.:ZIC0TSI                               FRI 09/05/97 12:52 Page:15   
         1 000006   005110 471500                    LDP1    2632,,PR0
         1 000007   000001 335007                    LCA     1,DL
         1 000010   100007 755100                    STA     7,,PR1
         1 000011   000017 710000 1                  TRA     s:2959

       51     2956    1       ELSE
       52     2957    1           GLOBAL.ENQ$->FPT$ENQ.V.WAIT_TIME#=P_WAIT;

   2957  1 000012   000000 470400 xsym               LDP0    GLOBAL$
         1 000013   005110 471500                    LDP1    2632,,PR0
         1 000014   200003 473500                    LDP3    @P_WAIT,,AUTO
         1 000015   300000 235100                    LDA     0,,PR3
         1 000016   100007 755100                    STA     7,,PR1

       53     2958
       54     2959    1       CALL BSEARCH

   2959  1 000017   000211 701000 1                  TSX1    BSEARCH
         1 000020   000044 702000 1                  TSX2    s:2970

       55     2960    2       WHENRETURN DO;

       56     2961    2           IF GLOBAL.ENQ.SHARE=%NONE# AND

   2961  1 000021   000000 470400 xsym               LDP0    GLOBAL$
         1 000022   001407 236100                    LDQ     775,,PR0
         1 000023   777000 376003                    ANQ     -512,DU
         1 000024   003000 116003                    CMPQ    1536,DU
         1 000025   000043 601000 1                  TNZ     s:2966
         1 000026   200005 235100                    LDA     INDX,,AUTO
         1 000027   000001 735000                    ALS     1
         1 000030   200004 471500                    LDP1    ENQLIST$,,AUTO
         1 000031   100000 236105                    LDQ     0,AL,PR1
         1 000032   100000 316003                    CANQ    32768,DU
         1 000033   000043 601000 1                  TNZ     s:2966

       57     2962    3              NOT ENQLIST.STATUS.MODIFY(INDX) THEN DO;
PL6.E3A0      #001=ZIM$ENQM File=ZIM$ENQM.:ZIC0TSI                               FRI 09/05/97 12:52 Page:16   

       58     2963    3               CALL ENQIT ALTRET(ALT);

   2963  1 000034   000265 701000 1                  TSX1    ENQIT
         1 000035   000210 702000 1                  TSX2    ALT

       59     2964    3               ENQLIST.STATUS.MODIFY(INDX)=%YES#;

   2964  1 000036   200005 235100                    LDA     INDX,,AUTO
         1 000037   000001 735000                    ALS     1
         1 000040   200004 470500                    LDP0    ENQLIST$,,AUTO
         1 000041   100000 236003                    LDQ     32768,DU
         1 000042   000000 256105                    ORSQ    0,AL,PR0

       60     2965    3               END;

       61     2966    2           GOTO RET;

   2966  1 000043   000207 710000 1                  TRA     RET

       62     2967    2           END;
       63     2968
       64     2969        /*      Not found in ENQ list.  Add it. */
       65     2970    2       IF GLOBAL.ENQ.LIST.COUNT+1>=GLOBAL.ENQ.LIST.MAXCOUNT THEN DO;

   2970  1 000044   000000 470400 xsym               LDP0    GLOBAL$
         1 000045   001412 720100                    LXL0    778,,PR0
         1 000046   000001 621010                    EAX1    1,X0
         1 000047   001413 101100                    CMPX1   779,,PR0
         1 000050   000105 602000 1                  TNC     s:2986

       66     2971        /*          Need more memory for ENQLIST. */
       67     2972    2           CALL ZIO$GETSEG(GLOBAL$,1024,PTR$)

   2972  1 000051   200007 631500                    EPPR1   PTR$,,AUTO
         1 000052   200016 451500                    STP1    HIGH+4,,AUTO
         1 000053   000004 237000 2                  LDAQ    4
PL6.E3A0      #001=ZIM$ENQM File=ZIM$ENQM.:ZIC0TSI                               FRI 09/05/97 12:52 Page:17   
         1 000054   200014 757100                    STAQ    HIGH+2,,AUTO
         1 000055   200014 630500                    EPPR0   HIGH+2,,AUTO
         1 000056   000001 631400 2                  EPPR1   1
         1 000057   000000 701000 xent               TSX1    ZIO$GETSEG
         1 000060   000062 702000 1                  TSX2    s:2974
         1 000061   000073 710000 1                  TRA     s:2978

       68     2973    3           WHENALTRETURN DO;

       69     2974    3               GLOBAL.RET.ERROR#=ERR#CAC#MEM;

   2974  1 000062   210770 235007                    LDA     70136,DL
         1 000063   000000 470400 xsym               LDP0    GLOBAL$
         1 000064   000006 755100                    STA     6,,PR0

       70     2975    3               GLOBAL.RET.SYSERR#=B$TCB$->B$TCB.ALT$->B$ALT.ERR;

   2975  1 000065   000000 471400 xsym               LDP1    B$TCB$
         1 000066   100000 473500                    LDP3    0,,PR1
         1 000067   300102 236100                    LDQ     66,,PR3
         1 000070   000007 756100                    STQ     7,,PR0

       71     2976    3               CALL M$ERR;

   2976  1 000071   000002 713400                    CLIMB   err
         1 000072   000000 401760                    pmme    nvectors=0

       72     2977    3               END;

       73     2978    2           GLOBAL.ENQ.LIST.MAXCOUNT= GLOBAL.ENQ.LIST.MAXCOUNT+

   2978  1 000073   000000 470400 xsym               LDP0    GLOBAL$
         1 000074   001413 220100                    LDX0    779,,PR0
         1 000075   001000 621010                    EAX1    512,X0
         1 000076   001413 741100                    STX1    779,,PR0

       74     2979    2              1024/SIZEW(ENQLIST(0));
PL6.E3A0      #001=ZIM$ENQM File=ZIM$ENQM.:ZIC0TSI                               FRI 09/05/97 12:52 Page:18   
       75     2980    3           IF GLOBAL.ENQ.LIST.BASE$=ADDR(NIL) THEN DO;

   2980  1 000077   001411 236100                    LDQ     777,,PR0
         1 000100   000000 116000 2                  CMPQ    0
         1 000101   000105 601000 1                  TNZ     s:2986

       76     2981    3               GLOBAL.ENQ.LIST.BASE$=PTR$;

   2981  1 000102   200007 236100                    LDQ     PTR$,,AUTO
         1 000103   001411 756100                    STQ     777,,PR0

       77     2982    3               ENQLIST$=GLOBAL.ENQ.LIST.BASE$;

   2982  1 000104   200004 756100                    STQ     ENQLIST$,,AUTO

       78     2983    3               END;

       79     2984    2           END;

       80     2985
       81     2986    1       CALL ENQIT ALTRET(ALT);

   2986  1 000105   000265 701000 1                  TSX1    ENQIT
         1 000106   000210 702000 1                  TSX2    ALT

       82     2987    1       IF INDX<=GLOBAL.ENQ.LIST.COUNT THEN

   2987  1 000107   000000 470400 xsym               LDP0    GLOBAL$
         1 000110   001412 236100                    LDQ     778,,PR0
         1 000111   777777 376007                    ANQ     -1,DL
         1 000112   200005 116100                    CMPQ    INDX,,AUTO
         1 000113   000124 604000 1                  TMI     s:2991

       83     2988        /*          Move other entries out of the way. */
       84     2989    1           CALL ZIM$SHIFT_ENQLIST(INDX,1);

   2989  1 000114   000007 236000 2                  LDQ     7
PL6.E3A0      #001=ZIM$ENQM File=ZIM$ENQM.:ZIC0TSI                               FRI 09/05/97 12:52 Page:19   
         1 000115   200015 756100                    STQ     HIGH+3,,AUTO
         1 000116   200005 631500                    EPPR1   INDX,,AUTO
         1 000117   200014 451500                    STP1    HIGH+2,,AUTO
         1 000120   200014 630500                    EPPR0   HIGH+2,,AUTO
         1 000121   000003 631400 2                  EPPR1   3
         1 000122   000000 701000 xent               TSX1    ZIM$SHIFT_ENQLIST
         1 000123   000000 011000                    NOP     0

       85     2990
       86     2991    1       GLOBAL.ENQ.LIST.COUNT=GLOBAL.ENQ.LIST.COUNT+1;

   2991  1 000124   000000 470400 xsym               LDP0    GLOBAL$
         1 000125   001412 720100                    LXL0    778,,PR0
         1 000126   000001 621010                    EAX1    1,X0
         1 000127   001412 441100                    SXL1    778,,PR0

       87     2992    1       ENQLIST(INDX)='0'B;

   2992  1 000130   200005 235100                    LDA     INDX,,AUTO
         1 000131   000001 735000                    ALS     1
         1 000132   200004 471500                    LDP1    ENQLIST$,,AUTO
         1 000133   100000 450105                    STZ     0,AL,PR1
         1 000134   100001 450105                    STZ     1,AL,PR1

       88     2993    1       ENQLIST.VALUE(INDX)=GLOBAL.ENQ.VALUE;

   2993  1 000135   200005 235100                    LDA     INDX,,AUTO
         1 000136   000001 735000                    ALS     1
         1 000137   000002 735000                    ALS     2
         1 000140   000105 100500                    MLR     fill='000'O
         1 000141   001407 400006                    ADSC9   775,,PR0                 cn=2,n=6
         1 000142   100000 400006                    ADSC9   0,A,PR1                  cn=2,n=6

       89     2994    1       IF GLOBAL.ENQ.SHARE=%NONE# THEN

   2994  1 000143   001407 236100                    LDQ     775,,PR0
         1 000144   777000 376003                    ANQ     -512,DU
PL6.E3A0      #001=ZIM$ENQM File=ZIM$ENQM.:ZIC0TSI                               FRI 09/05/97 12:52 Page:20   
         1 000145   003000 116003                    CMPQ    1536,DU
         1 000146   000153 601000 1                  TNZ     s:2996

       90     2995    1           ENQLIST.STATUS.MODIFY(INDX)=%YES#;

   2995  1 000147   200005 235100                    LDA     INDX,,AUTO
         1 000150   000001 735000                    ALS     1
         1 000151   100000 236003                    LDQ     32768,DU
         1 000152   100000 256105                    ORSQ    0,AL,PR1

       91     2996    1       GOTO RET;

   2996  1 000153   000207 710000 1                  TRA     RET

       92     2997        %EJECT;
PL6.E3A0      #001=ZIM$ENQM File=ZIM$ENQM.:ZIC0TSI                               FRI 09/05/97 12:52 Page:21   
       93     2998    1   ZIM$ENQ_FIND: ENTRY ALTRET;

   2998  1 000154   000000 700200 xent  ZIM$ENQ_FIND TSX0  ! X66_AUTO_1
         1 000155   000020 000001                    ZERO    16,1

       94     2999
       95     3000    1       CALL BSEARCH ALTRET(ALT);

   3000  1 000156   000211 701000 1                  TSX1    BSEARCH
         1 000157   000210 702000 1                  TSX2    ALT

       96     3001    1       GOTO RET;

   3001  1 000160   000207 710000 1                  TRA     RET

       97     3002        %EJECT;
PL6.E3A0      #001=ZIM$ENQM File=ZIM$ENQM.:ZIC0TSI                               FRI 09/05/97 12:52 Page:22   
       98     3003        /*D*
       99     3004        NAME:   ZIM$ENQMOD
      100     3005        CALL:   CALL ZIM$ENQMOD
      101     3006        INPUT:  GLOBAL.ENQ.LIST.INDX - The entry being upgraded.
      102     3007        DESCRIPTION:
      103     3008            If the index to an ENQ entry is known, this routine can
      104     3009            be called to upgrade the ENQ to reflect a modified page.
      105     3010        */
      106     3011
      107     3012    1   ZIM$ENQMOD: ENTRY ALTRET;

   3012  1 000161   000000 700200 xent  ZIM$ENQMOD   TSX0  ! X66_AUTO_1
         1 000162   000020 000001                    ZERO    16,1

      108     3013    1       GLOBAL.ENQ$->FPT$ENQ.V.WAIT_TIME#=-1;

   3013  1 000163   000000 470400 xsym               LDP0    GLOBAL$
         1 000164   005110 471500                    LDP1    2632,,PR0
         1 000165   000001 335007                    LCA     1,DL
         1 000166   100007 755100                    STA     7,,PR1

      109     3014    1       ENQLIST$=GLOBAL.ENQ.LIST.BASE$;

   3014  1 000167   001411 236100                    LDQ     777,,PR0
         1 000170   200004 756100                    STQ     ENQLIST$,,AUTO

      110     3015    1       GLOBAL.ENQ.VALUE=ENQLIST.VALUE(GLOBAL.ENQ.LIST.INDX);

   3015  1 000171   001412 220100                    LDX0    778,,PR0
         1 000172   001412 020100                    ADLX0   778,,PR0
         1 000173   000000 635010                    EAA     0,X0
         1 000174   000020 771000                    ARL     16
         1 000175   200004 471500                    LDP1    ENQLIST$,,AUTO
         1 000176   000100 100505                    MLR     fill='000'O
         1 000177   100000 400006                    ADSC9   0,A,PR1                  cn=2,n=6
         1 000200   001407 400006                    ADSC9   775,,PR0                 cn=2,n=6

PL6.E3A0      #001=ZIM$ENQM File=ZIM$ENQM.:ZIC0TSI                               FRI 09/05/97 12:52 Page:23   
      111     3016    1       GLOBAL.ENQ.SHARE=%NONE#;

   3016  1 000201   003000 236003                    LDQ     1536,DU
         1 000202   001407 552140                    STBQ    775,'40'O,PR0

      112     3017    1       ENQLIST.STATUS.MODIFY(GLOBAL.ENQ.LIST.INDX)='1'B;

   3017  1 000203   100000 236003                    LDQ     32768,DU
         1 000204   100000 256110                    ORSQ    0,X0,PR1

      113     3018    1       CALL ENQIT ALTRET(ALT);

   3018  1 000205   000265 701000 1                  TSX1    ENQIT
         1 000206   000210 702000 1                  TSX2    ALT

      114     3019    1   RET:RETURN;

   3019  1 000207   000000 702200 xent  RET          TSX2  ! X66_ARET

      115     3020    1   ALT:ALTRETURN;

   3020  1 000210   000000 702200 xent  ALT          TSX2  ! X66_AALT

      116     3021        %EJECT;
PL6.E3A0      #001=ZIM$ENQM File=ZIM$ENQM.:ZIC0TSI                               FRI 09/05/97 12:52 Page:24   
      117     3022        /*I*
      118     3023        NAME:   BSEARCH
      119     3024        PURPOSE:Does a binary search on the ENQLIST table.
      120     3025        DESCRIPTION:
      121     3026            If GLOBAL.ENQ.VALUE is found in the table, the routine
      122     3027            RETURNs with INDX set to the index of the entry.  If
      123     3028            it is not found, the routine ALTRETURNs with INDX
      124     3029            set to the position in the table where the entry belongs.
      125     3030        */
      126     3031
      127     3032    1   BSEARCH: PROC ALTRET;

   3032  1 000211   200010 741300       BSEARCH      STX1  ! PTR$+1,,AUTO

      128     3033
      129     3034    2   DCL MIDDLE SBIN;
      130     3035    2   DCL HIGH SBIN;
      131     3036
      132     3037    2       ENQLIST$=GLOBAL.ENQ.LIST.BASE$;

   3037  1 000212   000000 470400 xsym               LDP0    GLOBAL$
         1 000213   001411 236100                    LDQ     777,,PR0
         1 000214   200004 756100                    STQ     ENQLIST$,,AUTO

      133     3038
      134     3039    2       INDX=1;

   3039  1 000215   000001 235007                    LDA     1,DL
         1 000216   200005 755100                    STA     INDX,,AUTO

      135     3040    2       HIGH=GLOBAL.ENQ.LIST.COUNT;

   3040  1 000217   001412 236100                    LDQ     778,,PR0
         1 000220   777777 376007                    ANQ     -1,DL
         1 000221   200012 756100                    STQ     HIGH,,AUTO

      136     3041    3       DO WHILE(INDX<=HIGH);
PL6.E3A0      #001=ZIM$ENQM File=ZIM$ENQM.:ZIC0TSI                               FRI 09/05/97 12:52 Page:25   

   3041  1 000222   200005 116100                    CMPQ    INDX,,AUTO
         1 000223   000260 604000 1                  TMI     s:3056

      137     3042    3           MIDDLE=(INDX+HIGH)/2;

   3042  1 000224   200005 236100                    LDQ     INDX,,AUTO
         1 000225   200012 036100                    ADLQ    HIGH,,AUTO
         1 000226   000002 506007                    DIV     2,DL
         1 000227   200011 756100                    STQ     MIDDLE,,AUTO

      138     3043    3           IF ENQLIST.VALUE(MIDDLE)<GLOBAL.ENQ.VALUE THEN

   3043  1 000230   200011 235100                    LDA     MIDDLE,,AUTO
         1 000231   000003 735000                    ALS     3
         1 000232   200004 470500                    LDP0    ENQLIST$,,AUTO
         1 000233   000000 471400 xsym               LDP1    GLOBAL$
         1 000234   000100 106505                    CMPC    fill='000'O
         1 000235   000000 400006                    ADSC9   0,A,PR0                  cn=2,n=6
         1 000236   101407 400006                    ADSC9   775,,PR1                 cn=2,n=6
         1 000237   000243 603000 1                  TRC     s:3046

      139     3044    3               INDX=MIDDLE+1;

   3044  1 000240   000001 036007                    ADLQ    1,DL
         1 000241   200005 756100                    STQ     INDX,,AUTO
         1 000242   000255 710000 1                  TRA     s:3053

      140     3045    3           ELSE
      141     3046    3               IF ENQLIST.VALUE(MIDDLE)>GLOBAL.ENQ.VALUE THEN

   3046  1 000243   000250 602000 1                  TNC     s:3049
         1 000244   000250 600000 1                  TZE     s:3049

      142     3047    3                   HIGH=MIDDLE-1;

   3047  1 000245   000001 136007                    SBLQ    1,DL
PL6.E3A0      #001=ZIM$ENQM File=ZIM$ENQM.:ZIC0TSI                               FRI 09/05/97 12:52 Page:26   
         1 000246   200012 756100                    STQ     HIGH,,AUTO
         1 000247   000255 710000 1                  TRA     s:3053

      143     3048    4               ELSE DO;

      144     3049    4                   INDX=MIDDLE;

   3049  1 000250   200005 756100                    STQ     INDX,,AUTO

      145     3050    4                   GLOBAL.ENQ.LIST.INDX=INDX;

   3050  1 000251   000000 620006                    EAX0    0,QL
         1 000252   101412 740100                    STX0    778,,PR1

      146     3051    4                   RETURN;

   3051  1 000253   200010 221300                    LDX1  ! PTR$+1,,AUTO
         1 000254   000001 702211                    TSX2  ! 1,X1

      147     3052    4                   END;
      148     3053    3           END; /* WHILE */

   3053  1 000255   200005 236100                    LDQ     INDX,,AUTO
         1 000256   200012 116100                    CMPQ    HIGH,,AUTO
         1 000257   000224 604400 1                  TMOZ    s:3042

      149     3054
      150     3055        /*      Entry not found.  Return where it would go. */
      151     3056    2       GLOBAL.ENQ.LIST.INDX=INDX;

   3056  1 000260   200005 720100                    LXL0    INDX,,AUTO
         1 000261   000000 470400 xsym               LDP0    GLOBAL$
         1 000262   001412 740100                    STX0    778,,PR0

      152     3057    2   ALT:ALTRETURN;

   3057  1 000263   200010 221300       ALT          LDX1  ! PTR$+1,,AUTO
PL6.E3A0      #001=ZIM$ENQM File=ZIM$ENQM.:ZIC0TSI                               FRI 09/05/97 12:52 Page:27   
         1 000264   000000 702211                    TSX2  ! 0,X1

      153     3058    2   END BSEARCH;
      154     3059        %EJECT;
PL6.E3A0      #001=ZIM$ENQM File=ZIM$ENQM.:ZIC0TSI                               FRI 09/05/97 12:52 Page:28   
      155     3060        /*I*
      156     3061        NAME:   ENQIT
      157     3062        PURPOSE:Issue the actual M$ENQ and handle errors.
      158     3063        */
      159     3064    1   ENQIT: PROC ALTRET;

   3064  1 000265   200010 741300       ENQIT        STX1  ! PTR$+1,,AUTO

      160     3065    2       GLOBAL.ENQ$->FPT$ENQ.V.DCB#=GLOBAL.ENQ.VALUE.DCB#;

   3065  1 000266   000000 470400 xsym               LDP0    GLOBAL$
         1 000267   005110 471500                    LDP1    2632,,PR0
         1 000270   001407 720100                    LXL0    775,,PR0
         1 000271   100006 740100                    STX0    6,,PR1

      161     3066    2       GLOBAL.ENQ$->FPT$ENQ.V.SHARE#=GLOBAL.ENQ.SHARE;

   3066  1 000272   005110 471500                    LDP1    2632,,PR0
         1 000273   001407 236100                    LDQ     775,,PR0
         1 000274   000015 772000                    QRL     13
         1 000275   100006 676100                    ERQ     6,,PR1
         1 000276   140000 376007                    ANQ     49152,DL
         1 000277   100006 656100                    ERSQ    6,,PR1

      162     3067    2       GLOBAL.RNAME.VALUE=GLOBAL.ENQ.VALUE.RNAME;

   3067  1 000300   000100 100500                    MLR     fill='000'O
         1 000301   001410 000004                    ADSC9   776,,PR0                 cn=0,n=4
         1 000302   004776 200004                    ADSC9   2558,,PR0                cn=1,n=4

      163     3068    2       CALL M$ENQ(GLOBAL.ENQ$->FPT$ENQ) ALTRET(ER_ENQ);

   3068  1 000303   005110 471500                    LDP1    2632,,PR0
         1 000304   100000 630500                    EPPR0   0,,PR1
         1 000305   420002 713400                    CLIMB   alt,+8194
         1 000306   401000 401760                    pmme    nvectors=3
         1 000307   000314 702000 1                  TSX2    ER_ENQ
PL6.E3A0      #001=ZIM$ENQM File=ZIM$ENQM.:ZIC0TSI                               FRI 09/05/97 12:52 Page:29   

      164     3069    2       GLOBAL.STATS.CURR.ENQS=GLOBAL.STATS.CURR.ENQS+1;

   3069  1 000310   000000 470400 xsym               LDP0    GLOBAL$
         1 000311   001427 054100                    AOS     791,,PR0

      165     3070    2       RETURN;

   3070  1 000312   200010 221300                    LDX1  ! PTR$+1,,AUTO
         1 000313   000001 702211                    TSX2  ! 1,X1

   3069  1 000314                       ER_ENQ       null
      166     3071    2   ER_ENQ: ;
      167     3072    2       IF B$TCB$->B$TCB.ALT$->B$ALT.ERR.ERR#=%E$ENQ_LIMIT OR

   3072  1 000314   000000 470400 xsym               LDP0    B$TCB$
         1 000315   000000 471500                    LDP1    0,,PR0
         1 000316   100102 236100                    LDQ     66,,PR1
         1 000317   377770 376007                    ANQ     131064,DL
         1 000320   014540 116007                    CMPQ    6496,DL
         1 000321   000324 600000 1                  TZE     s:3074
         1 000322   014400 116007                    CMPQ    6400,DL
         1 000323   000335 601000 1                  TNZ     s:3079

      168     3073    3          B$TCB$->B$TCB.ALT$->B$ALT.ERR.ERR#=%E$DSFULL THEN DO;

      169     3074    3           GLOBAL.RET.ERROR#=ERR#IO#MAXENQ;

   3074  1 000324   210763 235007                    LDA     70131,DL
         1 000325   000000 473400 xsym               LDP3    GLOBAL$
         1 000326   300006 755100                    STA     6,,PR3

      170     3075    3           GLOBAL.RET.SYSERR#=B$TCB$->B$TCB.ALT$->B$ALT.ERR;

   3075  1 000327   000000 471500                    LDP1    0,,PR0
         1 000330   100102 236100                    LDQ     66,,PR1
         1 000331   300007 756100                    STQ     7,,PR3
PL6.E3A0      #001=ZIM$ENQM File=ZIM$ENQM.:ZIC0TSI                               FRI 09/05/97 12:52 Page:30   

      171     3076    3           CALL M$ERR;

   3076  1 000332   000002 713400                    CLIMB   err
         1 000333   000000 401760                    pmme    nvectors=0

      172     3077    3           END;

   3077  1 000334   000362 710000 1                  TRA     s:3095

      173     3078    2       ELSE
      174     3079    2           IF B$TCB$->B$TCB.ALT$->B$ALT.ERR.ERR#=%E$DLOCK OR

   3079  1 000335   014410 116007                    CMPQ    6408,DL
         1 000336   000341 600000 1                  TZE     s:3081
         1 000337   014420 116007                    CMPQ    6416,DL
         1 000340   000362 601000 1                  TNZ     s:3095

      175     3080    2              B$TCB$->B$TCB.ALT$->B$ALT.ERR.ERR#=%E$TIMELIMIT THEN
      176     3081    2               IF GLOBAL.ENQ$->FPT$ENQ.V.WAIT_TIME#~=0 AND

   3081  1 000341   000000 473400 xsym               LDP3    GLOBAL$
         1 000342   305110 474500                    LDP4    2632,,PR3
         1 000343   400007 235100                    LDA     7,,PR4
         1 000344   000357 600000 1                  TZE     s:3091
         1 000345   302604 235100                    LDA     1412,,PR3
         1 000346   000357 600000 1                  TZE     s:3091

      177     3082    3                  GLOBAL.TJRNL.DCB#~=0 THEN DO;

      178     3083    3                   GLOBAL.STATS.CURR.LOCKS=GLOBAL.STATS.CURR.LOCKS+1;

   3083  1 000347   301430 054100                    AOS     792,,PR3

      179     3084    3                   CALL ZIM$PROL

   3084  1 000350   000010 631400 2                  EPPR1   8
PL6.E3A0      #001=ZIM$ENQM File=ZIM$ENQM.:ZIC0TSI                               FRI 09/05/97 12:52 Page:31   
         1 000351   000000 701000 xent               TSX1    ZIM$PROL
         1 000352   000354 702000 1                  TSX2    s:3086
         1 000353   000356 710000 1                  TRA     s:3088

      180     3085    4                   WHENALTRETURN DO;

      181     3086    4                       CALL M$ERR;

   3086  1 000354   000002 713400                    CLIMB   err
         1 000355   000000 401760                    pmme    nvectors=0

      182     3087    4                       END;

      183     3088    3                   GOTO ALT;

   3088  1 000356   000374 710000 1                  TRA     ALT

      184     3089    3                   END;
      185     3090    3               ELSE DO;

      186     3091    3                   ERROR=ERR#CAC#RTRV;

   3091  1 000357   210771 235007                    LDA     70137,DL
         1 000360   200006 755100                    STA     ERROR,,AUTO

      187     3092    3                   GOTO ALT;

   3092  1 000361   000374 710000 1                  TRA     ALT

      188     3093    3                   END;
      189     3094
      190     3095    2       ERROR=ERR#IO#CAC;

   3095  1 000362   303375 235007                    LDA     100093,DL
         1 000363   200006 755100                    STA     ERROR,,AUTO

      191     3096    2       GLOBAL.RET.SYSERR#=B$TCB$->B$TCB.ALT$->B$ALT.ERR;
PL6.E3A0      #001=ZIM$ENQM File=ZIM$ENQM.:ZIC0TSI                               FRI 09/05/97 12:52 Page:32   

   3096  1 000364   000000 470400 xsym               LDP0    B$TCB$
         1 000365   000000 471500                    LDP1    0,,PR0
         1 000366   100102 236100                    LDQ     66,,PR1
         1 000367   000000 473400 xsym               LDP3    GLOBAL$
         1 000370   300007 756100                    STQ     7,,PR3

      192     3097    2       GLOBAL.RET.DCB#=GLOBAL.ENQ$->FPT$ENQ.V.DCB#;

   3097  1 000371   305110 471500                    LDP1    2632,,PR3
         1 000372   100006 220100                    LDX0    6,,PR1
         1 000373   300014 740100                    STX0    12,,PR3

   3097  1 000374                       ALT          null
      193     3098    2   ALT: ;
      194     3099            %DBALT;

   3100  1 000374   000000 470400 xsym               LDP0    GLOBAL$
         1 000375   000006 235100                    LDA     6,,PR0
         1 000376   000405 601000 1                  TNZ     s:3108

   3102  1 000377   000010 450100                    STZ     8,,PR0

   3103  1 000400   000012 450100                    STZ     10,,PR0

   3104  1 000401   000013 450100                    STZ     11,,PR0

   3105  1 000402   000011 450100                    STZ     9,,PR0

   3106  1 000403   200006 236100                    LDQ     ERROR,,AUTO
         1 000404   000006 756100                    STQ     6,,PR0

   3108  1 000405   000006 235100                    LDA     6,,PR0
         1 000406   303240 115007                    CMPA    100000,DL
         1 000407   000412 603000 1                  TRC     s:3111

   3109  1 000410   200010 221300                    LDX1  ! PTR$+1,,AUTO
PL6.E3A0      #001=ZIM$ENQM File=ZIM$ENQM.:ZIC0TSI                               FRI 09/05/97 12:52 Page:33   
         1 000411   000000 702211                    TSX2  ! 0,X1

   3111  1 000412   000010 631400 2                  EPPR1   8
         1 000413   000000 701000 xent               TSX1    ZIB$ERR
         1 000414   000000 011000                    NOP     0

      195     3113    2   END ENQIT;

   3113  1 000415   200010 221300                    LDX1  ! PTR$+1,,AUTO
         1 000416   000001 702211                    TSX2  ! 1,X1

(unnamed)
 Sect OctLoc
   2     000   000000 006014   000003 000000   000000 002000   000002 000000    ................
   2     004   000000 006000   000002 006000   000000 000001   000006 006000    ................
   2     010   000000 000000                                                    ....
      196     3114    1   END ZIM$ENQM;
      197     3115        %EOD;

PL6.E3A0      #001=ZIM$ENQM File=ZIM$ENQM.:ZIC0TSI                               FRI 09/05/97 12:52 Page:34   
--  Include file information  --

   ZI_ERRORS_C.:ZIC0TOU  is referenced.
   B_ERRORS_C.:LIB_E05  is referenced.
   ZI$GLOBAL.:ZIC0TOU  is referenced.
   CP_6_SUBS.:LIB_E05  is referenced.
   CP_6.:LIB_E05  cannot be made into a system file and is referenced.
   B$JIT_C.:E05TOU  was found in the system file and is never referenced.
   CP_6_C.:E05TOU  was found in the system file and is referenced.
      No diagnostics issued in procedure ZIM$ENQM.

   Procedure ZIM$ENQM requires 271 words for executable code.
   Procedure ZIM$ENQM requires 16 words of local(AUTO) storage.
PL6.E3A0      #001=ZIM$ENQM File=ZIM$ENQM.:ZIC0TSI                               FRI 09/05/97 12:52 Page:35   
          *** CROSS REFERENCE LISTING ***
**     DENOTES     IDENTIFIER DEFINITION
<<                 IDENTIFIER'S VALUE SET
>>                 IDENTIFIER'S VALUE USED
<>                 IDENTIFIER SET AND/OR USED
--                 IDENTIFIER REFERENCED
PL6.E3A0      #001=ZIM$ENQM File=ZIM$ENQM.:ZIC0TSI                               FRI 09/05/97 12:52 Page:36   
          MINI XREF LISTING

ALT
      3020**LABEL    2963--CALLALT  2986--CALLALT  3000--CALLALT  3018--CALLALT
ALT IN PROCEDURE ENQIT
      3097**LABEL    3088--GOTO     3092--GOTO
B$ALT.CODE
       130**DCL       130--REDEF     131--REDEF     131--REDEF
B$ALT.ERR
       131**DCL      2975>>ASSIGN   3075>>ASSIGN   3096>>ASSIGN
B$ALT.ERR.ERR#
       132**DCL       132--REDEF    3072>>IF       3072>>IF       3079>>IF       3079>>IF
B$ALT.EVID
       131**DCL       131--REDEF     131--REDEF
B$TCB.ALT$
       126**DCL      2975>>ASSIGN   3072>>IF       3072>>IF       3075>>ASSIGN   3079>>IF       3079>>IF
      3096>>ASSIGN
B$TCB$
      2942**DCL      2975>>ASSIGN   3072>>IF       3072>>IF       3075>>ASSIGN   3079>>IF       3079>>IF
      3096>>ASSIGN
BSEARCH
      3032**PROC     2959--CALL     3000--CALL
ENQIT
      3064**PROC     2963--CALL     2986--CALL     3018--CALL
ENQLIST
      1471**DCL      2978--ASSIGN   2992<<ASSIGN
ENQLIST.STATUS.MODIFY
      1477**DCL      2961>>IF       2964<<ASSIGN   2995<<ASSIGN   3017<<ASSIGN
ENQLIST.VALUE
      1482**DCL      2993<<ASSIGN   3015>>ASSIGN   3043>>IF       3046>>IF
ENQLIST$
      1486**DCL      1471--IMP-PTR  2961>>IF       2964>>ASSIGN   2982<<ASSIGN   2992>>ASSIGN   2993>>ASSIGN
      2995>>ASSIGN   3014<<ASSIGN   3015>>ASSIGN   3017>>ASSIGN   3037<<ASSIGN   3043>>IF       3046>>IF
ERROR
PL6.E3A0      #001=ZIM$ENQM File=ZIM$ENQM.:ZIC0TSI                               FRI 09/05/97 12:52 Page:37   
      2951**DCL      3091<<ASSIGN   3095<<ASSIGN   3106>>ASSIGN
ER_ENQ IN PROCEDURE ENQIT
      3069**LABEL    3068--CALLALT
FPT$ENQ
       118**DCL      3068<>CALL
FPT$ENQ.V.DCB#
       119**DCL      3065<<ASSIGN   3097>>ASSIGN
FPT$ENQ.V.SHARE#
       120**DCL      3066<<ASSIGN
FPT$ENQ.V.WAIT_TIME#
       122**DCL      2955<<ASSIGN   2957<<ASSIGN   3013<<ASSIGN   3081>>IF
GLOBAL.ACTIVE.DBCB$
      1169**DCL      1170--REDEF
GLOBAL.ACTIVE.SSS$
      1165**DCL      1166--REDEF
GLOBAL.ENQ.LIST.BASE$
      1301**DCL      2980>>IF       2981<<ASSIGN   2982>>ASSIGN   3014>>ASSIGN   3037>>ASSIGN
GLOBAL.ENQ.LIST.COUNT
      1305**DCL      2970>>IF       2987>>IF       2991<<ASSIGN   2991>>ASSIGN   3040>>ASSIGN
GLOBAL.ENQ.LIST.INDX
      1303**DCL      3015>>ASSIGN   3017>>ASSIGN   3050<<ASSIGN   3056<<ASSIGN
GLOBAL.ENQ.LIST.MAXCOUNT
      1307**DCL      2970>>IF       2978<<ASSIGN   2978>>ASSIGN
GLOBAL.ENQ.SHARE
      1289**DCL      2961>>IF       2994>>IF       3016<<ASSIGN   3066>>ASSIGN
GLOBAL.ENQ.VALUE
      1294**DCL      2993>>ASSIGN   3015<<ASSIGN   3043>>IF       3046>>IF
GLOBAL.ENQ.VALUE.DCB#
      1296**DCL      3065>>ASSIGN
GLOBAL.ENQ.VALUE.RNAME
      1298**DCL      3067>>ASSIGN
GLOBAL.ENQ$
      1438**DCL      2955>>ASSIGN   2957>>ASSIGN   3013>>ASSIGN   3065>>ASSIGN   3066>>ASSIGN   3068>>CALL
      3081>>IF       3097>>ASSIGN
GLOBAL.KEY
      1373**DCL      1376--REDEF
PL6.E3A0      #001=ZIM$ENQM File=ZIM$ENQM.:ZIC0TSI                               FRI 09/05/97 12:52 Page:38   
GLOBAL.PARAN.TRACE.MODE
      1248**DCL      1255--REDEF
GLOBAL.PRINTBUF.BUFFER
      1407**DCL      1408--REDEF    1409--REDEF    1410--REDEF
GLOBAL.PRINTBUF.ERR.V
      1412**DCL      1415--REDEF    1416--REDEF    1417--REDEF
GLOBAL.RET.AC#
      1185**DCL      3102<<ASSIGN
GLOBAL.RET.DCB#
      1189**DCL      3097<<ASSIGN
GLOBAL.RET.ERROR#
      1183**DCL      2974<<ASSIGN   3074<<ASSIGN   3100>>IF       3106<<ASSIGN   3108>>IF
GLOBAL.RET.FR#
      1186**DCL      3105<<ASSIGN
GLOBAL.RET.RC#
      1188**DCL      3104<<ASSIGN
GLOBAL.RET.SC#
      1187**DCL      3103<<ASSIGN
GLOBAL.RET.SYSERR#
      1184**DCL      2975<<ASSIGN   3075<<ASSIGN   3096<<ASSIGN
GLOBAL.RNAME.VALUE
      1392**DCL      3067<<ASSIGN
GLOBAL.STATS.CURR.ENQS
      1325**DCL      3069<<ASSIGN   3069>>ASSIGN
GLOBAL.STATS.CURR.LOCKS
      1326**DCL      3083<<ASSIGN   3083>>ASSIGN
GLOBAL.TJRNL.DCB#
      1352**DCL      3081>>IF
GLOBAL$
      1467**DCL      1163--IMP-PTR  2955>>ASSIGN   2957>>ASSIGN   2961>>IF       2970>>IF       2970>>IF
      2972<>CALL     2974>>ASSIGN   2975>>ASSIGN   2978>>ASSIGN   2978>>ASSIGN   2980>>IF       2981>>ASSIGN
      2982>>ASSIGN   2987>>IF       2991>>ASSIGN   2991>>ASSIGN   2993>>ASSIGN   2994>>IF       3013>>ASSIGN
      3014>>ASSIGN   3015>>ASSIGN   3015>>ASSIGN   3016>>ASSIGN   3017>>ASSIGN   3037>>ASSIGN   3040>>ASSIGN
      3043>>IF       3046>>IF       3050>>ASSIGN   3056>>ASSIGN   3065>>ASSIGN   3065>>ASSIGN   3066>>ASSIGN
      3066>>ASSIGN   3067>>ASSIGN   3067>>ASSIGN   3068>>CALL     3069>>ASSIGN   3069>>ASSIGN   3074>>ASSIGN
      3075>>ASSIGN   3081>>IF       3081>>IF       3083>>ASSIGN   3083>>ASSIGN   3096>>ASSIGN   3097>>ASSIGN
PL6.E3A0      #001=ZIM$ENQM File=ZIM$ENQM.:ZIC0TSI                               FRI 09/05/97 12:52 Page:39   
      3097>>ASSIGN   3100>>IF       3102>>ASSIGN   3103>>ASSIGN   3104>>ASSIGN   3105>>ASSIGN   3106>>ASSIGN
      3108>>IF
HIGH IN PROCEDURE BSEARCH
      3035**DCL      3040<<ASSIGN   3041>>DOWHILE  3042>>ASSIGN   3047<<ASSIGN
INDX
      2950**DCL      2961>>IF       2964>>ASSIGN   2987>>IF       2989<>CALL     2992>>ASSIGN   2993>>ASSIGN
      2995>>ASSIGN   3039<<ASSIGN   3041>>DOWHILE  3042>>ASSIGN   3044<<ASSIGN   3049<<ASSIGN   3050>>ASSIGN
      3056>>ASSIGN
M$ENQ
       101**DCL-ENT  3068--CALL
M$ERR
        47**DCL-ENT  2976--CALL     3076--CALL     3086--CALL
MIDDLE IN PROCEDURE BSEARCH
      3034**DCL      3042<<ASSIGN   3043>>IF       3044>>ASSIGN   3046>>IF       3047>>ASSIGN   3049>>ASSIGN
PTR$
      2952**DCL      2972<>CALL     2981>>ASSIGN
P_WAIT
      2948**DCL        25--PROC     2954--IF       2957>>ASSIGN
RET
      3019**LABEL    2966--GOTO     2996--GOTO     3001--GOTO
ZIB$ERR
      1468**DCL-ENT  3111--CALL
ZIM$PROL
      2944**DCL-ENT  3084--CALL
ZIM$SHIFT_ENQLIST
      2945**DCL-ENT  2989--CALL
ZIO$GETSEG
      2946**DCL-ENT  2972--CALL

PL6.E3A0      #002=ZIM$INDXMAP_ADD File=ZIM$ENQM.:ZIC0TSI                        FRI 09/05/97 12:52 Page:40   
      198        1        /*T***********************************************************/
      199        2        /*T*                                                         */
      200        3        /*T* Copyright (c) Bull HN Information Systems Inc., 1997    */
      201        4        /*T*                                                         */
      202        5        /*T***********************************************************/
      203        6        /*F*
      204        7        NAME:   ZIM$INDXMAP_ADD
      205        8        PURPOSE:Maintain map between INDXLIST and ENQLIST.
      206        9        */
      207       10        /*D*
      208       11        NAME:   ZIM$INDXMAP_ADD
      209       12        CALL:   CALL ZIM$INDXMAP_ADD ALTRET;
      210       13        INPUT:  GLOBAL.ENQ.VALUE.DCB# - The DCB# of the file.
      211       14                GLOBAL.ENQ.VALUE.RNAME - Effective page number for indexed.
      212       15                GLOBAL.KEYID.RECID - The indexed record id.
      213       16        DESCRIPTION:
      214       17            INDXMAP is an array that maps unique RECIDs of indexed records
      215       18            into the non-unique INDXMAP entry that is used to lock the
      216       19            records (a hash of the primary key).
      217       20
      218       21            Since this is a many to one mapping, care must be taken
      219       22            when eliminating entries from the INDXMAP.  This can only
      220       23            be done if none of the INDXMAP entries point to it anymore.
      221       24        */
      222       25
      223       26        %EJECT;
PL6.E3A0      #002=ZIM$INDXMAP_ADD File=ZIM$ENQM.:ZIC0TSI                        FRI 09/05/97 12:52 Page:41   
      224       27        ZIM$INDXMAP_ADD: PROC ALTRET AVOID($PR5, $PR6, $PR7);
      225       28
      226       29        %INCLUDE ZI$GLOBAL;
      227      515         %GLOBALS;
      228      823         %ENQLIST;
      229      841         %INDXMAP;
      230      857        %INCLUDE CP_6;
      231      938         %B$ALT;
      232      946         %B$TCB;
      233      949        %INCLUDE CP_6_SUBS;
      234     1489
      235     1490        %INCLUDE B_ERRORS_C;
      236     2617        %INCLUDE ZI_ERRORS_C;
      237     2943    1   DCL INDX SBIN;
      238     2944    1   DCL STOP SBIN;
      239     2945    1   DCL PTR$ PTR;
      240     2946
      241     2947    1   DCL ZIM$MRL_SHIFT ENTRY(3);
      242     2948    1   DCL ZIO$GETSEG ENTRY(3) ALTRET;
      243     2949    1   DCL B$TCB$ PTR SYMREF;
      244     2950
      245     2951        %EJECT;
PL6.E3A0      #002=ZIM$INDXMAP_ADD File=ZIM$ENQM.:ZIC0TSI                        FRI 09/05/97 12:52 Page:42   
      246     2952    1       CALL BSEARCH
      247     2953    2       WHENRETURN DO;
      248     2954    2           IF GLOBAL.ENQ.SHARE=%NONE# THEN
      249     2955    2               INDXMAP.STATUS.MODIFY(INDX)=%YES#;
      250     2956    2           GOTO RET;
      251     2957    2           END;
      252     2958
      253     2959        /*      Check for space for INDXMAP array. */
      254     2960    2       IF GLOBAL.ENQ.INDXMAP.COUNT+1>=GLOBAL.ENQ.INDXMAP.MAXCOUNT THEN DO;
      255     2961    2           CALL ZIO$GETSEG(GLOBAL.DB.DBCB$(1),512,PTR$)
      256     2962    3           WHENALTRETURN DO;
      257     2963    3               GLOBAL.RET.ERROR#=ERR#CAC#MEM;
      258     2964    3               GLOBAL.RET.SYSERR#=B$TCB$->B$TCB.ALT$->B$ALT.ERR;
      259     2965    3               CALL M$ERR;
      260     2966    3               END;
      261     2967    2           GLOBAL.ENQ.INDXMAP.MAXCOUNT=GLOBAL.ENQ.INDXMAP.MAXCOUNT+
      262     2968    2              512/SIZEW(INDXMAP(0));
      263     2969    3           IF GLOBAL.ENQ.INDXMAP.BASE$=ADDR(NIL) THEN DO;
      264     2970    3               GLOBAL.ENQ.INDXMAP.BASE$=PTR$;
      265     2971    3               INDXMAP$=GLOBAL.ENQ.INDXMAP.BASE$;
      266     2972    3               END;
      267     2973    2           END;
      268     2974
      269     2975        /*      Make room for new entry in INDXMAP array. */
      270     2976    1       IF INDX<=GLOBAL.ENQ.INDXMAP.COUNT THEN
      271     2977    1           CALL ZIM$MRL_SHIFT(ADDR(INDXMAP(INDX)),
      272     2978    1              ADDR(INDXMAP(INDX+1)),
      273     2979    1              (GLOBAL.ENQ.INDXMAP.COUNT-INDX+1)*SIZEC(INDXMAP(0)));
      274     2980
      275     2981        /*      Fill it in. */
      276     2982    1       GLOBAL.ENQ.INDXMAP.COUNT=GLOBAL.ENQ.INDXMAP.COUNT+1;
      277     2983    1       INDXMAP(INDX)='0'B;
      278     2984    1       INDXMAP.RECID(INDX)=GLOBAL.KEYID.RECID;
      279     2985    1       INDXMAP.ENQINDX(INDX)=GLOBAL.ENQ.LIST.INDX;
      280     2986    1       IF GLOBAL.ENQ.SHARE=%NONE# THEN
      281     2987    1           INDXMAP.STATUS.MODIFY(INDX)=%YES#;
      282     2988    1       GOTO RET;
PL6.E3A0      #002=ZIM$INDXMAP_ADD File=ZIM$ENQM.:ZIC0TSI                        FRI 09/05/97 12:52 Page:43   
      283     2989
      284     2990        %EJECT;
PL6.E3A0      #002=ZIM$INDXMAP_ADD File=ZIM$ENQM.:ZIC0TSI                        FRI 09/05/97 12:52 Page:44   
      285     2991    1   ZIM$INDXMAP_FIND: ENTRY ALTRET;
      286     2992
      287     2993    1       CALL BSEARCH ALTRET(ALT);
      288     2994
      289     2995    1   RET:RETURN;
      290     2996    1   ALT:ALTRETURN;
      291     2997        %EJECT;
PL6.E3A0      #002=ZIM$INDXMAP_ADD File=ZIM$ENQM.:ZIC0TSI                        FRI 09/05/97 12:52 Page:45   
      292     2998        /*I*
      293     2999        NAME:   BSEARCH
      294     3000        PURPOSE:Does binary search on the INDXMAP table
      295     3001        DESCRIPTION:
      296     3002            If KEY is found in the table, the routine RETURNs with INDX set to
      297     3003            the index of the entry. If it is not found, the routine ALTRETURNs
      298     3004            with INDX set to the position in the table where the entry
      299     3005            belongs.
      300     3006        */
      301     3007
      302     3008    1   BSEARCH: PROC ALTRET;
      303     3009
      304     3010    2   DCL MIDDLE SBIN;
      305     3011    2   DCL HIGH SBIN;
      306     3012
      307     3013    2       INDXMAP$=GLOBAL.ENQ.INDXMAP.BASE$;
      308     3014
      309     3015    2       INDX=1;
      310     3016    2       HIGH = GLOBAL.ENQ.INDXMAP.COUNT;
      311     3017    3       DO WHILE (INDX<=HIGH);
      312     3018    3           MIDDLE=(INDX+HIGH)/2;
      313     3019    3           IF INDXMAP.RECID(MIDDLE)<GLOBAL.KEYID.RECID THEN
      314     3020    3               INDX=MIDDLE+1;
      315     3021    3           ELSE
      316     3022    3               IF INDXMAP.RECID(MIDDLE)>GLOBAL.KEYID.RECID THEN
      317     3023    3                   HIGH=MIDDLE-1;
      318     3024    4               ELSE DO;
      319     3025    4                   INDX=MIDDLE;
      320     3026    4                   GLOBAL.ENQ.INDXMAP.INDX=INDX;
      321     3027    4                   RETURN;
      322     3028    4                   END;
      323     3029    3           END;
      324     3030
      325     3031        /*      Entry not found.  Return where it should go. */
      326     3032    2       GLOBAL.ENQ.INDXMAP.INDX=INDX;
      327     3033    2   ALT:ALTRETURN;
      328     3034
PL6.E3A0      #002=ZIM$INDXMAP_ADD File=ZIM$ENQM.:ZIC0TSI                        FRI 09/05/97 12:52 Page:46   
      329     3035    2   END BSEARCH;
      330     3036    1   END ZIM$INDXMAP_ADD;
      331     3037        %EOD;

PL6.E3A0      #002=ZIM$INDXMAP_ADD File=ZIM$ENQM.:ZIC0TSI                        FRI 09/05/97 12:52 Page:47   
--  Include file information  --

   ZI_ERRORS_C.:ZIC0TOU  is referenced.
   B_ERRORS_C.:LIB_E05  is referenced.
   CP_6_SUBS.:LIB_E05  is referenced.
   CP_6.:LIB_E05  cannot be made into a system file and is referenced.
   ZI$GLOBAL.:ZIC0TOU  is referenced.
   B$JIT_C.:E05TOU  was found in the system file and is never referenced.
   CP_6_C.:E05TOU  was found in the system file and is referenced.
      No diagnostics issued in procedure ZIM$INDXMAP_ADD.

   Procedure ZIM$INDXMAP_ADD requires 161 words for executable code.
   Procedure ZIM$INDXMAP_ADD requires 20 words of local(AUTO) storage.

PL6.E3A0      #002=ZIM$INDXMAP_ADD File=ZIM$ENQM.:ZIC0TSI                        FRI 09/05/97 12:52 Page:48   

 Object Unit name= ZIM$INDXMAP_ADD                            File name= ZIM$ENQM.:ZIC0TOU
 UTS= SEP 05 '97 12:52:57.84 FRI                              Compiler= PL-6/E31         Sev=      00
 SharedLib= :SHARED_SYSTEM                                    Alt SharedLib=


    ****  Control sections  ****

 Sect   Type Bound  Init  Size OctSiz  Section name(segment info)
    0   DCB   even  none     0      0  M$UC
    1   Proc  even  none   161    241  ZIM$INDXMAP_ADD
    2  RoData even  none     5      5  ZIM$INDXMAP_ADD

    ****  Entry defs  ****

                              Check   Calling
                             calling  sequence
  Sect OctLoc Primary Altret sequence   type   Parms  Name
     1      0   yes    yes     yes      XStd       0  ZIM$INDXMAP_ADD
     1    155          yes     yes      XStd       0  ZIM$INDXMAP_FIND

  ****  Entry refs  ****

         Check        Calling
        calling       sequence
Altret sequence SRef   type   Args  Name
 yes     yes           XStd      3 ZIO$GETSEG
         yes           XStd      3 ZIM$MRL_SHIFT
                       nStd      0 X66_AUTO_0
                       nStd      0 X66_ARET
                       nStd      0 X66_AALT

  ****  Data refs  ****

  Flags:  r = read only, s = secondary
Flgs Name                             Flgs Name                             Flgs Name
r    GLOBAL$                               M$UC                                  B$TCB$
PL6.E3A0      #002=ZIM$INDXMAP_ADD File=ZIM$ENQM.:ZIC0TSI                        FRI 09/05/97 12:52 Page:49   

  ****  Segment refs  ****

  Flags:  r = read only, s = secondary
Flgs Name                             Flgs Name                             Flgs Name
     NULLSID                               ISSID
PL6.E3A0      #002=ZIM$INDXMAP_ADD File=ZIM$ENQM.:ZIC0TSI                        FRI 09/05/97 12:52 Page:50   


      198        1        /*T***********************************************************/
      199        2        /*T*                                                         */
      200        3        /*T* Copyright (c) Bull HN Information Systems Inc., 1997    */
      201        4        /*T*                                                         */
      202        5        /*T***********************************************************/
      203        6        /*F*
      204        7        NAME:   ZIM$INDXMAP_ADD
      205        8        PURPOSE:Maintain map between INDXLIST and ENQLIST.
      206        9        */
      207       10        /*D*
      208       11        NAME:   ZIM$INDXMAP_ADD
      209       12        CALL:   CALL ZIM$INDXMAP_ADD ALTRET;
      210       13        INPUT:  GLOBAL.ENQ.VALUE.DCB# - The DCB# of the file.
      211       14                GLOBAL.ENQ.VALUE.RNAME - Effective page number for indexed.
      212       15                GLOBAL.KEYID.RECID - The indexed record id.
      213       16        DESCRIPTION:
      214       17            INDXMAP is an array that maps unique RECIDs of indexed records
      215       18            into the non-unique INDXMAP entry that is used to lock the
      216       19            records (a hash of the primary key).
      217       20
      218       21            Since this is a many to one mapping, care must be taken
      219       22            when eliminating entries from the INDXMAP.  This can only
      220       23            be done if none of the INDXMAP entries point to it anymore.
      221       24        */
      222       25
      223       26        %EJECT;
PL6.E3A0      #002=ZIM$INDXMAP_ADD File=ZIM$ENQM.:ZIC0TSI                        FRI 09/05/97 12:52 Page:51   
      224       27        ZIM$INDXMAP_ADD: PROC ALTRET AVOID($PR5, $PR6, $PR7);

     27  1 000000   000000 700200 xent  ZIM$INDXMAP* TSX0  ! X66_AUTO_0
         1 000001   000024 000000                    ZERO    20,0

      225       28
      226       29        %INCLUDE ZI$GLOBAL;
      227      515         %GLOBALS;
      228      823         %ENQLIST;
      229      841         %INDXMAP;
      230      857        %INCLUDE CP_6;
      231      938         %B$ALT;
      232      946         %B$TCB;
      233      949        %INCLUDE CP_6_SUBS;
      234     1489
      235     1490        %INCLUDE B_ERRORS_C;
      236     2617        %INCLUDE ZI_ERRORS_C;
      237     2943    1   DCL INDX SBIN;
      238     2944    1   DCL STOP SBIN;
      239     2945    1   DCL PTR$ PTR;
      240     2946
      241     2947    1   DCL ZIM$MRL_SHIFT ENTRY(3);
      242     2948    1   DCL ZIO$GETSEG ENTRY(3) ALTRET;
      243     2949    1   DCL B$TCB$ PTR SYMREF;
      244     2950
      245     2951        %EJECT;
PL6.E3A0      #002=ZIM$INDXMAP_ADD File=ZIM$ENQM.:ZIC0TSI                        FRI 09/05/97 12:52 Page:52   
      246     2952    1       CALL BSEARCH

   2952  1 000002   000163 701000 1                  TSX1    BSEARCH
         1 000003   000017 702000 1                  TSX2    s:2960

      247     2953    2       WHENRETURN DO;

      248     2954    2           IF GLOBAL.ENQ.SHARE=%NONE# THEN

   2954  1 000004   000000 470400 xsym               LDP0    GLOBAL$
         1 000005   001407 236100                    LDQ     775,,PR0
         1 000006   777000 376003                    ANQ     -512,DU
         1 000007   003000 116003                    CMPQ    1536,DU
         1 000010   000016 601000 1                  TNZ     s:2956

      249     2955    2               INDXMAP.STATUS.MODIFY(INDX)=%YES#;

   2955  1 000011   200005 235100                    LDA     INDX,,AUTO
         1 000012   000001 735000                    ALS     1
         1 000013   200004 471500                    LDP1    INDXMAP$,,AUTO
         1 000014   100000 236003                    LDQ     32768,DU
         1 000015   100000 256105                    ORSQ    0,AL,PR1

      250     2956    2           GOTO RET;

   2956  1 000016   000161 710000 1                  TRA     RET

      251     2957    2           END;
      252     2958
      253     2959        /*      Check for space for INDXMAP array. */
      254     2960    2       IF GLOBAL.ENQ.INDXMAP.COUNT+1>=GLOBAL.ENQ.INDXMAP.MAXCOUNT THEN DO;

   2960  1 000017   000000 470400 xsym               LDP0    GLOBAL$
         1 000020   001414 236100                    LDQ     780,,PR0
         1 000021   777777 376007                    ANQ     -1,DL
         1 000022   200014 756100                    STQ     HIGH+2,,AUTO
         1 000023   001414 236100                    LDQ     780,,PR0
PL6.E3A0      #002=ZIM$INDXMAP_ADD File=ZIM$ENQM.:ZIC0TSI                        FRI 09/05/97 12:52 Page:53   
         1 000024   000022 772000                    QRL     18
         1 000025   000001 036007                    ADLQ    1,DL
         1 000026   200014 116100                    CMPQ    HIGH+2,,AUTO
         1 000027   000067 604000 1                  TMI     s:2976

      255     2961    2           CALL ZIO$GETSEG(GLOBAL.DB.DBCB$(1),512,PTR$)

   2961  1 000030   200007 631500                    EPPR1   PTR$,,AUTO
         1 000031   200016 451500                    STP1    HIGH+4,,AUTO
         1 000032   000002 236000 2                  LDQ     2
         1 000033   200015 756100                    STQ     HIGH+3,,AUTO
         1 000034   000000 236000 xsym               LDQ     GLOBAL$
         1 000035   000162 036003                    ADLQ    114,DU
         1 000036   200014 756100                    STQ     HIGH+2,,AUTO
         1 000037   200014 630500                    EPPR0   HIGH+2,,AUTO
         1 000040   000000 631400 2                  EPPR1   0
         1 000041   000000 701000 xent               TSX1    ZIO$GETSEG
         1 000042   000044 702000 1                  TSX2    s:2963
         1 000043   000055 710000 1                  TRA     s:2967

      256     2962    3           WHENALTRETURN DO;

      257     2963    3               GLOBAL.RET.ERROR#=ERR#CAC#MEM;

   2963  1 000044   210770 235007                    LDA     70136,DL
         1 000045   000000 470400 xsym               LDP0    GLOBAL$
         1 000046   000006 755100                    STA     6,,PR0

      258     2964    3               GLOBAL.RET.SYSERR#=B$TCB$->B$TCB.ALT$->B$ALT.ERR;

   2964  1 000047   000000 471400 xsym               LDP1    B$TCB$
         1 000050   100000 473500                    LDP3    0,,PR1
         1 000051   300102 236100                    LDQ     66,,PR3
         1 000052   000007 756100                    STQ     7,,PR0

      259     2965    3               CALL M$ERR;

PL6.E3A0      #002=ZIM$INDXMAP_ADD File=ZIM$ENQM.:ZIC0TSI                        FRI 09/05/97 12:52 Page:54   
   2965  1 000053   000002 713400                    CLIMB   err
         1 000054   000000 401760                    pmme    nvectors=0

      260     2966    3               END;

      261     2967    2           GLOBAL.ENQ.INDXMAP.MAXCOUNT=GLOBAL.ENQ.INDXMAP.MAXCOUNT+

   2967  1 000055   000000 470400 xsym               LDP0    GLOBAL$
         1 000056   001414 720100                    LXL0    780,,PR0
         1 000057   000400 621010                    EAX1    256,X0
         1 000060   001414 441100                    SXL1    780,,PR0

      262     2968    2              512/SIZEW(INDXMAP(0));
      263     2969    3           IF GLOBAL.ENQ.INDXMAP.BASE$=ADDR(NIL) THEN DO;

   2969  1 000061   001415 236100                    LDQ     781,,PR0
         1 000062   000003 116000 2                  CMPQ    3
         1 000063   000067 601000 1                  TNZ     s:2976

      264     2970    3               GLOBAL.ENQ.INDXMAP.BASE$=PTR$;

   2970  1 000064   200007 236100                    LDQ     PTR$,,AUTO
         1 000065   001415 756100                    STQ     781,,PR0

      265     2971    3               INDXMAP$=GLOBAL.ENQ.INDXMAP.BASE$;

   2971  1 000066   200004 756100                    STQ     INDXMAP$,,AUTO

      266     2972    3               END;

      267     2973    2           END;

      268     2974
      269     2975        /*      Make room for new entry in INDXMAP array. */
      270     2976    1       IF INDX<=GLOBAL.ENQ.INDXMAP.COUNT THEN

   2976  1 000067   001414 236100                    LDQ     780,,PR0
PL6.E3A0      #002=ZIM$INDXMAP_ADD File=ZIM$ENQM.:ZIC0TSI                        FRI 09/05/97 12:52 Page:55   
         1 000070   000022 772000                    QRL     18
         1 000071   200005 116100                    CMPQ    INDX,,AUTO
         1 000072   000124 604000 1                  TMI     s:2982

      271     2977    1           CALL ZIM$MRL_SHIFT(ADDR(INDXMAP(INDX)),

   2977  1 000073   200005 136100                    SBLQ    INDX,,AUTO
         1 000074   200015 756100                    STQ     HIGH+3,,AUTO
         1 000075   200005 236100                    LDQ     INDX,,AUTO
         1 000076   000023 736000                    QLS     19
         1 000077   200004 036100                    ADLQ    INDXMAP$,,AUTO
         1 000100   200014 756100                    STQ     HIGH+2,,AUTO
         1 000101   200005 236100                    LDQ     INDX,,AUTO
         1 000102   000023 736000                    QLS     19
         1 000103   000002 036003                    ADLQ    2,DU
         1 000104   200004 036100                    ADLQ    INDXMAP$,,AUTO
         1 000105   200016 756100                    STQ     HIGH+4,,AUTO
         1 000106   200015 235100                    LDA     HIGH+3,,AUTO
         1 000107   000003 735000                    ALS     3
         1 000110   000010 035007                    ADLA    8,DL
         1 000111   200017 755100                    STA     HIGH+5,,AUTO
         1 000112   200017 631500                    EPPR1   HIGH+5,,AUTO
         1 000113   200022 451500                    STP1    HIGH+8,,AUTO
         1 000114   200016 633500                    EPPR3   HIGH+4,,AUTO
         1 000115   200021 453500                    STP3    HIGH+7,,AUTO
         1 000116   200014 634500                    EPPR4   HIGH+2,,AUTO
         1 000117   200020 454500                    STP4    HIGH+6,,AUTO
         1 000120   200020 630500                    EPPR0   HIGH+6,,AUTO
         1 000121   000000 631400 2                  EPPR1   0
         1 000122   000000 701000 xent               TSX1    ZIM$MRL_SHIFT
         1 000123   000000 011000                    NOP     0

      272     2978    1              ADDR(INDXMAP(INDX+1)),
      273     2979    1              (GLOBAL.ENQ.INDXMAP.COUNT-INDX+1)*SIZEC(INDXMAP(0)));
      274     2980
      275     2981        /*      Fill it in. */
      276     2982    1       GLOBAL.ENQ.INDXMAP.COUNT=GLOBAL.ENQ.INDXMAP.COUNT+1;
PL6.E3A0      #002=ZIM$INDXMAP_ADD File=ZIM$ENQM.:ZIC0TSI                        FRI 09/05/97 12:52 Page:56   

   2982  1 000124   000000 470400 xsym               LDP0    GLOBAL$
         1 000125   001414 220100                    LDX0    780,,PR0
         1 000126   000001 621010                    EAX1    1,X0
         1 000127   001414 741100                    STX1    780,,PR0

      277     2983    1       INDXMAP(INDX)='0'B;

   2983  1 000130   200005 235100                    LDA     INDX,,AUTO
         1 000131   000001 735000                    ALS     1
         1 000132   200004 471500                    LDP1    INDXMAP$,,AUTO
         1 000133   100000 450105                    STZ     0,AL,PR1
         1 000134   100001 450105                    STZ     1,AL,PR1

      278     2984    1       INDXMAP.RECID(INDX)=GLOBAL.KEYID.RECID;

   2984  1 000135   000000 620005                    EAX0    0,AL
         1 000136   005012 235100                    LDA     2570,,PR0
         1 000137   100001 755110                    STA     1,X0,PR1

      279     2985    1       INDXMAP.ENQINDX(INDX)=GLOBAL.ENQ.LIST.INDX;

   2985  1 000140   001412 236100                    LDQ     778,,PR0
         1 000141   777777 376003                    ANQ     -1,DU
         1 000142   000022 772000                    QRL     18
         1 000143   100000 676110                    ERQ     0,X0,PR1
         1 000144   000004 376000 2                  ANQ     4
         1 000145   100000 656110                    ERSQ    0,X0,PR1

      280     2986    1       IF GLOBAL.ENQ.SHARE=%NONE# THEN

   2986  1 000146   001407 236100                    LDQ     775,,PR0
         1 000147   777000 376003                    ANQ     -512,DU
         1 000150   003000 116003                    CMPQ    1536,DU
         1 000151   000154 601000 1                  TNZ     s:2988

      281     2987    1           INDXMAP.STATUS.MODIFY(INDX)=%YES#;
PL6.E3A0      #002=ZIM$INDXMAP_ADD File=ZIM$ENQM.:ZIC0TSI                        FRI 09/05/97 12:52 Page:57   

   2987  1 000152   100000 236003                    LDQ     32768,DU
         1 000153   100000 256110                    ORSQ    0,X0,PR1

      282     2988    1       GOTO RET;

   2988  1 000154   000161 710000 1                  TRA     RET

      283     2989
      284     2990        %EJECT;
PL6.E3A0      #002=ZIM$INDXMAP_ADD File=ZIM$ENQM.:ZIC0TSI                        FRI 09/05/97 12:52 Page:58   
      285     2991    1   ZIM$INDXMAP_FIND: ENTRY ALTRET;

   2991  1 000155   000000 700200 xent  ZIM$INDXMAP* TSX0  ! X66_AUTO_0
         1 000156   000024 000000                    ZERO    20,0

      286     2992
      287     2993    1       CALL BSEARCH ALTRET(ALT);

   2993  1 000157   000163 701000 1                  TSX1    BSEARCH
         1 000160   000162 702000 1                  TSX2    ALT

      288     2994
      289     2995    1   RET:RETURN;

   2995  1 000161   000000 702200 xent  RET          TSX2  ! X66_ARET

      290     2996    1   ALT:ALTRETURN;

   2996  1 000162   000000 702200 xent  ALT          TSX2  ! X66_AALT

      291     2997        %EJECT;
PL6.E3A0      #002=ZIM$INDXMAP_ADD File=ZIM$ENQM.:ZIC0TSI                        FRI 09/05/97 12:52 Page:59   
      292     2998        /*I*
      293     2999        NAME:   BSEARCH
      294     3000        PURPOSE:Does binary search on the INDXMAP table
      295     3001        DESCRIPTION:
      296     3002            If KEY is found in the table, the routine RETURNs with INDX set to
      297     3003            the index of the entry. If it is not found, the routine ALTRETURNs
      298     3004            with INDX set to the position in the table where the entry
      299     3005            belongs.
      300     3006        */
      301     3007
      302     3008    1   BSEARCH: PROC ALTRET;

   3008  1 000163   200010 741300       BSEARCH      STX1  ! PTR$+1,,AUTO

      303     3009
      304     3010    2   DCL MIDDLE SBIN;
      305     3011    2   DCL HIGH SBIN;
      306     3012
      307     3013    2       INDXMAP$=GLOBAL.ENQ.INDXMAP.BASE$;

   3013  1 000164   000000 470400 xsym               LDP0    GLOBAL$
         1 000165   001415 236100                    LDQ     781,,PR0
         1 000166   200004 756100                    STQ     INDXMAP$,,AUTO

      308     3014
      309     3015    2       INDX=1;

   3015  1 000167   000001 235007                    LDA     1,DL
         1 000170   200005 755100                    STA     INDX,,AUTO

      310     3016    2       HIGH = GLOBAL.ENQ.INDXMAP.COUNT;

   3016  1 000171   001414 236100                    LDQ     780,,PR0
         1 000172   000022 772000                    QRL     18
         1 000173   200012 756100                    STQ     HIGH,,AUTO

      311     3017    3       DO WHILE (INDX<=HIGH);
PL6.E3A0      #002=ZIM$INDXMAP_ADD File=ZIM$ENQM.:ZIC0TSI                        FRI 09/05/97 12:52 Page:60   

   3017  1 000174   200005 116100                    CMPQ    INDX,,AUTO
         1 000175   000235 604000 1                  TMI     s:3032

      312     3018    3           MIDDLE=(INDX+HIGH)/2;

   3018  1 000176   200005 236100                    LDQ     INDX,,AUTO
         1 000177   200012 036100                    ADLQ    HIGH,,AUTO
         1 000200   000002 506007                    DIV     2,DL
         1 000201   200011 756100                    STQ     MIDDLE,,AUTO

      313     3019    3           IF INDXMAP.RECID(MIDDLE)<GLOBAL.KEYID.RECID THEN

   3019  1 000202   000000 470400 xsym               LDP0    GLOBAL$
         1 000203   200011 235100                    LDA     MIDDLE,,AUTO
         1 000204   000001 735000                    ALS     1
         1 000205   200004 471500                    LDP1    INDXMAP$,,AUTO
         1 000206   100001 236105                    LDQ     1,AL,PR1
         1 000207   005012 116100                    CMPQ    2570,,PR0
         1 000210   000215 603000 1                  TRC     s:3022

      314     3020    3               INDX=MIDDLE+1;

   3020  1 000211   200011 235100                    LDA     MIDDLE,,AUTO
         1 000212   000001 035007                    ADLA    1,DL
         1 000213   200005 755100                    STA     INDX,,AUTO
         1 000214   000232 710000 1                  TRA     s:3029

      315     3021    3           ELSE
      316     3022    3               IF INDXMAP.RECID(MIDDLE)>GLOBAL.KEYID.RECID THEN

   3022  1 000215   005012 236100                    LDQ     2570,,PR0
         1 000216   100001 116105                    CMPQ    1,AL,PR1
         1 000217   000224 603000 1                  TRC     s:3025

      317     3023    3                   HIGH=MIDDLE-1;

PL6.E3A0      #002=ZIM$INDXMAP_ADD File=ZIM$ENQM.:ZIC0TSI                        FRI 09/05/97 12:52 Page:61   
   3023  1 000220   200011 235100                    LDA     MIDDLE,,AUTO
         1 000221   000001 135007                    SBLA    1,DL
         1 000222   200012 755100                    STA     HIGH,,AUTO
         1 000223   000232 710000 1                  TRA     s:3029

      318     3024    4               ELSE DO;

      319     3025    4                   INDX=MIDDLE;

   3025  1 000224   200011 235100                    LDA     MIDDLE,,AUTO
         1 000225   200005 755100                    STA     INDX,,AUTO

      320     3026    4                   GLOBAL.ENQ.INDXMAP.INDX=INDX;

   3026  1 000226   000000 620005                    EAX0    0,AL
         1 000227   001413 440100                    SXL0    779,,PR0

      321     3027    4                   RETURN;

   3027  1 000230   200010 221300                    LDX1  ! PTR$+1,,AUTO
         1 000231   000001 702211                    TSX2  ! 1,X1

      322     3028    4                   END;
      323     3029    3           END;

   3029  1 000232   200005 236100                    LDQ     INDX,,AUTO
         1 000233   200012 116100                    CMPQ    HIGH,,AUTO
         1 000234   000176 604400 1                  TMOZ    s:3018

      324     3030
      325     3031        /*      Entry not found.  Return where it should go. */
      326     3032    2       GLOBAL.ENQ.INDXMAP.INDX=INDX;

   3032  1 000235   200005 720100                    LXL0    INDX,,AUTO
         1 000236   001413 440100                    SXL0    779,,PR0

      327     3033    2   ALT:ALTRETURN;
PL6.E3A0      #002=ZIM$INDXMAP_ADD File=ZIM$ENQM.:ZIC0TSI                        FRI 09/05/97 12:52 Page:62   

   3033  1 000237   200010 221300       ALT          LDX1  ! PTR$+1,,AUTO
         1 000240   000000 702211                    TSX2  ! 0,X1

(unnamed)
 Sect OctLoc
   2     000   000003 000000   000000 001000   000001 006000   000000 006014    ................
   2     004   000777 777777                                                    ....
      328     3034
      329     3035    2   END BSEARCH;
      330     3036    1   END ZIM$INDXMAP_ADD;
      331     3037        %EOD;

PL6.E3A0      #002=ZIM$INDXMAP_ADD File=ZIM$ENQM.:ZIC0TSI                        FRI 09/05/97 12:52 Page:63   
--  Include file information  --

   ZI_ERRORS_C.:ZIC0TOU  is referenced.
   B_ERRORS_C.:LIB_E05  is referenced.
   CP_6_SUBS.:LIB_E05  is referenced.
   CP_6.:LIB_E05  cannot be made into a system file and is referenced.
   ZI$GLOBAL.:ZIC0TOU  is referenced.
   B$JIT_C.:E05TOU  was found in the system file and is never referenced.
   CP_6_C.:E05TOU  was found in the system file and is referenced.
      No diagnostics issued in procedure ZIM$INDXMAP_ADD.

   Procedure ZIM$INDXMAP_ADD requires 161 words for executable code.
   Procedure ZIM$INDXMAP_ADD requires 20 words of local(AUTO) storage.
PL6.E3A0      #002=ZIM$INDXMAP_ADD File=ZIM$ENQM.:ZIC0TSI                        FRI 09/05/97 12:52 Page:64   
          *** CROSS REFERENCE LISTING ***
**     DENOTES     IDENTIFIER DEFINITION
<<                 IDENTIFIER'S VALUE SET
>>                 IDENTIFIER'S VALUE USED
<>                 IDENTIFIER SET AND/OR USED
--                 IDENTIFIER REFERENCED
PL6.E3A0      #002=ZIM$INDXMAP_ADD File=ZIM$ENQM.:ZIC0TSI                        FRI 09/05/97 12:52 Page:65   
          MINI XREF LISTING

ALT
      2996**LABEL    2993--CALLALT
B$ALT.CODE
       940**DCL       940--REDEF     941--REDEF     941--REDEF
B$ALT.ERR
       941**DCL      2964>>ASSIGN
B$ALT.ERR.ERR#
       942**DCL       942--REDEF
B$ALT.EVID
       941**DCL       941--REDEF     941--REDEF
B$TCB.ALT$
       947**DCL      2964>>ASSIGN
B$TCB$
      2949**DCL      2964>>ASSIGN
BSEARCH
      3008**PROC     2952--CALL     2993--CALL
ENQLIST$
       839**DCL       824--IMP-PTR
GLOBAL.ACTIVE.DBCB$
       522**DCL       523--REDEF
GLOBAL.ACTIVE.SSS$
       518**DCL       519--REDEF
GLOBAL.DB.DBCB$
       616**DCL      2961<>CALL
GLOBAL.ENQ.INDXMAP.BASE$
       669**DCL      2969>>IF       2970<<ASSIGN   2971>>ASSIGN   3013>>ASSIGN
GLOBAL.ENQ.INDXMAP.COUNT
       665**DCL      2960>>IF       2976>>IF       2977>>CALL     2982<<ASSIGN   2982>>ASSIGN   3016>>ASSIGN
GLOBAL.ENQ.INDXMAP.INDX
       663**DCL      3026<<ASSIGN   3032<<ASSIGN
GLOBAL.ENQ.INDXMAP.MAXCOUNT
       667**DCL      2960>>IF       2967<<ASSIGN   2967>>ASSIGN
PL6.E3A0      #002=ZIM$INDXMAP_ADD File=ZIM$ENQM.:ZIC0TSI                        FRI 09/05/97 12:52 Page:66   
GLOBAL.ENQ.LIST.INDX
       656**DCL      2985>>ASSIGN
GLOBAL.ENQ.SHARE
       642**DCL      2954>>IF       2986>>IF
GLOBAL.KEY
       726**DCL       729--REDEF
GLOBAL.KEYID.RECID
       756**DCL      2984>>ASSIGN   3019>>IF       3022>>IF
GLOBAL.PARAN.TRACE.MODE
       601**DCL       608--REDEF
GLOBAL.PRINTBUF.BUFFER
       760**DCL       761--REDEF     762--REDEF     763--REDEF
GLOBAL.PRINTBUF.ERR.V
       765**DCL       768--REDEF     769--REDEF     770--REDEF
GLOBAL.RET.ERROR#
       536**DCL      2963<<ASSIGN
GLOBAL.RET.SYSERR#
       537**DCL      2964<<ASSIGN
GLOBAL$
       820**DCL       516--IMP-PTR  2954>>IF       2960>>IF       2960>>IF       2961>>CALL     2963>>ASSIGN
      2964>>ASSIGN   2967>>ASSIGN   2967>>ASSIGN   2969>>IF       2970>>ASSIGN   2971>>ASSIGN   2976>>IF
      2977>>CALL     2982>>ASSIGN   2982>>ASSIGN   2984>>ASSIGN   2985>>ASSIGN   2986>>IF       3013>>ASSIGN
      3016>>ASSIGN   3019>>IF       3022>>IF       3026>>ASSIGN   3032>>ASSIGN
HIGH IN PROCEDURE BSEARCH
      3011**DCL      3016<<ASSIGN   3017>>DOWHILE  3018>>ASSIGN   3023<<ASSIGN
INDX
      2943**DCL      2955>>ASSIGN   2976>>IF       2977>>CALL     2977>>CALL     2977>>CALL     2983>>ASSIGN
      2984>>ASSIGN   2985>>ASSIGN   2987>>ASSIGN   3015<<ASSIGN   3017>>DOWHILE  3018>>ASSIGN   3020<<ASSIGN
      3025<<ASSIGN   3026>>ASSIGN   3032>>ASSIGN
INDXMAP
       842**DCL      2967--ASSIGN   2977--CALL     2977--CALL     2977--CALL     2983<<ASSIGN
INDXMAP.ENQINDX
       851**DCL      2985<<ASSIGN
INDXMAP.RECID
       853**DCL      2984<<ASSIGN   3019>>IF       3022>>IF
INDXMAP.STATUS.MODIFY
PL6.E3A0      #002=ZIM$INDXMAP_ADD File=ZIM$ENQM.:ZIC0TSI                        FRI 09/05/97 12:52 Page:67   
       848**DCL      2955<<ASSIGN   2987<<ASSIGN
INDXMAP$
       855**DCL       842--IMP-PTR  2955>>ASSIGN   2971<<ASSIGN   2977>>CALL     2977>>CALL     2983>>ASSIGN
      2984>>ASSIGN   2985>>ASSIGN   2987>>ASSIGN   3013<<ASSIGN   3019>>IF       3022>>IF
M$ERR
       878**DCL-ENT  2965--CALL
MIDDLE IN PROCEDURE BSEARCH
      3010**DCL      3018<<ASSIGN   3019>>IF       3020>>ASSIGN   3022>>IF       3023>>ASSIGN   3025>>ASSIGN
PTR$
      2945**DCL      2961<>CALL     2970>>ASSIGN
RET
      2995**LABEL    2956--GOTO     2988--GOTO
ZIM$MRL_SHIFT
      2947**DCL-ENT  2977--CALL
ZIO$GETSEG
      2948**DCL-ENT  2961--CALL

PL6.E3A0      #003=ZIM$SHIFT_ENQLIST File=ZIM$ENQM.:ZIC0TSI                      FRI 09/05/97 12:53 Page:68   
      332        1        /*T***********************************************************/
      333        2        /*T*                                                         */
      334        3        /*T* Copyright (c) Bull HN Information Systems Inc., 1997    */
      335        4        /*T*                                                         */
      336        5        /*T***********************************************************/
      337        6
      338        7        /*P*
      339        8        NAME:   ZIM$SHIFT_ENQLIST
      340        9        PURPOSE:To remap structures that point to ENQLIST.
      341       10        */
      342       11        /*D*
      343       12        NAME:   ZIM$SHIFT_ENQLIST
      344       13        ENTRY:  CALL ZIM$SHIFT_ENQLIST(FROM,CHANGE);
      345       14        INPUT:  FROM - Index into ENQLIST of first entry to change
      346       15                TO - Index into ENQLIST of last entry that changed
      347       16                CHANGE - Amount each entry changed by.
      348       17        DESCRIPTION:
      349       18            When adding and deleting entries in ENQLIST the structures
      350       19            that point into it must be updated to reflect the new
      351       20            locations.
      352       21
      353       22            The two structures that must be adjusted are INDXMAP.ENQINDX
      354       23            and GLOBAL.BCB.BUF.ENQINDX.  The first must be searched
      355       24            completely since their is no reverse map.  The second
      356       25            can be updated directly using ENQLIST.BUFSLOT.
      357       26        */
      358       27        %EJECT;
PL6.E3A0      #003=ZIM$SHIFT_ENQLIST File=ZIM$ENQM.:ZIC0TSI                      FRI 09/05/97 12:53 Page:69   
      359       28        ZIM$SHIFT_ENQLIST: PROC(LOW,CHANGE) AVOID($PR5, $PR6, $PR7);
      360       29        %INCLUDE ZI$GLOBAL;
      361      515         %GLOBALS;
      362      823         %ENQLIST;
      363      841         %INDXMAP;
      364      857
      365      858    1   DCL ZIM$MRL_SHIFT ENTRY(3);
      366      859
      367      860    1   DCL LOW UBIN;
      368      861    1   DCL PAGES REDEF LOW SBIN;
      369      862    1   DCL CHANGE SBIN;
      370      863
      371      864    1   DCL I UBIN;
      372      865
      373      866    1   DCL SIZE UBIN;
      374      867    1   DCL CHARS CHAR(SIZE) BASED CALIGNED;
      375      868
      376      869    1       ENQLIST$=GLOBAL.ENQ.LIST.BASE$;
      377      870    1       INDXMAP$=GLOBAL.ENQ.INDXMAP.BASE$;
      378      871
      379      872    2       DO I=LOW TO GLOBAL.ENQ.LIST.COUNT;
      380      873    2           IF ENQLIST.BUFSLOT(I)~=0 THEN
      381      874    2               GLOBAL.BCB.BUF.ENQINDX(ENQLIST.BUFSLOT(I))=
      382      875    2                  GLOBAL.BCB.BUF.ENQINDX(ENQLIST.BUFSLOT(I))+CHANGE;
      383      876    2           END;
      384      877
      385      878    2       DO I=1 TO GLOBAL.ENQ.INDXMAP.COUNT;
      386      879    2           IF INDXMAP.ENQINDX(I) >= LOW THEN
      387      880    2               INDXMAP.ENQINDX(I)=INDXMAP.ENQINDX(I)+CHANGE;
      388      881    2           END;
      389      882
      390      883        /*      Now grow or shrink structure. */
      391      884    1       IF CHANGE>0 THEN
      392      885    1           CALL ZIM$MRL_SHIFT(ADDR(ENQLIST(LOW)),
      393      886    1              ADDR(ENQLIST(LOW+CHANGE)),
      394      887    1              (GLOBAL.ENQ.LIST.COUNT-LOW+1)*SIZEC(ENQLIST(0)));
      395      888    2       ELSE DO;
PL6.E3A0      #003=ZIM$SHIFT_ENQLIST File=ZIM$ENQM.:ZIC0TSI                      FRI 09/05/97 12:53 Page:70   
      396      889    2           SIZE=(GLOBAL.ENQ.LIST.COUNT-LOW+1)*SIZEC(ENQLIST(0));
      397      890    2           ADDR(ENQLIST(LOW+CHANGE))->CHARS=ADDR(ENQLIST(LOW))->CHARS;
      398      891    2           END;
      399      892    1       GOTO RET;
      400      893        %EJECT;
PL6.E3A0      #003=ZIM$SHIFT_ENQLIST File=ZIM$ENQM.:ZIC0TSI                      FRI 09/05/97 12:53 Page:71   
      401      894        /*P*
      402      895        NAME:   ZIM$MOVE_ENQLIST
      403      896        PURPOSE:To move the whole ENQLIST when buffers anre added or deleted.
      404      897        */
      405      898        /*D*
      406      899        NAME:   ZIM$MOVE_ENQLIST
      407      900        CALL:   CALL ZIM$MOVE_ENQLIST(PAGES)
      408      901        INPUT:  PAGES - Signed value of pages to move.
      409      902        DESCRIPTION:
      410      903            The array ENQLIST is stored after the buffer pool.  Therefore,
      411      904            when the user makes a call to IDSBUFFERS, ENQLIST must be moved.
      412      905            This routine relocates ENQLIST both forward and backward in
      413      906            memory, and will update the base pointer also.
      414      907        */
      415      908        %EJECT;
PL6.E3A0      #003=ZIM$SHIFT_ENQLIST File=ZIM$ENQM.:ZIC0TSI                      FRI 09/05/97 12:53 Page:72   
      416      909    1   ZIM$MOVE_ENQLIST: ENTRY(LOW);
      417      910
      418      911    1       IF PAGES~=0 AND
      419      912    2          GLOBAL.ENQ.LIST.BASE$~=ADDR(NIL) THEN DO;
      420      913    2           ENQLIST$=GLOBAL.ENQ.LIST.BASE$;
      421      914    2           GLOBAL.ENQ.LIST.BASE$=
      422      915    2              PINCRW(GLOBAL.ENQ.LIST.BASE$,PAGES*1024);
      423      916    2           SIZE=(GLOBAL.ENQ.LIST.COUNT+1)*SIZEC(ENQLIST(0));
      424      917    2           IF PAGES<0 THEN
      425      918    2               GLOBAL.ENQ.LIST.BASE$->CHARS=ENQLIST$->CHARS;
      426      919    2           ELSE
      427      920    2               CALL ZIM$MRL_SHIFT(ENQLIST$,
      428      921    2                  GLOBAL.ENQ.LIST.BASE$,
      429      922    2                  SIZE);
      430      923    2           END;
      431      924
      432      925    1   RET:RETURN;
      433      926    1   END ZIM$SHIFT_ENQLIST;
      434      927        %EOD;

PL6.E3A0      #003=ZIM$SHIFT_ENQLIST File=ZIM$ENQM.:ZIC0TSI                      FRI 09/05/97 12:53 Page:73   
--  Include file information  --

   ZI$GLOBAL.:ZIC0TOU  is referenced.
   B$JIT_C.:E05TOU  was found in the system file and is never referenced.
   CP_6_C.:E05TOU  was found in the system file and is never referenced.
      No diagnostics issued in procedure ZIM$SHIFT_ENQLIST.

   Procedure ZIM$SHIFT_ENQLIST requires 164 words for executable code.
   Procedure ZIM$SHIFT_ENQLIST requires 18 words of local(AUTO) storage.

PL6.E3A0      #003=ZIM$SHIFT_ENQLIST File=ZIM$ENQM.:ZIC0TSI                      FRI 09/05/97 12:53 Page:74   

 Object Unit name= ZIM$SHIFT_ENQLIST                          File name= ZIM$ENQM.:ZIC0TOU
 UTS= SEP 05 '97 12:53:07.08 FRI                              Compiler= PL-6/E31         Sev=      00
 SharedLib= :SHARED_SYSTEM                                    Alt SharedLib=


    ****  Control sections  ****

 Sect   Type Bound  Init  Size OctSiz  Section name(segment info)
    0   Proc  even  none   164    244  ZIM$SHIFT_ENQLIST
    1  RoData even  none     4      4  ZIM$SHIFT_ENQLIST

    ****  Entry defs  ****

                              Check   Calling
                             calling  sequence
  Sect OctLoc Primary Altret sequence   type   Parms  Name
     0      0   yes            yes      XStd       2  ZIM$SHIFT_ENQLIST
     0    173                  yes      XStd       1  ZIM$MOVE_ENQLIST

  ****  Entry refs  ****

         Check        Calling
        calling       sequence
Altret sequence SRef   type   Args  Name
         yes           XStd      3 ZIM$MRL_SHIFT
                       nStd      0 X66_AUTO_2
                       nStd      0 X66_ARET

  ****  Data refs  ****

  Flags:  r = read only, s = secondary
Flgs Name                             Flgs Name                             Flgs Name
r    GLOBAL$
PL6.E3A0      #003=ZIM$SHIFT_ENQLIST File=ZIM$ENQM.:ZIC0TSI                      FRI 09/05/97 12:53 Page:75   

  ****  Segment refs  ****

  Flags:  r = read only, s = secondary
Flgs Name                             Flgs Name                             Flgs Name
     NULLSID
PL6.E3A0      #003=ZIM$SHIFT_ENQLIST File=ZIM$ENQM.:ZIC0TSI                      FRI 09/05/97 12:53 Page:76   


      332        1        /*T***********************************************************/
      333        2        /*T*                                                         */
      334        3        /*T* Copyright (c) Bull HN Information Systems Inc., 1997    */
      335        4        /*T*                                                         */
      336        5        /*T***********************************************************/
      337        6
      338        7        /*P*
      339        8        NAME:   ZIM$SHIFT_ENQLIST
      340        9        PURPOSE:To remap structures that point to ENQLIST.
      341       10        */
      342       11        /*D*
      343       12        NAME:   ZIM$SHIFT_ENQLIST
      344       13        ENTRY:  CALL ZIM$SHIFT_ENQLIST(FROM,CHANGE);
      345       14        INPUT:  FROM - Index into ENQLIST of first entry to change
      346       15                TO - Index into ENQLIST of last entry that changed
      347       16                CHANGE - Amount each entry changed by.
      348       17        DESCRIPTION:
      349       18            When adding and deleting entries in ENQLIST the structures
      350       19            that point into it must be updated to reflect the new
      351       20            locations.
      352       21
      353       22            The two structures that must be adjusted are INDXMAP.ENQINDX
      354       23            and GLOBAL.BCB.BUF.ENQINDX.  The first must be searched
      355       24            completely since their is no reverse map.  The second
      356       25            can be updated directly using ENQLIST.BUFSLOT.
      357       26        */
      358       27        %EJECT;
PL6.E3A0      #003=ZIM$SHIFT_ENQLIST File=ZIM$ENQM.:ZIC0TSI                      FRI 09/05/97 12:53 Page:77   
      359       28        ZIM$SHIFT_ENQLIST: PROC(LOW,CHANGE) AVOID($PR5, $PR6, $PR7);

     28  0 000000   000000 700200 xent  ZIM$SHIFT_E* TSX0  ! X66_AUTO_2
         0 000001   000022 000002                    ZERO    18,2

      360       29        %INCLUDE ZI$GLOBAL;
      361      515         %GLOBALS;
      362      823         %ENQLIST;
      363      841         %INDXMAP;
      364      857
      365      858    1   DCL ZIM$MRL_SHIFT ENTRY(3);
      366      859
      367      860    1   DCL LOW UBIN;
      368      861    1   DCL PAGES REDEF LOW SBIN;
      369      862    1   DCL CHANGE SBIN;
      370      863
      371      864    1   DCL I UBIN;
      372      865
      373      866    1   DCL SIZE UBIN;
      374      867    1   DCL CHARS CHAR(SIZE) BASED CALIGNED;
      375      868
      376      869    1       ENQLIST$=GLOBAL.ENQ.LIST.BASE$;

    869  0 000002   000000 470400 xsym               LDP0    GLOBAL$
         0 000003   001411 236100                    LDQ     777,,PR0
         0 000004   200005 756100                    STQ     ENQLIST$,,AUTO

      377      870    1       INDXMAP$=GLOBAL.ENQ.INDXMAP.BASE$;

    870  0 000005   001415 236100                    LDQ     781,,PR0
         0 000006   200006 756100                    STQ     INDXMAP$,,AUTO

      378      871
      379      872    2       DO I=LOW TO GLOBAL.ENQ.LIST.COUNT;

    872  0 000007   200003 471500                    LDP1    @LOW,,AUTO
         0 000010   100000 235100                    LDA     0,,PR1
PL6.E3A0      #003=ZIM$SHIFT_ENQLIST File=ZIM$ENQM.:ZIC0TSI                      FRI 09/05/97 12:53 Page:78   
         0 000011   200007 755100                    STA     I,,AUTO
         0 000012   000047 710000 0                  TRA     s:876+3

      380      873    2           IF ENQLIST.BUFSLOT(I)~=0 THEN

    873  0 000013   200007 235100                    LDA     I,,AUTO
         0 000014   000001 735000                    ALS     1
         0 000015   200005 470500                    LDP0    ENQLIST$,,AUTO
         0 000016   000000 236105                    LDQ     0,AL,PR0
         0 000017   000777 316003                    CANQ    511,DU
         0 000020   000044 600000 0                  TZE     s:876

      381      874    2               GLOBAL.BCB.BUF.ENQINDX(ENQLIST.BUFSLOT(I))=

    874  0 000021   000000 236105                    LDQ     0,AL,PR0
         0 000022   000022 772000                    QRL     18
         0 000023   000777 376007                    ANQ     511,DL
         0 000024   000005 402007                    MPY     5,DL
         0 000025   200007 235100                    LDA     I,,AUTO
         0 000026   000001 735000                    ALS     1
         0 000027   000000 620006                    EAX0    0,QL
         0 000030   000000 236105                    LDQ     0,AL,PR0
         0 000031   000022 772000                    QRL     18
         0 000032   000777 376007                    ANQ     511,DL
         0 000033   000005 402007                    MPY     5,DL
         0 000034   200004 471500                    LDP1    @CHANGE,,AUTO
         0 000035   000000 473400 xsym               LDP3    GLOBAL$
         0 000036   300206 236106                    LDQ     134,QL,PR3
         0 000037   077777 376007                    ANQ     32767,DL
         0 000040   100000 036100                    ADLQ    0,,PR1
         0 000041   300206 676110                    ERQ     134,X0,PR3
         0 000042   077777 376007                    ANQ     32767,DL
         0 000043   300206 656110                    ERSQ    134,X0,PR3

      382      875    2                  GLOBAL.BCB.BUF.ENQINDX(ENQLIST.BUFSLOT(I))+CHANGE;
      383      876    2           END;

PL6.E3A0      #003=ZIM$SHIFT_ENQLIST File=ZIM$ENQM.:ZIC0TSI                      FRI 09/05/97 12:53 Page:79   
    876  0 000044   200007 235100                    LDA     I,,AUTO
         0 000045   000001 035007                    ADLA    1,DL
         0 000046   200007 755100                    STA     I,,AUTO
         0 000047   000000 470400 xsym               LDP0    GLOBAL$
         0 000050   001412 236100                    LDQ     778,,PR0
         0 000051   777777 376007                    ANQ     -1,DL
         0 000052   200007 116100                    CMPQ    I,,AUTO
         0 000053   000013 603000 0                  TRC     s:873

      384      877
      385      878    2       DO I=1 TO GLOBAL.ENQ.INDXMAP.COUNT;

    878  0 000054   000001 235007                    LDA     1,DL
         0 000055   200007 755100                    STA     I,,AUTO
         0 000056   000077 710000 0                  TRA     s:881+3

      386      879    2           IF INDXMAP.ENQINDX(I) >= LOW THEN

    879  0 000057   200003 470500                    LDP0    @LOW,,AUTO
         0 000060   200007 235100                    LDA     I,,AUTO
         0 000061   000001 735000                    ALS     1
         0 000062   200006 471500                    LDP1    INDXMAP$,,AUTO
         0 000063   100000 236105                    LDQ     0,AL,PR1
         0 000064   000000 376000 1                  ANQ     0
         0 000065   000000 116100                    CMPQ    0,,PR0
         0 000066   000074 602000 0                  TNC     s:881

      387      880    2               INDXMAP.ENQINDX(I)=INDXMAP.ENQINDX(I)+CHANGE;

    880  0 000067   200004 473500                    LDP3    @CHANGE,,AUTO
         0 000070   300000 036100                    ADLQ    0,,PR3
         0 000071   100000 676105                    ERQ     0,AL,PR1
         0 000072   000000 376000 1                  ANQ     0
         0 000073   100000 656105                    ERSQ    0,AL,PR1

      388      881    2           END;

PL6.E3A0      #003=ZIM$SHIFT_ENQLIST File=ZIM$ENQM.:ZIC0TSI                      FRI 09/05/97 12:53 Page:80   
    881  0 000074   200007 236100                    LDQ     I,,AUTO
         0 000075   000001 036007                    ADLQ    1,DL
         0 000076   200007 756100                    STQ     I,,AUTO
         0 000077   000000 470400 xsym               LDP0    GLOBAL$
         0 000100   001414 236100                    LDQ     780,,PR0
         0 000101   000022 772000                    QRL     18
         0 000102   200007 116100                    CMPQ    I,,AUTO
         0 000103   000057 603000 0                  TRC     s:879

      389      882
      390      883        /*      Now grow or shrink structure. */
      391      884    1       IF CHANGE>0 THEN

    884  0 000104   200004 471500                    LDP1    @CHANGE,,AUTO
         0 000105   100000 235100                    LDA     0,,PR1
         0 000106   000150 604400 0                  TMOZ    s:889

      392      885    1           CALL ZIM$MRL_SHIFT(ADDR(ENQLIST(LOW)),

    885  0 000107   200003 473500                    LDP3    @LOW,,AUTO
         0 000110   300000 235100                    LDA     0,,PR3
         0 000111   000001 735000                    ALS     1
         0 000112   300000 236100                    LDQ     0,,PR3
         0 000113   100000 036100                    ADLQ    0,,PR1
         0 000114   200012 756100                    STQ     SIZE+2,,AUTO
         0 000115   001412 236100                    LDQ     778,,PR0
         0 000116   777777 376007                    ANQ     -1,DL
         0 000117   300000 136100                    SBLQ    0,,PR3
         0 000120   200014 756100                    STQ     SIZE+4,,AUTO
         0 000121   000044 733000                    LRS     36
         0 000122   000022 736000                    QLS     18
         0 000123   200005 036100                    ADLQ    ENQLIST$,,AUTO
         0 000124   200013 756100                    STQ     SIZE+3,,AUTO
         0 000125   200012 236100                    LDQ     SIZE+2,,AUTO
         0 000126   000023 736000                    QLS     19
         0 000127   200005 036100                    ADLQ    ENQLIST$,,AUTO
         0 000130   200015 756100                    STQ     SIZE+5,,AUTO
PL6.E3A0      #003=ZIM$SHIFT_ENQLIST File=ZIM$ENQM.:ZIC0TSI                      FRI 09/05/97 12:53 Page:81   
         0 000131   200014 235100                    LDA     SIZE+4,,AUTO
         0 000132   000003 735000                    ALS     3
         0 000133   000010 035007                    ADLA    8,DL
         0 000134   200016 755100                    STA     SIZE+6,,AUTO
         0 000135   200016 634500                    EPPR4   SIZE+6,,AUTO
         0 000136   200021 454500                    STP4    SIZE+9,,AUTO
         0 000137   200015 630500                    EPPR0   SIZE+5,,AUTO
         0 000140   200020 450500                    STP0    SIZE+8,,AUTO
         0 000141   200013 630500                    EPPR0   SIZE+3,,AUTO
         0 000142   200017 450500                    STP0    SIZE+7,,AUTO
         0 000143   200017 630500                    EPPR0   SIZE+7,,AUTO
         0 000144   000002 631400 1                  EPPR1   2
         0 000145   000000 701000 xent               TSX1    ZIM$MRL_SHIFT
         0 000146   000000 011000                    NOP     0
         0 000147   000172 710000 0                  TRA     s:892

      393      886    1              ADDR(ENQLIST(LOW+CHANGE)),
      394      887    1              (GLOBAL.ENQ.LIST.COUNT-LOW+1)*SIZEC(ENQLIST(0)));
      395      888    2       ELSE DO;

      396      889    2           SIZE=(GLOBAL.ENQ.LIST.COUNT-LOW+1)*SIZEC(ENQLIST(0));

    889  0 000150   200003 473500                    LDP3    @LOW,,AUTO
         0 000151   001412 236100                    LDQ     778,,PR0
         0 000152   777777 376007                    ANQ     -1,DL
         0 000153   300000 136100                    SBLQ    0,,PR3
         0 000154   000003 736000                    QLS     3
         0 000155   000010 036007                    ADLQ    8,DL
         0 000156   200010 756100                    STQ     SIZE,,AUTO

      397      890    2           ADDR(ENQLIST(LOW+CHANGE))->CHARS=ADDR(ENQLIST(LOW))->CHARS;

    890  0 000157   300000 236100                    LDQ     0,,PR3
         0 000160   100000 036100                    ADLQ    0,,PR1
         0 000161   300000 235100                    LDA     0,,PR3
         0 000162   000001 735000                    ALS     1
         0 000163   000002 735000                    ALS     2
PL6.E3A0      #003=ZIM$SHIFT_ENQLIST File=ZIM$ENQM.:ZIC0TSI                      FRI 09/05/97 12:53 Page:82   
         0 000164   000003 736000                    QLS     3
         0 000165   200005 474500                    LDP4    ENQLIST$,,AUTO
         0 000166   200010 720100                    LXL0    SIZE,,AUTO
         0 000167   040146 100545                    MLR     fill='040'O
         0 000170   400000 000010                    ADSC9   0,A,PR4                  cn=0,n=*X0
         0 000171   400000 000010                    ADSC9   0,Q,PR4                  cn=0,n=*X0

      398      891    2           END;

      399      892    1       GOTO RET;

    892  0 000172   000243 710000 0                  TRA     RET

      400      893        %EJECT;
PL6.E3A0      #003=ZIM$SHIFT_ENQLIST File=ZIM$ENQM.:ZIC0TSI                      FRI 09/05/97 12:53 Page:83   
      401      894        /*P*
      402      895        NAME:   ZIM$MOVE_ENQLIST
      403      896        PURPOSE:To move the whole ENQLIST when buffers anre added or deleted.
      404      897        */
      405      898        /*D*
      406      899        NAME:   ZIM$MOVE_ENQLIST
      407      900        CALL:   CALL ZIM$MOVE_ENQLIST(PAGES)
      408      901        INPUT:  PAGES - Signed value of pages to move.
      409      902        DESCRIPTION:
      410      903            The array ENQLIST is stored after the buffer pool.  Therefore,
      411      904            when the user makes a call to IDSBUFFERS, ENQLIST must be moved.
      412      905            This routine relocates ENQLIST both forward and backward in
      413      906            memory, and will update the base pointer also.
      414      907        */
      415      908        %EJECT;
PL6.E3A0      #003=ZIM$SHIFT_ENQLIST File=ZIM$ENQM.:ZIC0TSI                      FRI 09/05/97 12:53 Page:84   
      416      909    1   ZIM$MOVE_ENQLIST: ENTRY(LOW);

    909  0 000173   000000 700200 xent  ZIM$MOVE_EN* TSX0  ! X66_AUTO_2
         0 000174   000022 000002                    ZERO    18,2

      417      910
      418      911    1       IF PAGES~=0 AND

    911  0 000175   200003 470500                    LDP0    @LOW,,AUTO
         0 000176   000000 235100                    LDA     0,,PR0
         0 000177   000243 600000 0                  TZE     RET
         0 000200   000000 471400 xsym               LDP1    GLOBAL$
         0 000201   101411 236100                    LDQ     777,,PR1
         0 000202   000001 116000 1                  CMPQ    1
         0 000203   000243 600000 0                  TZE     RET

      419      912    2          GLOBAL.ENQ.LIST.BASE$~=ADDR(NIL) THEN DO;

      420      913    2           ENQLIST$=GLOBAL.ENQ.LIST.BASE$;

    913  0 000204   200005 756100                    STQ     ENQLIST$,,AUTO

      421      914    2           GLOBAL.ENQ.LIST.BASE$=

    914  0 000205   000000 236100                    LDQ     0,,PR0
         0 000206   101411 473500                    LDP3    777,,PR1
         0 000207   000012 736000                    QLS     10
         0 000210   300000 634506                    EPPR4   0,QL,PR3
         0 000211   101411 454500                    STP4    777,,PR1

      422      915    2              PINCRW(GLOBAL.ENQ.LIST.BASE$,PAGES*1024);
      423      916    2           SIZE=(GLOBAL.ENQ.LIST.COUNT+1)*SIZEC(ENQLIST(0));

    916  0 000212   101412 236100                    LDQ     778,,PR1
         0 000213   000003 736000                    QLS     3
         0 000214   000003 376000 1                  ANQ     3
         0 000215   000010 036007                    ADLQ    8,DL
PL6.E3A0      #003=ZIM$SHIFT_ENQLIST File=ZIM$ENQM.:ZIC0TSI                      FRI 09/05/97 12:53 Page:85   
         0 000216   200010 756100                    STQ     SIZE,,AUTO

      424      917    2           IF PAGES<0 THEN

    917  0 000217   000000 235100                    LDA     0,,PR0
         0 000220   000230 605000 0                  TPL     s:920

      425      918    2               GLOBAL.ENQ.LIST.BASE$->CHARS=ENQLIST$->CHARS;

    918  0 000221   200005 473500                    LDP3    ENQLIST$,,AUTO
         0 000222   000000 620006                    EAX0    0,QL
         0 000223   200010 721100                    LXL1    SIZE,,AUTO
         0 000224   040140 100540                    MLR     fill='040'O
         0 000225   300000 000010                    ADSC9   0,,PR3                   cn=0,n=*X0
         0 000226   400000 000011                    ADSC9   0,,PR4                   cn=0,n=*X1
         0 000227   000243 710000 0                  TRA     RET

      426      919    2           ELSE
      427      920    2               CALL ZIM$MRL_SHIFT(ENQLIST$,

    920  0 000230   200010 633500                    EPPR3   SIZE,,AUTO
         0 000231   200014 453500                    STP3    SIZE+4,,AUTO
         0 000232   000000 236000 xsym               LDQ     GLOBAL$
         0 000233   001411 036003                    ADLQ    777,DU
         0 000234   200013 756100                    STQ     SIZE+3,,AUTO
         0 000235   200005 630500                    EPPR0   ENQLIST$,,AUTO
         0 000236   200012 450500                    STP0    SIZE+2,,AUTO
         0 000237   200012 630500                    EPPR0   SIZE+2,,AUTO
         0 000240   000002 631400 1                  EPPR1   2
         0 000241   000000 701000 xent               TSX1    ZIM$MRL_SHIFT
         0 000242   000000 011000                    NOP     0

      428      921    2                  GLOBAL.ENQ.LIST.BASE$,
      429      922    2                  SIZE);
      430      923    2           END;

      431      924
PL6.E3A0      #003=ZIM$SHIFT_ENQLIST File=ZIM$ENQM.:ZIC0TSI                      FRI 09/05/97 12:53 Page:86   
      432      925    1   RET:RETURN;

    925  0 000243   000000 702200 xent  RET          TSX2  ! X66_ARET

(unnamed)
 Sect OctLoc
   1     000   000777 777777   000000 006014   000003 000000   000007 777770    ................
      433      926    1   END ZIM$SHIFT_ENQLIST;
      434      927        %EOD;

PL6.E3A0      #003=ZIM$SHIFT_ENQLIST File=ZIM$ENQM.:ZIC0TSI                      FRI 09/05/97 12:53 Page:87   
--  Include file information  --

   ZI$GLOBAL.:ZIC0TOU  is referenced.
   B$JIT_C.:E05TOU  was found in the system file and is never referenced.
   CP_6_C.:E05TOU  was found in the system file and is never referenced.
      No diagnostics issued in procedure ZIM$SHIFT_ENQLIST.

   Procedure ZIM$SHIFT_ENQLIST requires 164 words for executable code.
   Procedure ZIM$SHIFT_ENQLIST requires 18 words of local(AUTO) storage.
PL6.E3A0      #003=ZIM$SHIFT_ENQLIST File=ZIM$ENQM.:ZIC0TSI                      FRI 09/05/97 12:53 Page:88   
          *** CROSS REFERENCE LISTING ***
**     DENOTES     IDENTIFIER DEFINITION
<<                 IDENTIFIER'S VALUE SET
>>                 IDENTIFIER'S VALUE USED
<>                 IDENTIFIER SET AND/OR USED
--                 IDENTIFIER REFERENCED
PL6.E3A0      #003=ZIM$SHIFT_ENQLIST File=ZIM$ENQM.:ZIC0TSI                      FRI 09/05/97 12:53 Page:89   
          MINI XREF LISTING

CHANGE
       862**DCL        28--PROC      874>>ASSIGN    880>>ASSIGN    884>>IF        885>>CALL      890>>ASSIGN
CHARS
       867**DCL       890<<ASSIGN    890>>ASSIGN    918<<ASSIGN    918>>ASSIGN
ENQLIST
       824**DCL       885--CALL      885--CALL      885--CALL      889--ASSIGN    890--ASSIGN    890--ASSIGN
       916--ASSIGN
ENQLIST.BUFSLOT
       833**DCL       873>>IF        874>>ASSIGN    874>>ASSIGN
ENQLIST$
       839**DCL       824--IMP-PTR   869<<ASSIGN    873>>IF        874>>ASSIGN    874>>ASSIGN    885>>CALL
       885>>CALL      890>>ASSIGN    890>>ASSIGN    913<<ASSIGN    918>>ASSIGN    920<>CALL
GLOBAL.ACTIVE.DBCB$
       522**DCL       523--REDEF
GLOBAL.ACTIVE.SSS$
       518**DCL       519--REDEF
GLOBAL.BCB.BUF.ENQINDX
       639**DCL       874<<ASSIGN    874>>ASSIGN
GLOBAL.ENQ.INDXMAP.BASE$
       669**DCL       870>>ASSIGN
GLOBAL.ENQ.INDXMAP.COUNT
       665**DCL       878>>DOINDEX
GLOBAL.ENQ.LIST.BASE$
       654**DCL       869>>ASSIGN    911>>IF        913>>ASSIGN    914<<ASSIGN    914>>ASSIGN    918>>ASSIGN
       920<>CALL
GLOBAL.ENQ.LIST.COUNT
       658**DCL       872>>DOINDEX   885>>CALL      889>>ASSIGN    916>>ASSIGN
GLOBAL.KEY
       726**DCL       729--REDEF
GLOBAL.PARAN.TRACE.MODE
       601**DCL       608--REDEF
GLOBAL.PRINTBUF.BUFFER
PL6.E3A0      #003=ZIM$SHIFT_ENQLIST File=ZIM$ENQM.:ZIC0TSI                      FRI 09/05/97 12:53 Page:90   
       760**DCL       761--REDEF     762--REDEF     763--REDEF
GLOBAL.PRINTBUF.ERR.V
       765**DCL       768--REDEF     769--REDEF     770--REDEF
GLOBAL$
       820**DCL       516--IMP-PTR   869>>ASSIGN    870>>ASSIGN    872>>DOINDEX   874>>ASSIGN    874>>ASSIGN
       878>>DOINDEX   885>>CALL      889>>ASSIGN    911>>IF        913>>ASSIGN    914>>ASSIGN    914>>ASSIGN
       916>>ASSIGN    918>>ASSIGN    920>>CALL
I
       864**DCL       872<<DOINDEX   873>>IF        874>>ASSIGN    874>>ASSIGN    878<<DOINDEX   879>>IF
       880>>ASSIGN    880>>ASSIGN
INDXMAP.ENQINDX
       851**DCL       879>>IF        880<<ASSIGN    880>>ASSIGN
INDXMAP$
       855**DCL       842--IMP-PTR   870<<ASSIGN    879>>IF        880>>ASSIGN    880>>ASSIGN
LOW
       860**DCL        28--PROC      861--REDEF     872>>DOINDEX   879>>IF        885>>CALL      885>>CALL
       885>>CALL      889>>ASSIGN    890>>ASSIGN    890>>ASSIGN    909--ENTRY
PAGES
       861**DCL       911>>IF        914>>ASSIGN    917>>IF
RET
       925**LABEL     892--GOTO
SIZE
       866**DCL       867--IMP-SIZ   889<<ASSIGN    890>>ASSIGN    890>>ASSIGN    916<<ASSIGN    918>>ASSIGN
       918>>ASSIGN    920<>CALL
ZIM$MRL_SHIFT
       858**DCL-ENT   885--CALL      920--CALL

PL6.E3A0      #004=ZIM$DEQ_DCB File=ZIM$ENQM.:ZIC0TSI                            FRI 09/05/97 12:53 Page:91   
      435        1        /*T***********************************************************/
      436        2        /*T*                                                         */
      437        3        /*T* Copyright (c) Bull HN Information Systems Inc., 1997    */
      438        4        /*T*                                                         */
      439        5        /*T***********************************************************/
      440        6        /*P*
      441        7        NAME:   ZIM$DEQ_DCB
      442        8        PURPOSE:To drop all the ENQs against a particular DCB.
      443        9        */
      444       10        /*D*
      445       11        NAME:   ZIM$DEQ_DCB
      446       12        CALL:   CALL ZIM$DEQ_DCB(DCB#) ALTRET;
      447       13        INPUT:  DCB# - The DCB# chosen.
      448       14        DESCRIPTION:
      449       15            The two arrays ENQLIST and INDXMAP are searched for entries
      450       16            against the specified DCB.  If any are found they are removed
      451       17            and the lists are compacted.
      452       18        */
      453       19        ZIM$DEQ_DCB: PROC(DCB#) ALTRET AVOID($PR5,$PR6,$PR7);
      454       20
      455       21    1   DCL DCB# SBIN HALF HALIGNED;
      456       22
      457       23        %INCLUDE ZI$GLOBAL;
      458      509         %GLOBALS;
      459      817         %ENQLIST;
      460      835         %INDXMAP;
      461      851         %TRCE_SUBS;
      462      875        %INCLUDE CP_6;
      463      956         %FPT_DEQ(FPTN=FPT$DEQ,STCLASS=BASED);
      464      973         %FPT_DEQ(FPTN=FPT$DEQALL,STCLASS=BASED);
      465      990         %B$TCB;
      466      993         %B$ALT;
      467     1001         %F$DCB;
      468     1058        %INCLUDE CP_6_SUBS;
      469     1598        %INCLUDE ZI_ERRORS_C;
      470     1924
      471     1925    1   DCL ZIM$TRACE ENTRY;
PL6.E3A0      #004=ZIM$DEQ_DCB File=ZIM$ENQM.:ZIC0TSI                            FRI 09/05/97 12:53 Page:92   
      472     1926    1   DCL ZIM$SHIFT_ENQLIST ENTRY(2);
      473     1927    1   DCL B$TCB$ PTR SYMREF ALIGNED;
      474     1928
      475     1929    1   DCL LOW SBIN ALIGNED;
      476     1930    1   DCL HIGH SBIN ALIGNED;
      477     1931    1   DCL ERROR REDEF HIGH UBIN;
      478     1932    1   DCL CHAR_MOVE CHAR(LOW) BASED CALIGNED;
      479     1933    1   DCL F$DCB$ PTR;
      480     1934
      481     1935    1   DCL COUNT UBIN;
      482     1936    1   DCL I UBIN;
      483     1937    1   DCL SIZE UBIN;
      484     1938    1   DCL CHARS CHAR(SIZE) BASED CALIGNED;
      485     1939
      486     1940    1       IF DCB#=0 THEN
      487     1941    1           GOTO RET;
      488     1942
      489     1943    1       INDXMAP$=GLOBAL.ENQ.INDXMAP.BASE$;
      490     1944    1       ENQLIST$=GLOBAL.ENQ.LIST.BASE$;
      491     1945    1       F$DCB$ = DCBADDR(DCB#);
      492     1946
      493     1947    2       IF F$DCB$->F$DCB.ORG#=%INDEXED# THEN DO;
      494     1948        /*          First remove entries from the INDXMAP list. */
      495     1949    2           COUNT = GLOBAL.ENQ.INDXMAP.COUNT;
      496     1950    3           DO I = COUNT DOWNTO 1;
      497     1951    3               IF ENQLIST.VALUE.DCB#(INDXMAP.ENQINDX(I))=DCB#
      498     1952    4               THEN DO;
      499     1953    4                   IF I < GLOBAL.ENQ.INDXMAP.COUNT
      500     1954    5                   THEN DO;
      501     1955
      502     1956        /*                      Have something to pack down. */
      503     1957    5                       SIZE=(GLOBAL.ENQ.INDXMAP.COUNT - I)*SIZEC(INDXMAP(0));
      504     1958    5                       ADDR(INDXMAP(I))->CHARS=ADDR(INDXMAP(I+1))->CHARS;
      505     1959    5                       END;
      506     1960
      507     1961    4                   GLOBAL.ENQ.INDXMAP.COUNT=GLOBAL.ENQ.INDXMAP.COUNT - 1;
      508     1962    4                   END;
PL6.E3A0      #004=ZIM$DEQ_DCB File=ZIM$ENQM.:ZIC0TSI                            FRI 09/05/97 12:53 Page:93   
      509     1963    3               END;
      510     1964    2           END;
      511     1965
      512     1966        /*          Now check ENQLIST in the same manner. */
      513     1967    1   EL: LOW=1;
      514     1968    2       DO WHILE(LOW<=GLOBAL.ENQ.LIST.COUNT);
      515     1969    2           IF ENQLIST.VALUE.DCB#(LOW)=DCB# THEN
      516     1970    2               GOTO EH;
      517     1971    2           LOW=LOW+1;
      518     1972    2           END;
      519     1973    1       GOTO RET;
      520     1974
      521     1975    1   EH: HIGH=LOW+1;
      522     1976    2   EH1:DO WHILE(HIGH<=GLOBAL.ENQ.LIST.COUNT);
      523     1977    2           IF ENQLIST.VALUE.DCB#(HIGH)~=DCB# THEN
      524     1978    2               EXIT EH1;
      525     1979    2           HIGH=HIGH+1;
      526     1980    2           END;
      527     1981    1       HIGH=HIGH-1;
      528     1982
      529     1983    1       IF HIGH<GLOBAL.ENQ.LIST.COUNT THEN
      530     1984        /*          Have something to pack down. */
      531     1985    1           CALL ZIM$SHIFT_ENQLIST(HIGH+1,-(HIGH-LOW+1));
      532     1986    1       GLOBAL.ENQ.LIST.COUNT=GLOBAL.ENQ.LIST.COUNT-(HIGH-LOW+1);
      533     1987
      534     1988        /*      Dequeue all entires for the DCB. */
      535     1989    1       GLOBAL.DEQALL$->FPT$DEQALL.V.DCB#=DCB#;
      536     1990    1       CALL M$DEQ(GLOBAL.DEQALL$->FPT$DEQALL) ALTRET(DEQ_ERR);
      537     1991    2       IF GLOBAL.PARAN.TRACE.MODE~='0'B THEN DO;
      538     1992    2           GLOBAL.PARAN.TRACE.PNO=(HIGH-LOW)+1;
      539     1993    2           GLOBAL.PARAN.TRACE.PDCB=DCB#;
      540     1994    2           IF DCBADDR(DCB#)->F$DCB.ORG#=%IDS# THEN
      541     1995    2               GLOBAL.PARAN.TRACE.TYPE=%TR#PDEQALL;
      542     1996    2           ELSE
      543     1997    2               GLOBAL.PARAN.TRACE.TYPE=%TR#IDEQALL;
      544     1998    2           CALL ZIM$TRACE;
      545     1999    2           END;
PL6.E3A0      #004=ZIM$DEQ_DCB File=ZIM$ENQM.:ZIC0TSI                            FRI 09/05/97 12:53 Page:94   
      546     2000
      547     2001    1       GOTO RET;
      548     2002        %EJECT;
PL6.E3A0      #004=ZIM$DEQ_DCB File=ZIM$ENQM.:ZIC0TSI                            FRI 09/05/97 12:53 Page:95   
      549     2003        /*P*
      550     2004        NAME:   ZIM$DEQ_ONE
      551     2005        PURPOSE:To drop a single ENQ if possible.
      552     2006        */
      553     2007        /*D*
      554     2008        NAME:   ZIM$DEQ_ONE
      555     2009        CALL:   CALL ZIM$DEQ_ONE
      556     2010        INPUT:  GLOBAL.ENQ.LIST.INDX
      557     2011        DESCRIPTION:
      558     2012            An individual ENQ identified by GLOBAL.ENQ.LIST.INDX is
      559     2013            DEQed and removed from ENQLIST.  All related structures are
      560     2014            also updated.  If the DCB# of the entry in ENQLIST identifies
      561     2015            an indexed area, the DEQ will only be done if no entries in
      562     2016            INDXMAP are mapped onto it.
      563     2017        */
      564     2018    1   ZIM$DEQ_ONE: ENTRY ALTRET;
      565     2019
      566     2020    1       ENQLIST$=GLOBAL.ENQ.LIST.BASE$;
      567     2021    1       INDXMAP$=GLOBAL.ENQ.INDXMAP.BASE$;
      568     2022
      569     2023    1       IF DCBADDR(ENQLIST.VALUE.DCB#(GLOBAL.ENQ.LIST.INDX))->
      570     2024    1          F$DCB.ORG#=%INDEXED# THEN
      571     2025        /*          See if anyone still using this ENQ. */
      572     2026    2       DO LOW=1 TO GLOBAL.ENQ.INDXMAP.COUNT;
      573     2027    3           IF GLOBAL.ENQ.LIST.INDX=INDXMAP.ENQINDX(LOW) THEN DO;
      574     2028    3               ERROR=1;
      575     2029                    %DBEXC;
      576     2033    3               END;
      577     2034    2           END;
      578     2035
      579     2036        /*      Release ENQ. */
      580     2037    1       GLOBAL.DEQ$->FPT$DEQ.V.DCB#=ENQLIST.VALUE.DCB#(GLOBAL.ENQ.LIST.INDX);
      581     2038    1       GLOBAL.RNAME.VALUE=ENQLIST.VALUE.RNAME(GLOBAL.ENQ.LIST.INDX);
      582     2039    1       CALL M$DEQ(GLOBAL.DEQ$->FPT$DEQ) ALTRET(DEQ_ERR);
      583     2040
      584     2041        /*      Forget about mapping from buffers. */
      585     2042    1       GLOBAL.BCB.BUF.ENQINDX(ENQLIST.BUFSLOT(GLOBAL.ENQ.LIST.INDX))=0;
PL6.E3A0      #004=ZIM$DEQ_DCB File=ZIM$ENQM.:ZIC0TSI                            FRI 09/05/97 12:53 Page:96   
      586     2043    1       ENQLIST.BUFSLOT(GLOBAL.ENQ.LIST.INDX)=0;
      587     2044
      588     2045    1       IF GLOBAL.ENQ.LIST.INDX<GLOBAL.ENQ.LIST.COUNT THEN
      589     2046        /*          Have something to pack down. */
      590     2047    1           CALL ZIM$SHIFT_ENQLIST(GLOBAL.ENQ.LIST.INDX+1,-1);
      591     2048    1       GLOBAL.ENQ.LIST.COUNT=GLOBAL.ENQ.LIST.COUNT-1;
      592     2049
      593     2050    2       IF GLOBAL.PARAN.TRACE.MODE~='0'B THEN DO;
      594     2051    2           GLOBAL.PARAN.TRACE.PNO=1;
      595     2052    2           GLOBAL.PARAN.TRACE.PDCB=ENQLIST.VALUE.DCB#(GLOBAL.ENQ.LIST.INDX);
      596     2053    2           GLOBAL.PARAN.TRACE.TYPE=%TR#PDEQALL;
      597     2054    2           CALL ZIM$TRACE;
      598     2055    2           END;
      599     2056
      600     2057    1   RET:RETURN;
      601     2058    1   DEQ_ERR:;
      602     2059    1       ERROR=ERR#IO#CAC;
      603     2060    1       GLOBAL.RET.SYSERR#=B$TCB$->B$TCB.ALT$->B$ALT.ERR;
      604     2061    1       GLOBAL.RET.DCB#=GLOBAL.DEQ$->FPT$DEQ.V.DCB#;
      605     2062            %DBALT;
      606     2076    1   END ZIM$DEQ_DCB;
      607     2077        %EOD;

PL6.E3A0      #004=ZIM$DEQ_DCB File=ZIM$ENQM.:ZIC0TSI                            FRI 09/05/97 12:53 Page:97   
--  Include file information  --

   ZI_ERRORS_C.:ZIC0TOU  is referenced.
   CP_6_SUBS.:LIB_E05  is referenced.
   CP_6.:LIB_E05  cannot be made into a system file and is referenced.
   ZI$GLOBAL.:ZIC0TOU  is referenced.
   B$JIT_C.:E05TOU  was found in the system file and is never referenced.
   CP_6_C.:E05TOU  was found in the system file and is referenced.
      No diagnostics issued in procedure ZIM$DEQ_DCB.

   Procedure ZIM$DEQ_DCB requires 344 words for executable code.
   Procedure ZIM$DEQ_DCB requires 16 words of local(AUTO) storage.

PL6.E3A0      #004=ZIM$DEQ_DCB File=ZIM$ENQM.:ZIC0TSI                            FRI 09/05/97 12:53 Page:98   

 Object Unit name= ZIM$DEQ_DCB                                File name= ZIM$ENQM.:ZIC0TOU
 UTS= SEP 05 '97 12:53:12.24 FRI                              Compiler= PL-6/E31         Sev=      00
 SharedLib= :SHARED_SYSTEM                                    Alt SharedLib=


    ****  Control sections  ****

 Sect   Type Bound  Init  Size OctSiz  Section name(segment info)
    0   DCB   even  none     0      0  M$UC
    1   Proc  even  none   344    530  ZIM$DEQ_DCB
    2  RoData even  none    10     12  ZIM$DEQ_DCB

    ****  Entry defs  ****

                              Check   Calling
                             calling  sequence
  Sect OctLoc Primary Altret sequence   type   Parms  Name
     1      0   yes    yes     yes      XStd       1  ZIM$DEQ_DCB
     1    320          yes     yes      XStd       0  ZIM$DEQ_ONE

  ****  Entry refs  ****

         Check        Calling
        calling       sequence
Altret sequence SRef   type   Args  Name
         yes           XStd      2 ZIM$SHIFT_ENQLIST
         yes           XStd      0 ZIM$TRACE
         yes           XStd      0 ZIB$ERR
                       nStd      0 X66_AUTO_1
                       nStd      0 X66_ARET
                       nStd      0 X66_AALT
PL6.E3A0      #004=ZIM$DEQ_DCB File=ZIM$ENQM.:ZIC0TSI                            FRI 09/05/97 12:53 Page:99   

  ****  Data refs  ****

  Flags:  r = read only, s = secondary
Flgs Name                             Flgs Name                             Flgs Name
r    GLOBAL$                               M$UC                                  B$TCB$

  ****  Segment refs  ****

  Flags:  r = read only, s = secondary
Flgs Name                             Flgs Name                             Flgs Name
     ROSID                                 NULLSID                               ISSID
PL6.E3A0      #004=ZIM$DEQ_DCB File=ZIM$ENQM.:ZIC0TSI                            FRI 09/05/97 12:53 Page:100  


      435        1        /*T***********************************************************/
      436        2        /*T*                                                         */
      437        3        /*T* Copyright (c) Bull HN Information Systems Inc., 1997    */
      438        4        /*T*                                                         */
      439        5        /*T***********************************************************/
      440        6        /*P*
      441        7        NAME:   ZIM$DEQ_DCB
      442        8        PURPOSE:To drop all the ENQs against a particular DCB.
      443        9        */
      444       10        /*D*
      445       11        NAME:   ZIM$DEQ_DCB
      446       12        CALL:   CALL ZIM$DEQ_DCB(DCB#) ALTRET;
      447       13        INPUT:  DCB# - The DCB# chosen.
      448       14        DESCRIPTION:
      449       15            The two arrays ENQLIST and INDXMAP are searched for entries
      450       16            against the specified DCB.  If any are found they are removed
      451       17            and the lists are compacted.
      452       18        */
      453       19        ZIM$DEQ_DCB: PROC(DCB#) ALTRET AVOID($PR5,$PR6,$PR7);

     19  1 000000   000000 700200 xent  ZIM$DEQ_DCB  TSX0  ! X66_AUTO_1
         1 000001   000020 000001                    ZERO    16,1

      454       20
      455       21    1   DCL DCB# SBIN HALF HALIGNED;
      456       22
      457       23        %INCLUDE ZI$GLOBAL;
      458      509         %GLOBALS;
      459      817         %ENQLIST;
      460      835         %INDXMAP;
      461      851         %TRCE_SUBS;
      462      875        %INCLUDE CP_6;
      463      956         %FPT_DEQ(FPTN=FPT$DEQ,STCLASS=BASED);
      464      973         %FPT_DEQ(FPTN=FPT$DEQALL,STCLASS=BASED);
      465      990         %B$TCB;
      466      993         %B$ALT;
PL6.E3A0      #004=ZIM$DEQ_DCB File=ZIM$ENQM.:ZIC0TSI                            FRI 09/05/97 12:53 Page:101  
      467     1001         %F$DCB;
      468     1058        %INCLUDE CP_6_SUBS;
      469     1598        %INCLUDE ZI_ERRORS_C;
      470     1924
      471     1925    1   DCL ZIM$TRACE ENTRY;
      472     1926    1   DCL ZIM$SHIFT_ENQLIST ENTRY(2);
      473     1927    1   DCL B$TCB$ PTR SYMREF ALIGNED;
      474     1928
      475     1929    1   DCL LOW SBIN ALIGNED;
      476     1930    1   DCL HIGH SBIN ALIGNED;
      477     1931    1   DCL ERROR REDEF HIGH UBIN;
      478     1932    1   DCL CHAR_MOVE CHAR(LOW) BASED CALIGNED;
      479     1933    1   DCL F$DCB$ PTR;
      480     1934
      481     1935    1   DCL COUNT UBIN;
      482     1936    1   DCL I UBIN;
      483     1937    1   DCL SIZE UBIN;
      484     1938    1   DCL CHARS CHAR(SIZE) BASED CALIGNED;
      485     1939
      486     1940    1       IF DCB#=0 THEN

   1940  1 000002   200003 470500                    LDP0    @DCB#,,AUTO
         1 000003   000100 100500                    MLR     fill='000'O
         1 000004   000000 000002                    ADSC9   0,,PR0                   cn=0,n=2
         1 000005   200014 000004                    ADSC9   SIZE+1,,AUTO             cn=0,n=4
         1 000006   200014 236100                    LDQ     SIZE+1,,AUTO
         1 000007   000022 732000                    QRS     18
         1 000010   000000 116003                    CMPQ    0,DU
         1 000011   000476 600000 1                  TZE     RET

      487     1941    1           GOTO RET;
      488     1942
      489     1943    1       INDXMAP$=GLOBAL.ENQ.INDXMAP.BASE$;

   1943  1 000012   000000 471400 xsym               LDP1    GLOBAL$
         1 000013   101415 236100                    LDQ     781,,PR1
         1 000014   200005 756100                    STQ     INDXMAP$,,AUTO
PL6.E3A0      #004=ZIM$DEQ_DCB File=ZIM$ENQM.:ZIC0TSI                            FRI 09/05/97 12:53 Page:102  

      490     1944    1       ENQLIST$=GLOBAL.ENQ.LIST.BASE$;

   1944  1 000015   101411 236100                    LDQ     777,,PR1
         1 000016   200004 756100                    STQ     ENQLIST$,,AUTO

      491     1945    1       F$DCB$ = DCBADDR(DCB#);

   1945  1 000017   000000 473400 2                  LDP3    0
         1 000020   300000 474500                    LDP4    0,,PR3
         1 000021   000100 100500                    MLR     fill='000'O
         1 000022   000000 000002                    ADSC9   0,,PR0                   cn=0,n=2
         1 000023   200014 000004                    ADSC9   SIZE+1,,AUTO             cn=0,n=4
         1 000024   200014 236100                    LDQ     SIZE+1,,AUTO
         1 000025   000022 732000                    QRS     18
         1 000026   400000 236106                    LDQ     0,QL,PR4
         1 000027   200010 756100                    STQ     F$DCB$,,AUTO

      492     1946
      493     1947    2       IF F$DCB$->F$DCB.ORG#=%INDEXED# THEN DO;

   1947  1 000030   200010 470500                    LDP0    F$DCB$,,AUTO
         1 000031   000032 236100                    LDQ     26,,PR0
         1 000032   777000 376003                    ANQ     -512,DU
         1 000033   006000 116003                    CMPQ    3072,DU
         1 000034   000115 601000 1                  TNZ     EL

      494     1948        /*          First remove entries from the INDXMAP list. */
      495     1949    2           COUNT = GLOBAL.ENQ.INDXMAP.COUNT;

   1949  1 000035   101414 236100                    LDQ     780,,PR1
         1 000036   000022 772000                    QRL     18
         1 000037   200011 756100                    STQ     COUNT,,AUTO

      496     1950    3           DO I = COUNT DOWNTO 1;

   1950  1 000040   200012 756100                    STQ     I,,AUTO
PL6.E3A0      #004=ZIM$DEQ_DCB File=ZIM$ENQM.:ZIC0TSI                            FRI 09/05/97 12:53 Page:103  
         1 000041   000113 710000 1                  TRA     s:1963+3

      497     1951    3               IF ENQLIST.VALUE.DCB#(INDXMAP.ENQINDX(I))=DCB#

   1951  1 000042   200012 235100                    LDA     I,,AUTO
         1 000043   000001 735000                    ALS     1
         1 000044   200005 470500                    LDP0    INDXMAP$,,AUTO
         1 000045   000000 236105                    LDQ     0,AL,PR0
         1 000046   000001 736000                    QLS     1
         1 000047   000001 376000 2                  ANQ     1
         1 000050   200003 471500                    LDP1    @DCB#,,AUTO
         1 000051   000100 100500                    MLR     fill='000'O
         1 000052   100000 000002                    ADSC9   0,,PR1                   cn=0,n=2
         1 000053   200014 000004                    ADSC9   SIZE+1,,AUTO             cn=0,n=4
         1 000054   000000 620006                    EAX0    0,QL
         1 000055   200014 236100                    LDQ     SIZE+1,,AUTO
         1 000056   000022 732000                    QRS     18
         1 000057   200015 756100                    STQ     SIZE+2,,AUTO
         1 000060   200004 473500                    LDP3    ENQLIST$,,AUTO
         1 000061   300000 236110                    LDQ     0,X0,PR3
         1 000062   777777 376007                    ANQ     -1,DL
         1 000063   200015 116100                    CMPQ    SIZE+2,,AUTO
         1 000064   000110 601000 1                  TNZ     s:1963

      498     1952    4               THEN DO;

      499     1953    4                   IF I < GLOBAL.ENQ.INDXMAP.COUNT

   1953  1 000065   000000 474400 xsym               LDP4    GLOBAL$
         1 000066   401414 236100                    LDQ     780,,PR4
         1 000067   000022 772000                    QRL     18
         1 000070   200012 116100                    CMPQ    I,,AUTO
         1 000071   000105 602000 1                  TNC     s:1961
         1 000072   000105 600000 1                  TZE     s:1961

      500     1954    5                   THEN DO;

PL6.E3A0      #004=ZIM$DEQ_DCB File=ZIM$ENQM.:ZIC0TSI                            FRI 09/05/97 12:53 Page:104  
      501     1955
      502     1956        /*                      Have something to pack down. */
      503     1957    5                       SIZE=(GLOBAL.ENQ.INDXMAP.COUNT - I)*SIZEC(INDXMAP(0));

   1957  1 000073   200012 136100                    SBLQ    I,,AUTO
         1 000074   000003 736000                    QLS     3
         1 000075   200013 756100                    STQ     SIZE,,AUTO

      504     1958    5                       ADDR(INDXMAP(I))->CHARS=ADDR(INDXMAP(I+1))->CHARS;

   1958  1 000076   200012 235100                    LDA     I,,AUTO
         1 000077   000003 735000                    ALS     3
         1 000100   000000 620006                    EAX0    0,QL
         1 000101   200013 721100                    LXL1    SIZE,,AUTO
         1 000102   040145 100545                    MLR     fill='040'O
         1 000103   000002 000010                    ADSC9   2,A,PR0                  cn=0,n=*X0
         1 000104   000000 000011                    ADSC9   0,A,PR0                  cn=0,n=*X1

      505     1959    5                       END;

      506     1960
      507     1961    4                   GLOBAL.ENQ.INDXMAP.COUNT=GLOBAL.ENQ.INDXMAP.COUNT - 1;

   1961  1 000105   401414 220100                    LDX0    780,,PR4
         1 000106   777777 621010                    EAX1    -1,X0
         1 000107   401414 741100                    STX1    780,,PR4

      508     1962    4                   END;

      509     1963    3               END;

   1963  1 000110   200012 235100                    LDA     I,,AUTO
         1 000111   000001 135007                    SBLA    1,DL
         1 000112   200012 755100                    STA     I,,AUTO
         1 000113   200012 235100                    LDA     I,,AUTO
         1 000114   000042 601000 1                  TNZ     s:1951

PL6.E3A0      #004=ZIM$DEQ_DCB File=ZIM$ENQM.:ZIC0TSI                            FRI 09/05/97 12:53 Page:105  
      510     1964    2           END;

      511     1965
      512     1966        /*          Now check ENQLIST in the same manner. */
      513     1967    1   EL: LOW=1;

   1967  1 000115   000001 235007       EL           LDA     1,DL
         1 000116   200006 755100                    STA     LOW,,AUTO

      514     1968    2       DO WHILE(LOW<=GLOBAL.ENQ.LIST.COUNT);

   1968  1 000117   000000 470400 xsym               LDP0    GLOBAL$
         1 000120   001412 236100                    LDQ     778,,PR0
         1 000121   777777 376007                    ANQ     -1,DL
         1 000122   200006 116100                    CMPQ    LOW,,AUTO
         1 000123   000150 604000 1                  TMI     s:1973

      515     1969    2           IF ENQLIST.VALUE.DCB#(LOW)=DCB# THEN

   1969  1 000124   200003 470500                    LDP0    @DCB#,,AUTO
         1 000125   000100 100500                    MLR     fill='000'O
         1 000126   000000 000002                    ADSC9   0,,PR0                   cn=0,n=2
         1 000127   200014 000004                    ADSC9   SIZE+1,,AUTO             cn=0,n=4
         1 000130   200014 236100                    LDQ     SIZE+1,,AUTO
         1 000131   000022 732000                    QRS     18
         1 000132   200015 756100                    STQ     SIZE+2,,AUTO
         1 000133   200006 235100                    LDA     LOW,,AUTO
         1 000134   000001 735000                    ALS     1
         1 000135   200004 471500                    LDP1    ENQLIST$,,AUTO
         1 000136   100000 236105                    LDQ     0,AL,PR1
         1 000137   777777 376007                    ANQ     -1,DL
         1 000140   200015 116100                    CMPQ    SIZE+2,,AUTO
         1 000141   000151 600000 1                  TZE     EH

      516     1970    2               GOTO EH;
      517     1971    2           LOW=LOW+1;

PL6.E3A0      #004=ZIM$DEQ_DCB File=ZIM$ENQM.:ZIC0TSI                            FRI 09/05/97 12:53 Page:106  
   1971  1 000142   200006 054100                    AOS     LOW,,AUTO

      518     1972    2           END;

   1972  1 000143   000000 473400 xsym               LDP3    GLOBAL$
         1 000144   301412 236100                    LDQ     778,,PR3
         1 000145   777777 376007                    ANQ     -1,DL
         1 000146   200006 116100                    CMPQ    LOW,,AUTO
         1 000147   000124 605000 1                  TPL     s:1969

      519     1973    1       GOTO RET;

   1973  1 000150   000476 710000 1                  TRA     RET

      520     1974
      521     1975    1   EH: HIGH=LOW+1;

   1975  1 000151   200006 235100       EH           LDA     LOW,,AUTO
         1 000152   000001 035007                    ADLA    1,DL
         1 000153   200007 755100                    STA     HIGH,,AUTO

      522     1976    2   EH1:DO WHILE(HIGH<=GLOBAL.ENQ.LIST.COUNT);

   1976  1 000154   000000 473400 xsym  EH1          LDP3    GLOBAL$
         1 000155   301412 236100                    LDQ     778,,PR3
         1 000156   777777 376007                    ANQ     -1,DL
         1 000157   200007 116100                    CMPQ    HIGH,,AUTO
         1 000160   000205 604000 1                  TMI     s:1981

      523     1977    2           IF ENQLIST.VALUE.DCB#(HIGH)~=DCB# THEN

   1977  1 000161   200003 470500                    LDP0    @DCB#,,AUTO
         1 000162   000100 100500                    MLR     fill='000'O
         1 000163   000000 000002                    ADSC9   0,,PR0                   cn=0,n=2
         1 000164   200014 000004                    ADSC9   SIZE+1,,AUTO             cn=0,n=4
         1 000165   200014 236100                    LDQ     SIZE+1,,AUTO
         1 000166   000022 732000                    QRS     18
PL6.E3A0      #004=ZIM$DEQ_DCB File=ZIM$ENQM.:ZIC0TSI                            FRI 09/05/97 12:53 Page:107  
         1 000167   200015 756100                    STQ     SIZE+2,,AUTO
         1 000170   200007 235100                    LDA     HIGH,,AUTO
         1 000171   000001 735000                    ALS     1
         1 000172   200004 471500                    LDP1    ENQLIST$,,AUTO
         1 000173   100000 236105                    LDQ     0,AL,PR1
         1 000174   777777 376007                    ANQ     -1,DL
         1 000175   200015 116100                    CMPQ    SIZE+2,,AUTO
         1 000176   000205 601000 1                  TNZ     s:1981

      524     1978    2               EXIT EH1;
      525     1979    2           HIGH=HIGH+1;

   1979  1 000177   200007 054100                    AOS     HIGH,,AUTO

      526     1980    2           END;

   1980  1 000200   000000 473400 xsym               LDP3    GLOBAL$
         1 000201   301412 236100                    LDQ     778,,PR3
         1 000202   777777 376007                    ANQ     -1,DL
         1 000203   200007 116100                    CMPQ    HIGH,,AUTO
         1 000204   000161 605000 1                  TPL     s:1977

      527     1981    1       HIGH=HIGH-1;

   1981  1 000205   000001 336007                    LCQ     1,DL
         1 000206   200007 056100                    ASQ     HIGH,,AUTO

      528     1982
      529     1983    1       IF HIGH<GLOBAL.ENQ.LIST.COUNT THEN

   1983  1 000207   000000 473400 xsym               LDP3    GLOBAL$
         1 000210   301412 236100                    LDQ     778,,PR3
         1 000211   777777 376007                    ANQ     -1,DL
         1 000212   200007 116100                    CMPQ    HIGH,,AUTO
         1 000213   000233 604400 1                  TMOZ    s:1986

      530     1984        /*          Have something to pack down. */
PL6.E3A0      #004=ZIM$DEQ_DCB File=ZIM$ENQM.:ZIC0TSI                            FRI 09/05/97 12:53 Page:108  
      531     1985    1           CALL ZIM$SHIFT_ENQLIST(HIGH+1,-(HIGH-LOW+1));

   1985  1 000214   200007 236100                    LDQ     HIGH,,AUTO
         1 000215   200006 136100                    SBLQ    LOW,,AUTO
         1 000216   200007 235100                    LDA     HIGH,,AUTO
         1 000217   000001 035007                    ADLA    1,DL
         1 000220   200014 755100                    STA     SIZE+1,,AUTO
         1 000221   000004 676000 2                  ERQ     4
         1 000222   200015 756100                    STQ     SIZE+2,,AUTO
         1 000223   200015 634500                    EPPR4   SIZE+2,,AUTO
         1 000224   200017 454500                    STP4    SIZE+4,,AUTO
         1 000225   200014 630500                    EPPR0   SIZE+1,,AUTO
         1 000226   200016 450500                    STP0    SIZE+3,,AUTO
         1 000227   200016 630500                    EPPR0   SIZE+3,,AUTO
         1 000230   000003 631400 2                  EPPR1   3
         1 000231   000000 701000 xent               TSX1    ZIM$SHIFT_ENQLIST
         1 000232   000000 011000                    NOP     0

      532     1986    1       GLOBAL.ENQ.LIST.COUNT=GLOBAL.ENQ.LIST.COUNT-(HIGH-LOW+1);

   1986  1 000233   200007 236100                    LDQ     HIGH,,AUTO
         1 000234   200006 136100                    SBLQ    LOW,,AUTO
         1 000235   200014 756100                    STQ     SIZE+1,,AUTO
         1 000236   000000 470400 xsym               LDP0    GLOBAL$
         1 000237   001412 236100                    LDQ     778,,PR0
         1 000240   777777 376007                    ANQ     -1,DL
         1 000241   200014 136100                    SBLQ    SIZE+1,,AUTO
         1 000242   777777 620006                    EAX0    -1,QL
         1 000243   001412 440100                    SXL0    778,,PR0

      533     1987
      534     1988        /*      Dequeue all entires for the DCB. */
      535     1989    1       GLOBAL.DEQALL$->FPT$DEQALL.V.DCB#=DCB#;

   1989  1 000244   005111 471500                    LDP1    2633,,PR0
         1 000245   200003 473500                    LDP3    @DCB#,,AUTO
         1 000246   000100 100500                    MLR     fill='000'O
PL6.E3A0      #004=ZIM$DEQ_DCB File=ZIM$ENQM.:ZIC0TSI                            FRI 09/05/97 12:53 Page:109  
         1 000247   300000 000002                    ADSC9   0,,PR3                   cn=0,n=2
         1 000250   100006 000002                    ADSC9   6,,PR1                   cn=0,n=2

      536     1990    1       CALL M$DEQ(GLOBAL.DEQALL$->FPT$DEQALL) ALTRET(DEQ_ERR);

   1990  1 000251   005111 471500                    LDP1    2633,,PR0
         1 000252   100000 630500                    EPPR0   0,,PR1
         1 000253   420003 713400                    CLIMB   alt,+8195
         1 000254   401000 401760                    pmme    nvectors=3
         1 000255   000477 702000 1                  TSX2    DEQ_ERR

      537     1991    2       IF GLOBAL.PARAN.TRACE.MODE~='0'B THEN DO;

   1991  1 000256   000000 470400 xsym               LDP0    GLOBAL$
         1 000257   000061 235100                    LDA     49,,PR0
         1 000260   000317 600000 1                  TZE     s:2001

      538     1992    2           GLOBAL.PARAN.TRACE.PNO=(HIGH-LOW)+1;

   1992  1 000261   200007 236100                    LDQ     HIGH,,AUTO
         1 000262   200006 136100                    SBLQ    LOW,,AUTO
         1 000263   000001 036007                    ADLQ    1,DL
         1 000264   000056 756100                    STQ     46,,PR0

      539     1993    2           GLOBAL.PARAN.TRACE.PDCB=DCB#;

   1993  1 000265   200003 471500                    LDP1    @DCB#,,AUTO
         1 000266   000100 100500                    MLR     fill='000'O
         1 000267   100000 000002                    ADSC9   0,,PR1                   cn=0,n=2
         1 000270   000055 400002                    ADSC9   45,,PR0                  cn=2,n=2

      540     1994    2           IF DCBADDR(DCB#)->F$DCB.ORG#=%IDS# THEN

   1994  1 000271   000000 473400 2                  LDP3    0
         1 000272   300000 474500                    LDP4    0,,PR3
         1 000273   000100 100500                    MLR     fill='000'O
         1 000274   100000 000002                    ADSC9   0,,PR1                   cn=0,n=2
PL6.E3A0      #004=ZIM$DEQ_DCB File=ZIM$ENQM.:ZIC0TSI                            FRI 09/05/97 12:53 Page:110  
         1 000275   200014 000004                    ADSC9   SIZE+1,,AUTO             cn=0,n=4
         1 000276   200014 236100                    LDQ     SIZE+1,,AUTO
         1 000277   000022 732000                    QRS     18
         1 000300   400000 470506                    LDP0    0,QL,PR4
         1 000301   000032 236100                    LDQ     26,,PR0
         1 000302   777000 376003                    ANQ     -512,DU
         1 000303   007000 116003                    CMPQ    3584,DU
         1 000304   000311 601000 1                  TNZ     s:1997

      541     1995    2               GLOBAL.PARAN.TRACE.TYPE=%TR#PDEQALL;

   1995  1 000305   000025 220003                    LDX0    21,DU
         1 000306   000000 470400 xsym               LDP0    GLOBAL$
         1 000307   000060 740100                    STX0    48,,PR0
         1 000310   000314 710000 1                  TRA     s:1998

      542     1996    2           ELSE
      543     1997    2               GLOBAL.PARAN.TRACE.TYPE=%TR#IDEQALL;

   1997  1 000311   000026 220003                    LDX0    22,DU
         1 000312   000000 470400 xsym               LDP0    GLOBAL$
         1 000313   000060 740100                    STX0    48,,PR0

      544     1998    2           CALL ZIM$TRACE;

   1998  1 000314   000005 631400 2                  EPPR1   5
         1 000315   000000 701000 xent               TSX1    ZIM$TRACE
         1 000316   000000 011000                    NOP     0

      545     1999    2           END;

      546     2000
      547     2001    1       GOTO RET;

   2001  1 000317   000476 710000 1                  TRA     RET

      548     2002        %EJECT;
PL6.E3A0      #004=ZIM$DEQ_DCB File=ZIM$ENQM.:ZIC0TSI                            FRI 09/05/97 12:53 Page:111  
      549     2003        /*P*
      550     2004        NAME:   ZIM$DEQ_ONE
      551     2005        PURPOSE:To drop a single ENQ if possible.
      552     2006        */
      553     2007        /*D*
      554     2008        NAME:   ZIM$DEQ_ONE
      555     2009        CALL:   CALL ZIM$DEQ_ONE
      556     2010        INPUT:  GLOBAL.ENQ.LIST.INDX
      557     2011        DESCRIPTION:
      558     2012            An individual ENQ identified by GLOBAL.ENQ.LIST.INDX is
      559     2013            DEQed and removed from ENQLIST.  All related structures are
      560     2014            also updated.  If the DCB# of the entry in ENQLIST identifies
      561     2015            an indexed area, the DEQ will only be done if no entries in
      562     2016            INDXMAP are mapped onto it.
      563     2017        */
      564     2018    1   ZIM$DEQ_ONE: ENTRY ALTRET;

   2018  1 000320   000000 700200 xent  ZIM$DEQ_ONE  TSX0  ! X66_AUTO_1
         1 000321   000020 000001                    ZERO    16,1

      565     2019
      566     2020    1       ENQLIST$=GLOBAL.ENQ.LIST.BASE$;

   2020  1 000322   000000 470400 xsym               LDP0    GLOBAL$
         1 000323   001411 236100                    LDQ     777,,PR0
         1 000324   200004 756100                    STQ     ENQLIST$,,AUTO

      567     2021    1       INDXMAP$=GLOBAL.ENQ.INDXMAP.BASE$;

   2021  1 000325   001415 236100                    LDQ     781,,PR0
         1 000326   200005 756100                    STQ     INDXMAP$,,AUTO

      568     2022
      569     2023    1       IF DCBADDR(ENQLIST.VALUE.DCB#(GLOBAL.ENQ.LIST.INDX))->

   2023  1 000327   001412 220100                    LDX0    778,,PR0
         1 000330   001412 020100                    ADLX0   778,,PR0
PL6.E3A0      #004=ZIM$DEQ_DCB File=ZIM$ENQM.:ZIC0TSI                            FRI 09/05/97 12:53 Page:112  
         1 000331   000000 471400 2                  LDP1    0
         1 000332   100000 473500                    LDP3    0,,PR1
         1 000333   200004 474500                    LDP4    ENQLIST$,,AUTO
         1 000334   400000 721110                    LXL1    0,X0,PR4
         1 000335   300000 470511                    LDP0    0,X1,PR3
         1 000336   000032 236100                    LDQ     26,,PR0
         1 000337   777000 376003                    ANQ     -512,DU
         1 000340   006000 116003                    CMPQ    3072,DU
         1 000341   000372 601000 1                  TNZ     s:2037

      570     2024    1          F$DCB.ORG#=%INDEXED# THEN
      571     2025        /*          See if anyone still using this ENQ. */
      572     2026    2       DO LOW=1 TO GLOBAL.ENQ.INDXMAP.COUNT;

   2026  1 000342   000001 235007                    LDA     1,DL
         1 000343   200006 755100                    STA     LOW,,AUTO
         1 000344   000365 710000 1                  TRA     s:2034+1

      573     2027    3           IF GLOBAL.ENQ.LIST.INDX=INDXMAP.ENQINDX(LOW) THEN DO;

   2027  1 000345   200006 235100                    LDA     LOW,,AUTO
         1 000346   000001 735000                    ALS     1
         1 000347   200005 470500                    LDP0    INDXMAP$,,AUTO
         1 000350   000000 236105                    LDQ     0,AL,PR0
         1 000351   000006 376000 2                  ANQ     6
         1 000352   200014 756100                    STQ     SIZE+1,,AUTO
         1 000353   000000 471400 xsym               LDP1    GLOBAL$
         1 000354   101412 236100                    LDQ     778,,PR1
         1 000355   000022 772000                    QRL     18
         1 000356   200014 116100                    CMPQ    SIZE+1,,AUTO
         1 000357   000364 601000 1                  TNZ     s:2034

      574     2028    3               ERROR=1;

   2028  1 000360   000001 235007                    LDA     1,DL
         1 000361   200007 755100                    STA     HIGH,,AUTO

PL6.E3A0      #004=ZIM$DEQ_DCB File=ZIM$ENQM.:ZIC0TSI                            FRI 09/05/97 12:53 Page:113  
      575     2029                    %DBEXC;

   2030  1 000362   100006 755100                    STA     6,,PR1

   2031  1 000363   000000 702200 xent               TSX2  ! X66_ARET

      576     2033    3               END;
      577     2034    2           END;

   2034  1 000364   200006 054100                    AOS     LOW,,AUTO
         1 000365   000000 470400 xsym               LDP0    GLOBAL$
         1 000366   001414 236100                    LDQ     780,,PR0
         1 000367   000022 772000                    QRL     18
         1 000370   200006 116100                    CMPQ    LOW,,AUTO
         1 000371   000345 605000 1                  TPL     s:2027

      578     2035
      579     2036        /*      Release ENQ. */
      580     2037    1       GLOBAL.DEQ$->FPT$DEQ.V.DCB#=ENQLIST.VALUE.DCB#(GLOBAL.ENQ.LIST.INDX);

   2037  1 000372   000000 470400 xsym               LDP0    GLOBAL$
         1 000373   005137 471500                    LDP1    2655,,PR0
         1 000374   001412 220100                    LDX0    778,,PR0
         1 000375   001412 020100                    ADLX0   778,,PR0
         1 000376   200004 473500                    LDP3    ENQLIST$,,AUTO
         1 000377   300000 721110                    LXL1    0,X0,PR3
         1 000400   100006 741100                    STX1    6,,PR1

      581     2038    1       GLOBAL.RNAME.VALUE=ENQLIST.VALUE.RNAME(GLOBAL.ENQ.LIST.INDX);

   2038  1 000401   001412 220100                    LDX0    778,,PR0
         1 000402   001412 020100                    ADLX0   778,,PR0
         1 000403   000000 635010                    EAA     0,X0
         1 000404   000020 771000                    ARL     16
         1 000405   000100 100505                    MLR     fill='000'O
         1 000406   300001 000004                    ADSC9   1,A,PR3                  cn=0,n=4
         1 000407   004776 200004                    ADSC9   2558,,PR0                cn=1,n=4
PL6.E3A0      #004=ZIM$DEQ_DCB File=ZIM$ENQM.:ZIC0TSI                            FRI 09/05/97 12:53 Page:114  

      582     2039    1       CALL M$DEQ(GLOBAL.DEQ$->FPT$DEQ) ALTRET(DEQ_ERR);

   2039  1 000410   005137 471500                    LDP1    2655,,PR0
         1 000411   100000 630500                    EPPR0   0,,PR1
         1 000412   420003 713400                    CLIMB   alt,+8195
         1 000413   401000 401760                    pmme    nvectors=3
         1 000414   000477 702000 1                  TSX2    DEQ_ERR

      583     2040
      584     2041        /*      Forget about mapping from buffers. */
      585     2042    1       GLOBAL.BCB.BUF.ENQINDX(ENQLIST.BUFSLOT(GLOBAL.ENQ.LIST.INDX))=0;

   2042  1 000415   000000 470400 xsym               LDP0    GLOBAL$
         1 000416   001412 220100                    LDX0    778,,PR0
         1 000417   001412 020100                    ADLX0   778,,PR0
         1 000420   200004 471500                    LDP1    ENQLIST$,,AUTO
         1 000421   100000 236110                    LDQ     0,X0,PR1
         1 000422   000022 772000                    QRL     18
         1 000423   000777 376007                    ANQ     511,DL
         1 000424   000005 402007                    MPY     5,DL
         1 000425   000000 621006                    EAX1    0,QL
         1 000426   000007 236000 2                  LDQ     7
         1 000427   000206 356111                    ANSQ    134,X1,PR0

      586     2043    1       ENQLIST.BUFSLOT(GLOBAL.ENQ.LIST.INDX)=0;

   2043  1 000430   001412 220100                    LDX0    778,,PR0
         1 000431   001412 020100                    ADLX0   778,,PR0
         1 000432   000010 236000 2                  LDQ     8
         1 000433   100000 356110                    ANSQ    0,X0,PR1

      587     2044
      588     2045    1       IF GLOBAL.ENQ.LIST.INDX<GLOBAL.ENQ.LIST.COUNT THEN

   2045  1 000434   001412 720100                    LXL0    778,,PR0
         1 000435   001412 100100                    CMPX0   778,,PR0
PL6.E3A0      #004=ZIM$DEQ_DCB File=ZIM$ENQM.:ZIC0TSI                            FRI 09/05/97 12:53 Page:115  
         1 000436   000454 602000 1                  TNC     s:2048
         1 000437   000454 600000 1                  TZE     s:2048

      589     2046        /*          Have something to pack down. */
      590     2047    1           CALL ZIM$SHIFT_ENQLIST(GLOBAL.ENQ.LIST.INDX+1,-1);

   2047  1 000440   001412 236100                    LDQ     778,,PR0
         1 000441   000022 772000                    QRL     18
         1 000442   000001 036007                    ADLQ    1,DL
         1 000443   200014 756100                    STQ     SIZE+1,,AUTO
         1 000444   000011 236000 2                  LDQ     9
         1 000445   200017 756100                    STQ     SIZE+4,,AUTO
         1 000446   200014 633500                    EPPR3   SIZE+1,,AUTO
         1 000447   200016 453500                    STP3    SIZE+3,,AUTO
         1 000450   200016 630500                    EPPR0   SIZE+3,,AUTO
         1 000451   000003 631400 2                  EPPR1   3
         1 000452   000000 701000 xent               TSX1    ZIM$SHIFT_ENQLIST
         1 000453   000000 011000                    NOP     0

      591     2048    1       GLOBAL.ENQ.LIST.COUNT=GLOBAL.ENQ.LIST.COUNT-1;

   2048  1 000454   000000 470400 xsym               LDP0    GLOBAL$
         1 000455   001412 720100                    LXL0    778,,PR0
         1 000456   777777 621010                    EAX1    -1,X0
         1 000457   001412 441100                    SXL1    778,,PR0

      592     2049
      593     2050    2       IF GLOBAL.PARAN.TRACE.MODE~='0'B THEN DO;

   2050  1 000460   000061 235100                    LDA     49,,PR0
         1 000461   000476 600000 1                  TZE     RET

      594     2051    2           GLOBAL.PARAN.TRACE.PNO=1;

   2051  1 000462   000001 236007                    LDQ     1,DL
         1 000463   000056 756100                    STQ     46,,PR0

PL6.E3A0      #004=ZIM$DEQ_DCB File=ZIM$ENQM.:ZIC0TSI                            FRI 09/05/97 12:53 Page:116  
      595     2052    2           GLOBAL.PARAN.TRACE.PDCB=ENQLIST.VALUE.DCB#(GLOBAL.ENQ.LIST.INDX);

   2052  1 000464   001412 220100                    LDX0    778,,PR0
         1 000465   001412 020100                    ADLX0   778,,PR0
         1 000466   200004 471500                    LDP1    ENQLIST$,,AUTO
         1 000467   100000 722110                    LXL2    0,X0,PR1
         1 000470   000055 442100                    SXL2    45,,PR0

      596     2053    2           GLOBAL.PARAN.TRACE.TYPE=%TR#PDEQALL;

   2053  1 000471   000025 223003                    LDX3    21,DU
         1 000472   000060 743100                    STX3    48,,PR0

      597     2054    2           CALL ZIM$TRACE;

   2054  1 000473   000005 631400 2                  EPPR1   5
         1 000474   000000 701000 xent               TSX1    ZIM$TRACE
         1 000475   000000 011000                    NOP     0

      598     2055    2           END;

      599     2056
      600     2057    1   RET:RETURN;

   2057  1 000476   000000 702200 xent  RET          TSX2  ! X66_ARET

   2053  1 000477                       DEQ_ERR      null
      601     2058    1   DEQ_ERR:;
      602     2059    1       ERROR=ERR#IO#CAC;

   2059  1 000477   303375 235007                    LDA     100093,DL
         1 000500   200007 755100                    STA     HIGH,,AUTO

      603     2060    1       GLOBAL.RET.SYSERR#=B$TCB$->B$TCB.ALT$->B$ALT.ERR;

   2060  1 000501   000000 470400 xsym               LDP0    B$TCB$
         1 000502   000000 471500                    LDP1    0,,PR0
PL6.E3A0      #004=ZIM$DEQ_DCB File=ZIM$ENQM.:ZIC0TSI                            FRI 09/05/97 12:53 Page:117  
         1 000503   100102 236100                    LDQ     66,,PR1
         1 000504   000000 473400 xsym               LDP3    GLOBAL$
         1 000505   300007 756100                    STQ     7,,PR3

      604     2061    1       GLOBAL.RET.DCB#=GLOBAL.DEQ$->FPT$DEQ.V.DCB#;

   2061  1 000506   305137 471500                    LDP1    2655,,PR3
         1 000507   100006 220100                    LDX0    6,,PR1
         1 000510   300014 740100                    STX0    12,,PR3

      605     2062            %DBALT;

   2063  1 000511   300006 235100                    LDA     6,,PR3
         1 000512   000521 601000 1                  TNZ     s:2071

   2065  1 000513   300010 450100                    STZ     8,,PR3

   2066  1 000514   300012 450100                    STZ     10,,PR3

   2067  1 000515   300013 450100                    STZ     11,,PR3

   2068  1 000516   300011 450100                    STZ     9,,PR3

   2069  1 000517   200007 235100                    LDA     HIGH,,AUTO
         1 000520   300006 755100                    STA     6,,PR3

   2071  1 000521   303240 115007                    CMPA    100000,DL
         1 000522   000524 603000 1                  TRC     s:2074

   2072  1 000523   000000 702200 xent               TSX2  ! X66_AALT

   2074  1 000524   000005 631400 2                  EPPR1   5
         1 000525   000000 701000 xent               TSX1    ZIB$ERR
         1 000526   000000 011000                    NOP     0

      606     2076    1   END ZIM$DEQ_DCB;

PL6.E3A0      #004=ZIM$DEQ_DCB File=ZIM$ENQM.:ZIC0TSI                            FRI 09/05/97 12:53 Page:118  
   2076  1 000527   000000 702200 xent               TSX2  ! X66_ARET

(unnamed)
 Sect OctLoc
   2     000   000000 006003   001777 777776   000000 006014   000002 000000    ................
   2     004   777777 777777   000000 000000   000777 777777   777777 700000    ................
   2     010   777000 777777   000004 006000                                    ........
      607     2077        %EOD;

PL6.E3A0      #004=ZIM$DEQ_DCB File=ZIM$ENQM.:ZIC0TSI                            FRI 09/05/97 12:53 Page:119  
--  Include file information  --

   ZI_ERRORS_C.:ZIC0TOU  is referenced.
   CP_6_SUBS.:LIB_E05  is referenced.
   CP_6.:LIB_E05  cannot be made into a system file and is referenced.
   ZI$GLOBAL.:ZIC0TOU  is referenced.
   B$JIT_C.:E05TOU  was found in the system file and is never referenced.
   CP_6_C.:E05TOU  was found in the system file and is referenced.
      No diagnostics issued in procedure ZIM$DEQ_DCB.

   Procedure ZIM$DEQ_DCB requires 344 words for executable code.
   Procedure ZIM$DEQ_DCB requires 16 words of local(AUTO) storage.
PL6.E3A0      #004=ZIM$DEQ_DCB File=ZIM$ENQM.:ZIC0TSI                            FRI 09/05/97 12:53 Page:120  
          *** CROSS REFERENCE LISTING ***
**     DENOTES     IDENTIFIER DEFINITION
<<                 IDENTIFIER'S VALUE SET
>>                 IDENTIFIER'S VALUE USED
<>                 IDENTIFIER SET AND/OR USED
--                 IDENTIFIER REFERENCED
PL6.E3A0      #004=ZIM$DEQ_DCB File=ZIM$ENQM.:ZIC0TSI                            FRI 09/05/97 12:53 Page:121  
          MINI XREF LISTING

B$ALT.CODE
       995**DCL       995--REDEF     996--REDEF     996--REDEF
B$ALT.ERR
       996**DCL      2060>>ASSIGN
B$ALT.ERR.ERR#
       997**DCL       997--REDEF
B$ALT.EVID
       996**DCL       996--REDEF     996--REDEF
B$TCB.ALT$
       991**DCL      2060>>ASSIGN
B$TCB$
      1927**DCL      2060>>ASSIGN
CHARS
      1938**DCL      1958<<ASSIGN   1958>>ASSIGN
COUNT
      1935**DCL      1949<<ASSIGN   1950>>DOINDEX
DCB#
        21**DCL        19--PROC     1940>>IF       1945--ASSIGN   1951>>IF       1969>>IF       1977>>IF
      1989>>ASSIGN   1993>>ASSIGN   1994--IF
DEQ_ERR
      2053**LABEL    1990--CALLALT  2039--CALLALT
EH
      1975**LABEL    1970--GOTO
EH1
      1976**LABEL    1978--EXIT
ENQLIST.BUFSLOT
       827**DCL      2042>>ASSIGN   2043<<ASSIGN
ENQLIST.VALUE.DCB#
       831**DCL      1951>>IF       1969>>IF       1977>>IF       2023--IF       2037>>ASSIGN   2052>>ASSIGN
ENQLIST.VALUE.RNAME
       832**DCL      2038>>ASSIGN
ENQLIST$
PL6.E3A0      #004=ZIM$DEQ_DCB File=ZIM$ENQM.:ZIC0TSI                            FRI 09/05/97 12:53 Page:122  
       833**DCL       818--IMP-PTR  1944<<ASSIGN   1951>>IF       1969>>IF       1977>>IF       2020<<ASSIGN
      2023>>IF       2037>>ASSIGN   2038>>ASSIGN   2042>>ASSIGN   2043>>ASSIGN   2052>>ASSIGN
ERROR
      1931**DCL      2028<<ASSIGN   2030>>ASSIGN   2059<<ASSIGN   2069>>ASSIGN
F$DCB.ACTPOS
      1034**DCL      1034--REDEF
F$DCB.ARS#
      1008**DCL      1008--REDEF
F$DCB.ATTR
      1027**DCL      1028--REDEF
F$DCB.BORROW
      1042**DCL      1042--REDEF    1042--REDEF    1042--REDEF
F$DCB.DCBNAME.L
      1056**DCL      1056--IMP-SIZ
F$DCB.EOMCHAR#
      1012**DCL      1012--REDEF
F$DCB.FLDID
      1037**DCL      1037--REDEF
F$DCB.FORM$
      1031**DCL      1031--REDEF
F$DCB.FSECT
      1047**DCL      1047--REDEF
F$DCB.FSN#
      1024**DCL      1024--REDEF    1024--REDEF    1025--REDEF
F$DCB.HEADER$
      1030**DCL      1030--REDEF
F$DCB.IXTNSIZE#
      1028**DCL      1028--REDEF
F$DCB.LASTSTA$
      1017**DCL      1017--REDEF
F$DCB.LVL
      1043**DCL      1043--REDEF
F$DCB.NAME#.C
      1018**DCL      1018--REDEF
F$DCB.NOEOF
      1040**DCL      1040--REDEF
PL6.E3A0      #004=ZIM$DEQ_DCB File=ZIM$ENQM.:ZIC0TSI                            FRI 09/05/97 12:53 Page:123  
F$DCB.NRECS#
      1029**DCL      1029--REDEF
F$DCB.NRECX
      1048**DCL      1048--REDEF
F$DCB.OHDR
      1040**DCL      1040--REDEF
F$DCB.ORG#
      1023**DCL      1023--REDEF    1947>>IF       1994>>IF       2023>>IF
F$DCB.PRECNO
      1046**DCL      1046--REDEF
F$DCB.RCSZ
      1052**DCL      1052--REDEF
F$DCB.RES#
      1019**DCL      1019--REDEF
F$DCB.SETX
      1031**DCL      1031--REDEF
F$DCB.TAB$
      1031**DCL      1031--REDEF
F$DCB.TDA
      1045**DCL      1046--REDEF
F$DCB.WSN#
      1019**DCL      1019--REDEF
F$DCB$
      1933**DCL      1945<<ASSIGN   1947>>IF
FPT$DEQ
       967**DCL      2039<>CALL
FPT$DEQ.V.DCB#
       968**DCL      2037<<ASSIGN   2061>>ASSIGN
FPT$DEQALL
       984**DCL      1990<>CALL
FPT$DEQALL.V.DCB#
       985**DCL      1989<<ASSIGN
GLOBAL.ACTIVE.DBCB$
       516**DCL       517--REDEF
GLOBAL.ACTIVE.SSS$
       512**DCL       513--REDEF
PL6.E3A0      #004=ZIM$DEQ_DCB File=ZIM$ENQM.:ZIC0TSI                            FRI 09/05/97 12:53 Page:124  
GLOBAL.BCB.BUF.ENQINDX
       633**DCL      2042<<ASSIGN
GLOBAL.DEQ$
       808**DCL      2037>>ASSIGN   2039>>CALL     2061>>ASSIGN
GLOBAL.DEQALL$
       786**DCL      1989>>ASSIGN   1990>>CALL
GLOBAL.ENQ.INDXMAP.BASE$
       663**DCL      1943>>ASSIGN   2021>>ASSIGN
GLOBAL.ENQ.INDXMAP.COUNT
       659**DCL      1949>>ASSIGN   1953>>IF       1957>>ASSIGN   1961<<ASSIGN   1961>>ASSIGN   2026>>DOINDEX
GLOBAL.ENQ.LIST.BASE$
       648**DCL      1944>>ASSIGN   2020>>ASSIGN
GLOBAL.ENQ.LIST.COUNT
       652**DCL      1968>>DOWHILE  1976>>DOWHILE  1983>>IF       1986<<ASSIGN   1986>>ASSIGN   2045>>IF
      2048<<ASSIGN   2048>>ASSIGN
GLOBAL.ENQ.LIST.INDX
       650**DCL      2023>>IF       2027>>IF       2037>>ASSIGN   2038>>ASSIGN   2042>>ASSIGN   2043>>ASSIGN
      2045>>IF       2047>>CALL     2052>>ASSIGN
GLOBAL.KEY
       720**DCL       723--REDEF
GLOBAL.PARAN.TRACE.MODE
       595**DCL       602--REDEF    1991>>IF       2050>>IF
GLOBAL.PARAN.TRACE.PDCB
       590**DCL      1993<<ASSIGN   2052<<ASSIGN
GLOBAL.PARAN.TRACE.PNO
       591**DCL      1992<<ASSIGN   2051<<ASSIGN
GLOBAL.PARAN.TRACE.TYPE
       593**DCL      1995<<ASSIGN   1997<<ASSIGN   2053<<ASSIGN
GLOBAL.PRINTBUF.BUFFER
       754**DCL       755--REDEF     756--REDEF     757--REDEF
GLOBAL.PRINTBUF.ERR.V
       759**DCL       762--REDEF     763--REDEF     764--REDEF
GLOBAL.RET.AC#
       532**DCL      2065<<ASSIGN
GLOBAL.RET.DCB#
       536**DCL      2061<<ASSIGN
PL6.E3A0      #004=ZIM$DEQ_DCB File=ZIM$ENQM.:ZIC0TSI                            FRI 09/05/97 12:53 Page:125  
GLOBAL.RET.ERROR#
       530**DCL      2030<<ASSIGN   2063>>IF       2069<<ASSIGN   2071>>IF
GLOBAL.RET.FR#
       533**DCL      2068<<ASSIGN
GLOBAL.RET.RC#
       535**DCL      2067<<ASSIGN
GLOBAL.RET.SC#
       534**DCL      2066<<ASSIGN
GLOBAL.RET.SYSERR#
       531**DCL      2060<<ASSIGN
GLOBAL.RNAME.VALUE
       739**DCL      2038<<ASSIGN
GLOBAL$
       814**DCL       510--IMP-PTR  1943>>ASSIGN   1944>>ASSIGN   1949>>ASSIGN   1953>>IF       1957>>ASSIGN
      1961>>ASSIGN   1961>>ASSIGN   1968>>DOWHILE  1976>>DOWHILE  1983>>IF       1986>>ASSIGN   1986>>ASSIGN
      1989>>ASSIGN   1990>>CALL     1991>>IF       1992>>ASSIGN   1993>>ASSIGN   1995>>ASSIGN   1997>>ASSIGN
      2020>>ASSIGN   2021>>ASSIGN   2023>>IF       2026>>DOINDEX  2027>>IF       2030>>ASSIGN   2037>>ASSIGN
      2037>>ASSIGN   2038>>ASSIGN   2038>>ASSIGN   2039>>CALL     2042>>ASSIGN   2042>>ASSIGN   2043>>ASSIGN
      2045>>IF       2045>>IF       2047>>CALL     2048>>ASSIGN   2048>>ASSIGN   2050>>IF       2051>>ASSIGN
      2052>>ASSIGN   2052>>ASSIGN   2053>>ASSIGN   2060>>ASSIGN   2061>>ASSIGN   2061>>ASSIGN   2063>>IF
      2065>>ASSIGN   2066>>ASSIGN   2067>>ASSIGN   2068>>ASSIGN   2069>>ASSIGN   2071>>IF
HIGH
      1930**DCL      1931--REDEF    1975<<ASSIGN   1976>>DOWHILE  1977>>IF       1979<<ASSIGN   1979>>ASSIGN
      1981<<ASSIGN   1981>>ASSIGN   1983>>IF       1985>>CALL     1985>>CALL     1986>>ASSIGN   1992>>ASSIGN
I
      1936**DCL      1950<<DOINDEX  1951>>IF       1953>>IF       1957>>ASSIGN   1958>>ASSIGN   1958>>ASSIGN
INDXMAP
       836**DCL      1957--ASSIGN   1958--ASSIGN   1958--ASSIGN
INDXMAP.ENQINDX
       845**DCL      1951>>IF       2027>>IF
INDXMAP$
       849**DCL       836--IMP-PTR  1943<<ASSIGN   1951>>IF       1958>>ASSIGN   1958>>ASSIGN   2021<<ASSIGN
      2027>>IF
LOW
      1929**DCL      1932--IMP-SIZ  1967<<ASSIGN   1968>>DOWHILE  1969>>IF       1971<<ASSIGN   1971>>ASSIGN
      1975>>ASSIGN   1985>>CALL     1986>>ASSIGN   1992>>ASSIGN   2026<<DOINDEX  2027>>IF
PL6.E3A0      #004=ZIM$DEQ_DCB File=ZIM$ENQM.:ZIC0TSI                            FRI 09/05/97 12:53 Page:126  
M$DEQ
       951**DCL-ENT  1990--CALL     2039--CALL
RET
      2057**LABEL    1941--GOTO     1973--GOTO     2001--GOTO
SIZE
      1937**DCL      1938--IMP-SIZ  1957<<ASSIGN   1958>>ASSIGN   1958>>ASSIGN
ZIB$ERR
       815**DCL-ENT  2074--CALL
ZIM$SHIFT_ENQLIST
      1926**DCL-ENT  1985--CALL     2047--CALL
ZIM$TRACE
      1925**DCL-ENT  1998--CALL     2054--CALL

PL6.E3A0      #005=ZIM$EKEEP File=ZIM$ENQM.:ZIC0TSI                              FRI 09/05/97 12:53 Page:127  
      608        1        /*M*    ZIM$EKEEP - Keep the page containing current of run enqed */
      609        2        /*T***********************************************************/
      610        3        /*T*                                                         */
      611        4        /*T* Copyright (c) Bull HN Information Systems Inc., 1997    */
      612        5        /*T*                                                         */
      613        6        /*T***********************************************************/
      614        7        ZIM$EKEEP: PROC ALTRET AVOID($PR5,$PR6,$PR7);
      615        8        %INCLUDE CP_6;
      616       89         %F$DCB;
      617      146        %INCLUDE CP_6_SUBS;
      618      686        %SUB_EXC;
      619      733        %INCLUDE ZI$GLOBAL;
      620     1219         %GLOBALS;
      621     1527         %ENQLIST;
      622     1545         %INDXMAP;
      623     1561        %INCLUDE ZI$DBCB;
      624     2203         %DBCB;
      625     2681         %AWS;
      626     2721         %RWS;
      627     2741         %SETWS;
      628     2760        %INCLUDE ZI$SSS;
      629     3309         %OA1;
      630     3317         %OA;
      631     3382         %AC;
      632     3477         %RA;
      633     3497         %RC;
      634     3529         %SC;
      635     3556        %INCLUDE ZI_ERRORS_C;
      636     3882
      637     3883    1   DCL PS0$ PTR SYMREF;
      638     3884    1   DCL DBSTATUS CHAR(7) BASED(PS0$) CALIGNED;
      639     3885    1   DCL ZIM$ENQM ENTRY(2) ALTRET;
      640     3886    1   DCL ZIM$MAPQUE ENTRY(3) ALTRET;
      641     3887    1   DCL ZIM$DEQ_ONE ENTRY ALTRET;
      642     3888
      643     3889    1   DCL ERROR SBIN ALIGNED;
      644     3890    1   DCL DBKEY SBIN ALIGNED;
PL6.E3A0      #005=ZIM$EKEEP File=ZIM$ENQM.:ZIC0TSI                              FRI 09/05/97 12:53 Page:128  
      645     3891    1   DCL DBNO SBIN ALIGNED;
      646     3892    1   DCL INDX SBIN ALIGNED;
      647     3893    1   DCL ALL BIT(1) ALIGNED;
      648     3894    1   DCL I UBIN;
      649     3895    1   DCL SIZE UBIN;
      650     3896    1   DCL CHARS CHAR(SIZE) BASED CALIGNED;
      651     3897    1       DBCB$=GLOBAL.ACTIVE.DBCB$;
      652     3898    1       IF DBCB$=ADDR(NIL) THEN
      653     3899    1           GOTO CRUN_NULL;
      654     3900    1       IF DBCB.CRUN.DBK=0 THEN
      655     3901    1           GOTO CRUN_NULL;
      656     3902
      657     3903        /*      Set up ENQLIST and INDXMAP pointers. */
      658     3904    1       ENQLIST$=GLOBAL.ENQ.LIST.BASE$;
      659     3905    1       INDXMAP$=GLOBAL.ENQ.INDXMAP.BASE$;
      660     3906        /*      Find ENQLIST entry for current of run. */
      661     3907    1       DBKEY=DBCB.CRUN.DBK;
      662     3908    1       SSS$=GLOBAL.ACTIVE.SSS$;
      663     3909    1       RC$=PINCRW(SSS$,DBCB.CRUN.RC);
      664     3910    1       CALL FINDQ_RC;
      665     3911    2       IF AWS.ATRIB.CAC THEN DO;
      666     3912    2           ENQLIST.STATUS.KEEP(GLOBAL.ENQ.LIST.INDX)=%YES#;
      667     3913    2           IF AWS.ATRIB.INDEXED THEN
      668     3914    2               INDXMAP.STATUS.KEEP(GLOBAL.ENQ.INDXMAP.INDX)=%YES#;
      669     3915    2           END;
      670     3916
      671     3917    1       DBSTATUS='0000000';
      672     3918    1       GOTO RET;
      673     3919
      674     3920    1   CRUN_NULL:
      675     3921    1       CALL BINCHAR(DBSTATUS,1900000+EXC#CRNUL);
      676     3922    1       GOTO RET;
      677     3923        %EJECT;
PL6.E3A0      #005=ZIM$EKEEP File=ZIM$ENQM.:ZIC0TSI                              FRI 09/05/97 12:53 Page:129  
      678     3924        /*P*
      679     3925        NAME:   ZIM$EREDUCEQ
      680     3926        PURPOSE:Drop ENQs not representing currencies.
      681     3927        */
      682     3928        /*D*
      683     3929        NAME:   ZIM$EREDUCEQ
      684     3930        ENTRY:  CALL ZIM$EREDUCEQ ALTRET;
      685     3931        DESCRIPTION:
      686     3932            Both ENQLIST and INDXMAP are searched for entries that do
      687     3933            not corrospond to any currencies.  If any are found they
      688     3934            are released.
      689     3935
      690     3936            If ZIM$EREDUCEQ is called, all areas are processed.  If
      691     3937            ZIM$RECUCEQ is called, only those areas that are marked
      692     3938            as currency only are processed.
      693     3939        */
      694     3940    1   ZIM$EREDUCEQ: ENTRY ALTRET;
      695     3941    1       ALL='1'B;
      696     3942    1       GOTO REDUCE;
      697     3943
      698     3944    1   ZIM$REDUCEQ: ENTRY ALTRET;
      699     3945    1       ALL='0'B;
      700     3946
      701     3947    1   REDUCE: ;
      702     3948    1       ENQLIST$=GLOBAL.ENQ.LIST.BASE$;
      703     3949    1       INDXMAP$=GLOBAL.ENQ.INDXMAP.BASE$;
      704     3950
      705     3951    1       CALL MARK_CURRENCY;
      706     3952
      707     3953        /*      Get rid of unneccessary entries from INDXMAP. */
      708     3954    2       DO I=1 TO GLOBAL.ENQ.INDXMAP.COUNT;
      709     3955    2           IF NOT INDXMAP.STATUS.KEEP(I) AND
      710     3956    2              NOT INDXMAP.STATUS.CURRENT(I) AND
      711     3957    2              NOT INDXMAP.STATUS.MODIFY(I) AND
      712     3958    2              (ALL OR DCBADDR(ENQLIST.VALUE.DCB#(INDXMAP.ENQINDX(I)))->
      713     3959    3              F$DCB.UOPT#(1)) THEN DO;
      714     3960        /*              Remove entry from INDXMAP. */
PL6.E3A0      #005=ZIM$EKEEP File=ZIM$ENQM.:ZIC0TSI                              FRI 09/05/97 12:53 Page:130  
      715     3961    4               IF I<GLOBAL.ENQ.INDXMAP.COUNT THEN DO;
      716     3962    4                   SIZE=(GLOBAL.ENQ.INDXMAP.COUNT-I)*SIZEC(INDXMAP(0));
      717     3963    4                   ADDR(INDXMAP(I))->CHARS=ADDR(INDXMAP(I+1))->CHARS;
      718     3964    4                   END;
      719     3965    3               GLOBAL.ENQ.INDXMAP.COUNT=GLOBAL.ENQ.INDXMAP.COUNT-1;
      720     3966    3               I=I-1;
      721     3967    3               END;
      722     3968    2           END;
      723     3969
      724     3970        /*      Get rid of unneccessary entries form ENQLIST. */
      725     3971    2       DO I=1 TO GLOBAL.ENQ.LIST.COUNT;
      726     3972    2           IF NOT ENQLIST.STATUS.KEEP(I) AND
      727     3973    2              NOT ENQLIST.STATUS.MODIFY(I) AND
      728     3974    2              NOT ENQLIST.STATUS.CURRENT(I) AND
      729     3975    2              (ENQLIST.BUFSLOT(I)=0 OR
      730     3976    2              GLOBAL.BCB.BUF.LOCK(ENQLIST.BUFSLOT(I))=0) AND
      731     3977    3              (ALL OR DCBADDR(ENQLIST.VALUE.DCB#(I))->F$DCB.UOPT#(1)) THEN DO;
      732     3978        /*
      733     3979                        If not specifically kept, and not modified and
      734     3980                        not a currency, and (either the page is not in
      735     3981                        memory or is not locked), and (either all areas
      736     3982                        are to be processed or this one specifically is
      737     3983                        to be processed), its ok to drop the ENQ.
      738     3984        */
      739     3985    3               GLOBAL.ENQ.LIST.INDX = I;
      740     3986                    %DBCAL(NAME=ZIM$DEQ_ONE,EXC=NEXTI,ALT=RET);
      741     4002    3               I=I-1;
      742     4003    3               END;
      743     4004    2   NEXTI:  END;
      744     4005    1   RET:RETURN;
      745     4006        %EJECT;
PL6.E3A0      #005=ZIM$EKEEP File=ZIM$ENQM.:ZIC0TSI                              FRI 09/05/97 12:53 Page:131  
      746     4007        /*I*
      747     4008        NAME:   MARK_CURRENCY
      748     4009        PURPOSE:To mark the entries that corrospond to currencies.
      749     4010        */
      750     4011        /*D*
      751     4012        NAME:   MARK_CURRENCY
      752     4013        CALL:   CALL MARK_CURRENCY
      753     4014        DESCRIPTION:
      754     4015            This routine looks through every currency in the DBCB and
      755     4016            marks the entries in both ENQLIST and INDXMAP to indicate
      756     4017            which ones correspond to some currency.  That way we know
      757     4018            which entries we can get rid of later.
      758     4019        */
      759     4020    1   MARK_CURRENCY: PROC ALTRET;
      760     4021
      761     4022        /*      First clear flag in ENQLIST and INDXMAP. */
      762     4023    3       DO I=1 TO GLOBAL.ENQ.LIST.COUNT;
      763     4024    3           ENQLIST.STATUS.CURRENT(I)='0'B;
      764     4025    3           END;
      765     4026    3       DO I=1 TO GLOBAL.ENQ.INDXMAP.COUNT;
      766     4027    3           INDXMAP.STATUS.CURRENT(I)='0'B;
      767     4028    3           END;
      768     4029
      769     4030    3       DO DBNO=1 TO DB#MAX;
      770     4031        /*          For each possible database. */
      771     4032    4           IF GLOBAL.DB.SSS$(DBNO)~=ADDR(NIL) THEN DO;
      772     4033    4               SSS$=GLOBAL.DB.SSS$(DBNO);
      773     4034    4               DBCB$=GLOBAL.DB.DBCB$(DBNO);
      774     4035        /*              Check current of run. */
      775     4036    4               RC$=PINCRW(SSS$,DBCB.CRUN.RC);
      776     4037    4               DBKEY=DBCB.CRUN.DBK;
      777     4038    4               IF DBKEY~=0 THEN
      778     4039    4                   CALL FINDQ_RC;
      779     4040
      780     4041        /*              Check all area currencies. */
      781     4042    4               OA$=PINCRW(SSS$,SIZEW(OA1));
      782     4043    4               AC$=OA$;
PL6.E3A0      #005=ZIM$EKEEP File=ZIM$ENQM.:ZIC0TSI                              FRI 09/05/97 12:53 Page:132  
      783     4044    5               DO WHILE(AC.OAACN~=0);
      784     4045    5                   AC$=PINCRW(SSS$,AC.OAACN);
      785     4046    5                   AWS$=PINCRW(DBCB$,AC.WSOF);
      786     4047    5                   DBKEY=AWS.CURR;
      787     4048    5                   IF DBKEY ~= 0 THEN
      788     4049    5                       CALL FINDQ_AC;
      789     4050    5                   END;
      790     4051
      791     4052        /*              Check all record currencies. */
      792     4053    4               RC$=OA$;
      793     4054    5               DO WHILE(RC.OARCN~=0);
      794     4055    5                   RC$=PINCRW(SSS$,RC.OARCN);
      795     4056    5                   RWS$=PINCRW(DBCB$,RC.RCWSO);
      796     4057    5                   DBKEY=RWS.CURR;
      797     4058    5                   IF DBKEY~=0 THEN
      798     4059    5                       CALL FINDQ_RC;
      799     4060    5                   END;
      800     4061
      801     4062        /*              Check all sets currencies. */
      802     4063    4               SC$=OA$;
      803     4064    5               DO WHILE(SC.OASCN~=0);
      804     4065    5                   SC$=PINCRW(SSS$,SC.OASCN);
      805     4066    5                   SETWS$=PINCRW(DBCB$,SC.SCWSO);
      806     4067    5                   DBKEY=SETWS.CURR;
      807     4068    6                   IF DBKEY~=0 THEN DO;
      808     4069    6                       AC$=PINCRW(SSS$,SETWS.AC);
      809     4070    6                       AWS$=PINCRW(DBCB$,AC.WSOF);
      810     4071    6                       CALL FINDQ_AC;
      811     4072    6                       END;
      812     4073    5                   END;
      813     4074    4               END;
      814     4075    3           END;
      815     4076
      816     4077    2       RETURN;
      817     4078
      818     4079    2   END MARK_CURRENCY;
      819     4080        %EJECT;
PL6.E3A0      #005=ZIM$EKEEP File=ZIM$ENQM.:ZIC0TSI                              FRI 09/05/97 12:53 Page:133  
      820     4081        /*I*
      821     4082        NAME:   FINDQ_RC
      822     4083        PURPOSE:Find the entry representing the RC and mark as currency.
      823     4084        */
      824     4085        /*D*
      825     4086        NAME:   FINDQ_RC
      826     4087        CALL:   CALL FINDQ_RC
      827     4088        INPUT:  RC$ - Identifies the record
      828     4089                DBKEY - The database key of the currency.
      829     4090        OUTPUT: A marked ENQLIST and INDXMAP entry
      830     4091                GLOBAL.ENQ.LIST.INDX - The ENQLIST index.
      831     4092                GLOBAL.ENQ.INDXMAP.INDX - The INDXMAP index.
      832     4093        DESCRIPTION:
      833     4094            The DBKEY is converted to a DCB# and PAGE# which is used to
      834     4095            find the corrosponding entry in the ENQLIST and INDXMAP
      835     4096            tables.  These entries are then marked as being a currency.
      836     4097        */
      837     4098    1   FINDQ_RC: PROC;
      838     4099    2   DCL ZIM$INDXMAP_FIND ENTRY ALTRET;
      839     4100    2   DCL ZIM$ENQ_FIND ENTRY ALTRET;
      840     4101
      841     4102
      842     4103    3       IF RC.DEF.PSTO=4 THEN DO;
      843     4104        /*          The record is indexed.  Only one area. */
      844     4105    3           RA$=PINCRW(SSS$,RC.RCRAN);
      845     4106    3           AC$=PINCRW(SSS$,RA.ACRAH);
      846     4107    3           AWS$=PINCRW(DBCB$,AC.WSOF);
      847     4108    3           END;
      848     4109    3       ELSE DO;
      849     4110        /*          Not indexed.  Must find proper area. */
      850     4111    3           AC$=PINCRW(SSS$,SIZEW(OA1));
      851     4112    4           DO WHILE(AC.OAACN~=0);
      852     4113    4               AC$=PINCRW(SSS$,AC.OAACN);
      853     4114    4               AWS$=PINCRW(DBCB$,AC.WSOF);
      854     4115    4               IF AC.DBLIM.LOWDBK<=DBKEY AND
      855     4116    4                  DBKEY<=AWS.HIGHDBK THEN
      856     4117        /*                  Found proper AC for this DBKEY. */
PL6.E3A0      #005=ZIM$EKEEP File=ZIM$ENQM.:ZIC0TSI                              FRI 09/05/97 12:53 Page:134  
      857     4118    4                   GOTO GOT_AC;
      858     4119    4               END;
      859     4120    3           END;
      860     4121
      861     4122    2   FINDQ_AC: ENTRY;
      862     4123    2   GOT_AC: ;
      863     4124    2       GLOBAL.ENQ.VALUE.DCB#=AWS.DDCB;
      864     4125    2       IF AWS.ATRIB.CAC THEN
      865     4126    3           IF AWS.ATRIB.INDEXED THEN DO;
      866     4127    3               GLOBAL.ENQ.VALUE.RNAME=DBKEY;
      867     4128    3               CALL ZIM$INDXMAP_FIND;
      868     4129    3               INDX=GLOBAL.ENQ.INDXMAP.INDX;
      869     4130    3               INDXMAP.STATUS.CURRENT(INDX)='1'B;
      870     4131    3               ENQLIST.STATUS.CURRENT(INDXMAP.ENQINDX(INDX))='1'B;
      871     4132    3               END;
      872     4133    3           ELSE DO;
      873     4134    3               GLOBAL.ENQ.VALUE.RNAME=
      874     4135    3                  (DBKEY-AC.DBLIM.LOWDBK+AC.LPP)/AC.LPP;
      875     4136    3               CALL ZIM$ENQ_FIND;
      876     4137    3               ENQLIST.STATUS.CURRENT(GLOBAL.ENQ.LIST.INDX)=%YES#;
      877     4138    3               END;
      878     4139    2   RET:RETURN;
      879     4140    2   END FINDQ_RC;
      880     4141    1   END ZIM$EKEEP;

PL6.E3A0      #005=ZIM$EKEEP File=ZIM$ENQM.:ZIC0TSI                              FRI 09/05/97 12:53 Page:135  
--  Include file information  --

   ZI_ERRORS_C.:ZIC0TOU  is referenced.
   ZI$SSS.:ZIC0TOU  cannot be made into a system file and is referenced.
   ZI$DBCB.:ZIC0TOU  is referenced.
   ZI$GLOBAL.:ZIC0TOU  is referenced.
   CP_6_SUBS.:LIB_E05  is referenced.
   CP_6.:LIB_E05  cannot be made into a system file and is referenced.
   B$JIT_C.:E05TOU  was found in the system file and is never referenced.
   CP_6_C.:E05TOU  was found in the system file and is referenced.
      No diagnostics issued in procedure ZIM$EKEEP.

   Procedure ZIM$EKEEP requires 435 words for executable code.
   Procedure ZIM$EKEEP requires 32 words of local(AUTO) storage.

    No errors detected in file ZIM$ENQM.:ZIC0TSI    .

PL6.E3A0      #005=ZIM$EKEEP File=ZIM$ENQM.:ZIC0TSI                              FRI 09/05/97 12:53 Page:136  

 Object Unit name= ZIM$EKEEP                                  File name= ZIM$ENQM.:ZIC0TOU
 UTS= SEP 05 '97 12:53:23.48 FRI                              Compiler= PL-6/E31         Sev=      00
 SharedLib= :SHARED_SYSTEM                                    Alt SharedLib=


    ****  Control sections  ****

 Sect   Type Bound  Init  Size OctSiz  Section name(segment info)
    0   DCB   even  none     0      0  M$UC
    1  RoData even  UTS      2      2  ZIM$EKEEP
    2   Proc  even  none   435    663  ZIM$EKEEP
    3  RoData even  none     7      7  ZIM$EKEEP

    ****  Entry defs  ****

                              Check   Calling
                             calling  sequence
  Sect OctLoc Primary Altret sequence   type   Parms  Name
     2      0   yes    yes     yes      XStd       0  ZIM$EKEEP
     2     70          yes     yes      XStd       0  ZIM$EREDUCEQ
     2     75          yes     yes      XStd       0  ZIM$REDUCEQ

  ****  Entry refs  ****

         Check        Calling
        calling       sequence
Altret sequence SRef   type   Args  Name
 yes     yes           XStd      0 ZIM$DEQ_ONE
 yes     yes           XStd      0 ZIM$INDXMAP_FIND
 yes     yes           XStd      0 ZIM$ENQ_FIND
                       nStd      0 X66_AUTO_0
                       nStd      0 X66_ARET
PL6.E3A0      #005=ZIM$EKEEP File=ZIM$ENQM.:ZIC0TSI                              FRI 09/05/97 12:53 Page:137  

  ****  Data refs  ****

  Flags:  r = read only, s = secondary
Flgs Name                             Flgs Name                             Flgs Name
     M$UC                             r    GLOBAL$                               PS0$

  ****  Segment refs  ****

  Flags:  r = read only, s = secondary
Flgs Name                             Flgs Name                             Flgs Name
     NULLSID                               ROSID
PL6.E3A0      #005=ZIM$EKEEP File=ZIM$ENQM.:ZIC0TSI                              FRI 09/05/97 12:53 Page:138  


      608        1        /*M*    ZIM$EKEEP - Keep the page containing current of run enqed */
      609        2        /*T***********************************************************/
      610        3        /*T*                                                         */
      611        4        /*T* Copyright (c) Bull HN Information Systems Inc., 1997    */
      612        5        /*T*                                                         */
      613        6        /*T***********************************************************/
      614        7        ZIM$EKEEP: PROC ALTRET AVOID($PR5,$PR6,$PR7);

      7  2 000000   000000 700200 xent  ZIM$EKEEP    TSX0  ! X66_AUTO_0
         2 000001   000040 000000                    ZERO    32,0

      615        8        %INCLUDE CP_6;
      616       89         %F$DCB;
      617      146        %INCLUDE CP_6_SUBS;
      618      686        %SUB_EXC;
      619      733        %INCLUDE ZI$GLOBAL;
      620     1219         %GLOBALS;
      621     1527         %ENQLIST;
      622     1545         %INDXMAP;
      623     1561        %INCLUDE ZI$DBCB;
      624     2203         %DBCB;
      625     2681         %AWS;
      626     2721         %RWS;
      627     2741         %SETWS;
      628     2760        %INCLUDE ZI$SSS;
      629     3309         %OA1;
      630     3317         %OA;
      631     3382         %AC;
      632     3477         %RA;
      633     3497         %RC;
      634     3529         %SC;
      635     3556        %INCLUDE ZI_ERRORS_C;
      636     3882
      637     3883    1   DCL PS0$ PTR SYMREF;
      638     3884    1   DCL DBSTATUS CHAR(7) BASED(PS0$) CALIGNED;
      639     3885    1   DCL ZIM$ENQM ENTRY(2) ALTRET;
PL6.E3A0      #005=ZIM$EKEEP File=ZIM$ENQM.:ZIC0TSI                              FRI 09/05/97 12:53 Page:139  
      640     3886    1   DCL ZIM$MAPQUE ENTRY(3) ALTRET;
      641     3887    1   DCL ZIM$DEQ_ONE ENTRY ALTRET;
      642     3888
      643     3889    1   DCL ERROR SBIN ALIGNED;
      644     3890    1   DCL DBKEY SBIN ALIGNED;
      645     3891    1   DCL DBNO SBIN ALIGNED;
      646     3892    1   DCL INDX SBIN ALIGNED;
      647     3893    1   DCL ALL BIT(1) ALIGNED;
      648     3894    1   DCL I UBIN;
      649     3895    1   DCL SIZE UBIN;
      650     3896    1   DCL CHARS CHAR(SIZE) BASED CALIGNED;
      651     3897    1       DBCB$=GLOBAL.ACTIVE.DBCB$;

   3897  2 000002   000000 470400 xsym               LDP0    GLOBAL$
         2 000003   000001 236100                    LDQ     1,,PR0
         2 000004   200005 756100                    STQ     DBCB$,,AUTO

      652     3898    1       IF DBCB$=ADDR(NIL) THEN

   3898  2 000005   000000 116000 3                  CMPQ    0
         2 000006   000060 600000 2                  TZE     CRUN_NULL

      653     3899    1           GOTO CRUN_NULL;
      654     3900    1       IF DBCB.CRUN.DBK=0 THEN

   3900  2 000007   200005 471500                    LDP1    DBCB$,,AUTO
         2 000010   101223 235100                    LDA     659,,PR1
         2 000011   000060 600000 2                  TZE     CRUN_NULL

      655     3901    1           GOTO CRUN_NULL;
      656     3902
      657     3903        /*      Set up ENQLIST and INDXMAP pointers. */
      658     3904    1       ENQLIST$=GLOBAL.ENQ.LIST.BASE$;

   3904  2 000012   001411 236100                    LDQ     777,,PR0
         2 000013   200003 756100                    STQ     ENQLIST$,,AUTO

PL6.E3A0      #005=ZIM$EKEEP File=ZIM$ENQM.:ZIC0TSI                              FRI 09/05/97 12:53 Page:140  
      659     3905    1       INDXMAP$=GLOBAL.ENQ.INDXMAP.BASE$;

   3905  2 000014   001415 236100                    LDQ     781,,PR0
         2 000015   200004 756100                    STQ     INDXMAP$,,AUTO

      660     3906        /*      Find ENQLIST entry for current of run. */
      661     3907    1       DBKEY=DBCB.CRUN.DBK;

   3907  2 000016   200021 755100                    STA     DBKEY,,AUTO

      662     3908    1       SSS$=GLOBAL.ACTIVE.SSS$;

   3908  2 000017   000000 236100                    LDQ     0,,PR0
         2 000020   200011 756100                    STQ     SSS$,,AUTO

      663     3909    1       RC$=PINCRW(SSS$,DBCB.CRUN.RC);

   3909  2 000021   101224 220100                    LDX0    660,,PR1
         2 000022   000000 636010                    EAQ     0,X0
         2 000023   200011 036100                    ADLQ    SSS$,,AUTO
         2 000024   200016 756100                    STQ     RC$,,AUTO

      664     3910    1       CALL FINDQ_RC;

   3910  2 000025   000507 701000 2                  TSX1    FINDQ_RC
         2 000026   000000 011000                    NOP     0

      665     3911    2       IF AWS.ATRIB.CAC THEN DO;

   3911  2 000027   200006 470500                    LDP0    AWS$,,AUTO
         2 000030   000000 236100                    LDQ     0,,PR0
         2 000031   000001 316003                    CANQ    1,DU
         2 000032   000053 600000 2                  TZE     s:3917

      666     3912    2           ENQLIST.STATUS.KEEP(GLOBAL.ENQ.LIST.INDX)=%YES#;

   3912  2 000033   000000 471400 xsym               LDP1    GLOBAL$
PL6.E3A0      #005=ZIM$EKEEP File=ZIM$ENQM.:ZIC0TSI                              FRI 09/05/97 12:53 Page:141  
         2 000034   101412 220100                    LDX0    778,,PR1
         2 000035   101412 020100                    ADLX0   778,,PR1
         2 000036   200003 473500                    LDP3    ENQLIST$,,AUTO
         2 000037   400000 236003                    LDQ     -131072,DU
         2 000040   300000 256110                    ORSQ    0,X0,PR3

      667     3913    2           IF AWS.ATRIB.INDEXED THEN

   3913  2 000041   000000 236100                    LDQ     0,,PR0
         2 000042   000010 316003                    CANQ    8,DU
         2 000043   000053 600000 2                  TZE     s:3917

      668     3914    2               INDXMAP.STATUS.KEEP(GLOBAL.ENQ.INDXMAP.INDX)=%YES#;

   3914  2 000044   101413 236100                    LDQ     779,,PR1
         2 000045   000001 736000                    QLS     1
         2 000046   000001 376000 3                  ANQ     1
         2 000047   200004 474500                    LDP4    INDXMAP$,,AUTO
         2 000050   000000 620006                    EAX0    0,QL
         2 000051   400000 236003                    LDQ     -131072,DU
         2 000052   400000 256110                    ORSQ    0,X0,PR4

      669     3915    2           END;

      670     3916
      671     3917    1       DBSTATUS='0000000';

   3917  2 000053   000000 471400 xsym               LDP1    PS0$
         2 000054   040100 100400                    MLR     fill='040'O
         2 000055   000000 000007 1                  ADSC9   0                        cn=0,n=7
         2 000056   100000 000007                    ADSC9   0,,PR1                   cn=0,n=7

      672     3918    1       GOTO RET;

   3918  2 000057   000267 710000 2                  TRA     RET

      673     3919
PL6.E3A0      #005=ZIM$EKEEP File=ZIM$ENQM.:ZIC0TSI                              FRI 09/05/97 12:53 Page:142  
      674     3920    1   CRUN_NULL:
      675     3921    1       CALL BINCHAR(DBSTATUS,1900000+EXC#CRNUL);

   3921  2 000060   000002 235000 3     CRUN_NULL    LDA     2
         2 000061   000044 773000                    LRL     36
         2 000062   200034 757100                    STAQ    SIZE+6,,AUTO
         2 000063   000000 471400 xsym               LDP1    PS0$
         2 000064   000100 301500                    BTD
         2 000065   200034 000010                    NDSC9   SIZE+6,,AUTO             cn=0,s=lsgnf,sf=0,n=8
         2 000066   100000 030007                    NDSC9   0,,PR1                   cn=0,s=nosgn,sf=0,n=7

      676     3922    1       GOTO RET;

   3922  2 000067   000267 710000 2                  TRA     RET

      677     3923        %EJECT;
PL6.E3A0      #005=ZIM$EKEEP File=ZIM$ENQM.:ZIC0TSI                              FRI 09/05/97 12:53 Page:143  
      678     3924        /*P*
      679     3925        NAME:   ZIM$EREDUCEQ
      680     3926        PURPOSE:Drop ENQs not representing currencies.
      681     3927        */
      682     3928        /*D*
      683     3929        NAME:   ZIM$EREDUCEQ
      684     3930        ENTRY:  CALL ZIM$EREDUCEQ ALTRET;
      685     3931        DESCRIPTION:
      686     3932            Both ENQLIST and INDXMAP are searched for entries that do
      687     3933            not corrospond to any currencies.  If any are found they
      688     3934            are released.
      689     3935
      690     3936            If ZIM$EREDUCEQ is called, all areas are processed.  If
      691     3937            ZIM$RECUCEQ is called, only those areas that are marked
      692     3938            as currency only are processed.
      693     3939        */
      694     3940    1   ZIM$EREDUCEQ: ENTRY ALTRET;

   3940  2 000070   000000 700200 xent  ZIM$EREDUCEQ TSX0  ! X66_AUTO_0
         2 000071   000040 000000                    ZERO    32,0

      695     3941    1       ALL='1'B;

   3941  2 000072   400000 236003                    LDQ     -131072,DU
         2 000073   200024 756100                    STQ     ALL,,AUTO

      696     3942    1       GOTO REDUCE;

   3942  2 000074   000100 710000 2                  TRA     REDUCE

      697     3943
      698     3944    1   ZIM$REDUCEQ: ENTRY ALTRET;

   3944  2 000075   000000 700200 xent  ZIM$REDUCEQ  TSX0  ! X66_AUTO_0
         2 000076   000040 000000                    ZERO    32,0

      699     3945    1       ALL='0'B;
PL6.E3A0      #005=ZIM$EKEEP File=ZIM$ENQM.:ZIC0TSI                              FRI 09/05/97 12:53 Page:144  

   3945  2 000077   200024 450100                    STZ     ALL,,AUTO

   3945  2 000100                       REDUCE       null
      700     3946
      701     3947    1   REDUCE: ;
      702     3948    1       ENQLIST$=GLOBAL.ENQ.LIST.BASE$;

   3948  2 000100   000000 470400 xsym               LDP0    GLOBAL$
         2 000101   001411 236100                    LDQ     777,,PR0
         2 000102   200003 756100                    STQ     ENQLIST$,,AUTO

      703     3949    1       INDXMAP$=GLOBAL.ENQ.INDXMAP.BASE$;

   3949  2 000103   001415 236100                    LDQ     781,,PR0
         2 000104   200004 756100                    STQ     INDXMAP$,,AUTO

      704     3950
      705     3951    1       CALL MARK_CURRENCY;

   3951  2 000105   000270 701000 2                  TSX1    MARK_CURRENCY
         2 000106   000000 011000                    NOP     0

      706     3952
      707     3953        /*      Get rid of unneccessary entries from INDXMAP. */
      708     3954    2       DO I=1 TO GLOBAL.ENQ.INDXMAP.COUNT;

   3954  2 000107   000001 235007                    LDA     1,DL
         2 000110   200025 755100                    STA     I,,AUTO
         2 000111   000173 710000 2                  TRA     s:3968+3

      709     3955    2           IF NOT INDXMAP.STATUS.KEEP(I) AND

   3955  2 000112   200025 235100                    LDA     I,,AUTO
         2 000113   000001 735000                    ALS     1
         2 000114   200004 470500                    LDP0    INDXMAP$,,AUTO
         2 000115   000000 234105                    SZN     0,AL,PR0
PL6.E3A0      #005=ZIM$EKEEP File=ZIM$ENQM.:ZIC0TSI                              FRI 09/05/97 12:53 Page:145  
         2 000116   000170 604000 2                  TMI     s:3968
         2 000117   000000 236105                    LDQ     0,AL,PR0
         2 000120   200000 316003                    CANQ    65536,DU
         2 000121   000170 601000 2                  TNZ     s:3968
         2 000122   100000 316003                    CANQ    32768,DU
         2 000123   000170 601000 2                  TNZ     s:3968
         2 000124   200024 234100                    SZN     ALL,,AUTO
         2 000125   000141 604000 2                  TMI     s:3961
         2 000126   000000 236105                    LDQ     0,AL,PR0
         2 000127   000001 736000                    QLS     1
         2 000130   000003 376000 3                  ANQ     3
         2 000131   000004 471400 3                  LDP1    4
         2 000132   100000 473500                    LDP3    0,,PR1
         2 000133   200003 474500                    LDP4    ENQLIST$,,AUTO
         2 000134   400000 720106                    LXL0    0,QL,PR4
         2 000135   300000 470510                    LDP0    0,X0,PR3
         2 000136   000031 236100                    LDQ     25,,PR0
         2 000137   000200 316003                    CANQ    128,DU
         2 000140   000170 600000 2                  TZE     s:3968

      710     3956    2              NOT INDXMAP.STATUS.CURRENT(I) AND
      711     3957    2              NOT INDXMAP.STATUS.MODIFY(I) AND
      712     3958    2              (ALL OR DCBADDR(ENQLIST.VALUE.DCB#(INDXMAP.ENQINDX(I)))->
      713     3959    3              F$DCB.UOPT#(1)) THEN DO;

      714     3960        /*              Remove entry from INDXMAP. */
      715     3961    4               IF I<GLOBAL.ENQ.INDXMAP.COUNT THEN DO;

   3961  2 000141   000000 470400 xsym               LDP0    GLOBAL$
         2 000142   001414 236100                    LDQ     780,,PR0
         2 000143   000022 772000                    QRL     18
         2 000144   200025 116100                    CMPQ    I,,AUTO
         2 000145   000162 602000 2                  TNC     s:3965
         2 000146   000162 600000 2                  TZE     s:3965

      716     3962    4                   SIZE=(GLOBAL.ENQ.INDXMAP.COUNT-I)*SIZEC(INDXMAP(0));

PL6.E3A0      #005=ZIM$EKEEP File=ZIM$ENQM.:ZIC0TSI                              FRI 09/05/97 12:53 Page:146  
   3962  2 000147   200025 136100                    SBLQ    I,,AUTO
         2 000150   000003 736000                    QLS     3
         2 000151   200026 756100                    STQ     SIZE,,AUTO

      717     3963    4                   ADDR(INDXMAP(I))->CHARS=ADDR(INDXMAP(I+1))->CHARS;

   3963  2 000152   200025 235100                    LDA     I,,AUTO
         2 000153   000003 735000                    ALS     3
         2 000154   200004 471500                    LDP1    INDXMAP$,,AUTO
         2 000155   000000 620006                    EAX0    0,QL
         2 000156   200026 721100                    LXL1    SIZE,,AUTO
         2 000157   040145 100545                    MLR     fill='040'O
         2 000160   100002 000010                    ADSC9   2,A,PR1                  cn=0,n=*X0
         2 000161   100000 000011                    ADSC9   0,A,PR1                  cn=0,n=*X1

      718     3964    4                   END;

      719     3965    3               GLOBAL.ENQ.INDXMAP.COUNT=GLOBAL.ENQ.INDXMAP.COUNT-1;

   3965  2 000162   001414 220100                    LDX0    780,,PR0
         2 000163   777777 621010                    EAX1    -1,X0
         2 000164   001414 741100                    STX1    780,,PR0

      720     3966    3               I=I-1;

   3966  2 000165   200025 235100                    LDA     I,,AUTO
         2 000166   000001 135007                    SBLA    1,DL
         2 000167   200025 755100                    STA     I,,AUTO

      721     3967    3               END;

      722     3968    2           END;

   3968  2 000170   200025 235100                    LDA     I,,AUTO
         2 000171   000001 035007                    ADLA    1,DL
         2 000172   200025 755100                    STA     I,,AUTO
         2 000173   000000 470400 xsym               LDP0    GLOBAL$
PL6.E3A0      #005=ZIM$EKEEP File=ZIM$ENQM.:ZIC0TSI                              FRI 09/05/97 12:53 Page:147  
         2 000174   001414 236100                    LDQ     780,,PR0
         2 000175   000022 772000                    QRL     18
         2 000176   200025 116100                    CMPQ    I,,AUTO
         2 000177   000112 603000 2                  TRC     s:3955

      723     3969
      724     3970        /*      Get rid of unneccessary entries form ENQLIST. */
      725     3971    2       DO I=1 TO GLOBAL.ENQ.LIST.COUNT;

   3971  2 000200   000001 235007                    LDA     1,DL
         2 000201   200025 755100                    STA     I,,AUTO
         2 000202   000262 710000 2                  TRA     NEXTI+3

      726     3972    2           IF NOT ENQLIST.STATUS.KEEP(I) AND

   3972  2 000203   200025 235100                    LDA     I,,AUTO
         2 000204   000001 735000                    ALS     1
         2 000205   200003 470500                    LDP0    ENQLIST$,,AUTO
         2 000206   000000 234105                    SZN     0,AL,PR0
         2 000207   000257 604000 2                  TMI     NEXTI
         2 000210   000000 236105                    LDQ     0,AL,PR0
         2 000211   100000 316003                    CANQ    32768,DU
         2 000212   000257 601000 2                  TNZ     NEXTI
         2 000213   200000 316003                    CANQ    65536,DU
         2 000214   000257 601000 2                  TNZ     NEXTI
         2 000215   000777 316003                    CANQ    511,DU
         2 000216   000226 600000 2                  TZE     s:3972+19
         2 000217   000000 236105                    LDQ     0,AL,PR0
         2 000220   000022 772000                    QRL     18
         2 000221   000777 376007                    ANQ     511,DL
         2 000222   000005 402007                    MPY     5,DL
         2 000223   000000 471400 xsym               LDP1    GLOBAL$
         2 000224   100206 220106                    LDX0    134,QL,PR1
         2 000225   000257 601000 2                  TNZ     NEXTI
         2 000226   200024 234100                    SZN     ALL,,AUTO
         2 000227   000241 604000 2                  TMI     s:3985
         2 000230   000004 471400 3                  LDP1    4
PL6.E3A0      #005=ZIM$EKEEP File=ZIM$ENQM.:ZIC0TSI                              FRI 09/05/97 12:53 Page:148  
         2 000231   100000 473500                    LDP3    0,,PR1
         2 000232   200025 235100                    LDA     I,,AUTO
         2 000233   000001 735000                    ALS     1
         2 000234   000000 720105                    LXL0    0,AL,PR0
         2 000235   300000 474510                    LDP4    0,X0,PR3
         2 000236   400031 236100                    LDQ     25,,PR4
         2 000237   000200 316003                    CANQ    128,DU
         2 000240   000257 600000 2                  TZE     NEXTI

      727     3973    2              NOT ENQLIST.STATUS.MODIFY(I) AND
      728     3974    2              NOT ENQLIST.STATUS.CURRENT(I) AND
      729     3975    2              (ENQLIST.BUFSLOT(I)=0 OR
      730     3976    2              GLOBAL.BCB.BUF.LOCK(ENQLIST.BUFSLOT(I))=0) AND
      731     3977    3              (ALL OR DCBADDR(ENQLIST.VALUE.DCB#(I))->F$DCB.UOPT#(1)) THEN DO;

      732     3978        /*
      733     3979                        If not specifically kept, and not modified and
      734     3980                        not a currency, and (either the page is not in
      735     3981                        memory or is not locked), and (either all areas
      736     3982                        are to be processed or this one specifically is
      737     3983                        to be processed), its ok to drop the ENQ.
      738     3984        */
      739     3985    3               GLOBAL.ENQ.LIST.INDX = I;

   3985  2 000241   200025 720100                    LXL0    I,,AUTO
         2 000242   000000 471400 xsym               LDP1    GLOBAL$
         2 000243   101412 740100                    STX0    778,,PR1

      740     3986                    %DBCAL(NAME=ZIM$DEQ_ONE,EXC=NEXTI,ALT=RET);

   3990  2 000244   000005 631400 3                  EPPR1   5
         2 000245   000000 701000 xent               TSX1    ZIM$DEQ_ONE
         2 000246   000267 702000 2                  TSX2    RET

   3991  2 000247   000000 470400 xsym               LDP0    GLOBAL$
         2 000250   000006 235100                    LDA     6,,PR0
         2 000251   000254 600000 2                  TZE     s:4002
PL6.E3A0      #005=ZIM$EKEEP File=ZIM$ENQM.:ZIC0TSI                              FRI 09/05/97 12:53 Page:149  

   3996  2 000252   000006 450100                    STZ     6,,PR0

   3997  2 000253   000257 710000 2                  TRA     NEXTI

      741     4002    3               I=I-1;

   4002  2 000254   200025 236100                    LDQ     I,,AUTO
         2 000255   000001 136007                    SBLQ    1,DL
         2 000256   200025 756100                    STQ     I,,AUTO

      742     4003    3               END;

      743     4004    2   NEXTI:  END;

   4004  2 000257   200025 235100       NEXTI        LDA     I,,AUTO
         2 000260   000001 035007                    ADLA    1,DL
         2 000261   200025 755100                    STA     I,,AUTO
         2 000262   000000 470400 xsym               LDP0    GLOBAL$
         2 000263   001412 236100                    LDQ     778,,PR0
         2 000264   777777 376007                    ANQ     -1,DL
         2 000265   200025 116100                    CMPQ    I,,AUTO
         2 000266   000203 603000 2                  TRC     s:3972

      744     4005    1   RET:RETURN;

   4005  2 000267   000000 702200 xent  RET          TSX2  ! X66_ARET

      745     4006        %EJECT;
PL6.E3A0      #005=ZIM$EKEEP File=ZIM$ENQM.:ZIC0TSI                              FRI 09/05/97 12:53 Page:150  
      746     4007        /*I*
      747     4008        NAME:   MARK_CURRENCY
      748     4009        PURPOSE:To mark the entries that corrospond to currencies.
      749     4010        */
      750     4011        /*D*
      751     4012        NAME:   MARK_CURRENCY
      752     4013        CALL:   CALL MARK_CURRENCY
      753     4014        DESCRIPTION:
      754     4015            This routine looks through every currency in the DBCB and
      755     4016            marks the entries in both ENQLIST and INDXMAP to indicate
      756     4017            which ones correspond to some currency.  That way we know
      757     4018            which entries we can get rid of later.
      758     4019        */
      759     4020    1   MARK_CURRENCY: PROC ALTRET;

   4020  2 000270   200030 741300       MARK_CURREN* STX1  ! SIZE+2,,AUTO

      760     4021
      761     4022        /*      First clear flag in ENQLIST and INDXMAP. */
      762     4023    3       DO I=1 TO GLOBAL.ENQ.LIST.COUNT;

   4023  2 000271   000001 235007                    LDA     1,DL
         2 000272   200025 755100                    STA     I,,AUTO
         2 000273   000304 710000 2                  TRA     s:4025+3

      763     4024    3           ENQLIST.STATUS.CURRENT(I)='0'B;

   4024  2 000274   200025 235100                    LDA     I,,AUTO
         2 000275   000001 735000                    ALS     1
         2 000276   200003 470500                    LDP0    ENQLIST$,,AUTO
         2 000277   000006 236000 3                  LDQ     6
         2 000300   000000 356105                    ANSQ    0,AL,PR0

      764     4025    3           END;

   4025  2 000301   200025 235100                    LDA     I,,AUTO
         2 000302   000001 035007                    ADLA    1,DL
PL6.E3A0      #005=ZIM$EKEEP File=ZIM$ENQM.:ZIC0TSI                              FRI 09/05/97 12:53 Page:151  
         2 000303   200025 755100                    STA     I,,AUTO
         2 000304   000000 470400 xsym               LDP0    GLOBAL$
         2 000305   001412 236100                    LDQ     778,,PR0
         2 000306   777777 376007                    ANQ     -1,DL
         2 000307   200025 116100                    CMPQ    I,,AUTO
         2 000310   000274 603000 2                  TRC     s:4024

      765     4026    3       DO I=1 TO GLOBAL.ENQ.INDXMAP.COUNT;

   4026  2 000311   000001 235007                    LDA     1,DL
         2 000312   200025 755100                    STA     I,,AUTO
         2 000313   000324 710000 2                  TRA     s:4028+3

      766     4027    3           INDXMAP.STATUS.CURRENT(I)='0'B;

   4027  2 000314   200025 235100                    LDA     I,,AUTO
         2 000315   000001 735000                    ALS     1
         2 000316   200004 470500                    LDP0    INDXMAP$,,AUTO
         2 000317   000006 236000 3                  LDQ     6
         2 000320   000000 356105                    ANSQ    0,AL,PR0

      767     4028    3           END;

   4028  2 000321   200025 235100                    LDA     I,,AUTO
         2 000322   000001 035007                    ADLA    1,DL
         2 000323   200025 755100                    STA     I,,AUTO
         2 000324   000000 470400 xsym               LDP0    GLOBAL$
         2 000325   001414 236100                    LDQ     780,,PR0
         2 000326   000022 772000                    QRL     18
         2 000327   200025 116100                    CMPQ    I,,AUTO
         2 000330   000314 603000 2                  TRC     s:4027

      768     4029
      769     4030    3       DO DBNO=1 TO DB#MAX;

   4030  2 000331   000001 235007                    LDA     1,DL
         2 000332   200022 755100                    STA     DBNO,,AUTO
PL6.E3A0      #005=ZIM$EKEEP File=ZIM$ENQM.:ZIC0TSI                              FRI 09/05/97 12:53 Page:152  
         2 000333   000502 710000 2                  TRA     s:4075+1

      770     4031        /*          For each possible database. */
      771     4032    4           IF GLOBAL.DB.SSS$(DBNO)~=ADDR(NIL) THEN DO;

   4032  2 000334   000000 470400 xsym               LDP0    GLOBAL$
         2 000335   200022 720100                    LXL0    DBNO,,AUTO
         2 000336   000153 236110                    LDQ     107,X0,PR0
         2 000337   000000 116000 3                  CMPQ    0
         2 000340   000501 600000 2                  TZE     s:4075

      772     4033    4               SSS$=GLOBAL.DB.SSS$(DBNO);

   4033  2 000341   200011 756100                    STQ     SSS$,,AUTO

      773     4034    4               DBCB$=GLOBAL.DB.DBCB$(DBNO);

   4034  2 000342   000161 236110                    LDQ     113,X0,PR0
         2 000343   200005 756100                    STQ     DBCB$,,AUTO

      774     4035        /*              Check current of run. */
      775     4036    4               RC$=PINCRW(SSS$,DBCB.CRUN.RC);

   4036  2 000344   200005 471500                    LDP1    DBCB$,,AUTO
         2 000345   101224 221100                    LDX1    660,,PR1
         2 000346   000000 636011                    EAQ     0,X1
         2 000347   200011 036100                    ADLQ    SSS$,,AUTO
         2 000350   200016 756100                    STQ     RC$,,AUTO

      776     4037    4               DBKEY=DBCB.CRUN.DBK;

   4037  2 000351   101223 235100                    LDA     659,,PR1
         2 000352   200021 755100                    STA     DBKEY,,AUTO

      777     4038    4               IF DBKEY~=0 THEN

   4038  2 000353   000356 600000 2                  TZE     s:4042
PL6.E3A0      #005=ZIM$EKEEP File=ZIM$ENQM.:ZIC0TSI                              FRI 09/05/97 12:53 Page:153  

      778     4039    4                   CALL FINDQ_RC;

   4039  2 000354   000507 701000 2                  TSX1    FINDQ_RC
         2 000355   000000 011000                    NOP     0

      779     4040
      780     4041        /*              Check all area currencies. */
      781     4042    4               OA$=PINCRW(SSS$,SIZEW(OA1));

   4042  2 000356   200011 236100                    LDQ     SSS$,,AUTO
         2 000357   000001 036003                    ADLQ    1,DU
         2 000360   200013 756100                    STQ     OA$,,AUTO

      782     4043    4               AC$=OA$;

   4043  2 000361   200014 756100                    STQ     AC$,,AUTO

      783     4044    5               DO WHILE(AC.OAACN~=0);

   4044  2 000362   200014 470500                    LDP0    AC$,,AUTO
         2 000363   000001 220100                    LDX0    1,,PR0
         2 000364   000410 600000 2                  TZE     s:4053

      784     4045    5                   AC$=PINCRW(SSS$,AC.OAACN);

   4045  2 000365   200014 470500                    LDP0    AC$,,AUTO
         2 000366   000001 220100                    LDX0    1,,PR0
         2 000367   000000 636010                    EAQ     0,X0
         2 000370   200011 036100                    ADLQ    SSS$,,AUTO
         2 000371   200014 756100                    STQ     AC$,,AUTO

      785     4046    5                   AWS$=PINCRW(DBCB$,AC.WSOF);

   4046  2 000372   200014 470500                    LDP0    AC$,,AUTO
         2 000373   000003 220100                    LDX0    3,,PR0
         2 000374   000000 636010                    EAQ     0,X0
PL6.E3A0      #005=ZIM$EKEEP File=ZIM$ENQM.:ZIC0TSI                              FRI 09/05/97 12:53 Page:154  
         2 000375   200005 036100                    ADLQ    DBCB$,,AUTO
         2 000376   200006 756100                    STQ     AWS$,,AUTO

      786     4047    5                   DBKEY=AWS.CURR;

   4047  2 000377   200006 471500                    LDP1    AWS$,,AUTO
         2 000400   100001 235100                    LDA     1,,PR1
         2 000401   200021 755100                    STA     DBKEY,,AUTO

      787     4048    5                   IF DBKEY ~= 0 THEN

   4048  2 000402   000405 600000 2                  TZE     s:4050

      788     4049    5                       CALL FINDQ_AC;

   4049  2 000403   000570 701000 2                  TSX1    FINDQ_AC
         2 000404   000000 011000                    NOP     0

      789     4050    5                   END;

   4050  2 000405   200014 470500                    LDP0    AC$,,AUTO
         2 000406   000001 220100                    LDX0    1,,PR0
         2 000407   000365 601000 2                  TNZ     s:4045

      790     4051
      791     4052        /*              Check all record currencies. */
      792     4053    4               RC$=OA$;

   4053  2 000410   200013 236100                    LDQ     OA$,,AUTO
         2 000411   200016 756100                    STQ     RC$,,AUTO

      793     4054    5               DO WHILE(RC.OARCN~=0);

   4054  2 000412   200016 471500                    LDP1    RC$,,AUTO
         2 000413   100002 221100                    LDX1    2,,PR1
         2 000414   000440 600000 2                  TZE     s:4063

PL6.E3A0      #005=ZIM$EKEEP File=ZIM$ENQM.:ZIC0TSI                              FRI 09/05/97 12:53 Page:155  
      794     4055    5                   RC$=PINCRW(SSS$,RC.OARCN);

   4055  2 000415   200016 470500                    LDP0    RC$,,AUTO
         2 000416   000002 220100                    LDX0    2,,PR0
         2 000417   000000 636010                    EAQ     0,X0
         2 000420   200011 036100                    ADLQ    SSS$,,AUTO
         2 000421   200016 756100                    STQ     RC$,,AUTO

      795     4056    5                   RWS$=PINCRW(DBCB$,RC.RCWSO);

   4056  2 000422   200016 470500                    LDP0    RC$,,AUTO
         2 000423   000004 220100                    LDX0    4,,PR0
         2 000424   000000 636010                    EAQ     0,X0
         2 000425   200005 036100                    ADLQ    DBCB$,,AUTO
         2 000426   200007 756100                    STQ     RWS$,,AUTO

      796     4057    5                   DBKEY=RWS.CURR;

   4057  2 000427   200007 471500                    LDP1    RWS$,,AUTO
         2 000430   100001 235100                    LDA     1,,PR1
         2 000431   200021 755100                    STA     DBKEY,,AUTO

      797     4058    5                   IF DBKEY~=0 THEN

   4058  2 000432   000435 600000 2                  TZE     s:4060

      798     4059    5                       CALL FINDQ_RC;

   4059  2 000433   000507 701000 2                  TSX1    FINDQ_RC
         2 000434   000000 011000                    NOP     0

      799     4060    5                   END;

   4060  2 000435   200016 470500                    LDP0    RC$,,AUTO
         2 000436   000002 220100                    LDX0    2,,PR0
         2 000437   000415 601000 2                  TNZ     s:4055

PL6.E3A0      #005=ZIM$EKEEP File=ZIM$ENQM.:ZIC0TSI                              FRI 09/05/97 12:53 Page:156  
      800     4061
      801     4062        /*              Check all sets currencies. */
      802     4063    4               SC$=OA$;

   4063  2 000440   200013 236100                    LDQ     OA$,,AUTO
         2 000441   200017 756100                    STQ     SC$,,AUTO

      803     4064    5               DO WHILE(SC.OASCN~=0);

   4064  2 000442   200017 470500                    LDP0    SC$,,AUTO
         2 000443   000001 720100                    LXL0    1,,PR0
         2 000444   000501 600000 2                  TZE     s:4075

      804     4065    5                   SC$=PINCRW(SSS$,SC.OASCN);

   4065  2 000445   200017 470500                    LDP0    SC$,,AUTO
         2 000446   000001 720100                    LXL0    1,,PR0
         2 000447   000000 636010                    EAQ     0,X0
         2 000450   200011 036100                    ADLQ    SSS$,,AUTO
         2 000451   200017 756100                    STQ     SC$,,AUTO

      805     4066    5                   SETWS$=PINCRW(DBCB$,SC.SCWSO);

   4066  2 000452   200017 470500                    LDP0    SC$,,AUTO
         2 000453   000001 220100                    LDX0    1,,PR0
         2 000454   000000 636010                    EAQ     0,X0
         2 000455   200005 036100                    ADLQ    DBCB$,,AUTO
         2 000456   200010 756100                    STQ     SETWS$,,AUTO

      806     4067    5                   DBKEY=SETWS.CURR;

   4067  2 000457   200010 471500                    LDP1    SETWS$,,AUTO
         2 000460   100001 235100                    LDA     1,,PR1
         2 000461   200021 755100                    STA     DBKEY,,AUTO

      807     4068    6                   IF DBKEY~=0 THEN DO;

PL6.E3A0      #005=ZIM$EKEEP File=ZIM$ENQM.:ZIC0TSI                              FRI 09/05/97 12:53 Page:157  
   4068  2 000462   000476 600000 2                  TZE     s:4073

      808     4069    6                       AC$=PINCRW(SSS$,SETWS.AC);

   4069  2 000463   100000 721100                    LXL1    0,,PR1
         2 000464   000000 636011                    EAQ     0,X1
         2 000465   200011 036100                    ADLQ    SSS$,,AUTO
         2 000466   200014 756100                    STQ     AC$,,AUTO

      809     4070    6                       AWS$=PINCRW(DBCB$,AC.WSOF);

   4070  2 000467   200014 473500                    LDP3    AC$,,AUTO
         2 000470   300003 222100                    LDX2    3,,PR3
         2 000471   000000 636012                    EAQ     0,X2
         2 000472   200005 036100                    ADLQ    DBCB$,,AUTO
         2 000473   200006 756100                    STQ     AWS$,,AUTO

      810     4071    6                       CALL FINDQ_AC;

   4071  2 000474   000570 701000 2                  TSX1    FINDQ_AC
         2 000475   000000 011000                    NOP     0

      811     4072    6                       END;

      812     4073    5                   END;

   4073  2 000476   200017 470500                    LDP0    SC$,,AUTO
         2 000477   000001 720100                    LXL0    1,,PR0
         2 000500   000445 601000 2                  TNZ     s:4065

      813     4074    4               END;

      814     4075    3           END;

   4075  2 000501   200022 054100                    AOS     DBNO,,AUTO
         2 000502   200022 235100                    LDA     DBNO,,AUTO
         2 000503   000005 115007                    CMPA    5,DL
PL6.E3A0      #005=ZIM$EKEEP File=ZIM$ENQM.:ZIC0TSI                              FRI 09/05/97 12:53 Page:158  
         2 000504   000334 604400 2                  TMOZ    s:4032

      815     4076
      816     4077    2       RETURN;

   4077  2 000505   200030 221300                    LDX1  ! SIZE+2,,AUTO
         2 000506   000001 702211                    TSX2  ! 1,X1

      817     4078
      818     4079    2   END MARK_CURRENCY;
      819     4080        %EJECT;
PL6.E3A0      #005=ZIM$EKEEP File=ZIM$ENQM.:ZIC0TSI                              FRI 09/05/97 12:53 Page:159  
      820     4081        /*I*
      821     4082        NAME:   FINDQ_RC
      822     4083        PURPOSE:Find the entry representing the RC and mark as currency.
      823     4084        */
      824     4085        /*D*
      825     4086        NAME:   FINDQ_RC
      826     4087        CALL:   CALL FINDQ_RC
      827     4088        INPUT:  RC$ - Identifies the record
      828     4089                DBKEY - The database key of the currency.
      829     4090        OUTPUT: A marked ENQLIST and INDXMAP entry
      830     4091                GLOBAL.ENQ.LIST.INDX - The ENQLIST index.
      831     4092                GLOBAL.ENQ.INDXMAP.INDX - The INDXMAP index.
      832     4093        DESCRIPTION:
      833     4094            The DBKEY is converted to a DCB# and PAGE# which is used to
      834     4095            find the corrosponding entry in the ENQLIST and INDXMAP
      835     4096            tables.  These entries are then marked as being a currency.
      836     4097        */
      837     4098    1   FINDQ_RC: PROC;

   4098  2 000507   200032 741300       FINDQ_RC     STX1  ! SIZE+4,,AUTO

      838     4099    2   DCL ZIM$INDXMAP_FIND ENTRY ALTRET;
      839     4100    2   DCL ZIM$ENQ_FIND ENTRY ALTRET;
      840     4101
      841     4102
      842     4103    3       IF RC.DEF.PSTO=4 THEN DO;

   4103  2 000510   200016 470500                    LDP0    RC$,,AUTO
         2 000511   000000 236100                    LDQ     0,,PR0
         2 000512   000007 376003                    ANQ     7,DU
         2 000513   000004 116003                    CMPQ    4,DU
         2 000514   000534 601000 2                  TNZ     s:4111

      843     4104        /*          The record is indexed.  Only one area. */
      844     4105    3           RA$=PINCRW(SSS$,RC.RCRAN);

   4105  2 000515   000001 220100                    LDX0    1,,PR0
PL6.E3A0      #005=ZIM$EKEEP File=ZIM$ENQM.:ZIC0TSI                              FRI 09/05/97 12:53 Page:160  
         2 000516   000000 636010                    EAQ     0,X0
         2 000517   200011 036100                    ADLQ    SSS$,,AUTO
         2 000520   200015 756100                    STQ     RA$,,AUTO

      845     4106    3           AC$=PINCRW(SSS$,RA.ACRAH);

   4106  2 000521   200015 471500                    LDP1    RA$,,AUTO
         2 000522   100002 722100                    LXL2    2,,PR1
         2 000523   000000 636012                    EAQ     0,X2
         2 000524   200011 036100                    ADLQ    SSS$,,AUTO
         2 000525   200014 756100                    STQ     AC$,,AUTO

      846     4107    3           AWS$=PINCRW(DBCB$,AC.WSOF);

   4107  2 000526   200014 473500                    LDP3    AC$,,AUTO
         2 000527   300003 223100                    LDX3    3,,PR3
         2 000530   000000 636013                    EAQ     0,X3
         2 000531   200005 036100                    ADLQ    DBCB$,,AUTO
         2 000532   200006 756100                    STQ     AWS$,,AUTO

      847     4108    3           END;

   4108  2 000533   000567 710000 2                  TRA     s:4120

      848     4109    3       ELSE DO;

      849     4110        /*          Not indexed.  Must find proper area. */
      850     4111    3           AC$=PINCRW(SSS$,SIZEW(OA1));

   4111  2 000534   200011 236100                    LDQ     SSS$,,AUTO
         2 000535   000001 036003                    ADLQ    1,DU
         2 000536   200014 756100                    STQ     AC$,,AUTO

      851     4112    4           DO WHILE(AC.OAACN~=0);

   4112  2 000537   200014 471500                    LDP1    AC$,,AUTO
         2 000540   100001 220100                    LDX0    1,,PR1
PL6.E3A0      #005=ZIM$EKEEP File=ZIM$ENQM.:ZIC0TSI                              FRI 09/05/97 12:53 Page:161  
         2 000541   000567 600000 2                  TZE     s:4120

      852     4113    4               AC$=PINCRW(SSS$,AC.OAACN);

   4113  2 000542   200014 470500                    LDP0    AC$,,AUTO
         2 000543   000001 220100                    LDX0    1,,PR0
         2 000544   000000 636010                    EAQ     0,X0
         2 000545   200011 036100                    ADLQ    SSS$,,AUTO
         2 000546   200014 756100                    STQ     AC$,,AUTO

      853     4114    4               AWS$=PINCRW(DBCB$,AC.WSOF);

   4114  2 000547   200014 470500                    LDP0    AC$,,AUTO
         2 000550   000003 220100                    LDX0    3,,PR0
         2 000551   000000 636010                    EAQ     0,X0
         2 000552   200005 036100                    ADLQ    DBCB$,,AUTO
         2 000553   200006 756100                    STQ     AWS$,,AUTO

      854     4115    4               IF AC.DBLIM.LOWDBK<=DBKEY AND

   4115  2 000554   000010 236100                    LDQ     8,,PR0
         2 000555   000565 604000 2                  TMI     s:4119
         2 000556   200021 116100                    CMPQ    DBKEY,,AUTO
         2 000557   000565 605400 2                  TPNZ    s:4119
         2 000560   200006 471500                    LDP1    AWS$,,AUTO
         2 000561   100003 236100                    LDQ     3,,PR1
         2 000562   000571 604000 2                  TMI     GOT_AC
         2 000563   200021 116100                    CMPQ    DBKEY,,AUTO
         2 000564   000571 605000 2                  TPL     GOT_AC

      855     4116    4                  DBKEY<=AWS.HIGHDBK THEN
      856     4117        /*                  Found proper AC for this DBKEY. */
      857     4118    4                   GOTO GOT_AC;
      858     4119    4               END;

   4119  2 000565   000001 221100                    LDX1    1,,PR0
         2 000566   000542 601000 2                  TNZ     s:4113
PL6.E3A0      #005=ZIM$EKEEP File=ZIM$ENQM.:ZIC0TSI                              FRI 09/05/97 12:53 Page:162  

      859     4120    3           END;

   4120  2 000567   000571 710000 2                  TRA     GOT_AC

      860     4121
      861     4122    2   FINDQ_AC: ENTRY;

   4122  2 000570   200032 741300       FINDQ_AC     STX1  ! SIZE+4,,AUTO

   4118  2 000571                       GOT_AC       null
      862     4123    2   GOT_AC: ;
      863     4124    2       GLOBAL.ENQ.VALUE.DCB#=AWS.DDCB;

   4124  2 000571   200006 470500                    LDP0    AWS$,,AUTO
         2 000572   000006 220100                    LDX0    6,,PR0
         2 000573   000000 471400 xsym               LDP1    GLOBAL$
         2 000574   101407 440100                    SXL0    775,,PR1

      864     4125    2       IF AWS.ATRIB.CAC THEN

   4125  2 000575   000000 236100                    LDQ     0,,PR0
         2 000576   000001 316003                    CANQ    1,DU
         2 000577   000661 600000 2                  TZE     RET

      865     4126    3           IF AWS.ATRIB.INDEXED THEN DO;

   4126  2 000600   000010 316003                    CANQ    8,DU
         2 000601   000630 600000 2                  TZE     s:4134

      866     4127    3               GLOBAL.ENQ.VALUE.RNAME=DBKEY;

   4127  2 000602   200021 235100                    LDA     DBKEY,,AUTO
         2 000603   101410 755100                    STA     776,,PR1

      867     4128    3               CALL ZIM$INDXMAP_FIND;

PL6.E3A0      #005=ZIM$EKEEP File=ZIM$ENQM.:ZIC0TSI                              FRI 09/05/97 12:53 Page:163  
   4128  2 000604   000005 631400 3                  EPPR1   5
         2 000605   000000 701000 xent               TSX1    ZIM$INDXMAP_FIND
         2 000606   000000 011000                    NOP     0

      868     4129    3               INDX=GLOBAL.ENQ.INDXMAP.INDX;

   4129  2 000607   000000 470400 xsym               LDP0    GLOBAL$
         2 000610   001413 236100                    LDQ     779,,PR0
         2 000611   777777 376007                    ANQ     -1,DL
         2 000612   200023 756100                    STQ     INDX,,AUTO

      869     4130    3               INDXMAP.STATUS.CURRENT(INDX)='1'B;

   4130  2 000613   200023 235100                    LDA     INDX,,AUTO
         2 000614   000001 735000                    ALS     1
         2 000615   200004 471500                    LDP1    INDXMAP$,,AUTO
         2 000616   200000 236003                    LDQ     65536,DU
         2 000617   100000 256105                    ORSQ    0,AL,PR1

      870     4131    3               ENQLIST.STATUS.CURRENT(INDXMAP.ENQINDX(INDX))='1'B;

   4131  2 000620   100000 236105                    LDQ     0,AL,PR1
         2 000621   000001 736000                    QLS     1
         2 000622   000003 376000 3                  ANQ     3
         2 000623   200003 473500                    LDP3    ENQLIST$,,AUTO
         2 000624   000000 620006                    EAX0    0,QL
         2 000625   200000 236003                    LDQ     65536,DU
         2 000626   300000 256110                    ORSQ    0,X0,PR3

      871     4132    3               END;

   4132  2 000627   000661 710000 2                  TRA     RET

      872     4133    3           ELSE DO;

      873     4134    3               GLOBAL.ENQ.VALUE.RNAME=

PL6.E3A0      #005=ZIM$EKEEP File=ZIM$ENQM.:ZIC0TSI                              FRI 09/05/97 12:53 Page:164  
   4134  2 000630   200014 473500                    LDP3    AC$,,AUTO
         2 000631   200021 236100                    LDQ     DBKEY,,AUTO
         2 000632   300010 136100                    SBLQ    8,,PR3
         2 000633   200034 756100                    STQ     SIZE+6,,AUTO
         2 000634   300012 236100                    LDQ     10,,PR3
         2 000635   777777 376007                    ANQ     -1,DL
         2 000636   200035 756100                    STQ     SIZE+7,,AUTO
         2 000637   200034 236100                    LDQ     SIZE+6,,AUTO
         2 000640   200035 036100                    ADLQ    SIZE+7,,AUTO
         2 000641   200036 756100                    STQ     SIZE+8,,AUTO
         2 000642   300012 236100                    LDQ     10,,PR3
         2 000643   777777 376007                    ANQ     -1,DL
         2 000644   200037 756100                    STQ     SIZE+9,,AUTO
         2 000645   200036 236100                    LDQ     SIZE+8,,AUTO
         2 000646   200037 506100                    DIV     SIZE+9,,AUTO
         2 000647   101410 756100                    STQ     776,,PR1

      874     4135    3                  (DBKEY-AC.DBLIM.LOWDBK+AC.LPP)/AC.LPP;
      875     4136    3               CALL ZIM$ENQ_FIND;

   4136  2 000650   000005 631400 3                  EPPR1   5
         2 000651   000000 701000 xent               TSX1    ZIM$ENQ_FIND
         2 000652   000000 011000                    NOP     0

      876     4137    3               ENQLIST.STATUS.CURRENT(GLOBAL.ENQ.LIST.INDX)=%YES#;

   4137  2 000653   000000 470400 xsym               LDP0    GLOBAL$
         2 000654   001412 220100                    LDX0    778,,PR0
         2 000655   001412 020100                    ADLX0   778,,PR0
         2 000656   200003 471500                    LDP1    ENQLIST$,,AUTO
         2 000657   200000 236003                    LDQ     65536,DU
         2 000660   100000 256110                    ORSQ    0,X0,PR1

      877     4138    3               END;

      878     4139    2   RET:RETURN;

PL6.E3A0      #005=ZIM$EKEEP File=ZIM$ENQM.:ZIC0TSI                              FRI 09/05/97 12:53 Page:165  
   4139  2 000661   200032 221300       RET          LDX1  ! SIZE+4,,AUTO
         2 000662   000001 702211                    TSX2  ! 1,X1

(unnamed)
 Sect OctLoc
   1     000   060060 060060   060060 060040                                    0000000

(unnamed)
 Sect OctLoc
   3     000   000000 006014   000001 777776   000007 205140   001777 777776    ...........`....
   3     004   000000 006003   000000 000000   577777 777777                    ............
      879     4140    2   END FINDQ_RC;
      880     4141    1   END ZIM$EKEEP;

PL6.E3A0      #005=ZIM$EKEEP File=ZIM$ENQM.:ZIC0TSI                              FRI 09/05/97 12:53 Page:166  
--  Include file information  --

   ZI_ERRORS_C.:ZIC0TOU  is referenced.
   ZI$SSS.:ZIC0TOU  cannot be made into a system file and is referenced.
   ZI$DBCB.:ZIC0TOU  is referenced.
   ZI$GLOBAL.:ZIC0TOU  is referenced.
   CP_6_SUBS.:LIB_E05  is referenced.
   CP_6.:LIB_E05  cannot be made into a system file and is referenced.
   B$JIT_C.:E05TOU  was found in the system file and is never referenced.
   CP_6_C.:E05TOU  was found in the system file and is referenced.
      No diagnostics issued in procedure ZIM$EKEEP.

   Procedure ZIM$EKEEP requires 435 words for executable code.
   Procedure ZIM$EKEEP requires 32 words of local(AUTO) storage.

    No errors detected in file ZIM$ENQM.:ZIC0TSI    .
PL6.E3A0      #005=ZIM$EKEEP File=ZIM$ENQM.:ZIC0TSI                              FRI 09/05/97 12:53 Page:167  
          *** CROSS REFERENCE LISTING ***
**     DENOTES     IDENTIFIER DEFINITION
<<                 IDENTIFIER'S VALUE SET
>>                 IDENTIFIER'S VALUE USED
<>                 IDENTIFIER SET AND/OR USED
--                 IDENTIFIER REFERENCED
PL6.E3A0      #005=ZIM$EKEEP File=ZIM$ENQM.:ZIC0TSI                              FRI 09/05/97 12:53 Page:168  
          MINI XREF LISTING

AC.DBLIM.LOWDBK
      3423**DCL      4115>>IF       4134>>ASSIGN
AC.DEF.ANL
      3402**DCL      3473--IMP-SIZ
AC.DEF.FORG
      3389**DCL      3393--REDEF
AC.LPP
      3426**DCL      4134>>ASSIGN   4134>>ASSIGN
AC.OAACN
      3403**DCL      4044>>DOWHILE  4045>>ASSIGN   4112>>DOWHILE  4113>>ASSIGN
AC.WSOF
      3406**DCL      4046>>ASSIGN   4070>>ASSIGN   4107>>ASSIGN   4114>>ASSIGN
AC$
      3385**DCL      3386--IMP-PTR  4043<<ASSIGN   4044>>DOWHILE  4045<<ASSIGN   4045>>ASSIGN   4046>>ASSIGN
      4069<<ASSIGN   4070>>ASSIGN   4106<<ASSIGN   4107>>ASSIGN   4111<<ASSIGN   4112>>DOWHILE  4113<<ASSIGN
      4113>>ASSIGN   4114>>ASSIGN   4115>>IF       4134>>ASSIGN   4134>>ASSIGN   4134>>ASSIGN
ALL
      3893**DCL      3941<<ASSIGN   3945<<ASSIGN   3955>>IF       3972>>IF
AWS.ATRIB.CAC
      2700**DCL      3911>>IF       4125>>IF
AWS.ATRIB.INDEXED
      2697**DCL      3913>>IF       4126>>IF
AWS.CURR
      2703**DCL      4047>>ASSIGN
AWS.DDCB
      2708**DCL      4124>>ASSIGN
AWS.HIGHDBK
      2705**DCL      4115>>IF
AWS$
      2682**DCL      2683--IMP-PTR  3911>>IF       3913>>IF       4046<<ASSIGN   4047>>ASSIGN   4070<<ASSIGN
      4107<<ASSIGN   4114<<ASSIGN   4115>>IF       4124>>ASSIGN   4125>>IF       4126>>IF
CHARS
PL6.E3A0      #005=ZIM$EKEEP File=ZIM$ENQM.:ZIC0TSI                              FRI 09/05/97 12:53 Page:169  
      3896**DCL      3963<<ASSIGN   3963>>ASSIGN
CRUN_NULL
      3921**LABEL    3899--GOTO     3901--GOTO
DBCB.CRUN.DBK
      2663**DCL      3900>>IF       3907>>ASSIGN   4037>>ASSIGN
DBCB.CRUN.RC
      2664**DCL      3909>>ASSIGN   4036>>ASSIGN
DBCB.IOWS.CFCT
      2633**DCL      2634--REDEF
DBCB.IOWS.DBKF.RQ
      2576**DCL      2577--REDEF
DBCB.IOWS.DBKR
      2573**DCL      2574--REDEF
DBCB.IOWS.NOBF
      2635**DCL      2636--REDEF
DBCB.IOWS.SPND
      2561**DCL      2562--REDEF
DBCB.SWS.RDYCW
      2299**DCL      2300--REDEF
DBCB.SWS.TEMP.PTR1$
      2333**DCL      2334--REDEF    2335--REDEF
DBCB.SWS.TEMP.PTR2$
      2336**DCL      2337--REDEF
DBCB$
      2204**DCL      2205--IMP-PTR  3897<<ASSIGN   3898>>IF       3900>>IF       3907>>ASSIGN   3909>>ASSIGN
      4034<<ASSIGN   4036>>ASSIGN   4037>>ASSIGN   4046>>ASSIGN   4056>>ASSIGN   4066>>ASSIGN   4070>>ASSIGN
      4107>>ASSIGN   4114>>ASSIGN
DBKEY
      3890**DCL      3907<<ASSIGN   4037<<ASSIGN   4038>>IF       4047<<ASSIGN   4048>>IF       4057<<ASSIGN
      4058>>IF       4067<<ASSIGN   4068>>IF       4115>>IF       4115>>IF       4127>>ASSIGN   4134>>ASSIGN
DBNO
      3891**DCL      4030<<DOINDEX  4032>>IF       4033>>ASSIGN   4034>>ASSIGN
DBSTATUS
      3884**DCL      3917<<ASSIGN   3921<<CALLBLT
ENQLIST.BUFSLOT
      1537**DCL      3972>>IF       3972>>IF
PL6.E3A0      #005=ZIM$EKEEP File=ZIM$ENQM.:ZIC0TSI                              FRI 09/05/97 12:53 Page:170  
ENQLIST.STATUS.CURRENT
      1532**DCL      3972>>IF       4024<<ASSIGN   4131<<ASSIGN   4137<<ASSIGN
ENQLIST.STATUS.KEEP
      1530**DCL      3912<<ASSIGN   3972>>IF
ENQLIST.STATUS.MODIFY
      1534**DCL      3972>>IF
ENQLIST.VALUE.DCB#
      1541**DCL      3955--IF       3972--IF
ENQLIST$
      1543**DCL      1528--IMP-PTR  3904<<ASSIGN   3912>>ASSIGN   3948<<ASSIGN   3955>>IF       3972>>IF
      3972>>IF       3972>>IF       3972>>IF       3972>>IF       3972>>IF       4024>>ASSIGN   4131>>ASSIGN
      4137>>ASSIGN
F$DCB.ACTPOS
       122**DCL       122--REDEF
F$DCB.ARS#
        96**DCL        96--REDEF
F$DCB.ATTR
       115**DCL       116--REDEF
F$DCB.BORROW
       130**DCL       130--REDEF     130--REDEF     130--REDEF
F$DCB.DCBNAME.L
       144**DCL       144--IMP-SIZ
F$DCB.EOMCHAR#
       100**DCL       100--REDEF
F$DCB.FLDID
       125**DCL       125--REDEF
F$DCB.FORM$
       119**DCL       119--REDEF
F$DCB.FSECT
       135**DCL       135--REDEF
F$DCB.FSN#
       112**DCL       112--REDEF     112--REDEF     113--REDEF
F$DCB.HEADER$
       118**DCL       118--REDEF
F$DCB.IXTNSIZE#
       116**DCL       116--REDEF
PL6.E3A0      #005=ZIM$EKEEP File=ZIM$ENQM.:ZIC0TSI                              FRI 09/05/97 12:53 Page:171  
F$DCB.LASTSTA$
       105**DCL       105--REDEF
F$DCB.LVL
       131**DCL       131--REDEF
F$DCB.NAME#.C
       106**DCL       106--REDEF
F$DCB.NOEOF
       128**DCL       128--REDEF
F$DCB.NRECS#
       117**DCL       117--REDEF
F$DCB.NRECX
       136**DCL       136--REDEF
F$DCB.OHDR
       128**DCL       128--REDEF
F$DCB.ORG#
       111**DCL       111--REDEF
F$DCB.PRECNO
       134**DCL       134--REDEF
F$DCB.RCSZ
       140**DCL       140--REDEF
F$DCB.RES#
       107**DCL       107--REDEF
F$DCB.SETX
       119**DCL       119--REDEF
F$DCB.TAB$
       119**DCL       119--REDEF
F$DCB.TDA
       133**DCL       134--REDEF
F$DCB.UOPT#
       109**DCL      3955>>IF       3972>>IF
F$DCB.WSN#
       107**DCL       107--REDEF
FINDQ_AC IN PROCEDURE FINDQ_RC
      4122**ENTRY    4049--CALL     4071--CALL
FINDQ_RC
      4098**PROC     3910--CALL     4039--CALL     4059--CALL
PL6.E3A0      #005=ZIM$EKEEP File=ZIM$ENQM.:ZIC0TSI                              FRI 09/05/97 12:53 Page:172  
GLOBAL.ACTIVE.DBCB$
      1226**DCL      1227--REDEF    3897>>ASSIGN
GLOBAL.ACTIVE.SSS$
      1222**DCL      1223--REDEF    3908>>ASSIGN
GLOBAL.BCB.BUF.LOCK
      1338**DCL      3972>>IF
GLOBAL.DB.DBCB$
      1320**DCL      4034>>ASSIGN
GLOBAL.DB.SSS$
      1319**DCL      4030--DOINDEX  4030--DOINDEX  4032>>IF       4033>>ASSIGN
GLOBAL.ENQ.INDXMAP.BASE$
      1373**DCL      3905>>ASSIGN   3949>>ASSIGN
GLOBAL.ENQ.INDXMAP.COUNT
      1369**DCL      3954>>DOINDEX  3961>>IF       3962>>ASSIGN   3965<<ASSIGN   3965>>ASSIGN   4026>>DOINDEX
GLOBAL.ENQ.INDXMAP.INDX
      1367**DCL      3914>>ASSIGN   4129>>ASSIGN
GLOBAL.ENQ.LIST.BASE$
      1358**DCL      3904>>ASSIGN   3948>>ASSIGN
GLOBAL.ENQ.LIST.COUNT
      1362**DCL      3971>>DOINDEX  4023>>DOINDEX
GLOBAL.ENQ.LIST.INDX
      1360**DCL      3912>>ASSIGN   3985<<ASSIGN   4137>>ASSIGN
GLOBAL.ENQ.VALUE.DCB#
      1353**DCL      4124<<ASSIGN
GLOBAL.ENQ.VALUE.RNAME
      1355**DCL      4127<<ASSIGN   4134<<ASSIGN
GLOBAL.KEY
      1430**DCL      1433--REDEF
GLOBAL.PARAN.TRACE.MODE
      1305**DCL      1312--REDEF
GLOBAL.PRINTBUF.BUFFER
      1464**DCL      1465--REDEF    1466--REDEF    1467--REDEF
GLOBAL.PRINTBUF.ERR.V
      1469**DCL      1472--REDEF    1473--REDEF    1474--REDEF
GLOBAL.RET.ERROR#
      1240**DCL      3991>>IF       3996<<ASSIGN
PL6.E3A0      #005=ZIM$EKEEP File=ZIM$ENQM.:ZIC0TSI                              FRI 09/05/97 12:53 Page:173  
GLOBAL$
      1524**DCL      1220--IMP-PTR  3897>>ASSIGN   3904>>ASSIGN   3905>>ASSIGN   3908>>ASSIGN   3912>>ASSIGN
      3914>>ASSIGN   3948>>ASSIGN   3949>>ASSIGN   3954>>DOINDEX  3961>>IF       3962>>ASSIGN   3965>>ASSIGN
      3965>>ASSIGN   3971>>DOINDEX  3972>>IF       3985>>ASSIGN   3991>>IF       3996>>ASSIGN   4023>>DOINDEX
      4026>>DOINDEX  4032>>IF       4033>>ASSIGN   4034>>ASSIGN   4124>>ASSIGN   4127>>ASSIGN   4129>>ASSIGN
      4134>>ASSIGN   4137>>ASSIGN
GOT_AC IN PROCEDURE FINDQ_RC
      4118**LABEL    4118--GOTO
I
      3894**DCL      3954<<DOINDEX  3955>>IF       3955>>IF       3955>>IF       3955>>IF       3961>>IF
      3962>>ASSIGN   3963>>ASSIGN   3963>>ASSIGN   3966<<ASSIGN   3966>>ASSIGN   3971<<DOINDEX  3972>>IF
      3972>>IF       3972>>IF       3972>>IF       3972>>IF       3972>>IF       3985>>ASSIGN   4002<<ASSIGN
      4002>>ASSIGN   4023<<DOINDEX  4024>>ASSIGN   4026<<DOINDEX  4027>>ASSIGN
INDX
      3892**DCL      4129<<ASSIGN   4130>>ASSIGN   4131>>ASSIGN
INDXMAP
      1546**DCL      3962--ASSIGN   3963--ASSIGN   3963--ASSIGN
INDXMAP.ENQINDX
      1555**DCL      3955>>IF       4131>>ASSIGN
INDXMAP.STATUS.CURRENT
      1550**DCL      3955>>IF       4027<<ASSIGN   4130<<ASSIGN
INDXMAP.STATUS.KEEP
      1548**DCL      3914<<ASSIGN   3955>>IF
INDXMAP.STATUS.MODIFY
      1552**DCL      3955>>IF
INDXMAP$
      1559**DCL      1546--IMP-PTR  3905<<ASSIGN   3914>>ASSIGN   3949<<ASSIGN   3955>>IF       3955>>IF
      3955>>IF       3955>>IF       3963>>ASSIGN   3963>>ASSIGN   4027>>ASSIGN   4130>>ASSIGN   4131>>ASSIGN
MARK_CURRENCY
      4020**PROC     3951--CALL
NEXTI
      4004**LABEL    3997--GOTO
OA.SCNAM.EIS.COUNT
      3342**DCL      3377--IMP-SIZ
OA$
      3320**DCL      3321--IMP-PTR  4042<<ASSIGN   4043>>ASSIGN   4053>>ASSIGN   4063>>ASSIGN
PL6.E3A0      #005=ZIM$EKEEP File=ZIM$ENQM.:ZIC0TSI                              FRI 09/05/97 12:53 Page:174  
OA1
      3312**DCL      4042--ASSIGN   4111--ASSIGN
OA1$
      3311**DCL      3312--IMP-PTR
PS0$
      3883**DCL      3884--IMP-PTR  3917>>ASSIGN   3921>>CALLBLT
RA.ACRAH
      3489**DCL      4106>>ASSIGN
RA.PGRNG.IHIGHDBK
      3492**DCL      3493--REDEF
RA$
      3479**DCL      3480--IMP-PTR  4105<<ASSIGN   4106>>ASSIGN
RC.DEF.PSTO
      3505**DCL      4103>>IF
RC.DEF.RNL
      3516**DCL      3526--IMP-SIZ
RC.OARCN
      3519**DCL      4054>>DOWHILE  4055>>ASSIGN
RC.RCRAN
      3517**DCL      4105>>ASSIGN
RC.RCWSO
      3524**DCL      4056>>ASSIGN
RC$
      3500**DCL      3501--IMP-PTR  3909<<ASSIGN   4036<<ASSIGN   4053<<ASSIGN   4054>>DOWHILE  4055<<ASSIGN
      4055>>ASSIGN   4056>>ASSIGN   4103>>IF       4105>>ASSIGN
REDUCE
      3945**LABEL    3942--GOTO
RET
      4005**LABEL    3918--GOTO     3922--GOTO     3990--CALLALT
RWS.CURR
      2735**DCL      4057>>ASSIGN
RWS.KEY.LENGTH
      2737**DCL      2738--IMP-SIZ
RWS$
      2722**DCL      2723--IMP-PTR  4056<<ASSIGN   4057>>ASSIGN
SC.DEF.SNL
PL6.E3A0      #005=ZIM$EKEEP File=ZIM$ENQM.:ZIC0TSI                              FRI 09/05/97 12:53 Page:175  
      3545**DCL      3550--IMP-SIZ
SC.OASCN
      3547**DCL      4064>>DOWHILE  4065>>ASSIGN
SC.SCWSO
      3546**DCL      4066>>ASSIGN
SC$
      3532**DCL      3533--IMP-PTR  4063<<ASSIGN   4064>>DOWHILE  4065<<ASSIGN   4065>>ASSIGN   4066>>ASSIGN
SETWS.AC
      2753**DCL      4069>>ASSIGN
SETWS.CURR
      2754**DCL      4067>>ASSIGN
SETWS.KEY.LENGTH
      2756**DCL      2757--IMP-SIZ
SETWS$
      2742**DCL      2743--IMP-PTR  4066<<ASSIGN   4067>>ASSIGN   4069>>ASSIGN
SIZE
      3895**DCL      3896--IMP-SIZ  3962<<ASSIGN   3963>>ASSIGN   3963>>ASSIGN
SSS$
      2767**DCL      3908<<ASSIGN   3909>>ASSIGN   4033<<ASSIGN   4036>>ASSIGN   4042>>ASSIGN   4045>>ASSIGN
      4055>>ASSIGN   4065>>ASSIGN   4069>>ASSIGN   4105>>ASSIGN   4106>>ASSIGN   4111>>ASSIGN   4113>>ASSIGN
ZIM$DEQ_ONE
      3887**DCL-ENT  3990--CALL
ZIM$ENQ_FIND IN PROCEDURE FINDQ_RC
      4100**DCL-ENT  4136--CALL
ZIM$INDXMAP_FIND IN PROCEDURE FINDQ_RC
      4099**DCL-ENT  4128--CALL
