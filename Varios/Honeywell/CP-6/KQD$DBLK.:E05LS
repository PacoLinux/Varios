VERSION E05

PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:1    
        1        1        /*M* KQD$DBLK - Data management and cache routines for comgroup */
        2        2        /*T***********************************************************/
        3        3        /*T*                                                         */
        4        4        /*T* Copyright (c) Bull HN Information Systems Inc., 1997    */
        5        5        /*T*                                                         */
        6        6        /*T***********************************************************/
        7        7        /**/
        8        8        /*X* DMC,PLM=6,IND=0,IDT=2,SDI=2,CTI=0,ENU=0,AND,DCI=4,CSU=2,ECU=4,THI=0,DTI=0,STI=2
                 8        ,IAD=0,PRB */
        9        9        /**/
       10       10        /*P* NAME:         KQD$DBLK
       11       11
       12       12             PURPOSE:      Provide routines for data and buffer management.
       13       13
       14       14        */
       15       15
       16       16
       17       17        KQD$GET: PROC(KQ$CG,PDBLK$,PDDA) ALTRET;
       18       18
       19       19
       20       20        /**/
       21       21        /* INCLUDES */
       22       22        /**/
       23       23        %INCLUDE EL$TABLES;
       24      346        %INCLUDE EL_SUBS_C;
       25      430        %INCLUDE FM$CFU;
       26      475        %INCLUDE FM$SET;
       27      502        %INCLUDE HF_LOCK_C;
       28      516        %INCLUDE KC$CP6V_C;
       29      636        %INCLUDE KC_CP6;
       30     1196        %INCLUDE KQ_MAC_C;
       31     3746        %INCLUDE KQ_DATA_R;
       32     4578        %INCLUDE KQ_SUBS_C;
       33     4878        %INCLUDE N$REQ;
       34     4952        %INCLUDE N_FC_C;
       35     4989        %INCLUDE SS_SCHED_C;
       36     5222        %INCLUDE XUD_UTS_M;
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:2    
       37     5304
       38     5305
       39     5306        /**/
       40     5307        /* PARAMETERS */
       41     5308        /**/
       42     5309        %KQ_CG (FPTN=KQ$CG,STCLASS=);
       43     6048    1   DCL PDBLK$ PTR;
       44     6049    1   DCL PSTAMP REDEF PDBLK$ UBIN;
       45     6050    1   DCL PDDA BIT(36) ALIGNED;
       46     6051    1   DCL PSTA$ REDEF PDDA PTR;
       47     6052    1   DCL PSIZ REDEF PDDA UBIN;
       48     6053    1   DCL PEPTR$ REDEF PDDA EPTR;
       49     6054
       50     6055
       51     6056        /**/
       52     6057        /* BASED STRUCTURES */
       53     6058        /**/
       54     6059        %FM$CFU;
       55     6065        %FM$CFUA;
       56     6071        %FM$CFUN;
       57     6074        %FM$CFUX (BASED="BASED(F$CFU$)");
       58     6079        %FM$SET (BASED="BASED(F$CFU$)");
       59     6084        %KQ_BTN (FPTN=KQ$BTN,STCLASS=BASED);
       60     6116        %KQ_DBLK (FPTN=KQ$DBLK,STCLASS="BASED(DBLK$)");
       61     6169        %KQ_DFRBLK (FPTN=KQ$DFRBLK,STCLASS="BASED(DFR$)");
       62     6219        %KQ_DGRAN (FPTN=KQ$DGRAN,STCLASS="BASED(DGRAN$)");
       63     6366        %KQ_GRAN (FPTN=KQ$GRAN,STCLASS="BASED(DGRAN$)");
       64     6421        %KQ_STA (FPTN=KQ$STA,STCLASS=BASED);
       65     6760        %KQ_MBLK (FPTN=KQ$MBLK,STCLASS=BASED);
       66     7030    1   DCL WRD(0:1023) UBIN BASED ALIGNED;
       67     7031
       68     7032
       69     7033        /**/
       70     7034        /* AUTO */
       71     7035        /**/
       72     7036    1   DCL DBLK$ PTR;
       73     7037    1   DCL 1 DBLK REDEF DBLK$,
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:3    
       74     7038    1         2 * BIT(8),
       75     7039    1         2 DISP UBIN(9) UNAL,
       76     7040    1         2 * BIT(19);
       77     7041    1   DCL DFR$ PTR;
       78     7042    1   DCL TDFR$ PTR;
       79     7043    1   DCL DGRAN$ PTR;
       80     7044    1   DCL 1 DGRAN REDEF DGRAN$,
       81     7045    1         2 * BIT(8),
       82     7046    1         2 DISP UBIN(16) UNAL,
       83     7047    1         2 * BIT(12);
       84     7048    1   DCL I UBIN;
       85     7049    1   DCL J UBIN;
       86     7050    1   DCL PREVDBLK$ PTR;
       87     7051    1   DCL DA UBIN;
       88     7052    1   DCL 1 KEY,
       89     7053    1         2 DA UBIN,
       90     7054    1         2 GARB UBIN;
       91     7055    1   DCL ENTFLG UBIN;
       92     7056    1   DCL DELFLG UBIN;
       93     7057    1   DCL 1 CHKPARM DALIGNED,
       94     7058    1         2 * BIT(72),
       95     7059    1         2 P$ PTR;
       96     7060    1   DCL REGFLG UBIN;
       97     7061    1   DCL ERRCODE UBIN;
       98     7062    1   DCL STAMP UBIN;
       99     7063    1   DCL 1 DDA,
      100     7064    1         2 DISP UBIN(9) UNAL,
      101     7065    1         2 DA UBIN(27) UNAL;
      102     7066        %KQ_DFRPARM (FPTN=KQ$DFRPARM,STCLASS=AUTO);
      103     7095    1   DCL EPTR$ EPTR;
      104     7096    1   DCL T$ PTR;
      105     7097    1   DCL P$ PTR;
      106     7098    1   DCL SIZBYTES UBIN;
      107     7099    1   DCL HD$ PTR;
      108     7100    1   DCL TL$ PTR;
      109     7101    1   DCL PASS UBIN;
      110     7102    1   DCL LDFR$ PTR;
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:4    
      111     7103    1   DCL LDBLK$ PTR;
      112     7104    1   DCL LDGRAN$ PTR;
      113     7105
      114     7106
      115     7107        /**/
      116     7108        /* EXTERNAL DATA */
      117     7109        /**/
      118     7110    1   DCL F$CFU$ PTR SYMREF READONLY;
      119     7111    1   DCL FM_FRZERO UBIN SYMREF;
      120     7112    1   DCL FM_WRCMP UBIN SYMREF;
      121     7113    1   DCL H_GATECNT UBIN SYMREF;
      122     7114    1   DCL NI$DS UBIN SYMREF;
      123     7115    1   DCL S_CUN UBIN SYMREF;
      124     7116    1   DCL S_TIMR UBIN SYMREF;
      125     7117        %EL$CGERR (NAME=KQ_ERRLOG_BFR,STCLASS=SYMREF,N=50);
      126     7121
      127     7122
      128     7123        /**/
      129     7124        /* CONSTANT */
      130     7125        /**/
      131     7126        %KQ_DBLK (STCLASS=CONSTANT);
      132     7179        %KQ_DFRBLK (STCLASS=CONSTANT);
      133     7229        %KQ_DGRAN (STCLASS="CONSTANT SYMDEF",FPTN=KQ_IDGRAN);
      134     7376    1   DCL KQD_MINSPLIT SBIN CONSTANT INIT(20);
      135     7377
      136     7378
      137     7379        /**/
      138     7380        /* EXTERNAL ROUTINES */
      139     7381        /**/
      140     7382    1   DCL ELA$SYSLOG ENTRY(6) ALTRET;
      141     7383    1   DCL FAF$FRTOSRNJ ENTRY(3) ALTRET;
      142     7384    1   DCL FAF$SRTODR ENTRY(2) ALTRET;
      143     7385    1   DCL KQB$DELETENL ENTRY(3) ALTRET;
      144     7386    1   DCL KQB$INSERTNL ENTRY(3) ALTRET;
      145     7387    1   DCL KQB$SRCH ENTRY(3) ALTRET;
      146     7388    1   DCL KQC$CXTSET ENTRY(1) ALTRET;
      147     7389    1   DCL KQE$RDEA ENTRY(1);
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:5    
      148     7390    1   DCL KQE$RDEAERR ENTRY(1);
      149     7391    1   DCL KQE$WREA ENTRY(1);
      150     7392    1   DCL KQM$GETP ENTRY(3) ALTRET;
      151     7393    1   DCL KQM$RELP ENTRY(2) ALTRET;
      152     7394    1   DCL KQS$CGFULL ENTRY(1) ALTRET;
      153     7395    1   DCL KQX$CHKPTR ENTRY(1) ALTRET;
      154     7396    1   DCL KQZ$LOG ENTRY(8) ALTRET;
      155     7397    1   DCL NIO$QUE ENTRY(1) ALTRET;
      156     7398    1   DCL NIQ$GETSNR ENTRY(1) ALTRET;
      157     7399    1   DCL NIQ$GETNR ENTRY(1) ALTRET;
      158     7400    1   DCL NIQ$REL ENTRY(1) ALTRET;
      159     7401    1   DCL SC_CGCACHE ENTRY CONV(2,0);
      160     7402    1   DCL SC_CGCACHESCR ENTRY CONV(2,0);
      161     7403    1   DCL SSR$REG ENTRY(3) ALTRET;
      162     7404    1   DCL SSR$RUE ENTRY(4);
      163     7405    1   DCL SSS$SYSTIME ENTRY(1);
      164     7406        %XUD$UTS_ENTRIES;
      165     7438
      166     7439
      167     7440        /**/
      168     7441        /* EQUs */
      169     7442        /**/
      170     7443        %EQU KQD_UNLOCK=0;
      171     7444        %EQU KQD_UPD=1;
      172     7445        %EQU KQD_LREL=2;
      173     7446        %EQU KQD_DEL=3;
      174     7447        /**/
      175     7448        %EQU GFLG_INIT=1;
      176     7449        %EQU GFLG_FREE=2;
      177     7450        %EQU GFLG_NEW=3;
      178     7451        /**/
      179     7452        %XUD_UTS_EQU;
      180     7463        /**/
      181     7464        %SUB EMPTY_GRAN = "1024-SIZEW(KQ$DGRAN) ";
      182     7465        %SUB  NONE = 0;
      183     7466        %SUB  ADD = 1;
      184     7467        %SUB  SUBTRACT = 2;
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:6    
      185     7468
      186     7469        %EJECT;
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:7    
      187     7470
      188     7471
      189     7472        /*F* NAME:         KQD$GET
      190     7473
      191     7474             PURPOSE:      Allocate a block of data space from the
      192     7475                           disk data area.
      193     7476
      194     7477        */
      195     7478
      196     7479
      197     7480        /*D* NAME:         KQD$GET
      198     7481
      199     7482             CALL:         CALL KQD$GET(KQ$CG,DBLK$,DDA) ALTRET(LOC);
      200     7483
      201     7484             ENTRY:        CALL KQD$GETR(KQ$CG,DBLK$,DDA) ALTRET(LOC);
      202     7485
      203     7486             INPUT:        KQ$CG - The comgroup context area
      204     7487                           DDA - Size in bytes to allocate
      205     7488
      206     7489             OUTPUT:       DBLK$ - Pointer to the data area
      207     7490                           DDA - Data disk address of the area
      208     7491
      209     7492             DESCRIPTION:
      210     7493                   Normal return:
      211     7494                           DBLK$ - Ptr to the data block allocated
      212     7495                           DDA - Data disk address
      213     7496
      214     7497                   Alternate return:
      215     7498                           If DBLK$ is ADDR(NIL), then DDA contains the error
      216     7499                           code. A code of KQDE_NDFRBLK means the call must be
      217     7500                           re-issued later (out of defer blocks).
      218     7501                           If DBLK$ is not ADDR(NIL), it is the pointer to
      219     7502                           a defer block that must be passed to KQD$DEFERGO
      220     7503                           when it is alright to proceed.
      221     7504
      222     7505                           The in-core granules are examined for free space.
      223     7506                           If a block of space is found that is at least as
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:8    
      224     7507                           large as is needed, it is used.  If it is larger
      225     7508                           than needed by at least KQD_MINSPLIT, it is split
      226     7509                           into two blocks, one of the size needed and the
      227     7510                           other the rest.
      228     7511
      229     7512                           If a granule is examined and its available chain
      230     7513                           does not contain usable space, a buddy-up
      231     7514                           operation is performed if:  there are at
      232     7515                           least two available blocks at least one
      233     7516                           of which resides on the AVAIL chain.
      234     7517                           The buddy-up process moves all blocks from the
      235     7518                           available chain to the buddied-up chain, and
      236     7519                           buddies up neighbors.  If the buddy-up oeration
      237     7520                           did not find any space, or if it was not
      238     7521                           performed, the next granule is examined.
      239     7522
      240     7523                           If all granules are examined and there is no
      241     7524                           space available of the right size, an attempt
      242     7525                           is made to allocate a new granule.  If no
      243     7526                           granules remain, the caller is told there is
      244     7527                           no space left.  If there is a granule, then
      245     7528                           a page is obtained.  If a new page cannot be
      246     7529                           allocated, then an old page is thrown out and
      247     7530                           reused.
      248     7531
      249     7532                           GETR, if called by a user, will REG until the
      250     7533                           operation completes (will never return a defer
      251     7534                           block ptr).  If called not on behalf of a user,
      252     7535                           will return the error KQDE_CREG if there is no
      253     7536                           space available in core.
      254     7537
      255     7538
      256     7539
      257     7540        %EJECT;
      258     7541
      259     7542
      260     7543        KQD$GET: ENTRY(KQ$CG,PDBLK$,PDDA) ALTRET;
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:9    
      261     7544        */
      262     7545
      263     7546    1         REGFLG=0;
      264     7547    1         GOTO GETCOM;
      265     7548
      266     7549    1   KQD$GETR: ENTRY(KQ$CG,PDBLK$,PDDA) ALTRET;
      267     7550
      268     7551    1         REGFLG=1;
      269     7552
      270     7553
      271     7554    1   GETCOM: ;
      272     7555    1         ENTFLG=%KQDC_GET;
      273     7556    1         DFR$=ADDR(NIL);
      274     7557    1         SIZBYTES=PSIZ;
      275     7558    1         IF SIZBYTES=0 OR SIZBYTES > KQ_MCMAX#+SIZEC(KQ$MBLK) THEN
      276     7559    2           DO;
      277     7560    2           PDBLK$=ADDR(NIL);
      278     7561    2           PSIZ=%KQDE_BADPARMS;
      279     7562    2   ALTRT:
      280     7563    2           ALTRETURN;
      281     7564    2           END;
      282     7565        /**/
      283     7566              %LOCK (G=KQ$CG.DTREE.GATE);
      284     7569        /**/
      285     7570    1   GET10: ;
      286     7571    1         DGRAN$=KQ$CG.AVAIL.HD$;  /* Head of in-core granules */
      287     7572    2           DO WHILE(DGRAN$~=ADDR(NIL));
      288     7573    2           IF NOT KQ$DGRAN.HDR.WRITE THEN
      289     7574    3             DO;
      290     7575    3             CALL ALLOC ALTRET(NOSPACE);
      291     7576    3             GOTO GOTDBLK;
      292     7577    3             END;
      293     7578        /**/
      294     7579    2   NOSPACE: ;
      295     7580    2           DGRAN$=KQ$DGRAN.FLINK$;
      296     7581    2           END;
      297     7582    1         GOTO GETSPACE;
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:10   
      298     7583        /**/
      299     7584        /**/
      300     7585    1   GOTDBLK: ;
      301     7586    2         IF KQ_LOG.KQD THEN DO;
      302     7587    2           LDFR$=DFR$; LDBLK$=DBLK$;
      303     7588    2           CALL KQZ$LOG(KQ$CG,%KQLOG_DCGET,,SIZBYTES,
      304     7589    2           LDFR$,DDA,LDBLK$);
      305     7590    2           END;
      306     7591    1         IF DFR$~=ADDR(NIL) THEN
      307     7592    1           CALL RELBLK;
      308     7593              %UNLOCK (G=KQ$CG.DTREE.GATE);
      309     7596    1         PDBLK$=DBLK$;
      310     7597    1         PDDA=DDA;
      311     7598    1         RETURN;
      312     7599        /**/
      313     7600        /* Nothing in core - invoke the space allocator */
      314     7601        /**/
      315     7602    1   GETSPACE: ;
      316     7603    1         DA=0;
      317     7604    1         IF DFR$=ADDR(NIL) THEN
      318     7605    1           IF REGFLG~=0 THEN
      319     7606    1             IF S_TIMR~=2 AND S_CUN~=0 THEN
      320     7607    1               CALL GETBLKR ALTRET(GET10);
      321     7608    1             ELSE
      322     7609    1               GOTO CREG;  /* Can't REG */
      323     7610    1           ELSE
      324     7611    1             CALL GETBLK ALTRET(NODFRBLK);
      325     7612    2         IF KQ_LOG.KQD THEN DO;
      326     7613    2           LDFR$=DFR$;
      327     7614    2           CALL KQZ$LOG(KQ$CG,%KQLOG_DCGDFR,,SIZBYTES,
      328     7615    2           LDFR$);
      329     7616    2           END;
      330     7617    1         KQ$DFRBLK.DDA=SIZBYTES;
      331     7618    1         IF KQ$CG.GETTL$=ADDR(NIL) THEN
      332     7619    1           KQ$CG.GETHD$=DFR$;
      333     7620    1         ELSE
      334     7621    1           KQ$CG.GETTL$->KQ$DFRBLK.LNK$=DFR$;
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:11   
      335     7622    1         KQ$CG.GETTL$=DFR$;
      336     7623    1         IF KQ$CG.GETFLG~=0 THEN
      337     7624    2           DO;  /* Allocator is already running */
      338     7625                %UNLOCK (G=KQ$CG.DTREE.GATE);
      339     7628    2           GOTO FTCH30; /* GET is already in progress */
      340     7629    2           END;
      341     7630    1         KQ$CG.GETFLG=%GFLG_INIT;
      342     7631    1         CALL GETINIT;  /* Initiate the allocator */
      343     7632    1         IF KQ$DFRBLK.EVNT THEN
      344     7633    2           DO;  /* Allocation has already occurred */
      345     7634    2           IF KQ$DFRBLK.USR~=0 THEN
      346     7635    2             GOTO FTCH30; /* Must REG - have had UQA reported already */
      347     7636    2           PDBLK$=KQ$DFRBLK.DBLK$;
      348     7637    2           PSIZ=KQ$DFRBLK.DDA;
      349     7638    2           ERRCODE=KQ$DFRBLK.ERRCODE;
      350     7639                %LOCK (G=KQ$CG.DTREE.GATE);
      351     7642    2           CALL RELBLK;
      352     7643                %UNLOCK (G=KQ$CG.DTREE.GATE);
      353     7646    2           IF ERRCODE~=0 THEN
      354     7647    3             DO;
      355     7648    3             PDBLK$=ADDR(NIL);
      356     7649    3             PSIZ=ERRCODE;
      357     7650    3             ALTRETURN;
      358     7651    3             END;
      359     7652    2           RETURN;
      360     7653    2           END;
      361     7654    1         GOTO FTCH30;
      362     7655        /**/
      363     7656        /**/
      364     7657    1   INITGRAN: PROC;
      365     7658
      366     7659
      367     7660    2         IF KQ$DGRAN.BTN.KEY~=' ' THEN
      368     7661    2           CALL SC_CGCACHESCR;  /* This is not an initialized page */
      369     7662    2         KQ$DGRAN.HDR.STAMP.GMOD=DA;
      370     7663    2         DBLK$=PINCRW(DGRAN$,SIZEW(KQ$DGRAN));
      371     7664    2         KQ$DBLK=KQ_DBLK;
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:12   
      372     7665    2         KQ$DBLK.SIZW=1024-SIZEW(KQ$DGRAN);
      373     7666    2         KQ$DGRAN.AVAILX=SIZEW(KQ$DGRAN);
      374     7667    2         KQ$DGRAN.WRDSAVAIL=KQ$DBLK.SIZW;
      375     7668    2         KQ$DGRAN.WRDSFREE = KQ$DBLK.SIZW;
      376     7669    2         KQ$CG.STATS.WRDSUSED = KQ$CG.STATS.WRDSUSED + SIZEW(KQ$DGRAN);
      377     7670    2         KEY.DA=DA;
      378     7671    2         KEY.GARB=0;
      379     7672    2         T$=ADDR(KQ$DGRAN.BTN);
      380     7673    2         CALL KQB$INSERTNL(KQ$CG.DTREE,KEY,T$) ALTRET(TREEERR);
      381     7674    2         KQ$DGRAN.HDR.CHAIN='1'B;  /* Now is on chain */
      382     7675    2         KQ$DGRAN.HDR.UPD='1'B;  /* Update this to disk */
      383     7676    2         KQ$DGRAN.FLINK$=KQ$CG.AVAIL.HD$;
      384     7677    2         IF KQ$CG.AVAIL.TL$=ADDR(NIL) THEN
      385     7678    2           KQ$CG.AVAIL.TL$=DGRAN$;
      386     7679    2         ELSE
      387     7680    2           KQ$CG.AVAIL.HD$->KQ$DGRAN.BLINK$=DGRAN$;
      388     7681    2         KQ$CG.AVAIL.HD$=DGRAN$;
      389     7682    2         CALL SSS$SYSTIME(KQ$DGRAN.HDR.WRITEUTS);
      390     7683    2         KQ$DGRAN.TIME=KQ$DGRAN.HDR.WRITEUTS;
      391     7684    2         RETURN;
      392     7685        /**/
      393     7686    2   TREEERR: ;
      394     7687    2         CALL SC_CGCACHESCR;
      395     7688    2         GOTO TREEERR;
      396     7689        /**/
      397     7690        /*S*  SCREECH_CODE: KQD-S$CGCACHESCR
      398     7691              TYPE: SCREECH
      399     7692              MESSAGE: Fatal error in comgroup data cache
      400     7693        */
      401     7694        /**/
      402     7695    2   END INITGRAN;
      403     7696        %EJECT;
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:13   
      404     7697
      405     7698
      406     7699    1   GETINIT: PROC ALTRET;
      407     7700
      408     7701    2   DCL TDFR$ PTR;
      409     7702    2   DCL GDFR$ PTR;
      410     7703    2   DCL TDGRAN$ PTR;
      411     7704    2   DCL T$ PTR;
      412     7705    2   DCL P$ PTR;
      413     7706
      414     7707    2         TDFR$=DFR$;
      415     7708    2         GDFR$=ADDR(NIL);
      416     7709    2         TDGRAN$=DGRAN$;
      417     7710    2         DGRAN$=ADDR(NIL);
      418     7711    2   STARTGET: ;
      419     7712    2         IF KQ$CG.GETFLG=%GFLG_INIT THEN  /* Needs to be started */
      420     7713    3           DO;
      421     7714    3           DFR$=KQ$CG.GETHD$;
      422     7715    3           IF DFR$=ADDR(NIL) THEN
      423     7716    4             DO;
      424     7717    4             KQ$CG.GETFLG=0;
      425     7718    4             GOTO UNLKRET;
      426     7719    4             END;
      427     7720    4             DO WHILE(DFR$~=ADDR(NIL));
      428     7721    4             KQ$DFRBLK.GFLG='1'B;
      429     7722    4             DFR$=KQ$DFRBLK.LNK$;
      430     7723    4             END;
      431     7724    3           IF KQ$CG.FREEDA~=0 THEN /* There is a list of grans */
      432     7725    3             IF KQ$CG.ADDFREE~=0 THEN
      433     7726    3               GOTO UNLKRET;
      434     7727    3             ELSE
      435     7728    4               DO;
      436     7729    4               CALL GETBLK ALTRET(UNLKRET);
      437     7730    4               GDFR$=DFR$;
      438     7731    4               KQ$DFRBLK.CODE=%KQDC_GETFREE;
      439     7732    4               DA=KQ$CG.FREEDA;
      440     7733    4               KQ$DFRBLK.USR=0;
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:14   
      441     7734    4               KQ$CG.GETFLG=%GFLG_FREE;
      442     7735    5               IF KQ_LOG.GETP THEN DO;
      443     7736    5                 LDFR$=DFR$;
      444     7737    5                 CALL KQZ$LOG(KQ$CG,%KQLOG_GINIT,,
      445     7738    5                 %KQDC_GETFREE,LDFR$) ALTRET(LOG2);
      446     7739    5                 RETURN;
      447     7740    5   LOG2:         END;
      448     7741    4               GOTO GETFREE;
      449     7742    4               END;
      450     7743    3           ELSE /* No list of grans with space avail */
      451     7744    3             IF KQ$CG.NGAVAL>KQ$CG.AUCTL.MAXPG THEN
      452     7745    4               DO; /* There are granules left to allocate */
      453     7746    4               DA=0;
      454     7747    4               CALL GETBLK ALTRET(UNLKRET);
      455     7748    4               GDFR$=DFR$;
      456     7749    4               KQ$DFRBLK.CODE=%KQDC_GETNEW;
      457     7750    4               KQ$DFRBLK.USR=0;
      458     7751    4               KQ$CG.GETFLG=%GFLG_NEW;
      459     7752    5               IF KQ_LOG.GETP THEN DO;
      460     7753    5                 LDFR$=DFR$;
      461     7754    5                 CALL KQZ$LOG(KQ$CG,%KQLOG_GINIT,,
      462     7755    5                 %KQDC_GETNEW,LDFR$) ALTRET(LOG3);
      463     7756    5                 RETURN;
      464     7757    5   LOG3:         END;
      465     7758    4               GOTO GETNEW5;
      466     7759    4               END;
      467     7760    3             ELSE
      468     7761    3               GOTO GETNOSPACE; /* No space left */
      469     7762    3           END;
      470     7763        /**/
      471     7764    2         GOTO UNLKRET;
      472     7765        /**/
      473     7766        /**/
      474     7767
      475     7768
      476     7769    2   GETPROCESS: ENTRY ALTRET;
      477     7770
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:15   
      478     7771
      479     7772    3         IF KQ_LOG.GETP THEN DO;
      480     7773    3           IF DFR$~=ADDR(NIL) THEN
      481     7774    3             I=KQ$DFRBLK.CODE;
      482     7775    3           ELSE
      483     7776    3             I=0;
      484     7777    3           LDFR$=DFR$; LDGRAN$=DGRAN$;
      485     7778    3           CALL KQZ$LOG(KQ$CG,%KQLOG_GPROC,,I,
      486     7779    3           LDFR$,,LDGRAN$) ALTRET(LOG4);
      487     7780    3           RETURN;  /* Never comes here */
      488     7781    3   LOG4:   END;
      489     7782    2         TDFR$=DFR$;
      490     7783    2         GDFR$=DFR$;
      491     7784    2         TDGRAN$=DGRAN$;
      492     7785    2         IF DGRAN$=ADDR(NIL) THEN
      493     7786    2           GOTO NOALLOC5;  /* Didn't get the granule */
      494     7787    2         IF DFR$~=ADDR(NIL) THEN
      495     7788    2           IF KQ$DFRBLK.CODE=%KQDC_GETNEW THEN
      496     7789    2             GOTO GETNEW;
      497     7790    2   LOOP: ;
      498     7791    2         T$=KQ$CG.GETHD$;
      499     7792    2         P$=ADDR(NIL);
      500     7793    3           DO WHILE(T$~=ADDR(NIL));
      501     7794    3           DFR$=T$;
      502     7795    3           T$=KQ$DFRBLK.LNK$;
      503     7796    3           SIZBYTES=KQ$DFRBLK.DDA;
      504     7797    3           IF NOT KQ$DFRBLK.ABORT THEN
      505     7798    3             CALL ALLOC ALTRET(NOALLOC);
      506     7799    3           ELSE
      507     7800    4             DO;  /* Caller aborted the get - ignore it */
      508     7801    4             DBLK$=ADDR(NIL);
      509     7802    4             DDA='0'B;
      510     7803    4             END;
      511     7804    3           IF P$~=ADDR(NIL) THEN
      512     7805    3             P$->KQ$DFRBLK.LNK$=T$;
      513     7806    3           IF KQ$CG.GETHD$=DFR$ THEN
      514     7807    3             KQ$CG.GETHD$=T$;
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:16   
      515     7808    3           IF KQ$CG.GETTL$=DFR$ THEN
      516     7809    3             KQ$CG.GETTL$=P$;
      517     7810    3           KQ$DFRBLK.DBLK$=DBLK$;
      518     7811    3           KQ$DFRBLK.DDA=BITBIN(DDA);
      519     7812    3           KQ$DFRBLK.EVNT='1'B;
      520     7813    3           KQ$DGRAN.USECNT=KQ$DGRAN.USECNT+1;  /* Dont't let it disappear */
      521     7814    4           IF KQ_LOG.KQD THEN DO;
      522     7815    4             LDFR$=DFR$; LDGRAN$=DGRAN$;
      523     7816    4             CALL KQZ$LOG(KQ$CG,%KQLOG_DCGSAT,,,
      524     7817    4             LDFR$,DDA,LDBLK$) ALTRET(LOG1);
      525     7818    4             RETURN;  /* Never executed - just to get ret addr */
      526     7819    4   LOG1:     END;
      527     7820    3           CALL COMP;
      528     7821                %LOCK (G=KQ$CG.DTREE.GATE);
      529     7824    3           KQ$DGRAN.USECNT=KQ$DGRAN.USECNT-1;
      530     7825    3           GOTO LOOP;
      531     7826    3   NOALLOC: ;
      532     7827    3           P$=DFR$;
      533     7828    3           END;
      534     7829        /**/
      535     7830    2         DFR$=GDFR$;
      536     7831    2         IF KQ$CG.GETHD$=ADDR(NIL) AND GDFR$~=ADDR(NIL) THEN
      537     7832    3           DO;  /* GET process is complete */
      538     7833    3           KQ$CG.GETFLG=0;
      539     7834    4           IF KQ_LOG.GETP THEN DO;
      540     7835    4             LDFR$=DFR$;
      541     7836    4             CALL KQZ$LOG(KQ$CG,%KQLOG_GTRM,,
      542     7837    4             ,LDFR$) ALTRET(LOG5);
      543     7838    4             RETURN;  /* Never comes here */
      544     7839    4   LOG5:     END;
      545     7840    3           CALL RELBLK;
      546     7841    3           GOTO UNLKRET;
      547     7842    3           END;
      548     7843        /**/
      549     7844    2   NOALLOC5: ;
      550     7845    3           DO CASE(KQ$CG.GETFLG);
      551     7846    3             CASE(%GFLG_FREE);
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:17   
      552     7847    3               IF DFR$=ADDR(NIL) THEN
      553     7848    3                 GOTO UNLKRET;  /* This is not the GET process */
      554     7849    3               IF DGRAN$=ADDR(NIL) THEN
      555     7850    3                 DA=0;
      556     7851    3               ELSE
      557     7852    3                 DA=KQ$DGRAN.FREEFLINK;
      558     7853    3               IF DA=0 THEN
      559     7854    4                 DO; /* At end of free gran list */
      560     7855    4                 KQ$CG.GETFLG=%GFLG_NEW;
      561     7856    4                 KQ$DFRBLK.CODE=%KQDC_GETNEW;
      562     7857    4                 KQ$DFRBLK.DA=0;
      563     7858    4                 TDGRAN$=ADDR(NIL);
      564     7859    5                 IF KQ_LOG.GETP THEN DO;
      565     7860    5                   LDFR$=DFR$;
      566     7861    5                   CALL KQZ$LOG(KQ$CG,%KQLOG_GINIT,,
      567     7862    5                   %KQDC_GETNEW,LDFR$) ALTRET(LOG6);
      568     7863    5                   RETURN;  /* Never comes here */
      569     7864    5   LOG6:           END;
      570     7865    4                 GOTO GETNEW;
      571     7866    4                 END;
      572     7867    3   GETFREE:    ;
      573     7868    3               KQ$DFRBLK.DA=DA;
      574     7869    3               KEY.DA=DA;
      575     7870    3               KEY.GARB=0;
      576     7871    3               CALL KQB$SRCH(KQ$CG.DTREE,KEY,LDGRAN$) ALTRET(NOTIN);
      577     7872    3               DGRAN$=LDGRAN$;
      578     7873    3               DGRAN.DISP=0;
      579     7874    3               IF NOT KQ$DGRAN.HDR.WRITE THEN
      580     7875    3                 GOTO LOOP; /* Found one */
      581     7876    3   NOTIN:      ;
      582     7877    3               CALL READGRAN;
      583     7878    3               GOTO RET;
      584     7879        /**/
      585     7880    3             CASE(%GFLG_NEW);
      586     7881    3               IF DFR$=ADDR(NIL) THEN
      587     7882    3                 GOTO UNLKRET;  /* This is not the GET process */
      588     7883    3   GETNEW:     ;
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:18   
      589     7884    3               IF KQ$CG.NGAVAL>KQ$CG.AUCTL.MAXPG THEN
      590     7885    4                 DO;
      591     7886    4   GETNEW5:      ;
      592     7887    4                 IF KQ$CG.GETHD$=ADDR(NIL) THEN
      593     7888    5                   DO;
      594     7889    5                   KQ$CG.GETFLG=0;
      595     7890    5                   CALL RELBLK;
      596     7891    5                   GOTO UNLKALT;
      597     7892    5                   END;
      598     7893    4                 IF TDGRAN$=ADDR(NIL) THEN
      599     7894    4                   CALL GETPAGE ALTRET(RET);
      600     7895    4                 ELSE
      601     7896    4                   DGRAN$=TDGRAN$;
      602     7897    4                 TDGRAN$=ADDR(NIL);
      603     7898    4                 DA=KQ$CG.HIGRANS+FM_FRZERO;
      604     7899    4                 KQ$CG.HIGRANS=KQ$CG.HIGRANS+1;
      605     7900    4                 KQ$DFRBLK.DA=DA;
      606     7901    4                 CALL INITGRAN;
      607     7902    4                 GOTO LOOP;
      608     7903    4                 END;
      609     7904        /**/
      610     7905        /* No space is available  */
      611     7906        /**/
      612     7907    3   GETNOSPACE: ;
      613     7908
      614     7909    3               T$=KQ$CG.GETHD$;
      615     7910    3               P$=ADDR(NIL);
      616     7911    4                 DO WHILE(T$~=ADDR(NIL));
      617     7912    4                 DFR$=T$;
      618     7913    4                 T$=KQ$DFRBLK.LNK$;
      619     7914    4                 IF KQ$DFRBLK.GFLG THEN
      620     7915    5                   DO; /* This one has made full cycle */
      621     7916    5                   IF P$~=ADDR(NIL) THEN
      622     7917    5                     P$->KQ$DFRBLK.LNK$=T$;
      623     7918    5                   IF KQ$CG.GETHD$=DFR$ THEN
      624     7919    5                     KQ$CG.GETHD$=T$;
      625     7920    5                   IF KQ$CG.GETTL$=DFR$ THEN
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:19   
      626     7921    5                     KQ$CG.GETTL$=P$;
      627     7922    5                   KQ$DFRBLK.EVNT='1'B;
      628     7923    5                   KQ$DFRBLK.ERRCODE=%KQDE_NSPC;
      629     7924    5                   CALL COMP;
      630     7925    5                   CALL KQS$CGFULL(KQ$CG); /* Blow everyone away */
      631     7926                        %LOCK (G=KQ$CG.DTREE.GATE);
      632     7929    5                   GOTO GETNOSPACE;
      633     7930    5                   END;
      634     7931    4                 P$=DFR$;
      635     7932    4                 END;
      636     7933        /**/
      637     7934    3               DFR$=GDFR$;
      638     7935    4               IF DFR$~=ADDR(NIL) THEN DO;
      639     7936    5                 IF KQ_LOG.GETP THEN DO;
      640     7937    5                   LDFR$=DFR$;
      641     7938    5                   CALL KQZ$LOG(KQ$CG,%KQLOG_GTRM,,,
      642     7939    5                   LDFR$) ALTRET(LOG7);
      643     7940    5                   RETURN;  /* Never comes here */
      644     7941    5   LOG7:           END;
      645     7942    4                 CALL RELBLK;
      646     7943    4                 END;
      647     7944    3               GDFR$=ADDR(NIL);
      648     7945        /**/
      649     7946    3               IF KQ$CG.GETHD$~=ADDR(NIL) THEN
      650     7947    4                 DO;
      651     7948    4                 KQ$CG.GETFLG=%GFLG_INIT;
      652     7949    4                 GOTO STARTGET;
      653     7950    4                 END;
      654     7951    3               ELSE
      655     7952    3                 KQ$CG.GETFLG=0;
      656     7953        /**/
      657     7954    3             CASE(%GFLG_INIT);
      658     7955    3               GOTO STARTGET;
      659     7956    3           END;
      660     7957        /**/
      661     7958    2   UNLKRET: ;
      662     7959              %UNLOCK (G=KQ$CG.DTREE.GATE);
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:20   
      663     7962    2   RET:  ;
      664     7963    2         DFR$=TDFR$;
      665     7964    2         DGRAN$=TDGRAN$;
      666     7965    2         RETURN;
      667     7966        /**/
      668     7967    2   UNLKALT: ;
      669     7968              %UNLOCK (G=KQ$CG.DTREE.GATE);
      670     7971    2         DFR$=TDFR$;
      671     7972    2         DGRAN$=TDGRAN$;
      672     7973    2         ALTRETURN;
      673     7974
      674     7975    2   END GETINIT;
      675     7976        %EJECT;
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:21   
      676     7977
      677     7978
      678     7979        /*F* NAME:         KQD$GETINIT
      679     7980             PURPOSE:      To initiate a GET SPACE operation
      680     7981        */
      681     7982
      682     7983
      683     7984        /*D* NAME:         KQD$GETINIT
      684     7985             CALL:         CALL KQD$GETINIT(KQ$CG);
      685     7986             INPUT:        KQ$CG - The comgroup context block
      686     7987             DESCRIPTION:  Initiates a GET operation if one is needed
      687     7988                           and if it is possible at this time.
      688     7989        */
      689     7990
      690     7991    1   KQD$GETINIT: ENTRY(KQ$CG) ALTRET;  /* Never ALTRETs */
      691     7992
      692     7993
      693     7994    1         DFR$=ADDR(NIL);
      694     7995    1         DGRAN$=ADDR(NIL);
      695     7996              %LOCK (G=KQ$CG.DTREE.GATE);
      696     7999    1         CALL GETINIT;
      697     8000    1         RETURN;
      698     8001        %EJECT;
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:22   
      699     8002
      700     8003
      701     8004        /*F* NAME:         KQD$GETPROCESS
      702     8005             PURPOSE:      To allocate space from a granule
      703     8006        */
      704     8007
      705     8008
      706     8009        /*D* NAME:         KQD$GETPROCESS
      707     8010             CALL:         CALL KQD$GETPROCESS(KQ$CG,DFR$,DGRAN$);
      708     8011             INPUT:        KQ$CG - Comgroup context block
      709     8012                           DFR$ - Ptr to the defer block controlling the
      710     8013                                  current GET operation, NIL if this call
      711     8014                                  is not for the GET operation.
      712     8015                           DGRAN$ - Ptr to the page.  NIL if no page, e.g.
      713     8016                                    there was a disk error reading it.
      714     8017             DESCRIPTION:  As many pending GET requests as possible are
      715     8018                           satisfied from this page.  If not all are
      716     8019                           satisfied, the next step in the GET operation
      717     8020                           (if called on behalf of the GET operation)
      718     8021                           is initiated.
      719     8022        */
      720     8023
      721     8024
      722     8025    1   KQD$GETPROCESS: ENTRY(KQ$CG,PDBLK$,PDDA) ALTRET;  /* Never ALTRETs */
      723     8026
      724     8027
      725     8028    1         IF ADDR(PDBLK$)=ADDR(NIL) THEN
      726     8029    1           DFR$=ADDR(NIL);
      727     8030    1         ELSE
      728     8031    1           DFR$=PDBLK$;
      729     8032    1         DGRAN$=PSTA$;
      730     8033    1         CALL GETPROCESS;
      731     8034    1         RETURN;
      732     8035
      733     8036
      734     8037        %EJECT;
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:23   
      735     8038
      736     8039
      737     8040    1   ALLOC: PROC ALTRET;
      738     8041
      739     8042    2   DCL P$ PTR;
      740     8043    2   DCL AX UBIN;
      741     8044    2   DCL NAX UBIN;
      742     8045    2   DCL BX UBIN;
      743     8046    2   DCL B$ PTR;
      744     8047    2   DCL PB$ PTR;
      745     8048    2   DCL SB SBIN;
      746     8049    2   DCL AVAILCNT UBIN;
      747     8050    2   DCL BUDDIED BIT(1) ALIGNED;
      748     8051    2   DCL SIZW UBIN;
      749     8052
      750     8053
      751     8054    2         AVAILCNT=0;
      752     8055    2         BUDDIED = '0'B;
      753     8056    2         SIZW=(((SIZBYTES+3)/4+SIZEW(KQ$DBLK)+1)/2)*2;  /* # words needed */
      754     8057    2         P$=ADDR(NIL);
      755     8058    2         DBLK$=PINCRW(DGRAN$,KQ$DGRAN.AVAILX);  /* Search unsorted list */
      756     8059    3           DO WHILE(DBLK$~=DGRAN$);
      757     8060    3           IF KQ$DBLK.LREL THEN
      758     8061    4             DO; /* Latch released - see if really free yet */
      759     8062    5               DO INHIBIT;
      760     8063    5               IF KQ$DBLK.ACTCNT~=KQ$CG.STREE.ACTCNT THEN
      761     8064    6                 DO;
      762     8065    6                 CHKPARM.P$=KQ$DBLK.STA$;
      763     8066    6                 CALL KQX$CHKPTR(CHKPARM) ALTRET(RELIT);
      764     8067    6                 END;
      765     8068    5               IF KQ$DBLK.STA$->KQ$STA.LATCHCNT=KQ$DBLK.LATCHCNT THEN
      766     8069    5                 GOTO NXTDBLK;
      767     8070    5               END;
      768     8071    4   RELIT:    ;
      769     8072    4             KQ$DBLK.LREL='0'B;
      770     8073
      771     8074    4             CALL COUNT_WORDS(%NONE,%ADD);
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:24   
      772     8075                  /* A DBLK that was Latched-RELeased(LREL'd) is considered
      773     8076                     AVAILable but not FREE.  Therefore when we LREL'd it
      774     8077                     we added it to the WRDSAVAIL in the granule but not the
      775     8078                     the WRDSFREE.  Now that we are about to use this DBLK
      776     8079                     we can consider it FREE so we must add it to the number
      777     8080                     of WRDSFREE.                          */
      778     8081
      779     8082    4             KQ$DBLK.STA$=ADDR(NIL);
      780     8083    4             KQ$DGRAN.HDR.UPD='1'B;
      781     8084    4             END;
      782     8085    3           AVAILCNT=AVAILCNT+1; /* Found something */
      783     8086    3   GOTBLK: ;
      784     8087    3           SB=KQ$DBLK.SIZW-SIZW;
      785     8088    3           IF SB>=0 THEN
      786     8089    4             DO INHIBIT; /* Found one big enough */
      787     8090    4             IF SB >= KQD_MINSPLIT THEN
      788     8091    5               DO; /* Big enough to split */
      789     8092    5   SPLIT:      ;
      790     8093    5               PINCRW(DBLK$,SB)->KQ$DBLK=KQ_DBLK;
      791     8094    5               PINCRW(DBLK$,SB)->KQ$DBLK.SIZW=SIZW;
      792     8095                        /* Do this in a weird order so we don't lose
      793     8096                           space if we crash in the middle of the
      794     8097                           sequence */
      795     8098    5               KQ$DBLK.SIZW=KQ$DBLK.SIZW-SIZW;
      796     8099    5               DBLK$=PINCRW(DBLK$,KQ$DBLK.SIZW);
      797     8100    5               END;
      798     8101    4             ELSE
      799     8102    4               IF P$=ADDR(NIL) THEN
      800     8103    4                 KQ$DGRAN.AVAILX=KQ$DBLK.LINKX;
      801     8104    4               ELSE
      802     8105    4                 P$->KQ$DBLK.LINKX=KQ$DBLK.LINKX;
      803     8106    4   SETAVAIL: ;
      804     8107    4             CALL COUNT_WORDS(%SUBTRACT,%SUBTRACT);
      805     8108    4             GOTO GOTDBLK;
      806     8109    4             END;
      807     8110    3   NXTDBLK: ;
      808     8111    3           P$=DBLK$;
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:25   
      809     8112    3           DBLK$=PINCRW(DGRAN$,KQ$DBLK.LINKX);
      810     8113    3           END;
      811     8114        /**/
      812     8115        /* Didn't find any useful stuff on the unsorted list in this
      813     8116           granule.  Try the unsorted list. */
      814     8117        /**/
      815     8118    2   CHKBUDDY: ;
      816     8119    2         P$=ADDR(NIL);
      817     8120    2         DBLK$=PINCRW(DGRAN$,KQ$DGRAN.BUDDYX);
      818     8121    3           DO WHILE(DBLK$~=DGRAN$);
      819     8122    3           SB=KQ$DBLK.SIZW-SIZW;
      820     8123    3           IF SB>=0 THEN
      821     8124    4             DO;
      822     8125    4             IF SB>=KQD_MINSPLIT THEN
      823     8126    4               GOTO SPLIT;
      824     8127    4             IF P$=ADDR(NIL) THEN
      825     8128    4               KQ$DGRAN.BUDDYX=KQ$DBLK.LINKX;
      826     8129    4             ELSE
      827     8130    4               P$->KQ$DBLK.LINKX=KQ$DBLK.LINKX;
      828     8131    4             GOTO SETAVAIL;
      829     8132    4             END;
      830     8133    3           AVAILCNT=AVAILCNT+1;
      831     8134    3           P$=DBLK$;
      832     8135    3           DBLK$=PINCRW(DGRAN$,KQ$DBLK.LINKX);
      833     8136    3           END;
      834     8137        /**/
      835     8138        /* Couldn't find anything on either chain - try to buddy up. */
      836     8139        /**/
      837     8140    2         IF AVAILCNT>1 AND KQ$DGRAN.AVAILX>0 AND NOT BUDDIED THEN
      838     8141    3           DO; /* It's worth trying */
      839     8142    3           BUDDIED='1'B; /* Don't come here again */
      840     8143    3           P$=ADDR(NIL);
      841     8144    3           AX=KQ$DGRAN.AVAILX;
      842     8145    3           DBLK$=PINCRW(DGRAN$,AX);
      843     8146    4             DO WHILE(DBLK$~=DGRAN$);
      844     8147    4             KQ$DGRAN.HDR.UPD='1'B;
      845     8148    4             NAX=KQ$DBLK.LINKX; /* Remember link of this one */
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:26   
      846     8149    4             IF NOT KQ$DBLK.LREL THEN
      847     8150    5               DO INHIBIT; /* Can't buddy up latch released ones */
      848     8151    5               IF P$=ADDR(NIL) THEN
      849     8152    5                 KQ$DGRAN.AVAILX=KQ$DBLK.LINKX;
      850     8153    5               ELSE
      851     8154    5                 P$->KQ$DBLK.LINKX=KQ$DBLK.LINKX;
      852     8155    5               KQ$DBLK.LINKX=0;
      853     8156    5               IF KQ$DGRAN.BUDDYX=0 THEN
      854     8157    5                 KQ$DGRAN.BUDDYX=AX;
      855     8158    5               ELSE
      856     8159    6                 DO; /* Merge into existing sorted list */
      857     8160    6                 BX=KQ$DGRAN.BUDDYX;
      858     8161    6                 B$=PINCRW(DGRAN$,BX);
      859     8162    6                 PB$=ADDR(NIL);
      860     8163    7                   DO WHILE(BX~=0);
      861     8164    7                   IF AX<BX THEN
      862     8165    8                     DO; /* Put in front of this sorted list entry */
      863     8166    8                     KQ$DBLK.LINKX=BX;
      864     8167    8                     IF PB$=ADDR(NIL) THEN
      865     8168    8                       KQ$DGRAN.BUDDYX=AX;
      866     8169    8                     ELSE
      867     8170    8                       PB$->KQ$DBLK.LINKX=AX;
      868     8171    8                     IF AX+KQ$DBLK.SIZW=BX THEN
      869     8172    9                       DO; /* These two buddy up */
      870     8173    9                       KQ$DBLK.LINKX=B$->KQ$DBLK.LINKX;
      871     8174    9                       KQ$DBLK.SIZW=KQ$DBLK.SIZW+B$->KQ$DBLK.SIZW;
      872     8175    9                       END;
      873     8176    8                     GOTO BUDDYNXT;
      874     8177    8                     END;
      875     8178    7                   ELSE
      876     8179    7                     IF BX+B$->KQ$DBLK.SIZW=AX THEN
      877     8180    8                       DO; /* Buddy up after sorted one */
      878     8181    8                       B$->KQ$DBLK.SIZW=B$->KQ$DBLK.SIZW+KQ$DBLK.SIZW;
      879     8182    8                       IF BX+B$->KQ$DBLK.SIZW=B$->KQ$DBLK.LINKX THEN
      880     8183    9                         DO;
      881     8184    9                         T$=PINCRW(DGRAN$,B$->KQ$DBLK.LINKX);
      882     8185    9                         B$->KQ$DBLK.SIZW=B$->KQ$DBLK.SIZW+T$->KQ$DBLK.SIZW;
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:27   
      883     8186    9                         B$->KQ$DBLK.LINKX=T$->KQ$DBLK.LINKX;
      884     8187    9                         END;
      885     8188    8                       GOTO BUDDYNXT;
      886     8189    8                       END;
      887     8190    7                   BX=B$->KQ$DBLK.LINKX;
      888     8191    7                   PB$=B$;
      889     8192    7                   B$=PINCRW(DGRAN$,BX);
      890     8193    7                   END;
      891     8194    6                 PB$->KQ$DBLK.LINKX=AX;
      892     8195    6                 END;
      893     8196    5               END;
      894     8197    4             ELSE
      895     8198    4               P$=DBLK$;
      896     8199    4   BUDDYNXT: ;
      897     8200    4             AX=NAX;
      898     8201    4             DBLK$=PINCRW(DGRAN$,AX);
      899     8202    4             END;
      900     8203    3           GOTO CHKBUDDY; /* Go try again */
      901     8204    3           END;
      902     8205    2         ALTRETURN;
      903     8206
      904     8207        /**/
      905     8208    2   GOTDBLK:
      906     8209    2         KQ$DGRAN.USECNT=KQ$DGRAN.USECNT+1;
      907     8210    2         KQ$DGRAN.ACTCNT=KQ$DGRAN.ACTCNT+1;
      908     8211    2         KQ$DGRAN.HDR.UPD='1'B;  /* Set granule modified */
      909     8212    2         J=KQ$DBLK.SIZW;
      910     8213    2         KQ$DBLK=KQ_DBLK;  /* Initialize */
      911     8214    2         KQ$DBLK.SIZW=J;
      912     8215    2         KQ$DBLK.DSIZE=SIZBYTES;  /* Data size */
      913     8216    2         KQ$DBLK.ACTIVE='1'B;
      914     8217    2         KQ$DBLK.LOCK='1'B;
      915     8218        /**/
      916     8219    2         DDA.DA=ADDR(KQ$DGRAN.BTN.KEY)->WRD(0);
      917     8220    2         DDA.DISP=POFFW(DBLK$,DGRAN$)/2;
      918     8221    2         RETURN;
      919     8222
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:28   
      920     8223    2   END ALLOC;
      921     8224        %EJECT;
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:29   
      922     8225
      923     8226    1   COUNT_WORDS: PROC (AVAIL,FREE) ;
      924     8227
      925     8228    2   DCL AVAIL UBIN;   /* Add or Subtract from WRDSAVAIL */
      926     8229    2   DCL FREE UBIN;   /* Add or Subtract from WRDSFREE */
      927     8230
      928     8231    2         IF (FREE = %ADD) THEN
      929     8232    3           DO;
      930     8233    3           KQ$DGRAN.WRDSFREE=KQ$DGRAN.WRDSFREE+KQ$DBLK.SIZW;
      931     8234    3           KQ$CG.STATS.WRDSUSED = KQ$CG.STATS.WRDSUSED - KQ$DBLK.SIZW ;
      932     8235    3           IF KQ$DGRAN.WRDSFREE = %EMPTY_GRAN THEN
      933     8236    4             DO;
      934     8237    4             KQ$CG.UGRANS = KQ$CG.UGRANS - 1;
      935     8238    4             KQ$CG.NGAVAL = KQ$CG.NGAVAL + 1;
      936     8239    4             IF (KQ$CG.TRIGGERED) AND (KQ$CG.NGAVAL >=
      937     8240    4             KQ$CG.TRIGGER + KQ$CG.AUCTL.REDISKWARN)
      938     8241    4             THEN KQ$CG.TRIGGERED = '0'B;
      939     8242    4             END;
      940     8243    3           END;
      941     8244    2         ELSE
      942     8245    2           IF (FREE=%SUBTRACT) THEN
      943     8246    3             DO;
      944     8247    3             IF KQ$DGRAN.WRDSFREE = %EMPTY_GRAN THEN
      945     8248    4               DO;
      946     8249    4               KQ$CG.NGAVAL = KQ$CG.NGAVAL - 1;
      947     8250    4               KQ$CG.UGRANS = KQ$CG.UGRANS + 1;
      948     8251    4               IF (NOT KQ$CG.TRIGGERED) AND (KQ$CG.NGAVAL<=
      949     8252    4               KQ$CG.TRIGGER) THEN
      950     8253    5                 DO;
      951     8254                      %LOCK (G=KQ$CG.GATE.CG);
      952     8257    5                 KQ$CG.DELAY.DISKWARN='1'B;
      953     8258    5                 KQ$CG.TRIGGERED = '1'B;
      954     8259    5                 KQ$CG.BASEDELAY=KQ$CG.BASEDELAY+1;
      955     8260    5                 KQ_BASEDELAY=KQ_BASEDELAY+1;
      956     8261                      %UNLOCK (G=KQ$CG.GATE.CG);
      957     8264    5                 END;
      958     8265    4               END;
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:30   
      959     8266    3             KQ$DGRAN.WRDSFREE=KQ$DGRAN.WRDSFREE-KQ$DBLK.SIZW;
      960     8267    3             KQ$CG.STATS.WRDSUSED = KQ$CG.STATS.WRDSUSED + KQ$DBLK.SIZW ;
      961     8268    3             END;
      962     8269
      963     8270    2         IF (AVAIL = %ADD) THEN
      964     8271    2           KQ$DGRAN.WRDSAVAIL=KQ$DGRAN.WRDSAVAIL+KQ$DBLK.SIZW;
      965     8272    2         ELSE
      966     8273    2           IF (AVAIL=%SUBTRACT) THEN
      967     8274    2             KQ$DGRAN.WRDSAVAIL=KQ$DGRAN.WRDSAVAIL-KQ$DBLK.SIZW;
      968     8275
      969     8276    2         RETURN ;
      970     8277    2   END COUNT_WORDS;
      971     8278
      972     8279        /*F* NAME:         KQD$FETCH
      973     8280
      974     8281             PURPOSE:      Find a specific data block.
      975     8282
      976     8283        */
      977     8284
      978     8285
      979     8286
      980     8287        /*D* NAME:         KQD$FETCH
      981     8288
      982     8289             ENTRY:        KQD$FETCHR
      983     8290
      984     8291             CALL:         CALL KQD$FETCH(KQ$CG,DBLK$,DDA) ALTRET(LOC);
      985     8292
      986     8293             INPUT:        KQ$CG - Comgroup context block
      987     8294                           DBLK$ - Stamp which must be in data block
      988     8295                           DDA - Data disk address of desired block
      989     8296
      990     8297             OUTPUT:       DBLK$ - Pointer to data block
      991     8298                           DDA - Error code if ALTRET, otherwise unchanged
      992     8299
      993     8300             DESCRIPTION:
      994     8301                   Normal return:
      995     8302                           DBLK$ - Pointer to the data block
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:31   
      996     8303
      997     8304                   ALternate return:
      998     8305                           If DBLK$ is ADDR(NIL), then DDA contains the error
      999     8306                           code. A code of KQDE_NDFRBLK means the call must be
     1000     8307                           re-issued later (out of defer blocks).
     1001     8308
     1002     8309                           If DBLK$ is not ADDR(NIL), it is the pointer to
     1003     8310                           a defer block that must be passed to KQD$DEFERGO
     1004     8311                           when it is alright to proceed.
     1005     8312
     1006     8313                           FETCHR, if called by a user, will REG until the
     1007     8314                           operation completes (will never return a defer
     1008     8315                           block ptr).  If called not on behalf of a user,
     1009     8316                           will return the error KQDE_CREG if the item is
     1010     8317                           not in core.
     1011     8318
     1012     8319        */
     1013     8320
     1014     8321
     1015     8322        %EJECT;
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:32   
     1016     8323
     1017     8324
     1018     8325    1   KQD$FETCH: ENTRY(KQ$CG,PDBLK$,PDDA) ALTRET;
     1019     8326
     1020     8327    1         REGFLG=0;
     1021     8328    1         GOTO FTCH5;
     1022     8329
     1023     8330    1   KQD$FETCHR: ENTRY(KQ$CG,PDBLK$,PDDA) ALTRET;
     1024     8331
     1025     8332    1         REGFLG=1;
     1026     8333
     1027     8334    1   FTCH5: ;
     1028     8335    1         ENTFLG=%KQDC_FETCH;
     1029     8336
     1030     8337    1   FTCH8: ;
     1031     8338    1         STAMP=PSTAMP;
     1032     8339    1         DFR$=ADDR(NIL);
     1033     8340    1         DDA=PDDA;
     1034     8341
     1035     8342    1   FETCH: ;
     1036     8343    2         IF KQ_LOG.KQD THEN DO;
     1037     8344    2           LDFR$=DFR$;
     1038     8345    2           CALL KQZ$LOG(KQ$CG,%KQLOG_FETCH,,ENTFLG,
     1039     8346    2           LDFR$,DDA,REGFLG);
     1040     8347    2           END;
     1041     8348    1         DA=DDA.DA;
     1042     8349    1         KEY.DA=DA;
     1043     8350    1         KEY.GARB=0;
     1044     8351              %LOCK (G=KQ$CG.DTREE.GATE);
     1045     8354    1   FTCH10: ;
     1046     8355    1         CALL KQB$SRCH(KQ$CG.DTREE,KEY,LDGRAN$) ALTRET(FTCH20);
     1047     8356    1         DGRAN$=LDGRAN$;
     1048     8357    1         DGRAN.DISP=0;
     1049     8358    1         IF KQ$DGRAN.HDR.WRITE AND NOT KQ$DGRAN.HDR.FORCEOUT THEN
     1050     8359    1           GOTO FTCH20;  /* This page is going out - treat like not here */
     1051     8360    1         KQ$DGRAN.USECNT=KQ$DGRAN.USECNT+1;
     1052     8361    1         IF DFR$~=ADDR(NIL) THEN
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:33   
     1053     8362    2           DO CASE(ENTFLG);
     1054     8363    2             CASE(ELSE);
     1055     8364    2               CALL RELBLK;  /* Found it on second try */
     1056     8365    2             CASE(%KQDC_RENEGE,%KQDC_DEL);
     1057     8366    2           END;
     1058     8367
     1059     8368    1   FETCHDONE: ;
     1060     8369    1         DBLK$=PINCRW(DGRAN$,DDA.DISP*2);
     1061     8370    1         IF KQ$DBLK.LOCK OR (ENTFLG~=%KQDC_RENEGE AND NOT KQ$DBLK.ACTIVE) THEN
     1062     8371    2           DO;
     1063     8372    2           ERRCODE=%KQDE_STATE;
     1064     8373    2           CALL LOGERR(%KQELOG_KQD_STATE);
     1065     8374    2           IF KQ_DEBUG~=0 THEN
     1066     8375    2             CALL SC_CGCACHE;
     1067     8376    2           GOTO FTCH15;
     1068     8377    2           END;
     1069     8378    1         IF KQ$DBLK.STAMP~=STAMP THEN
     1070     8379    2           DO;
     1071     8380    2           ERRCODE=%KQDE_STMP;
     1072     8381    2           CALL LOGERR(%KQELOG_KQD_STMP,STAMP);
     1073     8382    2           IF KQ_DEBUG~=0 THEN
     1074     8383    2             CALL SC_CGCACHE;
     1075     8384    2           GOTO FTCH15;
     1076     8385    2           END;
     1077     8386    1         KQ$DGRAN.ACTCNT=KQ$DGRAN.ACTCNT+1;
     1078     8387    1         KQ$DBLK.LOCK='1'B;
     1079     8388    2           DO CASE(ENTFLG);
     1080     8389    2             CASE(%KQDC_RENEGE);
     1081     8390    2               GOTO RENEGE;
     1082     8391    2             CASE(%KQDC_DEL);
     1083     8392    2               DELFLG=%KQD_DEL;
     1084     8393    2               IF KQ$DBLK.FLNKDA~=0 AND DFR$=ADDR(NIL) THEN
     1085     8394    3                 DO;
     1086     8395    3                 CALL GETBLK ALTRET(DELNODBLK); /* Get DFRBLK at start */
     1087     8396    3                 KQ$DFRBLK.USR=0;
     1088     8397    3                 KQ$DFRBLK.GO='1'B;
     1089     8398    3                 END;
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:34   
     1090     8399    2               GOTO DELCOM4;
     1091     8400    2           END;
     1092     8401    1   FTCH12: ;
     1093     8402    1         IF DFR$~=ADDR(NIL) THEN
     1094     8403    1           GOTO FTCH19;
     1095     8404              %UNLOCK (G=KQ$CG.DTREE.GATE);
     1096     8407    1         PDBLK$=DBLK$;
     1097     8408    1         RETURN;
     1098     8409
     1099     8410    1   FTCH15: ;
     1100     8411    1         KQ$DGRAN.USECNT=KQ$DGRAN.USECNT-1;
     1101     8412    1         DBLK$=ADDR(NIL);
     1102     8413
     1103     8414    1   FTCH18: ;
     1104     8415    1         IF DFR$~=ADDR(NIL) THEN
     1105     8416    2           DO;
     1106     8417    2   FTCH19: ;
     1107     8418    2           KQ$DFRBLK.DBLK$=DBLK$;
     1108     8419    2           KQ$DFRBLK.DDA=BITBIN(DDA);
     1109     8420    2           KQ$DFRBLK.ERRCODE=ERRCODE;
     1110     8421    2           KQ$DFRBLK.EVNT='1'B;
     1111     8422    2           CALL COMP;
     1112     8423    2           RETURN;
     1113     8424    2           END;
     1114     8425              %UNLOCK (G=KQ$CG.DTREE.GATE);
     1115     8428    1         PDBLK$=ADDR(NIL);
     1116     8429    1         PSIZ=ERRCODE;
     1117     8430    1         ALTRETURN;
     1118     8431
     1119     8432
     1120     8433        /**/
     1121     8434    1   FTCH20: ;
     1122     8435    1         IF DFR$=ADDR(NIL) THEN
     1123     8436    1           IF REGFLG~=0 THEN
     1124     8437    1             IF S_TIMR~=2 AND S_CUN~=0 THEN
     1125     8438    1               CALL GETBLKR ALTRET(FTCH10);
     1126     8439    1             ELSE
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:35   
     1127     8440    1               GOTO CREG;  /* Can't REG */
     1128     8441    1           ELSE
     1129     8442    1             CALL GETBLK ALTRET(NODFRBLK);
     1130     8443        /**/
     1131     8444    1         IF ENTFLG~=%KQDC_FETCH THEN
     1132     8445    2           DO;
     1133     8446    2           KQ$DFRBLK.USR=0; /* Don't hold user if not fetch */
     1134     8447    2           KQ$DFRBLK.GO='1'B;
     1135     8448    2           END;
     1136     8449        /**/
     1137     8450    2         IF KQ_LOG.KQD THEN DO;
     1138     8451    2           LDFR$=DFR$;
     1139     8452    2           CALL KQZ$LOG(KQ$CG,%KQLOG_FTCHDFR,,ENTFLG,
     1140     8453    2           LDFR$,DDA,REGFLG);
     1141     8454    2           END;
     1142     8455        /**/
     1143     8456    1         KQ$DFRBLK.DDA=BITBIN(DDA);  /* Remember DDA */
     1144     8457    1         KQ$DFRBLK.DA=DA;
     1145     8458    1         KQ$DFRBLK.DBLK=STAMP;       /* Remember stamp */
     1146     8459    1         CALL READGRAN;
     1147     8460    1         IF ENTFLG~=%KQDC_FETCH THEN
     1148     8461    1           RETURN;
     1149     8462    1   FTCH30: ;
     1150     8463    1         IF KQ$DFRBLK.USR~=0 THEN
     1151     8464    2           DO;
     1152     8465    2           CALL SSR$REG(%SS_QA);
     1153     8466    2   FTCH40: ;
     1154     8467    2           IF NOT KQ$DFRBLK.EVNT THEN
     1155     8468    3             DO; /* Woke up when we shouldn't have */
     1156     8469    3             CALL SC_CGCACHE;
     1157     8470    3             GOTO FTCH30; /* Sleep again */
     1158     8471    3             END;
     1159     8472        /*S*  SCREECH_CODE: KQD-S$CGCACHE
     1160     8473              TYPE: SNAP
     1161     8474              MESSAGE: Error in comgroup data cache
     1162     8475        */
     1163     8476    2           ERRCODE=KQ$DFRBLK.ERRCODE;
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:36   
     1164     8477    2           DBLK$=KQ$DFRBLK.DBLK$;
     1165     8478    2           DDA=BINBIT(KQ$DFRBLK.DDA,36);
     1166     8479                %LOCK (G=KQ$CG.DTREE.GATE);
     1167     8482    2           CALL RELBLK;
     1168     8483                %UNLOCK (G=KQ$CG.DTREE.GATE);
     1169     8486    2           IF ERRCODE=0 THEN
     1170     8487    3             DO;
     1171     8488    3             PDBLK$=DBLK$;
     1172     8489    3             IF ENTFLG=%KQDC_GET THEN
     1173     8490    3               PDDA=DDA;
     1174     8491    3             RETURN;
     1175     8492    3             END;
     1176     8493    2           ELSE
     1177     8494    3             DO;
     1178     8495    3             PDBLK$=ADDR(NIL);
     1179     8496    3             PSIZ=ERRCODE;
     1180     8497    3             ALTRETURN;
     1181     8498    3             END;
     1182     8499    2           END;
     1183     8500    1         PDBLK$=DFR$;
     1184     8501    1         ALTRETURN;
     1185     8502        /**/
     1186     8503    1   DELNODBLK: ;
     1187     8504    1         KQ$DBLK.LOCK='0'B;
     1188     8505    1         KQ$DGRAN.USECNT=KQ$DGRAN.USECNT-1;
     1189     8506        /**/
     1190     8507    1   NODFRBLK: ;
     1191     8508              %UNLOCK (G=KQ$CG.DTREE.GATE);
     1192     8511    1         PDBLK$=ADDR(NIL);
     1193     8512    1         PSIZ=%KQDE_NDFRBLK;
     1194     8513    1         ALTRETURN;
     1195     8514        /**/
     1196     8515        /**/
     1197     8516    1   CREG: ;
     1198     8517              %UNLOCK (G=KQ$CG.DTREE.GATE);
     1199     8520    1         PDBLK$=ADDR(NIL);
     1200     8521    1         PSIZ=%KQDE_CREG;
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:37   
     1201     8522    1         ALTRETURN;
     1202     8523        /**/
     1203     8524        /**/
     1204     8525    1   KQD$FETCHDONE: ENTRY(KQ$CG,PDBLK$,PDDA) ALTRET;  /* Doesn't ALTRET */
     1205     8526
     1206     8527    1         DFR$=PDBLK$;
     1207     8528    1         DGRAN$=PSTA$;
     1208     8529    1         DDA=BINBIT(KQ$DFRBLK.DDA,36);
     1209     8530    1         STAMP=KQ$DFRBLK.DBLK;
     1210     8531    1         ENTFLG=KQ$DFRBLK.CODE;
     1211     8532    1         REGFLG=0;
     1212     8533    1         ERRCODE=KQ$DFRBLK.ERRCODE;
     1213     8534    1         IF ERRCODE~=0 OR KQ$DFRBLK.ABORT THEN
     1214     8535    2           DO;
     1215     8536    2           DBLK$=ADDR(NIL);
     1216     8537    2           IF DGRAN$=ADDR(NIL) THEN
     1217     8538    2             GOTO FTCH18;
     1218     8539    2           ELSE
     1219     8540    2             GOTO FTCH15;
     1220     8541    2           END;
     1221     8542        /**/
     1222     8543    2         IF KQ_LOG.KQD THEN DO;
     1223     8544    2           LDFR$=DFR$; LDBLK$=DBLK$;
     1224     8545    2           CALL KQZ$LOG(KQ$CG,%KQLOG_FTCHDONE,,ENTFLG,
     1225     8546    2           LDFR$,DDA,LDBLK$);
     1226     8547    2           END;
     1227     8548        /**/
     1228     8549    1         GOTO FETCHDONE;
     1229     8550
     1230     8551        %EJECT;
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:38   
     1231     8552
     1232     8553
     1233     8554        /*D* NAME:         KQD$DEFERGO
     1234     8555
     1235     8556              ENTRY:       KQD$DEFERWAIT
     1236     8557
     1237     8558             CALL:         CALL KQD$DEFERGO(KQ$CG,DFR$,EPTR$);
     1238     8559                           CALL KQD$DEFERWAIT(KQ$CG,DFR$,DDA);
     1239     8560
     1240     8561             INPUT:        KQ$CG - Comgroup context block
     1241     8562                           DFR$ - Ptr to defer block (which must contain
     1242     8563                                  INFO if DEFERGO).
     1243     8564                           EPTR$ - Routine to call when complete if DEFERGO
     1244     8565
     1245     8566             OUTPUT:       Nothing for DEFERGO.  For DEFERWAIT, same as
     1246     8567                           KQD$GETR or KQD$FETCHR.
     1247     8568
     1248     8569             DESCRIPTION:  Whenever FETCH, GET or any other routine
     1249     8570                           altrets indicating that the operation was
     1250     8571                           deferred, DEFERGO must be called passing
     1251     8572                           the defer block pointer returned on the original
     1252     8573                           call, and a routine that will be called when
     1253     8574                           the operation completes (if EPTR$ is ENTADDR(NIL)
     1254     8575                           the operation will be cancelled), or DEFERWAIT
     1255     8576                           must be called to wait for operation to complete.
     1256     8577
     1257     8578        */
     1258     8579
     1259     8580
     1260     8581    1   KQD$DEFERGO: ENTRY(KQ$CG,PDBLK$,PDDA) ALTRET;  /* Doesn't ALTRET */
     1261     8582
     1262     8583              %LOCK (G=KQ$CG.DTREE.GATE);
     1263     8586    1         DFR$=PDBLK$;
     1264     8587    1         ENTFLG=KQ$DFRBLK.CODE;
     1265     8588    1         KQ$DFRBLK.EPTR$=PEPTR$;
     1266     8589    1         IF KQ$DFRBLK.EPTR$=ENTADDR(NIL) THEN
     1267     8590    1           KQ$DFRBLK.ABORT='1'B;  /* Abort the process */
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:39   
     1268     8591    1         KQ$DFRBLK.GO='1'B;
     1269     8592    2         IF KQ_LOG.KQD THEN DO;
     1270     8593    2           LDFR$=DFR$; LDBLK$=DBLK$;
     1271     8594    2           CALL KQZ$LOG(KQ$CG,%KQLOG_DFRGO,,ENTFLG,
     1272     8595    2           LDFR$,LDBLK$,PEPTR$);
     1273     8596    2           END;
     1274     8597    1         CALL COMPLATER;  /* Don't comp now if EPTR */
     1275     8598    1         RETURN;
     1276     8599
     1277     8600
     1278     8601    1   KQD$DEFERWAIT: ENTRY(KQ$CG,PDBLK$,PDDA) ALTRET;
     1279     8602
     1280     8603    1         DFR$=PDBLK$;
     1281     8604    1         ENTFLG=KQ$DFRBLK.CODE;
     1282     8605    2         IF KQ_LOG.KQD THEN DO;
     1283     8606    2           LDFR$=DFR$;
     1284     8607    2           CALL KQZ$LOG(KQ$CG,%KQLOG_DFRWAIT,,ENTFLG,
     1285     8608    2           LDFR$);
     1286     8609    2           END;
     1287     8610              %LOCK (G=KQ$CG.DTREE.GATE);
     1288     8613    1         IF NOT KQ$DFRBLK.EVNT THEN
     1289     8614    2           DO; /* Operation not complete yet */
     1290     8615    2           KQ$DFRBLK.GO='1'B;
     1291     8616    2           KQ$DFRBLK.USR=S_CUN;
     1292     8617                %UNLOCK (G=KQ$CG.DTREE.GATE);
     1293     8620    2           CALL SSR$REG(%SS_QA);
     1294     8621    2           END;
     1295     8622    1         ELSE
     1296     8623                %UNLOCK   (G=KQ$CG.DTREE.GATE);
     1297     8626    1         GOTO FTCH40;
     1298     8627
     1299     8628        %EJECT;
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:40   
     1300     8629
     1301     8630
     1302     8631        /*F* NAME:         KQD$RENEGE
     1303     8632
     1304     8633             PURPOSE:      Change the status of a data block back from
     1305     8634                           latch-deleted to active.
     1306     8635
     1307     8636        */
     1308     8637
     1309     8638
     1310     8639
     1311     8640        /*D* NAME:         KQD$RENEGE
     1312     8641
     1313     8642             CALL:         CALL KQD$RENEGE(KQ$CG,STAMP,DDA) ALTRET(LOC);
     1314     8643
     1315     8644             INPUT:        KQ$CG - Comgroup context block
     1316     8645                           STAMP - Expected data block stamp
     1317     8646                           DDA - Data disc address of data block
     1318     8647
     1319     8648             DESCRIPTION:  The data block is located, it is removed from
     1320     8649                           the available chain, and it is marked active.
     1321     8650
     1322     8651        */
     1323     8652        %EJECT;
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:41   
     1324     8653
     1325     8654
     1326     8655    1   KQD$RENEGE: ENTRY(KQ$CG,PDBLK$,PDDA) ALTRET;
     1327     8656
     1328     8657
     1329     8658    1         REGFLG=1;
     1330     8659    1         ENTFLG=%KQDC_RENEGE;
     1331     8660    1         GOTO FTCH8;
     1332     8661
     1333     8662    1   RENEGE: ;
     1334     8663    1         KQ$DBLK.LOCK='0'B;
     1335     8664    1         KQ$DGRAN.USECNT=KQ$DGRAN.USECNT-1;
     1336     8665    1         IF NOT KQ$DBLK.LREL THEN
     1337     8666    1           GOTO RENEGE50;  /* Don't continue with next section */
     1338     8667    1         IF KQ$DBLK.ACTIVE THEN
     1339     8668    2           DO;
     1340     8669    2           CALL LOGERR(%KQELOG_KQD_STATE);
     1341     8670    2           IF KQ_DEBUG~=0 THEN
     1342     8671    2             CALL SC_CGCACHE;
     1343     8672    2           GOTO RENEGE50;
     1344     8673    2           END;
     1345     8674    1         KQ$DGRAN.ACTCNT=KQ$DGRAN.ACTCNT+1;
     1346     8675    1         I=POFFW(DBLK$,DGRAN$);
     1347     8676    1         J=KQ$DGRAN.AVAILX;
     1348     8677    2           DO WHILE(J~=0);  /* Run the avail chain */
     1349     8678    2           IF I=J THEN
     1350     8679    3             DO INHIBIT; /* Got it */
     1351     8680    3             IF J=KQ$DGRAN.AVAILX THEN
     1352     8681    3               KQ$DGRAN.AVAILX=KQ$DBLK.LINKX;
     1353     8682    3             ELSE
     1354     8683    3               PREVDBLK$->KQ$DBLK.LINKX=KQ$DBLK.LINKX;
     1355     8684    3             KQ$DBLK.ACTIVE='1'B;
     1356     8685    3             KQ$DBLK.LREL='0'B;
     1357     8686    3             KQ$DBLK.STA$=ADDR(NIL);
     1358     8687    3             KQ$DGRAN.HDR.UPD='1'B; /* Set granule modified */
     1359     8688
     1360     8689        /*        A DBLK that was LREL'd is considered AVAILable but not
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:42   
     1361     8690                  FREE.  Therefore, when it was LREL'd I added the size
     1362     8691                  of the DBLK to the number of the WRDSAVAIL but not to
     1363     8692                  the number of the WRDSFREE.  Therefore now that we are
     1364     8693                  REENGAGing this DBLK we only have to SUBTRACT the size
     1365     8694                  from WRDSAVAIL but not from the WRDSFREE.             */
     1366     8695
     1367     8696    3             CALL COUNT_WORDS(%SUBTRACT,%NONE) ;
     1368     8697
     1369     8698    3             GOTO DEL45;
     1370     8699    3             END;
     1371     8700    2           PREVDBLK$=PINCRW(DGRAN$,J);
     1372     8701    2           J=PREVDBLK$->KQ$DBLK.LINKX;
     1373     8702    2           END;
     1374     8703    1         CALL LOGERR(%KQELOG_KQD_RENEGE);
     1375     8704    1         IF KQ_DEBUG~=0 THEN
     1376     8705    1           CALL SC_CGCACHE; /* Data block not on avail list */
     1377     8706        /**/
     1378     8707    1   RENEGE50: ;
     1379     8708    1         DDA='0'B;
     1380     8709    1         GOTO DEL50;
     1381     8710        %EJECT;
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:43   
     1382     8711
     1383     8712
     1384     8713        /*F* NAME:         KQD$DELETE
     1385     8714
     1386     8715             PURPOSE:      Delete a data block that is locked in core
     1387     8716
     1388     8717        */
     1389     8718
     1390     8719
     1391     8720        /*D* NAME:         KQD$DELETE
     1392     8721
     1393     8722             ENTRY:        KQD$UNLOCK,KQD$LREL,KQD$UPDATED
     1394     8723
     1395     8724             CALL:         CALL KQD$DELETE(KQ$CG,DBLK$);
     1396     8725                           CALL KQD$UNLOCK(KQ$CG,DBLK$);
     1397     8726                           CALL KQD$LREL(KQ$CG,DBLK$,STA$);
     1398     8727
     1399     8728             INPUT:        KQ$CG - Comgroup context block
     1400     8729                           DBLK$ - Pointer to data block
     1401     8730                           STA$ - Pointer to station block (KQD$LREL only)
     1402     8731
     1403     8732             DESCRIPTION:  The granule's use count is decremented.  If
     1404     8733                           this is not KQD$UNLOCK, the block is added
     1405     8734                           to the granule's free list.  If KQD$LREL, the
     1406     8735                           LATCHCNT and STA$ fields in the data block
     1407     8736                           are filled in.
     1408     8737
     1409     8738        */
     1410     8739        %EJECT;
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:44   
     1411     8740
     1412     8741
     1413     8742    1   KQD$UNLOCK: ENTRY(KQ$CG,PDBLK$) ALTRET;
     1414     8743    1         DELFLG=%KQD_UNLOCK;
     1415     8744    1         GOTO DELCOM;
     1416     8745
     1417     8746    1   KQD$UPDATED: ENTRY(KQ$CG,PDBLK$) ALTRET;
     1418     8747    1         DELFLG=%KQD_UPD;
     1419     8748    1         GOTO DELCOM;
     1420     8749
     1421     8750    1   KQD$UPDATE: ENTRY(KQ$CG,PDBLK$) ALTRET;  /* Never ALTRETs */
     1422     8751    1         DBLK$=PDBLK$;
     1423     8752    1         DGRAN$=DBLK$;
     1424     8753    1         DGRAN.DISP=0;
     1425     8754    1         KQ$DGRAN.HDR.UPD='1'B;  /* Set granule updated */
     1426     8755    1         RETURN;
     1427     8756
     1428     8757    1   KQD$DELETE: ENTRY(KQ$CG,PDBLK$) ALTRET;
     1429     8758    1         DELFLG=%KQD_DEL;
     1430     8759    1         GOTO DELCOM;
     1431     8760
     1432     8761    1   KQD$LREL: ENTRY(KQ$CG,PDBLK$,PDDA) ALTRET;
     1433     8762    1         DELFLG=%KQD_LREL;
     1434     8763
     1435     8764    1   DELCOM:;
     1436     8765    1         ENTFLG=0;  /* Don't try to flink */
     1437     8766    1         REGFLG=0;  /* Don't try to REG */
     1438     8767    1         DBLK$=PDBLK$;
     1439     8768    1         DFR$=ADDR(NIL);
     1440     8769    2         IF KQ_LOG.KQD THEN DO;
     1441     8770    2           DGRAN$=DBLK$;
     1442     8771    2           DGRAN.DISP=0;
     1443     8772    2           DDA.DA=ADDR(KQ$DGRAN.BTN.KEY)->WRD(0);
     1444     8773    2           DDA.DISP=DBLK.DISP;
     1445     8774    2           LDBLK$=DBLK$;
     1446     8775    2           CALL KQZ$LOG(KQ$CG,%KQLOG_DELETE,,DELFLG,
     1447     8776    2           ,DDA,LDBLK$);
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:45   
     1448     8777    2           END;
     1449     8778              %LOCK (G=KQ$CG.DTREE.GATE);
     1450     8781
     1451     8782    1   DELCOM4: ;
     1452     8783    1         DGRAN$=DBLK$;
     1453     8784    1         DGRAN.DISP=0;
     1454     8785    1         IF NOT KQ$DBLK.ACTIVE OR NOT KQ$DBLK.LOCK OR KQ$DBLK.LREL THEN
     1455     8786    2           DO;
     1456     8787    2   DEL30:  ;
     1457     8788    2           CALL LOGERR(%KQELOG_KQD_DSTATE);
     1458     8789    2           IF KQ_DEBUG~=0 THEN
     1459     8790    2             CALL SC_CGCACHE;
     1460     8791    2           DDA='0'B;
     1461     8792    2           GOTO DEL50;
     1462     8793    2           END;
     1463     8794    1         ELSE IF KQ$DGRAN.USECNT = 0 THEN
     1464     8795    1             GOTO DEL30;
     1465     8796    1         KQ$DBLK.LOCK='0'B;
     1466     8797    1         KQ$DGRAN.USECNT=KQ$DGRAN.USECNT-1;
     1467     8798    1         KQ$DGRAN.ACTCNT=KQ$DGRAN.ACTCNT+1;
     1468     8799    2           DO CASE(DELFLG);
     1469     8800    2             CASE(%KQD_UPD);
     1470     8801    2               KQ$DGRAN.HDR.UPD='1'B;
     1471     8802    2             CASE(%KQD_DEL,%KQD_LREL);
     1472     8803    3                 DO INHIBIT;
     1473     8804    3                 KQ$DBLK.LINKX=KQ$DGRAN.AVAILX;
     1474     8805    3                 KQ$DGRAN.AVAILX=POFFW(DBLK$,DGRAN$);
     1475     8806    3                 KQ$DGRAN.HDR.UPD='1'B; /* Set granule modified */
     1476     8807    3                 KQ$DBLK.ACTIVE='0'B;
     1477     8808    3                 END;
     1478     8809    2               IF DELFLG=%KQD_LREL THEN
     1479     8810    3                 DO; /* Latch release */
     1480     8811    3                 KQ$DBLK.LATCHCNT=PSTA$->KQ$STA.LATCHCNT;
     1481     8812    3                 KQ$DBLK.STA$=PSTA$;
     1482     8813    3                 KQ$DBLK.LREL='1'B;
     1483     8814    3                 KQ$DBLK.ACTCNT=KQ$CG.STREE.ACTCNT;
     1484     8815                    /* Since this DBLK was LREL'd, it is considered AVAILable
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:46   
     1485     8816                       But no FREE.  Therefore only add it to the WRDSAVAIL
     1486     8817                       not to the WRDSFREE.  It will be added to WRDSFREE in
     1487     8818                       ALLOC when we re-use this DBLK for something else.  It
     1488     8819                       will be SUBTRACTED from WRDSAVAIL in REENGAGE if we
     1489     8820                       REENGAGE it.                           */
     1490     8821
     1491     8822    3                 CALL COUNT_WORDS(%ADD,%NONE);
     1492     8823    3                 END ;
     1493     8824    2               ELSE
     1494     8825                /* Since this DBLK was DELeted and not LREL'd, it is both
     1495     8826                   AVAILable and FREE.  Therefore ADD the size to both the
     1496     8827                   WRDSAVAIL and WRDSFREE in the granule.             */
     1497     8828
     1498     8829    2                 CALL COUNT_WORDS(%ADD,%ADD);
     1499     8830
     1500     8831    2           END;
     1501     8832    1   DEL45: ;
     1502     8833    2           DO CASE(ENTFLG);
     1503     8834    2             CASE(%KQDC_RENEGE,%KQDC_DEL);
     1504     8835    2               DDA=BINBIT(KQ$DBLK.FLNKDA,36);
     1505     8836    2             CASE(ELSE);
     1506     8837    2               DDA='0'B;
     1507     8838    2           END;
     1508     8839    1   DEL50: ;
     1509     8840    1         IF DDA='0'B AND DFR$~=ADDR(NIL) THEN
     1510     8841    1           CALL RELBLK;
     1511     8842    1         IF KQ$DGRAN.USECNT=0 THEN
     1512     8843    2           DO;
     1513     8844    2           IF KQ$CG.DELAY.NEEDPG OR KQ$CG.CURDATAPGS>KQ$CG.MAXDATAPGS THEN
     1514     8845    2             KQ$DGRAN.HDR.FORCEOUT='0'B;
     1515     8846    2           ELSE
     1516     8847    2             IF NOT KQ$DGRAN.HDR.FORCEOUT THEN
     1517     8848    2               GOTO DEL55;
     1518     8849    2           CALL REMPAGE ALTRET(DEL60);
     1519     8850    2           CALL RELPAGE ALTRET(DEL60);
     1520     8851    2           END;
     1521     8852    1   DEL55: ;
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:47   
     1522     8853              %UNLOCK (G=KQ$CG.DTREE.GATE);
     1523     8856    1   DEL60: ;
     1524     8857    1         IF DDA~='0'B THEN
     1525     8858    1           GOTO FETCH;  /* Do next segment */
     1526     8859    1         RETURN;
     1527     8860        %EJECT;
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:48   
     1528     8861
     1529     8862
     1530     8863        /*F* NAME:         KQD$DELDDA
     1531     8864
     1532     8865             PURPOSE:      Delete a data block given a data disk address
     1533     8866
     1534     8867        */
     1535     8868
     1536     8869
     1537     8870        /*D* NAME:         KQD$DELDDA
     1538     8871
     1539     8872             CALL:         CALL KQD$DELDDA(KQ$CG,STAMP,DDA);
     1540     8873
     1541     8874             INPUT:        KQ$CG - Comgroup context block
     1542     8875                           STAMP - Expected data stamp
     1543     8876                           DDA   - Data disk address
     1544     8877
     1545     8878             DESCRIPTION:  Deletes the data block whether or not the
     1546     8879                           block is in core.
     1547     8880
     1548     8881        */
     1549     8882        %EJECT;
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:49   
     1550     8883
     1551     8884
     1552     8885    1   KQD$DELDDA: ENTRY(KQ$CG,PDBLK$,PDDA) ALTRET;
     1553     8886
     1554     8887    1         REGFLG=0;
     1555     8888    1         ENTFLG=%KQDC_DEL;
     1556     8889    1         GOTO FTCH8;
     1557     8890
     1558     8891        %EJECT;
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:50   
     1559     8892
     1560     8893
     1561     8894        /*D* NAME:         GETBLK
     1562     8895
     1563     8896             CALL:         CALL GETBLK ALTRET(LOC);
     1564     8897
     1565     8898             OUTPUT:       DFR$ - Ptr to a defer block
     1566     8899
     1567     8900             DESCRIPTION:  Obtains a defer block from the chain of avail
     1568     8901                           ones.  If one is not available, will ALTRET.
     1569     8902
     1570     8903        */
     1571     8904
     1572     8905
     1573     8906        /*D* NAME:         RELBLK
     1574     8907
     1575     8908             CALL:         CALL RELBLK ALTRET(LOC);
     1576     8909
     1577     8910             INPUT:        DFR$ - Ptr to defer block
     1578     8911
     1579     8912             DESCRIPTION:  Releases a defer block.
     1580     8913
     1581     8914        */
     1582     8915
     1583     8916
     1584     8917    1   GETBLK: PROC ALTRET;
     1585     8918
     1586     8919        /**/
     1587     8920        /* LOCAL AUTO */
     1588     8921        /**/
     1589     8922    2   DCL ENTF UBIN;
     1590     8923    2   DCL FLG UBIN;
     1591     8924
     1592     8925    2         ENTF=0;
     1593     8926    2         GOTO GET10;
     1594     8927
     1595     8928    2   GETBLKR: ENTRY ALTRET;
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:51   
     1596     8929
     1597     8930    2         ENTF=1;
     1598     8931
     1599     8932    2   GET10: ;
     1600     8933    2         FLG=0;
     1601     8934        /**/
     1602     8935    2   GET20: ;
     1603     8936    2         IF KQ$CG.DFRFREEHD$~=ADDR(NIL) THEN
     1604     8937    3           DO;
     1605     8938    3           DFR$=KQ$CG.DFRFREEHD$;
     1606     8939    3           KQ$CG.DFRFREEHD$=KQ$DFRBLK.LNK$;
     1607     8940    3           IF KQ$CG.DFRFREEHD$=ADDR(NIL)
     1608     8941    3           THEN KQ$CG.DFRFREETL$=ADDR(NIL);
     1609     8942    3           KQ$DFRBLK=KQ_DFRBLK;
     1610     8943    3           IF REGFLG~=0 AND S_TIMR~=2 THEN
     1611     8944    4             DO;
     1612     8945    4             KQ$DFRBLK.USR=S_CUN;
     1613     8946    4             KQ$DFRBLK.GO='1'B;
     1614     8947    4             END;
     1615     8948    3           KQ$DFRBLK.DA=DA;
     1616     8949    3           KQ$DFRBLK.CODE=ENTFLG;
     1617     8950    4           IF KQ_LOG.DFR THEN DO;
     1618     8951    4             LDFR$=DFR$;
     1619     8952    4             CALL KQZ$LOG(KQ$CG,%KQLOG_DFRGET,,ENTFLG,LDFR$,DA) ALTRET(LOG1);
     1620     8953    4             RETURN;  /* Never comes here */
     1621     8954    4   LOG1:     END;
     1622     8955    3           IF FLG=0 THEN
     1623     8956    3             RETURN;
     1624     8957    3           ELSE
     1625     8958    4             DO;
     1626     8959    4             ALTRETURN;
     1627     8960    4             END;
     1628     8961    3           END;
     1629     8962        /**/
     1630     8963    2         KQ$CG.STATS.NODFRS=KQ$CG.STATS.NODFRS+1;
     1631     8964    2         IF ENTF~=0 THEN
     1632     8965    3           DO;
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:52   
     1633     8966                %UNLOCK (G=KQ$CG.DTREE.GATE);
     1634     8969    3           CALL SSR$REG(%SS_SL,,1);
     1635     8970                %LOCK (G=KQ$CG.DTREE.GATE);
     1636     8973    3           FLG=1;
     1637     8974    3           GOTO GET20;
     1638     8975    3           END;
     1639     8976        /**/
     1640     8977    2         DFR$=ADDR(NIL);
     1641     8978    2         ALTRETURN;
     1642     8979
     1643     8980
     1644     8981    2   RELBLK: ENTRY ALTRET;
     1645     8982
     1646     8983    3         IF KQ_LOG.DFR THEN DO;
     1647     8984    3           LDFR$=DFR$; FLG=KQ$DFRBLK.CODE;
     1648     8985    3           CALL KQZ$LOG(KQ$CG,%KQLOG_DFRREL,,FLG,LDFR$) ALTRET(LOG2);
     1649     8986    3           RETURN;  /* Never comes here */
     1650     8987    3   LOG2:   END;
     1651     8988    2         KQ$DFRBLK.LNK$=ADDR(NIL);
     1652     8989    2         IF KQ$CG.DFRFREETL$=ADDR(NIL)
     1653     8990    2         THEN KQ$CG.DFRFREEHD$=DFR$;
     1654     8991    2         ELSE KQ$CG.DFRFREETL$->KQ$DFRBLK.LNK$=DFR$;
     1655     8992    2         KQ$CG.DFRFREETL$=DFR$;
     1656     8993    2         DFR$=ADDR(NIL);
     1657     8994    2         RETURN;
     1658     8995
     1659     8996    2   END GETBLK;
     1660     8997        %EJECT;
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:53   
     1661     8998
     1662     8999
     1663     9000        /*F* NAME:         KQD$RELDFR
     1664     9001
     1665     9002             PURPOSE:      Release a defer block
     1666     9003
     1667     9004        */
     1668     9005
     1669     9006
     1670     9007        /*D* NAME:         KQD$RELDFR
     1671     9008
     1672     9009             CALL:         CALL KQD$RELDFR(KQ$CG,DFR$);
     1673     9010
     1674     9011             INPUT:        KQ$CG - Context block
     1675     9012                           DFR$ - Ptr to defer block
     1676     9013
     1677     9014             DESCRIPTION:  Releases the specified defer block.  Must be
     1678     9015                           called with KQ$CG.DTREE.GATE locked.
     1679     9016
     1680     9017        */
     1681     9018
     1682     9019
     1683     9020    1   KQD$RELDFR: ENTRY(KQ$CG,PDBLK$) ALTRET;  /* Never ALTRETs */
     1684     9021
     1685     9022
     1686     9023    1         DFR$=PDBLK$;
     1687     9024    1         CALL RELBLK;
     1688     9025    1         RETURN;
     1689     9026        %EJECT;
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:54   
     1690     9027
     1691     9028
     1692     9029        /*D* NAME:         READGRAN
     1693     9030
     1694     9031             CALL:         CALL READGRAN;
     1695     9032
     1696     9033             INPUT:        DA - disk address to read
     1697     9034                           DFR$ - Ptr to defer block
     1698     9035
     1699     9036             DESCRIPTION:  The lists of pending requests are searched for
     1700     9037                           this disk address.  If found, this request is
     1701     9038                           added to the appropriate list.  If not found,
     1702     9039                           a page is obtained and the I/O started.
     1703     9040
     1704     9041        */
     1705     9042
     1706     9043
     1707     9044    1   READGRAN: PROC;
     1708     9045
     1709     9046
     1710     9047        /**/
     1711     9048        /* LOCAL AUTO */
     1712     9049        /**/
     1713     9050    2   DCL P$ PTR;
     1714     9051    2   DCL Q$ PTR;
     1715     9052        /**/
     1716     9053        /* BASED STRUCTURES */
     1717     9054        /**/
     1718     9055        %N$REQ (STCLASS="BASED(Q$)");
     1719     9113
     1720     9114    2         IF DA<FM_FRZERO THEN
     1721     9115    2           CALL SC_CGCACHE;  /* Illegal disk address */
     1722     9116
     1723     9117    2         P$=KQ$CG.IOHD$;
     1724     9118    3           DO WHILE(P$~=ADDR(NIL));
     1725     9119    3           IF DA=P$->KQ$DFRBLK.DA AND P$->KQ$DFRBLK.CODE~=%KQDC_WRITE THEN
     1726     9120    4             DO;
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:55   
     1727     9121    4             KQ$CG.IOTL$->KQ$DFRBLK.LNK$=DFR$;
     1728     9122    4             KQ$CG.IOTL$=DFR$;
     1729     9123    4             KQ$DFRBLK.LNK$=ADDR(NIL);
     1730     9124                  %UNLOCK (G=KQ$CG.DTREE.GATE);
     1731     9127    4             RETURN;
     1732     9128    4             END;
     1733     9129    3           P$=P$->KQ$DFRBLK.LNK$;
     1734     9130    3           END;
     1735     9131        /**/
     1736     9132    2         P$=KQ$CG.NEEDPGHD$;
     1737     9133    3           DO WHILE(P$~=ADDR(NIL));
     1738     9134    3           IF DA=P$->KQ$DFRBLK.DA THEN
     1739     9135    4             DO;
     1740     9136    4             KQ$CG.NEEDPGTL$->KQ$DFRBLK.LNK$=DFR$;
     1741     9137    4             KQ$CG.NEEDPGTL$=DFR$;
     1742     9138    4             KQ$CG.NEEDPGCNT=KQ$CG.NEEDPGCNT+1;
     1743     9139    4             KQ$DFRBLK.LNK$=ADDR(NIL);
     1744     9140                  %UNLOCK (G=KQ$CG.DTREE.GATE);
     1745     9143    4             RETURN;
     1746     9144    4             END;
     1747     9145    3           P$=P$->KQ$DFRBLK.LNK$;
     1748     9146    3           END;
     1749     9147        /**/
     1750     9148    2         P$=KQ$CG.IOQHD$;
     1751     9149    3           DO WHILE(P$~=ADDR(NIL));
     1752     9150    3           IF DA=P$->KQ$DFRBLK.DA AND P$->KQ$DFRBLK.CODE~=%KQDC_WRITE THEN
     1753     9151    4             DO;
     1754     9152    4             KQ$CG.IOQTL$->KQ$DFRBLK.LNK$=DFR$;
     1755     9153    4             KQ$CG.IOQTL$=DFR$;
     1756     9154    4             KQ$DFRBLK.LNK$=ADDR(NIL);
     1757     9155                  %UNLOCK (G=KQ$CG.DTREE.GATE);
     1758     9158    4             RETURN;
     1759     9159    4             END;
     1760     9160    3           P$=P$->KQ$DFRBLK.LNK$;
     1761     9161    3           END;
     1762     9162        /**/
     1763     9163        /* This granule is not already being read.  Get a page and
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:56   
     1764     9164           read it in.  */
     1765     9165        /**/
     1766     9166    2         CALL GETPAGE ALTRET(PGALT);
     1767     9167        /**/
     1768     9168    2         KQ$DFRBLK.LNK$=ADDR(NIL);
     1769     9169    2         IF KQ$CG.IOTL$=ADDR(NIL) THEN
     1770     9170    2           KQ$CG.IOHD$=DFR$;
     1771     9171    2         ELSE
     1772     9172    2           KQ$CG.IOTL$->KQ$DFRBLK.LNK$=DFR$;
     1773     9173    2         KQ$CG.IOTL$=DFR$;
     1774     9174        /**/
     1775     9175              %UNLOCK (G=KQ$CG.DTREE.GATE);
     1776     9178        /**/
     1777     9179
     1778     9180    2   READGRAN5: ENTRY;
     1779     9181
     1780     9182    2         KQ$DFRBLK.DGRAN$=DGRAN$;
     1781     9183    2         CALL NIQ$GETNR(Q$) ALTRET(NOQENTS);
     1782     9184    2   READGRAN8: ;
     1783     9185    3         IF KQ_LOG.DCIO THEN DO;
     1784     9186    3           LDFR$=DFR$; LDGRAN$=DGRAN$;
     1785     9187    3           CALL KQZ$LOG(KQ$CG,%KQLOG_DCREAD,,,LDFR$,DA,LDGRAN$)
     1786     9188    3           ALTRET(LOG1);
     1787     9189    3           RETURN;  /* Never comes here */
     1788     9190    3   LOG1:   END;
     1789     9191        /**/
     1790     9192    2         IF KQ$DGRAN.BTN.KEY~=' ' THEN
     1791     9193    2           CALL SC_CGCACHESCR;  /* This is not an initialized page */
     1792     9194              %LOCK (G=KQ$CG.GATE.CG);
     1793     9197    2         KQ$CG.IOCNT=KQ$CG.IOCNT+1;
     1794     9198              %UNLOCK (G=KQ$CG.GATE.CG);
     1795     9201    2         N$REQ.BUF$=DGRAN$;
     1796     9202    2         N$REQ.OPFLG=OP_BPF|OP_EA;
     1797     9203    2         P$=KQ$CG.CFU$;
     1798     9204    2         N$REQ.BUFSIZE=1024*4;
     1799     9205    2         N$REQ.FC=%N_RDBIN;
     1800     9206    2         N$REQ.EAENTRY=ENTADDR(KQE$RDEA);
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:57   
     1801     9207    2         N$REQ.EAINFOP$=DFR$;
     1802     9208    2         N$REQ.EAINFOXP$=ADDR(KQ$CG);
     1803     9209    2         CALL FAF$FRTOSRNJ(DA,N$REQ.DLA,P$) ALTRET(ERR);
     1804     9210    2         CALL FAF$SRTODR(N$REQ.DLA,KQ$CG.SETX) ALTRET(ERR);
     1805     9211    2         DGRAN$->WRD(0)=BITBIN('112233445566'O);
     1806     9212    2         IF N$REQ.IOFLG.IOS ~= '1'B THEN
     1807     9213    3           DO;
     1808     9214    3           CALL NIQ$GETSNR(N$REQ.IOS$) ALTRET(NOSENTS);
     1809     9215    3           N$REQ.IOFLG.IOS='1'B;
     1810     9216    3           END;
     1811     9217    2         CALL NIO$QUE(N$REQ) ALTRET(NOSENTS);
     1812     9218    2         KQ$CG.STATS.DISCRDS=KQ$CG.STATS.DISCRDS+1;
     1813     9219        /**/
     1814     9220    2   PGALT: ;
     1815     9221    2         RETURN;
     1816     9222        /**/
     1817     9223    2   NOSENTS: ;  /* NIO$QUE ALTRETURNed saying no IOS packets. Put this guy on    */
     1818     9224                    /* the IOQHD$ list to try again later                            */
     1819     9225              %LOCK (G=KQ$CG.GATE.CG);
     1820     9228    2         KQ$CG.IOCNT=KQ$CG.IOCNT-1;
     1821     9229              %UNLOCK (G=KQ$CG.GATE.CG);
     1822     9232    2         CALL NIQ$REL(Q$);
     1823     9233        /**/
     1824     9234    2   NOQENTS: ;
     1825     9235              %LOCK (G=KQ$CG.DTREE.GATE);
     1826     9238    2         T$=ADDR(NIL);
     1827     9239    2         P$=KQ$CG.IOHD$;
     1828     9240    3           DO WHILE(P$~=ADDR(NIL));
     1829     9241    3           IF P$=DFR$ THEN
     1830     9242    4             DO;
     1831     9243    4             IF T$=ADDR(NIL) THEN
     1832     9244    4               KQ$CG.IOHD$=KQ$DFRBLK.LNK$;
     1833     9245    4             ELSE
     1834     9246    4               T$->KQ$DFRBLK.LNK$=KQ$DFRBLK.LNK$;
     1835     9247    4             IF KQ$CG.IOTL$=DFR$ THEN
     1836     9248    4               KQ$CG.IOTL$=T$;
     1837     9249    4             IF KQ$CG.IOQHD$=ADDR(NIL) THEN
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:58   
     1838     9250    4               KQ$CG.IOQHD$=DFR$;
     1839     9251    4             ELSE
     1840     9252    4               KQ$CG.IOQTL$->KQ$DFRBLK.LNK$=DFR$;
     1841     9253    4             KQ$CG.IOQTL$=DFR$;
     1842     9254    4             KQ$DFRBLK.LNK$=ADDR(NIL);
     1843     9255                  %UNLOCK (G=KQ$CG.DTREE.GATE);
     1844     9258    4             RETURN;
     1845     9259    4             END;
     1846     9260    3           ELSE
     1847     9261    4             DO;
     1848     9262    4             T$=P$;
     1849     9263    4             P$=P$->KQ$DFRBLK.LNK$;
     1850     9264    4             END;
     1851     9265    3           END;
     1852     9266    2         CALL SC_CGCACHESCR;
     1853     9267    2         RETURN;
     1854     9268        /**/
     1855     9269    2   ERR:  ;
     1856     9270    2         CALL SC_CGCACHE;
     1857     9271    2         KQ$DFRBLK.ERRCODE=%KQDE_BDDA;
     1858     9272    2         N$REQ.TYC='0'B;  /* Force RDEA to think I/O didn't work */
     1859     9273    2         CALL KQE$RDEAERR(N$REQ);  /* Simulate interrupt */
     1860     9274    2         CALL NIQ$REL(Q$);
     1861     9275    2         RETURN;
     1862     9276        /**/
     1863     9277        /**/
     1864     9278    2   READGRANSTRTIO: ENTRY;
     1865     9279        /**/
     1866     9280    2         DFR$=PDBLK$;
     1867     9281    2         Q$=PSTA$;
     1868     9282    2         DGRAN$=KQ$DFRBLK.DGRAN$;
     1869     9283    2         DA=KQ$DFRBLK.DA;
     1870     9284    2         GOTO READGRAN8;
     1871     9285        /**/
     1872     9286    2   END READGRAN;
     1873     9287        %EJECT;
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:59   
     1874     9288        /*F* NAME:            KQD$STARTIO
     1875     9289
     1876     9290             CALL:            CALL KQD$STARTIO(KQ$CG,DFR$,Q$);
     1877     9291
     1878     9292             INPUT:           KQ$CG - Context block
     1879     9293                              DFR$ - Defer block to start read for
     1880     9294                              Q$ - IOQ packet to use
     1881     9295
     1882     9296             DESCRIPTION:     A read is started for the indicated defer block.
     1883     9297
     1884     9298        */
     1885     9299
     1886     9300
     1887     9301
     1888     9302    1   KQD$STARTIO: ENTRY(KQ$CG,PDBLK$,PDDA) ALTRET;
     1889     9303
     1890     9304    1         CALL READGRANSTRTIO;
     1891     9305    1         RETURN;
     1892     9306        %EJECT;
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:60   
     1893     9307
     1894     9308
     1895     9309        /*D* NAME:         WRITEGRAN
     1896     9310
     1897     9311             CALL:         CALL WRITEGRAN(GRAN$,DA,DFR$,Q$);
     1898     9312
     1899     9313             INPUT:        GRAN$ - Ptr to page
     1900     9314                           DA - Disk address
     1901     9315                           DFR$ - Ptr to defer block for this write
     1902     9316                           Q$ - Ptr to a queue packet
     1903     9317
     1904     9318             DESCRIPTION:  Writes the page to the specified disk address.
     1905     9319                           Must be called with page removed from all
     1906     9320                           appropriate core chains.
     1907     9321
     1908     9322        */
     1909     9323
     1910     9324
     1911     9325    1   WRITEGRAN: PROC(DGRAN$,DA,DFR$,Q$) ALTRET;
     1912     9326
     1913     9327
     1914     9328        /**/
     1915     9329        /* PARAMETERS */
     1916     9330        /**/
     1917     9331    2   DCL DGRAN$ PTR;
     1918     9332    2   DCL DA UBIN;
     1919     9333    2   DCL DFR$ PTR;
     1920     9334    2   DCL Q$ PTR;
     1921     9335        /**/
     1922     9336        /* BASED STRUCTURES */
     1923     9337        /**/
     1924     9338        %N$REQ (STCLASS="BASED(Q$)");
     1925     9396
     1926     9397        /**/
     1927     9398        /* LOCAL AUTO */
     1928     9399        /**/
     1929     9400    2   DCL I$ PTR;
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:61   
     1930     9401
     1931     9402
     1932     9403            %LOCK (G=KQ$CG.GATE.CG);
     1933     9406    2         KQ$CG.IOCNT=KQ$CG.IOCNT+1;
     1934     9407              %UNLOCK (G=KQ$CG.GATE.CG);
     1935     9410        /**/
     1936     9411    2         CALL SSS$SYSTIME(KQ$DGRAN.HDR.WRITEUTS);
     1937     9412        /**/
     1938     9413    2         N$REQ.BUF$=DGRAN$;
     1939     9414    2         N$REQ.OPFLG=OP_BPF|OP_EA;
     1940     9415    2         N$REQ.BUFSIZE=1024*4;
     1941     9416    2         N$REQ.NOALT = '1'B;
     1942     9417    2         I$=KQ$CG.CFU$;
     1943     9418    2         CALL FAF$FRTOSRNJ(DA,N$REQ.DLA,I$) ALTRET(ERR);
     1944     9419    2         CALL FAF$SRTODR(N$REQ.DLA,KQ$CG.SETX) ALTRET(ERR);
     1945     9420    2         IF FM_WRCMP=0 THEN
     1946     9421    2           N$REQ.FC=%N_WRBIN;
     1947     9422    2         ELSE
     1948     9423    2           N$REQ.FC=%N_WRCMP;
     1949     9424    2         N$REQ.EAENTRY=ENTADDR(KQE$WREA);
     1950     9425    2         N$REQ.EAINFOP$=DGRAN$;
     1951     9426    2         N$REQ.EAINFOXP$=ADDR(KQ$CG);
     1952     9427    2         KQ$DGRAN.DFR$=DFR$;
     1953     9428    3         CALL NIO$QUE(N$REQ) WHENALTRETURN DO; ALTRETURN; END;
     1954     9429    2         KQ$CG.STATS.DISCWRS=KQ$CG.STATS.DISCWRS+1;
     1955     9430    2         RETURN;
     1956     9431        /**/
     1957     9432    2   ERR:  ;
     1958     9433    2         CALL SC_CGCACHESCR;
     1959     9434    2         GOTO ERR;
     1960     9435        /**/
     1961     9436    2   END WRITEGRAN;
     1962     9437        %EJECT;
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:62   
     1963     9438
     1964     9439
     1965     9440        /*D* NAME:         GETPAGE
     1966     9441
     1967     9442             CALL:         CALL GETPAGE ALTRET(LOC);
     1968     9443
     1969     9444             INPUT:        DFR$ - Ptr to defer block
     1970     9445
     1971     9446             OUTPUT:       If normal return, DGRAN$ is pointer to page.
     1972     9447                           If ALTRET, ERRCODE contains the error code.  Zero
     1973     9448                           indicates that the get was deferred, in which case
     1974     9449                           DFR$ points to the defer block.
     1975     9450
     1976     9451             DESCRIPTION:  KQM$GETP is called to allocate a page.  If one
     1977     9452                           is not available, the disk cache is searched to
     1978     9453                           find one.  If it is necessary to write out a page,
     1979     9454                           the write is initiated.  If no pages can be found
     1980     9455                           to throw out, the defer block is added to the
     1981     9456                           list of operations needing a page.
     1982     9457
     1983     9458        */
     1984     9459
     1985     9460
     1986     9461    1   GETPAGE: PROC ALTRET;
     1987     9462
     1988     9463
     1989     9464        /**/
     1990     9465        /* LOCAL AUTO */
     1991     9466        /**/
     1992     9467    2   DCL I SBIN;
     1993     9468    2   DCL P$ PTR;
     1994     9469
     1995     9470    2         IF KQ$CG.DATAFREE$~=ADDR(NIL) THEN
     1996     9471    3           DO;
     1997     9472    3           DGRAN$=KQ$CG.DATAFREE$;
     1998     9473    3           KQ$CG.DATAFREE$=KQ$DGRAN.FLINK$;
     1999     9474    3           END;
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:63   
     2000     9475    2         ELSE
     2001     9476    3           DO;
     2002     9477    3           IF KQ$CG.CURDATAPGS>=KQ$CG.MAXDATAPGS THEN
     2003     9478    3             GOTO NOPAGE;
     2004     9479    3           CALL KQM$GETP(KQ$CG,LDGRAN$,I) ALTRET(NOPAGE);
     2005     9480    3           DGRAN$=LDGRAN$;
     2006     9481    3           KQ$CG.CURDATAPGS=KQ$CG.CURDATAPGS+1;
     2007     9482    3           END;
     2008     9483        /**/
     2009     9484    2   BLDHDR: ;
     2010     9485    2         KQ$DGRAN=KQ_IDGRAN;
     2011     9486    2         KQ$GRAN=KQ$CG.GRAN;
     2012     9487    2         KQ$DGRAN.HDR.PTYP=%KQ_PTYP_DATA;
     2013     9488    2         KQ$DGRAN.HDR.GTYP=%KQ_PTYP_DATA;
     2014     9489    2         KQ$DGRAN.HDR.SELF$=DGRAN$;
     2015     9490    2         RETURN;
     2016     9491        /**/
     2017     9492
     2018     9493    2   NOPAGE: ;
     2019     9494    2         ERRCODE=0;
     2020     9495        /**/
     2021     9496    2         DGRAN$=KQ$CG.AVAIL.TL$;
     2022     9497    3           DO WHILE(DGRAN$~=ADDR(NIL));
     2023     9498    4           IF KQ$DGRAN.USECNT=0 THEN DO;
     2024     9499    4             KQ$DGRAN.HDR.FORCEOUT='0'B;
     2025     9500    4             CALL REMPAGENP ALTRET(ALT);
     2026     9501    4             GOTO BLDHDR;
     2027     9502    4             END;
     2028     9503    3           DGRAN$=KQ$DGRAN.BLINK$;
     2029     9504    3           END;
     2030     9505        /**/
     2031     9506    2         IF KQ$CG.NEEDPGTL$=ADDR(NIL) THEN
     2032     9507    2           KQ$CG.NEEDPGHD$=DFR$;
     2033     9508    2         ELSE
     2034     9509    2           KQ$CG.NEEDPGTL$->KQ$DFRBLK.LNK$=DFR$;
     2035     9510    2         KQ$DFRBLK.LNK$=ADDR(NIL);
     2036     9511    2         KQ$CG.NEEDPGTL$=DFR$;
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:64   
     2037     9512    2         KQ$CG.NEEDPGCNT=KQ$CG.NEEDPGCNT+1;
     2038     9513              %UNLOCK (G=KQ$CG.DTREE.GATE);
     2039     9516              %LOCK (G=KQ$CG.GATE.CG);
     2040     9519    2         KQ$CG.DELAY.NEEDPG='1'B;
     2041     9520              %UNLOCK (G=KQ$CG.GATE.CG);
     2042     9523    2   ALT:  ALTRETURN;
     2043     9524    2   END GETPAGE;
     2044     9525        %EJECT;
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:65   
     2045     9526
     2046     9527
     2047     9528        /*D* NAME:         REMPAGE
     2048     9529
     2049     9530             CALL:         CALL REMPAGE ALTRET(LOC);
     2050     9531
     2051     9532             INPUT:        DGRAN$ - Ptr to a data cache page to throw out
     2052     9533
     2053     9534             DESCRIPTION:  The specified page must have a USECNT of zero.
     2054     9535                           The page is removed from the AVAIL chain.
     2055     9536                           If it is updated, it is written out.  Routine
     2056     9537                           ALTRETs if it writes it out.
     2057     9538
     2058     9539        */
     2059     9540
     2060     9541
     2061     9542    1   REMPAGE: PROC ALTRET;
     2062     9543
     2063     9544        /**/
     2064     9545        /* AUTO */
     2065     9546        /**/
     2066     9547    2   DCL ENTF UBIN;
     2067     9548    2   DCL TDFR$ PTR;
     2068     9549    2   DCL DA UBIN;
     2069     9550    2   DCL Q$ PTR;
     2070     9551    2   DCL ADDFLG UBIN;
     2071     9552
     2072     9553    2         ENTF=0;
     2073     9554    2         GOTO REMP;
     2074     9555
     2075     9556    2   REMPAGENP: ENTRY ALTRET;
     2076     9557
     2077     9558    2         ENTF=1;
     2078     9559
     2079     9560    2   REMP: ;
     2080     9561    2         DA=ADDR(KQ$DGRAN.BTN.KEY)->WRD(0);
     2081     9562    2         TDFR$=DFR$;
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:66   
     2082     9563        /**/
     2083     9564    2         IF NOT KQ$DGRAN.HDR.EMPTYLIST AND NOT KQ$DGRAN.HDR.FORCEOUT AND
     2084     9565    2         KQ$DGRAN.WRDSAVAIL>=100 THEN
     2085     9566    2           ADDFLG=1;
     2086     9567    2         ELSE
     2087     9568    2           ADDFLG=0;
     2088     9569    2         IF KQ$DGRAN.HDR.UPD OR KQ$DGRAN.HDR.FORCEOUT THEN
     2089     9570    3           DO;
     2090     9571    3           IF ENTF~=0 THEN
     2091     9572    4             DO;
     2092     9573    4             IF KQ$CG.NEEDPGTL$=ADDR(NIL) THEN
     2093     9574    4               KQ$CG.NEEDPGHD$=DFR$;
     2094     9575    4             ELSE
     2095     9576    4               KQ$CG.NEEDPGTL$->KQ$DFRBLK.LNK$=DFR$;
     2096     9577    4             KQ$CG.NEEDPGTL$=DFR$;
     2097     9578    4             KQ$DFRBLK.LNK$=ADDR(NIL);
     2098     9579    4             KQ$CG.NEEDPGCNT=KQ$CG.NEEDPGCNT+1;
     2099     9580    4             END;
     2100     9581    3           CALL NIQ$GETNR(Q$) ALTRET(NOQENTS);
     2101     9582    3           IF ADDFLG~=0 THEN
     2102     9583    4             DO;  /* Put on avail list if more than 10% of space is avail */
     2103     9584    4             KQ$DGRAN.FREEFLINK=KQ$CG.FREEDA;
     2104     9585    4             KQ$CG.FREEDA=ADDR(KQ$DGRAN.BTN.KEY)->WRD(0);
     2105     9586    4             KQ$DGRAN.HDR.EMPTYLIST='1'B;
     2106     9587    4             KQ$DGRAN.HDR.UPD='1'B;
     2107     9588    4             KQ$DGRAN.HDR.ADDFREE='1'B;
     2108     9589    4             KQ$CG.ADDFREE=KQ$CG.ADDFREE+1; /* Incr # adds in progress */
     2109     9590    4             END;
     2110     9591    3           KQ$DGRAN.HDR.WRITE='1'B; /* Write in progress */
     2111     9592    3           KQ$DGRAN.USECNT=KQ$DGRAN.USECNT+1;
     2112     9593    3           CALL GETBLK ALTRET(NODFR);
     2113     9594    3           KQ$DFRBLK.CODE=%KQDC_WRITE;
     2114     9595    3           KQ$DFRBLK.DA=DA;
     2115     9596    3           IF KQ$CG.IOTL$=ADDR(NIL) THEN
     2116     9597    3             KQ$CG.IOHD$=DFR$;
     2117     9598    3           ELSE
     2118     9599    3             KQ$CG.IOTL$->KQ$DFRBLK.LNK$=DFR$;
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:67   
     2119     9600    3           KQ$CG.IOTL$=DFR$;
     2120     9601    3   NODFR:  ;
     2121     9602    4           IF KQ_LOG.DCIO THEN DO;
     2122     9603    4             LDFR$=DFR$; LDGRAN$=DGRAN$;
     2123     9604    4             CALL KQZ$LOG(KQ$CG,%KQLOG_DCWRITE,,,LDFR$,
     2124     9605    4             DA,LDGRAN$) ALTRET(LOG1);
     2125     9606    4             RETURN;  /* Never comes here */
     2126     9607    4   LOG1:     END;
     2127     9608        /**/
     2128     9609    3           CALL KQB$DELETENL(KQ$CG.DTREE,KQ$DGRAN.BTN.KEY,ADDR(KQ$DGRAN.BTN)) ALTRET(
              9609                    ERR);
     2129     9610        /**/
     2130     9611    3           IF KQ$DGRAN.BLINK$=ADDR(NIL) THEN
     2131     9612    3             KQ$CG.AVAIL.HD$=KQ$DGRAN.FLINK$;
     2132     9613    3           ELSE
     2133     9614    3             KQ$DGRAN.BLINK$->KQ$DGRAN.FLINK$=KQ$DGRAN.FLINK$;
     2134     9615    3           IF KQ$DGRAN.FLINK$=ADDR(NIL) THEN
     2135     9616    3             KQ$CG.AVAIL.TL$=KQ$DGRAN.BLINK$;
     2136     9617    3           ELSE
     2137     9618    3             KQ$DGRAN.FLINK$->KQ$DGRAN.BLINK$=KQ$DGRAN.BLINK$;
     2138     9619        /**/
     2139     9620    3           KQ$DGRAN.HDR.CHAIN='0'B;  /* Not chained any more */
     2140     9621    3           LDGRAN$=DGRAN$; LDFR$=DFR$;
     2141     9622    3           CALL WRITEGRAN(LDGRAN$,DA,LDFR$,Q$) ALTRET (NOSENTS);
     2142     9623                %UNLOCK (G=KQ$CG.DTREE.GATE);
     2143     9626    3           DFR$=TDFR$;
     2144     9627    3           DGRAN$=ADDR(NIL);
     2145     9628    3           ALTRETURN;
     2146     9629    3           END;
     2147     9630        /**/
     2148     9631    3         IF KQ_LOG.DCIO THEN DO;
     2149     9632    3           LDGRAN$=DGRAN$;
     2150     9633    3           CALL KQZ$LOG(KQ$CG,%KQLOG_DCREMP,,,,DA,LDGRAN$)
     2151     9634    3           ALTRET(LOG2);
     2152     9635    3           RETURN;  /* Never comes here */
     2153     9636    3   LOG2:   END;
     2154     9637        /**/
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:68   
     2155     9638    2         CALL KQB$DELETENL(KQ$CG.DTREE,KQ$DGRAN.BTN.KEY,ADDR(KQ$DGRAN.BTN)) ALTRET(ERR)
              9638                  ;
     2156     9639        /**/
     2157     9640    2         IF KQ$DGRAN.BLINK$=ADDR(NIL) THEN
     2158     9641    2           KQ$CG.AVAIL.HD$=KQ$DGRAN.FLINK$;
     2159     9642    2         ELSE
     2160     9643    2           KQ$DGRAN.BLINK$->KQ$DGRAN.FLINK$=KQ$DGRAN.FLINK$;
     2161     9644    2         IF KQ$DGRAN.FLINK$=ADDR(NIL) THEN
     2162     9645    2           KQ$CG.AVAIL.TL$=KQ$DGRAN.BLINK$;
     2163     9646    2         ELSE
     2164     9647    2           KQ$DGRAN.FLINK$->KQ$DGRAN.BLINK$=KQ$DGRAN.BLINK$;
     2165     9648        /**/
     2166     9649    2         KQ$DGRAN.HDR.CHAIN='0'B;  /* Not chained any more */
     2167     9650        /**/
     2168     9651    2         RETURN;
     2169     9652        /**/
     2170     9653    2   ERR:  ;
     2171     9654    2         CALL SC_CGCACHESCR;
     2172     9655    2         GOTO ERR;
     2173     9656        /**/
     2174     9657    2   NOQENTS: ;
     2175     9658    2   NOSENTS: ;
     2176     9659              %UNLOCK (G=KQ$CG.DTREE.GATE);
     2177     9662    2         ALTRETURN;
     2178     9663        /**/
     2179     9664    2   END REMPAGE;
     2180     9665        %EJECT;
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:69   
     2181     9666
     2182     9667
     2183     9668        /*F* NAME:         KQD$RELP
     2184     9669
     2185     9670             PURPOSE:      Release a page that is no longer needed for
     2186     9671                           its original purpose.
     2187     9672
     2188     9673        */
     2189     9674
     2190     9675
     2191     9676
     2192     9677        /*D* NAME:         KQD$RELP
     2193     9678
     2194     9679             CALL:         CALL KQD$RELP(KQ$CG,DGRAN$);
     2195     9680
     2196     9681             INPUT:        KQ$CG - Context block ptr
     2197     9682                           DGRAN$ - Ptr to page to release
     2198     9683
     2199     9684             DESCRIPTION:  If the page is not needed by any other
     2200     9685                           process, it is released via KQM$RELP.
     2201     9686                           Otherwise, it is given to whomever needs it.
     2202     9687
     2203     9688        */
     2204     9689
     2205     9690
     2206     9691    1   KQD$RELP: ENTRY(KQ$CG,PDBLK$) ALTRET;
     2207     9692
     2208     9693    1         DGRAN$=PDBLK$;
     2209     9694              %LOCK (G=KQ$CG.DTREE.GATE);
     2210     9697    1         CALL RELPAGE ALTRET(NOUNLK);
     2211     9698              %UNLOCK (G=KQ$CG.DTREE.GATE);
     2212     9701    1         RETURN;
     2213     9702        /**/
     2214     9703    1   NOUNLK: ;
     2215     9704    1         ALTRETURN;
     2216     9705        %EJECT;
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:70   
     2217     9706
     2218     9707
     2219     9708        /*D* NAME:         RELPAGE
     2220     9709
     2221     9710             CALL:         CALL RELPAGE ALTRET(LOC);
     2222     9711
     2223     9712             INPUT:        DGRAN$ - Ptr to page to release
     2224     9713
     2225     9714             DESCRIPTION:  The page must be completely free.  If no other
     2226     9715                           process needs the page, it is released and the
     2227     9716                           routine exits.  If something else needs it,
     2228     9717                           the page is given to it, the process is COMPed,
     2229     9718                           and the routine ALTRETs to indicate the gate was
     2230     9719                           unlocked.
     2231     9720
     2232     9721        */
     2233     9722
     2234     9723
     2235     9724    1   RELPAGE: PROC ALTRET;
     2236     9725
     2237     9726        /**/
     2238     9727        /* AUTO */
     2239     9728        /**/
     2240     9729    2   DCL TDFR$ PTR;
     2241     9730    2   DCL P$ PTR;
     2242     9731    2   DCL T$ PTR;
     2243     9732    2   DCL N$ PTR;
     2244     9733
     2245     9734    2         TDFR$=DFR$;
     2246     9735    2         KQ$DGRAN=KQ_IDGRAN;
     2247     9736    2         KQ$GRAN=KQ$CG.GRAN;
     2248     9737    2         KQ$DGRAN.HDR.PTYP=%KQ_PTYP_DATA;
     2249     9738    2         KQ$DGRAN.HDR.GTYP=%KQ_PTYP_DATA;
     2250     9739    2         KQ$DGRAN.HDR.SELF$=DGRAN$;
     2251     9740    2   LOOP: ;
     2252     9741    2         IF KQ$CG.NEEDPGHD$~=ADDR(NIL) AND KQ$CG.MAXDATAPGS>=KQ$CG.CURDATAPGS THEN
     2253     9742    3           DO;
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:71   
     2254     9743    3           DFR$=KQ$CG.NEEDPGHD$;
     2255     9744    3           KQ$CG.NEEDPGHD$=KQ$DFRBLK.LNK$;
     2256     9745    3           IF KQ$CG.NEEDPGTL$=DFR$ THEN
     2257     9746    3             KQ$CG.NEEDPGTL$=ADDR(NIL);
     2258     9747    3           KQ$DFRBLK.LNK$=ADDR(NIL);
     2259     9748    3           KQ$CG.NEEDPGCNT=KQ$CG.NEEDPGCNT-1;
     2260     9749    4             DO CASE(KQ$DFRBLK.CODE);
     2261     9750    4               CASE(%KQDC_GETNEW);
     2262     9751    4                 CALL GETPROCESS ALTRET(TRYAGAIN);
     2263     9752    4                 DFR$=TDFR$;
     2264     9753    4                 ALTRETURN;
     2265     9754    4               CASE(ELSE);
     2266     9755    4                 CALL SC_CGCACHE;
     2267     9756    4                 GOTO LOOP;
     2268     9757    4               CASE(%KQDC_FETCH,%KQDC_RENEGE,%KQDC_DEL,%KQDC_GETFREE);
     2269     9758    4                 IF KQ$DFRBLK.ABORT THEN
     2270     9759    5                   DO;
     2271     9760    5                   CALL RELBLK;
     2272     9761    5                   GOTO LOOP;
     2273     9762    5                   END;
     2274     9763    4                 DA=KQ$DFRBLK.DA;
     2275     9764    4                 IF KQ$CG.IOHD$=ADDR(NIL) THEN
     2276     9765    4                   KQ$CG.IOHD$=DFR$;
     2277     9766    4                 ELSE
     2278     9767    4                   KQ$CG.IOTL$->KQ$DFRBLK.LNK$=DFR$;
     2279     9768    4                 KQ$CG.IOTL$=DFR$;
     2280     9769    4                 T$=KQ$CG.NEEDPGHD$; /* Move other requests for this */
     2281     9770    4                 P$=ADDR(NIL);        /* disk addr to IOHD$ */
     2282     9771    5                   DO WHILE(T$~=ADDR(NIL));
     2283     9772    5                   N$=T$->KQ$DFRBLK.LNK$;
     2284     9773    5                   IF T$->KQ$DFRBLK.DA=DA THEN
     2285     9774    6                     DO;
     2286     9775    6                     IF P$=ADDR(NIL) THEN
     2287     9776    6                       KQ$CG.NEEDPGHD$=T$->KQ$DFRBLK.LNK$;
     2288     9777    6                     ELSE
     2289     9778    6                       P$->KQ$DFRBLK.LNK$=T$->KQ$DFRBLK.LNK$;
     2290     9779    6                     IF KQ$CG.NEEDPGTL$=T$ THEN
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:72   
     2291     9780    6                       KQ$CG.NEEDPGTL$=P$;
     2292     9781    6                     KQ$CG.IOTL$->KQ$DFRBLK.LNK$=T$;
     2293     9782    6                     KQ$CG.IOTL$=T$;
     2294     9783    6                     T$->KQ$DFRBLK.LNK$=ADDR(NIL);
     2295     9784    6                     KQ$CG.NEEDPGCNT=KQ$CG.NEEDPGCNT+1;
     2296     9785    6                     END;
     2297     9786    5                   ELSE
     2298     9787    5                     P$=T$;
     2299     9788    5                   T$=N$;
     2300     9789    5                   END;
     2301     9790                      %UNLOCK (G=KQ$CG.DTREE.GATE);
     2302     9793    4                 CALL READGRAN5;
     2303     9794    4             END;
     2304     9795    3           IF KQ$CG.NEEDPGHD$=ADDR(NIL) AND KQ$CG.DELAY.NEEDPG THEN
     2305     9796    4             DO;
     2306     9797                  %LOCK (G=KQ$CG.GATE.CG);
     2307     9800    4             IF KQ$CG.NEEDPGHD$=ADDR(NIL) THEN
     2308     9801    4               KQ$CG.DELAY.NEEDPG='0'B;
     2309     9802                  %UNLOCK (G=KQ$CG.GATE.CG);
     2310     9805    4             END;
     2311     9806    3           DFR$=TDFR$;
     2312     9807    3           ALTRETURN;
     2313     9808    3           END;
     2314     9809    2         ELSE
     2315     9810    2           IF KQ$CG.CURDATAPGS<=KQ$CG.MINDATAPGS THEN
     2316     9811    3   KEEPIT:   DO;
     2317     9812    3             KQ$DGRAN.FLINK$=KQ$CG.DATAFREE$;
     2318     9813    3             KQ$CG.DATAFREE$=DGRAN$;
     2319     9814    3             END;
     2320     9815    2           ELSE
     2321     9816    3             DO;
     2322     9817    3             IF  KQ$CG.CURDATAPGS = 2
     2323     9818    3             AND KQ$CG.FWUSR# ~= 0 THEN GOTO KEEPIT;
     2324     9819    3             LDGRAN$=DGRAN$; DGRAN$=ADDR(NIL);
     2325     9820    3             CALL KQM$RELP(KQ$CG,LDGRAN$);
     2326     9821    3             KQ$CG.CURDATAPGS=KQ$CG.CURDATAPGS-1;
     2327     9822    3             END;
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:73   
     2328     9823    2         DFR$=TDFR$;
     2329     9824    2         RETURN;
     2330     9825        /**/
     2331     9826    2   TRYAGAIN: ;
     2332     9827              %LOCK (G=KQ$CG.DTREE.GATE);
     2333     9830    2         GOTO LOOP;
     2334     9831        /**/
     2335     9832    2   END RELPAGE;
     2336     9833        %EJECT;
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:74   
     2337     9834
     2338     9835
     2339     9836        /*D* NAME:         COMP
     2340     9837
     2341     9838             CALL:         CALL COMP;
     2342     9839
     2343     9840             INPUT:        DFR$ - Ptr to defer block to comp
     2344     9841
     2345     9842             DESCRIPTION:  The indicated defer block is comp'ed.  If both
     2346     9843                           EVNT and GO are set (indicating that both the
     2347     9844                           operation and DEFERGO are complete) then
     2348     9845                           something is done.  If there is an EPTR, it
     2349     9846                           is called.  If there is a user number, the
     2350     9847                           user is awakened.  If neither, the block is
     2351     9848                           released.
     2352     9849
     2353     9850                           COMP must be called with the DTREE gate locked.
     2354     9851                           The gate will be unlocked before returning.
     2355     9852
     2356     9853        */
     2357     9854
     2358     9855
     2359     9856    1   COMP: PROC;
     2360     9857
     2361     9858    2   COMP0:
     2362     9859
     2363     9860    2         IF KQ$DFRBLK.GO AND KQ$DFRBLK.EVNT THEN
     2364     9861    2           IF KQ$DFRBLK.EPTR$~=ENTADDR(NIL) THEN
     2365     9862    3             DO;
     2366     9863    3             IF NI$DS>1 OR H_GATECNT>1 THEN
     2367     9864    4   COMP1:      DO;  /* Other gates are locked - can't call handler */
     2368     9865    4               KQ$DFRBLK.LNK$=KQ$CG.DFRDFR$;
     2369     9866    4               KQ$CG.DFRDFR$=DFR$;
     2370     9867    4               KQ$CG.BASEDELAY=KQ$CG.BASEDELAY+1;
     2371     9868    4               KQ_BASEDELAY=KQ_BASEDELAY+1;
     2372     9869                    %UNLOCK (G=KQ$CG.DTREE.GATE);
     2373     9872    4               RETURN;
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:75   
     2374     9873    4               END;
     2375     9874    3   COMP2:    ;
     2376     9875    3             KQ$DFRPARM.INFO=KQ$DFRBLK.INFO;
     2377     9876    3             KQ$DFRPARM.DBLK$=KQ$DFRBLK.DBLK$;
     2378     9877    3             KQ$DFRPARM.DDA=KQ$DFRBLK.DDA;
     2379     9878    3             KQ$DFRPARM.ERR=KQ$DFRBLK.ERRCODE;
     2380     9879    3             EPTR$=KQ$DFRBLK.EPTR$;
     2381     9880    3             CALL RELBLK;
     2382     9881                  %UNLOCK (G=KQ$CG.DTREE.GATE);
     2383     9884    3             CALL EPTR$(KQ$DFRPARM);
     2384     9885    3             END;
     2385     9886    2           ELSE
     2386     9887    2             IF KQ$DFRBLK.USR~=0 THEN
     2387     9888    3               DO;
     2388     9889                    %UNLOCK (G=KQ$CG.DTREE.GATE);
     2389     9892    3               CALL SSR$RUE(%SS_UQA,KQ$DFRBLK.USR);
     2390     9893    3               END;
     2391     9894    2             ELSE
     2392     9895    3               DO;
     2393     9896    3               CALL UNDOIT ALTRET(NDUC);
     2394     9897    3               KQ$DGRAN.USECNT=KQ$DGRAN.USECNT-1;
     2395     9898    3   NDUC:       ;
     2396     9899    3               CALL RELBLK;
     2397     9900                    %UNLOCK (G=KQ$CG.DTREE.GATE);
     2398     9903    3               END;
     2399     9904    2         ELSE
     2400     9905    3           DO;
     2401     9906                %UNLOCK (G=KQ$CG.DTREE.GATE);
     2402     9909    3           END;
     2403     9910    2   RET:  ;
     2404     9911    2         RETURN;
     2405     9912        /**/
     2406     9913    2   COMPDFR: ENTRY;
     2407     9914        /**/
     2408     9915    2         GOTO COMP2;
     2409     9916        /**/
     2410     9917    2   COMPLATER: ENTRY;
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:76   
     2411     9918        /**/
     2412     9919    2         IF KQ$DFRBLK.GO AND KQ$DFRBLK.EVNT AND KQ$DFRBLK.EPTR$~=ENTADDR(NIL) THEN
     2413     9920    2           GOTO COMP1;  /* Don't comp if EPTR - may blow TSTACK */
     2414     9921    2         GOTO COMP0;
     2415     9922        /**/
     2416     9923    2   COMPRCVR: ENTRY; /* Called during KQD$RECOVER to fix stuff */
     2417     9924                         /* left on the DFRDFR chain               */
     2418     9925    2         CALL UNDOIT;
     2419     9926    2         RETURN;
     2420     9927        /**/
     2421     9928        /**/
     2422     9929    2   UNDOIT: PROC ALTRET;
     2423     9930        /**/
     2424     9931    3         DBLK$=KQ$DFRBLK.DBLK$;
     2425     9932    3         IF DBLK$ = ADDR(NIL) THEN ALTRETURN;
     2426     9933    3         DGRAN$=DBLK$;
     2427     9934    3         DGRAN.DISP=0;
     2428     9935    4           DO CASE(KQ$DFRBLK.CODE);
     2429     9936    4             CASE(%KQDC_FETCH);
     2430     9937    4               KQ$DBLK.LOCK='0'B;
     2431     9938    4             CASE(%KQDC_GET);
     2432     9939    4               KQ$DBLK.LINKX=KQ$DGRAN.AVAILX;
     2433     9940    4               KQ$DGRAN.AVAILX=POFFW(DBLK$,DGRAN$);
     2434     9941    4               KQ$DBLK.ACTIVE='0'B;
     2435     9942    4               KQ$DBLK.LOCK='0'B;
     2436     9943    4               KQ$DBLK.LREL='0'B;
     2437     9944    4               CALL COUNT_WORDS(%ADD,%ADD);
     2438     9945    4             CASE(ELSE);
     2439     9946    4               CALL SC_CGCACHE;
     2440     9947    4           END;
     2441     9948    3         RETURN;
     2442     9949    3   END UNDOIT;
     2443     9950    2   END COMP;
     2444     9951        %EJECT;
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:77   
     2445     9952
     2446     9953
     2447     9954        /*F* NAME:         KQD$COMP
     2448     9955
     2449     9956             PURPOSE:      Do COMP processing for defer blocks that could
     2450     9957                           not be COMPed when their request was satified
     2451     9958
     2452     9959        */
     2453     9960
     2454     9961
     2455     9962
     2456     9963        /*D* NAME:         KQD$COMP
     2457     9964
     2458     9965             CALL:         CALL KQD$COMP(KQ$CG);
     2459     9966
     2460     9967             INPUT:        KQ$CG - Context block
     2461     9968
     2462     9969             DESCRIPTION:  The list of defer blocks headed by KQ$CG.DFRDFR$
     2463     9970                           is COMPed by calling COMPDFR for each.
     2464     9971
     2465     9972        */
     2466     9973
     2467     9974
     2468     9975    1   KQD$COMP: ENTRY(KQ$CG) ALTRET;
     2469     9976
     2470     9977    2           DO WHILE('1'B);
     2471     9978                %LOCK (G=KQ$CG.DTREE.GATE);
     2472     9981    2           IF KQ$CG.DFRDFR$=ADDR(NIL) THEN
     2473     9982    3             DO;
     2474     9983                  %UNLOCK (G=KQ$CG.DTREE.GATE);
     2475     9986    3             RETURN;
     2476     9987    3             END;
     2477     9988    2           DFR$=KQ$CG.DFRDFR$;
     2478     9989    2           KQ$CG.DFRDFR$=KQ$DFRBLK.LNK$;
     2479     9990    2           CALL COMPDFR;
     2480     9991    2           END;
     2481     9992        %EJECT;
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:78   
     2482     9993
     2483     9994
     2484     9995        /*F* NAME:         KQD$RECOVER
     2485     9996
     2486     9997             PURPOSE:      Recover those parts of the comgroup queue controlled
     2487     9998                           by KQD after a recovery.
     2488     9999
     2489    10000        */
     2490    10001
     2491    10002
     2492    10003
     2493    10004        /*D* NAME:         KQD$RECOVER
     2494    10005
     2495    10006             CALL:         CALL KQD$RECOVER(KQ$CG) ALTRET(CANNOTOPEN)
     2496    10007
     2497    10008             INPUT:        KQ$CG - Context block
     2498    10009
     2499    10010             ENVIRONMENT:  On behalf of user.
     2500    10011                           KCC$CLOCK not enabled.
     2501    10012                           Garbage collector not running.
     2502    10013                           Comgroup only open to one user (us).
     2503    10014
     2504    10015             DESCRIPTION:  The data cache pages present when the comgroup
     2505    10016                           was closed have already been placed in the
     2506    10017                           DTREE by comgroup reopen (as part of the process
     2507    10018                           of reading in the memory pages).  For each page,
     2508    10019                           the global flags have been zapped (e.g. USECNT).
     2509    10020
     2510    10021                           The job of this routine is to clean up everything
     2511    10022                           else.
     2512    10023
     2513    10024                           This routine performs the following:
     2514    10025
     2515    10026                           o    Clean up the free defer block chain.  This
     2516    10027                                is done by zapping NDFRBLKS, and then
     2517    10028                                incrementing it by the number actually
     2518    10029                                present on the free chain.  NDFRBLKS will
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:79   
     2519    10030                                be corrected later in the process as we
     2520    10031                                release more of them
     2521    10032                           o    Clean up the various chains of active
     2522    10033                                defer blocks.  These are the
     2523    10034                                      - I/O chain (IOHD$)
     2524    10035                                      - Need page chain (NEEDPGHD$)
     2525    10036                                      - GET chain (GETHD$)
     2526    10037                                      - Need IOQ packet chain (IOQHD$)
     2527    10038                                      - Awaiting-COMP chain (DFRDFR$)
     2528    10039                                This is done by running each chain and
     2529    10040                                doing the appropriate thing for each
     2530    10041                                of its members.
     2531    10042                           o    Each DBLK that has been fetched or GETted
     2532    10043                                and was caught by the crash while still locked
     2533    10044                                into the cache is UNLOCKed
     2534    10045
     2535    10046        */
     2536    10047
     2537    10048
     2538    10049    1   KQD$RECOVER: ENTRY(KQ$CG) ALTRET;
     2539    10050
     2540    10051    1         KQ$CG.NDFRBLKS=0;
     2541    10052    1         DFR$=KQ$CG.DFRFREEHD$;
     2542    10053    1         KQ$CG.DFRFREETL$=ADDR(NIL);
     2543    10054    2           DO WHILE(DFR$~=ADDR(NIL));
     2544    10055    2           KQ$CG.NDFRBLKS=KQ$CG.NDFRBLKS+1;
     2545    10056    2           KQ$CG.DFRFREETL$=DFR$;
     2546    10057    2           DFR$=KQ$DFRBLK.LNK$;
     2547    10058    2           END;
     2548    10059        /**/
     2549    10060    1         CALL RCVCHAIN (KQ$CG.IOHD$);
     2550    10061    1         KQ$CG.IOTL$=ADDR(NIL);
     2551    10062    1         CALL RCVCHAIN (KQ$CG.NEEDPGHD$);
     2552    10063    1         KQ$CG.NEEDPGTL$=ADDR(NIL);
     2553    10064    1         CALL RCVCHAIN (KQ$CG.IOQHD$);
     2554    10065    1         KQ$CG.IOQTL$=ADDR(NIL);
     2555    10066    1         CALL RCVCHAIN (KQ$CG.GETHD$);
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:80   
     2556    10067    1         KQ$CG.GETTL$=ADDR(NIL);
     2557    10068        /**/
     2558    10069    2           DO WHILE (KQ$CG.DFRDFR$ ~= ADDR(NIL));
     2559    10070    2           DFR$=KQ$CG.DFRDFR$;
     2560    10071    3             DO CASE (KQ$DFRBLK.CODE);
     2561    10072
     2562    10073    3               CASE (%KQDC_GET,%KQDC_FETCH);
     2563    10074    3                 CALL COMPRCVR;
     2564    10075
     2565    10076    3               CASE (ELSE);
     2566    10077    3                 ;
     2567    10078    3             END;
     2568    10079    2           KQ$CG.DFRDFR$=KQ$DFRBLK.LNK$;
     2569    10080    2           CALL RELBLK;
     2570    10081    2           KQ$CG.NDFRBLKS=KQ$CG.NDFRBLKS+1;
     2571    10082    2           END;
     2572    10083        /**/
     2573    10084    1         KQ$CG.SHRINKCNT=0;
     2574    10085    1         KQ$CG.SHRINKPGS=0;
     2575    10086        /**/
     2576    10087    1         DGRAN$=KQ$CG.DTREE.HEAD$;
     2577    10088    2           DO WHILE (DGRAN$ ~= ADDR(NIL));
     2578    10089    2           DGRAN$ = PINCRW(DGRAN$,-SIZEW(KQ$DGRAN.HDR));
     2579    10090    2           CALL RCVGRAN ALTRET(ALTRT);
     2580    10091    2           DGRAN$=KQ$DGRAN.BTN.FLINK$;
     2581    10092    2           END;
     2582    10093        /**/
     2583    10094    1         CALL KQC$CXTSET(ADDR(KQ$CG));
     2584    10095        /**/
     2585    10096    1         RETURN;
     2586    10097        /**/
     2587    10098        /** PROC TO RECOVER A CHAIN **/
     2588    10099    1   RCVCHAIN: PROC (HD$);
     2589    10100        /**/
     2590    10101    2   DCL HD$ PTR;
     2591    10102        /**/
     2592    10103    3           DO WHILE (HD$ ~= ADDR(NIL));
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:81   
     2593    10104    3           DFR$=HD$;
     2594    10105    3           HD$=KQ$DFRBLK.LNK$;
     2595    10106    3           CALL RELBLK;
     2596    10107    3           KQ$CG.NDFRBLKS=KQ$CG.NDFRBLKS+1;
     2597    10108    3           END;
     2598    10109    2         RETURN;
     2599    10110    2   END RCVCHAIN;
     2600    10111        /**/
     2601    10112        /*I* NAME:         RCVGRAN
     2602    10113             PURPOSE:      To fix up an in-core data granule during
     2603    10114                           KQD$RECOVER
     2604    10115             DESCRIPTION:  The free chains in the granule are rebuilt
     2605    10116                           to ensure their integrity.  Also, all active
     2606    10117                           data blocks have their LOCK bits zapped.  This
     2607    10118                           last prevents problems when people try to FETCH
     2608    10119                           stuff which was LOCKed when the comgroup was
     2609    10120                           crashed.
     2610    10121
     2611    10122                           A diagnostic SNAP is issued if any granule is
     2612    10123                           broken.
     2613    10124                           If a granule is unrecoverably broken, we ALTRET
     2614    10125                           and the comgroup cannot be opened.
     2615    10126        */
     2616    10127    1   RCVGRAN: PROC ALTRET;
     2617    10128        /**/
     2618    10129    2   DCL PASS UBIN;
     2619    10130    2   DCL I UBIN;
     2620    10131    2   DCL LASTX UBIN;
     2621    10132    2   DCL BLKX UBIN;
     2622    10133        /**/
     2623    10134    2         PASS=1;
     2624    10135    2   RETRY:;
     2625    10136    2         BLKX=SIZEW(KQ$DGRAN);
     2626    10137    2         LASTX=0;
     2627    10138    2   LOOP: DBLK$=PINCRW(DGRAN$,BLKX);
     2628    10139    2         IF KQ$DBLK.SIZW + BLKX > 1024 THEN
     2629    10140    3           DO;
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:82   
     2630    10141    3           IF PASS = 1 THEN
     2631    10142    4             DO;
     2632    10143    4             CALL SC_CGCACHE;
     2633    10144    4   PASS2:    PASS=2;
     2634    10145    4             KQ$DGRAN.AVAILX=0;
     2635    10146    4             KQ$DGRAN.BUDDYX=0;
     2636    10147                  /* All the Words in this Granule that were considered
     2637    10148                     AVAILable and FREE are now considered USED.  This
     2638    10149                     Routine will make them Available later             */
     2639    10150    4             I = KQ$DBLK.SIZW ;
     2640    10151    4             KQ$DBLK.SIZW = KQ$DGRAN.WRDSAVAIL;
     2641    10152    4             CALL COUNT_WORDS(%SUBTRACT,%NONE) ;
     2642    10153    4             KQ$DBLK.SIZW = KQ$DGRAN.WRDSFREE ;
     2643    10154    4             CALL COUNT_WORDS(%NONE,%SUBTRACT) ;
     2644    10155    4             KQ$DBLK.SIZW = I ;
     2645    10156    4             GOTO RETRY;
     2646    10157    4             END;
     2647    10158    3           IF KQ$DBLK.ACTIVE OR KQ$DBLK.LREL THEN
     2648    10159    3             ALTRETURN;
     2649    10160    3           KQ$DBLK.SIZW=1024-BLKX;
     2650    10161    3           END;
     2651    10162    2         IF KQ$DBLK.LREL OR KQ$DBLK.ACTIVE THEN
     2652    10163    3           DO;
     2653    10164    3           I=KQ$DBLK.DSIZE+SIZEC(KQ$DBLK)+4*(BLKX);
     2654    10165    3           IF KQ$DBLK.MBLK THEN I=I+SIZEC(KQ$MBLK);
     2655    10166    3           IF I > 4096 THEN
     2656    10167    4             DO;
     2657    10168    4             CALL SC_CGCACHE;
     2658    10169    4             ALTRETURN;
     2659    10170    4             END;
     2660    10171    3           END;
     2661    10172    2         IF NOT KQ$DBLK.ACTIVE THEN
     2662    10173    2           IF PASS = 2 THEN
     2663    10174    3             DO;
     2664    10175    3             KQ$DBLK.LINKX=0;
     2665    10176    3             IF LASTX = 0
     2666    10177    3             THEN KQ$DGRAN.AVAILX=BLKX;
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:83   
     2667    10178    3             ELSE PINCRW(DGRAN$,LASTX)->KQ$DBLK.LINKX=BLKX;
     2668    10179    3             LASTX=BLKX;
     2669    10180                  /* Remember were I said above that this routine would
     2670    10181                     make them AVAILable later.  Well it is Later.      */
     2671    10182    3             CALL COUNT_WORDS(%ADD,%ADD);
     2672    10183    3             END;
     2673    10184    2         IF PASS = 2 THEN
     2674    10185    2           KQ$DBLK.LOCK='0'B;
     2675    10186    2         IF KQ$DBLK.SIZW<=0 THEN CALL SC_CGCACHE;
     2676    10187    2         BLKX=BLKX+KQ$DBLK.SIZW;
     2677    10188    2         IF BLKX ~= 1024 THEN GOTO LOOP;
     2678    10189    2         IF PASS = 1 THEN GOTO PASS2;
     2679    10190    2         RETURN;
     2680    10191    2   END RCVGRAN;
     2681    10192        %EJECT;
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:84   
     2682    10193
     2683    10194
     2684    10195        /*F* NAME:         KQD$NEEDPG
     2685    10196
     2686    10197             PURPOSE:      Do things to the data cache a 1 second intervals.
     2687    10198
     2688    10199        */
     2689    10200
     2690    10201
     2691    10202
     2692    10203        /*D* NAME:         KQD$NEEDPG
     2693    10204
     2694    10205             CALL:         CALL KQD$NEEDPG(KQ$CG);
     2695    10206
     2696    10207             INPUT:        KQ$CG - Comgroup context block
     2697    10208
     2698    10209             DESCRIPTION:  If there are tasks waiting for a page and the
     2699    10210                           comgroup does not have its maximum number of data
     2700    10211                           cache pages, an attempt is made to get one.  If
     2701    10212                           successful, RELPAGE is called to find someone to
     2702    10213                           use it, and the loop is repeated.
     2703    10214
     2704    10215        */
     2705    10216
     2706    10217
     2707    10218
     2708    10219    1   KQD$NEEDPG: ENTRY(KQ$CG) ALTRET;  /* Never ALTRETs */
     2709    10220
     2710    10221    1   NEEDPG: ;
     2711    10222              %LOCK (G=KQ$CG.DTREE.GATE);
     2712    10225    2           DO WHILE(KQ$CG.NEEDPGHD$~=ADDR(NIL));
     2713    10226    2           IF KQ$CG.DATAFREE$~=ADDR(NIL) THEN
     2714    10227    3             DO;
     2715    10228    3             DGRAN$=KQ$CG.DATAFREE$;
     2716    10229    3             KQ$CG.DATAFREE$=KQ$DGRAN.FLINK$;
     2717    10230    3             END;
     2718    10231    2           ELSE
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:85   
     2719    10232    2             IF KQ$CG.CURDATAPGS<KQ$CG.MAXDATAPGS THEN
     2720    10233    3               DO;
     2721    10234    3               CALL KQM$GETP(KQ$CG,LDGRAN$,I) ALTRET(UNLKRET);
     2722    10235    3               DGRAN$=LDGRAN$;
     2723    10236    3               KQ$CG.CURDATAPGS=KQ$CG.CURDATAPGS+1;
     2724    10237    3               KQ$DGRAN=KQ_IDGRAN;
     2725    10238    3               KQ$GRAN=KQ$CG.GRAN;
     2726    10239    3               KQ$DGRAN.HDR.PTYP=%KQ_PTYP_DATA;
     2727    10240    3               KQ$DGRAN.HDR.GTYP=%KQ_PTYP_DATA;
     2728    10241    3               KQ$DGRAN.HDR.SELF$=DGRAN$;
     2729    10242    3               END;
     2730    10243    2             ELSE
     2731    10244    3               DO;
     2732    10245    3               DGRAN$=KQ$CG.AVAIL.TL$;
     2733    10246    4                 DO WHILE(DGRAN$~=ADDR(NIL));
     2734    10247    4                 IF KQ$DGRAN.USECNT=0 THEN
     2735    10248    5                   DO;
     2736    10249    5                   KQ$DGRAN.HDR.FORCEOUT='0'B;
     2737    10250    5                   CALL REMPAGE ALTRET(NEEDPG);
     2738    10251    5                   GOTO RELPG;
     2739    10252    5                   END;
     2740    10253    4                 DGRAN$=KQ$DGRAN.BLINK$;
     2741    10254    4                 END;
     2742    10255    3               GOTO UNLKRET;
     2743    10256    3               END;
     2744    10257        /**/
     2745    10258    2   RELPG:  ;
     2746    10259    2           CALL RELPAGE ALTRET(NEEDPG);
     2747    10260    2           END;
     2748    10261        /**/
     2749    10262        /**/
     2750    10263    1   UNLKRET: ;
     2751    10264              %UNLOCK (G=KQ$CG.DTREE.GATE);
     2752    10267        /**/
     2753    10268    1   RET:  ;
     2754    10269    1         RETURN;
     2755    10270        %EJECT;
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:86   
     2756    10271
     2757    10272
     2758    10273        /*F* NAME:         KQD$SQUEEZE
     2759    10274
     2760    10275             PURPOSE:      Do things to the data cache a 1 minute intervals.
     2761    10276
     2762    10277        */
     2763    10278
     2764    10279
     2765    10280
     2766    10281        /*D* NAME:         KQD$SQUEEZE
     2767    10282
     2768    10283             CALL:         CALL KQD$SQUEEZE(KQ$CG);
     2769    10284
     2770    10285             INPUT:        KQ$CG - Comgroup context block
     2771    10286
     2772    10287             DESCRIPTION:  The data cache is searched.  For each page with USECNT=0:
     2773    10288                              o if ACTCNT is non-zero, it is zeroed
     2774    10289                              o if it is already zero (indicating no activity
     2775    10290                                in the last minute) it is thrown out
     2776    10291                              o if FORCECNT is 1 and UPD is set, the page is written,
     2777    10292                                but not thrown out (FORCEOUT set)
     2778    10293
     2779    10294        */
     2780    10295
     2781    10296
     2782    10297
     2783    10298    1   KQD$SQUEEZE: ENTRY(KQ$CG) ALTRET;  /* Never ALTRETs */
     2784    10299
     2785    10300    1         ENTFLG = 0;
     2786    10301    1         CALL SSS$SYSTIME(PASS);
     2787    10302    1   RESTART: ;
     2788    10303              %LOCK (G=KQ$CG.DTREE.GATE);
     2789    10306    1   RESTART5: ;
     2790    10307    1         IF KQ$CG.IOCNT>20 THEN
     2791    10308    1           GOTO UNLKRET;  /* Don't do too many I/Os at once */
     2792    10309    1         IF KQ$CG.FORCECNT~=1 THEN
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:87   
     2793    10310    2           DO;
     2794    10311    2           IF KQ$CG.FORCECNT~=0 THEN
     2795    10312    2             KQ$CG.FORCECNT=KQ$CG.FORCECNT-1;
     2796    10313    2           ELSE
     2797    10314    2             KQ$CG.FORCECNT=KQ$CG.AUCTL.WRITETIME;
     2798    10315    2           DELFLG=0; /* Don't force out this time */
     2799    10316    2           END;
     2800    10317    1         ELSE
     2801    10318    2           DO;
     2802    10319    2           KQ$CG.FORCECNT=KQ$CG.AUCTL.WRITETIME;
     2803    10320    2           DELFLG=1;
     2804    10321    2           CALL SSS$SYSTIME(J);
     2805    10322    2           CALL XUD$UTS_ADJ_25TH(I, J, -KQ$CG.AUCTL.WRITETIME*%UTS_25TH_MIN#);
     2806    10323    2           END;
     2807    10324    1         DGRAN$=KQ$CG.AVAIL.TL$;
     2808    10325    2           DO WHILE(DGRAN$~=ADDR(NIL));
     2809    10326    2           IF NOT KQ$DGRAN.HDR.WRITE AND KQ$DGRAN.PASS~=PASS THEN
     2810    10327    3             DO;
     2811    10328    3             KQ$DGRAN.PASS=PASS;
     2812    10329    3             IF KQ$DGRAN.USECNT=0 THEN
     2813    10330    4               DO;
     2814    10331    4               IF (KQ$DGRAN.ACTCNT=0 AND KQ$CG.CURDATAPGS-KQ$CG.IOCNT>KQ$CG.MINDATAPGS)
     2815    10332    4               OR KQ$CG.CURDATAPGS-KQ$CG.IOCNT>KQ$CG.MAXDATAPGS THEN
     2816    10333                          /* Yeah, yeah, I know IOCNT is not just the count of       */
     2817    10334                          /* writes outstanding but it will suffice here. The only   */
     2818    10335                          /* effect will be to wait an extra minute before we purge  */
     2819    10336                          /* down to MINDATAPGS                                      */
     2820    10337    5                 DO;
     2821    10338    5                 KQ$DGRAN.HDR.FORCEOUT='0'B;
     2822    10339    5                 GOTO WRITEIT;
     2823    10340    5                 END;
     2824    10341    4               KQ$DGRAN.ACTCNT=0;
     2825    10342    4               IF DELFLG~=0 THEN
     2826    10343    4                 IF KQ$DGRAN.TIME<I THEN
     2827    10344    4                   IF NOT KQ$DGRAN.HDR.UPD THEN
     2828    10345    4                     KQ$DGRAN.TIME=J;
     2829    10346    4                   ELSE
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:88   
     2830    10347    5                     DO;
     2831    10348    5                     KQ$DGRAN.HDR.FORCEOUT='1'B;
     2832    10349    5   WRITEIT:          ;
     2833    10350    5                     CALL REMPAGE ALTRET(RESTART);
     2834    10351    5                     CALL RELPAGE ALTRET(RESTART);
     2835    10352    5                     GOTO RESTART5;
     2836    10353    5                     END;
     2837    10354    4               END;
     2838    10355    3             ELSE
     2839    10356    3               IF DELFLG~=0 AND KQ$DGRAN.TIME<I THEN
     2840    10357    3                 IF KQ$DGRAN.HDR.UPD THEN
     2841    10358    3                   KQ$DGRAN.HDR.FORCEOUT='1'B;
     2842    10359    3                 ELSE
     2843    10360    3                   KQ$DGRAN.TIME=J;
     2844    10361    3             END;
     2845    10362    2           DGRAN$=KQ$DGRAN.BLINK$;
     2846    10363    2           END;
     2847    10364        /**/
     2848    10365    1         GOTO UNLKRET;
     2849    10366        %EJECT;
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:89   
     2850    10367
     2851    10368
     2852    10369        /*D* NAME:          LOGERR
     2853    10370
     2854    10371             CALL:          CALL LOGERR(WRD);
     2855    10372
     2856    10373             INPUT:         WRD - Optional word to put in error log entry
     2857    10374                            CODE - The code for the errlog entry
     2858    10375
     2859    10376        */
     2860    10377
     2861    10378
     2862    10379    1   LOGERR: PROC(CODE,WRD);
     2863    10380
     2864    10381        /* PARAMETERS */
     2865    10382    2   DCL CODE UBIN;
     2866    10383    2   DCL WRD UBIN;
     2867    10384
     2868    10385            %LOCK (G=KQ_ERRLOG_GATE);
     2869    10388    2         KQ_STATS.CACHERRS=KQ_STATS.CACHERRS+1;
     2870    10389    2         KQ_ERRLOG_BFR='0'B;
     2871    10390    2         KQ_ERRLOG_BFR.SIZ=15;
     2872    10391    2         IF ADDR(WRD)~=ADDR(NIL) THEN
     2873    10392    2           KQ_ERRLOG_BFR.INFO(0)=WRD;
     2874    10393    2         IF DBLK$~=ADDR(NIL) THEN
     2875    10394    2           ADDR(KQ_ERRLOG_BFR.INFO(1))->KQ$DBLK=KQ$DBLK;
     2876    10395    2         IF DFR$~=ADDR(NIL) THEN
     2877    10396    2           ADDR(KQ_ERRLOG_BFR.INFO(7))->KQ$DFRBLK=KQ$DFRBLK;
     2878    10397    2         KQ_ERRLOG_BFR.CODE=CODE;
     2879    10398    2         CALL ERRLOG;
     2880    10399    2         RETURN;
     2881    10400    2   END LOGERR;
     2882    10401        %EJECT;
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:90   
     2883    10402
     2884    10403
     2885    10404        /*F* NAME:         KQD$ERRLOG
     2886    10405
     2887    10406             PURPOSE:      Create an error log entry for a comgroup error
     2888    10407
     2889    10408        */
     2890    10409
     2891    10410
     2892    10411        /*D* NAME:         KQD$ERRLOG
     2893    10412
     2894    10413             CALL:         CALL KQD$ERRLOG(KQ$CG);
     2895    10414
     2896    10415             INPUT:        KQ$CG - The comgroup context block
     2897    10416
     2898    10417             DESCRIPTION:  The gate KQ_ERRLOG_GATE must be locked, and
     2899    10418                           KQ_ERRLOG_BFR must contains CODE, SIZ and INFO.
     2900    10419                           The common portions of the buffer are filled in,
     2901    10420                           the error logger is called, and the gate is
     2902    10421                           unlocked.
     2903    10422
     2904    10423        */
     2905    10424    1   KQD$ERRLOG: ENTRY(KQ$CG) ALTRET;
     2906    10425
     2907    10426    1         CALL ERRLOG;
     2908    10427    1         RETURN;
     2909    10428
     2910    10429
     2911    10430    1   ERRLOG: PROC;
     2912    10431
     2913    10432        /* AUTOMATIC */
     2914    10433    2   DCL CFU$ PTR;
     2915    10434    2   DCL 1 CFU REDEF CFU$,
     2916    10435    2         2 CTX UBIN(18) UNAL,
     2917    10436    2         2 * UBIN(18) UNAL;
     2918    10437
     2919    10438    2         CFU$=KQ$CG.CFU$;
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:91   
     2920    10439    2         KQ_ERRLOG_BFR.ACCT=PINCRW(F$CFU$,CFU$->FM$CFU.ACCTX)->FM$CFUA.ACCT;
     2921    10440    2         KQ_ERRLOG_BFR.PSN=FM$SET.PSN(KQ$CG.SETX);
     2922    10441    3           DO WHILE(CFU$->FM$CFU.NAMEX<FM$CFUX.CFUT);
     2923    10442    3           CFU$=PINCRW(F$CFU$,CFU$->FM$CFU.NAMEX);
     2924    10443    3           END;
     2925    10444    2         CFU$=PINCRC(F$CFU$,CFU$->FM$CFU.NAMEX);
     2926    10445    2         KQ_ERRLOG_BFR.FNAME.L=CFU$->FM$CFUN.L;
     2927    10446    2         KQ_ERRLOG_BFR.FNAME.C=CFU$->FM$CFUN.C;
     2928    10447    2         CFU$=ADDR(KQ$CG);
     2929    10448    2         KQ_ERRLOG_BFR.CTX=CFU.CTX;
     2930    10449    2         CALL ELA$SYSLOG(EL_CGERR,KQ_ERRLOG_BFR,POFFW(ADDR(KQ_ERRLOG_BFR.INFO),
     2931    10450    2         ADDR(KQ_ERRLOG_BFR))+KQ_ERRLOG_BFR.SIZ,'0'B,1,CFU$);
     2932    10451              %UNLOCK (G=KQ_ERRLOG_GATE);
     2933    10454    2         RETURN;
     2934    10455    2   END ERRLOG;
     2935    10456
     2936    10457    1   END KQD$GET;

PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:92   
--  Include file information  --

   XUD_UTS_M.:E05TOU  is referenced.
   SS_SCHED_C.:E05TOU  is referenced.
   N_FC_C.:E05TOU  is referenced.
   N$REQ.:E05TOU  is referenced.
   KQ_SUBS_C.:E05TOU  is referenced.
   KQ_DATA_R.:E05TOU  cannot be made into a system file and is referenced.
   KQ_MAC_C.:E05TOU  is referenced.
   KC_CP6.:E05TOU  is referenced.
   KC$CP6V_C.:E05TOU  is referenced.
   HF_LOCK_C.:E05TOU  cannot be made into a system file and is referenced.
   FM$SET.:E05TOU  is referenced.
   FM$CFU.:E05TOU  is referenced.
   EL_SUBS_C.:E05TOU  is referenced.
   EL$TABLES.:E05TOU  is referenced.
      No diagnostics issued in procedure KQD$GET.

   Procedure KQD$GET requires 4173 words for executable code.
   Procedure KQD$GET requires 82 words of local(AUTO) storage.

    No errors detected in file KQD$DBLK.:E05TSI    .

PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:93   

 Object Unit name= KQD$GET                                    File name= KQD$DBLK.:E05TOU
 UTS= JUL 30 '97 01:24:47.52 WED                              Compiler= PL-6/E31         Sev=      00
 SharedLib= :SHARED_SYSTEM                                    Alt SharedLib=


    ****  Control sections  ****

 Sect   Type Bound  Init  Size OctSiz  Section name(segment info)
    0  RoData even  UTS     48     60  KQD$GET
    1   Proc  even  none  4173  10115  KQD$GET
    2  RoData even  none    48     60  KQD$GET

    ****  Entry defs  ****

                              Check   Calling
                             calling  sequence
  Sect OctLoc Primary Altret sequence   type   Parms  Name
     1      0   yes    yes     yes      Std        3  KQD$GET
     1      4          yes     yes      Std        3  KQD$GETR
     1   1430          yes     yes      Std        1  KQD$GETINIT
     1   1447          yes     yes      Std        3  KQD$GETPROCESS
     1   2400          yes     yes      Std        3  KQD$FETCH
     1   2404          yes     yes      Std        3  KQD$FETCHR
     1   3152          yes     yes      Std        3  KQD$FETCHDONE
     1   3242          yes     yes      Std        3  KQD$DEFERGO
     1   3326          yes     yes      Std        3  KQD$DEFERWAIT
     1   3424          yes     yes      Std        3  KQD$RENEGE
     1   3556          yes     yes      Std        2  KQD$UNLOCK
     1   3562          yes     yes      Std        2  KQD$UPDATED
     1   3567          yes     yes      Std        2  KQD$UPDATE
     1   3603          yes     yes      Std        2  KQD$DELETE
     1   3610          yes     yes      Std        3  KQD$LREL
     1   4076          yes     yes      Std        3  KQD$DELDDA
     1   4316          yes     yes      Std        2  KQD$RELDFR
     1   5121          yes     yes      Std        3  KQD$STARTIO
     1   6054          yes     yes      Std        2  KQD$RELP
     1   6706          yes     yes      Std        1  KQD$COMP
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:94   
     1   6742          yes     yes      Std        1  KQD$RECOVER
     1   7354          yes     yes      Std        1  KQD$NEEDPG
     1   7502          yes     yes      Std        1  KQD$SQUEEZE
     1   7767          yes     yes      Std        1  KQD$ERRLOG

  ****  Data defs  ****

 Sect OctLoc  Name                           Sect OctLoc  Name
    0     16  KQ_IDGRAN

  ****  Entry refs  ****

         Check        Calling
        calling       sequence
Altret sequence SRef   type   Args  Name
         yes           Std       1 HFC$LOCK
 yes     yes           Std       8 KQZ$LOG
 yes     yes           Std       3 SSR$REG
         yes           Std       1 HFC$UNLOCK
         yes           Std       1 SSS$SYSTIME
 yes     yes           Std       3 XUD$UTS_ADJ_25TH
 yes     yes           Std       3 KQB$SRCH
 yes     yes           Std       1 KQC$CXTSET
 yes     yes           Std       3 KQM$GETP
 yes     yes           Std       3 KQB$INSERTNL
 yes     yes           Std       1 KQS$CGFULL
 yes     yes           Std       1 KQX$CHKPTR
 yes     yes           Std       1 NIO$QUE
 yes     yes           Std       1 NIQ$REL
         yes           Std       1 KQE$RDEAERR
 yes     yes           Std       1 NIQ$GETNR
         yes           Std       1 KQE$RDEA
 yes     yes           Std       3 FAF$FRTOSRNJ
 yes     yes           Std       2 FAF$SRTODR
 yes     yes           Std       1 NIQ$GETSNR
         yes           Std       1 KQE$WREA
 yes     yes           Std       3 KQB$DELETENL
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:95   
 yes     yes           Std       2 KQM$RELP
         yes           Std       4 SSR$RUE
 yes     yes           Std       6 ELA$SYSLOG
                       nStd      0 X66_AUTO_3
                       Std       0 B_CONSPOOL_D
                       nStd      0 X66_AALT
                       nStd      0 X66_ARET

  ****  Data refs  ****

  Flags:  r = read only, s = secondary
Flgs Name                             Flgs Name                             Flgs Name
     SC_CGCACHE                            SC_CGCACHESCR                         KQ_BASEDELAY
     KQ_DEBUG                              KQ_STATS                              KQ_LOG
     KQ_ERRLOG_GATE                   r    F$CFU$                                FM_FRZERO
     FM_WRCMP                              H_GATECNT                             NI$DS
     S_CUN                                 S_TIMR                                KQ_ERRLOG_BFR
     B_VECTNIL

  ****  Segment refs  ****

  Flags:  r = read only, s = secondary
Flgs Name                             Flgs Name                             Flgs Name
     NULLSID                               ASLENTSID                             ISSID
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:96   


        1        1        /*M* KQD$DBLK - Data management and cache routines for comgroup */
        2        2        /*T***********************************************************/
        3        3        /*T*                                                         */
        4        4        /*T* Copyright (c) Bull HN Information Systems Inc., 1997    */
        5        5        /*T*                                                         */
        6        6        /*T***********************************************************/
        7        7        /**/
        8        8       /*X* DMC,PLM=6,IND=0,IDT=2,SDI=2,CTI=0,ENU=0,AND,DCI=4,CSU=2,ECU=4,THI=0,DTI=0,STI=2
                 8        ,IAD=0,PRB */
        9        9        /**/
       10       10        /*P* NAME:         KQD$DBLK
       11       11
       12       12             PURPOSE:      Provide routines for data and buffer management.
       13       13
       14       14        */
       15       15
       16       16
       17       17        KQD$GET: PROC(KQ$CG,PDBLK$,PDDA) ALTRET;

     17  1 000000   000000 700200 xent  KQD$GET      TSX0  ! X66_AUTO_3
         1 000001   000122 000003                    ZERO    82,3

       18       18
       19       19
       20       20        /**/
       21       21        /* INCLUDES */
       22       22        /**/
       23       23        %INCLUDE EL$TABLES;
       24      346        %INCLUDE EL_SUBS_C;
       25      430        %INCLUDE FM$CFU;
       26      475        %INCLUDE FM$SET;
       27      502        %INCLUDE HF_LOCK_C;
       28      516        %INCLUDE KC$CP6V_C;
       29      636        %INCLUDE KC_CP6;
       30     1196        %INCLUDE KQ_MAC_C;
       31     3746        %INCLUDE KQ_DATA_R;
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:97   
       32     4578        %INCLUDE KQ_SUBS_C;
       33     4878        %INCLUDE N$REQ;
       34     4952        %INCLUDE N_FC_C;
       35     4989        %INCLUDE SS_SCHED_C;
       36     5222        %INCLUDE XUD_UTS_M;
       37     5304
       38     5305
       39     5306        /**/
       40     5307        /* PARAMETERS */
       41     5308        /**/
       42     5309        %KQ_CG (FPTN=KQ$CG,STCLASS=);
       43     6048    1   DCL PDBLK$ PTR;
       44     6049    1   DCL PSTAMP REDEF PDBLK$ UBIN;
       45     6050    1   DCL PDDA BIT(36) ALIGNED;
       46     6051    1   DCL PSTA$ REDEF PDDA PTR;
       47     6052    1   DCL PSIZ REDEF PDDA UBIN;
       48     6053    1   DCL PEPTR$ REDEF PDDA EPTR;
       49     6054
       50     6055
       51     6056        /**/
       52     6057        /* BASED STRUCTURES */
       53     6058        /**/
       54     6059        %FM$CFU;
       55     6065        %FM$CFUA;
       56     6071        %FM$CFUN;
       57     6074        %FM$CFUX (BASED="BASED(F$CFU$)");
       58     6079        %FM$SET (BASED="BASED(F$CFU$)");
       59     6084        %KQ_BTN (FPTN=KQ$BTN,STCLASS=BASED);
       60     6116        %KQ_DBLK (FPTN=KQ$DBLK,STCLASS="BASED(DBLK$)");
       61     6169        %KQ_DFRBLK (FPTN=KQ$DFRBLK,STCLASS="BASED(DFR$)");
       62     6219        %KQ_DGRAN (FPTN=KQ$DGRAN,STCLASS="BASED(DGRAN$)");
       63     6366        %KQ_GRAN (FPTN=KQ$GRAN,STCLASS="BASED(DGRAN$)");
       64     6421        %KQ_STA (FPTN=KQ$STA,STCLASS=BASED);
       65     6760        %KQ_MBLK (FPTN=KQ$MBLK,STCLASS=BASED);
       66     7030    1   DCL WRD(0:1023) UBIN BASED ALIGNED;
       67     7031
       68     7032
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:98   
       69     7033        /**/
       70     7034        /* AUTO */
       71     7035        /**/
       72     7036    1   DCL DBLK$ PTR;
       73     7037    1   DCL 1 DBLK REDEF DBLK$,
       74     7038    1         2 * BIT(8),
       75     7039    1         2 DISP UBIN(9) UNAL,
       76     7040    1         2 * BIT(19);
       77     7041    1   DCL DFR$ PTR;
       78     7042    1   DCL TDFR$ PTR;
       79     7043    1   DCL DGRAN$ PTR;
       80     7044    1   DCL 1 DGRAN REDEF DGRAN$,
       81     7045    1         2 * BIT(8),
       82     7046    1         2 DISP UBIN(16) UNAL,
       83     7047    1         2 * BIT(12);
       84     7048    1   DCL I UBIN;
       85     7049    1   DCL J UBIN;
       86     7050    1   DCL PREVDBLK$ PTR;
       87     7051    1   DCL DA UBIN;
       88     7052    1   DCL 1 KEY,
       89     7053    1         2 DA UBIN,
       90     7054    1         2 GARB UBIN;
       91     7055    1   DCL ENTFLG UBIN;
       92     7056    1   DCL DELFLG UBIN;
       93     7057    1   DCL 1 CHKPARM DALIGNED,
       94     7058    1         2 * BIT(72),
       95     7059    1         2 P$ PTR;
       96     7060    1   DCL REGFLG UBIN;
       97     7061    1   DCL ERRCODE UBIN;
       98     7062    1   DCL STAMP UBIN;
       99     7063    1   DCL 1 DDA,
      100     7064    1         2 DISP UBIN(9) UNAL,
      101     7065    1         2 DA UBIN(27) UNAL;
      102     7066        %KQ_DFRPARM (FPTN=KQ$DFRPARM,STCLASS=AUTO);
      103     7095    1   DCL EPTR$ EPTR;
      104     7096    1   DCL T$ PTR;
      105     7097    1   DCL P$ PTR;
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:99   
      106     7098    1   DCL SIZBYTES UBIN;
      107     7099    1   DCL HD$ PTR;
      108     7100    1   DCL TL$ PTR;
      109     7101    1   DCL PASS UBIN;
      110     7102    1   DCL LDFR$ PTR;
      111     7103    1   DCL LDBLK$ PTR;
      112     7104    1   DCL LDGRAN$ PTR;
      113     7105
      114     7106
      115     7107        /**/
      116     7108        /* EXTERNAL DATA */
      117     7109        /**/
      118     7110    1   DCL F$CFU$ PTR SYMREF READONLY;
      119     7111    1   DCL FM_FRZERO UBIN SYMREF;
      120     7112    1   DCL FM_WRCMP UBIN SYMREF;
      121     7113    1   DCL H_GATECNT UBIN SYMREF;
      122     7114    1   DCL NI$DS UBIN SYMREF;
      123     7115    1   DCL S_CUN UBIN SYMREF;
      124     7116    1   DCL S_TIMR UBIN SYMREF;
      125     7117        %EL$CGERR (NAME=KQ_ERRLOG_BFR,STCLASS=SYMREF,N=50);
      126     7121
      127     7122
      128     7123        /**/
      129     7124        /* CONSTANT */
      130     7125        /**/
      131     7126        %KQ_DBLK (STCLASS=CONSTANT);
      132     7179        %KQ_DFRBLK (STCLASS=CONSTANT);
      133     7229        %KQ_DGRAN (STCLASS="CONSTANT SYMDEF",FPTN=KQ_IDGRAN);
      134     7376    1   DCL KQD_MINSPLIT SBIN CONSTANT INIT(20);
      135     7377
      136     7378
      137     7379        /**/
      138     7380        /* EXTERNAL ROUTINES */
      139     7381        /**/
      140     7382    1   DCL ELA$SYSLOG ENTRY(6) ALTRET;
      141     7383    1   DCL FAF$FRTOSRNJ ENTRY(3) ALTRET;
      142     7384    1   DCL FAF$SRTODR ENTRY(2) ALTRET;
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:100  
      143     7385    1   DCL KQB$DELETENL ENTRY(3) ALTRET;
      144     7386    1   DCL KQB$INSERTNL ENTRY(3) ALTRET;
      145     7387    1   DCL KQB$SRCH ENTRY(3) ALTRET;
      146     7388    1   DCL KQC$CXTSET ENTRY(1) ALTRET;
      147     7389    1   DCL KQE$RDEA ENTRY(1);
      148     7390    1   DCL KQE$RDEAERR ENTRY(1);
      149     7391    1   DCL KQE$WREA ENTRY(1);
      150     7392    1   DCL KQM$GETP ENTRY(3) ALTRET;
      151     7393    1   DCL KQM$RELP ENTRY(2) ALTRET;
      152     7394    1   DCL KQS$CGFULL ENTRY(1) ALTRET;
      153     7395    1   DCL KQX$CHKPTR ENTRY(1) ALTRET;
      154     7396    1   DCL KQZ$LOG ENTRY(8) ALTRET;
      155     7397    1   DCL NIO$QUE ENTRY(1) ALTRET;
      156     7398    1   DCL NIQ$GETSNR ENTRY(1) ALTRET;
      157     7399    1   DCL NIQ$GETNR ENTRY(1) ALTRET;
      158     7400    1   DCL NIQ$REL ENTRY(1) ALTRET;
      159     7401    1   DCL SC_CGCACHE ENTRY CONV(2,0);
      160     7402    1   DCL SC_CGCACHESCR ENTRY CONV(2,0);
      161     7403    1   DCL SSR$REG ENTRY(3) ALTRET;
      162     7404    1   DCL SSR$RUE ENTRY(4);
      163     7405    1   DCL SSS$SYSTIME ENTRY(1);
      164     7406        %XUD$UTS_ENTRIES;
      165     7438
      166     7439
      167     7440        /**/
      168     7441        /* EQUs */
      169     7442        /**/
      170     7443        %EQU KQD_UNLOCK=0;
      171     7444        %EQU KQD_UPD=1;
      172     7445        %EQU KQD_LREL=2;
      173     7446        %EQU KQD_DEL=3;
      174     7447        /**/
      175     7448        %EQU GFLG_INIT=1;
      176     7449        %EQU GFLG_FREE=2;
      177     7450        %EQU GFLG_NEW=3;
      178     7451        /**/
      179     7452        %XUD_UTS_EQU;
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:101  
      180     7463        /**/
      181     7464        %SUB EMPTY_GRAN = "1024-SIZEW(KQ$DGRAN) ";
      182     7465        %SUB  NONE = 0;
      183     7466        %SUB  ADD = 1;
      184     7467        %SUB  SUBTRACT = 2;
      185     7468
      186     7469        %EJECT;
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:102  
      187     7470
      188     7471
      189     7472        /*F* NAME:         KQD$GET
      190     7473
      191     7474             PURPOSE:      Allocate a block of data space from the
      192     7475                           disk data area.
      193     7476
      194     7477        */
      195     7478
      196     7479
      197     7480        /*D* NAME:         KQD$GET
      198     7481
      199     7482             CALL:         CALL KQD$GET(KQ$CG,DBLK$,DDA) ALTRET(LOC);
      200     7483
      201     7484             ENTRY:        CALL KQD$GETR(KQ$CG,DBLK$,DDA) ALTRET(LOC);
      202     7485
      203     7486             INPUT:        KQ$CG - The comgroup context area
      204     7487                           DDA - Size in bytes to allocate
      205     7488
      206     7489             OUTPUT:       DBLK$ - Pointer to the data area
      207     7490                           DDA - Data disk address of the area
      208     7491
      209     7492             DESCRIPTION:
      210     7493                   Normal return:
      211     7494                           DBLK$ - Ptr to the data block allocated
      212     7495                           DDA - Data disk address
      213     7496
      214     7497                   Alternate return:
      215     7498                           If DBLK$ is ADDR(NIL), then DDA contains the error
      216     7499                           code. A code of KQDE_NDFRBLK means the call must be
      217     7500                           re-issued later (out of defer blocks).
      218     7501                           If DBLK$ is not ADDR(NIL), it is the pointer to
      219     7502                           a defer block that must be passed to KQD$DEFERGO
      220     7503                           when it is alright to proceed.
      221     7504
      222     7505                           The in-core granules are examined for free space.
      223     7506                           If a block of space is found that is at least as
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:103  
      224     7507                           large as is needed, it is used.  If it is larger
      225     7508                           than needed by at least KQD_MINSPLIT, it is split
      226     7509                           into two blocks, one of the size needed and the
      227     7510                           other the rest.
      228     7511
      229     7512                           If a granule is examined and its available chain
      230     7513                           does not contain usable space, a buddy-up
      231     7514                           operation is performed if:  there are at
      232     7515                           least two available blocks at least one
      233     7516                           of which resides on the AVAIL chain.
      234     7517                           The buddy-up process moves all blocks from the
      235     7518                           available chain to the buddied-up chain, and
      236     7519                           buddies up neighbors.  If the buddy-up oeration
      237     7520                           did not find any space, or if it was not
      238     7521                           performed, the next granule is examined.
      239     7522
      240     7523                           If all granules are examined and there is no
      241     7524                           space available of the right size, an attempt
      242     7525                           is made to allocate a new granule.  If no
      243     7526                           granules remain, the caller is told there is
      244     7527                           no space left.  If there is a granule, then
      245     7528                           a page is obtained.  If a new page cannot be
      246     7529                           allocated, then an old page is thrown out and
      247     7530                           reused.
      248     7531
      249     7532                           GETR, if called by a user, will REG until the
      250     7533                           operation completes (will never return a defer
      251     7534                           block ptr).  If called not on behalf of a user,
      252     7535                           will return the error KQDE_CREG if there is no
      253     7536                           space available in core.
      254     7537
      255     7538
      256     7539
      257     7540        %EJECT;
      258     7541
      259     7542
      260     7543        KQD$GET: ENTRY(KQ$CG,PDBLK$,PDDA) ALTRET;
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:104  
      261     7544        */
      262     7545
      263     7546    1         REGFLG=0;

   7546  1 000002   200026 450100                    STZ     REGFLG,,AUTO

      264     7547    1         GOTO GETCOM;

   7547  1 000003   000010 710000 1                  TRA     GETCOM

      265     7548
      266     7549    1   KQD$GETR: ENTRY(KQ$CG,PDBLK$,PDDA) ALTRET;

   7549  1 000004   000000 700200 xent  KQD$GETR     TSX0  ! X66_AUTO_3
         1 000005   000122 000003                    ZERO    82,3

      267     7550
      268     7551    1         REGFLG=1;

   7551  1 000006   000001 235007                    LDA     1,DL
         1 000007   200026 755100                    STA     REGFLG,,AUTO

   7551  1 000010                       GETCOM       null
      269     7552
      270     7553
      271     7554    1   GETCOM: ;
      272     7555    1         ENTFLG=%KQDC_GET;

   7555  1 000010   000005 235007                    LDA     5,DL
         1 000011   200020 755100                    STA     ENTFLG,,AUTO

      273     7556    1         DFR$=ADDR(NIL);

   7556  1 000012   000001 236000 xsym               LDQ     B_VECTNIL+1
         1 000013   200007 756100                    STQ     DFR$,,AUTO

      274     7557    1         SIZBYTES=PSIZ;
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:105  

   7557  1 000014   200005 470500                    LDP0    @PDDA,,AUTO
         1 000015   000000 235100                    LDA     0,,PR0
         1 000016   200042 755100                    STA     SIZBYTES,,AUTO

      275     7558    1         IF SIZBYTES=0 OR SIZBYTES > KQ_MCMAX#+SIZEC(KQ$MBLK) THEN

   7558  1 000017   000022 600000 1                  TZE     s:7560
         1 000020   007501 115007                    CMPA    3905,DL
         1 000021   000027 602000 1                  TNC     s:7567

      276     7559    2           DO;

      277     7560    2           PDBLK$=ADDR(NIL);

   7560  1 000022   200004 471500                    LDP1    @PDBLK$,,AUTO
         1 000023   100000 756100                    STQ     0,,PR1

      278     7561    2           PSIZ=%KQDE_BADPARMS;

   7561  1 000024   000011 235007                    LDA     9,DL
         1 000025   000000 755100                    STA     0,,PR0

      279     7562    2   ALTRT:
      280     7563    2           ALTRETURN;

   7563  1 000026   000000 702200 xent  ALTRT        TSX2  ! X66_AALT

      281     7564    2           END;
      282     7565        /**/
      283     7566              %LOCK (G=KQ$CG.DTREE.GATE);

   7567  1 000027   200003 236100                    LDQ     @KQ$CG,,AUTO
         1 000030   000231 036003                    ADLQ    153,DU
         1 000031   200112 756100                    STQ     I$+1,,AUTO
         1 000032   200112 630500                    EPPR0   I$+1,,AUTO
         1 000033   000017 631400 xsym               EPPR1   B_VECTNIL+15
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:106  
         1 000034   000000 701000 xent               TSX1    HFC$LOCK
         1 000035   000000 011000                    NOP     0

   7558  1 000036                       GET10        null
      284     7569        /**/
      285     7570    1   GET10: ;
      286     7571    1         DGRAN$=KQ$CG.AVAIL.HD$;  /* Head of in-core granules */

   7571  1 000036   200003 470500                    LDP0    @KQ$CG,,AUTO
         1 000037   000244 236100                    LDQ     164,,PR0
         1 000040   200011 756100                    STQ     DGRAN$,,AUTO

      287     7572    2           DO WHILE(DGRAN$~=ADDR(NIL));

   7572  1 000041   000054 710000 1                  TRA     s:7581

      288     7573    2           IF NOT KQ$DGRAN.HDR.WRITE THEN

   7573  1 000042   200011 470500                    LDP0    DGRAN$,,AUTO
         1 000043   000001 236100                    LDQ     1,,PR0
         1 000044   000100 316003                    CANQ    64,DU
         1 000045   000051 601000 1                  TNZ     NOSPACE

      289     7574    3             DO;

      290     7575    3             CALL ALLOC ALTRET(NOSPACE);

   7575  1 000046   001470 701000 1                  TSX1    ALLOC
         1 000047   000051 702000 1                  TSX2    NOSPACE

      291     7576    3             GOTO GOTDBLK;

   7576  1 000050   000057 710000 1                  TRA     GOTDBLK

   7573  1 000051                       NOSPACE      null
      292     7577    3             END;
      293     7578        /**/
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:107  
      294     7579    2   NOSPACE: ;
      295     7580    2           DGRAN$=KQ$DGRAN.FLINK$;

   7580  1 000051   200011 470500                    LDP0    DGRAN$,,AUTO
         1 000052   000017 236100                    LDQ     15,,PR0
         1 000053   200011 756100                    STQ     DGRAN$,,AUTO

      296     7581    2           END;

   7581  1 000054   000001 116000 xsym               CMPQ    B_VECTNIL+1
         1 000055   000042 601000 1                  TNZ     s:7573

      297     7582    1         GOTO GETSPACE;

   7582  1 000056   000132 710000 1                  TRA     GETSPACE

   7572  1 000057                       GOTDBLK      null
      298     7583        /**/
      299     7584        /**/
      300     7585    1   GOTDBLK: ;
      301     7586    2         IF KQ_LOG.KQD THEN DO;

   7586  1 000057   000000 236000 xsym               LDQ     KQ_LOG
         1 000060   040000 316003                    CANQ    16384,DU
         1 000061   000107 600000 1                  TZE     s:7591

      302     7587    2           LDFR$=DFR$; LDBLK$=DBLK$;

   7587  1 000062   200007 236100                    LDQ     DFR$,,AUTO
         1 000063   200046 756100                    STQ     LDFR$,,AUTO

   7587  1 000064   200006 236100                    LDQ     DBLK$,,AUTO
         1 000065   200047 756100                    STQ     LDBLK$,,AUTO

      303     7588    2           CALL KQZ$LOG(KQ$CG,%KQLOG_DCGET,,SIZBYTES,

   7588  1 000066   200047 630500                    EPPR0   LDBLK$,,AUTO
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:108  
         1 000067   200120 450500                    STP0    I$+7,,AUTO
         1 000070   200031 631500                    EPPR1   DDA,,AUTO
         1 000071   200117 451500                    STP1    I$+6,,AUTO
         1 000072   200046 633500                    EPPR3   LDFR$,,AUTO
         1 000073   200116 453500                    STP3    I$+5,,AUTO
         1 000074   200042 634500                    EPPR4   SIZBYTES,,AUTO
         1 000075   200115 454500                    STP4    I$+4,,AUTO
         1 000076   000001 236000 xsym               LDQ     B_VECTNIL+1
         1 000077   200114 756100                    STQ     I$+3,,AUTO
         1 000100   000000 236000 2                  LDQ     0
         1 000101   200003 235100                    LDA     @KQ$CG,,AUTO
         1 000102   200112 757100                    STAQ    I$+1,,AUTO
         1 000103   200112 630500                    EPPR0   I$+1,,AUTO
         1 000104   000025 631400 xsym               EPPR1   B_VECTNIL+21
         1 000105   000000 701000 xent               TSX1    KQZ$LOG
         1 000106   000000 011000                    NOP     0

      304     7589    2           LDFR$,DDA,LDBLK$);
      305     7590    2           END;

      306     7591    1         IF DFR$~=ADDR(NIL) THEN

   7591  1 000107   200007 236100                    LDQ     DFR$,,AUTO
         1 000110   000001 116000 xsym               CMPQ    B_VECTNIL+1
         1 000111   000114 600000 1                  TZE     s:7594

      307     7592    1           CALL RELBLK;

   7592  1 000112   004244 701000 1                  TSX1    RELBLK
         1 000113   000000 011000                    NOP     0

      308     7593              %UNLOCK (G=KQ$CG.DTREE.GATE);

   7594  1 000114   200003 236100                    LDQ     @KQ$CG,,AUTO
         1 000115   000231 036003                    ADLQ    153,DU
         1 000116   200112 756100                    STQ     I$+1,,AUTO
         1 000117   200112 630500                    EPPR0   I$+1,,AUTO
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:109  
         1 000120   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 000121   000000 701000 xent               TSX1    HFC$UNLOCK
         1 000122   000000 011000                    NOP     0

      309     7596    1         PDBLK$=DBLK$;

   7596  1 000123   200006 236100                    LDQ     DBLK$,,AUTO
         1 000124   200004 470500                    LDP0    @PDBLK$,,AUTO
         1 000125   000000 756100                    STQ     0,,PR0

      310     7597    1         PDDA=DDA;

   7597  1 000126   200031 236100                    LDQ     DDA,,AUTO
         1 000127   200005 471500                    LDP1    @PDDA,,AUTO
         1 000130   100000 756100                    STQ     0,,PR1

      311     7598    1         RETURN;

   7598  1 000131   000000 702200 xent               TSX2  ! X66_ARET

   7597  1 000132                       GETSPACE     null
      312     7599        /**/
      313     7600        /* Nothing in core - invoke the space allocator */
      314     7601        /**/
      315     7602    1   GETSPACE: ;
      316     7603    1         DA=0;

   7603  1 000132   200015 450100                    STZ     DA,,AUTO

      317     7604    1         IF DFR$=ADDR(NIL) THEN

   7604  1 000133   200007 236100                    LDQ     DFR$,,AUTO
         1 000134   000001 116000 xsym               CMPQ    B_VECTNIL+1
         1 000135   000152 601000 1                  TNZ     s:7612

      318     7605    1           IF REGFLG~=0 THEN

PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:110  
   7605  1 000136   200026 235100                    LDA     REGFLG,,AUTO
         1 000137   000150 600000 1                  TZE     s:7611

      319     7606    1             IF S_TIMR~=2 AND S_CUN~=0 THEN

   7606  1 000140   000000 235000 xsym               LDA     S_TIMR
         1 000141   000002 115007                    CMPA    2,DL
         1 000142   003134 600000 1                  TZE     CREG
         1 000143   000000 235000 xsym               LDA     S_CUN
         1 000144   003134 600000 1                  TZE     CREG

      320     7607    1               CALL GETBLKR ALTRET(GET10);

   7607  1 000145   004107 701000 1                  TSX1    GETBLKR
         1 000146   000036 702000 1                  TSX2    GET10
         1 000147   000152 710000 1                  TRA     s:7612

      321     7608    1             ELSE
      322     7609    1               GOTO CREG;  /* Can't REG */
      323     7610    1           ELSE
      324     7611    1             CALL GETBLK ALTRET(NODFRBLK);

   7611  1 000150   004104 701000 1                  TSX1    GETBLK
         1 000151   003116 702000 1                  TSX2    NODFRBLK

      325     7612    2         IF KQ_LOG.KQD THEN DO;

   7612  1 000152   000000 236000 xsym               LDQ     KQ_LOG
         1 000153   040000 316003                    CANQ    16384,DU
         1 000154   000174 600000 1                  TZE     s:7617

      326     7613    2           LDFR$=DFR$;

   7613  1 000155   200007 236100                    LDQ     DFR$,,AUTO
         1 000156   200046 756100                    STQ     LDFR$,,AUTO

      327     7614    2           CALL KQZ$LOG(KQ$CG,%KQLOG_DCGDFR,,SIZBYTES,
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:111  

   7614  1 000157   200046 630500                    EPPR0   LDFR$,,AUTO
         1 000160   200116 450500                    STP0    I$+5,,AUTO
         1 000161   200042 631500                    EPPR1   SIZBYTES,,AUTO
         1 000162   200115 451500                    STP1    I$+4,,AUTO
         1 000163   000001 236000 xsym               LDQ     B_VECTNIL+1
         1 000164   200114 756100                    STQ     I$+3,,AUTO
         1 000165   000001 236000 2                  LDQ     1
         1 000166   200003 235100                    LDA     @KQ$CG,,AUTO
         1 000167   200112 757100                    STAQ    I$+1,,AUTO
         1 000170   200112 630500                    EPPR0   I$+1,,AUTO
         1 000171   000023 631400 xsym               EPPR1   B_VECTNIL+19
         1 000172   000000 701000 xent               TSX1    KQZ$LOG
         1 000173   000000 011000                    NOP     0

      328     7615    2           LDFR$);
      329     7616    2           END;

      330     7617    1         KQ$DFRBLK.DDA=SIZBYTES;

   7617  1 000174   200007 470500                    LDP0    DFR$,,AUTO
         1 000175   200042 235100                    LDA     SIZBYTES,,AUTO
         1 000176   000004 755100                    STA     4,,PR0

      331     7618    1         IF KQ$CG.GETTL$=ADDR(NIL) THEN

   7618  1 000177   200003 471500                    LDP1    @KQ$CG,,AUTO
         1 000200   100260 236100                    LDQ     176,,PR1
         1 000201   000001 116000 xsym               CMPQ    B_VECTNIL+1
         1 000202   000206 601000 1                  TNZ     s:7621

      332     7619    1           KQ$CG.GETHD$=DFR$;

   7619  1 000203   200007 236100                    LDQ     DFR$,,AUTO
         1 000204   100257 756100                    STQ     175,,PR1
         1 000205   000211 710000 1                  TRA     s:7622

PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:112  
      333     7620    1         ELSE
      334     7621    1           KQ$CG.GETTL$->KQ$DFRBLK.LNK$=DFR$;

   7621  1 000206   100260 473500                    LDP3    176,,PR1
         1 000207   200007 236100                    LDQ     DFR$,,AUTO
         1 000210   300000 756100                    STQ     0,,PR3

      335     7622    1         KQ$CG.GETTL$=DFR$;

   7622  1 000211   100260 756100                    STQ     176,,PR1

      336     7623    1         IF KQ$CG.GETFLG~=0 THEN

   7623  1 000212   100226 236100                    LDQ     150,,PR1
         1 000213   777000 316003                    CANQ    -512,DU
         1 000214   000225 600000 1                  TZE     s:7630

      337     7624    2           DO;  /* Allocator is already running */

      338     7625                %UNLOCK (G=KQ$CG.DTREE.GATE);

   7626  1 000215   200003 236100                    LDQ     @KQ$CG,,AUTO
         1 000216   000231 036003                    ADLQ    153,DU
         1 000217   200112 756100                    STQ     I$+1,,AUTO
         1 000220   200112 630500                    EPPR0   I$+1,,AUTO
         1 000221   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 000222   000000 701000 xent               TSX1    HFC$UNLOCK
         1 000223   000000 011000                    NOP     0

      339     7628    2           GOTO FTCH30; /* GET is already in progress */

   7628  1 000224   003013 710000 1                  TRA     FTCH30

      340     7629    2           END;
      341     7630    1         KQ$CG.GETFLG=%GFLG_INIT;

   7630  1 000225   001000 236003                    LDQ     512,DU
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:113  
         1 000226   100226 552140                    STBQ    150,'40'O,PR1

      342     7631    1         CALL GETINIT;  /* Initiate the allocator */

   7631  1 000227   000423 701000 1                  TSX1    GETINIT
         1 000230   000000 011000                    NOP     0

      343     7632    1         IF KQ$DFRBLK.EVNT THEN

   7632  1 000231   200007 470500                    LDP0    DFR$,,AUTO
         1 000232   000001 236100                    LDQ     1,,PR0
         1 000233   200000 316007                    CANQ    65536,DL
         1 000234   000302 600000 1                  TZE     s:7654

      344     7633    2           DO;  /* Allocation has already occurred */

      345     7634    2           IF KQ$DFRBLK.USR~=0 THEN

   7634  1 000235   000777 316007                    CANQ    511,DL
         1 000236   003013 601000 1                  TNZ     FTCH30

      346     7635    2             GOTO FTCH30; /* Must REG - have had UQA reported already */
      347     7636    2           PDBLK$=KQ$DFRBLK.DBLK$;

   7636  1 000237   000003 236100                    LDQ     3,,PR0
         1 000240   200004 471500                    LDP1    @PDBLK$,,AUTO
         1 000241   100000 756100                    STQ     0,,PR1

      348     7637    2           PSIZ=KQ$DFRBLK.DDA;

   7637  1 000242   200005 473500                    LDP3    @PDDA,,AUTO
         1 000243   000004 235100                    LDA     4,,PR0
         1 000244   300000 755100                    STA     0,,PR3

      349     7638    2           ERRCODE=KQ$DFRBLK.ERRCODE;

   7638  1 000245   000001 236100                    LDQ     1,,PR0
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:114  
         1 000246   000022 772000                    QRL     18
         1 000247   000777 376007                    ANQ     511,DL
         1 000250   200027 756100                    STQ     ERRCODE,,AUTO

      350     7639                %LOCK (G=KQ$CG.DTREE.GATE);

   7640  1 000251   200003 236100                    LDQ     @KQ$CG,,AUTO
         1 000252   000231 036003                    ADLQ    153,DU
         1 000253   200112 756100                    STQ     I$+1,,AUTO
         1 000254   200112 630500                    EPPR0   I$+1,,AUTO
         1 000255   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 000256   000000 701000 xent               TSX1    HFC$LOCK
         1 000257   000000 011000                    NOP     0

      351     7642    2           CALL RELBLK;

   7642  1 000260   004244 701000 1                  TSX1    RELBLK
         1 000261   000000 011000                    NOP     0

      352     7643                %UNLOCK (G=KQ$CG.DTREE.GATE);

   7644  1 000262   200003 236100                    LDQ     @KQ$CG,,AUTO
         1 000263   000231 036003                    ADLQ    153,DU
         1 000264   200112 756100                    STQ     I$+1,,AUTO
         1 000265   200112 630500                    EPPR0   I$+1,,AUTO
         1 000266   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 000267   000000 701000 xent               TSX1    HFC$UNLOCK
         1 000270   000000 011000                    NOP     0

      353     7646    2           IF ERRCODE~=0 THEN

   7646  1 000271   200027 235100                    LDA     ERRCODE,,AUTO
         1 000272   000301 600000 1                  TZE     s:7652

      354     7647    3             DO;

      355     7648    3             PDBLK$=ADDR(NIL);
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:115  

   7648  1 000273   000001 236000 xsym               LDQ     B_VECTNIL+1
         1 000274   200004 470500                    LDP0    @PDBLK$,,AUTO
         1 000275   000000 756100                    STQ     0,,PR0

      356     7649    3             PSIZ=ERRCODE;

   7649  1 000276   200005 471500                    LDP1    @PDDA,,AUTO
         1 000277   100000 755100                    STA     0,,PR1

      357     7650    3             ALTRETURN;

   7650  1 000300   000000 702200 xent               TSX2  ! X66_AALT

      358     7651    3             END;
      359     7652    2           RETURN;

   7652  1 000301   000000 702200 xent               TSX2  ! X66_ARET

      360     7653    2           END;
      361     7654    1         GOTO FTCH30;

   7654  1 000302   003013 710000 1                  TRA     FTCH30

      362     7655        /**/
      363     7656        /**/
      364     7657    1   INITGRAN: PROC;

   7657  1 000303   200066 741300       INITGRAN     STX1  ! P$+1,,AUTO

      365     7658
      366     7659
      367     7660    2         IF KQ$DGRAN.BTN.KEY~=' ' THEN

   7660  1 000304   200011 470500                    LDP0    DGRAN$,,AUTO
         1 000305   040000 106500                    CMPC    fill='040'O
         1 000306   000011 000010                    ADSC9   9,,PR0                   cn=0,n=8
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:116  
         1 000307   000035 000001 xsym               ADSC9   B_VECTNIL+29             cn=0,n=1
         1 000310   000313 600000 1                  TZE     s:7662

      368     7661    2           CALL SC_CGCACHESCR;  /* This is not an initialized page */

   7661  1 000311   000000 713400 xsym               CLIMB   SC_CGCACHESCR
         1 000312   000000 600000 xsid               climb   nvectors=         0

      369     7662    2         KQ$DGRAN.HDR.STAMP.GMOD=DA;

   7662  1 000313   200011 470500                    LDP0    DGRAN$,,AUTO
         1 000314   200015 236100                    LDQ     DA,,AUTO
         1 000315   000000 552104                    STBQ    0,'04'O,PR0

      370     7663    2         DBLK$=PINCRW(DGRAN$,SIZEW(KQ$DGRAN));

   7663  1 000316   200011 236100                    LDQ     DGRAN$,,AUTO
         1 000317   000040 036003                    ADLQ    32,DU
         1 000320   200006 756100                    STQ     DBLK$,,AUTO

      371     7664    2         KQ$DBLK=KQ_DBLK;

   7664  1 000321   200006 471500                    LDP1    DBLK$,,AUTO
         1 000322   000100 100400                    MLR     fill='000'O
         1 000323   000000 000030 0                  ADSC9   KQ_DBLK                  cn=0,n=24
         1 000324   100000 000030                    ADSC9   0,,PR1                   cn=0,n=24

      372     7665    2         KQ$DBLK.SIZW=1024-SIZEW(KQ$DGRAN);

   7665  1 000325   001740 220003                    LDX0    992,DU
         1 000326   100004 740100                    STX0    4,,PR1

      373     7666    2         KQ$DGRAN.AVAILX=SIZEW(KQ$DGRAN);

   7666  1 000327   000040 235007                    LDA     32,DL
         1 000330   000014 755100                    STA     12,,PR0

PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:117  
      374     7667    2         KQ$DGRAN.WRDSAVAIL=KQ$DBLK.SIZW;

   7667  1 000331   100004 236100                    LDQ     4,,PR1
         1 000332   000022 772000                    QRL     18
         1 000333   000021 756100                    STQ     17,,PR0

      375     7668    2         KQ$DGRAN.WRDSFREE = KQ$DBLK.SIZW;

   7668  1 000334   100004 236100                    LDQ     4,,PR1
         1 000335   000022 772000                    QRL     18
         1 000336   000027 756100                    STQ     23,,PR0

      376     7669    2         KQ$CG.STATS.WRDSUSED = KQ$CG.STATS.WRDSUSED + SIZEW(KQ$DGRAN);

   7669  1 000337   200003 473500                    LDP3    @KQ$CG,,AUTO
         1 000340   000040 236007                    LDQ     32,DL
         1 000341   300202 056100                    ASQ     130,,PR3

      377     7670    2         KEY.DA=DA;

   7670  1 000342   200015 235100                    LDA     DA,,AUTO
         1 000343   200016 755100                    STA     KEY,,AUTO

      378     7671    2         KEY.GARB=0;

   7671  1 000344   200017 450100                    STZ     KEY+1,,AUTO

      379     7672    2         T$=ADDR(KQ$DGRAN.BTN);

   7672  1 000345   200011 236100                    LDQ     DGRAN$,,AUTO
         1 000346   000004 036003                    ADLQ    4,DU
         1 000347   200040 756100                    STQ     T$,,AUTO

      380     7673    2         CALL KQB$INSERTNL(KQ$CG.DTREE,KEY,T$) ALTRET(TREEERR);

   7673  1 000350   200040 634500                    EPPR4   T$,,AUTO
         1 000351   200114 454500                    STP4    I$+3,,AUTO
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:118  
         1 000352   200016 635500                    EPPR5   KEY,,AUTO
         1 000353   200113 455500                    STP5    I$+2,,AUTO
         1 000354   200003 236100                    LDQ     @KQ$CG,,AUTO
         1 000355   000231 036003                    ADLQ    153,DU
         1 000356   200112 756100                    STQ     I$+1,,AUTO
         1 000357   200112 630500                    EPPR0   I$+1,,AUTO
         1 000360   000021 631400 xsym               EPPR1   B_VECTNIL+17
         1 000361   000000 701000 xent               TSX1    KQB$INSERTNL
         1 000362   000420 702000 1                  TSX2    TREEERR

      381     7674    2         KQ$DGRAN.HDR.CHAIN='1'B;  /* Now is on chain */

   7674  1 000363   200011 470500                    LDP0    DGRAN$,,AUTO
         1 000364   000020 236003                    LDQ     16,DU
         1 000365   000001 256100                    ORSQ    1,,PR0

      382     7675    2         KQ$DGRAN.HDR.UPD='1'B;  /* Update this to disk */

   7675  1 000366   000010 236003                    LDQ     8,DU
         1 000367   000001 256100                    ORSQ    1,,PR0

      383     7676    2         KQ$DGRAN.FLINK$=KQ$CG.AVAIL.HD$;

   7676  1 000370   200003 471500                    LDP1    @KQ$CG,,AUTO
         1 000371   100244 236100                    LDQ     164,,PR1
         1 000372   000017 756100                    STQ     15,,PR0

      384     7677    2         IF KQ$CG.AVAIL.TL$=ADDR(NIL) THEN

   7677  1 000373   100245 236100                    LDQ     165,,PR1
         1 000374   000001 116000 xsym               CMPQ    B_VECTNIL+1
         1 000375   000401 601000 1                  TNZ     s:7680

      385     7678    2           KQ$CG.AVAIL.TL$=DGRAN$;

   7678  1 000376   200011 236100                    LDQ     DGRAN$,,AUTO
         1 000377   100245 756100                    STQ     165,,PR1
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:119  
         1 000400   000404 710000 1                  TRA     s:7681

      386     7679    2         ELSE
      387     7680    2           KQ$CG.AVAIL.HD$->KQ$DGRAN.BLINK$=DGRAN$;

   7680  1 000401   100244 473500                    LDP3    164,,PR1
         1 000402   200011 236100                    LDQ     DGRAN$,,AUTO
         1 000403   300016 756100                    STQ     14,,PR3

      388     7681    2         KQ$CG.AVAIL.HD$=DGRAN$;

   7681  1 000404   100244 756100                    STQ     164,,PR1

      389     7682    2         CALL SSS$SYSTIME(KQ$DGRAN.HDR.WRITEUTS);

   7682  1 000405   000003 036003                    ADLQ    3,DU
         1 000406   200112 756100                    STQ     I$+1,,AUTO
         1 000407   200112 630500                    EPPR0   I$+1,,AUTO
         1 000410   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 000411   000000 701000 xent               TSX1    SSS$SYSTIME
         1 000412   000000 011000                    NOP     0

      390     7683    2         KQ$DGRAN.TIME=KQ$DGRAN.HDR.WRITEUTS;

   7683  1 000413   200011 470500                    LDP0    DGRAN$,,AUTO
         1 000414   000003 235100                    LDA     3,,PR0
         1 000415   000024 755100                    STA     20,,PR0

      391     7684    2         RETURN;

   7684  1 000416   200066 221300                    LDX1  ! P$+1,,AUTO
         1 000417   000001 702211                    TSX2  ! 1,X1

   7683  1 000420                       TREEERR      null
      392     7685        /**/
      393     7686    2   TREEERR: ;
      394     7687    2         CALL SC_CGCACHESCR;
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:120  

   7687  1 000420   000000 713400 xsym               CLIMB   SC_CGCACHESCR
         1 000421   000000 600000 xsid               climb   nvectors=         0

      395     7688    2         GOTO TREEERR;

   7688  1 000422   000420 710000 1                  TRA     TREEERR

      396     7689        /**/
      397     7690        /*S*  SCREECH_CODE: KQD-S$CGCACHESCR
      398     7691              TYPE: SCREECH
      399     7692              MESSAGE: Fatal error in comgroup data cache
      400     7693        */
      401     7694        /**/
      402     7695    2   END INITGRAN;
      403     7696        %EJECT;
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:121  
      404     7697
      405     7698
      406     7699    1   GETINIT: PROC ALTRET;

   7699  1 000423   200060 741300       GETINIT      STX1  ! CFU$+1,,AUTO

      407     7700
      408     7701    2   DCL TDFR$ PTR;
      409     7702    2   DCL GDFR$ PTR;
      410     7703    2   DCL TDGRAN$ PTR;
      411     7704    2   DCL T$ PTR;
      412     7705    2   DCL P$ PTR;
      413     7706
      414     7707    2         TDFR$=DFR$;

   7707  1 000424   200007 236100                    LDQ     DFR$,,AUTO
         1 000425   200061 756100                    STQ     TDFR$,,AUTO

      415     7708    2         GDFR$=ADDR(NIL);

   7708  1 000426   000001 236000 xsym               LDQ     B_VECTNIL+1
         1 000427   200062 756100                    STQ     GDFR$,,AUTO

      416     7709    2         TDGRAN$=DGRAN$;

   7709  1 000430   200011 236100                    LDQ     DGRAN$,,AUTO
         1 000431   200063 756100                    STQ     TDGRAN$,,AUTO

      417     7710    2         DGRAN$=ADDR(NIL);

   7710  1 000432   000001 236000 xsym               LDQ     B_VECTNIL+1
         1 000433   200011 756100                    STQ     DGRAN$,,AUTO

   7710  1 000434                       STARTGET     null
      418     7711    2   STARTGET: ;
      419     7712    2         IF KQ$CG.GETFLG=%GFLG_INIT THEN  /* Needs to be started */

PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:122  
   7712  1 000434   200003 470500                    LDP0    @KQ$CG,,AUTO
         1 000435   000226 236100                    LDQ     150,,PR0
         1 000436   777000 376003                    ANQ     -512,DU
         1 000437   001000 116003                    CMPQ    512,DU
         1 000440   000576 601000 1                  TNZ     s:7764

      420     7713    3           DO;

      421     7714    3           DFR$=KQ$CG.GETHD$;

   7714  1 000441   000257 236100                    LDQ     175,,PR0
         1 000442   200007 756100                    STQ     DFR$,,AUTO

      422     7715    3           IF DFR$=ADDR(NIL) THEN

   7715  1 000443   000001 116000 xsym               CMPQ    B_VECTNIL+1
         1 000444   000450 601000 1                  TNZ     s:7720

      423     7716    4             DO;

      424     7717    4             KQ$CG.GETFLG=0;

   7717  1 000445   000000 236003                    LDQ     0,DU
         1 000446   000226 552140                    STBQ    150,'40'O,PR0

      425     7718    4             GOTO UNLKRET;

   7718  1 000447   001376 710000 1                  TRA     UNLKRET

      426     7719    4             END;
      427     7720    4             DO WHILE(DFR$~=ADDR(NIL));

   7720  1 000450   000456 710000 1                  TRA     s:7723

      428     7721    4             KQ$DFRBLK.GFLG='1'B;

   7721  1 000451   200007 470500                    LDP0    DFR$,,AUTO
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:123  
         1 000452   040000 236007                    LDQ     16384,DL
         1 000453   000001 256100                    ORSQ    1,,PR0

      429     7722    4             DFR$=KQ$DFRBLK.LNK$;

   7722  1 000454   000000 236100                    LDQ     0,,PR0
         1 000455   200007 756100                    STQ     DFR$,,AUTO

      430     7723    4             END;

   7723  1 000456   000001 116000 xsym               CMPQ    B_VECTNIL+1
         1 000457   000451 601000 1                  TNZ     s:7721

      431     7724    3           IF KQ$CG.FREEDA~=0 THEN /* There is a list of grans */

   7724  1 000460   200003 470500                    LDP0    @KQ$CG,,AUTO
         1 000461   000226 236100                    LDQ     150,,PR0
         1 000462   000032 316000 xsym               CANQ    B_VECTNIL+26
         1 000463   000531 600000 1                  TZE     s:7744

      432     7725    3             IF KQ$CG.ADDFREE~=0 THEN

   7725  1 000464   000227 235100                    LDA     151,,PR0
         1 000465   001376 601000 1                  TNZ     UNLKRET

      433     7726    3               GOTO UNLKRET;
      434     7727    3             ELSE
      435     7728    4               DO;

      436     7729    4               CALL GETBLK ALTRET(UNLKRET);

   7729  1 000466   004104 701000 1                  TSX1    GETBLK
         1 000467   001376 702000 1                  TSX2    UNLKRET

      437     7730    4               GDFR$=DFR$;

   7730  1 000470   200007 236100                    LDQ     DFR$,,AUTO
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:124  
         1 000471   200062 756100                    STQ     GDFR$,,AUTO

      438     7731    4               KQ$DFRBLK.CODE=%KQDC_GETFREE;

   7731  1 000472   200007 470500                    LDP0    DFR$,,AUTO
         1 000473   011000 236003                    LDQ     4608,DU
         1 000474   000001 552140                    STBQ    1,'40'O,PR0

      439     7732    4               DA=KQ$CG.FREEDA;

   7732  1 000475   200003 471500                    LDP1    @KQ$CG,,AUTO
         1 000476   100226 236100                    LDQ     150,,PR1
         1 000477   000032 376000 xsym               ANQ     B_VECTNIL+26
         1 000500   200015 756100                    STQ     DA,,AUTO

      440     7733    4               KQ$DFRBLK.USR=0;

   7733  1 000501   000000 236003                    LDQ     0,DU
         1 000502   000001 552104                    STBQ    1,'04'O,PR0

      441     7734    4               KQ$CG.GETFLG=%GFLG_FREE;

   7734  1 000503   002000 236003                    LDQ     1024,DU
         1 000504   100226 552140                    STBQ    150,'40'O,PR1

      442     7735    5               IF KQ_LOG.GETP THEN DO;

   7735  1 000505   000000 236000 xsym               LDQ     KQ_LOG
         1 000506   020000 316003                    CANQ    8192,DU
         1 000507   000530 600000 1                  TZE     s:7741

      443     7736    5                 LDFR$=DFR$;

   7736  1 000510   200007 236100                    LDQ     DFR$,,AUTO
         1 000511   200046 756100                    STQ     LDFR$,,AUTO

      444     7737    5                 CALL KQZ$LOG(KQ$CG,%KQLOG_GINIT,,
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:125  

   7737  1 000512   200046 633500                    EPPR3   LDFR$,,AUTO
         1 000513   200116 453500                    STP3    I$+5,,AUTO
         1 000514   000002 236000 2                  LDQ     2
         1 000515   000001 235000 xsym               LDA     B_VECTNIL+1
         1 000516   200114 757100                    STAQ    I$+3,,AUTO
         1 000517   000003 236000 2                  LDQ     3
         1 000520   200003 235100                    LDA     @KQ$CG,,AUTO
         1 000521   200112 757100                    STAQ    I$+1,,AUTO
         1 000522   200112 630500                    EPPR0   I$+1,,AUTO
         1 000523   000023 631400 xsym               EPPR1   B_VECTNIL+19
         1 000524   000000 701000 xent               TSX1    KQZ$LOG
         1 000525   000530 702000 1                  TSX2    s:7741

      445     7738    5                 %KQDC_GETFREE,LDFR$) ALTRET(LOG2);
      446     7739    5                 RETURN;

   7739  1 000526   200060 221300                    LDX1  ! CFU$+1,,AUTO
         1 000527   000001 702211                    TSX2  ! 1,X1

      447     7740    5   LOG2:         END;
      448     7741    4               GOTO GETFREE;

   7741  1 000530   001140 710000 1                  TRA     GETFREE

      449     7742    4               END;
      450     7743    3           ELSE /* No list of grans with space avail */
      451     7744    3             IF KQ$CG.NGAVAL>KQ$CG.AUCTL.MAXPG THEN

   7744  1 000531   000133 236100                    LDQ     91,,PR0
         1 000532   000022 772000                    QRL     18
         1 000533   000217 116100                    CMPQ    143,,PR0
         1 000534   001242 603000 1                  TRC     GETNOSPACE

      452     7745    4               DO; /* There are granules left to allocate */

      453     7746    4               DA=0;
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:126  

   7746  1 000535   200015 450100                    STZ     DA,,AUTO

      454     7747    4               CALL GETBLK ALTRET(UNLKRET);

   7747  1 000536   004104 701000 1                  TSX1    GETBLK
         1 000537   001376 702000 1                  TSX2    UNLKRET

      455     7748    4               GDFR$=DFR$;

   7748  1 000540   200007 236100                    LDQ     DFR$,,AUTO
         1 000541   200062 756100                    STQ     GDFR$,,AUTO

      456     7749    4               KQ$DFRBLK.CODE=%KQDC_GETNEW;

   7749  1 000542   200007 470500                    LDP0    DFR$,,AUTO
         1 000543   012000 236003                    LDQ     5120,DU
         1 000544   000001 552140                    STBQ    1,'40'O,PR0

      457     7750    4               KQ$DFRBLK.USR=0;

   7750  1 000545   000000 236003                    LDQ     0,DU
         1 000546   000001 552104                    STBQ    1,'04'O,PR0

      458     7751    4               KQ$CG.GETFLG=%GFLG_NEW;

   7751  1 000547   200003 471500                    LDP1    @KQ$CG,,AUTO
         1 000550   003000 236003                    LDQ     1536,DU
         1 000551   100226 552140                    STBQ    150,'40'O,PR1

      459     7752    5               IF KQ_LOG.GETP THEN DO;

   7752  1 000552   000000 236000 xsym               LDQ     KQ_LOG
         1 000553   020000 316003                    CANQ    8192,DU
         1 000554   000575 600000 1                  TZE     s:7758

      460     7753    5                 LDFR$=DFR$;
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:127  

   7753  1 000555   200007 236100                    LDQ     DFR$,,AUTO
         1 000556   200046 756100                    STQ     LDFR$,,AUTO

      461     7754    5                 CALL KQZ$LOG(KQ$CG,%KQLOG_GINIT,,

   7754  1 000557   200046 633500                    EPPR3   LDFR$,,AUTO
         1 000560   200116 453500                    STP3    I$+5,,AUTO
         1 000561   000003 236000 2                  LDQ     3
         1 000562   000001 235000 xsym               LDA     B_VECTNIL+1
         1 000563   200114 757100                    STAQ    I$+3,,AUTO
         1 000564   000003 236000 2                  LDQ     3
         1 000565   200003 235100                    LDA     @KQ$CG,,AUTO
         1 000566   200112 757100                    STAQ    I$+1,,AUTO
         1 000567   200112 630500                    EPPR0   I$+1,,AUTO
         1 000570   000023 631400 xsym               EPPR1   B_VECTNIL+19
         1 000571   000000 701000 xent               TSX1    KQZ$LOG
         1 000572   000575 702000 1                  TSX2    s:7758

      462     7755    5                 %KQDC_GETNEW,LDFR$) ALTRET(LOG3);
      463     7756    5                 RETURN;

   7756  1 000573   200060 221300                    LDX1  ! CFU$+1,,AUTO
         1 000574   000001 702211                    TSX2  ! 1,X1

      464     7757    5   LOG3:         END;
      465     7758    4               GOTO GETNEW5;

   7758  1 000575   001204 710000 1                  TRA     GETNEW5

      466     7759    4               END;
      467     7760    3             ELSE
      468     7761    3               GOTO GETNOSPACE; /* No space left */
      469     7762    3           END;
      470     7763        /**/
      471     7764    2         GOTO UNLKRET;

PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:128  
   7764  1 000576   001376 710000 1                  TRA     UNLKRET

      472     7765        /**/
      473     7766        /**/
      474     7767
      475     7768
      476     7769    2   GETPROCESS: ENTRY ALTRET;

   7769  1 000577   200060 741300       GETPROCESS   STX1  ! CFU$+1,,AUTO

      477     7770
      478     7771
      479     7772    3         IF KQ_LOG.GETP THEN DO;

   7772  1 000600   000000 236000 xsym               LDQ     KQ_LOG
         1 000601   020000 316003                    CANQ    8192,DU
         1 000602   000642 600000 1                  TZE     s:7782

      480     7773    3           IF DFR$~=ADDR(NIL) THEN

   7773  1 000603   200007 236100                    LDQ     DFR$,,AUTO
         1 000604   000001 116000 xsym               CMPQ    B_VECTNIL+1
         1 000605   000613 600000 1                  TZE     s:7776

      481     7774    3             I=KQ$DFRBLK.CODE;

   7774  1 000606   200007 470500                    LDP0    DFR$,,AUTO
         1 000607   000001 236100                    LDQ     1,,PR0
         1 000610   000033 772000                    QRL     27
         1 000611   200012 756100                    STQ     I,,AUTO
         1 000612   000614 710000 1                  TRA     s:7777

      482     7775    3           ELSE
      483     7776    3             I=0;

   7776  1 000613   200012 450100                    STZ     I,,AUTO

PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:129  
      484     7777    3           LDFR$=DFR$; LDGRAN$=DGRAN$;

   7777  1 000614   200007 236100                    LDQ     DFR$,,AUTO
         1 000615   200046 756100                    STQ     LDFR$,,AUTO

   7777  1 000616   200011 236100                    LDQ     DGRAN$,,AUTO
         1 000617   200050 756100                    STQ     LDGRAN$,,AUTO

      485     7778    3           CALL KQZ$LOG(KQ$CG,%KQLOG_GPROC,,I,

   7778  1 000620   200050 630500                    EPPR0   LDGRAN$,,AUTO
         1 000621   200120 450500                    STP0    I$+7,,AUTO
         1 000622   000001 236000 xsym               LDQ     B_VECTNIL+1
         1 000623   200117 756100                    STQ     I$+6,,AUTO
         1 000624   200046 631500                    EPPR1   LDFR$,,AUTO
         1 000625   200116 451500                    STP1    I$+5,,AUTO
         1 000626   200012 633500                    EPPR3   I,,AUTO
         1 000627   200115 453500                    STP3    I$+4,,AUTO
         1 000630   200114 756100                    STQ     I$+3,,AUTO
         1 000631   000004 236000 2                  LDQ     4
         1 000632   200003 235100                    LDA     @KQ$CG,,AUTO
         1 000633   200112 757100                    STAQ    I$+1,,AUTO
         1 000634   200112 630500                    EPPR0   I$+1,,AUTO
         1 000635   000025 631400 xsym               EPPR1   B_VECTNIL+21
         1 000636   000000 701000 xent               TSX1    KQZ$LOG
         1 000637   000642 702000 1                  TSX2    s:7782

      486     7779    3           LDFR$,,LDGRAN$) ALTRET(LOG4);
      487     7780    3           RETURN;  /* Never comes here */

   7780  1 000640   200060 221300                    LDX1  ! CFU$+1,,AUTO
         1 000641   000001 702211                    TSX2  ! 1,X1

      488     7781    3   LOG4:   END;
      489     7782    2         TDFR$=DFR$;

   7782  1 000642   200007 236100                    LDQ     DFR$,,AUTO
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:130  
         1 000643   200061 756100                    STQ     TDFR$,,AUTO

      490     7783    2         GDFR$=DFR$;

   7783  1 000644   200062 756100                    STQ     GDFR$,,AUTO

      491     7784    2         TDGRAN$=DGRAN$;

   7784  1 000645   200011 236100                    LDQ     DGRAN$,,AUTO
         1 000646   200063 756100                    STQ     TDGRAN$,,AUTO

      492     7785    2         IF DGRAN$=ADDR(NIL) THEN

   7785  1 000647   000001 116000 xsym               CMPQ    B_VECTNIL+1
         1 000650   001055 600000 1                  TZE     NOALLOC5

      493     7786    2           GOTO NOALLOC5;  /* Didn't get the granule */
      494     7787    2         IF DFR$~=ADDR(NIL) THEN

   7787  1 000651   200007 236100                    LDQ     DFR$,,AUTO
         1 000652   000001 116000 xsym               CMPQ    B_VECTNIL+1
         1 000653   000661 600000 1                  TZE     LOOP

      495     7788    2           IF KQ$DFRBLK.CODE=%KQDC_GETNEW THEN

   7788  1 000654   200007 470500                    LDP0    DFR$,,AUTO
         1 000655   000001 236100                    LDQ     1,,PR0
         1 000656   777000 376003                    ANQ     -512,DU
         1 000657   012000 116003                    CMPQ    5120,DU
         1 000660   001177 600000 1                  TZE     GETNEW

   7787  1 000661                       LOOP         null
      496     7789    2             GOTO GETNEW;
      497     7790    2   LOOP: ;
      498     7791    2         T$=KQ$CG.GETHD$;

   7791  1 000661   200003 470500                    LDP0    @KQ$CG,,AUTO
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:131  
         1 000662   000257 236100                    LDQ     175,,PR0
         1 000663   200064 756100                    STQ     T$,,AUTO

      499     7792    2         P$=ADDR(NIL);

   7792  1 000664   000001 236000 xsym               LDQ     B_VECTNIL+1
         1 000665   200065 756100                    STQ     P$,,AUTO

      500     7793    3           DO WHILE(T$~=ADDR(NIL));

   7793  1 000666   001011 710000 1                  TRA     s:7828

      501     7794    3           DFR$=T$;

   7794  1 000667   200064 236100                    LDQ     T$,,AUTO
         1 000670   200007 756100                    STQ     DFR$,,AUTO

      502     7795    3           T$=KQ$DFRBLK.LNK$;

   7795  1 000671   200007 470500                    LDP0    DFR$,,AUTO
         1 000672   000000 236100                    LDQ     0,,PR0
         1 000673   200064 756100                    STQ     T$,,AUTO

      503     7796    3           SIZBYTES=KQ$DFRBLK.DDA;

   7796  1 000674   000004 235100                    LDA     4,,PR0
         1 000675   200042 755100                    STA     SIZBYTES,,AUTO

      504     7797    3           IF NOT KQ$DFRBLK.ABORT THEN

   7797  1 000676   000001 236100                    LDQ     1,,PR0
         1 000677   100000 316007                    CANQ    32768,DL
         1 000700   000704 601000 1                  TNZ     s:7801

      505     7798    3             CALL ALLOC ALTRET(NOALLOC);

   7798  1 000701   001470 701000 1                  TSX1    ALLOC
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:132  
         1 000702   001007 702000 1                  TSX2    NOALLOC
         1 000703   000707 710000 1                  TRA     s:7804

      506     7799    3           ELSE
      507     7800    4             DO;  /* Caller aborted the get - ignore it */

      508     7801    4             DBLK$=ADDR(NIL);

   7801  1 000704   000001 236000 xsym               LDQ     B_VECTNIL+1
         1 000705   200006 756100                    STQ     DBLK$,,AUTO

      509     7802    4             DDA='0'B;

   7802  1 000706   200031 450100                    STZ     DDA,,AUTO

      510     7803    4             END;

      511     7804    3           IF P$~=ADDR(NIL) THEN

   7804  1 000707   200065 236100                    LDQ     P$,,AUTO
         1 000710   000001 116000 xsym               CMPQ    B_VECTNIL+1
         1 000711   000715 600000 1                  TZE     s:7806

      512     7805    3             P$->KQ$DFRBLK.LNK$=T$;

   7805  1 000712   200064 236100                    LDQ     T$,,AUTO
         1 000713   200065 470500                    LDP0    P$,,AUTO
         1 000714   000000 756100                    STQ     0,,PR0

      513     7806    3           IF KQ$CG.GETHD$=DFR$ THEN

   7806  1 000715   200003 470500                    LDP0    @KQ$CG,,AUTO
         1 000716   000257 236100                    LDQ     175,,PR0
         1 000717   200007 116100                    CMPQ    DFR$,,AUTO
         1 000720   000723 601000 1                  TNZ     s:7808

      514     7807    3             KQ$CG.GETHD$=T$;
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:133  

   7807  1 000721   200064 236100                    LDQ     T$,,AUTO
         1 000722   000257 756100                    STQ     175,,PR0

      515     7808    3           IF KQ$CG.GETTL$=DFR$ THEN

   7808  1 000723   000260 236100                    LDQ     176,,PR0
         1 000724   200007 116100                    CMPQ    DFR$,,AUTO
         1 000725   000730 601000 1                  TNZ     s:7810

      516     7809    3             KQ$CG.GETTL$=P$;

   7809  1 000726   200065 236100                    LDQ     P$,,AUTO
         1 000727   000260 756100                    STQ     176,,PR0

      517     7810    3           KQ$DFRBLK.DBLK$=DBLK$;

   7810  1 000730   200006 236100                    LDQ     DBLK$,,AUTO
         1 000731   200007 471500                    LDP1    DFR$,,AUTO
         1 000732   100003 756100                    STQ     3,,PR1

      518     7811    3           KQ$DFRBLK.DDA=BITBIN(DDA);

   7811  1 000733   200031 235100                    LDA     DDA,,AUTO
         1 000734   100004 755100                    STA     4,,PR1

      519     7812    3           KQ$DFRBLK.EVNT='1'B;

   7812  1 000735   200000 236007                    LDQ     65536,DL
         1 000736   100001 256100                    ORSQ    1,,PR1

      520     7813    3           KQ$DGRAN.USECNT=KQ$DGRAN.USECNT+1;  /* Dont't let it disappear */

   7813  1 000737   200011 473500                    LDP3    DGRAN$,,AUTO
         1 000740   300013 054100                    AOS     11,,PR3

      521     7814    4           IF KQ_LOG.KQD THEN DO;
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:134  

   7814  1 000741   000000 236000 xsym               LDQ     KQ_LOG
         1 000742   040000 316003                    CANQ    16384,DU
         1 000743   000772 600000 1                  TZE     s:7820

      522     7815    4             LDFR$=DFR$; LDGRAN$=DGRAN$;

   7815  1 000744   200007 236100                    LDQ     DFR$,,AUTO
         1 000745   200046 756100                    STQ     LDFR$,,AUTO

   7815  1 000746   200011 236100                    LDQ     DGRAN$,,AUTO
         1 000747   200050 756100                    STQ     LDGRAN$,,AUTO

      523     7816    4             CALL KQZ$LOG(KQ$CG,%KQLOG_DCGSAT,,,

   7816  1 000750   200047 634500                    EPPR4   LDBLK$,,AUTO
         1 000751   200120 454500                    STP4    I$+7,,AUTO
         1 000752   200031 635500                    EPPR5   DDA,,AUTO
         1 000753   200117 455500                    STP5    I$+6,,AUTO
         1 000754   200046 636500                    EPPR6   LDFR$,,AUTO
         1 000755   200116 456500                    STP6    I$+5,,AUTO
         1 000756   000001 236000 xsym               LDQ     B_VECTNIL+1
         1 000757   000001 235000 xsym               LDA     B_VECTNIL+1
         1 000760   200114 757100                    STAQ    I$+3,,AUTO
         1 000761   000005 236000 2                  LDQ     5
         1 000762   200003 235100                    LDA     @KQ$CG,,AUTO
         1 000763   200112 757100                    STAQ    I$+1,,AUTO
         1 000764   200112 630500                    EPPR0   I$+1,,AUTO
         1 000765   000025 631400 xsym               EPPR1   B_VECTNIL+21
         1 000766   000000 701000 xent               TSX1    KQZ$LOG
         1 000767   000772 702000 1                  TSX2    s:7820

      524     7817    4             LDFR$,DDA,LDBLK$) ALTRET(LOG1);
      525     7818    4             RETURN;  /* Never executed - just to get ret addr */

   7818  1 000770   200060 221300                    LDX1  ! CFU$+1,,AUTO
         1 000771   000001 702211                    TSX2  ! 1,X1
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:135  

      526     7819    4   LOG1:     END;
      527     7820    3           CALL COMP;

   7820  1 000772   006426 701000 1                  TSX1    COMP
         1 000773   000000 011000                    NOP     0

      528     7821                %LOCK (G=KQ$CG.DTREE.GATE);

   7822  1 000774   200003 236100                    LDQ     @KQ$CG,,AUTO
         1 000775   000231 036003                    ADLQ    153,DU
         1 000776   200112 756100                    STQ     I$+1,,AUTO
         1 000777   200112 630500                    EPPR0   I$+1,,AUTO
         1 001000   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 001001   000000 701000 xent               TSX1    HFC$LOCK
         1 001002   000000 011000                    NOP     0

      529     7824    3           KQ$DGRAN.USECNT=KQ$DGRAN.USECNT-1;

   7824  1 001003   200011 470500                    LDP0    DGRAN$,,AUTO
         1 001004   000001 336007                    LCQ     1,DL
         1 001005   000013 056100                    ASQ     11,,PR0

      530     7825    3           GOTO LOOP;

   7825  1 001006   000661 710000 1                  TRA     LOOP

   7824  1 001007                       NOALLOC      null
      531     7826    3   NOALLOC: ;
      532     7827    3           P$=DFR$;

   7827  1 001007   200007 236100                    LDQ     DFR$,,AUTO
         1 001010   200065 756100                    STQ     P$,,AUTO

      533     7828    3           END;

   7828  1 001011   200064 236100                    LDQ     T$,,AUTO
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:136  
         1 001012   000001 116000 xsym               CMPQ    B_VECTNIL+1
         1 001013   000667 601000 1                  TNZ     s:7794

      534     7829        /**/
      535     7830    2         DFR$=GDFR$;

   7830  1 001014   200062 236100                    LDQ     GDFR$,,AUTO
         1 001015   200007 756100                    STQ     DFR$,,AUTO

      536     7831    2         IF KQ$CG.GETHD$=ADDR(NIL) AND GDFR$~=ADDR(NIL) THEN

   7831  1 001016   200003 470500                    LDP0    @KQ$CG,,AUTO
         1 001017   000257 236100                    LDQ     175,,PR0
         1 001020   000001 116000 xsym               CMPQ    B_VECTNIL+1
         1 001021   001055 601000 1                  TNZ     NOALLOC5
         1 001022   200062 236100                    LDQ     GDFR$,,AUTO
         1 001023   000001 116000 xsym               CMPQ    B_VECTNIL+1
         1 001024   001055 600000 1                  TZE     NOALLOC5

      537     7832    3           DO;  /* GET process is complete */

      538     7833    3           KQ$CG.GETFLG=0;

   7833  1 001025   000000 236003                    LDQ     0,DU
         1 001026   000226 552140                    STBQ    150,'40'O,PR0

      539     7834    4           IF KQ_LOG.GETP THEN DO;

   7834  1 001027   000000 236000 xsym               LDQ     KQ_LOG
         1 001030   020000 316003                    CANQ    8192,DU
         1 001031   001052 600000 1                  TZE     s:7840

      540     7835    4             LDFR$=DFR$;

   7835  1 001032   200007 236100                    LDQ     DFR$,,AUTO
         1 001033   200046 756100                    STQ     LDFR$,,AUTO

PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:137  
      541     7836    4             CALL KQZ$LOG(KQ$CG,%KQLOG_GTRM,,

   7836  1 001034   200046 631500                    EPPR1   LDFR$,,AUTO
         1 001035   200116 451500                    STP1    I$+5,,AUTO
         1 001036   000001 236000 xsym               LDQ     B_VECTNIL+1
         1 001037   000001 235000 xsym               LDA     B_VECTNIL+1
         1 001040   200114 757100                    STAQ    I$+3,,AUTO
         1 001041   000007 236000 2                  LDQ     7
         1 001042   200003 235100                    LDA     @KQ$CG,,AUTO
         1 001043   200112 757100                    STAQ    I$+1,,AUTO
         1 001044   200112 630500                    EPPR0   I$+1,,AUTO
         1 001045   000023 631400 xsym               EPPR1   B_VECTNIL+19
         1 001046   000000 701000 xent               TSX1    KQZ$LOG
         1 001047   001052 702000 1                  TSX2    s:7840

      542     7837    4             ,LDFR$) ALTRET(LOG5);
      543     7838    4             RETURN;  /* Never comes here */

   7838  1 001050   200060 221300                    LDX1  ! CFU$+1,,AUTO
         1 001051   000001 702211                    TSX2  ! 1,X1

      544     7839    4   LOG5:     END;
      545     7840    3           CALL RELBLK;

   7840  1 001052   004244 701000 1                  TSX1    RELBLK
         1 001053   000000 011000                    NOP     0

      546     7841    3           GOTO UNLKRET;

   7841  1 001054   001376 710000 1                  TRA     UNLKRET

   7838  1 001055                       NOALLOC5     null
      547     7842    3           END;
      548     7843        /**/
      549     7844    2   NOALLOC5: ;
      550     7845    3           DO CASE(KQ$CG.GETFLG);

PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:138  
   7845  1 001055   200003 470500                    LDP0    @KQ$CG,,AUTO
         1 001056   000226 236100                    LDQ     150,,PR0
         1 001057   000033 772000                    QRL     27
         1 001060   000004 116007                    CMPQ    4,DL
         1 001061   001063 602006 1                  TNC     NOALLOC5+6,QL
         1 001062   001376 710000 1                  TRA     UNLKRET
         1 001063   001376 710000 1                  TRA     UNLKRET
         1 001064   001375 710000 1                  TRA     s:7955
         1 001065   001067 710000 1                  TRA     s:7847
         1 001066   001174 710000 1                  TRA     s:7881

      551     7846    3             CASE(%GFLG_FREE);

      552     7847    3               IF DFR$=ADDR(NIL) THEN

   7847  1 001067   200007 236100                    LDQ     DFR$,,AUTO
         1 001070   000001 116000 xsym               CMPQ    B_VECTNIL+1
         1 001071   001376 600000 1                  TZE     UNLKRET

      553     7848    3                 GOTO UNLKRET;  /* This is not the GET process */
      554     7849    3               IF DGRAN$=ADDR(NIL) THEN

   7849  1 001072   200011 236100                    LDQ     DGRAN$,,AUTO
         1 001073   000001 116000 xsym               CMPQ    B_VECTNIL+1
         1 001074   001077 601000 1                  TNZ     s:7852

      555     7850    3                 DA=0;

   7850  1 001075   200015 450100                    STZ     DA,,AUTO
         1 001076   001102 710000 1                  TRA     s:7853

      556     7851    3               ELSE
      557     7852    3                 DA=KQ$DGRAN.FREEFLINK;

   7852  1 001077   200011 471500                    LDP1    DGRAN$,,AUTO
         1 001100   100023 235100                    LDA     19,,PR1
         1 001101   200015 755100                    STA     DA,,AUTO
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:139  

      558     7853    3               IF DA=0 THEN

   7853  1 001102   200015 235100                    LDA     DA,,AUTO
         1 001103   001140 601000 1                  TNZ     GETFREE

      559     7854    4                 DO; /* At end of free gran list */

      560     7855    4                 KQ$CG.GETFLG=%GFLG_NEW;

   7855  1 001104   003000 236003                    LDQ     1536,DU
         1 001105   000226 552140                    STBQ    150,'40'O,PR0

      561     7856    4                 KQ$DFRBLK.CODE=%KQDC_GETNEW;

   7856  1 001106   200007 471500                    LDP1    DFR$,,AUTO
         1 001107   012000 236003                    LDQ     5120,DU
         1 001110   100001 552140                    STBQ    1,'40'O,PR1

      562     7857    4                 KQ$DFRBLK.DA=0;

   7857  1 001111   100002 450100                    STZ     2,,PR1

      563     7858    4                 TDGRAN$=ADDR(NIL);

   7858  1 001112   000001 236000 xsym               LDQ     B_VECTNIL+1
         1 001113   200063 756100                    STQ     TDGRAN$,,AUTO

      564     7859    5                 IF KQ_LOG.GETP THEN DO;

   7859  1 001114   000000 236000 xsym               LDQ     KQ_LOG
         1 001115   020000 316003                    CANQ    8192,DU
         1 001116   001137 600000 1                  TZE     s:7865

      565     7860    5                   LDFR$=DFR$;

   7860  1 001117   200007 236100                    LDQ     DFR$,,AUTO
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:140  
         1 001120   200046 756100                    STQ     LDFR$,,AUTO

      566     7861    5                   CALL KQZ$LOG(KQ$CG,%KQLOG_GINIT,,

   7861  1 001121   200046 633500                    EPPR3   LDFR$,,AUTO
         1 001122   200116 453500                    STP3    I$+5,,AUTO
         1 001123   000003 236000 2                  LDQ     3
         1 001124   000001 235000 xsym               LDA     B_VECTNIL+1
         1 001125   200114 757100                    STAQ    I$+3,,AUTO
         1 001126   000003 236000 2                  LDQ     3
         1 001127   200003 235100                    LDA     @KQ$CG,,AUTO
         1 001130   200112 757100                    STAQ    I$+1,,AUTO
         1 001131   200112 630500                    EPPR0   I$+1,,AUTO
         1 001132   000023 631400 xsym               EPPR1   B_VECTNIL+19
         1 001133   000000 701000 xent               TSX1    KQZ$LOG
         1 001134   001137 702000 1                  TSX2    s:7865

      567     7862    5                   %KQDC_GETNEW,LDFR$) ALTRET(LOG6);
      568     7863    5                   RETURN;  /* Never comes here */

   7863  1 001135   200060 221300                    LDX1  ! CFU$+1,,AUTO
         1 001136   000001 702211                    TSX2  ! 1,X1

      569     7864    5   LOG6:           END;
      570     7865    4                 GOTO GETNEW;

   7865  1 001137   001177 710000 1                  TRA     GETNEW

   7862  1 001140                       GETFREE      null
      571     7866    4                 END;
      572     7867    3   GETFREE:    ;
      573     7868    3               KQ$DFRBLK.DA=DA;

   7868  1 001140   200007 470500                    LDP0    DFR$,,AUTO
         1 001141   200015 235100                    LDA     DA,,AUTO
         1 001142   000002 755100                    STA     2,,PR0

PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:141  
      574     7869    3               KEY.DA=DA;

   7869  1 001143   200015 236100                    LDQ     DA,,AUTO
         1 001144   200016 756100                    STQ     KEY,,AUTO

      575     7870    3               KEY.GARB=0;

   7870  1 001145   200017 450100                    STZ     KEY+1,,AUTO

      576     7871    3               CALL KQB$SRCH(KQ$CG.DTREE,KEY,LDGRAN$) ALTRET(NOTIN);

   7871  1 001146   200050 631500                    EPPR1   LDGRAN$,,AUTO
         1 001147   200114 451500                    STP1    I$+3,,AUTO
         1 001150   200016 633500                    EPPR3   KEY,,AUTO
         1 001151   200113 453500                    STP3    I$+2,,AUTO
         1 001152   200003 236100                    LDQ     @KQ$CG,,AUTO
         1 001153   000231 036003                    ADLQ    153,DU
         1 001154   200112 756100                    STQ     I$+1,,AUTO
         1 001155   200112 630500                    EPPR0   I$+1,,AUTO
         1 001156   000021 631400 xsym               EPPR1   B_VECTNIL+17
         1 001157   000000 701000 xent               TSX1    KQB$SRCH
         1 001160   001171 702000 1                  TSX2    NOTIN

      577     7872    3               DGRAN$=LDGRAN$;

   7872  1 001161   200050 236100                    LDQ     LDGRAN$,,AUTO
         1 001162   200011 756100                    STQ     DGRAN$,,AUTO

      578     7873    3               DGRAN.DISP=0;

   7873  1 001163   000010 236000 2                  LDQ     8
         1 001164   200011 356100                    ANSQ    DGRAN$,,AUTO

      579     7874    3               IF NOT KQ$DGRAN.HDR.WRITE THEN

   7874  1 001165   200011 470500                    LDP0    DGRAN$,,AUTO
         1 001166   000001 236100                    LDQ     1,,PR0
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:142  
         1 001167   000100 316003                    CANQ    64,DU
         1 001170   000661 600000 1                  TZE     LOOP

   7874  1 001171                       NOTIN        null
      580     7875    3                 GOTO LOOP; /* Found one */
      581     7876    3   NOTIN:      ;
      582     7877    3               CALL READGRAN;

   7877  1 001171   004326 701000 1                  TSX1    READGRAN
         1 001172   000000 011000                    NOP     0

      583     7878    3               GOTO RET;

   7878  1 001173   001405 710000 1                  TRA     RET

      584     7879        /**/
      585     7880    3             CASE(%GFLG_NEW);

      586     7881    3               IF DFR$=ADDR(NIL) THEN

   7881  1 001174   200007 236100                    LDQ     DFR$,,AUTO
         1 001175   000001 116000 xsym               CMPQ    B_VECTNIL+1
         1 001176   001376 600000 1                  TZE     UNLKRET

   7881  1 001177                       GETNEW       null
      587     7882    3                 GOTO UNLKRET;  /* This is not the GET process */
      588     7883    3   GETNEW:     ;
      589     7884    3               IF KQ$CG.NGAVAL>KQ$CG.AUCTL.MAXPG THEN

   7884  1 001177   200003 470500                    LDP0    @KQ$CG,,AUTO
         1 001200   000133 236100                    LDQ     91,,PR0
         1 001201   000022 772000                    QRL     18
         1 001202   000217 116100                    CMPQ    143,,PR0
         1 001203   001242 603000 1                  TRC     GETNOSPACE

      590     7885    4                 DO;

PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:143  
   7878  1 001204                       GETNEW5      null
      591     7886    4   GETNEW5:      ;
      592     7887    4                 IF KQ$CG.GETHD$=ADDR(NIL) THEN

   7887  1 001204   200003 470500                    LDP0    @KQ$CG,,AUTO
         1 001205   000257 236100                    LDQ     175,,PR0
         1 001206   000001 116000 xsym               CMPQ    B_VECTNIL+1
         1 001207   001215 601000 1                  TNZ     s:7893

      593     7888    5                   DO;

      594     7889    5                   KQ$CG.GETFLG=0;

   7889  1 001210   000000 236003                    LDQ     0,DU
         1 001211   000226 552140                    STBQ    150,'40'O,PR0

      595     7890    5                   CALL RELBLK;

   7890  1 001212   004244 701000 1                  TSX1    RELBLK
         1 001213   000000 011000                    NOP     0

      596     7891    5                   GOTO UNLKALT;

   7891  1 001214   001413 710000 1                  TRA     UNLKALT

      597     7892    5                   END;
      598     7893    4                 IF TDGRAN$=ADDR(NIL) THEN

   7893  1 001215   200063 236100                    LDQ     TDGRAN$,,AUTO
         1 001216   000001 116000 xsym               CMPQ    B_VECTNIL+1
         1 001217   001223 601000 1                  TNZ     s:7896

      599     7894    4                   CALL GETPAGE ALTRET(RET);

   7894  1 001220   005302 701000 1                  TSX1    GETPAGE
         1 001221   001405 702000 1                  TSX2    RET
         1 001222   001224 710000 1                  TRA     s:7897
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:144  

      600     7895    4                 ELSE
      601     7896    4                   DGRAN$=TDGRAN$;

   7896  1 001223   200011 756100                    STQ     DGRAN$,,AUTO

      602     7897    4                 TDGRAN$=ADDR(NIL);

   7897  1 001224   000001 236000 xsym               LDQ     B_VECTNIL+1
         1 001225   200063 756100                    STQ     TDGRAN$,,AUTO

      603     7898    4                 DA=KQ$CG.HIGRANS+FM_FRZERO;

   7898  1 001226   200003 470500                    LDP0    @KQ$CG,,AUTO
         1 001227   000222 236100                    LDQ     146,,PR0
         1 001230   000000 036000 xsym               ADLQ    FM_FRZERO
         1 001231   200015 756100                    STQ     DA,,AUTO

      604     7899    4                 KQ$CG.HIGRANS=KQ$CG.HIGRANS+1;

   7899  1 001232   000222 235100                    LDA     146,,PR0
         1 001233   000001 035007                    ADLA    1,DL
         1 001234   000222 755100                    STA     146,,PR0

      605     7900    4                 KQ$DFRBLK.DA=DA;

   7900  1 001235   200007 471500                    LDP1    DFR$,,AUTO
         1 001236   100002 756100                    STQ     2,,PR1

      606     7901    4                 CALL INITGRAN;

   7901  1 001237   000303 701000 1                  TSX1    INITGRAN
         1 001240   000000 011000                    NOP     0

      607     7902    4                 GOTO LOOP;

   7902  1 001241   000661 710000 1                  TRA     LOOP
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:145  

      608     7903    4                 END;
      609     7904        /**/
      610     7905        /* No space is available  */
      611     7906        /**/
      612     7907    3   GETNOSPACE: ;

   7907  1 001242                       GETNOSPACE   null
      613     7908
      614     7909    3               T$=KQ$CG.GETHD$;

   7909  1 001242   200003 470500                    LDP0    @KQ$CG,,AUTO
         1 001243   000257 236100                    LDQ     175,,PR0
         1 001244   200064 756100                    STQ     T$,,AUTO

      615     7910    3               P$=ADDR(NIL);

   7910  1 001245   000001 236000 xsym               LDQ     B_VECTNIL+1
         1 001246   200065 756100                    STQ     P$,,AUTO

      616     7911    4                 DO WHILE(T$~=ADDR(NIL));

   7911  1 001247   001325 710000 1                  TRA     s:7932

      617     7912    4                 DFR$=T$;

   7912  1 001250   200064 236100                    LDQ     T$,,AUTO
         1 001251   200007 756100                    STQ     DFR$,,AUTO

      618     7913    4                 T$=KQ$DFRBLK.LNK$;

   7913  1 001252   200007 470500                    LDP0    DFR$,,AUTO
         1 001253   000000 236100                    LDQ     0,,PR0
         1 001254   200064 756100                    STQ     T$,,AUTO

      619     7914    4                 IF KQ$DFRBLK.GFLG THEN

PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:146  
   7914  1 001255   000001 236100                    LDQ     1,,PR0
         1 001256   040000 316007                    CANQ    16384,DL
         1 001257   001323 600000 1                  TZE     s:7931

      620     7915    5                   DO; /* This one has made full cycle */

      621     7916    5                   IF P$~=ADDR(NIL) THEN

   7916  1 001260   200065 236100                    LDQ     P$,,AUTO
         1 001261   000001 116000 xsym               CMPQ    B_VECTNIL+1
         1 001262   001266 600000 1                  TZE     s:7918

      622     7917    5                     P$->KQ$DFRBLK.LNK$=T$;

   7917  1 001263   200064 236100                    LDQ     T$,,AUTO
         1 001264   200065 471500                    LDP1    P$,,AUTO
         1 001265   100000 756100                    STQ     0,,PR1

      623     7918    5                   IF KQ$CG.GETHD$=DFR$ THEN

   7918  1 001266   200003 471500                    LDP1    @KQ$CG,,AUTO
         1 001267   100257 236100                    LDQ     175,,PR1
         1 001270   200007 116100                    CMPQ    DFR$,,AUTO
         1 001271   001274 601000 1                  TNZ     s:7920

      624     7919    5                     KQ$CG.GETHD$=T$;

   7919  1 001272   200064 236100                    LDQ     T$,,AUTO
         1 001273   100257 756100                    STQ     175,,PR1

      625     7920    5                   IF KQ$CG.GETTL$=DFR$ THEN

   7920  1 001274   100260 236100                    LDQ     176,,PR1
         1 001275   200007 116100                    CMPQ    DFR$,,AUTO
         1 001276   001301 601000 1                  TNZ     s:7922

      626     7921    5                     KQ$CG.GETTL$=P$;
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:147  

   7921  1 001277   200065 236100                    LDQ     P$,,AUTO
         1 001300   100260 756100                    STQ     176,,PR1

      627     7922    5                   KQ$DFRBLK.EVNT='1'B;

   7922  1 001301   200000 236007                    LDQ     65536,DL
         1 001302   000001 256100                    ORSQ    1,,PR0

      628     7923    5                   KQ$DFRBLK.ERRCODE=%KQDE_NSPC;

   7923  1 001303   000002 236003                    LDQ     2,DU
         1 001304   000001 552120                    STBQ    1,'20'O,PR0

      629     7924    5                   CALL COMP;

   7924  1 001305   006426 701000 1                  TSX1    COMP
         1 001306   000000 011000                    NOP     0

      630     7925    5                   CALL KQS$CGFULL(KQ$CG); /* Blow everyone away */

   7925  1 001307   200003 630500                    EPPR0   @KQ$CG,,AUTO
         1 001310   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 001311   000000 701000 xent               TSX1    KQS$CGFULL
         1 001312   000000 011000                    NOP     0

      631     7926                        %LOCK (G=KQ$CG.DTREE.GATE);

   7927  1 001313   200003 236100                    LDQ     @KQ$CG,,AUTO
         1 001314   000231 036003                    ADLQ    153,DU
         1 001315   200112 756100                    STQ     I$+1,,AUTO
         1 001316   200112 630500                    EPPR0   I$+1,,AUTO
         1 001317   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 001320   000000 701000 xent               TSX1    HFC$LOCK
         1 001321   000000 011000                    NOP     0

      632     7929    5                   GOTO GETNOSPACE;
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:148  

   7929  1 001322   001242 710000 1                  TRA     GETNOSPACE

      633     7930    5                   END;
      634     7931    4                 P$=DFR$;

   7931  1 001323   200007 236100                    LDQ     DFR$,,AUTO
         1 001324   200065 756100                    STQ     P$,,AUTO

      635     7932    4                 END;

   7932  1 001325   200064 236100                    LDQ     T$,,AUTO
         1 001326   000001 116000 xsym               CMPQ    B_VECTNIL+1
         1 001327   001250 601000 1                  TNZ     s:7912

      636     7933        /**/
      637     7934    3               DFR$=GDFR$;

   7934  1 001330   200062 236100                    LDQ     GDFR$,,AUTO
         1 001331   200007 756100                    STQ     DFR$,,AUTO

      638     7935    4               IF DFR$~=ADDR(NIL) THEN DO;

   7935  1 001332   000001 116000 xsym               CMPQ    B_VECTNIL+1
         1 001333   001361 600000 1                  TZE     s:7944

      639     7936    5                 IF KQ_LOG.GETP THEN DO;

   7936  1 001334   000000 236000 xsym               LDQ     KQ_LOG
         1 001335   020000 316003                    CANQ    8192,DU
         1 001336   001357 600000 1                  TZE     s:7942

      640     7937    5                   LDFR$=DFR$;

   7937  1 001337   200007 236100                    LDQ     DFR$,,AUTO
         1 001340   200046 756100                    STQ     LDFR$,,AUTO

PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:149  
      641     7938    5                   CALL KQZ$LOG(KQ$CG,%KQLOG_GTRM,,,

   7938  1 001341   200046 630500                    EPPR0   LDFR$,,AUTO
         1 001342   200116 450500                    STP0    I$+5,,AUTO
         1 001343   000001 236000 xsym               LDQ     B_VECTNIL+1
         1 001344   000001 235000 xsym               LDA     B_VECTNIL+1
         1 001345   200114 757100                    STAQ    I$+3,,AUTO
         1 001346   000007 236000 2                  LDQ     7
         1 001347   200003 235100                    LDA     @KQ$CG,,AUTO
         1 001350   200112 757100                    STAQ    I$+1,,AUTO
         1 001351   200112 630500                    EPPR0   I$+1,,AUTO
         1 001352   000023 631400 xsym               EPPR1   B_VECTNIL+19
         1 001353   000000 701000 xent               TSX1    KQZ$LOG
         1 001354   001357 702000 1                  TSX2    s:7942

      642     7939    5                   LDFR$) ALTRET(LOG7);
      643     7940    5                   RETURN;  /* Never comes here */

   7940  1 001355   200060 221300                    LDX1  ! CFU$+1,,AUTO
         1 001356   000001 702211                    TSX2  ! 1,X1

      644     7941    5   LOG7:           END;
      645     7942    4                 CALL RELBLK;

   7942  1 001357   004244 701000 1                  TSX1    RELBLK
         1 001360   000000 011000                    NOP     0

      646     7943    4                 END;

      647     7944    3               GDFR$=ADDR(NIL);

   7944  1 001361   000001 236000 xsym               LDQ     B_VECTNIL+1
         1 001362   200062 756100                    STQ     GDFR$,,AUTO

      648     7945        /**/
      649     7946    3               IF KQ$CG.GETHD$~=ADDR(NIL) THEN

PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:150  
   7946  1 001363   200003 470500                    LDP0    @KQ$CG,,AUTO
         1 001364   000257 236100                    LDQ     175,,PR0
         1 001365   000001 116000 xsym               CMPQ    B_VECTNIL+1
         1 001366   001372 600000 1                  TZE     s:7952

      650     7947    4                 DO;

      651     7948    4                 KQ$CG.GETFLG=%GFLG_INIT;

   7948  1 001367   001000 236003                    LDQ     512,DU
         1 001370   000226 552140                    STBQ    150,'40'O,PR0

      652     7949    4                 GOTO STARTGET;

   7949  1 001371   000434 710000 1                  TRA     STARTGET

      653     7950    4                 END;
      654     7951    3               ELSE
      655     7952    3                 KQ$CG.GETFLG=0;

   7952  1 001372   000000 236003                    LDQ     0,DU
         1 001373   000226 552140                    STBQ    150,'40'O,PR0
         1 001374   001376 710000 1                  TRA     UNLKRET

      656     7953        /**/
      657     7954    3             CASE(%GFLG_INIT);

      658     7955    3               GOTO STARTGET;

   7955  1 001375   000434 710000 1                  TRA     STARTGET

      659     7956    3           END;

   7951  1 001376                       UNLKRET      null
      660     7957        /**/
      661     7958    2   UNLKRET: ;
      662     7959              %UNLOCK (G=KQ$CG.DTREE.GATE);
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:151  

   7960  1 001376   200003 236100                    LDQ     @KQ$CG,,AUTO
         1 001377   000231 036003                    ADLQ    153,DU
         1 001400   200112 756100                    STQ     I$+1,,AUTO
         1 001401   200112 630500                    EPPR0   I$+1,,AUTO
         1 001402   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 001403   000000 701000 xent               TSX1    HFC$UNLOCK
         1 001404   000000 011000                    NOP     0

   7951  1 001405                       RET          null
      663     7962    2   RET:  ;
      664     7963    2         DFR$=TDFR$;

   7963  1 001405   200061 236100                    LDQ     TDFR$,,AUTO
         1 001406   200007 756100                    STQ     DFR$,,AUTO

      665     7964    2         DGRAN$=TDGRAN$;

   7964  1 001407   200063 236100                    LDQ     TDGRAN$,,AUTO
         1 001410   200011 756100                    STQ     DGRAN$,,AUTO

      666     7965    2         RETURN;

   7965  1 001411   200060 221300                    LDX1  ! CFU$+1,,AUTO
         1 001412   000001 702211                    TSX2  ! 1,X1

   7964  1 001413                       UNLKALT      null
      667     7966        /**/
      668     7967    2   UNLKALT: ;
      669     7968              %UNLOCK (G=KQ$CG.DTREE.GATE);

   7969  1 001413   200003 236100                    LDQ     @KQ$CG,,AUTO
         1 001414   000231 036003                    ADLQ    153,DU
         1 001415   200112 756100                    STQ     I$+1,,AUTO
         1 001416   200112 630500                    EPPR0   I$+1,,AUTO
         1 001417   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 001420   000000 701000 xent               TSX1    HFC$UNLOCK
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:152  
         1 001421   000000 011000                    NOP     0

      670     7971    2         DFR$=TDFR$;

   7971  1 001422   200061 236100                    LDQ     TDFR$,,AUTO
         1 001423   200007 756100                    STQ     DFR$,,AUTO

      671     7972    2         DGRAN$=TDGRAN$;

   7972  1 001424   200063 236100                    LDQ     TDGRAN$,,AUTO
         1 001425   200011 756100                    STQ     DGRAN$,,AUTO

      672     7973    2         ALTRETURN;

   7973  1 001426   200060 221300                    LDX1  ! CFU$+1,,AUTO
         1 001427   000000 702211                    TSX2  ! 0,X1

      673     7974
      674     7975    2   END GETINIT;
      675     7976        %EJECT;
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:153  
      676     7977
      677     7978
      678     7979        /*F* NAME:         KQD$GETINIT
      679     7980             PURPOSE:      To initiate a GET SPACE operation
      680     7981        */
      681     7982
      682     7983
      683     7984        /*D* NAME:         KQD$GETINIT
      684     7985             CALL:         CALL KQD$GETINIT(KQ$CG);
      685     7986             INPUT:        KQ$CG - The comgroup context block
      686     7987             DESCRIPTION:  Initiates a GET operation if one is needed
      687     7988                           and if it is possible at this time.
      688     7989        */
      689     7990
      690     7991    1   KQD$GETINIT: ENTRY(KQ$CG) ALTRET;  /* Never ALTRETs */

   7991  1 001430   000000 700200 xent  KQD$GETINIT  TSX0  ! X66_AUTO_3
         1 001431   000122 000003                    ZERO    82,3

      691     7992
      692     7993
      693     7994    1         DFR$=ADDR(NIL);

   7994  1 001432   000001 236000 xsym               LDQ     B_VECTNIL+1
         1 001433   200007 756100                    STQ     DFR$,,AUTO

      694     7995    1         DGRAN$=ADDR(NIL);

   7995  1 001434   200011 756100                    STQ     DGRAN$,,AUTO

      695     7996              %LOCK (G=KQ$CG.DTREE.GATE);

   7997  1 001435   200003 236100                    LDQ     @KQ$CG,,AUTO
         1 001436   000231 036003                    ADLQ    153,DU
         1 001437   200112 756100                    STQ     I$+1,,AUTO
         1 001440   200112 630500                    EPPR0   I$+1,,AUTO
         1 001441   000017 631400 xsym               EPPR1   B_VECTNIL+15
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:154  
         1 001442   000000 701000 xent               TSX1    HFC$LOCK
         1 001443   000000 011000                    NOP     0

      696     7999    1         CALL GETINIT;

   7999  1 001444   000423 701000 1                  TSX1    GETINIT
         1 001445   000000 011000                    NOP     0

      697     8000    1         RETURN;

   8000  1 001446   000000 702200 xent               TSX2  ! X66_ARET

      698     8001        %EJECT;
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:155  
      699     8002
      700     8003
      701     8004        /*F* NAME:         KQD$GETPROCESS
      702     8005             PURPOSE:      To allocate space from a granule
      703     8006        */
      704     8007
      705     8008
      706     8009        /*D* NAME:         KQD$GETPROCESS
      707     8010             CALL:         CALL KQD$GETPROCESS(KQ$CG,DFR$,DGRAN$);
      708     8011             INPUT:        KQ$CG - Comgroup context block
      709     8012                           DFR$ - Ptr to the defer block controlling the
      710     8013                                  current GET operation, NIL if this call
      711     8014                                  is not for the GET operation.
      712     8015                           DGRAN$ - Ptr to the page.  NIL if no page, e.g.
      713     8016                                    there was a disk error reading it.
      714     8017             DESCRIPTION:  As many pending GET requests as possible are
      715     8018                           satisfied from this page.  If not all are
      716     8019                           satisfied, the next step in the GET operation
      717     8020                           (if called on behalf of the GET operation)
      718     8021                           is initiated.
      719     8022        */
      720     8023
      721     8024
      722     8025    1   KQD$GETPROCESS: ENTRY(KQ$CG,PDBLK$,PDDA) ALTRET;  /* Never ALTRETs */

   8025  1 001447   000000 700200 xent  KQD$GETPROC* TSX0  ! X66_AUTO_3
         1 001450   000122 000003                    ZERO    82,3

      723     8026
      724     8027
      725     8028    1         IF ADDR(PDBLK$)=ADDR(NIL) THEN

   8028  1 001451   200004 236100                    LDQ     @PDBLK$,,AUTO
         1 001452   000001 116000 xsym               CMPQ    B_VECTNIL+1
         1 001453   001457 601000 1                  TNZ     s:8031

      726     8029    1           DFR$=ADDR(NIL);
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:156  

   8029  1 001454   000001 236000 xsym               LDQ     B_VECTNIL+1
         1 001455   200007 756100                    STQ     DFR$,,AUTO
         1 001456   001462 710000 1                  TRA     s:8032

      727     8030    1         ELSE
      728     8031    1           DFR$=PDBLK$;

   8031  1 001457   200004 470500                    LDP0    @PDBLK$,,AUTO
         1 001460   000000 236100                    LDQ     0,,PR0
         1 001461   200007 756100                    STQ     DFR$,,AUTO

      729     8032    1         DGRAN$=PSTA$;

   8032  1 001462   200005 470500                    LDP0    @PDDA,,AUTO
         1 001463   000000 236100                    LDQ     0,,PR0
         1 001464   200011 756100                    STQ     DGRAN$,,AUTO

      730     8033    1         CALL GETPROCESS;

   8033  1 001465   000577 701000 1                  TSX1    GETPROCESS
         1 001466   000000 011000                    NOP     0

      731     8034    1         RETURN;

   8034  1 001467   000000 702200 xent               TSX2  ! X66_ARET

      732     8035
      733     8036
      734     8037        %EJECT;
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:157  
      735     8038
      736     8039
      737     8040    1   ALLOC: PROC ALTRET;

   8040  1 001470   200066 741300       ALLOC        STX1  ! P$+1,,AUTO

      738     8041
      739     8042    2   DCL P$ PTR;
      740     8043    2   DCL AX UBIN;
      741     8044    2   DCL NAX UBIN;
      742     8045    2   DCL BX UBIN;
      743     8046    2   DCL B$ PTR;
      744     8047    2   DCL PB$ PTR;
      745     8048    2   DCL SB SBIN;
      746     8049    2   DCL AVAILCNT UBIN;
      747     8050    2   DCL BUDDIED BIT(1) ALIGNED;
      748     8051    2   DCL SIZW UBIN;
      749     8052
      750     8053
      751     8054    2         AVAILCNT=0;

   8054  1 001471   200076 450100                    STZ     AVAILCNT,,AUTO

      752     8055    2         BUDDIED = '0'B;

   8055  1 001472   200077 450100                    STZ     BUDDIED,,AUTO

      753     8056    2         SIZW=(((SIZBYTES+3)/4+SIZEW(KQ$DBLK)+1)/2)*2;  /* # words needed */

   8056  1 001473   200042 236100                    LDQ     SIZBYTES,,AUTO
         1 001474   000003 036007                    ADLQ    3,DL
         1 001475   000002 772000                    QRL     2
         1 001476   000007 036007                    ADLQ    7,DL
         1 001477   000001 772000                    QRL     1
         1 001500   000001 736000                    QLS     1
         1 001501   200100 756100                    STQ     SIZW,,AUTO

PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:158  
      754     8057    2         P$=ADDR(NIL);

   8057  1 001502   000001 236000 xsym               LDQ     B_VECTNIL+1
         1 001503   200067 756100                    STQ     P$,,AUTO

      755     8058    2         DBLK$=PINCRW(DGRAN$,KQ$DGRAN.AVAILX);  /* Search unsorted list */

   8058  1 001504   200011 470500                    LDP0    DGRAN$,,AUTO
         1 001505   000014 720100                    LXL0    12,,PR0
         1 001506   000000 636010                    EAQ     0,X0
         1 001507   200011 036100                    ADLQ    DGRAN$,,AUTO
         1 001510   200006 756100                    STQ     DBLK$,,AUTO

      756     8059    3           DO WHILE(DBLK$~=DGRAN$);

   8059  1 001511   200011 116100                    CMPQ    DGRAN$,,AUTO
         1 001512   001646 600000 1                  TZE     CHKBUDDY

      757     8060    3           IF KQ$DBLK.LREL THEN

   8060  1 001513   200006 470500                    LDP0    DBLK$,,AUTO
         1 001514   000003 236100                    LDQ     3,,PR0
         1 001515   000100 316003                    CANQ    64,DU
         1 001516   001560 600000 1                  TZE     s:8085

      758     8061    4             DO; /* Latch released - see if really free yet */

      759     8062    5               DO INHIBIT;

      760     8063    5               IF KQ$DBLK.ACTCNT~=KQ$CG.STREE.ACTCNT THEN

   8063  1 001517   000004 720300                    LXL0  ! 4,,PR0
         1 001520   200003 471700                    LDP1  ! @KQ$CG,,AUTO
         1 001521   100102 100300                    CMPX0 ! 66,,PR1
         1 001522   001533 600200 1                  TZE   ! s:8068

      761     8064    6                 DO;
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:159  

      762     8065    6                 CHKPARM.P$=KQ$DBLK.STA$;

   8065  1 001523   000002 236300                    LDQ   ! 2,,PR0
         1 001524   200024 756300                    STQ   ! CHKPARM+2,,AUTO

      763     8066    6                 CALL KQX$CHKPTR(CHKPARM) ALTRET(RELIT);

   8066  1 001525   200022 633700                    EPPR3 ! CHKPARM,,AUTO
         1 001526   200112 453700                    STP3  ! I$+1,,AUTO
         1 001527   200112 630700                    EPPR0 ! I$+1,,AUTO
         1 001530   000017 631600 xsym               EPPR1 ! B_VECTNIL+15
         1 001531   000000 701200 xent               TSX1  ! KQX$CHKPTR
         1 001532   001541 702200 1                  TSX2  ! RELIT

      764     8067    6                 END;

      765     8068    5               IF KQ$DBLK.STA$->KQ$STA.LATCHCNT=KQ$DBLK.LATCHCNT THEN

   8068  1 001533   200006 470700                    LDP0  ! DBLK$,,AUTO
         1 001534   000002 471700                    LDP1  ! 2,,PR0
         1 001535   100015 236300                    LDQ   ! 13,,PR1
         1 001536   000003 676300                    ERQ   ! 3,,PR0
         1 001537   777000 376203                    ANQ   ! -512,DU
         1 001540   001635 600200 1                  TZE   ! NXTDBLK

      766     8069    5                 GOTO NXTDBLK;
      767     8070    5               END;

      768     8071    4   RELIT:    ;

   8071  1 001541                       RELIT        null
      769     8072    4             KQ$DBLK.LREL='0'B;

   8072  1 001541   200006 470500                    LDP0    DBLK$,,AUTO
         1 001542   000011 236000 2                  LDQ     9
         1 001543   000003 356100                    ANSQ    3,,PR0
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:160  

      770     8073
      771     8074    4             CALL COUNT_WORDS(%NONE,%ADD);

   8074  1 001544   000000 236000 2                  LDQ     0
         1 001545   200104 756100                    STQ     ADDFLG+1,,AUTO
         1 001546   000012 236000 2                  LDQ     10
         1 001547   200103 756100                    STQ     Q$+1,,AUTO
         1 001550   002215 701000 1                  TSX1    COUNT_WORDS
         1 001551   000000 011000                    NOP     0

      772     8075                  /* A DBLK that was Latched-RELeased(LREL'd) is considered
      773     8076                     AVAILable but not FREE.  Therefore when we LREL'd it
      774     8077                     we added it to the WRDSAVAIL in the granule but not the
      775     8078                     the WRDSFREE.  Now that we are about to use this DBLK
      776     8079                     we can consider it FREE so we must add it to the number
      777     8080                     of WRDSFREE.                          */
      778     8081
      779     8082    4             KQ$DBLK.STA$=ADDR(NIL);

   8082  1 001552   000001 236000 xsym               LDQ     B_VECTNIL+1
         1 001553   200006 470500                    LDP0    DBLK$,,AUTO
         1 001554   000002 756100                    STQ     2,,PR0

      780     8083    4             KQ$DGRAN.HDR.UPD='1'B;

   8083  1 001555   200011 471500                    LDP1    DGRAN$,,AUTO
         1 001556   000010 236003                    LDQ     8,DU
         1 001557   100001 256100                    ORSQ    1,,PR1

      781     8084    4             END;

      782     8085    3           AVAILCNT=AVAILCNT+1; /* Found something */

   8085  1 001560   200076 235100                    LDA     AVAILCNT,,AUTO
         1 001561   000001 035007                    ADLA    1,DL
         1 001562   200076 755100                    STA     AVAILCNT,,AUTO
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:161  

   8085  1 001563                       GOTBLK       null
      783     8086    3   GOTBLK: ;
      784     8087    3           SB=KQ$DBLK.SIZW-SIZW;

   8087  1 001563   000004 236100                    LDQ     4,,PR0
         1 001564   000022 772000                    QRL     18
         1 001565   200100 136100                    SBLQ    SIZW,,AUTO
         1 001566   200075 756100                    STQ     SB,,AUTO

      785     8088    3           IF SB>=0 THEN

   8088  1 001567   001635 604000 1                  TMI     NXTDBLK

      786     8089    4             DO INHIBIT; /* Found one big enough */

      787     8090    4             IF SB >= KQD_MINSPLIT THEN

   8090  1 001570   000056 116200 0                  CMPQ  ! KQD_MINSPLIT
         1 001571   001614 604200 1                  TMI   ! s:8102

      788     8091    5               DO; /* Big enough to split */

   8082  1 001572                       SPLIT        null
      789     8092    5   SPLIT:      ;
      790     8093    5               PINCRW(DBLK$,SB)->KQ$DBLK=KQ_DBLK;

   8093  1 001572   200075 235300                    LDA   ! SB,,AUTO
         1 001573   000002 735200                    ALS   ! 2
         1 001574   200006 470700                    LDP0  ! DBLK$,,AUTO
         1 001575   000105 100600                    MLR   ! fill='000'O
         1 001576   000000 000030 0                  ADSC9   KQ_DBLK                  cn=0,n=24
         1 001577   000000 000030                    ADSC9   0,A,PR0                  cn=0,n=24

      791     8094    5               PINCRW(DBLK$,SB)->KQ$DBLK.SIZW=SIZW;

   8094  1 001600   200100 720300                    LXL0  ! SIZW,,AUTO
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:162  
         1 001601   200075 721300                    LXL1  ! SB,,AUTO
         1 001602   000004 740311                    STX0  ! 4,X1,PR0

      792     8095                        /* Do this in a weird order so we don't lose
      793     8096                           space if we crash in the middle of the
      794     8097                           sequence */
      795     8098    5               KQ$DBLK.SIZW=KQ$DBLK.SIZW-SIZW;

   8098  1 001603   000004 236300                    LDQ   ! 4,,PR0
         1 001604   000022 772200                    QRL   ! 18
         1 001605   200100 136300                    SBLQ  ! SIZW,,AUTO
         1 001606   000000 622206                    EAX2  ! 0,QL
         1 001607   000004 742300                    STX2  ! 4,,PR0

      796     8099    5               DBLK$=PINCRW(DBLK$,KQ$DBLK.SIZW);

   8099  1 001610   000000 636212                    EAQ   ! 0,X2
         1 001611   200006 036300                    ADLQ  ! DBLK$,,AUTO
         1 001612   200006 756300                    STQ   ! DBLK$,,AUTO

      797     8100    5               END;

   8100  1 001613   001627 710200 1                  TRA   ! SETAVAIL

      798     8101    4             ELSE
      799     8102    4               IF P$=ADDR(NIL) THEN

   8102  1 001614   200067 236300                    LDQ   ! P$,,AUTO
         1 001615   000001 116200 xsym               CMPQ  ! B_VECTNIL+1
         1 001616   001624 601200 1                  TNZ   ! s:8105

      800     8103    4                 KQ$DGRAN.AVAILX=KQ$DBLK.LINKX;

   8103  1 001617   000003 236300                    LDQ   ! 3,,PR0
         1 001620   777777 376207                    ANQ   ! -1,DL
         1 001621   200011 471700                    LDP1  ! DGRAN$,,AUTO
         1 001622   100014 756300                    STQ   ! 12,,PR1
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:163  
         1 001623   001627 710200 1                  TRA   ! SETAVAIL

      801     8104    4               ELSE
      802     8105    4                 P$->KQ$DBLK.LINKX=KQ$DBLK.LINKX;

   8105  1 001624   000003 720300                    LXL0  ! 3,,PR0
         1 001625   200067 471700                    LDP1  ! P$,,AUTO
         1 001626   100003 440300                    SXL0  ! 3,,PR1

   8100  1 001627                       SETAVAIL     null
      803     8106    4   SETAVAIL: ;
      804     8107    4             CALL COUNT_WORDS(%SUBTRACT,%SUBTRACT);

   8107  1 001627   000001 236200 2                  LDQ   ! 1
         1 001630   200104 756300                    STQ   ! ADDFLG+1,,AUTO
         1 001631   200103 756300                    STQ   ! Q$+1,,AUTO
         1 001632   002215 701200 1                  TSX1  ! COUNT_WORDS
         1 001633   000000 011200                    NOP   ! 0

      805     8108    4             GOTO GOTDBLK;

   8108  1 001634   002154 710200 1                  TRA   ! GOTDBLK

      806     8109    4             END;

   8107  1 001635                       NXTDBLK      null
      807     8110    3   NXTDBLK: ;
      808     8111    3           P$=DBLK$;

   8111  1 001635   200006 236100                    LDQ     DBLK$,,AUTO
         1 001636   200067 756100                    STQ     P$,,AUTO

      809     8112    3           DBLK$=PINCRW(DGRAN$,KQ$DBLK.LINKX);

   8112  1 001637   200006 470500                    LDP0    DBLK$,,AUTO
         1 001640   000003 720100                    LXL0    3,,PR0
         1 001641   000000 636010                    EAQ     0,X0
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:164  
         1 001642   200011 036100                    ADLQ    DGRAN$,,AUTO
         1 001643   200006 756100                    STQ     DBLK$,,AUTO

      810     8113    3           END;

   8113  1 001644   200011 116100                    CMPQ    DGRAN$,,AUTO
         1 001645   001513 601000 1                  TNZ     s:8060

   8105  1 001646                       CHKBUDDY     null
      811     8114        /**/
      812     8115        /* Didn't find any useful stuff on the unsorted list in this
      813     8116           granule.  Try the unsorted list. */
      814     8117        /**/
      815     8118    2   CHKBUDDY: ;
      816     8119    2         P$=ADDR(NIL);

   8119  1 001646   000001 236000 xsym               LDQ     B_VECTNIL+1
         1 001647   200067 756100                    STQ     P$,,AUTO

      817     8120    2         DBLK$=PINCRW(DGRAN$,KQ$DGRAN.BUDDYX);

   8120  1 001650   200011 470500                    LDP0    DGRAN$,,AUTO
         1 001651   000015 720100                    LXL0    13,,PR0
         1 001652   000000 636010                    EAQ     0,X0
         1 001653   200011 036100                    ADLQ    DGRAN$,,AUTO
         1 001654   200006 756100                    STQ     DBLK$,,AUTO

      818     8121    3           DO WHILE(DBLK$~=DGRAN$);

   8121  1 001655   200011 116100                    CMPQ    DGRAN$,,AUTO
         1 001656   001716 600000 1                  TZE     s:8140

      819     8122    3           SB=KQ$DBLK.SIZW-SIZW;

   8122  1 001657   200006 470500                    LDP0    DBLK$,,AUTO
         1 001660   000004 236100                    LDQ     4,,PR0
         1 001661   000022 772000                    QRL     18
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:165  
         1 001662   200100 136100                    SBLQ    SIZW,,AUTO
         1 001663   200075 756100                    STQ     SB,,AUTO

      820     8123    3           IF SB>=0 THEN

   8123  1 001664   001703 604000 1                  TMI     s:8133

      821     8124    4             DO;

      822     8125    4             IF SB>=KQD_MINSPLIT THEN

   8125  1 001665   000056 116000 0                  CMPQ    KQD_MINSPLIT
         1 001666   001572 605000 1                  TPL     SPLIT

      823     8126    4               GOTO SPLIT;
      824     8127    4             IF P$=ADDR(NIL) THEN

   8127  1 001667   200067 236100                    LDQ     P$,,AUTO
         1 001670   000001 116000 xsym               CMPQ    B_VECTNIL+1
         1 001671   001677 601000 1                  TNZ     s:8130

      825     8128    4               KQ$DGRAN.BUDDYX=KQ$DBLK.LINKX;

   8128  1 001672   000003 236100                    LDQ     3,,PR0
         1 001673   777777 376007                    ANQ     -1,DL
         1 001674   200011 471500                    LDP1    DGRAN$,,AUTO
         1 001675   100015 756100                    STQ     13,,PR1
         1 001676   001702 710000 1                  TRA     s:8131

      826     8129    4             ELSE
      827     8130    4               P$->KQ$DBLK.LINKX=KQ$DBLK.LINKX;

   8130  1 001677   000003 720100                    LXL0    3,,PR0
         1 001700   200067 471500                    LDP1    P$,,AUTO
         1 001701   100003 440100                    SXL0    3,,PR1

      828     8131    4             GOTO SETAVAIL;
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:166  

   8131  1 001702   001627 710000 1                  TRA     SETAVAIL

      829     8132    4             END;
      830     8133    3           AVAILCNT=AVAILCNT+1;

   8133  1 001703   200076 235100                    LDA     AVAILCNT,,AUTO
         1 001704   000001 035007                    ADLA    1,DL
         1 001705   200076 755100                    STA     AVAILCNT,,AUTO

      831     8134    3           P$=DBLK$;

   8134  1 001706   200006 236100                    LDQ     DBLK$,,AUTO
         1 001707   200067 756100                    STQ     P$,,AUTO

      832     8135    3           DBLK$=PINCRW(DGRAN$,KQ$DBLK.LINKX);

   8135  1 001710   000003 720100                    LXL0    3,,PR0
         1 001711   000000 636010                    EAQ     0,X0
         1 001712   200011 036100                    ADLQ    DGRAN$,,AUTO
         1 001713   200006 756100                    STQ     DBLK$,,AUTO

      833     8136    3           END;

   8136  1 001714   200011 116100                    CMPQ    DGRAN$,,AUTO
         1 001715   001657 601000 1                  TNZ     s:8122

      834     8137        /**/
      835     8138        /* Couldn't find anything on either chain - try to buddy up. */
      836     8139        /**/
      837     8140    2         IF AVAILCNT>1 AND KQ$DGRAN.AVAILX>0 AND NOT BUDDIED THEN

   8140  1 001716   200076 235100                    LDA     AVAILCNT,,AUTO
         1 001717   000002 115007                    CMPA    2,DL
         1 001720   002152 602000 1                  TNC     s:8205
         1 001721   200011 470500                    LDP0    DGRAN$,,AUTO
         1 001722   000014 235100                    LDA     12,,PR0
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:167  
         1 001723   002152 600000 1                  TZE     s:8205
         1 001724   200077 234100                    SZN     BUDDIED,,AUTO
         1 001725   002152 604000 1                  TMI     s:8205

      838     8141    3           DO; /* It's worth trying */

      839     8142    3           BUDDIED='1'B; /* Don't come here again */

   8142  1 001726   400000 236003                    LDQ     -131072,DU
         1 001727   200077 756100                    STQ     BUDDIED,,AUTO

      840     8143    3           P$=ADDR(NIL);

   8143  1 001730   000001 236000 xsym               LDQ     B_VECTNIL+1
         1 001731   200067 756100                    STQ     P$,,AUTO

      841     8144    3           AX=KQ$DGRAN.AVAILX;

   8144  1 001732   200070 755100                    STA     AX,,AUTO

      842     8145    3           DBLK$=PINCRW(DGRAN$,AX);

   8145  1 001733   200070 236100                    LDQ     AX,,AUTO
         1 001734   000022 736000                    QLS     18
         1 001735   200011 036100                    ADLQ    DGRAN$,,AUTO
         1 001736   200006 756100                    STQ     DBLK$,,AUTO

      843     8146    4             DO WHILE(DBLK$~=DGRAN$);

   8146  1 001737   200011 116100                    CMPQ    DGRAN$,,AUTO
         1 001740   002151 600000 1                  TZE     s:8203

      844     8147    4             KQ$DGRAN.HDR.UPD='1'B;

   8147  1 001741   200011 470500                    LDP0    DGRAN$,,AUTO
         1 001742   000010 236003                    LDQ     8,DU
         1 001743   000001 256100                    ORSQ    1,,PR0
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:168  

      845     8148    4             NAX=KQ$DBLK.LINKX; /* Remember link of this one */

   8148  1 001744   200006 471500                    LDP1    DBLK$,,AUTO
         1 001745   100003 236100                    LDQ     3,,PR1
         1 001746   777777 376007                    ANQ     -1,DL
         1 001747   200071 756100                    STQ     NAX,,AUTO

      846     8149    4             IF NOT KQ$DBLK.LREL THEN

   8149  1 001750   100003 236100                    LDQ     3,,PR1
         1 001751   000100 316003                    CANQ    64,DU
         1 001752   002137 601000 1                  TNZ     s:8198

      847     8150    5               DO INHIBIT; /* Can't buddy up latch released ones */

      848     8151    5               IF P$=ADDR(NIL) THEN

   8151  1 001753   200067 236300                    LDQ   ! P$,,AUTO
         1 001754   000001 116200 xsym               CMPQ  ! B_VECTNIL+1
         1 001755   001762 601200 1                  TNZ   ! s:8154

      849     8152    5                 KQ$DGRAN.AVAILX=KQ$DBLK.LINKX;

   8152  1 001756   100003 236300                    LDQ   ! 3,,PR1
         1 001757   777777 376207                    ANQ   ! -1,DL
         1 001760   000014 756300                    STQ   ! 12,,PR0
         1 001761   001765 710200 1                  TRA   ! s:8155

      850     8153    5               ELSE
      851     8154    5                 P$->KQ$DBLK.LINKX=KQ$DBLK.LINKX;

   8154  1 001762   100003 720300                    LXL0  ! 3,,PR1
         1 001763   200067 473700                    LDP3  ! P$,,AUTO
         1 001764   300003 440300                    SXL0  ! 3,,PR3

      852     8155    5               KQ$DBLK.LINKX=0;
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:169  

   8155  1 001765   000000 220203                    LDX0  ! 0,DU
         1 001766   100003 440300                    SXL0  ! 3,,PR1

      853     8156    5               IF KQ$DGRAN.BUDDYX=0 THEN

   8156  1 001767   000015 235300                    LDA   ! 13,,PR0
         1 001770   001774 601200 1                  TNZ   ! s:8160

      854     8157    5                 KQ$DGRAN.BUDDYX=AX;

   8157  1 001771   200070 236300                    LDQ   ! AX,,AUTO
         1 001772   000015 756300                    STQ   ! 13,,PR0
         1 001773   002136 710200 1                  TRA   ! s:8196

      855     8158    5               ELSE
      856     8159    6                 DO; /* Merge into existing sorted list */

      857     8160    6                 BX=KQ$DGRAN.BUDDYX;

   8160  1 001774   200072 755300                    STA   ! BX,,AUTO

      858     8161    6                 B$=PINCRW(DGRAN$,BX);

   8161  1 001775   200072 236300                    LDQ   ! BX,,AUTO
         1 001776   000022 736200                    QLS   ! 18
         1 001777   200011 036300                    ADLQ  ! DGRAN$,,AUTO
         1 002000   200073 756300                    STQ   ! B$,,AUTO

      859     8162    6                 PB$=ADDR(NIL);

   8162  1 002001   000001 236200 xsym               LDQ   ! B_VECTNIL+1
         1 002002   200074 756300                    STQ   ! PB$,,AUTO

      860     8163    7                   DO WHILE(BX~=0);

   8163  1 002003   000000 115203                    CMPA  ! 0,DU
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:170  
         1 002004   002133 600200 1                  TZE   ! s:8194

      861     8164    7                   IF AX<BX THEN

   8164  1 002005   200070 236300                    LDQ   ! AX,,AUTO
         1 002006   200072 116300                    CMPQ  ! BX,,AUTO
         1 002007   002046 603200 1                  TRC   ! s:8179

      862     8165    8                     DO; /* Put in front of this sorted list entry */

      863     8166    8                     KQ$DBLK.LINKX=BX;

   8166  1 002010   200072 720300                    LXL0  ! BX,,AUTO
         1 002011   200006 470700                    LDP0  ! DBLK$,,AUTO
         1 002012   000003 440300                    SXL0  ! 3,,PR0

      864     8167    8                     IF PB$=ADDR(NIL) THEN

   8167  1 002013   200074 236300                    LDQ   ! PB$,,AUTO
         1 002014   000001 116200 xsym               CMPQ  ! B_VECTNIL+1
         1 002015   002022 601200 1                  TNZ   ! s:8170

      865     8168    8                       KQ$DGRAN.BUDDYX=AX;

   8168  1 002016   200011 471700                    LDP1  ! DGRAN$,,AUTO
         1 002017   200070 235300                    LDA   ! AX,,AUTO
         1 002020   100015 755300                    STA   ! 13,,PR1
         1 002021   002025 710200 1                  TRA   ! s:8171

      866     8169    8                     ELSE
      867     8170    8                       PB$->KQ$DBLK.LINKX=AX;

   8170  1 002022   200070 721300                    LXL1  ! AX,,AUTO
         1 002023   200074 471700                    LDP1  ! PB$,,AUTO
         1 002024   100003 441300                    SXL1  ! 3,,PR1

      868     8171    8                     IF AX+KQ$DBLK.SIZW=BX THEN
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:171  

   8171  1 002025   000004 236300                    LDQ   ! 4,,PR0
         1 002026   000022 772200                    QRL   ! 18
         1 002027   200070 036300                    ADLQ  ! AX,,AUTO
         1 002030   200072 116300                    CMPQ  ! BX,,AUTO
         1 002031   002045 601200 1                  TNZ   ! s:8176

      869     8172    9                       DO; /* These two buddy up */

      870     8173    9                       KQ$DBLK.LINKX=B$->KQ$DBLK.LINKX;

   8173  1 002032   200073 471700                    LDP1  ! B$,,AUTO
         1 002033   100003 721300                    LXL1  ! 3,,PR1
         1 002034   000003 441300                    SXL1  ! 3,,PR0

      871     8174    9                       KQ$DBLK.SIZW=KQ$DBLK.SIZW+B$->KQ$DBLK.SIZW;

   8174  1 002035   100004 236300                    LDQ   ! 4,,PR1
         1 002036   000022 772200                    QRL   ! 18
         1 002037   200112 756300                    STQ   ! I$+1,,AUTO
         1 002040   000004 236300                    LDQ   ! 4,,PR0
         1 002041   000022 772200                    QRL   ! 18
         1 002042   200112 036300                    ADLQ  ! I$+1,,AUTO
         1 002043   000000 621206                    EAX1  ! 0,QL
         1 002044   000004 741300                    STX1  ! 4,,PR0

      872     8175    9                       END;

      873     8176    8                     GOTO BUDDYNXT;

   8176  1 002045   002141 710200 1                  TRA   ! BUDDYNXT

      874     8177    8                     END;
      875     8178    7                   ELSE
      876     8179    7                     IF BX+B$->KQ$DBLK.SIZW=AX THEN

   8179  1 002046   200073 470700                    LDP0  ! B$,,AUTO
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:172  
         1 002047   000004 236300                    LDQ   ! 4,,PR0
         1 002050   000022 772200                    QRL   ! 18
         1 002051   200072 036300                    ADLQ  ! BX,,AUTO
         1 002052   200070 116300                    CMPQ  ! AX,,AUTO
         1 002053   002120 601200 1                  TNZ   ! s:8190

      877     8180    8                       DO; /* Buddy up after sorted one */

      878     8181    8                       B$->KQ$DBLK.SIZW=B$->KQ$DBLK.SIZW+KQ$DBLK.SIZW;

   8181  1 002054   200006 471700                    LDP1  ! DBLK$,,AUTO
         1 002055   100004 236300                    LDQ   ! 4,,PR1
         1 002056   000022 772200                    QRL   ! 18
         1 002057   200112 756300                    STQ   ! I$+1,,AUTO
         1 002060   000004 236300                    LDQ   ! 4,,PR0
         1 002061   000022 772200                    QRL   ! 18
         1 002062   200112 036300                    ADLQ  ! I$+1,,AUTO
         1 002063   000000 620206                    EAX0  ! 0,QL
         1 002064   000004 740300                    STX0  ! 4,,PR0

      879     8182    8                       IF BX+B$->KQ$DBLK.SIZW=B$->KQ$DBLK.LINKX THEN

   8182  1 002065   000004 236300                    LDQ   ! 4,,PR0
         1 002066   000022 772200                    QRL   ! 18
         1 002067   200072 036300                    ADLQ  ! BX,,AUTO
         1 002070   200112 756300                    STQ   ! I$+1,,AUTO
         1 002071   000003 236300                    LDQ   ! 3,,PR0
         1 002072   777777 376207                    ANQ   ! -1,DL
         1 002073   200113 756300                    STQ   ! I$+2,,AUTO
         1 002074   200112 236300                    LDQ   ! I$+1,,AUTO
         1 002075   200113 116300                    CMPQ  ! I$+2,,AUTO
         1 002076   002117 601200 1                  TNZ   ! s:8188

      880     8183    9                         DO;

      881     8184    9                         T$=PINCRW(DGRAN$,B$->KQ$DBLK.LINKX);

PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:173  
   8184  1 002077   000003 720300                    LXL0  ! 3,,PR0
         1 002100   000000 636210                    EAQ   ! 0,X0
         1 002101   200011 036300                    ADLQ  ! DGRAN$,,AUTO
         1 002102   200040 756300                    STQ   ! T$,,AUTO

      882     8185    9                         B$->KQ$DBLK.SIZW=B$->KQ$DBLK.SIZW+T$->KQ$DBLK.SIZW;

   8185  1 002103   200040 473700                    LDP3  ! T$,,AUTO
         1 002104   300004 236300                    LDQ   ! 4,,PR3
         1 002105   000022 772200                    QRL   ! 18
         1 002106   200112 756300                    STQ   ! I$+1,,AUTO
         1 002107   000004 236300                    LDQ   ! 4,,PR0
         1 002110   000022 772200                    QRL   ! 18
         1 002111   200112 036300                    ADLQ  ! I$+1,,AUTO
         1 002112   000000 620206                    EAX0  ! 0,QL
         1 002113   000004 740300                    STX0  ! 4,,PR0

      883     8186    9                         B$->KQ$DBLK.LINKX=T$->KQ$DBLK.LINKX;

   8186  1 002114   200040 473700                    LDP3  ! T$,,AUTO
         1 002115   300003 721300                    LXL1  ! 3,,PR3
         1 002116   000003 441300                    SXL1  ! 3,,PR0

      884     8187    9                         END;

      885     8188    8                       GOTO BUDDYNXT;

   8188  1 002117   002141 710200 1                  TRA   ! BUDDYNXT

      886     8189    8                       END;
      887     8190    7                   BX=B$->KQ$DBLK.LINKX;

   8190  1 002120   000003 236300                    LDQ   ! 3,,PR0
         1 002121   777777 376207                    ANQ   ! -1,DL
         1 002122   200072 756300                    STQ   ! BX,,AUTO

      888     8191    7                   PB$=B$;
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:174  

   8191  1 002123   200073 236300                    LDQ   ! B$,,AUTO
         1 002124   200074 756300                    STQ   ! PB$,,AUTO

      889     8192    7                   B$=PINCRW(DGRAN$,BX);

   8192  1 002125   200072 236300                    LDQ   ! BX,,AUTO
         1 002126   000022 736200                    QLS   ! 18
         1 002127   200011 036300                    ADLQ  ! DGRAN$,,AUTO
         1 002130   200073 756300                    STQ   ! B$,,AUTO

      890     8193    7                   END;

   8193  1 002131   200072 235300                    LDA   ! BX,,AUTO
         1 002132   002005 601200 1                  TNZ   ! s:8164

      891     8194    6                 PB$->KQ$DBLK.LINKX=AX;

   8194  1 002133   200070 720300                    LXL0  ! AX,,AUTO
         1 002134   200074 470700                    LDP0  ! PB$,,AUTO
         1 002135   000003 440300                    SXL0  ! 3,,PR0

      892     8195    6                 END;

      893     8196    5               END;

   8196  1 002136   002141 710000 1                  TRA     BUDDYNXT

      894     8197    4             ELSE
      895     8198    4               P$=DBLK$;

   8198  1 002137   200006 236100                    LDQ     DBLK$,,AUTO
         1 002140   200067 756100                    STQ     P$,,AUTO

   8187  1 002141                       BUDDYNXT     null
      896     8199    4   BUDDYNXT: ;
      897     8200    4             AX=NAX;
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:175  

   8200  1 002141   200071 235100                    LDA     NAX,,AUTO
         1 002142   200070 755100                    STA     AX,,AUTO

      898     8201    4             DBLK$=PINCRW(DGRAN$,AX);

   8201  1 002143   200070 236100                    LDQ     AX,,AUTO
         1 002144   000022 736000                    QLS     18
         1 002145   200011 036100                    ADLQ    DGRAN$,,AUTO
         1 002146   200006 756100                    STQ     DBLK$,,AUTO

      899     8202    4             END;

   8202  1 002147   200011 116100                    CMPQ    DGRAN$,,AUTO
         1 002150   001741 601000 1                  TNZ     s:8147

      900     8203    3           GOTO CHKBUDDY; /* Go try again */

   8203  1 002151   001646 710000 1                  TRA     CHKBUDDY

      901     8204    3           END;
      902     8205    2         ALTRETURN;

   8205  1 002152   200066 221300                    LDX1  ! P$+1,,AUTO
         1 002153   000000 702211                    TSX2  ! 0,X1

      903     8206
      904     8207        /**/
      905     8208    2   GOTDBLK:
      906     8209    2         KQ$DGRAN.USECNT=KQ$DGRAN.USECNT+1;

   8209  1 002154   200011 470500       GOTDBLK      LDP0    DGRAN$,,AUTO
         1 002155   000013 054100                    AOS     11,,PR0

      907     8210    2         KQ$DGRAN.ACTCNT=KQ$DGRAN.ACTCNT+1;

   8210  1 002156   000022 054100                    AOS     18,,PR0
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:176  

      908     8211    2         KQ$DGRAN.HDR.UPD='1'B;  /* Set granule modified */

   8211  1 002157   000010 236003                    LDQ     8,DU
         1 002160   000001 256100                    ORSQ    1,,PR0

      909     8212    2         J=KQ$DBLK.SIZW;

   8212  1 002161   200006 471500                    LDP1    DBLK$,,AUTO
         1 002162   100004 236100                    LDQ     4,,PR1
         1 002163   000022 772000                    QRL     18
         1 002164   200013 756100                    STQ     J,,AUTO

      910     8213    2         KQ$DBLK=KQ_DBLK;  /* Initialize */

   8213  1 002165   000100 100400                    MLR     fill='000'O
         1 002166   000000 000030 0                  ADSC9   KQ_DBLK                  cn=0,n=24
         1 002167   100000 000030                    ADSC9   0,,PR1                   cn=0,n=24

      911     8214    2         KQ$DBLK.SIZW=J;

   8214  1 002170   200013 720100                    LXL0    J,,AUTO
         1 002171   100004 740100                    STX0    4,,PR1

      912     8215    2         KQ$DBLK.DSIZE=SIZBYTES;  /* Data size */

   8215  1 002172   200042 721100                    LXL1    SIZBYTES,,AUTO
         1 002173   100000 441100                    SXL1    0,,PR1

      913     8216    2         KQ$DBLK.ACTIVE='1'B;

   8216  1 002174   000400 236003                    LDQ     256,DU
         1 002175   100003 256100                    ORSQ    3,,PR1

      914     8217    2         KQ$DBLK.LOCK='1'B;

   8217  1 002176   000200 236003                    LDQ     128,DU
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:177  
         1 002177   100003 256100                    ORSQ    3,,PR1

      915     8218        /**/
      916     8219    2         DDA.DA=ADDR(KQ$DGRAN.BTN.KEY)->WRD(0);

   8219  1 002200   000011 236100                    LDQ     9,,PR0
         1 002201   200031 552134                    STBQ    DDA,'34'O,AUTO

      917     8220    2         DDA.DISP=POFFW(DBLK$,DGRAN$)/2;

   8220  1 002202   200011 235100                    LDA     DGRAN$,,AUTO
         1 002203   000022 771000                    ARL     18
         1 002204   200112 755100                    STA     I$+1,,AUTO
         1 002205   200006 236100                    LDQ     DBLK$,,AUTO
         1 002206   000022 772000                    QRL     18
         1 002207   200112 136100                    SBLQ    I$+1,,AUTO
         1 002210   000002 506007                    DIV     2,DL
         1 002211   000033 736000                    QLS     27
         1 002212   200031 552140                    STBQ    DDA,'40'O,AUTO

      918     8221    2         RETURN;

   8221  1 002213   200066 221300                    LDX1  ! P$+1,,AUTO
         1 002214   000001 702211                    TSX2  ! 1,X1

      919     8222
      920     8223    2   END ALLOC;
      921     8224        %EJECT;
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:178  
      922     8225
      923     8226    1   COUNT_WORDS: PROC (AVAIL,FREE) ;

   8226  1 002215   200102 741300       COUNT_WORDS  STX1  ! DA+1,,AUTO

      924     8227
      925     8228    2   DCL AVAIL UBIN;   /* Add or Subtract from WRDSAVAIL */
      926     8229    2   DCL FREE UBIN;   /* Add or Subtract from WRDSFREE */
      927     8230
      928     8231    2         IF (FREE = %ADD) THEN

   8231  1 002216   200104 470500                    LDP0    @FREE,,AUTO
         1 002217   000000 235100                    LDA     0,,PR0
         1 002220   000001 115007                    CMPA    1,DL
         1 002221   002264 601000 1                  TNZ     s:8245

      929     8232    3           DO;

      930     8233    3           KQ$DGRAN.WRDSFREE=KQ$DGRAN.WRDSFREE+KQ$DBLK.SIZW;

   8233  1 002222   200011 471500                    LDP1    DGRAN$,,AUTO
         1 002223   200006 473500                    LDP3    DBLK$,,AUTO
         1 002224   300004 236100                    LDQ     4,,PR3
         1 002225   000022 772000                    QRL     18
         1 002226   100027 036100                    ADLQ    23,,PR1
         1 002227   100027 756100                    STQ     23,,PR1

      931     8234    3           KQ$CG.STATS.WRDSUSED = KQ$CG.STATS.WRDSUSED - KQ$DBLK.SIZW ;

   8234  1 002230   300004 236100                    LDQ     4,,PR3
         1 002231   000022 772000                    QRL     18
         1 002232   200112 756100                    STQ     I$+1,,AUTO
         1 002233   200003 474500                    LDP4    @KQ$CG,,AUTO
         1 002234   400202 236100                    LDQ     130,,PR4
         1 002235   200112 136100                    SBLQ    I$+1,,AUTO
         1 002236   400202 756100                    STQ     130,,PR4

PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:179  
      932     8235    3           IF KQ$DGRAN.WRDSFREE = %EMPTY_GRAN THEN

   8235  1 002237   100027 235100                    LDA     23,,PR1
         1 002240   001740 115007                    CMPA    992,DL
         1 002241   002351 601000 1                  TNZ     s:8270

      933     8236    4             DO;

      934     8237    4             KQ$CG.UGRANS = KQ$CG.UGRANS - 1;

   8237  1 002242   400220 235100                    LDA     144,,PR4
         1 002243   000001 135007                    SBLA    1,DL
         1 002244   400220 755100                    STA     144,,PR4

      935     8238    4             KQ$CG.NGAVAL = KQ$CG.NGAVAL + 1;

   8238  1 002245   400217 235100                    LDA     143,,PR4
         1 002246   000001 035007                    ADLA    1,DL
         1 002247   400217 755100                    STA     143,,PR4

      936     8239    4             IF (KQ$CG.TRIGGERED) AND (KQ$CG.NGAVAL >=

   8239  1 002250   400216 236100                    LDQ     142,,PR4
         1 002251   000400 316007                    CANQ    256,DL
         1 002252   002351 600000 1                  TZE     s:8270
         1 002253   400141 236100                    LDQ     97,,PR4
         1 002254   000022 772000                    QRL     18
         1 002255   400224 036100                    ADLQ    148,,PR4
         1 002256   400217 116100                    CMPQ    143,,PR4
         1 002257   002261 600000 1                  TZE     s:8241
         1 002260   002351 603000 1                  TRC     s:8270

      937     8240    4             KQ$CG.TRIGGER + KQ$CG.AUCTL.REDISKWARN)
      938     8241    4             THEN KQ$CG.TRIGGERED = '0'B;

   8241  1 002261   000013 236000 2                  LDQ     11
         1 002262   400216 356100                    ANSQ    142,,PR4
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:180  

      939     8242    4             END;

      940     8243    3           END;

   8243  1 002263   002351 710000 1                  TRA     s:8270

      941     8244    2         ELSE
      942     8245    2           IF (FREE=%SUBTRACT) THEN

   8245  1 002264   000002 115007                    CMPA    2,DL
         1 002265   002351 601000 1                  TNZ     s:8270

      943     8246    3             DO;

      944     8247    3             IF KQ$DGRAN.WRDSFREE = %EMPTY_GRAN THEN

   8247  1 002266   200011 471500                    LDP1    DGRAN$,,AUTO
         1 002267   100027 235100                    LDA     23,,PR1
         1 002270   001740 115007                    CMPA    992,DL
         1 002271   002334 601000 1                  TNZ     s:8266

      945     8248    4               DO;

      946     8249    4               KQ$CG.NGAVAL = KQ$CG.NGAVAL - 1;

   8249  1 002272   200003 473500                    LDP3    @KQ$CG,,AUTO
         1 002273   300217 235100                    LDA     143,,PR3
         1 002274   000001 135007                    SBLA    1,DL
         1 002275   300217 755100                    STA     143,,PR3

      947     8250    4               KQ$CG.UGRANS = KQ$CG.UGRANS + 1;

   8250  1 002276   300220 235100                    LDA     144,,PR3
         1 002277   000001 035007                    ADLA    1,DL
         1 002300   300220 755100                    STA     144,,PR3

PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:181  
      948     8251    4               IF (NOT KQ$CG.TRIGGERED) AND (KQ$CG.NGAVAL<=

   8251  1 002301   300216 236100                    LDQ     142,,PR3
         1 002302   000400 316007                    CANQ    256,DL
         1 002303   002334 601000 1                  TNZ     s:8266
         1 002304   300224 236100                    LDQ     148,,PR3
         1 002305   300217 116100                    CMPQ    143,,PR3
         1 002306   002334 602000 1                  TNC     s:8266

      949     8252    4               KQ$CG.TRIGGER) THEN
      950     8253    5                 DO;

      951     8254                      %LOCK (G=KQ$CG.GATE.CG);

   8255  1 002307   200003 236100                    LDQ     @KQ$CG,,AUTO
         1 002310   000107 036003                    ADLQ    71,DU
         1 002311   200112 756100                    STQ     I$+1,,AUTO
         1 002312   200112 630500                    EPPR0   I$+1,,AUTO
         1 002313   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 002314   000000 701000 xent               TSX1    HFC$LOCK
         1 002315   000000 011000                    NOP     0

      952     8257    5                 KQ$CG.DELAY.DISKWARN='1'B;

   8257  1 002316   200003 470500                    LDP0    @KQ$CG,,AUTO
         1 002317   001000 236003                    LDQ     512,DU
         1 002320   000020 256100                    ORSQ    16,,PR0

      953     8258    5                 KQ$CG.TRIGGERED = '1'B;

   8258  1 002321   000400 236007                    LDQ     256,DL
         1 002322   000216 256100                    ORSQ    142,,PR0

      954     8259    5                 KQ$CG.BASEDELAY=KQ$CG.BASEDELAY+1;

   8259  1 002323   000025 054100                    AOS     21,,PR0

PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:182  
      955     8260    5                 KQ_BASEDELAY=KQ_BASEDELAY+1;

   8260  1 002324   000000 054000 xsym               AOS     KQ_BASEDELAY

      956     8261                      %UNLOCK (G=KQ$CG.GATE.CG);

   8262  1 002325   200003 236100                    LDQ     @KQ$CG,,AUTO
         1 002326   000107 036003                    ADLQ    71,DU
         1 002327   200112 756100                    STQ     I$+1,,AUTO
         1 002330   200112 630500                    EPPR0   I$+1,,AUTO
         1 002331   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 002332   000000 701000 xent               TSX1    HFC$UNLOCK
         1 002333   000000 011000                    NOP     0

      957     8264    5                 END;

      958     8265    4               END;

      959     8266    3             KQ$DGRAN.WRDSFREE=KQ$DGRAN.WRDSFREE-KQ$DBLK.SIZW;

   8266  1 002334   200006 470500                    LDP0    DBLK$,,AUTO
         1 002335   000004 236100                    LDQ     4,,PR0
         1 002336   000022 772000                    QRL     18
         1 002337   200112 756100                    STQ     I$+1,,AUTO
         1 002340   200011 471500                    LDP1    DGRAN$,,AUTO
         1 002341   100027 236100                    LDQ     23,,PR1
         1 002342   200112 136100                    SBLQ    I$+1,,AUTO
         1 002343   100027 756100                    STQ     23,,PR1

      960     8267    3             KQ$CG.STATS.WRDSUSED = KQ$CG.STATS.WRDSUSED + KQ$DBLK.SIZW ;

   8267  1 002344   200003 473500                    LDP3    @KQ$CG,,AUTO
         1 002345   000004 236100                    LDQ     4,,PR0
         1 002346   000022 772000                    QRL     18
         1 002347   300202 036100                    ADLQ    130,,PR3
         1 002350   300202 756100                    STQ     130,,PR3

PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:183  
      961     8268    3             END;

      962     8269
      963     8270    2         IF (AVAIL = %ADD) THEN

   8270  1 002351   200103 470500                    LDP0    @AVAIL,,AUTO
         1 002352   000000 235100                    LDA     0,,PR0
         1 002353   000001 115007                    CMPA    1,DL
         1 002354   002364 601000 1                  TNZ     s:8273

      964     8271    2           KQ$DGRAN.WRDSAVAIL=KQ$DGRAN.WRDSAVAIL+KQ$DBLK.SIZW;

   8271  1 002355   200011 471500                    LDP1    DGRAN$,,AUTO
         1 002356   200006 473500                    LDP3    DBLK$,,AUTO
         1 002357   300004 236100                    LDQ     4,,PR3
         1 002360   000022 772000                    QRL     18
         1 002361   100021 036100                    ADLQ    17,,PR1
         1 002362   100021 756100                    STQ     17,,PR1
         1 002363   002376 710000 1                  TRA     s:8276

      965     8272    2         ELSE
      966     8273    2           IF (AVAIL=%SUBTRACT) THEN

   8273  1 002364   000002 115007                    CMPA    2,DL
         1 002365   002376 601000 1                  TNZ     s:8276

      967     8274    2             KQ$DGRAN.WRDSAVAIL=KQ$DGRAN.WRDSAVAIL-KQ$DBLK.SIZW;

   8274  1 002366   200006 471500                    LDP1    DBLK$,,AUTO
         1 002367   100004 236100                    LDQ     4,,PR1
         1 002370   000022 772000                    QRL     18
         1 002371   200112 756100                    STQ     I$+1,,AUTO
         1 002372   200011 473500                    LDP3    DGRAN$,,AUTO
         1 002373   300021 236100                    LDQ     17,,PR3
         1 002374   200112 136100                    SBLQ    I$+1,,AUTO
         1 002375   300021 756100                    STQ     17,,PR3

PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:184  
      968     8275
      969     8276    2         RETURN ;

   8276  1 002376   200102 221300                    LDX1  ! DA+1,,AUTO
         1 002377   000001 702211                    TSX2  ! 1,X1

      970     8277    2   END COUNT_WORDS;
      971     8278
      972     8279        /*F* NAME:         KQD$FETCH
      973     8280
      974     8281             PURPOSE:      Find a specific data block.
      975     8282
      976     8283        */
      977     8284
      978     8285
      979     8286
      980     8287        /*D* NAME:         KQD$FETCH
      981     8288
      982     8289             ENTRY:        KQD$FETCHR
      983     8290
      984     8291             CALL:         CALL KQD$FETCH(KQ$CG,DBLK$,DDA) ALTRET(LOC);
      985     8292
      986     8293             INPUT:        KQ$CG - Comgroup context block
      987     8294                           DBLK$ - Stamp which must be in data block
      988     8295                           DDA - Data disk address of desired block
      989     8296
      990     8297             OUTPUT:       DBLK$ - Pointer to data block
      991     8298                           DDA - Error code if ALTRET, otherwise unchanged
      992     8299
      993     8300             DESCRIPTION:
      994     8301                   Normal return:
      995     8302                           DBLK$ - Pointer to the data block
      996     8303
      997     8304                   ALternate return:
      998     8305                           If DBLK$ is ADDR(NIL), then DDA contains the error
      999     8306                           code. A code of KQDE_NDFRBLK means the call must be
     1000     8307                           re-issued later (out of defer blocks).
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:185  
     1001     8308
     1002     8309                           If DBLK$ is not ADDR(NIL), it is the pointer to
     1003     8310                           a defer block that must be passed to KQD$DEFERGO
     1004     8311                           when it is alright to proceed.
     1005     8312
     1006     8313                           FETCHR, if called by a user, will REG until the
     1007     8314                           operation completes (will never return a defer
     1008     8315                           block ptr).  If called not on behalf of a user,
     1009     8316                           will return the error KQDE_CREG if the item is
     1010     8317                           not in core.
     1011     8318
     1012     8319        */
     1013     8320
     1014     8321
     1015     8322        %EJECT;
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:186  
     1016     8323
     1017     8324
     1018     8325    1   KQD$FETCH: ENTRY(KQ$CG,PDBLK$,PDDA) ALTRET;

   8325  1 002400   000000 700200 xent  KQD$FETCH    TSX0  ! X66_AUTO_3
         1 002401   000122 000003                    ZERO    82,3

     1019     8326
     1020     8327    1         REGFLG=0;

   8327  1 002402   200026 450100                    STZ     REGFLG,,AUTO

     1021     8328    1         GOTO FTCH5;

   8328  1 002403   002410 710000 1                  TRA     FTCH5

     1022     8329
     1023     8330    1   KQD$FETCHR: ENTRY(KQ$CG,PDBLK$,PDDA) ALTRET;

   8330  1 002404   000000 700200 xent  KQD$FETCHR   TSX0  ! X66_AUTO_3
         1 002405   000122 000003                    ZERO    82,3

     1024     8331
     1025     8332    1         REGFLG=1;

   8332  1 002406   000001 235007                    LDA     1,DL
         1 002407   200026 755100                    STA     REGFLG,,AUTO

   8332  1 002410                       FTCH5        null
     1026     8333
     1027     8334    1   FTCH5: ;
     1028     8335    1         ENTFLG=%KQDC_FETCH;

   8335  1 002410   000001 235007                    LDA     1,DL
         1 002411   200020 755100                    STA     ENTFLG,,AUTO

   8335  1 002412                       FTCH8        null
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:187  
     1029     8336
     1030     8337    1   FTCH8: ;
     1031     8338    1         STAMP=PSTAMP;

   8338  1 002412   200004 470500                    LDP0    @PDBLK$,,AUTO
         1 002413   000000 235100                    LDA     0,,PR0
         1 002414   200030 755100                    STA     STAMP,,AUTO

     1032     8339    1         DFR$=ADDR(NIL);

   8339  1 002415   000001 236000 xsym               LDQ     B_VECTNIL+1
         1 002416   200007 756100                    STQ     DFR$,,AUTO

     1033     8340    1         DDA=PDDA;

   8340  1 002417   200005 471500                    LDP1    @PDDA,,AUTO
         1 002420   100000 236100                    LDQ     0,,PR1
         1 002421   200031 756100                    STQ     DDA,,AUTO

   8340  1 002422                       FETCH        null
     1034     8341
     1035     8342    1   FETCH: ;
     1036     8343    2         IF KQ_LOG.KQD THEN DO;

   8343  1 002422   000000 236000 xsym               LDQ     KQ_LOG
         1 002423   040000 316003                    CANQ    16384,DU
         1 002424   002450 600000 1                  TZE     s:8348

     1037     8344    2           LDFR$=DFR$;

   8344  1 002425   200007 236100                    LDQ     DFR$,,AUTO
         1 002426   200046 756100                    STQ     LDFR$,,AUTO

     1038     8345    2           CALL KQZ$LOG(KQ$CG,%KQLOG_FETCH,,ENTFLG,

   8345  1 002427   200026 630500                    EPPR0   REGFLG,,AUTO
         1 002430   200120 450500                    STP0    I$+7,,AUTO
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:188  
         1 002431   200031 631500                    EPPR1   DDA,,AUTO
         1 002432   200117 451500                    STP1    I$+6,,AUTO
         1 002433   200046 633500                    EPPR3   LDFR$,,AUTO
         1 002434   200116 453500                    STP3    I$+5,,AUTO
         1 002435   200020 634500                    EPPR4   ENTFLG,,AUTO
         1 002436   200115 454500                    STP4    I$+4,,AUTO
         1 002437   000001 236000 xsym               LDQ     B_VECTNIL+1
         1 002440   200114 756100                    STQ     I$+3,,AUTO
         1 002441   000014 236000 2                  LDQ     12
         1 002442   200003 235100                    LDA     @KQ$CG,,AUTO
         1 002443   200112 757100                    STAQ    I$+1,,AUTO
         1 002444   200112 630500                    EPPR0   I$+1,,AUTO
         1 002445   000025 631400 xsym               EPPR1   B_VECTNIL+21
         1 002446   000000 701000 xent               TSX1    KQZ$LOG
         1 002447   000000 011000                    NOP     0

     1039     8346    2           LDFR$,DDA,REGFLG);
     1040     8347    2           END;

     1041     8348    1         DA=DDA.DA;

   8348  1 002450   200031 236100                    LDQ     DDA,,AUTO
         1 002451   000032 376000 xsym               ANQ     B_VECTNIL+26
         1 002452   200015 756100                    STQ     DA,,AUTO

     1042     8349    1         KEY.DA=DA;

   8349  1 002453   200016 756100                    STQ     KEY,,AUTO

     1043     8350    1         KEY.GARB=0;

   8350  1 002454   200017 450100                    STZ     KEY+1,,AUTO

     1044     8351              %LOCK (G=KQ$CG.DTREE.GATE);

   8352  1 002455   200003 236100                    LDQ     @KQ$CG,,AUTO
         1 002456   000231 036003                    ADLQ    153,DU
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:189  
         1 002457   200112 756100                    STQ     I$+1,,AUTO
         1 002460   200112 630500                    EPPR0   I$+1,,AUTO
         1 002461   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 002462   000000 701000 xent               TSX1    HFC$LOCK
         1 002463   000000 011000                    NOP     0

   8350  1 002464                       FTCH10       null
     1045     8354    1   FTCH10: ;
     1046     8355    1         CALL KQB$SRCH(KQ$CG.DTREE,KEY,LDGRAN$) ALTRET(FTCH20);

   8355  1 002464   200050 630500                    EPPR0   LDGRAN$,,AUTO
         1 002465   200114 450500                    STP0    I$+3,,AUTO
         1 002466   200016 631500                    EPPR1   KEY,,AUTO
         1 002467   200113 451500                    STP1    I$+2,,AUTO
         1 002470   200003 236100                    LDQ     @KQ$CG,,AUTO
         1 002471   000231 036003                    ADLQ    153,DU
         1 002472   200112 756100                    STQ     I$+1,,AUTO
         1 002473   200112 630500                    EPPR0   I$+1,,AUTO
         1 002474   000021 631400 xsym               EPPR1   B_VECTNIL+17
         1 002475   000000 701000 xent               TSX1    KQB$SRCH
         1 002476   002721 702000 1                  TSX2    FTCH20

     1047     8356    1         DGRAN$=LDGRAN$;

   8356  1 002477   200050 236100                    LDQ     LDGRAN$,,AUTO
         1 002500   200011 756100                    STQ     DGRAN$,,AUTO

     1048     8357    1         DGRAN.DISP=0;

   8357  1 002501   000010 236000 2                  LDQ     8
         1 002502   200011 356100                    ANSQ    DGRAN$,,AUTO

     1049     8358    1         IF KQ$DGRAN.HDR.WRITE AND NOT KQ$DGRAN.HDR.FORCEOUT THEN

   8358  1 002503   200011 470500                    LDP0    DGRAN$,,AUTO
         1 002504   000001 236100                    LDQ     1,,PR0
         1 002505   000100 316003                    CANQ    64,DU
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:190  
         1 002506   002511 600000 1                  TZE     s:8360
         1 002507   000400 316003                    CANQ    256,DU
         1 002510   002721 600000 1                  TZE     FTCH20

     1050     8359    1           GOTO FTCH20;  /* This page is going out - treat like not here */
     1051     8360    1         KQ$DGRAN.USECNT=KQ$DGRAN.USECNT+1;

   8360  1 002511   000013 054100                    AOS     11,,PR0

     1052     8361    1         IF DFR$~=ADDR(NIL) THEN

   8361  1 002512   200007 236100                    LDQ     DFR$,,AUTO
         1 002513   000001 116000 xsym               CMPQ    B_VECTNIL+1
         1 002514   002530 600000 1                  TZE     FETCHDONE

     1053     8362    2           DO CASE(ENTFLG);

   8362  1 002515   200020 235100                    LDA     ENTFLG,,AUTO
         1 002516   000004 115007                    CMPA    4,DL
         1 002517   002521 602005 1                  TNC     s:8362+4,AL
         1 002520   002525 710000 1                  TRA     s:8364
         1 002521   002525 710000 1                  TRA     s:8364
         1 002522   002525 710000 1                  TRA     s:8364
         1 002523   002530 710000 1                  TRA     FETCHDONE
         1 002524   002530 710000 1                  TRA     FETCHDONE

     1054     8363    2             CASE(ELSE);

     1055     8364    2               CALL RELBLK;  /* Found it on second try */

   8364  1 002525   004244 701000 1                  TSX1    RELBLK
         1 002526   000000 011000                    NOP     0
         1 002527   002530 710000 1                  TRA     FETCHDONE

     1056     8365    2             CASE(%KQDC_RENEGE,%KQDC_DEL);

     1057     8366    2           END;
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:191  

   8361  1 002530                       FETCHDONE    null
     1058     8367
     1059     8368    1   FETCHDONE: ;
     1060     8369    1         DBLK$=PINCRW(DGRAN$,DDA.DISP*2);

   8369  1 002530   200031 236100                    LDQ     DDA,,AUTO
         1 002531   000033 772000                    QRL     27
         1 002532   000023 736000                    QLS     19
         1 002533   200011 036100                    ADLQ    DGRAN$,,AUTO
         1 002534   200006 756100                    STQ     DBLK$,,AUTO

     1061     8370    1         IF KQ$DBLK.LOCK OR (ENTFLG~=%KQDC_RENEGE AND NOT KQ$DBLK.ACTIVE) THEN

   8370  1 002535   200006 470500                    LDP0    DBLK$,,AUTO
         1 002536   000003 236100                    LDQ     3,,PR0
         1 002537   000200 316003                    CANQ    128,DU
         1 002540   002546 601000 1                  TNZ     s:8372
         1 002541   200020 235100                    LDA     ENTFLG,,AUTO
         1 002542   000002 115007                    CMPA    2,DL
         1 002543   002563 600000 1                  TZE     s:8378
         1 002544   000400 316003                    CANQ    256,DU
         1 002545   002563 601000 1                  TNZ     s:8378

     1062     8371    2           DO;

     1063     8372    2           ERRCODE=%KQDE_STATE;

   8372  1 002546   000005 235007                    LDA     5,DL
         1 002547   200027 755100                    STA     ERRCODE,,AUTO

     1064     8373    2           CALL LOGERR(%KQELOG_KQD_STATE);

   8373  1 002550   000001 236000 xsym               LDQ     B_VECTNIL+1
         1 002551   200054 756100                    STQ     @CODE+1,,AUTO
         1 002552   000000 236000 2                  LDQ     0
         1 002553   200053 756100                    STQ     LDGRAN$+3,,AUTO
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:192  
         1 002554   007720 701000 1                  TSX1    LOGERR
         1 002555   000000 011000                    NOP     0

     1065     8374    2           IF KQ_DEBUG~=0 THEN

   8374  1 002556   000000 235000 xsym               LDA     KQ_DEBUG
         1 002557   002562 600000 1                  TZE     s:8376

     1066     8375    2             CALL SC_CGCACHE;

   8375  1 002560   000000 713400 xsym               CLIMB   SC_CGCACHE
         1 002561   000000 600000 xsid               climb   nvectors=         0

     1067     8376    2           GOTO FTCH15;

   8376  1 002562   002656 710000 1                  TRA     FTCH15

     1068     8377    2           END;
     1069     8378    1         IF KQ$DBLK.STAMP~=STAMP THEN

   8378  1 002563   000000 236100                    LDQ     0,,PR0
         1 002564   000022 772000                    QRL     18
         1 002565   200030 116100                    CMPQ    STAMP,,AUTO
         1 002566   002604 600000 1                  TZE     s:8386

     1070     8379    2           DO;

     1071     8380    2           ERRCODE=%KQDE_STMP;

   8380  1 002567   000003 235007                    LDA     3,DL
         1 002570   200027 755100                    STA     ERRCODE,,AUTO

     1072     8381    2           CALL LOGERR(%KQELOG_KQD_STMP,STAMP);

   8381  1 002571   200030 631500                    EPPR1   STAMP,,AUTO
         1 002572   200054 451500                    STP1    @CODE+1,,AUTO
         1 002573   000001 236000 2                  LDQ     1
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:193  
         1 002574   200053 756100                    STQ     LDGRAN$+3,,AUTO
         1 002575   007720 701000 1                  TSX1    LOGERR
         1 002576   000000 011000                    NOP     0

     1073     8382    2           IF KQ_DEBUG~=0 THEN

   8382  1 002577   000000 235000 xsym               LDA     KQ_DEBUG
         1 002600   002603 600000 1                  TZE     s:8384

     1074     8383    2             CALL SC_CGCACHE;

   8383  1 002601   000000 713400 xsym               CLIMB   SC_CGCACHE
         1 002602   000000 600000 xsid               climb   nvectors=         0

     1075     8384    2           GOTO FTCH15;

   8384  1 002603   002656 710000 1                  TRA     FTCH15

     1076     8385    2           END;
     1077     8386    1         KQ$DGRAN.ACTCNT=KQ$DGRAN.ACTCNT+1;

   8386  1 002604   200011 471500                    LDP1    DGRAN$,,AUTO
         1 002605   100022 054100                    AOS     18,,PR1

     1078     8387    1         KQ$DBLK.LOCK='1'B;

   8387  1 002606   000200 236003                    LDQ     128,DU
         1 002607   000003 256100                    ORSQ    3,,PR0

     1079     8388    2           DO CASE(ENTFLG);

   8388  1 002610   200020 235100                    LDA     ENTFLG,,AUTO
         1 002611   000004 115007                    CMPA    4,DL
         1 002612   002614 602005 1                  TNC     s:8388+4,AL
         1 002613   002640 710000 1                  TRA     FTCH12
         1 002614   002640 710000 1                  TRA     FTCH12
         1 002615   002640 710000 1                  TRA     FTCH12
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:194  
         1 002616   002620 710000 1                  TRA     s:8390
         1 002617   002621 710000 1                  TRA     s:8392

     1080     8389    2             CASE(%KQDC_RENEGE);

     1081     8390    2               GOTO RENEGE;

   8390  1 002620   003433 710000 1                  TRA     RENEGE

     1082     8391    2             CASE(%KQDC_DEL);

     1083     8392    2               DELFLG=%KQD_DEL;

   8392  1 002621   000003 235007                    LDA     3,DL
         1 002622   200021 755100                    STA     DELFLG,,AUTO

     1084     8393    2               IF KQ$DBLK.FLNKDA~=0 AND DFR$=ADDR(NIL) THEN

   8393  1 002623   000001 235100                    LDA     1,,PR0
         1 002624   002637 600000 1                  TZE     s:8399
         1 002625   200007 236100                    LDQ     DFR$,,AUTO
         1 002626   000001 116000 xsym               CMPQ    B_VECTNIL+1
         1 002627   002637 601000 1                  TNZ     s:8399

     1085     8394    3                 DO;

     1086     8395    3                 CALL GETBLK ALTRET(DELNODBLK); /* Get DFRBLK at start */

   8395  1 002630   004104 701000 1                  TSX1    GETBLK
         1 002631   003110 702000 1                  TSX2    DELNODBLK

     1087     8396    3                 KQ$DFRBLK.USR=0;

   8396  1 002632   200007 470500                    LDP0    DFR$,,AUTO
         1 002633   000000 236003                    LDQ     0,DU
         1 002634   000001 552104                    STBQ    1,'04'O,PR0

PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:195  
     1088     8397    3                 KQ$DFRBLK.GO='1'B;

   8397  1 002635   400000 236007                    LDQ     -131072,DL
         1 002636   000001 256100                    ORSQ    1,,PR0

     1089     8398    3                 END;

     1090     8399    2               GOTO DELCOM4;

   8399  1 002637   003671 710000 1                  TRA     DELCOM4

     1091     8400    2           END;

   8397  1 002640                       FTCH12       null
     1092     8401    1   FTCH12: ;
     1093     8402    1         IF DFR$~=ADDR(NIL) THEN

   8402  1 002640   200007 236100                    LDQ     DFR$,,AUTO
         1 002641   000001 116000 xsym               CMPQ    B_VECTNIL+1
         1 002642   002666 601000 1                  TNZ     FTCH19

     1094     8403    1           GOTO FTCH19;
     1095     8404              %UNLOCK (G=KQ$CG.DTREE.GATE);

   8405  1 002643   200003 236100                    LDQ     @KQ$CG,,AUTO
         1 002644   000231 036003                    ADLQ    153,DU
         1 002645   200112 756100                    STQ     I$+1,,AUTO
         1 002646   200112 630500                    EPPR0   I$+1,,AUTO
         1 002647   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 002650   000000 701000 xent               TSX1    HFC$UNLOCK
         1 002651   000000 011000                    NOP     0

     1096     8407    1         PDBLK$=DBLK$;

   8407  1 002652   200006 236100                    LDQ     DBLK$,,AUTO
         1 002653   200004 470500                    LDP0    @PDBLK$,,AUTO
         1 002654   000000 756100                    STQ     0,,PR0
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:196  

     1097     8408    1         RETURN;

   8408  1 002655   000000 702200 xent               TSX2  ! X66_ARET

   8407  1 002656                       FTCH15       null
     1098     8409
     1099     8410    1   FTCH15: ;
     1100     8411    1         KQ$DGRAN.USECNT=KQ$DGRAN.USECNT-1;

   8411  1 002656   200011 470500                    LDP0    DGRAN$,,AUTO
         1 002657   000001 336007                    LCQ     1,DL
         1 002660   000013 056100                    ASQ     11,,PR0

     1101     8412    1         DBLK$=ADDR(NIL);

   8412  1 002661   000001 236000 xsym               LDQ     B_VECTNIL+1
         1 002662   200006 756100                    STQ     DBLK$,,AUTO

   8412  1 002663                       FTCH18       null
     1102     8413
     1103     8414    1   FTCH18: ;
     1104     8415    1         IF DFR$~=ADDR(NIL) THEN

   8415  1 002663   200007 236100                    LDQ     DFR$,,AUTO
         1 002664   000001 116000 xsym               CMPQ    B_VECTNIL+1
         1 002665   002703 600000 1                  TZE     s:8426

     1105     8416    2           DO;

   8412  1 002666                       FTCH19       null
     1106     8417    2   FTCH19: ;
     1107     8418    2           KQ$DFRBLK.DBLK$=DBLK$;

   8418  1 002666   200006 236100                    LDQ     DBLK$,,AUTO
         1 002667   200007 470500                    LDP0    DFR$,,AUTO
         1 002670   000003 756100                    STQ     3,,PR0
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:197  

     1108     8419    2           KQ$DFRBLK.DDA=BITBIN(DDA);

   8419  1 002671   200031 235100                    LDA     DDA,,AUTO
         1 002672   000004 755100                    STA     4,,PR0

     1109     8420    2           KQ$DFRBLK.ERRCODE=ERRCODE;

   8420  1 002673   200027 236100                    LDQ     ERRCODE,,AUTO
         1 002674   000022 736000                    QLS     18
         1 002675   000001 552120                    STBQ    1,'20'O,PR0

     1110     8421    2           KQ$DFRBLK.EVNT='1'B;

   8421  1 002676   200000 236007                    LDQ     65536,DL
         1 002677   000001 256100                    ORSQ    1,,PR0

     1111     8422    2           CALL COMP;

   8422  1 002700   006426 701000 1                  TSX1    COMP
         1 002701   000000 011000                    NOP     0

     1112     8423    2           RETURN;

   8423  1 002702   000000 702200 xent               TSX2  ! X66_ARET

     1113     8424    2           END;
     1114     8425              %UNLOCK (G=KQ$CG.DTREE.GATE);

   8426  1 002703   200003 236100                    LDQ     @KQ$CG,,AUTO
         1 002704   000231 036003                    ADLQ    153,DU
         1 002705   200112 756100                    STQ     I$+1,,AUTO
         1 002706   200112 630500                    EPPR0   I$+1,,AUTO
         1 002707   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 002710   000000 701000 xent               TSX1    HFC$UNLOCK
         1 002711   000000 011000                    NOP     0

PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:198  
     1115     8428    1         PDBLK$=ADDR(NIL);

   8428  1 002712   000001 236000 xsym               LDQ     B_VECTNIL+1
         1 002713   200004 470500                    LDP0    @PDBLK$,,AUTO
         1 002714   000000 756100                    STQ     0,,PR0

     1116     8429    1         PSIZ=ERRCODE;

   8429  1 002715   200005 471500                    LDP1    @PDDA,,AUTO
         1 002716   200027 235100                    LDA     ERRCODE,,AUTO
         1 002717   100000 755100                    STA     0,,PR1

     1117     8430    1         ALTRETURN;

   8430  1 002720   000000 702200 xent               TSX2  ! X66_AALT

   8429  1 002721                       FTCH20       null
     1118     8431
     1119     8432
     1120     8433        /**/
     1121     8434    1   FTCH20: ;
     1122     8435    1         IF DFR$=ADDR(NIL) THEN

   8435  1 002721   200007 236100                    LDQ     DFR$,,AUTO
         1 002722   000001 116000 xsym               CMPQ    B_VECTNIL+1
         1 002723   002740 601000 1                  TNZ     s:8444

     1123     8436    1           IF REGFLG~=0 THEN

   8436  1 002724   200026 235100                    LDA     REGFLG,,AUTO
         1 002725   002736 600000 1                  TZE     s:8442

     1124     8437    1             IF S_TIMR~=2 AND S_CUN~=0 THEN

   8437  1 002726   000000 235000 xsym               LDA     S_TIMR
         1 002727   000002 115007                    CMPA    2,DL
         1 002730   003134 600000 1                  TZE     CREG
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:199  
         1 002731   000000 235000 xsym               LDA     S_CUN
         1 002732   003134 600000 1                  TZE     CREG

     1125     8438    1               CALL GETBLKR ALTRET(FTCH10);

   8438  1 002733   004107 701000 1                  TSX1    GETBLKR
         1 002734   002464 702000 1                  TSX2    FTCH10
         1 002735   002740 710000 1                  TRA     s:8444

     1126     8439    1             ELSE
     1127     8440    1               GOTO CREG;  /* Can't REG */
     1128     8441    1           ELSE
     1129     8442    1             CALL GETBLK ALTRET(NODFRBLK);

   8442  1 002736   004104 701000 1                  TSX1    GETBLK
         1 002737   003116 702000 1                  TSX2    NODFRBLK

     1130     8443        /**/
     1131     8444    1         IF ENTFLG~=%KQDC_FETCH THEN

   8444  1 002740   200020 235100                    LDA     ENTFLG,,AUTO
         1 002741   000001 115007                    CMPA    1,DL
         1 002742   002750 600000 1                  TZE     s:8450

     1132     8445    2           DO;

     1133     8446    2           KQ$DFRBLK.USR=0; /* Don't hold user if not fetch */

   8446  1 002743   200007 470500                    LDP0    DFR$,,AUTO
         1 002744   000000 236003                    LDQ     0,DU
         1 002745   000001 552104                    STBQ    1,'04'O,PR0

     1134     8447    2           KQ$DFRBLK.GO='1'B;

   8447  1 002746   400000 236007                    LDQ     -131072,DL
         1 002747   000001 256100                    ORSQ    1,,PR0

PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:200  
     1135     8448    2           END;

     1136     8449        /**/
     1137     8450    2         IF KQ_LOG.KQD THEN DO;

   8450  1 002750   000000 236000 xsym               LDQ     KQ_LOG
         1 002751   040000 316003                    CANQ    16384,DU
         1 002752   002776 600000 1                  TZE     s:8456

     1138     8451    2           LDFR$=DFR$;

   8451  1 002753   200007 236100                    LDQ     DFR$,,AUTO
         1 002754   200046 756100                    STQ     LDFR$,,AUTO

     1139     8452    2           CALL KQZ$LOG(KQ$CG,%KQLOG_FTCHDFR,,ENTFLG,

   8452  1 002755   200026 630500                    EPPR0   REGFLG,,AUTO
         1 002756   200120 450500                    STP0    I$+7,,AUTO
         1 002757   200031 631500                    EPPR1   DDA,,AUTO
         1 002760   200117 451500                    STP1    I$+6,,AUTO
         1 002761   200046 633500                    EPPR3   LDFR$,,AUTO
         1 002762   200116 453500                    STP3    I$+5,,AUTO
         1 002763   200020 634500                    EPPR4   ENTFLG,,AUTO
         1 002764   200115 454500                    STP4    I$+4,,AUTO
         1 002765   000001 236000 xsym               LDQ     B_VECTNIL+1
         1 002766   200114 756100                    STQ     I$+3,,AUTO
         1 002767   000015 236000 2                  LDQ     13
         1 002770   200003 235100                    LDA     @KQ$CG,,AUTO
         1 002771   200112 757100                    STAQ    I$+1,,AUTO
         1 002772   200112 630500                    EPPR0   I$+1,,AUTO
         1 002773   000025 631400 xsym               EPPR1   B_VECTNIL+21
         1 002774   000000 701000 xent               TSX1    KQZ$LOG
         1 002775   000000 011000                    NOP     0

     1140     8453    2           LDFR$,DDA,REGFLG);
     1141     8454    2           END;

PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:201  
     1142     8455        /**/
     1143     8456    1         KQ$DFRBLK.DDA=BITBIN(DDA);  /* Remember DDA */

   8456  1 002776   200007 470500                    LDP0    DFR$,,AUTO
         1 002777   200031 235100                    LDA     DDA,,AUTO
         1 003000   000004 755100                    STA     4,,PR0

     1144     8457    1         KQ$DFRBLK.DA=DA;

   8457  1 003001   200015 236100                    LDQ     DA,,AUTO
         1 003002   000002 756100                    STQ     2,,PR0

     1145     8458    1         KQ$DFRBLK.DBLK=STAMP;       /* Remember stamp */

   8458  1 003003   200030 235100                    LDA     STAMP,,AUTO
         1 003004   000003 755100                    STA     3,,PR0

     1146     8459    1         CALL READGRAN;

   8459  1 003005   004326 701000 1                  TSX1    READGRAN
         1 003006   000000 011000                    NOP     0

     1147     8460    1         IF ENTFLG~=%KQDC_FETCH THEN

   8460  1 003007   200020 235100                    LDA     ENTFLG,,AUTO
         1 003010   000001 115007                    CMPA    1,DL
         1 003011   003013 600000 1                  TZE     FTCH30

     1148     8461    1           RETURN;

   8461  1 003012   000000 702200 xent               TSX2  ! X66_ARET

   8460  1 003013                       FTCH30       null
     1149     8462    1   FTCH30: ;
     1150     8463    1         IF KQ$DFRBLK.USR~=0 THEN

   8463  1 003013   200007 470500                    LDP0    DFR$,,AUTO
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:202  
         1 003014   000001 236100                    LDQ     1,,PR0
         1 003015   000777 316007                    CANQ    511,DL
         1 003016   003104 600000 1                  TZE     s:8500

     1151     8464    2           DO;

     1152     8465    2           CALL SSR$REG(%SS_QA);

   8465  1 003017   000017 630400 2                  EPPR0   15
         1 003020   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 003021   000000 701000 xent               TSX1    SSR$REG
         1 003022   000000 011000                    NOP     0

   8465  1 003023                       FTCH40       null
     1153     8466    2   FTCH40: ;
     1154     8467    2           IF NOT KQ$DFRBLK.EVNT THEN

   8467  1 003023   200007 470500                    LDP0    DFR$,,AUTO
         1 003024   000001 236100                    LDQ     1,,PR0
         1 003025   200000 316007                    CANQ    65536,DL
         1 003026   003032 601000 1                  TNZ     s:8476

     1155     8468    3             DO; /* Woke up when we shouldn't have */

     1156     8469    3             CALL SC_CGCACHE;

   8469  1 003027   000000 713400 xsym               CLIMB   SC_CGCACHE
         1 003030   000000 600000 xsid               climb   nvectors=         0

     1157     8470    3             GOTO FTCH30; /* Sleep again */

   8470  1 003031   003013 710000 1                  TRA     FTCH30

     1158     8471    3             END;
     1159     8472        /*S*  SCREECH_CODE: KQD-S$CGCACHE
     1160     8473              TYPE: SNAP
     1161     8474              MESSAGE: Error in comgroup data cache
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:203  
     1162     8475        */
     1163     8476    2           ERRCODE=KQ$DFRBLK.ERRCODE;

   8476  1 003032   000001 236100                    LDQ     1,,PR0
         1 003033   000022 772000                    QRL     18
         1 003034   000777 376007                    ANQ     511,DL
         1 003035   200027 756100                    STQ     ERRCODE,,AUTO

     1164     8477    2           DBLK$=KQ$DFRBLK.DBLK$;

   8477  1 003036   000003 236100                    LDQ     3,,PR0
         1 003037   200006 756100                    STQ     DBLK$,,AUTO

     1165     8478    2           DDA=BINBIT(KQ$DFRBLK.DDA,36);

   8478  1 003040   000004 236100                    LDQ     4,,PR0
         1 003041   200031 756100                    STQ     DDA,,AUTO

     1166     8479                %LOCK (G=KQ$CG.DTREE.GATE);

   8480  1 003042   200003 236100                    LDQ     @KQ$CG,,AUTO
         1 003043   000231 036003                    ADLQ    153,DU
         1 003044   200112 756100                    STQ     I$+1,,AUTO
         1 003045   200112 630500                    EPPR0   I$+1,,AUTO
         1 003046   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 003047   000000 701000 xent               TSX1    HFC$LOCK
         1 003050   000000 011000                    NOP     0

     1167     8482    2           CALL RELBLK;

   8482  1 003051   004244 701000 1                  TSX1    RELBLK
         1 003052   000000 011000                    NOP     0

     1168     8483                %UNLOCK (G=KQ$CG.DTREE.GATE);

   8484  1 003053   200003 236100                    LDQ     @KQ$CG,,AUTO
         1 003054   000231 036003                    ADLQ    153,DU
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:204  
         1 003055   200112 756100                    STQ     I$+1,,AUTO
         1 003056   200112 630500                    EPPR0   I$+1,,AUTO
         1 003057   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 003060   000000 701000 xent               TSX1    HFC$UNLOCK
         1 003061   000000 011000                    NOP     0

     1169     8486    2           IF ERRCODE=0 THEN

   8486  1 003062   200027 235100                    LDA     ERRCODE,,AUTO
         1 003063   003076 601000 1                  TNZ     s:8495

     1170     8487    3             DO;

     1171     8488    3             PDBLK$=DBLK$;

   8488  1 003064   200006 236100                    LDQ     DBLK$,,AUTO
         1 003065   200004 470500                    LDP0    @PDBLK$,,AUTO
         1 003066   000000 756100                    STQ     0,,PR0

     1172     8489    3             IF ENTFLG=%KQDC_GET THEN

   8489  1 003067   200020 235100                    LDA     ENTFLG,,AUTO
         1 003070   000005 115007                    CMPA    5,DL
         1 003071   003075 601000 1                  TNZ     s:8491

     1173     8490    3               PDDA=DDA;

   8490  1 003072   200031 236100                    LDQ     DDA,,AUTO
         1 003073   200005 471500                    LDP1    @PDDA,,AUTO
         1 003074   100000 756100                    STQ     0,,PR1

     1174     8491    3             RETURN;

   8491  1 003075   000000 702200 xent               TSX2  ! X66_ARET

     1175     8492    3             END;
     1176     8493    2           ELSE
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:205  
     1177     8494    3             DO;

     1178     8495    3             PDBLK$=ADDR(NIL);

   8495  1 003076   000001 236000 xsym               LDQ     B_VECTNIL+1
         1 003077   200004 470500                    LDP0    @PDBLK$,,AUTO
         1 003100   000000 756100                    STQ     0,,PR0

     1179     8496    3             PSIZ=ERRCODE;

   8496  1 003101   200005 471500                    LDP1    @PDDA,,AUTO
         1 003102   100000 755100                    STA     0,,PR1

     1180     8497    3             ALTRETURN;

   8497  1 003103   000000 702200 xent               TSX2  ! X66_AALT

     1181     8498    3             END;
     1182     8499    2           END;
     1183     8500    1         PDBLK$=DFR$;

   8500  1 003104   200007 236100                    LDQ     DFR$,,AUTO
         1 003105   200004 471500                    LDP1    @PDBLK$,,AUTO
         1 003106   100000 756100                    STQ     0,,PR1

     1184     8501    1         ALTRETURN;

   8501  1 003107   000000 702200 xent               TSX2  ! X66_AALT

   8500  1 003110                       DELNODBLK    null
     1185     8502        /**/
     1186     8503    1   DELNODBLK: ;
     1187     8504    1         KQ$DBLK.LOCK='0'B;

   8504  1 003110   200006 470500                    LDP0    DBLK$,,AUTO
         1 003111   000020 236000 2                  LDQ     16
         1 003112   000003 356100                    ANSQ    3,,PR0
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:206  

     1188     8505    1         KQ$DGRAN.USECNT=KQ$DGRAN.USECNT-1;

   8505  1 003113   200011 471500                    LDP1    DGRAN$,,AUTO
         1 003114   000001 336007                    LCQ     1,DL
         1 003115   100013 056100                    ASQ     11,,PR1

   8505  1 003116                       NODFRBLK     null
     1189     8506        /**/
     1190     8507    1   NODFRBLK: ;
     1191     8508              %UNLOCK (G=KQ$CG.DTREE.GATE);

   8509  1 003116   200003 236100                    LDQ     @KQ$CG,,AUTO
         1 003117   000231 036003                    ADLQ    153,DU
         1 003120   200112 756100                    STQ     I$+1,,AUTO
         1 003121   200112 630500                    EPPR0   I$+1,,AUTO
         1 003122   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 003123   000000 701000 xent               TSX1    HFC$UNLOCK
         1 003124   000000 011000                    NOP     0

     1192     8511    1         PDBLK$=ADDR(NIL);

   8511  1 003125   000001 236000 xsym               LDQ     B_VECTNIL+1
         1 003126   200004 470500                    LDP0    @PDBLK$,,AUTO
         1 003127   000000 756100                    STQ     0,,PR0

     1193     8512    1         PSIZ=%KQDE_NDFRBLK;

   8512  1 003130   000012 235007                    LDA     10,DL
         1 003131   200005 471500                    LDP1    @PDDA,,AUTO
         1 003132   100000 755100                    STA     0,,PR1

     1194     8513    1         ALTRETURN;

   8513  1 003133   000000 702200 xent               TSX2  ! X66_AALT

   8512  1 003134                       CREG         null
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:207  
     1195     8514        /**/
     1196     8515        /**/
     1197     8516    1   CREG: ;
     1198     8517              %UNLOCK (G=KQ$CG.DTREE.GATE);

   8518  1 003134   200003 236100                    LDQ     @KQ$CG,,AUTO
         1 003135   000231 036003                    ADLQ    153,DU
         1 003136   200112 756100                    STQ     I$+1,,AUTO
         1 003137   200112 630500                    EPPR0   I$+1,,AUTO
         1 003140   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 003141   000000 701000 xent               TSX1    HFC$UNLOCK
         1 003142   000000 011000                    NOP     0

     1199     8520    1         PDBLK$=ADDR(NIL);

   8520  1 003143   000001 236000 xsym               LDQ     B_VECTNIL+1
         1 003144   200004 470500                    LDP0    @PDBLK$,,AUTO
         1 003145   000000 756100                    STQ     0,,PR0

     1200     8521    1         PSIZ=%KQDE_CREG;

   8521  1 003146   000001 235007                    LDA     1,DL
         1 003147   200005 471500                    LDP1    @PDDA,,AUTO
         1 003150   100000 755100                    STA     0,,PR1

     1201     8522    1         ALTRETURN;

   8522  1 003151   000000 702200 xent               TSX2  ! X66_AALT

     1202     8523        /**/
     1203     8524        /**/
     1204     8525    1   KQD$FETCHDONE: ENTRY(KQ$CG,PDBLK$,PDDA) ALTRET;  /* Doesn't ALTRET */

   8525  1 003152   000000 700200 xent  KQD$FETCHDO* TSX0  ! X66_AUTO_3
         1 003153   000122 000003                    ZERO    82,3

     1205     8526
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:208  
     1206     8527    1         DFR$=PDBLK$;

   8527  1 003154   200004 470500                    LDP0    @PDBLK$,,AUTO
         1 003155   000000 236100                    LDQ     0,,PR0
         1 003156   200007 756100                    STQ     DFR$,,AUTO

     1207     8528    1         DGRAN$=PSTA$;

   8528  1 003157   200005 471500                    LDP1    @PDDA,,AUTO
         1 003160   100000 236100                    LDQ     0,,PR1
         1 003161   200011 756100                    STQ     DGRAN$,,AUTO

     1208     8529    1         DDA=BINBIT(KQ$DFRBLK.DDA,36);

   8529  1 003162   200007 473500                    LDP3    DFR$,,AUTO
         1 003163   300004 236100                    LDQ     4,,PR3
         1 003164   200031 756100                    STQ     DDA,,AUTO

     1209     8530    1         STAMP=KQ$DFRBLK.DBLK;

   8530  1 003165   300003 235100                    LDA     3,,PR3
         1 003166   200030 755100                    STA     STAMP,,AUTO

     1210     8531    1         ENTFLG=KQ$DFRBLK.CODE;

   8531  1 003167   300001 236100                    LDQ     1,,PR3
         1 003170   000033 772000                    QRL     27
         1 003171   200020 756100                    STQ     ENTFLG,,AUTO

     1211     8532    1         REGFLG=0;

   8532  1 003172   200026 450100                    STZ     REGFLG,,AUTO

     1212     8533    1         ERRCODE=KQ$DFRBLK.ERRCODE;

   8533  1 003173   300001 236100                    LDQ     1,,PR3
         1 003174   000022 772000                    QRL     18
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:209  
         1 003175   000777 376007                    ANQ     511,DL
         1 003176   200027 756100                    STQ     ERRCODE,,AUTO

     1213     8534    1         IF ERRCODE~=0 OR KQ$DFRBLK.ABORT THEN

   8534  1 003177   003203 601000 1                  TNZ     s:8536
         1 003200   300001 236100                    LDQ     1,,PR3
         1 003201   100000 316007                    CANQ    32768,DL
         1 003202   003211 600000 1                  TZE     s:8543

     1214     8535    2           DO;

     1215     8536    2           DBLK$=ADDR(NIL);

   8536  1 003203   000001 236000 xsym               LDQ     B_VECTNIL+1
         1 003204   200006 756100                    STQ     DBLK$,,AUTO

     1216     8537    2           IF DGRAN$=ADDR(NIL) THEN

   8537  1 003205   200011 236100                    LDQ     DGRAN$,,AUTO
         1 003206   000001 116000 xsym               CMPQ    B_VECTNIL+1
         1 003207   002663 600000 1                  TZE     FTCH18

     1217     8538    2             GOTO FTCH18;
     1218     8539    2           ELSE
     1219     8540    2             GOTO FTCH15;

   8540  1 003210   002656 710000 1                  TRA     FTCH15

     1220     8541    2           END;
     1221     8542        /**/
     1222     8543    2         IF KQ_LOG.KQD THEN DO;

   8543  1 003211   000000 236000 xsym               LDQ     KQ_LOG
         1 003212   040000 316003                    CANQ    16384,DU
         1 003213   003241 600000 1                  TZE     s:8549

PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:210  
     1223     8544    2           LDFR$=DFR$; LDBLK$=DBLK$;

   8544  1 003214   200007 236100                    LDQ     DFR$,,AUTO
         1 003215   200046 756100                    STQ     LDFR$,,AUTO

   8544  1 003216   200006 236100                    LDQ     DBLK$,,AUTO
         1 003217   200047 756100                    STQ     LDBLK$,,AUTO

     1224     8545    2           CALL KQZ$LOG(KQ$CG,%KQLOG_FTCHDONE,,ENTFLG,

   8545  1 003220   200047 634500                    EPPR4   LDBLK$,,AUTO
         1 003221   200120 454500                    STP4    I$+7,,AUTO
         1 003222   200031 635500                    EPPR5   DDA,,AUTO
         1 003223   200117 455500                    STP5    I$+6,,AUTO
         1 003224   200046 636500                    EPPR6   LDFR$,,AUTO
         1 003225   200116 456500                    STP6    I$+5,,AUTO
         1 003226   200020 637500                    EPPR7   ENTFLG,,AUTO
         1 003227   200115 457500                    STP7    I$+4,,AUTO
         1 003230   000001 236000 xsym               LDQ     B_VECTNIL+1
         1 003231   200114 756100                    STQ     I$+3,,AUTO
         1 003232   000021 236000 2                  LDQ     17
         1 003233   200003 235100                    LDA     @KQ$CG,,AUTO
         1 003234   200112 757100                    STAQ    I$+1,,AUTO
         1 003235   200112 630500                    EPPR0   I$+1,,AUTO
         1 003236   000025 631400 xsym               EPPR1   B_VECTNIL+21
         1 003237   000000 701000 xent               TSX1    KQZ$LOG
         1 003240   000000 011000                    NOP     0

     1225     8546    2           LDFR$,DDA,LDBLK$);
     1226     8547    2           END;

     1227     8548        /**/
     1228     8549    1         GOTO FETCHDONE;

   8549  1 003241   002530 710000 1                  TRA     FETCHDONE

     1229     8550
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:211  
     1230     8551        %EJECT;
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:212  
     1231     8552
     1232     8553
     1233     8554        /*D* NAME:         KQD$DEFERGO
     1234     8555
     1235     8556              ENTRY:       KQD$DEFERWAIT
     1236     8557
     1237     8558             CALL:         CALL KQD$DEFERGO(KQ$CG,DFR$,EPTR$);
     1238     8559                           CALL KQD$DEFERWAIT(KQ$CG,DFR$,DDA);
     1239     8560
     1240     8561             INPUT:        KQ$CG - Comgroup context block
     1241     8562                           DFR$ - Ptr to defer block (which must contain
     1242     8563                                  INFO if DEFERGO).
     1243     8564                           EPTR$ - Routine to call when complete if DEFERGO
     1244     8565
     1245     8566             OUTPUT:       Nothing for DEFERGO.  For DEFERWAIT, same as
     1246     8567                           KQD$GETR or KQD$FETCHR.
     1247     8568
     1248     8569             DESCRIPTION:  Whenever FETCH, GET or any other routine
     1249     8570                           altrets indicating that the operation was
     1250     8571                           deferred, DEFERGO must be called passing
     1251     8572                           the defer block pointer returned on the original
     1252     8573                           call, and a routine that will be called when
     1253     8574                           the operation completes (if EPTR$ is ENTADDR(NIL)
     1254     8575                           the operation will be cancelled), or DEFERWAIT
     1255     8576                           must be called to wait for operation to complete.
     1256     8577
     1257     8578        */
     1258     8579
     1259     8580
     1260     8581    1   KQD$DEFERGO: ENTRY(KQ$CG,PDBLK$,PDDA) ALTRET;  /* Doesn't ALTRET */

   8581  1 003242   000000 700200 xent  KQD$DEFERGO  TSX0  ! X66_AUTO_3
         1 003243   000122 000003                    ZERO    82,3

     1261     8582
     1262     8583              %LOCK (G=KQ$CG.DTREE.GATE);

PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:213  
   8584  1 003244   200003 236100                    LDQ     @KQ$CG,,AUTO
         1 003245   000231 036003                    ADLQ    153,DU
         1 003246   200112 756100                    STQ     I$+1,,AUTO
         1 003247   200112 630500                    EPPR0   I$+1,,AUTO
         1 003250   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 003251   000000 701000 xent               TSX1    HFC$LOCK
         1 003252   000000 011000                    NOP     0

     1263     8586    1         DFR$=PDBLK$;

   8586  1 003253   200004 470500                    LDP0    @PDBLK$,,AUTO
         1 003254   000000 236100                    LDQ     0,,PR0
         1 003255   200007 756100                    STQ     DFR$,,AUTO

     1264     8587    1         ENTFLG=KQ$DFRBLK.CODE;

   8587  1 003256   200007 471500                    LDP1    DFR$,,AUTO
         1 003257   100001 236100                    LDQ     1,,PR1
         1 003260   000033 772000                    QRL     27
         1 003261   200020 756100                    STQ     ENTFLG,,AUTO

     1265     8588    1         KQ$DFRBLK.EPTR$=PEPTR$;

   8588  1 003262   200005 473500                    LDP3    @PDDA,,AUTO
         1 003263   300000 236100                    LDQ     0,,PR3
         1 003264   100005 756100                    STQ     5,,PR1

     1266     8589    1         IF KQ$DFRBLK.EPTR$=ENTADDR(NIL) THEN

   8589  1 003265   000002 116000 xsym               CMPQ    B_VECTNIL+2
         1 003266   003271 601000 1                  TNZ     s:8591

     1267     8590    1           KQ$DFRBLK.ABORT='1'B;  /* Abort the process */

   8590  1 003267   100000 236007                    LDQ     32768,DL
         1 003270   100001 256100                    ORSQ    1,,PR1

PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:214  
     1268     8591    1         KQ$DFRBLK.GO='1'B;

   8591  1 003271   400000 236007                    LDQ     -131072,DL
         1 003272   100001 256100                    ORSQ    1,,PR1

     1269     8592    2         IF KQ_LOG.KQD THEN DO;

   8592  1 003273   000000 236000 xsym               LDQ     KQ_LOG
         1 003274   040000 316003                    CANQ    16384,DU
         1 003275   003323 600000 1                  TZE     s:8597

     1270     8593    2           LDFR$=DFR$; LDBLK$=DBLK$;

   8593  1 003276   200007 236100                    LDQ     DFR$,,AUTO
         1 003277   200046 756100                    STQ     LDFR$,,AUTO

   8593  1 003300   200006 236100                    LDQ     DBLK$,,AUTO
         1 003301   200047 756100                    STQ     LDBLK$,,AUTO

     1271     8594    2           CALL KQZ$LOG(KQ$CG,%KQLOG_DFRGO,,ENTFLG,

   8594  1 003302   200005 236100                    LDQ     @PDDA,,AUTO
         1 003303   200120 756100                    STQ     I$+7,,AUTO
         1 003304   200047 634500                    EPPR4   LDBLK$,,AUTO
         1 003305   200117 454500                    STP4    I$+6,,AUTO
         1 003306   200046 635500                    EPPR5   LDFR$,,AUTO
         1 003307   200116 455500                    STP5    I$+5,,AUTO
         1 003310   200020 636500                    EPPR6   ENTFLG,,AUTO
         1 003311   200115 456500                    STP6    I$+4,,AUTO
         1 003312   000001 236000 xsym               LDQ     B_VECTNIL+1
         1 003313   200114 756100                    STQ     I$+3,,AUTO
         1 003314   000022 236000 2                  LDQ     18
         1 003315   200003 235100                    LDA     @KQ$CG,,AUTO
         1 003316   200112 757100                    STAQ    I$+1,,AUTO
         1 003317   200112 630500                    EPPR0   I$+1,,AUTO
         1 003320   000025 631400 xsym               EPPR1   B_VECTNIL+21
         1 003321   000000 701000 xent               TSX1    KQZ$LOG
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:215  
         1 003322   000000 011000                    NOP     0

     1272     8595    2           LDFR$,LDBLK$,PEPTR$);
     1273     8596    2           END;

     1274     8597    1         CALL COMPLATER;  /* Don't comp now if EPTR */

   8597  1 003323   006602 701000 1                  TSX1    COMPLATER
         1 003324   000000 011000                    NOP     0

     1275     8598    1         RETURN;

   8598  1 003325   000000 702200 xent               TSX2  ! X66_ARET

     1276     8599
     1277     8600
     1278     8601    1   KQD$DEFERWAIT: ENTRY(KQ$CG,PDBLK$,PDDA) ALTRET;

   8601  1 003326   000000 700200 xent  KQD$DEFERWA* TSX0  ! X66_AUTO_3
         1 003327   000122 000003                    ZERO    82,3

     1279     8602
     1280     8603    1         DFR$=PDBLK$;

   8603  1 003330   200004 470500                    LDP0    @PDBLK$,,AUTO
         1 003331   000000 236100                    LDQ     0,,PR0
         1 003332   200007 756100                    STQ     DFR$,,AUTO

     1281     8604    1         ENTFLG=KQ$DFRBLK.CODE;

   8604  1 003333   200007 471500                    LDP1    DFR$,,AUTO
         1 003334   100001 236100                    LDQ     1,,PR1
         1 003335   000033 772000                    QRL     27
         1 003336   200020 756100                    STQ     ENTFLG,,AUTO

     1282     8605    2         IF KQ_LOG.KQD THEN DO;

PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:216  
   8605  1 003337   000000 236000 xsym               LDQ     KQ_LOG
         1 003340   040000 316003                    CANQ    16384,DU
         1 003341   003361 600000 1                  TZE     s:8611

     1283     8606    2           LDFR$=DFR$;

   8606  1 003342   200007 236100                    LDQ     DFR$,,AUTO
         1 003343   200046 756100                    STQ     LDFR$,,AUTO

     1284     8607    2           CALL KQZ$LOG(KQ$CG,%KQLOG_DFRWAIT,,ENTFLG,

   8607  1 003344   200046 633500                    EPPR3   LDFR$,,AUTO
         1 003345   200116 453500                    STP3    I$+5,,AUTO
         1 003346   200020 634500                    EPPR4   ENTFLG,,AUTO
         1 003347   200115 454500                    STP4    I$+4,,AUTO
         1 003350   000001 236000 xsym               LDQ     B_VECTNIL+1
         1 003351   200114 756100                    STQ     I$+3,,AUTO
         1 003352   000023 236000 2                  LDQ     19
         1 003353   200003 235100                    LDA     @KQ$CG,,AUTO
         1 003354   200112 757100                    STAQ    I$+1,,AUTO
         1 003355   200112 630500                    EPPR0   I$+1,,AUTO
         1 003356   000023 631400 xsym               EPPR1   B_VECTNIL+19
         1 003357   000000 701000 xent               TSX1    KQZ$LOG
         1 003360   000000 011000                    NOP     0

     1285     8608    2           LDFR$);
     1286     8609    2           END;

     1287     8610              %LOCK (G=KQ$CG.DTREE.GATE);

   8611  1 003361   200003 236100                    LDQ     @KQ$CG,,AUTO
         1 003362   000231 036003                    ADLQ    153,DU
         1 003363   200112 756100                    STQ     I$+1,,AUTO
         1 003364   200112 630500                    EPPR0   I$+1,,AUTO
         1 003365   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 003366   000000 701000 xent               TSX1    HFC$LOCK
         1 003367   000000 011000                    NOP     0
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:217  

     1288     8613    1         IF NOT KQ$DFRBLK.EVNT THEN

   8613  1 003370   200007 470500                    LDP0    DFR$,,AUTO
         1 003371   000001 236100                    LDQ     1,,PR0
         1 003372   200000 316007                    CANQ    65536,DL
         1 003373   003414 601000 1                  TNZ     s:8624

     1289     8614    2           DO; /* Operation not complete yet */

     1290     8615    2           KQ$DFRBLK.GO='1'B;

   8615  1 003374   400000 236007                    LDQ     -131072,DL
         1 003375   000001 256100                    ORSQ    1,,PR0

     1291     8616    2           KQ$DFRBLK.USR=S_CUN;

   8616  1 003376   000000 236000 xsym               LDQ     S_CUN
         1 003377   000001 552104                    STBQ    1,'04'O,PR0

     1292     8617                %UNLOCK (G=KQ$CG.DTREE.GATE);

   8618  1 003400   200003 236100                    LDQ     @KQ$CG,,AUTO
         1 003401   000231 036003                    ADLQ    153,DU
         1 003402   200112 756100                    STQ     I$+1,,AUTO
         1 003403   200112 630500                    EPPR0   I$+1,,AUTO
         1 003404   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 003405   000000 701000 xent               TSX1    HFC$UNLOCK
         1 003406   000000 011000                    NOP     0

     1293     8620    2           CALL SSR$REG(%SS_QA);

   8620  1 003407   000017 630400 2                  EPPR0   15
         1 003410   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 003411   000000 701000 xent               TSX1    SSR$REG
         1 003412   000000 011000                    NOP     0

PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:218  
     1294     8621    2           END;

   8621  1 003413   003423 710000 1                  TRA     s:8626

     1295     8622    1         ELSE
     1296     8623                %UNLOCK   (G=KQ$CG.DTREE.GATE);

   8624  1 003414   200003 236100                    LDQ     @KQ$CG,,AUTO
         1 003415   000231 036003                    ADLQ    153,DU
         1 003416   200112 756100                    STQ     I$+1,,AUTO
         1 003417   200112 630500                    EPPR0   I$+1,,AUTO
         1 003420   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 003421   000000 701000 xent               TSX1    HFC$UNLOCK
         1 003422   000000 011000                    NOP     0

     1297     8626    1         GOTO FTCH40;

   8626  1 003423   003023 710000 1                  TRA     FTCH40

     1298     8627
     1299     8628        %EJECT;
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:219  
     1300     8629
     1301     8630
     1302     8631        /*F* NAME:         KQD$RENEGE
     1303     8632
     1304     8633             PURPOSE:      Change the status of a data block back from
     1305     8634                           latch-deleted to active.
     1306     8635
     1307     8636        */
     1308     8637
     1309     8638
     1310     8639
     1311     8640        /*D* NAME:         KQD$RENEGE
     1312     8641
     1313     8642             CALL:         CALL KQD$RENEGE(KQ$CG,STAMP,DDA) ALTRET(LOC);
     1314     8643
     1315     8644             INPUT:        KQ$CG - Comgroup context block
     1316     8645                           STAMP - Expected data block stamp
     1317     8646                           DDA - Data disc address of data block
     1318     8647
     1319     8648             DESCRIPTION:  The data block is located, it is removed from
     1320     8649                           the available chain, and it is marked active.
     1321     8650
     1322     8651        */
     1323     8652        %EJECT;
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:220  
     1324     8653
     1325     8654
     1326     8655    1   KQD$RENEGE: ENTRY(KQ$CG,PDBLK$,PDDA) ALTRET;

   8655  1 003424   000000 700200 xent  KQD$RENEGE   TSX0  ! X66_AUTO_3
         1 003425   000122 000003                    ZERO    82,3

     1327     8656
     1328     8657
     1329     8658    1         REGFLG=1;

   8658  1 003426   000001 235007                    LDA     1,DL
         1 003427   200026 755100                    STA     REGFLG,,AUTO

     1330     8659    1         ENTFLG=%KQDC_RENEGE;

   8659  1 003430   000002 236007                    LDQ     2,DL
         1 003431   200020 756100                    STQ     ENTFLG,,AUTO

     1331     8660    1         GOTO FTCH8;

   8660  1 003432   002412 710000 1                  TRA     FTCH8

   8659  1 003433                       RENEGE       null
     1332     8661
     1333     8662    1   RENEGE: ;
     1334     8663    1         KQ$DBLK.LOCK='0'B;

   8663  1 003433   000020 236000 2                  LDQ     16
         1 003434   000003 356100                    ANSQ    3,,PR0

     1335     8664    1         KQ$DGRAN.USECNT=KQ$DGRAN.USECNT-1;

   8664  1 003435   000001 336007                    LCQ     1,DL
         1 003436   100013 056100                    ASQ     11,,PR1

     1336     8665    1         IF NOT KQ$DBLK.LREL THEN
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:221  

   8665  1 003437   000003 236100                    LDQ     3,,PR0
         1 003440   000100 316003                    CANQ    64,DU
         1 003441   003554 600000 1                  TZE     RENEGE50

     1337     8666    1           GOTO RENEGE50;  /* Don't continue with next section */
     1338     8667    1         IF KQ$DBLK.ACTIVE THEN

   8667  1 003442   000400 316003                    CANQ    256,DU
         1 003443   003457 600000 1                  TZE     s:8674

     1339     8668    2           DO;

     1340     8669    2           CALL LOGERR(%KQELOG_KQD_STATE);

   8669  1 003444   000001 236000 xsym               LDQ     B_VECTNIL+1
         1 003445   200054 756100                    STQ     @CODE+1,,AUTO
         1 003446   000000 236000 2                  LDQ     0
         1 003447   200053 756100                    STQ     LDGRAN$+3,,AUTO
         1 003450   007720 701000 1                  TSX1    LOGERR
         1 003451   000000 011000                    NOP     0

     1341     8670    2           IF KQ_DEBUG~=0 THEN

   8670  1 003452   000000 235000 xsym               LDA     KQ_DEBUG
         1 003453   003456 600000 1                  TZE     s:8672

     1342     8671    2             CALL SC_CGCACHE;

   8671  1 003454   000000 713400 xsym               CLIMB   SC_CGCACHE
         1 003455   000000 600000 xsid               climb   nvectors=         0

     1343     8672    2           GOTO RENEGE50;

   8672  1 003456   003554 710000 1                  TRA     RENEGE50

     1344     8673    2           END;
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:222  
     1345     8674    1         KQ$DGRAN.ACTCNT=KQ$DGRAN.ACTCNT+1;

   8674  1 003457   100022 054100                    AOS     18,,PR1

     1346     8675    1         I=POFFW(DBLK$,DGRAN$);

   8675  1 003460   200011 235100                    LDA     DGRAN$,,AUTO
         1 003461   000022 771000                    ARL     18
         1 003462   200112 755100                    STA     I$+1,,AUTO
         1 003463   200006 236100                    LDQ     DBLK$,,AUTO
         1 003464   000022 772000                    QRL     18
         1 003465   200112 136100                    SBLQ    I$+1,,AUTO
         1 003466   200012 756100                    STQ     I,,AUTO

     1347     8676    1         J=KQ$DGRAN.AVAILX;

   8676  1 003467   100014 235100                    LDA     12,,PR1
         1 003470   200013 755100                    STA     J,,AUTO

     1348     8677    2           DO WHILE(J~=0);  /* Run the avail chain */

   8677  1 003471   003542 600000 1                  TZE     s:8703

     1349     8678    2           IF I=J THEN

   8678  1 003472   200012 236100                    LDQ     I,,AUTO
         1 003473   200013 116100                    CMPQ    J,,AUTO
         1 003474   003531 601000 1                  TNZ     s:8700

     1350     8679    3             DO INHIBIT; /* Got it */

     1351     8680    3             IF J=KQ$DGRAN.AVAILX THEN

   8680  1 003475   200011 470700                    LDP0  ! DGRAN$,,AUTO
         1 003476   200013 236300                    LDQ   ! J,,AUTO
         1 003477   000014 116300                    CMPQ  ! 12,,PR0
         1 003500   003506 601200 1                  TNZ   ! s:8683
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:223  

     1352     8681    3               KQ$DGRAN.AVAILX=KQ$DBLK.LINKX;

   8681  1 003501   200006 471700                    LDP1  ! DBLK$,,AUTO
         1 003502   100003 236300                    LDQ   ! 3,,PR1
         1 003503   777777 376207                    ANQ   ! -1,DL
         1 003504   000014 756300                    STQ   ! 12,,PR0
         1 003505   003512 710200 1                  TRA   ! s:8684

     1353     8682    3             ELSE
     1354     8683    3               PREVDBLK$->KQ$DBLK.LINKX=KQ$DBLK.LINKX;

   8683  1 003506   200006 471700                    LDP1  ! DBLK$,,AUTO
         1 003507   100003 720300                    LXL0  ! 3,,PR1
         1 003510   200014 473700                    LDP3  ! PREVDBLK$,,AUTO
         1 003511   300003 440300                    SXL0  ! 3,,PR3

     1355     8684    3             KQ$DBLK.ACTIVE='1'B;

   8684  1 003512   000400 236203                    LDQ   ! 256,DU
         1 003513   100003 256300                    ORSQ  ! 3,,PR1

     1356     8685    3             KQ$DBLK.LREL='0'B;

   8685  1 003514   000011 236200 2                  LDQ   ! 9
         1 003515   100003 356300                    ANSQ  ! 3,,PR1

     1357     8686    3             KQ$DBLK.STA$=ADDR(NIL);

   8686  1 003516   000001 236200 xsym               LDQ   ! B_VECTNIL+1
         1 003517   100002 756300                    STQ   ! 2,,PR1

     1358     8687    3             KQ$DGRAN.HDR.UPD='1'B; /* Set granule modified */

   8687  1 003520   000010 236203                    LDQ   ! 8,DU
         1 003521   000001 256300                    ORSQ  ! 1,,PR0

PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:224  
     1359     8688
     1360     8689        /*        A DBLK that was LREL'd is considered AVAILable but not
     1361     8690                  FREE.  Therefore, when it was LREL'd I added the size
     1362     8691                  of the DBLK to the number of the WRDSAVAIL but not to
     1363     8692                  the number of the WRDSFREE.  Therefore now that we are
     1364     8693                  REENGAGing this DBLK we only have to SUBTRACT the size
     1365     8694                  from WRDSAVAIL but not from the WRDSFREE.             */
     1366     8695
     1367     8696    3             CALL COUNT_WORDS(%SUBTRACT,%NONE) ;

   8696  1 003522   000012 236200 2                  LDQ   ! 10
         1 003523   200104 756300                    STQ   ! ADDFLG+1,,AUTO
         1 003524   000001 236200 2                  LDQ   ! 1
         1 003525   200103 756300                    STQ   ! Q$+1,,AUTO
         1 003526   002215 701200 1                  TSX1  ! COUNT_WORDS
         1 003527   000000 011200                    NOP   ! 0

     1368     8697
     1369     8698    3             GOTO DEL45;

   8698  1 003530   004013 710200 1                  TRA   ! DEL45

     1370     8699    3             END;

     1371     8700    2           PREVDBLK$=PINCRW(DGRAN$,J);

   8700  1 003531   200013 236100                    LDQ     J,,AUTO
         1 003532   000022 736000                    QLS     18
         1 003533   200011 036100                    ADLQ    DGRAN$,,AUTO
         1 003534   200014 756100                    STQ     PREVDBLK$,,AUTO

     1372     8701    2           J=PREVDBLK$->KQ$DBLK.LINKX;

   8701  1 003535   200014 470500                    LDP0    PREVDBLK$,,AUTO
         1 003536   000003 236100                    LDQ     3,,PR0
         1 003537   777777 376007                    ANQ     -1,DL
         1 003540   200013 756100                    STQ     J,,AUTO
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:225  

     1373     8702    2           END;

   8702  1 003541   003472 601000 1                  TNZ     s:8678

     1374     8703    1         CALL LOGERR(%KQELOG_KQD_RENEGE);

   8703  1 003542   000001 236000 xsym               LDQ     B_VECTNIL+1
         1 003543   200054 756100                    STQ     @CODE+1,,AUTO
         1 003544   000005 236000 2                  LDQ     5
         1 003545   200053 756100                    STQ     LDGRAN$+3,,AUTO
         1 003546   007720 701000 1                  TSX1    LOGERR
         1 003547   000000 011000                    NOP     0

     1375     8704    1         IF KQ_DEBUG~=0 THEN

   8704  1 003550   000000 235000 xsym               LDA     KQ_DEBUG
         1 003551   003554 600000 1                  TZE     RENEGE50

     1376     8705    1           CALL SC_CGCACHE; /* Data block not on avail list */

   8705  1 003552   000000 713400 xsym               CLIMB   SC_CGCACHE
         1 003553   000000 600000 xsid               climb   nvectors=         0

   8704  1 003554                       RENEGE50     null
     1377     8706        /**/
     1378     8707    1   RENEGE50: ;
     1379     8708    1         DDA='0'B;

   8708  1 003554   200031 450100                    STZ     DDA,,AUTO

     1380     8709    1         GOTO DEL50;

   8709  1 003555   004030 710000 1                  TRA     DEL50

     1381     8710        %EJECT;
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:226  
     1382     8711
     1383     8712
     1384     8713        /*F* NAME:         KQD$DELETE
     1385     8714
     1386     8715             PURPOSE:      Delete a data block that is locked in core
     1387     8716
     1388     8717        */
     1389     8718
     1390     8719
     1391     8720        /*D* NAME:         KQD$DELETE
     1392     8721
     1393     8722             ENTRY:        KQD$UNLOCK,KQD$LREL,KQD$UPDATED
     1394     8723
     1395     8724             CALL:         CALL KQD$DELETE(KQ$CG,DBLK$);
     1396     8725                           CALL KQD$UNLOCK(KQ$CG,DBLK$);
     1397     8726                           CALL KQD$LREL(KQ$CG,DBLK$,STA$);
     1398     8727
     1399     8728             INPUT:        KQ$CG - Comgroup context block
     1400     8729                           DBLK$ - Pointer to data block
     1401     8730                           STA$ - Pointer to station block (KQD$LREL only)
     1402     8731
     1403     8732             DESCRIPTION:  The granule's use count is decremented.  If
     1404     8733                           this is not KQD$UNLOCK, the block is added
     1405     8734                           to the granule's free list.  If KQD$LREL, the
     1406     8735                           LATCHCNT and STA$ fields in the data block
     1407     8736                           are filled in.
     1408     8737
     1409     8738        */
     1410     8739        %EJECT;
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:227  
     1411     8740
     1412     8741
     1413     8742    1   KQD$UNLOCK: ENTRY(KQ$CG,PDBLK$) ALTRET;

   8742  1 003556   000000 700200 xent  KQD$UNLOCK   TSX0  ! X66_AUTO_3
         1 003557   000122 000003                    ZERO    82,3

     1414     8743    1         DELFLG=%KQD_UNLOCK;

   8743  1 003560   200021 450100                    STZ     DELFLG,,AUTO

     1415     8744    1         GOTO DELCOM;

   8744  1 003561   003614 710000 1                  TRA     DELCOM

     1416     8745
     1417     8746    1   KQD$UPDATED: ENTRY(KQ$CG,PDBLK$) ALTRET;

   8746  1 003562   000000 700200 xent  KQD$UPDATED  TSX0  ! X66_AUTO_3
         1 003563   000122 000003                    ZERO    82,3

     1418     8747    1         DELFLG=%KQD_UPD;

   8747  1 003564   000001 235007                    LDA     1,DL
         1 003565   200021 755100                    STA     DELFLG,,AUTO

     1419     8748    1         GOTO DELCOM;

   8748  1 003566   003614 710000 1                  TRA     DELCOM

     1420     8749
     1421     8750    1   KQD$UPDATE: ENTRY(KQ$CG,PDBLK$) ALTRET;  /* Never ALTRETs */

   8750  1 003567   000000 700200 xent  KQD$UPDATE   TSX0  ! X66_AUTO_3
         1 003570   000122 000003                    ZERO    82,3

     1422     8751    1         DBLK$=PDBLK$;
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:228  

   8751  1 003571   200004 470500                    LDP0    @PDBLK$,,AUTO
         1 003572   000000 236100                    LDQ     0,,PR0
         1 003573   200006 756100                    STQ     DBLK$,,AUTO

     1423     8752    1         DGRAN$=DBLK$;

   8752  1 003574   200011 756100                    STQ     DGRAN$,,AUTO

     1424     8753    1         DGRAN.DISP=0;

   8753  1 003575   000010 236000 2                  LDQ     8
         1 003576   200011 356100                    ANSQ    DGRAN$,,AUTO

     1425     8754    1         KQ$DGRAN.HDR.UPD='1'B;  /* Set granule updated */

   8754  1 003577   200011 471500                    LDP1    DGRAN$,,AUTO
         1 003600   000010 236003                    LDQ     8,DU
         1 003601   100001 256100                    ORSQ    1,,PR1

     1426     8755    1         RETURN;

   8755  1 003602   000000 702200 xent               TSX2  ! X66_ARET

     1427     8756
     1428     8757    1   KQD$DELETE: ENTRY(KQ$CG,PDBLK$) ALTRET;

   8757  1 003603   000000 700200 xent  KQD$DELETE   TSX0  ! X66_AUTO_3
         1 003604   000122 000003                    ZERO    82,3

     1429     8758    1         DELFLG=%KQD_DEL;

   8758  1 003605   000003 235007                    LDA     3,DL
         1 003606   200021 755100                    STA     DELFLG,,AUTO

     1430     8759    1         GOTO DELCOM;

PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:229  
   8759  1 003607   003614 710000 1                  TRA     DELCOM

     1431     8760
     1432     8761    1   KQD$LREL: ENTRY(KQ$CG,PDBLK$,PDDA) ALTRET;

   8761  1 003610   000000 700200 xent  KQD$LREL     TSX0  ! X66_AUTO_3
         1 003611   000122 000003                    ZERO    82,3

     1433     8762    1         DELFLG=%KQD_LREL;

   8762  1 003612   000002 235007                    LDA     2,DL
         1 003613   200021 755100                    STA     DELFLG,,AUTO

   8762  1 003614                       DELCOM       null
     1434     8763
     1435     8764    1   DELCOM:;
     1436     8765    1         ENTFLG=0;  /* Don't try to flink */

   8765  1 003614   200020 450100                    STZ     ENTFLG,,AUTO

     1437     8766    1         REGFLG=0;  /* Don't try to REG */

   8766  1 003615   200026 450100                    STZ     REGFLG,,AUTO

     1438     8767    1         DBLK$=PDBLK$;

   8767  1 003616   200004 470500                    LDP0    @PDBLK$,,AUTO
         1 003617   000000 236100                    LDQ     0,,PR0
         1 003620   200006 756100                    STQ     DBLK$,,AUTO

     1439     8768    1         DFR$=ADDR(NIL);

   8768  1 003621   000001 236000 xsym               LDQ     B_VECTNIL+1
         1 003622   200007 756100                    STQ     DFR$,,AUTO

     1440     8769    2         IF KQ_LOG.KQD THEN DO;

PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:230  
   8769  1 003623   000000 236000 xsym               LDQ     KQ_LOG
         1 003624   040000 316003                    CANQ    16384,DU
         1 003625   003662 600000 1                  TZE     s:8779

     1441     8770    2           DGRAN$=DBLK$;

   8770  1 003626   200006 236100                    LDQ     DBLK$,,AUTO
         1 003627   200011 756100                    STQ     DGRAN$,,AUTO

     1442     8771    2           DGRAN.DISP=0;

   8771  1 003630   000010 236000 2                  LDQ     8
         1 003631   200011 356100                    ANSQ    DGRAN$,,AUTO

     1443     8772    2           DDA.DA=ADDR(KQ$DGRAN.BTN.KEY)->WRD(0);

   8772  1 003632   200011 471500                    LDP1    DGRAN$,,AUTO
         1 003633   100011 236100                    LDQ     9,,PR1
         1 003634   200031 552134                    STBQ    DDA,'34'O,AUTO

     1444     8773    2           DDA.DISP=DBLK.DISP;

   8773  1 003635   200006 236100                    LDQ     DBLK$,,AUTO
         1 003636   000010 736000                    QLS     8
         1 003637   200031 552140                    STBQ    DDA,'40'O,AUTO

     1445     8774    2           LDBLK$=DBLK$;

   8774  1 003640   200006 236100                    LDQ     DBLK$,,AUTO
         1 003641   200047 756100                    STQ     LDBLK$,,AUTO

     1446     8775    2           CALL KQZ$LOG(KQ$CG,%KQLOG_DELETE,,DELFLG,

   8775  1 003642   200047 633500                    EPPR3   LDBLK$,,AUTO
         1 003643   200120 453500                    STP3    I$+7,,AUTO
         1 003644   200031 634500                    EPPR4   DDA,,AUTO
         1 003645   200117 454500                    STP4    I$+6,,AUTO
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:231  
         1 003646   000001 236000 xsym               LDQ     B_VECTNIL+1
         1 003647   200116 756100                    STQ     I$+5,,AUTO
         1 003650   200021 635500                    EPPR5   DELFLG,,AUTO
         1 003651   200115 455500                    STP5    I$+4,,AUTO
         1 003652   200114 756100                    STQ     I$+3,,AUTO
         1 003653   000002 236000 2                  LDQ     2
         1 003654   200003 235100                    LDA     @KQ$CG,,AUTO
         1 003655   200112 757100                    STAQ    I$+1,,AUTO
         1 003656   200112 630500                    EPPR0   I$+1,,AUTO
         1 003657   000025 631400 xsym               EPPR1   B_VECTNIL+21
         1 003660   000000 701000 xent               TSX1    KQZ$LOG
         1 003661   000000 011000                    NOP     0

     1447     8776    2           ,DDA,LDBLK$);
     1448     8777    2           END;

     1449     8778              %LOCK (G=KQ$CG.DTREE.GATE);

   8779  1 003662   200003 236100                    LDQ     @KQ$CG,,AUTO
         1 003663   000231 036003                    ADLQ    153,DU
         1 003664   200112 756100                    STQ     I$+1,,AUTO
         1 003665   200112 630500                    EPPR0   I$+1,,AUTO
         1 003666   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 003667   000000 701000 xent               TSX1    HFC$LOCK
         1 003670   000000 011000                    NOP     0

   8775  1 003671                       DELCOM4      null
     1450     8781
     1451     8782    1   DELCOM4: ;
     1452     8783    1         DGRAN$=DBLK$;

   8783  1 003671   200006 236100                    LDQ     DBLK$,,AUTO
         1 003672   200011 756100                    STQ     DGRAN$,,AUTO

     1453     8784    1         DGRAN.DISP=0;

   8784  1 003673   000010 236000 2                  LDQ     8
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:232  
         1 003674   200011 356100                    ANSQ    DGRAN$,,AUTO

     1454     8785    1         IF NOT KQ$DBLK.ACTIVE OR NOT KQ$DBLK.LOCK OR KQ$DBLK.LREL THEN

   8785  1 003675   200006 470500                    LDP0    DBLK$,,AUTO
         1 003676   000003 236100                    LDQ     3,,PR0
         1 003677   000400 316003                    CANQ    256,DU
         1 003700   003705 600000 1                  TZE     DEL30
         1 003701   000200 316003                    CANQ    128,DU
         1 003702   003705 600000 1                  TZE     DEL30
         1 003703   000100 316003                    CANQ    64,DU
         1 003704   003721 600000 1                  TZE     s:8794

     1455     8786    2           DO;

   8785  1 003705                       DEL30        null
     1456     8787    2   DEL30:  ;
     1457     8788    2           CALL LOGERR(%KQELOG_KQD_DSTATE);

   8788  1 003705   000001 236000 xsym               LDQ     B_VECTNIL+1
         1 003706   200054 756100                    STQ     @CODE+1,,AUTO
         1 003707   000014 236000 2                  LDQ     12
         1 003710   200053 756100                    STQ     LDGRAN$+3,,AUTO
         1 003711   007720 701000 1                  TSX1    LOGERR
         1 003712   000000 011000                    NOP     0

     1458     8789    2           IF KQ_DEBUG~=0 THEN

   8789  1 003713   000000 235000 xsym               LDA     KQ_DEBUG
         1 003714   003717 600000 1                  TZE     s:8791

     1459     8790    2             CALL SC_CGCACHE;

   8790  1 003715   000000 713400 xsym               CLIMB   SC_CGCACHE
         1 003716   000000 600000 xsid               climb   nvectors=         0

     1460     8791    2           DDA='0'B;
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:233  

   8791  1 003717   200031 450100                    STZ     DDA,,AUTO

     1461     8792    2           GOTO DEL50;

   8792  1 003720   004030 710000 1                  TRA     DEL50

     1462     8793    2           END;
     1463     8794    1         ELSE IF KQ$DGRAN.USECNT = 0 THEN

   8794  1 003721   200011 471500                    LDP1    DGRAN$,,AUTO
         1 003722   100013 235100                    LDA     11,,PR1
         1 003723   003705 600000 1                  TZE     DEL30

     1464     8795    1             GOTO DEL30;
     1465     8796    1         KQ$DBLK.LOCK='0'B;

   8796  1 003724   000020 236000 2                  LDQ     16
         1 003725   000003 356100                    ANSQ    3,,PR0

     1466     8797    1         KQ$DGRAN.USECNT=KQ$DGRAN.USECNT-1;

   8797  1 003726   000001 336007                    LCQ     1,DL
         1 003727   100013 056100                    ASQ     11,,PR1

     1467     8798    1         KQ$DGRAN.ACTCNT=KQ$DGRAN.ACTCNT+1;

   8798  1 003730   100022 054100                    AOS     18,,PR1

     1468     8799    2           DO CASE(DELFLG);

   8799  1 003731   200021 235100                    LDA     DELFLG,,AUTO
         1 003732   000004 115007                    CMPA    4,DL
         1 003733   003735 602005 1                  TNC     s:8799+4,AL
         1 003734   004013 710000 1                  TRA     DEL45
         1 003735   004013 710000 1                  TRA     DEL45
         1 003736   003741 710000 1                  TRA     s:8801
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:234  
         1 003737   003744 710000 1                  TRA     s:8804
         1 003740   003744 710000 1                  TRA     s:8804

     1469     8800    2             CASE(%KQD_UPD);

     1470     8801    2               KQ$DGRAN.HDR.UPD='1'B;

   8801  1 003741   000010 236003                    LDQ     8,DU
         1 003742   100001 256100                    ORSQ    1,,PR1
         1 003743   004013 710000 1                  TRA     DEL45

     1471     8802    2             CASE(%KQD_DEL,%KQD_LREL);

     1472     8803    3                 DO INHIBIT;

     1473     8804    3                 KQ$DBLK.LINKX=KQ$DGRAN.AVAILX;

   8804  1 003744   100014 720300                    LXL0  ! 12,,PR1
         1 003745   000003 440300                    SXL0  ! 3,,PR0

     1474     8805    3                 KQ$DGRAN.AVAILX=POFFW(DBLK$,DGRAN$);

   8805  1 003746   200011 235300                    LDA   ! DGRAN$,,AUTO
         1 003747   000022 771200                    ARL   ! 18
         1 003750   200112 755300                    STA   ! I$+1,,AUTO
         1 003751   200006 236300                    LDQ   ! DBLK$,,AUTO
         1 003752   000022 772200                    QRL   ! 18
         1 003753   200112 136300                    SBLQ  ! I$+1,,AUTO
         1 003754   100014 756300                    STQ   ! 12,,PR1

     1475     8806    3                 KQ$DGRAN.HDR.UPD='1'B; /* Set granule modified */

   8806  1 003755   000010 236203                    LDQ   ! 8,DU
         1 003756   100001 256300                    ORSQ  ! 1,,PR1

     1476     8807    3                 KQ$DBLK.ACTIVE='0'B;

PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:235  
   8807  1 003757   000024 236200 2                  LDQ   ! 20
         1 003760   000003 356300                    ANSQ  ! 3,,PR0

     1477     8808    3                 END;

     1478     8809    2               IF DELFLG=%KQD_LREL THEN

   8809  1 003761   200021 235100                    LDA     DELFLG,,AUTO
         1 003762   000002 115007                    CMPA    2,DL
         1 003763   004006 601000 1                  TNZ     s:8829

     1479     8810    3                 DO; /* Latch release */

     1480     8811    3                 KQ$DBLK.LATCHCNT=PSTA$->KQ$STA.LATCHCNT;

   8811  1 003764   200005 473500                    LDP3    @PDDA,,AUTO
         1 003765   300000 474500                    LDP4    0,,PR3
         1 003766   400015 236100                    LDQ     13,,PR4
         1 003767   000003 552140                    STBQ    3,'40'O,PR0

     1481     8812    3                 KQ$DBLK.STA$=PSTA$;

   8812  1 003770   300000 236100                    LDQ     0,,PR3
         1 003771   000002 756100                    STQ     2,,PR0

     1482     8813    3                 KQ$DBLK.LREL='1'B;

   8813  1 003772   000100 236003                    LDQ     64,DU
         1 003773   000003 256100                    ORSQ    3,,PR0

     1483     8814    3                 KQ$DBLK.ACTCNT=KQ$CG.STREE.ACTCNT;

   8814  1 003774   200003 474500                    LDP4    @KQ$CG,,AUTO
         1 003775   400102 220100                    LDX0    66,,PR4
         1 003776   000004 440100                    SXL0    4,,PR0

     1484     8815                    /* Since this DBLK was LREL'd, it is considered AVAILable
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:236  
     1485     8816                       But no FREE.  Therefore only add it to the WRDSAVAIL
     1486     8817                       not to the WRDSFREE.  It will be added to WRDSFREE in
     1487     8818                       ALLOC when we re-use this DBLK for something else.  It
     1488     8819                       will be SUBTRACTED from WRDSAVAIL in REENGAGE if we
     1489     8820                       REENGAGE it.                           */
     1490     8821
     1491     8822    3                 CALL COUNT_WORDS(%ADD,%NONE);

   8822  1 003777   000012 236000 2                  LDQ     10
         1 004000   200104 756100                    STQ     ADDFLG+1,,AUTO
         1 004001   000000 236000 2                  LDQ     0
         1 004002   200103 756100                    STQ     Q$+1,,AUTO
         1 004003   002215 701000 1                  TSX1    COUNT_WORDS
         1 004004   000000 011000                    NOP     0

     1492     8823    3                 END ;

   8823  1 004005   004013 710000 1                  TRA     DEL45

     1493     8824    2               ELSE
     1494     8825                /* Since this DBLK was DELeted and not LREL'd, it is both
     1495     8826                   AVAILable and FREE.  Therefore ADD the size to both the
     1496     8827                   WRDSAVAIL and WRDSFREE in the granule.             */
     1497     8828
     1498     8829    2                 CALL COUNT_WORDS(%ADD,%ADD);

   8829  1 004006   000000 236000 2                  LDQ     0
         1 004007   200104 756100                    STQ     ADDFLG+1,,AUTO
         1 004010   200103 756100                    STQ     Q$+1,,AUTO
         1 004011   002215 701000 1                  TSX1    COUNT_WORDS
         1 004012   000000 011000                    NOP     0

     1499     8830
     1500     8831    2           END;

   8822  1 004013                       DEL45        null
     1501     8832    1   DEL45: ;
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:237  
     1502     8833    2           DO CASE(ENTFLG);

   8833  1 004013   200020 235100                    LDA     ENTFLG,,AUTO
         1 004014   000004 115007                    CMPA    4,DL
         1 004015   004017 602005 1                  TNC     DEL45+4,AL
         1 004016   004027 710000 1                  TRA     s:8837
         1 004017   004027 710000 1                  TRA     s:8837
         1 004020   004027 710000 1                  TRA     s:8837
         1 004021   004023 710000 1                  TRA     s:8835
         1 004022   004023 710000 1                  TRA     s:8835

     1503     8834    2             CASE(%KQDC_RENEGE,%KQDC_DEL);

     1504     8835    2               DDA=BINBIT(KQ$DBLK.FLNKDA,36);

   8835  1 004023   200006 470500                    LDP0    DBLK$,,AUTO
         1 004024   000001 236100                    LDQ     1,,PR0
         1 004025   200031 756100                    STQ     DDA,,AUTO
         1 004026   004030 710000 1                  TRA     DEL50

     1505     8836    2             CASE(ELSE);

     1506     8837    2               DDA='0'B;

   8837  1 004027   200031 450100                    STZ     DDA,,AUTO

     1507     8838    2           END;

   8833  1 004030                       DEL50        null
     1508     8839    1   DEL50: ;
     1509     8840    1         IF DDA='0'B AND DFR$~=ADDR(NIL) THEN

   8840  1 004030   200031 235100                    LDA     DDA,,AUTO
         1 004031   004037 601000 1                  TNZ     s:8842
         1 004032   200007 236100                    LDQ     DFR$,,AUTO
         1 004033   000001 116000 xsym               CMPQ    B_VECTNIL+1
         1 004034   004037 600000 1                  TZE     s:8842
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:238  

     1510     8841    1           CALL RELBLK;

   8841  1 004035   004244 701000 1                  TSX1    RELBLK
         1 004036   000000 011000                    NOP     0

     1511     8842    1         IF KQ$DGRAN.USECNT=0 THEN

   8842  1 004037   200011 470500                    LDP0    DGRAN$,,AUTO
         1 004040   000013 235100                    LDA     11,,PR0
         1 004041   004064 601000 1                  TNZ     DEL55

     1512     8843    2           DO;

     1513     8844    2           IF KQ$CG.DELAY.NEEDPG OR KQ$CG.CURDATAPGS>KQ$CG.MAXDATAPGS THEN

   8844  1 004042   200003 471500                    LDP1    @KQ$CG,,AUTO
         1 004043   100020 236100                    LDQ     16,,PR1
         1 004044   040000 316003                    CANQ    16384,DU
         1 004045   004052 601000 1                  TNZ     s:8845
         1 004046   100241 720100                    LXL0    161,,PR1
         1 004047   100241 100100                    CMPX0   161,,PR1
         1 004050   004055 602000 1                  TNC     s:8847
         1 004051   004055 600000 1                  TZE     s:8847

     1514     8845    2             KQ$DGRAN.HDR.FORCEOUT='0'B;

   8845  1 004052   000024 236000 2                  LDQ     20
         1 004053   000001 356100                    ANSQ    1,,PR0
         1 004054   004060 710000 1                  TRA     s:8849

     1515     8846    2           ELSE
     1516     8847    2             IF NOT KQ$DGRAN.HDR.FORCEOUT THEN

   8847  1 004055   000001 236100                    LDQ     1,,PR0
         1 004056   000400 316003                    CANQ    256,DU
         1 004057   004064 600000 1                  TZE     DEL55
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:239  

     1517     8848    2               GOTO DEL55;
     1518     8849    2           CALL REMPAGE ALTRET(DEL60);

   8849  1 004060   005456 701000 1                  TSX1    REMPAGE
         1 004061   004073 702000 1                  TSX2    DEL60

     1519     8850    2           CALL RELPAGE ALTRET(DEL60);

   8850  1 004062   006103 701000 1                  TSX1    RELPAGE
         1 004063   004073 702000 1                  TSX2    DEL60

     1520     8851    2           END;

   8850  1 004064                       DEL55        null
     1521     8852    1   DEL55: ;
     1522     8853              %UNLOCK (G=KQ$CG.DTREE.GATE);

   8854  1 004064   200003 236100                    LDQ     @KQ$CG,,AUTO
         1 004065   000231 036003                    ADLQ    153,DU
         1 004066   200112 756100                    STQ     I$+1,,AUTO
         1 004067   200112 630500                    EPPR0   I$+1,,AUTO
         1 004070   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 004071   000000 701000 xent               TSX1    HFC$UNLOCK
         1 004072   000000 011000                    NOP     0

   8850  1 004073                       DEL60        null
     1523     8856    1   DEL60: ;
     1524     8857    1         IF DDA~='0'B THEN

   8857  1 004073   200031 235100                    LDA     DDA,,AUTO
         1 004074   002422 601000 1                  TNZ     FETCH

     1525     8858    1           GOTO FETCH;  /* Do next segment */
     1526     8859    1         RETURN;

   8859  1 004075   000000 702200 xent               TSX2  ! X66_ARET
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:240  

     1527     8860        %EJECT;
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:241  
     1528     8861
     1529     8862
     1530     8863        /*F* NAME:         KQD$DELDDA
     1531     8864
     1532     8865             PURPOSE:      Delete a data block given a data disk address
     1533     8866
     1534     8867        */
     1535     8868
     1536     8869
     1537     8870        /*D* NAME:         KQD$DELDDA
     1538     8871
     1539     8872             CALL:         CALL KQD$DELDDA(KQ$CG,STAMP,DDA);
     1540     8873
     1541     8874             INPUT:        KQ$CG - Comgroup context block
     1542     8875                           STAMP - Expected data stamp
     1543     8876                           DDA   - Data disk address
     1544     8877
     1545     8878             DESCRIPTION:  Deletes the data block whether or not the
     1546     8879                           block is in core.
     1547     8880
     1548     8881        */
     1549     8882        %EJECT;
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:242  
     1550     8883
     1551     8884
     1552     8885    1   KQD$DELDDA: ENTRY(KQ$CG,PDBLK$,PDDA) ALTRET;

   8885  1 004076   000000 700200 xent  KQD$DELDDA   TSX0  ! X66_AUTO_3
         1 004077   000122 000003                    ZERO    82,3

     1553     8886
     1554     8887    1         REGFLG=0;

   8887  1 004100   200026 450100                    STZ     REGFLG,,AUTO

     1555     8888    1         ENTFLG=%KQDC_DEL;

   8888  1 004101   000003 235007                    LDA     3,DL
         1 004102   200020 755100                    STA     ENTFLG,,AUTO

     1556     8889    1         GOTO FTCH8;

   8889  1 004103   002412 710000 1                  TRA     FTCH8

     1557     8890
     1558     8891        %EJECT;
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:243  
     1559     8892
     1560     8893
     1561     8894        /*D* NAME:         GETBLK
     1562     8895
     1563     8896             CALL:         CALL GETBLK ALTRET(LOC);
     1564     8897
     1565     8898             OUTPUT:       DFR$ - Ptr to a defer block
     1566     8899
     1567     8900             DESCRIPTION:  Obtains a defer block from the chain of avail
     1568     8901                           ones.  If one is not available, will ALTRET.
     1569     8902
     1570     8903        */
     1571     8904
     1572     8905
     1573     8906        /*D* NAME:         RELBLK
     1574     8907
     1575     8908             CALL:         CALL RELBLK ALTRET(LOC);
     1576     8909
     1577     8910             INPUT:        DFR$ - Ptr to defer block
     1578     8911
     1579     8912             DESCRIPTION:  Releases a defer block.
     1580     8913
     1581     8914        */
     1582     8915
     1583     8916
     1584     8917    1   GETBLK: PROC ALTRET;

   8917  1 004104   200104 741300       GETBLK       STX1  ! @FREE,,AUTO

     1585     8918
     1586     8919        /**/
     1587     8920        /* LOCAL AUTO */
     1588     8921        /**/
     1589     8922    2   DCL ENTF UBIN;
     1590     8923    2   DCL FLG UBIN;
     1591     8924
     1592     8925    2         ENTF=0;
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:244  

   8925  1 004105   200105 450100                    STZ     ENTF,,AUTO

     1593     8926    2         GOTO GET10;

   8926  1 004106   004112 710000 1                  TRA     GET10

     1594     8927
     1595     8928    2   GETBLKR: ENTRY ALTRET;

   8928  1 004107   200104 741300       GETBLKR      STX1  ! @FREE,,AUTO

     1596     8929
     1597     8930    2         ENTF=1;

   8930  1 004110   000001 235007                    LDA     1,DL
         1 004111   200105 755100                    STA     ENTF,,AUTO

   8930  1 004112                       GET10        null
     1598     8931
     1599     8932    2   GET10: ;
     1600     8933    2         FLG=0;

   8933  1 004112   200106 450100                    STZ     FLG,,AUTO

   8933  1 004113                       GET20        null
     1601     8934        /**/
     1602     8935    2   GET20: ;
     1603     8936    2         IF KQ$CG.DFRFREEHD$~=ADDR(NIL) THEN

   8936  1 004113   200003 470500                    LDP0    @KQ$CG,,AUTO
         1 004114   000230 236100                    LDQ     152,,PR0
         1 004115   000001 116000 xsym               CMPQ    B_VECTNIL+1
         1 004116   004203 600000 1                  TZE     s:8963

     1604     8937    3           DO;

PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:245  
     1605     8938    3           DFR$=KQ$CG.DFRFREEHD$;

   8938  1 004117   200007 756100                    STQ     DFR$,,AUTO

     1606     8939    3           KQ$CG.DFRFREEHD$=KQ$DFRBLK.LNK$;

   8939  1 004120   200007 471500                    LDP1    DFR$,,AUTO
         1 004121   100000 236100                    LDQ     0,,PR1
         1 004122   000230 756100                    STQ     152,,PR0

     1607     8940    3           IF KQ$CG.DFRFREEHD$=ADDR(NIL)

   8940  1 004123   000001 116000 xsym               CMPQ    B_VECTNIL+1
         1 004124   004127 601000 1                  TNZ     s:8942

     1608     8941    3           THEN KQ$CG.DFRFREETL$=ADDR(NIL);

   8941  1 004125   000001 236000 xsym               LDQ     B_VECTNIL+1
         1 004126   000263 756100                    STQ     179,,PR0

     1609     8942    3           KQ$DFRBLK=KQ_DFRBLK;

   8942  1 004127   000100 100400                    MLR     fill='000'O
         1 004130   000006 000040 0                  ADSC9   KQ_DFRBLK                cn=0,n=32
         1 004131   100000 000040                    ADSC9   0,,PR1                   cn=0,n=32

     1610     8943    3           IF REGFLG~=0 AND S_TIMR~=2 THEN

   8943  1 004132   200026 235100                    LDA     REGFLG,,AUTO
         1 004133   004143 600000 1                  TZE     s:8948
         1 004134   000000 236000 xsym               LDQ     S_TIMR
         1 004135   000002 116007                    CMPQ    2,DL
         1 004136   004143 600000 1                  TZE     s:8948

     1611     8944    4             DO;

     1612     8945    4             KQ$DFRBLK.USR=S_CUN;
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:246  

   8945  1 004137   000000 236000 xsym               LDQ     S_CUN
         1 004140   100001 552104                    STBQ    1,'04'O,PR1

     1613     8946    4             KQ$DFRBLK.GO='1'B;

   8946  1 004141   400000 236007                    LDQ     -131072,DL
         1 004142   100001 256100                    ORSQ    1,,PR1

     1614     8947    4             END;

     1615     8948    3           KQ$DFRBLK.DA=DA;

   8948  1 004143   200015 235100                    LDA     DA,,AUTO
         1 004144   100002 755100                    STA     2,,PR1

     1616     8949    3           KQ$DFRBLK.CODE=ENTFLG;

   8949  1 004145   200020 236100                    LDQ     ENTFLG,,AUTO
         1 004146   000033 736000                    QLS     27
         1 004147   100001 552140                    STBQ    1,'40'O,PR1

     1617     8950    4           IF KQ_LOG.DFR THEN DO;

   8950  1 004150   000000 430000 xsym               FSZN    KQ_LOG
         1 004151   004175 605000 1                  TPL     s:8955

     1618     8951    4             LDFR$=DFR$;

   8951  1 004152   200007 236100                    LDQ     DFR$,,AUTO
         1 004153   200046 756100                    STQ     LDFR$,,AUTO

     1619     8952    4             CALL KQZ$LOG(KQ$CG,%KQLOG_DFRGET,,ENTFLG,LDFR$,DA) ALTRET(LOG1);

   8952  1 004154   200015 633500                    EPPR3   DA,,AUTO
         1 004155   200117 453500                    STP3    I$+6,,AUTO
         1 004156   200046 634500                    EPPR4   LDFR$,,AUTO
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:247  
         1 004157   200116 454500                    STP4    I$+5,,AUTO
         1 004160   200020 635500                    EPPR5   ENTFLG,,AUTO
         1 004161   200115 455500                    STP5    I$+4,,AUTO
         1 004162   000001 236000 xsym               LDQ     B_VECTNIL+1
         1 004163   200114 756100                    STQ     I$+3,,AUTO
         1 004164   000026 236000 2                  LDQ     22
         1 004165   200003 235100                    LDA     @KQ$CG,,AUTO
         1 004166   200112 757100                    STAQ    I$+1,,AUTO
         1 004167   200112 630500                    EPPR0   I$+1,,AUTO
         1 004170   000024 631400 xsym               EPPR1   B_VECTNIL+20
         1 004171   000000 701000 xent               TSX1    KQZ$LOG
         1 004172   004175 702000 1                  TSX2    s:8955

     1620     8953    4             RETURN;  /* Never comes here */

   8953  1 004173   200104 221300                    LDX1  ! @FREE,,AUTO
         1 004174   000001 702211                    TSX2  ! 1,X1

     1621     8954    4   LOG1:     END;
     1622     8955    3           IF FLG=0 THEN

   8955  1 004175   200106 235100                    LDA     FLG,,AUTO
         1 004176   004201 601000 1                  TNZ     s:8959

     1623     8956    3             RETURN;

   8956  1 004177   200104 221300                    LDX1  ! @FREE,,AUTO
         1 004200   000001 702211                    TSX2  ! 1,X1

     1624     8957    3           ELSE
     1625     8958    4             DO;

     1626     8959    4             ALTRETURN;

   8959  1 004201   200104 221300                    LDX1  ! @FREE,,AUTO
         1 004202   000000 702211                    TSX2  ! 0,X1

PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:248  
     1627     8960    4             END;
     1628     8961    3           END;
     1629     8962        /**/
     1630     8963    2         KQ$CG.STATS.NODFRS=KQ$CG.STATS.NODFRS+1;

   8963  1 004203   000201 054100                    AOS     129,,PR0

     1631     8964    2         IF ENTF~=0 THEN

   8964  1 004204   200105 235100                    LDA     ENTF,,AUTO
         1 004205   004240 600000 1                  TZE     s:8977

     1632     8965    3           DO;

     1633     8966                %UNLOCK (G=KQ$CG.DTREE.GATE);

   8967  1 004206   200003 236100                    LDQ     @KQ$CG,,AUTO
         1 004207   000231 036003                    ADLQ    153,DU
         1 004210   200112 756100                    STQ     I$+1,,AUTO
         1 004211   200112 630500                    EPPR0   I$+1,,AUTO
         1 004212   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 004213   000000 701000 xent               TSX1    HFC$UNLOCK
         1 004214   000000 011000                    NOP     0

     1634     8969    3           CALL SSR$REG(%SS_SL,,1);

   8969  1 004215   000000 236000 2                  LDQ     0
         1 004216   200114 756100                    STQ     I$+3,,AUTO
         1 004217   000001 236000 xsym               LDQ     B_VECTNIL+1
         1 004220   000030 235000 2                  LDA     24
         1 004221   200112 757100                    STAQ    I$+1,,AUTO
         1 004222   200112 630500                    EPPR0   I$+1,,AUTO
         1 004223   000021 631400 xsym               EPPR1   B_VECTNIL+17
         1 004224   000000 701000 xent               TSX1    SSR$REG
         1 004225   000000 011000                    NOP     0

     1635     8970                %LOCK (G=KQ$CG.DTREE.GATE);
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:249  

   8971  1 004226   200003 236100                    LDQ     @KQ$CG,,AUTO
         1 004227   000231 036003                    ADLQ    153,DU
         1 004230   200112 756100                    STQ     I$+1,,AUTO
         1 004231   200112 630500                    EPPR0   I$+1,,AUTO
         1 004232   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 004233   000000 701000 xent               TSX1    HFC$LOCK
         1 004234   000000 011000                    NOP     0

     1636     8973    3           FLG=1;

   8973  1 004235   000001 235007                    LDA     1,DL
         1 004236   200106 755100                    STA     FLG,,AUTO

     1637     8974    3           GOTO GET20;

   8974  1 004237   004113 710000 1                  TRA     GET20

     1638     8975    3           END;
     1639     8976        /**/
     1640     8977    2         DFR$=ADDR(NIL);

   8977  1 004240   000001 236000 xsym               LDQ     B_VECTNIL+1
         1 004241   200007 756100                    STQ     DFR$,,AUTO

     1641     8978    2         ALTRETURN;

   8978  1 004242   200104 221300                    LDX1  ! @FREE,,AUTO
         1 004243   000000 702211                    TSX2  ! 0,X1

     1642     8979
     1643     8980
     1644     8981    2   RELBLK: ENTRY ALTRET;

   8981  1 004244   200104 741300       RELBLK       STX1  ! @FREE,,AUTO

     1645     8982
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:250  
     1646     8983    3         IF KQ_LOG.DFR THEN DO;

   8983  1 004245   000000 430000 xsym               FSZN    KQ_LOG
         1 004246   004274 605000 1                  TPL     s:8988

     1647     8984    3           LDFR$=DFR$; FLG=KQ$DFRBLK.CODE;

   8984  1 004247   200007 236100                    LDQ     DFR$,,AUTO
         1 004250   200046 756100                    STQ     LDFR$,,AUTO

   8984  1 004251   200007 470500                    LDP0    DFR$,,AUTO
         1 004252   000001 236100                    LDQ     1,,PR0
         1 004253   000033 772000                    QRL     27
         1 004254   200106 756100                    STQ     FLG,,AUTO

     1648     8985    3           CALL KQZ$LOG(KQ$CG,%KQLOG_DFRREL,,FLG,LDFR$) ALTRET(LOG2);

   8985  1 004255   200046 631500                    EPPR1   LDFR$,,AUTO
         1 004256   200116 451500                    STP1    I$+5,,AUTO
         1 004257   200106 633500                    EPPR3   FLG,,AUTO
         1 004260   200115 453500                    STP3    I$+4,,AUTO
         1 004261   000001 236000 xsym               LDQ     B_VECTNIL+1
         1 004262   200114 756100                    STQ     I$+3,,AUTO
         1 004263   000032 236000 2                  LDQ     26
         1 004264   200003 235100                    LDA     @KQ$CG,,AUTO
         1 004265   200112 757100                    STAQ    I$+1,,AUTO
         1 004266   200112 630500                    EPPR0   I$+1,,AUTO
         1 004267   000023 631400 xsym               EPPR1   B_VECTNIL+19
         1 004270   000000 701000 xent               TSX1    KQZ$LOG
         1 004271   004274 702000 1                  TSX2    s:8988

     1649     8986    3           RETURN;  /* Never comes here */

   8986  1 004272   200104 221300                    LDX1  ! @FREE,,AUTO
         1 004273   000001 702211                    TSX2  ! 1,X1

     1650     8987    3   LOG2:   END;
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:251  
     1651     8988    2         KQ$DFRBLK.LNK$=ADDR(NIL);

   8988  1 004274   000001 236000 xsym               LDQ     B_VECTNIL+1
         1 004275   200007 470500                    LDP0    DFR$,,AUTO
         1 004276   000000 756100                    STQ     0,,PR0

     1652     8989    2         IF KQ$CG.DFRFREETL$=ADDR(NIL)

   8989  1 004277   200003 471500                    LDP1    @KQ$CG,,AUTO
         1 004300   100263 236100                    LDQ     179,,PR1
         1 004301   000001 116000 xsym               CMPQ    B_VECTNIL+1
         1 004302   004306 601000 1                  TNZ     s:8991

     1653     8990    2         THEN KQ$CG.DFRFREEHD$=DFR$;

   8990  1 004303   200007 236100                    LDQ     DFR$,,AUTO
         1 004304   100230 756100                    STQ     152,,PR1
         1 004305   004311 710000 1                  TRA     s:8992

     1654     8991    2         ELSE KQ$CG.DFRFREETL$->KQ$DFRBLK.LNK$=DFR$;

   8991  1 004306   100263 473500                    LDP3    179,,PR1
         1 004307   200007 236100                    LDQ     DFR$,,AUTO
         1 004310   300000 756100                    STQ     0,,PR3

     1655     8992    2         KQ$CG.DFRFREETL$=DFR$;

   8992  1 004311   100263 756100                    STQ     179,,PR1

     1656     8993    2         DFR$=ADDR(NIL);

   8993  1 004312   000001 236000 xsym               LDQ     B_VECTNIL+1
         1 004313   200007 756100                    STQ     DFR$,,AUTO

     1657     8994    2         RETURN;

   8994  1 004314   200104 221300                    LDX1  ! @FREE,,AUTO
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:252  
         1 004315   000001 702211                    TSX2  ! 1,X1

     1658     8995
     1659     8996    2   END GETBLK;
     1660     8997        %EJECT;
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:253  
     1661     8998
     1662     8999
     1663     9000        /*F* NAME:         KQD$RELDFR
     1664     9001
     1665     9002             PURPOSE:      Release a defer block
     1666     9003
     1667     9004        */
     1668     9005
     1669     9006
     1670     9007        /*D* NAME:         KQD$RELDFR
     1671     9008
     1672     9009             CALL:         CALL KQD$RELDFR(KQ$CG,DFR$);
     1673     9010
     1674     9011             INPUT:        KQ$CG - Context block
     1675     9012                           DFR$ - Ptr to defer block
     1676     9013
     1677     9014             DESCRIPTION:  Releases the specified defer block.  Must be
     1678     9015                           called with KQ$CG.DTREE.GATE locked.
     1679     9016
     1680     9017        */
     1681     9018
     1682     9019
     1683     9020    1   KQD$RELDFR: ENTRY(KQ$CG,PDBLK$) ALTRET;  /* Never ALTRETs */

   9020  1 004316   000000 700200 xent  KQD$RELDFR   TSX0  ! X66_AUTO_3
         1 004317   000122 000003                    ZERO    82,3

     1684     9021
     1685     9022
     1686     9023    1         DFR$=PDBLK$;

   9023  1 004320   200004 470500                    LDP0    @PDBLK$,,AUTO
         1 004321   000000 236100                    LDQ     0,,PR0
         1 004322   200007 756100                    STQ     DFR$,,AUTO

     1687     9024    1         CALL RELBLK;

PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:254  
   9024  1 004323   004244 701000 1                  TSX1    RELBLK
         1 004324   000000 011000                    NOP     0

     1688     9025    1         RETURN;

   9025  1 004325   000000 702200 xent               TSX2  ! X66_ARET

     1689     9026        %EJECT;
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:255  
     1690     9027
     1691     9028
     1692     9029        /*D* NAME:         READGRAN
     1693     9030
     1694     9031             CALL:         CALL READGRAN;
     1695     9032
     1696     9033             INPUT:        DA - disk address to read
     1697     9034                           DFR$ - Ptr to defer block
     1698     9035
     1699     9036             DESCRIPTION:  The lists of pending requests are searched for
     1700     9037                           this disk address.  If found, this request is
     1701     9038                           added to the appropriate list.  If not found,
     1702     9039                           a page is obtained and the I/O started.
     1703     9040
     1704     9041        */
     1705     9042
     1706     9043
     1707     9044    1   READGRAN: PROC;

   9044  1 004326   200066 741300       READGRAN     STX1  ! P$+1,,AUTO

     1708     9045
     1709     9046
     1710     9047        /**/
     1711     9048        /* LOCAL AUTO */
     1712     9049        /**/
     1713     9050    2   DCL P$ PTR;
     1714     9051    2   DCL Q$ PTR;
     1715     9052        /**/
     1716     9053        /* BASED STRUCTURES */
     1717     9054        /**/
     1718     9055        %N$REQ (STCLASS="BASED(Q$)");
     1719     9113
     1720     9114    2         IF DA<FM_FRZERO THEN

   9114  1 004327   200015 236100                    LDQ     DA,,AUTO
         1 004330   000000 116000 xsym               CMPQ    FM_FRZERO
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:256  
         1 004331   004334 603000 1                  TRC     s:9117

     1721     9115    2           CALL SC_CGCACHE;  /* Illegal disk address */

   9115  1 004332   000000 713400 xsym               CLIMB   SC_CGCACHE
         1 004333   000000 600000 xsid               climb   nvectors=         0

     1722     9116
     1723     9117    2         P$=KQ$CG.IOHD$;

   9117  1 004334   200003 470500                    LDP0    @KQ$CG,,AUTO
         1 004335   000246 236100                    LDQ     166,,PR0
         1 004336   200067 756100                    STQ     P$,,AUTO

     1724     9118    3           DO WHILE(P$~=ADDR(NIL));

   9118  1 004337   004373 710000 1                  TRA     s:9130

     1725     9119    3           IF DA=P$->KQ$DFRBLK.DA AND P$->KQ$DFRBLK.CODE~=%KQDC_WRITE THEN

   9119  1 004340   200067 470500                    LDP0    P$,,AUTO
         1 004341   200015 236100                    LDQ     DA,,AUTO
         1 004342   000002 116100                    CMPQ    2,,PR0
         1 004343   004371 601000 1                  TNZ     s:9129
         1 004344   000001 236100                    LDQ     1,,PR0
         1 004345   777000 376003                    ANQ     -512,DU
         1 004346   006000 116003                    CMPQ    3072,DU
         1 004347   004371 600000 1                  TZE     s:9129

     1726     9120    4             DO;

     1727     9121    4             KQ$CG.IOTL$->KQ$DFRBLK.LNK$=DFR$;

   9121  1 004350   200003 471500                    LDP1    @KQ$CG,,AUTO
         1 004351   100247 473500                    LDP3    167,,PR1
         1 004352   200007 236100                    LDQ     DFR$,,AUTO
         1 004353   300000 756100                    STQ     0,,PR3
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:257  

     1728     9122    4             KQ$CG.IOTL$=DFR$;

   9122  1 004354   100247 756100                    STQ     167,,PR1

     1729     9123    4             KQ$DFRBLK.LNK$=ADDR(NIL);

   9123  1 004355   000001 236000 xsym               LDQ     B_VECTNIL+1
         1 004356   200007 470500                    LDP0    DFR$,,AUTO
         1 004357   000000 756100                    STQ     0,,PR0

     1730     9124                  %UNLOCK (G=KQ$CG.DTREE.GATE);

   9125  1 004360   200003 236100                    LDQ     @KQ$CG,,AUTO
         1 004361   000231 036003                    ADLQ    153,DU
         1 004362   200112 756100                    STQ     I$+1,,AUTO
         1 004363   200112 630500                    EPPR0   I$+1,,AUTO
         1 004364   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 004365   000000 701000 xent               TSX1    HFC$UNLOCK
         1 004366   000000 011000                    NOP     0

     1731     9127    4             RETURN;

   9127  1 004367   200066 221300                    LDX1  ! P$+1,,AUTO
         1 004370   000001 702211                    TSX2  ! 1,X1

     1732     9128    4             END;
     1733     9129    3           P$=P$->KQ$DFRBLK.LNK$;

   9129  1 004371   000000 236100                    LDQ     0,,PR0
         1 004372   200067 756100                    STQ     P$,,AUTO

     1734     9130    3           END;

   9130  1 004373   000001 116000 xsym               CMPQ    B_VECTNIL+1
         1 004374   004340 601000 1                  TNZ     s:9119

PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:258  
     1735     9131        /**/
     1736     9132    2         P$=KQ$CG.NEEDPGHD$;

   9132  1 004375   200003 470500                    LDP0    @KQ$CG,,AUTO
         1 004376   000250 236100                    LDQ     168,,PR0
         1 004377   200067 756100                    STQ     P$,,AUTO

     1737     9133    3           DO WHILE(P$~=ADDR(NIL));

   9133  1 004400   004431 710000 1                  TRA     s:9146

     1738     9134    3           IF DA=P$->KQ$DFRBLK.DA THEN

   9134  1 004401   200067 470500                    LDP0    P$,,AUTO
         1 004402   200015 236100                    LDQ     DA,,AUTO
         1 004403   000002 116100                    CMPQ    2,,PR0
         1 004404   004427 601000 1                  TNZ     s:9145

     1739     9135    4             DO;

     1740     9136    4             KQ$CG.NEEDPGTL$->KQ$DFRBLK.LNK$=DFR$;

   9136  1 004405   200003 471500                    LDP1    @KQ$CG,,AUTO
         1 004406   100251 473500                    LDP3    169,,PR1
         1 004407   200007 236100                    LDQ     DFR$,,AUTO
         1 004410   300000 756100                    STQ     0,,PR3

     1741     9137    4             KQ$CG.NEEDPGTL$=DFR$;

   9137  1 004411   100251 756100                    STQ     169,,PR1

     1742     9138    4             KQ$CG.NEEDPGCNT=KQ$CG.NEEDPGCNT+1;

   9138  1 004412   100252 054100                    AOS     170,,PR1

     1743     9139    4             KQ$DFRBLK.LNK$=ADDR(NIL);

PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:259  
   9139  1 004413   000001 236000 xsym               LDQ     B_VECTNIL+1
         1 004414   200007 470500                    LDP0    DFR$,,AUTO
         1 004415   000000 756100                    STQ     0,,PR0

     1744     9140                  %UNLOCK (G=KQ$CG.DTREE.GATE);

   9141  1 004416   200003 236100                    LDQ     @KQ$CG,,AUTO
         1 004417   000231 036003                    ADLQ    153,DU
         1 004420   200112 756100                    STQ     I$+1,,AUTO
         1 004421   200112 630500                    EPPR0   I$+1,,AUTO
         1 004422   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 004423   000000 701000 xent               TSX1    HFC$UNLOCK
         1 004424   000000 011000                    NOP     0

     1745     9143    4             RETURN;

   9143  1 004425   200066 221300                    LDX1  ! P$+1,,AUTO
         1 004426   000001 702211                    TSX2  ! 1,X1

     1746     9144    4             END;
     1747     9145    3           P$=P$->KQ$DFRBLK.LNK$;

   9145  1 004427   000000 236100                    LDQ     0,,PR0
         1 004430   200067 756100                    STQ     P$,,AUTO

     1748     9146    3           END;

   9146  1 004431   000001 116000 xsym               CMPQ    B_VECTNIL+1
         1 004432   004401 601000 1                  TNZ     s:9134

     1749     9147        /**/
     1750     9148    2         P$=KQ$CG.IOQHD$;

   9148  1 004433   200003 470500                    LDP0    @KQ$CG,,AUTO
         1 004434   000261 236100                    LDQ     177,,PR0
         1 004435   200067 756100                    STQ     P$,,AUTO

PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:260  
     1751     9149    3           DO WHILE(P$~=ADDR(NIL));

   9149  1 004436   004472 710000 1                  TRA     s:9161

     1752     9150    3           IF DA=P$->KQ$DFRBLK.DA AND P$->KQ$DFRBLK.CODE~=%KQDC_WRITE THEN

   9150  1 004437   200067 470500                    LDP0    P$,,AUTO
         1 004440   200015 236100                    LDQ     DA,,AUTO
         1 004441   000002 116100                    CMPQ    2,,PR0
         1 004442   004470 601000 1                  TNZ     s:9160
         1 004443   000001 236100                    LDQ     1,,PR0
         1 004444   777000 376003                    ANQ     -512,DU
         1 004445   006000 116003                    CMPQ    3072,DU
         1 004446   004470 600000 1                  TZE     s:9160

     1753     9151    4             DO;

     1754     9152    4             KQ$CG.IOQTL$->KQ$DFRBLK.LNK$=DFR$;

   9152  1 004447   200003 471500                    LDP1    @KQ$CG,,AUTO
         1 004450   100262 473500                    LDP3    178,,PR1
         1 004451   200007 236100                    LDQ     DFR$,,AUTO
         1 004452   300000 756100                    STQ     0,,PR3

     1755     9153    4             KQ$CG.IOQTL$=DFR$;

   9153  1 004453   100262 756100                    STQ     178,,PR1

     1756     9154    4             KQ$DFRBLK.LNK$=ADDR(NIL);

   9154  1 004454   000001 236000 xsym               LDQ     B_VECTNIL+1
         1 004455   200007 470500                    LDP0    DFR$,,AUTO
         1 004456   000000 756100                    STQ     0,,PR0

     1757     9155                  %UNLOCK (G=KQ$CG.DTREE.GATE);

   9156  1 004457   200003 236100                    LDQ     @KQ$CG,,AUTO
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:261  
         1 004460   000231 036003                    ADLQ    153,DU
         1 004461   200112 756100                    STQ     I$+1,,AUTO
         1 004462   200112 630500                    EPPR0   I$+1,,AUTO
         1 004463   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 004464   000000 701000 xent               TSX1    HFC$UNLOCK
         1 004465   000000 011000                    NOP     0

     1758     9158    4             RETURN;

   9158  1 004466   200066 221300                    LDX1  ! P$+1,,AUTO
         1 004467   000001 702211                    TSX2  ! 1,X1

     1759     9159    4             END;
     1760     9160    3           P$=P$->KQ$DFRBLK.LNK$;

   9160  1 004470   000000 236100                    LDQ     0,,PR0
         1 004471   200067 756100                    STQ     P$,,AUTO

     1761     9161    3           END;

   9161  1 004472   000001 116000 xsym               CMPQ    B_VECTNIL+1
         1 004473   004437 601000 1                  TNZ     s:9150

     1762     9162        /**/
     1763     9163        /* This granule is not already being read.  Get a page and
     1764     9164           read it in.  */
     1765     9165        /**/
     1766     9166    2         CALL GETPAGE ALTRET(PGALT);

   9166  1 004474   005302 701000 1                  TSX1    GETPAGE
         1 004475   004726 702000 1                  TSX2    PGALT

     1767     9167        /**/
     1768     9168    2         KQ$DFRBLK.LNK$=ADDR(NIL);

   9168  1 004476   000001 236000 xsym               LDQ     B_VECTNIL+1
         1 004477   200007 470500                    LDP0    DFR$,,AUTO
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:262  
         1 004500   000000 756100                    STQ     0,,PR0

     1769     9169    2         IF KQ$CG.IOTL$=ADDR(NIL) THEN

   9169  1 004501   200003 471500                    LDP1    @KQ$CG,,AUTO
         1 004502   100247 236100                    LDQ     167,,PR1
         1 004503   000001 116000 xsym               CMPQ    B_VECTNIL+1
         1 004504   004510 601000 1                  TNZ     s:9172

     1770     9170    2           KQ$CG.IOHD$=DFR$;

   9170  1 004505   200007 236100                    LDQ     DFR$,,AUTO
         1 004506   100246 756100                    STQ     166,,PR1
         1 004507   004513 710000 1                  TRA     s:9173

     1771     9171    2         ELSE
     1772     9172    2           KQ$CG.IOTL$->KQ$DFRBLK.LNK$=DFR$;

   9172  1 004510   100247 473500                    LDP3    167,,PR1
         1 004511   200007 236100                    LDQ     DFR$,,AUTO
         1 004512   300000 756100                    STQ     0,,PR3

     1773     9173    2         KQ$CG.IOTL$=DFR$;

   9173  1 004513   100247 756100                    STQ     167,,PR1

     1774     9174        /**/
     1775     9175              %UNLOCK (G=KQ$CG.DTREE.GATE);

   9176  1 004514   200003 236100                    LDQ     @KQ$CG,,AUTO
         1 004515   000231 036003                    ADLQ    153,DU
         1 004516   200112 756100                    STQ     I$+1,,AUTO
         1 004517   200112 630500                    EPPR0   I$+1,,AUTO
         1 004520   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 004521   000000 701000 xent               TSX1    HFC$UNLOCK
         1 004522   000000 011000                    NOP     0
         1 004523   004525 710000 1                  TRA     s:9182
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:263  

     1776     9178        /**/
     1777     9179
     1778     9180    2   READGRAN5: ENTRY;

   9180  1 004524   200066 741300       READGRAN5    STX1  ! P$+1,,AUTO

     1779     9181
     1780     9182    2         KQ$DFRBLK.DGRAN$=DGRAN$;

   9182  1 004525   200011 236100                    LDQ     DGRAN$,,AUTO
         1 004526   200007 470500                    LDP0    DFR$,,AUTO
         1 004527   000007 756100                    STQ     7,,PR0

     1781     9183    2         CALL NIQ$GETNR(Q$) ALTRET(NOQENTS);

   9183  1 004530   200070 631500                    EPPR1   Q$,,AUTO
         1 004531   200112 451500                    STP1    I$+1,,AUTO
         1 004532   200112 630500                    EPPR0   I$+1,,AUTO
         1 004533   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 004534   000000 701000 xent               TSX1    NIQ$GETNR
         1 004535   004760 702000 1                  TSX2    NOQENTS

   9182  1 004536                       READGRAN8    null
     1782     9184    2   READGRAN8: ;
     1783     9185    3         IF KQ_LOG.DCIO THEN DO;

   9185  1 004536   000000 236000 xsym               LDQ     KQ_LOG
         1 004537   010000 316003                    CANQ    4096,DU
         1 004540   004567 600000 1                  TZE     s:9192

     1784     9186    3           LDFR$=DFR$; LDGRAN$=DGRAN$;

   9186  1 004541   200007 236100                    LDQ     DFR$,,AUTO
         1 004542   200046 756100                    STQ     LDFR$,,AUTO

   9186  1 004543   200011 236100                    LDQ     DGRAN$,,AUTO
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:264  
         1 004544   200050 756100                    STQ     LDGRAN$,,AUTO

     1785     9187    3           CALL KQZ$LOG(KQ$CG,%KQLOG_DCREAD,,,LDFR$,DA,LDGRAN$)

   9187  1 004545   200050 630500                    EPPR0   LDGRAN$,,AUTO
         1 004546   200120 450500                    STP0    I$+7,,AUTO
         1 004547   200015 631500                    EPPR1   DA,,AUTO
         1 004550   200117 451500                    STP1    I$+6,,AUTO
         1 004551   200046 633500                    EPPR3   LDFR$,,AUTO
         1 004552   200116 453500                    STP3    I$+5,,AUTO
         1 004553   000001 236000 xsym               LDQ     B_VECTNIL+1
         1 004554   000001 235000 xsym               LDA     B_VECTNIL+1
         1 004555   200114 757100                    STAQ    I$+3,,AUTO
         1 004556   000034 236000 2                  LDQ     28
         1 004557   200003 235100                    LDA     @KQ$CG,,AUTO
         1 004560   200112 757100                    STAQ    I$+1,,AUTO
         1 004561   200112 630500                    EPPR0   I$+1,,AUTO
         1 004562   000025 631400 xsym               EPPR1   B_VECTNIL+21
         1 004563   000000 701000 xent               TSX1    KQZ$LOG
         1 004564   004567 702000 1                  TSX2    s:9192

     1786     9188    3           ALTRET(LOG1);
     1787     9189    3           RETURN;  /* Never comes here */

   9189  1 004565   200066 221300                    LDX1  ! P$+1,,AUTO
         1 004566   000001 702211                    TSX2  ! 1,X1

     1788     9190    3   LOG1:   END;
     1789     9191        /**/
     1790     9192    2         IF KQ$DGRAN.BTN.KEY~=' ' THEN

   9192  1 004567   200011 470500                    LDP0    DGRAN$,,AUTO
         1 004570   040000 106500                    CMPC    fill='040'O
         1 004571   000011 000010                    ADSC9   9,,PR0                   cn=0,n=8
         1 004572   000035 000001 xsym               ADSC9   B_VECTNIL+29             cn=0,n=1
         1 004573   004576 600000 1                  TZE     s:9195

PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:265  
     1791     9193    2           CALL SC_CGCACHESCR;  /* This is not an initialized page */

   9193  1 004574   000000 713400 xsym               CLIMB   SC_CGCACHESCR
         1 004575   000000 600000 xsid               climb   nvectors=         0

     1792     9194              %LOCK (G=KQ$CG.GATE.CG);

   9195  1 004576   200003 236100                    LDQ     @KQ$CG,,AUTO
         1 004577   000107 036003                    ADLQ    71,DU
         1 004600   200112 756100                    STQ     I$+1,,AUTO
         1 004601   200112 630500                    EPPR0   I$+1,,AUTO
         1 004602   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 004603   000000 701000 xent               TSX1    HFC$LOCK
         1 004604   000000 011000                    NOP     0

     1793     9197    2         KQ$CG.IOCNT=KQ$CG.IOCNT+1;

   9197  1 004605   200003 470500                    LDP0    @KQ$CG,,AUTO
         1 004606   000225 720100                    LXL0    149,,PR0
         1 004607   000001 621010                    EAX1    1,X0
         1 004610   000225 441100                    SXL1    149,,PR0

     1794     9198              %UNLOCK (G=KQ$CG.GATE.CG);

   9199  1 004611   200003 236100                    LDQ     @KQ$CG,,AUTO
         1 004612   000107 036003                    ADLQ    71,DU
         1 004613   200112 756100                    STQ     I$+1,,AUTO
         1 004614   200112 630500                    EPPR0   I$+1,,AUTO
         1 004615   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 004616   000000 701000 xent               TSX1    HFC$UNLOCK
         1 004617   000000 011000                    NOP     0

     1795     9201    2         N$REQ.BUF$=DGRAN$;

   9201  1 004620   200011 236100                    LDQ     DGRAN$,,AUTO
         1 004621   200070 470500                    LDP0    Q$,,AUTO
         1 004622   000005 756100                    STQ     5,,PR0
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:266  

     1796     9202    2         N$REQ.OPFLG=OP_BPF|OP_EA;

   9202  1 004623   200070 470500                    LDP0    Q$,,AUTO
         1 004624   000050 236007                    LDQ     40,DL
         1 004625   000004 552104                    STBQ    4,'04'O,PR0

     1797     9203    2         P$=KQ$CG.CFU$;

   9203  1 004626   200003 470500                    LDP0    @KQ$CG,,AUTO
         1 004627   000214 236100                    LDQ     140,,PR0
         1 004630   200067 756100                    STQ     P$,,AUTO

     1798     9204    2         N$REQ.BUFSIZE=1024*4;

   9204  1 004631   200070 471500                    LDP1    Q$,,AUTO
         1 004632   100004 236100                    LDQ     4,,PR1
         1 004633   177777 376007                    ANQ     65535,DL
         1 004634   002000 276003                    ORQ     1024,DU
         1 004635   100004 756100                    STQ     4,,PR1

     1799     9205    2         N$REQ.FC=%N_RDBIN;

   9205  1 004636   200070 471500                    LDP1    Q$,,AUTO
         1 004637   000002 236007                    LDQ     2,DL
         1 004640   100003 552104                    STBQ    3,'04'O,PR1

     1800     9206    2         N$REQ.EAENTRY=ENTADDR(KQE$RDEA);

   9206  1 004641   000000 636000 xent               EAQ     KQE$RDEA
         1 004642   200070 471500                    LDP1    Q$,,AUTO
         1 004643   100023 756100                    STQ     19,,PR1

     1801     9207    2         N$REQ.EAINFOP$=DFR$;

   9207  1 004644   200007 236100                    LDQ     DFR$,,AUTO
         1 004645   200070 471500                    LDP1    Q$,,AUTO
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:267  
         1 004646   100024 756100                    STQ     20,,PR1

     1802     9208    2         N$REQ.EAINFOXP$=ADDR(KQ$CG);

   9208  1 004647   200003 236100                    LDQ     @KQ$CG,,AUTO
         1 004650   200070 471500                    LDP1    Q$,,AUTO
         1 004651   100025 756100                    STQ     21,,PR1

     1803     9209    2         CALL FAF$FRTOSRNJ(DA,N$REQ.DLA,P$) ALTRET(ERR);

   9209  1 004652   200067 631500                    EPPR1   P$,,AUTO
         1 004653   200114 451500                    STP1    I$+3,,AUTO
         1 004654   200070 236100                    LDQ     Q$,,AUTO
         1 004655   000001 036003                    ADLQ    1,DU
         1 004656   200113 756100                    STQ     I$+2,,AUTO
         1 004657   200015 633500                    EPPR3   DA,,AUTO
         1 004660   200112 453500                    STP3    I$+1,,AUTO
         1 004661   200112 630500                    EPPR0   I$+1,,AUTO
         1 004662   000021 631400 xsym               EPPR1   B_VECTNIL+17
         1 004663   000000 701000 xent               TSX1    FAF$FRTOSRNJ
         1 004664   005061 702000 1                  TSX2    ERR

     1804     9210    2         CALL FAF$SRTODR(N$REQ.DLA,KQ$CG.SETX) ALTRET(ERR);

   9210  1 004665   200003 236100                    LDQ     @KQ$CG,,AUTO
         1 004666   000216 036003                    ADLQ    142,DU
         1 004667   200113 756100                    STQ     I$+2,,AUTO
         1 004670   200070 236100                    LDQ     Q$,,AUTO
         1 004671   000001 036003                    ADLQ    1,DU
         1 004672   200112 756100                    STQ     I$+1,,AUTO
         1 004673   200112 630500                    EPPR0   I$+1,,AUTO
         1 004674   000020 631400 xsym               EPPR1   B_VECTNIL+16
         1 004675   000000 701000 xent               TSX1    FAF$SRTODR
         1 004676   005061 702000 1                  TSX2    ERR

     1805     9211    2         DGRAN$->WRD(0)=BITBIN('112233445566'O);

PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:268  
   9211  1 004677   200011 470500                    LDP0    DGRAN$,,AUTO
         1 004700   000057 235000 0                  LDA     KQD_MINSPLIT+1
         1 004701   000000 755100                    STA     0,,PR0

     1806     9212    2         IF N$REQ.IOFLG.IOS ~= '1'B THEN

   9212  1 004702   200070 471500                    LDP1    Q$,,AUTO
         1 004703   100004 236100                    LDQ     4,,PR1
         1 004704   040000 316007                    CANQ    16384,DL
         1 004705   004720 601000 1                  TNZ     s:9217

     1807     9213    3           DO;

     1808     9214    3           CALL NIQ$GETSNR(N$REQ.IOS$) ALTRET(NOSENTS);

   9214  1 004706   200070 236100                    LDQ     Q$,,AUTO
         1 004707   000012 036003                    ADLQ    10,DU
         1 004710   200112 756100                    STQ     I$+1,,AUTO
         1 004711   200112 630500                    EPPR0   I$+1,,AUTO
         1 004712   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 004713   000000 701000 xent               TSX1    NIQ$GETSNR
         1 004714   004730 702000 1                  TSX2    NOSENTS

     1809     9215    3           N$REQ.IOFLG.IOS='1'B;

   9215  1 004715   200070 470500                    LDP0    Q$,,AUTO
         1 004716   040000 236007                    LDQ     16384,DL
         1 004717   000004 256100                    ORSQ    4,,PR0

     1810     9216    3           END;

     1811     9217    2         CALL NIO$QUE(N$REQ) ALTRET(NOSENTS);

   9217  1 004720   200070 630500                    EPPR0   Q$,,AUTO
         1 004721   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 004722   000000 701000 xent               TSX1    NIO$QUE
         1 004723   004730 702000 1                  TSX2    NOSENTS
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:269  

     1812     9218    2         KQ$CG.STATS.DISCRDS=KQ$CG.STATS.DISCRDS+1;

   9218  1 004724   200003 470500                    LDP0    @KQ$CG,,AUTO
         1 004725   000175 054100                    AOS     125,,PR0

   9218  1 004726                       PGALT        null
     1813     9219        /**/
     1814     9220    2   PGALT: ;
     1815     9221    2         RETURN;

   9221  1 004726   200066 221300                    LDX1  ! P$+1,,AUTO
         1 004727   000001 702211                    TSX2  ! 1,X1

   9218  1 004730                       NOSENTS      null
     1816     9222        /**/
     1817     9223    2   NOSENTS: ;  /* NIO$QUE ALTRETURNed saying no IOS packets. Put this guy on    */
     1818     9224                    /* the IOQHD$ list to try again later                            */
     1819     9225              %LOCK (G=KQ$CG.GATE.CG);

   9226  1 004730   200003 236100                    LDQ     @KQ$CG,,AUTO
         1 004731   000107 036003                    ADLQ    71,DU
         1 004732   200112 756100                    STQ     I$+1,,AUTO
         1 004733   200112 630500                    EPPR0   I$+1,,AUTO
         1 004734   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 004735   000000 701000 xent               TSX1    HFC$LOCK
         1 004736   000000 011000                    NOP     0

     1820     9228    2         KQ$CG.IOCNT=KQ$CG.IOCNT-1;

   9228  1 004737   200003 470500                    LDP0    @KQ$CG,,AUTO
         1 004740   000225 720100                    LXL0    149,,PR0
         1 004741   777777 621010                    EAX1    -1,X0
         1 004742   000225 441100                    SXL1    149,,PR0

     1821     9229              %UNLOCK (G=KQ$CG.GATE.CG);

PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:270  
   9230  1 004743   200003 236100                    LDQ     @KQ$CG,,AUTO
         1 004744   000107 036003                    ADLQ    71,DU
         1 004745   200112 756100                    STQ     I$+1,,AUTO
         1 004746   200112 630500                    EPPR0   I$+1,,AUTO
         1 004747   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 004750   000000 701000 xent               TSX1    HFC$UNLOCK
         1 004751   000000 011000                    NOP     0

     1822     9232    2         CALL NIQ$REL(Q$);

   9232  1 004752   200070 630500                    EPPR0   Q$,,AUTO
         1 004753   200112 450500                    STP0    I$+1,,AUTO
         1 004754   200112 630500                    EPPR0   I$+1,,AUTO
         1 004755   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 004756   000000 701000 xent               TSX1    NIQ$REL
         1 004757   000000 011000                    NOP     0

   9228  1 004760                       NOQENTS      null
     1823     9233        /**/
     1824     9234    2   NOQENTS: ;
     1825     9235              %LOCK (G=KQ$CG.DTREE.GATE);

   9236  1 004760   200003 236100                    LDQ     @KQ$CG,,AUTO
         1 004761   000231 036003                    ADLQ    153,DU
         1 004762   200112 756100                    STQ     I$+1,,AUTO
         1 004763   200112 630500                    EPPR0   I$+1,,AUTO
         1 004764   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 004765   000000 701000 xent               TSX1    HFC$LOCK
         1 004766   000000 011000                    NOP     0

     1826     9238    2         T$=ADDR(NIL);

   9238  1 004767   000001 236000 xsym               LDQ     B_VECTNIL+1
         1 004770   200040 756100                    STQ     T$,,AUTO

     1827     9239    2         P$=KQ$CG.IOHD$;

PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:271  
   9239  1 004771   200003 470500                    LDP0    @KQ$CG,,AUTO
         1 004772   000246 236100                    LDQ     166,,PR0
         1 004773   200067 756100                    STQ     P$,,AUTO

     1828     9240    3           DO WHILE(P$~=ADDR(NIL));

   9240  1 004774   005053 710000 1                  TRA     s:9265

     1829     9241    3           IF P$=DFR$ THEN

   9241  1 004775   200067 236100                    LDQ     P$,,AUTO
         1 004776   200007 116100                    CMPQ    DFR$,,AUTO
         1 004777   005047 601000 1                  TNZ     s:9262

     1830     9242    4             DO;

     1831     9243    4             IF T$=ADDR(NIL) THEN

   9243  1 005000   200040 236100                    LDQ     T$,,AUTO
         1 005001   000001 116000 xsym               CMPQ    B_VECTNIL+1
         1 005002   005010 601000 1                  TNZ     s:9246

     1832     9244    4               KQ$CG.IOHD$=KQ$DFRBLK.LNK$;

   9244  1 005003   200007 470500                    LDP0    DFR$,,AUTO
         1 005004   000000 236100                    LDQ     0,,PR0
         1 005005   200003 471500                    LDP1    @KQ$CG,,AUTO
         1 005006   100246 756100                    STQ     166,,PR1
         1 005007   005014 710000 1                  TRA     s:9247

     1833     9245    4             ELSE
     1834     9246    4               T$->KQ$DFRBLK.LNK$=KQ$DFRBLK.LNK$;

   9246  1 005010   200007 470500                    LDP0    DFR$,,AUTO
         1 005011   000000 236100                    LDQ     0,,PR0
         1 005012   200040 471500                    LDP1    T$,,AUTO
         1 005013   100000 756100                    STQ     0,,PR1
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:272  

     1835     9247    4             IF KQ$CG.IOTL$=DFR$ THEN

   9247  1 005014   200003 471500                    LDP1    @KQ$CG,,AUTO
         1 005015   100247 236100                    LDQ     167,,PR1
         1 005016   200007 116100                    CMPQ    DFR$,,AUTO
         1 005017   005022 601000 1                  TNZ     s:9249

     1836     9248    4               KQ$CG.IOTL$=T$;

   9248  1 005020   200040 236100                    LDQ     T$,,AUTO
         1 005021   100247 756100                    STQ     167,,PR1

     1837     9249    4             IF KQ$CG.IOQHD$=ADDR(NIL) THEN

   9249  1 005022   100261 236100                    LDQ     177,,PR1
         1 005023   000001 116000 xsym               CMPQ    B_VECTNIL+1
         1 005024   005030 601000 1                  TNZ     s:9252

     1838     9250    4               KQ$CG.IOQHD$=DFR$;

   9250  1 005025   200007 236100                    LDQ     DFR$,,AUTO
         1 005026   100261 756100                    STQ     177,,PR1
         1 005027   005033 710000 1                  TRA     s:9253

     1839     9251    4             ELSE
     1840     9252    4               KQ$CG.IOQTL$->KQ$DFRBLK.LNK$=DFR$;

   9252  1 005030   100262 473500                    LDP3    178,,PR1
         1 005031   200007 236100                    LDQ     DFR$,,AUTO
         1 005032   300000 756100                    STQ     0,,PR3

     1841     9253    4             KQ$CG.IOQTL$=DFR$;

   9253  1 005033   100262 756100                    STQ     178,,PR1

     1842     9254    4             KQ$DFRBLK.LNK$=ADDR(NIL);
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:273  

   9254  1 005034   000001 236000 xsym               LDQ     B_VECTNIL+1
         1 005035   000000 756100                    STQ     0,,PR0

     1843     9255                  %UNLOCK (G=KQ$CG.DTREE.GATE);

   9256  1 005036   200003 236100                    LDQ     @KQ$CG,,AUTO
         1 005037   000231 036003                    ADLQ    153,DU
         1 005040   200112 756100                    STQ     I$+1,,AUTO
         1 005041   200112 630500                    EPPR0   I$+1,,AUTO
         1 005042   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 005043   000000 701000 xent               TSX1    HFC$UNLOCK
         1 005044   000000 011000                    NOP     0

     1844     9258    4             RETURN;

   9258  1 005045   200066 221300                    LDX1  ! P$+1,,AUTO
         1 005046   000001 702211                    TSX2  ! 1,X1

     1845     9259    4             END;
     1846     9260    3           ELSE
     1847     9261    4             DO;

     1848     9262    4             T$=P$;

   9262  1 005047   200040 756100                    STQ     T$,,AUTO

     1849     9263    4             P$=P$->KQ$DFRBLK.LNK$;

   9263  1 005050   200067 470500                    LDP0    P$,,AUTO
         1 005051   000000 236100                    LDQ     0,,PR0
         1 005052   200067 756100                    STQ     P$,,AUTO

     1850     9264    4             END;

     1851     9265    3           END;

PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:274  
   9265  1 005053   000001 116000 xsym               CMPQ    B_VECTNIL+1
         1 005054   004775 601000 1                  TNZ     s:9241

     1852     9266    2         CALL SC_CGCACHESCR;

   9266  1 005055   000000 713400 xsym               CLIMB   SC_CGCACHESCR
         1 005056   000000 600000 xsid               climb   nvectors=         0

     1853     9267    2         RETURN;

   9267  1 005057   200066 221300                    LDX1  ! P$+1,,AUTO
         1 005060   000001 702211                    TSX2  ! 1,X1

   9256  1 005061                       ERR          null
     1854     9268        /**/
     1855     9269    2   ERR:  ;
     1856     9270    2         CALL SC_CGCACHE;

   9270  1 005061   000000 713400 xsym               CLIMB   SC_CGCACHE
         1 005062   000000 600000 xsid               climb   nvectors=         0

     1857     9271    2         KQ$DFRBLK.ERRCODE=%KQDE_BDDA;

   9271  1 005063   200007 470500                    LDP0    DFR$,,AUTO
         1 005064   000004 236003                    LDQ     4,DU
         1 005065   000001 552120                    STBQ    1,'20'O,PR0

     1858     9272    2         N$REQ.TYC='0'B;  /* Force RDEA to think I/O didn't work */

   9272  1 005066   200070 471500                    LDP1    Q$,,AUTO
         1 005067   100021 450100                    STZ     17,,PR1

     1859     9273    2         CALL KQE$RDEAERR(N$REQ);  /* Simulate interrupt */

   9273  1 005070   200070 630500                    EPPR0   Q$,,AUTO
         1 005071   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 005072   000000 701000 xent               TSX1    KQE$RDEAERR
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:275  
         1 005073   000000 011000                    NOP     0

     1860     9274    2         CALL NIQ$REL(Q$);

   9274  1 005074   200070 630500                    EPPR0   Q$,,AUTO
         1 005075   200112 450500                    STP0    I$+1,,AUTO
         1 005076   200112 630500                    EPPR0   I$+1,,AUTO
         1 005077   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 005100   000000 701000 xent               TSX1    NIQ$REL
         1 005101   000000 011000                    NOP     0

     1861     9275    2         RETURN;

   9275  1 005102   200066 221300                    LDX1  ! P$+1,,AUTO
         1 005103   000001 702211                    TSX2  ! 1,X1

     1862     9276        /**/
     1863     9277        /**/
     1864     9278    2   READGRANSTRTIO: ENTRY;

   9278  1 005104   200066 741300       READGRANSTR* STX1  ! P$+1,,AUTO

     1865     9279        /**/
     1866     9280    2         DFR$=PDBLK$;

   9280  1 005105   200004 470500                    LDP0    @PDBLK$,,AUTO
         1 005106   000000 236100                    LDQ     0,,PR0
         1 005107   200007 756100                    STQ     DFR$,,AUTO

     1867     9281    2         Q$=PSTA$;

   9281  1 005110   200005 471500                    LDP1    @PDDA,,AUTO
         1 005111   100000 236100                    LDQ     0,,PR1
         1 005112   200070 756100                    STQ     Q$,,AUTO

     1868     9282    2         DGRAN$=KQ$DFRBLK.DGRAN$;

PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:276  
   9282  1 005113   200007 473500                    LDP3    DFR$,,AUTO
         1 005114   300007 236100                    LDQ     7,,PR3
         1 005115   200011 756100                    STQ     DGRAN$,,AUTO

     1869     9283    2         DA=KQ$DFRBLK.DA;

   9283  1 005116   300002 235100                    LDA     2,,PR3
         1 005117   200015 755100                    STA     DA,,AUTO

     1870     9284    2         GOTO READGRAN8;

   9284  1 005120   004536 710000 1                  TRA     READGRAN8

     1871     9285        /**/
     1872     9286    2   END READGRAN;
     1873     9287        %EJECT;
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:277  
     1874     9288        /*F* NAME:            KQD$STARTIO
     1875     9289
     1876     9290             CALL:            CALL KQD$STARTIO(KQ$CG,DFR$,Q$);
     1877     9291
     1878     9292             INPUT:           KQ$CG - Context block
     1879     9293                              DFR$ - Defer block to start read for
     1880     9294                              Q$ - IOQ packet to use
     1881     9295
     1882     9296             DESCRIPTION:     A read is started for the indicated defer block.
     1883     9297
     1884     9298        */
     1885     9299
     1886     9300
     1887     9301
     1888     9302    1   KQD$STARTIO: ENTRY(KQ$CG,PDBLK$,PDDA) ALTRET;

   9302  1 005121   000000 700200 xent  KQD$STARTIO  TSX0  ! X66_AUTO_3
         1 005122   000122 000003                    ZERO    82,3

     1889     9303
     1890     9304    1         CALL READGRANSTRTIO;

   9304  1 005123   005104 701000 1                  TSX1    READGRANSTRTIO
         1 005124   000000 011000                    NOP     0

     1891     9305    1         RETURN;

   9305  1 005125   000000 702200 xent               TSX2  ! X66_ARET

     1892     9306        %EJECT;
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:278  
     1893     9307
     1894     9308
     1895     9309        /*D* NAME:         WRITEGRAN
     1896     9310
     1897     9311             CALL:         CALL WRITEGRAN(GRAN$,DA,DFR$,Q$);
     1898     9312
     1899     9313             INPUT:        GRAN$ - Ptr to page
     1900     9314                           DA - Disk address
     1901     9315                           DFR$ - Ptr to defer block for this write
     1902     9316                           Q$ - Ptr to a queue packet
     1903     9317
     1904     9318             DESCRIPTION:  Writes the page to the specified disk address.
     1905     9319                           Must be called with page removed from all
     1906     9320                           appropriate core chains.
     1907     9321
     1908     9322        */
     1909     9323
     1910     9324
     1911     9325    1   WRITEGRAN: PROC(DGRAN$,DA,DFR$,Q$) ALTRET;

   9325  1 005126   200104 741300       WRITEGRAN    STX1  ! @FREE,,AUTO

     1912     9326
     1913     9327
     1914     9328        /**/
     1915     9329        /* PARAMETERS */
     1916     9330        /**/
     1917     9331    2   DCL DGRAN$ PTR;
     1918     9332    2   DCL DA UBIN;
     1919     9333    2   DCL DFR$ PTR;
     1920     9334    2   DCL Q$ PTR;
     1921     9335        /**/
     1922     9336        /* BASED STRUCTURES */
     1923     9337        /**/
     1924     9338        %N$REQ (STCLASS="BASED(Q$)");
     1925     9396
     1926     9397        /**/
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:279  
     1927     9398        /* LOCAL AUTO */
     1928     9399        /**/
     1929     9400    2   DCL I$ PTR;
     1930     9401
     1931     9402
     1932     9403            %LOCK (G=KQ$CG.GATE.CG);

   9404  1 005127   200003 236100                    LDQ     @KQ$CG,,AUTO
         1 005130   000107 036003                    ADLQ    71,DU
         1 005131   200112 756100                    STQ     I$+1,,AUTO
         1 005132   200112 630500                    EPPR0   I$+1,,AUTO
         1 005133   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 005134   000000 701000 xent               TSX1    HFC$LOCK
         1 005135   000000 011000                    NOP     0

     1933     9406    2         KQ$CG.IOCNT=KQ$CG.IOCNT+1;

   9406  1 005136   200003 470500                    LDP0    @KQ$CG,,AUTO
         1 005137   000225 720100                    LXL0    149,,PR0
         1 005140   000001 621010                    EAX1    1,X0
         1 005141   000225 441100                    SXL1    149,,PR0

     1934     9407              %UNLOCK (G=KQ$CG.GATE.CG);

   9408  1 005142   200003 236100                    LDQ     @KQ$CG,,AUTO
         1 005143   000107 036003                    ADLQ    71,DU
         1 005144   200112 756100                    STQ     I$+1,,AUTO
         1 005145   200112 630500                    EPPR0   I$+1,,AUTO
         1 005146   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 005147   000000 701000 xent               TSX1    HFC$UNLOCK
         1 005150   000000 011000                    NOP     0

     1935     9410        /**/
     1936     9411    2         CALL SSS$SYSTIME(KQ$DGRAN.HDR.WRITEUTS);

   9411  1 005151   200011 236100                    LDQ     DGRAN$,,AUTO
         1 005152   000003 036003                    ADLQ    3,DU
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:280  
         1 005153   200112 756100                    STQ     I$+1,,AUTO
         1 005154   200112 630500                    EPPR0   I$+1,,AUTO
         1 005155   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 005156   000000 701000 xent               TSX1    SSS$SYSTIME
         1 005157   000000 011000                    NOP     0

     1937     9412        /**/
     1938     9413    2         N$REQ.BUF$=DGRAN$;

   9413  1 005160   200110 470500                    LDP0    @Q$,,AUTO
         1 005161   000000 471500                    LDP1    0,,PR0
         1 005162   200105 473500                    LDP3    @DGRAN$,,AUTO
         1 005163   300000 236100                    LDQ     0,,PR3
         1 005164   100005 756100                    STQ     5,,PR1

     1939     9414    2         N$REQ.OPFLG=OP_BPF|OP_EA;

   9414  1 005165   000000 471500                    LDP1    0,,PR0
         1 005166   000050 236007                    LDQ     40,DL
         1 005167   100004 552104                    STBQ    4,'04'O,PR1

     1940     9415    2         N$REQ.BUFSIZE=1024*4;

   9415  1 005170   000000 471500                    LDP1    0,,PR0
         1 005171   100004 236100                    LDQ     4,,PR1
         1 005172   177777 376007                    ANQ     65535,DL
         1 005173   002000 276003                    ORQ     1024,DU
         1 005174   100004 756100                    STQ     4,,PR1

     1941     9416    2         N$REQ.NOALT = '1'B;

   9416  1 005175   000000 471500                    LDP1    0,,PR0
         1 005176   100000 236007                    LDQ     32768,DL
         1 005177   100004 256100                    ORSQ    4,,PR1

     1942     9417    2         I$=KQ$CG.CFU$;

PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:281  
   9417  1 005200   200003 471500                    LDP1    @KQ$CG,,AUTO
         1 005201   100214 236100                    LDQ     140,,PR1
         1 005202   200111 756100                    STQ     I$,,AUTO

     1943     9418    2         CALL FAF$FRTOSRNJ(DA,N$REQ.DLA,I$) ALTRET(ERR);

   9418  1 005203   000000 474500                    LDP4    0,,PR0
         1 005204   200111 635500                    EPPR5   I$,,AUTO
         1 005205   200114 455500                    STP5    I$+3,,AUTO
         1 005206   400001 636500                    EPPR6   1,,PR4
         1 005207   200113 456500                    STP6    I$+2,,AUTO
         1 005210   200106 236100                    LDQ     @DA,,AUTO
         1 005211   200112 756100                    STQ     I$+1,,AUTO
         1 005212   200112 630500                    EPPR0   I$+1,,AUTO
         1 005213   000021 631400 xsym               EPPR1   B_VECTNIL+17
         1 005214   000000 701000 xent               TSX1    FAF$FRTOSRNJ
         1 005215   005277 702000 1                  TSX2    ERR

     1944     9419    2         CALL FAF$SRTODR(N$REQ.DLA,KQ$CG.SETX) ALTRET(ERR);

   9419  1 005216   200110 470500                    LDP0    @Q$,,AUTO
         1 005217   000000 471500                    LDP1    0,,PR0
         1 005220   200003 236100                    LDQ     @KQ$CG,,AUTO
         1 005221   000216 036003                    ADLQ    142,DU
         1 005222   200113 756100                    STQ     I$+2,,AUTO
         1 005223   100001 633500                    EPPR3   1,,PR1
         1 005224   200112 453500                    STP3    I$+1,,AUTO
         1 005225   200112 630500                    EPPR0   I$+1,,AUTO
         1 005226   000020 631400 xsym               EPPR1   B_VECTNIL+16
         1 005227   000000 701000 xent               TSX1    FAF$SRTODR
         1 005230   005277 702000 1                  TSX2    ERR

     1945     9420    2         IF FM_WRCMP=0 THEN

   9420  1 005231   000000 235000 xsym               LDA     FM_WRCMP
         1 005232   005240 601000 1                  TNZ     s:9423

PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:282  
     1946     9421    2           N$REQ.FC=%N_WRBIN;

   9421  1 005233   200110 470500                    LDP0    @Q$,,AUTO
         1 005234   000000 471500                    LDP1    0,,PR0
         1 005235   000003 236007                    LDQ     3,DL
         1 005236   100003 552104                    STBQ    3,'04'O,PR1
         1 005237   005244 710000 1                  TRA     s:9424

     1947     9422    2         ELSE
     1948     9423    2           N$REQ.FC=%N_WRCMP;

   9423  1 005240   200110 470500                    LDP0    @Q$,,AUTO
         1 005241   000000 471500                    LDP1    0,,PR0
         1 005242   000007 236007                    LDQ     7,DL
         1 005243   100003 552104                    STBQ    3,'04'O,PR1

     1949     9424    2         N$REQ.EAENTRY=ENTADDR(KQE$WREA);

   9424  1 005244   000000 471500                    LDP1    0,,PR0
         1 005245   000000 636000 xent               EAQ     KQE$WREA
         1 005246   100023 756100                    STQ     19,,PR1

     1950     9425    2         N$REQ.EAINFOP$=DGRAN$;

   9425  1 005247   000000 471500                    LDP1    0,,PR0
         1 005250   200105 473500                    LDP3    @DGRAN$,,AUTO
         1 005251   300000 236100                    LDQ     0,,PR3
         1 005252   100024 756100                    STQ     20,,PR1

     1951     9426    2         N$REQ.EAINFOXP$=ADDR(KQ$CG);

   9426  1 005253   000000 471500                    LDP1    0,,PR0
         1 005254   200003 236100                    LDQ     @KQ$CG,,AUTO
         1 005255   100025 756100                    STQ     21,,PR1

     1952     9427    2         KQ$DGRAN.DFR$=DFR$;

PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:283  
   9427  1 005256   200107 471500                    LDP1    @DFR$,,AUTO
         1 005257   100000 236100                    LDQ     0,,PR1
         1 005260   200011 474500                    LDP4    DGRAN$,,AUTO
         1 005261   400025 756100                    STQ     21,,PR4

     1953     9428    3         CALL NIO$QUE(N$REQ) WHENALTRETURN DO; ALTRETURN; END;

   9428  1 005262   000000 475500                    LDP5    0,,PR0
         1 005263   200112 455500                    STP5    I$+1,,AUTO
         1 005264   200112 630500                    EPPR0   I$+1,,AUTO
         1 005265   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 005266   000000 701000 xent               TSX1    NIO$QUE
         1 005267   005271 702000 1                  TSX2    s:9428+7
         1 005270   005273 710000 1                  TRA     s:9429

   9428  1 005271   200104 221300                    LDX1  ! @FREE,,AUTO
         1 005272   000000 702211                    TSX2  ! 0,X1

     1954     9429    2         KQ$CG.STATS.DISCWRS=KQ$CG.STATS.DISCWRS+1;

   9429  1 005273   200003 470500                    LDP0    @KQ$CG,,AUTO
         1 005274   000176 054100                    AOS     126,,PR0

     1955     9430    2         RETURN;

   9430  1 005275   200104 221300                    LDX1  ! @FREE,,AUTO
         1 005276   000001 702211                    TSX2  ! 1,X1

   9429  1 005277                       ERR          null
     1956     9431        /**/
     1957     9432    2   ERR:  ;
     1958     9433    2         CALL SC_CGCACHESCR;

   9433  1 005277   000000 713400 xsym               CLIMB   SC_CGCACHESCR
         1 005300   000000 600000 xsid               climb   nvectors=         0

     1959     9434    2         GOTO ERR;
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:284  

   9434  1 005301   005277 710000 1                  TRA     ERR

     1960     9435        /**/
     1961     9436    2   END WRITEGRAN;
     1962     9437        %EJECT;
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:285  
     1963     9438
     1964     9439
     1965     9440        /*D* NAME:         GETPAGE
     1966     9441
     1967     9442             CALL:         CALL GETPAGE ALTRET(LOC);
     1968     9443
     1969     9444             INPUT:        DFR$ - Ptr to defer block
     1970     9445
     1971     9446             OUTPUT:       If normal return, DGRAN$ is pointer to page.
     1972     9447                           If ALTRET, ERRCODE contains the error code.  Zero
     1973     9448                           indicates that the get was deferred, in which case
     1974     9449                           DFR$ points to the defer block.
     1975     9450
     1976     9451             DESCRIPTION:  KQM$GETP is called to allocate a page.  If one
     1977     9452                           is not available, the disk cache is searched to
     1978     9453                           find one.  If it is necessary to write out a page,
     1979     9454                           the write is initiated.  If no pages can be found
     1980     9455                           to throw out, the defer block is added to the
     1981     9456                           list of operations needing a page.
     1982     9457
     1983     9458        */
     1984     9459
     1985     9460
     1986     9461    1   GETPAGE: PROC ALTRET;

   9461  1 005302   200072 741300       GETPAGE      STX1  ! BX,,AUTO

     1987     9462
     1988     9463
     1989     9464        /**/
     1990     9465        /* LOCAL AUTO */
     1991     9466        /**/
     1992     9467    2   DCL I SBIN;
     1993     9468    2   DCL P$ PTR;
     1994     9469
     1995     9470    2         IF KQ$CG.DATAFREE$~=ADDR(NIL) THEN

PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:286  
   9470  1 005303   200003 470500                    LDP0    @KQ$CG,,AUTO
         1 005304   000243 236100                    LDQ     163,,PR0
         1 005305   000001 116000 xsym               CMPQ    B_VECTNIL+1
         1 005306   005314 600000 1                  TZE     s:9477

     1996     9471    3           DO;

     1997     9472    3           DGRAN$=KQ$CG.DATAFREE$;

   9472  1 005307   200011 756100                    STQ     DGRAN$,,AUTO

     1998     9473    3           KQ$CG.DATAFREE$=KQ$DGRAN.FLINK$;

   9473  1 005310   200011 471500                    LDP1    DGRAN$,,AUTO
         1 005311   100017 236100                    LDQ     15,,PR1
         1 005312   000243 756100                    STQ     163,,PR0

     1999     9474    3           END;

   9474  1 005313   005337 710000 1                  TRA     BLDHDR

     2000     9475    2         ELSE
     2001     9476    3           DO;

     2002     9477    3           IF KQ$CG.CURDATAPGS>=KQ$CG.MAXDATAPGS THEN

   9477  1 005314   000241 720100                    LXL0    161,,PR0
         1 005315   000241 100100                    CMPX0   161,,PR0
         1 005316   005363 603000 1                  TRC     NOPAGE

     2003     9478    3             GOTO NOPAGE;
     2004     9479    3           CALL KQM$GETP(KQ$CG,LDGRAN$,I) ALTRET(NOPAGE);

   9479  1 005317   200073 631500                    EPPR1   I,,AUTO
         1 005320   200114 451500                    STP1    I$+3,,AUTO
         1 005321   200050 633500                    EPPR3   LDGRAN$,,AUTO
         1 005322   200113 453500                    STP3    I$+2,,AUTO
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:287  
         1 005323   200003 236100                    LDQ     @KQ$CG,,AUTO
         1 005324   200112 756100                    STQ     I$+1,,AUTO
         1 005325   200112 630500                    EPPR0   I$+1,,AUTO
         1 005326   000021 631400 xsym               EPPR1   B_VECTNIL+17
         1 005327   000000 701000 xent               TSX1    KQM$GETP
         1 005330   005363 702000 1                  TSX2    NOPAGE

     2005     9480    3           DGRAN$=LDGRAN$;

   9480  1 005331   200050 236100                    LDQ     LDGRAN$,,AUTO
         1 005332   200011 756100                    STQ     DGRAN$,,AUTO

     2006     9481    3           KQ$CG.CURDATAPGS=KQ$CG.CURDATAPGS+1;

   9481  1 005333   200003 470500                    LDP0    @KQ$CG,,AUTO
         1 005334   000241 720100                    LXL0    161,,PR0
         1 005335   000001 621010                    EAX1    1,X0
         1 005336   000241 441100                    SXL1    161,,PR0

     2007     9482    3           END;

   9480  1 005337                       BLDHDR       null
     2008     9483        /**/
     2009     9484    2   BLDHDR: ;
     2010     9485    2         KQ$DGRAN=KQ_IDGRAN;

   9485  1 005337   200011 470500                    LDP0    DGRAN$,,AUTO
         1 005340   000100 100400                    MLR     fill='000'O
         1 005341   000016 000200 0                  ADSC9   KQ_IDGRAN                cn=0,n=128
         1 005342   000000 000200                    ADSC9   0,,PR0                   cn=0,n=128

     2011     9486    2         KQ$GRAN=KQ$CG.GRAN;

   9486  1 005343   200003 471500                    LDP1    @KQ$CG,,AUTO
         1 005344   000100 100500                    MLR     fill='000'O
         1 005345   100253 000020                    ADSC9   171,,PR1                 cn=0,n=16
         1 005346   000000 000020                    ADSC9   0,,PR0                   cn=0,n=16
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:288  

     2012     9487    2         KQ$DGRAN.HDR.PTYP=%KQ_PTYP_DATA;

   9487  1 005347   000001 236100                    LDQ     1,,PR0
         1 005350   000035 376000 2                  ANQ     29
         1 005351   000001 276003                    ORQ     1,DU
         1 005352   000001 756100                    STQ     1,,PR0

     2013     9488    2         KQ$DGRAN.HDR.GTYP=%KQ_PTYP_DATA;

   9488  1 005353   000001 236100                    LDQ     1,,PR0
         1 005354   000036 376000 2                  ANQ     30
         1 005355   040000 276007                    ORQ     16384,DL
         1 005356   000001 756100                    STQ     1,,PR0

     2014     9489    2         KQ$DGRAN.HDR.SELF$=DGRAN$;

   9489  1 005357   200011 236100                    LDQ     DGRAN$,,AUTO
         1 005360   000002 756100                    STQ     2,,PR0

     2015     9490    2         RETURN;

   9490  1 005361   200072 221300                    LDX1  ! BX,,AUTO
         1 005362   000001 702211                    TSX2  ! 1,X1

   9489  1 005363                       NOPAGE       null
     2016     9491        /**/
     2017     9492
     2018     9493    2   NOPAGE: ;
     2019     9494    2         ERRCODE=0;

   9494  1 005363   200027 450100                    STZ     ERRCODE,,AUTO

     2020     9495        /**/
     2021     9496    2         DGRAN$=KQ$CG.AVAIL.TL$;

   9496  1 005364   200003 470500                    LDP0    @KQ$CG,,AUTO
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:289  
         1 005365   000245 236100                    LDQ     165,,PR0
         1 005366   200011 756100                    STQ     DGRAN$,,AUTO

     2022     9497    3           DO WHILE(DGRAN$~=ADDR(NIL));

   9497  1 005367   005402 710000 1                  TRA     s:9504

     2023     9498    4           IF KQ$DGRAN.USECNT=0 THEN DO;

   9498  1 005370   200011 470500                    LDP0    DGRAN$,,AUTO
         1 005371   000013 235100                    LDA     11,,PR0
         1 005372   005400 601000 1                  TNZ     s:9503

     2024     9499    4             KQ$DGRAN.HDR.FORCEOUT='0'B;

   9499  1 005373   000024 236000 2                  LDQ     20
         1 005374   000001 356100                    ANSQ    1,,PR0

     2025     9500    4             CALL REMPAGENP ALTRET(ALT);

   9500  1 005375   005461 701000 1                  TSX1    REMPAGENP
         1 005376   005454 702000 1                  TSX2    ALT

     2026     9501    4             GOTO BLDHDR;

   9501  1 005377   005337 710000 1                  TRA     BLDHDR

     2027     9502    4             END;
     2028     9503    3           DGRAN$=KQ$DGRAN.BLINK$;

   9503  1 005400   000016 236100                    LDQ     14,,PR0
         1 005401   200011 756100                    STQ     DGRAN$,,AUTO

     2029     9504    3           END;

   9504  1 005402   000001 116000 xsym               CMPQ    B_VECTNIL+1
         1 005403   005370 601000 1                  TNZ     s:9498
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:290  

     2030     9505        /**/
     2031     9506    2         IF KQ$CG.NEEDPGTL$=ADDR(NIL) THEN

   9506  1 005404   200003 470500                    LDP0    @KQ$CG,,AUTO
         1 005405   000251 236100                    LDQ     169,,PR0
         1 005406   000001 116000 xsym               CMPQ    B_VECTNIL+1
         1 005407   005413 601000 1                  TNZ     s:9509

     2032     9507    2           KQ$CG.NEEDPGHD$=DFR$;

   9507  1 005410   200007 236100                    LDQ     DFR$,,AUTO
         1 005411   000250 756100                    STQ     168,,PR0
         1 005412   005416 710000 1                  TRA     s:9510

     2033     9508    2         ELSE
     2034     9509    2           KQ$CG.NEEDPGTL$->KQ$DFRBLK.LNK$=DFR$;

   9509  1 005413   000251 471500                    LDP1    169,,PR0
         1 005414   200007 236100                    LDQ     DFR$,,AUTO
         1 005415   100000 756100                    STQ     0,,PR1

     2035     9510    2         KQ$DFRBLK.LNK$=ADDR(NIL);

   9510  1 005416   000001 236000 xsym               LDQ     B_VECTNIL+1
         1 005417   200007 471500                    LDP1    DFR$,,AUTO
         1 005420   100000 756100                    STQ     0,,PR1

     2036     9511    2         KQ$CG.NEEDPGTL$=DFR$;

   9511  1 005421   200007 236100                    LDQ     DFR$,,AUTO
         1 005422   000251 756100                    STQ     169,,PR0

     2037     9512    2         KQ$CG.NEEDPGCNT=KQ$CG.NEEDPGCNT+1;

   9512  1 005423   000252 054100                    AOS     170,,PR0

PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:291  
     2038     9513              %UNLOCK (G=KQ$CG.DTREE.GATE);

   9514  1 005424   200003 236100                    LDQ     @KQ$CG,,AUTO
         1 005425   000231 036003                    ADLQ    153,DU
         1 005426   200112 756100                    STQ     I$+1,,AUTO
         1 005427   200112 630500                    EPPR0   I$+1,,AUTO
         1 005430   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 005431   000000 701000 xent               TSX1    HFC$UNLOCK
         1 005432   000000 011000                    NOP     0

     2039     9516              %LOCK (G=KQ$CG.GATE.CG);

   9517  1 005433   200003 236100                    LDQ     @KQ$CG,,AUTO
         1 005434   000107 036003                    ADLQ    71,DU
         1 005435   200112 756100                    STQ     I$+1,,AUTO
         1 005436   200112 630500                    EPPR0   I$+1,,AUTO
         1 005437   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 005440   000000 701000 xent               TSX1    HFC$LOCK
         1 005441   000000 011000                    NOP     0

     2040     9519    2         KQ$CG.DELAY.NEEDPG='1'B;

   9519  1 005442   200003 470500                    LDP0    @KQ$CG,,AUTO
         1 005443   040000 236003                    LDQ     16384,DU
         1 005444   000020 256100                    ORSQ    16,,PR0

     2041     9520              %UNLOCK (G=KQ$CG.GATE.CG);

   9521  1 005445   200003 236100                    LDQ     @KQ$CG,,AUTO
         1 005446   000107 036003                    ADLQ    71,DU
         1 005447   200112 756100                    STQ     I$+1,,AUTO
         1 005450   200112 630500                    EPPR0   I$+1,,AUTO
         1 005451   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 005452   000000 701000 xent               TSX1    HFC$UNLOCK
         1 005453   000000 011000                    NOP     0

     2042     9523    2   ALT:  ALTRETURN;
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:292  

   9523  1 005454   200072 221300       ALT          LDX1  ! BX,,AUTO
         1 005455   000000 702211                    TSX2  ! 0,X1

     2043     9524    2   END GETPAGE;
     2044     9525        %EJECT;
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:293  
     2045     9526
     2046     9527
     2047     9528        /*D* NAME:         REMPAGE
     2048     9529
     2049     9530             CALL:         CALL REMPAGE ALTRET(LOC);
     2050     9531
     2051     9532             INPUT:        DGRAN$ - Ptr to a data cache page to throw out
     2052     9533
     2053     9534             DESCRIPTION:  The specified page must have a USECNT of zero.
     2054     9535                           The page is removed from the AVAIL chain.
     2055     9536                           If it is updated, it is written out.  Routine
     2056     9537                           ALTRETs if it writes it out.
     2057     9538
     2058     9539        */
     2059     9540
     2060     9541
     2061     9542    1   REMPAGE: PROC ALTRET;

   9542  1 005456   200076 741300       REMPAGE      STX1  ! AVAILCNT,,AUTO

     2062     9543
     2063     9544        /**/
     2064     9545        /* AUTO */
     2065     9546        /**/
     2066     9547    2   DCL ENTF UBIN;
     2067     9548    2   DCL TDFR$ PTR;
     2068     9549    2   DCL DA UBIN;
     2069     9550    2   DCL Q$ PTR;
     2070     9551    2   DCL ADDFLG UBIN;
     2071     9552
     2072     9553    2         ENTF=0;

   9553  1 005457   200077 450100                    STZ     ENTF,,AUTO

     2073     9554    2         GOTO REMP;

   9554  1 005460   005464 710000 1                  TRA     REMP
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:294  

     2074     9555
     2075     9556    2   REMPAGENP: ENTRY ALTRET;

   9556  1 005461   200076 741300       REMPAGENP    STX1  ! AVAILCNT,,AUTO

     2076     9557
     2077     9558    2         ENTF=1;

   9558  1 005462   000001 235007                    LDA     1,DL
         1 005463   200077 755100                    STA     ENTF,,AUTO

   9558  1 005464                       REMP         null
     2078     9559
     2079     9560    2   REMP: ;
     2080     9561    2         DA=ADDR(KQ$DGRAN.BTN.KEY)->WRD(0);

   9561  1 005464   200011 470500                    LDP0    DGRAN$,,AUTO
         1 005465   000011 235100                    LDA     9,,PR0
         1 005466   200101 755100                    STA     DA,,AUTO

     2081     9562    2         TDFR$=DFR$;

   9562  1 005467   200007 236100                    LDQ     DFR$,,AUTO
         1 005470   200100 756100                    STQ     TDFR$,,AUTO

     2082     9563        /**/
     2083     9564    2         IF NOT KQ$DGRAN.HDR.EMPTYLIST AND NOT KQ$DGRAN.HDR.FORCEOUT AND

   9564  1 005471   000001 236100                    LDQ     1,,PR0
         1 005472   000040 316003                    CANQ    32,DU
         1 005473   005504 601000 1                  TNZ     s:9568
         1 005474   000400 316003                    CANQ    256,DU
         1 005475   005504 601000 1                  TNZ     s:9568
         1 005476   000021 235100                    LDA     17,,PR0
         1 005477   000144 115007                    CMPA    100,DL
         1 005500   005504 604000 1                  TMI     s:9568
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:295  

     2084     9565    2         KQ$DGRAN.WRDSAVAIL>=100 THEN
     2085     9566    2           ADDFLG=1;

   9566  1 005501   000001 235007                    LDA     1,DL
         1 005502   200103 755100                    STA     ADDFLG,,AUTO
         1 005503   005505 710000 1                  TRA     s:9569

     2086     9567    2         ELSE
     2087     9568    2           ADDFLG=0;

   9568  1 005504   200103 450100                    STZ     ADDFLG,,AUTO

     2088     9569    2         IF KQ$DGRAN.HDR.UPD OR KQ$DGRAN.HDR.FORCEOUT THEN

   9569  1 005505   000010 316003                    CANQ    8,DU
         1 005506   005511 601000 1                  TNZ     s:9571
         1 005507   000400 316003                    CANQ    256,DU
         1 005510   005742 600000 1                  TZE     s:9631

     2089     9570    3           DO;

     2090     9571    3           IF ENTF~=0 THEN

   9571  1 005511   200077 235100                    LDA     ENTF,,AUTO
         1 005512   005532 600000 1                  TZE     s:9581

     2091     9572    4             DO;

     2092     9573    4             IF KQ$CG.NEEDPGTL$=ADDR(NIL) THEN

   9573  1 005513   200003 471500                    LDP1    @KQ$CG,,AUTO
         1 005514   100251 236100                    LDQ     169,,PR1
         1 005515   000001 116000 xsym               CMPQ    B_VECTNIL+1
         1 005516   005522 601000 1                  TNZ     s:9576

     2093     9574    4               KQ$CG.NEEDPGHD$=DFR$;
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:296  

   9574  1 005517   200007 236100                    LDQ     DFR$,,AUTO
         1 005520   100250 756100                    STQ     168,,PR1
         1 005521   005525 710000 1                  TRA     s:9577

     2094     9575    4             ELSE
     2095     9576    4               KQ$CG.NEEDPGTL$->KQ$DFRBLK.LNK$=DFR$;

   9576  1 005522   100251 473500                    LDP3    169,,PR1
         1 005523   200007 236100                    LDQ     DFR$,,AUTO
         1 005524   300000 756100                    STQ     0,,PR3

     2096     9577    4             KQ$CG.NEEDPGTL$=DFR$;

   9577  1 005525   100251 756100                    STQ     169,,PR1

     2097     9578    4             KQ$DFRBLK.LNK$=ADDR(NIL);

   9578  1 005526   000001 236000 xsym               LDQ     B_VECTNIL+1
         1 005527   200007 473500                    LDP3    DFR$,,AUTO
         1 005530   300000 756100                    STQ     0,,PR3

     2098     9579    4             KQ$CG.NEEDPGCNT=KQ$CG.NEEDPGCNT+1;

   9579  1 005531   100252 054100                    AOS     170,,PR1

     2099     9580    4             END;

     2100     9581    3           CALL NIQ$GETNR(Q$) ALTRET(NOQENTS);

   9581  1 005532   200102 631500                    EPPR1   Q$,,AUTO
         1 005533   200112 451500                    STP1    I$+1,,AUTO
         1 005534   200112 630500                    EPPR0   I$+1,,AUTO
         1 005535   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 005536   000000 701000 xent               TSX1    NIQ$GETNR
         1 005537   006043 702000 1                  TSX2    NOQENTS

PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:297  
     2101     9582    3           IF ADDFLG~=0 THEN

   9582  1 005540   200103 235100                    LDA     ADDFLG,,AUTO
         1 005541   005562 600000 1                  TZE     s:9591

     2102     9583    4             DO;  /* Put on avail list if more than 10% of space is avail */

     2103     9584    4             KQ$DGRAN.FREEFLINK=KQ$CG.FREEDA;

   9584  1 005542   200003 470500                    LDP0    @KQ$CG,,AUTO
         1 005543   200011 471500                    LDP1    DGRAN$,,AUTO
         1 005544   000226 236100                    LDQ     150,,PR0
         1 005545   000032 376000 xsym               ANQ     B_VECTNIL+26
         1 005546   100023 756100                    STQ     19,,PR1

     2104     9585    4             KQ$CG.FREEDA=ADDR(KQ$DGRAN.BTN.KEY)->WRD(0);

   9585  1 005547   100011 236100                    LDQ     9,,PR1
         1 005550   000226 552134                    STBQ    150,'34'O,PR0

     2105     9586    4             KQ$DGRAN.HDR.EMPTYLIST='1'B;

   9586  1 005551   000040 236003                    LDQ     32,DU
         1 005552   100001 256100                    ORSQ    1,,PR1

     2106     9587    4             KQ$DGRAN.HDR.UPD='1'B;

   9587  1 005553   000010 236003                    LDQ     8,DU
         1 005554   100001 256100                    ORSQ    1,,PR1

     2107     9588    4             KQ$DGRAN.HDR.ADDFREE='1'B;

   9588  1 005555   000200 236003                    LDQ     128,DU
         1 005556   100001 256100                    ORSQ    1,,PR1

     2108     9589    4             KQ$CG.ADDFREE=KQ$CG.ADDFREE+1; /* Incr # adds in progress */

PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:298  
   9589  1 005557   000227 235100                    LDA     151,,PR0
         1 005560   000001 035007                    ADLA    1,DL
         1 005561   000227 755100                    STA     151,,PR0

     2109     9590    4             END;

     2110     9591    3           KQ$DGRAN.HDR.WRITE='1'B; /* Write in progress */

   9591  1 005562   200011 470500                    LDP0    DGRAN$,,AUTO
         1 005563   000100 236003                    LDQ     64,DU
         1 005564   000001 256100                    ORSQ    1,,PR0

     2111     9592    3           KQ$DGRAN.USECNT=KQ$DGRAN.USECNT+1;

   9592  1 005565   000013 054100                    AOS     11,,PR0

     2112     9593    3           CALL GETBLK ALTRET(NODFR);

   9593  1 005566   004104 701000 1                  TSX1    GETBLK
         1 005567   005610 702000 1                  TSX2    NODFR

     2113     9594    3           KQ$DFRBLK.CODE=%KQDC_WRITE;

   9594  1 005570   200007 470500                    LDP0    DFR$,,AUTO
         1 005571   006000 236003                    LDQ     3072,DU
         1 005572   000001 552140                    STBQ    1,'40'O,PR0

     2114     9595    3           KQ$DFRBLK.DA=DA;

   9595  1 005573   200101 235100                    LDA     DA,,AUTO
         1 005574   000002 755100                    STA     2,,PR0

     2115     9596    3           IF KQ$CG.IOTL$=ADDR(NIL) THEN

   9596  1 005575   200003 471500                    LDP1    @KQ$CG,,AUTO
         1 005576   100247 236100                    LDQ     167,,PR1
         1 005577   000001 116000 xsym               CMPQ    B_VECTNIL+1
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:299  
         1 005600   005604 601000 1                  TNZ     s:9599

     2116     9597    3             KQ$CG.IOHD$=DFR$;

   9597  1 005601   200007 236100                    LDQ     DFR$,,AUTO
         1 005602   100246 756100                    STQ     166,,PR1
         1 005603   005607 710000 1                  TRA     s:9600

     2117     9598    3           ELSE
     2118     9599    3             KQ$CG.IOTL$->KQ$DFRBLK.LNK$=DFR$;

   9599  1 005604   100247 473500                    LDP3    167,,PR1
         1 005605   200007 236100                    LDQ     DFR$,,AUTO
         1 005606   300000 756100                    STQ     0,,PR3

     2119     9600    3           KQ$CG.IOTL$=DFR$;

   9600  1 005607   100247 756100                    STQ     167,,PR1

   9600  1 005610                       NODFR        null
     2120     9601    3   NODFR:  ;
     2121     9602    4           IF KQ_LOG.DCIO THEN DO;

   9602  1 005610   000000 236000 xsym               LDQ     KQ_LOG
         1 005611   010000 316003                    CANQ    4096,DU
         1 005612   005641 600000 1                  TZE     s:9609

     2122     9603    4             LDFR$=DFR$; LDGRAN$=DGRAN$;

   9603  1 005613   200007 236100                    LDQ     DFR$,,AUTO
         1 005614   200046 756100                    STQ     LDFR$,,AUTO

   9603  1 005615   200011 236100                    LDQ     DGRAN$,,AUTO
         1 005616   200050 756100                    STQ     LDGRAN$,,AUTO

     2123     9604    4             CALL KQZ$LOG(KQ$CG,%KQLOG_DCWRITE,,,LDFR$,

PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:300  
   9604  1 005617   200050 630500                    EPPR0   LDGRAN$,,AUTO
         1 005620   200120 450500                    STP0    I$+7,,AUTO
         1 005621   200101 631500                    EPPR1   DA,,AUTO
         1 005622   200117 451500                    STP1    I$+6,,AUTO
         1 005623   200046 633500                    EPPR3   LDFR$,,AUTO
         1 005624   200116 453500                    STP3    I$+5,,AUTO
         1 005625   000001 236000 xsym               LDQ     B_VECTNIL+1
         1 005626   000001 235000 xsym               LDA     B_VECTNIL+1
         1 005627   200114 757100                    STAQ    I$+3,,AUTO
         1 005630   000040 236000 2                  LDQ     32
         1 005631   200003 235100                    LDA     @KQ$CG,,AUTO
         1 005632   200112 757100                    STAQ    I$+1,,AUTO
         1 005633   200112 630500                    EPPR0   I$+1,,AUTO
         1 005634   000025 631400 xsym               EPPR1   B_VECTNIL+21
         1 005635   000000 701000 xent               TSX1    KQZ$LOG
         1 005636   005641 702000 1                  TSX2    s:9609

     2124     9605    4             DA,LDGRAN$) ALTRET(LOG1);
     2125     9606    4             RETURN;  /* Never comes here */

   9606  1 005637   200076 221300                    LDX1  ! AVAILCNT,,AUTO
         1 005640   000001 702211                    TSX2  ! 1,X1

     2126     9607    4   LOG1:     END;
     2127     9608        /**/
     2128     9609    3           CALL KQB$DELETENL(KQ$CG.DTREE,KQ$DGRAN.BTN.KEY,ADDR(KQ$DGRAN.BTN)) ALTRET(
              9609                    ERR);

   9609  1 005641   200011 236100                    LDQ     DGRAN$,,AUTO
         1 005642   000004 036003                    ADLQ    4,DU
         1 005643   200112 756100                    STQ     I$+1,,AUTO
         1 005644   200112 630500                    EPPR0   I$+1,,AUTO
         1 005645   200115 450500                    STP0    I$+4,,AUTO
         1 005646   200011 236100                    LDQ     DGRAN$,,AUTO
         1 005647   000011 036003                    ADLQ    9,DU
         1 005650   200114 756100                    STQ     I$+3,,AUTO
         1 005651   200003 236100                    LDQ     @KQ$CG,,AUTO
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:301  
         1 005652   000231 036003                    ADLQ    153,DU
         1 005653   200113 756100                    STQ     I$+2,,AUTO
         1 005654   200113 630500                    EPPR0   I$+2,,AUTO
         1 005655   000021 631400 xsym               EPPR1   B_VECTNIL+17
         1 005656   000000 701000 xent               TSX1    KQB$DELETENL
         1 005657   006040 702000 1                  TSX2    ERR

     2129     9610        /**/
     2130     9611    3           IF KQ$DGRAN.BLINK$=ADDR(NIL) THEN

   9611  1 005660   200011 470500                    LDP0    DGRAN$,,AUTO
         1 005661   000016 236100                    LDQ     14,,PR0
         1 005662   000001 116000 xsym               CMPQ    B_VECTNIL+1
         1 005663   005670 601000 1                  TNZ     s:9614

     2131     9612    3             KQ$CG.AVAIL.HD$=KQ$DGRAN.FLINK$;

   9612  1 005664   000017 236100                    LDQ     15,,PR0
         1 005665   200003 471500                    LDP1    @KQ$CG,,AUTO
         1 005666   100244 756100                    STQ     164,,PR1
         1 005667   005673 710000 1                  TRA     s:9615

     2132     9613    3           ELSE
     2133     9614    3             KQ$DGRAN.BLINK$->KQ$DGRAN.FLINK$=KQ$DGRAN.FLINK$;

   9614  1 005670   000016 471500                    LDP1    14,,PR0
         1 005671   000017 236100                    LDQ     15,,PR0
         1 005672   100017 756100                    STQ     15,,PR1

     2134     9615    3           IF KQ$DGRAN.FLINK$=ADDR(NIL) THEN

   9615  1 005673   000017 236100                    LDQ     15,,PR0
         1 005674   000001 116000 xsym               CMPQ    B_VECTNIL+1
         1 005675   005702 601000 1                  TNZ     s:9618

     2135     9616    3             KQ$CG.AVAIL.TL$=KQ$DGRAN.BLINK$;

PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:302  
   9616  1 005676   000016 236100                    LDQ     14,,PR0
         1 005677   200003 471500                    LDP1    @KQ$CG,,AUTO
         1 005700   100245 756100                    STQ     165,,PR1
         1 005701   005705 710000 1                  TRA     s:9620

     2136     9617    3           ELSE
     2137     9618    3             KQ$DGRAN.FLINK$->KQ$DGRAN.BLINK$=KQ$DGRAN.BLINK$;

   9618  1 005702   000017 471500                    LDP1    15,,PR0
         1 005703   000016 236100                    LDQ     14,,PR0
         1 005704   100016 756100                    STQ     14,,PR1

     2138     9619        /**/
     2139     9620    3           KQ$DGRAN.HDR.CHAIN='0'B;  /* Not chained any more */

   9620  1 005705   000041 236000 2                  LDQ     33
         1 005706   000001 356100                    ANSQ    1,,PR0

     2140     9621    3           LDGRAN$=DGRAN$; LDFR$=DFR$;

   9621  1 005707   200011 236100                    LDQ     DGRAN$,,AUTO
         1 005710   200050 756100                    STQ     LDGRAN$,,AUTO

   9621  1 005711   200007 236100                    LDQ     DFR$,,AUTO
         1 005712   200046 756100                    STQ     LDFR$,,AUTO

     2141     9622    3           CALL WRITEGRAN(LDGRAN$,DA,LDFR$,Q$) ALTRET (NOSENTS);

   9622  1 005713   200102 631500                    EPPR1   Q$,,AUTO
         1 005714   200110 451500                    STP1    @Q$,,AUTO
         1 005715   200046 633500                    EPPR3   LDFR$,,AUTO
         1 005716   200107 453500                    STP3    @DFR$,,AUTO
         1 005717   200101 634500                    EPPR4   DA,,AUTO
         1 005720   200106 454500                    STP4    @DA,,AUTO
         1 005721   200050 635500                    EPPR5   LDGRAN$,,AUTO
         1 005722   200105 455500                    STP5    @DGRAN$,,AUTO
         1 005723   005126 701000 1                  TSX1    WRITEGRAN
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:303  
         1 005724   006043 702000 1                  TSX2    NOQENTS

     2142     9623                %UNLOCK (G=KQ$CG.DTREE.GATE);

   9624  1 005725   200003 236100                    LDQ     @KQ$CG,,AUTO
         1 005726   000231 036003                    ADLQ    153,DU
         1 005727   200112 756100                    STQ     I$+1,,AUTO
         1 005730   200112 630500                    EPPR0   I$+1,,AUTO
         1 005731   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 005732   000000 701000 xent               TSX1    HFC$UNLOCK
         1 005733   000000 011000                    NOP     0

     2143     9626    3           DFR$=TDFR$;

   9626  1 005734   200100 236100                    LDQ     TDFR$,,AUTO
         1 005735   200007 756100                    STQ     DFR$,,AUTO

     2144     9627    3           DGRAN$=ADDR(NIL);

   9627  1 005736   000001 236000 xsym               LDQ     B_VECTNIL+1
         1 005737   200011 756100                    STQ     DGRAN$,,AUTO

     2145     9628    3           ALTRETURN;

   9628  1 005740   200076 221300                    LDX1  ! AVAILCNT,,AUTO
         1 005741   000000 702211                    TSX2  ! 0,X1

     2146     9629    3           END;
     2147     9630        /**/
     2148     9631    3         IF KQ_LOG.DCIO THEN DO;

   9631  1 005742   000000 236000 xsym               LDQ     KQ_LOG
         1 005743   010000 316003                    CANQ    4096,DU
         1 005744   005770 600000 1                  TZE     s:9638

     2149     9632    3           LDGRAN$=DGRAN$;

PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:304  
   9632  1 005745   200011 236100                    LDQ     DGRAN$,,AUTO
         1 005746   200050 756100                    STQ     LDGRAN$,,AUTO

     2150     9633    3           CALL KQZ$LOG(KQ$CG,%KQLOG_DCREMP,,,,DA,LDGRAN$)

   9633  1 005747   200050 631500                    EPPR1   LDGRAN$,,AUTO
         1 005750   200120 451500                    STP1    I$+7,,AUTO
         1 005751   200101 633500                    EPPR3   DA,,AUTO
         1 005752   200117 453500                    STP3    I$+6,,AUTO
         1 005753   000001 236000 xsym               LDQ     B_VECTNIL+1
         1 005754   200116 756100                    STQ     I$+5,,AUTO
         1 005755   000001 235000 xsym               LDA     B_VECTNIL+1
         1 005756   200114 757100                    STAQ    I$+3,,AUTO
         1 005757   000043 236000 2                  LDQ     35
         1 005760   200003 235100                    LDA     @KQ$CG,,AUTO
         1 005761   200112 757100                    STAQ    I$+1,,AUTO
         1 005762   200112 630500                    EPPR0   I$+1,,AUTO
         1 005763   000025 631400 xsym               EPPR1   B_VECTNIL+21
         1 005764   000000 701000 xent               TSX1    KQZ$LOG
         1 005765   005770 702000 1                  TSX2    s:9638

     2151     9634    3           ALTRET(LOG2);
     2152     9635    3           RETURN;  /* Never comes here */

   9635  1 005766   200076 221300                    LDX1  ! AVAILCNT,,AUTO
         1 005767   000001 702211                    TSX2  ! 1,X1

     2153     9636    3   LOG2:   END;
     2154     9637        /**/
     2155     9638    2        CALL KQB$DELETENL(KQ$CG.DTREE,KQ$DGRAN.BTN.KEY,ADDR(KQ$DGRAN.BTN)) ALTRET(ERR)
              9638                  ;

   9638  1 005770   200011 236100                    LDQ     DGRAN$,,AUTO
         1 005771   000004 036003                    ADLQ    4,DU
         1 005772   200112 756100                    STQ     I$+1,,AUTO
         1 005773   200112 630500                    EPPR0   I$+1,,AUTO
         1 005774   200115 450500                    STP0    I$+4,,AUTO
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:305  
         1 005775   200011 236100                    LDQ     DGRAN$,,AUTO
         1 005776   000011 036003                    ADLQ    9,DU
         1 005777   200114 756100                    STQ     I$+3,,AUTO
         1 006000   200003 236100                    LDQ     @KQ$CG,,AUTO
         1 006001   000231 036003                    ADLQ    153,DU
         1 006002   200113 756100                    STQ     I$+2,,AUTO
         1 006003   200113 630500                    EPPR0   I$+2,,AUTO
         1 006004   000021 631400 xsym               EPPR1   B_VECTNIL+17
         1 006005   000000 701000 xent               TSX1    KQB$DELETENL
         1 006006   006040 702000 1                  TSX2    ERR

     2156     9639        /**/
     2157     9640    2         IF KQ$DGRAN.BLINK$=ADDR(NIL) THEN

   9640  1 006007   200011 470500                    LDP0    DGRAN$,,AUTO
         1 006010   000016 236100                    LDQ     14,,PR0
         1 006011   000001 116000 xsym               CMPQ    B_VECTNIL+1
         1 006012   006017 601000 1                  TNZ     s:9643

     2158     9641    2           KQ$CG.AVAIL.HD$=KQ$DGRAN.FLINK$;

   9641  1 006013   000017 236100                    LDQ     15,,PR0
         1 006014   200003 471500                    LDP1    @KQ$CG,,AUTO
         1 006015   100244 756100                    STQ     164,,PR1
         1 006016   006022 710000 1                  TRA     s:9644

     2159     9642    2         ELSE
     2160     9643    2           KQ$DGRAN.BLINK$->KQ$DGRAN.FLINK$=KQ$DGRAN.FLINK$;

   9643  1 006017   000016 471500                    LDP1    14,,PR0
         1 006020   000017 236100                    LDQ     15,,PR0
         1 006021   100017 756100                    STQ     15,,PR1

     2161     9644    2         IF KQ$DGRAN.FLINK$=ADDR(NIL) THEN

   9644  1 006022   000017 236100                    LDQ     15,,PR0
         1 006023   000001 116000 xsym               CMPQ    B_VECTNIL+1
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:306  
         1 006024   006031 601000 1                  TNZ     s:9647

     2162     9645    2           KQ$CG.AVAIL.TL$=KQ$DGRAN.BLINK$;

   9645  1 006025   000016 236100                    LDQ     14,,PR0
         1 006026   200003 471500                    LDP1    @KQ$CG,,AUTO
         1 006027   100245 756100                    STQ     165,,PR1
         1 006030   006034 710000 1                  TRA     s:9649

     2163     9646    2         ELSE
     2164     9647    2           KQ$DGRAN.FLINK$->KQ$DGRAN.BLINK$=KQ$DGRAN.BLINK$;

   9647  1 006031   000017 471500                    LDP1    15,,PR0
         1 006032   000016 236100                    LDQ     14,,PR0
         1 006033   100016 756100                    STQ     14,,PR1

     2165     9648        /**/
     2166     9649    2         KQ$DGRAN.HDR.CHAIN='0'B;  /* Not chained any more */

   9649  1 006034   000041 236000 2                  LDQ     33
         1 006035   000001 356100                    ANSQ    1,,PR0

     2167     9650        /**/
     2168     9651    2         RETURN;

   9651  1 006036   200076 221300                    LDX1  ! AVAILCNT,,AUTO
         1 006037   000001 702211                    TSX2  ! 1,X1

   9649  1 006040                       ERR          null
     2169     9652        /**/
     2170     9653    2   ERR:  ;
     2171     9654    2         CALL SC_CGCACHESCR;

   9654  1 006040   000000 713400 xsym               CLIMB   SC_CGCACHESCR
         1 006041   000000 600000 xsid               climb   nvectors=         0

     2172     9655    2         GOTO ERR;
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:307  

   9655  1 006042   006040 710000 1                  TRA     ERR

   9649  1 006043                       NOQENTS      null
   9649  1 006043                       NOSENTS      null
     2173     9656        /**/
     2174     9657    2   NOQENTS: ;
     2175     9658    2   NOSENTS: ;
     2176     9659              %UNLOCK (G=KQ$CG.DTREE.GATE);

   9660  1 006043   200003 236100                    LDQ     @KQ$CG,,AUTO
         1 006044   000231 036003                    ADLQ    153,DU
         1 006045   200112 756100                    STQ     I$+1,,AUTO
         1 006046   200112 630500                    EPPR0   I$+1,,AUTO
         1 006047   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 006050   000000 701000 xent               TSX1    HFC$UNLOCK
         1 006051   000000 011000                    NOP     0

     2177     9662    2         ALTRETURN;

   9662  1 006052   200076 221300                    LDX1  ! AVAILCNT,,AUTO
         1 006053   000000 702211                    TSX2  ! 0,X1

     2178     9663        /**/
     2179     9664    2   END REMPAGE;
     2180     9665        %EJECT;
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:308  
     2181     9666
     2182     9667
     2183     9668        /*F* NAME:         KQD$RELP
     2184     9669
     2185     9670             PURPOSE:      Release a page that is no longer needed for
     2186     9671                           its original purpose.
     2187     9672
     2188     9673        */
     2189     9674
     2190     9675
     2191     9676
     2192     9677        /*D* NAME:         KQD$RELP
     2193     9678
     2194     9679             CALL:         CALL KQD$RELP(KQ$CG,DGRAN$);
     2195     9680
     2196     9681             INPUT:        KQ$CG - Context block ptr
     2197     9682                           DGRAN$ - Ptr to page to release
     2198     9683
     2199     9684             DESCRIPTION:  If the page is not needed by any other
     2200     9685                           process, it is released via KQM$RELP.
     2201     9686                           Otherwise, it is given to whomever needs it.
     2202     9687
     2203     9688        */
     2204     9689
     2205     9690
     2206     9691    1   KQD$RELP: ENTRY(KQ$CG,PDBLK$) ALTRET;

   9691  1 006054   000000 700200 xent  KQD$RELP     TSX0  ! X66_AUTO_3
         1 006055   000122 000003                    ZERO    82,3

     2207     9692
     2208     9693    1         DGRAN$=PDBLK$;

   9693  1 006056   200004 470500                    LDP0    @PDBLK$,,AUTO
         1 006057   000000 236100                    LDQ     0,,PR0
         1 006060   200011 756100                    STQ     DGRAN$,,AUTO

PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:309  
     2209     9694              %LOCK (G=KQ$CG.DTREE.GATE);

   9695  1 006061   200003 236100                    LDQ     @KQ$CG,,AUTO
         1 006062   000231 036003                    ADLQ    153,DU
         1 006063   200112 756100                    STQ     I$+1,,AUTO
         1 006064   200112 630500                    EPPR0   I$+1,,AUTO
         1 006065   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 006066   000000 701000 xent               TSX1    HFC$LOCK
         1 006067   000000 011000                    NOP     0

     2210     9697    1         CALL RELPAGE ALTRET(NOUNLK);

   9697  1 006070   006103 701000 1                  TSX1    RELPAGE
         1 006071   006102 702000 1                  TSX2    NOUNLK

     2211     9698              %UNLOCK (G=KQ$CG.DTREE.GATE);

   9699  1 006072   200003 236100                    LDQ     @KQ$CG,,AUTO
         1 006073   000231 036003                    ADLQ    153,DU
         1 006074   200112 756100                    STQ     I$+1,,AUTO
         1 006075   200112 630500                    EPPR0   I$+1,,AUTO
         1 006076   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 006077   000000 701000 xent               TSX1    HFC$UNLOCK
         1 006100   000000 011000                    NOP     0

     2212     9701    1         RETURN;

   9701  1 006101   000000 702200 xent               TSX2  ! X66_ARET

   9693  1 006102                       NOUNLK       null
     2213     9702        /**/
     2214     9703    1   NOUNLK: ;
     2215     9704    1         ALTRETURN;

   9704  1 006102   000000 702200 xent               TSX2  ! X66_AALT

     2216     9705        %EJECT;
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:310  
     2217     9706
     2218     9707
     2219     9708        /*D* NAME:         RELPAGE
     2220     9709
     2221     9710             CALL:         CALL RELPAGE ALTRET(LOC);
     2222     9711
     2223     9712             INPUT:        DGRAN$ - Ptr to page to release
     2224     9713
     2225     9714             DESCRIPTION:  The page must be completely free.  If no other
     2226     9715                           process needs the page, it is released and the
     2227     9716                           routine exits.  If something else needs it,
     2228     9717                           the page is given to it, the process is COMPed,
     2229     9718                           and the routine ALTRETs to indicate the gate was
     2230     9719                           unlocked.
     2231     9720
     2232     9721        */
     2233     9722
     2234     9723
     2235     9724    1   RELPAGE: PROC ALTRET;

   9724  1 006103   200052 741300       RELPAGE      STX1  ! LDGRAN$+2,,AUTO

     2236     9725
     2237     9726        /**/
     2238     9727        /* AUTO */
     2239     9728        /**/
     2240     9729    2   DCL TDFR$ PTR;
     2241     9730    2   DCL P$ PTR;
     2242     9731    2   DCL T$ PTR;
     2243     9732    2   DCL N$ PTR;
     2244     9733
     2245     9734    2         TDFR$=DFR$;

   9734  1 006104   200007 236100                    LDQ     DFR$,,AUTO
         1 006105   200053 756100                    STQ     TDFR$,,AUTO

     2246     9735    2         KQ$DGRAN=KQ_IDGRAN;
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:311  

   9735  1 006106   200011 470500                    LDP0    DGRAN$,,AUTO
         1 006107   000100 100400                    MLR     fill='000'O
         1 006110   000016 000200 0                  ADSC9   KQ_IDGRAN                cn=0,n=128
         1 006111   000000 000200                    ADSC9   0,,PR0                   cn=0,n=128

     2247     9736    2         KQ$GRAN=KQ$CG.GRAN;

   9736  1 006112   200003 471500                    LDP1    @KQ$CG,,AUTO
         1 006113   000100 100500                    MLR     fill='000'O
         1 006114   100253 000020                    ADSC9   171,,PR1                 cn=0,n=16
         1 006115   000000 000020                    ADSC9   0,,PR0                   cn=0,n=16

     2248     9737    2         KQ$DGRAN.HDR.PTYP=%KQ_PTYP_DATA;

   9737  1 006116   000001 236100                    LDQ     1,,PR0
         1 006117   000035 376000 2                  ANQ     29
         1 006120   000001 276003                    ORQ     1,DU
         1 006121   000001 756100                    STQ     1,,PR0

     2249     9738    2         KQ$DGRAN.HDR.GTYP=%KQ_PTYP_DATA;

   9738  1 006122   000001 236100                    LDQ     1,,PR0
         1 006123   000036 376000 2                  ANQ     30
         1 006124   040000 276007                    ORQ     16384,DL
         1 006125   000001 756100                    STQ     1,,PR0

     2250     9739    2         KQ$DGRAN.HDR.SELF$=DGRAN$;

   9739  1 006126   200011 236100                    LDQ     DGRAN$,,AUTO
         1 006127   000002 756100                    STQ     2,,PR0

   9739  1 006130                       LOOP         null
     2251     9740    2   LOOP: ;
     2252     9741    2         IF KQ$CG.NEEDPGHD$~=ADDR(NIL) AND KQ$CG.MAXDATAPGS>=KQ$CG.CURDATAPGS THEN

   9741  1 006130   200003 470500                    LDP0    @KQ$CG,,AUTO
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:312  
         1 006131   000250 236100                    LDQ     168,,PR0
         1 006132   000001 116000 xsym               CMPQ    B_VECTNIL+1
         1 006133   006352 600000 1                  TZE     s:9810
         1 006134   000241 720100                    LXL0    161,,PR0
         1 006135   000241 100100                    CMPX0   161,,PR0
         1 006136   006140 600000 1                  TZE     s:9743
         1 006137   006352 603000 1                  TRC     s:9810

     2253     9742    3           DO;

     2254     9743    3           DFR$=KQ$CG.NEEDPGHD$;

   9743  1 006140   200007 756100                    STQ     DFR$,,AUTO

     2255     9744    3           KQ$CG.NEEDPGHD$=KQ$DFRBLK.LNK$;

   9744  1 006141   200007 471500                    LDP1    DFR$,,AUTO
         1 006142   100000 236100                    LDQ     0,,PR1
         1 006143   000250 756100                    STQ     168,,PR0

     2256     9745    3           IF KQ$CG.NEEDPGTL$=DFR$ THEN

   9745  1 006144   000251 236100                    LDQ     169,,PR0
         1 006145   200007 116100                    CMPQ    DFR$,,AUTO
         1 006146   006151 601000 1                  TNZ     s:9747

     2257     9746    3             KQ$CG.NEEDPGTL$=ADDR(NIL);

   9746  1 006147   000001 236000 xsym               LDQ     B_VECTNIL+1
         1 006150   000251 756100                    STQ     169,,PR0

     2258     9747    3           KQ$DFRBLK.LNK$=ADDR(NIL);

   9747  1 006151   000001 236000 xsym               LDQ     B_VECTNIL+1
         1 006152   100000 756100                    STQ     0,,PR1

     2259     9748    3           KQ$CG.NEEDPGCNT=KQ$CG.NEEDPGCNT-1;
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:313  

   9748  1 006153   000001 336007                    LCQ     1,DL
         1 006154   000252 056100                    ASQ     170,,PR0

     2260     9749    4             DO CASE(KQ$DFRBLK.CODE);

   9749  1 006155   100001 236100                    LDQ     1,,PR1
         1 006156   000033 772000                    QRL     27
         1 006157   000013 116007                    CMPQ    11,DL
         1 006160   006162 602006 1                  TNC     s:9749+5,QL
         1 006161   006203 710000 1                  TRA     s:9755
         1 006162   006203 710000 1                  TRA     s:9755
         1 006163   006206 710000 1                  TRA     s:9758
         1 006164   006206 710000 1                  TRA     s:9758
         1 006165   006206 710000 1                  TRA     s:9758
         1 006166   006203 710000 1                  TRA     s:9755
         1 006167   006203 710000 1                  TRA     s:9755
         1 006170   006203 710000 1                  TRA     s:9755
         1 006171   006203 710000 1                  TRA     s:9755
         1 006172   006203 710000 1                  TRA     s:9755
         1 006173   006206 710000 1                  TRA     s:9758
         1 006174   006175 710000 1                  TRA     s:9751

     2261     9750    4               CASE(%KQDC_GETNEW);

     2262     9751    4                 CALL GETPROCESS ALTRET(TRYAGAIN);

   9751  1 006175   000577 701000 1                  TSX1    GETPROCESS
         1 006176   006416 702000 1                  TSX2    TRYAGAIN

     2263     9752    4                 DFR$=TDFR$;

   9752  1 006177   200053 236100                    LDQ     TDFR$,,AUTO
         1 006200   200007 756100                    STQ     DFR$,,AUTO

     2264     9753    4                 ALTRETURN;

PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:314  
   9753  1 006201   200052 221300                    LDX1  ! LDGRAN$+2,,AUTO
         1 006202   000000 702211                    TSX2  ! 0,X1

     2265     9754    4               CASE(ELSE);

     2266     9755    4                 CALL SC_CGCACHE;

   9755  1 006203   000000 713400 xsym               CLIMB   SC_CGCACHE
         1 006204   000000 600000 xsid               climb   nvectors=         0

     2267     9756    4                 GOTO LOOP;

   9756  1 006205   006130 710000 1                  TRA     LOOP

     2268     9757    4               CASE(%KQDC_FETCH,%KQDC_RENEGE,%KQDC_DEL,%KQDC_GETFREE);

     2269     9758    4                 IF KQ$DFRBLK.ABORT THEN

   9758  1 006206   100001 236100                    LDQ     1,,PR1
         1 006207   100000 316007                    CANQ    32768,DL
         1 006210   006214 600000 1                  TZE     s:9763

     2270     9759    5                   DO;

     2271     9760    5                   CALL RELBLK;

   9760  1 006211   004244 701000 1                  TSX1    RELBLK
         1 006212   000000 011000                    NOP     0

     2272     9761    5                   GOTO LOOP;

   9761  1 006213   006130 710000 1                  TRA     LOOP

     2273     9762    5                   END;
     2274     9763    4                 DA=KQ$DFRBLK.DA;

   9763  1 006214   100002 235100                    LDA     2,,PR1
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:315  
         1 006215   200015 755100                    STA     DA,,AUTO

     2275     9764    4                 IF KQ$CG.IOHD$=ADDR(NIL) THEN

   9764  1 006216   000246 236100                    LDQ     166,,PR0
         1 006217   000001 116000 xsym               CMPQ    B_VECTNIL+1
         1 006220   006224 601000 1                  TNZ     s:9767

     2276     9765    4                   KQ$CG.IOHD$=DFR$;

   9765  1 006221   200007 236100                    LDQ     DFR$,,AUTO
         1 006222   000246 756100                    STQ     166,,PR0
         1 006223   006227 710000 1                  TRA     s:9768

     2277     9766    4                 ELSE
     2278     9767    4                   KQ$CG.IOTL$->KQ$DFRBLK.LNK$=DFR$;

   9767  1 006224   000247 473500                    LDP3    167,,PR0
         1 006225   200007 236100                    LDQ     DFR$,,AUTO
         1 006226   300000 756100                    STQ     0,,PR3

     2279     9768    4                 KQ$CG.IOTL$=DFR$;

   9768  1 006227   000247 756100                    STQ     167,,PR0

     2280     9769    4                 T$=KQ$CG.NEEDPGHD$; /* Move other requests for this */

   9769  1 006230   000250 236100                    LDQ     168,,PR0
         1 006231   200055 756100                    STQ     T$,,AUTO

     2281     9770    4                 P$=ADDR(NIL);        /* disk addr to IOHD$ */

   9770  1 006232   000001 236000 xsym               LDQ     B_VECTNIL+1
         1 006233   200054 756100                    STQ     P$,,AUTO

     2282     9771    5                   DO WHILE(T$~=ADDR(NIL));

PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:316  
   9771  1 006234   006277 710000 1                  TRA     s:9789

     2283     9772    5                   N$=T$->KQ$DFRBLK.LNK$;

   9772  1 006235   200055 470500                    LDP0    T$,,AUTO
         1 006236   000000 236100                    LDQ     0,,PR0
         1 006237   200056 756100                    STQ     N$,,AUTO

     2284     9773    5                   IF T$->KQ$DFRBLK.DA=DA THEN

   9773  1 006240   000002 236100                    LDQ     2,,PR0
         1 006241   200015 116100                    CMPQ    DA,,AUTO
         1 006242   006273 601000 1                  TNZ     s:9787

     2285     9774    6                     DO;

     2286     9775    6                     IF P$=ADDR(NIL) THEN

   9775  1 006243   200054 236100                    LDQ     P$,,AUTO
         1 006244   000001 116000 xsym               CMPQ    B_VECTNIL+1
         1 006245   006252 601000 1                  TNZ     s:9778

     2287     9776    6                       KQ$CG.NEEDPGHD$=T$->KQ$DFRBLK.LNK$;

   9776  1 006246   000000 236100                    LDQ     0,,PR0
         1 006247   200003 471500                    LDP1    @KQ$CG,,AUTO
         1 006250   100250 756100                    STQ     168,,PR1
         1 006251   006255 710000 1                  TRA     s:9779

     2288     9777    6                     ELSE
     2289     9778    6                       P$->KQ$DFRBLK.LNK$=T$->KQ$DFRBLK.LNK$;

   9778  1 006252   000000 236100                    LDQ     0,,PR0
         1 006253   200054 471500                    LDP1    P$,,AUTO
         1 006254   100000 756100                    STQ     0,,PR1

     2290     9779    6                     IF KQ$CG.NEEDPGTL$=T$ THEN
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:317  

   9779  1 006255   200003 471500                    LDP1    @KQ$CG,,AUTO
         1 006256   100251 236100                    LDQ     169,,PR1
         1 006257   200055 116100                    CMPQ    T$,,AUTO
         1 006260   006263 601000 1                  TNZ     s:9781

     2291     9780    6                       KQ$CG.NEEDPGTL$=P$;

   9780  1 006261   200054 236100                    LDQ     P$,,AUTO
         1 006262   100251 756100                    STQ     169,,PR1

     2292     9781    6                     KQ$CG.IOTL$->KQ$DFRBLK.LNK$=T$;

   9781  1 006263   100247 473500                    LDP3    167,,PR1
         1 006264   200055 236100                    LDQ     T$,,AUTO
         1 006265   300000 756100                    STQ     0,,PR3

     2293     9782    6                     KQ$CG.IOTL$=T$;

   9782  1 006266   100247 756100                    STQ     167,,PR1

     2294     9783    6                     T$->KQ$DFRBLK.LNK$=ADDR(NIL);

   9783  1 006267   000001 236000 xsym               LDQ     B_VECTNIL+1
         1 006270   000000 756100                    STQ     0,,PR0

     2295     9784    6                     KQ$CG.NEEDPGCNT=KQ$CG.NEEDPGCNT+1;

   9784  1 006271   100252 054100                    AOS     170,,PR1

     2296     9785    6                     END;

   9785  1 006272   006275 710000 1                  TRA     s:9788

     2297     9786    5                   ELSE
     2298     9787    5                     P$=T$;

PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:318  
   9787  1 006273   200055 236100                    LDQ     T$,,AUTO
         1 006274   200054 756100                    STQ     P$,,AUTO

     2299     9788    5                   T$=N$;

   9788  1 006275   200056 236100                    LDQ     N$,,AUTO
         1 006276   200055 756100                    STQ     T$,,AUTO

     2300     9789    5                   END;

   9789  1 006277   200055 236100                    LDQ     T$,,AUTO
         1 006300   000001 116000 xsym               CMPQ    B_VECTNIL+1
         1 006301   006235 601000 1                  TNZ     s:9772

     2301     9790                      %UNLOCK (G=KQ$CG.DTREE.GATE);

   9791  1 006302   200003 236100                    LDQ     @KQ$CG,,AUTO
         1 006303   000231 036003                    ADLQ    153,DU
         1 006304   200112 756100                    STQ     I$+1,,AUTO
         1 006305   200112 630500                    EPPR0   I$+1,,AUTO
         1 006306   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 006307   000000 701000 xent               TSX1    HFC$UNLOCK
         1 006310   000000 011000                    NOP     0

     2302     9793    4                 CALL READGRAN5;

   9793  1 006311   004524 701000 1                  TSX1    READGRAN5
         1 006312   000000 011000                    NOP     0

     2303     9794    4             END;

     2304     9795    3           IF KQ$CG.NEEDPGHD$=ADDR(NIL) AND KQ$CG.DELAY.NEEDPG THEN

   9795  1 006313   200003 470500                    LDP0    @KQ$CG,,AUTO
         1 006314   000250 236100                    LDQ     168,,PR0
         1 006315   000001 116000 xsym               CMPQ    B_VECTNIL+1
         1 006316   006346 601000 1                  TNZ     s:9806
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:319  
         1 006317   000020 236100                    LDQ     16,,PR0
         1 006320   040000 316003                    CANQ    16384,DU
         1 006321   006346 600000 1                  TZE     s:9806

     2305     9796    4             DO;

     2306     9797                  %LOCK (G=KQ$CG.GATE.CG);

   9798  1 006322   200003 236100                    LDQ     @KQ$CG,,AUTO
         1 006323   000107 036003                    ADLQ    71,DU
         1 006324   200112 756100                    STQ     I$+1,,AUTO
         1 006325   200112 630500                    EPPR0   I$+1,,AUTO
         1 006326   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 006327   000000 701000 xent               TSX1    HFC$LOCK
         1 006330   000000 011000                    NOP     0

     2307     9800    4             IF KQ$CG.NEEDPGHD$=ADDR(NIL) THEN

   9800  1 006331   200003 470500                    LDP0    @KQ$CG,,AUTO
         1 006332   000250 236100                    LDQ     168,,PR0
         1 006333   000001 116000 xsym               CMPQ    B_VECTNIL+1
         1 006334   006337 601000 1                  TNZ     s:9803

     2308     9801    4               KQ$CG.DELAY.NEEDPG='0'B;

   9801  1 006335   000044 236000 2                  LDQ     36
         1 006336   000020 356100                    ANSQ    16,,PR0

     2309     9802                  %UNLOCK (G=KQ$CG.GATE.CG);

   9803  1 006337   200003 236100                    LDQ     @KQ$CG,,AUTO
         1 006340   000107 036003                    ADLQ    71,DU
         1 006341   200112 756100                    STQ     I$+1,,AUTO
         1 006342   200112 630500                    EPPR0   I$+1,,AUTO
         1 006343   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 006344   000000 701000 xent               TSX1    HFC$UNLOCK
         1 006345   000000 011000                    NOP     0
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:320  

     2310     9805    4             END;

     2311     9806    3           DFR$=TDFR$;

   9806  1 006346   200053 236100                    LDQ     TDFR$,,AUTO
         1 006347   200007 756100                    STQ     DFR$,,AUTO

     2312     9807    3           ALTRETURN;

   9807  1 006350   200052 221300                    LDX1  ! LDGRAN$+2,,AUTO
         1 006351   000000 702211                    TSX2  ! 0,X1

     2313     9808    3           END;
     2314     9809    2         ELSE
     2315     9810    2           IF KQ$CG.CURDATAPGS<=KQ$CG.MINDATAPGS THEN

   9810  1 006352   000241 720100                    LXL0    161,,PR0
         1 006353   000242 100100                    CMPX0   162,,PR0
         1 006354   006356 600000 1                  TZE     KEEPIT
         1 006355   006365 603000 1                  TRC     s:9817

     2316     9811    3   KEEPIT:   DO;

   9811  1 006356                       KEEPIT       null
     2317     9812    3             KQ$DGRAN.FLINK$=KQ$CG.DATAFREE$;

   9812  1 006356   200003 470500                    LDP0    @KQ$CG,,AUTO
         1 006357   000243 236100                    LDQ     163,,PR0
         1 006360   200011 471500                    LDP1    DGRAN$,,AUTO
         1 006361   100017 756100                    STQ     15,,PR1

     2318     9813    3             KQ$CG.DATAFREE$=DGRAN$;

   9813  1 006362   200011 236100                    LDQ     DGRAN$,,AUTO
         1 006363   000243 756100                    STQ     163,,PR0

PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:321  
     2319     9814    3             END;

   9814  1 006364   006412 710000 1                  TRA     s:9823

     2320     9815    2           ELSE
     2321     9816    3             DO;

     2322     9817    3             IF  KQ$CG.CURDATAPGS = 2

   9817  1 006365   000002 100003                    CMPX0   2,DU
         1 006366   006372 601000 1                  TNZ     s:9819
         1 006367   000122 236100                    LDQ     82,,PR0
         1 006370   777000 316007                    CANQ    -512,DL
         1 006371   006356 601000 1                  TNZ     KEEPIT

     2323     9818    3             AND KQ$CG.FWUSR# ~= 0 THEN GOTO KEEPIT;
     2324     9819    3             LDGRAN$=DGRAN$; DGRAN$=ADDR(NIL);

   9819  1 006372   200011 236100                    LDQ     DGRAN$,,AUTO
         1 006373   200050 756100                    STQ     LDGRAN$,,AUTO

   9819  1 006374   000001 236000 xsym               LDQ     B_VECTNIL+1
         1 006375   200011 756100                    STQ     DGRAN$,,AUTO

     2325     9820    3             CALL KQM$RELP(KQ$CG,LDGRAN$);

   9820  1 006376   200050 631500                    EPPR1   LDGRAN$,,AUTO
         1 006377   200113 451500                    STP1    I$+2,,AUTO
         1 006400   200003 236100                    LDQ     @KQ$CG,,AUTO
         1 006401   200112 756100                    STQ     I$+1,,AUTO
         1 006402   200112 630500                    EPPR0   I$+1,,AUTO
         1 006403   000020 631400 xsym               EPPR1   B_VECTNIL+16
         1 006404   000000 701000 xent               TSX1    KQM$RELP
         1 006405   000000 011000                    NOP     0

     2326     9821    3             KQ$CG.CURDATAPGS=KQ$CG.CURDATAPGS-1;

PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:322  
   9821  1 006406   200003 470500                    LDP0    @KQ$CG,,AUTO
         1 006407   000241 720100                    LXL0    161,,PR0
         1 006410   777777 621010                    EAX1    -1,X0
         1 006411   000241 441100                    SXL1    161,,PR0

     2327     9822    3             END;

     2328     9823    2         DFR$=TDFR$;

   9823  1 006412   200053 236100                    LDQ     TDFR$,,AUTO
         1 006413   200007 756100                    STQ     DFR$,,AUTO

     2329     9824    2         RETURN;

   9824  1 006414   200052 221300                    LDX1  ! LDGRAN$+2,,AUTO
         1 006415   000001 702211                    TSX2  ! 1,X1

   9823  1 006416                       TRYAGAIN     null
     2330     9825        /**/
     2331     9826    2   TRYAGAIN: ;
     2332     9827              %LOCK (G=KQ$CG.DTREE.GATE);

   9828  1 006416   200003 236100                    LDQ     @KQ$CG,,AUTO
         1 006417   000231 036003                    ADLQ    153,DU
         1 006420   200112 756100                    STQ     I$+1,,AUTO
         1 006421   200112 630500                    EPPR0   I$+1,,AUTO
         1 006422   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 006423   000000 701000 xent               TSX1    HFC$LOCK
         1 006424   000000 011000                    NOP     0

     2333     9830    2         GOTO LOOP;

   9830  1 006425   006130 710000 1                  TRA     LOOP

     2334     9831        /**/
     2335     9832    2   END RELPAGE;
     2336     9833        %EJECT;
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:323  
     2337     9834
     2338     9835
     2339     9836        /*D* NAME:         COMP
     2340     9837
     2341     9838             CALL:         CALL COMP;
     2342     9839
     2343     9840             INPUT:        DFR$ - Ptr to defer block to comp
     2344     9841
     2345     9842             DESCRIPTION:  The indicated defer block is comp'ed.  If both
     2346     9843                           EVNT and GO are set (indicating that both the
     2347     9844                           operation and DEFERGO are complete) then
     2348     9845                           something is done.  If there is an EPTR, it
     2349     9846                           is called.  If there is a user number, the
     2350     9847                           user is awakened.  If neither, the block is
     2351     9848                           released.
     2352     9849
     2353     9850                           COMP must be called with the DTREE gate locked.
     2354     9851                           The gate will be unlocked before returning.
     2355     9852
     2356     9853        */
     2357     9854
     2358     9855
     2359     9856    1   COMP: PROC;

   9856  1 006426   200066 741300       COMP         STX1  ! P$+1,,AUTO

     2360     9857
     2361     9858    2   COMP0:
     2362     9859
     2363     9860    2         IF KQ$DFRBLK.GO AND KQ$DFRBLK.EVNT THEN

   9860  1 006427   200007 470500       COMP0        LDP0    DFR$,,AUTO
         1 006430   000001 236100                    LDQ     1,,PR0
         1 006431   400000 316007                    CANQ    -131072,DL
         1 006432   006567 600000 1                  TZE     s:9907
         1 006433   200000 316007                    CANQ    65536,DL
         1 006434   006567 600000 1                  TZE     s:9907
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:324  

     2364     9861    2           IF KQ$DFRBLK.EPTR$~=ENTADDR(NIL) THEN

   9861  1 006435   000005 236100                    LDQ     5,,PR0
         1 006436   000002 116000 xsym               CMPQ    B_VECTNIL+2
         1 006437   006525 600000 1                  TZE     s:9887

     2365     9862    3             DO;

     2366     9863    3             IF NI$DS>1 OR H_GATECNT>1 THEN

   9863  1 006440   000000 235000 xsym               LDA     NI$DS
         1 006441   000002 115007                    CMPA    2,DL
         1 006442   006446 603000 1                  TRC     COMP1
         1 006443   000000 235000 xsym               LDA     H_GATECNT
         1 006444   000002 115007                    CMPA    2,DL
         1 006445   006467 602000 1                  TNC     COMP2

     2367     9864    4   COMP1:      DO;  /* Other gates are locked - can't call handler */

   9864  1 006446                       COMP1        null
     2368     9865    4               KQ$DFRBLK.LNK$=KQ$CG.DFRDFR$;

   9865  1 006446   200003 470500                    LDP0    @KQ$CG,,AUTO
         1 006447   000026 236100                    LDQ     22,,PR0
         1 006450   200007 471500                    LDP1    DFR$,,AUTO
         1 006451   100000 756100                    STQ     0,,PR1

     2369     9866    4               KQ$CG.DFRDFR$=DFR$;

   9866  1 006452   200007 236100                    LDQ     DFR$,,AUTO
         1 006453   000026 756100                    STQ     22,,PR0

     2370     9867    4               KQ$CG.BASEDELAY=KQ$CG.BASEDELAY+1;

   9867  1 006454   000025 054100                    AOS     21,,PR0

PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:325  
     2371     9868    4               KQ_BASEDELAY=KQ_BASEDELAY+1;

   9868  1 006455   000000 054000 xsym               AOS     KQ_BASEDELAY

     2372     9869                    %UNLOCK (G=KQ$CG.DTREE.GATE);

   9870  1 006456   200003 236100                    LDQ     @KQ$CG,,AUTO
         1 006457   000231 036003                    ADLQ    153,DU
         1 006460   200112 756100                    STQ     I$+1,,AUTO
         1 006461   200112 630500                    EPPR0   I$+1,,AUTO
         1 006462   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 006463   000000 701000 xent               TSX1    HFC$UNLOCK
         1 006464   000000 011000                    NOP     0

     2373     9872    4               RETURN;

   9872  1 006465   200066 221300                    LDX1  ! P$+1,,AUTO
         1 006466   000001 702211                    TSX2  ! 1,X1

     2374     9873    4               END;
     2375     9874    3   COMP2:    ;

   9874  1 006467                       COMP2        null
     2376     9875    3             KQ$DFRPARM.INFO=KQ$DFRBLK.INFO;

   9875  1 006467   200007 470500                    LDP0    DFR$,,AUTO
         1 006470   000006 235100                    LDA     6,,PR0
         1 006471   200032 755100                    STA     KQ$DFRPARM,,AUTO

     2377     9876    3             KQ$DFRPARM.DBLK$=KQ$DFRBLK.DBLK$;

   9876  1 006472   000003 236100                    LDQ     3,,PR0
         1 006473   200033 756100                    STQ     KQ$DFRPARM+1,,AUTO

     2378     9877    3             KQ$DFRPARM.DDA=KQ$DFRBLK.DDA;

   9877  1 006474   000004 235100                    LDA     4,,PR0
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:326  
         1 006475   200034 755100                    STA     KQ$DFRPARM+2,,AUTO

     2379     9878    3             KQ$DFRPARM.ERR=KQ$DFRBLK.ERRCODE;

   9878  1 006476   000001 236100                    LDQ     1,,PR0
         1 006477   000022 772000                    QRL     18
         1 006500   000777 376007                    ANQ     511,DL
         1 006501   200036 756100                    STQ     KQ$DFRPARM+4,,AUTO

     2380     9879    3             EPTR$=KQ$DFRBLK.EPTR$;

   9879  1 006502   000005 236100                    LDQ     5,,PR0
         1 006503   200037 756100                    STQ     EPTR$,,AUTO

     2381     9880    3             CALL RELBLK;

   9880  1 006504   004244 701000 1                  TSX1    RELBLK
         1 006505   000000 011000                    NOP     0

     2382     9881                  %UNLOCK (G=KQ$CG.DTREE.GATE);

   9882  1 006506   200003 236100                    LDQ     @KQ$CG,,AUTO
         1 006507   000231 036003                    ADLQ    153,DU
         1 006510   200112 756100                    STQ     I$+1,,AUTO
         1 006511   200112 630500                    EPPR0   I$+1,,AUTO
         1 006512   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 006513   000000 701000 xent               TSX1    HFC$UNLOCK
         1 006514   000000 011000                    NOP     0

     2383     9884    3             CALL EPTR$(KQ$DFRPARM);

   9884  1 006515   200032 630500                    EPPR0   KQ$DFRPARM,,AUTO
         1 006516   200112 450500                    STP0    I$+1,,AUTO
         1 006517   200112 630500                    EPPR0   I$+1,,AUTO
         1 006520   200037 220100                    LDX0    EPTR$,,AUTO
         1 006521   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 006522   000000 701010                    TSX1    0,X0
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:327  
         1 006523   000000 011000                    NOP     0

     2384     9885    3             END;

   9885  1 006524   006576 710000 1                  TRA     RET

     2385     9886    2           ELSE
     2386     9887    2             IF KQ$DFRBLK.USR~=0 THEN

   9887  1 006525   000001 236100                    LDQ     1,,PR0
         1 006526   000777 316007                    CANQ    511,DL
         1 006527   006550 600000 1                  TZE     s:9896

     2387     9888    3               DO;

     2388     9889                    %UNLOCK (G=KQ$CG.DTREE.GATE);

   9890  1 006530   200003 236100                    LDQ     @KQ$CG,,AUTO
         1 006531   000231 036003                    ADLQ    153,DU
         1 006532   200112 756100                    STQ     I$+1,,AUTO
         1 006533   200112 630500                    EPPR0   I$+1,,AUTO
         1 006534   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 006535   000000 701000 xent               TSX1    HFC$UNLOCK
         1 006536   000000 011000                    NOP     0

     2389     9892    3               CALL SSR$RUE(%SS_UQA,KQ$DFRBLK.USR);

   9892  1 006537   200007 236100                    LDQ     DFR$,,AUTO
         1 006540   000046 036000 2                  ADLQ    38
         1 006541   000047 235000 2                  LDA     39
         1 006542   200112 757100                    STAQ    I$+1,,AUTO
         1 006543   200112 630500                    EPPR0   I$+1,,AUTO
         1 006544   000020 631400 xsym               EPPR1   B_VECTNIL+16
         1 006545   000000 701000 xent               TSX1    SSR$RUE
         1 006546   000000 011000                    NOP     0

     2390     9893    3               END;
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:328  

   9893  1 006547   006576 710000 1                  TRA     RET

     2391     9894    2             ELSE
     2392     9895    3               DO;

     2393     9896    3               CALL UNDOIT ALTRET(NDUC);

   9896  1 006550   006622 701000 1                  TSX1    UNDOIT
         1 006551   006555 702000 1                  TSX2    NDUC

     2394     9897    3               KQ$DGRAN.USECNT=KQ$DGRAN.USECNT-1;

   9897  1 006552   200011 470500                    LDP0    DGRAN$,,AUTO
         1 006553   000001 336007                    LCQ     1,DL
         1 006554   000013 056100                    ASQ     11,,PR0

   9897  1 006555                       NDUC         null
     2395     9898    3   NDUC:       ;
     2396     9899    3               CALL RELBLK;

   9899  1 006555   004244 701000 1                  TSX1    RELBLK
         1 006556   000000 011000                    NOP     0

     2397     9900                    %UNLOCK (G=KQ$CG.DTREE.GATE);

   9901  1 006557   200003 236100                    LDQ     @KQ$CG,,AUTO
         1 006560   000231 036003                    ADLQ    153,DU
         1 006561   200112 756100                    STQ     I$+1,,AUTO
         1 006562   200112 630500                    EPPR0   I$+1,,AUTO
         1 006563   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 006564   000000 701000 xent               TSX1    HFC$UNLOCK
         1 006565   000000 011000                    NOP     0

     2398     9903    3               END;

   9903  1 006566   006576 710000 1                  TRA     RET
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:329  

     2399     9904    2         ELSE
     2400     9905    3           DO;

     2401     9906                %UNLOCK (G=KQ$CG.DTREE.GATE);

   9907  1 006567   200003 236100                    LDQ     @KQ$CG,,AUTO
         1 006570   000231 036003                    ADLQ    153,DU
         1 006571   200112 756100                    STQ     I$+1,,AUTO
         1 006572   200112 630500                    EPPR0   I$+1,,AUTO
         1 006573   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 006574   000000 701000 xent               TSX1    HFC$UNLOCK
         1 006575   000000 011000                    NOP     0

     2402     9909    3           END;

   9905  1 006576                       RET          null
     2403     9910    2   RET:  ;
     2404     9911    2         RETURN;

   9911  1 006576   200066 221300                    LDX1  ! P$+1,,AUTO
         1 006577   000001 702211                    TSX2  ! 1,X1

     2405     9912        /**/
     2406     9913    2   COMPDFR: ENTRY;

   9913  1 006600   200066 741300       COMPDFR      STX1  ! P$+1,,AUTO

     2407     9914        /**/
     2408     9915    2         GOTO COMP2;

   9915  1 006601   006467 710000 1                  TRA     COMP2

     2409     9916        /**/
     2410     9917    2   COMPLATER: ENTRY;

   9917  1 006602   200066 741300       COMPLATER    STX1  ! P$+1,,AUTO
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:330  

     2411     9918        /**/
     2412     9919    2         IF KQ$DFRBLK.GO AND KQ$DFRBLK.EVNT AND KQ$DFRBLK.EPTR$~=ENTADDR(NIL) THEN

   9919  1 006603   200007 470500                    LDP0    DFR$,,AUTO
         1 006604   000001 236100                    LDQ     1,,PR0
         1 006605   400000 316007                    CANQ    -131072,DL
         1 006606   006614 600000 1                  TZE     s:9921
         1 006607   200000 316007                    CANQ    65536,DL
         1 006610   006614 600000 1                  TZE     s:9921
         1 006611   000005 236100                    LDQ     5,,PR0
         1 006612   000002 116000 xsym               CMPQ    B_VECTNIL+2
         1 006613   006446 601000 1                  TNZ     COMP1

     2413     9920    2           GOTO COMP1;  /* Don't comp if EPTR - may blow TSTACK */
     2414     9921    2         GOTO COMP0;

   9921  1 006614   006427 710000 1                  TRA     COMP0

     2415     9922        /**/
     2416     9923    2   COMPRCVR: ENTRY; /* Called during KQD$RECOVER to fix stuff */

   9923  1 006615   200066 741300       COMPRCVR     STX1  ! P$+1,,AUTO

     2417     9924                         /* left on the DFRDFR chain               */
     2418     9925    2         CALL UNDOIT;

   9925  1 006616   006622 701000 1                  TSX1    UNDOIT
         1 006617   000000 011000                    NOP     0

     2419     9926    2         RETURN;

   9926  1 006620   200066 221300                    LDX1  ! P$+1,,AUTO
         1 006621   000001 702211                    TSX2  ! 1,X1

     2420     9927        /**/
     2421     9928        /**/
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:331  
     2422     9929    2   UNDOIT: PROC ALTRET;

   9929  1 006622   200070 741300       UNDOIT       STX1  ! Q$,,AUTO

     2423     9930        /**/
     2424     9931    3         DBLK$=KQ$DFRBLK.DBLK$;

   9931  1 006623   200007 470500                    LDP0    DFR$,,AUTO
         1 006624   000003 236100                    LDQ     3,,PR0
         1 006625   200006 756100                    STQ     DBLK$,,AUTO

     2425     9932    3         IF DBLK$ = ADDR(NIL) THEN ALTRETURN;

   9932  1 006626   000001 116000 xsym               CMPQ    B_VECTNIL+1
         1 006627   006631 601000 1                  TNZ     s:9933

   9932  1 006630   000000 702211                    TSX2  ! 0,X1

     2426     9933    3         DGRAN$=DBLK$;

   9933  1 006631   200011 756100                    STQ     DGRAN$,,AUTO

     2427     9934    3         DGRAN.DISP=0;

   9934  1 006632   000010 236000 2                  LDQ     8
         1 006633   200011 356100                    ANSQ    DGRAN$,,AUTO

     2428     9935    4           DO CASE(KQ$DFRBLK.CODE);

   9935  1 006634   000001 236100                    LDQ     1,,PR0
         1 006635   000033 772000                    QRL     27
         1 006636   000006 116007                    CMPQ    6,DL
         1 006637   006641 602006 1                  TNC     s:9935+5,QL
         1 006640   006702 710000 1                  TRA     s:9946
         1 006641   006702 710000 1                  TRA     s:9946
         1 006642   006647 710000 1                  TRA     s:9937
         1 006643   006702 710000 1                  TRA     s:9946
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:332  
         1 006644   006702 710000 1                  TRA     s:9946
         1 006645   006702 710000 1                  TRA     s:9946
         1 006646   006653 710000 1                  TRA     s:9939

     2429     9936    4             CASE(%KQDC_FETCH);

     2430     9937    4               KQ$DBLK.LOCK='0'B;

   9937  1 006647   200006 471500                    LDP1    DBLK$,,AUTO
         1 006650   000020 236000 2                  LDQ     16
         1 006651   100003 356100                    ANSQ    3,,PR1
         1 006652   006704 710000 1                  TRA     s:9948

     2431     9938    4             CASE(%KQDC_GET);

     2432     9939    4               KQ$DBLK.LINKX=KQ$DGRAN.AVAILX;

   9939  1 006653   200011 471500                    LDP1    DGRAN$,,AUTO
         1 006654   100014 720100                    LXL0    12,,PR1
         1 006655   200006 473500                    LDP3    DBLK$,,AUTO
         1 006656   300003 440100                    SXL0    3,,PR3

     2433     9940    4               KQ$DGRAN.AVAILX=POFFW(DBLK$,DGRAN$);

   9940  1 006657   200011 235100                    LDA     DGRAN$,,AUTO
         1 006660   000022 771000                    ARL     18
         1 006661   200112 755100                    STA     I$+1,,AUTO
         1 006662   200006 236100                    LDQ     DBLK$,,AUTO
         1 006663   000022 772000                    QRL     18
         1 006664   200112 136100                    SBLQ    I$+1,,AUTO
         1 006665   100014 756100                    STQ     12,,PR1

     2434     9941    4               KQ$DBLK.ACTIVE='0'B;

   9941  1 006666   000024 236000 2                  LDQ     20
         1 006667   300003 356100                    ANSQ    3,,PR3

PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:333  
     2435     9942    4               KQ$DBLK.LOCK='0'B;

   9942  1 006670   000020 236000 2                  LDQ     16
         1 006671   300003 356100                    ANSQ    3,,PR3

     2436     9943    4               KQ$DBLK.LREL='0'B;

   9943  1 006672   000011 236000 2                  LDQ     9
         1 006673   300003 356100                    ANSQ    3,,PR3

     2437     9944    4               CALL COUNT_WORDS(%ADD,%ADD);

   9944  1 006674   000000 236000 2                  LDQ     0
         1 006675   200104 756100                    STQ     @FREE,,AUTO
         1 006676   200103 756100                    STQ     ADDFLG,,AUTO
         1 006677   002215 701000 1                  TSX1    COUNT_WORDS
         1 006700   000000 011000                    NOP     0
         1 006701   006704 710000 1                  TRA     s:9948

     2438     9945    4             CASE(ELSE);

     2439     9946    4               CALL SC_CGCACHE;

   9946  1 006702   000000 713400 xsym               CLIMB   SC_CGCACHE
         1 006703   000000 600000 xsid               climb   nvectors=         0

     2440     9947    4           END;

     2441     9948    3         RETURN;

   9948  1 006704   200070 221300                    LDX1  ! Q$,,AUTO
         1 006705   000001 702211                    TSX2  ! 1,X1

     2442     9949    3   END UNDOIT;
     2443     9950    2   END COMP;
     2444     9951        %EJECT;
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:334  
     2445     9952
     2446     9953
     2447     9954        /*F* NAME:         KQD$COMP
     2448     9955
     2449     9956             PURPOSE:      Do COMP processing for defer blocks that could
     2450     9957                           not be COMPed when their request was satified
     2451     9958
     2452     9959        */
     2453     9960
     2454     9961
     2455     9962
     2456     9963        /*D* NAME:         KQD$COMP
     2457     9964
     2458     9965             CALL:         CALL KQD$COMP(KQ$CG);
     2459     9966
     2460     9967             INPUT:        KQ$CG - Context block
     2461     9968
     2462     9969             DESCRIPTION:  The list of defer blocks headed by KQ$CG.DFRDFR$
     2463     9970                           is COMPed by calling COMPDFR for each.
     2464     9971
     2465     9972        */
     2466     9973
     2467     9974
     2468     9975    1   KQD$COMP: ENTRY(KQ$CG) ALTRET;

   9975  1 006706   000000 700200 xent  KQD$COMP     TSX0  ! X66_AUTO_3
         1 006707   000122 000003                    ZERO    82,3

     2469     9976
     2470     9977    2           DO WHILE('1'B);

     2471     9978                %LOCK (G=KQ$CG.DTREE.GATE);

   9979  1 006710   200003 236100                    LDQ     @KQ$CG,,AUTO
         1 006711   000231 036003                    ADLQ    153,DU
         1 006712   200112 756100                    STQ     I$+1,,AUTO
         1 006713   200112 630500                    EPPR0   I$+1,,AUTO
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:335  
         1 006714   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 006715   000000 701000 xent               TSX1    HFC$LOCK
         1 006716   000000 011000                    NOP     0

     2472     9981    2           IF KQ$CG.DFRDFR$=ADDR(NIL) THEN

   9981  1 006717   200003 470500                    LDP0    @KQ$CG,,AUTO
         1 006720   000026 236100                    LDQ     22,,PR0
         1 006721   000001 116000 xsym               CMPQ    B_VECTNIL+1
         1 006722   006733 601000 1                  TNZ     s:9988

     2473     9982    3             DO;

     2474     9983                  %UNLOCK (G=KQ$CG.DTREE.GATE);

   9984  1 006723   200003 236100                    LDQ     @KQ$CG,,AUTO
         1 006724   000231 036003                    ADLQ    153,DU
         1 006725   200112 756100                    STQ     I$+1,,AUTO
         1 006726   200112 630500                    EPPR0   I$+1,,AUTO
         1 006727   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 006730   000000 701000 xent               TSX1    HFC$UNLOCK
         1 006731   000000 011000                    NOP     0

     2475     9986    3             RETURN;

   9986  1 006732   000000 702200 xent               TSX2  ! X66_ARET

     2476     9987    3             END;
     2477     9988    2           DFR$=KQ$CG.DFRDFR$;

   9988  1 006733   200007 756100                    STQ     DFR$,,AUTO

     2478     9989    2           KQ$CG.DFRDFR$=KQ$DFRBLK.LNK$;

   9989  1 006734   200007 471500                    LDP1    DFR$,,AUTO
         1 006735   100000 236100                    LDQ     0,,PR1
         1 006736   000026 756100                    STQ     22,,PR0
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:336  

     2479     9990    2           CALL COMPDFR;

   9990  1 006737   006600 701000 1                  TSX1    COMPDFR
         1 006740   000000 011000                    NOP     0

     2480     9991    2           END;

   9991  1 006741   006710 710000 1                  TRA     s:9979

     2481     9992        %EJECT;
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:337  
     2482     9993
     2483     9994
     2484     9995        /*F* NAME:         KQD$RECOVER
     2485     9996
     2486     9997             PURPOSE:      Recover those parts of the comgroup queue controlled
     2487     9998                           by KQD after a recovery.
     2488     9999
     2489    10000        */
     2490    10001
     2491    10002
     2492    10003
     2493    10004        /*D* NAME:         KQD$RECOVER
     2494    10005
     2495    10006             CALL:         CALL KQD$RECOVER(KQ$CG) ALTRET(CANNOTOPEN)
     2496    10007
     2497    10008             INPUT:        KQ$CG - Context block
     2498    10009
     2499    10010             ENVIRONMENT:  On behalf of user.
     2500    10011                           KCC$CLOCK not enabled.
     2501    10012                           Garbage collector not running.
     2502    10013                           Comgroup only open to one user (us).
     2503    10014
     2504    10015             DESCRIPTION:  The data cache pages present when the comgroup
     2505    10016                           was closed have already been placed in the
     2506    10017                           DTREE by comgroup reopen (as part of the process
     2507    10018                           of reading in the memory pages).  For each page,
     2508    10019                           the global flags have been zapped (e.g. USECNT).
     2509    10020
     2510    10021                           The job of this routine is to clean up everything
     2511    10022                           else.
     2512    10023
     2513    10024                           This routine performs the following:
     2514    10025
     2515    10026                           o    Clean up the free defer block chain.  This
     2516    10027                                is done by zapping NDFRBLKS, and then
     2517    10028                                incrementing it by the number actually
     2518    10029                                present on the free chain.  NDFRBLKS will
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:338  
     2519    10030                                be corrected later in the process as we
     2520    10031                                release more of them
     2521    10032                           o    Clean up the various chains of active
     2522    10033                                defer blocks.  These are the
     2523    10034                                      - I/O chain (IOHD$)
     2524    10035                                      - Need page chain (NEEDPGHD$)
     2525    10036                                      - GET chain (GETHD$)
     2526    10037                                      - Need IOQ packet chain (IOQHD$)
     2527    10038                                      - Awaiting-COMP chain (DFRDFR$)
     2528    10039                                This is done by running each chain and
     2529    10040                                doing the appropriate thing for each
     2530    10041                                of its members.
     2531    10042                           o    Each DBLK that has been fetched or GETted
     2532    10043                                and was caught by the crash while still locked
     2533    10044                                into the cache is UNLOCKed
     2534    10045
     2535    10046        */
     2536    10047
     2537    10048
     2538    10049    1   KQD$RECOVER: ENTRY(KQ$CG) ALTRET;

  10049  1 006742   000000 700200 xent  KQD$RECOVER  TSX0  ! X66_AUTO_3
         1 006743   000122 000003                    ZERO    82,3

     2539    10050
     2540    10051    1         KQ$CG.NDFRBLKS=0;

  10051  1 006744   200003 470500                    LDP0    @KQ$CG,,AUTO
         1 006745   000000 236003                    LDQ     0,DU
         1 006746   000225 552140                    STBQ    149,'40'O,PR0

     2541    10052    1         DFR$=KQ$CG.DFRFREEHD$;

  10052  1 006747   000230 236100                    LDQ     152,,PR0
         1 006750   200007 756100                    STQ     DFR$,,AUTO

     2542    10053    1         KQ$CG.DFRFREETL$=ADDR(NIL);
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:339  

  10053  1 006751   000001 236000 xsym               LDQ     B_VECTNIL+1
         1 006752   000263 756100                    STQ     179,,PR0

     2543    10054    2           DO WHILE(DFR$~=ADDR(NIL));

  10054  1 006753   006765 710000 1                  TRA     s:10058

     2544    10055    2           KQ$CG.NDFRBLKS=KQ$CG.NDFRBLKS+1;

  10055  1 006754   200003 470500                    LDP0    @KQ$CG,,AUTO
         1 006755   000225 236100                    LDQ     149,,PR0
         1 006756   001000 036003                    ADLQ    512,DU
         1 006757   000225 552140                    STBQ    149,'40'O,PR0

     2545    10056    2           KQ$CG.DFRFREETL$=DFR$;

  10056  1 006760   200007 236100                    LDQ     DFR$,,AUTO
         1 006761   000263 756100                    STQ     179,,PR0

     2546    10057    2           DFR$=KQ$DFRBLK.LNK$;

  10057  1 006762   200007 471500                    LDP1    DFR$,,AUTO
         1 006763   100000 236100                    LDQ     0,,PR1
         1 006764   200007 756100                    STQ     DFR$,,AUTO

     2547    10058    2           END;

  10058  1 006765   200007 236100                    LDQ     DFR$,,AUTO
         1 006766   000001 116000 xsym               CMPQ    B_VECTNIL+1
         1 006767   006754 601000 1                  TNZ     s:10055

     2548    10059        /**/
     2549    10060    1         CALL RCVCHAIN (KQ$CG.IOHD$);

  10060  1 006770   200003 236100                    LDQ     @KQ$CG,,AUTO
         1 006771   000246 036003                    ADLQ    166,DU
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:340  
         1 006772   200053 756100                    STQ     LDGRAN$+3,,AUTO
         1 006773   007121 701000 1                  TSX1    RCVCHAIN
         1 006774   000000 011000                    NOP     0

     2550    10061    1         KQ$CG.IOTL$=ADDR(NIL);

  10061  1 006775   000001 236000 xsym               LDQ     B_VECTNIL+1
         1 006776   200003 470500                    LDP0    @KQ$CG,,AUTO
         1 006777   000247 756100                    STQ     167,,PR0

     2551    10062    1         CALL RCVCHAIN (KQ$CG.NEEDPGHD$);

  10062  1 007000   200003 236100                    LDQ     @KQ$CG,,AUTO
         1 007001   000250 036003                    ADLQ    168,DU
         1 007002   200053 756100                    STQ     LDGRAN$+3,,AUTO
         1 007003   007121 701000 1                  TSX1    RCVCHAIN
         1 007004   000000 011000                    NOP     0

     2552    10063    1         KQ$CG.NEEDPGTL$=ADDR(NIL);

  10063  1 007005   000001 236000 xsym               LDQ     B_VECTNIL+1
         1 007006   200003 470500                    LDP0    @KQ$CG,,AUTO
         1 007007   000251 756100                    STQ     169,,PR0

     2553    10064    1         CALL RCVCHAIN (KQ$CG.IOQHD$);

  10064  1 007010   200003 236100                    LDQ     @KQ$CG,,AUTO
         1 007011   000261 036003                    ADLQ    177,DU
         1 007012   200053 756100                    STQ     LDGRAN$+3,,AUTO
         1 007013   007121 701000 1                  TSX1    RCVCHAIN
         1 007014   000000 011000                    NOP     0

     2554    10065    1         KQ$CG.IOQTL$=ADDR(NIL);

  10065  1 007015   000001 236000 xsym               LDQ     B_VECTNIL+1
         1 007016   200003 470500                    LDP0    @KQ$CG,,AUTO
         1 007017   000262 756100                    STQ     178,,PR0
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:341  

     2555    10066    1         CALL RCVCHAIN (KQ$CG.GETHD$);

  10066  1 007020   200003 236100                    LDQ     @KQ$CG,,AUTO
         1 007021   000257 036003                    ADLQ    175,DU
         1 007022   200053 756100                    STQ     LDGRAN$+3,,AUTO
         1 007023   007121 701000 1                  TSX1    RCVCHAIN
         1 007024   000000 011000                    NOP     0

     2556    10067    1         KQ$CG.GETTL$=ADDR(NIL);

  10067  1 007025   000001 236000 xsym               LDQ     B_VECTNIL+1
         1 007026   200003 470500                    LDP0    @KQ$CG,,AUTO
         1 007027   000260 756100                    STQ     176,,PR0

     2557    10068        /**/
     2558    10069    2           DO WHILE (KQ$CG.DFRDFR$ ~= ADDR(NIL));

  10069  1 007030   007065 710000 1                  TRA     s:10082

     2559    10070    2           DFR$=KQ$CG.DFRDFR$;

  10070  1 007031   200003 470500                    LDP0    @KQ$CG,,AUTO
         1 007032   000026 236100                    LDQ     22,,PR0
         1 007033   200007 756100                    STQ     DFR$,,AUTO

     2560    10071    3             DO CASE (KQ$DFRBLK.CODE);

  10071  1 007034   200007 471500                    LDP1    DFR$,,AUTO
         1 007035   100001 236100                    LDQ     1,,PR1
         1 007036   000033 772000                    QRL     27
         1 007037   000006 116007                    CMPQ    6,DL
         1 007040   007042 602006 1                  TNC     s:10071+6,QL
         1 007041   007053 710000 1                  TRA     s:10079
         1 007042   007053 710000 1                  TRA     s:10079
         1 007043   007050 710000 1                  TRA     s:10074
         1 007044   007053 710000 1                  TRA     s:10079
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:342  
         1 007045   007053 710000 1                  TRA     s:10079
         1 007046   007053 710000 1                  TRA     s:10079
         1 007047   007050 710000 1                  TRA     s:10074

     2561    10072
     2562    10073    3               CASE (%KQDC_GET,%KQDC_FETCH);

     2563    10074    3                 CALL COMPRCVR;

  10074  1 007050   006615 701000 1                  TSX1    COMPRCVR
         1 007051   000000 011000                    NOP     0
         1 007052   007053 710000 1                  TRA     s:10079

     2564    10075
     2565    10076    3               CASE (ELSE);

     2566    10077    3                 ;
     2567    10078    3             END;

     2568    10079    2           KQ$CG.DFRDFR$=KQ$DFRBLK.LNK$;

  10079  1 007053   200007 470500                    LDP0    DFR$,,AUTO
         1 007054   000000 236100                    LDQ     0,,PR0
         1 007055   200003 471500                    LDP1    @KQ$CG,,AUTO
         1 007056   100026 756100                    STQ     22,,PR1

     2569    10080    2           CALL RELBLK;

  10080  1 007057   004244 701000 1                  TSX1    RELBLK
         1 007060   000000 011000                    NOP     0

     2570    10081    2           KQ$CG.NDFRBLKS=KQ$CG.NDFRBLKS+1;

  10081  1 007061   200003 470500                    LDP0    @KQ$CG,,AUTO
         1 007062   000225 236100                    LDQ     149,,PR0
         1 007063   001000 036003                    ADLQ    512,DU
         1 007064   000225 552140                    STBQ    149,'40'O,PR0
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:343  

     2571    10082    2           END;

  10082  1 007065   000026 236100                    LDQ     22,,PR0
         1 007066   000001 116000 xsym               CMPQ    B_VECTNIL+1
         1 007067   007031 601000 1                  TNZ     s:10070

     2572    10083        /**/
     2573    10084    1         KQ$CG.SHRINKCNT=0;

  10084  1 007070   000000 220003                    LDX0    0,DU
         1 007071   000240 740100                    STX0    160,,PR0

     2574    10085    1         KQ$CG.SHRINKPGS=0;

  10085  1 007072   000240 440100                    SXL0    160,,PR0

     2575    10086        /**/
     2576    10087    1         DGRAN$=KQ$CG.DTREE.HEAD$;

  10087  1 007073   000235 236100                    LDQ     157,,PR0
         1 007074   200011 756100                    STQ     DGRAN$,,AUTO

     2577    10088    2           DO WHILE (DGRAN$ ~= ADDR(NIL));

  10088  1 007075   007106 710000 1                  TRA     s:10092

     2578    10089    2           DGRAN$ = PINCRW(DGRAN$,-SIZEW(KQ$DGRAN.HDR));

  10089  1 007076   200011 236100                    LDQ     DGRAN$,,AUTO
         1 007077   777774 036003                    ADLQ    -4,DU
         1 007100   200011 756100                    STQ     DGRAN$,,AUTO

     2579    10090    2           CALL RCVGRAN ALTRET(ALTRT);

  10090  1 007101   007145 701000 1                  TSX1    RCVGRAN
         1 007102   000026 702000 1                  TSX2    ALTRT
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:344  

     2580    10091    2           DGRAN$=KQ$DGRAN.BTN.FLINK$;

  10091  1 007103   200011 470500                    LDP0    DGRAN$,,AUTO
         1 007104   000010 236100                    LDQ     8,,PR0
         1 007105   200011 756100                    STQ     DGRAN$,,AUTO

     2581    10092    2           END;

  10092  1 007106   000001 116000 xsym               CMPQ    B_VECTNIL+1
         1 007107   007076 601000 1                  TNZ     s:10089

     2582    10093        /**/
     2583    10094    1         CALL KQC$CXTSET(ADDR(KQ$CG));

  10094  1 007110   200003 236100                    LDQ     @KQ$CG,,AUTO
         1 007111   200112 756100                    STQ     I$+1,,AUTO
         1 007112   200112 630500                    EPPR0   I$+1,,AUTO
         1 007113   200113 450500                    STP0    I$+2,,AUTO
         1 007114   200113 630500                    EPPR0   I$+2,,AUTO
         1 007115   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 007116   000000 701000 xent               TSX1    KQC$CXTSET
         1 007117   000000 011000                    NOP     0

     2584    10095        /**/
     2585    10096    1         RETURN;

  10096  1 007120   000000 702200 xent               TSX2  ! X66_ARET

     2586    10097        /**/
     2587    10098        /** PROC TO RECOVER A CHAIN **/
     2588    10099    1   RCVCHAIN: PROC (HD$);

  10099  1 007121   200052 741300       RCVCHAIN     STX1  ! LDGRAN$+2,,AUTO

     2589    10100        /**/
     2590    10101    2   DCL HD$ PTR;
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:345  
     2591    10102        /**/
     2592    10103    3           DO WHILE (HD$ ~= ADDR(NIL));

  10103  1 007122   007137 710000 1                  TRA     s:10108

     2593    10104    3           DFR$=HD$;

  10104  1 007123   200053 470500                    LDP0    @HD$,,AUTO
         1 007124   000000 236100                    LDQ     0,,PR0
         1 007125   200007 756100                    STQ     DFR$,,AUTO

     2594    10105    3           HD$=KQ$DFRBLK.LNK$;

  10105  1 007126   200007 471500                    LDP1    DFR$,,AUTO
         1 007127   100000 236100                    LDQ     0,,PR1
         1 007130   000000 756100                    STQ     0,,PR0

     2595    10106    3           CALL RELBLK;

  10106  1 007131   004244 701000 1                  TSX1    RELBLK
         1 007132   000000 011000                    NOP     0

     2596    10107    3           KQ$CG.NDFRBLKS=KQ$CG.NDFRBLKS+1;

  10107  1 007133   200003 470500                    LDP0    @KQ$CG,,AUTO
         1 007134   000225 236100                    LDQ     149,,PR0
         1 007135   001000 036003                    ADLQ    512,DU
         1 007136   000225 552140                    STBQ    149,'40'O,PR0

     2597    10108    3           END;

  10108  1 007137   200053 470500                    LDP0    @HD$,,AUTO
         1 007140   000000 236100                    LDQ     0,,PR0
         1 007141   000001 116000 xsym               CMPQ    B_VECTNIL+1
         1 007142   007123 601000 1                  TNZ     s:10104

     2598    10109    2         RETURN;
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:346  

  10109  1 007143   200052 221300                    LDX1  ! LDGRAN$+2,,AUTO
         1 007144   000001 702211                    TSX2  ! 1,X1

     2599    10110    2   END RCVCHAIN;
     2600    10111        /**/
     2601    10112        /*I* NAME:         RCVGRAN
     2602    10113             PURPOSE:      To fix up an in-core data granule during
     2603    10114                           KQD$RECOVER
     2604    10115             DESCRIPTION:  The free chains in the granule are rebuilt
     2605    10116                           to ensure their integrity.  Also, all active
     2606    10117                           data blocks have their LOCK bits zapped.  This
     2607    10118                           last prevents problems when people try to FETCH
     2608    10119                           stuff which was LOCKed when the comgroup was
     2609    10120                           crashed.
     2610    10121
     2611    10122                           A diagnostic SNAP is issued if any granule is
     2612    10123                           broken.
     2613    10124                           If a granule is unrecoverably broken, we ALTRET
     2614    10125                           and the comgroup cannot be opened.
     2615    10126        */
     2616    10127    1   RCVGRAN: PROC ALTRET;

  10127  1 007145   200052 741300       RCVGRAN      STX1  ! LDGRAN$+2,,AUTO

     2617    10128        /**/
     2618    10129    2   DCL PASS UBIN;
     2619    10130    2   DCL I UBIN;
     2620    10131    2   DCL LASTX UBIN;
     2621    10132    2   DCL BLKX UBIN;
     2622    10133        /**/
     2623    10134    2         PASS=1;

  10134  1 007146   000001 235007                    LDA     1,DL
         1 007147   200053 755100                    STA     PASS,,AUTO

  10134  1 007150                       RETRY        null
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:347  
     2624    10135    2   RETRY:;
     2625    10136    2         BLKX=SIZEW(KQ$DGRAN);

  10136  1 007150   000040 235007                    LDA     32,DL
         1 007151   200056 755100                    STA     BLKX,,AUTO

     2626    10137    2         LASTX=0;

  10137  1 007152   200055 450100                    STZ     LASTX,,AUTO

     2627    10138    2   LOOP: DBLK$=PINCRW(DGRAN$,BLKX);

  10138  1 007153   200056 236100       LOOP         LDQ     BLKX,,AUTO
         1 007154   000022 736000                    QLS     18
         1 007155   200011 036100                    ADLQ    DGRAN$,,AUTO
         1 007156   200006 756100                    STQ     DBLK$,,AUTO

     2628    10139    2         IF KQ$DBLK.SIZW + BLKX > 1024 THEN

  10139  1 007157   200006 470500                    LDP0    DBLK$,,AUTO
         1 007160   000004 236100                    LDQ     4,,PR0
         1 007161   000022 772000                    QRL     18
         1 007162   200056 036100                    ADLQ    BLKX,,AUTO
         1 007163   002001 116007                    CMPQ    1025,DL
         1 007164   007244 602000 1                  TNC     s:10162

     2629    10140    3           DO;

     2630    10141    3           IF PASS = 1 THEN

  10141  1 007165   200053 235100                    LDA     PASS,,AUTO
         1 007166   000001 115007                    CMPA    1,DL
         1 007167   007231 601000 1                  TNZ     s:10158

     2631    10142    4             DO;

     2632    10143    4             CALL SC_CGCACHE;
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:348  

  10143  1 007170   000000 713400 xsym               CLIMB   SC_CGCACHE
         1 007171   000000 600000 xsid               climb   nvectors=         0

     2633    10144    4   PASS2:    PASS=2;

  10144  1 007172   000002 235007       PASS2        LDA     2,DL
         1 007173   200053 755100                    STA     PASS,,AUTO

     2634    10145    4             KQ$DGRAN.AVAILX=0;

  10145  1 007174   200011 470500                    LDP0    DGRAN$,,AUTO
         1 007175   000014 450100                    STZ     12,,PR0

     2635    10146    4             KQ$DGRAN.BUDDYX=0;

  10146  1 007176   000015 450100                    STZ     13,,PR0

     2636    10147                  /* All the Words in this Granule that were considered
     2637    10148                     AVAILable and FREE are now considered USED.  This
     2638    10149                     Routine will make them Available later             */
     2639    10150    4             I = KQ$DBLK.SIZW ;

  10150  1 007177   200006 471500                    LDP1    DBLK$,,AUTO
         1 007200   100004 236100                    LDQ     4,,PR1
         1 007201   000022 772000                    QRL     18
         1 007202   200054 756100                    STQ     I,,AUTO

     2640    10151    4             KQ$DBLK.SIZW = KQ$DGRAN.WRDSAVAIL;

  10151  1 007203   000021 720100                    LXL0    17,,PR0
         1 007204   100004 740100                    STX0    4,,PR1

     2641    10152    4             CALL COUNT_WORDS(%SUBTRACT,%NONE) ;

  10152  1 007205   000012 236000 2                  LDQ     10
         1 007206   200104 756100                    STQ     @FREE,,AUTO
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:349  
         1 007207   000001 236000 2                  LDQ     1
         1 007210   200103 756100                    STQ     ADDFLG,,AUTO
         1 007211   002215 701000 1                  TSX1    COUNT_WORDS
         1 007212   000000 011000                    NOP     0

     2642    10153    4             KQ$DBLK.SIZW = KQ$DGRAN.WRDSFREE ;

  10153  1 007213   200011 470500                    LDP0    DGRAN$,,AUTO
         1 007214   000027 720100                    LXL0    23,,PR0
         1 007215   200006 471500                    LDP1    DBLK$,,AUTO
         1 007216   100004 740100                    STX0    4,,PR1

     2643    10154    4             CALL COUNT_WORDS(%NONE,%SUBTRACT) ;

  10154  1 007217   000001 236000 2                  LDQ     1
         1 007220   200104 756100                    STQ     @FREE,,AUTO
         1 007221   000012 236000 2                  LDQ     10
         1 007222   200103 756100                    STQ     ADDFLG,,AUTO
         1 007223   002215 701000 1                  TSX1    COUNT_WORDS
         1 007224   000000 011000                    NOP     0

     2644    10155    4             KQ$DBLK.SIZW = I ;

  10155  1 007225   200054 720100                    LXL0    I,,AUTO
         1 007226   200006 470500                    LDP0    DBLK$,,AUTO
         1 007227   000004 740100                    STX0    4,,PR0

     2645    10156    4             GOTO RETRY;

  10156  1 007230   007150 710000 1                  TRA     RETRY

     2646    10157    4             END;
     2647    10158    3           IF KQ$DBLK.ACTIVE OR KQ$DBLK.LREL THEN

  10158  1 007231   000003 236100                    LDQ     3,,PR0
         1 007232   000400 316003                    CANQ    256,DU
         1 007233   007236 601000 1                  TNZ     s:10159
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:350  
         1 007234   000100 316003                    CANQ    64,DU
         1 007235   007240 600000 1                  TZE     s:10160

     2648    10159    3             ALTRETURN;

  10159  1 007236   200052 221300                    LDX1  ! LDGRAN$+2,,AUTO
         1 007237   000000 702211                    TSX2  ! 0,X1

     2649    10160    3           KQ$DBLK.SIZW=1024-BLKX;

  10160  1 007240   200056 720100                    LXL0    BLKX,,AUTO
         1 007241   775777 620010                    EAX0    -1025,X0
         1 007242   777777 660003                    ERX0    -1,DU
         1 007243   000004 740100                    STX0    4,,PR0

     2650    10161    3           END;

     2651    10162    2         IF KQ$DBLK.LREL OR KQ$DBLK.ACTIVE THEN

  10162  1 007244   000003 236100                    LDQ     3,,PR0
         1 007245   000100 316003                    CANQ    64,DU
         1 007246   007251 601000 1                  TNZ     s:10164
         1 007247   000400 316003                    CANQ    256,DU
         1 007250   007276 600000 1                  TZE     s:10172

     2652    10163    3           DO;

     2653    10164    3           I=KQ$DBLK.DSIZE+SIZEC(KQ$DBLK)+4*(BLKX);

  10164  1 007251   000000 236100                    LDQ     0,,PR0
         1 007252   777777 376007                    ANQ     -1,DL
         1 007253   200112 756100                    STQ     I$+1,,AUTO
         1 007254   200056 236100                    LDQ     BLKX,,AUTO
         1 007255   000002 736000                    QLS     2
         1 007256   200112 036100                    ADLQ    I$+1,,AUTO
         1 007257   000030 036007                    ADLQ    24,DL
         1 007260   200054 756100                    STQ     I,,AUTO
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:351  

     2654    10165    3           IF KQ$DBLK.MBLK THEN I=I+SIZEC(KQ$MBLK);

  10165  1 007261   000003 236100                    LDQ     3,,PR0
         1 007262   000020 316003                    CANQ    16,DU
         1 007263   007267 600000 1                  TZE     s:10166

  10165  1 007264   200054 235100                    LDA     I,,AUTO
         1 007265   000100 035007                    ADLA    64,DL
         1 007266   200054 755100                    STA     I,,AUTO

     2655    10166    3           IF I > 4096 THEN

  10166  1 007267   200054 235100                    LDA     I,,AUTO
         1 007270   010001 115007                    CMPA    4097,DL
         1 007271   007276 602000 1                  TNC     s:10172

     2656    10167    4             DO;

     2657    10168    4             CALL SC_CGCACHE;

  10168  1 007272   000000 713400 xsym               CLIMB   SC_CGCACHE
         1 007273   000000 600000 xsid               climb   nvectors=         0

     2658    10169    4             ALTRETURN;

  10169  1 007274   200052 221300                    LDX1  ! LDGRAN$+2,,AUTO
         1 007275   000000 702211                    TSX2  ! 0,X1

     2659    10170    4             END;
     2660    10171    3           END;
     2661    10172    2         IF NOT KQ$DBLK.ACTIVE THEN

  10172  1 007276   000400 316003                    CANQ    256,DU
         1 007277   007325 601000 1                  TNZ     s:10184

     2662    10173    2           IF PASS = 2 THEN
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:352  

  10173  1 007300   200053 235100                    LDA     PASS,,AUTO
         1 007301   000002 115007                    CMPA    2,DL
         1 007302   007325 601000 1                  TNZ     s:10184

     2663    10174    3             DO;

     2664    10175    3             KQ$DBLK.LINKX=0;

  10175  1 007303   000000 220003                    LDX0    0,DU
         1 007304   000003 440100                    SXL0    3,,PR0

     2665    10176    3             IF LASTX = 0

  10176  1 007305   200055 236100                    LDQ     LASTX,,AUTO
         1 007306   007313 601000 1                  TNZ     s:10178

     2666    10177    3             THEN KQ$DGRAN.AVAILX=BLKX;

  10177  1 007307   200011 471500                    LDP1    DGRAN$,,AUTO
         1 007310   200056 235100                    LDA     BLKX,,AUTO
         1 007311   100014 755100                    STA     12,,PR1
         1 007312   007316 710000 1                  TRA     s:10179

     2667    10178    3             ELSE PINCRW(DGRAN$,LASTX)->KQ$DBLK.LINKX=BLKX;

  10178  1 007313   200056 721100                    LXL1    BLKX,,AUTO
         1 007314   200011 471500                    LDP1    DGRAN$,,AUTO
         1 007315   100003 441106                    SXL1    3,QL,PR1

     2668    10179    3             LASTX=BLKX;

  10179  1 007316   200056 235100                    LDA     BLKX,,AUTO
         1 007317   200055 755100                    STA     LASTX,,AUTO

     2669    10180                  /* Remember were I said above that this routine would
     2670    10181                     make them AVAILable later.  Well it is Later.      */
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:353  
     2671    10182    3             CALL COUNT_WORDS(%ADD,%ADD);

  10182  1 007320   000000 236000 2                  LDQ     0
         1 007321   200104 756100                    STQ     @FREE,,AUTO
         1 007322   200103 756100                    STQ     ADDFLG,,AUTO
         1 007323   002215 701000 1                  TSX1    COUNT_WORDS
         1 007324   000000 011000                    NOP     0

     2672    10183    3             END;

     2673    10184    2         IF PASS = 2 THEN

  10184  1 007325   200053 235100                    LDA     PASS,,AUTO
         1 007326   000002 115007                    CMPA    2,DL
         1 007327   007333 601000 1                  TNZ     s:10186

     2674    10185    2           KQ$DBLK.LOCK='0'B;

  10185  1 007330   200006 470500                    LDP0    DBLK$,,AUTO
         1 007331   000020 236000 2                  LDQ     16
         1 007332   000003 356100                    ANSQ    3,,PR0

     2675    10186    2         IF KQ$DBLK.SIZW<=0 THEN CALL SC_CGCACHE;

  10186  1 007333   200006 470500                    LDP0    DBLK$,,AUTO
         1 007334   000004 220100                    LDX0    4,,PR0
         1 007335   007340 601000 1                  TNZ     s:10187

  10186  1 007336   000000 713400 xsym               CLIMB   SC_CGCACHE
         1 007337   000000 600000 xsid               climb   nvectors=         0

     2676    10187    2         BLKX=BLKX+KQ$DBLK.SIZW;

  10187  1 007340   200006 470500                    LDP0    DBLK$,,AUTO
         1 007341   000004 236100                    LDQ     4,,PR0
         1 007342   000022 772000                    QRL     18
         1 007343   200056 036100                    ADLQ    BLKX,,AUTO
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:354  
         1 007344   200056 756100                    STQ     BLKX,,AUTO

     2677    10188    2         IF BLKX ~= 1024 THEN GOTO LOOP;

  10188  1 007345   002000 116007                    CMPQ    1024,DL
         1 007346   007153 601000 1                  TNZ     LOOP

     2678    10189    2         IF PASS = 1 THEN GOTO PASS2;

  10189  1 007347   200053 235100                    LDA     PASS,,AUTO
         1 007350   000001 115007                    CMPA    1,DL
         1 007351   007172 600000 1                  TZE     PASS2

     2679    10190    2         RETURN;

  10190  1 007352   200052 221300                    LDX1  ! LDGRAN$+2,,AUTO
         1 007353   000001 702211                    TSX2  ! 1,X1

     2680    10191    2   END RCVGRAN;
     2681    10192        %EJECT;
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:355  
     2682    10193
     2683    10194
     2684    10195        /*F* NAME:         KQD$NEEDPG
     2685    10196
     2686    10197             PURPOSE:      Do things to the data cache a 1 second intervals.
     2687    10198
     2688    10199        */
     2689    10200
     2690    10201
     2691    10202
     2692    10203        /*D* NAME:         KQD$NEEDPG
     2693    10204
     2694    10205             CALL:         CALL KQD$NEEDPG(KQ$CG);
     2695    10206
     2696    10207             INPUT:        KQ$CG - Comgroup context block
     2697    10208
     2698    10209             DESCRIPTION:  If there are tasks waiting for a page and the
     2699    10210                           comgroup does not have its maximum number of data
     2700    10211                           cache pages, an attempt is made to get one.  If
     2701    10212                           successful, RELPAGE is called to find someone to
     2702    10213                           use it, and the loop is repeated.
     2703    10214
     2704    10215        */
     2705    10216
     2706    10217
     2707    10218
     2708    10219    1   KQD$NEEDPG: ENTRY(KQ$CG) ALTRET;  /* Never ALTRETs */

  10219  1 007354   000000 700200 xent  KQD$NEEDPG   TSX0  ! X66_AUTO_3
         1 007355   000122 000003                    ZERO    82,3

  10190  1 007356                       NEEDPG       null
     2709    10220
     2710    10221    1   NEEDPG: ;
     2711    10222              %LOCK (G=KQ$CG.DTREE.GATE);

  10223  1 007356   200003 236100                    LDQ     @KQ$CG,,AUTO
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:356  
         1 007357   000231 036003                    ADLQ    153,DU
         1 007360   200112 756100                    STQ     I$+1,,AUTO
         1 007361   200112 630500                    EPPR0   I$+1,,AUTO
         1 007362   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 007363   000000 701000 xent               TSX1    HFC$LOCK
         1 007364   000000 011000                    NOP     0

     2712    10225    2           DO WHILE(KQ$CG.NEEDPGHD$~=ADDR(NIL));

  10225  1 007365   007466 710000 1                  TRA     s:10260

     2713    10226    2           IF KQ$CG.DATAFREE$~=ADDR(NIL) THEN

  10226  1 007366   200003 470500                    LDP0    @KQ$CG,,AUTO
         1 007367   000243 236100                    LDQ     163,,PR0
         1 007370   000001 116000 xsym               CMPQ    B_VECTNIL+1
         1 007371   007377 600000 1                  TZE     s:10232

     2714    10227    3             DO;

     2715    10228    3             DGRAN$=KQ$CG.DATAFREE$;

  10228  1 007372   200011 756100                    STQ     DGRAN$,,AUTO

     2716    10229    3             KQ$CG.DATAFREE$=KQ$DGRAN.FLINK$;

  10229  1 007373   200011 471500                    LDP1    DGRAN$,,AUTO
         1 007374   100017 236100                    LDQ     15,,PR1
         1 007375   000243 756100                    STQ     163,,PR0

     2717    10230    3             END;

  10230  1 007376   007464 710000 1                  TRA     RELPG

     2718    10231    2           ELSE
     2719    10232    2             IF KQ$CG.CURDATAPGS<KQ$CG.MAXDATAPGS THEN

PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:357  
  10232  1 007377   000241 720100                    LXL0    161,,PR0
         1 007400   000241 100100                    CMPX0   161,,PR0
         1 007401   007444 603000 1                  TRC     s:10245

     2720    10233    3               DO;

     2721    10234    3               CALL KQM$GETP(KQ$CG,LDGRAN$,I) ALTRET(UNLKRET);

  10234  1 007402   200012 631500                    EPPR1   I,,AUTO
         1 007403   200114 451500                    STP1    I$+3,,AUTO
         1 007404   200050 633500                    EPPR3   LDGRAN$,,AUTO
         1 007405   200113 453500                    STP3    I$+2,,AUTO
         1 007406   200003 236100                    LDQ     @KQ$CG,,AUTO
         1 007407   200112 756100                    STQ     I$+1,,AUTO
         1 007410   200112 630500                    EPPR0   I$+1,,AUTO
         1 007411   000021 631400 xsym               EPPR1   B_VECTNIL+17
         1 007412   000000 701000 xent               TSX1    KQM$GETP
         1 007413   007472 702000 1                  TSX2    UNLKRET

     2722    10235    3               DGRAN$=LDGRAN$;

  10235  1 007414   200050 236100                    LDQ     LDGRAN$,,AUTO
         1 007415   200011 756100                    STQ     DGRAN$,,AUTO

     2723    10236    3               KQ$CG.CURDATAPGS=KQ$CG.CURDATAPGS+1;

  10236  1 007416   200003 470500                    LDP0    @KQ$CG,,AUTO
         1 007417   000241 720100                    LXL0    161,,PR0
         1 007420   000001 621010                    EAX1    1,X0
         1 007421   000241 441100                    SXL1    161,,PR0

     2724    10237    3               KQ$DGRAN=KQ_IDGRAN;

  10237  1 007422   200011 471500                    LDP1    DGRAN$,,AUTO
         1 007423   000100 100400                    MLR     fill='000'O
         1 007424   000016 000200 0                  ADSC9   KQ_IDGRAN                cn=0,n=128
         1 007425   100000 000200                    ADSC9   0,,PR1                   cn=0,n=128
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:358  

     2725    10238    3               KQ$GRAN=KQ$CG.GRAN;

  10238  1 007426   000100 100500                    MLR     fill='000'O
         1 007427   000253 000020                    ADSC9   171,,PR0                 cn=0,n=16
         1 007430   100000 000020                    ADSC9   0,,PR1                   cn=0,n=16

     2726    10239    3               KQ$DGRAN.HDR.PTYP=%KQ_PTYP_DATA;

  10239  1 007431   100001 236100                    LDQ     1,,PR1
         1 007432   000035 376000 2                  ANQ     29
         1 007433   000001 276003                    ORQ     1,DU
         1 007434   100001 756100                    STQ     1,,PR1

     2727    10240    3               KQ$DGRAN.HDR.GTYP=%KQ_PTYP_DATA;

  10240  1 007435   100001 236100                    LDQ     1,,PR1
         1 007436   000036 376000 2                  ANQ     30
         1 007437   040000 276007                    ORQ     16384,DL
         1 007440   100001 756100                    STQ     1,,PR1

     2728    10241    3               KQ$DGRAN.HDR.SELF$=DGRAN$;

  10241  1 007441   200011 236100                    LDQ     DGRAN$,,AUTO
         1 007442   100002 756100                    STQ     2,,PR1

     2729    10242    3               END;

  10242  1 007443   007464 710000 1                  TRA     RELPG

     2730    10243    2             ELSE
     2731    10244    3               DO;

     2732    10245    3               DGRAN$=KQ$CG.AVAIL.TL$;

  10245  1 007444   000245 236100                    LDQ     165,,PR0
         1 007445   200011 756100                    STQ     DGRAN$,,AUTO
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:359  

     2733    10246    4                 DO WHILE(DGRAN$~=ADDR(NIL));

  10246  1 007446   007461 710000 1                  TRA     s:10254

     2734    10247    4                 IF KQ$DGRAN.USECNT=0 THEN

  10247  1 007447   200011 470500                    LDP0    DGRAN$,,AUTO
         1 007450   000013 235100                    LDA     11,,PR0
         1 007451   007457 601000 1                  TNZ     s:10253

     2735    10248    5                   DO;

     2736    10249    5                   KQ$DGRAN.HDR.FORCEOUT='0'B;

  10249  1 007452   000024 236000 2                  LDQ     20
         1 007453   000001 356100                    ANSQ    1,,PR0

     2737    10250    5                   CALL REMPAGE ALTRET(NEEDPG);

  10250  1 007454   005456 701000 1                  TSX1    REMPAGE
         1 007455   007356 702000 1                  TSX2    NEEDPG

     2738    10251    5                   GOTO RELPG;

  10251  1 007456   007464 710000 1                  TRA     RELPG

     2739    10252    5                   END;
     2740    10253    4                 DGRAN$=KQ$DGRAN.BLINK$;

  10253  1 007457   000016 236100                    LDQ     14,,PR0
         1 007460   200011 756100                    STQ     DGRAN$,,AUTO

     2741    10254    4                 END;

  10254  1 007461   000001 116000 xsym               CMPQ    B_VECTNIL+1
         1 007462   007447 601000 1                  TNZ     s:10247
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:360  

     2742    10255    3               GOTO UNLKRET;

  10255  1 007463   007472 710000 1                  TRA     UNLKRET

  10254  1 007464                       RELPG        null
     2743    10256    3               END;
     2744    10257        /**/
     2745    10258    2   RELPG:  ;
     2746    10259    2           CALL RELPAGE ALTRET(NEEDPG);

  10259  1 007464   006103 701000 1                  TSX1    RELPAGE
         1 007465   007356 702000 1                  TSX2    NEEDPG

     2747    10260    2           END;

  10260  1 007466   200003 470500                    LDP0    @KQ$CG,,AUTO
         1 007467   000250 236100                    LDQ     168,,PR0
         1 007470   000001 116000 xsym               CMPQ    B_VECTNIL+1
         1 007471   007366 601000 1                  TNZ     s:10226

  10250  1 007472                       UNLKRET      null
     2748    10261        /**/
     2749    10262        /**/
     2750    10263    1   UNLKRET: ;
     2751    10264              %UNLOCK (G=KQ$CG.DTREE.GATE);

  10265  1 007472   200003 236100                    LDQ     @KQ$CG,,AUTO
         1 007473   000231 036003                    ADLQ    153,DU
         1 007474   200112 756100                    STQ     I$+1,,AUTO
         1 007475   200112 630500                    EPPR0   I$+1,,AUTO
         1 007476   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 007477   000000 701000 xent               TSX1    HFC$UNLOCK
         1 007500   000000 011000                    NOP     0

     2752    10267        /**/
     2753    10268    1   RET:  ;
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:361  

  10268  1 007501                       RET          null
     2754    10269    1         RETURN;

  10269  1 007501   000000 702200 xent               TSX2  ! X66_ARET

     2755    10270        %EJECT;
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:362  
     2756    10271
     2757    10272
     2758    10273        /*F* NAME:         KQD$SQUEEZE
     2759    10274
     2760    10275             PURPOSE:      Do things to the data cache a 1 minute intervals.
     2761    10276
     2762    10277        */
     2763    10278
     2764    10279
     2765    10280
     2766    10281        /*D* NAME:         KQD$SQUEEZE
     2767    10282
     2768    10283             CALL:         CALL KQD$SQUEEZE(KQ$CG);
     2769    10284
     2770    10285             INPUT:        KQ$CG - Comgroup context block
     2771    10286
     2772    10287             DESCRIPTION:  The data cache is searched.  For each page with USECNT=0:
     2773    10288                              o if ACTCNT is non-zero, it is zeroed
     2774    10289                              o if it is already zero (indicating no activity
     2775    10290                                in the last minute) it is thrown out
     2776    10291                              o if FORCECNT is 1 and UPD is set, the page is written,
     2777    10292                                but not thrown out (FORCEOUT set)
     2778    10293
     2779    10294        */
     2780    10295
     2781    10296
     2782    10297
     2783    10298    1   KQD$SQUEEZE: ENTRY(KQ$CG) ALTRET;  /* Never ALTRETs */

  10298  1 007502   000000 700200 xent  KQD$SQUEEZE  TSX0  ! X66_AUTO_3
         1 007503   000122 000003                    ZERO    82,3

     2784    10299
     2785    10300    1         ENTFLG = 0;

  10300  1 007504   200020 450100                    STZ     ENTFLG,,AUTO

PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:363  
     2786    10301    1         CALL SSS$SYSTIME(PASS);

  10301  1 007505   200045 630500                    EPPR0   PASS,,AUTO
         1 007506   200112 450500                    STP0    I$+1,,AUTO
         1 007507   200112 630500                    EPPR0   I$+1,,AUTO
         1 007510   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 007511   000000 701000 xent               TSX1    SSS$SYSTIME
         1 007512   000000 011000                    NOP     0

  10300  1 007513                       RESTART      null
     2787    10302    1   RESTART: ;
     2788    10303              %LOCK (G=KQ$CG.DTREE.GATE);

  10304  1 007513   200003 236100                    LDQ     @KQ$CG,,AUTO
         1 007514   000231 036003                    ADLQ    153,DU
         1 007515   200112 756100                    STQ     I$+1,,AUTO
         1 007516   200112 630500                    EPPR0   I$+1,,AUTO
         1 007517   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 007520   000000 701000 xent               TSX1    HFC$LOCK
         1 007521   000000 011000                    NOP     0

  10300  1 007522                       RESTART5     null
     2789    10306    1   RESTART5: ;
     2790    10307    1         IF KQ$CG.IOCNT>20 THEN

  10307  1 007522   200003 470500                    LDP0    @KQ$CG,,AUTO
         1 007523   000225 720100                    LXL0    149,,PR0
         1 007524   000025 100003                    CMPX0   21,DU
         1 007525   007472 603000 1                  TRC     UNLKRET

     2791    10308    1           GOTO UNLKRET;  /* Don't do too many I/Os at once */
     2792    10309    1         IF KQ$CG.FORCECNT~=1 THEN

  10309  1 007526   000237 236100                    LDQ     159,,PR0
         1 007527   777000 376003                    ANQ     -512,DU
         1 007530   001000 116003                    CMPQ    512,DU
         1 007531   007545 600000 1                  TZE     s:10319
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:364  

     2793    10310    2           DO;

     2794    10311    2           IF KQ$CG.FORCECNT~=0 THEN

  10311  1 007532   000237 236100                    LDQ     159,,PR0
         1 007533   777000 316003                    CANQ    -512,DU
         1 007534   007540 600000 1                  TZE     s:10314

     2795    10312    2             KQ$CG.FORCECNT=KQ$CG.FORCECNT-1;

  10312  1 007535   777000 036003                    ADLQ    -512,DU
         1 007536   000237 552140                    STBQ    159,'40'O,PR0
         1 007537   007543 710000 1                  TRA     s:10315

     2796    10313    2           ELSE
     2797    10314    2             KQ$CG.FORCECNT=KQ$CG.AUCTL.WRITETIME;

  10314  1 007540   000135 236100                    LDQ     93,,PR0
         1 007541   000033 736000                    QLS     27
         1 007542   000237 552140                    STBQ    159,'40'O,PR0

     2798    10315    2           DELFLG=0; /* Don't force out this time */

  10315  1 007543   200021 450100                    STZ     DELFLG,,AUTO

     2799    10316    2           END;

  10316  1 007544   007577 710000 1                  TRA     s:10324

     2800    10317    1         ELSE
     2801    10318    2           DO;

     2802    10319    2           KQ$CG.FORCECNT=KQ$CG.AUCTL.WRITETIME;

  10319  1 007545   000135 236100                    LDQ     93,,PR0
         1 007546   000033 736000                    QLS     27
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:365  
         1 007547   000237 552140                    STBQ    159,'40'O,PR0

     2803    10320    2           DELFLG=1;

  10320  1 007550   000001 235007                    LDA     1,DL
         1 007551   200021 755100                    STA     DELFLG,,AUTO

     2804    10321    2           CALL SSS$SYSTIME(J);

  10321  1 007552   200013 631500                    EPPR1   J,,AUTO
         1 007553   200112 451500                    STP1    I$+1,,AUTO
         1 007554   200112 630500                    EPPR0   I$+1,,AUTO
         1 007555   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 007556   000000 701000 xent               TSX1    SSS$SYSTIME
         1 007557   000000 011000                    NOP     0

     2805    10322    2           CALL XUD$UTS_ADJ_25TH(I, J, -KQ$CG.AUCTL.WRITETIME*%UTS_25TH_MIN#);

  10322  1 007560   200003 470500                    LDP0    @KQ$CG,,AUTO
         1 007561   000135 236100                    LDQ     93,,PR0
         1 007562   000777 376007                    ANQ     511,DL
         1 007563   000050 402000 2                  MPY     40
         1 007564   200112 756100                    STQ     I$+1,,AUTO
         1 007565   200112 631500                    EPPR1   I$+1,,AUTO
         1 007566   200115 451500                    STP1    I$+4,,AUTO
         1 007567   200013 633500                    EPPR3   J,,AUTO
         1 007570   200114 453500                    STP3    I$+3,,AUTO
         1 007571   200012 634500                    EPPR4   I,,AUTO
         1 007572   200113 454500                    STP4    I$+2,,AUTO
         1 007573   200113 630500                    EPPR0   I$+2,,AUTO
         1 007574   000021 631400 xsym               EPPR1   B_VECTNIL+17
         1 007575   000000 701000 xent               TSX1    XUD$UTS_ADJ_25TH
         1 007576   000000 011000                    NOP     0

     2806    10323    2           END;

     2807    10324    1         DGRAN$=KQ$CG.AVAIL.TL$;
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:366  

  10324  1 007577   200003 470500                    LDP0    @KQ$CG,,AUTO
         1 007600   000245 236100                    LDQ     165,,PR0
         1 007601   200011 756100                    STQ     DGRAN$,,AUTO

     2808    10325    2           DO WHILE(DGRAN$~=ADDR(NIL));

  10325  1 007602   007715 710000 1                  TRA     s:10363

     2809    10326    2           IF NOT KQ$DGRAN.HDR.WRITE AND KQ$DGRAN.PASS~=PASS THEN

  10326  1 007603   200011 470500                    LDP0    DGRAN$,,AUTO
         1 007604   000001 236100                    LDQ     1,,PR0
         1 007605   000100 316003                    CANQ    64,DU
         1 007606   007713 601000 1                  TNZ     s:10362
         1 007607   000026 236100                    LDQ     22,,PR0
         1 007610   200045 116100                    CMPQ    PASS,,AUTO
         1 007611   007713 600000 1                  TZE     s:10362

     2810    10327    3             DO;

     2811    10328    3             KQ$DGRAN.PASS=PASS;

  10328  1 007612   200045 235100                    LDA     PASS,,AUTO
         1 007613   000026 755100                    STA     22,,PR0

     2812    10329    3             IF KQ$DGRAN.USECNT=0 THEN

  10329  1 007614   000013 235100                    LDA     11,,PR0
         1 007615   007676 601000 1                  TNZ     s:10356

     2813    10330    4               DO;

     2814    10331    4              IF (KQ$DGRAN.ACTCNT=0 AND KQ$CG.CURDATAPGS-KQ$CG.IOCNT>KQ$CG.MINDATAPGS)

  10331  1 007616   000022 235100                    LDA     18,,PR0
         1 007617   007634 601000 1                  TNZ     s:10331+14
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:367  
         1 007620   200003 471500                    LDP1    @KQ$CG,,AUTO
         1 007621   100225 236100                    LDQ     149,,PR1
         1 007622   777777 376007                    ANQ     -1,DL
         1 007623   200112 756100                    STQ     I$+1,,AUTO
         1 007624   100241 236100                    LDQ     161,,PR1
         1 007625   777777 376007                    ANQ     -1,DL
         1 007626   200112 136100                    SBLQ    I$+1,,AUTO
         1 007627   200113 756100                    STQ     I$+2,,AUTO
         1 007630   100242 236100                    LDQ     162,,PR1
         1 007631   000022 772000                    QRL     18
         1 007632   200113 116100                    CMPQ    I$+2,,AUTO
         1 007633   007650 604000 1                  TMI     s:10338
         1 007634   200003 471500                    LDP1    @KQ$CG,,AUTO
         1 007635   100225 236100                    LDQ     149,,PR1
         1 007636   777777 376007                    ANQ     -1,DL
         1 007637   200114 756100                    STQ     I$+3,,AUTO
         1 007640   100241 236100                    LDQ     161,,PR1
         1 007641   777777 376007                    ANQ     -1,DL
         1 007642   200114 136100                    SBLQ    I$+3,,AUTO
         1 007643   200115 756100                    STQ     I$+4,,AUTO
         1 007644   100241 236100                    LDQ     161,,PR1
         1 007645   000022 772000                    QRL     18
         1 007646   200115 116100                    CMPQ    I$+4,,AUTO
         1 007647   007653 605000 1                  TPL     s:10341

     2815    10332    4               OR KQ$CG.CURDATAPGS-KQ$CG.IOCNT>KQ$CG.MAXDATAPGS THEN
     2816    10333                          /* Yeah, yeah, I know IOCNT is not just the count of       */
     2817    10334                          /* writes outstanding but it will suffice here. The only   */
     2818    10335                          /* effect will be to wait an extra minute before we purge  */
     2819    10336                          /* down to MINDATAPGS                                      */
     2820    10337    5                 DO;

     2821    10338    5                 KQ$DGRAN.HDR.FORCEOUT='0'B;

  10338  1 007650   000024 236000 2                  LDQ     20
         1 007651   000001 356100                    ANSQ    1,,PR0

PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:368  
     2822    10339    5                 GOTO WRITEIT;

  10339  1 007652   007671 710000 1                  TRA     WRITEIT

     2823    10340    5                 END;
     2824    10341    4               KQ$DGRAN.ACTCNT=0;

  10341  1 007653   000022 450100                    STZ     18,,PR0

     2825    10342    4               IF DELFLG~=0 THEN

  10342  1 007654   200021 235100                    LDA     DELFLG,,AUTO
         1 007655   007713 600000 1                  TZE     s:10362

     2826    10343    4                 IF KQ$DGRAN.TIME<I THEN

  10343  1 007656   000024 236100                    LDQ     20,,PR0
         1 007657   200012 116100                    CMPQ    I,,AUTO
         1 007660   007713 603000 1                  TRC     s:10362

     2827    10344    4                   IF NOT KQ$DGRAN.HDR.UPD THEN

  10344  1 007661   000001 236100                    LDQ     1,,PR0
         1 007662   000010 316003                    CANQ    8,DU
         1 007663   007667 601000 1                  TNZ     s:10348

     2828    10345    4                     KQ$DGRAN.TIME=J;

  10345  1 007664   200013 235100                    LDA     J,,AUTO
         1 007665   000024 755100                    STA     20,,PR0
         1 007666   007713 710000 1                  TRA     s:10362

     2829    10346    4                   ELSE
     2830    10347    5                     DO;

     2831    10348    5                     KQ$DGRAN.HDR.FORCEOUT='1'B;

PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:369  
  10348  1 007667   000400 236003                    LDQ     256,DU
         1 007670   000001 256100                    ORSQ    1,,PR0

  10348  1 007671                       WRITEIT      null
     2832    10349    5   WRITEIT:          ;
     2833    10350    5                     CALL REMPAGE ALTRET(RESTART);

  10350  1 007671   005456 701000 1                  TSX1    REMPAGE
         1 007672   007513 702000 1                  TSX2    RESTART

     2834    10351    5                     CALL RELPAGE ALTRET(RESTART);

  10351  1 007673   006103 701000 1                  TSX1    RELPAGE
         1 007674   007513 702000 1                  TSX2    RESTART

     2835    10352    5                     GOTO RESTART5;

  10352  1 007675   007522 710000 1                  TRA     RESTART5

     2836    10353    5                     END;
     2837    10354    4               END;
     2838    10355    3             ELSE
     2839    10356    3               IF DELFLG~=0 AND KQ$DGRAN.TIME<I THEN

  10356  1 007676   200021 236100                    LDQ     DELFLG,,AUTO
         1 007677   007713 600000 1                  TZE     s:10362
         1 007700   000024 236100                    LDQ     20,,PR0
         1 007701   200012 116100                    CMPQ    I,,AUTO
         1 007702   007713 603000 1                  TRC     s:10362

     2840    10357    3                 IF KQ$DGRAN.HDR.UPD THEN

  10357  1 007703   000001 236100                    LDQ     1,,PR0
         1 007704   000010 316003                    CANQ    8,DU
         1 007705   007711 600000 1                  TZE     s:10360

     2841    10358    3                   KQ$DGRAN.HDR.FORCEOUT='1'B;
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:370  

  10358  1 007706   000400 236003                    LDQ     256,DU
         1 007707   000001 256100                    ORSQ    1,,PR0
         1 007710   007713 710000 1                  TRA     s:10362

     2842    10359    3                 ELSE
     2843    10360    3                   KQ$DGRAN.TIME=J;

  10360  1 007711   200013 235100                    LDA     J,,AUTO
         1 007712   000024 755100                    STA     20,,PR0

     2844    10361    3             END;

     2845    10362    2           DGRAN$=KQ$DGRAN.BLINK$;

  10362  1 007713   000016 236100                    LDQ     14,,PR0
         1 007714   200011 756100                    STQ     DGRAN$,,AUTO

     2846    10363    2           END;

  10363  1 007715   000001 116000 xsym               CMPQ    B_VECTNIL+1
         1 007716   007603 601000 1                  TNZ     s:10326

     2847    10364        /**/
     2848    10365    1         GOTO UNLKRET;

  10365  1 007717   007472 710000 1                  TRA     UNLKRET

     2849    10366        %EJECT;
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:371  
     2850    10367
     2851    10368
     2852    10369        /*D* NAME:          LOGERR
     2853    10370
     2854    10371             CALL:          CALL LOGERR(WRD);
     2855    10372
     2856    10373             INPUT:         WRD - Optional word to put in error log entry
     2857    10374                            CODE - The code for the errlog entry
     2858    10375
     2859    10376        */
     2860    10377
     2861    10378
     2862    10379    1   LOGERR: PROC(CODE,WRD);

  10379  1 007720   200052 741300       LOGERR       STX1  ! LDGRAN$+2,,AUTO

     2863    10380
     2864    10381        /* PARAMETERS */
     2865    10382    2   DCL CODE UBIN;
     2866    10383    2   DCL WRD UBIN;
     2867    10384
     2868    10385            %LOCK (G=KQ_ERRLOG_GATE);

  10386  1 007721   000051 630400 2                  EPPR0   41
         1 007722   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 007723   000000 701000 xent               TSX1    HFC$LOCK
         1 007724   000000 011000                    NOP     0

     2869    10388    2         KQ_STATS.CACHERRS=KQ_STATS.CACHERRS+1;

  10388  1 007725   000006 054000 xsym               AOS     KQ_STATS+6

     2870    10389    2         KQ_ERRLOG_BFR='0'B;

  10389  1 007726   000000 100400                    MLR     fill='000'O
         1 007727   000002 000001 xsym               ADSC9   B_VECTNIL+2              cn=0,n=1
         1 007730   000000 000400 xsym               ADSC9   KQ_ERRLOG_BFR            cn=0,n=256
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:372  

     2871    10390    2         KQ_ERRLOG_BFR.SIZ=15;

  10390  1 007731   000017 235007                    LDA     15,DL
         1 007732   000015 755000 xsym               STA     KQ_ERRLOG_BFR+13

     2872    10391    2         IF ADDR(WRD)~=ADDR(NIL) THEN

  10391  1 007733   200054 236100                    LDQ     @WRD,,AUTO
         1 007734   000001 116000 xsym               CMPQ    B_VECTNIL+1
         1 007735   007741 600000 1                  TZE     s:10393

     2873    10392    2           KQ_ERRLOG_BFR.INFO(0)=WRD;

  10392  1 007736   200054 470500                    LDP0    @WRD,,AUTO
         1 007737   000000 235100                    LDA     0,,PR0
         1 007740   000016 755000 xsym               STA     KQ_ERRLOG_BFR+14

     2874    10393    2         IF DBLK$~=ADDR(NIL) THEN

  10393  1 007741   200006 236100                    LDQ     DBLK$,,AUTO
         1 007742   000001 116000 xsym               CMPQ    B_VECTNIL+1
         1 007743   007750 600000 1                  TZE     s:10395

     2875    10394    2           ADDR(KQ_ERRLOG_BFR.INFO(1))->KQ$DBLK=KQ$DBLK;

  10394  1 007744   200006 470500                    LDP0    DBLK$,,AUTO
         1 007745   000000 100500                    MLR     fill='000'O
         1 007746   000000 000030                    ADSC9   0,,PR0                   cn=0,n=24
         1 007747   000017 000030 xsym               ADSC9   KQ_ERRLOG_BFR+15         cn=0,n=24

     2876    10395    2         IF DFR$~=ADDR(NIL) THEN

  10395  1 007750   200007 236100                    LDQ     DFR$,,AUTO
         1 007751   000001 116000 xsym               CMPQ    B_VECTNIL+1
         1 007752   007757 600000 1                  TZE     s:10397

PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:373  
     2877    10396    2           ADDR(KQ_ERRLOG_BFR.INFO(7))->KQ$DFRBLK=KQ$DFRBLK;

  10396  1 007753   200007 470500                    LDP0    DFR$,,AUTO
         1 007754   000000 100500                    MLR     fill='000'O
         1 007755   000000 000040                    ADSC9   0,,PR0                   cn=0,n=32
         1 007756   000025 000040 xsym               ADSC9   KQ_ERRLOG_BFR+21         cn=0,n=32

     2878    10397    2         KQ_ERRLOG_BFR.CODE=CODE;

  10397  1 007757   200053 470500                    LDP0    @CODE,,AUTO
         1 007760   000000 236100                    LDQ     0,,PR0
         1 007761   000033 736000                    QLS     27
         1 007762   000000 552040 xsym               STBQ    KQ_ERRLOG_BFR,'40'O

     2879    10398    2         CALL ERRLOG;

  10398  1 007763   007774 701000 1                  TSX1    ERRLOG
         1 007764   000000 011000                    NOP     0

     2880    10399    2         RETURN;

  10399  1 007765   200052 221300                    LDX1  ! LDGRAN$+2,,AUTO
         1 007766   000001 702211                    TSX2  ! 1,X1

     2881    10400    2   END LOGERR;
     2882    10401        %EJECT;
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:374  
     2883    10402
     2884    10403
     2885    10404        /*F* NAME:         KQD$ERRLOG
     2886    10405
     2887    10406             PURPOSE:      Create an error log entry for a comgroup error
     2888    10407
     2889    10408        */
     2890    10409
     2891    10410
     2892    10411        /*D* NAME:         KQD$ERRLOG
     2893    10412
     2894    10413             CALL:         CALL KQD$ERRLOG(KQ$CG);
     2895    10414
     2896    10415             INPUT:        KQ$CG - The comgroup context block
     2897    10416
     2898    10417             DESCRIPTION:  The gate KQ_ERRLOG_GATE must be locked, and
     2899    10418                           KQ_ERRLOG_BFR must contains CODE, SIZ and INFO.
     2900    10419                           The common portions of the buffer are filled in,
     2901    10420                           the error logger is called, and the gate is
     2902    10421                           unlocked.
     2903    10422
     2904    10423        */
     2905    10424    1   KQD$ERRLOG: ENTRY(KQ$CG) ALTRET;

  10424  1 007767   000000 700200 xent  KQD$ERRLOG   TSX0  ! X66_AUTO_3
         1 007770   000122 000003                    ZERO    82,3

     2906    10425
     2907    10426    1         CALL ERRLOG;

  10426  1 007771   007774 701000 1                  TSX1    ERRLOG
         1 007772   000000 011000                    NOP     0

     2908    10427    1         RETURN;

  10427  1 007773   000000 702200 xent               TSX2  ! X66_ARET

PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:375  
     2909    10428
     2910    10429
     2911    10430    1   ERRLOG: PROC;

  10430  1 007774   200056 741300       ERRLOG       STX1  ! BLKX,,AUTO

     2912    10431
     2913    10432        /* AUTOMATIC */
     2914    10433    2   DCL CFU$ PTR;
     2915    10434    2   DCL 1 CFU REDEF CFU$,
     2916    10435    2         2 CTX UBIN(18) UNAL,
     2917    10436    2         2 * UBIN(18) UNAL;
     2918    10437
     2919    10438    2         CFU$=KQ$CG.CFU$;

  10438  1 007775   200003 470500                    LDP0    @KQ$CG,,AUTO
         1 007776   000214 236100                    LDQ     140,,PR0
         1 007777   200057 756100                    STQ     CFU$,,AUTO

     2920    10439    2         KQ_ERRLOG_BFR.ACCT=PINCRW(F$CFU$,CFU$->FM$CFU.ACCTX)->FM$CFUA.ACCT;

  10439  1 010000   200057 471500                    LDP1    CFU$,,AUTO
         1 010001   100002 220100                    LDX0    2,,PR1
         1 010002   000000 635010                    EAA     0,X0
         1 010003   000020 771000                    ARL     16
         1 010004   000000 473400 xsym               LDP3    F$CFU$
         1 010005   040000 100505                    MLR     fill='040'O
         1 010006   300001 000010                    ADSC9   1,A,PR3                  cn=0,n=8
         1 010007   000003 000010 xsym               ADSC9   KQ_ERRLOG_BFR+3          cn=0,n=8

     2921    10440    2         KQ_ERRLOG_BFR.PSN=FM$SET.PSN(KQ$CG.SETX);

  10440  1 010010   000216 236100                    LDQ     142,,PR0
         1 010011   000017 772000                    QRL     15
         1 010012   000052 376000 2                  ANQ     42
         1 010013   000002 736000                    QLS     2
         1 010014   040000 100506                    MLR     fill='040'O
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:376  
         1 010015   300000 400006                    ADSC9   0,Q,PR3                  cn=2,n=6
         1 010016   000001 400006 xsym               ADSC9   KQ_ERRLOG_BFR+1          cn=2,n=6

     2922    10441    3           DO WHILE(CFU$->FM$CFU.NAMEX<FM$CFUX.CFUT);

  10441  1 010017   100002 720100                    LXL0    2,,PR1
         1 010020   300002 100100                    CMPX0   2,,PR3
         1 010021   010034 603000 1                  TRC     s:10444

     2923    10442    3           CFU$=PINCRW(F$CFU$,CFU$->FM$CFU.NAMEX);

  10442  1 010022   200057 470500                    LDP0    CFU$,,AUTO
         1 010023   000002 720100                    LXL0    2,,PR0
         1 010024   000000 636010                    EAQ     0,X0
         1 010025   000000 036000 xsym               ADLQ    F$CFU$
         1 010026   200057 756100                    STQ     CFU$,,AUTO

     2924    10443    3           END;

  10443  1 010027   200057 470500                    LDP0    CFU$,,AUTO
         1 010030   000002 720100                    LXL0    2,,PR0
         1 010031   000000 471400 xsym               LDP1    F$CFU$
         1 010032   100002 100100                    CMPX0   2,,PR1
         1 010033   010022 602000 1                  TNC     s:10442

     2925    10444    2         CFU$=PINCRC(F$CFU$,CFU$->FM$CFU.NAMEX);

  10444  1 010034   200057 470500                    LDP0    CFU$,,AUTO
         1 010035   000002 236100                    LDQ     2,,PR0
         1 010036   777777 376007                    ANQ     -1,DL
         1 010037   000020 736000                    QLS     16
         1 010040   000000 036000 xsym               ADLQ    F$CFU$
         1 010041   200057 756100                    STQ     CFU$,,AUTO

     2926    10445    2         KQ_ERRLOG_BFR.FNAME.L=CFU$->FM$CFUN.L;

  10445  1 010042   200057 470500                    LDP0    CFU$,,AUTO
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:377  
         1 010043   000000 100500                    MLR     fill='000'O
         1 010044   000000 400001                    ADSC9   0,,PR0                   cn=2,n=1
         1 010045   000005 000001 xsym               ADSC9   KQ_ERRLOG_BFR+5          cn=0,n=1

     2927    10446    2         KQ_ERRLOG_BFR.FNAME.C=CFU$->FM$CFUN.C;

  10446  1 010046   000100 101500                    MRL     fill='000'O
         1 010047   000000 400001                    ADSC9   0,,PR0                   cn=2,n=1
         1 010050   200112 000002                    ADSC9   I$+1,,AUTO               cn=0,n=2
         1 010051   200112 220100                    LDX0    I$+1,,AUTO
         1 010052   040000 100540                    MLR     fill='040'O
         1 010053   000000 600010                    ADSC9   0,,PR0                   cn=3,n=*X0
         1 010054   000005 200037 xsym               ADSC9   KQ_ERRLOG_BFR+5          cn=1,n=31

     2928    10447    2         CFU$=ADDR(KQ$CG);

  10447  1 010055   200003 236100                    LDQ     @KQ$CG,,AUTO
         1 010056   200057 756100                    STQ     CFU$,,AUTO

     2929    10448    2         KQ_ERRLOG_BFR.CTX=CFU.CTX;

  10448  1 010057   200057 220100                    LDX0    CFU$,,AUTO
         1 010060   000001 740000 xsym               STX0    KQ_ERRLOG_BFR+1

     2930    10449    2         CALL ELA$SYSLOG(EL_CGERR,KQ_ERRLOG_BFR,POFFW(ADDR(KQ_ERRLOG_BFR.INFO),

  10449  1 010061   000053 236000 2                  LDQ     43
         1 010062   000022 772000                    QRL     18
         1 010063   200112 756100                    STQ     I$+1,,AUTO
         1 010064   000054 236000 2                  LDQ     44
         1 010065   000022 772000                    QRL     18
         1 010066   200112 136100                    SBLQ    I$+1,,AUTO
         1 010067   000015 036000 xsym               ADLQ    KQ_ERRLOG_BFR+13
         1 010070   200113 756100                    STQ     I$+2,,AUTO
         1 010071   200057 630500                    EPPR0   CFU$,,AUTO
         1 010072   200121 450500                    STP0    I$+8,,AUTO
         1 010073   000000 236000 2                  LDQ     0
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:378  
         1 010074   200120 756100                    STQ     I$+7,,AUTO
         1 010075   000012 236000 2                  LDQ     10
         1 010076   200117 756100                    STQ     I$+6,,AUTO
         1 010077   200113 631500                    EPPR1   I$+2,,AUTO
         1 010100   200116 451500                    STP1    I$+5,,AUTO
         1 010101   000056 237000 2                  LDAQ    46
         1 010102   200114 757100                    STAQ    I$+3,,AUTO
         1 010103   200114 630500                    EPPR0   I$+3,,AUTO
         1 010104   000024 631400 xsym               EPPR1   B_VECTNIL+20
         1 010105   000000 701000 xent               TSX1    ELA$SYSLOG
         1 010106   000000 011000                    NOP     0

     2931    10450    2         ADDR(KQ_ERRLOG_BFR))+KQ_ERRLOG_BFR.SIZ,'0'B,1,CFU$);
     2932    10451              %UNLOCK (G=KQ_ERRLOG_GATE);

  10452  1 010107   000051 630400 2                  EPPR0   41
         1 010110   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 010111   000000 701000 xent               TSX1    HFC$UNLOCK
         1 010112   000000 011000                    NOP     0

     2933    10454    2         RETURN;

  10454  1 010113   200056 221300                    LDX1  ! BLKX,,AUTO
         1 010114   000001 702211                    TSX2  ! 1,X1

KQ_DBLK
 Sect OctLoc
   0     000   000000 000000   000000 000000   000000 006014   000000 000000    ................
   0     004   000000 000000   555555 555555                                    ........

KQ_DFRBLK
 Sect OctLoc
   0     006   000000 006014   000000 000000   000000 000000   000000 006014    ................
   0     012   000000 000000   000000 000000   000000 000000   000000 006014    ................

KQ_IDGRAN
 Sect OctLoc
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:379  
   0     016   000000 000000   000000 000000   000000 006014   000000 000000    ................
   0     022   000000 000000   000000 006014   000000 006014   000000 006014    ................
   0     026   000000 006014   040040 040040   040040 040040   000000 000000    ....        ....
   0     032   000000 000000   000000 000000   000000 006014   000000 006014    ................
   0     036   000000 000000   000000 000000   000000 000000   000000 000000    ................
   0     042   000000 000000   000000 006014   000000 000000   000000 000000    ................
   0     046   000000 000000   000000 000000   000000 000000   000000 000000    ................
   0     052   000000 000000   000000 000000   000000 000000   000000 000000    ................

KQD_MINSPLIT
 Sect OctLoc
   0     056   000000 000024                                                    ....

(unnamed)
 Sect OctLoc
   0     057   112233 445566                                                    J...

(unnamed)
 Sect OctLoc
   2     000   000003 006000   000004 006000   000013 006000   000014 006000    ................
   2     004   000015 006000   000005 006000   000000 000014   000006 006000    ................
   2     010   776000 007777   777677 777777   000002 006000   777777 777377    ................
   2     014   000006 006000   000007 006000   000000 000033   000016 006000    ................
   2     020   777577 777777   000010 006000   000011 006000   000012 006000    ................
   2     024   777377 777777   000000 000046   000025 006000   000000 000031    .......&........
   2     030   000027 006000   000000 000047   000031 006000   000000 000015    .......'........
   2     034   000033 006000   777770 777777   777777 437777   000000 000017    ................
   2     040   000037 006000   777757 777777   000000 000016   000042 006000    ............."..
   2     044   737777 777777   000000 000034   000001 600000   000045 006000    .............%..
   2     050   777777 775044   000000 006000   000007 777770   000000 006000    ...$............
   2     054   000016 006000   000000 000464   000055 006000   000000 006000    .........-......
     2934    10455    2   END ERRLOG;
     2935    10456
     2936    10457    1   END KQD$GET;

PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:380  
--  Include file information  --

   XUD_UTS_M.:E05TOU  is referenced.
   SS_SCHED_C.:E05TOU  is referenced.
   N_FC_C.:E05TOU  is referenced.
   N$REQ.:E05TOU  is referenced.
   KQ_SUBS_C.:E05TOU  is referenced.
   KQ_DATA_R.:E05TOU  cannot be made into a system file and is referenced.
   KQ_MAC_C.:E05TOU  is referenced.
   KC_CP6.:E05TOU  is referenced.
   KC$CP6V_C.:E05TOU  is referenced.
   HF_LOCK_C.:E05TOU  cannot be made into a system file and is referenced.
   FM$SET.:E05TOU  is referenced.
   FM$CFU.:E05TOU  is referenced.
   EL_SUBS_C.:E05TOU  is referenced.
   EL$TABLES.:E05TOU  is referenced.
      No diagnostics issued in procedure KQD$GET.
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:381  

 **** Variables and constants ****

  ****  Section 000 RoData KQD$GET

  ****  Scalars and arrays  ****
OctLoc.c.b A Datatyp(siz) R M Lvl/name                 OctLoc.c.b A Datatyp(siz) R M Lvl/name

    56-0-0/w SBIN        r     1 KQD_MINSPLIT               0-0-0/d STRC(216)   r     1 KQ_DBLK
     6-0-0/d STRC(288)   r     1 KQ_DFRBLK                 16-0-0/d STRC(1152)  r     1 KQ_IDGRAN

  ****  Auto variables  ****

  ****  Scalars and arrays  ****
OctLoc.c.b A Datatyp(siz) R M Lvl/name                 OctLoc.c.b A Datatyp(siz) R M Lvl/name

   103-0-0/w PTR         r     1 @AVAIL                    53-0-0/w PTR         r     1 @CODE
   106-0-0/w PTR         r     1 @DA                      107-0-0/w PTR         r     1 @DFR$
   105-0-0/w PTR         r     1 @DGRAN$                  104-0-0/w PTR         r     1 @FREE
    53-0-0/w PTR         r     1 @HD$                       3-0-0/w PTR         r     1 @KQ$CG
     4-0-0/w PTR         r     1 @PDBLK$                    5-0-0/w PTR         r     1 @PDDA
   110-0-0/w PTR         r     1 @Q$                       54-0-0/w PTR         r     1 @WRD
   103-0-0/w UBIN        r     1 ADDFLG                    *0-0-0/w UBIN        r     1 AVAIL
    76-0-0/w UBIN        r     1 AVAILCNT                  70-0-0/w UBIN        r     1 AX
    73-0-0/w PTR         r     1 B$                        56-0-0/w UBIN        r     1 BLKX
    77-0-0/w BIT         r     1 BUDDIED                   72-0-0/w UBIN        r     1 BX
    57-0-0/w STRC        r     1 CFU                       57-0-0/w PTR         r     1 CFU$
    22-0-0/d STRC(108)   r     1 CHKPARM                   *0-0-0/w UBIN        r     1 CODE
    15-0-0/w UBIN        r     1 DA                        *0-0-0/w UBIN        r     1 DA
   101-0-0/w UBIN        r     1 DA                         6-0-0/w STRC        r     1 DBLK
     6-0-0/w PTR         r     1 DBLK$                     31-0-0/b STRC        r     1 DDA
    21-0-0/w UBIN        r     1 DELFLG                     7-0-0/w PTR         r     1 DFR$
    *0-0-0/w PTR         r     1 DFR$                      11-0-0/w STRC        r     1 DGRAN
    11-0-0/w PTR         r     1 DGRAN$                    *0-0-0/w PTR         r     1 DGRAN$
   105-0-0/w UBIN        r     1 ENTF                      77-0-0/w UBIN        r     1 ENTF
    20-0-0/w UBIN        r     1 ENTFLG                    37-0-0/w EPTR        r     1 EPTR$
    27-0-0/w UBIN        r     1 ERRCODE                  106-0-0/w UBIN        r     1 FLG
    *0-0-0/w UBIN        r     1 FREE                      62-0-0/w PTR         r     1 GDFR$
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:382  
    *0-0-0/w PTR         r     1 HD$                       12-0-0/w UBIN        r     1 I
    73-0-0/w SBIN        r     1 I                         54-0-0/w UBIN        r     1 I
   111-0-0/w PTR         r     1 I$                        13-0-0/w UBIN        r     1 J
    16-0-0/w STRC(72)    r     1 KEY                       *0-0-0/d STRC(6516)  r     1 KQ$CG
    32-0-0/w STRC(180)   r     1 KQ$DFRPARM                55-0-0/w UBIN        r     1 LASTX
    47-0-0/w PTR         r     1 LDBLK$                    46-0-0/w PTR         r     1 LDFR$
    50-0-0/w PTR         r     1 LDGRAN$                   56-0-0/w PTR         r     1 N$
    71-0-0/w UBIN        r     1 NAX                       65-0-0/w PTR         r     1 P$
    67-0-0/w PTR         r     1 P$                        67-0-0/w PTR         r     1 P$
    54-0-0/w PTR         r     1 P$                        45-0-0/w UBIN        r     1 PASS
    53-0-0/w UBIN        r     1 PASS                      74-0-0/w PTR         r     1 PB$
    *0-0-0/w PTR         r     1 PDBLK$                    *0-0-0/w BIT         r     1 PDDA
    *0-0-0/w EPTR        r     1 PEPTR$                    14-0-0/w PTR         r     1 PREVDBLK$
    *0-0-0/w UBIN        r     1 PSIZ                      *0-0-0/w PTR         r     1 PSTA$
    *0-0-0/w UBIN        r     1 PSTAMP                    70-0-0/w PTR         r     1 Q$
    *0-0-0/w PTR         r     1 Q$                       102-0-0/w PTR         r     1 Q$
    26-0-0/w UBIN        r     1 REGFLG                    75-0-0/w SBIN        r     1 SB
    42-0-0/w UBIN        r     1 SIZBYTES                 100-0-0/w UBIN        r     1 SIZW
    30-0-0/w UBIN        r     1 STAMP                     40-0-0/w PTR         r     1 T$
    64-0-0/w PTR         r     1 T$                        55-0-0/w PTR         r     1 T$
    61-0-0/w PTR         r     1 TDFR$                    100-0-0/w PTR         r     1 TDFR$
    53-0-0/w PTR         r     1 TDFR$                     63-0-0/w PTR         r     1 TDGRAN$
    *0-0-0/w UBIN        r     1 WRD

  ****  SYMREF variables  ****

  ****  Scalars and arrays  ****
OctLoc.c.b A Datatyp(siz) R M Lvl/name                 OctLoc.c.b A Datatyp(siz) R M Lvl/name

     0-0-0/w PTR         r     1 F$CFU$                     0-0-0/w UBIN        r     1 FM_FRZERO
     0-0-0/w UBIN        r     1 FM_WRCMP                   0-0-0/w UBIN        r     1 H_GATECNT
     0-0-0/w SBIN        r     1 KQ_BASEDELAY               0-0-0/w UBIN        r     1 KQ_DEBUG
     0-0-0/w STRC(2304)  r     1 KQ_ERRLOG_BFR              0-0-0/b BIT (72)    r     1 KQ_ERRLOG_GATE
     0-0-0/b STRC        r     1 KQ_LOG                     0-0-0/w STRC(288)   r     1 KQ_STATS
     0-0-0/w UBIN        r     1 NI$DS                      0-0-0/w UBIN        r     1 S_CUN
     0-0-0/w UBIN        r     1 S_TIMR

PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:383  
  ****  BASED and DCB variables  ****

  ****  Scalars and arrays  ****
OctLoc.c.b A Datatyp(siz) R M Lvl/name                 OctLoc.c.b A Datatyp(siz) R M Lvl/name

     0-0-0/w STRC(288)   r     1 FM$CFU                     0-0-0/w STRC(288)   r     1 FM$CFUA
     0-0-0/c ASTR(27)    r     1 FM$CFUN                    0-0-0/w STRC(288)   r     1 FM$CFUX
     0-0-0/w STRC(288)   r     1 FM$SET(0:0)                0-0-0/d STRC(216)   r     1 KQ$DBLK
     0-0-0/d STRC(288)   r     1 KQ$DFRBLK                  0-0-0/d STRC(1152)  r     1 KQ$DGRAN
     0-0-0/w STRC(144)   r     1 KQ$GRAN                    0-0-0/d STRC(576)   r     1 KQ$MBLK
     0-0-0/d STRC(1296)  r     1 KQ$STA                     0-0-0/d STRC(1080)  r     1 N$REQ
     0-0-0/d STRC(1080)  r     1 N$REQ                      0-0-0/w UBIN        r     1 WRD(0:1023)


   Procedure KQD$GET requires 4173 words for executable code.
   Procedure KQD$GET requires 82 words of local(AUTO) storage.

    No errors detected in file KQD$DBLK.:E05TSI    .
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:384  
          *** CROSS REFERENCE LISTING ***
**     DENOTES     IDENTIFIER DEFINITION
<<                 IDENTIFIER'S VALUE SET
>>                 IDENTIFIER'S VALUE USED
<>                 IDENTIFIER SET AND/OR USED
--                 IDENTIFIER REFERENCED
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:385  
          MINI XREF LISTING

ADDFLG IN PROCEDURE REMPAGE
      9551**DCL      9566<<ASSIGN   9568<<ASSIGN   9582>>IF
ALLOC
      8040**PROC     7575--CALL     7798--CALL
ALT IN PROCEDURE GETPAGE
      9523**LABEL    9500--CALLALT
ALTRT
      7563**LABEL   10090--CALLALT
AVAIL IN PROCEDURE COUNT_WORDS
      8228**DCL      8226--PROC     8270>>IF       8273>>IF
AVAILCNT IN PROCEDURE ALLOC
      8049**DCL      8054<<ASSIGN   8085<<ASSIGN   8085>>ASSIGN   8133<<ASSIGN   8133>>ASSIGN   8140>>IF
AX IN PROCEDURE ALLOC
      8043**DCL      8144<<ASSIGN   8145>>ASSIGN   8157>>ASSIGN   8164>>IF       8168>>ASSIGN   8170>>ASSIGN
      8171>>IF       8179>>IF       8194>>ASSIGN   8200<<ASSIGN   8201>>ASSIGN
B$ IN PROCEDURE ALLOC
      8046**DCL      8161<<ASSIGN   8173>>ASSIGN   8174>>ASSIGN   8179>>IF       8181>>ASSIGN   8181>>ASSIGN
      8182>>IF       8182>>IF       8184>>ASSIGN   8185>>ASSIGN   8185>>ASSIGN   8186>>ASSIGN   8190>>ASSIGN
      8191>>ASSIGN   8192<<ASSIGN
BLDHDR IN PROCEDURE GETPAGE
      9480**LABEL    9501--GOTO
BLKX IN PROCEDURE RCVGRAN
     10132**DCL     10136<<ASSIGN  10138>>ASSIGN  10139>>IF      10160>>ASSIGN  10164>>ASSIGN  10177>>ASSIGN
     10178>>ASSIGN  10179>>ASSIGN  10187<<ASSIGN  10187>>ASSIGN  10188>>IF
BUDDIED IN PROCEDURE ALLOC
      8050**DCL      8055<<ASSIGN   8140>>IF       8142<<ASSIGN
BUDDYNXT IN PROCEDURE ALLOC
      8187**LABEL    8176--GOTO     8188--GOTO
BX IN PROCEDURE ALLOC
      8045**DCL      8160<<ASSIGN   8161>>ASSIGN   8163>>DOWHILE  8164>>IF       8166>>ASSIGN   8171>>IF
      8179>>IF       8182>>IF       8190<<ASSIGN   8192>>ASSIGN
CFU.CTX IN PROCEDURE ERRLOG
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:386  
     10435**DCL     10448>>ASSIGN
CFU$ IN PROCEDURE ERRLOG
     10433**DCL     10434--REDEF   10438<<ASSIGN  10439>>ASSIGN  10441>>DOWHILE 10442<<ASSIGN  10442>>ASSIGN
     10444<<ASSIGN  10444>>ASSIGN  10445>>ASSIGN  10446>>ASSIGN  10446>>ASSIGN  10447<<ASSIGN  10449<>CALL
CHKBUDDY IN PROCEDURE ALLOC
      8105**LABEL    8203--GOTO
CHKPARM
      7057**DCL      8066<>CALL
CHKPARM.P$
      7059**DCL      8065<<ASSIGN
CODE IN PROCEDURE LOGERR
     10382**DCL     10379--PROC    10397>>ASSIGN
COMP
      9856**PROC     7820--CALL     7924--CALL     8422--CALL
COMP0 IN PROCEDURE COMP
      9860**LABEL    9921--GOTO
COMP1 IN PROCEDURE COMP
      9864**LABEL    9920--GOTO
COMP2 IN PROCEDURE COMP
      9874**LABEL    9915--GOTO
COMPDFR IN PROCEDURE COMP
      9913**ENTRY    9990--CALL
COMPLATER IN PROCEDURE COMP
      9917**ENTRY    8597--CALL
COMPRCVR IN PROCEDURE COMP
      9923**ENTRY   10074--CALL
COUNT_WORDS
      8226**PROC     8074--CALL     8107--CALL     8696--CALL     8822--CALL     8829--CALL     9944--CALL
     10152--CALL    10154--CALL    10182--CALL
CREG
      8512**LABEL    7609--GOTO     8440--GOTO
DA
      7051**DCL      7603<<ASSIGN   7662>>ASSIGN   7670>>ASSIGN   7732<<ASSIGN   7746<<ASSIGN   7850<<ASSIGN
      7852<<ASSIGN   7853>>IF       7868>>ASSIGN   7869>>ASSIGN   7898<<ASSIGN   7900>>ASSIGN   8348<<ASSIGN
      8349>>ASSIGN   8457>>ASSIGN   8948>>ASSIGN   8952<>CALL     9114>>IF       9119>>IF       9134>>IF
      9150>>IF       9187<>CALL     9209<>CALL     9283<<ASSIGN   9763<<ASSIGN   9773>>IF
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:387  
DA IN PROCEDURE REMPAGE
      9549**DCL      9561<<ASSIGN   9595>>ASSIGN   9604<>CALL     9622<>CALL     9633<>CALL
DA IN PROCEDURE WRITEGRAN
      9332**DCL      9325--PROC     9418<>CALL
DBLK.DISP
      7039**DCL      8773>>ASSIGN
DBLK$
      7036**DCL      6129--IMP-PTR  7037--REDEF    7587>>ASSIGN   7596>>ASSIGN   7663<<ASSIGN   7664>>ASSIGN
      7665>>ASSIGN   7667>>ASSIGN   7668>>ASSIGN   7801<<ASSIGN   7810>>ASSIGN   8058<<ASSIGN   8059>>DOWHILE
      8060>>IF       8063>>IF       8065>>ASSIGN   8068>>IF       8068>>IF       8072>>ASSIGN   8082>>ASSIGN
      8087>>ASSIGN   8093>>ASSIGN   8094>>ASSIGN   8098>>ASSIGN   8098>>ASSIGN   8099<<ASSIGN   8099>>ASSIGN
      8099>>ASSIGN   8103>>ASSIGN   8105>>ASSIGN   8111>>ASSIGN   8112<<ASSIGN   8112>>ASSIGN   8120<<ASSIGN
      8121>>DOWHILE  8122>>ASSIGN   8128>>ASSIGN   8130>>ASSIGN   8134>>ASSIGN   8135<<ASSIGN   8135>>ASSIGN
      8145<<ASSIGN   8146>>DOWHILE  8148>>ASSIGN   8149>>IF       8152>>ASSIGN   8154>>ASSIGN   8155>>ASSIGN
      8166>>ASSIGN   8171>>IF       8173>>ASSIGN   8174>>ASSIGN   8174>>ASSIGN   8181>>ASSIGN   8198>>ASSIGN
      8201<<ASSIGN   8212>>ASSIGN   8213>>ASSIGN   8214>>ASSIGN   8215>>ASSIGN   8216>>ASSIGN   8217>>ASSIGN
      8220>>ASSIGN   8233>>ASSIGN   8234>>ASSIGN   8266>>ASSIGN   8267>>ASSIGN   8271>>ASSIGN   8274>>ASSIGN
      8369<<ASSIGN   8370>>IF       8370>>IF       8378>>IF       8387>>ASSIGN   8393>>IF       8407>>ASSIGN
      8412<<ASSIGN   8418>>ASSIGN   8477<<ASSIGN   8488>>ASSIGN   8504>>ASSIGN   8536<<ASSIGN   8544>>ASSIGN
      8593>>ASSIGN   8663>>ASSIGN   8665>>IF       8667>>IF       8675>>ASSIGN   8681>>ASSIGN   8683>>ASSIGN
      8684>>ASSIGN   8685>>ASSIGN   8686>>ASSIGN   8751<<ASSIGN   8752>>ASSIGN   8767<<ASSIGN   8770>>ASSIGN
      8774>>ASSIGN   8783>>ASSIGN   8785>>IF       8785>>IF       8785>>IF       8796>>ASSIGN   8804>>ASSIGN
      8805>>ASSIGN   8807>>ASSIGN   8811>>ASSIGN   8812>>ASSIGN   8813>>ASSIGN   8814>>ASSIGN   8835>>ASSIGN
      9931<<ASSIGN   9932>>IF       9933>>ASSIGN   9937>>ASSIGN   9939>>ASSIGN   9940>>ASSIGN   9941>>ASSIGN
      9942>>ASSIGN   9943>>ASSIGN  10138<<ASSIGN  10139>>IF      10150>>ASSIGN  10151>>ASSIGN  10153>>ASSIGN
     10155>>ASSIGN  10158>>IF      10158>>IF      10160>>ASSIGN  10162>>IF      10162>>IF      10164>>ASSIGN
     10165>>IF      10172>>IF      10175>>ASSIGN  10185>>ASSIGN  10186>>IF      10187>>ASSIGN  10393>>IF
     10394>>ASSIGN
DDA
      7063**DCL      7588<>CALL     7597>>ASSIGN   7802<<ASSIGN   7811>>ASSIGN   7816<>CALL     8340<<ASSIGN
      8345<>CALL     8419>>ASSIGN   8452<>CALL     8456>>ASSIGN   8478<<ASSIGN   8490>>ASSIGN   8529<<ASSIGN
      8545<>CALL     8708<<ASSIGN   8775<>CALL     8791<<ASSIGN   8835<<ASSIGN   8837<<ASSIGN   8840>>IF
      8857>>IF
DDA.DA
      7065**DCL      8219<<ASSIGN   8348>>ASSIGN   8772<<ASSIGN
DDA.DISP
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:388  
      7064**DCL      8220<<ASSIGN   8369>>ASSIGN   8773<<ASSIGN
DEL30
      8785**LABEL    8795--GOTO
DEL45
      8822**LABEL    8698--GOTO
DEL50
      8833**LABEL    8709--GOTO     8792--GOTO
DEL55
      8850**LABEL    8848--GOTO
DEL60
      8850**LABEL    8849--CALLALT  8850--CALLALT
DELCOM
      8762**LABEL    8744--GOTO     8748--GOTO     8759--GOTO
DELCOM4
      8775**LABEL    8399--GOTO
DELFLG
      7056**DCL      8392<<ASSIGN   8743<<ASSIGN   8747<<ASSIGN   8758<<ASSIGN   8762<<ASSIGN   8775<>CALL
      8799>>DOCASE   8809>>IF      10315<<ASSIGN  10320<<ASSIGN  10342>>IF      10356>>IF
DELNODBLK
      8500**LABEL    8395--CALLALT
DFR$
      7041**DCL      6182--IMP-PTR  7556<<ASSIGN   7587>>ASSIGN   7591>>IF       7604>>IF       7613>>ASSIGN
      7617>>ASSIGN   7619>>ASSIGN   7621>>ASSIGN   7622>>ASSIGN   7632>>IF       7634>>IF       7636>>ASSIGN
      7637>>ASSIGN   7638>>ASSIGN   7707>>ASSIGN   7714<<ASSIGN   7715>>IF       7720>>DOWHILE  7721>>ASSIGN
      7722<<ASSIGN   7722>>ASSIGN   7730>>ASSIGN   7731>>ASSIGN   7733>>ASSIGN   7736>>ASSIGN   7748>>ASSIGN
      7749>>ASSIGN   7750>>ASSIGN   7753>>ASSIGN   7773>>IF       7774>>ASSIGN   7777>>ASSIGN   7782>>ASSIGN
      7783>>ASSIGN   7787>>IF       7788>>IF       7794<<ASSIGN   7795>>ASSIGN   7796>>ASSIGN   7797>>IF
      7806>>IF       7808>>IF       7810>>ASSIGN   7811>>ASSIGN   7812>>ASSIGN   7815>>ASSIGN   7827>>ASSIGN
      7830<<ASSIGN   7835>>ASSIGN   7847>>IF       7856>>ASSIGN   7857>>ASSIGN   7860>>ASSIGN   7868>>ASSIGN
      7881>>IF       7900>>ASSIGN   7912<<ASSIGN   7913>>ASSIGN   7914>>IF       7918>>IF       7920>>IF
      7922>>ASSIGN   7923>>ASSIGN   7931>>ASSIGN   7934<<ASSIGN   7935>>IF       7937>>ASSIGN   7963<<ASSIGN
      7971<<ASSIGN   7994<<ASSIGN   8029<<ASSIGN   8031<<ASSIGN   8339<<ASSIGN   8344>>ASSIGN   8361>>IF
      8393>>IF       8396>>ASSIGN   8397>>ASSIGN   8402>>IF       8415>>IF       8418>>ASSIGN   8419>>ASSIGN
      8420>>ASSIGN   8421>>ASSIGN   8435>>IF       8446>>ASSIGN   8447>>ASSIGN   8451>>ASSIGN   8456>>ASSIGN
      8457>>ASSIGN   8458>>ASSIGN   8463>>IF       8467>>IF       8476>>ASSIGN   8477>>ASSIGN   8478>>ASSIGN
      8500>>ASSIGN   8527<<ASSIGN   8529>>ASSIGN   8530>>ASSIGN   8531>>ASSIGN   8533>>ASSIGN   8534>>IF
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:389  
      8544>>ASSIGN   8586<<ASSIGN   8587>>ASSIGN   8588>>ASSIGN   8589>>IF       8590>>ASSIGN   8591>>ASSIGN
      8593>>ASSIGN   8603<<ASSIGN   8604>>ASSIGN   8606>>ASSIGN   8613>>IF       8615>>ASSIGN   8616>>ASSIGN
      8768<<ASSIGN   8840>>IF       8938<<ASSIGN   8939>>ASSIGN   8942>>ASSIGN   8945>>ASSIGN   8946>>ASSIGN
      8948>>ASSIGN   8949>>ASSIGN   8951>>ASSIGN   8977<<ASSIGN   8984>>ASSIGN   8984>>ASSIGN   8988>>ASSIGN
      8990>>ASSIGN   8991>>ASSIGN   8992>>ASSIGN   8993<<ASSIGN   9023<<ASSIGN   9121>>ASSIGN   9122>>ASSIGN
      9123>>ASSIGN   9136>>ASSIGN   9137>>ASSIGN   9139>>ASSIGN   9152>>ASSIGN   9153>>ASSIGN   9154>>ASSIGN
      9168>>ASSIGN   9170>>ASSIGN   9172>>ASSIGN   9173>>ASSIGN   9182>>ASSIGN   9186>>ASSIGN   9207>>ASSIGN
      9241>>IF       9244>>ASSIGN   9246>>ASSIGN   9247>>IF       9250>>ASSIGN   9252>>ASSIGN   9253>>ASSIGN
      9254>>ASSIGN   9271>>ASSIGN   9280<<ASSIGN   9282>>ASSIGN   9283>>ASSIGN   9507>>ASSIGN   9509>>ASSIGN
      9510>>ASSIGN   9511>>ASSIGN   9562>>ASSIGN   9574>>ASSIGN   9576>>ASSIGN   9577>>ASSIGN   9578>>ASSIGN
      9594>>ASSIGN   9595>>ASSIGN   9597>>ASSIGN   9599>>ASSIGN   9600>>ASSIGN   9603>>ASSIGN   9621>>ASSIGN
      9626<<ASSIGN   9734>>ASSIGN   9743<<ASSIGN   9744>>ASSIGN   9745>>IF       9747>>ASSIGN   9749>>DOCASE
      9752<<ASSIGN   9758>>IF       9763>>ASSIGN   9765>>ASSIGN   9767>>ASSIGN   9768>>ASSIGN   9806<<ASSIGN
      9823<<ASSIGN   9860>>IF       9860>>IF       9861>>IF       9865>>ASSIGN   9866>>ASSIGN   9875>>ASSIGN
      9876>>ASSIGN   9877>>ASSIGN   9878>>ASSIGN   9879>>ASSIGN   9887>>IF       9892>>CALL     9919>>IF
      9919>>IF       9919>>IF       9931>>ASSIGN   9935>>DOCASE   9988<<ASSIGN   9989>>ASSIGN  10052<<ASSIGN
     10054>>DOWHILE 10056>>ASSIGN  10057<<ASSIGN  10057>>ASSIGN  10070<<ASSIGN  10071>>DOCASE  10079>>ASSIGN
     10104<<ASSIGN  10105>>ASSIGN  10395>>IF      10396>>ASSIGN
DFR$ IN PROCEDURE WRITEGRAN
      9333**DCL      9325--PROC     9427>>ASSIGN
DGRAN.DISP
      7046**DCL      7873<<ASSIGN   8357<<ASSIGN   8753<<ASSIGN   8771<<ASSIGN   8784<<ASSIGN   9934<<ASSIGN
DGRAN$
      7043**DCL      6232--IMP-PTR  6380--IMP-PTR  7044--REDEF    7571<<ASSIGN   7572>>DOWHILE  7573>>IF
      7580<<ASSIGN   7580>>ASSIGN   7660>>IF       7662>>ASSIGN   7663>>ASSIGN   7666>>ASSIGN   7667>>ASSIGN
      7668>>ASSIGN   7672>>ASSIGN   7674>>ASSIGN   7675>>ASSIGN   7676>>ASSIGN   7678>>ASSIGN   7680>>ASSIGN
      7681>>ASSIGN   7682>>CALL     7683>>ASSIGN   7683>>ASSIGN   7709>>ASSIGN   7710<<ASSIGN   7777>>ASSIGN
      7784>>ASSIGN   7785>>IF       7813>>ASSIGN   7813>>ASSIGN   7815>>ASSIGN   7824>>ASSIGN   7824>>ASSIGN
      7849>>IF       7852>>ASSIGN   7872<<ASSIGN   7874>>IF       7896<<ASSIGN   7964<<ASSIGN   7972<<ASSIGN
      7995<<ASSIGN   8032<<ASSIGN   8058>>ASSIGN   8058>>ASSIGN   8059>>DOWHILE  8083>>ASSIGN   8103>>ASSIGN
      8112>>ASSIGN   8120>>ASSIGN   8120>>ASSIGN   8121>>DOWHILE  8128>>ASSIGN   8135>>ASSIGN   8140>>IF
      8144>>ASSIGN   8145>>ASSIGN   8146>>DOWHILE  8147>>ASSIGN   8152>>ASSIGN   8156>>IF       8157>>ASSIGN
      8160>>ASSIGN   8161>>ASSIGN   8168>>ASSIGN   8184>>ASSIGN   8192>>ASSIGN   8201>>ASSIGN   8209>>ASSIGN
      8209>>ASSIGN   8210>>ASSIGN   8210>>ASSIGN   8211>>ASSIGN   8219>>ASSIGN   8220>>ASSIGN   8233>>ASSIGN
      8233>>ASSIGN   8235>>IF       8247>>IF       8266>>ASSIGN   8266>>ASSIGN   8271>>ASSIGN   8271>>ASSIGN
      8274>>ASSIGN   8274>>ASSIGN   8356<<ASSIGN   8358>>IF       8358>>IF       8360>>ASSIGN   8360>>ASSIGN
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:390  
      8369>>ASSIGN   8386>>ASSIGN   8386>>ASSIGN   8411>>ASSIGN   8411>>ASSIGN   8505>>ASSIGN   8505>>ASSIGN
      8528<<ASSIGN   8537>>IF       8664>>ASSIGN   8664>>ASSIGN   8674>>ASSIGN   8674>>ASSIGN   8675>>ASSIGN
      8676>>ASSIGN   8680>>IF       8681>>ASSIGN   8687>>ASSIGN   8700>>ASSIGN   8752<<ASSIGN   8754>>ASSIGN
      8770<<ASSIGN   8772>>ASSIGN   8783<<ASSIGN   8794>>IF       8797>>ASSIGN   8797>>ASSIGN   8798>>ASSIGN
      8798>>ASSIGN   8801>>ASSIGN   8804>>ASSIGN   8805>>ASSIGN   8805>>ASSIGN   8806>>ASSIGN   8842>>IF
      8845>>ASSIGN   8847>>IF       9182>>ASSIGN   9186>>ASSIGN   9192>>IF       9201>>ASSIGN   9211>>ASSIGN
      9282<<ASSIGN   9411>>CALL     9427>>ASSIGN   9472<<ASSIGN   9473>>ASSIGN   9480<<ASSIGN   9485>>ASSIGN
      9486>>ASSIGN   9487>>ASSIGN   9488>>ASSIGN   9489>>ASSIGN   9489>>ASSIGN   9496<<ASSIGN   9497>>DOWHILE
      9498>>IF       9499>>ASSIGN   9503<<ASSIGN   9503>>ASSIGN   9561>>ASSIGN   9564>>IF       9564>>IF
      9564>>IF       9569>>IF       9569>>IF       9584>>ASSIGN   9585>>ASSIGN   9586>>ASSIGN   9587>>ASSIGN
      9588>>ASSIGN   9591>>ASSIGN   9592>>ASSIGN   9592>>ASSIGN   9603>>ASSIGN   9609>>CALL     9609>>CALL
      9611>>IF       9612>>ASSIGN   9614>>ASSIGN   9614>>ASSIGN   9615>>IF       9616>>ASSIGN   9618>>ASSIGN
      9618>>ASSIGN   9620>>ASSIGN   9621>>ASSIGN   9627<<ASSIGN   9632>>ASSIGN   9638>>CALL     9638>>CALL
      9640>>IF       9641>>ASSIGN   9643>>ASSIGN   9643>>ASSIGN   9644>>IF       9645>>ASSIGN   9647>>ASSIGN
      9647>>ASSIGN   9649>>ASSIGN   9693<<ASSIGN   9735>>ASSIGN   9736>>ASSIGN   9737>>ASSIGN   9738>>ASSIGN
      9739>>ASSIGN   9739>>ASSIGN   9812>>ASSIGN   9813>>ASSIGN   9819>>ASSIGN   9819<<ASSIGN   9897>>ASSIGN
      9897>>ASSIGN   9933<<ASSIGN   9939>>ASSIGN   9940>>ASSIGN   9940>>ASSIGN  10087<<ASSIGN  10088>>DOWHILE
     10089<<ASSIGN  10089>>ASSIGN  10091<<ASSIGN  10091>>ASSIGN  10138>>ASSIGN  10145>>ASSIGN  10146>>ASSIGN
     10151>>ASSIGN  10153>>ASSIGN  10177>>ASSIGN  10178>>ASSIGN  10228<<ASSIGN  10229>>ASSIGN  10235<<ASSIGN
     10237>>ASSIGN  10238>>ASSIGN  10239>>ASSIGN  10240>>ASSIGN  10241>>ASSIGN  10241>>ASSIGN  10245<<ASSIGN
     10246>>DOWHILE 10247>>IF      10249>>ASSIGN  10253<<ASSIGN  10253>>ASSIGN  10324<<ASSIGN  10325>>DOWHILE
     10326>>IF      10326>>IF      10328>>ASSIGN  10329>>IF      10331>>IF      10338>>ASSIGN  10341>>ASSIGN
     10343>>IF      10344>>IF      10345>>ASSIGN  10348>>ASSIGN  10356>>IF      10357>>IF      10358>>ASSIGN
     10360>>ASSIGN  10362<<ASSIGN  10362>>ASSIGN
DGRAN$ IN PROCEDURE WRITEGRAN
      9331**DCL      9325--PROC     9413>>ASSIGN   9425>>ASSIGN
ELA$SYSLOG
      7382**DCL-ENT 10449--CALL
ENTF IN PROCEDURE GETBLK
      8922**DCL      8925<<ASSIGN   8930<<ASSIGN   8964>>IF
ENTF IN PROCEDURE REMPAGE
      9547**DCL      9553<<ASSIGN   9558<<ASSIGN   9571>>IF
ENTFLG
      7055**DCL      7555<<ASSIGN   8335<<ASSIGN   8345<>CALL     8362>>DOCASE   8370>>IF       8388>>DOCASE
      8444>>IF       8452<>CALL     8460>>IF       8489>>IF       8531<<ASSIGN   8545<>CALL     8587<<ASSIGN
      8594<>CALL     8604<<ASSIGN   8607<>CALL     8659<<ASSIGN   8765<<ASSIGN   8833>>DOCASE   8888<<ASSIGN
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:391  
      8949>>ASSIGN   8952<>CALL    10300<<ASSIGN
EPTR$
      7095**DCL      9879<<ASSIGN   9884>>CALL
ERR IN PROCEDURE READGRAN
      9256**LABEL    9209--CALLALT  9210--CALLALT
ERR IN PROCEDURE REMPAGE
      9649**LABEL    9609--CALLALT  9638--CALLALT  9655--GOTO
ERR IN PROCEDURE WRITEGRAN
      9429**LABEL    9418--CALLALT  9419--CALLALT  9434--GOTO
ERRCODE
      7061**DCL      7638<<ASSIGN   7646>>IF       7649>>ASSIGN   8372<<ASSIGN   8380<<ASSIGN   8420>>ASSIGN
      8429>>ASSIGN   8476<<ASSIGN   8486>>IF       8496>>ASSIGN   8533<<ASSIGN   8534>>IF       9494<<ASSIGN
ERRLOG
     10430**PROC    10398--CALL    10426--CALL
F$CFU$
      7110**DCL      6075--IMP-PTR  6080--IMP-PTR 10439>>ASSIGN  10440>>ASSIGN  10441>>DOWHILE 10442>>ASSIGN
     10444>>ASSIGN
FAF$FRTOSRNJ
      7383**DCL-ENT  9209--CALL     9418--CALL
FAF$SRTODR
      7384**DCL-ENT  9210--CALL     9419--CALL
FETCH
      8340**LABEL    8858--GOTO
FETCHDONE
      8361**LABEL    8549--GOTO
FLG IN PROCEDURE GETBLK
      8923**DCL      8933<<ASSIGN   8955>>IF       8973<<ASSIGN   8984<<ASSIGN   8985<>CALL
FM$CFU.ACCTX
      6061**DCL      6061--REDEF   10439>>ASSIGN
FM$CFU.NAMEX
      6061**DCL     10441>>DOWHILE 10442>>ASSIGN  10444>>ASSIGN
FM$CFUA.ACCT
      6066**DCL     10439>>ASSIGN
FM$CFUN.C
      6072**DCL     10446>>ASSIGN
FM$CFUN.L
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:392  
      6072**DCL      6072--IMP-SIZ 10445>>ASSIGN  10446>>ASSIGN
FM$CFUX.CFUT
      6075**DCL     10441>>DOWHILE
FM$SET.PSN
      6080**DCL     10440>>ASSIGN
FM$SET.USERLIST
      6081**DCL      6081--REDEF
FM_FRZERO
      7111**DCL      7898>>ASSIGN   9114>>IF
FM_WRCMP
      7112**DCL      9420>>IF
FREE IN PROCEDURE COUNT_WORDS
      8229**DCL      8226--PROC     8231>>IF       8245>>IF
FTCH10
      8350**LABEL    8438--CALLALT
FTCH15
      8407**LABEL    8376--GOTO     8384--GOTO     8540--GOTO
FTCH18
      8412**LABEL    8538--GOTO
FTCH19
      8412**LABEL    8403--GOTO
FTCH20
      8429**LABEL    8355--CALLALT  8359--GOTO
FTCH30
      8460**LABEL    7628--GOTO     7635--GOTO     7654--GOTO     8470--GOTO
FTCH40
      8465**LABEL    8626--GOTO
FTCH5
      8332**LABEL    8328--GOTO
FTCH8
      8335**LABEL    8660--GOTO     8889--GOTO
GDFR$ IN PROCEDURE GETINIT
      7702**DCL      7708<<ASSIGN   7730<<ASSIGN   7748<<ASSIGN   7783<<ASSIGN   7830>>ASSIGN   7831>>IF
      7934>>ASSIGN   7944<<ASSIGN
GET10
      7558**LABEL    7607--CALLALT
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:393  
GET10 IN PROCEDURE GETBLK
      8930**LABEL    8926--GOTO
GET20 IN PROCEDURE GETBLK
      8933**LABEL    8974--GOTO
GETBLK
      8917**PROC     7611--CALL     7729--CALL     7747--CALL     8395--CALL     8442--CALL     9593--CALL
GETBLKR IN PROCEDURE GETBLK
      8928**ENTRY    7607--CALL     8438--CALL
GETCOM
      7551**LABEL    7547--GOTO
GETFREE IN PROCEDURE GETINIT
      7862**LABEL    7741--GOTO
GETINIT
      7699**PROC     7631--CALL     7999--CALL
GETNEW IN PROCEDURE GETINIT
      7881**LABEL    7789--GOTO     7865--GOTO
GETNEW5 IN PROCEDURE GETINIT
      7878**LABEL    7758--GOTO
GETNOSPACE IN PROCEDURE GETINIT
      7907**LABEL    7761--GOTO     7929--GOTO
GETPAGE
      9461**PROC     7894--CALL     9166--CALL
GETPROCESS IN PROCEDURE GETINIT
      7769**ENTRY    8033--CALL     9751--CALL
GETSPACE
      7597**LABEL    7582--GOTO
GOTDBLK
      7572**LABEL    7576--GOTO
GOTDBLK IN PROCEDURE ALLOC
      8209**LABEL    8108--GOTO
HD$ IN PROCEDURE RCVCHAIN
     10101**DCL     10099--PROC    10103>>DOWHILE 10104>>ASSIGN  10105<<ASSIGN
HFC$LOCK
       515**DCL-ENT  7567--CALL     7640--CALL     7822--CALL     7927--CALL     7997--CALL     8255--CALL
      8352--CALL     8480--CALL     8584--CALL     8611--CALL     8779--CALL     8971--CALL     9195--CALL
      9226--CALL     9236--CALL     9404--CALL     9517--CALL     9695--CALL     9798--CALL     9828--CALL
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:394  
      9979--CALL    10223--CALL    10304--CALL    10386--CALL
HFC$UNLOCK
       515**DCL-ENT  7594--CALL     7626--CALL     7644--CALL     7960--CALL     7969--CALL     8262--CALL
      8405--CALL     8426--CALL     8484--CALL     8509--CALL     8518--CALL     8618--CALL     8624--CALL
      8854--CALL     8967--CALL     9125--CALL     9141--CALL     9156--CALL     9176--CALL     9199--CALL
      9230--CALL     9256--CALL     9408--CALL     9514--CALL     9521--CALL     9624--CALL     9660--CALL
      9699--CALL     9791--CALL     9803--CALL     9870--CALL     9882--CALL     9890--CALL     9901--CALL
      9907--CALL     9984--CALL    10265--CALL    10452--CALL
H_GATECNT
      7113**DCL      9863>>IF
I
      7048**DCL      7774<<ASSIGN   7776<<ASSIGN   7778<>CALL     8675<<ASSIGN   8678>>IF      10234<>CALL
     10322<>CALL    10343>>IF      10356>>IF
I IN PROCEDURE GETPAGE
      9467**DCL      9479<>CALL
I IN PROCEDURE RCVGRAN
     10130**DCL     10150<<ASSIGN  10155>>ASSIGN  10164<<ASSIGN  10165<<ASSIGN  10165>>ASSIGN  10166>>IF
I$ IN PROCEDURE WRITEGRAN
      9400**DCL      9417<<ASSIGN   9418<>CALL
INITGRAN
      7657**PROC     7901--CALL
J
      7049**DCL      8212<<ASSIGN   8214>>ASSIGN   8676<<ASSIGN   8677>>DOWHILE  8678>>IF       8680>>IF
      8700>>ASSIGN   8701<<ASSIGN  10321<>CALL    10322<>CALL    10345>>ASSIGN  10360>>ASSIGN
KEEPIT IN PROCEDURE RELPAGE
      9811**LABEL    9818--GOTO
KEY
      7052**DCL      7673<>CALL     7871<>CALL     8355<>CALL
KEY.DA
      7053**DCL      7670<<ASSIGN   7869<<ASSIGN   8349<<ASSIGN
KEY.GARB
      7054**DCL      7671<<ASSIGN   7870<<ASSIGN   8350<<ASSIGN
KQ$CG
      5324**DCL        17--PROC     7549--ENTRY    7588<>CALL     7614<>CALL     7737<>CALL     7754<>CALL
      7778<>CALL     7816<>CALL     7836<>CALL     7861<>CALL     7925<>CALL     7938<>CALL     7991--ENTRY
      8025--ENTRY    8325--ENTRY    8330--ENTRY    8345<>CALL     8452<>CALL     8525--ENTRY    8545<>CALL
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:395  
      8581--ENTRY    8594<>CALL     8601--ENTRY    8607<>CALL     8655--ENTRY    8742--ENTRY    8746--ENTRY
      8750--ENTRY    8757--ENTRY    8761--ENTRY    8775<>CALL     8885--ENTRY    8952<>CALL     8985<>CALL
      9020--ENTRY    9187<>CALL     9208--ASSIGN   9302--ENTRY    9426--ASSIGN   9479<>CALL     9604<>CALL
      9633<>CALL     9691--ENTRY    9820<>CALL     9975--ENTRY   10049--ENTRY   10094--CALL    10219--ENTRY
     10234<>CALL    10298--ENTRY   10424--ENTRY   10447--ASSIGN
KQ$CG.ADDFREE
      5885**DCL      7725>>IF       9589<<ASSIGN   9589>>ASSIGN
KQ$CG.AUCTL.DVBYTE.REREAD
      5767**DCL      5768--REDEF
KQ$CG.AUCTL.MAXPG
      5764**DCL      7744>>IF       7884>>IF
KQ$CG.AUCTL.REDISKWARN
      5774**DCL      8239>>IF
KQ$CG.AUCTL.WRITETIME
      5769**DCL     10314>>ASSIGN  10319>>ASSIGN  10322>>CALL
KQ$CG.AVAIL.HD$
      5955**DCL      7571>>ASSIGN   7676>>ASSIGN   7680>>ASSIGN   7681<<ASSIGN   9612<<ASSIGN   9641<<ASSIGN
KQ$CG.AVAIL.TL$
      5957**DCL      7677>>IF       7678<<ASSIGN   9496>>ASSIGN   9616<<ASSIGN   9645<<ASSIGN  10245>>ASSIGN
     10324>>ASSIGN
KQ$CG.BASEDELAY
      5434**DCL      8259<<ASSIGN   8259>>ASSIGN   9867<<ASSIGN   9867>>ASSIGN
KQ$CG.CFU$
      5835**DCL      9203>>ASSIGN   9417>>ASSIGN  10438>>ASSIGN
KQ$CG.CURDATAPGS
      5944**DCL      8844>>IF       9477>>IF       9481<<ASSIGN   9481>>ASSIGN   9741>>IF       9810>>IF
      9817>>IF       9821<<ASSIGN   9821>>ASSIGN  10232>>IF      10236<<ASSIGN  10236>>ASSIGN  10331>>IF
     10331>>IF
KQ$CG.DATAFREE$
      5950**DCL      9470>>IF       9472>>ASSIGN   9473<<ASSIGN   9812>>ASSIGN   9813<<ASSIGN  10226>>IF
     10228>>ASSIGN  10229<<ASSIGN
KQ$CG.DELAY.DISKWARN
      5411**DCL      8257<<ASSIGN
KQ$CG.DELAY.NEEDPG
      5398**DCL      8844>>IF       9519<<ASSIGN   9795>>IF       9801<<ASSIGN
KQ$CG.DFRDFR$
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:396  
      5437**DCL      9865>>ASSIGN   9866<<ASSIGN   9981>>IF       9988>>ASSIGN   9989<<ASSIGN  10069>>DOWHILE
     10070>>ASSIGN  10079<<ASSIGN
KQ$CG.DFRFREEHD$
      5889**DCL      8936>>IF       8938>>ASSIGN   8939<<ASSIGN   8940>>IF       8990<<ASSIGN  10052>>ASSIGN
KQ$CG.DFRFREETL$
      6044**DCL      8941<<ASSIGN   8989>>IF       8991>>ASSIGN   8992<<ASSIGN  10053<<ASSIGN  10056<<ASSIGN
KQ$CG.DTREE
      5907**DCL      7673<>CALL     7871<>CALL     8355<>CALL     9609<>CALL     9638<>CALL
KQ$CG.DTREE.GATE
      5909**DCL      7567<>CALL     7594<>CALL     7626<>CALL     7640<>CALL     7644<>CALL     7822<>CALL
      7927<>CALL     7960<>CALL     7969<>CALL     7997<>CALL     8352<>CALL     8405<>CALL     8426<>CALL
      8480<>CALL     8484<>CALL     8509<>CALL     8518<>CALL     8584<>CALL     8611<>CALL     8618<>CALL
      8624<>CALL     8779<>CALL     8854<>CALL     8967<>CALL     8971<>CALL     9125<>CALL     9141<>CALL
      9156<>CALL     9176<>CALL     9236<>CALL     9256<>CALL     9514<>CALL     9624<>CALL     9660<>CALL
      9695<>CALL     9699<>CALL     9791<>CALL     9828<>CALL     9870<>CALL     9882<>CALL     9890<>CALL
      9901<>CALL     9907<>CALL     9979<>CALL     9984<>CALL    10223<>CALL    10265<>CALL    10304<>CALL
KQ$CG.DTREE.HEAD$
      5917**DCL     10087>>ASSIGN
KQ$CG.FORCECNT
      5930**DCL     10309>>IF      10311>>IF      10312<<ASSIGN  10312>>ASSIGN  10314<<ASSIGN  10319<<ASSIGN
KQ$CG.FREEDA
      5881**DCL      7724>>IF       7732>>ASSIGN   9584>>ASSIGN   9585<<ASSIGN
KQ$CG.FWUSR#
      5746**DCL      9817>>IF
KQ$CG.GATE.CG
      5714**DCL      8255<>CALL     8262<>CALL     9195<>CALL     9199<>CALL     9226<>CALL     9230<>CALL
      9404<>CALL     9408<>CALL     9517<>CALL     9521<>CALL     9798<>CALL     9803<>CALL
KQ$CG.GETFLG
      5879**DCL      7623>>IF       7630<<ASSIGN   7712>>IF       7717<<ASSIGN   7734<<ASSIGN   7751<<ASSIGN
      7833<<ASSIGN   7845>>DOCASE   7855<<ASSIGN   7889<<ASSIGN   7948<<ASSIGN   7952<<ASSIGN
KQ$CG.GETHD$
      6034**DCL      7619<<ASSIGN   7714>>ASSIGN   7791>>ASSIGN   7806>>IF       7807<<ASSIGN   7831>>IF
      7887>>IF       7909>>ASSIGN   7918>>IF       7919<<ASSIGN   7946>>IF      10066<>CALL
KQ$CG.GETTL$
      6037**DCL      7618>>IF       7621>>ASSIGN   7622<<ASSIGN   7808>>IF       7809<<ASSIGN   7920>>IF
      7921<<ASSIGN  10067<<ASSIGN
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:397  
KQ$CG.GRAN
      5994**DCL      9486>>ASSIGN   9736>>ASSIGN  10238>>ASSIGN
KQ$CG.HIGRANS
      5855**DCL      7898>>ASSIGN   7899<<ASSIGN   7899>>ASSIGN
KQ$CG.IOCNT
      5876**DCL      9197<<ASSIGN   9197>>ASSIGN   9228<<ASSIGN   9228>>ASSIGN   9406<<ASSIGN   9406>>ASSIGN
     10307>>IF      10331>>IF      10331>>IF
KQ$CG.IOHD$
      5959**DCL      9117>>ASSIGN   9170<<ASSIGN   9239>>ASSIGN   9244<<ASSIGN   9597<<ASSIGN   9764>>IF
      9765<<ASSIGN  10060<>CALL
KQ$CG.IOQHD$
      6039**DCL      9148>>ASSIGN   9249>>IF       9250<<ASSIGN  10064<>CALL
KQ$CG.IOQTL$
      6042**DCL      9152>>ASSIGN   9153<<ASSIGN   9252>>ASSIGN   9253<<ASSIGN  10065<<ASSIGN
KQ$CG.IOTL$
      5962**DCL      9121>>ASSIGN   9122<<ASSIGN   9169>>IF       9172>>ASSIGN   9173<<ASSIGN   9247>>IF
      9248<<ASSIGN   9596>>IF       9599>>ASSIGN   9600<<ASSIGN   9767>>ASSIGN   9768<<ASSIGN   9781>>ASSIGN
      9782<<ASSIGN  10061<<ASSIGN
KQ$CG.MAXDATAPGS
      5941**DCL      8844>>IF       9477>>IF       9741>>IF      10232>>IF      10331>>IF
KQ$CG.MINDATAPGS
      5946**DCL      9810>>IF      10331>>IF
KQ$CG.NDFRBLKS
      5873**DCL     10051<<ASSIGN  10055<<ASSIGN  10055>>ASSIGN  10081<<ASSIGN  10081>>ASSIGN  10107<<ASSIGN
     10107>>ASSIGN
KQ$CG.NEEDPGCNT
      5975**DCL      9138<<ASSIGN   9138>>ASSIGN   9512<<ASSIGN   9512>>ASSIGN   9579<<ASSIGN   9579>>ASSIGN
      9748<<ASSIGN   9748>>ASSIGN   9784<<ASSIGN   9784>>ASSIGN
KQ$CG.NEEDPGHD$
      5964**DCL      9132>>ASSIGN   9507<<ASSIGN   9574<<ASSIGN   9741>>IF       9743>>ASSIGN   9744<<ASSIGN
      9769>>ASSIGN   9776<<ASSIGN   9795>>IF       9800>>IF      10062<>CALL    10225>>DOWHILE
KQ$CG.NEEDPGTL$
      5973**DCL      9136>>ASSIGN   9137<<ASSIGN   9506>>IF       9509>>ASSIGN   9511<<ASSIGN   9573>>IF
      9576>>ASSIGN   9577<<ASSIGN   9745>>IF       9746<<ASSIGN   9779>>IF       9780<<ASSIGN  10063<<ASSIGN
KQ$CG.NGAVAL
      5849**DCL      7744>>IF       7884>>IF       8238<<ASSIGN   8238>>ASSIGN   8239>>IF       8249<<ASSIGN
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:398  
      8249>>ASSIGN   8251>>IF
KQ$CG.SETX
      5839**DCL      9210<>CALL     9419<>CALL    10440>>ASSIGN
KQ$CG.SHRINKCNT
      5937**DCL     10084<<ASSIGN
KQ$CG.SHRINKPGS
      5939**DCL     10085<<ASSIGN
KQ$CG.STATS.DISCRDS
      5817**DCL      9218<<ASSIGN   9218>>ASSIGN
KQ$CG.STATS.DISCWRS
      5817**DCL      9429<<ASSIGN   9429>>ASSIGN
KQ$CG.STATS.NODFRS
      5818**DCL      8963<<ASSIGN   8963>>ASSIGN
KQ$CG.STATS.WRDSUSED
      5818**DCL      7669<<ASSIGN   7669>>ASSIGN   8234<<ASSIGN   8234>>ASSIGN   8267<<ASSIGN   8267>>ASSIGN
KQ$CG.STREE.ACTCNT
      5671**DCL      8063>>IF       8814>>ASSIGN
KQ$CG.TRIGGER
      5861**DCL      8239>>IF       8251>>IF
KQ$CG.TRIGGERED
      5843**DCL      8239>>IF       8241<<ASSIGN   8251>>IF       8258<<ASSIGN
KQ$CG.UGRANS
      5851**DCL      8237<<ASSIGN   8237>>ASSIGN   8250<<ASSIGN   8250>>ASSIGN
KQ$DBLK
      6129**DCL      7664<<ASSIGN   8056--ASSIGN   8093<<ASSIGN   8213<<ASSIGN  10164--ASSIGN  10394<<ASSIGN
     10394>>ASSIGN
KQ$DBLK.ACTCNT
      6165**DCL      8063>>IF       8814<<ASSIGN
KQ$DBLK.ACTIVE
      6147**DCL      8216<<ASSIGN   8370>>IF       8667>>IF       8684<<ASSIGN   8785>>IF       8807<<ASSIGN
      9941<<ASSIGN  10158>>IF      10162>>IF      10172>>IF
KQ$DBLK.DSIZE
      6134**DCL      8215<<ASSIGN  10164>>ASSIGN
KQ$DBLK.FLNKDA
      6136**DCL      8393>>IF       8835>>ASSIGN
KQ$DBLK.LATCHCNT
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:399  
      6143**DCL      8068>>IF       8811<<ASSIGN
KQ$DBLK.LINKX
      6160**DCL      8103>>ASSIGN   8105<<ASSIGN   8105>>ASSIGN   8112>>ASSIGN   8128>>ASSIGN   8130<<ASSIGN
      8130>>ASSIGN   8135>>ASSIGN   8148>>ASSIGN   8152>>ASSIGN   8154<<ASSIGN   8154>>ASSIGN   8155<<ASSIGN
      8166<<ASSIGN   8170<<ASSIGN   8173<<ASSIGN   8173>>ASSIGN   8182>>IF       8184>>ASSIGN   8186<<ASSIGN
      8186>>ASSIGN   8190>>ASSIGN   8194<<ASSIGN   8681>>ASSIGN   8683<<ASSIGN   8683>>ASSIGN   8701>>ASSIGN
      8804<<ASSIGN   9939<<ASSIGN  10175<<ASSIGN  10178<<ASSIGN
KQ$DBLK.LOCK
      6149**DCL      8217<<ASSIGN   8370>>IF       8387<<ASSIGN   8504<<ASSIGN   8663<<ASSIGN   8785>>IF
      8796<<ASSIGN   9937<<ASSIGN   9942<<ASSIGN  10185<<ASSIGN
KQ$DBLK.LREL
      6151**DCL      8060>>IF       8072<<ASSIGN   8149>>IF       8665>>IF       8685<<ASSIGN   8785>>IF
      8813<<ASSIGN   9943<<ASSIGN  10158>>IF      10162>>IF
KQ$DBLK.MBLK
      6154**DCL     10165>>IF
KQ$DBLK.SIZW
      6163**DCL      7665<<ASSIGN   7667>>ASSIGN   7668>>ASSIGN   8087>>ASSIGN   8094<<ASSIGN   8098<<ASSIGN
      8098>>ASSIGN   8099>>ASSIGN   8122>>ASSIGN   8171>>IF       8174<<ASSIGN   8174>>ASSIGN   8174>>ASSIGN
      8179>>IF       8181<<ASSIGN   8181>>ASSIGN   8181>>ASSIGN   8182>>IF       8185<<ASSIGN   8185>>ASSIGN
      8185>>ASSIGN   8212>>ASSIGN   8214<<ASSIGN   8233>>ASSIGN   8234>>ASSIGN   8266>>ASSIGN   8267>>ASSIGN
      8271>>ASSIGN   8274>>ASSIGN  10139>>IF      10150>>ASSIGN  10151<<ASSIGN  10153<<ASSIGN  10155<<ASSIGN
     10160<<ASSIGN  10186>>IF      10187>>ASSIGN
KQ$DBLK.STA$
      6139**DCL      8065>>ASSIGN   8068>>IF       8082<<ASSIGN   8686<<ASSIGN   8812<<ASSIGN
KQ$DBLK.STAMP
      6130**DCL      8378>>IF
KQ$DFRBLK
      6182**DCL      8942<<ASSIGN  10396<<ASSIGN  10396>>ASSIGN
KQ$DFRBLK.ABORT
      6193**DCL      7797>>IF       8534>>IF       8590<<ASSIGN   9758>>IF
KQ$DFRBLK.CODE
      6185**DCL      7731<<ASSIGN   7749<<ASSIGN   7774>>ASSIGN   7788>>IF       7856<<ASSIGN   8531>>ASSIGN
      8587>>ASSIGN   8604>>ASSIGN   8949<<ASSIGN   8984>>ASSIGN   9119>>IF       9150>>IF       9594<<ASSIGN
      9749>>DOCASE   9935>>DOCASE  10071>>DOCASE
KQ$DFRBLK.DA
      6202**DCL      7857<<ASSIGN   7868<<ASSIGN   7900<<ASSIGN   8457<<ASSIGN   8948<<ASSIGN   9119>>IF
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:400  
      9134>>IF       9150>>IF       9283>>ASSIGN   9595<<ASSIGN   9763>>ASSIGN   9773>>IF
KQ$DFRBLK.DBLK
      6206**DCL      8458<<ASSIGN   8530>>ASSIGN
KQ$DFRBLK.DBLK$
      6204**DCL      6206--REDEF    7636>>ASSIGN   7810<<ASSIGN   8418<<ASSIGN   8477>>ASSIGN   9876>>ASSIGN
      9931>>ASSIGN
KQ$DFRBLK.DDA
      6208**DCL      7617<<ASSIGN   7637>>ASSIGN   7796>>ASSIGN   7811<<ASSIGN   8419<<ASSIGN   8456<<ASSIGN
      8478>>ASSIGN   8529>>ASSIGN   9877>>ASSIGN
KQ$DFRBLK.DGRAN$
      6216**DCL      9182<<ASSIGN   9282>>ASSIGN
KQ$DFRBLK.EPTR$
      6210**DCL      8588<<ASSIGN   8589>>IF       9861>>IF       9879>>ASSIGN   9919>>IF
KQ$DFRBLK.ERRCODE
      6187**DCL      7638>>ASSIGN   7923<<ASSIGN   8420<<ASSIGN   8476>>ASSIGN   8533>>ASSIGN   9271<<ASSIGN
      9878>>ASSIGN
KQ$DFRBLK.EVNT
      6191**DCL      7632>>IF       7812<<ASSIGN   7922<<ASSIGN   8421<<ASSIGN   8467>>IF       8613>>IF
      9860>>IF       9919>>IF
KQ$DFRBLK.GFLG
      6195**DCL      7721<<ASSIGN   7914>>IF
KQ$DFRBLK.GO
      6189**DCL      8397<<ASSIGN   8447<<ASSIGN   8591<<ASSIGN   8615<<ASSIGN   8946<<ASSIGN   9860>>IF
      9919>>IF
KQ$DFRBLK.INFO
      6212**DCL      6214--REDEF    9875>>ASSIGN
KQ$DFRBLK.LNK$
      6183**DCL      7621<<ASSIGN   7722>>ASSIGN   7795>>ASSIGN   7805<<ASSIGN   7913>>ASSIGN   7917<<ASSIGN
      8939>>ASSIGN   8988<<ASSIGN   8991<<ASSIGN   9121<<ASSIGN   9123<<ASSIGN   9129>>ASSIGN   9136<<ASSIGN
      9139<<ASSIGN   9145>>ASSIGN   9152<<ASSIGN   9154<<ASSIGN   9160>>ASSIGN   9168<<ASSIGN   9172<<ASSIGN
      9244>>ASSIGN   9246<<ASSIGN   9246>>ASSIGN   9252<<ASSIGN   9254<<ASSIGN   9263>>ASSIGN   9509<<ASSIGN
      9510<<ASSIGN   9576<<ASSIGN   9578<<ASSIGN   9599<<ASSIGN   9744>>ASSIGN   9747<<ASSIGN   9767<<ASSIGN
      9772>>ASSIGN   9776>>ASSIGN   9778<<ASSIGN   9778>>ASSIGN   9781<<ASSIGN   9783<<ASSIGN   9865<<ASSIGN
      9989>>ASSIGN  10057>>ASSIGN  10079>>ASSIGN  10105>>ASSIGN
KQ$DFRBLK.USR
      6200**DCL      7634>>IF       7733<<ASSIGN   7750<<ASSIGN   8396<<ASSIGN   8446<<ASSIGN   8463>>IF
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:401  
      8616<<ASSIGN   8945<<ASSIGN   9887>>IF       9892<>CALL
KQ$DFRPARM
      7079**DCL      9884<>CALL
KQ$DFRPARM.DBLK$
      7084**DCL      7086--REDEF    9876<<ASSIGN
KQ$DFRPARM.DDA
      7088**DCL      9877<<ASSIGN
KQ$DFRPARM.ERR
      7092**DCL      9878<<ASSIGN
KQ$DFRPARM.INFO
      7080**DCL      7082--REDEF    9875<<ASSIGN
KQ$DGRAN
      6232**DCL      7663--ASSIGN   7665--ASSIGN   7666--ASSIGN   7669--ASSIGN   8235--IF       8247--IF
      9485<<ASSIGN   9735<<ASSIGN  10136--ASSIGN  10237<<ASSIGN
KQ$DGRAN.ACTCNT
      6343**DCL      8210<<ASSIGN   8210>>ASSIGN   8386<<ASSIGN   8386>>ASSIGN   8674<<ASSIGN   8674>>ASSIGN
      8798<<ASSIGN   8798>>ASSIGN  10331>>IF      10341<<ASSIGN
KQ$DGRAN.AVAILX
      6324**DCL      7666<<ASSIGN   8058>>ASSIGN   8103<<ASSIGN   8140>>IF       8144>>ASSIGN   8152<<ASSIGN
      8676>>ASSIGN   8680>>IF       8681<<ASSIGN   8804>>ASSIGN   8805<<ASSIGN   9939>>ASSIGN   9940<<ASSIGN
     10145<<ASSIGN  10177<<ASSIGN
KQ$DGRAN.BLINK$
      6330**DCL      7680<<ASSIGN   9503>>ASSIGN   9611>>IF       9614>>ASSIGN   9616>>ASSIGN   9618<<ASSIGN
      9618>>ASSIGN   9640>>IF       9643>>ASSIGN   9645>>ASSIGN   9647<<ASSIGN   9647>>ASSIGN  10253>>ASSIGN
     10362>>ASSIGN
KQ$DGRAN.BTN
      6305**DCL      7672--ASSIGN   9609--CALL     9638--CALL
KQ$DGRAN.BTN.FLINK$
      6316**DCL     10091>>ASSIGN
KQ$DGRAN.BTN.KEY
      6318**DCL      7660>>IF       8219--ASSIGN   8772--ASSIGN   9192>>IF       9561--ASSIGN   9585--ASSIGN
      9609<>CALL     9638<>CALL
KQ$DGRAN.BUDDYX
      6327**DCL      8120>>ASSIGN   8128<<ASSIGN   8156>>IF       8157<<ASSIGN   8160>>ASSIGN   8168<<ASSIGN
     10146<<ASSIGN
KQ$DGRAN.DFR$
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:402  
      6352**DCL      9427<<ASSIGN
KQ$DGRAN.FLINK$
      6332**DCL      7580>>ASSIGN   7676<<ASSIGN   9473>>ASSIGN   9612>>ASSIGN   9614<<ASSIGN   9614>>ASSIGN
      9615>>IF       9618>>ASSIGN   9641>>ASSIGN   9643<<ASSIGN   9643>>ASSIGN   9644>>IF       9647>>ASSIGN
      9812<<ASSIGN  10229>>ASSIGN
KQ$DGRAN.FREEFLINK
      6345**DCL      7852>>ASSIGN   9584<<ASSIGN
KQ$DGRAN.HDR
      6249**DCL     10089--ASSIGN
KQ$DGRAN.HDR.ADDFREE
      6261**DCL      9588<<ASSIGN
KQ$DGRAN.HDR.CHAIN
      6267**DCL      7674<<ASSIGN   9620<<ASSIGN   9649<<ASSIGN
KQ$DGRAN.HDR.EMPTYLIST
      6265**DCL      9564>>IF       9586<<ASSIGN
KQ$DGRAN.HDR.FORCEOUT
      6259**DCL      8358>>IF       8845<<ASSIGN   8847>>IF       9499<<ASSIGN   9564>>IF       9569>>IF
     10249<<ASSIGN  10338<<ASSIGN  10348<<ASSIGN  10358<<ASSIGN
KQ$DGRAN.HDR.GTYP
      6276**DCL      9488<<ASSIGN   9738<<ASSIGN  10240<<ASSIGN
KQ$DGRAN.HDR.PTYP
      6271**DCL      9487<<ASSIGN   9737<<ASSIGN  10239<<ASSIGN
KQ$DGRAN.HDR.SELF$
      6283**DCL      9489<<ASSIGN   9739<<ASSIGN  10241<<ASSIGN
KQ$DGRAN.HDR.STAMP.GMOD
      6255**DCL      7662<<ASSIGN
KQ$DGRAN.HDR.UPD
      6269**DCL      7675<<ASSIGN   8083<<ASSIGN   8147<<ASSIGN   8211<<ASSIGN   8687<<ASSIGN   8754<<ASSIGN
      8801<<ASSIGN   8806<<ASSIGN   9569>>IF       9587<<ASSIGN  10344>>IF      10357>>IF
KQ$DGRAN.HDR.WRITE
      6263**DCL      7573>>IF       7874>>IF       8358>>IF       9591<<ASSIGN  10326>>IF
KQ$DGRAN.HDR.WRITEUTS
      6285**DCL      7682<>CALL     7683>>ASSIGN   9411<>CALL
KQ$DGRAN.PASS
      6355**DCL     10326>>IF      10328<<ASSIGN
KQ$DGRAN.TIME
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:403  
      6347**DCL      7683<<ASSIGN  10343>>IF      10345<<ASSIGN  10356>>IF      10360<<ASSIGN
KQ$DGRAN.USECNT
      6322**DCL      7813<<ASSIGN   7813>>ASSIGN   7824<<ASSIGN   7824>>ASSIGN   8209<<ASSIGN   8209>>ASSIGN
      8360<<ASSIGN   8360>>ASSIGN   8411<<ASSIGN   8411>>ASSIGN   8505<<ASSIGN   8505>>ASSIGN   8664<<ASSIGN
      8664>>ASSIGN   8794>>IF       8797<<ASSIGN   8797>>ASSIGN   8842>>IF       9498>>IF       9592<<ASSIGN
      9592>>ASSIGN   9897<<ASSIGN   9897>>ASSIGN  10247>>IF      10329>>IF
KQ$DGRAN.WRDSAVAIL
      6338**DCL      7667<<ASSIGN   8271<<ASSIGN   8271>>ASSIGN   8274<<ASSIGN   8274>>ASSIGN   9564>>IF
     10151>>ASSIGN
KQ$DGRAN.WRDSFREE
      6359**DCL      7668<<ASSIGN   8233<<ASSIGN   8233>>ASSIGN   8235>>IF       8247>>IF       8266<<ASSIGN
      8266>>ASSIGN  10153>>ASSIGN
KQ$GRAN
      6380**DCL      9486<<ASSIGN   9736<<ASSIGN  10238<<ASSIGN
KQ$MBLK
      6773**DCL      7558--IF      10165--ASSIGN
KQ$MBLK.DVE.EOMCHAR
      6875**DCL      6877--REDEF
KQ$MBLK.KEY1
      6801**DCL      6803--REDEF
KQ$MBLK.KEY2
      6810**DCL      6828--REDEF
KQ$MBLK.LNK$
      6775**DCL      6777--REDEF    6783--REDEF    6787--REDEF
KQ$MBLK.TYC
      6924**DCL      6926--REDEF
KQ$MBLK.XSP.MREQ$
      6830**DCL      6834--REDEF
KQ$STA.ACTTYC
      6487**DCL      6491--REDEF
KQ$STA.DCBLNK$
      6494**DCL      6497--REDEF    6501--REDEF
KQ$STA.EVCNT
      6580**DCL      6583--REDEF
KQ$STA.EVNT
      6546**DCL      6550--REDEF    6553--REDEF
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:404  
KQ$STA.LATCHCNT
      6505**DCL      8068>>IF       8811>>ASSIGN
KQ$STA.OPNBLKED
      6607**DCL      6610--REDEF
KQ$STA.OPNREJ
      6613**DCL      6615--REDEF
KQ$STA.SUCCREAD
      6536**DCL      6540--REDEF
KQ$STA.TCOUNT
      6665**DCL      6671--REDEF
KQ$STA.VGOT$
      6650**DCL      6654--REDEF    6658--REDEF
KQB$DELETENL
      7385**DCL-ENT  9609--CALL     9638--CALL
KQB$INSERTNL
      7386**DCL-ENT  7673--CALL
KQB$SRCH
      7387**DCL-ENT  7871--CALL     8355--CALL
KQC$CXTSET
      7388**DCL-ENT 10094--CALL
KQD_MINSPLIT
      7376**DCL      8090>>IF       8125>>IF
KQE$RDEA
      7389**DCL-ENT  9206--ASSIGN
KQE$RDEAERR
      7390**DCL-ENT  9273--CALL
KQE$WREA
      7391**DCL-ENT  9424--ASSIGN
KQM$GETP
      7392**DCL-ENT  9479--CALL    10234--CALL
KQM$RELP
      7393**DCL-ENT  9820--CALL
KQS$CGFULL
      7394**DCL-ENT  7925--CALL
KQX$CHKPTR
      7395**DCL-ENT  8066--CALL
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:405  
KQZ$LOG
      7396**DCL-ENT  7588--CALL     7614--CALL     7737--CALL     7754--CALL     7778--CALL     7816--CALL
      7836--CALL     7861--CALL     7938--CALL     8345--CALL     8452--CALL     8545--CALL     8594--CALL
      8607--CALL     8775--CALL     8952--CALL     8985--CALL     9187--CALL     9604--CALL     9633--CALL
KQ_BASEDELAY
      3756**DCL      8260<<ASSIGN   8260>>ASSIGN   9868<<ASSIGN   9868>>ASSIGN
KQ_DBLK
      7139**DCL      7664>>ASSIGN   8093>>ASSIGN   8213>>ASSIGN
KQ_DEBUG
      3758**DCL      8374>>IF       8382>>IF       8670>>IF       8704>>IF       8789>>IF
KQ_DFRBLK
      7192**DCL      8942>>ASSIGN
KQ_DFRBLK.DBLK$
      7214**DCL      7216--REDEF
KQ_DFRBLK.INFO
      7222**DCL      7224--REDEF
KQ_ERRLOG_BFR
      7118**DCL     10389<<ASSIGN  10449<>CALL    10449--CALL
KQ_ERRLOG_BFR.ACCT
      7118**DCL     10439<<ASSIGN
KQ_ERRLOG_BFR.CODE
      7118**DCL     10397<<ASSIGN
KQ_ERRLOG_BFR.CTX
      7118**DCL     10448<<ASSIGN
KQ_ERRLOG_BFR.FNAME.C
      7119**DCL     10446<<ASSIGN
KQ_ERRLOG_BFR.FNAME.L
      7119**DCL     10445<<ASSIGN
KQ_ERRLOG_BFR.INFO
      7119**DCL     10392<<ASSIGN  10394--ASSIGN  10396--ASSIGN  10449--CALL
KQ_ERRLOG_BFR.PSN
      7118**DCL     10440<<ASSIGN
KQ_ERRLOG_BFR.SIZ
      7119**DCL     10390<<ASSIGN  10449>>CALL
KQ_ERRLOG_GATE
      3788**DCL     10386<>CALL    10452<>CALL
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:406  
KQ_IDGRAN
      7242**DCL      9485>>ASSIGN   9735>>ASSIGN  10237>>ASSIGN
KQ_IMBLK.DVE.EOMCHAR
      4420**DCL      4422--REDEF
KQ_IMBLK.KEY1
      4346**DCL      4348--REDEF
KQ_IMBLK.KEY2
      4355**DCL      4373--REDEF
KQ_IMBLK.LNK$
      4320**DCL      4322--REDEF    4328--REDEF    4332--REDEF
KQ_IMBLK.TYC
      4469**DCL      4471--REDEF
KQ_IMBLK.XSP.MREQ$
      4375**DCL      4379--REDEF
KQ_IRBLK.BUF$
      3924**DCL      3926--REDEF
KQ_IRBLK.CNACTD
      3838**DCL      3847--REDEF
KQ_IRBLK.DBLKX
      3944**DCL      3948--REDEF
KQ_IRBLK.EOFNONE
      3816**DCL      3819--REDEF
KQ_IRBLK.FROMQ
      3822**DCL      3825--REDEF
KQ_IRBLK.KEY1R
      3863**DCL      3864--REDEF
KQ_IRBLK.KEY2R
      3868**DCL      3869--REDEF
KQ_IRBLK.LATCH
      3811**DCL      3813--REDEF
KQ_IRBLK.LWRITES$
      3955**DCL      3959--REDEF
KQ_IRBLKT.CNACTD
      4024**DCL      4033--REDEF
KQ_IRBLKT.DBLK$
      4087**DCL      4091--REDEF    4094--REDEF
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:407  
KQ_IRBLKT.EOFNONE
      4002**DCL      4005--REDEF
KQ_IRBLKT.FROMQ
      4008**DCL      4011--REDEF
KQ_IRBLKT.KEY1R
      4049**DCL      4050--REDEF
KQ_IRBLKT.KEY2R
      4054**DCL      4055--REDEF
KQ_IRBLKT.LATCH
      3997**DCL      3999--REDEF
KQ_LOG.DCIO
      3777**DCL      9185>>IF       9602>>IF       9631>>IF
KQ_LOG.DFR
      3780**DCL      8950>>IF       8983>>IF
KQ_LOG.GETP
      3776**DCL      7735>>IF       7752>>IF       7772>>IF       7834>>IF       7859>>IF       7936>>IF
KQ_LOG.KQD
      3775**DCL      7586>>IF       7612>>IF       7814>>IF       8343>>IF       8450>>IF       8543>>IF
      8592>>IF       8605>>IF       8769>>IF
KQ_STATS.CACHERRS
      3768**DCL     10388<<ASSIGN  10388>>ASSIGN
LASTX IN PROCEDURE RCVGRAN
     10131**DCL     10137<<ASSIGN  10176>>IF      10178>>ASSIGN  10179<<ASSIGN
LDBLK$
      7103**DCL      7587<<ASSIGN   7588<>CALL     7816<>CALL     8544<<ASSIGN   8545<>CALL     8593<<ASSIGN
      8594<>CALL     8774<<ASSIGN   8775<>CALL
LDFR$
      7102**DCL      7587<<ASSIGN   7588<>CALL     7613<<ASSIGN   7614<>CALL     7736<<ASSIGN   7737<>CALL
      7753<<ASSIGN   7754<>CALL     7777<<ASSIGN   7778<>CALL     7815<<ASSIGN   7816<>CALL     7835<<ASSIGN
      7836<>CALL     7860<<ASSIGN   7861<>CALL     7937<<ASSIGN   7938<>CALL     8344<<ASSIGN   8345<>CALL
      8451<<ASSIGN   8452<>CALL     8544<<ASSIGN   8545<>CALL     8593<<ASSIGN   8594<>CALL     8606<<ASSIGN
      8607<>CALL     8951<<ASSIGN   8952<>CALL     8984<<ASSIGN   8985<>CALL     9186<<ASSIGN   9187<>CALL
      9603<<ASSIGN   9604<>CALL     9621<<ASSIGN   9622<>CALL
LDGRAN$
      7104**DCL      7777<<ASSIGN   7778<>CALL     7815<<ASSIGN   7871<>CALL     7872>>ASSIGN   8355<>CALL
      8356>>ASSIGN   9186<<ASSIGN   9187<>CALL     9479<>CALL     9480>>ASSIGN   9603<<ASSIGN   9604<>CALL
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:408  
      9621<<ASSIGN   9622<>CALL     9632<<ASSIGN   9633<>CALL     9819<<ASSIGN   9820<>CALL    10234<>CALL
     10235>>ASSIGN
LOG1 IN PROCEDURE GETBLK
      8954**LABEL    8952--CALLALT
LOG1 IN PROCEDURE GETINIT
      7819**LABEL    7816--CALLALT
LOG1 IN PROCEDURE READGRAN
      9190**LABEL    9187--CALLALT
LOG1 IN PROCEDURE REMPAGE
      9607**LABEL    9604--CALLALT
LOG2 IN PROCEDURE GETBLK
      8987**LABEL    8985--CALLALT
LOG2 IN PROCEDURE GETINIT
      7740**LABEL    7737--CALLALT
LOG2 IN PROCEDURE REMPAGE
      9636**LABEL    9633--CALLALT
LOG3 IN PROCEDURE GETINIT
      7757**LABEL    7754--CALLALT
LOG4 IN PROCEDURE GETINIT
      7781**LABEL    7778--CALLALT
LOG5 IN PROCEDURE GETINIT
      7839**LABEL    7836--CALLALT
LOG6 IN PROCEDURE GETINIT
      7864**LABEL    7861--CALLALT
LOG7 IN PROCEDURE GETINIT
      7941**LABEL    7938--CALLALT
LOGERR
     10379**PROC     8373--CALL     8381--CALL     8669--CALL     8703--CALL     8788--CALL
LOOP IN PROCEDURE GETINIT
      7787**LABEL    7825--GOTO     7875--GOTO     7902--GOTO
LOOP IN PROCEDURE RCVGRAN
     10138**LABEL   10188--GOTO
LOOP IN PROCEDURE RELPAGE
      9739**LABEL    9756--GOTO     9761--GOTO     9830--GOTO
N$ IN PROCEDURE RELPAGE
      9732**DCL      9772<<ASSIGN   9788>>ASSIGN
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:409  
N$REQ IN PROCEDURE READGRAN
      9064**DCL      9217<>CALL     9273<>CALL
N$REQ.BUF$ IN PROCEDURE READGRAN
      9073**DCL      9201<<ASSIGN
N$REQ.BUFADDR IN PROCEDURE READGRAN
      9073**DCL      9074--REDEF    9074--REDEF
N$REQ.BUFSIZE IN PROCEDURE READGRAN
      9067**DCL      9204<<ASSIGN
N$REQ.DLA IN PROCEDURE READGRAN
      9064**DCL      9209<>CALL     9210<>CALL
N$REQ.DLA.DRELADDR IN PROCEDURE READGRAN
      9065**DCL      9065--REDEF
N$REQ.DVE.EOMCHAR IN PROCEDURE READGRAN
      9102**DCL      9103--REDEF
N$REQ.EAENTRY IN PROCEDURE READGRAN
      9095**DCL      9206<<ASSIGN
N$REQ.EAINFO IN PROCEDURE READGRAN
      9096**DCL      9096--REDEF
N$REQ.EAINFOP$ IN PROCEDURE READGRAN
      9096**DCL      9207<<ASSIGN
N$REQ.EAINFOX IN PROCEDURE READGRAN
      9096**DCL      9097--REDEF
N$REQ.EAINFOXP$ IN PROCEDURE READGRAN
      9097**DCL      9208<<ASSIGN
N$REQ.EVNTINFO IN PROCEDURE READGRAN
      9097**DCL      9097--REDEF
N$REQ.FC IN PROCEDURE READGRAN
      9067**DCL      9205<<ASSIGN
N$REQ.IOFLG.IOS IN PROCEDURE READGRAN
      9068**DCL      9212>>IF       9215<<ASSIGN
N$REQ.IOS$ IN PROCEDURE READGRAN
      9077**DCL      9214<>CALL
N$REQ.OPFLG IN PROCEDURE READGRAN
      9070**DCL      9202<<ASSIGN
N$REQ.STATUS IN PROCEDURE READGRAN
      9078**DCL      9084--REDEF
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:410  
N$REQ.TYC IN PROCEDURE READGRAN
      9086**DCL      9272<<ASSIGN
N$REQ IN PROCEDURE WRITEGRAN
      9347**DCL      9428<>CALL
N$REQ.BUF$ IN PROCEDURE WRITEGRAN
      9356**DCL      9413<<ASSIGN
N$REQ.BUFADDR IN PROCEDURE WRITEGRAN
      9356**DCL      9357--REDEF    9357--REDEF
N$REQ.BUFSIZE IN PROCEDURE WRITEGRAN
      9350**DCL      9415<<ASSIGN
N$REQ.DLA IN PROCEDURE WRITEGRAN
      9347**DCL      9418<>CALL     9419<>CALL
N$REQ.DLA.DRELADDR IN PROCEDURE WRITEGRAN
      9348**DCL      9348--REDEF
N$REQ.DVE.EOMCHAR IN PROCEDURE WRITEGRAN
      9385**DCL      9386--REDEF
N$REQ.EAENTRY IN PROCEDURE WRITEGRAN
      9378**DCL      9424<<ASSIGN
N$REQ.EAINFO IN PROCEDURE WRITEGRAN
      9379**DCL      9379--REDEF
N$REQ.EAINFOP$ IN PROCEDURE WRITEGRAN
      9379**DCL      9425<<ASSIGN
N$REQ.EAINFOX IN PROCEDURE WRITEGRAN
      9379**DCL      9380--REDEF
N$REQ.EAINFOXP$ IN PROCEDURE WRITEGRAN
      9380**DCL      9426<<ASSIGN
N$REQ.EVNTINFO IN PROCEDURE WRITEGRAN
      9380**DCL      9380--REDEF
N$REQ.FC IN PROCEDURE WRITEGRAN
      9350**DCL      9421<<ASSIGN   9423<<ASSIGN
N$REQ.NOALT IN PROCEDURE WRITEGRAN
      9350**DCL      9416<<ASSIGN
N$REQ.OPFLG IN PROCEDURE WRITEGRAN
      9353**DCL      9414<<ASSIGN
N$REQ.STATUS IN PROCEDURE WRITEGRAN
      9361**DCL      9367--REDEF
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:411  
NAX IN PROCEDURE ALLOC
      8044**DCL      8148<<ASSIGN   8200>>ASSIGN
NDUC IN PROCEDURE COMP
      9897**LABEL    9896--CALLALT
NEEDPG
     10190**LABEL   10250--CALLALT 10259--CALLALT
NI$DS
      7114**DCL      9863>>IF
NIO$QUE
      7397**DCL-ENT  9217--CALL     9428--CALL
NIQ$GETNR
      7399**DCL-ENT  9183--CALL     9581--CALL
NIQ$GETSNR
      7398**DCL-ENT  9214--CALL
NIQ$REL
      7400**DCL-ENT  9232--CALL     9274--CALL
NOALLOC IN PROCEDURE GETINIT
      7824**LABEL    7798--CALLALT
NOALLOC5 IN PROCEDURE GETINIT
      7838**LABEL    7786--GOTO
NODFR IN PROCEDURE REMPAGE
      9600**LABEL    9593--CALLALT
NODFRBLK
      8505**LABEL    7611--CALLALT  8442--CALLALT
NOPAGE IN PROCEDURE GETPAGE
      9489**LABEL    9478--GOTO     9479--CALLALT
NOQENTS IN PROCEDURE READGRAN
      9228**LABEL    9183--CALLALT
NOQENTS IN PROCEDURE REMPAGE
      9649**LABEL    9581--CALLALT
NOSENTS IN PROCEDURE READGRAN
      9218**LABEL    9214--CALLALT  9217--CALLALT
NOSENTS IN PROCEDURE REMPAGE
      9649**LABEL    9622--CALLALT
NOSPACE
      7573**LABEL    7575--CALLALT
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:412  
NOTIN IN PROCEDURE GETINIT
      7874**LABEL    7871--CALLALT
NOUNLK
      9693**LABEL    9697--CALLALT
NXTDBLK IN PROCEDURE ALLOC
      8107**LABEL    8069--GOTO
P$ IN PROCEDURE ALLOC
      8042**DCL      8057<<ASSIGN   8102>>IF       8105>>ASSIGN   8111<<ASSIGN   8119<<ASSIGN   8127>>IF
      8130>>ASSIGN   8134<<ASSIGN   8143<<ASSIGN   8151>>IF       8154>>ASSIGN   8198<<ASSIGN
P$ IN PROCEDURE GETINIT
      7705**DCL      7792<<ASSIGN   7804>>IF       7805>>ASSIGN   7809>>ASSIGN   7827<<ASSIGN   7910<<ASSIGN
      7916>>IF       7917>>ASSIGN   7921>>ASSIGN   7931<<ASSIGN
P$ IN PROCEDURE READGRAN
      9050**DCL      9117<<ASSIGN   9118>>DOWHILE  9119>>IF       9119>>IF       9129<<ASSIGN   9129>>ASSIGN
      9132<<ASSIGN   9133>>DOWHILE  9134>>IF       9145<<ASSIGN   9145>>ASSIGN   9148<<ASSIGN   9149>>DOWHILE
      9150>>IF       9150>>IF       9160<<ASSIGN   9160>>ASSIGN   9203<<ASSIGN   9209<>CALL     9239<<ASSIGN
      9240>>DOWHILE  9241>>IF       9262>>ASSIGN   9263<<ASSIGN   9263>>ASSIGN
P$ IN PROCEDURE RELPAGE
      9730**DCL      9770<<ASSIGN   9775>>IF       9778>>ASSIGN   9780>>ASSIGN   9787<<ASSIGN
PASS
      7101**DCL     10301<>CALL    10326>>IF      10328>>ASSIGN
PASS IN PROCEDURE RCVGRAN
     10129**DCL     10134<<ASSIGN  10141>>IF      10144<<ASSIGN  10173>>IF      10184>>IF      10189>>IF
PASS2 IN PROCEDURE RCVGRAN
     10144**LABEL   10189--GOTO
PB$ IN PROCEDURE ALLOC
      8047**DCL      8162<<ASSIGN   8167>>IF       8170>>ASSIGN   8191<<ASSIGN   8194>>ASSIGN
PDBLK$
      6048**DCL        17--PROC     6049--REDEF    7549--ENTRY    7560<<ASSIGN   7596<<ASSIGN   7636<<ASSIGN
      7648<<ASSIGN   8025--ENTRY    8028--IF       8031>>ASSIGN   8325--ENTRY    8330--ENTRY    8407<<ASSIGN
      8428<<ASSIGN   8488<<ASSIGN   8495<<ASSIGN   8500<<ASSIGN   8511<<ASSIGN   8520<<ASSIGN   8525--ENTRY
      8527>>ASSIGN   8581--ENTRY    8586>>ASSIGN   8601--ENTRY    8603>>ASSIGN   8655--ENTRY    8742--ENTRY
      8746--ENTRY    8750--ENTRY    8751>>ASSIGN   8757--ENTRY    8761--ENTRY    8767>>ASSIGN   8885--ENTRY
      9020--ENTRY    9023>>ASSIGN   9280>>ASSIGN   9302--ENTRY    9691--ENTRY    9693>>ASSIGN
PDDA
      6050**DCL        17--PROC     6051--REDEF    6052--REDEF    6053--REDEF    7549--ENTRY    7597<<ASSIGN
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:413  
      8025--ENTRY    8325--ENTRY    8330--ENTRY    8340>>ASSIGN   8490<<ASSIGN   8525--ENTRY    8581--ENTRY
      8601--ENTRY    8655--ENTRY    8761--ENTRY    8885--ENTRY    9302--ENTRY
PEPTR$
      6053**DCL      8588>>ASSIGN   8594<>CALL
PGALT IN PROCEDURE READGRAN
      9218**LABEL    9166--CALLALT
PREVDBLK$
      7050**DCL      8683>>ASSIGN   8700<<ASSIGN   8701>>ASSIGN
PSIZ
      6052**DCL      7557>>ASSIGN   7561<<ASSIGN   7637<<ASSIGN   7649<<ASSIGN   8429<<ASSIGN   8496<<ASSIGN
      8512<<ASSIGN   8521<<ASSIGN
PSTA$
      6051**DCL      8032>>ASSIGN   8528>>ASSIGN   8811>>ASSIGN   8812>>ASSIGN   9281>>ASSIGN
PSTAMP
      6049**DCL      8338>>ASSIGN
Q$ IN PROCEDURE READGRAN
      9051**DCL      9064--IMP-PTR  9183<>CALL     9201>>ASSIGN   9202>>ASSIGN   9204>>ASSIGN   9205>>ASSIGN
      9206>>ASSIGN   9207>>ASSIGN   9208>>ASSIGN   9209>>CALL     9210>>CALL     9212>>IF       9214>>CALL
      9215>>ASSIGN   9217>>CALL     9232<>CALL     9272>>ASSIGN   9273>>CALL     9274<>CALL     9281<<ASSIGN
Q$ IN PROCEDURE REMPAGE
      9550**DCL      9581<>CALL     9622<>CALL
Q$ IN PROCEDURE WRITEGRAN
      9334**DCL      9325--PROC     9347--IMP-PTR  9413>>ASSIGN   9414>>ASSIGN   9415>>ASSIGN   9416>>ASSIGN
      9418>>CALL     9419>>CALL     9421>>ASSIGN   9423>>ASSIGN   9424>>ASSIGN   9425>>ASSIGN   9426>>ASSIGN
      9428>>CALL
RCVCHAIN
     10099**PROC    10060--CALL    10062--CALL    10064--CALL    10066--CALL
RCVGRAN
     10127**PROC    10090--CALL
READGRAN
      9044**PROC     7877--CALL     8459--CALL
READGRAN5 IN PROCEDURE READGRAN
      9180**ENTRY    9793--CALL
READGRAN8 IN PROCEDURE READGRAN
      9182**LABEL    9284--GOTO
READGRANSTRTIO IN PROCEDURE READGRAN
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:414  
      9278**ENTRY    9304--CALL
REGFLG
      7060**DCL      7546<<ASSIGN   7551<<ASSIGN   7605>>IF       8327<<ASSIGN   8332<<ASSIGN   8345<>CALL
      8436>>IF       8452<>CALL     8532<<ASSIGN   8658<<ASSIGN   8766<<ASSIGN   8887<<ASSIGN   8943>>IF
RELBLK IN PROCEDURE GETBLK
      8981**ENTRY    7592--CALL     7642--CALL     7840--CALL     7890--CALL     7942--CALL     8364--CALL
      8482--CALL     8841--CALL     9024--CALL     9760--CALL     9880--CALL     9899--CALL    10080--CALL
     10106--CALL
RELIT IN PROCEDURE ALLOC
      8071**LABEL    8066--CALLALT
RELPAGE
      9724**PROC     8850--CALL     9697--CALL    10259--CALL    10351--CALL
RELPG
     10254**LABEL   10251--GOTO
REMP IN PROCEDURE REMPAGE
      9558**LABEL    9554--GOTO
REMPAGE
      9542**PROC     8849--CALL    10250--CALL    10350--CALL
REMPAGENP IN PROCEDURE REMPAGE
      9556**ENTRY    9500--CALL
RENEGE
      8659**LABEL    8390--GOTO
RENEGE50
      8704**LABEL    8666--GOTO     8672--GOTO
RESTART
     10300**LABEL   10350--CALLALT 10351--CALLALT
RESTART5
     10300**LABEL   10352--GOTO
RET IN PROCEDURE GETINIT
      7951**LABEL    7878--GOTO     7894--CALLALT
RETRY IN PROCEDURE RCVGRAN
     10134**LABEL   10156--GOTO
SB IN PROCEDURE ALLOC
      8048**DCL      8087<<ASSIGN   8088>>IF       8090>>IF       8093>>ASSIGN   8094>>ASSIGN   8122<<ASSIGN
      8123>>IF       8125>>IF
SC_CGCACHE
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:415  
      7401**DCL-ENT  8375--CALL     8383--CALL     8469--CALL     8671--CALL     8705--CALL     8790--CALL
      9115--CALL     9270--CALL     9755--CALL     9946--CALL    10143--CALL    10168--CALL    10186--CALL
SC_CGCACHESCR
      7402**DCL-ENT  7661--CALL     7687--CALL     9193--CALL     9266--CALL     9433--CALL     9654--CALL
SETAVAIL IN PROCEDURE ALLOC
      8100**LABEL    8131--GOTO
SIZBYTES
      7098**DCL      7557<<ASSIGN   7558>>IF       7558>>IF       7588<>CALL     7614<>CALL     7617>>ASSIGN
      7796<<ASSIGN   8056>>ASSIGN   8215>>ASSIGN
SIZW IN PROCEDURE ALLOC
      8051**DCL      8056<<ASSIGN   8087>>ASSIGN   8094>>ASSIGN   8098>>ASSIGN   8122>>ASSIGN
SPLIT IN PROCEDURE ALLOC
      8082**LABEL    8126--GOTO
SSR$REG
      7403**DCL-ENT  8465--CALL     8620--CALL     8969--CALL
SSR$RUE
      7404**DCL-ENT  9892--CALL
SSS$SYSTIME
      7405**DCL-ENT  7682--CALL     9411--CALL    10301--CALL    10321--CALL
STAMP
      7062**DCL      8338<<ASSIGN   8378>>IF       8381<>CALL     8458>>ASSIGN   8530<<ASSIGN
STARTGET IN PROCEDURE GETINIT
      7710**LABEL    7949--GOTO     7955--GOTO
S_CUN
      7115**DCL      7606>>IF       8437>>IF       8616>>ASSIGN   8945>>ASSIGN
S_TIMR
      7116**DCL      7606>>IF       8437>>IF       8943>>IF
T$
      7096**DCL      7672<<ASSIGN   7673<>CALL     8184<<ASSIGN   8185>>ASSIGN   8186>>ASSIGN   9238<<ASSIGN
      9243>>IF       9246>>ASSIGN   9248>>ASSIGN   9262<<ASSIGN
T$ IN PROCEDURE GETINIT
      7704**DCL      7791<<ASSIGN   7793>>DOWHILE  7794>>ASSIGN   7795<<ASSIGN   7805>>ASSIGN   7807>>ASSIGN
      7909<<ASSIGN   7911>>DOWHILE  7912>>ASSIGN   7913<<ASSIGN   7917>>ASSIGN   7919>>ASSIGN
T$ IN PROCEDURE RELPAGE
      9731**DCL      9769<<ASSIGN   9771>>DOWHILE  9772>>ASSIGN   9773>>IF       9776>>ASSIGN   9778>>ASSIGN
      9779>>IF       9781>>ASSIGN   9782>>ASSIGN   9783>>ASSIGN   9787>>ASSIGN   9788<<ASSIGN
PL6.E3A0      #001=KQD$GET File=KQD$DBLK.:E05TSI                                 WED 07/30/97 01:24 Page:416  
TDFR$ IN PROCEDURE GETINIT
      7701**DCL      7707<<ASSIGN   7782<<ASSIGN   7963>>ASSIGN   7971>>ASSIGN
TDFR$ IN PROCEDURE RELPAGE
      9729**DCL      9734<<ASSIGN   9752>>ASSIGN   9806>>ASSIGN   9823>>ASSIGN
TDFR$ IN PROCEDURE REMPAGE
      9548**DCL      9562<<ASSIGN   9626>>ASSIGN
TDGRAN$ IN PROCEDURE GETINIT
      7703**DCL      7709<<ASSIGN   7784<<ASSIGN   7858<<ASSIGN   7893>>IF       7896>>ASSIGN   7897<<ASSIGN
      7964>>ASSIGN   7972>>ASSIGN
TREEERR IN PROCEDURE INITGRAN
      7683**LABEL    7673--CALLALT  7688--GOTO
TRYAGAIN IN PROCEDURE RELPAGE
      9823**LABEL    9751--CALLALT
UNDOIT IN PROCEDURE COMP
      9929**PROC     9896--CALL     9925--CALL
UNLKALT IN PROCEDURE GETINIT
      7964**LABEL    7891--GOTO
UNLKRET
     10250**LABEL   10234--CALLALT 10255--GOTO    10308--GOTO    10365--GOTO
UNLKRET IN PROCEDURE GETINIT
      7951**LABEL    7718--GOTO     7726--GOTO     7729--CALLALT  7747--CALLALT  7764--GOTO     7841--GOTO
      7848--GOTO     7882--GOTO
WRD
      7030**DCL      8219>>ASSIGN   8772>>ASSIGN   9211<<ASSIGN   9561>>ASSIGN   9585>>ASSIGN
WRD IN PROCEDURE LOGERR
     10383**DCL     10379--PROC    10391--IF      10392>>ASSIGN
WRITEGRAN
      9325**PROC     9622--CALL
WRITEIT
     10348**LABEL   10339--GOTO
XUD$UTS_ADJ_25TH
      7431**DCL-ENT 10322--CALL
