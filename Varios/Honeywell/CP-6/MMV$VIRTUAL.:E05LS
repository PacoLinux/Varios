VERSION E05

PL6.E3A0      #001=MMV$OPEN File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:25 Page:1    
        1        1        /*M* MMV$VIRTUAL - MM routines to manage large virtual space */
        2        2        /*T***********************************************************/
        3        3        /*T*                                                         */
        4        4        /*T* Copyright (c) Bull HN Information Systems Inc., 1997    */
        5        5        /*T*                                                         */
        6        6        /*T***********************************************************/
        7        7        /*X* DMR,PLM=5,IND=5,CTI=5,SDI=5,MCL=10,CSI=0,ECI=0 */
        8        8        MMV$OPEN: PROC ALTRET;
        9        9
       10       10        /*F* NAME: MMV$OPEN
       11       11             PURPOSE: To ready a virtual segment for use.
       12       12             DESCRIPTION: MMV$OPEN is called by file management when the
       13       13                          access type specified VS1, VS2, or VS3. The main
       14       14                          thing that has to be done in this routine is to
       15       15                          initialize the page table for the given WSQ and
       16       16                          set up the WSPTD. No pages are put into the map
       17       17                          until a fault occurs.
       18       18          */
       19       19
       20       20        /* Includes */
       21       21        %INCLUDE B$JIT;
       22      624        %INCLUDE B$MAP;
       23      723        %INCLUDE B_SEGIDS_C;
       24     1262        %INCLUDE CP_6;
       25     6821        %INCLUDE CP_6_SUBS;
       26     7361        %INCLUDE F$CP6V_C;
       27     7587        %INCLUDE F$DCB;
       28     7636        %INCLUDE MM_DATA_R;
       29     8156        %INCLUDE HF_DATA_R;
       30     8199        %INCLUDE M_ERRORS_C;
       31     8263        %INCLUDE M_ERRSET_C;
       32     8287        %INCLUDE S_WSPTD_R;
       33     8303        %INCLUDE UD_SEV_C;
       34     8317        %INCLUDE HF_LOCK_C;
       35     8331
       36     8332        /* Symrefs */
       37     8333    1   DCL B$JIT$ PTR SYMREF READONLY;
PL6.E3A0      #001=MMV$OPEN File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:25 Page:2    
       38     8334    1   DCL B$PPUT$ PTR SYMREF READONLY;
       39     8335    1   DCL B$PS$(0:0) PTR SYMREF;
       40     8336    1   DCL B$ROSEG$ PTR SYMREF READONLY;
       41     8337    1   DCL B$USERLS$ PTR SYMREF;
       42     8338    1   DCL B$UPT$ PTR SYMREF;
       43     8339    1   DCL B$VS1$ PTR SYMREF READONLY;
       44     8340    1   DCL B$VS2$ PTR SYMREF READONLY;
       45     8341    1   DCL B$VS3$ PTR SYMREF READONLY;
       46     8342    1   DCL B$IPHYMAP$ PTR SYMREF READONLY;
       47     8343    1   DCL B$WSQ0PT$ PTR SYMREF READONLY;
       48     8344
       49     8345        /* Macro invocations */
       50     8346        %FPT$OPEN_V;
       51     8361        %MM$VIRTUAL_STATS;
       52     8365        %MODERR(MODULE='26'O);                  /* Sets the module of errcode to v    */
       53     8373        %VLP_ERRCODE (FPTN=ERR_VSINUSE,
       54     8374                       FCG=MM,
       55     8375                       MID=V,
       56     8376                       MON='1'B,
       57     8377                       ERR#=%E$VSINUSE,
       58     8378                       SEV=SEV_ERROR#,
       59     8379                       STCLASS=CONSTANT);
       60     8424        %VLP_ERRCODE (FPTN=ERR_VSTOBIG,
       61     8425                       FCG=MM,
       62     8426                       MID=V,
       63     8427                       MON='1'B,
       64     8428                       ERR#=%E$VSTOBIG,
       65     8429                       SEV=SEV_ERROR#,
       66     8430                       STCLASS=CONSTANT);
       67     8475        %VLP_ERRCODE (FPTN=ILGLSEG,ERR#=%E$ILGLSEG,SEV=SEV_ERROR#,FCG=MM,MID=V,MON='1'B,
              8475            STCLASS=CONSTANT);
       68     8520        %VLP_ERRCODE (FPTN=BRKCTY,ERR#=%E$BRKCTY,SEV=SEV_ERROR#,FCG=MM,MID=V,MON='1'B,
              8520            STCLASS=CONSTANT);
       69     8565        %VLP_ERRCODE (FPTN=NOVLPVIRT,ERR#=%E$NOVLPVIRT,SEV=SEV_ERROR#,FCG=MM,MID=V,MON='1'B,
              8565            STCLASS=CONSTANT);
       70     8610        %VLP$VIRTUAL_V (FPTN=VLP$VIRTUAL);
       71     8615
PL6.E3A0      #001=MMV$OPEN File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:25 Page:3    
       72     8616        /* Entry references */
       73     8617    1   DCL MME$WGVP ENTRY(4) ALTRET;
       74     8618    1   DCL MME$GVPNOPP ENTRY(4) ALTRET;
       75     8619    1   DCL MME$WFVP ENTRY(4) ALTRET;
       76     8620    1   DCL MMB$GPP ENTRY(2) ALTRET;
       77     8621    1   DCL MMB$GNPP ENTRY(2) ALTRET;
       78     8622    1   DCL MMB$FPPONTAIL ENTRY(1) ALTRET;
       79     8623    1   DCL MME$RVNP ENTRY(4) ALTRET;
       80     8624
       81     8625        /* Subs */
       82     8626        %SUB MM$VCB = VCB$->MM$VCB;
       83     8627
       84     8628        /* Auto */
       85     8629    1   DCL EWSQ SBIN;
       86     8630    1   DCL P$ PTR;
       87     8631    1   DCL ERR UBIN;
       88     8632    1   DCL I SBIN;
       89     8633    1   DCL VPPGTBL UBIN;                       /* Page table virtual page            */
       90     8634    1   DCL VCB$ PTR;
       91     8635    1   DCL SEGID BIT(12);
       92     8636    1   DCL PPNO UBIN;
       93     8637    1   DCL TEMP SBIN;
       94     8638    1   DCL   SAVE_PPNO UBIN WORD;
       95     8639    1   DCL TERR UBIN;
       96     8640
       97     8641        /* Begin procedure */
       98     8642
       99     8643        /* Check out passed parameters */
      100     8644    1        VCB$ = B$JIT.DCB$ -> F$DCB.SETSTA$;     /* Setsta contians
      101     8645                                                          address of ROSEG area */
      102     8646    1        B$JIT.DCBNO = B$JIT.DCB$ -> F$DCB.DCB#;
      103     8647
      104     8648    1        IF VCB$ = ADDR(NIL)                /* No VLP_VIRTUAL specified */
      105     8649    2        THEN DO;
      106     8650    2             B$JIT.ERR = NOVLPVIRT;
      107     8651                  /*E* ERROR: -E$NOVLPVIRT-SEV_ERROR#
      108     8652                       MESSAGE: VLP_VIRTUAL must be specified.
PL6.E3A0      #001=MMV$OPEN File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:25 Page:4    
      109     8653                       MESSAGE1: The access method specified VS1 or VS2 or VS3
      110     8654                                 and VIRTUAL was not specified on the open.
      111     8655              */
      112     8656    2             ALTRETURN;
      113     8657    2           END;
      114     8658
      115     8659    1        IF NOT B$JIT.JUNK & %JJ_LNKRETIP#
      116     8660    2        THEN DO;
      117     8661    2             B$JIT.DCB$ -> F$DCB.LASTSTA$->MM$VIRTUAL_STATS = '0'B;
      118     8662    2             MM$VCB.MAXVP# = (MM$VCB.MAXVP# -1) / 1024;
      119     8663    2           END;
      120     8664                 /* Check to see if maxvp is resonable */
      121     8665    1        IF MM$VCB.MAXVP# >= 1024 * 4096    /* Greater than maximum               */
      122     8666    2        THEN DO;
      123     8667    2             B$JIT.ERR = ERR_VSTOBIG;
      124     8668                  /*E* ERROR: -E$VSTOBIG-SEV_ERROR#
      125     8669                       MESSAGE: The size is greater than the maximum allowable.
      126     8670                       MESSAGE1: The size of the virtual area is greater than
      127     8671                                 the maximum allowable size.
      128     8672                   */
      129     8673    2             ALTRETURN;
      130     8674    2           END;
      131     8675
      132     8676    1        IF MM$VCB.PPMAX < 4                /* Illegal need at least four */
      133     8677    2        THEN DO;
      134     8678    2             MM$VCB.PPMAX = 4;
      135     8679    2           END;
      136     8680
      137     8681    1        MM$VCB.PPMIN = MINIMUM( MM$VCB.PPMAX,
      138     8682    1             MAXIMUM( MM$VCB.PPMIN , 4));
      139     8683
      140     8684    1        MM$VCB.HEAD = -1;                  /* Mark head                          */
      141     8685    1        MM$VCB.TAIL = -1;                  /* Mark tail                          */
      142     8686    1        MM$VCB.PPC = 0;
      143     8687    1        MM$VCB.WRITE = %FALSE;
      144     8688    1        MM$VCB.CREATE = %FALSE;
      145     8689    1        MM$VCB.T.FRAGMENTED = %FALSE;
PL6.E3A0      #001=MMV$OPEN File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:25 Page:5    
      146     8690    1        MM$VCB.T.SECTION = %FALSE;
      147     8691    1        MM$VCB.UPGT#=0;
      148     8692    1        MM$VCB.PTR$ = ADDR(NIL);
      149     8693    1        MM$VCB.MAXVP_WRITTEN = -1;
      150     8694    1        MM$VCB.NPGTPGS = MM$VCB.MAXVP# / 1024 + 1;
      151     8695        /*  Decide what kind of mapping it's going to be used */
      152     8696    2        IF HW_SECT_PT THEN DO;             /*   We can use section page table  */
      153     8697    3             IF MM$VCB.NPGTPGS>%MM_MAXSECTPT THEN DO;
      154     8698    3                  MM$VCB.T.SECTION=%TRUE;  /* Use section page table */
      155     8699    3                  MM$VCB.NPGTSECT=(MM$VCB.NPGTPGS-1)/1024+1; /* Nr
      156     8700        of pages used for the section (max 4) */
      157     8701    3                  MM$VCB.NPGTPGS=MINIMUM(MM$VCB.NPGTPGS,%MM_MAXPTENTS - MM$VCB.NPGTSECT
              8701                           ); /*  For a
      158     8702        section PT we use at most 15 noncontiguous pages for pg tables */
      159     8703    3                  GOTO PT_SETUP;
      160     8704    3                END;
      161     8705    2           END;
      162     8706
      163     8707    1        IF MM$VCB.NPGTPGS > 16 OR (MM$VCB.PPMAX < 256 AND MM$VCB.NPGTPGS > 1)
      164     8708    2        THEN DO;
      165     8709    3             IF HW_FRAG_PT THEN DO;
      166     8710    3   GOFRAG:
      167     8711    3                  MM$VCB.T.FRAGMENTED = %TRUE;
      168     8712    3                  MM$VCB.NPGTPGS = 1;
      169     8713    3                END;
      170     8714    3             ELSE DO;
      171     8715    4                  IF MM$VCB.NPGTPGS > 16 THEN DO;
      172     8716    4                       B$JIT.ERR = ERR_VSTOBIG;
      173     8717    4                       ALTRETURN;
      174     8718    4                     END;
      175     8719    3                END;
      176     8720    2           END;
      177     8721
      178     8722        /* Set the write indication if the user can update this file */
      179     8723    1   PT_SETUP:
      180     8724    1        IF B$JIT.DCB$ -> F$DCB.FFLG.UPD
      181     8725    1        THEN
PL6.E3A0      #001=MMV$OPEN File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:25 Page:6    
      182     8726    1             MM$VCB.WRITE = %TRUE;
      183     8727    1        IF B$JIT.DCB$->F$DCB.FUN = %CREATE# AND NOT B$JIT.JUNK & %JJ_LNKRETIP#
              8727                 /* File is open create*/
      184     8728    1        THEN
      185     8729    1             MM$VCB.CREATE = %TRUE;
      186     8730
      187     8731
      188     8732    2        DO CASE (MM$VCB.SEGNUM);
      189     8733
      190     8734    2        CASE (%VS1#);
      191     8735    2           EWSQ = %VS1WSQ;
      192     8736    2           VPPGTBL = %VS1PGTBL;
      193     8737    2           SEGID = %VS1SID;
      194     8738    2           P$ = B$VS1$;
      195     8739
      196     8740    2        CASE (%VS2#);
      197     8741    2           EWSQ = %VS2WSQ;
      198     8742    2           VPPGTBL = %VS2PGTBL;
      199     8743    2           SEGID = %VS2SID;
      200     8744    2           P$ = B$VS2$;
      201     8745
      202     8746    2        CASE (%VS3#);
      203     8747    2           EWSQ = %VS3WSQ;
      204     8748    2           VPPGTBL = %VS3PGTBL;
      205     8749    2           SEGID = %VS3SID;
      206     8750    2           P$ = B$VS3$;
      207     8751
      208     8752    2        CASE (ELSE);
      209     8753    2           B$JIT.ERR = ILGLSEG;
      210     8754                  /*E* ERROR: -E$ILGLSEG-SEV_ERROR#
      211     8755                       MESSAGE: Illegal segment number.
      212     8756                       MESSAGE1: The segment number for the virtual segment
      213     8757                                 was not 1, 2, or 3.
      214     8758                             */
      215     8759    2           ALTRETURN;
      216     8760    2        END;
      217     8761
PL6.E3A0      #001=MMV$OPEN File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:25 Page:7    
      218     8762    1        MM$VCB.WSQ = EWSQ;
      219     8763    1        I = EWSQ - %VS1WSQ;                /* Index into jit table for DCB#      */
      220     8764    1        IF B$JIT.VIRTUAL.DCB#(I) ~= 0      /* Already used                       */
      221     8765    2        THEN DO;
      222     8766    2             B$JIT.ERR = ERR_VSINUSE;
      223     8767                  /*E* ERROR: -E$VSINUSE-SEV_ERROR#
      224     8768                       MESSAGE: The specified Virtual segment is already in use
      225     8769                       MESSAGE1: The access method specified a virtual segment
      226     8770                                 and that segment is in use by another DCB.
      227     8771                        */
      228     8772    2             ALTRETURN;
      229     8773    2           END;
      230     8774
      231     8775        /* Get a page table for this wsq */
      232     8776    2        IF MM$VCB.T.SECTION THEN DO;  /* Get the Section and the page tables */
      233     8777    2             PPNO = MM$VCB.NPGTSECT;
      234     8778    2             CALL MMB$GNPP(PPNO,%USERWSQ) ALTRET(NO_PT);
      235     8779    3             DO TEMP = 0 TO MM$VCB.NPGTSECT - 1;
      236     8780    3                  CALL MME$GVPNOPP (%USERWSQ,VPPGTBL+TEMP,PPNO+TEMP,ERR) ALTRET (REL_IT
              8780                           );
      237     8781    3                END;
      238     8782    3             DO TEMP=0 TO MM$VCB.NPGTPGS-1;
      239     8783    3                  CALL MMB$GPP(PPNO,%USERWSQ) ALTRET(REL_EM);
      240     8784    3                  CALL MME$GVPNOPP(%USERWSQ,VPPGTBL+MM$VCB.NPGTSECT+TEMP,PPNO,ERR)
              8784                           ALTRET (REL_EM);
      241     8785    3                END;
      242     8786    2           END;
      243     8787    2        ELSE DO;
      244     8788    2             PPNO = MM$VCB.NPGTPGS;
      245     8789    2             CALL MMB$GNPP(PPNO,%USERWSQ) ALTRET(NO_PT);
      246     8790    3             DO TEMP = 0 TO MM$VCB.NPGTPGS - 1;
      247     8791    3                  CALL MME$GVPNOPP (%USERWSQ,VPPGTBL+TEMP,PPNO+TEMP,ERR) ALTRET (
              8791                           REL_DENSE);
      248     8792    3                END;
      249     8793    2           END;
      250     8794        /* Set DCB# in jit for this virtual array */
      251     8795    1        B$JIT.VIRTUAL.DCB# (I) = B$JIT.DCBNO;
PL6.E3A0      #001=MMV$OPEN File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:25 Page:8    
      252     8796
      253     8797        /* Set pointer to segment in vlp */
      254     8798    1        VCB$->VLP$VIRTUAL.PTR$ = P$; /* P$ contains pointer to approiate segment */
      255     8799
      256     8800             %FINDMAP (P$ = P$,WSQ = EWSQ);
      257     8803
      258     8804        /* Set segment not null */
      259     8805    1        IF NOT HW_IMX THEN
      260     8806                  %SETNOTNULL (LS$ = B$USERLS$, SEGID = SEGID);
      261     8809    2        ELSE DO;
      262     8810    2             TEMP = BITBIN(SEGID & '1777'O);
      263     8811    2             B$USERLS$->MM$SDESC.FLGS(TEMP) = '7'O;
      264     8812    2           END;
      265     8813
      266     8814    2        IF MM$VCB.T.SECTION THEN DO;
      267     8815    3             DO I=0 TO MM$VCB.NPGTSECT*1024-1;
      268     8816    3                  P$->B$SECT(I) = '0'B;
      269     8817    3                  P$->B$SECT.PRES(I)= %TRUE;
      270     8818    3                  P$->B$SECT.PTBOUND(I)= 15   ;
      271     8819    3                  P$->B$SECT.PTBASE(I) = MM_SCTDFT;
      272     8820    3                END;
      273     8821    3             DO I=0 TO MM$VCB.NPGTPGS-1;
      274     8822    4                  DO TEMP =0 TO 1023;
      275     8823    4                       PINCRW(P$,(I+MM$VCB.NPGTSECT) *1024 )->B$MAP(TEMP)=MM_FPMC;
      276     8824    4                     END;
      277     8825    3                END;
      278     8826    2           END;
      279     8827    2        ELSE DO;
      280     8828    2             TEMP = MM$VCB.NPGTPGS * 1024 - 1;
      281     8829    3             DO I = 0 TO TEMP;             /* Clear out page table               */
      282     8830    3                  P$ -> B$MAP (I) = '0'B;
      283     8831    3                  IF NOT MM$VCB.T.FRAGMENTED OR I >= 128
      284     8832    3                  THEN
      285     8833    3                       P$ -> B$MAP(I) = MM_FPMC;
      286     8834    3                END;
      287     8835    2           END;
      288     8836
PL6.E3A0      #001=MMV$OPEN File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:25 Page:9    
      289     8837        /* Must set up wsptd for the virtual area */
      290     8838    1        TEMP = B$UPT$ -> B$MAP.RPN (VPPGTBL);
      291     8839    1        TEMP = TEMP * (1024 / HW_PTB_UNITS);
      292     8840    1        S_WSPTD.BLKNO(EWSQ)=TEMP;
      293     8841    1        IF MM$VCB.T.SECTION THEN S_WSPTD.NBLKS(EWSQ) = MM$VCB.NPGTSECT * 16;
      294     8842    1        ELSE S_WSPTD.NBLKS(EWSQ) = MM$VCB.NPGTPGS * 16;
      295     8843    1        S_WSPTD.P(EWSQ) = %TRUE;           /* Page table present                 */
      296     8844    1        S_WSPTD.T(EWSQ) = MM$VCB.T;
      297     8845    1        IF NOT HW_IMX THEN
      298     8846    1             S_WSPTD.Q(EWSQ) = BINBIT(MOD(EWSQ,4),2);
      299     8847    1        ELSE
      300     8848    1             S_WSPTD.Q(EWSQ) = '0'O;
      301     8849
      302     8850        /* Save it in MM$VCB for use at time of schedule */
      303     8851    1        MM$VCB.WSPTD = S_WSPTD(EWSQ);
      304     8852    1        RETURN;                            /* All done                           */
      305     8853
      306     8854
      307     8855    1   NO_PT:
      308     8856    2        IF HW_FRAG_PT THEN DO;
      309     8857    2             MM$VCB.T.SECTION = %FALSE;
      310     8858    2             GOTO GOFRAG;
      311     8859    2           END;
      312     8860    1        B$JIT.ERR = BRKCTY;
      313     8861    1        ALTRETURN;
      314     8862
      315     8863    1   REL_EM: /* Release both PTS(here), and SCTs(at REL_IT); */
      316     8864    2        DO I = 0 TO TEMP-1;
      317     8865    2             CALL MME$WFVP (%USERWSQ, VPPGTBL+MM$VCB.NPGTPGS+I,, TERR);
      318     8866    2           END;
      319     8867    1        TEMP = MM$VCB.NPGTSECT;
      320     8868    1   REL_IT: /* Release the SCT or the PT.  TEMP holds how far we got */
      321     8869    2        DO I = 0 TO TEMP-1;
      322     8870    2             CALL MME$RVNP (%USERWSQ, VPPGTBL+I, PPNO, TERR);
      323     8871    2             CALL MMB$FPPONTAIL (PPNO);
      324     8872    2           END;
      325     8873    2        DO I = TEMP TO MM$VCB.NPGTSECT - 1;
PL6.E3A0      #001=MMV$OPEN File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:25 Page:10   
      326     8874    2             CALL MMB$FPPONTAIL(PPNO+I);
      327     8875    2           END;
      328     8876             %ERRSETN(CODE=ERR);
      329     8879    1        ALTRETURN;
      330     8880
      331     8881    1   REL_DENSE:
      332     8882    1        SAVE_PPNO = PPNO;
      333     8883    2        DO I = 0 TO TEMP -1;
      334     8884    2             CALL MME$RVNP(%USERWSQ,VPPGTBL+I,PPNO,TEMP);
      335     8885    2             CALL MMB$FPPONTAIL(PPNO);
      336     8886    2           END;
      337     8887    2        DO I = TEMP TO MM$VCB.NPGTPGS - 1;
      338     8888    2             CALL MMB$FPPONTAIL(SAVE_PPNO+I);
      339     8889    2           END;
      340     8890             %ERRSETN(CODE=ERR);
      341     8893    1        ALTRETURN;
      342     8894    1   END MMV$OPEN;
      343     8895        %EOD;

PL6.E3A0      #001=MMV$OPEN File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:25 Page:11   
--  Include file information  --

   HF_LOCK_C.:E05TOU  cannot be made into a system file and is referenced.
   UD_SEV_C.:E05TOU  is referenced.
   S_WSPTD_R.:E05TOU  cannot be made into a system file and is referenced.
   M_ERRSET_C.:E05TOU  is referenced.
   M_ERRORS_C.:E05TOU  is referenced.
   HF_DATA_R.:E05TOU  cannot be made into a system file and is referenced.
   MM_MACRO_M.:E05TOU  is referenced.
   B_STRINGS_C.:E05TOU  is referenced.
   MM$SYSGEN.:E05TOU  is referenced.
   M_INFO_C.:E05TOU  is referenced.
   MM_DATA_R.:E05TOU  cannot be made into a system file and is referenced.
   F$DCB.:E05TOU  cannot be made into a system file and is referenced.
   F$CP6V_C.:E05TOU  is referenced.
   CP_6_SUBS.:E05TOU  is referenced.
   CP_6_C.:E05TOU  is referenced.
   CP_6.:E05TOU  cannot be made into a system file and is referenced.
   B_SEGIDS_C.:E05TOU  is referenced.
   B$MAP.:E05TOU  cannot be made into a system file and is referenced.
   B$JIT_C.:E05TOU  is referenced.
   B$JIT.:E05TOU  cannot be made into a system file and is referenced.
      No diagnostics issued in procedure MMV$OPEN.

   Procedure MMV$OPEN requires 596 words for executable code.
   Procedure MMV$OPEN requires 22 words of local(AUTO) storage.

PL6.E3A0      #001=MMV$OPEN File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:25 Page:12   

 Object Unit name= MMV$OPEN                                   File name= MMV$VIRTUAL.:E05TOU
 UTS= JUL 30 '97 03:25:09.76 WED                              Compiler= PL-6/E31         Sev=      00
 SharedLib= :SHARED_SYSTEM                                    Alt SharedLib=


    ****  Control sections  ****

 Sect   Type Bound  Init  Size OctSiz  Section name(segment info)
    0   DCB   even  none     0      0  M$UC
    1  RoData even  UTS      6      6  MMV$OPEN
    2   Proc  even  none   596   1124  MMV$OPEN
    3  RoData even  none     6      6  MMV$OPEN

    ****  Entry defs  ****

                              Check   Calling
                             calling  sequence
  Sect OctLoc Primary Altret sequence   type   Parms  Name
     2      0   yes    yes     yes      Std        0  MMV$OPEN

  ****  Entry refs  ****

         Check        Calling
        calling       sequence
Altret sequence SRef   type   Args  Name
 yes     yes           Std       2 MMB$GNPP
 yes     yes           Std       4 MME$GVPNOPP
 yes     yes           Std       2 MMB$GPP
 yes     yes           Std       4 MME$WFVP
 yes     yes           Std       4 MME$RVNP
 yes     yes           Std       1 MMB$FPPONTAIL
                       nStd      0 X66_AUTO_0
                       Std       0 B_CONSPOOL_D
                       nStd      0 X66_AALT
                       nStd      0 X66_ARET
PL6.E3A0      #001=MMV$OPEN File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:25 Page:13   

  ****  Data refs  ****

  Flags:  r = read only, s = secondary
Flgs Name                             Flgs Name                             Flgs Name
     M$UC                             r    MM_BYP$                               MM_FPMC
     MM_SCTDFT                        r    MM_PTPTRS$                            HW_PTB_UNITS
     HW_SECT_PT                            HW_FRAG_PT                            HW_IMX
     S_WSPTD                          r    B$JIT$                                B$USERLS$
     B$UPT$                           r    B$VS1$                           r    B$VS2$
r    B$VS3$                                B_VECTNIL

  ****  Segment refs  ****

  Flags:  r = read only, s = secondary
Flgs Name                             Flgs Name                             Flgs Name
     ISSID
PL6.E3A0      #001=MMV$OPEN File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:25 Page:14   


        1        1        /*M* MMV$VIRTUAL - MM routines to manage large virtual space */
        2        2        /*T***********************************************************/
        3        3        /*T*                                                         */
        4        4        /*T* Copyright (c) Bull HN Information Systems Inc., 1997    */
        5        5        /*T*                                                         */
        6        6        /*T***********************************************************/
        7        7        /*X* DMR,PLM=5,IND=5,CTI=5,SDI=5,MCL=10,CSI=0,ECI=0 */
        8        8        MMV$OPEN: PROC ALTRET;

      8  2 000000   000000 700200 xent  MMV$OPEN     TSX0  ! X66_AUTO_0
         2 000001   000026 000000                    ZERO    22,0

        9        9
       10       10        /*F* NAME: MMV$OPEN
       11       11             PURPOSE: To ready a virtual segment for use.
       12       12             DESCRIPTION: MMV$OPEN is called by file management when the
       13       13                          access type specified VS1, VS2, or VS3. The main
       14       14                          thing that has to be done in this routine is to
       15       15                          initialize the page table for the given WSQ and
       16       16                          set up the WSPTD. No pages are put into the map
       17       17                          until a fault occurs.
       18       18          */
       19       19
       20       20        /* Includes */
       21       21        %INCLUDE B$JIT;
       22      624        %INCLUDE B$MAP;
       23      723        %INCLUDE B_SEGIDS_C;
       24     1262        %INCLUDE CP_6;
       25     6821        %INCLUDE CP_6_SUBS;
       26     7361        %INCLUDE F$CP6V_C;
       27     7587        %INCLUDE F$DCB;
       28     7636        %INCLUDE MM_DATA_R;
       29     8156        %INCLUDE HF_DATA_R;
       30     8199        %INCLUDE M_ERRORS_C;
       31     8263        %INCLUDE M_ERRSET_C;
       32     8287        %INCLUDE S_WSPTD_R;
PL6.E3A0      #001=MMV$OPEN File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:25 Page:15   
       33     8303        %INCLUDE UD_SEV_C;
       34     8317        %INCLUDE HF_LOCK_C;
       35     8331
       36     8332        /* Symrefs */
       37     8333    1   DCL B$JIT$ PTR SYMREF READONLY;
       38     8334    1   DCL B$PPUT$ PTR SYMREF READONLY;
       39     8335    1   DCL B$PS$(0:0) PTR SYMREF;
       40     8336    1   DCL B$ROSEG$ PTR SYMREF READONLY;
       41     8337    1   DCL B$USERLS$ PTR SYMREF;
       42     8338    1   DCL B$UPT$ PTR SYMREF;
       43     8339    1   DCL B$VS1$ PTR SYMREF READONLY;
       44     8340    1   DCL B$VS2$ PTR SYMREF READONLY;
       45     8341    1   DCL B$VS3$ PTR SYMREF READONLY;
       46     8342    1   DCL B$IPHYMAP$ PTR SYMREF READONLY;
       47     8343    1   DCL B$WSQ0PT$ PTR SYMREF READONLY;
       48     8344
       49     8345        /* Macro invocations */
       50     8346        %FPT$OPEN_V;
       51     8361        %MM$VIRTUAL_STATS;
       52     8365        %MODERR(MODULE='26'O);                  /* Sets the module of errcode to v    */
       53     8373        %VLP_ERRCODE (FPTN=ERR_VSINUSE,
       54     8374                       FCG=MM,
       55     8375                       MID=V,
       56     8376                       MON='1'B,
       57     8377                       ERR#=%E$VSINUSE,
       58     8378                       SEV=SEV_ERROR#,
       59     8379                       STCLASS=CONSTANT);
       60     8424        %VLP_ERRCODE (FPTN=ERR_VSTOBIG,
       61     8425                       FCG=MM,
       62     8426                       MID=V,
       63     8427                       MON='1'B,
       64     8428                       ERR#=%E$VSTOBIG,
       65     8429                       SEV=SEV_ERROR#,
       66     8430                       STCLASS=CONSTANT);
       67     8475        %VLP_ERRCODE (FPTN=ILGLSEG,ERR#=%E$ILGLSEG,SEV=SEV_ERROR#,FCG=MM,MID=V,MON='1'B,
              8475            STCLASS=CONSTANT);
       68     8520        %VLP_ERRCODE (FPTN=BRKCTY,ERR#=%E$BRKCTY,SEV=SEV_ERROR#,FCG=MM,MID=V,MON='1'B,
PL6.E3A0      #001=MMV$OPEN File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:25 Page:16   
              8520            STCLASS=CONSTANT);
       69     8565       %VLP_ERRCODE (FPTN=NOVLPVIRT,ERR#=%E$NOVLPVIRT,SEV=SEV_ERROR#,FCG=MM,MID=V,MON='1'B,
              8565            STCLASS=CONSTANT);
       70     8610        %VLP$VIRTUAL_V (FPTN=VLP$VIRTUAL);
       71     8615
       72     8616        /* Entry references */
       73     8617    1   DCL MME$WGVP ENTRY(4) ALTRET;
       74     8618    1   DCL MME$GVPNOPP ENTRY(4) ALTRET;
       75     8619    1   DCL MME$WFVP ENTRY(4) ALTRET;
       76     8620    1   DCL MMB$GPP ENTRY(2) ALTRET;
       77     8621    1   DCL MMB$GNPP ENTRY(2) ALTRET;
       78     8622    1   DCL MMB$FPPONTAIL ENTRY(1) ALTRET;
       79     8623    1   DCL MME$RVNP ENTRY(4) ALTRET;
       80     8624
       81     8625        /* Subs */
       82     8626        %SUB MM$VCB = VCB$->MM$VCB;
       83     8627
       84     8628        /* Auto */
       85     8629    1   DCL EWSQ SBIN;
       86     8630    1   DCL P$ PTR;
       87     8631    1   DCL ERR UBIN;
       88     8632    1   DCL I SBIN;
       89     8633    1   DCL VPPGTBL UBIN;                       /* Page table virtual page            */
       90     8634    1   DCL VCB$ PTR;
       91     8635    1   DCL SEGID BIT(12);
       92     8636    1   DCL PPNO UBIN;
       93     8637    1   DCL TEMP SBIN;
       94     8638    1   DCL   SAVE_PPNO UBIN WORD;
       95     8639    1   DCL TERR UBIN;
       96     8640
       97     8641        /* Begin procedure */
       98     8642
       99     8643        /* Check out passed parameters */
      100     8644    1        VCB$ = B$JIT.DCB$ -> F$DCB.SETSTA$;     /* Setsta contians

   8644  2 000002   000000 470400 xsym               LDP0    B$JIT$
         2 000003   000232 471500                    LDP1    154,,PR0
PL6.E3A0      #001=MMV$OPEN File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:25 Page:17   
         2 000004   100006 236100                    LDQ     6,,PR1
         2 000005   200010 756100                    STQ     VCB$,,AUTO

      101     8645                                                          address of ROSEG area */
      102     8646    1        B$JIT.DCBNO = B$JIT.DCB$ -> F$DCB.DCB#;

   8646  2 000006   100060 236100                    LDQ     48,,PR1
         2 000007   000033 772000                    QRL     27
         2 000010   000022 552104                    STBQ    18,'04'O,PR0

      103     8647
      104     8648    1        IF VCB$ = ADDR(NIL)                /* No VLP_VIRTUAL specified */

   8648  2 000011   200010 236100                    LDQ     VCB$,,AUTO
         2 000012   000001 116000 xsym               CMPQ    B_VECTNIL+1
         2 000013   000017 601000 2                  TNZ     s:8659

      105     8649    2        THEN DO;

      106     8650    2             B$JIT.ERR = NOVLPVIRT;

   8650  2 000014   000005 236000 1                  LDQ     NOVLPVIRT
         2 000015   000012 756100                    STQ     10,,PR0

      107     8651                  /*E* ERROR: -E$NOVLPVIRT-SEV_ERROR#
      108     8652                       MESSAGE: VLP_VIRTUAL must be specified.
      109     8653                       MESSAGE1: The access method specified VS1 or VS2 or VS3
      110     8654                                 and VIRTUAL was not specified on the open.
      111     8655              */
      112     8656    2             ALTRETURN;

   8656  2 000016   000000 702200 xent               TSX2  ! X66_AALT

      113     8657    2           END;
      114     8658
      115     8659    1        IF NOT B$JIT.JUNK & %JJ_LNKRETIP#

PL6.E3A0      #001=MMV$OPEN File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:25 Page:18   
   8659  2 000017   000315 220100                    LDX0    205,,PR0
         2 000020   000002 360003                    ANX0    2,DU
         2 000021   000033 601000 2                  TNZ     s:8665

      116     8660    2        THEN DO;

      117     8661    2             B$JIT.DCB$ -> F$DCB.LASTSTA$->MM$VIRTUAL_STATS = '0'B;

   8661  2 000022   100007 473500                    LDP3    7,,PR1
         2 000023   000100 100400                    MLR     fill='000'O
         2 000024   000002 000001 xsym               ADSC9   B_VECTNIL+2              cn=0,n=1
         2 000025   300000 000040                    ADSC9   0,,PR3                   cn=0,n=32

      118     8662    2             MM$VCB.MAXVP# = (MM$VCB.MAXVP# -1) / 1024;

   8662  2 000026   200010 471500                    LDP1    VCB$,,AUTO
         2 000027   100002 236100                    LDQ     2,,PR1
         2 000030   000001 136007                    SBLQ    1,DL
         2 000031   002000 506007                    DIV     1024,DL
         2 000032   100002 756100                    STQ     2,,PR1

      119     8663    2           END;

      120     8664                 /* Check to see if maxvp is resonable */
      121     8665    1        IF MM$VCB.MAXVP# >= 1024 * 4096    /* Greater than maximum               */

   8665  2 000033   200010 471500                    LDP1    VCB$,,AUTO
         2 000034   100002 235100                    LDA     2,,PR1
         2 000035   000020 115003                    CMPA    16,DU
         2 000036   000042 604000 2                  TMI     s:8676

      122     8666    2        THEN DO;

      123     8667    2             B$JIT.ERR = ERR_VSTOBIG;

   8667  2 000037   000002 236000 1                  LDQ     ERR_VSTOBIG
         2 000040   000012 756100                    STQ     10,,PR0
PL6.E3A0      #001=MMV$OPEN File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:25 Page:19   

      124     8668                  /*E* ERROR: -E$VSTOBIG-SEV_ERROR#
      125     8669                       MESSAGE: The size is greater than the maximum allowable.
      126     8670                       MESSAGE1: The size of the virtual area is greater than
      127     8671                                 the maximum allowable size.
      128     8672                   */
      129     8673    2             ALTRETURN;

   8673  2 000041   000000 702200 xent               TSX2  ! X66_AALT

      130     8674    2           END;
      131     8675
      132     8676    1        IF MM$VCB.PPMAX < 4                /* Illegal need at least four */

   8676  2 000042   100003 220100                    LDX0    3,,PR1
         2 000043   000004 100003                    CMPX0   4,DU
         2 000044   000047 603000 2                  TRC     s:8681

      133     8677    2        THEN DO;

      134     8678    2             MM$VCB.PPMAX = 4;

   8678  2 000045   000004 221003                    LDX1    4,DU
         2 000046   100003 741100                    STX1    3,,PR1

      135     8679    2           END;

      136     8680
      137     8681    1        MM$VCB.PPMIN = MINIMUM( MM$VCB.PPMAX,

   8681  2 000047   100003 236100                    LDQ     3,,PR1
         2 000050   777777 376007                    ANQ     -1,DL
         2 000051   000004 116007                    CMPQ    4,DL
         2 000052   000054 603000 2                  TRC     s:8681+5
         2 000053   000004 236007                    LDQ     4,DL
         2 000054   200016 756100                    STQ     TERR+1,,AUTO
         2 000055   100003 236100                    LDQ     3,,PR1
PL6.E3A0      #001=MMV$OPEN File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:25 Page:20   
         2 000056   000022 772000                    QRL     18
         2 000057   200016 116100                    CMPQ    TERR+1,,AUTO
         2 000060   000063 602000 2                  TNC     s:8681+12
         2 000061   000063 600000 2                  TZE     s:8681+12
         2 000062   200016 236100                    LDQ     TERR+1,,AUTO
         2 000063   000000 620006                    EAX0    0,QL
         2 000064   100003 440100                    SXL0    3,,PR1

      138     8682    1             MAXIMUM( MM$VCB.PPMIN , 4));
      139     8683
      140     8684    1        MM$VCB.HEAD = -1;                  /* Mark head                          */

   8684  2 000065   000001 335007                    LCA     1,DL
         2 000066   100006 755100                    STA     6,,PR1

      141     8685    1        MM$VCB.TAIL = -1;                  /* Mark tail                          */

   8685  2 000067   100007 755100                    STA     7,,PR1

      142     8686    1        MM$VCB.PPC = 0;

   8686  2 000070   000000 221003                    LDX1    0,DU
         2 000071   100011 741100                    STX1    9,,PR1

      143     8687    1        MM$VCB.WRITE = %FALSE;

   8687  2 000072   000000 236000 3                  LDQ     0
         2 000073   100000 356100                    ANSQ    0,,PR1

      144     8688    1        MM$VCB.CREATE = %FALSE;

   8688  2 000074   000001 236000 3                  LDQ     1
         2 000075   100000 356100                    ANSQ    0,,PR1

      145     8689    1        MM$VCB.T.FRAGMENTED = %FALSE;

   8689  2 000076   000002 236000 3                  LDQ     2
PL6.E3A0      #001=MMV$OPEN File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:25 Page:21   
         2 000077   100000 356100                    ANSQ    0,,PR1

      146     8690    1        MM$VCB.T.SECTION = %FALSE;

   8690  2 000100   000003 236000 3                  LDQ     3
         2 000101   100000 356100                    ANSQ    0,,PR1

      147     8691    1        MM$VCB.UPGT#=0;

   8691  2 000102   100013 741100                    STX1    11,,PR1

      148     8692    1        MM$VCB.PTR$ = ADDR(NIL);

   8692  2 000103   000001 236000 xsym               LDQ     B_VECTNIL+1
         2 000104   100004 756100                    STQ     4,,PR1

      149     8693    1        MM$VCB.MAXVP_WRITTEN = -1;

   8693  2 000105   100010 755100                    STA     8,,PR1

      150     8694    1        MM$VCB.NPGTPGS = MM$VCB.MAXVP# / 1024 + 1;

   8694  2 000106   100002 236100                    LDQ     2,,PR1
         2 000107   002000 506007                    DIV     1024,DL
         2 000110   000001 036007                    ADLQ    1,DL
         2 000111   100012 756100                    STQ     10,,PR1

      151     8695        /*  Decide what kind of mapping it's going to be used */
      152     8696    2        IF HW_SECT_PT THEN DO;             /*   We can use section page table  */

   8696  2 000112   000000 234000 xsym               SZN     HW_SECT_PT
         2 000113   000137 605000 2                  TPL     s:8707

      153     8697    3             IF MM$VCB.NPGTPGS>%MM_MAXSECTPT THEN DO;

   8697  2 000114   000004 116007                    CMPQ    4,DL
         2 000115   000137 604400 2                  TMOZ    s:8707
PL6.E3A0      #001=MMV$OPEN File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:25 Page:22   

      154     8698    3                  MM$VCB.T.SECTION=%TRUE;  /* Use section page table */

   8698  2 000116   010000 236003                    LDQ     4096,DU
         2 000117   100000 256100                    ORSQ    0,,PR1

      155     8699    3                  MM$VCB.NPGTSECT=(MM$VCB.NPGTPGS-1)/1024+1; /* Nr

   8699  2 000120   100012 236100                    LDQ     10,,PR1
         2 000121   000001 136007                    SBLQ    1,DL
         2 000122   002000 506007                    DIV     1024,DL
         2 000123   000001 622006                    EAX2    1,QL
         2 000124   100011 442100                    SXL2    9,,PR1

      156     8700        of pages used for the section (max 4) */
      157     8701    3                 MM$VCB.NPGTPGS=MINIMUM(MM$VCB.NPGTPGS,%MM_MAXPTENTS - MM$VCB.NPGTSECT
              8701                           ); /*  For a

   8701  2 000125   100011 236100                    LDQ     9,,PR1
         2 000126   000022 736000                    QLS     18
         2 000127   000022 732000                    QRS     18
         2 000130   000027 676000 xsym               ERQ     B_VECTNIL+23
         2 000131   000021 036007                    ADLQ    17,DL
         2 000132   100012 116100                    CMPQ    10,,PR1
         2 000133   000135 604400 2                  TMOZ    s:8701+8
         2 000134   100012 236100                    LDQ     10,,PR1
         2 000135   100012 756100                    STQ     10,,PR1

      158     8702        section PT we use at most 15 noncontiguous pages for pg tables */
      159     8703    3                  GOTO PT_SETUP;

   8703  2 000136   000163 710000 2                  TRA     PT_SETUP

      160     8704    3                END;
      161     8705    2           END;
      162     8706
      163     8707    1        IF MM$VCB.NPGTPGS > 16 OR (MM$VCB.PPMAX < 256 AND MM$VCB.NPGTPGS > 1)
PL6.E3A0      #001=MMV$OPEN File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:25 Page:23   

   8707  2 000137   000020 116007                    CMPQ    16,DL
         2 000140   000146 605400 2                  TPNZ    s:8709
         2 000141   100003 222100                    LDX2    3,,PR1
         2 000142   000400 102003                    CMPX2   256,DU
         2 000143   000163 603000 2                  TRC     PT_SETUP
         2 000144   000001 116007                    CMPQ    1,DL
         2 000145   000163 604400 2                  TMOZ    PT_SETUP

      164     8708    2        THEN DO;

      165     8709    3             IF HW_FRAG_PT THEN DO;

   8709  2 000146   000000 234000 xsym               SZN     HW_FRAG_PT
         2 000147   000156 605000 2                  TPL     s:8715

      166     8710    3   GOFRAG:
      167     8711    3                  MM$VCB.T.FRAGMENTED = %TRUE;

   8711  2 000150   200010 470500       GOFRAG       LDP0    VCB$,,AUTO
         2 000151   020000 236003                    LDQ     8192,DU
         2 000152   000000 256100                    ORSQ    0,,PR0

      168     8712    3                  MM$VCB.NPGTPGS = 1;

   8712  2 000153   000001 235007                    LDA     1,DL
         2 000154   000012 755100                    STA     10,,PR0

      169     8713    3                END;

   8713  2 000155   000163 710000 2                  TRA     PT_SETUP

      170     8714    3             ELSE DO;

      171     8715    4                  IF MM$VCB.NPGTPGS > 16 THEN DO;

   8715  2 000156   000020 116007                    CMPQ    16,DL
PL6.E3A0      #001=MMV$OPEN File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:25 Page:24   
         2 000157   000163 604400 2                  TMOZ    PT_SETUP

      172     8716    4                       B$JIT.ERR = ERR_VSTOBIG;

   8716  2 000160   000002 236000 1                  LDQ     ERR_VSTOBIG
         2 000161   000012 756100                    STQ     10,,PR0

      173     8717    4                       ALTRETURN;

   8717  2 000162   000000 702200 xent               TSX2  ! X66_AALT

      174     8718    4                     END;
      175     8719    3                END;
      176     8720    2           END;
      177     8721
      178     8722        /* Set the write indication if the user can update this file */
      179     8723    1   PT_SETUP:
      180     8724    1        IF B$JIT.DCB$ -> F$DCB.FFLG.UPD

   8724  2 000163   000000 470400 xsym  PT_SETUP     LDP0    B$JIT$
         2 000164   000232 471500                    LDP1    154,,PR0
         2 000165   100004 236100                    LDQ     4,,PR1
         2 000166   040000 316003                    CANQ    16384,DU
         2 000167   000173 600000 2                  TZE     s:8727

      181     8725    1        THEN
      182     8726    1             MM$VCB.WRITE = %TRUE;

   8726  2 000170   200010 473500                    LDP3    VCB$,,AUTO
         2 000171   100000 236003                    LDQ     32768,DU
         2 000172   300000 256100                    ORSQ    0,,PR3

      183     8727    1        IF B$JIT.DCB$->F$DCB.FUN = %CREATE# AND NOT B$JIT.JUNK & %JJ_LNKRETIP#
              8727                 /* File is open create*/

   8727  2 000173   000232 471500                    LDP1    154,,PR0
         2 000174   100032 236100                    LDQ     26,,PR1
PL6.E3A0      #001=MMV$OPEN File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:25 Page:25   
         2 000175   000777 376003                    ANQ     511,DU
         2 000176   000003 116003                    CMPQ    3,DU
         2 000177   000206 601000 2                  TNZ     s:8732
         2 000200   000315 220100                    LDX0    205,,PR0
         2 000201   000002 360003                    ANX0    2,DU
         2 000202   000206 601000 2                  TNZ     s:8732

      184     8728    1        THEN
      185     8729    1             MM$VCB.CREATE = %TRUE;

   8729  2 000203   200010 473500                    LDP3    VCB$,,AUTO
         2 000204   040000 236003                    LDQ     16384,DU
         2 000205   300000 256100                    ORSQ    0,,PR3

      186     8730
      187     8731
      188     8732    2        DO CASE (MM$VCB.SEGNUM);

   8732  2 000206   200010 471500                    LDP1    VCB$,,AUTO
         2 000207   100000 720100                    LXL0    0,,PR1
         2 000210   000777 360003                    ANX0    511,DU
         2 000211   000004 100003                    CMPX0   4,DU
         2 000212   000214 602010 2                  TNC     s:8732+6,X0
         2 000213   000253 710000 2                  TRA     s:8753
         2 000214   000253 710000 2                  TRA     s:8753
         2 000215   000220 710000 2                  TRA     s:8735
         2 000216   000231 710000 2                  TRA     s:8741
         2 000217   000242 710000 2                  TRA     s:8747

      189     8733
      190     8734    2        CASE (%VS1#);

      191     8735    2           EWSQ = %VS1WSQ;

   8735  2 000220   000011 235007                    LDA     9,DL
         2 000221   200003 755100                    STA     EWSQ,,AUTO

PL6.E3A0      #001=MMV$OPEN File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:25 Page:26   
      192     8736    2           VPPGTBL = %VS1PGTBL;

   8736  2 000222   001050 236007                    LDQ     552,DL
         2 000223   200007 756100                    STQ     VPPGTBL,,AUTO

      193     8737    2           SEGID = %VS1SID;

   8737  2 000224   603200 236003                    LDQ     -63872,DU
         2 000225   200011 756100                    STQ     SEGID,,AUTO

      194     8738    2           P$ = B$VS1$;

   8738  2 000226   000000 236000 xsym               LDQ     B$VS1$
         2 000227   200004 756100                    STQ     P$,,AUTO
         2 000230   000256 710000 2                  TRA     s:8762

      195     8739
      196     8740    2        CASE (%VS2#);

      197     8741    2           EWSQ = %VS2WSQ;

   8741  2 000231   000012 235007                    LDA     10,DL
         2 000232   200003 755100                    STA     EWSQ,,AUTO

      198     8742    2           VPPGTBL = %VS2PGTBL;

   8742  2 000233   001070 236007                    LDQ     568,DL
         2 000234   200007 756100                    STQ     VPPGTBL,,AUTO

      199     8743    2           SEGID = %VS2SID;

   8743  2 000235   603300 236003                    LDQ     -63808,DU
         2 000236   200011 756100                    STQ     SEGID,,AUTO

      200     8744    2           P$ = B$VS2$;

   8744  2 000237   000000 236000 xsym               LDQ     B$VS2$
PL6.E3A0      #001=MMV$OPEN File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:25 Page:27   
         2 000240   200004 756100                    STQ     P$,,AUTO
         2 000241   000256 710000 2                  TRA     s:8762

      201     8745
      202     8746    2        CASE (%VS3#);

      203     8747    2           EWSQ = %VS3WSQ;

   8747  2 000242   000013 235007                    LDA     11,DL
         2 000243   200003 755100                    STA     EWSQ,,AUTO

      204     8748    2           VPPGTBL = %VS3PGTBL;

   8748  2 000244   001110 236007                    LDQ     584,DL
         2 000245   200007 756100                    STQ     VPPGTBL,,AUTO

      205     8749    2           SEGID = %VS3SID;

   8749  2 000246   603400 236003                    LDQ     -63744,DU
         2 000247   200011 756100                    STQ     SEGID,,AUTO

      206     8750    2           P$ = B$VS3$;

   8750  2 000250   000000 236000 xsym               LDQ     B$VS3$
         2 000251   200004 756100                    STQ     P$,,AUTO
         2 000252   000256 710000 2                  TRA     s:8762

      207     8751
      208     8752    2        CASE (ELSE);

      209     8753    2           B$JIT.ERR = ILGLSEG;

   8753  2 000253   000003 236000 1                  LDQ     ILGLSEG
         2 000254   000012 756100                    STQ     10,,PR0

      210     8754                  /*E* ERROR: -E$ILGLSEG-SEV_ERROR#
      211     8755                       MESSAGE: Illegal segment number.
PL6.E3A0      #001=MMV$OPEN File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:25 Page:28   
      212     8756                       MESSAGE1: The segment number for the virtual segment
      213     8757                                 was not 1, 2, or 3.
      214     8758                             */
      215     8759    2           ALTRETURN;

   8759  2 000255   000000 702200 xent               TSX2  ! X66_AALT

      216     8760    2        END;

      217     8761
      218     8762    1        MM$VCB.WSQ = EWSQ;

   8762  2 000256   200003 236100                    LDQ     EWSQ,,AUTO
         2 000257   000022 736000                    QLS     18
         2 000260   100000 552120                    STBQ    0,'20'O,PR1

      219     8763    1        I = EWSQ - %VS1WSQ;                /* Index into jit table for DCB#      */

   8763  2 000261   000011 135007                    SBLA    9,DL
         2 000262   200006 755100                    STA     I,,AUTO

      220     8764    1        IF B$JIT.VIRTUAL.DCB#(I) ~= 0      /* Already used                       */

   8764  2 000263   000100 101505                    MRL     fill='000'O
         2 000264   000217 000001                    ADSC9   143,A,PR0                cn=0,n=1
         2 000265   200016 000004                    ADSC9   TERR+1,,AUTO             cn=0,n=4
         2 000266   200016 236100                    LDQ     TERR+1,,AUTO
         2 000267   000000 116003                    CMPQ    0,DU
         2 000270   000274 600000 2                  TZE     s:8776

      221     8765    2        THEN DO;

      222     8766    2             B$JIT.ERR = ERR_VSINUSE;

   8766  2 000271   000001 236000 1                  LDQ     ERR_VSINUSE
         2 000272   000012 756100                    STQ     10,,PR0

PL6.E3A0      #001=MMV$OPEN File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:25 Page:29   
      223     8767                  /*E* ERROR: -E$VSINUSE-SEV_ERROR#
      224     8768                       MESSAGE: The specified Virtual segment is already in use
      225     8769                       MESSAGE1: The access method specified a virtual segment
      226     8770                                 and that segment is in use by another DCB.
      227     8771                        */
      228     8772    2             ALTRETURN;

   8772  2 000273   000000 702200 xent               TSX2  ! X66_AALT

      229     8773    2           END;
      230     8774
      231     8775        /* Get a page table for this wsq */
      232     8776    2        IF MM$VCB.T.SECTION THEN DO;  /* Get the Section and the page tables */

   8776  2 000274   100000 236100                    LDQ     0,,PR1
         2 000275   010000 316003                    CANQ    4096,DU
         2 000276   000413 600000 2                  TZE     s:8788

      233     8777    2             PPNO = MM$VCB.NPGTSECT;

   8777  2 000277   100011 236100                    LDQ     9,,PR1
         2 000300   000022 736000                    QLS     18
         2 000301   000022 732000                    QRS     18
         2 000302   200012 756100                    STQ     PPNO,,AUTO

      234     8778    2             CALL MMB$GNPP(PPNO,%USERWSQ) ALTRET(NO_PT);

   8778  2 000303   000004 236000 3                  LDQ     4
         2 000304   200017 756100                    STQ     TERR+2,,AUTO
         2 000305   200012 633500                    EPPR3   PPNO,,AUTO
         2 000306   200016 453500                    STP3    TERR+1,,AUTO
         2 000307   200016 630500                    EPPR0   TERR+1,,AUTO
         2 000310   000020 631400 xsym               EPPR1   B_VECTNIL+16
         2 000311   000000 701000 xent               TSX1    MMB$GNPP
         2 000312   000706 702000 2                  TSX2    NO_PT

      235     8779    3             DO TEMP = 0 TO MM$VCB.NPGTSECT - 1;
PL6.E3A0      #001=MMV$OPEN File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:25 Page:30   

   8779  2 000313   200013 450100                    STZ     TEMP,,AUTO
         2 000314   000342 710000 2                  TRA     s:8781+1

      236     8780    3                 CALL MME$GVPNOPP (%USERWSQ,VPPGTBL+TEMP,PPNO+TEMP,ERR) ALTRET (REL_IT
              8780                           );

   8780  2 000315   200007 236100                    LDQ     VPPGTBL,,AUTO
         2 000316   200013 036100                    ADLQ    TEMP,,AUTO
         2 000317   200016 756100                    STQ     TERR+1,,AUTO
         2 000320   200012 236100                    LDQ     PPNO,,AUTO
         2 000321   200013 036100                    ADLQ    TEMP,,AUTO
         2 000322   200016 235100                    LDA     TERR+1,,AUTO
         2 000323   200017 755100                    STA     TERR+2,,AUTO
         2 000324   200020 756100                    STQ     TERR+3,,AUTO
         2 000325   200005 630500                    EPPR0   ERR,,AUTO
         2 000326   200025 450500                    STP0    TERR+8,,AUTO
         2 000327   200020 631500                    EPPR1   TERR+3,,AUTO
         2 000330   200024 451500                    STP1    TERR+7,,AUTO
         2 000331   200017 633500                    EPPR3   TERR+2,,AUTO
         2 000332   200023 453500                    STP3    TERR+6,,AUTO
         2 000333   000004 236000 3                  LDQ     4
         2 000334   200022 756100                    STQ     TERR+5,,AUTO
         2 000335   200022 630500                    EPPR0   TERR+5,,AUTO
         2 000336   000022 631400 xsym               EPPR1   B_VECTNIL+18
         2 000337   000000 701000 xent               TSX1    MME$GVPNOPP
         2 000340   000754 702000 2                  TSX2    REL_IT

      237     8781    3                END;

   8781  2 000341   200013 054100                    AOS     TEMP,,AUTO
         2 000342   200010 470500                    LDP0    VCB$,,AUTO
         2 000343   000011 236100                    LDQ     9,,PR0
         2 000344   000022 736000                    QLS     18
         2 000345   000022 732000                    QRS     18
         2 000346   200013 116100                    CMPQ    TEMP,,AUTO
         2 000347   000315 605400 2                  TPNZ    s:8780
PL6.E3A0      #001=MMV$OPEN File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:25 Page:31   

      238     8782    3             DO TEMP=0 TO MM$VCB.NPGTPGS-1;

   8782  2 000350   200013 450100                    STZ     TEMP,,AUTO
         2 000351   000406 710000 2                  TRA     s:8785+1

      239     8783    3                  CALL MMB$GPP(PPNO,%USERWSQ) ALTRET(REL_EM);

   8783  2 000352   000004 236000 3                  LDQ     4
         2 000353   200017 756100                    STQ     TERR+2,,AUTO
         2 000354   200012 630500                    EPPR0   PPNO,,AUTO
         2 000355   200016 450500                    STP0    TERR+1,,AUTO
         2 000356   200016 630500                    EPPR0   TERR+1,,AUTO
         2 000357   000020 631400 xsym               EPPR1   B_VECTNIL+16
         2 000360   000000 701000 xent               TSX1    MMB$GPP
         2 000361   000720 702000 2                  TSX2    REL_EM

      240     8784    3                  CALL MME$GVPNOPP(%USERWSQ,VPPGTBL+MM$VCB.NPGTSECT+TEMP,PPNO,ERR)
              8784                           ALTRET (REL_EM);

   8784  2 000362   200010 470500                    LDP0    VCB$,,AUTO
         2 000363   000011 236100                    LDQ     9,,PR0
         2 000364   000022 736000                    QLS     18
         2 000365   000022 732000                    QRS     18
         2 000366   200007 036100                    ADLQ    VPPGTBL,,AUTO
         2 000367   200013 036100                    ADLQ    TEMP,,AUTO
         2 000370   200016 756100                    STQ     TERR+1,,AUTO
         2 000371   200005 631500                    EPPR1   ERR,,AUTO
         2 000372   200023 451500                    STP1    TERR+6,,AUTO
         2 000373   200012 633500                    EPPR3   PPNO,,AUTO
         2 000374   200022 453500                    STP3    TERR+5,,AUTO
         2 000375   200016 634500                    EPPR4   TERR+1,,AUTO
         2 000376   200021 454500                    STP4    TERR+4,,AUTO
         2 000377   000004 236000 3                  LDQ     4
         2 000400   200020 756100                    STQ     TERR+3,,AUTO
         2 000401   200020 630500                    EPPR0   TERR+3,,AUTO
         2 000402   000022 631400 xsym               EPPR1   B_VECTNIL+18
PL6.E3A0      #001=MMV$OPEN File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:25 Page:32   
         2 000403   000000 701000 xent               TSX1    MME$GVPNOPP
         2 000404   000720 702000 2                  TSX2    REL_EM

      241     8785    3                END;

   8785  2 000405   200013 054100                    AOS     TEMP,,AUTO
         2 000406   200010 470500                    LDP0    VCB$,,AUTO
         2 000407   200013 236100                    LDQ     TEMP,,AUTO
         2 000410   000012 116100                    CMPQ    10,,PR0
         2 000411   000352 604000 2                  TMI     s:8783

      242     8786    2           END;

   8786  2 000412   000460 710000 2                  TRA     s:8795

      243     8787    2        ELSE DO;

      244     8788    2             PPNO = MM$VCB.NPGTPGS;

   8788  2 000413   100012 235100                    LDA     10,,PR1
         2 000414   200012 755100                    STA     PPNO,,AUTO

      245     8789    2             CALL MMB$GNPP(PPNO,%USERWSQ) ALTRET(NO_PT);

   8789  2 000415   000004 236000 3                  LDQ     4
         2 000416   200017 756100                    STQ     TERR+2,,AUTO
         2 000417   200012 633500                    EPPR3   PPNO,,AUTO
         2 000420   200016 453500                    STP3    TERR+1,,AUTO
         2 000421   200016 630500                    EPPR0   TERR+1,,AUTO
         2 000422   000020 631400 xsym               EPPR1   B_VECTNIL+16
         2 000423   000000 701000 xent               TSX1    MMB$GNPP
         2 000424   000706 702000 2                  TSX2    NO_PT

      246     8790    3             DO TEMP = 0 TO MM$VCB.NPGTPGS - 1;

   8790  2 000425   200013 450100                    STZ     TEMP,,AUTO
         2 000426   000454 710000 2                  TRA     s:8792+1
PL6.E3A0      #001=MMV$OPEN File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:25 Page:33   

      247     8791    3                  CALL MME$GVPNOPP (%USERWSQ,VPPGTBL+TEMP,PPNO+TEMP,ERR) ALTRET (
              8791                           REL_DENSE);

   8791  2 000427   200007 236100                    LDQ     VPPGTBL,,AUTO
         2 000430   200013 036100                    ADLQ    TEMP,,AUTO
         2 000431   200016 756100                    STQ     TERR+1,,AUTO
         2 000432   200012 236100                    LDQ     PPNO,,AUTO
         2 000433   200013 036100                    ADLQ    TEMP,,AUTO
         2 000434   200016 235100                    LDA     TERR+1,,AUTO
         2 000435   200017 755100                    STA     TERR+2,,AUTO
         2 000436   200020 756100                    STQ     TERR+3,,AUTO
         2 000437   200005 630500                    EPPR0   ERR,,AUTO
         2 000440   200025 450500                    STP0    TERR+8,,AUTO
         2 000441   200020 631500                    EPPR1   TERR+3,,AUTO
         2 000442   200024 451500                    STP1    TERR+7,,AUTO
         2 000443   200017 633500                    EPPR3   TERR+2,,AUTO
         2 000444   200023 453500                    STP3    TERR+6,,AUTO
         2 000445   000004 236000 3                  LDQ     4
         2 000446   200022 756100                    STQ     TERR+5,,AUTO
         2 000447   200022 630500                    EPPR0   TERR+5,,AUTO
         2 000450   000022 631400 xsym               EPPR1   B_VECTNIL+18
         2 000451   000000 701000 xent               TSX1    MME$GVPNOPP
         2 000452   001040 702000 2                  TSX2    REL_DENSE

      248     8792    3                END;

   8792  2 000453   200013 054100                    AOS     TEMP,,AUTO
         2 000454   200010 470500                    LDP0    VCB$,,AUTO
         2 000455   200013 236100                    LDQ     TEMP,,AUTO
         2 000456   000012 116100                    CMPQ    10,,PR0
         2 000457   000427 604000 2                  TMI     s:8791

      249     8793    2           END;

      250     8794        /* Set DCB# in jit for this virtual array */
      251     8795    1        B$JIT.VIRTUAL.DCB# (I) = B$JIT.DCBNO;
PL6.E3A0      #001=MMV$OPEN File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:25 Page:34   

   8795  2 000460   000000 471400 xsym               LDP1    B$JIT$
         2 000461   200006 235100                    LDA     I,,AUTO
         2 000462   000105 100500                    MLR     fill='000'O
         2 000463   100022 600001                    ADSC9   18,,PR1                  cn=3,n=1
         2 000464   100217 000001                    ADSC9   143,A,PR1                cn=0,n=1

      252     8796
      253     8797        /* Set pointer to segment in vlp */
      254     8798    1        VCB$->VLP$VIRTUAL.PTR$ = P$; /* P$ contains pointer to approiate segment */

   8798  2 000465   200004 236100                    LDQ     P$,,AUTO
         2 000466   000004 756100                    STQ     4,,PR0

      255     8799
      256     8800             %FINDMAP (P$ = P$,WSQ = EWSQ);

   8801  2 000467   200003 720100                    LXL0    EWSQ,,AUTO
         2 000470   000000 236010 xsym               LDQ     MM_PTPTRS$,X0
         2 000471   200004 756100                    STQ     P$,,AUTO

      257     8803
      258     8804        /* Set segment not null */
      259     8805    1        IF NOT HW_IMX THEN

   8805  2 000472   000000 234000 xsym               SZN     HW_IMX
         2 000473   000506 604000 2                  TMI     s:8810

      260     8806                  %SETNOTNULL (LS$ = B$USERLS$, SEGID = SEGID);

   8807  2 000474   200011 236100                    LDQ     SEGID,,AUTO
         2 000475   777700 376003                    ANQ     -64,DU
         2 000476   177700 376003                    ANQ     65472,DU
         2 000477   000030 772000                    QRL     24
         2 000500   000001 736000                    QLS     1
         2 000501   000000 473400 xsym               LDP3    B$USERLS$
         2 000502   000000 621006                    EAX1    0,QL
PL6.E3A0      #001=MMV$OPEN File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:25 Page:35   
         2 000503   000400 236007                    LDQ     256,DL
         2 000504   300000 256111                    ORSQ    0,X1,PR3
         2 000505   000520 710000 2                  TRA     s:8814

      261     8809    2        ELSE DO;

      262     8810    2             TEMP = BITBIN(SEGID & '1777'O);

   8810  2 000506   200011 236100                    LDQ     SEGID,,AUTO
         2 000507   777700 376003                    ANQ     -64,DU
         2 000510   177700 376003                    ANQ     65472,DU
         2 000511   000030 772000                    QRL     24
         2 000512   200013 756100                    STQ     TEMP,,AUTO

      263     8811    2             B$USERLS$->MM$SDESC.FLGS(TEMP) = '7'O;

   8811  2 000513   200013 235100                    LDA     TEMP,,AUTO
         2 000514   000001 735000                    ALS     1
         2 000515   000000 473400 xsym               LDP3    B$USERLS$
         2 000516   160000 236007                    LDQ     57344,DL
         2 000517   300000 256105                    ORSQ    0,AL,PR3

      264     8812    2           END;

      265     8813
      266     8814    2        IF MM$VCB.T.SECTION THEN DO;

   8814  2 000520   000000 236100                    LDQ     0,,PR0
         2 000521   010000 316003                    CANQ    4096,DU
         2 000522   000575 600000 2                  TZE     s:8828

      267     8815    3             DO I=0 TO MM$VCB.NPGTSECT*1024-1;

   8815  2 000523   200006 450100                    STZ     I,,AUTO
         2 000524   000537 710000 2                  TRA     s:8820+1

      268     8816    3                  P$->B$SECT(I) = '0'B;
PL6.E3A0      #001=MMV$OPEN File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:25 Page:36   

   8816  2 000525   200004 470500                    LDP0    P$,,AUTO
         2 000526   200006 720100                    LXL0    I,,AUTO
         2 000527   000000 450110                    STZ     0,X0,PR0

      269     8817    3                  P$->B$SECT.PRES(I)= %TRUE;

   8817  2 000530   100000 236007                    LDQ     32768,DL
         2 000531   000000 256110                    ORSQ    0,X0,PR0

      270     8818    3                  P$->B$SECT.PTBOUND(I)= 15   ;

   8818  2 000532   000017 236007                    LDQ     15,DL
         2 000533   000000 256110                    ORSQ    0,X0,PR0

      271     8819    3                  P$->B$SECT.PTBASE(I) = MM_SCTDFT;

   8819  2 000534   000000 721000 xsym               LXL1    MM_SCTDFT
         2 000535   000000 741110                    STX1    0,X0,PR0

      272     8820    3                END;

   8820  2 000536   200006 054100                    AOS     I,,AUTO
         2 000537   200010 470500                    LDP0    VCB$,,AUTO
         2 000540   000011 236100                    LDQ     9,,PR0
         2 000541   000022 736000                    QLS     18
         2 000542   000010 732000                    QRS     8
         2 000543   200006 116100                    CMPQ    I,,AUTO
         2 000544   000525 605400 2                  TPNZ    s:8816

      273     8821    3             DO I=0 TO MM$VCB.NPGTPGS-1;

   8821  2 000545   200006 450100                    STZ     I,,AUTO
         2 000546   000571 710000 2                  TRA     s:8825+1

      274     8822    4                  DO TEMP =0 TO 1023;

PL6.E3A0      #001=MMV$OPEN File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:25 Page:37   
   8822  2 000547   200013 450100                    STZ     TEMP,,AUTO

      275     8823    4                       PINCRW(P$,(I+MM$VCB.NPGTSECT) *1024 )->B$MAP(TEMP)=MM_FPMC;

   8823  2 000550   200010 470500                    LDP0    VCB$,,AUTO
         2 000551   000011 236100                    LDQ     9,,PR0
         2 000552   000022 736000                    QLS     18
         2 000553   000022 732000                    QRS     18
         2 000554   200006 036100                    ADLQ    I,,AUTO
         2 000555   000012 736000                    QLS     10
         2 000556   200013 036100                    ADLQ    TEMP,,AUTO
         2 000557   200016 756100                    STQ     TERR+1,,AUTO
         2 000560   000000 236000 xsym               LDQ     MM_FPMC
         2 000561   200004 471500                    LDP1    P$,,AUTO
         2 000562   200016 720100                    LXL0    TERR+1,,AUTO
         2 000563   100000 756110                    STQ     0,X0,PR1

      276     8824    4                     END;

   8824  2 000564   200013 054100                    AOS     TEMP,,AUTO
         2 000565   200013 235100                    LDA     TEMP,,AUTO
         2 000566   001777 115007                    CMPA    1023,DL
         2 000567   000550 604400 2                  TMOZ    s:8823

      277     8825    3                END;

   8825  2 000570   200006 054100                    AOS     I,,AUTO
         2 000571   200006 236100                    LDQ     I,,AUTO
         2 000572   000012 116100                    CMPQ    10,,PR0
         2 000573   000547 604000 2                  TMI     s:8822

      278     8826    2           END;

   8826  2 000574   000623 710000 2                  TRA     s:8838

      279     8827    2        ELSE DO;

PL6.E3A0      #001=MMV$OPEN File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:25 Page:38   
      280     8828    2             TEMP = MM$VCB.NPGTPGS * 1024 - 1;

   8828  2 000575   000012 235100                    LDA     10,,PR0
         2 000576   000012 735000                    ALS     10
         2 000577   000001 135007                    SBLA    1,DL
         2 000600   200013 755100                    STA     TEMP,,AUTO

      281     8829    3             DO I = 0 TO TEMP;             /* Clear out page table               */

   8829  2 000601   200006 450100                    STZ     I,,AUTO
         2 000602   000620 710000 2                  TRA     s:8834+1

      282     8830    3                  P$ -> B$MAP (I) = '0'B;

   8830  2 000603   200004 470500                    LDP0    P$,,AUTO
         2 000604   200006 720100                    LXL0    I,,AUTO
         2 000605   000000 450110                    STZ     0,X0,PR0

      283     8831    3                  IF NOT MM$VCB.T.FRAGMENTED OR I >= 128

   8831  2 000606   200010 471500                    LDP1    VCB$,,AUTO
         2 000607   100000 236100                    LDQ     0,,PR1
         2 000610   020000 316003                    CANQ    8192,DU
         2 000611   000615 600000 2                  TZE     s:8833
         2 000612   200006 235100                    LDA     I,,AUTO
         2 000613   000200 115007                    CMPA    128,DL
         2 000614   000617 604000 2                  TMI     s:8834

      284     8832    3                  THEN
      285     8833    3                       P$ -> B$MAP(I) = MM_FPMC;

   8833  2 000615   000000 236000 xsym               LDQ     MM_FPMC
         2 000616   000000 756110                    STQ     0,X0,PR0

      286     8834    3                END;

   8834  2 000617   200006 054100                    AOS     I,,AUTO
PL6.E3A0      #001=MMV$OPEN File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:25 Page:39   
         2 000620   200006 236100                    LDQ     I,,AUTO
         2 000621   200013 116100                    CMPQ    TEMP,,AUTO
         2 000622   000603 604400 2                  TMOZ    s:8830

      287     8835    2           END;

      288     8836
      289     8837        /* Must set up wsptd for the virtual area */
      290     8838    1        TEMP = B$UPT$ -> B$MAP.RPN (VPPGTBL);

   8838  2 000623   000000 470400 xsym               LDP0    B$UPT$
         2 000624   200007 720100                    LXL0    VPPGTBL,,AUTO
         2 000625   000000 236110                    LDQ     0,X0,PR0
         2 000626   000022 772000                    QRL     18
         2 000627   200013 756100                    STQ     TEMP,,AUTO

      291     8839    1        TEMP = TEMP * (1024 / HW_PTB_UNITS);

   8839  2 000630   002000 236007                    LDQ     1024,DL
         2 000631   000000 506000 xsym               DIV     HW_PTB_UNITS
         2 000632   200013 402100                    MPY     TEMP,,AUTO
         2 000633   200013 756100                    STQ     TEMP,,AUTO

      292     8840    1        S_WSPTD.BLKNO(EWSQ)=TEMP;

   8840  2 000634   000000 621006                    EAX1    0,QL
         2 000635   200003 722100                    LXL2    EWSQ,,AUTO
         2 000636   000000 741012 xsym               STX1    S_WSPTD,X2

      293     8841    1        IF MM$VCB.T.SECTION THEN S_WSPTD.NBLKS(EWSQ) = MM$VCB.NPGTSECT * 16;

   8841  2 000637   200010 471500                    LDP1    VCB$,,AUTO
         2 000640   100000 236100                    LDQ     0,,PR1
         2 000641   010000 316003                    CANQ    4096,DU
         2 000642   000652 600000 2                  TZE     s:8842

   8841  2 000643   100011 236100                    LDQ     9,,PR1
PL6.E3A0      #001=MMV$OPEN File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:25 Page:40   
         2 000644   000022 736000                    QLS     18
         2 000645   000016 732000                    QRS     14
         2 000646   000000 676012 xsym               ERQ     S_WSPTD,X2
         2 000647   007777 376007                    ANQ     4095,DL
         2 000650   000000 656012 xsym               ERSQ    S_WSPTD,X2
         2 000651   000657 710000 2                  TRA     s:8843

      294     8842    1        ELSE S_WSPTD.NBLKS(EWSQ) = MM$VCB.NPGTPGS * 16;

   8842  2 000652   100012 236100                    LDQ     10,,PR1
         2 000653   000004 736000                    QLS     4
         2 000654   000000 676012 xsym               ERQ     S_WSPTD,X2
         2 000655   007777 376007                    ANQ     4095,DL
         2 000656   000000 656012 xsym               ERSQ    S_WSPTD,X2

      295     8843    1        S_WSPTD.P(EWSQ) = %TRUE;           /* Page table present                 */

   8843  2 000657   100000 236007                    LDQ     32768,DL
         2 000660   000000 256012 xsym               ORSQ    S_WSPTD,X2

      296     8844    1        S_WSPTD.T(EWSQ) = MM$VCB.T;

   8844  2 000661   100000 236100                    LDQ     0,,PR1
         2 000662   000021 772000                    QRL     17
         2 000663   000000 676012 xsym               ERQ     S_WSPTD,X2
         2 000664   060000 376007                    ANQ     24576,DL
         2 000665   000000 656012 xsym               ERSQ    S_WSPTD,X2

      297     8845    1        IF NOT HW_IMX THEN

   8845  2 000666   000000 234000 xsym               SZN     HW_IMX
         2 000667   000701 604000 2                  TMI     s:8848

      298     8846    1             S_WSPTD.Q(EWSQ) = BINBIT(MOD(EWSQ,4),2);

   8846  2 000670   200003 236100                    LDQ     EWSQ,,AUTO
         2 000671   000004 506007                    DIV     4,DL
PL6.E3A0      #001=MMV$OPEN File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:25 Page:41   
         2 000672   000044 733000                    LRS     36
         2 000673   000042 736000                    QLS     34
         2 000674   000022 772000                    QRL     18
         2 000675   000000 676012 xsym               ERQ     S_WSPTD,X2
         2 000676   600000 376007                    ANQ     -65536,DL
         2 000677   000000 656012 xsym               ERSQ    S_WSPTD,X2
         2 000700   000703 710000 2                  TRA     s:8851

      299     8847    1        ELSE
      300     8848    1             S_WSPTD.Q(EWSQ) = '0'O;

   8848  2 000701   000005 236000 3                  LDQ     5
         2 000702   000000 356012 xsym               ANSQ    S_WSPTD,X2

      301     8849
      302     8850        /* Save it in MM$VCB for use at time of schedule */
      303     8851    1        MM$VCB.WSPTD = S_WSPTD(EWSQ);

   8851  2 000703   000000 236012 xsym               LDQ     S_WSPTD,X2
         2 000704   100005 756100                    STQ     5,,PR1

      304     8852    1        RETURN;                            /* All done                           */

   8852  2 000705   000000 702200 xent               TSX2  ! X66_ARET

      305     8853
      306     8854
      307     8855    1   NO_PT:
      308     8856    2        IF HW_FRAG_PT THEN DO;

   8856  2 000706   000000 234000 xsym  NO_PT        SZN     HW_FRAG_PT
         2 000707   000714 605000 2                  TPL     s:8860

      309     8857    2             MM$VCB.T.SECTION = %FALSE;

   8857  2 000710   200010 470500                    LDP0    VCB$,,AUTO
         2 000711   000003 236000 3                  LDQ     3
PL6.E3A0      #001=MMV$OPEN File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:25 Page:42   
         2 000712   000000 356100                    ANSQ    0,,PR0

      310     8858    2             GOTO GOFRAG;

   8858  2 000713   000150 710000 2                  TRA     GOFRAG

      311     8859    2           END;
      312     8860    1        B$JIT.ERR = BRKCTY;

   8860  2 000714   000004 236000 1                  LDQ     BRKCTY
         2 000715   000000 470400 xsym               LDP0    B$JIT$
         2 000716   000012 756100                    STQ     10,,PR0

      313     8861    1        ALTRETURN;

   8861  2 000717   000000 702200 xent               TSX2  ! X66_AALT

      314     8862
      315     8863    1   REL_EM: /* Release both PTS(here), and SCTs(at REL_IT); */
      316     8864    2        DO I = 0 TO TEMP-1;

   8864  2 000720   200006 450100       REL_EM       STZ     I,,AUTO
         2 000721   000744 710000 2                  TRA     s:8866+1

      317     8865    2             CALL MME$WFVP (%USERWSQ, VPPGTBL+MM$VCB.NPGTPGS+I,, TERR);

   8865  2 000722   200010 470500                    LDP0    VCB$,,AUTO
         2 000723   200007 236100                    LDQ     VPPGTBL,,AUTO
         2 000724   000012 036100                    ADLQ    10,,PR0
         2 000725   200006 036100                    ADLQ    I,,AUTO
         2 000726   200016 756100                    STQ     TERR+1,,AUTO
         2 000727   200015 631500                    EPPR1   TERR,,AUTO
         2 000730   200023 451500                    STP1    TERR+6,,AUTO
         2 000731   000001 236000 xsym               LDQ     B_VECTNIL+1
         2 000732   200022 756100                    STQ     TERR+5,,AUTO
         2 000733   200016 633500                    EPPR3   TERR+1,,AUTO
         2 000734   200021 453500                    STP3    TERR+4,,AUTO
PL6.E3A0      #001=MMV$OPEN File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:25 Page:43   
         2 000735   000004 236000 3                  LDQ     4
         2 000736   200020 756100                    STQ     TERR+3,,AUTO
         2 000737   200020 630500                    EPPR0   TERR+3,,AUTO
         2 000740   000022 631400 xsym               EPPR1   B_VECTNIL+18
         2 000741   000000 701000 xent               TSX1    MME$WFVP
         2 000742   000000 011000                    NOP     0

      318     8866    2           END;

   8866  2 000743   200006 054100                    AOS     I,,AUTO
         2 000744   200006 236100                    LDQ     I,,AUTO
         2 000745   200013 116100                    CMPQ    TEMP,,AUTO
         2 000746   000722 604000 2                  TMI     s:8865

      319     8867    1        TEMP = MM$VCB.NPGTSECT;

   8867  2 000747   200010 470500                    LDP0    VCB$,,AUTO
         2 000750   000011 236100                    LDQ     9,,PR0
         2 000751   000022 736000                    QLS     18
         2 000752   000022 732000                    QRS     18
         2 000753   200013 756100                    STQ     TEMP,,AUTO

      320     8868    1   REL_IT: /* Release the SCT or the PT.  TEMP holds how far we got */
      321     8869    2        DO I = 0 TO TEMP-1;

   8869  2 000754   200006 450100       REL_IT       STZ     I,,AUTO
         2 000755   001004 710000 2                  TRA     s:8872+1

      322     8870    2             CALL MME$RVNP (%USERWSQ, VPPGTBL+I, PPNO, TERR);

   8870  2 000756   200007 236100                    LDQ     VPPGTBL,,AUTO
         2 000757   200006 036100                    ADLQ    I,,AUTO
         2 000760   200016 756100                    STQ     TERR+1,,AUTO
         2 000761   200015 630500                    EPPR0   TERR,,AUTO
         2 000762   200023 450500                    STP0    TERR+6,,AUTO
         2 000763   200012 631500                    EPPR1   PPNO,,AUTO
         2 000764   200022 451500                    STP1    TERR+5,,AUTO
PL6.E3A0      #001=MMV$OPEN File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:25 Page:44   
         2 000765   200016 633500                    EPPR3   TERR+1,,AUTO
         2 000766   200021 453500                    STP3    TERR+4,,AUTO
         2 000767   000004 236000 3                  LDQ     4
         2 000770   200020 756100                    STQ     TERR+3,,AUTO
         2 000771   200020 630500                    EPPR0   TERR+3,,AUTO
         2 000772   000022 631400 xsym               EPPR1   B_VECTNIL+18
         2 000773   000000 701000 xent               TSX1    MME$RVNP
         2 000774   000000 011000                    NOP     0

      323     8871    2             CALL MMB$FPPONTAIL (PPNO);

   8871  2 000775   200012 630500                    EPPR0   PPNO,,AUTO
         2 000776   200016 450500                    STP0    TERR+1,,AUTO
         2 000777   200016 630500                    EPPR0   TERR+1,,AUTO
         2 001000   000017 631400 xsym               EPPR1   B_VECTNIL+15
         2 001001   000000 701000 xent               TSX1    MMB$FPPONTAIL
         2 001002   000000 011000                    NOP     0

      324     8872    2           END;

   8872  2 001003   200006 054100                    AOS     I,,AUTO
         2 001004   200006 236100                    LDQ     I,,AUTO
         2 001005   200013 116100                    CMPQ    TEMP,,AUTO
         2 001006   000756 604000 2                  TMI     s:8870

      325     8873    2        DO I = TEMP TO MM$VCB.NPGTSECT - 1;

   8873  2 001007   200013 235100                    LDA     TEMP,,AUTO
         2 001010   200006 755100                    STA     I,,AUTO
         2 001011   001024 710000 2                  TRA     s:8875+1

      326     8874    2             CALL MMB$FPPONTAIL(PPNO+I);

   8874  2 001012   200012 236100                    LDQ     PPNO,,AUTO
         2 001013   200006 036100                    ADLQ    I,,AUTO
         2 001014   200016 756100                    STQ     TERR+1,,AUTO
         2 001015   200016 630500                    EPPR0   TERR+1,,AUTO
PL6.E3A0      #001=MMV$OPEN File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:25 Page:45   
         2 001016   200017 450500                    STP0    TERR+2,,AUTO
         2 001017   200017 630500                    EPPR0   TERR+2,,AUTO
         2 001020   000017 631400 xsym               EPPR1   B_VECTNIL+15
         2 001021   000000 701000 xent               TSX1    MMB$FPPONTAIL
         2 001022   000000 011000                    NOP     0

      327     8875    2           END;

   8875  2 001023   200006 054100                    AOS     I,,AUTO
         2 001024   200010 470500                    LDP0    VCB$,,AUTO
         2 001025   000011 236100                    LDQ     9,,PR0
         2 001026   000022 736000                    QLS     18
         2 001027   000022 732000                    QRS     18
         2 001030   200006 116100                    CMPQ    I,,AUTO
         2 001031   001012 605400 2                  TPNZ    s:8874

      328     8876             %ERRSETN(CODE=ERR);

   8877  2 001032   200005 236100                    LDQ     ERR,,AUTO
         2 001033   000003 736000                    QLS     3
         2 001034   000000 276000 1                  ORQ     MMERR
         2 001035   000000 471400 xsym               LDP1    B$JIT$
         2 001036   100012 756100                    STQ     10,,PR1

      329     8879    1        ALTRETURN;

   8879  2 001037   000000 702200 xent               TSX2  ! X66_AALT

      330     8880
      331     8881    1   REL_DENSE:
      332     8882    1        SAVE_PPNO = PPNO;

   8882  2 001040   200012 235100       REL_DENSE    LDA     PPNO,,AUTO
         2 001041   200014 755100                    STA     SAVE_PPNO,,AUTO

      333     8883    2        DO I = 0 TO TEMP -1;

PL6.E3A0      #001=MMV$OPEN File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:25 Page:46   
   8883  2 001042   200006 450100                    STZ     I,,AUTO
         2 001043   001072 710000 2                  TRA     s:8886+1

      334     8884    2             CALL MME$RVNP(%USERWSQ,VPPGTBL+I,PPNO,TEMP);

   8884  2 001044   200007 236100                    LDQ     VPPGTBL,,AUTO
         2 001045   200006 036100                    ADLQ    I,,AUTO
         2 001046   200016 756100                    STQ     TERR+1,,AUTO
         2 001047   200013 630500                    EPPR0   TEMP,,AUTO
         2 001050   200023 450500                    STP0    TERR+6,,AUTO
         2 001051   200012 631500                    EPPR1   PPNO,,AUTO
         2 001052   200022 451500                    STP1    TERR+5,,AUTO
         2 001053   200016 633500                    EPPR3   TERR+1,,AUTO
         2 001054   200021 453500                    STP3    TERR+4,,AUTO
         2 001055   000004 236000 3                  LDQ     4
         2 001056   200020 756100                    STQ     TERR+3,,AUTO
         2 001057   200020 630500                    EPPR0   TERR+3,,AUTO
         2 001060   000022 631400 xsym               EPPR1   B_VECTNIL+18
         2 001061   000000 701000 xent               TSX1    MME$RVNP
         2 001062   000000 011000                    NOP     0

      335     8885    2             CALL MMB$FPPONTAIL(PPNO);

   8885  2 001063   200012 630500                    EPPR0   PPNO,,AUTO
         2 001064   200016 450500                    STP0    TERR+1,,AUTO
         2 001065   200016 630500                    EPPR0   TERR+1,,AUTO
         2 001066   000017 631400 xsym               EPPR1   B_VECTNIL+15
         2 001067   000000 701000 xent               TSX1    MMB$FPPONTAIL
         2 001070   000000 011000                    NOP     0

      336     8886    2           END;

   8886  2 001071   200006 054100                    AOS     I,,AUTO
         2 001072   200006 236100                    LDQ     I,,AUTO
         2 001073   200013 116100                    CMPQ    TEMP,,AUTO
         2 001074   001044 604000 2                  TMI     s:8884

PL6.E3A0      #001=MMV$OPEN File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:25 Page:47   
      337     8887    2        DO I = TEMP TO MM$VCB.NPGTPGS - 1;

   8887  2 001075   200013 235100                    LDA     TEMP,,AUTO
         2 001076   200006 755100                    STA     I,,AUTO
         2 001077   001112 710000 2                  TRA     s:8889+1

      338     8888    2             CALL MMB$FPPONTAIL(SAVE_PPNO+I);

   8888  2 001100   200014 236100                    LDQ     SAVE_PPNO,,AUTO
         2 001101   200006 036100                    ADLQ    I,,AUTO
         2 001102   200016 756100                    STQ     TERR+1,,AUTO
         2 001103   200016 630500                    EPPR0   TERR+1,,AUTO
         2 001104   200017 450500                    STP0    TERR+2,,AUTO
         2 001105   200017 630500                    EPPR0   TERR+2,,AUTO
         2 001106   000017 631400 xsym               EPPR1   B_VECTNIL+15
         2 001107   000000 701000 xent               TSX1    MMB$FPPONTAIL
         2 001110   000000 011000                    NOP     0

      339     8889    2           END;

   8889  2 001111   200006 054100                    AOS     I,,AUTO
         2 001112   200010 470500                    LDP0    VCB$,,AUTO
         2 001113   200006 236100                    LDQ     I,,AUTO
         2 001114   000012 116100                    CMPQ    10,,PR0
         2 001115   001100 604000 2                  TMI     s:8888

      340     8890             %ERRSETN(CODE=ERR);

   8891  2 001116   200005 236100                    LDQ     ERR,,AUTO
         2 001117   000003 736000                    QLS     3
         2 001120   000000 276000 1                  ORQ     MMERR
         2 001121   000000 471400 xsym               LDP1    B$JIT$
         2 001122   100012 756100                    STQ     10,,PR1

      341     8893    1        ALTRETURN;

   8893  2 001123   000000 702200 xent               TSX2  ! X66_AALT
PL6.E3A0      #001=MMV$OPEN File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:25 Page:48   

MMERR
 Sect OctLoc
   1     000   151526 400000                                                    i...

ERR_VSINUSE
 Sect OctLoc
   1     001   151526 412104                                                    i..D

ERR_VSTOBIG
 Sect OctLoc
   1     002   151526 412114                                                    i..L

ILGLSEG
 Sect OctLoc
   1     003   151526 423214                                                    i...

BRKCTY
 Sect OctLoc
   1     004   151526 412074                                                    i..<

NOVLPVIRT
 Sect OctLoc
   1     005   151526 423204                                                    i...

(unnamed)
 Sect OctLoc
   3     000   677777 777777   737777 777777   757777 777777   767777 777777    ................
   3     004   000012 006000   777777 177777                                    ........
      342     8894    1   END MMV$OPEN;
      343     8895        %EOD;

PL6.E3A0      #001=MMV$OPEN File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:25 Page:49   
--  Include file information  --

   HF_LOCK_C.:E05TOU  cannot be made into a system file and is referenced.
   UD_SEV_C.:E05TOU  is referenced.
   S_WSPTD_R.:E05TOU  cannot be made into a system file and is referenced.
   M_ERRSET_C.:E05TOU  is referenced.
   M_ERRORS_C.:E05TOU  is referenced.
   HF_DATA_R.:E05TOU  cannot be made into a system file and is referenced.
   MM_MACRO_M.:E05TOU  is referenced.
   B_STRINGS_C.:E05TOU  is referenced.
   MM$SYSGEN.:E05TOU  is referenced.
   M_INFO_C.:E05TOU  is referenced.
   MM_DATA_R.:E05TOU  cannot be made into a system file and is referenced.
   F$DCB.:E05TOU  cannot be made into a system file and is referenced.
   F$CP6V_C.:E05TOU  is referenced.
   CP_6_SUBS.:E05TOU  is referenced.
   CP_6_C.:E05TOU  is referenced.
   CP_6.:E05TOU  cannot be made into a system file and is referenced.
   B_SEGIDS_C.:E05TOU  is referenced.
   B$MAP.:E05TOU  cannot be made into a system file and is referenced.
   B$JIT_C.:E05TOU  is referenced.
   B$JIT.:E05TOU  cannot be made into a system file and is referenced.
      No diagnostics issued in procedure MMV$OPEN.
PL6.E3A0      #001=MMV$OPEN File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:25 Page:50   

 **** Variables and constants ****

  ****  Section 001 RoData MMV$OPEN

  ****  Scalars and arrays  ****
OctLoc.c.b A Datatyp(siz) R M Lvl/name                 OctLoc.c.b A Datatyp(siz) R M Lvl/name

     4-0-0/w STRC        r     1 BRKCTY                     1-0-0/w STRC        r     1 ERR_VSINUSE
     2-0-0/w STRC        r     1 ERR_VSTOBIG                3-0-0/w STRC        r     1 ILGLSEG
     0-0-0/b STRC        r     1 MMERR                      5-0-0/w STRC        r     1 NOVLPVIRT

  ****  Auto variables  ****

  ****  Scalars and arrays  ****
OctLoc.c.b A Datatyp(siz) R M Lvl/name                 OctLoc.c.b A Datatyp(siz) R M Lvl/name

     5-0-0/w UBIN        r     1 ERR                        3-0-0/w SBIN        r     1 EWSQ
     6-0-0/w SBIN        r     1 I                          4-0-0/w PTR         r     1 P$
    12-0-0/w UBIN        r     1 PPNO                      14-0-0/w UBIN        r     1 SAVE_PPNO
    11-0-0/b BIT (12)    r     1 SEGID                     13-0-0/w SBIN        r     1 TEMP
    15-0-0/w UBIN        r     1 TERR                      10-0-0/w PTR         r     1 VCB$
     7-0-0/w UBIN        r     1 VPPGTBL

  ****  SYMREF variables  ****

  ****  Scalars and arrays  ****
OctLoc.c.b A Datatyp(siz) R M Lvl/name                 OctLoc.c.b A Datatyp(siz) R M Lvl/name

     0-0-0/w PTR         r     1 B$JIT$                     0-0-0/w PTR         r     1 B$UPT$
     0-0-0/w PTR         r     1 B$USERLS$                  0-0-0/w PTR         r     1 B$VS1$
     0-0-0/w PTR         r     1 B$VS2$                     0-0-0/w PTR         r     1 B$VS3$
     0-0-0/w BIT         r     1 HW_FRAG_PT                 0-0-0/w BIT         r     1 HW_IMX
     0-0-0/w SBIN        r     1 HW_PTB_UNITS               0-0-0/w BIT         r     1 HW_SECT_PT
     0-0-0/w PTR         r     1 MM_BYP$                    0-0-0/b STRC        r     1 MM_FPMC
     0-0-0/w PTR         r     1 MM_PTPTRS$(0:16)
     0-0-0/w UBIN        r     1 MM_SCTDFT                  0-0-0/w STRC        r     1 S_WSPTD(0:28)

PL6.E3A0      #001=MMV$OPEN File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:25 Page:51   
  ****  BASED and DCB variables  ****

  ****  Scalars and arrays  ****
OctLoc.c.b A Datatyp(siz) R M Lvl/name                 OctLoc.c.b A Datatyp(siz) R M Lvl/name

     0-0-0/d STRC(8856)  r     1 B$JIT                      0-0-0/w STRC        r     1 B$MAP(0:1023)
     0-0-0/w STRC        r     1 B$SECT(0:1023)             0-0-0/d ASTR(3528)  r     1 F$DCB
     0-0-0/d STRC(72)    r     1 MM$DESC(0:0)
     0-0-0/d STRC(72)    r     1 MM$SDESC(0:0)
     0-0-0/w STRC(432)   r     1 MM$VCB                     0-0-0/w STRC(288)   r     1 MM$VIRTUAL_STATS
     0-0-0/w STRC(432)   r     1 VLP$VIRTUAL


   Procedure MMV$OPEN requires 596 words for executable code.
   Procedure MMV$OPEN requires 22 words of local(AUTO) storage.
PL6.E3A0      #001=MMV$OPEN File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:25 Page:52   
          *** CROSS REFERENCE LISTING ***
**     DENOTES     IDENTIFIER DEFINITION
<<                 IDENTIFIER'S VALUE SET
>>                 IDENTIFIER'S VALUE USED
<>                 IDENTIFIER SET AND/OR USED
--                 IDENTIFIER REFERENCED
PL6.E3A0      #001=MMV$OPEN File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:25 Page:53   
          MINI XREF LISTING

B$JIT.CPFLAGS1.SLEAZE
       442**DCL       442--REDEF
B$JIT.DCB$
       516**DCL      8644>>ASSIGN   8646>>ASSIGN   8661>>ASSIGN   8724>>IF       8727>>IF
B$JIT.DCBNO
       429**DCL      8646<<ASSIGN   8795>>ASSIGN
B$JIT.ERR
       348**DCL      8650<<ASSIGN   8667<<ASSIGN   8716<<ASSIGN   8753<<ASSIGN   8766<<ASSIGN   8860<<ASSIGN
      8877<<ASSIGN   8891<<ASSIGN
B$JIT.ERR.MID
       349**DCL       349--REDEF
B$JIT.JRESPEAK
       510**DCL       511--REDEF
B$JIT.JUNK
       548**DCL      8659>>IF       8727>>IF
B$JIT.ORIGINATOR_PORT.FROM_CR
       619**DCL       619--REDEF     620--REDEF
B$JIT.PNR
       523**DCL       523--REDEF
B$JIT.TSLINE
       617**DCL       618--REDEF
B$JIT.VIRTUAL.DCB#
       513**DCL      8764>>IF       8795<<ASSIGN
B$JIT$
      8333**DCL       343--IMP-PTR  8644>>ASSIGN   8646>>ASSIGN   8646>>ASSIGN   8650>>ASSIGN   8659>>IF
      8661>>ASSIGN   8667>>ASSIGN   8716>>ASSIGN   8724>>IF       8727>>IF       8727>>IF       8753>>ASSIGN
      8764>>IF       8766>>ASSIGN   8795>>ASSIGN   8795>>ASSIGN   8860>>ASSIGN   8877>>ASSIGN   8891>>ASSIGN
B$MAP
       665**DCL      8823<<ASSIGN   8830<<ASSIGN   8833<<ASSIGN
B$MAP.RPN
       666**DCL      8838>>ASSIGN
B$MAP.SCTRL
PL6.E3A0      #001=MMV$OPEN File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:25 Page:54   
       667**DCL       668--REDEF
B$SECT
       706**DCL      8816<<ASSIGN
B$SECT.PRES
       709**DCL      8817<<ASSIGN
B$SECT.PTBASE
       707**DCL      8819<<ASSIGN
B$SECT.PTBOUND
       711**DCL      8818<<ASSIGN
B$UPT$
      8338**DCL      8838>>ASSIGN
B$USERLS$
      8337**DCL      8807>>ASSIGN   8811>>ASSIGN
B$VS1$
      8339**DCL      8738>>ASSIGN
B$VS2$
      8340**DCL      8744>>ASSIGN
B$VS3$
      8341**DCL      8750>>ASSIGN
BRKCTY
      8532**DCL      8860>>ASSIGN
ERR
      8631**DCL      8780<>CALL     8784<>CALL     8791<>CALL     8877>>ASSIGN   8891>>ASSIGN
ERR_VSINUSE
      8391**DCL      8766>>ASSIGN
ERR_VSTOBIG
      8442**DCL      8667>>ASSIGN   8716>>ASSIGN
EWSQ
      8629**DCL      8735<<ASSIGN   8741<<ASSIGN   8747<<ASSIGN   8762>>ASSIGN   8763>>ASSIGN   8801>>ASSIGN
      8840>>ASSIGN   8841>>ASSIGN   8842>>ASSIGN   8843>>ASSIGN   8844>>ASSIGN   8846>>ASSIGN   8846>>ASSIGN
      8848>>ASSIGN   8851>>ASSIGN
F$DCB.ACTPOS
      7613**DCL      7613--REDEF
F$DCB.ARS
      7588**DCL      7588--REDEF
F$DCB.ATTR
PL6.E3A0      #001=MMV$OPEN File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:25 Page:55   
      7606**DCL      7607--REDEF
F$DCB.BORROW
      7621**DCL      7621--REDEF    7621--REDEF    7621--REDEF
F$DCB.DCB#
      7615**DCL      8646>>ASSIGN
F$DCB.DCBNAME.L
      7635**DCL      7635--IMP-SIZ
F$DCB.EOMCHAR
      7592**DCL      7592--REDEF
F$DCB.FFLG.UPD
      7593**DCL      8724>>IF
F$DCB.FLDID
      7616**DCL      7616--REDEF
F$DCB.FORM$
      7610**DCL      7610--REDEF
F$DCB.FSECT
      7626**DCL      7626--REDEF
F$DCB.FSN
      7603**DCL      7603--REDEF    7603--REDEF    7604--REDEF
F$DCB.FUN
      7602**DCL      8727>>IF
F$DCB.HEADER$
      7609**DCL      7609--REDEF
F$DCB.IXTNSIZE
      7607**DCL      7607--REDEF
F$DCB.LASTSTA$
      7597**DCL      7597--REDEF    8661>>ASSIGN
F$DCB.LVL
      7622**DCL      7622--REDEF
F$DCB.NAME.C
      7597**DCL      7597--REDEF
F$DCB.NOEOF
      7618**DCL      7618--REDEF
F$DCB.NRECS
      7608**DCL      7608--REDEF
F$DCB.NRECX
PL6.E3A0      #001=MMV$OPEN File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:25 Page:56   
      7627**DCL      7627--REDEF
F$DCB.OHDR
      7619**DCL      7619--REDEF
F$DCB.ORG
      7602**DCL      7602--REDEF
F$DCB.PRECNO
      7625**DCL      7625--REDEF
F$DCB.RCSZ
      7630**DCL      7630--REDEF
F$DCB.RES
      7598**DCL      7598--REDEF
F$DCB.SETSTA$
      7597**DCL      8644>>ASSIGN
F$DCB.SETX
      7610**DCL      7610--REDEF
F$DCB.TAB$
      7609**DCL      7610--REDEF
F$DCB.TDA
      7624**DCL      7624--REDEF
F$DCB.WSN
      7599**DCL      7599--REDEF
FPT$OPEN_V.FSN
      8357**DCL      8357--REDEF    8358--REDEF
GOFRAG
      8711**LABEL    8858--GOTO
HW_FRAG_PT
      8195**DCL      8709>>IF       8856>>IF
HW_IMX
      8198**DCL      8805>>IF       8845>>IF
HW_PTB_UNITS
      8193**DCL      8839>>ASSIGN
HW_SECT_PT
      8194**DCL      8696>>IF
I
      8632**DCL      8763<<ASSIGN   8764>>IF       8795>>ASSIGN   8815<<DOINDEX  8816>>ASSIGN   8817>>ASSIGN
      8818>>ASSIGN   8819>>ASSIGN   8821<<DOINDEX  8823>>ASSIGN   8829<<DOINDEX  8830>>ASSIGN   8831>>IF
PL6.E3A0      #001=MMV$OPEN File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:25 Page:57   
      8833>>ASSIGN   8864<<DOINDEX  8865>>CALL     8869<<DOINDEX  8870>>CALL     8873<<DOINDEX  8874>>CALL
      8883<<DOINDEX  8884>>CALL     8887<<DOINDEX  8888>>CALL
ILGLSEG
      8487**DCL      8753>>ASSIGN
MM$DESC.BOUND
      8107**DCL      8108--REDEF
MM$DESC.FLGS
      8108**DCL      8108--REDEF
MM$DESC.FLGS1.NOTEMPTY
      8108**DCL      8807<<ASSIGN
MM$PPUT.USER#
      8096**DCL      8096--REDEF
MM$SDESC.FLGS
      8110**DCL      8811<<ASSIGN
MM$VCB.CREATE
      8098**DCL      8688<<ASSIGN   8729<<ASSIGN
MM$VCB.HEAD
      8101**DCL      8684<<ASSIGN
MM$VCB.MAXVP#
      8100**DCL      8662<<ASSIGN   8662>>ASSIGN   8665>>IF       8694>>ASSIGN
MM$VCB.MAXVP_WRITTEN
      8101**DCL      8693<<ASSIGN
MM$VCB.NPGTPGS
      8102**DCL      8694<<ASSIGN   8697>>IF       8699>>ASSIGN   8701<<ASSIGN   8701>>ASSIGN   8707>>IF
      8707>>IF       8712<<ASSIGN   8715>>IF       8782>>DOINDEX  8788>>ASSIGN   8790>>DOINDEX  8821>>DOINDEX
      8828>>ASSIGN   8842>>ASSIGN   8865>>CALL     8887>>DOINDEX
MM$VCB.NPGTSECT
      8102**DCL      8699<<ASSIGN   8701>>ASSIGN   8777>>ASSIGN   8779>>DOINDEX  8784>>CALL     8815>>DOINDEX
      8823>>ASSIGN   8841>>ASSIGN   8867>>ASSIGN   8873>>DOINDEX
MM$VCB.PPC
      8102**DCL      8686<<ASSIGN
MM$VCB.PPMAX
      8100**DCL      8676>>IF       8678<<ASSIGN   8681>>ASSIGN   8707>>IF
MM$VCB.PPMIN
      8100**DCL      8681<<ASSIGN   8681>>ASSIGN
MM$VCB.PTR$
PL6.E3A0      #001=MMV$OPEN File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:25 Page:58   
      8100**DCL      8692<<ASSIGN
MM$VCB.SEGNUM
      8099**DCL      8732>>DOCASE
MM$VCB.T
      8098**DCL      8844>>ASSIGN
MM$VCB.T.FRAGMENTED
      8098**DCL      8689<<ASSIGN   8711<<ASSIGN   8831>>IF
MM$VCB.T.SECTION
      8099**DCL      8690<<ASSIGN   8698<<ASSIGN   8776>>IF       8814>>IF       8841>>IF       8857<<ASSIGN
MM$VCB.TAIL
      8101**DCL      8685<<ASSIGN
MM$VCB.UPGT#
      8102**DCL      8691<<ASSIGN
MM$VCB.WRITE
      8098**DCL      8687<<ASSIGN   8726<<ASSIGN
MM$VCB.WSPTD
      8100**DCL      8851<<ASSIGN
MM$VCB.WSQ
      8099**DCL      8762<<ASSIGN
MM$VIRTUAL_STATS
      8362**DCL      8661<<ASSIGN
MMB$FPPONTAIL
      8622**DCL-ENT  8871--CALL     8874--CALL     8885--CALL     8888--CALL
MMB$GNPP
      8621**DCL-ENT  8778--CALL     8789--CALL
MMB$GPP
      8620**DCL-ENT  8783--CALL
MME$GVPNOPP
      8618**DCL-ENT  8780--CALL     8784--CALL     8791--CALL
MME$RVNP
      8623**DCL-ENT  8870--CALL     8884--CALL
MME$WFVP
      8619**DCL-ENT  8865--CALL
MMERR
      8366**DCL      8877>>ASSIGN   8891>>ASSIGN
MM_BYP$
PL6.E3A0      #001=MMV$OPEN File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:25 Page:59   
      8027**DCL      8027--IMP-PTR
MM_FPMC
      8033**DCL      8823>>ASSIGN   8833>>ASSIGN
MM_PTPTRS$
      8107**DCL      8801>>ASSIGN
MM_SCTDFT
      8033**DCL      8819>>ASSIGN
NOVLPVIRT
      8577**DCL      8650>>ASSIGN
NO_PT
      8856**LABEL    8778--CALLALT  8789--CALLALT
P$
      8630**DCL      8738<<ASSIGN   8744<<ASSIGN   8750<<ASSIGN   8798>>ASSIGN   8801<<ASSIGN   8816>>ASSIGN
      8817>>ASSIGN   8818>>ASSIGN   8819>>ASSIGN   8823>>ASSIGN   8830>>ASSIGN   8833>>ASSIGN
PPNO
      8636**DCL      8777<<ASSIGN   8778<>CALL     8780>>CALL     8783<>CALL     8784<>CALL     8788<<ASSIGN
      8789<>CALL     8791>>CALL     8870<>CALL     8871<>CALL     8874>>CALL     8882>>ASSIGN   8884<>CALL
      8885<>CALL
PT_SETUP
      8724**LABEL    8703--GOTO
REL_DENSE
      8882**LABEL    8791--CALLALT
REL_EM
      8864**LABEL    8783--CALLALT  8784--CALLALT
REL_IT
      8869**LABEL    8780--CALLALT
SAVE_PPNO
      8638**DCL      8882<<ASSIGN   8888>>CALL
SEGID
      8635**DCL      8737<<ASSIGN   8743<<ASSIGN   8749<<ASSIGN   8807>>ASSIGN   8810>>ASSIGN
S_WSPTD
      8295**DCL      8851>>ASSIGN
S_WSPTD.BLKNO
      8295**DCL      8840<<ASSIGN
S_WSPTD.NBLKS
      8295**DCL      8841<<ASSIGN   8842<<ASSIGN
PL6.E3A0      #001=MMV$OPEN File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:25 Page:60   
S_WSPTD.P
      8295**DCL      8843<<ASSIGN
S_WSPTD.Q
      8295**DCL      8846<<ASSIGN   8848<<ASSIGN
S_WSPTD.T
      8295**DCL      8844<<ASSIGN
TEMP
      8637**DCL      8779<<DOINDEX  8780>>CALL     8780>>CALL     8782<<DOINDEX  8784>>CALL     8790<<DOINDEX
      8791>>CALL     8791>>CALL     8810<<ASSIGN   8811>>ASSIGN   8822<<DOINDEX  8823>>ASSIGN   8828<<ASSIGN
      8829>>DOINDEX  8838<<ASSIGN   8839<<ASSIGN   8839>>ASSIGN   8840>>ASSIGN   8864>>DOINDEX  8867<<ASSIGN
      8869>>DOINDEX  8873>>DOINDEX  8883>>DOINDEX  8884<>CALL     8887>>DOINDEX
TERR
      8639**DCL      8865<>CALL     8870<>CALL
VCB$
      8634**DCL      8644<<ASSIGN   8648>>IF       8662>>ASSIGN   8662>>ASSIGN   8665>>IF       8676>>IF
      8678>>ASSIGN   8681>>ASSIGN   8681>>ASSIGN   8681>>ASSIGN   8684>>ASSIGN   8685>>ASSIGN   8686>>ASSIGN
      8687>>ASSIGN   8688>>ASSIGN   8689>>ASSIGN   8690>>ASSIGN   8691>>ASSIGN   8692>>ASSIGN   8693>>ASSIGN
      8694>>ASSIGN   8694>>ASSIGN   8697>>IF       8698>>ASSIGN   8699>>ASSIGN   8699>>ASSIGN   8701>>ASSIGN
      8701>>ASSIGN   8701>>ASSIGN   8707>>IF       8707>>IF       8707>>IF       8711>>ASSIGN   8712>>ASSIGN
      8715>>IF       8726>>ASSIGN   8729>>ASSIGN   8732>>DOCASE   8762>>ASSIGN   8776>>IF       8777>>ASSIGN
      8779>>DOINDEX  8782>>DOINDEX  8784>>CALL     8788>>ASSIGN   8790>>DOINDEX  8798>>ASSIGN   8814>>IF
      8815>>DOINDEX  8821>>DOINDEX  8823>>ASSIGN   8828>>ASSIGN   8831>>IF       8841>>IF       8841>>ASSIGN
      8842>>ASSIGN   8844>>ASSIGN   8851>>ASSIGN   8857>>ASSIGN   8865>>CALL     8867>>ASSIGN   8873>>DOINDEX
      8887>>DOINDEX
VLP$VIRTUAL.PTR$
      8612**DCL      8798<<ASSIGN
VPPGTBL
      8633**DCL      8736<<ASSIGN   8742<<ASSIGN   8748<<ASSIGN   8780>>CALL     8784>>CALL     8791>>CALL
      8838>>ASSIGN   8865>>CALL     8870>>CALL     8884>>CALL

PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:61   
      344        1        /*T***********************************************************/
      345        2        /*T*                                                         */
      346        3        /*T* Copyright (c) Bull HN Information Systems Inc., 1997    */
      347        4        /*T*                                                         */
      348        5        /*T***********************************************************/
      349        6        /*F* NAME: MMV$PAGE
      350        7             PURPOSE: Performs the paging of a large virtual array.
      351        8             DESCRIPTION: This routine performs the paging function of
      352        9                          a large virtual array. It is call by the fault
      353       10                          handler on detection of a missing working space or
      354       11                          of a missing page fault accessing WSQ'S 9, 10, or 11
      355       12                          and less then the maximum virtual page kept in the
      356       13                          DCB. If the number of physical pages is less than
      357       14                          the limit set up at open time a new page will be
      358       15                          gotten by calling MME$WGVP to set up the page
      359       16                          table and then read in from the disk file. If the
      360       17                          the physical limit is reached the page table will
      361       18                          be searched to find the page that has not been
      362       19                          accessed for the longest time, write the page out
      363       20                          if it has been modified and then read in the new
      364       21                          virtual page. The chain is a chain of virtual
      365       22                          pages with the least recently accessed at the
      366       23                          tail. The chain is linked through MM$PPUT and
      367       24                          the PT.
      368       25
      369       26             MM$VCB.HEAD          B$MAP             MM$PPUT
      370       27             -------------       ---------         -----------
      371       28             |  First VP |------>| Rpage |-------->| NXTVP   |
      372       29             -------------       ---------        .-----------
      373       30                                 |       |    .    |         |
      374       31                                 ---------.        -----------
      375       32                                 | Rpage |-------->| NXTVP   |
      376       33                                 ---------        .-----------
      377       34             MM$VCB.TAIL         |       |    .    |         |
      378       35             ----------          ---------.        -----------
      379       36             | Last VP |-------->| Rpage |-------->|'777777777'O|
      380       37             -----------         ---------         -----------
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:62   
      381       38
      382       39              */
      383       40
      384       41        MMV$PAGE: PROC (EWSQ,EVPAGE,PPNO) ALTRET;
      385       42
      386       43        /* Includes */
      387       44        %INCLUDE B$JIT;
      388      647        %INCLUDE B$MAP;
      389      746        %INCLUDE B$SS;
      390      925        %INCLUDE B_MACROS_C;
      391     1036        %INCLUDE B_MAGIC_C;
      392     1154        %INCLUDE B_SEGIDS_C;
      393     1693        %INCLUDE CP_6;
      394     7252        %INCLUDE CP_6_SUBS;
      395     7792        %INCLUDE F$DCB;
      396     7841        %INCLUDE FM$CFU;
      397     7886        %INCLUDE F_ERRORS_C;
      398     8126        %INCLUDE MM_DATA_R;
      399     8646        %INCLUDE HF_DATA_R;
      400     8689        %INCLUDE M_ERRORS_C;
      401     8753        %INCLUDE M_ERRSET_C;
      402     8777        %INCLUDE UD_SEV_C;
      403     8791        %INCLUDE UE$CP6V_C;
      404     8875        %INCLUDE HF_LOCK_C;
      405     8889
      406     8890        /* Paramters */
      407     8891    1   DCL EWSQ UBIN;
      408     8892    1   DCL EVPAGE UBIN ;
      409     8893    1   DCL PPNO SBIN;
      410     8894
      411     8895        /* Symref's */
      412     8896    1   DCL B$PPUT$ PTR SYMREF READONLY;
      413     8897    1   DCL B$ROSEG$ PTR SYMREF READONLY;
      414     8898    1   DCL B$JIT$ PTR SYMREF READONLY;
      415     8899    1   DCL B$SBUF2$ PTR SYMREF READONLY;
      416     8900    1   DCL B$UPT$ PTR SYMREF READONLY;
      417     8901    1   DCL B$USERLS$ PTR SYMREF READONLY;
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:63   
      418     8902    1   DCL B$USERHJIT$ PTR SYMREF READONLY;
      419     8903    1   DCL B$WSQ0PT$ PTR SYMREF READONLY;
      420     8904    1   DCL B$IPHYMAP$ PTR SYMREF READONLY;
      421     8905    1   DCL B$MPT$ PTR SYMREF READONLY;
      422     8906    1   DCL S_RVA UBIN SYMREF;
      423     8907
      424     8908        /* Auto */
      425     8909    1   DCL EVP UBIN WORD;                      /* page being accessed */
      426     8910    1   DCL 1 EVPKEY REDEF EVP,
      427     8911    1            2 * BIT(14) UNAL,
      428     8912    1            2 PAGE_KEY UBIN(16) UNAL,
      429     8913    1            2 PAGE_NO_ENTRY UBIN(6) UNAL;
      430     8914    1   DCL 1 EVPSECT REDEF EVP,
      431     8915    1            2 * BIT(14) UNAL,
      432     8916    1            2 SECT# UBIN(12) UNAL,
      433     8917    1            2 PG# UBIN(10) UNAL;
      434     8918    1   DCL EVP_PAGE_NO_ENTRY UBIN;
      435     8919    1   DCL PAGE_NO_ENTRY SBIN;
      436     8920    1   DCL FRAGMENTED BIT(1);
      437     8921    1   DCL SECTION BIT(1);
      438     8922    1   DCL MAPVP UBIN;
      439     8923    1   DCL DCB# UBIN;                          /* Dcb number for this virtual area */
      440     8924    1   DCL WRITE_FLAG BIT(1);
      441     8925    1   DCL ERR UBIN;
      442     8926    1   DCL I SBIN;
      443     8927    1   DCL K SBIN;
      444     8928    1   DCL TLNACC SBIN;                        /* Tail of 'not accessed' list */
      445     8929    1   DCL HDNACC SBIN;                        /* Head of 'not accessed' list */
      446     8930    1   DCL TLACC SBIN;                         /* Tail of 'accessed' list */
      447     8931    1   DCL HDACC SBIN;                         /* Head of 'accessed' list     */
      448     8932    1   DCL VP SBIN;                            /* Current vp                         */
      449     8933    1   DCL 1 VPSECT REDEF VP,
      450     8934    1            2 * BIT(14),
      451     8935    1            2 SECT# UBIN(12) UNAL,
      452     8936    1            2 PG# UBIN(10) UNAL;
      453     8937    1   DCL ACTLPP REDEF VP SBIN;               /* PP at end of accessed list */
      454     8938    1   DCL PP SBIN;                            /* current physical page              */
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:64   
      455     8939    1   DCL NACTLPP REDEF PP SBIN;              /* PP at end of not accessed list */
      456     8940    1   DCL NXTVP SBIN;                         /* Next vp                            */
      457     8941    1   DCL 1 NXTVPSECT REDEF NXTVP,
      458     8942    1            2 * BIT(14),
      459     8943    1            2 SECT# UBIN(12) UNAL,
      460     8944    1            2 PG# UBIN(10) UNAL;
      461     8945    1   DCL NXTPP SBIN;                         /* Next physical page                 */
      462     8946        /* Tail predecessors */
      463     8947    1   DCL J SBIN;
      464     8948    1   DCL PREDTA SBIN;
      465     8949    1   DCL PREDTN SBIN;
      466     8950    1   DCL PREDT SBIN;
      467     8951    1   DCL IPG UBIN;                      /* Appropriate index in the page table */
      468     8952    1   DCL PTBASE UBIN WORD;
      469     8953    1   DCL ER_JUNK UBIN WORD;
      470     8954    1   DCL PT(0:15) SBIN HALF HALIGNED;
      471     8955    1   DCL SAVE_PPUT BIT(36) ALIGNED;
      472     8956    1   DCL  SAVE_VP SBIN WORD;
      473     8957    1   DCL   SCT# SBIN WORD;
      474     8958    1   DCL  SCT_USED SBIN WORD;
      475     8959    1   DCL  SKIP_COUNT SBIN WORD;
      476     8960    1   DCL UPD_CHAIN_FLG BIT(1);               /*Page chain updated */
      477     8961    1   DCL 1 READ$PAGE$ERR ,
      478     8962    1            2 FCG BIT(12),
      479     8963    1            2 MID BIT(6),
      480     8964    1            2 MON BIT(1),
      481     8965    1            2 CODE UBIN(14) UNAL,
      482     8966    1            2 SEV UBIN(3) UNAL;
      483     8967    1   DCL SEGID BIT(12);
      484     8968    1   DCL TEMP SBIN;
      485     8969    1   DCL BTEMP REDEF TEMP BIT(36) ALIGNED;
      486     8970    1   DCL MAP$ PTR;
      487     8971    1   DCL 1 MAP_PTR REDEF MAP$,
      488     8972    1            2 WOFFS UBIN(18) UNAL,
      489     8973    1            2 * UBIN(18) UNAL;
      490     8974    1   DCL SECT$ PTR;
      491     8975    1   DCL UNMAP$ PTR;
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:65   
      492     8976    1   DCL 1 UNMAP_PTR REDEF UNMAP$,
      493     8977    1            2 WOFFS UBIN(18) UNAL,
      494     8978    1            2 * UBIN(18) UNAL;
      495     8979    1   DCL   MAP_INDEX SBIN WORD;
      496     8980    1   DCL VCB$ PTR;
      497     8981    1   DCL STATS$ PTR;
      498     8982    1   DCL WSQ SBIN;
      499     8983    1   DCL WS_FLT BIT(1);                      /* Missing working space fault */
      500     8984        %FPT$STRAP_V (BASED=AUTO);
      501     8987
      502     8988        /* Base structures */
      503     8989        %T01DESCR (NAME=B$$DESCR);
      504     8997        %B$FLT (NAME=FINFO,SSF=NO,HREGS=NO,STCLASS=AUTO);
      505     9049        %B$ECCB;
      506     9057    1   DCL SST$SSFTCB ENTRY(6) ALTRET;
      507     9058    1   DCL 1 B$FRAGHWRD,
      508     9059    1            2 * BIT(1) UNAL,
      509     9060    1            2 KEY_VALID BIT(1) UNAL,
      510     9061    1            2 PAGE_KEY UBIN(16) UNAL;
      511     9062    1   DCL 1 B$FRAGMAP BASED ALIGNED,
      512     9063    1            2 HWRD(0:255) HALIGNED,
      513     9064    1                 3 * BIT(1) UNAL,
      514     9065    1                 3 KEY_VALID BIT(1) UNAL,
      515     9066    1                 3 PAGE_KEY UBIN(16) UNAL;
      516     9067    1   DCL 1 B$FRAGMAPD(0:63) BASED DALIGNED,
      517     9068    1            2 * BIT(1) UNAL,
      518     9069    1            2 KEY_VALID_0 BIT(1) UNAL,
      519     9070    1            2 PAGE_KEY_0 UBIN(16) UNAL,
      520     9071    1            2 * BIT(1) UNAL,
      521     9072    1            2 KEY_VALID_1 BIT(1) UNAL,
      522     9073    1            2 PAGE_KEY_1 UBIN(16) UNAL,
      523     9074    1            2 * BIT(1) UNAL,
      524     9075    1            2 KEY_VALID_2 BIT(1) UNAL,
      525     9076    1            2 PAGE_KEY_2 UBIN(16) UNAL,
      526     9077    1            2 * BIT(1) UNAL,
      527     9078    1            2 KEY_VALID_3 BIT(1) UNAL,
      528     9079    1            2 PAGE_KEY_3 UBIN(16) UNAL;
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:66   
      529     9080
      530     9081        /* Entry references */
      531     9082    1   DCL FMU$BLD ENTRY;
      532     9083    1   DCL HFE$M$STRAP ENTRY(1);
      533     9084    1   DCL JSE$ABORTM ENTRY(8);
      534     9085    1   DCL MMB$FPPONTAIL ENTRY(1) ALTRET;
      535     9086    1   DCL MMB$FPP ENTRY(1) ALTRET;
      536     9087    1   DCL MME$RVNP ENTRY(4) ALTRET;
      537     9088    1   DCL MME$WGVP ENTRY(4) ALTRET;
      538     9089    1   DCL MME$WFVP ENTRY(4) ALTRET;
      539     9090    1   DCL MME$CVM ENTRY (4) ALTRET;
      540     9091    1   DCL M$MREAD ENTRY(1) ALTRET;
      541     9092    1   DCL M$MWRITE ENTRY(1) ALTRET;
      542     9093    1   DCL SC_MM47 ENTRY CONV(2,0);
      543     9094    1   DCL SSS$SEXIT ENTRY;
      544     9095    1   DCL SSU$DELTAGO ENTRY(3);
      545     9096    1   DCL UDB$AUTO ENTRY;
      546     9097    1   DCL UDN$MAGIC ENTRY ;
      547     9098    1   DCL HFC$ASSOCCLR ENTRY(3);
      548     9099    1   DCL UDN$MGRES ENTRY(1);
      549     9100    1   DCL UDN$MGSAVE ENTRY(1);
      550     9101    1   DCL MMA$POPSSF ENTRY;
      551     9102
      552     9103        /* Macro invocations */
      553     9104        %B_MPT (FPTN=B_MPT,STCLASS=SYMREF);
      554     9197        %B$MAP (NAME=B$NMAP);
      555     9215        %B_MPT (FPTN=B_MPT_SAVE,STCLASS="");
      556     9308        %FM$CFU;
      557     9314        %FPT_READ (FPTN=READ_PAGEC,STCLASS=CONSTANT,KEYS=YES);
      558     9353        %FPT_READ (FPTN=READ_PAGE,STCLASS="");
      559     9392        %FPT_WRITE (FPTN=WRITE_PAGEC,STCLASS=CONSTANT);
      560     9423        %MM$VIRTUAL_STATS(STCLASS="BASED(STATS$)");
      561     9427        %MODERR(MODULE='26'O);                  /* Sets the module of errcode to v    */
      562     9435        %VLP_ERRCODE (FPTN=VSBADAC,ERR#=%E$VSBADAC,SEV=SEV_ERROR#,FCG=MM,MID=V,MON='1'B,
              9435            STCLASS=CONSTANT);
      563     9480        %VLP_ERRCODE (FPTN=PGINUSE,ERR#=%E$PGINUSE,SEV=SEV_ERROR#,FCG=MM,MID=V,MON='1'B,
              9480            STCLASS=CONSTANT);
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:67   
      564     9525
      565     9526        /* Sub's */
      566     9527        %SUB MM$VCB = VCB$ -> MM$VCB;
      567     9528        %SUB MM$PPUT = B$PPUT$ -> MM$VPPUT;
      568     9529        %SUB B$FRAGMAP = MAP$->B$FRAGMAP;
      569     9530        %SUB B$FRAGMAPD = MAP$->B$FRAGMAPD;
      570     9531        %SUB B$MAP = MAP$ -> B$MAP;
      571     9532        %SUB B$SECT = SECT$ -> B$SECT;
      572     9533        %SUB ECCB$ = B_MPT.ECCB$;
      573     9534        %SUB SS$ = B_MPT.SS$;
      574     9535        %SUB TCB$ = B_MPT.TCB$;
      575     9536        %SUB_EXC;
      576     9583
      577     9584        %EJECT;
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:68   
      578     9585        /* Procedure */
      579     9586
      580     9587    2        DO INHIBIT;
      581     9588    2             EVP = S_RVA;
      582     9589    2           END;
      583     9590    1        WS_FLT='0'B;                       /* Missing page fault */
      584     9591    1   FLTENT:;
      585     9592    1        UPD_CHAIN_FLG=%FALSE;
      586     9593             /* Get VP and EWSQ out of SS */
      587     9594    1        CALL UDN$MGSAVE (B_MPT_SAVE);
      588     9595    1        CALL UDN$MAGIC;
      589     9596
      590     9597    1        WSQ = SS$ -> B$SS.EWSQ#;
      591     9598    1        EVP = BITBIN(BINBIT(EVP,36)&'177777777777'O) /4096;
      592     9599    1        EVP_PAGE_NO_ENTRY = EVPKEY.PAGE_NO_ENTRY;
      593     9600        /* Reset B$SS.IR.MIR and B$SS.CPUREQ */
      594     9601    1        SS$ -> B$SS.IR.MIR = %FALSE;
      595     9602
      596     9603    1        IF WSQ > %USERWSQ
      597     9604    1        THEN
      598     9605    1             GOTO COMMON;
      599     9606             %FINDMAP (WSQ = WSQ , P$ = MAP$);
      600     9609    1        CALL MME$WGVP (WSQ, EVP, BITBIN (%PGINMEM|%PGWRITE|%PGIOM),ERR) ALTRET (
              9609                 CANT_GET);
      601     9610    1        PP = B$MAP.RPN (EVP);
      602     9611    1        IF HW_WSQ0PT THEN
      603     9612    1             PP = B$IPHYMAP$ -> MM$IPHY_MAP (PP);
      604     9613    1        CALL CVM;
      605     9614    1        TEMP = 23085;                      /* .000000055055 (  --) */
      606     9615    1        CALL INITPAGE1;
      607     9616    1        GOTO MMV_EXIT;
      608     9617
      609     9618        /* Handle M$GVP for virtual segment. */
      610     9619    1   MMV$GET: ENTRY(EWSQ,EVPAGE) ALTRET;
      611     9620
      612     9621    1        WSQ = EWSQ;
      613     9622    1        EVP = EVPAGE;
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:69   
      614     9623
      615     9624    1   COMMON: ;
      616     9625        %EJECT;
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:70   
      617     9626        /* Set up pointer to dcb for this virtual area */
      618     9627    1        DCB# = B$JIT.VIRTUAL.DCB# (WSQ - %VS1WSQ);
      619     9628    1        IF DCB# = 0
      620     9629    2        THEN DO;
      621     9630    2             CALL SC_MM47;
      622     9631                  /*S* SCREECH_CODE: MMV-S$MM47   */
      623     9632                  /*S* TYPE: SUA */
      624     9633                  /*S* MESSAGE: Inconsistency in large virtual segment */
      625     9634    2           END;
      626     9635    1        VCB$ = DCBADDR(DCB#) -> F$DCB.SETSTA$;
      627     9636    1        STATS$ = DCBADDR(DCB#) -> F$DCB.LASTSTA$;
      628     9637    1        IF WSQ ~= MM$VCB.WSQ               /* WSQ does not match */
      629     9638    2        THEN DO;
      630     9639    2             CALL SC_MM47;
      631     9640    2           END;
      632     9641    1        MM$VIRTUAL_STATS.FAULTS# = MM$VIRTUAL_STATS.FAULTS# + 1;
      633     9642
      634     9643        /* Check to see if the access is within bounds of the segment */
      635     9644    1        IF EVP > MM$VCB.MAXVP#
      636     9645    2        THEN DO;
      637     9646    2             B$JIT.ERR = VSBADAC;
      638     9647                  /*E* ERROR: MMV-E$VSBADAC-SEV_ABORT#
      639     9648                       MESSAGE: Memory accesses out of range for virtual segment
      640     9649                       MESSAGE1: The virtual address is larger than the maximum
      641     9650                                allowable for the virtual area
      642     9651                        */
      643     9652    2             CALL ABORTM(%SUBC_MEMORY#);
      644     9653    2           END;
      645     9654        /* If NOFILE report page fault to user */
      646     9655    1        IF MM$VCB.NOFILE
      647     9656    2        THEN DO;
      648     9657    2             IF WS_FLT THEN FPT$STRAP_V.STRAP = BITBIN(%FLT_MSPACE#);
      649     9658    2             ELSE FPT$STRAP_V.STRAP = BITBIN(%FLT_MPAGE#);
      650     9659    2             CALL HFE$M$STRAP(ADDR(FPT$STRAP_V));
      651     9660    2           END;
      652     9661        %EJECT;
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:71   
      653     9662
      654     9663    1        FRAGMENTED = MM$VCB.T.FRAGMENTED;
      655     9664    1        SECTION = MM$VCB.T.SECTION;
      656     9665    1        CALL FINDMAP (EVP);
      657     9666
      658     9667        /* Check to see if the page that the trap points to is already one
      659     9668             that should be in memory, if it is a SUA is in order because there
      660     9669             is something wrong. */
      661     9670    1        IF FRAGMENTED            /* Fragmented page table check to see if key */
      662     9671    2        THEN DO;                           /*   already exist. */
      663     9672                                      /* Also look for empty key slot at the
      664     9673                                         same time. */
      665     9674    2             I = EVP_PAGE_NO_ENTRY * 4;
      666     9675    2             PAGE_NO_ENTRY = -1;
      667     9676    3             DO TEMP = 0 TO 3;
      668     9677    3                  B$FRAGHWRD = B$FRAGMAP.HWRD (I);
      669     9678    3                  IF B$FRAGHWRD.KEY_VALID
      670     9679    3                  THEN
      671     9680    3                       IF B$FRAGHWRD.PAGE_KEY = EVPKEY.PAGE_KEY
      672     9681    3                       THEN
      673     9682    3                            CALL SC_MM47;
      674     9683    3                       ELSE ;
      675     9684    3                  ELSE
      676     9685    3                       PAGE_NO_ENTRY = I;
      677     9686    3                  I = I + 1;
      678     9687    3                END;
      679     9688    2           END;
      680     9689    1        ELSE IF SECTION THEN ;
      681     9690    1             ELSE IF B$MAP.RPN(EVP) ~= MM_FPMC.RPN
      682     9691    1                  THEN
      683     9692    1                       CALL SC_MM47;
      684     9693
      685     9694        %EJECT;
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:72   
      686     9695    1        IF WS_FLT THEN GOTO SPACEM;        /* It was missing working space */
      687     9696
      688     9697    1   GT_DATAPAG:
      689     9698    1        TEMP = MM$VCB.PPC;                 /* Move physical page count to auto   */
      690     9699    2        IF UPD_CHAIN_FLG = %FALSE THEN DO;
      691     9700    3             IF SECTION THEN DO;
      692     9701    3                  IF TEMP = MM$VCB.PPMAX THEN
      693     9702    3                       CALL UPD_SECT_CHAIN;
      694     9703    3                END;
      695     9704    3             ELSE DO;
      696     9705    3                  IF (FRAGMENTED AND PAGE_NO_ENTRY < 0) OR TEMP = MM$VCB.PPMAX
      697     9706    3                  THEN CALL UPD_FRAG_DENSE_CHAIN;
      698     9707    3                END;
      699     9708    2           END;
      700     9709    1        IF FRAGMENTED
      701     9710    2        THEN DO;
      702     9711    2             MAPVP = PAGE_NO_ENTRY + 128;
      703     9712
      704     9713             /* If the key is valid write out the page and assign the new
      705     9714                key then return */
      706     9715    2             B$FRAGHWRD = B$FRAGMAP.HWRD (PAGE_NO_ENTRY);
      707     9716    2             IF B$FRAGHWRD.KEY_VALID
      708     9717    3             THEN DO;
      709     9718    3                  VP = B$FRAGHWRD.PAGE_KEY * 64 + PAGE_NO_ENTRY/4;
      710     9719    3                  PP = B$MAP.RPN(MAPVP);   /* GET PHYSICAL PAGE */
      711     9720    3                  IF HW_WSQ0PT THEN
      712     9721    3                       PP=B$IPHYMAP$->MM$IPHY_MAP(PP);
      713     9722    3                  CALL CVM;
      714     9723    3                  IF B$MAP.CTRL(MAPVP) & %PGMOD
      715     9724    4                  THEN DO;
      716     9725    4                       B$MAP.CTRL(MAPVP) = B$MAP.CTRL(MAPVP) & ~%PGMOD;
      717     9726    4                       CALL WRITE$PAGE(VP) ALTRET(FM_ERROR);
      718     9727    4                     END;
      719     9728    3                  B$FRAGMAP.HWRD.PAGE_KEY(PAGE_NO_ENTRY) = EVPKEY.PAGE_KEY;
      720     9729    3                  IF H_S1000_FLG THEN
      721     9730    3                       CALL HFC$ASSOCCLR(WSQ,MAPVP,1);
      722     9731    3                  ELSE
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:73   
      723     9732    3                       CALL HFC$ASSOCCLR;
      724     9733    3                  IF NOT MM$VCB.CREATE OR EVP <= MM$VCB.MAXVP_WRITTEN
      725     9734    3                  THEN
      726     9735    3   READ_PAGE:
      727     9736    3                       CALL READ$PAGE (EVP) ALTRET (CANT_READ);
      728     9737    3                  ELSE
      729     9738    3   INIT_PAGE:
      730     9739    3                       CALL INIT$PAGE;
      731     9740    3   MMV_EXIT:
      732     9741    3                  CALL UNCVM;
      733     9742    3                  CALL UDN$MGRES(B_MPT_SAVE);
      734     9743    3                  CALL UDB$AUTO;
      735     9744    3                END;
      736     9745    2           END;
      737     9746    1        ELSE
      738     9747    1             MAPVP = EVP;
      739     9748
      740     9749
      741     9750        /* The chain of virtual pages has now been updated with the page
      742     9751             that is the newest at the head and the oldest is at the tail */
      743     9752    1        IF MM$VCB.PPC < MM$VCB.PPMAX       /* Can get physical                   */
      744     9753    2        THEN DO;
      745     9754    2             IF MM$VCB.WRITE
      746     9755    2             THEN
      747     9756    2                  CALL MME$WGVP(WSQ,MAPVP,BITBIN(%PGINMEM|%PGWRITE),ERR) ALTRET(
              9756                           CANT_GET1);
      748     9757    2             ELSE
      749     9758    2                  CALL MME$WGVP(WSQ,MAPVP,BITBIN(%PGINMEM),ERR) ALTRET(CANT_GET1);
      750     9759
      751     9760        /* If fragmented set page valid */
      752     9761    2             IF FRAGMENTED
      753     9762    3             THEN DO;
      754     9763    3                  B$FRAGMAP.HWRD.KEY_VALID(PAGE_NO_ENTRY) = %TRUE;
      755     9764    3                  B$FRAGMAP.HWRD.PAGE_KEY(PAGE_NO_ENTRY) = EVPKEY.PAGE_KEY;
      756     9765    3                END;
      757     9766
      758     9767
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:74   
      759     9768        /* The current usage count in MM$VCB has to be incremented and the
      760     9769             page must be added to the head of the usage chain */
      761     9770    2             CALL FINDMAP(MAPVP);
      762     9771    2             PP = B$MAP.RPN(IPG);          /* Get physical page number           */
      763     9772    2             IF HW_WSQ0PT THEN
      764     9773    2                  PP=B$IPHYMAP$->MM$IPHY_MAP(PP);
      765     9774    2             MM$VCB.PPC = MM$VCB.PPC + 1;
      766     9775
      767     9776        /* Keep track of the maximum physical we used */
      768     9777    2             IF MM$VCB.PPC > MM$VIRTUAL_STATS.MAXPGS#
      769     9778    2             THEN
      770     9779    2                  MM$VIRTUAL_STATS.MAXPGS# = MM$VCB.PPC;
      771     9780
      772     9781    2             IF MM$VCB.HEAD < 0            /* Empty chain                        */
      773     9782    3             THEN DO;
      774     9783    3                  MM$VCB.HEAD = MAPVP;
      775     9784    3                  MM$VCB.TAIL = MAPVP;
      776     9785    3                  MM$PPUT.PPNO(PP) = BITBIN('777777777'O); /* Set tail in chain */
      777     9786    3                END;
      778     9787    3             ELSE DO;
      779     9788        /* For section page tables, the virtual page chain is linked with the
      780     9789        most recently accessed page at the head.  (new vp are added at the head)
      781     9790        For fragmented and dense page tables, the virtual page chain is linked
      782     9791        with the most recently accessed at the tail (new vps are added at the tail). */
      783     9792    4                  IF SECTION THEN DO;
      784     9793    4                       MM$PPUT.PPNO(PP)=MM$VCB.HEAD;
              9793                                /* The new page is going to point to the former head */
      785     9794    4                       MM$VCB.HEAD = MAPVP;
      786     9795    4                     END;
      787     9796    4                  ELSE DO;
      788     9797    4                       IF HW_WSQ0PT THEN
      789     9798    4                            MM$PPUT.PPNO(B$IPHYMAP$->MM$IPHY_MAP(B$MAP.RPN(MM$VCB.TAIL)
              9798                                     )) = MAPVP;
      790     9799    4                       ELSE
      791     9800    4                            MM$PPUT.PPNO(B$MAP.RPN(MM$VCB.TAIL)) = MAPVP;
      792     9801    4                       MM$VCB.TAIL = MAPVP;
      793     9802    4                       MM$PPUT.PPNO(PP) = BITBIN('777777777'O);
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:75   
      794     9803    4                     END;
      795     9804    3                END;
      796     9805    2             CALL CVM;
      797     9806
      798     9807        /* If the file is not in create the page must be read in first */
      799     9808    2             IF NOT MM$VCB.CREATE OR EVP <= MM$VCB.MAXVP_WRITTEN
      800     9809    3             THEN DO;
      801     9810    3                  GOTO READ_PAGE;
      802     9811    3   CANT_READ:     ;
      803     9812    3                  IF READ$PAGE$ERR.CODE ~= %E$NOKEY
      804     9813    4                  THEN DO;
      805     9814    4                       GOTO FM_ERROR;
      806     9815    4                     END;
      807     9816    3                END;
      808     9817             /* Just neet to initialize the page if necessary */
      809     9818    2             GOTO INIT_PAGE;
      810     9819    2           END;
      811     9820        %EJECT;
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:76   
      812     9821    2        ELSE DO;
      813     9822    2   REUSE_PAGE: ;
      814     9823                       /* A page has to be released in order to read a new
      815     9824                          page. The page that is used is the tail of the
      816     9825                          page chain if section page tables otherwise use
      817     9826                          head of the chain.
      818     9827         */
      819     9828    2             IF UPD_CHAIN_FLG=%FALSE THEN
      820     9829    2                  IF SECTION THEN
      821     9830    2                       CALL UPD_SECT_CHAIN;
      822     9831    2                  ELSE
      823     9832    2                       CALL UPD_FRAG_DENSE_CHAIN;
      824     9833    3             IF SECTION THEN DO;
      825     9834    3                  VP = MM$VCB.TAIL;
      826     9835    3                  MM$VCB.TAIL=PREDT;
      827     9836    3                END;
      828     9837    2             ELSE
      829     9838    2                  VP = MM$VCB.HEAD;
      830     9839    2             CALL FINDMAP(VP);
      831     9840    2             PP = B$MAP.RPN(IPG);          /* Get physical page                  */
      832     9841    2             IF HW_WSQ0PT THEN
      833     9842    2                  PP=B$IPHYMAP$->MM$IPHY_MAP(PP);
      834     9843             /* Map it on to SBUF2 so we have access to it */
      835     9844    2             CALL CVM;
      836     9845
      837     9846             /* If the page has been modified write it out */
      838     9847    2             IF B$MAP.CTRL(IPG) & %PGMOD
      839     9848    3             THEN DO;
      840     9849    3                  IF FRAGMENTED  /* Need to calculate VP and reset key_valid */
      841     9850    4                  THEN DO;
      842     9851    4                       I = VP - 128;
      843     9852    4                       B$FRAGHWRD = B$FRAGMAP.HWRD(I);
      844     9853    4                       NXTVP = B$FRAGHWRD.PAGE_KEY * 64 + I /4;
      845     9854    4                       CALL WRITE$PAGE(NXTVP) ALTRET(FM_ERROR);
      846     9855    4                     END;
      847     9856    3                  ELSE
      848     9857    3                       CALL WRITE$PAGE (VP) ALTRET (FM_ERROR);
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:77   
      849     9858    3                END;
      850     9859    2             IF FRAGMENTED
      851     9860    3             THEN DO;
      852     9861    3                  B$FRAGMAP.HWRD.KEY_VALID(VP - 128) = %FALSE;
      853     9862    3                  B$FRAGMAP.HWRD.KEY_VALID(PAGE_NO_ENTRY) = %TRUE;
      854     9863    3                  B$FRAGMAP.HWRD.PAGE_KEY(PAGE_NO_ENTRY) = EVPKEY.PAGE_KEY;
      855     9864    3                END;
      856     9865
      857     9866    2             BTEMP=B$MAP(IPG);
      858     9867    2             B$MAP(IPG)=MM_FPMC;
      859     9868    2             CALL FINDMAP(MAPVP);
      860     9869    2             B$MAP(IPG) = BTEMP;           /* Set up new ptw                     */
      861     9870    2             B$MAP.CTRL(IPG) = B$MAP.CTRL(IPG) & ~%PGMOD;
      862     9871    2             IF H_S1000_FLG THEN
      863     9872    2                  CALL HFC$ASSOCCLR(WSQ,IPG,1);
      864     9873    2             ELSE
      865     9874    2                  CALL HFC$ASSOCCLR;
      866     9875
      867     9876             /* Remove page from the tail and put it on the head if section*/
      868     9877             /* Remove page from the head and put it on the tail if frag or dense*/
      869     9878    3             IF SECTION THEN DO;
      870     9879    3                  MM$PPUT.PPNO(PP)=MM$VCB.HEAD;
      871     9880    3                  MM$VCB.HEAD=MAPVP;
      872     9881    3                  CALL FINDMAP(MM$VCB.TAIL);
      873     9882    3                  IF HW_WSQ0PT THEN
      874     9883    3                       MM$PPUT.PPNO(B$IPHYMAP$->MM$IPHY_MAP(B$MAP.RPN(IPG)))=BITBIN(
              9883                                '777777777'O);
      875     9884    3                  ELSE
      876     9885    3                       MM$PPUT.PPNO(B$MAP.RPN(IPG)) = BITBIN('777777777'O);
      877     9886    3                END;
      878     9887    3             ELSE DO;
      879     9888    3                  MM$VCB.HEAD = MM$PPUT.PPNO(PP);
      880     9889    3                  IF HW_WSQ0PT THEN
      881     9890    3                       MM$PPUT.PPNO(B$IPHYMAP$->MM$IPHY_MAP(B$MAP.RPN(MM$VCB.TAIL))) =
              9890                                MAPVP;
      882     9891    3                  ELSE
      883     9892    3                       MM$PPUT.PPNO(B$MAP.RPN(MM$VCB.TAIL)) = MAPVP;
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:78   
      884     9893    3                  MM$VCB.TAIL = MAPVP;
      885     9894    3                  MM$PPUT.PPNO(PP) = BITBIN('777777777'O);
      886     9895    3                END;
      887     9896
      888     9897             /* Read in new page if necessary */
      889     9898    2             IF NOT MM$VCB.CREATE OR EVP <= MM$VCB.MAXVP_WRITTEN
      890     9899    3             THEN DO;
      891     9900    3                  GOTO READ_PAGE;
      892     9901    3                END;
      893     9902
      894     9903    2             GOTO INIT_PAGE;
      895     9904
      896     9905    2           END;
      897     9906
      898     9907    1   FM_ERROR: ;
      899     9908    1        CALL UNCVM;
      900     9909             %ERRSETN (CODE=READ$PAGE$ERR.CODE);
      901     9912    1        CALL ABORTM(%SUBC_VIRTERR#);
      902     9913
      903     9914    1   CANT_GET1: ;                  /* Must reset the key valid bit if fragmented */
      904     9915    1        IF MM$VCB.PPC >= MM$VCB.PPMIN
      905     9916    1        THEN
      906     9917    1             GOTO REUSE_PAGE;
      907     9918    1   CANT_GET: ;
      908     9919             %ERRSETN(CODE=ERR);
      909     9922    1        CALL ABORTM(%SUBC_VIRTERR#);
      910     9923
      911     9924        %EJECT;
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:79   
      912     9925        /*F* NAME: MMV$CLOSE
      913     9926             PURPOSE: To write out all pages that have been modified and
      914     9927                      to release all memory for the large virtual segment.
      915     9928                        */
      916     9929    1   MMV$CLOSE: ENTRY ALTRET;
      917     9930
      918     9931    1        VCB$ = B$JIT.DCB$ -> F$DCB.SETSTA$;
      919     9932    1        STATS$ = B$JIT.DCB$ -> F$DCB.LASTSTA$;
      920     9933    1        TLNACC = MM$VCB.SEGNUM;
      921     9934    2        DO CASE (TLNACC);
      922     9935    2        CASE (%VS1#);
      923     9936    2           HDACC = %VS1PGTBL;
      924     9937    2           DCB# = B$JIT.VIRTUAL.DCB#(0);
      925     9938    2           SEGID = %VS1SID;
      926     9939    2        CASE (%VS2#);
      927     9940    2           HDACC = %VS2PGTBL;
      928     9941    2           DCB# = B$JIT.VIRTUAL.DCB#(1);
      929     9942    2           SEGID = %VS2SID;
      930     9943    2        CASE (%VS3#);
      931     9944    2           HDACC = %VS3PGTBL;
      932     9945    2           DCB# = B$JIT.VIRTUAL.DCB#(2);
      933     9946    2           SEGID = %VS3SID;
      934     9947    2        CASE (ELSE);
      935     9948    2           RETURN;
      936     9949    2        END;
      937     9950
      938     9951
      939     9952    1        WSQ = MM$VCB.WSQ;
      940     9953             %FINDMAP (WSQ=WSQ,P$=MAP$);
      941     9956    1        IF DCB# = 0                        /* HAVEN'T BEEN INITED YET*/
      942     9957    1        THEN
      943     9958    1             RETURN;
      944     9959
      945     9960        /* Set write flag if the file will be saved. */
      946     9961    1        IF B$JIT.DCB$->F$DCB.CFU$->FM$CFU.NAMEX ~= 0 OR B$JIT.JUNK & %JJ_MLINKIP#
      947     9962    1        THEN
      948     9963    1             WRITE_FLAG = '1'B;
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:80   
      949     9964    1        ELSE
      950     9965    1             WRITE_FLAG = '0'B;
      951     9966
      952     9967        /* Write out all pages that have %PGMOD set and then release them */
      953     9968
      954     9969    1        TEMP = MM$VCB.PPC;
      955     9970    1        VP = MM$VCB.HEAD;
      956     9971
      957     9972    2        DO I = 1 TO TEMP;
      958     9973    2             CALL FINDMAP(VP);
      959     9974    2             PP = B$MAP.RPN(IPG);
      960     9975    2             IF HW_WSQ0PT THEN
      961     9976    2                  PP=B$IPHYMAP$->MM$IPHY_MAP(PP);
      962     9977    2             NXTVP = MM$PPUT.PPNO(PP);
      963     9978    2             MM$VCB.HEAD = NXTVP;
      964     9979    2             MM$VCB.PPC = MM$VCB.PPC - 1;
      965     9980    2             IF B$MAP.CTRL(IPG) & %PGMOD AND WRITE_FLAG
      966     9981    3             THEN DO;
      967     9982    3                  CALL CVM;
      968     9983    3                  IF MM$VCB.T.FRAGMENTED   /* fragmented page table */
      969     9984    4                  THEN DO;
      970     9985    4                       EVP = VP-128;
      971     9986    4                       B$FRAGHWRD = B$FRAGMAP.HWRD(EVP);
      972     9987    4                       EVP = B$FRAGHWRD.PAGE_KEY * 64 + EVP/4;
      973     9988    4                       CALL WRITE$PAGE (EVP);
      974     9989    4                     END;
      975     9990    3                  ELSE
      976     9991    3                       CALL WRITE$PAGE(VP);
      977     9992    3                  CALL UNCVM;
      978     9993    3                END;
      979     9994    2             CALL MME$WFVP(WSQ,VP,,ERR) ALTRET(MM_ERROR);
      980     9995    2             VP = NXTVP;
      981     9996    2           END;
      982     9997
      983     9998        /* Now release the page table */
      984     9999    1        TEMP = BITBIN(SEGID & '1777'O);
      985    10000    1        IF NOT HW_IMX THEN
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:81   
      986    10001    1             B$USERLS$->MM$DESC.FLGS1.NOTEMPTY(TEMP)='0'B;
      987    10002    2        ELSE DO;
      988    10003    2             B$USERLS$->MM$SDESC.FLGS(TEMP) = '1'O ;
      989    10004    2           END;
      990    10005
      991    10006    1        IF MM$VCB.T.SECTION THEN
      992    10007    1             TEMP = MM$VCB.NPGTSECT - 1;
      993    10008    1        ELSE
      994    10009    1             TEMP=MM$VCB.NPGTPGS-1;
      995    10010    2        DO I = 0 TO TEMP;
      996    10011    2             CALL MME$RVNP(%USERWSQ,HDACC+I,PP,ERR) ALTRET (MM_ERROR);
      997    10012    2             IF TEMP = 0
      998    10013    2             THEN
      999    10014    2                  CALL MMB$FPP (PP);
     1000    10015    2             ELSE /* Release on tail to try and keep contiguous pages together */
     1001    10016    2                  CALL MMB$FPPONTAIL(PP);
     1002    10017    2           END;
     1003    10018    2        IF MM$VCB.T.SECTION THEN DO;
     1004    10019    2             TEMP=MM$VCB.NPGTPGS-1;
     1005    10020    3             DO I=0 TO TEMP;
     1006    10021    3                  CALL MME$RVNP(%USERWSQ,HDACC+MM$VCB.NPGTSECT+I,PP,ERR) ALTRET(
             10021                           MM_ERROR);
     1007    10022    3                  IF TEMP=0 THEN
     1008    10023    3                       CALL MMB$FPP(PP);
     1009    10024    3                  ELSE
     1010    10025    3                       CALL MMB$FPPONTAIL(PP);
     1011    10026    3                END;
     1012    10027    2           END;
     1013    10028
     1014    10029             /* Zero out DCB# in jit */
     1015    10030    1        B$JIT.VIRTUAL.DCB#(WSQ - %VS1WSQ) = 0;
     1016    10031             /* Zap any residue on AS */
     1017    10032    1        MAP$ = ADDR (B$USERHJIT$ -> MM$DESC(448));
     1018    10033    2        DO I = 448 TO 511;
     1019    10034    2             IF MAP$ -> MM$DESC.TYP (0) = 4
     1020    10035    3             THEN DO;
     1021    10036    4                  IF NOT HW_IMX THEN DO;
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:82   
     1022    10037    4                       IF MAP$ -> MM$DESC.SUPER.BASE (0) / 256 = TLNACC
     1023    10038    4                       THEN
     1024    10039    4                            MAP$ -> MM$DESC (0) = '0'B;
     1025    10040    4                     END;
     1026    10041    4                  ELSE DO;
     1027    10042    4                       IF MAP$ -> MM$SDESC.WSN(0) - %USERWSQ = TLNACC
     1028    10043    4                       THEN
     1029    10044    4                            MAP$ -> MM$DESC (0) = '0'B;
     1030    10045    4                     END;
     1031    10046    3                END;
     1032    10047    2             MAP$ = PINCRW (MAP$,2);
     1033    10048    2           END;
     1034    10049
     1035    10050             /* Altreturn if some error was encountered */
     1036    10051    1        IF B$JIT.ERR.CODE = 0
     1037    10052    1        THEN RETURN;
     1038    10053    1        ELSE ALTRETURN;
     1039    10054
     1040    10055    1   MM_ERROR: ;
     1041    10056    1        CALL SC_MM47;                      /* Some error was encountered  */
     1042    10057    1        ALTRETURN;
     1043    10058
     1044    10059        %EJECT;
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:83   
     1045    10060    1   MMV$TRUNC: ENTRY (EWSQ) ALTRET;
     1046    10061
     1047    10062    1        WSQ = EWSQ;
     1048    10063        /* Set up pointer to dcb for this virtual area */
     1049    10064    1        DCB# = B$JIT.VIRTUAL.DCB# (WSQ - %VS1WSQ);
     1050    10065    1        IF DCB# = 0
     1051    10066    2        THEN DO;
     1052    10067    2             ALTRETURN;
     1053    10068    2           END;
     1054    10069    1        VCB$ = DCBADDR(DCB#) -> F$DCB.SETSTA$;
     1055    10070    1        STATS$ = DCBADDR(DCB#) -> F$DCB.LASTSTA$;
     1056    10071
     1057    10072    1        IF WSQ ~= MM$VCB.WSQ               /* WSQ does not match */
     1058    10073    2        THEN DO;
     1059    10074    2             CALL SC_MM47;
     1060    10075    2             ALTRETURN;
     1061    10076    2           END;
     1062    10077
     1063    10078    1        IF MM$VCB.PPC <= MM$VCB.PPMIN
     1064    10079    1        THEN
     1065    10080    1             ALTRETURN;
     1066    10081
     1067    10082
     1068    10083        /* Write out all pages that have %PGMOD set and then release them */
     1069    10084
     1070    10085    1        TEMP = MM$VCB.PPC;
     1071    10086    1        VP = MM$VCB.HEAD;
     1072    10087    1        SKIP_COUNT = MM$VCB.PPMIN;
     1073    10088    1        SECTION = MM$VCB.T.SECTION;
     1074    10089    2        DO WHILE (MM$VCB.PPC > MM$VCB.PPMIN);
     1075    10090    2             CALL FINDMAP(VP);
     1076    10091    2             PP = B$MAP.RPN(IPG);
     1077    10092    2             IF HW_WSQ0PT THEN
     1078    10093    2                  PP=B$IPHYMAP$->MM$IPHY_MAP(PP);
     1079    10094    2             NXTVP = MM$PPUT.PPNO(PP);
     1080    10095    3             IF SECTION AND SKIP_COUNT > 0 THEN DO;
     1081    10096    3                  SKIP_COUNT = SKIP_COUNT - 1;
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:84   
     1082    10097    3                  SAVE_VP = VP;
     1083    10098    3                END;
     1084    10099    3             ELSE DO;
     1085    10100    3                  IF NOT SECTION THEN
     1086    10101    3                       MM$VCB.HEAD = NXTVP;
     1087    10102    3                  MM$VCB.PPC = MM$VCB.PPC - 1;
     1088    10103    3                  IF B$MAP.CTRL(IPG) & %PGMOD
     1089    10104    4                  THEN DO;
     1090    10105    4                       CALL CVM;
     1091    10106    4                       IF MM$VCB.T.FRAGMENTED /* fragmented page table */
     1092    10107    5                       THEN DO;
     1093    10108    5                            B$FRAGHWRD = B$FRAGMAP.HWRD(VP-128);
     1094    10109    5                            EVP = B$FRAGHWRD.PAGE_KEY * 64 + VP/4 - 32;
     1095    10110    5                            CALL WRITE$PAGE (EVP);
     1096    10111    5                          END;
     1097    10112    4                       ELSE
     1098    10113    4                            CALL WRITE$PAGE(VP) ;
     1099    10114    4                       CALL UNCVM;
     1100    10115    4                     END;
     1101    10116    3                  IF MM$VCB.T.FRAGMENTED
     1102    10117    3                  THEN
     1103    10118    3                       B$FRAGMAP.HWRD.KEY_VALID(VP - 128) = %FALSE;
     1104    10119    3                  CALL MME$WFVP(WSQ,VP,,ERR) ALTRET(MM_ERROR);
     1105    10120    3                END;
     1106    10121    2             VP = NXTVP;
     1107    10122    2           END;
     1108    10123    2        IF SECTION THEN DO;
     1109    10124    2             CALL FINDMAP(SAVE_VP);
     1110    10125    2             PP= B$MAP.RPN(IPG);
     1111    10126    2             IF HW_WSQ0PT THEN
     1112    10127    2                  PP = B$IPHYMAP$->MM$IPHY_MAP(PP);
     1113    10128    2             MM$PPUT.PPNO(PP) = BITBIN('777777777'O);
     1114    10129    2             MM$VCB.TAIL = SAVE_VP;
     1115    10130    2           END;
     1116    10131
     1117    10132
     1118    10133        /* Count up truncs */
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:85   
     1119    10134    1        MM$VIRTUAL_STATS.TRUNCS# = MM$VIRTUAL_STATS.TRUNCS# + 1;
     1120    10135    1        RETURN;
     1121    10136
     1122    10137        %EJECT;
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:86   
     1123    10138    1   SPACEM:;
     1124    10139    2        IF MM$VCB.UPGT# <MM$VCB.NPGTPGS THEN DO;
             10139                 /* There is an available page for a  page table */
     1125    10140    2             B$SECT.PTBASE(EVPSECT.SECT#)=B$UPT$->B$NMAP.RPN(%VS1PGTBL+
     1126    10141    2                  16*(WSQ-%VS1WSQ)+MM$VCB.NPGTSECT+MM$VCB.UPGT#);
     1127    10142    2             MM$VCB.UPGT#=MM$VCB.UPGT#+1;
     1128    10143    2           END;
     1129    10144    2        ELSE DO;
     1130    10145    2             IF UPD_CHAIN_FLG = %FALSE THEN
     1131    10146    2                  CALL UPD_SECT_CHAIN;
     1132    10147        /*   There are no available page table pages, so we have to reuse one */
     1133    10148    2             IF SCT_USED < MM$VCB.NPGTPGS -1 THEN
     1134    10149    2                  CALL REUSE_INACTIVE_PT;
     1135    10150    2             ELSE
     1136    10151    2                  CALL REUSE_ACTIVE_PT;
     1137    10152    2           END;
     1138    10153    1        GOTO GT_DATAPAG;
     1139    10154        /* Some internal subroutines */
     1140    10155    1   CVM: PROC ALTRET;
     1141    10156    2        CALL MME$CVM(%USERWSQ,%SBUF2PG,PP,ERR) ALTRET(MM_SCR);
     1142    10157    2        RETURN;
     1143    10158    2   UNCVM: ENTRY ALTRET;
     1144    10159    2        CALL MME$CVM(%USERWSQ,%SBUF2PG,-1,ERR) ALTRET(MM_SCR);
     1145    10160    2        RETURN;
     1146    10161    2   MM_SCR: CALL SC_MM47;
     1147    10162    2        ALTRETURN;
     1148    10163    2   TRUNCPG: ENTRY ALTRET;
     1149    10164
     1150    10165
     1151    10166    2   END CVM;
     1152    10167        %EJECT;
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:87   
     1153    10168    1   MMV$CVM: ENTRY(EWSQ,EVPAGE,PPNO) ALTRET;
     1154    10169
     1155    10170    1        WSQ = EWSQ;
     1156    10171    1        EVP_PAGE_NO_ENTRY = EVPKEY.PAGE_NO_ENTRY;
     1157    10172             %FINDMAP (WSQ=WSQ,P$=MAP$);
     1158    10175    1        DCB# = B$JIT.VIRTUAL.DCB#(WSQ-%VS1WSQ);
     1159    10176    1        VCB$ = DCBADDR(DCB#) -> F$DCB.SETSTA$;
     1160    10177    1        STATS$ = DCBADDR(DCB#) -> F$DCB.LASTSTA$;
     1161    10178
     1162    10179    1        IF MM$VCB.T.FRAGMENTED
     1163    10180    2        THEN DO;
     1164    10181    2             PAGE_NO_ENTRY = EVP_PAGE_NO_ENTRY * 4;
     1165    10182    3             DO I = 0 TO 3;
     1166    10183    3                  IF NOT B$FRAGMAP.HWRD.KEY_VALID (PAGE_NO_ENTRY)
     1167    10184    3                  THEN
     1168    10185    3                       GOTO GOTSLOT;
     1169    10186    3                  PAGE_NO_ENTRY = PAGE_NO_ENTRY + 1;
     1170    10187    3                END;
     1171    10188    2             B$JIT.ERR = PGINUSE;
     1172    10189        /*E* ERROR:         MMV-E$PGINUSE-0
     1173    10190        MESSAGE:       All pages in use for fragmented page table (M$CVM).
     1174    10191                            */
     1175    10192    2             RETURN;
     1176    10193
     1177    10194    2   GOTSLOT:  MAPVP = PAGE_NO_ENTRY + 128;
     1178    10195    2           END;
     1179    10196    1        ELSE
     1180    10197    1             MAPVP = EVP;
     1181    10198
     1182    10199    1        CALL MME$CVM (WSQ,EVP,PPNO,ERR)
     1183    10200    2        WHENALTRETURN DO;
     1184    10201    2             ALTRETURN;
     1185    10202    2           END;
     1186    10203    1        IF MM$VCB.T.FRAGMENTED
     1187    10204    2        THEN DO;
     1188    10205    2             B$FRAGMAP.HWRD.KEY_VALID(PAGE_NO_ENTRY) = (PPNO >= 0);
     1189    10206    2             B$FRAGMAP.HWRD.PAGE_KEY(PAGE_NO_ENTRY) = EVPKEY.PAGE_KEY;
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:88   
     1190    10207    2           END;
     1191    10208    1        RETURN;
     1192    10209
     1193    10210        %EJECT;
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:89   
     1194    10211        /* Handle M$FVP */
     1195    10212    1   MMV$RLS: ENTRY(EWSQ,EVPAGE) ALTRET;
     1196    10213
     1197    10214    1        CALL TRUNCPG;
     1198    10215    1        RETURN;
     1199    10216
     1200    10217        %EJECT;
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:90   
     1201    10218    1   READ$PAGE: PROC (VPAGE) ALTRET;
     1202    10219        /* Internal procedure to read the page into the given virtual page */
     1203    10220
     1204    10221        /* Parameters */
     1205    10222    2   DCL VPAGE UBIN;                         /* Virtual page to be read in         */
     1206    10223
     1207    10224        /* Auto */
     1208    10225    2   DCL RW EPTR;
     1209    10226    2   DCL SAVEDCB$ PTR;
     1210    10227    2   DCL   SAVEDCBNO UBIN WORD;
     1211    10228    2   DCL 1 SAVEERR,
     1212    10229    2            2 FCG BIT(12),
     1213    10230    2            2 MID BIT(6),
     1214    10231    2            2 MON BIT(1),
     1215    10232    2            2 CODE UBIN(14) UNAL,
     1216    10233    2            2 SEV UBIN(3) UNAL;
     1217    10234    2   DCL 1 KEY ALIGNED,
     1218    10235    2            2 SIZE UBIN(9) CALIGNED,
     1219    10236    2            2 VP# UBIN(27) CALIGNED;
     1220    10237
     1221    10238        /* Count up file reads */
     1222    10239    2        MM$VIRTUAL_STATS.READS# = MM$VIRTUAL_STATS.READS# + 1;
     1223    10240    2        READ_PAGE = READ_PAGEC;            /* Initialize                         */
     1224    10241    2        RW = ENTADDR (M$MREAD);
     1225    10242    2   RWPAGE: IF MM$VCB.NOFILE
     1226    10243    2        THEN
     1227    10244    2             RETURN;
     1228    10245    2        SAVEDCB$ = B$JIT.DCB$;
     1229    10246    2        SAVEDCBNO = B$JIT.DCBNO;
     1230    10247    2        SAVEERR = B$JIT.ERR;
     1231    10248    2        KEY.SIZE = SIZEC(KEY.VP#);
     1232    10249    2        KEY.VP# = VPAGE;
     1233    10250
     1234    10251        /* Setup fpt for the read */
     1235    10252    2        READ_PAGE.V.DCB# = DCB#;
     1236    10253    2        READ_PAGE.V_ = VECTOR(READ_PAGE.V);
     1237    10254    2        READ_PAGE.KEY_ = VECTOR(KEY);
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:91   
     1238    10255    2        READ_PAGE.BUF_.BUF$ = B$SBUF2$;
     1239    10256    2        READ_PAGE.BUF_.BOUND = 4095;       /* One page worth                     */
     1240    10257    2        CALL RW (READ_PAGE) ALTRET (READ_ERROR);
     1241    10258    2        IF VPAGE > MM$VCB.MAXVP_WRITTEN
     1242    10259    2        THEN
     1243    10260    2             MM$VCB.MAXVP_WRITTEN = VPAGE;
     1244    10261
     1245    10262        /* Check to see if the upper level should be built */
     1246    10263    2        B$JIT.DCB$ = DCBADDR(DCB#);
     1247    10264    2        IF B$JIT.DCB$->F$DCB.RDL0 > B$JIT.DCB$->F$DCB.LRDL0
     1248    10265    3        THEN DO;
     1249    10266    3             CALL FMU$BLD;
     1250    10267    3             B$JIT.DCB$->F$DCB.RDL0 = 0;
     1251    10268    3             B$JIT.DCB$->F$DCB.CFU$->FM$CFU.FUN = MOD(B$JIT.DCB$->F$DCB.CFU$->FM$CFU.
             10268                      FUN,4);
     1252    10269    3           END;
     1253    10270
     1254    10271    2        B$JIT.DCB$ = SAVEDCB$;
     1255    10272    2        B$JIT.DCBNO = SAVEDCBNO;
     1256    10273    2        READ$PAGE$ERR = B$JIT.ERR;
     1257    10274    2        B$JIT.ERR = SAVEERR;
     1258    10275    2        RETURN;
     1259    10276
     1260    10277    2   READ_ERROR: ;
     1261    10278    2        B$JIT.DCB$ = SAVEDCB$;
     1262    10279    2        B$JIT.DCBNO = SAVEDCBNO;
     1263    10280    2        READ$PAGE$ERR = B$JIT.ERR;
     1264    10281    2        B$JIT.ERR = SAVEERR;
     1265    10282    2        ALTRETURN;
     1266    10283
     1267    10284    2   WRITE$PAGE: ENTRY (VPAGE) ALTRET;
     1268    10285        /* Internal procedure to read the page into the given virtual page */
     1269    10286
     1270    10287        /* Count up file writes */
     1271    10288    2        MM$VIRTUAL_STATS.WRITES# = MM$VIRTUAL_STATS.WRITES# + 1;
     1272    10289
     1273    10290        /* Setup fpt for the write */
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:92   
     1274    10291    2        READ_PAGE = WRITE_PAGEC;           /* Initialize                         */
     1275    10292    2        RW = ENTADDR (M$MWRITE);
     1276    10293    2        GOTO RWPAGE;
     1277    10294    2   END READ$PAGE;
     1278    10295        %EJECT;
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:93   
     1279    10296    1   INIT$PAGE: PROC;                   /* Initialize a page to the given value */
     1280    10297
     1281    10298    2   DCL 1 B$SHORT_PAGE BASED DALIGNED,      /* Page for move */
     1282    10299    2            2 * (0:1015) UBIN;
     1283    10300
     1284    10301    2        TEMP = 23085;                      /* .000000055055 (  --) */
     1285    10302    2        IF MM$VCB.INITIALIZE
     1286    10303    2        THEN
     1287    10304    2             TEMP = MM$VCB.INITVALUE;
     1288    10305    2   INITPAGE1: ENTRY;
     1289    10306    2        B$SBUF2$->B$PAGE.WRD(0) = TEMP;
     1290    10307    2        B$SBUF2$->B$PAGE.WRD(1) = TEMP;
     1291    10308    2        B$SBUF2$->B$PAGE.WRD(2) = TEMP;
     1292    10309    2        B$SBUF2$->B$PAGE.WRD(3) = TEMP;
     1293    10310    2        B$SBUF2$->B$PAGE.WRD(4) = TEMP;
     1294    10311    2        B$SBUF2$->B$PAGE.WRD(5) = TEMP;
     1295    10312    2        B$SBUF2$->B$PAGE.WRD(6) = TEMP;
     1296    10313    2        B$SBUF2$->B$PAGE.WRD(7) = TEMP;
     1297    10314
     1298    10315        /* Overlap the move to initialize the rest of the page */
     1299    10316    2        PINCRW(B$SBUF2$,8)->B$SHORT_PAGE = B$SBUF2$->B$SHORT_PAGE;
     1300    10317    2        RETURN;
     1301    10318
     1302    10319    2   END INIT$PAGE;
     1303    10320        %EJECT;
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:94   
     1304    10321    1   ABORTM:PROC (SUBC);
     1305    10322
     1306    10323    2   DCL SUBC UBIN;
     1307    10324    2        FINFO = '0'B;
     1308    10325    2        FINFO.SUBC=SUBC;
     1309    10326    2        FINFO.ERR = B$JIT.ERR;
     1310    10327    2        FINFO.P# = 0;
     1311    10328    2        IF SS$->B$SS.ISR.WSR ~= %USERWSR THEN
     1312    10329    2             CALL MMA$POPSSF;
     1313    10330    2        IF B_MPT.ECCBDESC$->B$$DESCR.FLGS & %DSXXX
     1314    10331                                                /* If a user running under DELTA      */
     1315    10332    2             OR (    (SS$->B$SS.ISR.WSR = %ASLWSR)
     1316    10333    2             AND (B$JIT.JUNK2 & %JJ2_DBRK#) )
     1317    10334    3        THEN DO;
     1318    10335    3             CALL SSU$DELTAGO(%ECC_ERROR#,FINFO,0);
     1319    10336    3             RETURN;
     1320    10337    3           END;
     1321    10338    2        ELSE IF ((SUBC = %SUBC_VIRTERR# AND ECCB$->B$ECCB.FLTFLG.HDWR) OR
     1322    10339    2                  (SUBC = %SUBC_MEMORY# AND ECCB$->B$ECCB.FLTFLG.MEM) )
     1323    10340    2                  AND ECCB$->B$ECCB.FLAGS.ERRSET
     1324    10341    3             THEN DO;
     1325    10342    3                  CALL SST$SSFTCB(ECCB$->B$ECCB.ERR,%ECC_ERROR#,FINFO,SS$,TCB$) ALTRET(
             10342                           TCB_FULL);
     1326    10343    3                  CALL SSS$SEXIT;
     1327    10344    3                  RETURN;
     1328    10345    3                END;
     1329    10346        /* FAULTING DOMAIN NOT TO GET CONTROL */
     1330    10347    2   TCB_FULL: ;
     1331    10348    2        CALL JSE$ABORTM;
     1332    10349    2   END ABORTM;
     1333    10350        %EJECT;
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:95   
     1334    10351    1   FINDMAP: PROC(VA);
     1335    10352        /* This program will return a pointer to the page
     1336    10353           table in MAP$ and an index into it in IPG. This subroutine
     1337    10354           wil set WS_FLT to TRUE when using section PT and the Page table
     1338    10355           for the section is set to MM_SCTDFT   */
     1339    10356    2   DCL 1 VA ALIGNED,
     1340    10357    2            2 * BIT(14),
     1341    10358    2            2 SECT# UBIN(12) UNAL,
     1342    10359    2            2 PG# UBIN(10) UNAL;
     1343    10360        /**/
     1344    10361             %FINDMAP (WSQ=WSQ,P$=MAP$); /* get pointer to the section or page table */
     1345    10364    3        IF MM$VCB.T.SECTION THEN DO;       /* Section page table */
     1346    10365    3             SECT$=MAP$;
     1347    10366    4             IF B$SECT.PTBASE(VA.SECT#)~=MM_SCTDFT THEN DO;
     1348    10367    4                  PTBASE=B$SECT.PTBASE(VA.SECT#);
     1349    10368    5                  DO MAP_INDEX = MM$VCB.NPGTSECT TO MM$VCB.NPGTSECT+MM$VCB.NPGTPGS -1;
     1350    10369    5                       IF PTBASE = B$UPT$->B$NMAP.RPN(%VS1PGTBL+ 16 * (WSQ-
     1351    10370    5                            %VS1WSQ) + MAP_INDEX) THEN GOTO FOUND_PTBASE;
     1352    10371    5                     END;
     1353    10372    4                  CALL SC_MM47;
     1354    10373    4   FOUND_PTBASE:
     1355    10374    4                  MAP_PTR.WOFFS = MAP_PTR.WOFFS + MAP_INDEX * 1024;
     1356    10375    4                END;
     1357    10376    3             ELSE
     1358    10377    3                  WS_FLT = %TRUE;
     1359    10378    3             IPG=VA.PG#;
     1360    10379    3             SCT# = VA.SECT#;
     1361    10380    3           END;
     1362    10381    2        ELSE IPG=BITBIN(VA);
     1363    10382    2        RETURN;
     1364    10383    2   END FINDMAP;
     1365    10384        %EJECT;
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:96   
     1366    10385    1   UPD_SECT_CHAIN :PROC;
     1367    10386        /* This program will take a trip through the page chain,
     1368    10387           producing two chains: accessed and not accessed, which
     1369    10388           will be linked together at the end. SCT PT chain is linked
     1370    10389           with most recently accessed pages at the head and the least
     1371    10390           recently accessed pages at the tail.  The chain is setup up
     1372    10391           this way so when we go the reuse a Page table we can guarantee
     1373    10392           that the Page table with the least recently accessed pages is
     1374    10393           the page table to be re-used. This routine is called if we
     1375    10394            need to re-use a page or re-use a page table.  Note PREDT is
     1376    10395            set to make to next to last VP in the chain.    */
     1377    10396
     1378    10397    2        SCT_USED = -1;
     1379    10398    2        PT = '0'B;
     1380    10399    2        TEMP=MM$VCB.PPC;
     1381    10400    2        HDACC=-1;                          /* Head of accessed chain */
     1382    10401    2        TLACC=-1;                          /* Tail of accessed chain */
     1383    10402    2        HDNACC=-1;                         /* Head of not accessed chain */
     1384    10403    2        TLNACC=-1;                         /* Tail of not accessed chain */
     1385    10404    2        PREDTN = -1;
     1386    10405    2        NXTVP=MM$VCB.HEAD;
     1387    10406    3        DO I=1 TO TEMP;
     1388    10407    3             CALL FINDMAP(NXTVP);
     1389    10408    3             NXTPP=B$MAP.RPN(IPG);
     1390    10409    4             DO J = 0 TO SCT_USED;
     1391    10410    4                  IF PT(J) = SCT# THEN GOTO END_SCT_LOOP;
     1392    10411    4                END;
     1393    10412    3             SCT_USED = SCT_USED +1;
     1394    10413    3             IF SCT_USED >= MM$VCB.NPGTPGS THEN
     1395    10414    3                  CALL SC_MM47;
     1396    10415    3             PT(SCT_USED) = SCT# ;
     1397    10416    3   END_SCT_LOOP:
     1398    10417    3             IF HW_WSQ0PT THEN
     1399    10418    3                  NXTPP=B$IPHYMAP$->MM$IPHY_MAP(NXTPP);
     1400    10419
     1401    10420    3             IF B$MAP.CTRL(IPG) & %PGACC   /* Page has been accessed */
     1402    10421    4             THEN DO;
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:97   
     1403    10422    4   ACCESSED:
     1404    10423    4                  B$MAP.CTRL(IPG) = B$MAP.CTRL(IPG) & ~%PGACC;
     1405    10424    4                  IF HDACC < 0 THEN
     1406    10425    4                       HDACC = NXTVP;
     1407    10426    5                  ELSE DO;
     1408    10427    5                       MM$PPUT.PPNO (ACTLPP) = NXTVP;
     1409    10428    5                       PREDTA = TLACC;     /* Tail predecessor */
     1410    10429    5                     END;
     1411    10430    4                  TLACC=NXTVP ;            /* Tail  */
     1412    10431    4                  ACTLPP=NXTPP;
     1413    10432    4                END;
     1414    10433    4             ELSE DO;
     1415    10434    4   NOTACC:
     1416    10435    4                  IF HDNACC<0 THEN
     1417    10436    4                       HDNACC=NXTVP;
     1418    10437    5                  ELSE DO;
     1419    10438    5                       MM$PPUT.PPNO(NACTLPP)=NXTVP;
     1420    10439    5                       PREDTN = TLNACC;
     1421    10440    5                     END;
     1422    10441    4                  TLNACC=NXTVP;
     1423    10442    4                  NACTLPP=NXTPP;
     1424    10443    4                END;
     1425    10444    3             NXTVP=MM$PPUT.PPNO(NXTPP);
     1426    10445    3           END;                            /* DO I=  */
     1427    10446    2        IF NXTVP~=BITBIN('777777777'O) THEN
     1428    10447    2             CALL SC_MM47;
     1429    10448    3        IF HDACC>=0 THEN DO;
     1430    10449    3             MM$VCB.HEAD=HDACC;
     1431    10450    4             IF HDNACC<0 THEN DO;
     1432    10451    4                  MM$VCB.TAIL=TLACC;
     1433    10452    4                  MM$PPUT.PPNO(ACTLPP)=BITBIN('777777777'O);
     1434    10453    4                  PREDT=PREDTA;
     1435    10454    4                END;
     1436    10455    4             ELSE DO;
     1437    10456    4                  MM$PPUT.PPNO(ACTLPP)=HDNACC;
     1438    10457    4                  MM$VCB.TAIL=TLNACC;
     1439    10458    4                  MM$PPUT.PPNO(NACTLPP)=BITBIN('777777777'O);
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:98   
     1440    10459    4                  IF PREDTN = -1 THEN PREDT = TLACC;
     1441    10460    4                  ELSE PREDT=PREDTN;
     1442    10461    4                END;
     1443    10462    3           END;
     1444    10463    3        ELSE DO;                           /* No accessed pages */
     1445    10464    3             MM$VCB.HEAD=HDNACC;
     1446    10465    3             MM$VCB.TAIL=TLNACC;
     1447    10466    3             MM$PPUT.PPNO(NACTLPP)=BITBIN('777777777'O);
     1448    10467    3             PREDT=PREDTN;
     1449    10468    3           END;
     1450    10469    2        UPD_CHAIN_FLG=%TRUE;
     1451    10470    2        RETURN;
     1452    10471    2   END UPD_SECT_CHAIN;
     1453    10472        %EJECT;
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:99   
     1454    10473    1   UPD_FRAG_DENSE_CHAIN :PROC;
     1455    10474        /* This subroutine will take a trip through the page chain,
     1456    10475           producing two chains: accessed and not accessed, which
     1457    10476           will be linked together at the end. The resulting chain
     1458    10477           will be linked with the least recently accessed VP at the
     1459    10478           head of the chain and the most recently accessed VP at the
     1460    10479           tail of the chain.  If using fragmented PT and an entry
     1461    10480           needs to be re-used (PAGE_NO_ENTRY eq -1) PAGE_NO_ENTRY will be
     1462    10481           set to the entry to re-use.  */
     1463    10482    2        TEMP=MM$VCB.PPC;
     1464    10483    2        HDACC=-1;                          /* Head of accessed chain */
     1465    10484    2        NXTVP=MM$VCB.HEAD;
     1466    10485    2        MM$VCB.HEAD = -1;
     1467    10486    3        DO I=1 TO TEMP;
     1468    10487    3             NXTPP=B$MAP.RPN(NXTVP);
     1469    10488    3             IF HW_WSQ0PT THEN
     1470    10489    3                  NXTPP=B$IPHYMAP$->MM$IPHY_MAP(NXTPP);
     1471    10490    3             IF FRAGMENTED THEN            /* Save oldest PAGE_NO_ENTRY */
     1472    10491    3                  IF PAGE_NO_ENTRY < 0 AND (NXTVP - 128)/4 = EVP_PAGE_NO_ENTRY
     1473    10492    4                  THEN DO;
     1474    10493    4                       PAGE_NO_ENTRY = NXTVP - 128;
     1475    10494    4                       GOTO ACCESSED;
     1476    10495    4                     END;
     1477    10496
     1478    10497    3             IF B$MAP.CTRL(NXTVP) & %PGACC /* Page has been accessed */
     1479    10498    4             THEN DO;
     1480    10499    4   ACCESSED:      B$MAP.CTRL(NXTVP) = B$MAP.CTRL(NXTVP) & ~%PGACC;
     1481    10500    4                  IF HDACC < 0 THEN
     1482    10501    4                       HDACC = NXTVP;
     1483    10502    4                  ELSE
     1484    10503    4                       MM$PPUT.PPNO (ACTLPP) = NXTVP;
     1485    10504    4                  MM$VCB.TAIL = NXTVP;
     1486    10505    4                  ACTLPP=NXTPP;
     1487    10506    4                END;
     1488    10507    4             ELSE DO;
     1489    10508    4   NOTACC:        IF MM$VCB.HEAD < 0 THEN
     1490    10509    4                       MM$VCB.HEAD = NXTVP;
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:100  
     1491    10510    4                  ELSE
     1492    10511    4                       MM$PPUT.PPNO(NACTLPP)=NXTVP;
     1493    10512    4                  TLNACC=NXTVP;
     1494    10513    4                  NACTLPP=NXTPP;
     1495    10514    4                END;
     1496    10515    3             NXTVP=MM$PPUT.PPNO(NXTPP);
     1497    10516    3           END;                            /* DO I=  */
     1498    10517    2        IF NXTVP~=BITBIN('777777777'O) THEN
     1499    10518    2             CALL SC_MM47;
     1500    10519    2        IF HDACC >= 0 THEN
     1501    10520    2             MM$PPUT.PPNO(ACTLPP) = BITBIN('777777777'O);
     1502    10521    2        IF MM$VCB.HEAD < 0 THEN
     1503    10522    2             MM$VCB.HEAD=HDACC;
     1504    10523    2        ELSE
     1505    10524    2             MM$PPUT.PPNO(NACTLPP) = HDACC;
     1506    10525    2        UPD_CHAIN_FLG=%TRUE;
     1507    10526    2        RETURN;
     1508    10527    2   END UPD_FRAG_DENSE_CHAIN;
     1509    10528
     1510    10529        %EJECT;
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:101  
     1511    10530    1   REUSE_INACTIVE_PT: PROC;
     1512    10531
     1513    10532    3        DO I=0 TO MM$VCB.WSPTD.NBLKS*64-1; /* Find out what page tables
     1514    10533        exist */
     1515    10534    3             IF B$SECT.PTBASE(I) ~= MM_SCTDFT
     1516    10535    4             THEN DO;
     1517    10536    5                  DO J = 0 TO SCT_USED;
     1518    10537    5                       IF I = PT(J) THEN GOTO PAGE_USED;
     1519    10538    5                     END;
     1520    10539    4                  PTBASE = B$SECT.PTBASE(I);
     1521    10540    4                  B$SECT(EVPSECT.SECT#) = B$SECT(I);
     1522    10541    4                  B$SECT.PTBASE(I) = MM_SCTDFT;
     1523    10542    4                  RETURN;
     1524    10543    4                END;
     1525    10544    3   PAGE_USED:
     1526    10545    3           END;
     1527    10546    2        CALL SC_MM47;
     1528    10547    2   END REUSE_INACTIVE_PT;
     1529    10548        %EJECT;
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:102  
     1530    10549    1   REUSE_ACTIVE_PT: PROC;
     1531    10550
     1532    10551    2        TEMP=0;                            /* Index in the PT array */
     1533    10552        /* Follow the page chain and find %MM_MAXPTENTS - MM$VCB.NPGTSECT-1  hits */
     1534    10553        /* the MM_MAXPGENTS - MM$VCB.NPGTSECT page table is going to be replaced */
     1535    10554    2        J=1;
     1536    10555    2        NXTVP=MM$VCB.HEAD;
     1537    10556    2        VP=NXTVP;
     1538    10557    2        I=0;
     1539    10558    3        DO UNTIL I=%MM_MAXPTENTS - MM$VCB.NPGTSECT - 1;
             10558                 /* I is used to count the hits */
     1540    10559    3             PREDT=VP;
     1541    10560    3             VP=NXTVP;
     1542    10561    4             DO TEMP=0 TO %MM_MAXPTENTS - MM$VCB.NPGTSECT- 1;
     1543    10562    5                  IF PT(TEMP)=VPSECT.SECT# THEN DO;
     1544    10563    5                       PT(TEMP)=-1;
     1545    10564    5                       I=I+1;
     1546    10565    5                     END;
     1547    10566    4                END;                       /* DO TEMP= */
     1548    10567    3             CALL FINDMAP(VP);
     1549    10568    3             IF HW_WSQ0PT THEN
     1550    10569    3                  NXTVP = MM$PPUT.PPNO(B$IPHYMAP$->MM$IPHY_MAP(B$MAP.RPN(IPG)));
     1551    10570    3             ELSE
     1552    10571    3                  NXTVP=MM$PPUT.PPNO(B$MAP.RPN(IPG));
     1553    10572    3             IF NXTVP=MM$VCB.TAIL THEN
     1554    10573    3                  CALL SC_MM47;
     1555    10574    3             J=J+1;
     1556    10575    3           END;                            /* DO UNTIL */
     1557    10576        /* At this point only one PT entry contains a value~=-1 */
     1558    10577        /* and this is the SECT# that we are going to replace */
     1559    10578    3        DO I=0 TO %MM_MAXPTENTS - MM$VCB.NPGTSECT- 1;
     1560    10579    3             IF PT(I)~=-1 THEN GOTO UNUSED_PT;
     1561    10580    3           END;
     1562    10581    2   UNUSED_PT:
     1563    10582    2        PTBASE = B$SECT.PTBASE(PT(I));
     1564    10583    3        DO K = MM$VCB.NPGTSECT TO MM$VCB.NPGTSECT+MM$VCB.NPGTPGS -1;
     1565    10584    3             IF PTBASE = B$UPT$->B$NMAP.RPN(%VS1PGTBL+ 16 * (WSQ-
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:103  
     1566    10585    3                  %VS1WSQ) + K) THEN GOTO FOUND_PTBASE;
     1567    10586    3           END;
     1568    10587    2        CALL SC_MM47;
     1569    10588    2   FOUND_PTBASE:
     1570    10589    2        UNMAP$ = SECT$;
     1571    10590    2        UNMAP_PTR.WOFFS = UNMAP_PTR.WOFFS + K * 1024;
     1572    10591    2        TEMP=MM$VCB.PPC;
     1573    10592    3        DO J=J TO TEMP;
     1574    10593    3             CALL FINDMAP(NXTVP);
     1575    10594    3             NXTPP=B$MAP.RPN(IPG);
     1576    10595    3             IF HW_WSQ0PT THEN
     1577    10596    3                  NXTPP=B$IPHYMAP$->MM$IPHY_MAP(NXTPP);
     1578    10597    4             IF NXTVPSECT.SECT#=PT(I) THEN DO; /* The page is mapped
     1579    10598           into the PT to be reused, so we have to get rid of it */
     1580    10599    4                  IF NOT (UNMAP$->B$NMAP.CTRL(NXTVPSECT.PG#) & %PGINMEM)
     1581    10600    4                  THEN CALL SC_MM47;
     1582    10601    5                  IF UNMAP$->B$NMAP.CTRL(NXTVPSECT.PG#) & %PGMOD THEN DO;
     1583    10602          /* We have to write the page on disk */
     1584    10603    5                       PP=NXTPP;
     1585    10604    5                       CALL CVM;
     1586    10605    5                       CALL WRITE$PAGE(NXTVP);
     1587    10606    5                     END;
     1588    10607        /*  Give the page back */
     1589    10608    4                  SAVE_PPUT = MM$PPUT(NXTPP);
     1590    10609    5                  CALL MME$WFVP(WSQ,NXTVP,,ERR) WHENALTRETURN DO;
     1591    10610    5                       CALL SC_MM47;
     1592    10611    5                     END;
     1593    10612    4                  MM$VCB.PPC=MM$VCB.PPC-1;
     1594    10613        /* Take the page out from the chain */
     1595    10614    4                  CALL FINDMAP(VP);        /* The previous page in the chain */
     1596    10615    4                  PP=B$MAP.RPN(IPG);
     1597    10616    4                  IF HW_WSQ0PT THEN PP=B$IPHYMAP$->MM$IPHY_MAP(PP);
     1598    10617    4                  MM$PPUT(PP)=SAVE_PPUT;
     1599    10618    4                  NXTPP = PP;
     1600    10619    4                END;
     1601    10620    4             ELSE DO;       /* The page is mapped somewhere else, so it stays */
     1602    10621    4                  PREDT=VP;
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:104  
     1603    10622    4                  VP=NXTVP;
     1604    10623    4                END;
     1605    10624    3             NXTVP=MM$PPUT.PPNO(NXTPP);    /* Advance NXTVP */
     1606    10625    3           END; /* We have been through the chain and eliminated all the
     1607    10626         pages mapped into the PT to be reused */
     1608    10627    2        MM$VCB.TAIL=VP;
     1609    10628    2        CALL FINDMAP(VP);
     1610    10629
     1611    10630    2        IF HW_WSQ0PT THEN
     1612    10631    2             MM$PPUT.PPNO(B$IPHYMAP$->MM$IPHY_MAP(B$MAP.RPN(IPG)))=BITBIN('777777777'O)
             10631                      ;
     1613    10632    2        ELSE
     1614    10633    2             MM$PPUT.PPNO(B$MAP.RPN(IPG)) = BITBIN('777777777'O);
     1615    10634    2        B$SECT(EVPSECT.SECT#)=B$SECT(PT(I));
     1616    10635    2        B$SECT.PTBASE(PT(I))=MM_SCTDFT;
     1617    10636    2   END REUSE_ACTIVE_PT;
     1618    10637    1   END MMV$PAGE;
     1619    10638        %EOD;

PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:105  
--  Include file information  --

   HF_LOCK_C.:E05TOU  cannot be made into a system file and is referenced.
   UE$CP6V_C.:E05TOU  is referenced.
   UD_SEV_C.:E05TOU  is referenced.
   M_ERRSET_C.:E05TOU  is referenced.
   M_ERRORS_C.:E05TOU  is referenced.
   HF_DATA_R.:E05TOU  cannot be made into a system file and is referenced.
   MM_MACRO_M.:E05TOU  is referenced.
   B_STRINGS_C.:E05TOU  is referenced.
   MM$SYSGEN.:E05TOU  is referenced.
   M_INFO_C.:E05TOU  is referenced.
   MM_DATA_R.:E05TOU  cannot be made into a system file and is referenced.
   F_ERRORS_C.:E05TOU  is referenced.
   FM$CFU.:E05TOU  is referenced.
   F$DCB.:E05TOU  cannot be made into a system file and is referenced.
   CP_6_SUBS.:E05TOU  is referenced.
   CP_6_C.:E05TOU  is referenced.
   CP_6.:E05TOU  cannot be made into a system file and is referenced.
   B_SEGIDS_C.:E05TOU  is referenced.
   B_MAGIC_C.:E05TOU  is referenced.
   B_MACROS_C.:E05TOU  is referenced.
   B$SS.:E05TOU  cannot be made into a system file and is referenced.
   B$MAP.:E05TOU  cannot be made into a system file and is referenced.
   B$JIT_C.:E05TOU  is referenced.
   B$JIT.:E05TOU  cannot be made into a system file and is referenced.
      No diagnostics issued in procedure MMV$PAGE.

   Procedure MMV$PAGE requires 2433 words for executable code.
   Procedure MMV$PAGE requires 108 words of local(AUTO) storage.

PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:106  

 Object Unit name= MMV$PAGE                                   File name= MMV$VIRTUAL.:E05TOU
 UTS= JUL 30 '97 03:26:13.36 WED                              Compiler= PL-6/E31         Sev=      00
 SharedLib= :SHARED_SYSTEM                                    Alt SharedLib=


    ****  Control sections  ****

 Sect   Type Bound  Init  Size OctSiz  Section name(segment info)
    0   DCB   even  none     0      0  M$UC
    1  RoData even  UTS     31     37  MMV$PAGE
    2   Proc  even  none  2433   4601  MMV$PAGE
    3  RoData even  none    27     33  MMV$PAGE

    ****  Entry defs  ****

                              Check   Calling
                             calling  sequence
  Sect OctLoc Primary Altret sequence   type   Parms  Name
     2      0   yes    yes     yes      Std        3  MMV$PAGE
     2    101          yes     yes      Std        2  MMV$GET
     2   1345          yes     yes      Std        0  MMV$CLOSE
     2   2053          yes     yes      Std        1  MMV$TRUNC
     2   2466          yes     yes      Std        3  MMV$CVM
     2   2631          yes     yes      Std        2  MMV$RLS
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:107  

  ****  Entry refs  ****

         Check        Calling
        calling       sequence
Altret sequence SRef   type   Args  Name
         yes           Std       1 UDN$MGSAVE
 yes     yes           Std       4 MME$WFVP
         yes           Std       3 HFC$ASSOCCLR
 yes     yes           Std       4 MME$CVM
         yes           Std       0 UDB$AUTO
         yes           Std       1 HFE$M$STRAP
         yes           Std       1 UDN$MGRES
         yes           Std       0 UDN$MAGIC
 yes     yes           Std       4 MME$WGVP
 yes     yes           Std       4 MME$RVNP
 yes     yes           Std       1 MMB$FPP
 yes     yes           Std       1 MMB$FPPONTAIL
 yes     yes           Std       1 M$MREAD
         yes           Std       0 FMU$BLD
 yes     yes           Std       1 M$MWRITE
         yes           Std       0 MMA$POPSSF
         yes           Std       3 SSU$DELTAGO
 yes     yes           Std       6 SST$SSFTCB
         yes           Std       8 JSE$ABORTM
         yes           Std       0 SSS$SEXIT
                       nStd      0 X66_AUTO_3
                       Std       0 B_CONSPOOL_D
                       nStd      0 X66_ARET
                       nStd      0 X66_AALT
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:108  

  ****  Data refs  ****

  Flags:  r = read only, s = secondary
Flgs Name                             Flgs Name                             Flgs Name
     SC_MM47                               M$UC                             r    MM_BYP$
     MM_FPMC                               MM_SCTDFT                        r    MM_PTPTRS$
     H_S1000_FLG                           HW_WSQ0PT                             HW_IMX
r    B$PPUT$                          r    B$JIT$                           r    B$SBUF2$
r    B$UPT$                           r    B$USERLS$                        r    B$USERHJIT$
r    B$IPHYMAP$                            S_RVA                                 B_MPT
     B_VECTNIL

  ****  Segment refs  ****

  Flags:  r = read only, s = secondary
Flgs Name                             Flgs Name                             Flgs Name
     ISSID                                 NULLSID                               ASLENTSID
     ROSID
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:109  


      344        1        /*T***********************************************************/
      345        2        /*T*                                                         */
      346        3        /*T* Copyright (c) Bull HN Information Systems Inc., 1997    */
      347        4        /*T*                                                         */
      348        5        /*T***********************************************************/
      349        6        /*F* NAME: MMV$PAGE
      350        7             PURPOSE: Performs the paging of a large virtual array.
      351        8             DESCRIPTION: This routine performs the paging function of
      352        9                          a large virtual array. It is call by the fault
      353       10                          handler on detection of a missing working space or
      354       11                          of a missing page fault accessing WSQ'S 9, 10, or 11
      355       12                          and less then the maximum virtual page kept in the
      356       13                          DCB. If the number of physical pages is less than
      357       14                          the limit set up at open time a new page will be
      358       15                          gotten by calling MME$WGVP to set up the page
      359       16                          table and then read in from the disk file. If the
      360       17                          the physical limit is reached the page table will
      361       18                          be searched to find the page that has not been
      362       19                          accessed for the longest time, write the page out
      363       20                          if it has been modified and then read in the new
      364       21                          virtual page. The chain is a chain of virtual
      365       22                          pages with the least recently accessed at the
      366       23                          tail. The chain is linked through MM$PPUT and
      367       24                          the PT.
      368       25
      369       26             MM$VCB.HEAD          B$MAP             MM$PPUT
      370       27             -------------       ---------         -----------
      371       28             |  First VP |------>| Rpage |-------->| NXTVP   |
      372       29             -------------       ---------        .-----------
      373       30                                 |       |    .    |         |
      374       31                                 ---------.        -----------
      375       32                                 | Rpage |-------->| NXTVP   |
      376       33                                 ---------        .-----------
      377       34             MM$VCB.TAIL         |       |    .    |         |
      378       35             ----------          ---------.        -----------
      379       36             | Last VP |-------->| Rpage |-------->|'777777777'O|
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:110  
      380       37             -----------         ---------         -----------
      381       38
      382       39              */
      383       40
      384       41        MMV$PAGE: PROC (EWSQ,EVPAGE,PPNO) ALTRET;

     41  2 000000   000000 700200 xent  MMV$PAGE     TSX0  ! X66_AUTO_3
         2 000001   000154 000003                    ZERO    108,3

      385       42
      386       43        /* Includes */
      387       44        %INCLUDE B$JIT;
      388      647        %INCLUDE B$MAP;
      389      746        %INCLUDE B$SS;
      390      925        %INCLUDE B_MACROS_C;
      391     1036        %INCLUDE B_MAGIC_C;
      392     1154        %INCLUDE B_SEGIDS_C;
      393     1693        %INCLUDE CP_6;
      394     7252        %INCLUDE CP_6_SUBS;
      395     7792        %INCLUDE F$DCB;
      396     7841        %INCLUDE FM$CFU;
      397     7886        %INCLUDE F_ERRORS_C;
      398     8126        %INCLUDE MM_DATA_R;
      399     8646        %INCLUDE HF_DATA_R;
      400     8689        %INCLUDE M_ERRORS_C;
      401     8753        %INCLUDE M_ERRSET_C;
      402     8777        %INCLUDE UD_SEV_C;
      403     8791        %INCLUDE UE$CP6V_C;
      404     8875        %INCLUDE HF_LOCK_C;
      405     8889
      406     8890        /* Paramters */
      407     8891    1   DCL EWSQ UBIN;
      408     8892    1   DCL EVPAGE UBIN ;
      409     8893    1   DCL PPNO SBIN;
      410     8894
      411     8895        /* Symref's */
      412     8896    1   DCL B$PPUT$ PTR SYMREF READONLY;
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:111  
      413     8897    1   DCL B$ROSEG$ PTR SYMREF READONLY;
      414     8898    1   DCL B$JIT$ PTR SYMREF READONLY;
      415     8899    1   DCL B$SBUF2$ PTR SYMREF READONLY;
      416     8900    1   DCL B$UPT$ PTR SYMREF READONLY;
      417     8901    1   DCL B$USERLS$ PTR SYMREF READONLY;
      418     8902    1   DCL B$USERHJIT$ PTR SYMREF READONLY;
      419     8903    1   DCL B$WSQ0PT$ PTR SYMREF READONLY;
      420     8904    1   DCL B$IPHYMAP$ PTR SYMREF READONLY;
      421     8905    1   DCL B$MPT$ PTR SYMREF READONLY;
      422     8906    1   DCL S_RVA UBIN SYMREF;
      423     8907
      424     8908        /* Auto */
      425     8909    1   DCL EVP UBIN WORD;                      /* page being accessed */
      426     8910    1   DCL 1 EVPKEY REDEF EVP,
      427     8911    1            2 * BIT(14) UNAL,
      428     8912    1            2 PAGE_KEY UBIN(16) UNAL,
      429     8913    1            2 PAGE_NO_ENTRY UBIN(6) UNAL;
      430     8914    1   DCL 1 EVPSECT REDEF EVP,
      431     8915    1            2 * BIT(14) UNAL,
      432     8916    1            2 SECT# UBIN(12) UNAL,
      433     8917    1            2 PG# UBIN(10) UNAL;
      434     8918    1   DCL EVP_PAGE_NO_ENTRY UBIN;
      435     8919    1   DCL PAGE_NO_ENTRY SBIN;
      436     8920    1   DCL FRAGMENTED BIT(1);
      437     8921    1   DCL SECTION BIT(1);
      438     8922    1   DCL MAPVP UBIN;
      439     8923    1   DCL DCB# UBIN;                          /* Dcb number for this virtual area */
      440     8924    1   DCL WRITE_FLAG BIT(1);
      441     8925    1   DCL ERR UBIN;
      442     8926    1   DCL I SBIN;
      443     8927    1   DCL K SBIN;
      444     8928    1   DCL TLNACC SBIN;                        /* Tail of 'not accessed' list */
      445     8929    1   DCL HDNACC SBIN;                        /* Head of 'not accessed' list */
      446     8930    1   DCL TLACC SBIN;                         /* Tail of 'accessed' list */
      447     8931    1   DCL HDACC SBIN;                         /* Head of 'accessed' list     */
      448     8932    1   DCL VP SBIN;                            /* Current vp                         */
      449     8933    1   DCL 1 VPSECT REDEF VP,
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:112  
      450     8934    1            2 * BIT(14),
      451     8935    1            2 SECT# UBIN(12) UNAL,
      452     8936    1            2 PG# UBIN(10) UNAL;
      453     8937    1   DCL ACTLPP REDEF VP SBIN;               /* PP at end of accessed list */
      454     8938    1   DCL PP SBIN;                            /* current physical page              */
      455     8939    1   DCL NACTLPP REDEF PP SBIN;              /* PP at end of not accessed list */
      456     8940    1   DCL NXTVP SBIN;                         /* Next vp                            */
      457     8941    1   DCL 1 NXTVPSECT REDEF NXTVP,
      458     8942    1            2 * BIT(14),
      459     8943    1            2 SECT# UBIN(12) UNAL,
      460     8944    1            2 PG# UBIN(10) UNAL;
      461     8945    1   DCL NXTPP SBIN;                         /* Next physical page                 */
      462     8946        /* Tail predecessors */
      463     8947    1   DCL J SBIN;
      464     8948    1   DCL PREDTA SBIN;
      465     8949    1   DCL PREDTN SBIN;
      466     8950    1   DCL PREDT SBIN;
      467     8951    1   DCL IPG UBIN;                      /* Appropriate index in the page table */
      468     8952    1   DCL PTBASE UBIN WORD;
      469     8953    1   DCL ER_JUNK UBIN WORD;
      470     8954    1   DCL PT(0:15) SBIN HALF HALIGNED;
      471     8955    1   DCL SAVE_PPUT BIT(36) ALIGNED;
      472     8956    1   DCL  SAVE_VP SBIN WORD;
      473     8957    1   DCL   SCT# SBIN WORD;
      474     8958    1   DCL  SCT_USED SBIN WORD;
      475     8959    1   DCL  SKIP_COUNT SBIN WORD;
      476     8960    1   DCL UPD_CHAIN_FLG BIT(1);               /*Page chain updated */
      477     8961    1   DCL 1 READ$PAGE$ERR ,
      478     8962    1            2 FCG BIT(12),
      479     8963    1            2 MID BIT(6),
      480     8964    1            2 MON BIT(1),
      481     8965    1            2 CODE UBIN(14) UNAL,
      482     8966    1            2 SEV UBIN(3) UNAL;
      483     8967    1   DCL SEGID BIT(12);
      484     8968    1   DCL TEMP SBIN;
      485     8969    1   DCL BTEMP REDEF TEMP BIT(36) ALIGNED;
      486     8970    1   DCL MAP$ PTR;
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:113  
      487     8971    1   DCL 1 MAP_PTR REDEF MAP$,
      488     8972    1            2 WOFFS UBIN(18) UNAL,
      489     8973    1            2 * UBIN(18) UNAL;
      490     8974    1   DCL SECT$ PTR;
      491     8975    1   DCL UNMAP$ PTR;
      492     8976    1   DCL 1 UNMAP_PTR REDEF UNMAP$,
      493     8977    1            2 WOFFS UBIN(18) UNAL,
      494     8978    1            2 * UBIN(18) UNAL;
      495     8979    1   DCL   MAP_INDEX SBIN WORD;
      496     8980    1   DCL VCB$ PTR;
      497     8981    1   DCL STATS$ PTR;
      498     8982    1   DCL WSQ SBIN;
      499     8983    1   DCL WS_FLT BIT(1);                      /* Missing working space fault */
      500     8984        %FPT$STRAP_V (BASED=AUTO);
      501     8987
      502     8988        /* Base structures */
      503     8989        %T01DESCR (NAME=B$$DESCR);
      504     8997        %B$FLT (NAME=FINFO,SSF=NO,HREGS=NO,STCLASS=AUTO);
      505     9049        %B$ECCB;
      506     9057    1   DCL SST$SSFTCB ENTRY(6) ALTRET;
      507     9058    1   DCL 1 B$FRAGHWRD,
      508     9059    1            2 * BIT(1) UNAL,
      509     9060    1            2 KEY_VALID BIT(1) UNAL,
      510     9061    1            2 PAGE_KEY UBIN(16) UNAL;
      511     9062    1   DCL 1 B$FRAGMAP BASED ALIGNED,
      512     9063    1            2 HWRD(0:255) HALIGNED,
      513     9064    1                 3 * BIT(1) UNAL,
      514     9065    1                 3 KEY_VALID BIT(1) UNAL,
      515     9066    1                 3 PAGE_KEY UBIN(16) UNAL;
      516     9067    1   DCL 1 B$FRAGMAPD(0:63) BASED DALIGNED,
      517     9068    1            2 * BIT(1) UNAL,
      518     9069    1            2 KEY_VALID_0 BIT(1) UNAL,
      519     9070    1            2 PAGE_KEY_0 UBIN(16) UNAL,
      520     9071    1            2 * BIT(1) UNAL,
      521     9072    1            2 KEY_VALID_1 BIT(1) UNAL,
      522     9073    1            2 PAGE_KEY_1 UBIN(16) UNAL,
      523     9074    1            2 * BIT(1) UNAL,
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:114  
      524     9075    1            2 KEY_VALID_2 BIT(1) UNAL,
      525     9076    1            2 PAGE_KEY_2 UBIN(16) UNAL,
      526     9077    1            2 * BIT(1) UNAL,
      527     9078    1            2 KEY_VALID_3 BIT(1) UNAL,
      528     9079    1            2 PAGE_KEY_3 UBIN(16) UNAL;
      529     9080
      530     9081        /* Entry references */
      531     9082    1   DCL FMU$BLD ENTRY;
      532     9083    1   DCL HFE$M$STRAP ENTRY(1);
      533     9084    1   DCL JSE$ABORTM ENTRY(8);
      534     9085    1   DCL MMB$FPPONTAIL ENTRY(1) ALTRET;
      535     9086    1   DCL MMB$FPP ENTRY(1) ALTRET;
      536     9087    1   DCL MME$RVNP ENTRY(4) ALTRET;
      537     9088    1   DCL MME$WGVP ENTRY(4) ALTRET;
      538     9089    1   DCL MME$WFVP ENTRY(4) ALTRET;
      539     9090    1   DCL MME$CVM ENTRY (4) ALTRET;
      540     9091    1   DCL M$MREAD ENTRY(1) ALTRET;
      541     9092    1   DCL M$MWRITE ENTRY(1) ALTRET;
      542     9093    1   DCL SC_MM47 ENTRY CONV(2,0);
      543     9094    1   DCL SSS$SEXIT ENTRY;
      544     9095    1   DCL SSU$DELTAGO ENTRY(3);
      545     9096    1   DCL UDB$AUTO ENTRY;
      546     9097    1   DCL UDN$MAGIC ENTRY ;
      547     9098    1   DCL HFC$ASSOCCLR ENTRY(3);
      548     9099    1   DCL UDN$MGRES ENTRY(1);
      549     9100    1   DCL UDN$MGSAVE ENTRY(1);
      550     9101    1   DCL MMA$POPSSF ENTRY;
      551     9102
      552     9103        /* Macro invocations */
      553     9104        %B_MPT (FPTN=B_MPT,STCLASS=SYMREF);
      554     9197        %B$MAP (NAME=B$NMAP);
      555     9215        %B_MPT (FPTN=B_MPT_SAVE,STCLASS="");
      556     9308        %FM$CFU;
      557     9314        %FPT_READ (FPTN=READ_PAGEC,STCLASS=CONSTANT,KEYS=YES);
      558     9353        %FPT_READ (FPTN=READ_PAGE,STCLASS="");
      559     9392        %FPT_WRITE (FPTN=WRITE_PAGEC,STCLASS=CONSTANT);
      560     9423        %MM$VIRTUAL_STATS(STCLASS="BASED(STATS$)");
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:115  
      561     9427        %MODERR(MODULE='26'O);                  /* Sets the module of errcode to v    */
      562     9435        %VLP_ERRCODE (FPTN=VSBADAC,ERR#=%E$VSBADAC,SEV=SEV_ERROR#,FCG=MM,MID=V,MON='1'B,
              9435            STCLASS=CONSTANT);
      563     9480        %VLP_ERRCODE (FPTN=PGINUSE,ERR#=%E$PGINUSE,SEV=SEV_ERROR#,FCG=MM,MID=V,MON='1'B,
              9480            STCLASS=CONSTANT);
      564     9525
      565     9526        /* Sub's */
      566     9527        %SUB MM$VCB = VCB$ -> MM$VCB;
      567     9528        %SUB MM$PPUT = B$PPUT$ -> MM$VPPUT;
      568     9529        %SUB B$FRAGMAP = MAP$->B$FRAGMAP;
      569     9530        %SUB B$FRAGMAPD = MAP$->B$FRAGMAPD;
      570     9531        %SUB B$MAP = MAP$ -> B$MAP;
      571     9532        %SUB B$SECT = SECT$ -> B$SECT;
      572     9533        %SUB ECCB$ = B_MPT.ECCB$;
      573     9534        %SUB SS$ = B_MPT.SS$;
      574     9535        %SUB TCB$ = B_MPT.TCB$;
      575     9536        %SUB_EXC;
      576     9583
      577     9584        %EJECT;
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:116  
      578     9585        /* Procedure */
      579     9586
      580     9587    2        DO INHIBIT;

      581     9588    2             EVP = S_RVA;

   9588  2 000002   000000 235200 xsym               LDA   ! S_RVA
         2 000003   200006 755300                    STA   ! EVP,,AUTO

      582     9589    2           END;

      583     9590    1        WS_FLT='0'B;                       /* Missing page fault */

   9590  2 000004   200070 450100                    STZ     WS_FLT,,AUTO

   9590  2 000005                       FLTENT       null
      584     9591    1   FLTENT:;
      585     9592    1        UPD_CHAIN_FLG=%FALSE;

   9592  2 000005   200055 450100                    STZ     UPD_CHAIN_FLG,,AUTO

      586     9593             /* Get VP and EWSQ out of SS */
      587     9594    1        CALL UDN$MGSAVE (B_MPT_SAVE);

   9594  2 000006   200102 630500                    EPPR0   B_MPT_SAVE,,AUTO
         2 000007   200146 450500                    STP0    KEY+2,,AUTO
         2 000010   200146 630500                    EPPR0   KEY+2,,AUTO
         2 000011   000017 631400 xsym               EPPR1   B_VECTNIL+15
         2 000012   000000 701000 xent               TSX1    UDN$MGSAVE
         2 000013   000000 011000                    NOP     0

      588     9595    1        CALL UDN$MAGIC;

   9595  2 000014   000002 631400 xsym               EPPR1   B_VECTNIL+2
         2 000015   000000 701000 xent               TSX1    UDN$MAGIC
         2 000016   000000 011000                    NOP     0

PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:117  
      589     9596
      590     9597    1        WSQ = SS$ -> B$SS.EWSQ#;

   9597  2 000017   000000 470400 xsym               LDP0    B_MPT
         2 000020   000006 236100                    LDQ     6,,PR0
         2 000021   000777 376007                    ANQ     511,DL
         2 000022   200067 756100                    STQ     WSQ,,AUTO

      591     9598    1        EVP = BITBIN(BINBIT(EVP,36)&'177777777777'O) /4096;

   9598  2 000023   200006 236100                    LDQ     EVP,,AUTO
         2 000024   000035 376000 1                  ANQ     PGINUSE+1
         2 000025   000014 772000                    QRL     12
         2 000026   200006 756100                    STQ     EVP,,AUTO

      592     9599    1        EVP_PAGE_NO_ENTRY = EVPKEY.PAGE_NO_ENTRY;

   9599  2 000027   200006 236100                    LDQ     EVP,,AUTO
         2 000030   000077 376007                    ANQ     63,DL
         2 000031   200007 756100                    STQ     EVP_PAGE_NO_ENTRY,,AUTO

      593     9600        /* Reset B$SS.IR.MIR and B$SS.CPUREQ */
      594     9601    1        SS$ -> B$SS.IR.MIR = %FALSE;

   9601  2 000032   000000 236000 3                  LDQ     0
         2 000033   000004 356100                    ANSQ    4,,PR0

      595     9602
      596     9603    1        IF WSQ > %USERWSQ

   9603  2 000034   200067 235100                    LDA     WSQ,,AUTO
         2 000035   000010 115007                    CMPA    8,DL
         2 000036   000111 605400 2                  TPNZ    COMMON

      597     9604    1        THEN
      598     9605    1             GOTO COMMON;
      599     9606             %FINDMAP (WSQ = WSQ , P$ = MAP$);
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:118  

   9607  2 000037   000000 236005 xsym               LDQ     MM_PTPTRS$,AL
         2 000040   200061 756100                    STQ     MAP$,,AUTO

      600     9609    1        CALL MME$WGVP (WSQ, EVP, BITBIN (%PGINMEM|%PGWRITE|%PGIOM),ERR) ALTRET (
              9609                 CANT_GET);

   9609  2 000041   200016 631500                    EPPR1   ERR,,AUTO
         2 000042   200151 451500                    STP1    KEY+5,,AUTO
         2 000043   000002 236000 3                  LDQ     2
         2 000044   200150 756100                    STQ     KEY+4,,AUTO
         2 000045   200006 633500                    EPPR3   EVP,,AUTO
         2 000046   200147 453500                    STP3    KEY+3,,AUTO
         2 000047   200067 634500                    EPPR4   WSQ,,AUTO
         2 000050   200146 454500                    STP4    KEY+2,,AUTO
         2 000051   200146 630500                    EPPR0   KEY+2,,AUTO
         2 000052   000022 631400 xsym               EPPR1   B_VECTNIL+18
         2 000053   000000 701000 xent               TSX1    MME$WGVP
         2 000054   001333 702000 2                  TSX2    CANT_GET

      601     9610    1        PP = B$MAP.RPN (EVP);

   9610  2 000055   200061 470500                    LDP0    MAP$,,AUTO
         2 000056   200006 720100                    LXL0    EVP,,AUTO
         2 000057   000000 236110                    LDQ     0,X0,PR0
         2 000060   000022 772000                    QRL     18
         2 000061   200026 756100                    STQ     PP,,AUTO

      602     9611    1        IF HW_WSQ0PT THEN

   9611  2 000062   000000 234000 xsym               SZN     HW_WSQ0PT
         2 000063   000072 605000 2                  TPL     s:9613

      603     9612    1             PP = B$IPHYMAP$ -> MM$IPHY_MAP (PP);

   9612  2 000064   200026 235100                    LDA     PP,,AUTO
         2 000065   000001 735000                    ALS     1
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:119  
         2 000066   000000 471400 xsym               LDP1    B$IPHYMAP$
         2 000067   000100 101505                    MRL     fill='000'O
         2 000070   100000 000002                    ADSC9   0,A,PR1                  cn=0,n=2
         2 000071   200026 000004                    ADSC9   PP,,AUTO                 cn=0,n=4

      604     9613    1        CALL CVM;

   9613  2 000072   002426 701000 2                  TSX1    CVM
         2 000073   000000 011000                    NOP     0

      605     9614    1        TEMP = 23085;                      /* .000000055055 (  --) */

   9614  2 000074   055055 235007                    LDA     23085,DL
         2 000075   200060 755100                    STA     TEMP,,AUTO

      606     9615    1        CALL INITPAGE1;

   9615  2 000076   003044 701000 2                  TSX1    INITPAGE1
         2 000077   000000 011000                    NOP     0

      607     9616    1        GOTO MMV_EXIT;

   9616  2 000100   000474 710000 2                  TRA     MMV_EXIT

      608     9617
      609     9618        /* Handle M$GVP for virtual segment. */
      610     9619    1   MMV$GET: ENTRY(EWSQ,EVPAGE) ALTRET;

   9619  2 000101   000000 700200 xent  MMV$GET      TSX0  ! X66_AUTO_3
         2 000102   000154 000003                    ZERO    108,3

      611     9620
      612     9621    1        WSQ = EWSQ;

   9621  2 000103   200003 470500                    LDP0    @EWSQ,,AUTO
         2 000104   000000 235100                    LDA     0,,PR0
         2 000105   200067 755100                    STA     WSQ,,AUTO
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:120  

      613     9622    1        EVP = EVPAGE;

   9622  2 000106   200004 471500                    LDP1    @EVPAGE,,AUTO
         2 000107   100000 235100                    LDA     0,,PR1
         2 000110   200006 755100                    STA     EVP,,AUTO

   9622  2 000111                       COMMON       null
      614     9623
      615     9624    1   COMMON: ;
      616     9625        %EJECT;
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:121  
      617     9626        /* Set up pointer to dcb for this virtual area */
      618     9627    1        DCB# = B$JIT.VIRTUAL.DCB# (WSQ - %VS1WSQ);

   9627  2 000111   000000 470400 xsym               LDP0    B$JIT$
         2 000112   200067 235100                    LDA     WSQ,,AUTO
         2 000113   000100 101505                    MRL     fill='000'O
         2 000114   000214 600001                    ADSC9   140,A,PR0                cn=3,n=1
         2 000115   200014 000004                    ADSC9   DCB#,,AUTO               cn=0,n=4

      619     9628    1        IF DCB# = 0

   9628  2 000116   200014 236100                    LDQ     DCB#,,AUTO
         2 000117   000122 601000 2                  TNZ     s:9635

      620     9629    2        THEN DO;

      621     9630    2             CALL SC_MM47;

   9630  2 000120   000000 713400 xsym               CLIMB   SC_MM47
         2 000121   000000 600000 xsid               climb   nvectors=         0

      622     9631                  /*S* SCREECH_CODE: MMV-S$MM47   */
      623     9632                  /*S* TYPE: SUA */
      624     9633                  /*S* MESSAGE: Inconsistency in large virtual segment */
      625     9634    2           END;

      626     9635    1        VCB$ = DCBADDR(DCB#) -> F$DCB.SETSTA$;

   9635  2 000122   000003 470400 3                  LDP0    3
         2 000123   000000 471500                    LDP1    0,,PR0
         2 000124   200014 720100                    LXL0    DCB#,,AUTO
         2 000125   100000 473510                    LDP3    0,X0,PR1
         2 000126   300006 236100                    LDQ     6,,PR3
         2 000127   200065 756100                    STQ     VCB$,,AUTO

      627     9636    1        STATS$ = DCBADDR(DCB#) -> F$DCB.LASTSTA$;

PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:122  
   9636  2 000130   300007 236100                    LDQ     7,,PR3
         2 000131   200066 756100                    STQ     STATS$,,AUTO

      628     9637    1        IF WSQ ~= MM$VCB.WSQ               /* WSQ does not match */

   9637  2 000132   200065 474500                    LDP4    VCB$,,AUTO
         2 000133   400000 236100                    LDQ     0,,PR4
         2 000134   000022 772000                    QRL     18
         2 000135   000777 376007                    ANQ     511,DL
         2 000136   200067 116100                    CMPQ    WSQ,,AUTO
         2 000137   000142 600000 2                  TZE     s:9641

      629     9638    2        THEN DO;

      630     9639    2             CALL SC_MM47;

   9639  2 000140   000000 713400 xsym               CLIMB   SC_MM47
         2 000141   000000 600000 xsid               climb   nvectors=         0

      631     9640    2           END;

      632     9641    1        MM$VIRTUAL_STATS.FAULTS# = MM$VIRTUAL_STATS.FAULTS# + 1;

   9641  2 000142   200066 470500                    LDP0    STATS$,,AUTO
         2 000143   000002 235100                    LDA     2,,PR0
         2 000144   000001 035007                    ADLA    1,DL
         2 000145   000002 755100                    STA     2,,PR0

      633     9642
      634     9643        /* Check to see if the access is within bounds of the segment */
      635     9644    1        IF EVP > MM$VCB.MAXVP#

   9644  2 000146   200065 471500                    LDP1    VCB$,,AUTO
         2 000147   200006 236100                    LDQ     EVP,,AUTO
         2 000150   000153 604000 2                  TMI     s:9646
         2 000151   100002 116100                    CMPQ    2,,PR1
         2 000152   000162 604400 2                  TMOZ    s:9655
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:123  

      636     9645    2        THEN DO;

      637     9646    2             B$JIT.ERR = VSBADAC;

   9646  2 000153   000033 236000 1                  LDQ     VSBADAC
         2 000154   000000 473400 xsym               LDP3    B$JIT$
         2 000155   300012 756100                    STQ     10,,PR3

      638     9647                  /*E* ERROR: MMV-E$VSBADAC-SEV_ABORT#
      639     9648                       MESSAGE: Memory accesses out of range for virtual segment
      640     9649                       MESSAGE1: The virtual address is larger than the maximum
      641     9650                                allowable for the virtual area
      642     9651                        */
      643     9652    2             CALL ABORTM(%SUBC_MEMORY#);

   9652  2 000156   000004 236000 3                  LDQ     4
         2 000157   200135 756100                    STQ     READ_PAGE+15,,AUTO
         2 000160   003064 701000 2                  TSX1    ABORTM
         2 000161   000000 011000                    NOP     0

      644     9653    2           END;

      645     9654        /* If NOFILE report page fault to user */
      646     9655    1        IF MM$VCB.NOFILE

   9655  2 000162   200065 470500                    LDP0    VCB$,,AUTO
         2 000163   000000 236100                    LDQ     0,,PR0
         2 000164   200000 316003                    CANQ    65536,DU
         2 000165   000211 600000 2                  TZE     s:9663

      647     9656    2        THEN DO;

      648     9657    2             IF WS_FLT THEN FPT$STRAP_V.STRAP = BITBIN(%FLT_MSPACE#);

   9657  2 000166   200070 234100                    SZN     WS_FLT,,AUTO
         2 000167   000175 605000 2                  TPL     s:9658
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:124  

   9657  2 000170   200072 236100                    LDQ     FPT$STRAP_V,,AUTO
         2 000171   000005 376000 3                  ANQ     5
         2 000172   460000 276003                    ORQ     -106496,DU
         2 000173   200072 756100                    STQ     FPT$STRAP_V,,AUTO
         2 000174   000201 710000 2                  TRA     s:9659

      649     9658    2             ELSE FPT$STRAP_V.STRAP = BITBIN(%FLT_MPAGE#);

   9658  2 000175   200072 236100                    LDQ     FPT$STRAP_V,,AUTO
         2 000176   000005 376000 3                  ANQ     5
         2 000177   500000 276003                    ORQ     -98304,DU
         2 000200   200072 756100                    STQ     FPT$STRAP_V,,AUTO

      650     9659    2             CALL HFE$M$STRAP(ADDR(FPT$STRAP_V));

   9659  2 000201   200072 631500                    EPPR1   FPT$STRAP_V,,AUTO
         2 000202   200146 451500                    STP1    KEY+2,,AUTO
         2 000203   200146 633500                    EPPR3   KEY+2,,AUTO
         2 000204   200147 453500                    STP3    KEY+3,,AUTO
         2 000205   200147 630500                    EPPR0   KEY+3,,AUTO
         2 000206   000017 631400 xsym               EPPR1   B_VECTNIL+15
         2 000207   000000 701000 xent               TSX1    HFE$M$STRAP
         2 000210   000000 011000                    NOP     0

      651     9660    2           END;

      652     9661        %EJECT;
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:125  
      653     9662
      654     9663    1        FRAGMENTED = MM$VCB.T.FRAGMENTED;

   9663  2 000211   200065 470500                    LDP0    VCB$,,AUTO
         2 000212   000000 236100                    LDQ     0,,PR0
         2 000213   000004 736000                    QLS     4
         2 000214   400000 376003                    ANQ     -131072,DU
         2 000215   200011 756100                    STQ     FRAGMENTED,,AUTO

      655     9664    1        SECTION = MM$VCB.T.SECTION;

   9664  2 000216   000000 236100                    LDQ     0,,PR0
         2 000217   000005 736000                    QLS     5
         2 000220   400000 376003                    ANQ     -131072,DU
         2 000221   200012 756100                    STQ     SECTION,,AUTO

      656     9665    1        CALL FINDMAP (EVP);

   9665  2 000222   200006 631500                    EPPR1   EVP,,AUTO
         2 000223   200137 451500                    STP1    @SUBC+2,,AUTO
         2 000224   003213 701000 2                  TSX1    FINDMAP
         2 000225   000000 011000                    NOP     0

      657     9666
      658     9667        /* Check to see if the page that the trap points to is already one
      659     9668             that should be in memory, if it is a SUA is in order because there
      660     9669             is something wrong. */
      661     9670    1        IF FRAGMENTED            /* Fragmented page table check to see if key */

   9670  2 000226   200011 234100                    SZN     FRAGMENTED,,AUTO
         2 000227   000273 605000 2                  TPL     s:9689

      662     9671    2        THEN DO;                           /*   already exist. */

      663     9672                                      /* Also look for empty key slot at the
      664     9673                                         same time. */
      665     9674    2             I = EVP_PAGE_NO_ENTRY * 4;
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:126  

   9674  2 000230   200007 235100                    LDA     EVP_PAGE_NO_ENTRY,,AUTO
         2 000231   000002 735000                    ALS     2
         2 000232   200017 755100                    STA     I,,AUTO

      666     9675    2             PAGE_NO_ENTRY = -1;

   9675  2 000233   000001 336007                    LCQ     1,DL
         2 000234   200010 756100                    STQ     PAGE_NO_ENTRY,,AUTO

      667     9676    3             DO TEMP = 0 TO 3;

   9676  2 000235   200060 450100                    STZ     TEMP,,AUTO

      668     9677    3                  B$FRAGHWRD = B$FRAGMAP.HWRD (I);

   9677  2 000236   200017 235100                    LDA     I,,AUTO
         2 000237   000001 735000                    ALS     1
         2 000240   200061 470500                    LDP0    MAP$,,AUTO
         2 000241   000100 100505                    MLR     fill='000'O
         2 000242   000000 000002                    ADSC9   0,A,PR0                  cn=0,n=2
         2 000243   200100 000002                    ADSC9   B$FRAGHWRD,,AUTO         cn=0,n=2

      669     9678    3                  IF B$FRAGHWRD.KEY_VALID

   9678  2 000244   200100 236100                    LDQ     B$FRAGHWRD,,AUTO
         2 000245   200000 316003                    CANQ    65536,DU
         2 000246   000263 600000 2                  TZE     s:9685

      670     9679    3                  THEN
      671     9680    3                       IF B$FRAGHWRD.PAGE_KEY = EVPKEY.PAGE_KEY

   9680  2 000247   200006 236100                    LDQ     EVP,,AUTO
         2 000250   000006 772000                    QRL     6
         2 000251   177777 376007                    ANQ     65535,DL
         2 000252   200146 756100                    STQ     KEY+2,,AUTO
         2 000253   200100 236100                    LDQ     B$FRAGHWRD,,AUTO
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:127  
         2 000254   000022 772000                    QRL     18
         2 000255   177777 376007                    ANQ     65535,DL
         2 000256   200146 116100                    CMPQ    KEY+2,,AUTO
         2 000257   000265 601000 2                  TNZ     s:9686

      672     9681    3                       THEN
      673     9682    3                            CALL SC_MM47;

   9682  2 000260   000000 713400 xsym               CLIMB   SC_MM47
         2 000261   000000 600000 xsid               climb   nvectors=         0
         2 000262   000265 710000 2                  TRA     s:9686

      674     9683    3                       ELSE ;
      675     9684    3                  ELSE
      676     9685    3                       PAGE_NO_ENTRY = I;

   9685  2 000263   200017 235100                    LDA     I,,AUTO
         2 000264   200010 755100                    STA     PAGE_NO_ENTRY,,AUTO

      677     9686    3                  I = I + 1;

   9686  2 000265   200017 054100                    AOS     I,,AUTO

      678     9687    3                END;

   9687  2 000266   200060 054100                    AOS     TEMP,,AUTO
         2 000267   200060 235100                    LDA     TEMP,,AUTO
         2 000270   000003 115007                    CMPA    3,DL
         2 000271   000236 604400 2                  TMOZ    s:9677

      679     9688    2           END;

   9688  2 000272   000304 710000 2                  TRA     s:9695

      680     9689    1        ELSE IF SECTION THEN ;

   9689  2 000273   200012 234100                    SZN     SECTION,,AUTO
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:128  
         2 000274   000304 604000 2                  TMI     s:9695

      681     9690    1             ELSE IF B$MAP.RPN(EVP) ~= MM_FPMC.RPN

   9690  2 000275   200061 470500                    LDP0    MAP$,,AUTO
         2 000276   200006 720100                    LXL0    EVP,,AUTO
         2 000277   000000 221110                    LDX1    0,X0,PR0
         2 000300   000000 101000 xsym               CMPX1   MM_FPMC
         2 000301   000304 600000 2                  TZE     s:9695

      682     9691    1                  THEN
      683     9692    1                       CALL SC_MM47;

   9692  2 000302   000000 713400 xsym               CLIMB   SC_MM47
         2 000303   000000 600000 xsid               climb   nvectors=         0

      684     9693
      685     9694        %EJECT;
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:129  
      686     9695    1        IF WS_FLT THEN GOTO SPACEM;        /* It was missing working space */

   9695  2 000304   200070 234100                    SZN     WS_FLT,,AUTO
         2 000305   002351 604000 2                  TMI     SPACEM

      687     9696
      688     9697    1   GT_DATAPAG:
      689     9698    1        TEMP = MM$VCB.PPC;                 /* Move physical page count to auto   */

   9698  2 000306   200065 470500       GT_DATAPAG   LDP0    VCB$,,AUTO
         2 000307   000011 236100                    LDQ     9,,PR0
         2 000310   000022 772000                    QRL     18
         2 000311   200060 756100                    STQ     TEMP,,AUTO

      690     9699    2        IF UPD_CHAIN_FLG = %FALSE THEN DO;

   9699  2 000312   200055 234100                    SZN     UPD_CHAIN_FLG,,AUTO
         2 000313   000337 604000 2                  TMI     s:9709

      691     9700    3             IF SECTION THEN DO;

   9700  2 000314   200012 234100                    SZN     SECTION,,AUTO
         2 000315   000325 605000 2                  TPL     s:9705

      692     9701    3                  IF TEMP = MM$VCB.PPMAX THEN

   9701  2 000316   000003 236100                    LDQ     3,,PR0
         2 000317   000022 772000                    QRL     18
         2 000320   200060 116100                    CMPQ    TEMP,,AUTO
         2 000321   000337 601000 2                  TNZ     s:9709

      693     9702    3                       CALL UPD_SECT_CHAIN;

   9702  2 000322   003324 701000 2                  TSX1    UPD_SECT_CHAIN
         2 000323   000000 011000                    NOP     0

      694     9703    3                END;
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:130  

   9703  2 000324   000337 710000 2                  TRA     s:9709

      695     9704    3             ELSE DO;

      696     9705    3                  IF (FRAGMENTED AND PAGE_NO_ENTRY < 0) OR TEMP = MM$VCB.PPMAX

   9705  2 000325   200011 234100                    SZN     FRAGMENTED,,AUTO
         2 000326   000331 605000 2                  TPL     s:9705+4
         2 000327   200010 235100                    LDA     PAGE_NO_ENTRY,,AUTO
         2 000330   000335 604000 2                  TMI     s:9706
         2 000331   000003 236100                    LDQ     3,,PR0
         2 000332   000022 772000                    QRL     18
         2 000333   200060 116100                    CMPQ    TEMP,,AUTO
         2 000334   000337 601000 2                  TNZ     s:9709

      697     9706    3                  THEN CALL UPD_FRAG_DENSE_CHAIN;

   9706  2 000335   003614 701000 2                  TSX1    UPD_FRAG_DENSE_CHAIN
         2 000336   000000 011000                    NOP     0

      698     9707    3                END;

      699     9708    2           END;

      700     9709    1        IF FRAGMENTED

   9709  2 000337   200011 234100                    SZN     FRAGMENTED,,AUTO
         2 000340   000510 605000 2                  TPL     s:9747

      701     9710    2        THEN DO;

      702     9711    2             MAPVP = PAGE_NO_ENTRY + 128;

   9711  2 000341   200010 235100                    LDA     PAGE_NO_ENTRY,,AUTO
         2 000342   000200 035007                    ADLA    128,DL
         2 000343   200013 755100                    STA     MAPVP,,AUTO
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:131  

      703     9712
      704     9713             /* If the key is valid write out the page and assign the new
      705     9714                key then return */
      706     9715    2             B$FRAGHWRD = B$FRAGMAP.HWRD (PAGE_NO_ENTRY);

   9715  2 000344   200010 236100                    LDQ     PAGE_NO_ENTRY,,AUTO
         2 000345   000001 736000                    QLS     1
         2 000346   200061 470500                    LDP0    MAP$,,AUTO
         2 000347   000100 100506                    MLR     fill='000'O
         2 000350   000000 000002                    ADSC9   0,Q,PR0                  cn=0,n=2
         2 000351   200100 000002                    ADSC9   B$FRAGHWRD,,AUTO         cn=0,n=2

      707     9716    2             IF B$FRAGHWRD.KEY_VALID

   9716  2 000352   200100 236100                    LDQ     B$FRAGHWRD,,AUTO
         2 000353   200000 316003                    CANQ    65536,DU
         2 000354   000512 600000 2                  TZE     s:9752

      708     9717    3             THEN DO;

      709     9718    3                  VP = B$FRAGHWRD.PAGE_KEY * 64 + PAGE_NO_ENTRY/4;

   9718  2 000355   200010 236100                    LDQ     PAGE_NO_ENTRY,,AUTO
         2 000356   000004 506007                    DIV     4,DL
         2 000357   200146 756100                    STQ     KEY+2,,AUTO
         2 000360   200100 236100                    LDQ     B$FRAGHWRD,,AUTO
         2 000361   000014 772000                    QRL     12
         2 000362   000006 376000 3                  ANQ     6
         2 000363   200146 036100                    ADLQ    KEY+2,,AUTO
         2 000364   200025 756100                    STQ     VP,,AUTO

      710     9719    3                  PP = B$MAP.RPN(MAPVP);   /* GET PHYSICAL PAGE */

   9719  2 000365   200013 720100                    LXL0    MAPVP,,AUTO
         2 000366   000000 236110                    LDQ     0,X0,PR0
         2 000367   000022 772000                    QRL     18
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:132  
         2 000370   200026 756100                    STQ     PP,,AUTO

      711     9720    3                  IF HW_WSQ0PT THEN

   9720  2 000371   000000 234000 xsym               SZN     HW_WSQ0PT
         2 000372   000401 605000 2                  TPL     s:9722

      712     9721    3                       PP=B$IPHYMAP$->MM$IPHY_MAP(PP);

   9721  2 000373   200026 235100                    LDA     PP,,AUTO
         2 000374   000001 735000                    ALS     1
         2 000375   000000 471400 xsym               LDP1    B$IPHYMAP$
         2 000376   000100 101505                    MRL     fill='000'O
         2 000377   100000 000002                    ADSC9   0,A,PR1                  cn=0,n=2
         2 000400   200026 000004                    ADSC9   PP,,AUTO                 cn=0,n=4

      713     9722    3                  CALL CVM;

   9722  2 000401   002426 701000 2                  TSX1    CVM
         2 000402   000000 011000                    NOP     0

      714     9723    3                  IF B$MAP.CTRL(MAPVP) & %PGMOD

   9723  2 000403   200061 470500                    LDP0    MAP$,,AUTO
         2 000404   200013 720100                    LXL0    MAPVP,,AUTO
         2 000405   000000 236110                    LDQ     0,X0,PR0
         2 000406   000036 736000                    QLS     30
         2 000407   020000 376003                    ANQ     8192,DU
         2 000410   000424 600000 2                  TZE     s:9728

      715     9724    4                  THEN DO;

      716     9725    4                       B$MAP.CTRL(MAPVP) = B$MAP.CTRL(MAPVP) & ~%PGMOD;

   9725  2 000411   000000 236110                    LDQ     0,X0,PR0
         2 000412   000036 736000                    QLS     30
         2 000413   750000 376003                    ANQ     -12288,DU
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:133  
         2 000414   000036 772000                    QRL     30
         2 000415   000000 676110                    ERQ     0,X0,PR0
         2 000416   000077 376007                    ANQ     63,DL
         2 000417   000000 656110                    ERSQ    0,X0,PR0

      717     9726    4                       CALL WRITE$PAGE(VP) ALTRET(FM_ERROR);

   9726  2 000420   200025 631500                    EPPR1   VP,,AUTO
         2 000421   200137 451500                    STP1    @SUBC+2,,AUTO
         2 000422   003020 701000 2                  TSX1    WRITE$PAGE
         2 000423   001311 702000 2                  TSX2    FM_ERROR

      718     9727    4                     END;

      719     9728    3                  B$FRAGMAP.HWRD.PAGE_KEY(PAGE_NO_ENTRY) = EVPKEY.PAGE_KEY;

   9728  2 000424   200010 236100                    LDQ     PAGE_NO_ENTRY,,AUTO
         2 000425   000022 402007                    MPY     18,DL
         2 000426   000000 116003                    CMPQ    0,DU
         2 000427   000431 605000 2                  TPL     s:9728+5
         2 000430   000044 036003                    ADLQ    36,DU
         2 000431   200061 470500                    LDP0    MAP$,,AUTO
         2 000432   003106 060500                    CSL     bolr='003'O
         2 000433   200006 250020                    BDSC    EVP,,AUTO                by=1,bit=5,n=16
         2 000434   000000 020020                    BDSC    0,Q,PR0                  by=0,bit=2,n=16

      720     9729    3                  IF H_S1000_FLG THEN

   9729  2 000435   000000 234000 xsym               SZN     H_S1000_FLG
         2 000436   000452 605000 2                  TPL     s:9732

      721     9730    3                       CALL HFC$ASSOCCLR(WSQ,MAPVP,1);

   9730  2 000437   000007 236000 3                  LDQ     7
         2 000440   200150 756100                    STQ     KEY+4,,AUTO
         2 000441   200013 631500                    EPPR1   MAPVP,,AUTO
         2 000442   200147 451500                    STP1    KEY+3,,AUTO
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:134  
         2 000443   200067 633500                    EPPR3   WSQ,,AUTO
         2 000444   200146 453500                    STP3    KEY+2,,AUTO
         2 000445   200146 630500                    EPPR0   KEY+2,,AUTO
         2 000446   000021 631400 xsym               EPPR1   B_VECTNIL+17
         2 000447   000000 701000 xent               TSX1    HFC$ASSOCCLR
         2 000450   000000 011000                    NOP     0
         2 000451   000455 710000 2                  TRA     s:9733

      722     9731    3                  ELSE
      723     9732    3                       CALL HFC$ASSOCCLR;

   9732  2 000452   000002 631400 xsym               EPPR1   B_VECTNIL+2
         2 000453   000000 701000 xent               TSX1    HFC$ASSOCCLR
         2 000454   000000 011000                    NOP     0

      724     9733    3                  IF NOT MM$VCB.CREATE OR EVP <= MM$VCB.MAXVP_WRITTEN

   9733  2 000455   200065 470500                    LDP0    VCB$,,AUTO
         2 000456   000000 236100                    LDQ     0,,PR0
         2 000457   040000 316003                    CANQ    16384,DU
         2 000460   000465 600000 2                  TZE     READ_PAGE
         2 000461   200006 236100                    LDQ     EVP,,AUTO
         2 000462   000472 604000 2                  TMI     INIT_PAGE
         2 000463   000010 116100                    CMPQ    8,,PR0
         2 000464   000472 605400 2                  TPNZ    INIT_PAGE

      725     9734    3                  THEN
      726     9735    3   READ_PAGE:
      727     9736    3                       CALL READ$PAGE (EVP) ALTRET (CANT_READ);

   9736  2 000465   200006 630500       READ_PAGE    EPPR0   EVP,,AUTO
         2 000466   200137 450500                    STP0    @SUBC+2,,AUTO
         2 000467   002636 701000 2                  TSX1    READ$PAGE
         2 000470   000736 702000 2                  TSX2    CANT_READ
         2 000471   000474 710000 2                  TRA     MMV_EXIT

      728     9737    3                  ELSE
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:135  
      729     9738    3   INIT_PAGE:
      730     9739    3                       CALL INIT$PAGE;

   9739  2 000472   003033 701000 2     INIT_PAGE    TSX1    INIT$PAGE
         2 000473   000000 011000                    NOP     0

      731     9740    3   MMV_EXIT:
      732     9741    3                  CALL UNCVM;

   9741  2 000474   002443 701000 2     MMV_EXIT     TSX1    UNCVM
         2 000475   000000 011000                    NOP     0

      733     9742    3                  CALL UDN$MGRES(B_MPT_SAVE);

   9742  2 000476   200102 630500                    EPPR0   B_MPT_SAVE,,AUTO
         2 000477   200146 450500                    STP0    KEY+2,,AUTO
         2 000500   200146 630500                    EPPR0   KEY+2,,AUTO
         2 000501   000017 631400 xsym               EPPR1   B_VECTNIL+15
         2 000502   000000 701000 xent               TSX1    UDN$MGRES
         2 000503   000000 011000                    NOP     0

      734     9743    3                  CALL UDB$AUTO;

   9743  2 000504   000002 631400 xsym               EPPR1   B_VECTNIL+2
         2 000505   000000 701000 xent               TSX1    UDB$AUTO
         2 000506   000000 011000                    NOP     0

      735     9744    3                END;

      736     9745    2           END;

   9745  2 000507   000512 710000 2                  TRA     s:9752

      737     9746    1        ELSE
      738     9747    1             MAPVP = EVP;

   9747  2 000510   200006 235100                    LDA     EVP,,AUTO
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:136  
         2 000511   200013 755100                    STA     MAPVP,,AUTO

      739     9748
      740     9749
      741     9750        /* The chain of virtual pages has now been updated with the page
      742     9751             that is the newest at the head and the oldest is at the tail */
      743     9752    1        IF MM$VCB.PPC < MM$VCB.PPMAX       /* Can get physical                   */

   9752  2 000512   200065 470500                    LDP0    VCB$,,AUTO
         2 000513   000011 220100                    LDX0    9,,PR0
         2 000514   000003 100100                    CMPX0   3,,PR0
         2 000515   000744 603000 2                  TRC     REUSE_PAGE

      744     9753    2        THEN DO;

      745     9754    2             IF MM$VCB.WRITE

   9754  2 000516   000000 236100                    LDQ     0,,PR0
         2 000517   100000 316003                    CANQ    32768,DU
         2 000520   000536 600000 2                  TZE     s:9758

      746     9755    2             THEN
      747     9756    2                  CALL MME$WGVP(WSQ,MAPVP,BITBIN(%PGINMEM|%PGWRITE),ERR) ALTRET(
              9756                           CANT_GET1);

   9756  2 000521   200016 631500                    EPPR1   ERR,,AUTO
         2 000522   200151 451500                    STP1    KEY+5,,AUTO
         2 000523   000011 236000 3                  LDQ     9
         2 000524   200150 756100                    STQ     KEY+4,,AUTO
         2 000525   200013 633500                    EPPR3   MAPVP,,AUTO
         2 000526   200147 453500                    STP3    KEY+3,,AUTO
         2 000527   200067 634500                    EPPR4   WSQ,,AUTO
         2 000530   200146 454500                    STP4    KEY+2,,AUTO
         2 000531   200146 630500                    EPPR0   KEY+2,,AUTO
         2 000532   000022 631400 xsym               EPPR1   B_VECTNIL+18
         2 000533   000000 701000 xent               TSX1    MME$WGVP
         2 000534   001326 702000 2                  TSX2    CANT_GET1
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:137  
         2 000535   000552 710000 2                  TRA     s:9761

      748     9757    2             ELSE
      749     9758    2                  CALL MME$WGVP(WSQ,MAPVP,BITBIN(%PGINMEM),ERR) ALTRET(CANT_GET1);

   9758  2 000536   200016 631500                    EPPR1   ERR,,AUTO
         2 000537   200151 451500                    STP1    KEY+5,,AUTO
         2 000540   000013 236000 3                  LDQ     11
         2 000541   200150 756100                    STQ     KEY+4,,AUTO
         2 000542   200013 633500                    EPPR3   MAPVP,,AUTO
         2 000543   200147 453500                    STP3    KEY+3,,AUTO
         2 000544   200067 634500                    EPPR4   WSQ,,AUTO
         2 000545   200146 454500                    STP4    KEY+2,,AUTO
         2 000546   200146 630500                    EPPR0   KEY+2,,AUTO
         2 000547   000022 631400 xsym               EPPR1   B_VECTNIL+18
         2 000550   000000 701000 xent               TSX1    MME$WGVP
         2 000551   001326 702000 2                  TSX2    CANT_GET1

      750     9759
      751     9760        /* If fragmented set page valid */
      752     9761    2             IF FRAGMENTED

   9761  2 000552   200011 234100                    SZN     FRAGMENTED,,AUTO
         2 000553   000575 605000 2                  TPL     s:9770

      753     9762    3             THEN DO;

      754     9763    3                  B$FRAGMAP.HWRD.KEY_VALID(PAGE_NO_ENTRY) = %TRUE;

   9763  2 000554   200010 236100                    LDQ     PAGE_NO_ENTRY,,AUTO
         2 000555   000022 402007                    MPY     18,DL
         2 000556   000000 116003                    CMPQ    0,DU
         2 000557   000561 605000 2                  TPL     s:9763+5
         2 000560   000044 036003                    ADLQ    36,DU
         2 000561   200061 470500                    LDP0    MAP$,,AUTO
         2 000562   003106 060400                    CSL     bolr='003'O
         2 000563   000030 000001 xsym               BDSC    B_VECTNIL+24             by=0,bit=0,n=1
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:138  
         2 000564   000000 010001                    BDSC    0,Q,PR0                  by=0,bit=1,n=1

      755     9764    3                  B$FRAGMAP.HWRD.PAGE_KEY(PAGE_NO_ENTRY) = EVPKEY.PAGE_KEY;

   9764  2 000565   200010 236100                    LDQ     PAGE_NO_ENTRY,,AUTO
         2 000566   000022 402007                    MPY     18,DL
         2 000567   000000 116003                    CMPQ    0,DU
         2 000570   000572 605000 2                  TPL     s:9764+5
         2 000571   000044 036003                    ADLQ    36,DU
         2 000572   003106 060500                    CSL     bolr='003'O
         2 000573   200006 250020                    BDSC    EVP,,AUTO                by=1,bit=5,n=16
         2 000574   000000 020020                    BDSC    0,Q,PR0                  by=0,bit=2,n=16

      756     9765    3                END;

      757     9766
      758     9767
      759     9768        /* The current usage count in MM$VCB has to be incremented and the
      760     9769             page must be added to the head of the usage chain */
      761     9770    2             CALL FINDMAP(MAPVP);

   9770  2 000575   200013 630500                    EPPR0   MAPVP,,AUTO
         2 000576   200137 450500                    STP0    @SUBC+2,,AUTO
         2 000577   003213 701000 2                  TSX1    FINDMAP
         2 000600   000000 011000                    NOP     0

      762     9771    2             PP = B$MAP.RPN(IPG);          /* Get physical page number           */

   9771  2 000601   200061 470500                    LDP0    MAP$,,AUTO
         2 000602   200035 720100                    LXL0    IPG,,AUTO
         2 000603   000000 236110                    LDQ     0,X0,PR0
         2 000604   000022 772000                    QRL     18
         2 000605   200026 756100                    STQ     PP,,AUTO

      763     9772    2             IF HW_WSQ0PT THEN

   9772  2 000606   000000 234000 xsym               SZN     HW_WSQ0PT
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:139  
         2 000607   000616 605000 2                  TPL     s:9774

      764     9773    2                  PP=B$IPHYMAP$->MM$IPHY_MAP(PP);

   9773  2 000610   200026 235100                    LDA     PP,,AUTO
         2 000611   000001 735000                    ALS     1
         2 000612   000000 471400 xsym               LDP1    B$IPHYMAP$
         2 000613   000100 101505                    MRL     fill='000'O
         2 000614   100000 000002                    ADSC9   0,A,PR1                  cn=0,n=2
         2 000615   200026 000004                    ADSC9   PP,,AUTO                 cn=0,n=4

      765     9774    2             MM$VCB.PPC = MM$VCB.PPC + 1;

   9774  2 000616   200065 471500                    LDP1    VCB$,,AUTO
         2 000617   100011 221100                    LDX1    9,,PR1
         2 000620   000001 622011                    EAX2    1,X1
         2 000621   100011 742100                    STX2    9,,PR1

      766     9775
      767     9776        /* Keep track of the maximum physical we used */
      768     9777    2             IF MM$VCB.PPC > MM$VIRTUAL_STATS.MAXPGS#

   9777  2 000622   200066 473500                    LDP3    STATS$,,AUTO
         2 000623   100011 236100                    LDQ     9,,PR1
         2 000624   000022 772000                    QRL     18
         2 000625   300003 116100                    CMPQ    3,,PR3
         2 000626   000631 602000 2                  TNC     s:9781
         2 000627   000631 600000 2                  TZE     s:9781

      769     9778    2             THEN
      770     9779    2                  MM$VIRTUAL_STATS.MAXPGS# = MM$VCB.PPC;

   9779  2 000630   300003 756100                    STQ     3,,PR3

      771     9780
      772     9781    2             IF MM$VCB.HEAD < 0            /* Empty chain                        */

PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:140  
   9781  2 000631   100006 235100                    LDA     6,,PR1
         2 000632   000647 605000 2                  TPL     s:9792

      773     9782    3             THEN DO;

      774     9783    3                  MM$VCB.HEAD = MAPVP;

   9783  2 000633   200013 236100                    LDQ     MAPVP,,AUTO
         2 000634   100006 756100                    STQ     6,,PR1

      775     9784    3                  MM$VCB.TAIL = MAPVP;

   9784  2 000635   200013 235100                    LDA     MAPVP,,AUTO
         2 000636   100007 755100                    STA     7,,PR1

      776     9785    3                  MM$PPUT.PPNO(PP) = BITBIN('777777777'O); /* Set tail in chain */

   9785  2 000637   000036 236000 1                  LDQ     PGINUSE+2
         2 000640   000011 772000                    QRL     9
         2 000641   000000 474400 xsym               LDP4    B$PPUT$
         2 000642   200026 720100                    LXL0    PP,,AUTO
         2 000643   400000 676110                    ERQ     0,X0,PR4
         2 000644   000032 376000 xsym               ANQ     B_VECTNIL+26
         2 000645   400000 656110                    ERSQ    0,X0,PR4

      777     9786    3                END;

   9786  2 000646   000723 710000 2                  TRA     s:9805

      778     9787    3             ELSE DO;

      779     9788        /* For section page tables, the virtual page chain is linked with the
      780     9789        most recently accessed page at the head.  (new vp are added at the head)
      781     9790        For fragmented and dense page tables, the virtual page chain is linked
      782     9791        with the most recently accessed at the tail (new vps are added at the tail). */
      783     9792    4                  IF SECTION THEN DO;

PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:141  
   9792  2 000647   200012 234100                    SZN     SECTION,,AUTO
         2 000650   000662 605000 2                  TPL     s:9797

      784     9793    4                       MM$PPUT.PPNO(PP)=MM$VCB.HEAD;
              9793                                /* The new page is going to point to the former head */

   9793  2 000651   000000 474400 xsym               LDP4    B$PPUT$
         2 000652   200026 720100                    LXL0    PP,,AUTO
         2 000653   100006 236100                    LDQ     6,,PR1
         2 000654   400000 676110                    ERQ     0,X0,PR4
         2 000655   000032 376000 xsym               ANQ     B_VECTNIL+26
         2 000656   400000 656110                    ERSQ    0,X0,PR4

      785     9794    4                       MM$VCB.HEAD = MAPVP;

   9794  2 000657   200013 235100                    LDA     MAPVP,,AUTO
         2 000660   100006 755100                    STA     6,,PR1

      786     9795    4                     END;

   9795  2 000661   000723 710000 2                  TRA     s:9805

      787     9796    4                  ELSE DO;

      788     9797    4                       IF HW_WSQ0PT THEN

   9797  2 000662   000000 234000 xsym               SZN     HW_WSQ0PT
         2 000663   000703 605000 2                  TPL     s:9800

      789     9798    4                           MM$PPUT.PPNO(B$IPHYMAP$->MM$IPHY_MAP(B$MAP.RPN(MM$VCB.TAIL)
              9798                                     )) = MAPVP;

   9798  2 000664   100007 720100                    LXL0    7,,PR1
         2 000665   000000 236110                    LDQ     0,X0,PR0
         2 000666   000022 772000                    QRL     18
         2 000667   000001 736000                    QLS     1
         2 000670   000000 474400 xsym               LDP4    B$IPHYMAP$
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:142  
         2 000671   000100 100506                    MLR     fill='000'O
         2 000672   400000 000002                    ADSC9   0,Q,PR4                  cn=0,n=2
         2 000673   200146 000004                    ADSC9   KEY+2,,AUTO              cn=0,n=4
         2 000674   200146 220100                    LDX0    KEY+2,,AUTO
         2 000675   000000 475400 xsym               LDP5    B$PPUT$
         2 000676   200013 236100                    LDQ     MAPVP,,AUTO
         2 000677   500000 676110                    ERQ     0,X0,PR5
         2 000700   000032 376000 xsym               ANQ     B_VECTNIL+26
         2 000701   500000 656110                    ERSQ    0,X0,PR5
         2 000702   000712 710000 2                  TRA     s:9801

      790     9799    4                       ELSE
      791     9800    4                            MM$PPUT.PPNO(B$MAP.RPN(MM$VCB.TAIL)) = MAPVP;

   9800  2 000703   100007 720100                    LXL0    7,,PR1
         2 000704   000000 221110                    LDX1    0,X0,PR0
         2 000705   000000 474400 xsym               LDP4    B$PPUT$
         2 000706   200013 236100                    LDQ     MAPVP,,AUTO
         2 000707   400000 676111                    ERQ     0,X1,PR4
         2 000710   000032 376000 xsym               ANQ     B_VECTNIL+26
         2 000711   400000 656111                    ERSQ    0,X1,PR4

      792     9801    4                       MM$VCB.TAIL = MAPVP;

   9801  2 000712   200013 235100                    LDA     MAPVP,,AUTO
         2 000713   100007 755100                    STA     7,,PR1

      793     9802    4                       MM$PPUT.PPNO(PP) = BITBIN('777777777'O);

   9802  2 000714   000036 236000 1                  LDQ     PGINUSE+2
         2 000715   000011 772000                    QRL     9
         2 000716   000000 474400 xsym               LDP4    B$PPUT$
         2 000717   200026 720100                    LXL0    PP,,AUTO
         2 000720   400000 676110                    ERQ     0,X0,PR4
         2 000721   000032 376000 xsym               ANQ     B_VECTNIL+26
         2 000722   400000 656110                    ERSQ    0,X0,PR4

PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:143  
      794     9803    4                     END;

      795     9804    3                END;

      796     9805    2             CALL CVM;

   9805  2 000723   002426 701000 2                  TSX1    CVM
         2 000724   000000 011000                    NOP     0

      797     9806
      798     9807        /* If the file is not in create the page must be read in first */
      799     9808    2             IF NOT MM$VCB.CREATE OR EVP <= MM$VCB.MAXVP_WRITTEN

   9808  2 000725   200065 470500                    LDP0    VCB$,,AUTO
         2 000726   000000 236100                    LDQ     0,,PR0
         2 000727   040000 316003                    CANQ    16384,DU
         2 000730   000735 600000 2                  TZE     s:9810
         2 000731   200006 236100                    LDQ     EVP,,AUTO
         2 000732   000743 604000 2                  TMI     s:9818
         2 000733   000010 116100                    CMPQ    8,,PR0
         2 000734   000743 605400 2                  TPNZ    s:9818

      800     9809    3             THEN DO;

      801     9810    3                  GOTO READ_PAGE;

   9810  2 000735   000465 710000 2                  TRA     READ_PAGE

   9802  2 000736                       CANT_READ    null
      802     9811    3   CANT_READ:     ;
      803     9812    3                  IF READ$PAGE$ERR.CODE ~= %E$NOKEY

   9812  2 000736   200056 236100                    LDQ     READ$PAGE$ERR,,AUTO
         2 000737   377770 376007                    ANQ     131064,DL
         2 000740   001020 116007                    CMPQ    528,DL
         2 000741   000743 600000 2                  TZE     s:9818

PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:144  
      804     9813    4                  THEN DO;

      805     9814    4                       GOTO FM_ERROR;

   9814  2 000742   001311 710000 2                  TRA     FM_ERROR

      806     9815    4                     END;
      807     9816    3                END;
      808     9817             /* Just neet to initialize the page if necessary */
      809     9818    2             GOTO INIT_PAGE;

   9818  2 000743   000472 710000 2                  TRA     INIT_PAGE

      810     9819    2           END;
      811     9820        %EJECT;
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:145  
      812     9821    2        ELSE DO;

   9818  2 000744                       REUSE_PAGE   null
      813     9822    2   REUSE_PAGE: ;
      814     9823                       /* A page has to be released in order to read a new
      815     9824                          page. The page that is used is the tail of the
      816     9825                          page chain if section page tables otherwise use
      817     9826                          head of the chain.
      818     9827         */
      819     9828    2             IF UPD_CHAIN_FLG=%FALSE THEN

   9828  2 000744   200055 234100                    SZN     UPD_CHAIN_FLG,,AUTO
         2 000745   000755 604000 2                  TMI     s:9833

      820     9829    2                  IF SECTION THEN

   9829  2 000746   200012 234100                    SZN     SECTION,,AUTO
         2 000747   000753 605000 2                  TPL     s:9832

      821     9830    2                       CALL UPD_SECT_CHAIN;

   9830  2 000750   003324 701000 2                  TSX1    UPD_SECT_CHAIN
         2 000751   000000 011000                    NOP     0
         2 000752   000755 710000 2                  TRA     s:9833

      822     9831    2                  ELSE
      823     9832    2                       CALL UPD_FRAG_DENSE_CHAIN;

   9832  2 000753   003614 701000 2                  TSX1    UPD_FRAG_DENSE_CHAIN
         2 000754   000000 011000                    NOP     0

      824     9833    3             IF SECTION THEN DO;

   9833  2 000755   200012 234100                    SZN     SECTION,,AUTO
         2 000756   000765 605000 2                  TPL     s:9838

      825     9834    3                  VP = MM$VCB.TAIL;
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:146  

   9834  2 000757   200065 470500                    LDP0    VCB$,,AUTO
         2 000760   000007 235100                    LDA     7,,PR0
         2 000761   200025 755100                    STA     VP,,AUTO

      826     9835    3                  MM$VCB.TAIL=PREDT;

   9835  2 000762   200034 236100                    LDQ     PREDT,,AUTO
         2 000763   000007 756100                    STQ     7,,PR0

      827     9836    3                END;

   9836  2 000764   000770 710000 2                  TRA     s:9839

      828     9837    2             ELSE
      829     9838    2                  VP = MM$VCB.HEAD;

   9838  2 000765   200065 470500                    LDP0    VCB$,,AUTO
         2 000766   000006 235100                    LDA     6,,PR0
         2 000767   200025 755100                    STA     VP,,AUTO

      830     9839    2             CALL FINDMAP(VP);

   9839  2 000770   200025 631500                    EPPR1   VP,,AUTO
         2 000771   200137 451500                    STP1    @SUBC+2,,AUTO
         2 000772   003213 701000 2                  TSX1    FINDMAP
         2 000773   000000 011000                    NOP     0

      831     9840    2             PP = B$MAP.RPN(IPG);          /* Get physical page                  */

   9840  2 000774   200061 470500                    LDP0    MAP$,,AUTO
         2 000775   200035 720100                    LXL0    IPG,,AUTO
         2 000776   000000 236110                    LDQ     0,X0,PR0
         2 000777   000022 772000                    QRL     18
         2 001000   200026 756100                    STQ     PP,,AUTO

      832     9841    2             IF HW_WSQ0PT THEN
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:147  

   9841  2 001001   000000 234000 xsym               SZN     HW_WSQ0PT
         2 001002   001011 605000 2                  TPL     s:9844

      833     9842    2                  PP=B$IPHYMAP$->MM$IPHY_MAP(PP);

   9842  2 001003   200026 235100                    LDA     PP,,AUTO
         2 001004   000001 735000                    ALS     1
         2 001005   000000 471400 xsym               LDP1    B$IPHYMAP$
         2 001006   000100 101505                    MRL     fill='000'O
         2 001007   100000 000002                    ADSC9   0,A,PR1                  cn=0,n=2
         2 001010   200026 000004                    ADSC9   PP,,AUTO                 cn=0,n=4

      834     9843             /* Map it on to SBUF2 so we have access to it */
      835     9844    2             CALL CVM;

   9844  2 001011   002426 701000 2                  TSX1    CVM
         2 001012   000000 011000                    NOP     0

      836     9845
      837     9846             /* If the page has been modified write it out */
      838     9847    2             IF B$MAP.CTRL(IPG) & %PGMOD

   9847  2 001013   200061 470500                    LDP0    MAP$,,AUTO
         2 001014   200035 720100                    LXL0    IPG,,AUTO
         2 001015   000000 236110                    LDQ     0,X0,PR0
         2 001016   000036 736000                    QLS     30
         2 001017   020000 376003                    ANQ     8192,DU
         2 001020   001053 600000 2                  TZE     s:9859

      839     9848    3             THEN DO;

      840     9849    3                  IF FRAGMENTED  /* Need to calculate VP and reset key_valid */

   9849  2 001021   200011 234100                    SZN     FRAGMENTED,,AUTO
         2 001022   001047 605000 2                  TPL     s:9857

PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:148  
      841     9850    4                  THEN DO;

      842     9851    4                       I = VP - 128;

   9851  2 001023   200025 235100                    LDA     VP,,AUTO
         2 001024   000200 135007                    SBLA    128,DL
         2 001025   200017 755100                    STA     I,,AUTO

      843     9852    4                       B$FRAGHWRD = B$FRAGMAP.HWRD(I);

   9852  2 001026   000001 735000                    ALS     1
         2 001027   000100 100505                    MLR     fill='000'O
         2 001030   000000 000002                    ADSC9   0,A,PR0                  cn=0,n=2
         2 001031   200100 000002                    ADSC9   B$FRAGHWRD,,AUTO         cn=0,n=2

      844     9853    4                       NXTVP = B$FRAGHWRD.PAGE_KEY * 64 + I /4;

   9853  2 001032   200017 236100                    LDQ     I,,AUTO
         2 001033   000004 506007                    DIV     4,DL
         2 001034   200146 756100                    STQ     KEY+2,,AUTO
         2 001035   200100 236100                    LDQ     B$FRAGHWRD,,AUTO
         2 001036   000014 772000                    QRL     12
         2 001037   000006 376000 3                  ANQ     6
         2 001040   200146 036100                    ADLQ    KEY+2,,AUTO
         2 001041   200027 756100                    STQ     NXTVP,,AUTO

      845     9854    4                       CALL WRITE$PAGE(NXTVP) ALTRET(FM_ERROR);

   9854  2 001042   200027 631500                    EPPR1   NXTVP,,AUTO
         2 001043   200137 451500                    STP1    @SUBC+2,,AUTO
         2 001044   003020 701000 2                  TSX1    WRITE$PAGE
         2 001045   001311 702000 2                  TSX2    FM_ERROR

      846     9855    4                     END;

   9855  2 001046   001053 710000 2                  TRA     s:9859

PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:149  
      847     9856    3                  ELSE
      848     9857    3                       CALL WRITE$PAGE (VP) ALTRET (FM_ERROR);

   9857  2 001047   200025 631500                    EPPR1   VP,,AUTO
         2 001050   200137 451500                    STP1    @SUBC+2,,AUTO
         2 001051   003020 701000 2                  TSX1    WRITE$PAGE
         2 001052   001311 702000 2                  TSX2    FM_ERROR

      849     9858    3                END;

      850     9859    2             IF FRAGMENTED

   9859  2 001053   200011 234100                    SZN     FRAGMENTED,,AUTO
         2 001054   001106 605000 2                  TPL     s:9866

      851     9860    3             THEN DO;

      852     9861    3                  B$FRAGMAP.HWRD.KEY_VALID(VP - 128) = %FALSE;

   9861  2 001055   200025 236100                    LDQ     VP,,AUTO
         2 001056   000022 402007                    MPY     18,DL
         2 001057   000000 116003                    CMPQ    0,DU
         2 001060   001062 605000 2                  TPL     s:9861+5
         2 001061   000044 036003                    ADLQ    36,DU
         2 001062   200061 470500                    LDP0    MAP$,,AUTO
         2 001063   003106 060400                    CSL     bolr='003'O
         2 001064   000002 000001 xsym               BDSC    B_VECTNIL+2              by=0,bit=0,n=1
         2 001065   077700 010001                    BDSC    -64,Q,PR0                by=0,bit=1,n=1

      853     9862    3                  B$FRAGMAP.HWRD.KEY_VALID(PAGE_NO_ENTRY) = %TRUE;

   9862  2 001066   200010 236100                    LDQ     PAGE_NO_ENTRY,,AUTO
         2 001067   000022 402007                    MPY     18,DL
         2 001070   000000 116003                    CMPQ    0,DU
         2 001071   001073 605000 2                  TPL     s:9862+5
         2 001072   000044 036003                    ADLQ    36,DU
         2 001073   003106 060400                    CSL     bolr='003'O
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:150  
         2 001074   000030 000001 xsym               BDSC    B_VECTNIL+24             by=0,bit=0,n=1
         2 001075   000000 010001                    BDSC    0,Q,PR0                  by=0,bit=1,n=1

      854     9863    3                  B$FRAGMAP.HWRD.PAGE_KEY(PAGE_NO_ENTRY) = EVPKEY.PAGE_KEY;

   9863  2 001076   200010 236100                    LDQ     PAGE_NO_ENTRY,,AUTO
         2 001077   000022 402007                    MPY     18,DL
         2 001100   000000 116003                    CMPQ    0,DU
         2 001101   001103 605000 2                  TPL     s:9863+5
         2 001102   000044 036003                    ADLQ    36,DU
         2 001103   003106 060500                    CSL     bolr='003'O
         2 001104   200006 250020                    BDSC    EVP,,AUTO                by=1,bit=5,n=16
         2 001105   000000 020020                    BDSC    0,Q,PR0                  by=0,bit=2,n=16

      855     9864    3                END;

      856     9865
      857     9866    2             BTEMP=B$MAP(IPG);

   9866  2 001106   200061 470500                    LDP0    MAP$,,AUTO
         2 001107   200035 720100                    LXL0    IPG,,AUTO
         2 001110   000000 236110                    LDQ     0,X0,PR0
         2 001111   200060 756100                    STQ     TEMP,,AUTO

      858     9867    2             B$MAP(IPG)=MM_FPMC;

   9867  2 001112   000000 236000 xsym               LDQ     MM_FPMC
         2 001113   000000 756110                    STQ     0,X0,PR0

      859     9868    2             CALL FINDMAP(MAPVP);

   9868  2 001114   200013 631500                    EPPR1   MAPVP,,AUTO
         2 001115   200137 451500                    STP1    @SUBC+2,,AUTO
         2 001116   003213 701000 2                  TSX1    FINDMAP
         2 001117   000000 011000                    NOP     0

      860     9869    2             B$MAP(IPG) = BTEMP;           /* Set up new ptw                     */
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:151  

   9869  2 001120   200060 236100                    LDQ     TEMP,,AUTO
         2 001121   200061 470500                    LDP0    MAP$,,AUTO
         2 001122   200035 720100                    LXL0    IPG,,AUTO
         2 001123   000000 756110                    STQ     0,X0,PR0

      861     9870    2             B$MAP.CTRL(IPG) = B$MAP.CTRL(IPG) & ~%PGMOD;

   9870  2 001124   200035 720100                    LXL0    IPG,,AUTO
         2 001125   000000 236110                    LDQ     0,X0,PR0
         2 001126   000036 736000                    QLS     30
         2 001127   750000 376003                    ANQ     -12288,DU
         2 001130   000036 772000                    QRL     30
         2 001131   000000 676110                    ERQ     0,X0,PR0
         2 001132   000077 376007                    ANQ     63,DL
         2 001133   000000 656110                    ERSQ    0,X0,PR0

      862     9871    2             IF H_S1000_FLG THEN

   9871  2 001134   000000 234000 xsym               SZN     H_S1000_FLG
         2 001135   001151 605000 2                  TPL     s:9874

      863     9872    2                  CALL HFC$ASSOCCLR(WSQ,IPG,1);

   9872  2 001136   000007 236000 3                  LDQ     7
         2 001137   200150 756100                    STQ     KEY+4,,AUTO
         2 001140   200035 631500                    EPPR1   IPG,,AUTO
         2 001141   200147 451500                    STP1    KEY+3,,AUTO
         2 001142   200067 633500                    EPPR3   WSQ,,AUTO
         2 001143   200146 453500                    STP3    KEY+2,,AUTO
         2 001144   200146 630500                    EPPR0   KEY+2,,AUTO
         2 001145   000021 631400 xsym               EPPR1   B_VECTNIL+17
         2 001146   000000 701000 xent               TSX1    HFC$ASSOCCLR
         2 001147   000000 011000                    NOP     0
         2 001150   001154 710000 2                  TRA     s:9878

      864     9873    2             ELSE
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:152  
      865     9874    2                  CALL HFC$ASSOCCLR;

   9874  2 001151   000002 631400 xsym               EPPR1   B_VECTNIL+2
         2 001152   000000 701000 xent               TSX1    HFC$ASSOCCLR
         2 001153   000000 011000                    NOP     0

      866     9875
      867     9876             /* Remove page from the tail and put it on the head if section*/
      868     9877             /* Remove page from the head and put it on the tail if frag or dense*/
      869     9878    3             IF SECTION THEN DO;

   9878  2 001154   200012 234100                    SZN     SECTION,,AUTO
         2 001155   001231 605000 2                  TPL     s:9888

      870     9879    3                  MM$PPUT.PPNO(PP)=MM$VCB.HEAD;

   9879  2 001156   000000 470400 xsym               LDP0    B$PPUT$
         2 001157   200026 720100                    LXL0    PP,,AUTO
         2 001160   200065 471500                    LDP1    VCB$,,AUTO
         2 001161   100006 236100                    LDQ     6,,PR1
         2 001162   000000 676110                    ERQ     0,X0,PR0
         2 001163   000032 376000 xsym               ANQ     B_VECTNIL+26
         2 001164   000000 656110                    ERSQ    0,X0,PR0

      871     9880    3                  MM$VCB.HEAD=MAPVP;

   9880  2 001165   200013 235100                    LDA     MAPVP,,AUTO
         2 001166   100006 755100                    STA     6,,PR1

      872     9881    3                  CALL FINDMAP(MM$VCB.TAIL);

   9881  2 001167   200065 236100                    LDQ     VCB$,,AUTO
         2 001170   000007 036003                    ADLQ    7,DU
         2 001171   200137 756100                    STQ     @SUBC+2,,AUTO
         2 001172   003213 701000 2                  TSX1    FINDMAP
         2 001173   000000 011000                    NOP     0

PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:153  
      873     9882    3                  IF HW_WSQ0PT THEN

   9882  2 001174   000000 234000 xsym               SZN     HW_WSQ0PT
         2 001175   001217 605000 2                  TPL     s:9885

      874     9883    3                       MM$PPUT.PPNO(B$IPHYMAP$->MM$IPHY_MAP(B$MAP.RPN(IPG)))=BITBIN(
              9883                                '777777777'O);

   9883  2 001176   200061 470500                    LDP0    MAP$,,AUTO
         2 001177   200035 720100                    LXL0    IPG,,AUTO
         2 001200   000000 236110                    LDQ     0,X0,PR0
         2 001201   000022 772000                    QRL     18
         2 001202   000001 736000                    QLS     1
         2 001203   000000 471400 xsym               LDP1    B$IPHYMAP$
         2 001204   000100 100506                    MLR     fill='000'O
         2 001205   100000 000002                    ADSC9   0,Q,PR1                  cn=0,n=2
         2 001206   200146 000004                    ADSC9   KEY+2,,AUTO              cn=0,n=4
         2 001207   200146 221100                    LDX1    KEY+2,,AUTO
         2 001210   000036 236000 1                  LDQ     PGINUSE+2
         2 001211   000011 772000                    QRL     9
         2 001212   000000 473400 xsym               LDP3    B$PPUT$
         2 001213   300000 676111                    ERQ     0,X1,PR3
         2 001214   000032 376000 xsym               ANQ     B_VECTNIL+26
         2 001215   300000 656111                    ERSQ    0,X1,PR3
         2 001216   001277 710000 2                  TRA     s:9898

      875     9884    3                  ELSE
      876     9885    3                       MM$PPUT.PPNO(B$MAP.RPN(IPG)) = BITBIN('777777777'O);

   9885  2 001217   200061 470500                    LDP0    MAP$,,AUTO
         2 001220   200035 720100                    LXL0    IPG,,AUTO
         2 001221   000000 221110                    LDX1    0,X0,PR0
         2 001222   000036 236000 1                  LDQ     PGINUSE+2
         2 001223   000011 772000                    QRL     9
         2 001224   000000 471400 xsym               LDP1    B$PPUT$
         2 001225   100000 676111                    ERQ     0,X1,PR1
         2 001226   000032 376000 xsym               ANQ     B_VECTNIL+26
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:154  
         2 001227   100000 656111                    ERSQ    0,X1,PR1

      877     9886    3                END;

   9886  2 001230   001277 710000 2                  TRA     s:9898

      878     9887    3             ELSE DO;

      879     9888    3                  MM$VCB.HEAD = MM$PPUT.PPNO(PP);

   9888  2 001231   000000 470400 xsym               LDP0    B$PPUT$
         2 001232   200026 720100                    LXL0    PP,,AUTO
         2 001233   000000 236110                    LDQ     0,X0,PR0
         2 001234   000032 376000 xsym               ANQ     B_VECTNIL+26
         2 001235   200065 471500                    LDP1    VCB$,,AUTO
         2 001236   100006 756100                    STQ     6,,PR1

      880     9889    3                  IF HW_WSQ0PT THEN

   9889  2 001237   000000 234000 xsym               SZN     HW_WSQ0PT
         2 001240   001260 605000 2                  TPL     s:9892

      881     9890    3                       MM$PPUT.PPNO(B$IPHYMAP$->MM$IPHY_MAP(B$MAP.RPN(MM$VCB.TAIL))) =
              9890                                MAPVP;

   9890  2 001241   100007 720100                    LXL0    7,,PR1
         2 001242   200061 473500                    LDP3    MAP$,,AUTO
         2 001243   300000 236110                    LDQ     0,X0,PR3
         2 001244   000022 772000                    QRL     18
         2 001245   000001 736000                    QLS     1
         2 001246   000000 474400 xsym               LDP4    B$IPHYMAP$
         2 001247   000100 100506                    MLR     fill='000'O
         2 001250   400000 000002                    ADSC9   0,Q,PR4                  cn=0,n=2
         2 001251   200146 000004                    ADSC9   KEY+2,,AUTO              cn=0,n=4
         2 001252   200146 220100                    LDX0    KEY+2,,AUTO
         2 001253   200013 236100                    LDQ     MAPVP,,AUTO
         2 001254   000000 676110                    ERQ     0,X0,PR0
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:155  
         2 001255   000032 376000 xsym               ANQ     B_VECTNIL+26
         2 001256   000000 656110                    ERSQ    0,X0,PR0
         2 001257   001267 710000 2                  TRA     s:9893

      882     9891    3                  ELSE
      883     9892    3                       MM$PPUT.PPNO(B$MAP.RPN(MM$VCB.TAIL)) = MAPVP;

   9892  2 001260   100007 720100                    LXL0    7,,PR1
         2 001261   200061 473500                    LDP3    MAP$,,AUTO
         2 001262   300000 221110                    LDX1    0,X0,PR3
         2 001263   200013 236100                    LDQ     MAPVP,,AUTO
         2 001264   000000 676111                    ERQ     0,X1,PR0
         2 001265   000032 376000 xsym               ANQ     B_VECTNIL+26
         2 001266   000000 656111                    ERSQ    0,X1,PR0

      884     9893    3                  MM$VCB.TAIL = MAPVP;

   9893  2 001267   200013 235100                    LDA     MAPVP,,AUTO
         2 001270   100007 755100                    STA     7,,PR1

      885     9894    3                  MM$PPUT.PPNO(PP) = BITBIN('777777777'O);

   9894  2 001271   000036 236000 1                  LDQ     PGINUSE+2
         2 001272   000011 772000                    QRL     9
         2 001273   200026 720100                    LXL0    PP,,AUTO
         2 001274   000000 676110                    ERQ     0,X0,PR0
         2 001275   000032 376000 xsym               ANQ     B_VECTNIL+26
         2 001276   000000 656110                    ERSQ    0,X0,PR0

      886     9895    3                END;

      887     9896
      888     9897             /* Read in new page if necessary */
      889     9898    2             IF NOT MM$VCB.CREATE OR EVP <= MM$VCB.MAXVP_WRITTEN

   9898  2 001277   200065 470500                    LDP0    VCB$,,AUTO
         2 001300   000000 236100                    LDQ     0,,PR0
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:156  
         2 001301   040000 316003                    CANQ    16384,DU
         2 001302   001307 600000 2                  TZE     s:9900
         2 001303   200006 236100                    LDQ     EVP,,AUTO
         2 001304   001310 604000 2                  TMI     s:9903
         2 001305   000010 116100                    CMPQ    8,,PR0
         2 001306   001310 605400 2                  TPNZ    s:9903

      890     9899    3             THEN DO;

      891     9900    3                  GOTO READ_PAGE;

   9900  2 001307   000465 710000 2                  TRA     READ_PAGE

      892     9901    3                END;
      893     9902
      894     9903    2             GOTO INIT_PAGE;

   9903  2 001310   000472 710000 2                  TRA     INIT_PAGE

   9894  2 001311                       FM_ERROR     null
      895     9904
      896     9905    2           END;
      897     9906
      898     9907    1   FM_ERROR: ;
      899     9908    1        CALL UNCVM;

   9908  2 001311   002443 701000 2                  TSX1    UNCVM
         2 001312   000000 011000                    NOP     0

      900     9909             %ERRSETN (CODE=READ$PAGE$ERR.CODE);

   9910  2 001313   200056 236100                    LDQ     READ$PAGE$ERR,,AUTO
         2 001314   000003 772000                    QRL     3
         2 001315   037777 376007                    ANQ     16383,DL
         2 001316   000003 736000                    QLS     3
         2 001317   000032 276000 1                  ORQ     MMERR
         2 001320   000000 470400 xsym               LDP0    B$JIT$
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:157  
         2 001321   000012 756100                    STQ     10,,PR0

      901     9912    1        CALL ABORTM(%SUBC_VIRTERR#);

   9912  2 001322   000015 236000 3                  LDQ     13
         2 001323   200135 756100                    STQ     READ_PAGE+15,,AUTO
         2 001324   003064 701000 2                  TSX1    ABORTM
         2 001325   000000 011000                    NOP     0

   9910  2 001326                       CANT_GET1    null
      902     9913
      903     9914    1   CANT_GET1: ;                  /* Must reset the key valid bit if fragmented */
      904     9915    1        IF MM$VCB.PPC >= MM$VCB.PPMIN

   9915  2 001326   200065 470500                    LDP0    VCB$,,AUTO
         2 001327   000003 720100                    LXL0    3,,PR0
         2 001330   000011 100100                    CMPX0   9,,PR0
         2 001331   000744 602000 2                  TNC     REUSE_PAGE
         2 001332   000744 600000 2                  TZE     REUSE_PAGE

   9915  2 001333                       CANT_GET     null
      905     9916    1        THEN
      906     9917    1             GOTO REUSE_PAGE;
      907     9918    1   CANT_GET: ;
      908     9919             %ERRSETN(CODE=ERR);

   9920  2 001333   200016 236100                    LDQ     ERR,,AUTO
         2 001334   000003 736000                    QLS     3
         2 001335   000032 276000 1                  ORQ     MMERR
         2 001336   000000 470400 xsym               LDP0    B$JIT$
         2 001337   000012 756100                    STQ     10,,PR0

      909     9922    1        CALL ABORTM(%SUBC_VIRTERR#);

   9922  2 001340   000015 236000 3                  LDQ     13
         2 001341   200135 756100                    STQ     READ_PAGE+15,,AUTO
         2 001342   003064 701000 2                  TSX1    ABORTM
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:158  
         2 001343   000000 011000                    NOP     0
         2 001344   001347 710000 2                  TRA     s:9931

      910     9923
      911     9924        %EJECT;
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:159  
      912     9925        /*F* NAME: MMV$CLOSE
      913     9926             PURPOSE: To write out all pages that have been modified and
      914     9927                      to release all memory for the large virtual segment.
      915     9928                        */
      916     9929    1   MMV$CLOSE: ENTRY ALTRET;

   9929  2 001345   000000 700200 xent  MMV$CLOSE    TSX0  ! X66_AUTO_3
         2 001346   000154 000003                    ZERO    108,3

      917     9930
      918     9931    1        VCB$ = B$JIT.DCB$ -> F$DCB.SETSTA$;

   9931  2 001347   000000 470400 xsym               LDP0    B$JIT$
         2 001350   000232 471500                    LDP1    154,,PR0
         2 001351   100006 236100                    LDQ     6,,PR1
         2 001352   200065 756100                    STQ     VCB$,,AUTO

      919     9932    1        STATS$ = B$JIT.DCB$ -> F$DCB.LASTSTA$;

   9932  2 001353   100007 236100                    LDQ     7,,PR1
         2 001354   200066 756100                    STQ     STATS$,,AUTO

      920     9933    1        TLNACC = MM$VCB.SEGNUM;

   9933  2 001355   200065 473500                    LDP3    VCB$,,AUTO
         2 001356   300000 236100                    LDQ     0,,PR3
         2 001357   000777 376007                    ANQ     511,DL
         2 001360   200021 756100                    STQ     TLNACC,,AUTO

      921     9934    2        DO CASE (TLNACC);

   9934  2 001361   000004 116007                    CMPQ    4,DL
         2 001362   001364 602006 2                  TNC     s:9934+3,QL
         2 001363   001422 710000 2                  TRA     s:9948
         2 001364   001422 710000 2                  TRA     s:9948
         2 001365   001370 710000 2                  TRA     s:9936
         2 001366   001400 710000 2                  TRA     s:9940
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:160  
         2 001367   001411 710000 2                  TRA     s:9944

      922     9935    2        CASE (%VS1#);

      923     9936    2           HDACC = %VS1PGTBL;

   9936  2 001370   001050 235007                    LDA     552,DL
         2 001371   200024 755100                    STA     HDACC,,AUTO

      924     9937    2           DCB# = B$JIT.VIRTUAL.DCB#(0);

   9937  2 001372   000217 236100                    LDQ     143,,PR0
         2 001373   000033 772000                    QRL     27
         2 001374   200014 756100                    STQ     DCB#,,AUTO

      925     9938    2           SEGID = %VS1SID;

   9938  2 001375   603200 236003                    LDQ     -63872,DU
         2 001376   200057 756100                    STQ     SEGID,,AUTO
         2 001377   001423 710000 2                  TRA     s:9952

      926     9939    2        CASE (%VS2#);

      927     9940    2           HDACC = %VS2PGTBL;

   9940  2 001400   001070 235007                    LDA     568,DL
         2 001401   200024 755100                    STA     HDACC,,AUTO

      928     9941    2           DCB# = B$JIT.VIRTUAL.DCB#(1);

   9941  2 001402   000217 236100                    LDQ     143,,PR0
         2 001403   000022 772000                    QRL     18
         2 001404   000777 376007                    ANQ     511,DL
         2 001405   200014 756100                    STQ     DCB#,,AUTO

      929     9942    2           SEGID = %VS2SID;

PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:161  
   9942  2 001406   603300 236003                    LDQ     -63808,DU
         2 001407   200057 756100                    STQ     SEGID,,AUTO
         2 001410   001423 710000 2                  TRA     s:9952

      930     9943    2        CASE (%VS3#);

      931     9944    2           HDACC = %VS3PGTBL;

   9944  2 001411   001110 235007                    LDA     584,DL
         2 001412   200024 755100                    STA     HDACC,,AUTO

      932     9945    2           DCB# = B$JIT.VIRTUAL.DCB#(2);

   9945  2 001413   000217 236100                    LDQ     143,,PR0
         2 001414   000011 772000                    QRL     9
         2 001415   000777 376007                    ANQ     511,DL
         2 001416   200014 756100                    STQ     DCB#,,AUTO

      933     9946    2           SEGID = %VS3SID;

   9946  2 001417   603400 236003                    LDQ     -63744,DU
         2 001420   200057 756100                    STQ     SEGID,,AUTO
         2 001421   001423 710000 2                  TRA     s:9952

      934     9947    2        CASE (ELSE);

      935     9948    2           RETURN;

   9948  2 001422   000000 702200 xent               TSX2  ! X66_ARET

      936     9949    2        END;

      937     9950
      938     9951
      939     9952    1        WSQ = MM$VCB.WSQ;

   9952  2 001423   300000 236100                    LDQ     0,,PR3
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:162  
         2 001424   000022 772000                    QRL     18
         2 001425   000777 376007                    ANQ     511,DL
         2 001426   200067 756100                    STQ     WSQ,,AUTO

      940     9953             %FINDMAP (WSQ=WSQ,P$=MAP$);

   9954  2 001427   000000 236006 xsym               LDQ     MM_PTPTRS$,QL
         2 001430   200061 756100                    STQ     MAP$,,AUTO

      941     9956    1        IF DCB# = 0                        /* HAVEN'T BEEN INITED YET*/

   9956  2 001431   200014 235100                    LDA     DCB#,,AUTO
         2 001432   001434 601000 2                  TNZ     s:9961

      942     9957    1        THEN
      943     9958    1             RETURN;

   9958  2 001433   000000 702200 xent               TSX2  ! X66_ARET

      944     9959
      945     9960        /* Set write flag if the file will be saved. */
      946     9961    1        IF B$JIT.DCB$->F$DCB.CFU$->FM$CFU.NAMEX ~= 0 OR B$JIT.JUNK & %JJ_MLINKIP#

   9961  2 001434   100066 474500                    LDP4    54,,PR1
         2 001435   400002 720100                    LXL0    2,,PR4
         2 001436   001442 601000 2                  TNZ     s:9963
         2 001437   000315 221100                    LDX1    205,,PR0
         2 001440   000001 361003                    ANX1    1,DU
         2 001441   001445 600000 2                  TZE     s:9965

      947     9962    1        THEN
      948     9963    1             WRITE_FLAG = '1'B;

   9963  2 001442   400000 236003                    LDQ     -131072,DU
         2 001443   200015 756100                    STQ     WRITE_FLAG,,AUTO
         2 001444   001446 710000 2                  TRA     s:9969

PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:163  
      949     9964    1        ELSE
      950     9965    1             WRITE_FLAG = '0'B;

   9965  2 001445   200015 450100                    STZ     WRITE_FLAG,,AUTO

      951     9966
      952     9967        /* Write out all pages that have %PGMOD set and then release them */
      953     9968
      954     9969    1        TEMP = MM$VCB.PPC;

   9969  2 001446   300011 236100                    LDQ     9,,PR3
         2 001447   000022 772000                    QRL     18
         2 001450   200060 756100                    STQ     TEMP,,AUTO

      955     9970    1        VP = MM$VCB.HEAD;

   9970  2 001451   300006 235100                    LDA     6,,PR3
         2 001452   200025 755100                    STA     VP,,AUTO

      956     9971
      957     9972    2        DO I = 1 TO TEMP;

   9972  2 001453   000001 235007                    LDA     1,DL
         2 001454   200017 755100                    STA     I,,AUTO
         2 001455   001600 710000 2                  TRA     s:9996+1

      958     9973    2             CALL FINDMAP(VP);

   9973  2 001456   200025 630500                    EPPR0   VP,,AUTO
         2 001457   200137 450500                    STP0    @SUBC+2,,AUTO
         2 001460   003213 701000 2                  TSX1    FINDMAP
         2 001461   000000 011000                    NOP     0

      959     9974    2             PP = B$MAP.RPN(IPG);

   9974  2 001462   200061 470500                    LDP0    MAP$,,AUTO
         2 001463   200035 720100                    LXL0    IPG,,AUTO
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:164  
         2 001464   000000 236110                    LDQ     0,X0,PR0
         2 001465   000022 772000                    QRL     18
         2 001466   200026 756100                    STQ     PP,,AUTO

      960     9975    2             IF HW_WSQ0PT THEN

   9975  2 001467   000000 234000 xsym               SZN     HW_WSQ0PT
         2 001470   001477 605000 2                  TPL     s:9977

      961     9976    2                  PP=B$IPHYMAP$->MM$IPHY_MAP(PP);

   9976  2 001471   200026 235100                    LDA     PP,,AUTO
         2 001472   000001 735000                    ALS     1
         2 001473   000000 471400 xsym               LDP1    B$IPHYMAP$
         2 001474   000100 101505                    MRL     fill='000'O
         2 001475   100000 000002                    ADSC9   0,A,PR1                  cn=0,n=2
         2 001476   200026 000004                    ADSC9   PP,,AUTO                 cn=0,n=4

      962     9977    2             NXTVP = MM$PPUT.PPNO(PP);

   9977  2 001477   000000 471400 xsym               LDP1    B$PPUT$
         2 001500   200026 721100                    LXL1    PP,,AUTO
         2 001501   100000 236111                    LDQ     0,X1,PR1
         2 001502   000032 376000 xsym               ANQ     B_VECTNIL+26
         2 001503   200027 756100                    STQ     NXTVP,,AUTO

      963     9978    2             MM$VCB.HEAD = NXTVP;

   9978  2 001504   200065 473500                    LDP3    VCB$,,AUTO
         2 001505   300006 756100                    STQ     6,,PR3

      964     9979    2             MM$VCB.PPC = MM$VCB.PPC - 1;

   9979  2 001506   300011 220100                    LDX0    9,,PR3
         2 001507   777777 621010                    EAX1    -1,X0
         2 001510   300011 741100                    STX1    9,,PR3

PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:165  
      965     9980    2             IF B$MAP.CTRL(IPG) & %PGMOD AND WRITE_FLAG

   9980  2 001511   200035 720100                    LXL0    IPG,,AUTO
         2 001512   000000 236110                    LDQ     0,X0,PR0
         2 001513   000036 736000                    QLS     30
         2 001514   020000 376003                    ANQ     8192,DU
         2 001515   001561 600000 2                  TZE     s:9994
         2 001516   200015 234100                    SZN     WRITE_FLAG,,AUTO
         2 001517   001561 605000 2                  TPL     s:9994

      966     9981    3             THEN DO;

      967     9982    3                  CALL CVM;

   9982  2 001520   002426 701000 2                  TSX1    CVM
         2 001521   000000 011000                    NOP     0

      968     9983    3                  IF MM$VCB.T.FRAGMENTED   /* fragmented page table */

   9983  2 001522   200065 470500                    LDP0    VCB$,,AUTO
         2 001523   000000 236100                    LDQ     0,,PR0
         2 001524   020000 316003                    CANQ    8192,DU
         2 001525   001553 600000 2                  TZE     s:9991

      969     9984    4                  THEN DO;

      970     9985    4                       EVP = VP-128;

   9985  2 001526   200025 235100                    LDA     VP,,AUTO
         2 001527   000200 135007                    SBLA    128,DL
         2 001530   200006 755100                    STA     EVP,,AUTO

      971     9986    4                       B$FRAGHWRD = B$FRAGMAP.HWRD(EVP);

   9986  2 001531   000001 735000                    ALS     1
         2 001532   200061 471500                    LDP1    MAP$,,AUTO
         2 001533   000100 100505                    MLR     fill='000'O
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:166  
         2 001534   100000 000002                    ADSC9   0,A,PR1                  cn=0,n=2
         2 001535   200100 000002                    ADSC9   B$FRAGHWRD,,AUTO         cn=0,n=2

      972     9987    4                       EVP = B$FRAGHWRD.PAGE_KEY * 64 + EVP/4;

   9987  2 001536   200006 236100                    LDQ     EVP,,AUTO
         2 001537   000002 772000                    QRL     2
         2 001540   200146 756100                    STQ     KEY+2,,AUTO
         2 001541   200100 236100                    LDQ     B$FRAGHWRD,,AUTO
         2 001542   000014 772000                    QRL     12
         2 001543   000006 376000 3                  ANQ     6
         2 001544   200146 036100                    ADLQ    KEY+2,,AUTO
         2 001545   200006 756100                    STQ     EVP,,AUTO

      973     9988    4                       CALL WRITE$PAGE (EVP);

   9988  2 001546   200006 633500                    EPPR3   EVP,,AUTO
         2 001547   200137 453500                    STP3    @SUBC+2,,AUTO
         2 001550   003020 701000 2                  TSX1    WRITE$PAGE
         2 001551   000000 011000                    NOP     0

      974     9989    4                     END;

   9989  2 001552   001557 710000 2                  TRA     s:9992

      975     9990    3                  ELSE
      976     9991    3                       CALL WRITE$PAGE(VP);

   9991  2 001553   200025 631500                    EPPR1   VP,,AUTO
         2 001554   200137 451500                    STP1    @SUBC+2,,AUTO
         2 001555   003020 701000 2                  TSX1    WRITE$PAGE
         2 001556   000000 011000                    NOP     0

      977     9992    3                  CALL UNCVM;

   9992  2 001557   002443 701000 2                  TSX1    UNCVM
         2 001560   000000 011000                    NOP     0
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:167  

      978     9993    3                END;

      979     9994    2             CALL MME$WFVP(WSQ,VP,,ERR) ALTRET(MM_ERROR);

   9994  2 001561   200016 630500                    EPPR0   ERR,,AUTO
         2 001562   200151 450500                    STP0    KEY+5,,AUTO
         2 001563   000001 236000 xsym               LDQ     B_VECTNIL+1
         2 001564   200150 756100                    STQ     KEY+4,,AUTO
         2 001565   200025 631500                    EPPR1   VP,,AUTO
         2 001566   200147 451500                    STP1    KEY+3,,AUTO
         2 001567   200067 633500                    EPPR3   WSQ,,AUTO
         2 001570   200146 453500                    STP3    KEY+2,,AUTO
         2 001571   200146 630500                    EPPR0   KEY+2,,AUTO
         2 001572   000022 631400 xsym               EPPR1   B_VECTNIL+18
         2 001573   000000 701000 xent               TSX1    MME$WFVP
         2 001574   002050 702000 2                  TSX2    MM_ERROR

      980     9995    2             VP = NXTVP;

   9995  2 001575   200027 235100                    LDA     NXTVP,,AUTO
         2 001576   200025 755100                    STA     VP,,AUTO

      981     9996    2           END;

   9996  2 001577   200017 054100                    AOS     I,,AUTO
         2 001600   200017 236100                    LDQ     I,,AUTO
         2 001601   200060 116100                    CMPQ    TEMP,,AUTO
         2 001602   001456 604400 2                  TMOZ    s:9973

      982     9997
      983     9998        /* Now release the page table */
      984     9999    1        TEMP = BITBIN(SEGID & '1777'O);

   9999  2 001603   200057 236100                    LDQ     SEGID,,AUTO
         2 001604   777700 376003                    ANQ     -64,DU
         2 001605   177700 376003                    ANQ     65472,DU
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:168  
         2 001606   000030 772000                    QRL     24
         2 001607   200060 756100                    STQ     TEMP,,AUTO

      985    10000    1        IF NOT HW_IMX THEN

  10000  2 001610   000000 234000 xsym               SZN     HW_IMX
         2 001611   001620 604000 2                  TMI     s:10003

      986    10001    1             B$USERLS$->MM$DESC.FLGS1.NOTEMPTY(TEMP)='0'B;

  10001  2 001612   200060 235100                    LDA     TEMP,,AUTO
         2 001613   000001 735000                    ALS     1
         2 001614   000000 470400 xsym               LDP0    B$USERLS$
         2 001615   000016 236000 3                  LDQ     14
         2 001616   000000 356105                    ANSQ    0,AL,PR0
         2 001617   001627 710000 2                  TRA     s:10006

      987    10002    2        ELSE DO;

      988    10003    2             B$USERLS$->MM$SDESC.FLGS(TEMP) = '1'O ;

  10003  2 001620   200060 235100                    LDA     TEMP,,AUTO
         2 001621   000001 735000                    ALS     1
         2 001622   000000 470400 xsym               LDP0    B$USERLS$
         2 001623   000000 236105                    LDQ     0,AL,PR0
         2 001624   000017 376000 3                  ANQ     15
         2 001625   020000 276007                    ORQ     8192,DL
         2 001626   000000 756105                    STQ     0,AL,PR0

      989    10004    2           END;

      990    10005
      991    10006    1        IF MM$VCB.T.SECTION THEN

  10006  2 001627   200065 471500                    LDP1    VCB$,,AUTO
         2 001630   100000 236100                    LDQ     0,,PR1
         2 001631   010000 316003                    CANQ    4096,DU
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:169  
         2 001632   001641 600000 2                  TZE     s:10009

      992    10007    1             TEMP = MM$VCB.NPGTSECT - 1;

  10007  2 001633   100011 236100                    LDQ     9,,PR1
         2 001634   000022 736000                    QLS     18
         2 001635   000022 732000                    QRS     18
         2 001636   000001 136007                    SBLQ    1,DL
         2 001637   200060 756100                    STQ     TEMP,,AUTO
         2 001640   001644 710000 2                  TRA     s:10010

      993    10008    1        ELSE
      994    10009    1             TEMP=MM$VCB.NPGTPGS-1;

  10009  2 001641   100012 235100                    LDA     10,,PR1
         2 001642   000001 135007                    SBLA    1,DL
         2 001643   200060 755100                    STA     TEMP,,AUTO

      995    10010    2        DO I = 0 TO TEMP;

  10010  2 001644   200017 450100                    STZ     I,,AUTO
         2 001645   001705 710000 2                  TRA     s:10017+1

      996    10011    2             CALL MME$RVNP(%USERWSQ,HDACC+I,PP,ERR) ALTRET (MM_ERROR);

  10011  2 001646   200024 236100                    LDQ     HDACC,,AUTO
         2 001647   200017 036100                    ADLQ    I,,AUTO
         2 001650   200146 756100                    STQ     KEY+2,,AUTO
         2 001651   200016 630500                    EPPR0   ERR,,AUTO
         2 001652   200153 450500                    STP0    KEY+7,,AUTO
         2 001653   200026 631500                    EPPR1   PP,,AUTO
         2 001654   200152 451500                    STP1    KEY+6,,AUTO
         2 001655   200146 633500                    EPPR3   KEY+2,,AUTO
         2 001656   200151 453500                    STP3    KEY+5,,AUTO
         2 001657   000020 236000 3                  LDQ     16
         2 001660   200150 756100                    STQ     KEY+4,,AUTO
         2 001661   200150 630500                    EPPR0   KEY+4,,AUTO
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:170  
         2 001662   000022 631400 xsym               EPPR1   B_VECTNIL+18
         2 001663   000000 701000 xent               TSX1    MME$RVNP
         2 001664   002050 702000 2                  TSX2    MM_ERROR

      997    10012    2             IF TEMP = 0

  10012  2 001665   200060 235100                    LDA     TEMP,,AUTO
         2 001666   001676 601000 2                  TNZ     s:10016

      998    10013    2             THEN
      999    10014    2                  CALL MMB$FPP (PP);

  10014  2 001667   200026 630500                    EPPR0   PP,,AUTO
         2 001670   200146 450500                    STP0    KEY+2,,AUTO
         2 001671   200146 630500                    EPPR0   KEY+2,,AUTO
         2 001672   000017 631400 xsym               EPPR1   B_VECTNIL+15
         2 001673   000000 701000 xent               TSX1    MMB$FPP
         2 001674   000000 011000                    NOP     0
         2 001675   001704 710000 2                  TRA     s:10017

     1000    10015    2             ELSE /* Release on tail to try and keep contiguous pages together */
     1001    10016    2                  CALL MMB$FPPONTAIL(PP);

  10016  2 001676   200026 630500                    EPPR0   PP,,AUTO
         2 001677   200146 450500                    STP0    KEY+2,,AUTO
         2 001700   200146 630500                    EPPR0   KEY+2,,AUTO
         2 001701   000017 631400 xsym               EPPR1   B_VECTNIL+15
         2 001702   000000 701000 xent               TSX1    MMB$FPPONTAIL
         2 001703   000000 011000                    NOP     0

     1002    10017    2           END;

  10017  2 001704   200017 054100                    AOS     I,,AUTO
         2 001705   200017 236100                    LDQ     I,,AUTO
         2 001706   200060 116100                    CMPQ    TEMP,,AUTO
         2 001707   001646 604400 2                  TMOZ    s:10011

PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:171  
     1003    10018    2        IF MM$VCB.T.SECTION THEN DO;

  10018  2 001710   200065 470500                    LDP0    VCB$,,AUTO
         2 001711   000000 236100                    LDQ     0,,PR0
         2 001712   010000 316003                    CANQ    4096,DU
         2 001713   001767 600000 2                  TZE     s:10030

     1004    10019    2             TEMP=MM$VCB.NPGTPGS-1;

  10019  2 001714   000012 235100                    LDA     10,,PR0
         2 001715   000001 135007                    SBLA    1,DL
         2 001716   200060 755100                    STA     TEMP,,AUTO

     1005    10020    3             DO I=0 TO TEMP;

  10020  2 001717   200017 450100                    STZ     I,,AUTO
         2 001720   001764 710000 2                  TRA     s:10026+1

     1006    10021    3                  CALL MME$RVNP(%USERWSQ,HDACC+MM$VCB.NPGTSECT+I,PP,ERR) ALTRET(
             10021                           MM_ERROR);

  10021  2 001721   200065 470500                    LDP0    VCB$,,AUTO
         2 001722   000011 236100                    LDQ     9,,PR0
         2 001723   000022 736000                    QLS     18
         2 001724   000022 732000                    QRS     18
         2 001725   200024 036100                    ADLQ    HDACC,,AUTO
         2 001726   200017 036100                    ADLQ    I,,AUTO
         2 001727   200146 756100                    STQ     KEY+2,,AUTO
         2 001730   200016 631500                    EPPR1   ERR,,AUTO
         2 001731   200153 451500                    STP1    KEY+7,,AUTO
         2 001732   200026 633500                    EPPR3   PP,,AUTO
         2 001733   200152 453500                    STP3    KEY+6,,AUTO
         2 001734   200146 634500                    EPPR4   KEY+2,,AUTO
         2 001735   200151 454500                    STP4    KEY+5,,AUTO
         2 001736   000020 236000 3                  LDQ     16
         2 001737   200150 756100                    STQ     KEY+4,,AUTO
         2 001740   200150 630500                    EPPR0   KEY+4,,AUTO
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:172  
         2 001741   000022 631400 xsym               EPPR1   B_VECTNIL+18
         2 001742   000000 701000 xent               TSX1    MME$RVNP
         2 001743   002050 702000 2                  TSX2    MM_ERROR

     1007    10022    3                  IF TEMP=0 THEN

  10022  2 001744   200060 235100                    LDA     TEMP,,AUTO
         2 001745   001755 601000 2                  TNZ     s:10025

     1008    10023    3                       CALL MMB$FPP(PP);

  10023  2 001746   200026 630500                    EPPR0   PP,,AUTO
         2 001747   200146 450500                    STP0    KEY+2,,AUTO
         2 001750   200146 630500                    EPPR0   KEY+2,,AUTO
         2 001751   000017 631400 xsym               EPPR1   B_VECTNIL+15
         2 001752   000000 701000 xent               TSX1    MMB$FPP
         2 001753   000000 011000                    NOP     0
         2 001754   001763 710000 2                  TRA     s:10026

     1009    10024    3                  ELSE
     1010    10025    3                       CALL MMB$FPPONTAIL(PP);

  10025  2 001755   200026 630500                    EPPR0   PP,,AUTO
         2 001756   200146 450500                    STP0    KEY+2,,AUTO
         2 001757   200146 630500                    EPPR0   KEY+2,,AUTO
         2 001760   000017 631400 xsym               EPPR1   B_VECTNIL+15
         2 001761   000000 701000 xent               TSX1    MMB$FPPONTAIL
         2 001762   000000 011000                    NOP     0

     1011    10026    3                END;

  10026  2 001763   200017 054100                    AOS     I,,AUTO
         2 001764   200017 236100                    LDQ     I,,AUTO
         2 001765   200060 116100                    CMPQ    TEMP,,AUTO
         2 001766   001721 604400 2                  TMOZ    s:10021

     1012    10027    2           END;
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:173  

     1013    10028
     1014    10029             /* Zero out DCB# in jit */
     1015    10030    1        B$JIT.VIRTUAL.DCB#(WSQ - %VS1WSQ) = 0;

  10030  2 001767   000000 470400 xsym               LDP0    B$JIT$
         2 001770   200067 235100                    LDA     WSQ,,AUTO
         2 001771   000105 101400                    MRL     fill='000'O
         2 001772   000002 000004 xsym               ADSC9   B_VECTNIL+2              cn=0,n=4
         2 001773   000214 600001                    ADSC9   140,A,PR0                cn=3,n=1

     1016    10031             /* Zap any residue on AS */
     1017    10032    1        MAP$ = ADDR (B$USERHJIT$ -> MM$DESC(448));

  10032  2 001774   000000 236000 xsym               LDQ     B$USERHJIT$
         2 001775   001600 036003                    ADLQ    896,DU
         2 001776   200061 756100                    STQ     MAP$,,AUTO

     1018    10033    2        DO I = 448 TO 511;

  10033  2 001777   000700 235007                    LDA     448,DL
         2 002000   200017 755100                    STA     I,,AUTO

     1019    10034    2             IF MAP$ -> MM$DESC.TYP (0) = 4

  10034  2 002001   200061 470500                    LDP0    MAP$,,AUTO
         2 002002   000000 236100                    LDQ     0,,PR0
         2 002003   000017 376007                    ANQ     15,DL
         2 002004   000004 116007                    CMPQ    4,DL
         2 002005   002033 601000 2                  TNZ     s:10047

     1020    10035    3             THEN DO;

     1021    10036    4                  IF NOT HW_IMX THEN DO;

  10036  2 002006   000000 234000 xsym               SZN     HW_IMX
         2 002007   002022 604000 2                  TMI     s:10042
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:174  

     1022    10037    4                       IF MAP$ -> MM$DESC.SUPER.BASE (0) / 256 = TLNACC

  10037  2 002010   000000 236100                    LDQ     0,,PR0
         2 002011   000032 772000                    QRL     26
         2 002012   000010 772000                    QRL     8
         2 002013   002033 604000 2                  TMI     s:10047
         2 002014   200021 116100                    CMPQ    TLNACC,,AUTO
         2 002015   002033 601000 2                  TNZ     s:10047

     1023    10038    4                       THEN
     1024    10039    4                            MAP$ -> MM$DESC (0) = '0'B;

  10039  2 002016   000000 235003                    LDA     0,DU
         2 002017   000000 236003                    LDQ     0,DU
         2 002020   000000 757100                    STAQ    0,,PR0

     1025    10040    4                     END;

  10040  2 002021   002033 710000 2                  TRA     s:10047

     1026    10041    4                  ELSE DO;

     1027    10042    4                       IF MAP$ -> MM$SDESC.WSN(0) - %USERWSQ = TLNACC

  10042  2 002022   000000 236100                    LDQ     0,,PR0
         2 002023   000004 772000                    QRL     4
         2 002024   000777 376007                    ANQ     511,DL
         2 002025   000010 136007                    SBLQ    8,DL
         2 002026   200021 116100                    CMPQ    TLNACC,,AUTO
         2 002027   002033 601000 2                  TNZ     s:10047

     1028    10043    4                       THEN
     1029    10044    4                            MAP$ -> MM$DESC (0) = '0'B;

  10044  2 002030   000000 235003                    LDA     0,DU
         2 002031   000000 236003                    LDQ     0,DU
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:175  
         2 002032   000000 757100                    STAQ    0,,PR0

     1030    10045    4                     END;

     1031    10046    3                END;

     1032    10047    2             MAP$ = PINCRW (MAP$,2);

  10047  2 002033   200061 236100                    LDQ     MAP$,,AUTO
         2 002034   000002 036003                    ADLQ    2,DU
         2 002035   200061 756100                    STQ     MAP$,,AUTO

     1033    10048    2           END;

  10048  2 002036   200017 054100                    AOS     I,,AUTO
         2 002037   200017 235100                    LDA     I,,AUTO
         2 002040   000777 115007                    CMPA    511,DL
         2 002041   002001 604400 2                  TMOZ    s:10034

     1034    10049
     1035    10050             /* Altreturn if some error was encountered */
     1036    10051    1        IF B$JIT.ERR.CODE = 0

  10051  2 002042   000000 470400 xsym               LDP0    B$JIT$
         2 002043   000012 236100                    LDQ     10,,PR0
         2 002044   377770 316007                    CANQ    131064,DL
         2 002045   002047 601000 2                  TNZ     s:10053

     1037    10052    1        THEN RETURN;

  10052  2 002046   000000 702200 xent               TSX2  ! X66_ARET

     1038    10053    1        ELSE ALTRETURN;

  10053  2 002047   000000 702200 xent               TSX2  ! X66_AALT

  10051  2 002050                       MM_ERROR     null
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:176  
     1039    10054
     1040    10055    1   MM_ERROR: ;
     1041    10056    1        CALL SC_MM47;                      /* Some error was encountered  */

  10056  2 002050   000000 713400 xsym               CLIMB   SC_MM47
         2 002051   000000 600000 xsid               climb   nvectors=         0

     1042    10057    1        ALTRETURN;

  10057  2 002052   000000 702200 xent               TSX2  ! X66_AALT

     1043    10058
     1044    10059        %EJECT;
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:177  
     1045    10060    1   MMV$TRUNC: ENTRY (EWSQ) ALTRET;

  10060  2 002053   000000 700200 xent  MMV$TRUNC    TSX0  ! X66_AUTO_3
         2 002054   000154 000003                    ZERO    108,3

     1046    10061
     1047    10062    1        WSQ = EWSQ;

  10062  2 002055   200003 470500                    LDP0    @EWSQ,,AUTO
         2 002056   000000 235100                    LDA     0,,PR0
         2 002057   200067 755100                    STA     WSQ,,AUTO

     1048    10063        /* Set up pointer to dcb for this virtual area */
     1049    10064    1        DCB# = B$JIT.VIRTUAL.DCB# (WSQ - %VS1WSQ);

  10064  2 002060   000000 471400 xsym               LDP1    B$JIT$
         2 002061   000100 101505                    MRL     fill='000'O
         2 002062   100214 600001                    ADSC9   140,A,PR1                cn=3,n=1
         2 002063   200014 000004                    ADSC9   DCB#,,AUTO               cn=0,n=4

     1050    10065    1        IF DCB# = 0

  10065  2 002064   200014 236100                    LDQ     DCB#,,AUTO
         2 002065   002067 601000 2                  TNZ     s:10069

     1051    10066    2        THEN DO;

     1052    10067    2             ALTRETURN;

  10067  2 002066   000000 702200 xent               TSX2  ! X66_AALT

     1053    10068    2           END;
     1054    10069    1        VCB$ = DCBADDR(DCB#) -> F$DCB.SETSTA$;

  10069  2 002067   000003 473400 3                  LDP3    3
         2 002070   300000 474500                    LDP4    0,,PR3
         2 002071   400000 475506                    LDP5    0,QL,PR4
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:178  
         2 002072   500006 236100                    LDQ     6,,PR5
         2 002073   200065 756100                    STQ     VCB$,,AUTO

     1055    10070    1        STATS$ = DCBADDR(DCB#) -> F$DCB.LASTSTA$;

  10070  2 002074   200014 720100                    LXL0    DCB#,,AUTO
         2 002075   400000 475510                    LDP5    0,X0,PR4
         2 002076   500007 236100                    LDQ     7,,PR5
         2 002077   200066 756100                    STQ     STATS$,,AUTO

     1056    10071
     1057    10072    1        IF WSQ ~= MM$VCB.WSQ               /* WSQ does not match */

  10072  2 002100   200065 476500                    LDP6    VCB$,,AUTO
         2 002101   600000 236100                    LDQ     0,,PR6
         2 002102   000022 772000                    QRL     18
         2 002103   000777 376007                    ANQ     511,DL
         2 002104   200067 116100                    CMPQ    WSQ,,AUTO
         2 002105   002111 600000 2                  TZE     s:10078

     1058    10073    2        THEN DO;

     1059    10074    2             CALL SC_MM47;

  10074  2 002106   000000 713400 xsym               CLIMB   SC_MM47
         2 002107   000000 600000 xsid               climb   nvectors=         0

     1060    10075    2             ALTRETURN;

  10075  2 002110   000000 702200 xent               TSX2  ! X66_AALT

     1061    10076    2           END;
     1062    10077
     1063    10078    1        IF MM$VCB.PPC <= MM$VCB.PPMIN

  10078  2 002111   600003 721100                    LXL1    3,,PR6
         2 002112   600011 101100                    CMPX1   9,,PR6
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:179  
         2 002113   002115 602000 2                  TNC     s:10085

     1064    10079    1        THEN
     1065    10080    1             ALTRETURN;

  10080  2 002114   000000 702200 xent               TSX2  ! X66_AALT

     1066    10081
     1067    10082
     1068    10083        /* Write out all pages that have %PGMOD set and then release them */
     1069    10084
     1070    10085    1        TEMP = MM$VCB.PPC;

  10085  2 002115   600011 236100                    LDQ     9,,PR6
         2 002116   000022 772000                    QRL     18
         2 002117   200060 756100                    STQ     TEMP,,AUTO

     1071    10086    1        VP = MM$VCB.HEAD;

  10086  2 002120   600006 235100                    LDA     6,,PR6
         2 002121   200025 755100                    STA     VP,,AUTO

     1072    10087    1        SKIP_COUNT = MM$VCB.PPMIN;

  10087  2 002122   600003 236100                    LDQ     3,,PR6
         2 002123   777777 376007                    ANQ     -1,DL
         2 002124   200054 756100                    STQ     SKIP_COUNT,,AUTO

     1073    10088    1        SECTION = MM$VCB.T.SECTION;

  10088  2 002125   600000 236100                    LDQ     0,,PR6
         2 002126   000005 736000                    QLS     5
         2 002127   400000 376003                    ANQ     -131072,DU
         2 002130   200012 756100                    STQ     SECTION,,AUTO

     1074    10089    2        DO WHILE (MM$VCB.PPC > MM$VCB.PPMIN);

PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:180  
  10089  2 002131   600003 721100                    LXL1    3,,PR6
         2 002132   600011 101100                    CMPX1   9,,PR6
         2 002133   002307 603000 2                  TRC     s:10123

     1075    10090    2             CALL FINDMAP(VP);

  10090  2 002134   200025 630500                    EPPR0   VP,,AUTO
         2 002135   200137 450500                    STP0    @SUBC+2,,AUTO
         2 002136   003213 701000 2                  TSX1    FINDMAP
         2 002137   000000 011000                    NOP     0

     1076    10091    2             PP = B$MAP.RPN(IPG);

  10091  2 002140   200061 470500                    LDP0    MAP$,,AUTO
         2 002141   200035 720100                    LXL0    IPG,,AUTO
         2 002142   000000 236110                    LDQ     0,X0,PR0
         2 002143   000022 772000                    QRL     18
         2 002144   200026 756100                    STQ     PP,,AUTO

     1077    10092    2             IF HW_WSQ0PT THEN

  10092  2 002145   000000 234000 xsym               SZN     HW_WSQ0PT
         2 002146   002155 605000 2                  TPL     s:10094

     1078    10093    2                  PP=B$IPHYMAP$->MM$IPHY_MAP(PP);

  10093  2 002147   200026 235100                    LDA     PP,,AUTO
         2 002150   000001 735000                    ALS     1
         2 002151   000000 471400 xsym               LDP1    B$IPHYMAP$
         2 002152   000100 101505                    MRL     fill='000'O
         2 002153   100000 000002                    ADSC9   0,A,PR1                  cn=0,n=2
         2 002154   200026 000004                    ADSC9   PP,,AUTO                 cn=0,n=4

     1079    10094    2             NXTVP = MM$PPUT.PPNO(PP);

  10094  2 002155   000000 471400 xsym               LDP1    B$PPUT$
         2 002156   200026 721100                    LXL1    PP,,AUTO
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:181  
         2 002157   100000 236111                    LDQ     0,X1,PR1
         2 002160   000032 376000 xsym               ANQ     B_VECTNIL+26
         2 002161   200027 756100                    STQ     NXTVP,,AUTO

     1080    10095    3             IF SECTION AND SKIP_COUNT > 0 THEN DO;

  10095  2 002162   200012 234100                    SZN     SECTION,,AUTO
         2 002163   002173 605000 2                  TPL     s:10100
         2 002164   200054 235100                    LDA     SKIP_COUNT,,AUTO
         2 002165   002173 604400 2                  TMOZ    s:10100

     1081    10096    3                  SKIP_COUNT = SKIP_COUNT - 1;

  10096  2 002166   000001 336007                    LCQ     1,DL
         2 002167   200054 056100                    ASQ     SKIP_COUNT,,AUTO

     1082    10097    3                  SAVE_VP = VP;

  10097  2 002170   200025 235100                    LDA     VP,,AUTO
         2 002171   200051 755100                    STA     SAVE_VP,,AUTO

     1083    10098    3                END;

  10098  2 002172   002301 710000 2                  TRA     s:10121

     1084    10099    3             ELSE DO;

     1085    10100    3                  IF NOT SECTION THEN

  10100  2 002173   200012 234100                    SZN     SECTION,,AUTO
         2 002174   002177 604000 2                  TMI     s:10102

     1086    10101    3                       MM$VCB.HEAD = NXTVP;

  10101  2 002175   200065 473500                    LDP3    VCB$,,AUTO
         2 002176   300006 756100                    STQ     6,,PR3

PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:182  
     1087    10102    3                  MM$VCB.PPC = MM$VCB.PPC - 1;

  10102  2 002177   200065 473500                    LDP3    VCB$,,AUTO
         2 002200   300011 220100                    LDX0    9,,PR3
         2 002201   777777 621010                    EAX1    -1,X0
         2 002202   300011 741100                    STX1    9,,PR3

     1088    10103    3                  IF B$MAP.CTRL(IPG) & %PGMOD

  10103  2 002203   200035 720100                    LXL0    IPG,,AUTO
         2 002204   000000 236110                    LDQ     0,X0,PR0
         2 002205   000036 736000                    QLS     30
         2 002206   020000 376003                    ANQ     8192,DU
         2 002207   002250 600000 2                  TZE     s:10116

     1089    10104    4                  THEN DO;

     1090    10105    4                       CALL CVM;

  10105  2 002210   002426 701000 2                  TSX1    CVM
         2 002211   000000 011000                    NOP     0

     1091    10106    4                       IF MM$VCB.T.FRAGMENTED /* fragmented page table */

  10106  2 002212   200065 470500                    LDP0    VCB$,,AUTO
         2 002213   000000 236100                    LDQ     0,,PR0
         2 002214   020000 316003                    CANQ    8192,DU
         2 002215   002242 600000 2                  TZE     s:10113

     1092    10107    5                       THEN DO;

     1093    10108    5                            B$FRAGHWRD = B$FRAGMAP.HWRD(VP-128);

  10108  2 002216   200025 235100                    LDA     VP,,AUTO
         2 002217   000001 735000                    ALS     1
         2 002220   200061 471500                    LDP1    MAP$,,AUTO
         2 002221   000100 100505                    MLR     fill='000'O
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:183  
         2 002222   177700 000002                    ADSC9   -64,A,PR1                cn=0,n=2
         2 002223   200100 000002                    ADSC9   B$FRAGHWRD,,AUTO         cn=0,n=2

     1094    10109    5                            EVP = B$FRAGHWRD.PAGE_KEY * 64 + VP/4 - 32;

  10109  2 002224   200025 236100                    LDQ     VP,,AUTO
         2 002225   000004 506007                    DIV     4,DL
         2 002226   200146 756100                    STQ     KEY+2,,AUTO
         2 002227   200100 236100                    LDQ     B$FRAGHWRD,,AUTO
         2 002230   000014 772000                    QRL     12
         2 002231   000006 376000 3                  ANQ     6
         2 002232   200146 036100                    ADLQ    KEY+2,,AUTO
         2 002233   000040 136007                    SBLQ    32,DL
         2 002234   200006 756100                    STQ     EVP,,AUTO

     1095    10110    5                            CALL WRITE$PAGE (EVP);

  10110  2 002235   200006 633500                    EPPR3   EVP,,AUTO
         2 002236   200137 453500                    STP3    @SUBC+2,,AUTO
         2 002237   003020 701000 2                  TSX1    WRITE$PAGE
         2 002240   000000 011000                    NOP     0

     1096    10111    5                          END;

  10111  2 002241   002246 710000 2                  TRA     s:10114

     1097    10112    4                       ELSE
     1098    10113    4                            CALL WRITE$PAGE(VP) ;

  10113  2 002242   200025 631500                    EPPR1   VP,,AUTO
         2 002243   200137 451500                    STP1    @SUBC+2,,AUTO
         2 002244   003020 701000 2                  TSX1    WRITE$PAGE
         2 002245   000000 011000                    NOP     0

     1099    10114    4                       CALL UNCVM;

  10114  2 002246   002443 701000 2                  TSX1    UNCVM
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:184  
         2 002247   000000 011000                    NOP     0

     1100    10115    4                     END;

     1101    10116    3                  IF MM$VCB.T.FRAGMENTED

  10116  2 002250   200065 470500                    LDP0    VCB$,,AUTO
         2 002251   000000 236100                    LDQ     0,,PR0
         2 002252   020000 316003                    CANQ    8192,DU
         2 002253   002265 600000 2                  TZE     s:10119

     1102    10117    3                  THEN
     1103    10118    3                       B$FRAGMAP.HWRD.KEY_VALID(VP - 128) = %FALSE;

  10118  2 002254   200025 236100                    LDQ     VP,,AUTO
         2 002255   000022 402007                    MPY     18,DL
         2 002256   000000 116003                    CMPQ    0,DU
         2 002257   002261 605000 2                  TPL     s:10118+5
         2 002260   000044 036003                    ADLQ    36,DU
         2 002261   200061 471500                    LDP1    MAP$,,AUTO
         2 002262   003106 060400                    CSL     bolr='003'O
         2 002263   000002 000001 xsym               BDSC    B_VECTNIL+2              by=0,bit=0,n=1
         2 002264   177700 010001                    BDSC    -64,Q,PR1                by=0,bit=1,n=1

     1104    10119    3                  CALL MME$WFVP(WSQ,VP,,ERR) ALTRET(MM_ERROR);

  10119  2 002265   200016 631500                    EPPR1   ERR,,AUTO
         2 002266   200151 451500                    STP1    KEY+5,,AUTO
         2 002267   000001 236000 xsym               LDQ     B_VECTNIL+1
         2 002270   200150 756100                    STQ     KEY+4,,AUTO
         2 002271   200025 633500                    EPPR3   VP,,AUTO
         2 002272   200147 453500                    STP3    KEY+3,,AUTO
         2 002273   200067 634500                    EPPR4   WSQ,,AUTO
         2 002274   200146 454500                    STP4    KEY+2,,AUTO
         2 002275   200146 630500                    EPPR0   KEY+2,,AUTO
         2 002276   000022 631400 xsym               EPPR1   B_VECTNIL+18
         2 002277   000000 701000 xent               TSX1    MME$WFVP
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:185  
         2 002300   002050 702000 2                  TSX2    MM_ERROR

     1105    10120    3                END;

     1106    10121    2             VP = NXTVP;

  10121  2 002301   200027 235100                    LDA     NXTVP,,AUTO
         2 002302   200025 755100                    STA     VP,,AUTO

     1107    10122    2           END;

  10122  2 002303   200065 470500                    LDP0    VCB$,,AUTO
         2 002304   000003 720100                    LXL0    3,,PR0
         2 002305   000011 100100                    CMPX0   9,,PR0
         2 002306   002134 602000 2                  TNC     s:10090

     1108    10123    2        IF SECTION THEN DO;

  10123  2 002307   200012 234100                    SZN     SECTION,,AUTO
         2 002310   002344 605000 2                  TPL     s:10134

     1109    10124    2             CALL FINDMAP(SAVE_VP);

  10124  2 002311   200051 630500                    EPPR0   SAVE_VP,,AUTO
         2 002312   200137 450500                    STP0    @SUBC+2,,AUTO
         2 002313   003213 701000 2                  TSX1    FINDMAP
         2 002314   000000 011000                    NOP     0

     1110    10125    2             PP= B$MAP.RPN(IPG);

  10125  2 002315   200061 470500                    LDP0    MAP$,,AUTO
         2 002316   200035 720100                    LXL0    IPG,,AUTO
         2 002317   000000 236110                    LDQ     0,X0,PR0
         2 002320   000022 772000                    QRL     18
         2 002321   200026 756100                    STQ     PP,,AUTO

     1111    10126    2             IF HW_WSQ0PT THEN
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:186  

  10126  2 002322   000000 234000 xsym               SZN     HW_WSQ0PT
         2 002323   002332 605000 2                  TPL     s:10128

     1112    10127    2                  PP = B$IPHYMAP$->MM$IPHY_MAP(PP);

  10127  2 002324   200026 235100                    LDA     PP,,AUTO
         2 002325   000001 735000                    ALS     1
         2 002326   000000 471400 xsym               LDP1    B$IPHYMAP$
         2 002327   000100 101505                    MRL     fill='000'O
         2 002330   100000 000002                    ADSC9   0,A,PR1                  cn=0,n=2
         2 002331   200026 000004                    ADSC9   PP,,AUTO                 cn=0,n=4

     1113    10128    2             MM$PPUT.PPNO(PP) = BITBIN('777777777'O);

  10128  2 002332   000036 236000 1                  LDQ     PGINUSE+2
         2 002333   000011 772000                    QRL     9
         2 002334   000000 471400 xsym               LDP1    B$PPUT$
         2 002335   200026 721100                    LXL1    PP,,AUTO
         2 002336   100000 676111                    ERQ     0,X1,PR1
         2 002337   000032 376000 xsym               ANQ     B_VECTNIL+26
         2 002340   100000 656111                    ERSQ    0,X1,PR1

     1114    10129    2             MM$VCB.TAIL = SAVE_VP;

  10129  2 002341   200065 473500                    LDP3    VCB$,,AUTO
         2 002342   200051 235100                    LDA     SAVE_VP,,AUTO
         2 002343   300007 755100                    STA     7,,PR3

     1115    10130    2           END;

     1116    10131
     1117    10132
     1118    10133        /* Count up truncs */
     1119    10134    1        MM$VIRTUAL_STATS.TRUNCS# = MM$VIRTUAL_STATS.TRUNCS# + 1;

  10134  2 002344   200066 470500                    LDP0    STATS$,,AUTO
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:187  
         2 002345   000004 235100                    LDA     4,,PR0
         2 002346   000001 035007                    ADLA    1,DL
         2 002347   000004 755100                    STA     4,,PR0

     1120    10135    1        RETURN;

  10135  2 002350   000000 702200 xent               TSX2  ! X66_ARET

  10134  2 002351                       SPACEM       null
     1121    10136
     1122    10137        %EJECT;
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:188  
     1123    10138    1   SPACEM:;
     1124    10139    2        IF MM$VCB.UPGT# <MM$VCB.NPGTPGS THEN DO;
             10139                 /* There is an available page for a  page table */

  10139  2 002351   200065 470500                    LDP0    VCB$,,AUTO
         2 002352   000013 236100                    LDQ     11,,PR0
         2 002353   000022 732000                    QRS     18
         2 002354   000012 116100                    CMPQ    10,,PR0
         2 002355   002407 605000 2                  TPL     s:10145

     1125    10140    2             B$SECT.PTBASE(EVPSECT.SECT#)=B$UPT$->B$NMAP.RPN(%VS1PGTBL+

  10140  2 002356   200006 236100                    LDQ     EVP,,AUTO
         2 002357   000012 772000                    QRL     10
         2 002360   007777 376007                    ANQ     4095,DL
         2 002361   000000 620006                    EAX0    0,QL
         2 002362   000011 236100                    LDQ     9,,PR0
         2 002363   000022 736000                    QLS     18
         2 002364   000022 732000                    QRS     18
         2 002365   200146 756100                    STQ     KEY+2,,AUTO
         2 002366   200067 236100                    LDQ     WSQ,,AUTO
         2 002367   000004 736000                    QLS     4
         2 002370   200146 036100                    ADLQ    KEY+2,,AUTO
         2 002371   200147 756100                    STQ     KEY+3,,AUTO
         2 002372   000013 236100                    LDQ     11,,PR0
         2 002373   000022 732000                    QRS     18
         2 002374   200150 756100                    STQ     KEY+4,,AUTO
         2 002375   200147 236100                    LDQ     KEY+3,,AUTO
         2 002376   200150 036100                    ADLQ    KEY+4,,AUTO
         2 002377   000000 471400 xsym               LDP1    B$UPT$
         2 002400   100630 221106                    LDX1    408,QL,PR1
         2 002401   200062 473500                    LDP3    SECT$,,AUTO
         2 002402   300000 741110                    STX1    0,X0,PR3

     1126    10141    2                  16*(WSQ-%VS1WSQ)+MM$VCB.NPGTSECT+MM$VCB.UPGT#);
     1127    10142    2             MM$VCB.UPGT#=MM$VCB.UPGT#+1;

PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:189  
  10142  2 002403   000013 220100                    LDX0    11,,PR0
         2 002404   000001 621010                    EAX1    1,X0
         2 002405   000013 741100                    STX1    11,,PR0

     1128    10143    2           END;

  10143  2 002406   002425 710000 2                  TRA     s:10153

     1129    10144    2        ELSE DO;

     1130    10145    2             IF UPD_CHAIN_FLG = %FALSE THEN

  10145  2 002407   200055 234100                    SZN     UPD_CHAIN_FLG,,AUTO
         2 002410   002413 604000 2                  TMI     s:10148

     1131    10146    2                  CALL UPD_SECT_CHAIN;

  10146  2 002411   003324 701000 2                  TSX1    UPD_SECT_CHAIN
         2 002412   000000 011000                    NOP     0

     1132    10147        /*   There are no available page table pages, so we have to reuse one */
     1133    10148    2             IF SCT_USED < MM$VCB.NPGTPGS -1 THEN

  10148  2 002413   200065 470500                    LDP0    VCB$,,AUTO
         2 002414   000012 236100                    LDQ     10,,PR0
         2 002415   000001 136007                    SBLQ    1,DL
         2 002416   200053 116100                    CMPQ    SCT_USED,,AUTO
         2 002417   002423 604400 2                  TMOZ    s:10151

     1134    10149    2                  CALL REUSE_INACTIVE_PT;

  10149  2 002420   004012 701000 2                  TSX1    REUSE_INACTIVE_PT
         2 002421   000000 011000                    NOP     0
         2 002422   002425 710000 2                  TRA     s:10153

     1135    10150    2             ELSE
     1136    10151    2                  CALL REUSE_ACTIVE_PT;
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:190  

  10151  2 002423   004074 701000 2                  TSX1    REUSE_ACTIVE_PT
         2 002424   000000 011000                    NOP     0

     1137    10152    2           END;

     1138    10153    1        GOTO GT_DATAPAG;

  10153  2 002425   000306 710000 2                  TRA     GT_DATAPAG

     1139    10154        /* Some internal subroutines */
     1140    10155    1   CVM: PROC ALTRET;

  10155  2 002426   200136 741300       CVM          STX1  ! @SUBC+1,,AUTO

     1141    10156    2        CALL MME$CVM(%USERWSQ,%SBUF2PG,PP,ERR) ALTRET(MM_SCR);

  10156  2 002427   200016 630500                    EPPR0   ERR,,AUTO
         2 002430   200151 450500                    STP0    KEY+5,,AUTO
         2 002431   200026 631500                    EPPR1   PP,,AUTO
         2 002432   200150 451500                    STP1    KEY+4,,AUTO
         2 002433   000022 237000 3                  LDAQ    18
         2 002434   200146 757100                    STAQ    KEY+2,,AUTO
         2 002435   200146 630500                    EPPR0   KEY+2,,AUTO
         2 002436   000022 631400 xsym               EPPR1   B_VECTNIL+18
         2 002437   000000 701000 xent               TSX1    MME$CVM
         2 002440   002460 702000 2                  TSX2    MM_SCR

     1142    10157    2        RETURN;

  10157  2 002441   200136 221300                    LDX1  ! @SUBC+1,,AUTO
         2 002442   000001 702211                    TSX2  ! 1,X1

     1143    10158    2   UNCVM: ENTRY ALTRET;

  10158  2 002443   200136 741300       UNCVM        STX1  ! @SUBC+1,,AUTO

PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:191  
     1144    10159    2        CALL MME$CVM(%USERWSQ,%SBUF2PG,-1,ERR) ALTRET(MM_SCR);

  10159  2 002444   200016 630500                    EPPR0   ERR,,AUTO
         2 002445   200151 450500                    STP0    KEY+5,,AUTO
         2 002446   000024 236000 3                  LDQ     20
         2 002447   200150 756100                    STQ     KEY+4,,AUTO
         2 002450   000022 237000 3                  LDAQ    18
         2 002451   200146 757100                    STAQ    KEY+2,,AUTO
         2 002452   200146 630500                    EPPR0   KEY+2,,AUTO
         2 002453   000022 631400 xsym               EPPR1   B_VECTNIL+18
         2 002454   000000 701000 xent               TSX1    MME$CVM
         2 002455   002460 702000 2                  TSX2    MM_SCR

     1145    10160    2        RETURN;

  10160  2 002456   200136 221300                    LDX1  ! @SUBC+1,,AUTO
         2 002457   000001 702211                    TSX2  ! 1,X1

     1146    10161    2   MM_SCR: CALL SC_MM47;

  10161  2 002460   000000 713400 xsym  MM_SCR       CLIMB   SC_MM47
         2 002461   000000 600000 xsid               climb   nvectors=         0

     1147    10162    2        ALTRETURN;

  10162  2 002462   200136 221300                    LDX1  ! @SUBC+1,,AUTO
         2 002463   000000 702211                    TSX2  ! 0,X1

     1148    10163    2   TRUNCPG: ENTRY ALTRET;

  10163  2 002464   200136 741300       TRUNCPG      STX1  ! @SUBC+1,,AUTO

     1149    10164
     1150    10165
     1151    10166    2   END CVM;

  10166  2 002465   000001 702211                    TSX2  ! 1,X1
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:192  

     1152    10167        %EJECT;
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:193  
     1153    10168    1   MMV$CVM: ENTRY(EWSQ,EVPAGE,PPNO) ALTRET;

  10168  2 002466   000000 700200 xent  MMV$CVM      TSX0  ! X66_AUTO_3
         2 002467   000154 000003                    ZERO    108,3

     1154    10169
     1155    10170    1        WSQ = EWSQ;

  10170  2 002470   200003 470500                    LDP0    @EWSQ,,AUTO
         2 002471   000000 235100                    LDA     0,,PR0
         2 002472   200067 755100                    STA     WSQ,,AUTO

     1156    10171    1        EVP_PAGE_NO_ENTRY = EVPKEY.PAGE_NO_ENTRY;

  10171  2 002473   200006 236100                    LDQ     EVP,,AUTO
         2 002474   000077 376007                    ANQ     63,DL
         2 002475   200007 756100                    STQ     EVP_PAGE_NO_ENTRY,,AUTO

     1157    10172             %FINDMAP (WSQ=WSQ,P$=MAP$);

  10173  2 002476   000000 236005 xsym               LDQ     MM_PTPTRS$,AL
         2 002477   200061 756100                    STQ     MAP$,,AUTO

     1158    10175    1        DCB# = B$JIT.VIRTUAL.DCB#(WSQ-%VS1WSQ);

  10175  2 002500   000000 471400 xsym               LDP1    B$JIT$
         2 002501   200067 235100                    LDA     WSQ,,AUTO
         2 002502   000100 101505                    MRL     fill='000'O
         2 002503   100214 600001                    ADSC9   140,A,PR1                cn=3,n=1
         2 002504   200014 000004                    ADSC9   DCB#,,AUTO               cn=0,n=4

     1159    10176    1        VCB$ = DCBADDR(DCB#) -> F$DCB.SETSTA$;

  10176  2 002505   000003 473400 3                  LDP3    3
         2 002506   300000 474500                    LDP4    0,,PR3
         2 002507   200014 720100                    LXL0    DCB#,,AUTO
         2 002510   400000 475510                    LDP5    0,X0,PR4
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:194  
         2 002511   500006 236100                    LDQ     6,,PR5
         2 002512   200065 756100                    STQ     VCB$,,AUTO

     1160    10177    1        STATS$ = DCBADDR(DCB#) -> F$DCB.LASTSTA$;

  10177  2 002513   500007 236100                    LDQ     7,,PR5
         2 002514   200066 756100                    STQ     STATS$,,AUTO

     1161    10178
     1162    10179    1        IF MM$VCB.T.FRAGMENTED

  10179  2 002515   200065 476500                    LDP6    VCB$,,AUTO
         2 002516   600000 236100                    LDQ     0,,PR6
         2 002517   020000 316003                    CANQ    8192,DU
         2 002520   002554 600000 2                  TZE     s:10197

     1163    10180    2        THEN DO;

     1164    10181    2             PAGE_NO_ENTRY = EVP_PAGE_NO_ENTRY * 4;

  10181  2 002521   200007 235100                    LDA     EVP_PAGE_NO_ENTRY,,AUTO
         2 002522   000002 735000                    ALS     2
         2 002523   200010 755100                    STA     PAGE_NO_ENTRY,,AUTO

     1165    10182    3             DO I = 0 TO 3;

  10182  2 002524   200017 450100                    STZ     I,,AUTO

     1166    10183    3                  IF NOT B$FRAGMAP.HWRD.KEY_VALID (PAGE_NO_ENTRY)

  10183  2 002525   200010 236100                    LDQ     PAGE_NO_ENTRY,,AUTO
         2 002526   000022 402007                    MPY     18,DL
         2 002527   000000 116003                    CMPQ    0,DU
         2 002530   002532 605000 2                  TPL     s:10183+5
         2 002531   000044 036003                    ADLQ    36,DU
         2 002532   200061 470500                    LDP0    MAP$,,AUTO
         2 002533   000000 066506                    CMPB    filb='0'B
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:195  
         2 002534   000000 010001                    BDSC    0,Q,PR0                  by=0,bit=1,n=1
         2 002535   000002 000022 xsym               BDSC    B_VECTNIL+2              by=0,bit=0,n=18
         2 002536   002550 600000 2                  TZE     GOTSLOT

     1167    10184    3                  THEN
     1168    10185    3                       GOTO GOTSLOT;
     1169    10186    3                  PAGE_NO_ENTRY = PAGE_NO_ENTRY + 1;

  10186  2 002537   200010 054100                    AOS     PAGE_NO_ENTRY,,AUTO

     1170    10187    3                END;

  10187  2 002540   200017 054100                    AOS     I,,AUTO
         2 002541   200017 235100                    LDA     I,,AUTO
         2 002542   000003 115007                    CMPA    3,DL
         2 002543   002525 604400 2                  TMOZ    s:10183

     1171    10188    2             B$JIT.ERR = PGINUSE;

  10188  2 002544   000034 236000 1                  LDQ     PGINUSE
         2 002545   000000 471400 xsym               LDP1    B$JIT$
         2 002546   100012 756100                    STQ     10,,PR1

     1172    10189        /*E* ERROR:         MMV-E$PGINUSE-0
     1173    10190        MESSAGE:       All pages in use for fragmented page table (M$CVM).
     1174    10191                            */
     1175    10192    2             RETURN;

  10192  2 002547   000000 702200 xent               TSX2  ! X66_ARET

     1176    10193
     1177    10194    2   GOTSLOT:  MAPVP = PAGE_NO_ENTRY + 128;

  10194  2 002550   200010 235100       GOTSLOT      LDA     PAGE_NO_ENTRY,,AUTO
         2 002551   000200 035007                    ADLA    128,DL
         2 002552   200013 755100                    STA     MAPVP,,AUTO

PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:196  
     1178    10195    2           END;

  10195  2 002553   002556 710000 2                  TRA     s:10199

     1179    10196    1        ELSE
     1180    10197    1             MAPVP = EVP;

  10197  2 002554   200006 235100                    LDA     EVP,,AUTO
         2 002555   200013 755100                    STA     MAPVP,,AUTO

     1181    10198
     1182    10199    1        CALL MME$CVM (WSQ,EVP,PPNO,ERR)

  10199  2 002556   200016 630500                    EPPR0   ERR,,AUTO
         2 002557   200151 450500                    STP0    KEY+5,,AUTO
         2 002560   200005 236100                    LDQ     @PPNO,,AUTO
         2 002561   200150 756100                    STQ     KEY+4,,AUTO
         2 002562   200006 631500                    EPPR1   EVP,,AUTO
         2 002563   200147 451500                    STP1    KEY+3,,AUTO
         2 002564   200067 633500                    EPPR3   WSQ,,AUTO
         2 002565   200146 453500                    STP3    KEY+2,,AUTO
         2 002566   200146 630500                    EPPR0   KEY+2,,AUTO
         2 002567   000022 631400 xsym               EPPR1   B_VECTNIL+18
         2 002570   000000 701000 xent               TSX1    MME$CVM
         2 002571   002573 702000 2                  TSX2    s:10201
         2 002572   002574 710000 2                  TRA     s:10203

     1183    10200    2        WHENALTRETURN DO;

     1184    10201    2             ALTRETURN;

  10201  2 002573   000000 702200 xent               TSX2  ! X66_AALT

     1185    10202    2           END;
     1186    10203    1        IF MM$VCB.T.FRAGMENTED

  10203  2 002574   200065 470500                    LDP0    VCB$,,AUTO
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:197  
         2 002575   000000 236100                    LDQ     0,,PR0
         2 002576   020000 316003                    CANQ    8192,DU
         2 002577   002630 600000 2                  TZE     s:10208

     1187    10204    2        THEN DO;

     1188    10205    2             B$FRAGMAP.HWRD.KEY_VALID(PAGE_NO_ENTRY) = (PPNO >= 0);

  10205  2 002600   400000 220003                    LDX0    -131072,DU
         2 002601   200005 471500                    LDP1    @PPNO,,AUTO
         2 002602   100000 235100                    LDA     0,,PR1
         2 002603   002605 605000 2                  TPL     s:10205+5
         2 002604   000000 220003                    LDX0    0,DU
         2 002605   000000 636010                    EAQ     0,X0
         2 002606   200146 756100                    STQ     KEY+2,,AUTO
         2 002607   200010 236100                    LDQ     PAGE_NO_ENTRY,,AUTO
         2 002610   000022 402007                    MPY     18,DL
         2 002611   000000 116003                    CMPQ    0,DU
         2 002612   002614 605000 2                  TPL     s:10205+12
         2 002613   000044 036003                    ADLQ    36,DU
         2 002614   200061 473500                    LDP3    MAP$,,AUTO
         2 002615   003106 060500                    CSL     bolr='003'O
         2 002616   200146 000044                    BDSC    KEY+2,,AUTO              by=0,bit=0,n=36
         2 002617   300000 010001                    BDSC    0,Q,PR3                  by=0,bit=1,n=1

     1189    10206    2             B$FRAGMAP.HWRD.PAGE_KEY(PAGE_NO_ENTRY) = EVPKEY.PAGE_KEY;

  10206  2 002620   200010 236100                    LDQ     PAGE_NO_ENTRY,,AUTO
         2 002621   000022 402007                    MPY     18,DL
         2 002622   000000 116003                    CMPQ    0,DU
         2 002623   002625 605000 2                  TPL     s:10206+5
         2 002624   000044 036003                    ADLQ    36,DU
         2 002625   003106 060500                    CSL     bolr='003'O
         2 002626   200006 250020                    BDSC    EVP,,AUTO                by=1,bit=5,n=16
         2 002627   300000 020020                    BDSC    0,Q,PR3                  by=0,bit=2,n=16

     1190    10207    2           END;
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:198  

     1191    10208    1        RETURN;

  10208  2 002630   000000 702200 xent               TSX2  ! X66_ARET

     1192    10209
     1193    10210        %EJECT;
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:199  
     1194    10211        /* Handle M$FVP */
     1195    10212    1   MMV$RLS: ENTRY(EWSQ,EVPAGE) ALTRET;

  10212  2 002631   000000 700200 xent  MMV$RLS      TSX0  ! X66_AUTO_3
         2 002632   000154 000003                    ZERO    108,3

     1196    10213
     1197    10214    1        CALL TRUNCPG;

  10214  2 002633   002464 701000 2                  TSX1    TRUNCPG
         2 002634   000000 011000                    NOP     0

     1198    10215    1        RETURN;

  10215  2 002635   000000 702200 xent               TSX2  ! X66_ARET

     1199    10216
     1200    10217        %EJECT;
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:200  
     1201    10218    1   READ$PAGE: PROC (VPAGE) ALTRET;

  10218  2 002636   200136 741300       READ$PAGE    STX1  ! @SUBC+1,,AUTO

     1202    10219        /* Internal procedure to read the page into the given virtual page */
     1203    10220
     1204    10221        /* Parameters */
     1205    10222    2   DCL VPAGE UBIN;                         /* Virtual page to be read in         */
     1206    10223
     1207    10224        /* Auto */
     1208    10225    2   DCL RW EPTR;
     1209    10226    2   DCL SAVEDCB$ PTR;
     1210    10227    2   DCL   SAVEDCBNO UBIN WORD;
     1211    10228    2   DCL 1 SAVEERR,
     1212    10229    2            2 FCG BIT(12),
     1213    10230    2            2 MID BIT(6),
     1214    10231    2            2 MON BIT(1),
     1215    10232    2            2 CODE UBIN(14) UNAL,
     1216    10233    2            2 SEV UBIN(3) UNAL;
     1217    10234    2   DCL 1 KEY ALIGNED,
     1218    10235    2            2 SIZE UBIN(9) CALIGNED,
     1219    10236    2            2 VP# UBIN(27) CALIGNED;
     1220    10237
     1221    10238        /* Count up file reads */
     1222    10239    2        MM$VIRTUAL_STATS.READS# = MM$VIRTUAL_STATS.READS# + 1;

  10239  2 002637   200066 470500                    LDP0    STATS$,,AUTO
         2 002640   000000 235100                    LDA     0,,PR0
         2 002641   000001 035007                    ADLA    1,DL
         2 002642   000000 755100                    STA     0,,PR0

     1223    10240    2        READ_PAGE = READ_PAGEC;            /* Initialize                         */

  10240  2 002643   000100 100400                    MLR     fill='000'O
         2 002644   000000 000070 1                  ADSC9   READ_PAGEC               cn=0,n=56
         2 002645   200116 000070                    ADSC9   READ_PAGE,,AUTO          cn=0,n=56

PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:201  
     1224    10241    2        RW = ENTADDR (M$MREAD);

  10241  2 002646   000000 636000 xent               EAQ     M$MREAD
         2 002647   200140 756100                    STQ     RW,,AUTO

     1225    10242    2   RWPAGE: IF MM$VCB.NOFILE

  10242  2 002650   200065 470500       RWPAGE       LDP0    VCB$,,AUTO
         2 002651   000000 236100                    LDQ     0,,PR0
         2 002652   200000 316003                    CANQ    65536,DU
         2 002653   002656 600000 2                  TZE     s:10245

     1226    10243    2        THEN
     1227    10244    2             RETURN;

  10244  2 002654   200136 221300                    LDX1  ! @SUBC+1,,AUTO
         2 002655   000001 702211                    TSX2  ! 1,X1

     1228    10245    2        SAVEDCB$ = B$JIT.DCB$;

  10245  2 002656   000000 471400 xsym               LDP1    B$JIT$
         2 002657   100232 236100                    LDQ     154,,PR1
         2 002660   200141 756100                    STQ     SAVEDCB$,,AUTO

     1229    10246    2        SAVEDCBNO = B$JIT.DCBNO;

  10246  2 002661   100022 236100                    LDQ     18,,PR1
         2 002662   000777 376007                    ANQ     511,DL
         2 002663   200142 756100                    STQ     SAVEDCBNO,,AUTO

     1230    10247    2        SAVEERR = B$JIT.ERR;

  10247  2 002664   100012 236100                    LDQ     10,,PR1
         2 002665   200143 756100                    STQ     SAVEERR,,AUTO

     1231    10248    2        KEY.SIZE = SIZEC(KEY.VP#);

PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:202  
  10248  2 002666   003000 236003                    LDQ     1536,DU
         2 002667   200144 552140                    STBQ    KEY,'40'O,AUTO

     1232    10249    2        KEY.VP# = VPAGE;

  10249  2 002670   200137 473500                    LDP3    @VPAGE,,AUTO
         2 002671   300000 236100                    LDQ     0,,PR3
         2 002672   200144 552134                    STBQ    KEY,'34'O,AUTO

     1233    10250
     1234    10251        /* Setup fpt for the read */
     1235    10252    2        READ_PAGE.V.DCB# = DCB#;

  10252  2 002673   200014 720100                    LXL0    DCB#,,AUTO
         2 002674   200126 740100                    STX0    READ_PAGE+8,,AUTO

     1236    10253    2        READ_PAGE.V_ = VECTOR(READ_PAGE.V);

  10253  2 002675   000025 235000 3                  LDA     21
         2 002676   200146 452500                    STP2    KEY+2,,AUTO
         2 002677   200146 236100                    LDQ     KEY+2,,AUTO
         2 002700   000126 036003                    ADLQ    86,DU
         2 002701   200116 757100                    STAQ    READ_PAGE,,AUTO

     1237    10254    2        READ_PAGE.KEY_ = VECTOR(KEY);

  10254  2 002702   777640 235007                    LDA     -96,DL
         2 002703   200146 452500                    STP2    KEY+2,,AUTO
         2 002704   200146 236100                    LDQ     KEY+2,,AUTO
         2 002705   000144 036003                    ADLQ    100,DU
         2 002706   200120 757100                    STAQ    READ_PAGE+2,,AUTO

     1238    10255    2        READ_PAGE.BUF_.BUF$ = B$SBUF2$;

  10255  2 002707   000000 236000 xsym               LDQ     B$SBUF2$
         2 002710   200123 756100                    STQ     READ_PAGE+5,,AUTO

PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:203  
     1239    10256    2        READ_PAGE.BUF_.BOUND = 4095;       /* One page worth                     */

  10256  2 002711   200122 236100                    LDQ     READ_PAGE+4,,AUTO
         2 002712   177777 376007                    ANQ     65535,DL
         2 002713   000026 276000 3                  ORQ     22
         2 002714   200122 756100                    STQ     READ_PAGE+4,,AUTO

     1240    10257    2        CALL RW (READ_PAGE) ALTRET (READ_ERROR);

  10257  2 002715   200116 634500                    EPPR4   READ_PAGE,,AUTO
         2 002716   200146 454500                    STP4    KEY+2,,AUTO
         2 002717   200146 630500                    EPPR0   KEY+2,,AUTO
         2 002720   200140 221100                    LDX1    RW,,AUTO
         2 002721   000017 631400 xsym               EPPR1   B_VECTNIL+15
         2 002722   000000 701011                    TSX1    0,X1
         2 002723   003005 702000 2                  TSX2    READ_ERROR

     1241    10258    2        IF VPAGE > MM$VCB.MAXVP_WRITTEN

  10258  2 002724   200137 470500                    LDP0    @VPAGE,,AUTO
         2 002725   200065 471500                    LDP1    VCB$,,AUTO
         2 002726   000000 236100                    LDQ     0,,PR0
         2 002727   002732 604000 2                  TMI     s:10260
         2 002730   100010 116100                    CMPQ    8,,PR1
         2 002731   002733 604400 2                  TMOZ    s:10263

     1242    10259    2        THEN
     1243    10260    2             MM$VCB.MAXVP_WRITTEN = VPAGE;

  10260  2 002732   100010 756100                    STQ     8,,PR1

     1244    10261
     1245    10262        /* Check to see if the upper level should be built */
     1246    10263    2        B$JIT.DCB$ = DCBADDR(DCB#);

  10263  2 002733   000003 473400 3                  LDP3    3
         2 002734   300000 474500                    LDP4    0,,PR3
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:204  
         2 002735   200014 720100                    LXL0    DCB#,,AUTO
         2 002736   400000 236110                    LDQ     0,X0,PR4
         2 002737   000000 475400 xsym               LDP5    B$JIT$
         2 002740   500232 756100                    STQ     154,,PR5

     1247    10264    2        IF B$JIT.DCB$->F$DCB.RDL0 > B$JIT.DCB$->F$DCB.LRDL0

  10264  2 002741   500232 476500                    LDP6    154,,PR5
         2 002742   600003 236100                    LDQ     3,,PR6
         2 002743   000022 772000                    QRL     18
         2 002744   000777 376007                    ANQ     511,DL
         2 002745   200146 756100                    STQ     KEY+2,,AUTO
         2 002746   600037 236100                    LDQ     31,,PR6
         2 002747   000777 376007                    ANQ     511,DL
         2 002750   200146 116100                    CMPQ    KEY+2,,AUTO
         2 002751   002772 605000 2                  TPL     s:10271

     1248    10265    3        THEN DO;

     1249    10266    3             CALL FMU$BLD;

  10266  2 002752   000002 631400 xsym               EPPR1   B_VECTNIL+2
         2 002753   000000 701000 xent               TSX1    FMU$BLD
         2 002754   000000 011000                    NOP     0

     1250    10267    3             B$JIT.DCB$->F$DCB.RDL0 = 0;

  10267  2 002755   000000 470400 xsym               LDP0    B$JIT$
         2 002756   000232 471500                    LDP1    154,,PR0
         2 002757   000000 236003                    LDQ     0,DU
         2 002760   100003 552120                    STBQ    3,'20'O,PR1

     1251    10268    3             B$JIT.DCB$->F$DCB.CFU$->FM$CFU.FUN = MOD(B$JIT.DCB$->F$DCB.CFU$->FM$CFU.
             10268                      FUN,4);

  10268  2 002761   000232 471500                    LDP1    154,,PR0
         2 002762   100066 473500                    LDP3    54,,PR1
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:205  
         2 002763   300000 236100                    LDQ     0,,PR3
         2 002764   000041 772000                    QRL     33
         2 002765   000003 376007                    ANQ     3,DL
         2 002766   000041 736000                    QLS     33
         2 002767   300000 676100                    ERQ     0,,PR3
         2 002770   700000 376003                    ANQ     -32768,DU
         2 002771   300000 656100                    ERSQ    0,,PR3

     1252    10269    3           END;

     1253    10270
     1254    10271    2        B$JIT.DCB$ = SAVEDCB$;

  10271  2 002772   200141 236100                    LDQ     SAVEDCB$,,AUTO
         2 002773   000000 470400 xsym               LDP0    B$JIT$
         2 002774   000232 756100                    STQ     154,,PR0

     1255    10272    2        B$JIT.DCBNO = SAVEDCBNO;

  10272  2 002775   200142 236100                    LDQ     SAVEDCBNO,,AUTO
         2 002776   000022 552104                    STBQ    18,'04'O,PR0

     1256    10273    2        READ$PAGE$ERR = B$JIT.ERR;

  10273  2 002777   000012 236100                    LDQ     10,,PR0
         2 003000   200056 756100                    STQ     READ$PAGE$ERR,,AUTO

     1257    10274    2        B$JIT.ERR = SAVEERR;

  10274  2 003001   200143 236100                    LDQ     SAVEERR,,AUTO
         2 003002   000012 756100                    STQ     10,,PR0

     1258    10275    2        RETURN;

  10275  2 003003   200136 221300                    LDX1  ! @SUBC+1,,AUTO
         2 003004   000001 702211                    TSX2  ! 1,X1

PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:206  
  10274  2 003005                       READ_ERROR   null
     1259    10276
     1260    10277    2   READ_ERROR: ;
     1261    10278    2        B$JIT.DCB$ = SAVEDCB$;

  10278  2 003005   200141 236100                    LDQ     SAVEDCB$,,AUTO
         2 003006   000000 470400 xsym               LDP0    B$JIT$
         2 003007   000232 756100                    STQ     154,,PR0

     1262    10279    2        B$JIT.DCBNO = SAVEDCBNO;

  10279  2 003010   200142 236100                    LDQ     SAVEDCBNO,,AUTO
         2 003011   000022 552104                    STBQ    18,'04'O,PR0

     1263    10280    2        READ$PAGE$ERR = B$JIT.ERR;

  10280  2 003012   000012 236100                    LDQ     10,,PR0
         2 003013   200056 756100                    STQ     READ$PAGE$ERR,,AUTO

     1264    10281    2        B$JIT.ERR = SAVEERR;

  10281  2 003014   200143 236100                    LDQ     SAVEERR,,AUTO
         2 003015   000012 756100                    STQ     10,,PR0

     1265    10282    2        ALTRETURN;

  10282  2 003016   200136 221300                    LDX1  ! @SUBC+1,,AUTO
         2 003017   000000 702211                    TSX2  ! 0,X1

     1266    10283
     1267    10284    2   WRITE$PAGE: ENTRY (VPAGE) ALTRET;

  10284  2 003020   200136 741300       WRITE$PAGE   STX1  ! @SUBC+1,,AUTO

     1268    10285        /* Internal procedure to read the page into the given virtual page */
     1269    10286
     1270    10287        /* Count up file writes */
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:207  
     1271    10288    2        MM$VIRTUAL_STATS.WRITES# = MM$VIRTUAL_STATS.WRITES# + 1;

  10288  2 003021   200066 470500                    LDP0    STATS$,,AUTO
         2 003022   000001 235100                    LDA     1,,PR0
         2 003023   000001 035007                    ADLA    1,DL
         2 003024   000001 755100                    STA     1,,PR0

     1272    10289
     1273    10290        /* Setup fpt for the write */
     1274    10291    2        READ_PAGE = WRITE_PAGEC;           /* Initialize                         */

  10291  2 003025   000100 100400                    MLR     fill='000'O
         2 003026   000016 000060 1                  ADSC9   WRITE_PAGEC              cn=0,n=48
         2 003027   200116 000070                    ADSC9   READ_PAGE,,AUTO          cn=0,n=56

     1275    10292    2        RW = ENTADDR (M$MWRITE);

  10292  2 003030   000000 636000 xent               EAQ     M$MWRITE
         2 003031   200140 756100                    STQ     RW,,AUTO

     1276    10293    2        GOTO RWPAGE;

  10293  2 003032   002650 710000 2                  TRA     RWPAGE

     1277    10294    2   END READ$PAGE;
     1278    10295        %EJECT;
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:208  
     1279    10296    1   INIT$PAGE: PROC;                   /* Initialize a page to the given value */

  10296  2 003033   200134 741300       INIT$PAGE    STX1  ! READ_PAGE+14,,AUTO

     1280    10297
     1281    10298    2   DCL 1 B$SHORT_PAGE BASED DALIGNED,      /* Page for move */
     1282    10299    2            2 * (0:1015) UBIN;
     1283    10300
     1284    10301    2        TEMP = 23085;                      /* .000000055055 (  --) */

  10301  2 003034   055055 235007                    LDA     23085,DL
         2 003035   200060 755100                    STA     TEMP,,AUTO

     1285    10302    2        IF MM$VCB.INITIALIZE

  10302  2 003036   200065 470500                    LDP0    VCB$,,AUTO
         2 003037   000000 234100                    SZN     0,,PR0
         2 003040   003043 605000 2                  TPL     s:10304+2

     1286    10303    2        THEN
     1287    10304    2             TEMP = MM$VCB.INITVALUE;

  10304  2 003041   000001 235100                    LDA     1,,PR0
         2 003042   200060 755100                    STA     TEMP,,AUTO
         2 003043   003045 710000 2                  TRA     s:10306

     1288    10305    2   INITPAGE1: ENTRY;

  10305  2 003044   200134 741300       INITPAGE1    STX1  ! READ_PAGE+14,,AUTO

     1289    10306    2        B$SBUF2$->B$PAGE.WRD(0) = TEMP;

  10306  2 003045   200060 235100                    LDA     TEMP,,AUTO
         2 003046   000000 470400 xsym               LDP0    B$SBUF2$
         2 003047   000000 755100                    STA     0,,PR0

     1290    10307    2        B$SBUF2$->B$PAGE.WRD(1) = TEMP;
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:209  

  10307  2 003050   000001 755100                    STA     1,,PR0

     1291    10308    2        B$SBUF2$->B$PAGE.WRD(2) = TEMP;

  10308  2 003051   000002 755100                    STA     2,,PR0

     1292    10309    2        B$SBUF2$->B$PAGE.WRD(3) = TEMP;

  10309  2 003052   000003 755100                    STA     3,,PR0

     1293    10310    2        B$SBUF2$->B$PAGE.WRD(4) = TEMP;

  10310  2 003053   000004 755100                    STA     4,,PR0

     1294    10311    2        B$SBUF2$->B$PAGE.WRD(5) = TEMP;

  10311  2 003054   000005 755100                    STA     5,,PR0

     1295    10312    2        B$SBUF2$->B$PAGE.WRD(6) = TEMP;

  10312  2 003055   000006 755100                    STA     6,,PR0

     1296    10313    2        B$SBUF2$->B$PAGE.WRD(7) = TEMP;

  10313  2 003056   000007 755100                    STA     7,,PR0

     1297    10314
     1298    10315        /* Overlap the move to initialize the rest of the page */
     1299    10316    2        PINCRW(B$SBUF2$,8)->B$SHORT_PAGE = B$SBUF2$->B$SHORT_PAGE;

  10316  2 003057   000100 100500                    MLR     fill='000'O
         2 003060   000000 007740                    ADSC9   0,,PR0                   cn=0,n=4064
         2 003061   000010 007740                    ADSC9   8,,PR0                   cn=0,n=4064

     1300    10317    2        RETURN;

PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:210  
  10317  2 003062   200134 221300                    LDX1  ! READ_PAGE+14,,AUTO
         2 003063   000001 702211                    TSX2  ! 1,X1

     1301    10318
     1302    10319    2   END INIT$PAGE;
     1303    10320        %EJECT;
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:211  
     1304    10321    1   ABORTM:PROC (SUBC);

  10321  2 003064   200134 741300       ABORTM       STX1  ! READ_PAGE+14,,AUTO

     1305    10322
     1306    10323    2   DCL SUBC UBIN;
     1307    10324    2        FINFO = '0'B;

  10324  2 003065   000100 100400                    MLR     fill='000'O
         2 003066   000002 000001 xsym               ADSC9   B_VECTNIL+2              cn=0,n=1
         2 003067   200074 000020                    ADSC9   FINFO,,AUTO              cn=0,n=16

     1308    10325    2        FINFO.SUBC=SUBC;

  10325  2 003070   200135 470500                    LDP0    @SUBC,,AUTO
         2 003071   000000 720100                    LXL0    0,,PR0
         2 003072   200074 440100                    SXL0    FINFO,,AUTO

     1309    10326    2        FINFO.ERR = B$JIT.ERR;

  10326  2 003073   000000 471400 xsym               LDP1    B$JIT$
         2 003074   100012 236100                    LDQ     10,,PR1
         2 003075   200076 756100                    STQ     FINFO+2,,AUTO

     1310    10327    2        FINFO.P# = 0;

  10327  2 003076   200077 450100                    STZ     FINFO+3,,AUTO

     1311    10328    2        IF SS$->B$SS.ISR.WSR ~= %USERWSR THEN

  10328  2 003077   000000 473400 xsym               LDP3    B_MPT
         2 003100   300010 236100                    LDQ     8,,PR3
         2 003101   000160 376007                    ANQ     112,DL
         2 003102   000160 116007                    CMPQ    112,DL
         2 003103   003107 600000 2                  TZE     s:10330

     1312    10329    2             CALL MMA$POPSSF;
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:212  

  10329  2 003104   000002 631400 xsym               EPPR1   B_VECTNIL+2
         2 003105   000000 701000 xent               TSX1    MMA$POPSSF
         2 003106   000000 011000                    NOP     0

     1313    10330    2        IF B_MPT.ECCBDESC$->B$$DESCR.FLGS & %DSXXX

  10330  2 003107   000013 470400 xsym               LDP0    B_MPT+11
         2 003110   000000 236100                    LDQ     0,,PR0
         2 003111   000024 736000                    QLS     20
         2 003112   777000 376003                    ANQ     -512,DU
         2 003113   020000 376003                    ANQ     8192,DU
         2 003114   003126 601000 2                  TNZ     s:10335
         2 003115   000000 471400 xsym               LDP1    B_MPT
         2 003116   100010 236100                    LDQ     8,,PR1
         2 003117   000160 376007                    ANQ     112,DL
         2 003120   000140 116007                    CMPQ    96,DL
         2 003121   003142 601000 2                  TNZ     s:10338
         2 003122   000000 473400 xsym               LDP3    B$JIT$
         2 003123   300321 220100                    LDX0    209,,PR3
         2 003124   000001 360003                    ANX0    1,DU
         2 003125   003142 600000 2                  TZE     s:10338

     1314    10331                                                /* If a user running under DELTA      */
     1315    10332    2             OR (    (SS$->B$SS.ISR.WSR = %ASLWSR)
     1316    10333    2             AND (B$JIT.JUNK2 & %JJ2_DBRK#) )
     1317    10334    3        THEN DO;

     1318    10335    3             CALL SSU$DELTAGO(%ECC_ERROR#,FINFO,0);

  10335  2 003126   000004 236000 3                  LDQ     4
         2 003127   200150 756100                    STQ     KEY+4,,AUTO
         2 003130   200074 631500                    EPPR1   FINFO,,AUTO
         2 003131   200147 451500                    STP1    KEY+3,,AUTO
         2 003132   000027 236000 3                  LDQ     23
         2 003133   200146 756100                    STQ     KEY+2,,AUTO
         2 003134   200146 630500                    EPPR0   KEY+2,,AUTO
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:213  
         2 003135   000021 631400 xsym               EPPR1   B_VECTNIL+17
         2 003136   000000 701000 xent               TSX1    SSU$DELTAGO
         2 003137   000000 011000                    NOP     0

     1319    10336    3             RETURN;

  10336  2 003140   200134 221300                    LDX1  ! READ_PAGE+14,,AUTO
         2 003141   000001 702211                    TSX2  ! 1,X1

     1320    10337    3           END;
     1321    10338    2        ELSE IF ((SUBC = %SUBC_VIRTERR# AND ECCB$->B$ECCB.FLTFLG.HDWR) OR

  10338  2 003142   200135 473500                    LDP3    @SUBC,,AUTO
         2 003143   300000 235100                    LDA     0,,PR3
         2 003144   000014 115007                    CMPA    12,DL
         2 003145   003152 601000 2                  TNZ     s:10338+8
         2 003146   000005 474400 xsym               LDP4    B_MPT+5
         2 003147   400004 236100                    LDQ     4,,PR4
         2 003150   000002 316007                    CANQ    2,DL
         2 003151   003160 601000 2                  TNZ     s:10338+14
         2 003152   000000 115003                    CMPA    0,DU
         2 003153   003206 601000 2                  TNZ     TCB_FULL
         2 003154   000005 474400 xsym               LDP4    B_MPT+5
         2 003155   400004 236100                    LDQ     4,,PR4
         2 003156   000400 316007                    CANQ    256,DL
         2 003157   003206 600000 2                  TZE     TCB_FULL
         2 003160   002000 316003                    CANQ    1024,DU
         2 003161   003206 600000 2                  TZE     TCB_FULL

     1322    10339    2                  (SUBC = %SUBC_MEMORY# AND ECCB$->B$ECCB.FLTFLG.MEM) )
     1323    10340    2                  AND ECCB$->B$ECCB.FLAGS.ERRSET
     1324    10341    3             THEN DO;

     1325    10342    3                 CALL SST$SSFTCB(ECCB$->B$ECCB.ERR,%ECC_ERROR#,FINFO,SS$,TCB$) ALTRET(
             10342                           TCB_FULL);

  10342  2 003162   000030 236000 3                  LDQ     24
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:214  
         2 003163   200152 756100                    STQ     KEY+6,,AUTO
         2 003164   000031 236000 3                  LDQ     25
         2 003165   200151 756100                    STQ     KEY+5,,AUTO
         2 003166   200074 635500                    EPPR5   FINFO,,AUTO
         2 003167   200150 455500                    STP5    KEY+4,,AUTO
         2 003170   000027 236000 3                  LDQ     23
         2 003171   200147 756100                    STQ     KEY+3,,AUTO
         2 003172   000005 236000 xsym               LDQ     B_MPT+5
         2 003173   000032 036000 3                  ADLQ    26
         2 003174   200146 756100                    STQ     KEY+2,,AUTO
         2 003175   200146 630500                    EPPR0   KEY+2,,AUTO
         2 003176   000023 631400 xsym               EPPR1   B_VECTNIL+19
         2 003177   000000 701000 xent               TSX1    SST$SSFTCB
         2 003200   003206 702000 2                  TSX2    TCB_FULL

     1326    10343    3                  CALL SSS$SEXIT;

  10343  2 003201   000002 631400 xsym               EPPR1   B_VECTNIL+2
         2 003202   000000 701000 xent               TSX1    SSS$SEXIT
         2 003203   000000 011000                    NOP     0

     1327    10344    3                  RETURN;

  10344  2 003204   200134 221300                    LDX1  ! READ_PAGE+14,,AUTO
         2 003205   000001 702211                    TSX2  ! 1,X1

  10342  2 003206                       TCB_FULL     null
     1328    10345    3                END;
     1329    10346        /* FAULTING DOMAIN NOT TO GET CONTROL */
     1330    10347    2   TCB_FULL: ;
     1331    10348    2        CALL JSE$ABORTM;

  10348  2 003206   000002 631400 xsym               EPPR1   B_VECTNIL+2
         2 003207   000000 701000 xent               TSX1    JSE$ABORTM
         2 003210   000000 011000                    NOP     0

     1332    10349    2   END ABORTM;
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:215  

  10349  2 003211   200134 221300                    LDX1  ! READ_PAGE+14,,AUTO
         2 003212   000001 702211                    TSX2  ! 1,X1

     1333    10350        %EJECT;
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:216  
     1334    10351    1   FINDMAP: PROC(VA);

  10351  2 003213   200136 741300       FINDMAP      STX1  ! @SUBC+1,,AUTO

     1335    10352        /* This program will return a pointer to the page
     1336    10353           table in MAP$ and an index into it in IPG. This subroutine
     1337    10354           wil set WS_FLT to TRUE when using section PT and the Page table
     1338    10355           for the section is set to MM_SCTDFT   */
     1339    10356    2   DCL 1 VA ALIGNED,
     1340    10357    2            2 * BIT(14),
     1341    10358    2            2 SECT# UBIN(12) UNAL,
     1342    10359    2            2 PG# UBIN(10) UNAL;
     1343    10360        /**/
     1344    10361             %FINDMAP (WSQ=WSQ,P$=MAP$); /* get pointer to the section or page table */

  10362  2 003214   200067 720100                    LXL0    WSQ,,AUTO
         2 003215   000000 236010 xsym               LDQ     MM_PTPTRS$,X0
         2 003216   200061 756100                    STQ     MAP$,,AUTO

     1345    10364    3        IF MM$VCB.T.SECTION THEN DO;       /* Section page table */

  10364  2 003217   200065 470500                    LDP0    VCB$,,AUTO
         2 003220   000000 236100                    LDQ     0,,PR0
         2 003221   010000 316003                    CANQ    4096,DU
         2 003222   003317 600000 2                  TZE     s:10381

     1346    10365    3             SECT$=MAP$;

  10365  2 003223   200061 236100                    LDQ     MAP$,,AUTO
         2 003224   200062 756100                    STQ     SECT$,,AUTO

     1347    10366    4             IF B$SECT.PTBASE(VA.SECT#)~=MM_SCTDFT THEN DO;

  10366  2 003225   200137 471500                    LDP1    @VA,,AUTO
         2 003226   100000 236100                    LDQ     0,,PR1
         2 003227   000012 772000                    QRL     10
         2 003230   007777 376007                    ANQ     4095,DL
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:217  
         2 003231   200062 473500                    LDP3    SECT$,,AUTO
         2 003232   300000 236106                    LDQ     0,QL,PR3
         2 003233   000022 772000                    QRL     18
         2 003234   000000 116000 xsym               CMPQ    MM_SCTDFT
         2 003235   003304 600000 2                  TZE     s:10377

     1348    10367    4                  PTBASE=B$SECT.PTBASE(VA.SECT#);

  10367  2 003236   100000 236100                    LDQ     0,,PR1
         2 003237   000012 772000                    QRL     10
         2 003240   007777 376007                    ANQ     4095,DL
         2 003241   300000 236106                    LDQ     0,QL,PR3
         2 003242   000022 772000                    QRL     18
         2 003243   200036 756100                    STQ     PTBASE,,AUTO

     1349    10368    5                  DO MAP_INDEX = MM$VCB.NPGTSECT TO MM$VCB.NPGTSECT+MM$VCB.NPGTPGS -1;

  10368  2 003244   000011 236100                    LDQ     9,,PR0
         2 003245   000022 736000                    QLS     18
         2 003246   000022 732000                    QRS     18
         2 003247   200064 756100                    STQ     MAP_INDEX,,AUTO
         2 003250   003262 710000 2                  TRA     s:10371+1

     1350    10369    5                       IF PTBASE = B$UPT$->B$NMAP.RPN(%VS1PGTBL+ 16 * (WSQ-

  10369  2 003251   200067 236100                    LDQ     WSQ,,AUTO
         2 003252   000004 736000                    QLS     4
         2 003253   200064 036100                    ADLQ    MAP_INDEX,,AUTO
         2 003254   000000 470400 xsym               LDP0    B$UPT$
         2 003255   000630 236106                    LDQ     408,QL,PR0
         2 003256   000022 772000                    QRL     18
         2 003257   200036 116100                    CMPQ    PTBASE,,AUTO
         2 003260   003273 600000 2                  TZE     FOUND_PTBASE

     1351    10370    5                            %VS1WSQ) + MAP_INDEX) THEN GOTO FOUND_PTBASE;
     1352    10371    5                     END;

PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:218  
  10371  2 003261   200064 054100                    AOS     MAP_INDEX,,AUTO
         2 003262   200065 470500                    LDP0    VCB$,,AUTO
         2 003263   000011 236100                    LDQ     9,,PR0
         2 003264   000022 736000                    QLS     18
         2 003265   000022 732000                    QRS     18
         2 003266   000012 036100                    ADLQ    10,,PR0
         2 003267   200064 116100                    CMPQ    MAP_INDEX,,AUTO
         2 003270   003251 605400 2                  TPNZ    s:10369

     1353    10372    4                  CALL SC_MM47;

  10372  2 003271   000000 713400 xsym               CLIMB   SC_MM47
         2 003272   000000 600000 xsid               climb   nvectors=         0

     1354    10373    4   FOUND_PTBASE:
     1355    10374    4                  MAP_PTR.WOFFS = MAP_PTR.WOFFS + MAP_INDEX * 1024;

  10374  2 003273   200061 235100       FOUND_PTBASE LDA     MAP$,,AUTO
         2 003274   000022 771000                    ARL     18
         2 003275   200146 755100                    STA     KEY+2,,AUTO
         2 003276   200064 236100                    LDQ     MAP_INDEX,,AUTO
         2 003277   000012 736000                    QLS     10
         2 003300   200146 036100                    ADLQ    KEY+2,,AUTO
         2 003301   000000 620006                    EAX0    0,QL
         2 003302   200061 740100                    STX0    MAP$,,AUTO

     1356    10375    4                END;

  10375  2 003303   003306 710000 2                  TRA     s:10378

     1357    10376    3             ELSE
     1358    10377    3                  WS_FLT = %TRUE;

  10377  2 003304   400000 236003                    LDQ     -131072,DU
         2 003305   200070 756100                    STQ     WS_FLT,,AUTO

     1359    10378    3             IPG=VA.PG#;
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:219  

  10378  2 003306   200137 470500                    LDP0    @VA,,AUTO
         2 003307   000000 236100                    LDQ     0,,PR0
         2 003310   001777 376007                    ANQ     1023,DL
         2 003311   200035 756100                    STQ     IPG,,AUTO

     1360    10379    3             SCT# = VA.SECT#;

  10379  2 003312   000000 236100                    LDQ     0,,PR0
         2 003313   000012 772000                    QRL     10
         2 003314   007777 376007                    ANQ     4095,DL
         2 003315   200052 756100                    STQ     SCT#,,AUTO

     1361    10380    3           END;

  10380  2 003316   003322 710000 2                  TRA     s:10382

     1362    10381    2        ELSE IPG=BITBIN(VA);

  10381  2 003317   200137 471500                    LDP1    @VA,,AUTO
         2 003320   100000 235100                    LDA     0,,PR1
         2 003321   200035 755100                    STA     IPG,,AUTO

     1363    10382    2        RETURN;

  10382  2 003322   200136 221300                    LDX1  ! @SUBC+1,,AUTO
         2 003323   000001 702211                    TSX2  ! 1,X1

     1364    10383    2   END FINDMAP;
     1365    10384        %EJECT;
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:220  
     1366    10385    1   UPD_SECT_CHAIN :PROC;

  10385  2 003324   200134 741300       UPD_SECT_CH* STX1  ! READ_PAGE+14,,AUTO

     1367    10386        /* This program will take a trip through the page chain,
     1368    10387           producing two chains: accessed and not accessed, which
     1369    10388           will be linked together at the end. SCT PT chain is linked
     1370    10389           with most recently accessed pages at the head and the least
     1371    10390           recently accessed pages at the tail.  The chain is setup up
     1372    10391           this way so when we go the reuse a Page table we can guarantee
     1373    10392           that the Page table with the least recently accessed pages is
     1374    10393           the page table to be re-used. This routine is called if we
     1375    10394            need to re-use a page or re-use a page table.  Note PREDT is
     1376    10395            set to make to next to last VP in the chain.    */
     1377    10396
     1378    10397    2        SCT_USED = -1;

  10397  2 003325   000001 335007                    LCA     1,DL
         2 003326   200053 755100                    STA     SCT_USED,,AUTO

     1379    10398    2        PT = '0'B;

  10398  2 003327   000100 100400                    MLR     fill='000'O
         2 003330   000002 000001 xsym               ADSC9   B_VECTNIL+2              cn=0,n=1
         2 003331   200040 000040                    ADSC9   PT,,AUTO                 cn=0,n=32

     1380    10399    2        TEMP=MM$VCB.PPC;

  10399  2 003332   200065 470500                    LDP0    VCB$,,AUTO
         2 003333   000011 236100                    LDQ     9,,PR0
         2 003334   000022 772000                    QRL     18
         2 003335   200060 756100                    STQ     TEMP,,AUTO

     1381    10400    2        HDACC=-1;                          /* Head of accessed chain */

  10400  2 003336   200024 755100                    STA     HDACC,,AUTO

PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:221  
     1382    10401    2        TLACC=-1;                          /* Tail of accessed chain */

  10401  2 003337   200023 755100                    STA     TLACC,,AUTO

     1383    10402    2        HDNACC=-1;                         /* Head of not accessed chain */

  10402  2 003340   200022 755100                    STA     HDNACC,,AUTO

     1384    10403    2        TLNACC=-1;                         /* Tail of not accessed chain */

  10403  2 003341   200021 755100                    STA     TLNACC,,AUTO

     1385    10404    2        PREDTN = -1;

  10404  2 003342   200033 755100                    STA     PREDTN,,AUTO

     1386    10405    2        NXTVP=MM$VCB.HEAD;

  10405  2 003343   000006 235100                    LDA     6,,PR0
         2 003344   200027 755100                    STA     NXTVP,,AUTO

     1387    10406    3        DO I=1 TO TEMP;

  10406  2 003345   000001 235007                    LDA     1,DL
         2 003346   200017 755100                    STA     I,,AUTO
         2 003347   003511 710000 2                  TRA     s:10445+1

     1388    10407    3             CALL FINDMAP(NXTVP);

  10407  2 003350   200027 630500                    EPPR0   NXTVP,,AUTO
         2 003351   200137 450500                    STP0    @VA,,AUTO
         2 003352   003213 701000 2                  TSX1    FINDMAP
         2 003353   000000 011000                    NOP     0

     1389    10408    3             NXTPP=B$MAP.RPN(IPG);

  10408  2 003354   200061 470500                    LDP0    MAP$,,AUTO
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:222  
         2 003355   200035 720100                    LXL0    IPG,,AUTO
         2 003356   000000 236110                    LDQ     0,X0,PR0
         2 003357   000022 772000                    QRL     18
         2 003360   200030 756100                    STQ     NXTPP,,AUTO

     1390    10409    4             DO J = 0 TO SCT_USED;

  10409  2 003361   200031 450100                    STZ     J,,AUTO
         2 003362   003375 710000 2                  TRA     s:10411+1

     1391    10410    4                  IF PT(J) = SCT# THEN GOTO END_SCT_LOOP;

  10410  2 003363   200031 235100                    LDA     J,,AUTO
         2 003364   000001 735000                    ALS     1
         2 003365   000100 100505                    MLR     fill='000'O
         2 003366   200040 000002                    ADSC9   PT,A,AUTO                cn=0,n=2
         2 003367   200146 000004                    ADSC9   KEY+2,,AUTO              cn=0,n=4
         2 003370   200146 236100                    LDQ     KEY+2,,AUTO
         2 003371   000022 732000                    QRS     18
         2 003372   200052 116100                    CMPQ    SCT#,,AUTO
         2 003373   003414 600000 2                  TZE     END_SCT_LOOP

     1392    10411    4                END;

  10411  2 003374   200031 054100                    AOS     J,,AUTO
         2 003375   200031 236100                    LDQ     J,,AUTO
         2 003376   200053 116100                    CMPQ    SCT_USED,,AUTO
         2 003377   003363 604400 2                  TMOZ    s:10410

     1393    10412    3             SCT_USED = SCT_USED +1;

  10412  2 003400   200053 054100                    AOS     SCT_USED,,AUTO

     1394    10413    3             IF SCT_USED >= MM$VCB.NPGTPGS THEN

  10413  2 003401   200065 470500                    LDP0    VCB$,,AUTO
         2 003402   200053 236100                    LDQ     SCT_USED,,AUTO
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:223  
         2 003403   000012 116100                    CMPQ    10,,PR0
         2 003404   003407 604000 2                  TMI     s:10415

     1395    10414    3                  CALL SC_MM47;

  10414  2 003405   000000 713400 xsym               CLIMB   SC_MM47
         2 003406   000000 600000 xsid               climb   nvectors=         0

     1396    10415    3             PT(SCT_USED) = SCT# ;

  10415  2 003407   200053 235100                    LDA     SCT_USED,,AUTO
         2 003410   000001 735000                    ALS     1
         2 003411   000105 101500                    MRL     fill='000'O
         2 003412   200052 000004                    ADSC9   SCT#,,AUTO               cn=0,n=4
         2 003413   200040 000002                    ADSC9   PT,A,AUTO                cn=0,n=2

     1397    10416    3   END_SCT_LOOP:
     1398    10417    3             IF HW_WSQ0PT THEN

  10417  2 003414   000000 234000 xsym  END_SCT_LOOP SZN     HW_WSQ0PT
         2 003415   003424 605000 2                  TPL     s:10420

     1399    10418    3                  NXTPP=B$IPHYMAP$->MM$IPHY_MAP(NXTPP);

  10418  2 003416   200030 235100                    LDA     NXTPP,,AUTO
         2 003417   000001 735000                    ALS     1
         2 003420   000000 470400 xsym               LDP0    B$IPHYMAP$
         2 003421   000100 101505                    MRL     fill='000'O
         2 003422   000000 000002                    ADSC9   0,A,PR0                  cn=0,n=2
         2 003423   200030 000004                    ADSC9   NXTPP,,AUTO              cn=0,n=4

     1400    10419
     1401    10420    3             IF B$MAP.CTRL(IPG) & %PGACC   /* Page has been accessed */

  10420  2 003424   200061 470500                    LDP0    MAP$,,AUTO
         2 003425   200035 720100                    LXL0    IPG,,AUTO
         2 003426   000000 236110                    LDQ     0,X0,PR0
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:224  
         2 003427   000036 736000                    QLS     30
         2 003430   010000 376003                    ANQ     4096,DU
         2 003431   003463 600000 2                  TZE     NOTACC

     1402    10421    4             THEN DO;

     1403    10422    4   ACCESSED:
     1404    10423    4                  B$MAP.CTRL(IPG) = B$MAP.CTRL(IPG) & ~%PGACC;

  10423  2 003432   000000 236110       ACCESSED     LDQ     0,X0,PR0
         2 003433   000036 736000                    QLS     30
         2 003434   760000 376003                    ANQ     -8192,DU
         2 003435   000036 772000                    QRL     30
         2 003436   000000 676110                    ERQ     0,X0,PR0
         2 003437   000077 376007                    ANQ     63,DL
         2 003440   000000 656110                    ERSQ    0,X0,PR0

     1405    10424    4                  IF HDACC < 0 THEN

  10424  2 003441   200024 235100                    LDA     HDACC,,AUTO
         2 003442   003446 605000 2                  TPL     s:10427

     1406    10425    4                       HDACC = NXTVP;

  10425  2 003443   200027 236100                    LDQ     NXTVP,,AUTO
         2 003444   200024 756100                    STQ     HDACC,,AUTO
         2 003445   003456 710000 2                  TRA     s:10430

     1407    10426    5                  ELSE DO;

     1408    10427    5                       MM$PPUT.PPNO (ACTLPP) = NXTVP;

  10427  2 003446   000000 471400 xsym               LDP1    B$PPUT$
         2 003447   200025 720100                    LXL0    VP,,AUTO
         2 003450   200027 236100                    LDQ     NXTVP,,AUTO
         2 003451   100000 676110                    ERQ     0,X0,PR1
         2 003452   000032 376000 xsym               ANQ     B_VECTNIL+26
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:225  
         2 003453   100000 656110                    ERSQ    0,X0,PR1

     1409    10428    5                       PREDTA = TLACC;     /* Tail predecessor */

  10428  2 003454   200023 236100                    LDQ     TLACC,,AUTO
         2 003455   200032 756100                    STQ     PREDTA,,AUTO

     1410    10429    5                     END;

     1411    10430    4                  TLACC=NXTVP ;            /* Tail  */

  10430  2 003456   200027 235100                    LDA     NXTVP,,AUTO
         2 003457   200023 755100                    STA     TLACC,,AUTO

     1412    10431    4                  ACTLPP=NXTPP;

  10431  2 003460   200030 236100                    LDQ     NXTPP,,AUTO
         2 003461   200025 756100                    STQ     VP,,AUTO

     1413    10432    4                END;

  10432  2 003462   003504 710000 2                  TRA     s:10444

     1414    10433    4             ELSE DO;

     1415    10434    4   NOTACC:
     1416    10435    4                  IF HDNACC<0 THEN

  10435  2 003463   200022 235100       NOTACC       LDA     HDNACC,,AUTO
         2 003464   003470 605000 2                  TPL     s:10438

     1417    10436    4                       HDNACC=NXTVP;

  10436  2 003465   200027 236100                    LDQ     NXTVP,,AUTO
         2 003466   200022 756100                    STQ     HDNACC,,AUTO
         2 003467   003500 710000 2                  TRA     s:10441

PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:226  
     1418    10437    5                  ELSE DO;

     1419    10438    5                       MM$PPUT.PPNO(NACTLPP)=NXTVP;

  10438  2 003470   000000 471400 xsym               LDP1    B$PPUT$
         2 003471   200026 721100                    LXL1    PP,,AUTO
         2 003472   200027 236100                    LDQ     NXTVP,,AUTO
         2 003473   100000 676111                    ERQ     0,X1,PR1
         2 003474   000032 376000 xsym               ANQ     B_VECTNIL+26
         2 003475   100000 656111                    ERSQ    0,X1,PR1

     1420    10439    5                       PREDTN = TLNACC;

  10439  2 003476   200021 236100                    LDQ     TLNACC,,AUTO
         2 003477   200033 756100                    STQ     PREDTN,,AUTO

     1421    10440    5                     END;

     1422    10441    4                  TLNACC=NXTVP;

  10441  2 003500   200027 235100                    LDA     NXTVP,,AUTO
         2 003501   200021 755100                    STA     TLNACC,,AUTO

     1423    10442    4                  NACTLPP=NXTPP;

  10442  2 003502   200030 236100                    LDQ     NXTPP,,AUTO
         2 003503   200026 756100                    STQ     PP,,AUTO

     1424    10443    4                END;

     1425    10444    3             NXTVP=MM$PPUT.PPNO(NXTPP);

  10444  2 003504   000000 471400 xsym               LDP1    B$PPUT$
         2 003505   100000 236106                    LDQ     0,QL,PR1
         2 003506   000032 376000 xsym               ANQ     B_VECTNIL+26
         2 003507   200027 756100                    STQ     NXTVP,,AUTO

PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:227  
     1426    10445    3           END;                            /* DO I=  */

  10445  2 003510   200017 054100                    AOS     I,,AUTO
         2 003511   200017 236100                    LDQ     I,,AUTO
         2 003512   200060 116100                    CMPQ    TEMP,,AUTO
         2 003513   003350 604400 2                  TMOZ    s:10407

     1427    10446    2        IF NXTVP~=BITBIN('777777777'O) THEN

  10446  2 003514   000036 236000 1                  LDQ     PGINUSE+2
         2 003515   000011 772000                    QRL     9
         2 003516   003521 604000 2                  TMI     s:10447
         2 003517   200027 116100                    CMPQ    NXTVP,,AUTO
         2 003520   003523 600000 2                  TZE     s:10448

     1428    10447    2             CALL SC_MM47;

  10447  2 003521   000000 713400 xsym               CLIMB   SC_MM47
         2 003522   000000 600000 xsid               climb   nvectors=         0

     1429    10448    3        IF HDACC>=0 THEN DO;

  10448  2 003523   200024 235100                    LDA     HDACC,,AUTO
         2 003524   003572 604000 2                  TMI     s:10464

     1430    10449    3             MM$VCB.HEAD=HDACC;

  10449  2 003525   200065 470500                    LDP0    VCB$,,AUTO
         2 003526   000006 755100                    STA     6,,PR0

     1431    10450    4             IF HDNACC<0 THEN DO;

  10450  2 003527   200022 236100                    LDQ     HDNACC,,AUTO
         2 003530   003545 605000 2                  TPL     s:10456

     1432    10451    4                  MM$VCB.TAIL=TLACC;

PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:228  
  10451  2 003531   200023 235100                    LDA     TLACC,,AUTO
         2 003532   000007 755100                    STA     7,,PR0

     1433    10452    4                  MM$PPUT.PPNO(ACTLPP)=BITBIN('777777777'O);

  10452  2 003533   000036 236000 1                  LDQ     PGINUSE+2
         2 003534   000011 772000                    QRL     9
         2 003535   000000 471400 xsym               LDP1    B$PPUT$
         2 003536   200025 720100                    LXL0    VP,,AUTO
         2 003537   100000 676110                    ERQ     0,X0,PR1
         2 003540   000032 376000 xsym               ANQ     B_VECTNIL+26
         2 003541   100000 656110                    ERSQ    0,X0,PR1

     1434    10453    4                  PREDT=PREDTA;

  10453  2 003542   200032 236100                    LDQ     PREDTA,,AUTO
         2 003543   200034 756100                    STQ     PREDT,,AUTO

     1435    10454    4                END;

  10454  2 003544   003610 710000 2                  TRA     s:10469

     1436    10455    4             ELSE DO;

     1437    10456    4                  MM$PPUT.PPNO(ACTLPP)=HDNACC;

  10456  2 003545   000000 471400 xsym               LDP1    B$PPUT$
         2 003546   200025 720100                    LXL0    VP,,AUTO
         2 003547   100000 676110                    ERQ     0,X0,PR1
         2 003550   000032 376000 xsym               ANQ     B_VECTNIL+26
         2 003551   100000 656110                    ERSQ    0,X0,PR1

     1438    10457    4                  MM$VCB.TAIL=TLNACC;

  10457  2 003552   200021 236100                    LDQ     TLNACC,,AUTO
         2 003553   000007 756100                    STQ     7,,PR0

PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:229  
     1439    10458    4                  MM$PPUT.PPNO(NACTLPP)=BITBIN('777777777'O);

  10458  2 003554   000036 236000 1                  LDQ     PGINUSE+2
         2 003555   000011 772000                    QRL     9
         2 003556   200026 720100                    LXL0    PP,,AUTO
         2 003557   100000 676110                    ERQ     0,X0,PR1
         2 003560   000032 376000 xsym               ANQ     B_VECTNIL+26
         2 003561   100000 656110                    ERSQ    0,X0,PR1

     1440    10459    4                  IF PREDTN = -1 THEN PREDT = TLACC;

  10459  2 003562   200033 236100                    LDQ     PREDTN,,AUTO
         2 003563   000027 116000 xsym               CMPQ    B_VECTNIL+23
         2 003564   003570 601000 2                  TNZ     s:10460

  10459  2 003565   200023 235100                    LDA     TLACC,,AUTO
         2 003566   200034 755100                    STA     PREDT,,AUTO
         2 003567   003610 710000 2                  TRA     s:10469

     1441    10460    4                  ELSE PREDT=PREDTN;

  10460  2 003570   200034 756100                    STQ     PREDT,,AUTO

     1442    10461    4                END;

     1443    10462    3           END;

  10462  2 003571   003610 710000 2                  TRA     s:10469

     1444    10463    3        ELSE DO;                           /* No accessed pages */

     1445    10464    3             MM$VCB.HEAD=HDNACC;

  10464  2 003572   200065 470500                    LDP0    VCB$,,AUTO
         2 003573   200022 236100                    LDQ     HDNACC,,AUTO
         2 003574   000006 756100                    STQ     6,,PR0

PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:230  
     1446    10465    3             MM$VCB.TAIL=TLNACC;

  10465  2 003575   200021 235100                    LDA     TLNACC,,AUTO
         2 003576   000007 755100                    STA     7,,PR0

     1447    10466    3             MM$PPUT.PPNO(NACTLPP)=BITBIN('777777777'O);

  10466  2 003577   000036 236000 1                  LDQ     PGINUSE+2
         2 003600   000011 772000                    QRL     9
         2 003601   000000 471400 xsym               LDP1    B$PPUT$
         2 003602   200026 720100                    LXL0    PP,,AUTO
         2 003603   100000 676110                    ERQ     0,X0,PR1
         2 003604   000032 376000 xsym               ANQ     B_VECTNIL+26
         2 003605   100000 656110                    ERSQ    0,X0,PR1

     1448    10467    3             PREDT=PREDTN;

  10467  2 003606   200033 236100                    LDQ     PREDTN,,AUTO
         2 003607   200034 756100                    STQ     PREDT,,AUTO

     1449    10468    3           END;

     1450    10469    2        UPD_CHAIN_FLG=%TRUE;

  10469  2 003610   400000 236003                    LDQ     -131072,DU
         2 003611   200055 756100                    STQ     UPD_CHAIN_FLG,,AUTO

     1451    10470    2        RETURN;

  10470  2 003612   200134 221300                    LDX1  ! READ_PAGE+14,,AUTO
         2 003613   000001 702211                    TSX2  ! 1,X1

     1452    10471    2   END UPD_SECT_CHAIN;
     1453    10472        %EJECT;
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:231  
     1454    10473    1   UPD_FRAG_DENSE_CHAIN :PROC;

  10473  2 003614   200134 741300       UPD_FRAG_DE* STX1  ! READ_PAGE+14,,AUTO

     1455    10474        /* This subroutine will take a trip through the page chain,
     1456    10475           producing two chains: accessed and not accessed, which
     1457    10476           will be linked together at the end. The resulting chain
     1458    10477           will be linked with the least recently accessed VP at the
     1459    10478           head of the chain and the most recently accessed VP at the
     1460    10479           tail of the chain.  If using fragmented PT and an entry
     1461    10480           needs to be re-used (PAGE_NO_ENTRY eq -1) PAGE_NO_ENTRY will be
     1462    10481           set to the entry to re-use.  */
     1463    10482    2        TEMP=MM$VCB.PPC;

  10482  2 003615   200065 470500                    LDP0    VCB$,,AUTO
         2 003616   000011 236100                    LDQ     9,,PR0
         2 003617   000022 772000                    QRL     18
         2 003620   200060 756100                    STQ     TEMP,,AUTO

     1464    10483    2        HDACC=-1;                          /* Head of accessed chain */

  10483  2 003621   000001 335007                    LCA     1,DL
         2 003622   200024 755100                    STA     HDACC,,AUTO

     1465    10484    2        NXTVP=MM$VCB.HEAD;

  10484  2 003623   000006 235100                    LDA     6,,PR0
         2 003624   200027 755100                    STA     NXTVP,,AUTO

     1466    10485    2        MM$VCB.HEAD = -1;

  10485  2 003625   000001 335007                    LCA     1,DL
         2 003626   000006 755100                    STA     6,,PR0

     1467    10486    3        DO I=1 TO TEMP;

  10486  2 003627   000001 235007                    LDA     1,DL
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:232  
         2 003630   200017 755100                    STA     I,,AUTO
         2 003631   003747 710000 2                  TRA     s:10516+1

     1468    10487    3             NXTPP=B$MAP.RPN(NXTVP);

  10487  2 003632   200061 470500                    LDP0    MAP$,,AUTO
         2 003633   200027 720100                    LXL0    NXTVP,,AUTO
         2 003634   000000 236110                    LDQ     0,X0,PR0
         2 003635   000022 772000                    QRL     18
         2 003636   200030 756100                    STQ     NXTPP,,AUTO

     1469    10488    3             IF HW_WSQ0PT THEN

  10488  2 003637   000000 234000 xsym               SZN     HW_WSQ0PT
         2 003640   003647 605000 2                  TPL     s:10490

     1470    10489    3                  NXTPP=B$IPHYMAP$->MM$IPHY_MAP(NXTPP);

  10489  2 003641   200030 235100                    LDA     NXTPP,,AUTO
         2 003642   000001 735000                    ALS     1
         2 003643   000000 471400 xsym               LDP1    B$IPHYMAP$
         2 003644   000100 101505                    MRL     fill='000'O
         2 003645   100000 000002                    ADSC9   0,A,PR1                  cn=0,n=2
         2 003646   200030 000004                    ADSC9   NXTPP,,AUTO              cn=0,n=4

     1471    10490    3             IF FRAGMENTED THEN            /* Save oldest PAGE_NO_ENTRY */

  10490  2 003647   200011 234100                    SZN     FRAGMENTED,,AUTO
         2 003650   003666 605000 2                  TPL     s:10497

     1472    10491    3                  IF PAGE_NO_ENTRY < 0 AND (NXTVP - 128)/4 = EVP_PAGE_NO_ENTRY

  10491  2 003651   200010 235100                    LDA     PAGE_NO_ENTRY,,AUTO
         2 003652   003666 605000 2                  TPL     s:10497
         2 003653   200027 236100                    LDQ     NXTVP,,AUTO
         2 003654   000200 136007                    SBLQ    128,DL
         2 003655   000004 506007                    DIV     4,DL
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:233  
         2 003656   000000 116003                    CMPQ    0,DU
         2 003657   003666 604000 2                  TMI     s:10497
         2 003660   200007 116100                    CMPQ    EVP_PAGE_NO_ENTRY,,AUTO
         2 003661   003666 601000 2                  TNZ     s:10497

     1473    10492    4                  THEN DO;

     1474    10493    4                       PAGE_NO_ENTRY = NXTVP - 128;

  10493  2 003662   200027 235100                    LDA     NXTVP,,AUTO
         2 003663   000200 135007                    SBLA    128,DL
         2 003664   200010 755100                    STA     PAGE_NO_ENTRY,,AUTO

     1475    10494    4                       GOTO ACCESSED;

  10494  2 003665   003672 710000 2                  TRA     ACCESSED

     1476    10495    4                     END;
     1477    10496
     1478    10497    3             IF B$MAP.CTRL(NXTVP) & %PGACC /* Page has been accessed */

  10497  2 003666   000000 236110                    LDQ     0,X0,PR0
         2 003667   000036 736000                    QLS     30
         2 003670   010000 376003                    ANQ     4096,DU
         2 003671   003722 600000 2                  TZE     NOTACC

     1479    10498    4             THEN DO;

     1480    10499    4   ACCESSED:      B$MAP.CTRL(NXTVP) = B$MAP.CTRL(NXTVP) & ~%PGACC;

  10499  2 003672   000000 236110       ACCESSED     LDQ     0,X0,PR0
         2 003673   000036 736000                    QLS     30
         2 003674   760000 376003                    ANQ     -8192,DU
         2 003675   000036 772000                    QRL     30
         2 003676   000000 676110                    ERQ     0,X0,PR0
         2 003677   000077 376007                    ANQ     63,DL
         2 003700   000000 656110                    ERSQ    0,X0,PR0
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:234  

     1481    10500    4                  IF HDACC < 0 THEN

  10500  2 003701   200024 235100                    LDA     HDACC,,AUTO
         2 003702   003706 605000 2                  TPL     s:10503

     1482    10501    4                       HDACC = NXTVP;

  10501  2 003703   200027 236100                    LDQ     NXTVP,,AUTO
         2 003704   200024 756100                    STQ     HDACC,,AUTO
         2 003705   003714 710000 2                  TRA     s:10504

     1483    10502    4                  ELSE
     1484    10503    4                       MM$PPUT.PPNO (ACTLPP) = NXTVP;

  10503  2 003706   000000 471400 xsym               LDP1    B$PPUT$
         2 003707   200025 720100                    LXL0    VP,,AUTO
         2 003710   200027 236100                    LDQ     NXTVP,,AUTO
         2 003711   100000 676110                    ERQ     0,X0,PR1
         2 003712   000032 376000 xsym               ANQ     B_VECTNIL+26
         2 003713   100000 656110                    ERSQ    0,X0,PR1

     1485    10504    4                  MM$VCB.TAIL = NXTVP;

  10504  2 003714   200065 471500                    LDP1    VCB$,,AUTO
         2 003715   200027 235100                    LDA     NXTVP,,AUTO
         2 003716   100007 755100                    STA     7,,PR1

     1486    10505    4                  ACTLPP=NXTPP;

  10505  2 003717   200030 236100                    LDQ     NXTPP,,AUTO
         2 003720   200025 756100                    STQ     VP,,AUTO

     1487    10506    4                END;

  10506  2 003721   003742 710000 2                  TRA     s:10515

PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:235  
     1488    10507    4             ELSE DO;

     1489    10508    4   NOTACC:        IF MM$VCB.HEAD < 0 THEN

  10508  2 003722   200065 471500       NOTACC       LDP1    VCB$,,AUTO
         2 003723   100006 235100                    LDA     6,,PR1
         2 003724   003730 605000 2                  TPL     s:10511

     1490    10509    4                       MM$VCB.HEAD = NXTVP;

  10509  2 003725   200027 236100                    LDQ     NXTVP,,AUTO
         2 003726   100006 756100                    STQ     6,,PR1
         2 003727   003736 710000 2                  TRA     s:10512

     1491    10510    4                  ELSE
     1492    10511    4                       MM$PPUT.PPNO(NACTLPP)=NXTVP;

  10511  2 003730   000000 473400 xsym               LDP3    B$PPUT$
         2 003731   200026 721100                    LXL1    PP,,AUTO
         2 003732   200027 236100                    LDQ     NXTVP,,AUTO
         2 003733   300000 676111                    ERQ     0,X1,PR3
         2 003734   000032 376000 xsym               ANQ     B_VECTNIL+26
         2 003735   300000 656111                    ERSQ    0,X1,PR3

     1493    10512    4                  TLNACC=NXTVP;

  10512  2 003736   200027 235100                    LDA     NXTVP,,AUTO
         2 003737   200021 755100                    STA     TLNACC,,AUTO

     1494    10513    4                  NACTLPP=NXTPP;

  10513  2 003740   200030 236100                    LDQ     NXTPP,,AUTO
         2 003741   200026 756100                    STQ     PP,,AUTO

     1495    10514    4                END;

     1496    10515    3             NXTVP=MM$PPUT.PPNO(NXTPP);
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:236  

  10515  2 003742   000000 473400 xsym               LDP3    B$PPUT$
         2 003743   300000 236106                    LDQ     0,QL,PR3
         2 003744   000032 376000 xsym               ANQ     B_VECTNIL+26
         2 003745   200027 756100                    STQ     NXTVP,,AUTO

     1497    10516    3           END;                            /* DO I=  */

  10516  2 003746   200017 054100                    AOS     I,,AUTO
         2 003747   200017 236100                    LDQ     I,,AUTO
         2 003750   200060 116100                    CMPQ    TEMP,,AUTO
         2 003751   003632 604400 2                  TMOZ    s:10487

     1498    10517    2        IF NXTVP~=BITBIN('777777777'O) THEN

  10517  2 003752   000036 236000 1                  LDQ     PGINUSE+2
         2 003753   000011 772000                    QRL     9
         2 003754   003757 604000 2                  TMI     s:10518
         2 003755   200027 116100                    CMPQ    NXTVP,,AUTO
         2 003756   003761 600000 2                  TZE     s:10519

     1499    10518    2             CALL SC_MM47;

  10518  2 003757   000000 713400 xsym               CLIMB   SC_MM47
         2 003760   000000 600000 xsid               climb   nvectors=         0

     1500    10519    2        IF HDACC >= 0 THEN

  10519  2 003761   200024 235100                    LDA     HDACC,,AUTO
         2 003762   003772 604000 2                  TMI     s:10521

     1501    10520    2             MM$PPUT.PPNO(ACTLPP) = BITBIN('777777777'O);

  10520  2 003763   000036 236000 1                  LDQ     PGINUSE+2
         2 003764   000011 772000                    QRL     9
         2 003765   000000 470400 xsym               LDP0    B$PPUT$
         2 003766   200025 720100                    LXL0    VP,,AUTO
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:237  
         2 003767   000000 676110                    ERQ     0,X0,PR0
         2 003770   000032 376000 xsym               ANQ     B_VECTNIL+26
         2 003771   000000 656110                    ERSQ    0,X0,PR0

     1502    10521    2        IF MM$VCB.HEAD < 0 THEN

  10521  2 003772   200065 470500                    LDP0    VCB$,,AUTO
         2 003773   000006 235100                    LDA     6,,PR0
         2 003774   004000 605000 2                  TPL     s:10524

     1503    10522    2             MM$VCB.HEAD=HDACC;

  10522  2 003775   200024 236100                    LDQ     HDACC,,AUTO
         2 003776   000006 756100                    STQ     6,,PR0
         2 003777   004006 710000 2                  TRA     s:10525

     1504    10523    2        ELSE
     1505    10524    2             MM$PPUT.PPNO(NACTLPP) = HDACC;

  10524  2 004000   000000 471400 xsym               LDP1    B$PPUT$
         2 004001   200026 720100                    LXL0    PP,,AUTO
         2 004002   200024 236100                    LDQ     HDACC,,AUTO
         2 004003   100000 676110                    ERQ     0,X0,PR1
         2 004004   000032 376000 xsym               ANQ     B_VECTNIL+26
         2 004005   100000 656110                    ERSQ    0,X0,PR1

     1506    10525    2        UPD_CHAIN_FLG=%TRUE;

  10525  2 004006   400000 236003                    LDQ     -131072,DU
         2 004007   200055 756100                    STQ     UPD_CHAIN_FLG,,AUTO

     1507    10526    2        RETURN;

  10526  2 004010   200134 221300                    LDX1  ! READ_PAGE+14,,AUTO
         2 004011   000001 702211                    TSX2  ! 1,X1

     1508    10527    2   END UPD_FRAG_DENSE_CHAIN;
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:238  
     1509    10528
     1510    10529        %EJECT;
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:239  
     1511    10530    1   REUSE_INACTIVE_PT: PROC;

  10530  2 004012   200134 741300       REUSE_INACT* STX1  ! READ_PAGE+14,,AUTO

     1512    10531
     1513    10532    3        DO I=0 TO MM$VCB.WSPTD.NBLKS*64-1; /* Find out what page tables

  10532  2 004013   200017 450100                    STZ     I,,AUTO
         2 004014   004062 710000 2                  TRA     PAGE_USED+1

     1514    10533        exist */
     1515    10534    3             IF B$SECT.PTBASE(I) ~= MM_SCTDFT

  10534  2 004015   200062 470500                    LDP0    SECT$,,AUTO
         2 004016   200017 720100                    LXL0    I,,AUTO
         2 004017   000000 236110                    LDQ     0,X0,PR0
         2 004020   000022 772000                    QRL     18
         2 004021   000000 116000 xsym               CMPQ    MM_SCTDFT
         2 004022   004061 600000 2                  TZE     PAGE_USED

     1516    10535    4             THEN DO;

     1517    10536    5                  DO J = 0 TO SCT_USED;

  10536  2 004023   200031 450100                    STZ     J,,AUTO
         2 004024   004037 710000 2                  TRA     s:10538+1

     1518    10537    5                       IF I = PT(J) THEN GOTO PAGE_USED;

  10537  2 004025   200031 235100                    LDA     J,,AUTO
         2 004026   000001 735000                    ALS     1
         2 004027   000100 100505                    MLR     fill='000'O
         2 004030   200040 000002                    ADSC9   PT,A,AUTO                cn=0,n=2
         2 004031   200146 000004                    ADSC9   KEY+2,,AUTO              cn=0,n=4
         2 004032   200146 236100                    LDQ     KEY+2,,AUTO
         2 004033   000022 732000                    QRS     18
         2 004034   200017 116100                    CMPQ    I,,AUTO
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:240  
         2 004035   004061 600000 2                  TZE     PAGE_USED

     1519    10538    5                     END;

  10538  2 004036   200031 054100                    AOS     J,,AUTO
         2 004037   200031 236100                    LDQ     J,,AUTO
         2 004040   200053 116100                    CMPQ    SCT_USED,,AUTO
         2 004041   004025 604400 2                  TMOZ    s:10537

     1520    10539    4                  PTBASE = B$SECT.PTBASE(I);

  10539  2 004042   200062 470500                    LDP0    SECT$,,AUTO
         2 004043   200017 720100                    LXL0    I,,AUTO
         2 004044   000000 236110                    LDQ     0,X0,PR0
         2 004045   000022 772000                    QRL     18
         2 004046   200036 756100                    STQ     PTBASE,,AUTO

     1521    10540    4                  B$SECT(EVPSECT.SECT#) = B$SECT(I);

  10540  2 004047   200006 236100                    LDQ     EVP,,AUTO
         2 004050   000012 772000                    QRL     10
         2 004051   007777 376007                    ANQ     4095,DL
         2 004052   000000 621006                    EAX1    0,QL
         2 004053   000000 236110                    LDQ     0,X0,PR0
         2 004054   000000 756111                    STQ     0,X1,PR0

     1522    10541    4                  B$SECT.PTBASE(I) = MM_SCTDFT;

  10541  2 004055   000000 721000 xsym               LXL1    MM_SCTDFT
         2 004056   000000 741110                    STX1    0,X0,PR0

     1523    10542    4                  RETURN;

  10542  2 004057   200134 221300                    LDX1  ! READ_PAGE+14,,AUTO
         2 004060   000001 702211                    TSX2  ! 1,X1

     1524    10543    4                END;
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:241  
     1525    10544    3   PAGE_USED:
     1526    10545    3           END;

  10545  2 004061   200017 054100       PAGE_USED    AOS     I,,AUTO
         2 004062   200065 470500                    LDP0    VCB$,,AUTO
         2 004063   000005 236100                    LDQ     5,,PR0
         2 004064   000006 736000                    QLS     6
         2 004065   777700 376007                    ANQ     -64,DL
         2 004066   200017 116100                    CMPQ    I,,AUTO
         2 004067   004015 605400 2                  TPNZ    s:10534

     1527    10546    2        CALL SC_MM47;

  10546  2 004070   000000 713400 xsym               CLIMB   SC_MM47
         2 004071   000000 600000 xsid               climb   nvectors=         0

     1528    10547    2   END REUSE_INACTIVE_PT;

  10547  2 004072   200134 221300                    LDX1  ! READ_PAGE+14,,AUTO
         2 004073   000001 702211                    TSX2  ! 1,X1

     1529    10548        %EJECT;
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:242  
     1530    10549    1   REUSE_ACTIVE_PT: PROC;

  10549  2 004074   200134 741300       REUSE_ACTIV* STX1  ! READ_PAGE+14,,AUTO

     1531    10550
     1532    10551    2        TEMP=0;                            /* Index in the PT array */

  10551  2 004075   200060 450100                    STZ     TEMP,,AUTO

     1533    10552        /* Follow the page chain and find %MM_MAXPTENTS - MM$VCB.NPGTSECT-1  hits */
     1534    10553        /* the MM_MAXPGENTS - MM$VCB.NPGTSECT page table is going to be replaced */
     1535    10554    2        J=1;

  10554  2 004076   000001 235007                    LDA     1,DL
         2 004077   200031 755100                    STA     J,,AUTO

     1536    10555    2        NXTVP=MM$VCB.HEAD;

  10555  2 004100   200065 470500                    LDP0    VCB$,,AUTO
         2 004101   000006 235100                    LDA     6,,PR0
         2 004102   200027 755100                    STA     NXTVP,,AUTO

     1537    10556    2        VP=NXTVP;

  10556  2 004103   200025 755100                    STA     VP,,AUTO

     1538    10557    2        I=0;

  10557  2 004104   200017 450100                    STZ     I,,AUTO

     1539    10558    3        DO UNTIL I=%MM_MAXPTENTS - MM$VCB.NPGTSECT - 1;
             10558                 /* I is used to count the hits */

     1540    10559    3             PREDT=VP;

  10559  2 004105   200025 235100                    LDA     VP,,AUTO
         2 004106   200034 755100                    STA     PREDT,,AUTO
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:243  

     1541    10560    3             VP=NXTVP;

  10560  2 004107   200027 236100                    LDQ     NXTVP,,AUTO
         2 004110   200025 756100                    STQ     VP,,AUTO

     1542    10561    4             DO TEMP=0 TO %MM_MAXPTENTS - MM$VCB.NPGTSECT- 1;

  10561  2 004111   200060 450100                    STZ     TEMP,,AUTO
         2 004112   004135 710000 2                  TRA     s:10566+1

     1543    10562    5                  IF PT(TEMP)=VPSECT.SECT# THEN DO;

  10562  2 004113   200025 236100                    LDQ     VP,,AUTO
         2 004114   000012 772000                    QRL     10
         2 004115   007777 376007                    ANQ     4095,DL
         2 004116   200146 756100                    STQ     KEY+2,,AUTO
         2 004117   200060 235100                    LDA     TEMP,,AUTO
         2 004120   000001 735000                    ALS     1
         2 004121   000100 100505                    MLR     fill='000'O
         2 004122   200040 000002                    ADSC9   PT,A,AUTO                cn=0,n=2
         2 004123   200147 000004                    ADSC9   KEY+3,,AUTO              cn=0,n=4
         2 004124   200147 236100                    LDQ     KEY+3,,AUTO
         2 004125   000022 732000                    QRS     18
         2 004126   200146 116100                    CMPQ    KEY+2,,AUTO
         2 004127   004134 601000 2                  TNZ     s:10566

     1544    10563    5                       PT(TEMP)=-1;

  10563  2 004130   000105 101400                    MRL     fill='000'O
         2 004131   000027 000004 xsym               ADSC9   B_VECTNIL+23             cn=0,n=4
         2 004132   200040 000002                    ADSC9   PT,A,AUTO                cn=0,n=2

     1545    10564    5                       I=I+1;

  10564  2 004133   200017 054100                    AOS     I,,AUTO

PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:244  
     1546    10565    5                     END;

     1547    10566    4                END;                       /* DO TEMP= */

  10566  2 004134   200060 054100                    AOS     TEMP,,AUTO
         2 004135   200065 470500                    LDP0    VCB$,,AUTO
         2 004136   000011 236100                    LDQ     9,,PR0
         2 004137   000022 736000                    QLS     18
         2 004140   000022 732000                    QRS     18
         2 004141   000027 676000 xsym               ERQ     B_VECTNIL+23
         2 004142   000020 036007                    ADLQ    16,DL
         2 004143   200060 116100                    CMPQ    TEMP,,AUTO
         2 004144   004113 605000 2                  TPL     s:10562

     1548    10567    3             CALL FINDMAP(VP);

  10567  2 004145   200025 631500                    EPPR1   VP,,AUTO
         2 004146   200137 451500                    STP1    @VA,,AUTO
         2 004147   003213 701000 2                  TSX1    FINDMAP
         2 004150   000000 011000                    NOP     0

     1549    10568    3             IF HW_WSQ0PT THEN

  10568  2 004151   000000 234000 xsym               SZN     HW_WSQ0PT
         2 004152   004172 605000 2                  TPL     s:10571

     1550    10569    3                  NXTVP = MM$PPUT.PPNO(B$IPHYMAP$->MM$IPHY_MAP(B$MAP.RPN(IPG)));

  10569  2 004153   200061 470500                    LDP0    MAP$,,AUTO
         2 004154   200035 720100                    LXL0    IPG,,AUTO
         2 004155   000000 236110                    LDQ     0,X0,PR0
         2 004156   000022 772000                    QRL     18
         2 004157   000001 736000                    QLS     1
         2 004160   000000 471400 xsym               LDP1    B$IPHYMAP$
         2 004161   000100 100506                    MLR     fill='000'O
         2 004162   100000 000002                    ADSC9   0,Q,PR1                  cn=0,n=2
         2 004163   200146 000004                    ADSC9   KEY+2,,AUTO              cn=0,n=4
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:245  
         2 004164   200146 221100                    LDX1    KEY+2,,AUTO
         2 004165   000000 473400 xsym               LDP3    B$PPUT$
         2 004166   300000 236111                    LDQ     0,X1,PR3
         2 004167   000032 376000 xsym               ANQ     B_VECTNIL+26
         2 004170   200027 756100                    STQ     NXTVP,,AUTO
         2 004171   004201 710000 2                  TRA     s:10572

     1551    10570    3             ELSE
     1552    10571    3                  NXTVP=MM$PPUT.PPNO(B$MAP.RPN(IPG));

  10571  2 004172   200061 470500                    LDP0    MAP$,,AUTO
         2 004173   200035 720100                    LXL0    IPG,,AUTO
         2 004174   000000 221110                    LDX1    0,X0,PR0
         2 004175   000000 471400 xsym               LDP1    B$PPUT$
         2 004176   100000 236111                    LDQ     0,X1,PR1
         2 004177   000032 376000 xsym               ANQ     B_VECTNIL+26
         2 004200   200027 756100                    STQ     NXTVP,,AUTO

     1553    10572    3             IF NXTVP=MM$VCB.TAIL THEN

  10572  2 004201   200065 471500                    LDP1    VCB$,,AUTO
         2 004202   100007 116100                    CMPQ    7,,PR1
         2 004203   004206 601000 2                  TNZ     s:10574

     1554    10573    3                  CALL SC_MM47;

  10573  2 004204   000000 713400 xsym               CLIMB   SC_MM47
         2 004205   000000 600000 xsid               climb   nvectors=         0

     1555    10574    3             J=J+1;

  10574  2 004206   200031 054100                    AOS     J,,AUTO

     1556    10575    3           END;                            /* DO UNTIL */

  10575  2 004207   200065 470500                    LDP0    VCB$,,AUTO
         2 004210   000011 236100                    LDQ     9,,PR0
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:246  
         2 004211   000022 736000                    QLS     18
         2 004212   000022 732000                    QRS     18
         2 004213   000027 676000 xsym               ERQ     B_VECTNIL+23
         2 004214   000020 036007                    ADLQ    16,DL
         2 004215   200017 116100                    CMPQ    I,,AUTO
         2 004216   004105 601000 2                  TNZ     s:10559

     1557    10576        /* At this point only one PT entry contains a value~=-1 */
     1558    10577        /* and this is the SECT# that we are going to replace */
     1559    10578    3        DO I=0 TO %MM_MAXPTENTS - MM$VCB.NPGTSECT- 1;

  10578  2 004217   200017 450100                    STZ     I,,AUTO
         2 004220   004233 710000 2                  TRA     s:10580+1

     1560    10579    3             IF PT(I)~=-1 THEN GOTO UNUSED_PT;

  10579  2 004221   200017 235100                    LDA     I,,AUTO
         2 004222   000001 735000                    ALS     1
         2 004223   000100 100505                    MLR     fill='000'O
         2 004224   200040 000002                    ADSC9   PT,A,AUTO                cn=0,n=2
         2 004225   200146 000004                    ADSC9   KEY+2,,AUTO              cn=0,n=4
         2 004226   200146 236100                    LDQ     KEY+2,,AUTO
         2 004227   000022 732000                    QRS     18
         2 004230   000027 116000 xsym               CMPQ    B_VECTNIL+23
         2 004231   004243 601000 2                  TNZ     UNUSED_PT

     1561    10580    3           END;

  10580  2 004232   200017 054100                    AOS     I,,AUTO
         2 004233   200065 470500                    LDP0    VCB$,,AUTO
         2 004234   000011 236100                    LDQ     9,,PR0
         2 004235   000022 736000                    QLS     18
         2 004236   000022 732000                    QRS     18
         2 004237   000027 676000 xsym               ERQ     B_VECTNIL+23
         2 004240   000020 036007                    ADLQ    16,DL
         2 004241   200017 116100                    CMPQ    I,,AUTO
         2 004242   004221 605000 2                  TPL     s:10579
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:247  

     1562    10581    2   UNUSED_PT:
     1563    10582    2        PTBASE = B$SECT.PTBASE(PT(I));

  10582  2 004243   200017 235100       UNUSED_PT    LDA     I,,AUTO
         2 004244   000001 735000                    ALS     1
         2 004245   000100 100505                    MLR     fill='000'O
         2 004246   200040 000002                    ADSC9   PT,A,AUTO                cn=0,n=2
         2 004247   200146 000004                    ADSC9   KEY+2,,AUTO              cn=0,n=4
         2 004250   200146 236100                    LDQ     KEY+2,,AUTO
         2 004251   000022 732000                    QRS     18
         2 004252   200062 470500                    LDP0    SECT$,,AUTO
         2 004253   000000 236106                    LDQ     0,QL,PR0
         2 004254   000022 772000                    QRL     18
         2 004255   200036 756100                    STQ     PTBASE,,AUTO

     1564    10583    3        DO K = MM$VCB.NPGTSECT TO MM$VCB.NPGTSECT+MM$VCB.NPGTPGS -1;

  10583  2 004256   200065 471500                    LDP1    VCB$,,AUTO
         2 004257   100011 236100                    LDQ     9,,PR1
         2 004260   000022 736000                    QLS     18
         2 004261   000022 732000                    QRS     18
         2 004262   200020 756100                    STQ     K,,AUTO
         2 004263   004275 710000 2                  TRA     s:10586+1

     1565    10584    3             IF PTBASE = B$UPT$->B$NMAP.RPN(%VS1PGTBL+ 16 * (WSQ-

  10584  2 004264   200067 236100                    LDQ     WSQ,,AUTO
         2 004265   000004 736000                    QLS     4
         2 004266   200020 036100                    ADLQ    K,,AUTO
         2 004267   000000 470400 xsym               LDP0    B$UPT$
         2 004270   000630 236106                    LDQ     408,QL,PR0
         2 004271   000022 772000                    QRL     18
         2 004272   200036 116100                    CMPQ    PTBASE,,AUTO
         2 004273   004306 600000 2                  TZE     FOUND_PTBASE

     1566    10585    3                  %VS1WSQ) + K) THEN GOTO FOUND_PTBASE;
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:248  
     1567    10586    3           END;

  10586  2 004274   200020 054100                    AOS     K,,AUTO
         2 004275   200065 470500                    LDP0    VCB$,,AUTO
         2 004276   000011 236100                    LDQ     9,,PR0
         2 004277   000022 736000                    QLS     18
         2 004300   000022 732000                    QRS     18
         2 004301   000012 036100                    ADLQ    10,,PR0
         2 004302   200020 116100                    CMPQ    K,,AUTO
         2 004303   004264 605400 2                  TPNZ    s:10584

     1568    10587    2        CALL SC_MM47;

  10587  2 004304   000000 713400 xsym               CLIMB   SC_MM47
         2 004305   000000 600000 xsid               climb   nvectors=         0

     1569    10588    2   FOUND_PTBASE:
     1570    10589    2        UNMAP$ = SECT$;

  10589  2 004306   200062 236100       FOUND_PTBASE LDQ     SECT$,,AUTO
         2 004307   200063 756100                    STQ     UNMAP$,,AUTO

     1571    10590    2        UNMAP_PTR.WOFFS = UNMAP_PTR.WOFFS + K * 1024;

  10590  2 004310   200063 235100                    LDA     UNMAP$,,AUTO
         2 004311   000022 771000                    ARL     18
         2 004312   200146 755100                    STA     KEY+2,,AUTO
         2 004313   200020 236100                    LDQ     K,,AUTO
         2 004314   000012 736000                    QLS     10
         2 004315   200146 036100                    ADLQ    KEY+2,,AUTO
         2 004316   000000 620006                    EAX0    0,QL
         2 004317   200063 740100                    STX0    UNMAP$,,AUTO

     1572    10591    2        TEMP=MM$VCB.PPC;

  10591  2 004320   200065 470500                    LDP0    VCB$,,AUTO
         2 004321   000011 236100                    LDQ     9,,PR0
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:249  
         2 004322   000022 772000                    QRL     18
         2 004323   200060 756100                    STQ     TEMP,,AUTO

     1573    10592    3        DO J=J TO TEMP;

  10592  2 004324   004504 710000 2                  TRA     s:10625+1

     1574    10593    3             CALL FINDMAP(NXTVP);

  10593  2 004325   200027 630500                    EPPR0   NXTVP,,AUTO
         2 004326   200137 450500                    STP0    @VA,,AUTO
         2 004327   003213 701000 2                  TSX1    FINDMAP
         2 004330   000000 011000                    NOP     0

     1575    10594    3             NXTPP=B$MAP.RPN(IPG);

  10594  2 004331   200061 470500                    LDP0    MAP$,,AUTO
         2 004332   200035 720100                    LXL0    IPG,,AUTO
         2 004333   000000 236110                    LDQ     0,X0,PR0
         2 004334   000022 772000                    QRL     18
         2 004335   200030 756100                    STQ     NXTPP,,AUTO

     1576    10595    3             IF HW_WSQ0PT THEN

  10595  2 004336   000000 234000 xsym               SZN     HW_WSQ0PT
         2 004337   004346 605000 2                  TPL     s:10597

     1577    10596    3                  NXTPP=B$IPHYMAP$->MM$IPHY_MAP(NXTPP);

  10596  2 004340   200030 235100                    LDA     NXTPP,,AUTO
         2 004341   000001 735000                    ALS     1
         2 004342   000000 471400 xsym               LDP1    B$IPHYMAP$
         2 004343   000100 101505                    MRL     fill='000'O
         2 004344   100000 000002                    ADSC9   0,A,PR1                  cn=0,n=2
         2 004345   200030 000004                    ADSC9   NXTPP,,AUTO              cn=0,n=4

     1578    10597    4             IF NXTVPSECT.SECT#=PT(I) THEN DO; /* The page is mapped
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:250  

  10597  2 004346   200017 235100                    LDA     I,,AUTO
         2 004347   000001 735000                    ALS     1
         2 004350   000100 100505                    MLR     fill='000'O
         2 004351   200040 000002                    ADSC9   PT,A,AUTO                cn=0,n=2
         2 004352   200146 000004                    ADSC9   KEY+2,,AUTO              cn=0,n=4
         2 004353   200146 236100                    LDQ     KEY+2,,AUTO
         2 004354   000022 732000                    QRS     18
         2 004355   200147 756100                    STQ     KEY+3,,AUTO
         2 004356   200027 236100                    LDQ     NXTVP,,AUTO
         2 004357   000012 772000                    QRL     10
         2 004360   007777 376007                    ANQ     4095,DL
         2 004361   200147 116100                    CMPQ    KEY+3,,AUTO
         2 004362   004472 601000 2                  TNZ     s:10621

     1579    10598           into the PT to be reused, so we have to get rid of it */
     1580    10599    4                  IF NOT (UNMAP$->B$NMAP.CTRL(NXTVPSECT.PG#) & %PGINMEM)

  10599  2 004363   200027 721100                    LXL1    NXTVP,,AUTO
         2 004364   001777 361003                    ANX1    1023,DU
         2 004365   200063 471500                    LDP1    UNMAP$,,AUTO
         2 004366   100000 236111                    LDQ     0,X1,PR1
         2 004367   000036 736000                    QLS     30
         2 004370   400000 376003                    ANQ     -131072,DU
         2 004371   004374 601000 2                  TNZ     s:10601

     1581    10600    4                  THEN CALL SC_MM47;

  10600  2 004372   000000 713400 xsym               CLIMB   SC_MM47
         2 004373   000000 600000 xsid               climb   nvectors=         0

     1582    10601    5                  IF UNMAP$->B$NMAP.CTRL(NXTVPSECT.PG#) & %PGMOD THEN DO;

  10601  2 004374   200027 720100                    LXL0    NXTVP,,AUTO
         2 004375   001777 360003                    ANX0    1023,DU
         2 004376   200063 470500                    LDP0    UNMAP$,,AUTO
         2 004377   000000 236110                    LDQ     0,X0,PR0
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:251  
         2 004400   000036 736000                    QLS     30
         2 004401   020000 376003                    ANQ     8192,DU
         2 004402   004413 600000 2                  TZE     s:10608

     1583    10602          /* We have to write the page on disk */
     1584    10603    5                       PP=NXTPP;

  10603  2 004403   200030 235100                    LDA     NXTPP,,AUTO
         2 004404   200026 755100                    STA     PP,,AUTO

     1585    10604    5                       CALL CVM;

  10604  2 004405   002426 701000 2                  TSX1    CVM
         2 004406   000000 011000                    NOP     0

     1586    10605    5                       CALL WRITE$PAGE(NXTVP);

  10605  2 004407   200027 630500                    EPPR0   NXTVP,,AUTO
         2 004410   200137 450500                    STP0    @VA,,AUTO
         2 004411   003020 701000 2                  TSX1    WRITE$PAGE
         2 004412   000000 011000                    NOP     0

     1587    10606    5                     END;

     1588    10607        /*  Give the page back */
     1589    10608    4                  SAVE_PPUT = MM$PPUT(NXTPP);

  10608  2 004413   000000 470400 xsym               LDP0    B$PPUT$
         2 004414   200030 720100                    LXL0    NXTPP,,AUTO
         2 004415   000000 236110                    LDQ     0,X0,PR0
         2 004416   200050 756100                    STQ     SAVE_PPUT,,AUTO

     1590    10609    5                  CALL MME$WFVP(WSQ,NXTVP,,ERR) WHENALTRETURN DO;

  10609  2 004417   200016 631500                    EPPR1   ERR,,AUTO
         2 004420   200151 451500                    STP1    KEY+5,,AUTO
         2 004421   000001 236000 xsym               LDQ     B_VECTNIL+1
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:252  
         2 004422   200150 756100                    STQ     KEY+4,,AUTO
         2 004423   200027 633500                    EPPR3   NXTVP,,AUTO
         2 004424   200147 453500                    STP3    KEY+3,,AUTO
         2 004425   200067 634500                    EPPR4   WSQ,,AUTO
         2 004426   200146 454500                    STP4    KEY+2,,AUTO
         2 004427   200146 630500                    EPPR0   KEY+2,,AUTO
         2 004430   000022 631400 xsym               EPPR1   B_VECTNIL+18
         2 004431   000000 701000 xent               TSX1    MME$WFVP
         2 004432   004434 702000 2                  TSX2    s:10610
         2 004433   004436 710000 2                  TRA     s:10612

     1591    10610    5                       CALL SC_MM47;

  10610  2 004434   000000 713400 xsym               CLIMB   SC_MM47
         2 004435   000000 600000 xsid               climb   nvectors=         0

     1592    10611    5                     END;

     1593    10612    4                  MM$VCB.PPC=MM$VCB.PPC-1;

  10612  2 004436   200065 470500                    LDP0    VCB$,,AUTO
         2 004437   000011 220100                    LDX0    9,,PR0
         2 004440   777777 621010                    EAX1    -1,X0
         2 004441   000011 741100                    STX1    9,,PR0

     1594    10613        /* Take the page out from the chain */
     1595    10614    4                  CALL FINDMAP(VP);        /* The previous page in the chain */

  10614  2 004442   200025 631500                    EPPR1   VP,,AUTO
         2 004443   200137 451500                    STP1    @VA,,AUTO
         2 004444   003213 701000 2                  TSX1    FINDMAP
         2 004445   000000 011000                    NOP     0

     1596    10615    4                  PP=B$MAP.RPN(IPG);

  10615  2 004446   200061 470500                    LDP0    MAP$,,AUTO
         2 004447   200035 720100                    LXL0    IPG,,AUTO
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:253  
         2 004450   000000 236110                    LDQ     0,X0,PR0
         2 004451   000022 772000                    QRL     18
         2 004452   200026 756100                    STQ     PP,,AUTO

     1597    10616    4                  IF HW_WSQ0PT THEN PP=B$IPHYMAP$->MM$IPHY_MAP(PP);

  10616  2 004453   000000 234000 xsym               SZN     HW_WSQ0PT
         2 004454   004463 605000 2                  TPL     s:10617

  10616  2 004455   200026 235100                    LDA     PP,,AUTO
         2 004456   000001 735000                    ALS     1
         2 004457   000000 471400 xsym               LDP1    B$IPHYMAP$
         2 004460   000100 101505                    MRL     fill='000'O
         2 004461   100000 000002                    ADSC9   0,A,PR1                  cn=0,n=2
         2 004462   200026 000004                    ADSC9   PP,,AUTO                 cn=0,n=4

     1598    10617    4                  MM$PPUT(PP)=SAVE_PPUT;

  10617  2 004463   200050 236100                    LDQ     SAVE_PPUT,,AUTO
         2 004464   000000 471400 xsym               LDP1    B$PPUT$
         2 004465   200026 721100                    LXL1    PP,,AUTO
         2 004466   100000 756111                    STQ     0,X1,PR1

     1599    10618    4                  NXTPP = PP;

  10618  2 004467   200026 235100                    LDA     PP,,AUTO
         2 004470   200030 755100                    STA     NXTPP,,AUTO

     1600    10619    4                END;

  10619  2 004471   004476 710000 2                  TRA     s:10624

     1601    10620    4             ELSE DO;       /* The page is mapped somewhere else, so it stays */

     1602    10621    4                  PREDT=VP;

  10621  2 004472   200025 235100                    LDA     VP,,AUTO
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:254  
         2 004473   200034 755100                    STA     PREDT,,AUTO

     1603    10622    4                  VP=NXTVP;

  10622  2 004474   200027 235100                    LDA     NXTVP,,AUTO
         2 004475   200025 755100                    STA     VP,,AUTO

     1604    10623    4                END;

     1605    10624    3             NXTVP=MM$PPUT.PPNO(NXTPP);    /* Advance NXTVP */

  10624  2 004476   000000 471400 xsym               LDP1    B$PPUT$
         2 004477   200030 720100                    LXL0    NXTPP,,AUTO
         2 004500   100000 236110                    LDQ     0,X0,PR1
         2 004501   000032 376000 xsym               ANQ     B_VECTNIL+26
         2 004502   200027 756100                    STQ     NXTVP,,AUTO

     1606    10625    3           END; /* We have been through the chain and eliminated all the

  10625  2 004503   200031 054100                    AOS     J,,AUTO
         2 004504   200031 236100                    LDQ     J,,AUTO
         2 004505   200060 116100                    CMPQ    TEMP,,AUTO
         2 004506   004325 604400 2                  TMOZ    s:10593

     1607    10626         pages mapped into the PT to be reused */
     1608    10627    2        MM$VCB.TAIL=VP;

  10627  2 004507   200065 470500                    LDP0    VCB$,,AUTO
         2 004510   200025 235100                    LDA     VP,,AUTO
         2 004511   000007 755100                    STA     7,,PR0

     1609    10628    2        CALL FINDMAP(VP);

  10628  2 004512   200025 631500                    EPPR1   VP,,AUTO
         2 004513   200137 451500                    STP1    @VA,,AUTO
         2 004514   003213 701000 2                  TSX1    FINDMAP
         2 004515   000000 011000                    NOP     0
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:255  

     1610    10629
     1611    10630    2        IF HW_WSQ0PT THEN

  10630  2 004516   000000 234000 xsym               SZN     HW_WSQ0PT
         2 004517   004541 605000 2                  TPL     s:10633

     1612    10631    2            MM$PPUT.PPNO(B$IPHYMAP$->MM$IPHY_MAP(B$MAP.RPN(IPG)))=BITBIN('777777777'O)
             10631                      ;

  10631  2 004520   200061 470500                    LDP0    MAP$,,AUTO
         2 004521   200035 720100                    LXL0    IPG,,AUTO
         2 004522   000000 236110                    LDQ     0,X0,PR0
         2 004523   000022 772000                    QRL     18
         2 004524   000001 736000                    QLS     1
         2 004525   000000 471400 xsym               LDP1    B$IPHYMAP$
         2 004526   000100 100506                    MLR     fill='000'O
         2 004527   100000 000002                    ADSC9   0,Q,PR1                  cn=0,n=2
         2 004530   200146 000004                    ADSC9   KEY+2,,AUTO              cn=0,n=4
         2 004531   200146 221100                    LDX1    KEY+2,,AUTO
         2 004532   000036 236000 1                  LDQ     PGINUSE+2
         2 004533   000011 772000                    QRL     9
         2 004534   000000 473400 xsym               LDP3    B$PPUT$
         2 004535   300000 676111                    ERQ     0,X1,PR3
         2 004536   000032 376000 xsym               ANQ     B_VECTNIL+26
         2 004537   300000 656111                    ERSQ    0,X1,PR3
         2 004540   004552 710000 2                  TRA     s:10634

     1613    10632    2        ELSE
     1614    10633    2             MM$PPUT.PPNO(B$MAP.RPN(IPG)) = BITBIN('777777777'O);

  10633  2 004541   200061 470500                    LDP0    MAP$,,AUTO
         2 004542   200035 720100                    LXL0    IPG,,AUTO
         2 004543   000000 221110                    LDX1    0,X0,PR0
         2 004544   000036 236000 1                  LDQ     PGINUSE+2
         2 004545   000011 772000                    QRL     9
         2 004546   000000 471400 xsym               LDP1    B$PPUT$
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:256  
         2 004547   100000 676111                    ERQ     0,X1,PR1
         2 004550   000032 376000 xsym               ANQ     B_VECTNIL+26
         2 004551   100000 656111                    ERSQ    0,X1,PR1

     1615    10634    2        B$SECT(EVPSECT.SECT#)=B$SECT(PT(I));

  10634  2 004552   200006 236100                    LDQ     EVP,,AUTO
         2 004553   000012 772000                    QRL     10
         2 004554   007777 376007                    ANQ     4095,DL
         2 004555   200017 235100                    LDA     I,,AUTO
         2 004556   000001 735000                    ALS     1
         2 004557   000100 100505                    MLR     fill='000'O
         2 004560   200040 000002                    ADSC9   PT,A,AUTO                cn=0,n=2
         2 004561   200146 000004                    ADSC9   KEY+2,,AUTO              cn=0,n=4
         2 004562   000000 620006                    EAX0    0,QL
         2 004563   200146 236100                    LDQ     KEY+2,,AUTO
         2 004564   000022 732000                    QRS     18
         2 004565   200062 471500                    LDP1    SECT$,,AUTO
         2 004566   100000 236106                    LDQ     0,QL,PR1
         2 004567   100000 756110                    STQ     0,X0,PR1

     1616    10635    2        B$SECT.PTBASE(PT(I))=MM_SCTDFT;

  10635  2 004570   000100 100505                    MLR     fill='000'O
         2 004571   200040 000002                    ADSC9   PT,A,AUTO                cn=0,n=2
         2 004572   200146 000004                    ADSC9   KEY+2,,AUTO              cn=0,n=4
         2 004573   200146 236100                    LDQ     KEY+2,,AUTO
         2 004574   000022 732000                    QRS     18
         2 004575   000000 720000 xsym               LXL0    MM_SCTDFT
         2 004576   100000 740106                    STX0    0,QL,PR1

     1617    10636    2   END REUSE_ACTIVE_PT;

  10636  2 004577   200134 221300                    LDX1  ! READ_PAGE+14,,AUTO
         2 004600   000001 702211                    TSX2  ! 1,X1

READ_PAGEC
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:257  
 Sect OctLoc
   1     000   000005 777640   000010 006000   000000 177640   000000 006014    ................
   1     004   000000 177640   000000 006014   000000 177640   000000 006014    ................
   1     010   000000 600000   000000 000000   000000 000000   000000 000000    ................
   1     014   000000 000000   000000 000000                                    ........

WRITE_PAGEC
 Sect OctLoc
   1     016   000003 777640   000026 006000   000000 177640   000000 006014    ................
   1     022   000000 177640   000000 006014   000000 177640   000000 006014    ................
   1     026   000000 400400   000000 000000   000000 000000   000000 000000    ................

MMERR
 Sect OctLoc
   1     032   151526 400000                                                    i...

VSBADAC
 Sect OctLoc
   1     033   151526 423164                                                    i..t

PGINUSE
 Sect OctLoc
   1     034   151526 411534                                                    i...

(unnamed)
 Sect OctLoc
   1     035   177777 777777   777777 777000                                    ........

(unnamed)
 Sect OctLoc
   3     000   777777 777737   000000 000064   000001 006000   000000 006003    .......4........
   3     004   000002 006000   017777 777777   000017 777700   000003 006000    ................
   3     010   000000 000060   000010 006000   000000 000040   000012 006000    ...0....... ....
   3     014   000000 000014   000014 006000   777777 777377   777777 617777    ................
   3     020   000012 006000   000000 000500   000012 006000   000021 006000    ................
   3     024   000027 006000   000005 777640   001777 600000   000011 006000    ................
   3     030   000004 006000   000000 006000   000003 400000                    ............
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:258  
     1618    10637    1   END MMV$PAGE;
     1619    10638        %EOD;

PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:259  
--  Include file information  --

   HF_LOCK_C.:E05TOU  cannot be made into a system file and is referenced.
   UE$CP6V_C.:E05TOU  is referenced.
   UD_SEV_C.:E05TOU  is referenced.
   M_ERRSET_C.:E05TOU  is referenced.
   M_ERRORS_C.:E05TOU  is referenced.
   HF_DATA_R.:E05TOU  cannot be made into a system file and is referenced.
   MM_MACRO_M.:E05TOU  is referenced.
   B_STRINGS_C.:E05TOU  is referenced.
   MM$SYSGEN.:E05TOU  is referenced.
   M_INFO_C.:E05TOU  is referenced.
   MM_DATA_R.:E05TOU  cannot be made into a system file and is referenced.
   F_ERRORS_C.:E05TOU  is referenced.
   FM$CFU.:E05TOU  is referenced.
   F$DCB.:E05TOU  cannot be made into a system file and is referenced.
   CP_6_SUBS.:E05TOU  is referenced.
   CP_6_C.:E05TOU  is referenced.
   CP_6.:E05TOU  cannot be made into a system file and is referenced.
   B_SEGIDS_C.:E05TOU  is referenced.
   B_MAGIC_C.:E05TOU  is referenced.
   B_MACROS_C.:E05TOU  is referenced.
   B$SS.:E05TOU  cannot be made into a system file and is referenced.
   B$MAP.:E05TOU  cannot be made into a system file and is referenced.
   B$JIT_C.:E05TOU  is referenced.
   B$JIT.:E05TOU  cannot be made into a system file and is referenced.
      No diagnostics issued in procedure MMV$PAGE.
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:260  

 **** Variables and constants ****

  ****  Section 001 RoData MMV$PAGE

  ****  Scalars and arrays  ****
OctLoc.c.b A Datatyp(siz) R M Lvl/name                 OctLoc.c.b A Datatyp(siz) R M Lvl/name

    32-0-0/b STRC        r     1 MMERR                     34-0-0/w STRC        r     1 PGINUSE
     0-0-0/d STRC(504)   r     1 READ_PAGEC                33-0-0/w STRC        r     1 VSBADAC
    16-0-0/d STRC(432)   r     1 WRITE_PAGEC

  ****  Auto variables  ****

  ****  Scalars and arrays  ****
OctLoc.c.b A Datatyp(siz) R M Lvl/name                 OctLoc.c.b A Datatyp(siz) R M Lvl/name

     4-0-0/w PTR         r     1 @EVPAGE                    3-0-0/w PTR         r     1 @EWSQ
     5-0-0/w PTR         r     1 @PPNO                    135-0-0/w PTR         r     1 @SUBC
   137-0-0/w PTR         r     1 @VA                      137-0-0/w PTR         r     1 @VPAGE
    25-0-0/w SBIN        r     1 ACTLPP                   100-0-0/b STRC(18)    r     1 B$FRAGHWRD
    60-0-0/w BIT         r     1 BTEMP                    102-0-0/d STRC(432)   r     1 B_MPT_SAVE
    14-0-0/w UBIN        r     1 DCB#                      16-0-0/w UBIN        r     1 ERR
     6-0-0/w UBIN        r     1 EVP                       *0-0-0/w UBIN        r     1 EVPAGE
     6-0-0/w STRC        r     1 EVPKEY                     6-0-0/w STRC        r     1 EVPSECT
     7-0-0/w UBIN        r     1 EVP_PAGE_NO_ENTRY         *0-0-0/w UBIN        r     1 EWSQ
    74-0-0/w STRC(144)   r     1 FINFO                     72-0-0/d STRC(72)    r     1 FPT$STRAP_V
    11-0-0/b BIT         r     1 FRAGMENTED                24-0-0/w SBIN        r     1 HDACC
    22-0-0/w SBIN        r     1 HDNACC                    17-0-0/w SBIN        r     1 I
    35-0-0/w UBIN        r     1 IPG                       31-0-0/w SBIN        r     1 J
    20-0-0/w SBIN        r     1 K                        144-0-0/w STRC        r     1 KEY
    61-0-0/w PTR         r     1 MAP$                      13-0-0/w UBIN        r     1 MAPVP
    64-0-0/w SBIN        r     1 MAP_INDEX                 61-0-0/w STRC        r     1 MAP_PTR
    26-0-0/w SBIN        r     1 NACTLPP                   30-0-0/w SBIN        r     1 NXTPP
    27-0-0/w SBIN        r     1 NXTVP                     27-0-0/w STRC        r     1 NXTVPSECT
    10-0-0/w SBIN        r     1 PAGE_NO_ENTRY             26-0-0/w SBIN        r     1 PP
    *0-0-0/w SBIN        r     1 PPNO                      34-0-0/w SBIN        r     1 PREDT
    32-0-0/w SBIN        r     1 PREDTA                    33-0-0/w SBIN        r     1 PREDTN
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:261  
    40-0-0/h SBIN(18)    r     1 PT(0:15)                  36-0-0/w UBIN        r     1 PTBASE
    56-0-0/b STRC        r     1 READ$PAGE$ERR            116-0-0/d STRC(504)   r     1 READ_PAGE
   140-0-0/w EPTR        r     1 RW                       141-0-0/w PTR         r     1 SAVEDCB$
   142-0-0/w UBIN        r     1 SAVEDCBNO                143-0-0/b STRC        r     1 SAVEERR
    50-0-0/w BIT         r     1 SAVE_PPUT                 51-0-0/w SBIN        r     1 SAVE_VP
    52-0-0/w SBIN        r     1 SCT#                      53-0-0/w SBIN        r     1 SCT_USED
    62-0-0/w PTR         r     1 SECT$                     12-0-0/b BIT         r     1 SECTION
    57-0-0/b BIT (12)    r     1 SEGID                     54-0-0/w SBIN        r     1 SKIP_COUNT
    66-0-0/w PTR         r     1 STATS$                    *0-0-0/w UBIN        r     1 SUBC
    60-0-0/w SBIN        r     1 TEMP                      23-0-0/w SBIN        r     1 TLACC
    21-0-0/w SBIN        r     1 TLNACC                    63-0-0/w PTR         r     1 UNMAP$
    63-0-0/w STRC        r     1 UNMAP_PTR                 55-0-0/b BIT         r     1 UPD_CHAIN_FLG
    *0-0-0/w STRC        r     1 VA                        65-0-0/w PTR         r     1 VCB$
    25-0-0/w SBIN        r     1 VP                        *0-0-0/w UBIN        r     1 VPAGE
    25-0-0/w STRC        r     1 VPSECT                    15-0-0/b BIT         r     1 WRITE_FLAG
    67-0-0/w SBIN        r     1 WSQ                       70-0-0/b BIT         r     1 WS_FLT

  ****  SYMREF variables  ****

  ****  Scalars and arrays  ****
OctLoc.c.b A Datatyp(siz) R M Lvl/name                 OctLoc.c.b A Datatyp(siz) R M Lvl/name

     0-0-0/w PTR         r     1 B$IPHYMAP$                 0-0-0/w PTR         r     1 B$JIT$
     0-0-0/w PTR         r     1 B$PPUT$                    0-0-0/w PTR         r     1 B$SBUF2$
     0-0-0/w PTR         r     1 B$UPT$                     0-0-0/w PTR         r     1 B$USERHJIT$
     0-0-0/w PTR         r     1 B$USERLS$                  0-0-0/d STRC(432)   r     1 B_MPT
     0-0-0/w BIT         r     1 HW_IMX                     0-0-0/w BIT         r     1 HW_WSQ0PT
     0-0-0/w BIT         r     1 H_S1000_FLG                0-0-0/w PTR         r     1 MM_BYP$
     0-0-0/b STRC        r     1 MM_FPMC
     0-0-0/w PTR         r     1 MM_PTPTRS$(0:16)
     0-0-0/w UBIN        r     1 MM_SCTDFT                  0-0-0/w UBIN        r     1 S_RVA

  ****  BASED and DCB variables  ****

  ****  Scalars and arrays  ****
OctLoc.c.b A Datatyp(siz) R M Lvl/name                 OctLoc.c.b A Datatyp(siz) R M Lvl/name

PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:262  
     0-0-0/w STRC(72)    r     1 B$$DESCR                   0-0-0/w STRC(180)   r     1 B$ECCB
     0-0-0/w STRC(4608)  r     1 B$FRAGMAP                  0-0-0/d STRC(8856)  r     1 B$JIT
     0-0-0/w STRC        r     1 B$MAP(0:1023)              0-0-0/w STRC        r     1 B$NMAP(0:1023)
     0-0-0/w STRC(36864) r     1 B$PAGE                     0-0-0/w STRC        r     1 B$SECT(0:1023)
     0-0-0/d STRC(36576) r     1 B$SHORT_PAGE               0-0-0/d STRC(2304)  r     1 B$SS
     0-0-0/d ASTR(3528)  r     1 F$DCB                      0-0-0/w STRC(288)   r     1 FM$CFU
     0-0-0/d STRC(72)    r     1 MM$DESC(0:0)
     0-0-0/h UBIN(18)    r     1 MM$IPHY_MAP(0:0)
     0-0-0/d STRC(72)    r     1 MM$SDESC(0:0)
     0-0-0/w STRC(432)   r     1 MM$VCB                     0-0-0/w STRC(288)   r     1 MM$VIRTUAL_STATS
     0-0-0/w STRC        r     1 MM$VPPUT(0:0)


   Procedure MMV$PAGE requires 2433 words for executable code.
   Procedure MMV$PAGE requires 108 words of local(AUTO) storage.
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:263  
          *** CROSS REFERENCE LISTING ***
**     DENOTES     IDENTIFIER DEFINITION
<<                 IDENTIFIER'S VALUE SET
>>                 IDENTIFIER'S VALUE USED
<>                 IDENTIFIER SET AND/OR USED
--                 IDENTIFIER REFERENCED
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:264  
          MINI XREF LISTING

ABORTM
     10321**PROC     9652--CALL     9912--CALL     9922--CALL
ACCESSED IN PROCEDURE UPD_FRAG_DENSE_CHAIN
     10499**LABEL   10494--GOTO
ACTLPP
      8937**DCL     10427>>ASSIGN  10431<<ASSIGN  10452>>ASSIGN  10456>>ASSIGN  10503>>ASSIGN  10505<<ASSIGN
     10520>>ASSIGN
B$$DESCR.FLGS
      8992**DCL     10330>>IF
B$ECCB.ERR
      9051**DCL     10342<>CALL
B$ECCB.FLAGS.ERRSET
      9052**DCL     10338>>IF
B$ECCB.FLTFLG.HDWR
      9055**DCL     10338>>IF
B$ECCB.FLTFLG.MEM
      9054**DCL     10338>>IF
B$FRAGHWRD
      9058**DCL      9677<<ASSIGN   9715<<ASSIGN   9852<<ASSIGN   9986<<ASSIGN  10108<<ASSIGN
B$FRAGHWRD.KEY_VALID
      9060**DCL      9678>>IF       9716>>IF
B$FRAGHWRD.PAGE_KEY
      9061**DCL      9680>>IF       9718>>ASSIGN   9853>>ASSIGN   9987>>ASSIGN  10109>>ASSIGN
B$FRAGMAP.HWRD
      9063**DCL      9677>>ASSIGN   9715>>ASSIGN   9852>>ASSIGN   9986>>ASSIGN  10108>>ASSIGN
B$FRAGMAP.HWRD.KEY_VALID
      9065**DCL      9763<<ASSIGN   9861<<ASSIGN   9862<<ASSIGN  10118<<ASSIGN  10183>>IF      10205<<ASSIGN
B$FRAGMAP.HWRD.PAGE_KEY
      9066**DCL      9728<<ASSIGN   9764<<ASSIGN   9863<<ASSIGN  10206<<ASSIGN
B$IPHYMAP$
      8904**DCL      9612>>ASSIGN   9721>>ASSIGN   9773>>ASSIGN   9798>>ASSIGN   9842>>ASSIGN   9883>>ASSIGN
      9890>>ASSIGN   9976>>ASSIGN  10093>>ASSIGN  10127>>ASSIGN  10418>>ASSIGN  10489>>ASSIGN  10569>>ASSIGN
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:265  
     10596>>ASSIGN  10616>>ASSIGN  10631>>ASSIGN
B$JIT.CPFLAGS1.SLEAZE
       465**DCL       465--REDEF
B$JIT.DCB$
       539**DCL      9931>>ASSIGN   9932>>ASSIGN   9961>>IF      10245>>ASSIGN  10263<<ASSIGN  10264>>IF
     10264>>IF      10267>>ASSIGN  10268>>ASSIGN  10268>>ASSIGN  10271<<ASSIGN  10278<<ASSIGN
B$JIT.DCBNO
       452**DCL     10246>>ASSIGN  10272<<ASSIGN  10279<<ASSIGN
B$JIT.ERR
       371**DCL      9646<<ASSIGN   9910<<ASSIGN   9920<<ASSIGN  10188<<ASSIGN  10247>>ASSIGN  10273>>ASSIGN
     10274<<ASSIGN  10280>>ASSIGN  10281<<ASSIGN  10326>>ASSIGN
B$JIT.ERR.CODE
       372**DCL     10051>>IF
B$JIT.ERR.MID
       372**DCL       372--REDEF
B$JIT.JRESPEAK
       533**DCL       534--REDEF
B$JIT.JUNK
       571**DCL      9961>>IF
B$JIT.JUNK2
       625**DCL     10330>>IF
B$JIT.ORIGINATOR_PORT.FROM_CR
       642**DCL       642--REDEF     643--REDEF
B$JIT.PNR
       546**DCL       546--REDEF
B$JIT.TSLINE
       640**DCL       641--REDEF
B$JIT.VIRTUAL.DCB#
       536**DCL      9627>>ASSIGN   9937>>ASSIGN   9941>>ASSIGN   9945>>ASSIGN  10030<<ASSIGN  10064>>ASSIGN
     10175>>ASSIGN
B$JIT$
      8898**DCL       366--IMP-PTR  9627>>ASSIGN   9646>>ASSIGN   9910>>ASSIGN   9920>>ASSIGN   9931>>ASSIGN
      9932>>ASSIGN   9937>>ASSIGN   9941>>ASSIGN   9945>>ASSIGN   9961>>IF       9961>>IF      10030>>ASSIGN
     10051>>IF      10064>>ASSIGN  10175>>ASSIGN  10188>>ASSIGN  10245>>ASSIGN  10246>>ASSIGN  10247>>ASSIGN
     10263>>ASSIGN  10264>>IF      10264>>IF      10267>>ASSIGN  10268>>ASSIGN  10268>>ASSIGN  10271>>ASSIGN
     10272>>ASSIGN  10273>>ASSIGN  10274>>ASSIGN  10278>>ASSIGN  10279>>ASSIGN  10280>>ASSIGN  10281>>ASSIGN
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:266  
     10326>>ASSIGN  10330>>IF
B$MAP
       688**DCL      9866>>ASSIGN   9867<<ASSIGN   9869<<ASSIGN
B$MAP.CTRL
       693**DCL      9723>>IF       9725<<ASSIGN   9725>>ASSIGN   9847>>IF       9870<<ASSIGN   9870>>ASSIGN
      9980>>IF      10103>>IF      10420>>IF      10423<<ASSIGN  10423>>ASSIGN  10497>>IF      10499<<ASSIGN
     10499>>ASSIGN
B$MAP.RPN
       689**DCL      9610>>ASSIGN   9690>>IF       9719>>ASSIGN   9771>>ASSIGN   9798>>ASSIGN   9800>>ASSIGN
      9840>>ASSIGN   9883>>ASSIGN   9885>>ASSIGN   9890>>ASSIGN   9892>>ASSIGN   9974>>ASSIGN  10091>>ASSIGN
     10125>>ASSIGN  10408>>ASSIGN  10487>>ASSIGN  10569>>ASSIGN  10571>>ASSIGN  10594>>ASSIGN  10615>>ASSIGN
     10631>>ASSIGN  10633>>ASSIGN
B$MAP.SCTRL
       690**DCL       691--REDEF
B$NMAP.CTRL
      9213**DCL     10599>>IF      10601>>IF
B$NMAP.RPN
      9209**DCL     10140>>ASSIGN  10369>>IF      10584>>IF
B$NMAP.SCTRL
      9210**DCL      9211--REDEF
B$PAGE.WRD
       740**DCL     10306<<ASSIGN  10307<<ASSIGN  10308<<ASSIGN  10309<<ASSIGN  10310<<ASSIGN  10311<<ASSIGN
     10312<<ASSIGN  10313<<ASSIGN
B$PPUT$
      8896**DCL      9785>>ASSIGN   9793>>ASSIGN   9798>>ASSIGN   9800>>ASSIGN   9802>>ASSIGN   9879>>ASSIGN
      9883>>ASSIGN   9885>>ASSIGN   9888>>ASSIGN   9890>>ASSIGN   9892>>ASSIGN   9894>>ASSIGN   9977>>ASSIGN
     10094>>ASSIGN  10128>>ASSIGN  10427>>ASSIGN  10438>>ASSIGN  10444>>ASSIGN  10452>>ASSIGN  10456>>ASSIGN
     10458>>ASSIGN  10466>>ASSIGN  10503>>ASSIGN  10511>>ASSIGN  10515>>ASSIGN  10520>>ASSIGN  10524>>ASSIGN
     10569>>ASSIGN  10571>>ASSIGN  10608>>ASSIGN  10617>>ASSIGN  10624>>ASSIGN  10631>>ASSIGN  10633>>ASSIGN
B$SBUF2$
      8899**DCL     10255>>ASSIGN  10306>>ASSIGN  10307>>ASSIGN  10308>>ASSIGN  10309>>ASSIGN  10310>>ASSIGN
     10311>>ASSIGN  10312>>ASSIGN  10313>>ASSIGN  10316>>ASSIGN  10316>>ASSIGN
B$SECT
       729**DCL     10540<<ASSIGN  10540>>ASSIGN  10634<<ASSIGN  10634>>ASSIGN
B$SECT.PTBASE
       730**DCL     10140<<ASSIGN  10366>>IF      10367>>ASSIGN  10534>>IF      10539>>ASSIGN  10541<<ASSIGN
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:267  
     10582>>ASSIGN  10635<<ASSIGN
B$SHORT_PAGE IN PROCEDURE INIT$PAGE
     10298**DCL     10316<<ASSIGN  10316>>ASSIGN
B$SS.EWSQ#
       797**DCL      9597>>ASSIGN
B$SS.IR.MIR
       779**DCL      9601<<ASSIGN
B$SS.ISR.WSR
       803**DCL     10328>>IF      10330>>IF
B$SS.RVA
       798**DCL       799--REDEF
B$UPT$
      8900**DCL     10140>>ASSIGN  10369>>IF      10584>>IF
B$USERHJIT$
      8902**DCL     10032>>ASSIGN
B$USERLS$
      8901**DCL     10001>>ASSIGN  10003>>ASSIGN
BTEMP
      8969**DCL      9866<<ASSIGN   9869>>ASSIGN
B_MPT.AS
      9140**DCL      9143--REDEF
B_MPT.ASDESC
      9172**DCL      9176--REDEF
B_MPT.ECCB
      9155**DCL      9158--REDEF
B_MPT.ECCB$
      9158**DCL     10338>>IF      10338>>IF      10338>>IF      10342>>CALL
B_MPT.ECCBDESC
      9190**DCL      9194--REDEF
B_MPT.ECCBDESC$
      9194**DCL     10330>>IF
B_MPT.LS
      9135**DCL      9138--REDEF
B_MPT.LSDESC
      9166**DCL      9170--REDEF
B_MPT.PS
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:268  
      9145**DCL      9148--REDEF
B_MPT.PSDESC
      9178**DCL      9182--REDEF
B_MPT.SS
      9130**DCL      9133--REDEF
B_MPT.SS$
      9133**DCL      9597>>ASSIGN   9601>>ASSIGN  10328>>IF      10330>>IF      10342<>CALL
B_MPT.SSDESC
      9160**DCL      9164--REDEF
B_MPT.TCB
      9150**DCL      9153--REDEF
B_MPT.TCB$
      9153**DCL     10342<>CALL
B_MPT.TCBDESC
      9184**DCL      9188--REDEF
B_MPT_SAVE
      9237**DCL      9594<>CALL     9742<>CALL
B_MPT_SAVE.AS
      9251**DCL      9254--REDEF
B_MPT_SAVE.ASDESC
      9283**DCL      9287--REDEF
B_MPT_SAVE.ECCB
      9266**DCL      9269--REDEF
B_MPT_SAVE.ECCBDESC
      9301**DCL      9305--REDEF
B_MPT_SAVE.LS
      9246**DCL      9249--REDEF
B_MPT_SAVE.LSDESC
      9277**DCL      9281--REDEF
B_MPT_SAVE.PS
      9256**DCL      9259--REDEF
B_MPT_SAVE.PSDESC
      9289**DCL      9293--REDEF
B_MPT_SAVE.SS
      9241**DCL      9244--REDEF
B_MPT_SAVE.SSDESC
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:269  
      9271**DCL      9275--REDEF
B_MPT_SAVE.TCB
      9261**DCL      9264--REDEF
B_MPT_SAVE.TCBDESC
      9295**DCL      9299--REDEF
CANT_GET
      9915**LABEL    9609--CALLALT
CANT_GET1
      9910**LABEL    9756--CALLALT  9758--CALLALT
CANT_READ
      9802**LABEL    9736--CALLALT
COMMON
      9622**LABEL    9605--GOTO
CVM
     10155**PROC     9613--CALL     9722--CALL     9805--CALL     9844--CALL     9982--CALL    10105--CALL
     10604--CALL
DCB#
      8923**DCL      9627<<ASSIGN   9628>>IF       9635--ASSIGN   9636--ASSIGN   9937<<ASSIGN   9941<<ASSIGN
      9945<<ASSIGN   9956>>IF      10064<<ASSIGN  10065>>IF      10069--ASSIGN  10070--ASSIGN  10175<<ASSIGN
     10176--ASSIGN  10177--ASSIGN  10252>>ASSIGN  10263--ASSIGN
END_SCT_LOOP IN PROCEDURE UPD_SECT_CHAIN
     10417**LABEL   10410--GOTO
ERR
      8925**DCL      9609<>CALL     9756<>CALL     9758<>CALL     9920>>ASSIGN   9994<>CALL    10011<>CALL
     10021<>CALL    10119<>CALL    10156<>CALL    10159<>CALL    10199<>CALL    10609<>CALL
EVP
      8909**DCL      8910--REDEF    8914--REDEF    9588<<ASSIGN   9598<<ASSIGN   9598>>ASSIGN   9609<>CALL
      9610>>ASSIGN   9622<<ASSIGN   9644>>IF       9665<>CALL     9690>>IF       9733>>IF       9736<>CALL
      9747>>ASSIGN   9808>>IF       9898>>IF       9985<<ASSIGN   9986>>ASSIGN   9987<<ASSIGN   9987>>ASSIGN
      9988<>CALL    10109<<ASSIGN  10110<>CALL    10197>>ASSIGN  10199<>CALL
EVPAGE
      8892**DCL        41--PROC     9619--ENTRY    9622>>ASSIGN  10168--ENTRY   10212--ENTRY
EVPKEY.PAGE_KEY
      8912**DCL      9680>>IF       9728>>ASSIGN   9764>>ASSIGN   9863>>ASSIGN  10206>>ASSIGN
EVPKEY.PAGE_NO_ENTRY
      8913**DCL      9599>>ASSIGN  10171>>ASSIGN
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:270  
EVPSECT.SECT#
      8916**DCL     10140>>ASSIGN  10540>>ASSIGN  10634>>ASSIGN
EVP_PAGE_NO_ENTRY
      8918**DCL      9599<<ASSIGN   9674>>ASSIGN  10171<<ASSIGN  10181>>ASSIGN  10491>>IF
EWSQ
      8891**DCL        41--PROC     9619--ENTRY    9621>>ASSIGN  10060--ENTRY   10062>>ASSIGN  10168--ENTRY
     10170>>ASSIGN  10212--ENTRY
F$DCB.ACTPOS
      7818**DCL      7818--REDEF
F$DCB.ARS
      7793**DCL      7793--REDEF
F$DCB.ATTR
      7811**DCL      7812--REDEF
F$DCB.BORROW
      7826**DCL      7826--REDEF    7826--REDEF    7826--REDEF
F$DCB.CFU$
      7827**DCL      9961>>IF      10268>>ASSIGN  10268>>ASSIGN
F$DCB.DCBNAME.L
      7840**DCL      7840--IMP-SIZ
F$DCB.EOMCHAR
      7797**DCL      7797--REDEF
F$DCB.FLDID
      7821**DCL      7821--REDEF
F$DCB.FORM$
      7815**DCL      7815--REDEF
F$DCB.FSECT
      7831**DCL      7831--REDEF
F$DCB.FSN
      7808**DCL      7808--REDEF    7808--REDEF    7809--REDEF
F$DCB.HEADER$
      7814**DCL      7814--REDEF
F$DCB.IXTNSIZE
      7812**DCL      7812--REDEF
F$DCB.LASTSTA$
      7802**DCL      7802--REDEF    9636>>ASSIGN   9932>>ASSIGN  10070>>ASSIGN  10177>>ASSIGN
F$DCB.LRDL0
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:271  
      7810**DCL     10264>>IF
F$DCB.LVL
      7827**DCL      7827--REDEF
F$DCB.NAME.C
      7802**DCL      7802--REDEF
F$DCB.NOEOF
      7823**DCL      7823--REDEF
F$DCB.NRECS
      7813**DCL      7813--REDEF
F$DCB.NRECX
      7832**DCL      7832--REDEF
F$DCB.OHDR
      7824**DCL      7824--REDEF
F$DCB.ORG
      7807**DCL      7807--REDEF
F$DCB.PRECNO
      7830**DCL      7830--REDEF
F$DCB.RCSZ
      7835**DCL      7835--REDEF
F$DCB.RDL0
      7797**DCL     10264>>IF      10267<<ASSIGN
F$DCB.RES
      7803**DCL      7803--REDEF
F$DCB.SETSTA$
      7802**DCL      9635>>ASSIGN   9931>>ASSIGN  10069>>ASSIGN  10176>>ASSIGN
F$DCB.SETX
      7815**DCL      7815--REDEF
F$DCB.TAB$
      7814**DCL      7815--REDEF
F$DCB.TDA
      7829**DCL      7829--REDEF
F$DCB.WSN
      7804**DCL      7804--REDEF
FINDMAP
     10351**PROC     9665--CALL     9770--CALL     9839--CALL     9868--CALL     9881--CALL     9973--CALL
     10090--CALL    10124--CALL    10407--CALL    10567--CALL    10593--CALL    10614--CALL    10628--CALL
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:272  
FINFO
      8998**DCL     10324<<ASSIGN  10335<>CALL    10342<>CALL
FINFO.ERR
      9007**DCL     10326<<ASSIGN
FINFO.ERR.ERR#
      9007**DCL      9008--REDEF
FINFO.P#
      9010**DCL     10327<<ASSIGN
FINFO.SUBC
      9003**DCL     10325<<ASSIGN
FM$CFU.ACCTX
      9310**DCL      9310--REDEF
FM$CFU.FUN
      9309**DCL     10268<<ASSIGN  10268>>ASSIGN
FM$CFU.NAMEX
      9310**DCL      9961>>IF
FMU$BLD
      9082**DCL-ENT 10266--CALL
FM_ERROR
      9894**LABEL    9726--CALLALT  9814--GOTO     9854--CALLALT  9857--CALLALT
FOUND_PTBASE IN PROCEDURE FINDMAP
     10374**LABEL   10370--GOTO
FOUND_PTBASE IN PROCEDURE REUSE_ACTIVE_PT
     10589**LABEL   10585--GOTO
FPT$STRAP_V
      8985**DCL      9659--CALL
FPT$STRAP_V.STRAP
      8985**DCL      9657<<ASSIGN   9658<<ASSIGN
FRAGMENTED
      8920**DCL      9663<<ASSIGN   9670>>IF       9705>>IF       9709>>IF       9761>>IF       9849>>IF
      9859>>IF      10490>>IF
GOTSLOT
     10194**LABEL   10185--GOTO
GT_DATAPAG
      9698**LABEL   10153--GOTO
HDACC
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:273  
      8931**DCL      9936<<ASSIGN   9940<<ASSIGN   9944<<ASSIGN  10011>>CALL    10021>>CALL    10400<<ASSIGN
     10424>>IF      10425<<ASSIGN  10448>>IF      10449>>ASSIGN  10483<<ASSIGN  10500>>IF      10501<<ASSIGN
     10519>>IF      10522>>ASSIGN  10524>>ASSIGN
HDNACC
      8929**DCL     10402<<ASSIGN  10435>>IF      10436<<ASSIGN  10450>>IF      10456>>ASSIGN  10464>>ASSIGN
HFC$ASSOCCLR
      9098**DCL-ENT  9730--CALL     9732--CALL     9872--CALL     9874--CALL
HFE$M$STRAP
      9083**DCL-ENT  9659--CALL
HW_IMX
      8688**DCL     10000>>IF      10036>>IF
HW_WSQ0PT
      8684**DCL      9611>>IF       9720>>IF       9772>>IF       9797>>IF       9841>>IF       9882>>IF
      9889>>IF       9975>>IF      10092>>IF      10126>>IF      10417>>IF      10488>>IF      10568>>IF
     10595>>IF      10616>>IF      10630>>IF
H_S1000_FLG
      8658**DCL      9729>>IF       9871>>IF
I
      8926**DCL      9674<<ASSIGN   9677>>ASSIGN   9685>>ASSIGN   9686<<ASSIGN   9686>>ASSIGN   9851<<ASSIGN
      9852>>ASSIGN   9853>>ASSIGN   9972<<DOINDEX 10010<<DOINDEX 10011>>CALL    10020<<DOINDEX 10021>>CALL
     10033<<DOINDEX 10182<<DOINDEX 10406<<DOINDEX 10486<<DOINDEX 10532<<DOINDEX 10534>>IF      10537>>IF
     10539>>ASSIGN  10540>>ASSIGN  10541>>ASSIGN  10557<<ASSIGN  10558>>DOUNTIL 10564<<ASSIGN  10564>>ASSIGN
     10578<<DOINDEX 10579>>IF      10582>>ASSIGN  10597>>IF      10634>>ASSIGN  10635>>ASSIGN
INIT$PAGE
     10296**PROC     9739--CALL
INITPAGE1 IN PROCEDURE INIT$PAGE
     10305**ENTRY    9615--CALL
INIT_PAGE
      9739**LABEL    9818--GOTO     9903--GOTO
IPG
      8951**DCL      9771>>ASSIGN   9840>>ASSIGN   9847>>IF       9866>>ASSIGN   9867>>ASSIGN   9869>>ASSIGN
      9870>>ASSIGN   9870>>ASSIGN   9872<>CALL     9883>>ASSIGN   9885>>ASSIGN   9974>>ASSIGN   9980>>IF
     10091>>ASSIGN  10103>>IF      10125>>ASSIGN  10378<<ASSIGN  10381<<ASSIGN  10408>>ASSIGN  10420>>IF
     10423>>ASSIGN  10423>>ASSIGN  10569>>ASSIGN  10571>>ASSIGN  10594>>ASSIGN  10615>>ASSIGN  10631>>ASSIGN
     10633>>ASSIGN
J
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:274  
      8947**DCL     10409<<DOINDEX 10410>>IF      10536<<DOINDEX 10537>>IF      10554<<ASSIGN  10574<<ASSIGN
     10574>>ASSIGN  10592<<DOINDEX 10592>>DOINDEX
JSE$ABORTM
      9084**DCL-ENT 10348--CALL
K
      8927**DCL     10583<<DOINDEX 10584>>IF      10590>>ASSIGN
KEY IN PROCEDURE READ$PAGE
     10234**DCL     10254--ASSIGN
KEY.SIZE IN PROCEDURE READ$PAGE
     10235**DCL     10248<<ASSIGN
KEY.VP# IN PROCEDURE READ$PAGE
     10236**DCL     10248--ASSIGN  10249<<ASSIGN
M$MREAD
      9091**DCL-ENT 10241--ASSIGN
M$MWRITE
      9092**DCL-ENT 10292--ASSIGN
MAP$
      8970**DCL      8971--REDEF    9607<<ASSIGN   9610>>ASSIGN   9677>>ASSIGN   9690>>IF       9715>>ASSIGN
      9719>>ASSIGN   9723>>IF       9725>>ASSIGN   9725>>ASSIGN   9728>>ASSIGN   9763>>ASSIGN   9764>>ASSIGN
      9771>>ASSIGN   9798>>ASSIGN   9800>>ASSIGN   9840>>ASSIGN   9847>>IF       9852>>ASSIGN   9861>>ASSIGN
      9862>>ASSIGN   9863>>ASSIGN   9866>>ASSIGN   9867>>ASSIGN   9869>>ASSIGN   9870>>ASSIGN   9870>>ASSIGN
      9883>>ASSIGN   9885>>ASSIGN   9890>>ASSIGN   9892>>ASSIGN   9954<<ASSIGN   9974>>ASSIGN   9980>>IF
      9986>>ASSIGN  10032<<ASSIGN  10034>>IF      10037>>IF      10039>>ASSIGN  10042>>IF      10044>>ASSIGN
     10047<<ASSIGN  10047>>ASSIGN  10091>>ASSIGN  10103>>IF      10108>>ASSIGN  10118>>ASSIGN  10125>>ASSIGN
     10173<<ASSIGN  10183>>IF      10205>>ASSIGN  10206>>ASSIGN  10362<<ASSIGN  10365>>ASSIGN  10408>>ASSIGN
     10420>>IF      10423>>ASSIGN  10423>>ASSIGN  10487>>ASSIGN  10497>>IF      10499>>ASSIGN  10499>>ASSIGN
     10569>>ASSIGN  10571>>ASSIGN  10594>>ASSIGN  10615>>ASSIGN  10631>>ASSIGN  10633>>ASSIGN
MAPVP
      8922**DCL      9711<<ASSIGN   9719>>ASSIGN   9723>>IF       9725>>ASSIGN   9725>>ASSIGN   9730<>CALL
      9747<<ASSIGN   9756<>CALL     9758<>CALL     9770<>CALL     9783>>ASSIGN   9784>>ASSIGN   9794>>ASSIGN
      9798>>ASSIGN   9800>>ASSIGN   9801>>ASSIGN   9868<>CALL     9880>>ASSIGN   9890>>ASSIGN   9892>>ASSIGN
      9893>>ASSIGN  10194<<ASSIGN  10197<<ASSIGN
MAP_INDEX
      8979**DCL     10368<<DOINDEX 10369>>IF      10374>>ASSIGN
MAP_PTR.WOFFS
      8972**DCL     10374<<ASSIGN  10374>>ASSIGN
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:275  
MM$DESC
      8597**DCL     10032--ASSIGN  10039<<ASSIGN  10044<<ASSIGN
MM$DESC.BOUND
      8597**DCL      8598--REDEF
MM$DESC.FLGS
      8598**DCL      8598--REDEF
MM$DESC.FLGS1.NOTEMPTY
      8598**DCL     10001<<ASSIGN
MM$DESC.SUPER.BASE
      8598**DCL     10037>>IF
MM$DESC.TYP
      8599**DCL     10034>>IF
MM$IPHY_MAP
       744**DCL      9612>>ASSIGN   9721>>ASSIGN   9773>>ASSIGN   9798>>ASSIGN   9842>>ASSIGN   9883>>ASSIGN
      9890>>ASSIGN   9976>>ASSIGN  10093>>ASSIGN  10127>>ASSIGN  10418>>ASSIGN  10489>>ASSIGN  10569>>ASSIGN
     10596>>ASSIGN  10616>>ASSIGN  10631>>ASSIGN
MM$PPUT.USER#
      8586**DCL      8586--REDEF
MM$SDESC.FLGS
      8600**DCL     10003<<ASSIGN
MM$SDESC.WSN
      8600**DCL     10042>>IF
MM$VCB.CREATE
      8588**DCL      9733>>IF       9808>>IF       9898>>IF
MM$VCB.HEAD
      8591**DCL      9781>>IF       9783<<ASSIGN   9793>>ASSIGN   9794<<ASSIGN   9838>>ASSIGN   9879>>ASSIGN
      9880<<ASSIGN   9888<<ASSIGN   9970>>ASSIGN   9978<<ASSIGN  10086>>ASSIGN  10101<<ASSIGN  10405>>ASSIGN
     10449<<ASSIGN  10464<<ASSIGN  10484>>ASSIGN  10485<<ASSIGN  10508>>IF      10509<<ASSIGN  10521>>IF
     10522<<ASSIGN  10555>>ASSIGN
MM$VCB.INITIALIZE
      8588**DCL     10302>>IF
MM$VCB.INITVALUE
      8589**DCL     10304>>ASSIGN
MM$VCB.MAXVP#
      8590**DCL      9644>>IF
MM$VCB.MAXVP_WRITTEN
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:276  
      8591**DCL      9733>>IF       9808>>IF       9898>>IF      10258>>IF      10260<<ASSIGN
MM$VCB.NOFILE
      8588**DCL      9655>>IF      10242>>IF
MM$VCB.NPGTPGS
      8592**DCL     10009>>ASSIGN  10019>>ASSIGN  10139>>IF      10148>>IF      10368>>DOINDEX 10413>>IF
     10583>>DOINDEX
MM$VCB.NPGTSECT
      8592**DCL     10007>>ASSIGN  10021>>CALL    10140>>ASSIGN  10368>>DOINDEX 10368>>DOINDEX 10558>>DOUNTIL
     10561>>DOINDEX 10578>>DOINDEX 10583>>DOINDEX 10583>>DOINDEX
MM$VCB.PPC
      8592**DCL      9698>>ASSIGN   9752>>IF       9774<<ASSIGN   9774>>ASSIGN   9777>>IF       9779>>ASSIGN
      9915>>IF       9969>>ASSIGN   9979<<ASSIGN   9979>>ASSIGN  10078>>IF      10085>>ASSIGN  10089>>DOWHILE
     10102<<ASSIGN  10102>>ASSIGN  10399>>ASSIGN  10482>>ASSIGN  10591>>ASSIGN  10612<<ASSIGN  10612>>ASSIGN
MM$VCB.PPMAX
      8590**DCL      9701>>IF       9705>>IF       9752>>IF
MM$VCB.PPMIN
      8590**DCL      9915>>IF      10078>>IF      10087>>ASSIGN  10089>>DOWHILE
MM$VCB.SEGNUM
      8589**DCL      9933>>ASSIGN
MM$VCB.T.FRAGMENTED
      8588**DCL      9663>>ASSIGN   9983>>IF      10106>>IF      10116>>IF      10179>>IF      10203>>IF
MM$VCB.T.SECTION
      8589**DCL      9664>>ASSIGN  10006>>IF      10018>>IF      10088>>ASSIGN  10364>>IF
MM$VCB.TAIL
      8591**DCL      9784<<ASSIGN   9798>>ASSIGN   9800>>ASSIGN   9801<<ASSIGN   9834>>ASSIGN   9835<<ASSIGN
      9881<>CALL     9890>>ASSIGN   9892>>ASSIGN   9893<<ASSIGN  10129<<ASSIGN  10451<<ASSIGN  10457<<ASSIGN
     10465<<ASSIGN  10504<<ASSIGN  10572>>IF      10627<<ASSIGN
MM$VCB.UPGT#
      8592**DCL     10139>>IF      10140>>ASSIGN  10142<<ASSIGN  10142>>ASSIGN
MM$VCB.WRITE
      8588**DCL      9754>>IF
MM$VCB.WSPTD.NBLKS
      8591**DCL     10532>>DOINDEX
MM$VCB.WSQ
      8589**DCL      9637>>IF       9952>>ASSIGN  10072>>IF
MM$VIRTUAL_STATS.FAULTS#
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:277  
      9424**DCL      9641<<ASSIGN   9641>>ASSIGN
MM$VIRTUAL_STATS.MAXPGS#
      9424**DCL      9777>>IF       9779<<ASSIGN
MM$VIRTUAL_STATS.READS#
      9424**DCL     10239<<ASSIGN  10239>>ASSIGN
MM$VIRTUAL_STATS.TRUNCS#
      9424**DCL     10134<<ASSIGN  10134>>ASSIGN
MM$VIRTUAL_STATS.WRITES#
      9424**DCL     10288<<ASSIGN  10288>>ASSIGN
MM$VPPUT
      8586**DCL     10608>>ASSIGN  10617<<ASSIGN
MM$VPPUT.PPNO
      8588**DCL      9785<<ASSIGN   9793<<ASSIGN   9798<<ASSIGN   9800<<ASSIGN   9802<<ASSIGN   9879<<ASSIGN
      9883<<ASSIGN   9885<<ASSIGN   9888>>ASSIGN   9890<<ASSIGN   9892<<ASSIGN   9894<<ASSIGN   9977>>ASSIGN
     10094>>ASSIGN  10128<<ASSIGN  10427<<ASSIGN  10438<<ASSIGN  10444>>ASSIGN  10452<<ASSIGN  10456<<ASSIGN
     10458<<ASSIGN  10466<<ASSIGN  10503<<ASSIGN  10511<<ASSIGN  10515>>ASSIGN  10520<<ASSIGN  10524<<ASSIGN
     10569>>ASSIGN  10571>>ASSIGN  10624>>ASSIGN  10631<<ASSIGN  10633<<ASSIGN
MMA$POPSSF
      9101**DCL-ENT 10329--CALL
MMB$FPP
      9086**DCL-ENT 10014--CALL    10023--CALL
MMB$FPPONTAIL
      9085**DCL-ENT 10016--CALL    10025--CALL
MME$CVM
      9090**DCL-ENT 10156--CALL    10159--CALL    10199--CALL
MME$RVNP
      9087**DCL-ENT 10011--CALL    10021--CALL
MME$WFVP
      9089**DCL-ENT  9994--CALL    10119--CALL    10609--CALL
MME$WGVP
      9088**DCL-ENT  9609--CALL     9756--CALL     9758--CALL
MMERR
      9428**DCL      9910>>ASSIGN   9920>>ASSIGN
MMV_EXIT
      9741**LABEL    9616--GOTO
MM_BYP$
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:278  
      8517**DCL      8517--IMP-PTR
MM_ERROR
     10051**LABEL    9994--CALLALT 10011--CALLALT 10021--CALLALT 10119--CALLALT
MM_FPMC
      8523**DCL      9867>>ASSIGN
MM_FPMC.RPN
      8523**DCL      9690>>IF
MM_PTPTRS$
      8597**DCL      9607>>ASSIGN   9954>>ASSIGN  10173>>ASSIGN  10362>>ASSIGN
MM_SCR IN PROCEDURE CVM
     10161**LABEL   10156--CALLALT 10159--CALLALT
MM_SCTDFT
      8523**DCL     10366>>IF      10534>>IF      10541>>ASSIGN  10635>>ASSIGN
NACTLPP
      8939**DCL     10438>>ASSIGN  10442<<ASSIGN  10458>>ASSIGN  10466>>ASSIGN  10511>>ASSIGN  10513<<ASSIGN
     10524>>ASSIGN
NXTPP
      8945**DCL     10408<<ASSIGN  10418<<ASSIGN  10418>>ASSIGN  10431>>ASSIGN  10442>>ASSIGN  10444>>ASSIGN
     10487<<ASSIGN  10489<<ASSIGN  10489>>ASSIGN  10505>>ASSIGN  10513>>ASSIGN  10515>>ASSIGN  10594<<ASSIGN
     10596<<ASSIGN  10596>>ASSIGN  10603>>ASSIGN  10608>>ASSIGN  10618<<ASSIGN  10624>>ASSIGN
NXTVP
      8940**DCL      8941--REDEF    9853<<ASSIGN   9854<>CALL     9977<<ASSIGN   9978>>ASSIGN   9995>>ASSIGN
     10094<<ASSIGN  10101>>ASSIGN  10121>>ASSIGN  10405<<ASSIGN  10407<>CALL    10425>>ASSIGN  10427>>ASSIGN
     10430>>ASSIGN  10436>>ASSIGN  10438>>ASSIGN  10441>>ASSIGN  10444<<ASSIGN  10446>>IF      10484<<ASSIGN
     10487>>ASSIGN  10491>>IF      10493>>ASSIGN  10497>>IF      10499>>ASSIGN  10499>>ASSIGN  10501>>ASSIGN
     10503>>ASSIGN  10504>>ASSIGN  10509>>ASSIGN  10511>>ASSIGN  10512>>ASSIGN  10515<<ASSIGN  10517>>IF
     10555<<ASSIGN  10556>>ASSIGN  10560>>ASSIGN  10569<<ASSIGN  10571<<ASSIGN  10572>>IF      10593<>CALL
     10605<>CALL    10609<>CALL    10622>>ASSIGN  10624<<ASSIGN
NXTVPSECT.PG#
      8944**DCL     10599>>IF      10601>>IF
NXTVPSECT.SECT#
      8943**DCL     10597>>IF
PAGE_NO_ENTRY
      8919**DCL      9675<<ASSIGN   9685<<ASSIGN   9705>>IF       9711>>ASSIGN   9715>>ASSIGN   9718>>ASSIGN
      9728>>ASSIGN   9763>>ASSIGN   9764>>ASSIGN   9862>>ASSIGN   9863>>ASSIGN  10181<<ASSIGN  10183>>IF
     10186<<ASSIGN  10186>>ASSIGN  10194>>ASSIGN  10205>>ASSIGN  10206>>ASSIGN  10491>>IF      10493<<ASSIGN
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:279  
PAGE_USED IN PROCEDURE REUSE_INACTIVE_PT
     10545**LABEL   10537--GOTO
PGINUSE
      9492**DCL     10188>>ASSIGN
PP
      8938**DCL      8939--REDEF    9610<<ASSIGN   9612<<ASSIGN   9612>>ASSIGN   9719<<ASSIGN   9721<<ASSIGN
      9721>>ASSIGN   9771<<ASSIGN   9773<<ASSIGN   9773>>ASSIGN   9785>>ASSIGN   9793>>ASSIGN   9802>>ASSIGN
      9840<<ASSIGN   9842<<ASSIGN   9842>>ASSIGN   9879>>ASSIGN   9888>>ASSIGN   9894>>ASSIGN   9974<<ASSIGN
      9976<<ASSIGN   9976>>ASSIGN   9977>>ASSIGN  10011<>CALL    10014<>CALL    10016<>CALL    10021<>CALL
     10023<>CALL    10025<>CALL    10091<<ASSIGN  10093<<ASSIGN  10093>>ASSIGN  10094>>ASSIGN  10125<<ASSIGN
     10127<<ASSIGN  10127>>ASSIGN  10128>>ASSIGN  10156<>CALL    10603<<ASSIGN  10615<<ASSIGN  10616<<ASSIGN
     10616>>ASSIGN  10617>>ASSIGN  10618>>ASSIGN
PPNO
      8893**DCL        41--PROC    10168--ENTRY   10199<>CALL    10205>>ASSIGN
PREDT
      8950**DCL      9835>>ASSIGN  10453<<ASSIGN  10459<<ASSIGN  10460<<ASSIGN  10467<<ASSIGN  10559<<ASSIGN
     10621<<ASSIGN
PREDTA
      8948**DCL     10428<<ASSIGN  10453>>ASSIGN
PREDTN
      8949**DCL     10404<<ASSIGN  10439<<ASSIGN  10459>>IF      10460>>ASSIGN  10467>>ASSIGN
PT
      8954**DCL     10398<<ASSIGN  10410>>IF      10415<<ASSIGN  10537>>IF      10562>>IF      10563<<ASSIGN
     10579>>IF      10582>>ASSIGN  10597>>IF      10634>>ASSIGN  10635>>ASSIGN
PTBASE
      8952**DCL     10367<<ASSIGN  10369>>IF      10539<<ASSIGN  10582<<ASSIGN  10584>>IF
READ$PAGE
     10218**PROC     9736--CALL
READ$PAGE$ERR
      8961**DCL     10273<<ASSIGN  10280<<ASSIGN
READ$PAGE$ERR.CODE
      8965**DCL      9812>>IF       9910>>ASSIGN
READ_ERROR IN PROCEDURE READ$PAGE
     10274**LABEL   10257--CALLALT
READ_PAGE
      9736**LABEL    9810--GOTO     9900--GOTO    10240<<ASSIGN  10257<>CALL    10291<<ASSIGN
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:280  
READ_PAGE.BUF_.BOUND
      9372**DCL     10256<<ASSIGN
READ_PAGE.BUF_.BUF$
      9373**DCL     10255<<ASSIGN
READ_PAGE.KEY_
      9370**DCL     10254<<ASSIGN
READ_PAGE.STATION_
      9373**DCL      9374--REDEF
READ_PAGE.V
      9374**DCL     10253--ASSIGN
READ_PAGE.V.DCB#
      9374**DCL     10252<<ASSIGN
READ_PAGE.V.DVBYTE.REREAD#
      9385**DCL      9385--REDEF
READ_PAGE.V.INDX#
      9383**DCL      9383--REDEF
READ_PAGE.V_
      9370**DCL     10253<<ASSIGN
READ_PAGEC
      9331**DCL     10240>>ASSIGN
READ_PAGEC.STATION_
      9334**DCL      9335--REDEF
READ_PAGEC.V
      9335**DCL      9331--DCLINIT
READ_PAGEC.V.DVBYTE.REREAD#
      9346**DCL      9346--REDEF
READ_PAGEC.V.INDX#
      9344**DCL      9344--REDEF
REUSE_ACTIVE_PT
     10549**PROC    10151--CALL
REUSE_INACTIVE_PT
     10530**PROC    10149--CALL
REUSE_PAGE
      9818**LABEL    9917--GOTO
RW IN PROCEDURE READ$PAGE
     10225**DCL     10241<<ASSIGN  10257>>CALL    10292<<ASSIGN
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:281  
RWPAGE IN PROCEDURE READ$PAGE
     10242**LABEL   10293--GOTO
SAVEDCB$ IN PROCEDURE READ$PAGE
     10226**DCL     10245<<ASSIGN  10271>>ASSIGN  10278>>ASSIGN
SAVEDCBNO IN PROCEDURE READ$PAGE
     10227**DCL     10246<<ASSIGN  10272>>ASSIGN  10279>>ASSIGN
SAVEERR IN PROCEDURE READ$PAGE
     10228**DCL     10247<<ASSIGN  10274>>ASSIGN  10281>>ASSIGN
SAVE_PPUT
      8955**DCL     10608<<ASSIGN  10617>>ASSIGN
SAVE_VP
      8956**DCL     10097<<ASSIGN  10124<>CALL    10129>>ASSIGN
SCT#
      8957**DCL     10379<<ASSIGN  10410>>IF      10415>>ASSIGN
SCT_USED
      8958**DCL     10148>>IF      10397<<ASSIGN  10409>>DOINDEX 10412<<ASSIGN  10412>>ASSIGN  10413>>IF
     10415>>ASSIGN  10536>>DOINDEX
SC_MM47
      9093**DCL-ENT  9630--CALL     9639--CALL     9682--CALL     9692--CALL    10056--CALL    10074--CALL
     10161--CALL    10372--CALL    10414--CALL    10447--CALL    10518--CALL    10546--CALL    10573--CALL
     10587--CALL    10600--CALL    10610--CALL
SECT$
      8974**DCL     10140>>ASSIGN  10365<<ASSIGN  10366>>IF      10367>>ASSIGN  10534>>IF      10539>>ASSIGN
     10540>>ASSIGN  10540>>ASSIGN  10541>>ASSIGN  10582>>ASSIGN  10589>>ASSIGN  10634>>ASSIGN  10634>>ASSIGN
     10635>>ASSIGN
SECTION
      8921**DCL      9664<<ASSIGN   9689>>IF       9700>>IF       9792>>IF       9829>>IF       9833>>IF
      9878>>IF      10088<<ASSIGN  10095>>IF      10100>>IF      10123>>IF
SEGID
      8967**DCL      9938<<ASSIGN   9942<<ASSIGN   9946<<ASSIGN   9999>>ASSIGN
SKIP_COUNT
      8959**DCL     10087<<ASSIGN  10095>>IF      10096<<ASSIGN  10096>>ASSIGN
SPACEM
     10134**LABEL    9695--GOTO
SSS$SEXIT
      9094**DCL-ENT 10343--CALL
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:282  
SST$SSFTCB
      9057**DCL-ENT 10342--CALL
SSU$DELTAGO
      9095**DCL-ENT 10335--CALL
STATS$
      8981**DCL      9424--IMP-PTR  9636<<ASSIGN   9641>>ASSIGN   9641>>ASSIGN   9777>>IF       9779>>ASSIGN
      9932<<ASSIGN  10070<<ASSIGN  10134>>ASSIGN  10134>>ASSIGN  10177<<ASSIGN  10239>>ASSIGN  10239>>ASSIGN
     10288>>ASSIGN  10288>>ASSIGN
SUBC IN PROCEDURE ABORTM
     10323**DCL     10321--PROC    10325>>ASSIGN  10338>>IF      10338>>IF
S_RVA
      8906**DCL      9588>>ASSIGN
TCB_FULL IN PROCEDURE ABORTM
     10342**LABEL   10342--CALLALT
TEMP
      8968**DCL      8969--REDEF    9614<<ASSIGN   9676<<DOINDEX  9698<<ASSIGN   9701>>IF       9705>>IF
      9969<<ASSIGN   9972>>DOINDEX  9999<<ASSIGN  10001>>ASSIGN  10003>>ASSIGN  10007<<ASSIGN  10009<<ASSIGN
     10010>>DOINDEX 10012>>IF      10019<<ASSIGN  10020>>DOINDEX 10022>>IF      10085<<ASSIGN  10301<<ASSIGN
     10304<<ASSIGN  10306>>ASSIGN  10307>>ASSIGN  10308>>ASSIGN  10309>>ASSIGN  10310>>ASSIGN  10311>>ASSIGN
     10312>>ASSIGN  10313>>ASSIGN  10399<<ASSIGN  10406>>DOINDEX 10482<<ASSIGN  10486>>DOINDEX 10551<<ASSIGN
     10561<<DOINDEX 10562>>IF      10563>>ASSIGN  10591<<ASSIGN  10592>>DOINDEX
TLACC
      8930**DCL     10401<<ASSIGN  10428>>ASSIGN  10430<<ASSIGN  10451>>ASSIGN  10459>>ASSIGN
TLNACC
      8928**DCL      9933<<ASSIGN   9934>>DOCASE  10037>>IF      10042>>IF      10403<<ASSIGN  10439>>ASSIGN
     10441<<ASSIGN  10457>>ASSIGN  10465>>ASSIGN  10512<<ASSIGN
TRUNCPG IN PROCEDURE CVM
     10163**ENTRY   10214--CALL
UDB$AUTO
      9096**DCL-ENT  9743--CALL
UDN$MAGIC
      9097**DCL-ENT  9595--CALL
UDN$MGRES
      9099**DCL-ENT  9742--CALL
UDN$MGSAVE
      9100**DCL-ENT  9594--CALL
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:283  
UNCVM IN PROCEDURE CVM
     10158**ENTRY    9741--CALL     9908--CALL     9992--CALL    10114--CALL
UNMAP$
      8975**DCL      8976--REDEF   10589<<ASSIGN  10599>>IF      10601>>IF
UNMAP_PTR.WOFFS
      8977**DCL     10590<<ASSIGN  10590>>ASSIGN
UNUSED_PT IN PROCEDURE REUSE_ACTIVE_PT
     10582**LABEL   10579--GOTO
UPD_CHAIN_FLG
      8960**DCL      9592<<ASSIGN   9699>>IF       9828>>IF      10145>>IF      10469<<ASSIGN  10525<<ASSIGN
UPD_FRAG_DENSE_CHAIN
     10473**PROC     9706--CALL     9832--CALL
UPD_SECT_CHAIN
     10385**PROC     9702--CALL     9830--CALL    10146--CALL
VA IN PROCEDURE FINDMAP
     10356**DCL     10351--PROC    10381>>ASSIGN
VA.PG# IN PROCEDURE FINDMAP
     10359**DCL     10378>>ASSIGN
VA.SECT# IN PROCEDURE FINDMAP
     10358**DCL     10366>>IF      10367>>ASSIGN  10379>>ASSIGN
VCB$
      8980**DCL      9635<<ASSIGN   9637>>IF       9644>>IF       9655>>IF       9663>>ASSIGN   9664>>ASSIGN
      9698>>ASSIGN   9701>>IF       9705>>IF       9733>>IF       9733>>IF       9752>>IF       9752>>IF
      9754>>IF       9774>>ASSIGN   9774>>ASSIGN   9777>>IF       9779>>ASSIGN   9781>>IF       9783>>ASSIGN
      9784>>ASSIGN   9793>>ASSIGN   9794>>ASSIGN   9798>>ASSIGN   9800>>ASSIGN   9801>>ASSIGN   9808>>IF
      9808>>IF       9834>>ASSIGN   9835>>ASSIGN   9838>>ASSIGN   9879>>ASSIGN   9880>>ASSIGN   9881>>CALL
      9888>>ASSIGN   9890>>ASSIGN   9892>>ASSIGN   9893>>ASSIGN   9898>>IF       9898>>IF       9915>>IF
      9915>>IF       9931<<ASSIGN   9933>>ASSIGN   9952>>ASSIGN   9969>>ASSIGN   9970>>ASSIGN   9978>>ASSIGN
      9979>>ASSIGN   9979>>ASSIGN   9983>>IF      10006>>IF      10007>>ASSIGN  10009>>ASSIGN  10018>>IF
     10019>>ASSIGN  10021>>CALL    10069<<ASSIGN  10072>>IF      10078>>IF      10078>>IF      10085>>ASSIGN
     10086>>ASSIGN  10087>>ASSIGN  10088>>ASSIGN  10089>>DOWHILE 10089>>DOWHILE 10101>>ASSIGN  10102>>ASSIGN
     10102>>ASSIGN  10106>>IF      10116>>IF      10129>>ASSIGN  10139>>IF      10139>>IF      10140>>ASSIGN
     10140>>ASSIGN  10142>>ASSIGN  10142>>ASSIGN  10148>>IF      10176<<ASSIGN  10179>>IF      10203>>IF
     10242>>IF      10258>>IF      10260>>ASSIGN  10302>>IF      10304>>ASSIGN  10364>>IF      10368>>DOINDEX
     10368>>DOINDEX 10368>>DOINDEX 10399>>ASSIGN  10405>>ASSIGN  10413>>IF      10449>>ASSIGN  10451>>ASSIGN
     10457>>ASSIGN  10464>>ASSIGN  10465>>ASSIGN  10482>>ASSIGN  10484>>ASSIGN  10485>>ASSIGN  10504>>ASSIGN
PL6.E3A0      #002=MMV$PAGE File=MMV$VIRTUAL.:E05TSI                             WED 07/30/97 03:26 Page:284  
     10508>>IF      10509>>ASSIGN  10521>>IF      10522>>ASSIGN  10532>>DOINDEX 10555>>ASSIGN  10558>>DOUNTIL
     10561>>DOINDEX 10572>>IF      10578>>DOINDEX 10583>>DOINDEX 10583>>DOINDEX 10583>>DOINDEX 10591>>ASSIGN
     10612>>ASSIGN  10612>>ASSIGN  10627>>ASSIGN
VP
      8932**DCL      8933--REDEF    8937--REDEF    9718<<ASSIGN   9726<>CALL     9834<<ASSIGN   9838<<ASSIGN
      9839<>CALL     9851>>ASSIGN   9857<>CALL     9861>>ASSIGN   9970<<ASSIGN   9973<>CALL     9985>>ASSIGN
      9991<>CALL     9994<>CALL     9995<<ASSIGN  10086<<ASSIGN  10090<>CALL    10097>>ASSIGN  10108>>ASSIGN
     10109>>ASSIGN  10113<>CALL    10118>>ASSIGN  10119<>CALL    10121<<ASSIGN  10556<<ASSIGN  10559>>ASSIGN
     10560<<ASSIGN  10567<>CALL    10614<>CALL    10621>>ASSIGN  10622<<ASSIGN  10627>>ASSIGN  10628<>CALL
VPAGE IN PROCEDURE READ$PAGE
     10222**DCL     10218--PROC    10249>>ASSIGN  10258>>IF      10260>>ASSIGN  10284--ENTRY
VPSECT.SECT#
      8935**DCL     10562>>IF
VSBADAC
      9447**DCL      9646>>ASSIGN
WRITE$PAGE IN PROCEDURE READ$PAGE
     10284**ENTRY    9726--CALL     9854--CALL     9857--CALL     9988--CALL     9991--CALL    10110--CALL
     10113--CALL    10605--CALL
WRITE_FLAG
      8924**DCL      9963<<ASSIGN   9965<<ASSIGN   9980>>IF
WRITE_PAGEC
      9409**DCL     10291>>ASSIGN
WRITE_PAGEC.STATION_
      9411**DCL      9411--REDEF
WRITE_PAGEC.V
      9412**DCL      9409--DCLINIT
WRITE_PAGEC.V.DVBYTE.VFC#
      9418**DCL      9418--REDEF
WSQ
      8982**DCL      9597<<ASSIGN   9603>>IF       9607>>ASSIGN   9609<>CALL     9621<<ASSIGN   9627>>ASSIGN
      9637>>IF       9730<>CALL     9756<>CALL     9758<>CALL     9872<>CALL     9952<<ASSIGN   9954>>ASSIGN
      9994<>CALL    10030>>ASSIGN  10062<<ASSIGN  10064>>ASSIGN  10072>>IF      10119<>CALL    10140>>ASSIGN
     10170<<ASSIGN  10173>>ASSIGN  10175>>ASSIGN  10199<>CALL    10362>>ASSIGN  10369>>IF      10584>>IF
     10609<>CALL
WS_FLT
      8983**DCL      9590<<ASSIGN   9657>>IF       9695>>IF      10377<<ASSIGN

PL6.E3A0      #003=MMV$VIRTUAL File=MMV$VIRTUAL.:E05TSI                          WED 07/30/97 03:28 Page:285  
     1620        1        /*T***********************************************************/
     1621        2        /*T*                                                         */
     1622        3        /*T* Copyright (c) Bull HN Information Systems Inc., 1997    */
     1623        4        /*T*                                                         */
     1624        5        /*T***********************************************************/
     1625        6        MMV$VIRTUAL: PROC;
     1626        7
     1627        8        /*
     1628        9             This routine handles all the functions for the M$VIRTUAL pmme.
     1629       10         */
     1630       11
     1631       12        %INCLUDE B$JIT;
     1632      615        %INCLUDE B_ERRORS_C;
     1633     1742        %INCLUDE CP_6_C;
     1634     7221        %INCLUDE CP_6_SUBS;
     1635     7761        %INCLUDE F$DCB;
     1636     7810        %INCLUDE MM$CP6V_C;
     1637     7878        %INCLUDE MM_DATA_R;
     1638     8398        %INCLUDE UD_SEV_C;
     1639     8412
     1640     8413        /* Symrefs */
     1641     8414    1   DCL B$JIT$ PTR SYMREF;
     1642     8415    1   DCL B$PS0$ PTR SYMREF;
     1643     8416    1   DCL B$PS1$ PTR SYMREF;
     1644     8417    1   DCL B$PS2$ PTR SYMREF;
     1645     8418
     1646     8419        /* Auto */
     1647     8420    1   DCL STATS$ PTR;
     1648     8421    1   DCL DCB# UBIN;
     1649     8422    1   DCL VCB$ PTR;
     1650     8423    1   DCL MAXVP SBIN;
     1651     8424    1   DCL WSQ UBIN;
     1652     8425
     1653     8426        /* Macro invocations */
     1654     8427        %FPT$VIRTUAL_V (BASED="BASED(B$PS0$)");
     1655     8430        %VLP_VIRTUAL (FPTN=VLP$VIRTUAL,STCLASS=BASED);
     1656     8450        %MM$VIRTUAL_STATS(STCLASS="BASED(STATS$)");
PL6.E3A0      #003=MMV$VIRTUAL File=MMV$VIRTUAL.:E05TSI                          WED 07/30/97 03:28 Page:286  
     1657     8454
     1658     8455        /* Entry references */
     1659     8456    1   DCL FMP$CLSJ ENTRY;
     1660     8457    1   DCL HFF$NILERASE ENTRY(1) ALTRET;
     1661     8458    1   DCL MMV$CLOSE ENTRY ALTRET;
     1662     8459    1   DCL MMV$OPEN ENTRY ALTRET;
     1663     8460    1   DCL MMV$TRUNC ENTRY(1) ALTRET;
     1664     8461
     1665     8462        /* Error code */
     1666     8463        %VLP_ERRCODE (FPTN=VSNOTOPEN,ERR#=%E$VSNOTOPEN,SEV=SEV_ERROR#,FCG=MM,MID=V,MON='1'B,
              8463            STCLASS=CONSTANT);
     1667     8508
     1668     8509        %EJECT;
PL6.E3A0      #003=MMV$VIRTUAL File=MMV$VIRTUAL.:E05TSI                          WED 07/30/97 03:28 Page:287  
     1669     8510
     1670     8511        /* Get the DCB# for this segment */
     1671     8512    1        DCB# = 0;
     1672     8513    2        DO CASE (FPT$VIRTUAL_V.SEGNUM);
     1673     8514
     1674     8515    2        CASE(1);                           /* VS1 */
     1675     8516    2           DCB# = B$JIT.VIRTUAL.DCB#(0);
     1676     8517
     1677     8518    2        CASE(2);
     1678     8519    2           DCB# = B$JIT.VIRTUAL.DCB#(1);
     1679     8520
     1680     8521    2        CASE(3);
     1681     8522    2           DCB# = B$JIT.VIRTUAL.DCB#(2);
     1682     8523    2        END;
     1683     8524
     1684     8525    1        IF DCB# = 0
     1685     8526    2        THEN DO;
     1686     8527    2             B$JIT.ERR = VSNOTOPEN;
     1687     8528                  /*E* ERROR: MMV-E$VSNOTOPEN
     1688     8529                       MESSAGE: The virtual segment specified is not open */
     1689     8530    2             RETURN;
     1690     8531    2           END;
     1691     8532
     1692     8533    1        B$JIT.DCB$ = DCBADDR(DCB#);
     1693     8534    1        STATS$ = B$JIT.DCB$->F$DCB.LASTSTA$;
     1694     8535    1        VCB$ = B$JIT.DCB$->F$DCB.SETSTA$;
     1695     8536
     1696     8537    1        CALL HFF$NILERASE(B$PS1$)          /* Virtual was specified on the FPT */
     1697     8538    2        WHENRETURN DO;
     1698     8539    2             VCB$->MM$VCB.INITIALIZE = B$PS1$->VLP$VIRTUAL.INITIALIZE#;
     1699     8540    2             VCB$->MM$VCB.INITVALUE = B$PS1$->VLP$VIRTUAL.INITVALUE#;
     1700     8541    2             VCB$->MM$VCB.PPMIN = B$PS2$->VLP$VIRTUAL.MINPHYS#;
     1701     8542    2             VCB$->MM$VCB.PPMAX = B$PS2$->VLP$VIRTUAL.PHYSICAL#;
     1702     8543    2             MAXVP = (B$PS1$->VLP$VIRTUAL.SEGSIZE#-1)/1024;
     1703     8544
     1704     8545        /* If the size of the segment has changed, close and reopen it */
     1705     8546    2             IF MAXVP ~= VCB$->MM$VCB.MAXVP#
PL6.E3A0      #003=MMV$VIRTUAL File=MMV$VIRTUAL.:E05TSI                          WED 07/30/97 03:28 Page:288  
     1706     8547    3             THEN DO;
     1707     8548    3                  VCB$->MM$VCB.MAXVP# = B$PS1$->VLP$VIRTUAL.SEGSIZE#;
     1708     8549    3                  CALL MMV$CLOSE;
     1709     8550    3                  CALL MMV$OPEN
     1710     8551    4                  WHENALTRETURN DO;
     1711     8552    4                       CALL FMP$CLSJ;
     1712     8553    4                       RETURN;
     1713     8554    4                     END;
     1714     8555    3                END;
     1715     8556
     1716     8557        /* If the current physical page count is larger than PPMAX call trunc */
     1717     8558    2             IF VCB$->MM$VCB.PPC > VCB$->MM$VCB.PPMAX
     1718     8559    3             THEN DO;
     1719     8560    3                  WSQ = VCB$->MM$VCB.WSQ;
     1720     8561    3                  CALL MMV$TRUNC(WSQ);
     1721     8562    3                END;
     1722     8563    2           END;
     1723     8564
     1724     8565        /*
     1725     8566             If the user is requesting current information return it */
     1726     8567
     1727     8568    1        CALL HFF$NILERASE(B$PS2$)
     1728     8569    2        WHENRETURN DO;
     1729     8570    2             B$PS2$->VLP$VIRTUAL = VCB$->MM$VCB;
     1730     8571    2             B$PS2$->VLP$VIRTUAL.READS# = MM$VIRTUAL_STATS.READS#;
     1731     8572    2             B$PS2$->VLP$VIRTUAL.WRITES# = MM$VIRTUAL_STATS.WRITES#;
     1732     8573    2             B$PS2$->VLP$VIRTUAL.TRUNCS# = MM$VIRTUAL_STATS.TRUNCS#;
     1733     8574    2             B$PS2$->VLP$VIRTUAL.FAULTS# = MM$VIRTUAL_STATS.FAULTS#;
     1734     8575    2             B$PS2$->VLP$VIRTUAL.MAXPGS# = MM$VIRTUAL_STATS.MAXPGS#;
     1735     8576    2             B$PS2$->VLP$VIRTUAL.CURPGS# = VCB$->MM$VCB.PPC;
     1736     8577    2           END;
     1737     8578
     1738     8579    1        RETURN;
     1739     8580    1   END MMV$VIRTUAL;

PL6.E3A0      #003=MMV$VIRTUAL File=MMV$VIRTUAL.:E05TSI                          WED 07/30/97 03:28 Page:289  
--  Include file information  --

   UD_SEV_C.:E05TOU  is referenced.
   MM_MACRO_M.:E05TOU  is referenced.
   B_STRINGS_C.:E05TOU  is referenced.
   MM$SYSGEN.:E05TOU  is referenced.
   M_INFO_C.:E05TOU  is referenced.
   MM_DATA_R.:E05TOU  cannot be made into a system file and is referenced.
   MM$CP6V_C.:E05TOU  is referenced.
   F$DCB.:E05TOU  cannot be made into a system file and is referenced.
   CP_6_SUBS.:E05TOU  is referenced.
   CP_6_C.:E05TOU  is referenced.
   B_ERRORS_C.:E05TOU  is referenced.
   B$JIT_C.:E05TOU  is referenced.
   B$JIT.:E05TOU  cannot be made into a system file and is referenced.
      No diagnostics issued in procedure MMV$VIRTUAL.

   Procedure MMV$VIRTUAL requires 121 words for executable code.
   Procedure MMV$VIRTUAL requires 10 words of local(AUTO) storage.

    No errors detected in file MMV$VIRTUAL.:E05TSI    .

PL6.E3A0      #003=MMV$VIRTUAL File=MMV$VIRTUAL.:E05TSI                          WED 07/30/97 03:28 Page:290  

 Object Unit name= MMV$VIRTUAL                                File name= MMV$VIRTUAL.:E05TOU
 UTS= JUL 30 '97 03:28:34.68 WED                              Compiler= PL-6/E31         Sev=      00
 SharedLib= :SHARED_SYSTEM                                    Alt SharedLib=


    ****  Control sections  ****

 Sect   Type Bound  Init  Size OctSiz  Section name(segment info)
    0  RoData even  UTS      1      1  MMV$VIRTUAL
    1   Proc  even  none   121    171  MMV$VIRTUAL
    2  RoData even  none     3      3  MMV$VIRTUAL

    ****  Entry defs  ****

                              Check   Calling
                             calling  sequence
  Sect OctLoc Primary Altret sequence   type   Parms  Name
     1      0   yes            yes      Std        0  MMV$VIRTUAL

  ****  Entry refs  ****

         Check        Calling
        calling       sequence
Altret sequence SRef   type   Args  Name
 yes     yes           Std       1 HFF$NILERASE
 yes     yes           Std       0 MMV$CLOSE
         yes           Std       0 FMP$CLSJ
 yes     yes           Std       0 MMV$OPEN
 yes     yes           Std       1 MMV$TRUNC
                       nStd      0 X66_AUTO_0
                       nStd      0 X66_ARET
                       Std       0 B_CONSPOOL_D
PL6.E3A0      #003=MMV$VIRTUAL File=MMV$VIRTUAL.:E05TSI                          WED 07/30/97 03:28 Page:291  

  ****  Data refs  ****

  Flags:  r = read only, s = secondary
Flgs Name                             Flgs Name                             Flgs Name
r    MM_BYP$                               B$JIT$                                B$PS0$
     B$PS1$                                B$PS2$                                B_VECTNIL

  ****  Segment refs  ****

  Flags:  r = read only, s = secondary
Flgs Name                             Flgs Name                             Flgs Name
     ROSID                                 ISSID
PL6.E3A0      #003=MMV$VIRTUAL File=MMV$VIRTUAL.:E05TSI                          WED 07/30/97 03:28 Page:292  


     1620        1        /*T***********************************************************/
     1621        2        /*T*                                                         */
     1622        3        /*T* Copyright (c) Bull HN Information Systems Inc., 1997    */
     1623        4        /*T*                                                         */
     1624        5        /*T***********************************************************/
     1625        6        MMV$VIRTUAL: PROC;

      6  1 000000   000000 700200 xent  MMV$VIRTUAL  TSX0  ! X66_AUTO_0
         1 000001   000012 000000                    ZERO    10,0

     1626        7
     1627        8        /*
     1628        9             This routine handles all the functions for the M$VIRTUAL pmme.
     1629       10         */
     1630       11
     1631       12        %INCLUDE B$JIT;
     1632      615        %INCLUDE B_ERRORS_C;
     1633     1742        %INCLUDE CP_6_C;
     1634     7221        %INCLUDE CP_6_SUBS;
     1635     7761        %INCLUDE F$DCB;
     1636     7810        %INCLUDE MM$CP6V_C;
     1637     7878        %INCLUDE MM_DATA_R;
     1638     8398        %INCLUDE UD_SEV_C;
     1639     8412
     1640     8413        /* Symrefs */
     1641     8414    1   DCL B$JIT$ PTR SYMREF;
     1642     8415    1   DCL B$PS0$ PTR SYMREF;
     1643     8416    1   DCL B$PS1$ PTR SYMREF;
     1644     8417    1   DCL B$PS2$ PTR SYMREF;
     1645     8418
     1646     8419        /* Auto */
     1647     8420    1   DCL STATS$ PTR;
     1648     8421    1   DCL DCB# UBIN;
     1649     8422    1   DCL VCB$ PTR;
     1650     8423    1   DCL MAXVP SBIN;
     1651     8424    1   DCL WSQ UBIN;
PL6.E3A0      #003=MMV$VIRTUAL File=MMV$VIRTUAL.:E05TSI                          WED 07/30/97 03:28 Page:293  
     1652     8425
     1653     8426        /* Macro invocations */
     1654     8427        %FPT$VIRTUAL_V (BASED="BASED(B$PS0$)");
     1655     8430        %VLP_VIRTUAL (FPTN=VLP$VIRTUAL,STCLASS=BASED);
     1656     8450        %MM$VIRTUAL_STATS(STCLASS="BASED(STATS$)");
     1657     8454
     1658     8455        /* Entry references */
     1659     8456    1   DCL FMP$CLSJ ENTRY;
     1660     8457    1   DCL HFF$NILERASE ENTRY(1) ALTRET;
     1661     8458    1   DCL MMV$CLOSE ENTRY ALTRET;
     1662     8459    1   DCL MMV$OPEN ENTRY ALTRET;
     1663     8460    1   DCL MMV$TRUNC ENTRY(1) ALTRET;
     1664     8461
     1665     8462        /* Error code */
     1666     8463       %VLP_ERRCODE (FPTN=VSNOTOPEN,ERR#=%E$VSNOTOPEN,SEV=SEV_ERROR#,FCG=MM,MID=V,MON='1'B,
              8463            STCLASS=CONSTANT);
     1667     8508
     1668     8509        %EJECT;
PL6.E3A0      #003=MMV$VIRTUAL File=MMV$VIRTUAL.:E05TSI                          WED 07/30/97 03:28 Page:294  
     1669     8510
     1670     8511        /* Get the DCB# for this segment */
     1671     8512    1        DCB# = 0;

   8512  1 000002   200004 450100                    STZ     DCB#,,AUTO

     1672     8513    2        DO CASE (FPT$VIRTUAL_V.SEGNUM);

   8513  1 000003   000000 470400 xsym               LDP0    B$PS0$
         1 000004   000000 236100                    LDQ     0,,PR0
         1 000005   000033 772000                    QRL     27
         1 000006   000004 116007                    CMPQ    4,DL
         1 000007   000011 602006 1                  TNC     s:8513+6,QL
         1 000010   000035 710000 1                  TRA     s:8525
         1 000011   000035 710000 1                  TRA     s:8525
         1 000012   000015 710000 1                  TRA     s:8516
         1 000013   000022 710000 1                  TRA     s:8519
         1 000014   000030 710000 1                  TRA     s:8522

     1673     8514
     1674     8515    2        CASE(1);                           /* VS1 */

     1675     8516    2           DCB# = B$JIT.VIRTUAL.DCB#(0);

   8516  1 000015   000000 471400 xsym               LDP1    B$JIT$
         1 000016   100217 236100                    LDQ     143,,PR1
         1 000017   000033 772000                    QRL     27
         1 000020   200004 756100                    STQ     DCB#,,AUTO
         1 000021   000035 710000 1                  TRA     s:8525

     1676     8517
     1677     8518    2        CASE(2);

     1678     8519    2           DCB# = B$JIT.VIRTUAL.DCB#(1);

   8519  1 000022   000000 471400 xsym               LDP1    B$JIT$
         1 000023   100217 236100                    LDQ     143,,PR1
PL6.E3A0      #003=MMV$VIRTUAL File=MMV$VIRTUAL.:E05TSI                          WED 07/30/97 03:28 Page:295  
         1 000024   000022 772000                    QRL     18
         1 000025   000777 376007                    ANQ     511,DL
         1 000026   200004 756100                    STQ     DCB#,,AUTO
         1 000027   000035 710000 1                  TRA     s:8525

     1679     8520
     1680     8521    2        CASE(3);

     1681     8522    2           DCB# = B$JIT.VIRTUAL.DCB#(2);

   8522  1 000030   000000 471400 xsym               LDP1    B$JIT$
         1 000031   100217 236100                    LDQ     143,,PR1
         1 000032   000011 772000                    QRL     9
         1 000033   000777 376007                    ANQ     511,DL
         1 000034   200004 756100                    STQ     DCB#,,AUTO

     1682     8523    2        END;

     1683     8524
     1684     8525    1        IF DCB# = 0

   8525  1 000035   200004 235100                    LDA     DCB#,,AUTO
         1 000036   000043 601000 1                  TNZ     s:8533

     1685     8526    2        THEN DO;

     1686     8527    2             B$JIT.ERR = VSNOTOPEN;

   8527  1 000037   000000 236000 0                  LDQ     VSNOTOPEN
         1 000040   000000 471400 xsym               LDP1    B$JIT$
         1 000041   100012 756100                    STQ     10,,PR1

     1687     8528                  /*E* ERROR: MMV-E$VSNOTOPEN
     1688     8529                       MESSAGE: The virtual segment specified is not open */
     1689     8530    2             RETURN;

   8530  1 000042   000000 702200 xent               TSX2  ! X66_ARET
PL6.E3A0      #003=MMV$VIRTUAL File=MMV$VIRTUAL.:E05TSI                          WED 07/30/97 03:28 Page:296  

     1690     8531    2           END;
     1691     8532
     1692     8533    1        B$JIT.DCB$ = DCBADDR(DCB#);

   8533  1 000043   000000 471400 2                  LDP1    0
         1 000044   100000 473500                    LDP3    0,,PR1
         1 000045   300000 236105                    LDQ     0,AL,PR3
         1 000046   000000 474400 xsym               LDP4    B$JIT$
         1 000047   400232 756100                    STQ     154,,PR4

     1693     8534    1        STATS$ = B$JIT.DCB$->F$DCB.LASTSTA$;

   8534  1 000050   400232 475500                    LDP5    154,,PR4
         1 000051   500007 236100                    LDQ     7,,PR5
         1 000052   200003 756100                    STQ     STATS$,,AUTO

     1694     8535    1        VCB$ = B$JIT.DCB$->F$DCB.SETSTA$;

   8535  1 000053   500006 236100                    LDQ     6,,PR5
         1 000054   200005 756100                    STQ     VCB$,,AUTO

     1695     8536
     1696     8537    1        CALL HFF$NILERASE(B$PS1$)          /* Virtual was specified on the FPT */

   8537  1 000055   000001 630400 2                  EPPR0   1
         1 000056   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 000057   000000 701000 xent               TSX1    HFF$NILERASE
         1 000060   000140 702000 1                  TSX2    s:8568

     1697     8538    2        WHENRETURN DO;

     1698     8539    2             VCB$->MM$VCB.INITIALIZE = B$PS1$->VLP$VIRTUAL.INITIALIZE#;

   8539  1 000061   200005 470500                    LDP0    VCB$,,AUTO
         1 000062   000000 471400 xsym               LDP1    B$PS1$
         1 000063   100000 236100                    LDQ     0,,PR1
PL6.E3A0      #003=MMV$VIRTUAL File=MMV$VIRTUAL.:E05TSI                          WED 07/30/97 03:28 Page:297  
         1 000064   000000 676100                    ERQ     0,,PR0
         1 000065   400000 376003                    ANQ     -131072,DU
         1 000066   000000 656100                    ERSQ    0,,PR0

     1699     8540    2             VCB$->MM$VCB.INITVALUE = B$PS1$->VLP$VIRTUAL.INITVALUE#;

   8540  1 000067   000000 471400 xsym               LDP1    B$PS1$
         1 000070   100001 235100                    LDA     1,,PR1
         1 000071   000001 755100                    STA     1,,PR0

     1700     8541    2             VCB$->MM$VCB.PPMIN = B$PS2$->VLP$VIRTUAL.MINPHYS#;

   8541  1 000072   000000 473400 xsym               LDP3    B$PS2$
         1 000073   300003 720100                    LXL0    3,,PR3
         1 000074   000003 440100                    SXL0    3,,PR0

     1701     8542    2             VCB$->MM$VCB.PPMAX = B$PS2$->VLP$VIRTUAL.PHYSICAL#;

   8542  1 000075   300003 221100                    LDX1    3,,PR3
         1 000076   000003 741100                    STX1    3,,PR0

     1702     8543    2             MAXVP = (B$PS1$->VLP$VIRTUAL.SEGSIZE#-1)/1024;

   8543  1 000077   100002 236100                    LDQ     2,,PR1
         1 000100   000001 136007                    SBLQ    1,DL
         1 000101   002000 506007                    DIV     1024,DL
         1 000102   200006 756100                    STQ     MAXVP,,AUTO

     1703     8544
     1704     8545        /* If the size of the segment has changed, close and reopen it */
     1705     8546    2             IF MAXVP ~= VCB$->MM$VCB.MAXVP#

   8546  1 000103   000002 116100                    CMPQ    2,,PR0
         1 000104   000122 600000 1                  TZE     s:8558

     1706     8547    3             THEN DO;

PL6.E3A0      #003=MMV$VIRTUAL File=MMV$VIRTUAL.:E05TSI                          WED 07/30/97 03:28 Page:298  
     1707     8548    3                  VCB$->MM$VCB.MAXVP# = B$PS1$->VLP$VIRTUAL.SEGSIZE#;

   8548  1 000105   100002 235100                    LDA     2,,PR1
         1 000106   000002 755100                    STA     2,,PR0

     1708     8549    3                  CALL MMV$CLOSE;

   8549  1 000107   000002 631400 xsym               EPPR1   B_VECTNIL+2
         1 000110   000000 701000 xent               TSX1    MMV$CLOSE
         1 000111   000000 011000                    NOP     0

     1709     8550    3                  CALL MMV$OPEN

   8550  1 000112   000002 631400 xsym               EPPR1   B_VECTNIL+2
         1 000113   000000 701000 xent               TSX1    MMV$OPEN
         1 000114   000116 702000 1                  TSX2    s:8552
         1 000115   000122 710000 1                  TRA     s:8558

     1710     8551    4                  WHENALTRETURN DO;

     1711     8552    4                       CALL FMP$CLSJ;

   8552  1 000116   000002 631400 xsym               EPPR1   B_VECTNIL+2
         1 000117   000000 701000 xent               TSX1    FMP$CLSJ
         1 000120   000000 011000                    NOP     0

     1712     8553    4                       RETURN;

   8553  1 000121   000000 702200 xent               TSX2  ! X66_ARET

     1713     8554    4                     END;
     1714     8555    3                END;

     1715     8556
     1716     8557        /* If the current physical page count is larger than PPMAX call trunc */
     1717     8558    2             IF VCB$->MM$VCB.PPC > VCB$->MM$VCB.PPMAX

PL6.E3A0      #003=MMV$VIRTUAL File=MMV$VIRTUAL.:E05TSI                          WED 07/30/97 03:28 Page:299  
   8558  1 000122   200005 470500                    LDP0    VCB$,,AUTO
         1 000123   000003 220100                    LDX0    3,,PR0
         1 000124   000011 100100                    CMPX0   9,,PR0
         1 000125   000140 603000 1                  TRC     s:8568

     1718     8559    3             THEN DO;

     1719     8560    3                  WSQ = VCB$->MM$VCB.WSQ;

   8560  1 000126   000000 236100                    LDQ     0,,PR0
         1 000127   000022 772000                    QRL     18
         1 000130   000777 376007                    ANQ     511,DL
         1 000131   200007 756100                    STQ     WSQ,,AUTO

     1720     8561    3                  CALL MMV$TRUNC(WSQ);

   8561  1 000132   200007 631500                    EPPR1   WSQ,,AUTO
         1 000133   200010 451500                    STP1    WSQ+1,,AUTO
         1 000134   200010 630500                    EPPR0   WSQ+1,,AUTO
         1 000135   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 000136   000000 701000 xent               TSX1    MMV$TRUNC
         1 000137   000000 011000                    NOP     0

     1721     8562    3                END;

     1722     8563    2           END;

     1723     8564
     1724     8565        /*
     1725     8566             If the user is requesting current information return it */
     1726     8567
     1727     8568    1        CALL HFF$NILERASE(B$PS2$)

   8568  1 000140   000002 630400 2                  EPPR0   2
         1 000141   000017 631400 xsym               EPPR1   B_VECTNIL+15
         1 000142   000000 701000 xent               TSX1    HFF$NILERASE
         1 000143   000170 702000 1                  TSX2    s:8579
PL6.E3A0      #003=MMV$VIRTUAL File=MMV$VIRTUAL.:E05TSI                          WED 07/30/97 03:28 Page:300  

     1728     8569    2        WHENRETURN DO;

     1729     8570    2             B$PS2$->VLP$VIRTUAL = VCB$->MM$VCB;

   8570  1 000144   200005 470500                    LDP0    VCB$,,AUTO
         1 000145   000000 471400 xsym               LDP1    B$PS2$
         1 000146   000100 100500                    MLR     fill='000'O
         1 000147   000000 000060                    ADSC9   0,,PR0                   cn=0,n=48
         1 000150   100000 000060                    ADSC9   0,,PR1                   cn=0,n=48

     1730     8571    2             B$PS2$->VLP$VIRTUAL.READS# = MM$VIRTUAL_STATS.READS#;

   8571  1 000151   200003 471500                    LDP1    STATS$,,AUTO
         1 000152   000000 473400 xsym               LDP3    B$PS2$
         1 000153   100000 235100                    LDA     0,,PR1
         1 000154   300005 755100                    STA     5,,PR3

     1731     8572    2             B$PS2$->VLP$VIRTUAL.WRITES# = MM$VIRTUAL_STATS.WRITES#;

   8572  1 000155   100001 235100                    LDA     1,,PR1
         1 000156   300006 755100                    STA     6,,PR3

     1732     8573    2             B$PS2$->VLP$VIRTUAL.TRUNCS# = MM$VIRTUAL_STATS.TRUNCS#;

   8573  1 000157   100004 235100                    LDA     4,,PR1
         1 000160   300012 755100                    STA     10,,PR3

     1733     8574    2             B$PS2$->VLP$VIRTUAL.FAULTS# = MM$VIRTUAL_STATS.FAULTS#;

   8574  1 000161   100002 235100                    LDA     2,,PR1
         1 000162   300007 755100                    STA     7,,PR3

     1734     8575    2             B$PS2$->VLP$VIRTUAL.MAXPGS# = MM$VIRTUAL_STATS.MAXPGS#;

   8575  1 000163   100003 235100                    LDA     3,,PR1
         1 000164   300011 755100                    STA     9,,PR3
PL6.E3A0      #003=MMV$VIRTUAL File=MMV$VIRTUAL.:E05TSI                          WED 07/30/97 03:28 Page:301  

     1735     8576    2             B$PS2$->VLP$VIRTUAL.CURPGS# = VCB$->MM$VCB.PPC;

   8576  1 000165   000011 236100                    LDQ     9,,PR0
         1 000166   000022 772000                    QRL     18
         1 000167   300010 756100                    STQ     8,,PR3

     1736     8577    2           END;

     1737     8578
     1738     8579    1        RETURN;

   8579  1 000170   000000 702200 xent               TSX2  ! X66_ARET

VSNOTOPEN
 Sect OctLoc
   0     000   151526 423264                                                    i...

(unnamed)
 Sect OctLoc
   2     000   000000 006003   000000 006000   000000 006000                    ............
     1739     8580    1   END MMV$VIRTUAL;

PL6.E3A0      #003=MMV$VIRTUAL File=MMV$VIRTUAL.:E05TSI                          WED 07/30/97 03:28 Page:302  
--  Include file information  --

   UD_SEV_C.:E05TOU  is referenced.
   MM_MACRO_M.:E05TOU  is referenced.
   B_STRINGS_C.:E05TOU  is referenced.
   MM$SYSGEN.:E05TOU  is referenced.
   M_INFO_C.:E05TOU  is referenced.
   MM_DATA_R.:E05TOU  cannot be made into a system file and is referenced.
   MM$CP6V_C.:E05TOU  is referenced.
   F$DCB.:E05TOU  cannot be made into a system file and is referenced.
   CP_6_SUBS.:E05TOU  is referenced.
   CP_6_C.:E05TOU  is referenced.
   B_ERRORS_C.:E05TOU  is referenced.
   B$JIT_C.:E05TOU  is referenced.
   B$JIT.:E05TOU  cannot be made into a system file and is referenced.
      No diagnostics issued in procedure MMV$VIRTUAL.
PL6.E3A0      #003=MMV$VIRTUAL File=MMV$VIRTUAL.:E05TSI                          WED 07/30/97 03:28 Page:303  

 **** Variables and constants ****

  ****  Section 000 RoData MMV$VIRTUAL

  ****  Scalars and arrays  ****
OctLoc.c.b A Datatyp(siz) R M Lvl/name                 OctLoc.c.b A Datatyp(siz) R M Lvl/name

     0-0-0/w STRC        r     1 VSNOTOPEN

  ****  Auto variables  ****

  ****  Scalars and arrays  ****
OctLoc.c.b A Datatyp(siz) R M Lvl/name                 OctLoc.c.b A Datatyp(siz) R M Lvl/name

     4-0-0/w UBIN        r     1 DCB#                       6-0-0/w SBIN        r     1 MAXVP
     3-0-0/w PTR         r     1 STATS$                     5-0-0/w PTR         r     1 VCB$
     7-0-0/w UBIN        r     1 WSQ

  ****  SYMREF variables  ****

  ****  Scalars and arrays  ****
OctLoc.c.b A Datatyp(siz) R M Lvl/name                 OctLoc.c.b A Datatyp(siz) R M Lvl/name

     0-0-0/w PTR         r     1 B$JIT$                     0-0-0/w PTR         r     1 B$PS0$
     0-0-0/w PTR         r     1 B$PS1$                     0-0-0/w PTR         r     1 B$PS2$
     0-0-0/w PTR         r     1 MM_BYP$

  ****  BASED and DCB variables  ****

  ****  Scalars and arrays  ****
OctLoc.c.b A Datatyp(siz) R M Lvl/name                 OctLoc.c.b A Datatyp(siz) R M Lvl/name

     0-0-0/d STRC(8856)  r     1 B$JIT                      0-0-0/d ASTR(3528)  r     1 F$DCB
     0-0-0/d STRC(72)    r     1 FPT$VIRTUAL_V              0-0-0/w STRC(432)   r     1 MM$VCB
     0-0-0/w STRC(288)   r     1 MM$VIRTUAL_STATS           0-0-0/w STRC(432)   r     1 VLP$VIRTUAL

PL6.E3A0      #003=MMV$VIRTUAL File=MMV$VIRTUAL.:E05TSI                          WED 07/30/97 03:28 Page:304  

   Procedure MMV$VIRTUAL requires 121 words for executable code.
   Procedure MMV$VIRTUAL requires 10 words of local(AUTO) storage.

    No errors detected in file MMV$VIRTUAL.:E05TSI    .
PL6.E3A0      #003=MMV$VIRTUAL File=MMV$VIRTUAL.:E05TSI                          WED 07/30/97 03:28 Page:305  
          *** CROSS REFERENCE LISTING ***
**     DENOTES     IDENTIFIER DEFINITION
<<                 IDENTIFIER'S VALUE SET
>>                 IDENTIFIER'S VALUE USED
<>                 IDENTIFIER SET AND/OR USED
--                 IDENTIFIER REFERENCED
PL6.E3A0      #003=MMV$VIRTUAL File=MMV$VIRTUAL.:E05TSI                          WED 07/30/97 03:28 Page:306  
          MINI XREF LISTING

B$JIT.CPFLAGS1.SLEAZE
       433**DCL       433--REDEF
B$JIT.DCB$
       507**DCL      8533<<ASSIGN   8534>>ASSIGN   8535>>ASSIGN
B$JIT.ERR
       339**DCL      8527<<ASSIGN
B$JIT.ERR.MID
       340**DCL       340--REDEF
B$JIT.JRESPEAK
       501**DCL       502--REDEF
B$JIT.ORIGINATOR_PORT.FROM_CR
       610**DCL       610--REDEF     611--REDEF
B$JIT.PNR
       514**DCL       514--REDEF
B$JIT.TSLINE
       608**DCL       609--REDEF
B$JIT.VIRTUAL.DCB#
       504**DCL      8516>>ASSIGN   8519>>ASSIGN   8522>>ASSIGN
B$JIT$
      8414**DCL       334--IMP-PTR  8516>>ASSIGN   8519>>ASSIGN   8522>>ASSIGN   8527>>ASSIGN   8533>>ASSIGN
      8534>>ASSIGN   8535>>ASSIGN
B$PS0$
      8415**DCL      8428--IMP-PTR  8513>>DOCASE
B$PS1$
      8416**DCL      8537<>CALL     8539>>ASSIGN   8540>>ASSIGN   8543>>ASSIGN   8548>>ASSIGN
B$PS2$
      8417**DCL      8541>>ASSIGN   8542>>ASSIGN   8568<>CALL     8570>>ASSIGN   8571>>ASSIGN   8572>>ASSIGN
      8573>>ASSIGN   8574>>ASSIGN   8575>>ASSIGN   8576>>ASSIGN
DCB#
      8421**DCL      8512<<ASSIGN   8516<<ASSIGN   8519<<ASSIGN   8522<<ASSIGN   8525>>IF       8533--ASSIGN
F$DCB.ACTPOS
      7787**DCL      7787--REDEF
PL6.E3A0      #003=MMV$VIRTUAL File=MMV$VIRTUAL.:E05TSI                          WED 07/30/97 03:28 Page:307  
F$DCB.ARS
      7762**DCL      7762--REDEF
F$DCB.ATTR
      7780**DCL      7781--REDEF
F$DCB.BORROW
      7795**DCL      7795--REDEF    7795--REDEF    7795--REDEF
F$DCB.DCBNAME.L
      7809**DCL      7809--IMP-SIZ
F$DCB.EOMCHAR
      7766**DCL      7766--REDEF
F$DCB.FLDID
      7790**DCL      7790--REDEF
F$DCB.FORM$
      7784**DCL      7784--REDEF
F$DCB.FSECT
      7800**DCL      7800--REDEF
F$DCB.FSN
      7777**DCL      7777--REDEF    7777--REDEF    7778--REDEF
F$DCB.HEADER$
      7783**DCL      7783--REDEF
F$DCB.IXTNSIZE
      7781**DCL      7781--REDEF
F$DCB.LASTSTA$
      7771**DCL      7771--REDEF    8534>>ASSIGN
F$DCB.LVL
      7796**DCL      7796--REDEF
F$DCB.NAME.C
      7771**DCL      7771--REDEF
F$DCB.NOEOF
      7792**DCL      7792--REDEF
F$DCB.NRECS
      7782**DCL      7782--REDEF
F$DCB.NRECX
      7801**DCL      7801--REDEF
F$DCB.OHDR
      7793**DCL      7793--REDEF
PL6.E3A0      #003=MMV$VIRTUAL File=MMV$VIRTUAL.:E05TSI                          WED 07/30/97 03:28 Page:308  
F$DCB.ORG
      7776**DCL      7776--REDEF
F$DCB.PRECNO
      7799**DCL      7799--REDEF
F$DCB.RCSZ
      7804**DCL      7804--REDEF
F$DCB.RES
      7772**DCL      7772--REDEF
F$DCB.SETSTA$
      7771**DCL      8535>>ASSIGN
F$DCB.SETX
      7784**DCL      7784--REDEF
F$DCB.TAB$
      7783**DCL      7784--REDEF
F$DCB.TDA
      7798**DCL      7798--REDEF
F$DCB.WSN
      7773**DCL      7773--REDEF
FMP$CLSJ
      8456**DCL-ENT  8552--CALL
FPT$VIRTUAL_V.SEGNUM
      8428**DCL      8513>>DOCASE
HFF$NILERASE
      8457**DCL-ENT  8537--CALL     8568--CALL
MAXVP
      8423**DCL      8543<<ASSIGN   8546>>IF
MM$DESC.BOUND
      8349**DCL      8350--REDEF
MM$DESC.FLGS
      8350**DCL      8350--REDEF
MM$PPUT.USER#
      8338**DCL      8338--REDEF
MM$VCB
      8340**DCL      8570>>ASSIGN
MM$VCB.INITIALIZE
      8340**DCL      8539<<ASSIGN
PL6.E3A0      #003=MMV$VIRTUAL File=MMV$VIRTUAL.:E05TSI                          WED 07/30/97 03:28 Page:309  
MM$VCB.INITVALUE
      8341**DCL      8540<<ASSIGN
MM$VCB.MAXVP#
      8342**DCL      8546>>IF       8548<<ASSIGN
MM$VCB.PPC
      8344**DCL      8558>>IF       8576>>ASSIGN
MM$VCB.PPMAX
      8342**DCL      8542<<ASSIGN   8558>>IF
MM$VCB.PPMIN
      8342**DCL      8541<<ASSIGN
MM$VCB.WSQ
      8341**DCL      8560>>ASSIGN
MM$VIRTUAL_STATS.FAULTS#
      8451**DCL      8574>>ASSIGN
MM$VIRTUAL_STATS.MAXPGS#
      8451**DCL      8575>>ASSIGN
MM$VIRTUAL_STATS.READS#
      8451**DCL      8571>>ASSIGN
MM$VIRTUAL_STATS.TRUNCS#
      8451**DCL      8573>>ASSIGN
MM$VIRTUAL_STATS.WRITES#
      8451**DCL      8572>>ASSIGN
MMV$CLOSE
      8458**DCL-ENT  8549--CALL
MMV$OPEN
      8459**DCL-ENT  8550--CALL
MMV$TRUNC
      8460**DCL-ENT  8561--CALL
MM_BYP$
      8269**DCL      8269--IMP-PTR
STATS$
      8420**DCL      8451--IMP-PTR  8534<<ASSIGN   8571>>ASSIGN   8572>>ASSIGN   8573>>ASSIGN   8574>>ASSIGN
      8575>>ASSIGN
VCB$
      8422**DCL      8535<<ASSIGN   8539>>ASSIGN   8540>>ASSIGN   8541>>ASSIGN   8542>>ASSIGN   8546>>IF
      8548>>ASSIGN   8558>>IF       8558>>IF       8560>>ASSIGN   8570>>ASSIGN   8576>>ASSIGN
PL6.E3A0      #003=MMV$VIRTUAL File=MMV$VIRTUAL.:E05TSI                          WED 07/30/97 03:28 Page:310  
VLP$VIRTUAL
      8441**DCL      8570<<ASSIGN
VLP$VIRTUAL.CURPGS#
      8446**DCL      8576<<ASSIGN
VLP$VIRTUAL.FAULTS#
      8446**DCL      8574<<ASSIGN
VLP$VIRTUAL.INITIALIZE#
      8441**DCL      8539>>ASSIGN
VLP$VIRTUAL.INITVALUE#
      8443**DCL      8540>>ASSIGN
VLP$VIRTUAL.MAXPGS#
      8447**DCL      8575<<ASSIGN
VLP$VIRTUAL.MINPHYS#
      8444**DCL      8541>>ASSIGN
VLP$VIRTUAL.PHYSICAL#
      8444**DCL      8542>>ASSIGN
VLP$VIRTUAL.READS#
      8445**DCL      8571<<ASSIGN
VLP$VIRTUAL.SEGSIZE#
      8443**DCL      8543>>ASSIGN   8548>>ASSIGN
VLP$VIRTUAL.TRUNCS#
      8447**DCL      8573<<ASSIGN
VLP$VIRTUAL.WRITES#
      8445**DCL      8572<<ASSIGN
VSNOTOPEN
      8475**DCL      8527>>ASSIGN
WSQ
      8424**DCL      8560<<ASSIGN   8561<>CALL
