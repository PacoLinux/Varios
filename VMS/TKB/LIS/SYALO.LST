SYALO	MACRO M1110  22-AUG-78 02:01  PAGE 2


      1						.TITLE	SYALO
      2						.IDENT	/07/
      3					                                                                                ;**NEW**
      4					;                                                                               ;**NEW**
      5					; COPYRIGHT   1974,  DIGITAL  EQUIPMENT  CORP.,  MAYNARD,   MASS.               ;**NEW**
      6					; COPYRIGHT   1976,  DIGITAL  EQUIPMENT  CORP.,  MAYNARD,   MASS.
      7					;                                                                               ;**NEW**
      8					; THIS SOFTWARE IS FURNISHED TO PURCHASER UNDER A LICENSE FOR USE               ;**NEW**
      9					; ON A  SINGLE COMPUTER SYSTEM AND CAN BE  COPIED (WITH INCLUSION               ;**NEW**
     10					; OF DEC'S COPYRIGHT  NOTICE) ONLY FOR USE IN SUCH SYSTEM, EXCEPT               ;**NEW**
     11					; AS MAY OTHERWISE BE PROVIDED IN WRITING BY DEC.                               ;**NEW**
     12					;                                                                               ;**NEW**
     13					; THE  INFORMATION  IN THIS DOCUMENT IS SUBJECT TO CHANGE WITHOUT               ;**NEW**
     14					; NOTICE  AND  SHOULD NOT BE CONSTRUED AS A COMMITMENT BY DIGITAL               ;**NEW**
     15					; EQUIPMENT CORPORATION.                                                        ;**NEW**
     16					;                                                                               ;**NEW**
     17					; DEC  ASSUMES NO  RESPONSIBILITY  FOR  THE  USE  OR  RELIABILITY               ;**NEW**
     18					; OF  ITS  SOFTWARE ON  EQUIPMENT WHICH  IS  NOT SUPPLIED BY DEC.               ;**NEW**
     19					;                                                                               ;**NEW**
     20					;                                                                               ;**NEW**
     21					; VERSION 07
     22					;                                                                               ;**NEW**
     23					; D. N. CUTLER/C. MONIA  19-APR-74                                              ;**NEW**
     24					;
     25					; MODIFICATIONS:
     26					;
     27					; NO.		DATE		PROGRAMMER
     28					; ---		----		----------
     29					;
     30					; 054		27-MAR-76	C. MONIA
     31					; 062		31-MAY-76	C. MONIA
     32					; 065		07-JUL-76	C. MONIA
     33					;                                                                               ;**-12
     34					;+
     35					; **-$SYALO-SYMBOL ABSOLUTE ADDRESS ALLOCATION
     36					;
     37					; THIS ROUTINE IS CALLED IN PHASE 4 TO ASSIGN ABSOLUTE ADDRESSES TO
     38					; ALL RELOCATABLE SYMBOLS.
     39					;
     40					; INPUTS:
     41					;
     42					;	NONE.
     43					;
     44					; OUTPUTS:
     45					;
     46					;	ABSOLUTE ADDRESSES ARE ASSIGNED TO ALL RELOCATABLE SYMBOLS.
     47					;	A COUNT OF ALL SYMBOLS DEFINED IS PLACED IN S$GNTB OF EACH
     48					;	SEGMENT DESCRIPTOR
     49					;-
     50
     51	000000	012700 	000074'		$SYALO::MOV	#SYALO,R0	;GET PHASE CONTROL ROUTINE ADDRESS
     52	000004					CALL	$PCTRL		;CALL PHASE CONTROL ROUTINE
     53	000010	012700 	000000G			MOV	#$XFRAD,R0	;GET PRG VECTOR ADDRESS
     54	000014	022720 	000001 			CMP	#1,(R0)+	;PRG SPECIFIED?
     55	000020	001402 				BEQ	10$		;IF EQ NO
     56	000022					CALL	20$		;RELOCATE PRG XFR ADDRESS
     57	000026	012700 	000000G		10$:	MOV	#$ODTAD,R0	;GET ODT VECTOR ADDRESS
SYALO	MACRO M1110  22-AUG-78 02:01  PAGE 2-1


     58	000032	022720 	000001 			CMP	#1,(R0)+	;ODT SPECIFIED?
     59	000036	001415 				BEQ	30$		;IF EQ NO
     60	000040	011001 			20$:	MOV	(R0),R1		;GET ADDRESS OF SECTION ENTRY
     61	000042	010046 				MOV	R0,-(SP)	; SAVE VECTOR ADDRESS                           ;**NEW**
     62	000044					CALL	$CVRL		; CONVERT SECTION TO REAL ADDRESS               ;**NEW**
     63	000050	012602 				MOV	(SP)+,R2	; RETRIEVE VECTOR ADDRESS                       ;**NEW**
     64	000052	132760 	000000G	000000G		BITB	#CS$REL,C$SFLG(R0) ; ABS SECTION?                               ;**NEW**
     65	000060	001404 				BEQ	30$		; IF EQ YES                                     ;**NEW**
     66	000062	066042 	000000G			ADD	C$SBSE(R0),-(R2) ; ADD IN SECTION BASE ADDRESS                  ;**NEW**
     67	000066	066712 	000000G			ADD	$OFFST,(R2)	;                                               ;**NEW**
     68	000072				30$:	RETURN			;                                               ;**-4
     69
     70					;
     71					; SYMBOL ADDRESS ALLOCATION
     72					;
     73					; THIS ROUTINE IS CALLED FOR EACH SEGMENT IN THE ALLOCATION.
     74					;
     75
     76	000074				SYALO:				;
     77	000074	010546 				MOV	R5,-(SP)	; SAVE R5
     78	000076	016701 	000000G			MOV	$CRVSG,R1	; GET VIRTUAL ADDRESS OF SEGMENT
     79	000102					CALL	$WRMPG		; WRITE-MARK PAGE
     80	000106	016700 	000000G			MOV	$CRSEG,R0	; GET REAL ADDRESS OF CURRENT SEGMENT
     81	000112	010005 				MOV	R0,R5		; COPY ADDRESS
     82	000114	062700 	000000G			ADD	#S$GSTB,R0	;POINT TO GLOBAL SYM TABLE HEADER
     83	000120	062705 	000000G			ADD	#S$GNTB,R5	; POINT TO COUNT OF DEFINITIONS
     84	000124	012746 	000000G			MOV	#$ISED,-(SP)	;SET EDIT ROUTINE ADDRESS
     85	000130				10$:	CALL	@(SP)+		;GET NEXT SYMBOL
     86	000132	103002 				BCC	20$		;IF CC GOT ONE
     87	000134	012605 				MOV	(SP)+,R5	; RESTORE R5
     88	000136					RETURN			;
     89	000140	132760 	000000G	000000G	20$:	BITB	#SY$DEF,S$YFLG(R0);SYMBOL DEFINITION?
     90	000146	001770 				BEQ	10$		;IF EQ NO
     91	000150	132760 	000000G	000000G		BITB	#SY$IND,S$YFLG(R0);INDIRECT SYMBOL?
     92	000156	001364 				BNE	10$		;IF NE YES
     93	000160	132760 	000000G	000001G		BITB	#SY$EXC,S$YFLG+1(R0) ; SYMBOL EXCLUDED FROM MAP?
     94	000166	001001 				BNE	30$		; IF NE YES
     95	000170	005215 				INC	(R5)		; INCREMENT COUNT OF DEFINITIONS
     96	000172				30$:				;
     97	000172	132760 	000000G	000000G		BITB	#SY$REL,S$YFLG(R0);RELOCATABLE SYMBOL?
     98	000200	001753 				BEQ	10$		;IF EQ NO
     99	000202					CALL	$WRMPG		; WRITE MARK PAGE                               ;**NEW**
    100	000206					CALL	$LCKPG		; LOCK PAGE IN CORE                             ;**NEW**
    101	000212	010046 				MOV	R0,-(SP)	; SAVE REAL ADDRESS                             ;**NEW**
    102	000214	010146 				MOV	R1,-(SP)	; SAVE VIRTUAL ADDRESS                          ;**NEW**
    103	000216	016001 	000000G			MOV	S$YCMT(R0),R1	; GET VIRTUAL ADDRESS OF SEGMENT                ;**NEW**
    104	000222					CALL	$CVRL		; CONVERT TO REAL                               ;**NEW**
    105	000226	010002 				MOV	R0,R2		; COPY REAL ADDRESS                             ;**NEW**
    106	000230	012601 				MOV	(SP)+,R1	; RESTORE R1                                    ;**NEW**
    107	000232	012600 				MOV	(SP)+,R0	; RESTORE R0                                    ;**NEW**
    108	000234					CALL	$UNLPG		; UNLOCK PAGE                                   ;**NEW**
    109	000240	132762 	000000G	000001G		BITB	#CS$VSC,C$SFLG+1(R2) ; VIRTUAL SECTION?
    110	000246	001412 				BEQ	40$		; IF EQ NO
    111	000250	010046 				MOV	R0,-(SP)	; SAVE ADDRESS OF SYMBOL
    112
    113						.IF DF	V1145
    114
SYALO	MACRO M1110  22-AUG-78 02:01  PAGE 2-2


    115						MOV	S$YVAL(R0),R1	; GET VALUE
    116						CLR	R0		; CLEAR TOP PART OF VALUE
    117						DIV	C$SLTH(R2),R0	; COMPUTE MODULUS OF SYMBOL
    118
    119						.IFF
    120
    121	000252	016000 	000000G			MOV	S$YVAL(R0),R0	; GET VALUE
    122	000256	016201 	000000G			MOV	C$SLTH(R2),R1	; GET DIVISOR
    123	000262					CALL	$DIV		; COMPUTE MODULUS OF SYMBOL
    124
    125						.ENDC
    126
    127	000266	012600 				MOV	(SP)+,R0	; RESTORE ADDRESS OF SYMBOL
    128	000270	010160 	000000G			MOV	R1,S$YVAL(R0)	; RESET SYMBOL VALUE
    129	000274				40$:				;
    130	000274	066260 	000000G	000000G		ADD	C$SBSE(R2),S$YVAL(R0) ; RELOCATE SYMBOL                         ;**NEW**
    131	000302	032762 	000000C	000000G		BIT	#<CS$VAS!CS$VSC*400!CS$LIB>,C$SFLG(R2) ; VIRTUAL OR LIBRARY SECTION
    132	000310	001707 				BEQ	10$		; IF EQ NO                                      ;**NEW**
    133	000312	142760 	000000G	000000G		BICB	#SY$REL,S$YFLG(R0) ; CONVERT SYMBOL TO ABSOLUTE                 ;**NEW**
    134	000320	000703 				BR	10$		; GO AGAIN                                      ;**NEW**
    135					                                                                                ;**-6
    136		000001 				.END
SYALO	MACRO M1110  22-AUG-78 02:01  PAGE 2-3
SYMBOL TABLE

CR    = 000015   	FF    = 000014   	SY$IND= ****** GX	$CRSEG= ****** GX	$OFFST= ****** GX
CS$LIB= ****** GX	HT    = 000011   	SY$REL= ****** GX	$CRVSG= ****** GX	$PCTRL= ****** GX
CS$REL= ****** GX	LF    = 000012   	S$GNTB= ****** GX	$CVRL = ****** GX	$SYALO  000000RG
CS$VAS= ****** GX	R$$11M= 000000   	S$GSTB= ****** GX	$DIV  = ****** GX	$UNLPG= ****** GX
CS$VSC= ****** GX	SPA   = 000040   	S$YCMT= ****** GX	$ISED = ****** GX	$WRMPG= ****** GX
C$SBSE= ****** GX	SYALO   000074R  	S$YFLG= ****** GX	$LCKPG= ****** GX	$XFRAD= ****** GX
C$SFLG= ****** GX	SY$DEF= ****** GX	S$YVAL= ****** GX	$ODTAD= ****** GX	$$    = 000001
C$SLTH= ****** GX	SY$EXC= ****** GX	VT    = 000013

. ABS.	000000	   000
      	000322	   001
ERRORS DETECTED:  0

VIRTUAL MEMORY USED:  798 WORDS  ( 4 PAGES)
DYNAMIC MEMORY:  2772 WORDS  ( 10 PAGES)
ELAPSED TIME:  00:00:08
OBJ$:SYALO,LIS$:SYALO/-SP=SRC$:MACFLM,SYALO
