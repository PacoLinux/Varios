STFDB	MACRO M1110  22-AUG-78 02:00  PAGE 3


      1						.TITLE	STFDB
      2						.IDENT	/03/
      3					                                                                                ;**-1
      4					;
      5					; COPYRIGHT   1974,  DIGITAL  EQUIPMENT  CORP.,  MAYNARD,   MASS.
      6					; COPYRIGHT   1976,  DIGITAL  EQUIPMENT  CORP.,  MAYNARD,   MASS.
      7					;
      8					; THIS SOFTWARE IS FURNISHED TO PURCHASER UNDER A LICENSE FOR USE
      9					; ON A  SINGLE COMPUTER SYSTEM AND CAN BE  COPIED (WITH INCLUSION
     10					; OF DEC'S COPYRIGHT  NOTICE) ONLY FOR USE IN SUCH SYSTEM, EXCEPT
     11					; AS MAY OTHERWISE BE PROVIDED IN WRITING BY DEC.
     12					;
     13					; THE  INFORMATION  IN THIS DOCUMENT IS SUBJECT TO CHANGE WITHOUT
     14					; NOTICE  AND  SHOULD NOT BE CONSTRUED AS A COMMITMENT BY DIGITAL
     15					; EQUIPMENT CORPORATION.
     16					;
     17					; DEC  ASSUMES NO  RESPONSIBILITY  FOR  THE  USE  OR  RELIABILITY
     18					; OF  ITS  SOFTWARE ON  EQUIPMENT WHICH  IS  NOT SUPPLIED BY DEC.
     19					;
     20					; VERSION 03
     21					;                                                                               ;**NEW**
     22					; C. MONIA 04-MAR-74                                                            ;**NEW**
     23					;
     24					; MODIFICATIONS:
     25					;
     26					; NO.		DATE		PROGRAMMER
     27					; ---		----		----------
     28					;
     29					; 046		03-FEB-76	C. MONIA
     30					;
     31					;                                                                               ;**-2
     32					; ROUTINES TO MANAGE OVERLAYED I/O DATA BASE.
     33					;
     34					; MACRO LIBRARY CALLS
     35					;
     36
     37						.MCALL	CLOSE$
     38
     39					;
     40					; LOCAL DATA
     41					;
     42					; STACK OF RESIDENT FDB'S
     43					;
     44
     45	000000					.BLKW	5
     46	000012	000012'			RCBPT:	.WORD	.
     47					;
     48					;+
     49					; **-$POPCL-CLOSE ALL FDB'S ON THE RESIDENT FDB LIST
     50					;
     51					; INPUTS:
     52					;	RCBPT=POINTER TO STACK OF RESIDENT FDB'S
     53					;
     54					; OUTPUTS:
     55					;
     56					;	A POP CLOSE IS PERFORMED ON EACH RESIDENT FDB
     57					;-
STFDB	MACRO M1110  22-AUG-78 02:00  PAGE 3-1


     58					;
     59
     60	000014				$POPCL::			;
     61	000014	012700 	000012'			MOV	#RCBPT,R0	; GET ADDRESS OF RECORD BLOCK LIST
     62	000020	021000 				CMP	(R0),R0		; LIST EMPTY NOW?
     63	000022	001414 				BEQ	20$		; IF EQ YES
     64	000024	013046 				MOV	@(R0)+,-(SP)	; GET ADDRESS OF RECORD BLOCK
     65	000026	062740 	000002 			ADD	#2,-(R0)	; POP ENTRY FROM LIST
     66	000032	021667 	000000G			CMP	(SP),$ODLPT	; ODL FILE?
     67	000036	001002 				BNE	10$		; IF NE NO
     68	000040					CALL	$CLSOD		; CLOSE ODL FILE, RESET GCML BLOCK
     69	000044				10$:				;
     70	000044					CLOSE$	(SP)+		; CLOSE FILE
     71	000052	000760 				BR	$POPCL		; CONTINUE LIST PROCESSING
     72	000054				20$:				;
     73	000054					RETURN			;
     74					;
     75					;+
     76					; **-$STBLK-SETUP FCS BLOCK BUFFER STORAGE REGION
     77					;
     78					; INPUTS:
     79					;
     80					;	R0=ADDRESS OF BLOCK BUFFER POOL
     81					;
     82					;	BUFFER POOL SETUP AS FOLLOWS:
     83					;
     84					;	POOL: .WORD N
     85					;	      .BLKW N
     86					;
     87					;
     88					; OUTPUTS:
     89					;
     90					;	FILE STORAGE REGION 2 IS SETUP WITH A LISTHEAD POINTING TO THE
     91					;	ABOVE POOL IN THE FORMAT REQUIRED BY $RQCB, $RLCB STORAGE
     92					;	ALLOCATION AND DEALLOCATION ROUTINES.
     93					;
     94					;	***NOTE***
     95					;
     96					; NO FILES MAY BE OPEN WHEN THIS ROUTINE IS CALLED
     97					;
     98					;-
     99					;
    100
    101	000056				$STBLK::			;
    102	000056	013701 	000000G			MOV	@#.FSRPT,R1	; GET FSR2 ADDRESS
    103	000062	012002 				MOV	(R0)+,R2	; GET POOL SIZE
    104	000064	010021 				MOV	R0,(R1)+	; SET BUFFER POINTER
    105	000066	005011 				CLR	(R1)		; CLEAR SECOND WORD OF LISTHEAD
    106	000070	005020 				CLR	(R0)+		; CLEAR LINK TO NEXT
    107	000072	010210 				MOV	R2,(R0)		; SET BLOCK SIZE
    108	000074					RETURN			;
    109
    110					;
    111					;+
    112					; **-$STFNB-SETUP THE NAMEBLOCK PORTION OF THE FDB
    113					;
    114					; INPUTS:
STFDB	MACRO M1110  22-AUG-78 02:00  PAGE 3-2


    115					;
    116					;	R0=ADDRESS OF ELEMENT DESCRIPTOR
    117					;	R1=RECORD BLOCK ADDRESS
    118					;
    119					; OUTPUTS:
    120					;
    121					;	THE NAME BLOCK AND FILE SWITCH WORD ARE
    122					;	COPIED INTO THE APPROPRIATE LOCATIONS WITH-
    123					;	IN THE RECORD BLOCK
    124					;
    125					;		*** NOTE ***
    126					;
    127					;	IF E$LNUM IS -2 THEN THE DIRECTORY I/D                                  ;**NEW**
    128					;	IS SETUP INSTEAD OF THE FILE I/D.                                       ;**-1
    129					;-
    130					;
    131
    132	000076				$STFNB::			;
    133	000076	016046 	000000G			MOV	E$LNUM(R0),-(SP) ; SAVE DIRECTORY INDICATOR                     ;**NEW**
    134	000102					CALL	STFN		; SETUP FILENAME PORTION OF FNB                 ;**-1
    135	000106	062701 	000102 			ADD	#F.FNB+N.FID,R1	; POINT TO FILE I/D
    136	000112	022627 	177776 			CMP	(SP)+,#-2	; TEST DIRECTORY INDICATOR                      ;**NEW**
    137	000116	001002 				BNE	10$		; IF NE SETUP FILE I/D                          ;**NEW**
    138	000120	062701 	000024 			ADD	#<N.DID-N.FID>,R1 ; POINT TO DIRECTORY I/D                      ;**-2
    139	000124				10$:				;
    140	000124	012021 				MOV	(R0)+,(R1)+	; SETUP I/D
    141	000126	012021 				MOV	(R0)+,(R1)+	;
    142	000130	012021 				MOV	(R0)+,(R1)+	;
    143	000132					RETURN			;
    144
    145					;
    146					; SETUP THE FILENAME PORTION OF THE FDB
    147					; LEAVE R0 POINTING TO I/D.
    148					;
    149
    150	000134				STFN:				;
    151	000134	016061 	000000G	000000G		MOV	E$LSWT(R0),R$SWTH(R1) ; SET FILE SWITCH WORD
    152	000142	062700 	000000G			ADD	#E$LMND,R0	; POINT TO MODULE NAME TABLE
    153	000146	012061 	000136 			MOV	(R0)+,F.FNB+N.UNIT(R1) ; SET UNIT NUMBER
    154	000152	012061 	000134 			MOV	(R0)+,F.FNB+N.DVNM(R1) ; SET DEVICE NAME
    155	000156	012061 	000110 			MOV	(R0)+,F.FNB+N.FNAM(R1) ; SET FILE NAME
    156	000162	012061 	000112 			MOV	(R0)+,F.FNB+N.FNAM+2(R1) ;
    157	000166	012061 	000114 			MOV	(R0)+,F.FNB+N.FNAM+4(R1) ;
    158	000172	012061 	000116 			MOV	(R0)+,F.FNB+N.FTYP(R1) ; SET FILE TYPE
    159	000176	012061 	000120 			MOV	(R0)+,F.FNB+N.FVER(R1) ; SET FILE VERSION
    160	000202					RETURN			;
    161					;
    162					;+
    163					; **-$STRCB-SETUP RECORD BLOCK
    164					; **-$STFDB-RECORD FDB ADDRESS
    165					;
    166					;	THIS ROUTINE IS CALLED TO SETUP A RECORD BLOCK FOR
    167					; A FILE TO BE OPENED. THE BLOCK ADDRESS IS PUSHED ONTO
    168					; A LIST OF OPEN FDB'S SO THAT FILES MAY BE PROPERLY
    169					; CLOSED WHEN A TASK BUILD IS ABORTED. OPTIONALLY, AN FCS
    170					; BLOCK BUFFER POOL IS ESTABLISHED AND THE
    171					; FILENAME BLOCK IS SETUP. A CO-ROUTINE CALL IS MADE TO
STFDB	MACRO M1110  22-AUG-78 02:00  PAGE 3-3


    172					; THE CALLER. ON RETURN, THE RECORD BLOCK ADDRESS IS POP-
    173					; PED FROM THE LIST.
    174					;
    175					; IF $STFDB IS CALLED, ONLY THE RECORD BLOCK ADDRESS IS PUSHED; ALL
    176					; OTHER SETUP OPERATIONS ARE OMITTED.
    177					;
    178					;	IN THE EVENT OF AN ABORT, A POP-CLOSE IS DONE ON
    179					; EACH POINTER IN THE LIST VIA A CALL TO $POPCL.
    180					;
    181					; INPUTS:
    182					;
    183					;	R0=RECORD BLOCK POINTER
    184					;
    185					; OUTPUTS:
    186					;
    187					;	THE NAME BLOCK AND BUFFER POOL ARE SETUP AS REQUIRED
    188					;	THE RECORD BLOCK ADDRESS IS PUSHED ONTO THE LIST OF RESIDENT BLOCKS.
    189					;-
    190
    191						.ENABL	LSB
    192
    193	000204				$STFDB::			;
    194	000204	010046 				MOV	R0,-(SP)	; COPY FDB ADDRESS
    195	000206	000417 				BR	20$		; PUSH ON RECORD BLOCK LIST
    196
    197	000210				$STRCB::			;
    198	000210	010046 				MOV	R0,-(SP)	; SAVE RECORD BLOCK POINTER                     ;**NEW**
    199	000212	017001 	000000G			MOV	@R$NMBK(R0),R1	; GET VIRTUAL ADDRESS OF NAMEBLOCK              ;**NEW**
    200	000216	001405 				BEQ	10$		; IF EQ NONE                                    ;**-3
    201	000220					CALL	$CVRL		; CONVERT TO REAL ADDRESS                       ;**NEW**
    202	000224	011601 				MOV	(SP),R1		; GET ADDRESS OF RECORD BLOCK                   ;**NEW**
    203	000226					CALL	$STFNB		; SETUP FILENAME BLOCK
    204	000232				10$:				;
    205	000232	011600 				MOV	(SP),R0		; RETRIEVE RECORD BLOCK ADDRESS
    206	000234	016000 	000000G			MOV	R$BLKB(R0),R0	; GET ADDRESS OF BLOCK BUFFER
    207	000240	001402 				BEQ	20$		; IF EQ NONE
    208	000242					CALL	$STBLK		; SETUP BLOCK BUFFER POINTER
    209	000246				20$:				;
    210	000246	062767 	177776 	177536 		ADD	#-2,RCBPT	; PUSH RECORD BLOCK POINTER
    211	000254	012677 	177532 			MOV	(SP)+,@RCBPT	; SAVE BLOCK ADDRESS
    212	000260					CALL	@(SP)+		; CALL THE CALLER
    213	000262	062767 	000002 	177522 		ADD	#+2,RCBPT	; POP RECORD BLOCK POINTER
    214	000270					RETURN			;
    215
    216						.DSABL	LSB
    217
    218		000001 				.END
STFDB	MACRO M1110  22-AUG-78 02:00  PAGE 3-4
SYMBOL TABLE

B.BBFS= 000010   	FD.MNT= 100000   	F.BKEF= 000050   	F.RTYP= 000000   	R$BLKB= ****** GX
B.BFST= 000015   	FD.OSP= 004000   	F.BKP1= 000051   	F.SEQN= 000100   	R$NMBK= ****** GX
B.NXBD= 000012   	FD.PLC= 000004   	F.BKST= 000024   	F.SPDV= 000072   	R$SWTH= ****** GX
B.VBN = 000004   	FD.PRN= 000004   	F.BKVB= 000064   	F.SPUN= 000074   	R$$11M= 000000
CH.AND= 000001   	FD.PSE= 010000   	F.CHR = 000075   	F.STBK= 000036   	R.FIX = 000001
CR    = 000015   	FD.RAH= 000001   	F.CNTG= 000034   	F.UNIT= 000136   	R.SEQ = 000003
E$LMND= ****** GX	FD.RAN= 000002   	F.DFNB= 000046   	F.URBD= 000020   	R.VAR = 000002
E$LNUM= ****** GX	FD.REC= 000001   	F.DSPT= 000044   	F.VBN = 000064   	SPA   = 000040
E$LSWT= ****** GX	FD.RWM= 000001   	F.DVNM= 000134   	F.VBSZ= 000060   	STFN    000134R
FA.APD= 000100   	FD.SDI= 000020   	F.EFBK= 000010   	HT    = 000011   	S.BFHD= 000020
FA.CRE= 000010   	FD.SQD= 000040   	F.EFN = 000050   	LF    = 000012   	S.FATT= 000016
FA.DLK= 001000   	FD.TTY= 000004   	F.EOBB= 000032   	NB.DEV= 000200   	S.FDB = 000140
FA.ENB= 100000   	FD.WBH= 000002   	F.ERR = 000052   	NB.DIR= 000100   	S.FNAM= 000006
FA.EXC= 002000   	FF    = 000014   	F.FACC= 000043   	NB.NAM= 000004   	S.FNB = 000036
FA.EXT= 000004   	FF.CHR= 000005   	F.FFBY= 000014   	NB.SD1= 000400   	S.FNBW= 000017
FA.NSP= 000100   	FF.NV = 000003   	F.FNAM= 000110   	NB.SD2= 001000   	S.FNTY= 000004
FA.POS= 010000   	FF.POE= 000002   	F.FNB = 000102   	NB.SNM= 000040   	S.FTYP= 000002
FA.RD = 000001   	FF.RWD= 000001   	F.FTYP= 000116   	NB.STP= 000020   	S.NFEN= 000020
FA.RWD= 004000   	FF.RWF= 000006   	F.FVER= 000120   	NB.SVR= 000010   	VT    = 000013
FA.SEQ= 040000   	FF.SPC= 000004   	F.HIBK= 000004   	NB.TYP= 000002   	$CLSOD= ****** GX
FA.SHR= 000040   	FO.APD= 000106   	F.LUN = 000042   	NB.VER= 000001   	$CVRL = ****** GX
FA.TMP= 000020   	FO.MFY= 000002   	F.MBCT= 000054   	N.DID = 000024   	$ODLPT= ****** GX
FA.WCK= 020000   	FO.RD = 000001   	F.MBC1= 000055   	N.DVNM= 000032   	$POPCL  000014RG
FA.WRT= 000002   	FO.UPD= 000006   	F.MBFG= 000056   	N.FID = 000000   	$STBLK  000056RG
FD.BLK= 000010   	FO.WRT= 000016   	F.NRBD= 000024   	N.FNAM= 000006   	$STFDB  000204RG
FD.CCL= 000002   	F.ACTL= 000076   	F.NREC= 000030   	N.FTYP= 000014   	$STFNB  000076RG
FD.COM= 020000   	F.ALOC= 000040   	F.OVBS= 000030   	N.FVER= 000016   	$STRCB  000210RG
FD.CR = 000002   	F.BBFS= 000062   	F.RACC= 000016   	N.NEXT= 000022   	$$    = 000001
FD.DIR= 000010   	F.BDB = 000070   	F.RATT= 000001   	N.STAT= 000020   	.CLOSE= ****** G
FD.FTN= 000001   	F.BGBC= 000057   	F.RCNM= 000034   	N.UNIT= 000034   	.FSRPT= ****** GX
FD.F11= 040000   	F.BKDN= 000026   	F.RCTL= 000017   	PAR$$$= 000026   	...GBL= 000000
FD.INS= 000010   	F.BKDS= 000020   	F.RSIZ= 000002   	RCBPT   000012R  	...TPC= 000140
FD.ISP= 002000

. ABS.	000000	   000
      	000272	   001
ERRORS DETECTED:  0

VIRTUAL MEMORY USED:  2230 WORDS  ( 9 PAGES)
DYNAMIC MEMORY:  2772 WORDS  ( 10 PAGES)
ELAPSED TIME:  00:00:14
OBJ$:STFDB,LIS$:STFDB/-SP=SRC$:MACFLM,FCSPR,STFDB
