PCTRL	MACRO M1110  22-AUG-78 01:49  PAGE 2


      1						.TITLE	PCTRL
      2						.IDENT	/03/
      3					                                                                                ;**NEW**
      4					;                                                                               ;**NEW**
      5					; COPYRIGHT   1973,  DIGITAL  EQUIPMENT  CORP.,  MAYNARD,   MASS.               ;**NEW**
      6					; COPYRIGHT   1974,  DIGITAL  EQUIPMENT  CORP.,  MAYNARD,   MASS.               ;**NEW**
      7					; COPYRIGHT   1976,  DIGITAL  EQUIPMENT  CORP.,  MAYNARD,   MASS.
      8					;                                                                               ;**NEW**
      9					; THIS SOFTWARE IS FURNISHED TO PURCHASER UNDER A LICENSE FOR USE               ;**NEW**
     10					; ON A  SINGLE COMPUTER SYSTEM AND CAN BE COPIED (WITH INCLUSION                ;**NEW**
     11					; OF DEC'S COPYRIGHT NOTICE) ONLY FOR USE IN SUCH SYSTEM, EXCEPT                ;**NEW**
     12					; AS MAY OTHERWISE BE PROVIDED IN WRITING BY DEC.                               ;**NEW**
     13					;                                                                               ;**NEW**
     14					; THE  INFORMATION IN THIS DOCUMENT IS SUBJECT TO CHANGE WITHOUT                ;**NEW**
     15					; NOTICE AND  SHOULD NOT BE CONSTRUED AS A COMMITMENT BY DIGITAL                ;**NEW**
     16					; EQUIPMENT CORPORATION.                                                        ;**NEW**
     17					;                                                                               ;**NEW**
     18					; DEC  ASSUMES NO  RESPONSIBILITY  FOR  THE  USE  OR RELIABILITY                ;**NEW**
     19					; OF ITS  SOFTWARE ON  EQUIPMENT WHICH  IS NOT SUPPLIED BY DEC.                 ;**NEW**
     20					;                                                                               ;**NEW**
     21					; VERSION 03
     22					;                                                                               ;**NEW**
     23					; D. N. CUTLER/C. MONIA	18-MAR-74                                               ;**NEW**
     24					;                                                                               ;**NEW**
     25					; PHASE CONTROL ROUTINE                                                         ;**-13
     26					;
     27					; LOCAL DATA
     28					;
     29
     30	000000				$LVL::	.BLKW	1		; DISTANCE OF SEGMENT FROM ROOT
     31
     32					;+                                                                              ;**-13
     33					; **-$PCTRL-PHASE CONTROL
     34					;
     35					; THIS ROUTINE IS CALLED TO CONTROL THE PROCESSING OF ALL SEG-
     36					; MENTS IN ALL PHASES. AS EACH SEGMENT IS CONSIDERED, A PHASE
     37					; DEPENDENT ROUTINE IS CALLED.
     38					;
     39					; INPUTS:
     40					;
     41					;	R0=ADDRESS OF PHASE DEPENDENT ROUTINE.
     42					;
     43					; OUTPUTS:
     44					;
     45					;	$CRSEG=REAL ADDRESS OF CURRENT SEGMENT DESCRIPTOR                       ;**NEW**
     46					;	$CRVSG=VIRTUAL ADDRESS OF SEGMENT DESCRIPTOR                            ;**NEW**
     47					;	$LVL=DISTANCE OF SEGMENT FROM ROOT (0=ROOT LEVEL)
     48					;                                                                               ;**NEW**
     49					; THE PAGE CONTAINING THE DESCRIPTOR IS LOCKED IN MEMORY AND UNLOCKED           ;**NEW**
     50					; ON RETURN FROM THE CALLED ROUTINE.                                            ;**NEW**
     51					;                                                                               ;**NEW**
     52					;-                                                                              ;**-1
     53
     54	000002				$PCTRL::SAVRG			; SAVE NON VOLATILE REGISTERS                   ;**NEW**
     55	000006	010005 				MOV	R0,R5		; SAVE SUBROUTINE ADDRESS                       ;**NEW**
     56	000010	012767 	177777 	177762 		MOV	#-1,$LVL	; INITIALIZE LEVEL COUNT
     57	000016	005046 				CLR	-(SP)		; SET ZERO SENTINEL WORD                        ;**NEW**
PCTRL	MACRO M1110  22-AUG-78 01:49  PAGE 2-1


     58	000020	016746 	000000G			MOV	$RTSEG,-(SP)	; PUSH VIRTUAL ADDRESS OF ROOT                  ;**NEW**
     59	000024				10$:				;                                               ;**NEW**
     60	000024	005267 	177750 			INC	$LVL		; INCREMENT LEVEL COUNT
     61	000030	011646 				MOV	(SP),-(SP)	; SET SENTINEL AT THIS LEVEL                    ;**NEW**
     62	000032				20$:				;                                               ;**NEW**
     63	000032	011601 				MOV	(SP),R1		; GET VIRTUAL ADDRESS OF CURRENT                ;**NEW**
     64	000034					CALL	$CVLOK		; CONVERT TO REAL ADDRESS, LOCK IN MEMORY       ;**NEW**
     65	000040	010067 	000000G			MOV	R0,$CRSEG	; SAVE REAL ADDRESS OF CURRENT                  ;**NEW**
     66	000044	010167 	000000G			MOV	R1,$CRVSG	; SAVE VIRTUAL ADDRESS OF CURRENT               ;**NEW**
     67	000050					CALL	(R5)		; CALL SUBROUTINE                               ;**NEW**
     68	000052	011601 				MOV	(SP),R1		; GET VIRTUAL ADDRESS OF CURRENT                ;**NEW**
     69	000054					CALL	$CVRL		; CONVERT TO REAL ADDRESS                       ;**NEW**
     70	000060					CALL	$UNLPG		; UNLOCK PAGE                                   ;**NEW**
     71	000064	016046 	000000G			MOV	S$GUP(R0),-(SP)	; PUSH LINK-UP                                  ;**NEW**
     72	000070	001355 				BNE	10$		; IF NE HAVE LINK UP                            ;**NEW**
     73	000072	005726 				TST	(SP)+		; REMOVE ZERO WORD                              ;**NEW**
     74	000074				30$:				;                                               ;**NEW**
     75	000074	016016 	000000G			MOV	S$GNXT(R0),(SP) ; REPLACE TOS WITH LINK-NEXT                    ;**NEW**
     76	000100	021666 	000002 			CMP	(SP),2(SP)	; CHECK TOS AGAINST SENTINEL                    ;**NEW**
     77	000104	001352 				BNE	20$		; IN NE, VALID LINK-NEXT                        ;**NEW**
     78	000106	022626 				CMP	(SP)+,(SP)+	; DONE ALL ENTRIES AT THIS LEVEL                ;**NEW**
     79	000110	005367 	177664 			DEC	$LVL		; DECREMENT LEVEL COUNT
     80	000114	011601 				MOV	(SP),R1		; GET VIRTUAL ADDRESS OF OLD CURRENT            ;**NEW**
     81	000116	001403 				BEQ	40$		; IF EQ DONE                                    ;**NEW**
     82	000120					CALL	$CVRL		; CONVERT TO REAL ADDRESS	                ;**NEW**
     83	000124	000763 				BR	30$		; SCAN ENTRIES AT NEXT LOWEST LEVEL             ;**NEW**
     84	000126				40$:				;                                               ;**NEW**
     85	000126	005726 				TST	(SP)+		; POP ZERO SENTINEL WORD                        ;**NEW**
     86	000130					RETURN			;                                               ;**NEW**
     87					                                                                                ;**-45
     88		000001 				.END
PCTRL	MACRO M1110  22-AUG-78 01:49  PAGE 2-2
SYMBOL TABLE

CR    = 000015   	R$$11M= 000000   	VT    = 000013   	$CVRL = ****** GX	$SAVRG= ****** GX
FF    = 000014   	SPA   = 000040   	$CRSEG= ****** GX	$LVL    000000RG 	$UNLPG= ****** GX
HT    = 000011   	S$GNXT= ****** GX	$CRVSG= ****** GX	$PCTRL  000002RG 	$$    = 000001
LF    = 000012   	S$GUP = ****** GX	$CVLOK= ****** GX	$RTSEG= ****** GX

. ABS.	000000	   000
      	000132	   001
ERRORS DETECTED:  0

VIRTUAL MEMORY USED:  615 WORDS  ( 3 PAGES)
DYNAMIC MEMORY:  2772 WORDS  ( 10 PAGES)
ELAPSED TIME:  00:00:06
OBJ$:PCTRL,LIS$:PCTRL/-SP=SRC$:MACFLM,PCTRL
