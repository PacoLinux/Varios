RQVCB	MACRO M1110  22-AUG-78 01:58  PAGE 2


      1						.TITLE	RQVCB
      2						.IDENT	/00/
      3
      4					;
      5					; COPYRIGHT   1974,  DIGITAL  EQUIPMENT  CORP.,  MAYNARD,   MASS.
      6					;
      7					; THIS SOFTWARE IS FURNISHED TO PURCHASER UNDER A LICENSE FOR USE
      8					; ON A  SINGLE COMPUTER SYSTEM AND CAN BE  COPIED (WITH INCLUSION
      9					; OF DEC'S COPYRIGHT  NOTICE) ONLY FOR USE IN SUCH SYSTEM, EXCEPT
     10					; AS MAY OTHERWISE BE PROVIDED IN WRITING BY DEC.
     11					;
     12					; THE  INFORMATION  IN THIS DOCUMENT IS SUBJECT TO CHANGE WITHOUT
     13					; NOTICE  AND  SHOULD NOT BE CONSTRUED AS A COMMITMENT BY DIGITAL
     14					; EQUIPMENT CORPORATION.
     15					;
     16					; DEC  ASSUMES NO  RESPONSIBILITY  FOR  THE  USE  OR  RELIABILITY
     17					; OF  ITS  SOFTWARE ON  EQUIPMENT WHICH  IS  NOT SUPPLIED BY DEC.
     18					;
     19					; VERSION 00
     20					;
     21					; C. MONIA 22-FEB-74
     22					;
     23					; REQUEST VIRTUAL CORE BLOCK
     24					;
     25					;+
     26					; **-$RQVCB-REQUEST VIRTUAL MEMORY ALLOCATION
     27					;
     28					; INPUTS:
     29					;
     30					;	R1=ALLOCATION REQUEST IN BYTES (</= 512.)
     31					;	$HGVAD=NEXT FREE VIRTUAL ADDRESS
     32					;
     33					; OUTPUTS:
     34					;
     35					;	C-CLEAR: REQUEST SUCCEEDED.
     36					;
     37					;	R1=VIRTUAL ADDRESS OF REQUESTED BLOCK
     38					;	$HGVAD=UPDATED VALUE OF NEXT FREE ADDRESS
     39					;
     40					;	C-SET: REQUEST FAILED
     41					;
     42					;	FAILURE CONDITIONS:
     43					;
     44					;	(1) REQUEST EXCEEDED 512. BYTES
     45					;	(2) VIRTUAL STORAGE EXHAUSTED
     46					;
     47					; THIS ROUTINE IS CALLED TO ALLOCATE SPACE FROM VIRTUAL
     48					; MEMORY. THE ALLOCATION REQUEST IS ROUNDED UP TO THE
     49					; NEAREST WORD. IF THE ROUNDED VALUE CROSSES A DISK BLOCK
     50					; BOUNDRY THEN ALLOCATION BEGINS AT THE NEXT BLOCK.
     51					;
     52					;		*** NOTE ***
     53					;
     54					; VIRTUAL ADDRESSES ARE WORD VALUES.
     55					;-
     56
     57	000000				$RQVCB::			;
RQVCB	MACRO M1110  22-AUG-78 01:58  PAGE 2-1


     58	000000	010102 				MOV	R1,R2		; SAVE LENGTH
     59	000002	016701 	000000G			MOV	$HGVAD,R1	; GET HIGHEST VIRTUAL ADDRESS
     60	000006	001424 				BEQ	20$		; IF EQ NO SPACE LEFT
     61	000010	000241 				CLC			; CLEAR CARRY
     62	000012	006002 				ROR	R2		; DO UNSIGNED DIVIDE
     63	000014	005502 				ADC	R2		; ROUND UP TO NEAREST WORD
     64	000016	020227 	000400 			CMP	R2,#256.	; CHECK LENGTH OF REQUEST
     65	000022	101016 				BHI	20$		; IF HIGH, TOO BIG
     66	000024	005302 				DEC	R2		; BACK OFF SIZE BY ONE
     67	000026	010100 				MOV	R1,R0		; COPY FREE ADDRESS
     68	000030	060200 				ADD	R2,R0		; COMPUTE LAST ADDRESS IN ALLOCATION
     69	000032	103413 				BCS	30$		; IF C/S ADDRESS SPACE OVERFLOW
     70	000034	105000 				CLRB	R0		; CLEAR DISPLACEMENT INTO BLOCK
     71	000036	020001 				CMP	R0,R1		; SEE IF CROSSING BLOCK BOUNDRY
     72	000040	101401 				BLOS	10$		; IF LOS NO
     73	000042	010001 				MOV	R0,R1		; SET VIRTUAL ADDRESS
     74	000044				10$:				;
     75	000044	005202 				INC	R2		; CONVERT BACK TO LENGTH
     76	000046	060102 				ADD	R1,R2		; COMPUTE NEXT FREE ADDRESS
     77	000050	010267 	000000G			MOV	R2,$HGVAD	; UPDATE FREE ADDRESS
     78	000054	000241 				CLC			; SET SUCCESS
     79	000056	000401 				BR	30$		; EXIT
     80	000060				20$:				;
     81	000060	000261 				SEC			; SET FAILURE
     82	000062				30$:				;
     83	000062					RETURN			;
     84
     85		000001 				.END
RQVCB	MACRO M1110  22-AUG-78 01:58  PAGE 2-2
SYMBOL TABLE

CR    = 000015   	HT    = 000011   	R$$11M= 000000   	VT    = 000013   	$RQVCB  000000RG
FF    = 000014   	LF    = 000012   	SPA   = 000040   	$HGVAD= ****** GX

. ABS.	000000	   000
      	000064	   001
ERRORS DETECTED:  0

VIRTUAL MEMORY USED:  550 WORDS  ( 3 PAGES)
DYNAMIC MEMORY:  2772 WORDS  ( 10 PAGES)
ELAPSED TIME:  00:00:06
OBJ$:RQVCB,LIS$:RQVCB/-SP=SRC$:MACFLM,RQVCB
