
; Bliss-32 10.1-416	Monday 21-AUG-1978 23:20:17	DBB3:[F11B.SRC]RETDIR.B32;6					Page 1
;
;	0001	MODULE RETDIR (
;	0002			LANGUAGE (BLISS32),
;	0003			IDENT = 'B0003A'
;	0004			) =
;	0005	BEGIN
;	0006	
;	0007	!
;	0008	! Copyright (c) 1977
;	0009	! Digital Equipment Corporation, Maynard, Massachusetts 01754
;	0010	!
;	0011	! This software is furnished  under a license for use only on a single
;	0012	! computer  system and  may be  copied only with  the inclusion of the
;	0013	! above copyright notice.  This software, or any other copies thereof,
;	0014	! may not be provided or  otherwise made available to any other person
;	0015	! except for use on such system and to one who agrees to these license
;	0016	! terms.  Title to and  ownership of the  software  shall at all times
;	0017	! remain in DEC.
;	0018	!
;	0019	! The information in this software is subject to change without notice
;	0020	! and should  not be construed  as a commitment  by Digital  Equipment
;	0021	! Corporation.
;	0022	!
;	0023	! DEC assumes  no  responsibility  for  the use or  reliability of its
;	0024	! software on equipment which is not supplied by DEC.
;	0025	
;	0026	!++
;	0027	!
;	0028	! FACILITY:  F11ACP Structure Level 2
;	0029	!
;	0030	! ABSTRACT:
;	0031	!
;	0032	!	This routine returns the resulting data from a directory
;	0033	!	operation to the user's buffer packet.
;	0034	!
;	0035	! ENVIRONMENT:
;	0036	!
;	0037	!	STARLET operating system, including privileged system services
;	0038	!	and internal exec routines. This routine must be called
;	0039	!	in kernel mode.
;	0040	!
;	0041	!--
;	0042	!
;	0043	!
;	0044	! AUTHOR:  Andrew C. Goldstein,	 CREATION DATE:  3-Jan-1977  15:07
;	0045	!
;	0046	! REVISION HISTORY:
;	0047	!
;	0048	!   Andrew C. Goldstein, 30-Mar-1977  17:44
;	0049	!   X0002 - Remove returning of FIB components
;	0050	!
;	0051	!   Andrew C. Goldstein, 16-Jan-1978  19:53
;	0052	!   X0003 - Modify for structure level 2
;	0053	!
;	0054	!**
;	0055	

; Bliss-32 10.1-416	Monday 21-AUG-1978 23:20:17	DBB3:[F11B.SRC]RETDIR.B32;6					Page 1-1
;
;	0056	
;	0057	LIBRARY 'SYS$LIBRARY:LIB.L32';
;	0058	REQUIRE 'SRC$:FCPDEF.B32';

; Bliss-32 10.1-416	Monday 21-AUG-1978 23:20:17	DBB3:[F11B.SRC]RETDIR.B32;6					Page 2
;
;	0407	GLOBAL ROUTINE RETURN_DIR (COUNT, STRING, ABD) : NOVALUE =
;	0408	
;	0409	!++
;	0410	!
;	0411	! FUNCTIONAL DESCRIPTION:
;	0412	!
;	0413	!	This routine returns the resulting data from a directory
;	0414	!	operation to the user's buffer packet.
;	0415	!
;	0416	! CALLING SEQUENCE:
;	0417	!	RETURN_DIR (ARG1, ARG2, ARG3)
;	0418	!
;	0419	! INPUT PARAMETERS:
;	0420	!	ARG1: byte count of result string
;	0421	!	ARG2: address of result string
;	0422	!	ARG3: address of buffer descriptors
;	0423	!
;	0424	! IMPLICIT INPUTS:
;	0425	!	DIR_ENTRY: address of directory record
;	0426	!	DIR_VERSION: address of version entry
;	0427	!
;	0428	! OUTPUT PARAMETERS:
;	0429	!	NONE
;	0430	!
;	0431	! IMPLICIT OUTPUTS:
;	0432	!	NONE
;	0433	!
;	0434	! ROUTINE VALUE:
;	0435	!	NONE
;	0436	!
;	0437	! SIDE EFFECTS:
;	0438	!	result data written into buffer packet
;	0439	!
;	0440	!--
;	0441	
;	0442	BEGIN
;	0443	
;	0444	MAP
;	0445		STRING		: REF VECTOR [,BYTE], ! file string arg
;	0446		ABD		: REF BBLOCKVECTOR [,ABD$C_LENGTH];
;	0447						! descriptor arg
;	0448	
;	0449	LOCAL
;	0450		STRING_DESC	: VECTOR [2];	! FAO output string descriptor
;	0451	
;	0452	EXTERNAL
;	0453		DIR_ENTRY	: REF BBLOCK,	! address of directory record
;	0454		DIR_VERSION	: REF BBLOCK;	! address of version entry
;	0455	
;	0456	
;	0457	! Build the file name string in the buffer supplied.
;	0458	!
;	0459	
;	0460	.COUNT = 0;
;	0461	STRING_DESC[0] = FILENAME_LENGTH;

; Bliss-32 10.1-416	Monday 21-AUG-1978 23:20:17	DBB3:[F11B.SRC]RETDIR.B32;6					Page 2-1
;
;	0462	STRING_DESC[1] = .STRING;
;	0463	$FAO (DESCRIPTOR ('!AC;!SW'),
;     P 0464		.COUNT,
;     P 0465		STRING_DESC,
;     P 0466		DIR_ENTRY[DIR$B_NAMECOUNT],
;     P 0467		.DIR_VERSION[DIR$W_VERSION]
;     P 0468		);
;	0469	
;	0470	! If the user provided a result length buffer, give him the length
;	0471	! of the result string.
;	0472	!
;	0473	
;	0474	IF .ABD[ABD$C_RESL, ABD$W_COUNT] GEQ 2
;	0475	THEN
;	0476	    BEGIN
;	0477	    (.ABD[ABD$C_RESL, ABD$W_TEXT] + ABD[ABD$C_RESL, ABD$W_TEXT] + 1)<0,16> = ..COUNT;
;	0478	    END;
;	0479	
;	0480	! If the user provided a result string buffer, return as much of the
;	0481	! result string as will fit (zero filling the buffer).
;	0482	!
;	0483	
;	0484	CH$COPY (..COUNT, .STRING, 0,
;	0485	    .ABD[ABD$C_RES, ABD$W_COUNT],
;	0486	    .ABD[ABD$C_RES, ABD$W_TEXT] + ABD[ABD$C_RES, ABD$W_TEXT] + 1);
;	0487	
;	0488	END;					! end of routine RETURN_DIR


							    .TITLE  RETDIR
							    .IDENT  \B0003A\

							    .PSECT  $CODE$,NOWRT,2

		  57  53  21  3B  43  41  21  00000 P.AAB:  .ASCII  \!AC;!SW\						      ;
					      00007	    .BLKB   1
				    00000007  00008 P.AAA:  .LONG   7							      ;
				    00000000' 0000C 	    .ADDRESS P.AAB						      ;

							    .EXTRN  DIR_ENTRY, DIR_VERSION, SYS$FAO

					 003C 00010 	    .ENTRY  RETURN_DIR, Save R2,R3,R4,R5			      ; 0407
		         5E 	       04  C2 00012 	    SUBL2   #4, SP						      ;
				  04   BC  D4 00015 	    CLRL    @COUNT						      ; 0460
				       14  DD 00018 	    PUSHL   #20							      ; 0461
		    04   AE	  08   AC  D0 0001A 	    MOVL    STRING, STRING_DESC+4				      ; 0462
		         7E 	0000G  DF  32 0001F 	    CVTWL   @DIR_VERSION, -(SP)					      ; 0468
	   7E 	  0000G  CF	       05  C1 00024 	    ADDL3   #5, DIR_ENTRY, -(SP)				      ;
				  08   AE  9F 0002A 	    PUSHAB  STRING_DESC						      ;
				  04   AC  DD 0002D 	    PUSHL   COUNT						      ;
				  D5   AF  9F 00030 	    PUSHAB  P.AAA						      ;
	      00000000G  9F	       05  FB 00033 	    CALLS   #5, @#SYS$FAO					      ;
		         52 	  0C   AC  D0 0003A 	    MOVL    ABD, R2						      ; 0474
		         02 	  1A   A2  B1 0003E 	    CMPW    26(R2), #2						      ;
				       0F  1F 00042 	    BLSSU   1$							      ;

; Bliss-32 10.1-416	Monday 21-AUG-1978 23:20:17	DBB3:[F11B.SRC]RETDIR.B32;6					Page 2-2
;
		         51 	  18   A2  9E 00044 	    MOVAB   24(R2), R1						      ; 0477
		         50 	       61  3C 00048 	    MOVZWL  (R1), R0						      ;
				  01 A140  9F 0004B 	    PUSHAB  1(R1)[R0]						      ;
		         9E 	  04   BC  B0 0004F 	    MOVW    @COUNT, @(SP)+					      ;
		         51 	  20   A2  9E 00053 1$:     MOVAB   32(R2), R1						      ; 0486
		         50 	       61  3C 00057 	    MOVZWL  (R1), R0						      ;
	   00 	    08   BC	  04   BC  2C 0005A 	    MOVC5   @COUNT, @STRING, #0, 34(R2), 1(R1)[R0]		      ; 0484
		    01 A140	  22   A2     00060									      ;
					   04 00065 	    RET     							      ; 0407

; Routine Size:  86 bytes


;	0489	
;	0490	END
;	0491	ELUDOM






;				       PSECT SUMMARY
;
;	Name		 Bytes			       Attributes
;
;  $CODE$         	   102  NOWRT,  RD ,  EXE,NOSHR,  LCL,  REL,  CON,NOPIC,ALIGN(2)




;				LIBRARY STATISTICS
;
;					     -------- Symbols --------    Blocks
;	File				     Total    Loaded   Percent      Read
;
;  DBA4:[SYSLIB]LIB.L32;1		      5582        15         0       228





; Size:		86 code + 16 data bytes
; Run Time:	00:05.0
; Elapsed Time:	00:14.1
; Memory Used:	265 pages
; Compilation Complete
