
; Bliss-32 10.1-416	Monday 21-AUG-1978 23:22:03	DBB3:[F11B.SRC]SNDBAD.B32;11					Page 1
;
;	0001	MODULE SNDBAD (
;	0002			LANGUAGE (BLISS32),
;	0003			IDENT = 'B0003C'
;	0004			) =
;	0005	BEGIN
;	0006	
;	0007	!
;	0008	! Copyright (c) 1977
;	0009	! Digital Equipment Corporation, Maynard, Massachusetts 01754
;	0010	!
;	0011	! This software is furnished  under a license for use only on a single
;	0012	! computer  system and  may be  copied only with  the inclusion of the
;	0013	! above copyright notice.  This software, or any other copies thereof,
;	0014	! may not be provided or  otherwise made available to any other person
;	0015	! except for use on such system and to one who agrees to these license
;	0016	! terms.  Title to and  ownership of the  software  shall at all times
;	0017	! remain in DEC.
;	0018	!
;	0019	! The information in this software is subject to change without notice
;	0020	! and should  not be construed  as a commitment  by Digital  Equipment
;	0021	! Corporation.
;	0022	!
;	0023	! DEC assumes  no  responsibility  for  the use or  reliability of its
;	0024	! software on equipment which is not supplied by DEC.
;	0025	
;	0026	!++
;	0027	!
;	0028	! FACILITY:  F11ACP Structure Level 2
;	0029	!
;	0030	! ABSTRACT:
;	0031	!
;	0032	!	This routine sends a message to the bad block analysis program to
;	0033	!	deal with a file that is marked bad.
;	0034	!
;	0035	! ENVIRONMENT:
;	0036	!
;	0037	!	STARLET operating system, including privileged system services
;	0038	!	and internal exec routines.
;	0039	!
;	0040	!--
;	0041	!
;	0042	!
;	0043	! AUTHOR:  Andrew C. Goldstein,	 CREATION DATE:  26-May-1978  14:50
;	0044	!
;	0045	! REVISION HISTORY:
;	0046	!
;	0047	!   Andrew C. Goldstein, 31-May-78  16:03
;	0048	!   B0002 - Log files sent to bad block scanner
;	0049	!
;	0050	!   Andrew C. Goldstein, 14-Jun-78  13:24
;	0051	!   B0003 - Give input terminal name for BADBLOCK utility
;	0052	!
;	0053	!**
;	0054	
;	0055	

; Bliss-32 10.1-416	Monday 21-AUG-1978 23:22:03	DBB3:[F11B.SRC]SNDBAD.B32;11					Page 1-1
;
;	0056	LIBRARY 'SYS$LIBRARY:LIB.L32';
;	0057	REQUIRE 'SRC$:FCPDEF.B32';

; Bliss-32 10.1-416	Monday 21-AUG-1978 23:22:03	DBB3:[F11B.SRC]SNDBAD.B32;11					Page 2
;
;	0406	GLOBAL ROUTINE SEND_BADSCAN (FID) : NOVALUE =
;	0407	
;	0408	!++
;	0409	!
;	0410	! FUNCTIONAL DESCRIPTION:
;	0411	!
;	0412	!	This routine sends a message to the bad block analysis program to
;	0413	!	deal with a file that is marked bad.
;	0414	!
;	0415	!
;	0416	! CALLING SEQUENCE:
;	0417	!	SEND_BADSCAN (ARG1)
;	0418	!
;	0419	! INPUT PARAMETERS:
;	0420	!	ARG1: address of file ID of file
;	0421	!
;	0422	! IMPLICIT INPUTS:
;	0423	!	CURRENT_UCB: UCB of device containing file
;	0424	!
;	0425	! OUTPUT PARAMETERS:
;	0426	!	NONE
;	0427	!
;	0428	! IMPLICIT OUTPUTS:
;	0429	!	NONE
;	0430	!
;	0431	! ROUTINE VALUE:
;	0432	!	NONE
;	0433	!
;	0434	! SIDE EFFECTS:
;	0435	!	bad block scan process started
;	0436	!
;	0437	!--
;	0438	
;	0439	BEGIN
;	0440	
;	0441	MAP
;	0442		FID		: REF BBLOCK;	! file ID argument
;	0443	
;	0444	LOCAL
;	0445		MESSAGE		: BBLOCK [BBS$C_LENGTH], ! message buffer
;	0446		MBX_CHANNEL	: WORD;		! channel number for mailbox
;	0447	
;	0448	OWN
;	0449		MESSAGE_INDEX,			! message index number
;	0450		MBX_STATUS	: VECTOR [2];	! mailbox I/O status block
;	0451	
;	0452	EXTERNAL
;	0453		CURRENT_UCB	: REF BBLOCK;	! UCB of current device
;	0454	
;	0455	EXTERNAL ROUTINE
;	0456		SCAN_BADLOG;			! scan bad block log file
;	0457	
;	0458	
;	0459	! Construct the message in the message buffer.
;	0460	!

; Bliss-32 10.1-416	Monday 21-AUG-1978 23:22:03	DBB3:[F11B.SRC]SNDBAD.B32;11					Page 2-1
;
;	0461	
;	0462	MESSAGE_INDEX = .MESSAGE_INDEX + 1;
;	0463	
;	0464	CH$FILL (0, BBS$C_LENGTH, MESSAGE);
;	0465	MESSAGE[BBS$B_MSGTYPE] = MSG$_SCANBAD;
;	0466	MESSAGE[BBS$W_SEQUENCE] = .MESSAGE_INDEX;
;	0467	MESSAGE[BBS$L_UCB] = .CURRENT_UCB;
;	0468	CH$MOVE (FID$C_LENGTH, .FID, MESSAGE[BBS$W_FID]);
;	0469	
;	0470	! **** Temporary: Enter the file in the volume pending bad block log file
;	0471	! to keep track of work sent to the scanner.
;	0472	!
;	0473	
;	0474	SCAN_BADLOG (MESSAGE[BBS$W_FID], -1, -1, ENTER_READERR, 0);
;	0475	
;	0476	! Assign a channel to the bad block scanner mailbox. Note that we simply
;	0477	! give up on errors - the file will be left marked for delete and bad and
;	0478	! can be picked up and retried later.
;	0479	!
;	0480	
;	0481	IF NOT $ASSIGN (CHAN = MBX_CHANNEL,
;     P 0482			DEVNAM = DESCRIPTOR ('ACP$BADBLOCK_MBX'))
;	0483	THEN RETURN;
;	0484	
;	0485	! Send the message. Then attempt to create the bad block scan process. If one
;	0486	! is already active, the create will fail due to duplicate process names,
;	0487	! and the message will simply be queued.
;	0488	!
;	0489	
;	0490	IF $QIO	(CHAN = .MBX_CHANNEL,
;     P 0491		 FUNC = IO$_WRITELBLK OR IO$M_NOW,
;     P 0492		 EFN  = MBX_EFN,
;     P 0493		 IOSB = MBX_STATUS,
;     P 0494		 P1   = MESSAGE,
;     P 0495		 P2   = BBS$C_LENGTH
;     P 0496		)
;	0497	THEN $CREPRC (
;     P 0498		IMAGE  = DESCRIPTOR ('SYS$SYSTEM:BADBLOCK.EXE'),
;     P 0499		INPUT  = DESCRIPTOR ('_TTA1:'),
;     P 0500		OUTPUT = DESCRIPTOR ('_TTA1:'),
;     P 0501		ERROR  = DESCRIPTOR ('_TTA1:'),
;     P 0502		PRVADR = UPLIT (-1, -1),
;     P 0503		PRCNAM = DESCRIPTOR ('BADBLOCK_SCAN'),
;     P 0504		BASPRI = 4,
;     P 0505		UIC    = 1^16 + 3
;     P 0506		);
;	0507	
;	0508	$DASSGN (CHAN = .MBX_CHANNEL);
;	0509	
;	0510	END;					! end of routine SEND_BADSCAN


							    .TITLE  SNDBAD
							    .IDENT  \B0003C\


; Bliss-32 10.1-416	Monday 21-AUG-1978 23:22:03	DBB3:[F11B.SRC]SNDBAD.B32;11					Page 2-2
;
							    .PSECT  $CODE$,NOWRT,2

  43  4F  4C  42  44  41  42  24  50  43  41  00000 P.AAB:  .ASCII  \ACP$BADBLOCK_MBX\					      ;
			  58  42  4D  5F  4B  0000B									      ;
				    00000010  00010 P.AAA:  .LONG   16							      ;
				    00000000' 00014 	    .ADDRESS P.AAB						      ;
  3A  4D  45  54  53  59  53  24  53  59  53  00018 P.AAD:  .ASCII  \SYS$SYSTEM:BADBLOCK.EXE\				      ;
  58  45  2E  4B  43  4F  4C  42  44  41  42  00023									      ;
					  45  0002E									      ;
					      0002F	    .BLKB   1
				    00000017  00030 P.AAC:  .LONG   23							      ;
				    00000000' 00034 	    .ADDRESS P.AAD						      ;
		      3A  31  41  54  54  5F  00038 P.AAF:  .ASCII  \_TTA1:\						      ;
					      0003E	    .BLKB   2
				    00000006  00040 P.AAE:  .LONG   6							      ;
				    00000000' 00044 	    .ADDRESS P.AAF						      ;
		      3A  31  41  54  54  5F  00048 P.AAH:  .ASCII  \_TTA1:\						      ;
					      0004E	    .BLKB   2
				    00000006  00050 P.AAG:  .LONG   6							      ;
				    00000000' 00054 	    .ADDRESS P.AAH						      ;
		      3A  31  41  54  54  5F  00058 P.AAJ:  .ASCII  \_TTA1:\						      ;
					      0005E	    .BLKB   2
				    00000006  00060 P.AAI:  .LONG   6							      ;
				    00000000' 00064 	    .ADDRESS P.AAJ						      ;
			  FFFFFFFF  FFFFFFFF  00068 P.AAK:  .LONG   -1, -1						      ;
  43  53  5F  4B  43  4F  4C  42  44  41  42  00070 P.AAM:  .ASCII  \BADBLOCK_SCAN\					      ;
				      4E  41  0007B									      ;
					      0007D	    .BLKB   3
				    0000000D  00080 P.AAL:  .LONG   13							      ;
				    00000000' 00084 	    .ADDRESS P.AAM						      ;

							    .PSECT  $LOCKEDD1$,NOEXE,2

					      00000 MESSAGE_INDEX:
							    .BLKB   4
					      00004 MBX_STATUS:
							    .BLKB   8

							    .EXTRN  CURRENT_UCB, SCAN_BADLOG, SYS$ASSIGN, SYS$QIO
							    .EXTRN  SYS$CREPRC, SYS$DASSGN

							    .PSECT  $CODE$,NOWRT,2

					 007C 00088 	    .ENTRY  SEND_BADSCAN, Save R2,R3,R4,R5,R6			      ; 0406
		         56 	  83   AF  9E 0008A 	    MOVAB   P.AAA, R6						      ;
		         5E 	       18  C2 0008E 	    SUBL2   #24, SP						      ;
				0000'  CF  D6 00091 	    INCL    MESSAGE_INDEX					      ; 0462
	   00 	         6E 	       00  2C 00095 	    MOVC5   #0, (SP), #0, #18, MESSAGE				      ; 0464
		    04   AE	       12     00099									      ;
		    04   AE	       28  90 0009C 	    MOVB    #40, MESSAGE					      ; 0465
		    08   AE	0000'  CF  B0 000A0 	    MOVW    MESSAGE_INDEX, MESSAGE+4				      ; 0466
		    0C   AE	0000G  CF  D0 000A6 	    MOVL    CURRENT_UCB, MESSAGE+8				      ; 0467
      10   AE	    04   BC	       06  28 000AC 	    MOVC3   #6, @FID, MESSAGE+12				      ; 0468
		         7E 	       01  7D 000B2 	    MOVQ    #1, -(SP)						      ; 0474
		         7E 	       01  CE 000B5 	    MNEGL   #1, -(SP)						      ;

; Bliss-32 10.1-416	Monday 21-AUG-1978 23:22:03	DBB3:[F11B.SRC]SNDBAD.B32;11					Page 2-3
;
		         7E 	       01  CE 000B8 	    MNEGL   #1, -(SP)						      ;
				  20   AE  9F 000BB 	    PUSHAB  MESSAGE+12						      ;
		  0000G  CF	       05  FB 000BE 	    CALLS   #5, SCAN_BADLOG					      ;
				       7E  7C 000C3 	    CLRQ    -(SP)						      ; 0482
				  08   AE  9F 000C5 	    PUSHAB  MBX_CHANNEL						      ;
				       56  DD 000C8 	    PUSHL   R6							      ;
	      00000000G  9F	       04  FB 000CA 	    CALLS   #4, @#SYS$ASSIGN					      ;
		         54 	       50  E9 000D1 	    BLBC    R0, 2$						      ;
				       7E  7C 000D4 	    CLRQ    -(SP)						      ; 0496
				       7E  7C 000D6 	    CLRQ    -(SP)						      ;
				       12  DD 000D8 	    PUSHL   #18							      ;
				  18   AE  9F 000DA 	    PUSHAB  MESSAGE						      ;
				       7E  7C 000DD 	    CLRQ    -(SP)						      ;
				0000'  CF  9F 000DF 	    PUSHAB  MBX_STATUS						      ;
		         7E 	  60   8F  9A 000E3 	    MOVZBL  #96, -(SP)						      ;
		         7E 	  28   AE  3C 000E7 	    MOVZWL  MBX_CHANNEL, -(SP)					      ;
				       02  DD 000EB 	    PUSHL   #2							      ;
	      00000000G  9F	       0C  FB 000ED 	    CALLS   #12, @#SYS$QIO					      ;
		         27 	       50  E9 000F4 	    BLBC    R0, 1$						      ;
				       7E  7C 000F7 	    CLRQ    -(SP)						      ; 0506
			    00010003   8F  DD 000F9 	    PUSHL   #65539						      ;
				       04  DD 000FF 	    PUSHL   #4							      ;
				  70   A6  9F 00101 	    PUSHAB  P.AAL						      ;
				       7E  D4 00104 	    CLRL    -(SP)						      ;
				  58   A6  9F 00106 	    PUSHAB  P.AAK						      ;
				  50   A6  9F 00109 	    PUSHAB  P.AAI						      ;
				  40   A6  9F 0010C 	    PUSHAB  P.AAG						      ;
				  30   A6  9F 0010F 	    PUSHAB  P.AAE						      ;
				  20   A6  9F 00112 	    PUSHAB  P.AAC						      ;
				       7E  D4 00115 	    CLRL    -(SP)						      ;
	      00000000G  9F	       0C  FB 00117 	    CALLS   #12, @#SYS$CREPRC					      ;
		         7E 	       6E  3C 0011E 1$:     MOVZWL  MBX_CHANNEL, -(SP)					      ; 0508
	      00000000G  9F	       01  FB 00121 	    CALLS   #1, @#SYS$DASSGN					      ;
					   04 00128 2$:     RET     							      ; 0406

; Routine Size:  161 bytes


;	0511	
;	0512	END
;	0513	ELUDOM






;				       PSECT SUMMARY
;
;	Name		 Bytes			       Attributes
;
;  $LOCKEDD1$     	    12    WRT,  RD ,NOEXE,NOSHR,  LCL,  REL,  CON,NOPIC,ALIGN(2)
;  $CODE$         	   297  NOWRT,  RD ,  EXE,NOSHR,  LCL,  REL,  CON,NOPIC,ALIGN(2)



; Bliss-32 10.1-416	Monday 21-AUG-1978 23:22:03	DBB3:[F11B.SRC]SNDBAD.B32;11					Page 2-4
;


;				LIBRARY STATISTICS
;
;					     -------- Symbols --------    Blocks
;	File				     Total    Loaded   Percent      Read
;
;  DBA4:[SYSLIB]LIB.L32;1		      5582        20         0       235





; Size:		161 code + 148 data bytes
; Run Time:	00:06.4
; Elapsed Time:	00:15.1
; Memory Used:	293 pages
; Compilation Complete
