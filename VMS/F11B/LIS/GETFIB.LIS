
; Bliss-32 10.1-416	Monday 21-AUG-1978 23:16:42	DBB3:[F11B.SRC]GETFIB.B32;6					Page 1
;
;	0001	MODULE GETFIB (
;	0002			LANGUAGE (BLISS32),
;	0003			IDENT = 'B0008'
;	0004			) =
;	0005	BEGIN
;	0006	
;	0007	!
;	0008	! Copyright (c) 1977
;	0009	! Digital Equipment Corporation, Maynard, Massachusetts 01754
;	0010	!
;	0011	! This software is furnished  under a license for use only on a single
;	0012	! computer  system and  may be  copied only with  the inclusion of the
;	0013	! above copyright notice.  This software, or any other copies thereof,
;	0014	! may not be provided or  otherwise made available to any other person
;	0015	! except for use on such system and to one who agrees to these license
;	0016	! terms.  Title to and  ownership of the  software  shall at all times
;	0017	! remain in DEC.
;	0018	!
;	0019	! The information in this software is subject to change without notice
;	0020	! and should  not be construed  as a commitment  by Digital  Equipment
;	0021	! Corporation.
;	0022	!
;	0023	! DEC assumes  no  responsibility  for  the use or  reliability of its
;	0024	! software on equipment which is not supplied by DEC.
;	0025	
;	0026	!++
;	0027	!
;	0028	! FACILITY:  F11ACP Structure Level 2
;	0029	!
;	0030	! ABSTRACT:
;	0031	!
;	0032	!	This routine obtains the address of the FIB for this operation.
;	0033	!
;	0034	! ENVIRONMENT:
;	0035	!
;	0036	!	STARLET operating system, including privileged system services
;	0037	!	and internal exec routines.
;	0038	!
;	0039	!--
;	0040	!
;	0041	!
;	0042	! AUTHOR:  Andrew C. Goldstein,	 CREATION DATE:  7-Jan-1977  01:02
;	0043	!
;	0044	! REVISION HISTORY:
;	0045	!
;	0046	!   Andrew C. Goldstein, 25-Feb-1977  16:33
;	0047	!   X0002 - Always copy FIB to local storage
;	0048	!
;	0049	!   Andrew C. Goldstein, 30-Mar-1977  17:51
;	0050	!   X0003 - Zero out result string data
;	0051	!
;	0052	!   Andrew C. Goldstein, 1-Apr-1977  16:42
;	0053	!   X0004 - Move buffer descriptor initialization to GETREQ and add -1,-1 DID kluge
;	0054	!
;	0055	!   Andrew C. Goldstein, 7-Apr-1977  14:31

; Bliss-32 10.1-416	Monday 21-AUG-1978 23:16:42	DBB3:[F11B.SRC]GETFIB.B32;6					Page 1-1
;
;	0056	!   X0005 - Move local FIB to common module
;	0057	!
;	0058	!   Andrew C. Goldstein, 26-Sep-1977  15:07
;	0059	!   X0006 - Allow operations on file other than that open on channel
;	0060	!
;	0061	!   Andrew C. Goldstein, 17-Nov-1977  8:56
;	0062	!   X0007 - Special case check for DEACCESS in file ID validation
;	0063	!
;	0064	!   Andrew C. Goldstein, 14-Dec-1977  15:07
;	0065	!   X0008 - Modify for structure level 2
;	0066	!
;	0067	!**
;	0068	
;	0069	
;	0070	LIBRARY 'SYS$LIBRARY:LIB.L32';
;	0071	REQUIRE 'SRC$:FCPDEF.B32';

; Bliss-32 10.1-416	Monday 21-AUG-1978 23:16:42	DBB3:[F11B.SRC]GETFIB.B32;6					Page 2
;
;	0420	GLOBAL ROUTINE GET_FIB (ABD) =
;	0421	
;	0422	!++
;	0423	!
;	0424	! FUNCTIONAL DESCRIPTION:
;	0425	!
;	0426	!	This routine obtains the address of the FIB for this operation.
;	0427	!	It copies the FIB from the buffer packet into local storage
;	0428	!	and zero extends it to maximum length.
;	0429	!
;	0430	! CALLING SEQUENCE:
;	0431	!	GET_FIB (ARG1)
;	0432	!
;	0433	! INPUT PARAMETERS:
;	0434	!	ARG1: buffer descriptor list
;	0435	!
;	0436	! IMPLICIT INPUTS:
;	0437	!	CURRENT_WINDOW: address of user's window or 0
;	0438	!	IO_PACKET: address of user's I/O packet
;	0439	!
;	0440	! OUTPUT PARAMETERS:
;	0441	!	NONE
;	0442	!
;	0443	! IMPLICIT OUTPUTS:
;	0444	!	NONE
;	0445	!
;	0446	! ROUTINE VALUE:
;	0447	!	address of FIB
;	0448	!
;	0449	! SIDE EFFECTS:
;	0450	!	file ID may be written into FIB
;	0451	!	channel window pointer write-back inhibited
;	0452	!	result string buffers zeroed
;	0453	!
;	0454	!--
;	0455	
;	0456	BEGIN
;	0457	
;	0458	MAP
;	0459		ABD		: REF BBLOCKVECTOR [,ABD$C_LENGTH];
;	0460						! buffer descriptors
;	0461	
;	0462	LOCAL
;	0463		FCB		: REF BBLOCK,	! FCB of file
;	0464		FIBL;				! length of user FIB
;	0465	
;	0466	EXTERNAL
;	0467		CLEANUP_FLAGS	: BITVECTOR,	! cleanup action flags
;	0468		LOCAL_FIB	: BBLOCK,	! internal copy of user FIB
;	0469		IO_PACKET	: REF BBLOCK,	! I/O packet of this operation
;	0470		CURRENT_VCB	: REF BBLOCK,	! VCB of this volume
;	0471		PRIMARY_FCB	: REF BBLOCK,	! FCB of current file
;	0472		CURRENT_FIB	: REF BBLOCK,	! pointer to current FIB in use
;	0473		CURRENT_WINDOW	: REF BBLOCK;	! user's window
;	0474	

; Bliss-32 10.1-416	Monday 21-AUG-1978 23:16:42	DBB3:[F11B.SRC]GETFIB.B32;6					Page 2-1
;
;	0475	
;	0476	! Get the length of the user-supplied FIB. If there is a window,
;	0477	! and there is no user FIB, use the file ID from
;	0478	! the window's FCB. Also use the FCB's file ID if the file number
;	0479	! in the user FIB is zero.
;	0480	!
;	0481	
;	0482	FIBL = .ABD[ABD$C_FIB, ABD$W_COUNT];
;	0483	
;	0484	CH$COPY (.FIBL,
;	0485		.ABD[ABD$C_FIB, ABD$W_TEXT] + ABD[ABD$C_FIB, ABD$W_TEXT] + 1,
;	0486		0,
;	0487		FIB$C_LENGTH,
;	0488		LOCAL_FIB);
;	0489	CURRENT_FIB = LOCAL_FIB;
;	0490	
;	0491	IF .CURRENT_WINDOW NEQ 0
;	0492	THEN
;	0493	    BEGIN
;	0494	    FCB = .CURRENT_WINDOW[WCB$L_FCB];
;	0495	    IF .LOCAL_FIB[FIB$W_FID_NUM] EQL 0
;	0496	    AND .LOCAL_FIB[FIB$W_FID_RVN] EQL 0
;	0497	    THEN CH$MOVE (FIB$S_FID, FCB[FCB$W_FID], LOCAL_FIB[FIB$W_FID]);
;	0498	
;	0499	! If the file ID in the FIB does not match that in the FCB, this operation
;	0500	! is not on the open file; clear the FCB and window addresses (except in
;	0501	! the case of a DEACCESS, in which we force the file ID to that of the open
;	0502	! file and signal an error).
;	0503	!
;	0504	
;	0505	    IF .LOCAL_FIB[FIB$W_FID_NUM] NEQ .FCB[FCB$W_FID_NUM]
;	0506	    OR .LOCAL_FIB[FIB$W_FID_RVN] NEQ .FCB[FCB$W_FID_RVN]
;	0507	    THEN
;	0508		BEGIN
;	0509		IF .IO_PACKET[IRP$V_FCODE] EQL IO$_DEACCESS
;	0510		THEN
;	0511		    BEGIN
;	0512		    CH$MOVE (FIB$S_FID, FCB[FCB$W_FID], LOCAL_FIB[FIB$W_FID]);
;	0513		    ERR_STATUS (SS$_BADPARAM);
;	0514		    END
;	0515		ELSE
;	0516		    BEGIN
;	0517		    CURRENT_WINDOW = 0;
;	0518		    PRIMARY_FCB = 0;
;	0519		    END;
;	0520		END;
;	0521	    END
;	0522	
;	0523	! If there is no file open, there must be a minimum FIB.
;	0524	!
;	0525	
;	0526	ELSE
;	0527	    BEGIN
;	0528	    IF .FIBL LSS FIB$C_ACCDATA
;	0529	    THEN ERR_EXIT (SS$_INSFARG);

; Bliss-32 10.1-416	Monday 21-AUG-1978 23:16:42	DBB3:[F11B.SRC]GETFIB.B32;6					Page 2-2
;
;	0530	    END;
;	0531	
;	0532	! If a non-zero directory ID is present, signal its presence in the
;	0533	! cleanup flags.
;	0534	!
;	0535	
;	0536	IF .LOCAL_FIB[FIB$W_DID_NUM] NEQ 0
;	0537	OR .LOCAL_FIB[FIB$W_DID_RVN] NEQ 0
;	0538	THEN CLEANUP_FLAGS[CLF_DIRECTORY] = 1;
;	0539	
;	0540	! If the directory ID is -1,-1, convert it to 4,4,0 to be compatible with
;	0541	! the old RSX MFD kluge.
;	0542	!
;	0543	
;	0544	IF .LOCAL_FIB[FIB$W_DID_NUM] EQL 65535
;	0545	AND .LOCAL_FIB[FIB$W_DID_SEQ] EQL 65535
;	0546	THEN
;	0547	    BEGIN
;	0548	    LOCAL_FIB[FIB$W_DID_NUM] = 4;
;	0549	    LOCAL_FIB[FIB$W_DID_SEQ] = 4;
;	0550	    LOCAL_FIB[FIB$W_DID_RVN] = 0;
;	0551	    END;
;	0552	
;	0553	RETURN LOCAL_FIB;
;	0554	
;	0555	END;					! end of routine GET_FIB


							    .TITLE  GETFIB
							    .IDENT  \B0008\

							    .EXTRN  CLEANUP_FLAGS, LOCAL_FIB, IO_PACKET, CURRENT_VCB
							    .EXTRN  PRIMARY_FCB, CURRENT_FIB, CURRENT_WINDOW, USER_STATUS

							    .PSECT  $CODE$,NOWRT,2

					 00FC 00000 	    .ENTRY  GET_FIB, Save R2,R3,R4,R5,R6,R7			      ; 0420
		         57 	0000G  CF  9E 00002 	    MOVAB   LOCAL_FIB+4, R7					      ;
		         50 	  04   AC  D0 00007 	    MOVL    ABD, R0						      ; 0482
		         56 	  0A   A0  3C 0000B 	    MOVZWL  10(R0), FIBL					      ;
		         51 	  08   A0  9E 0000F 	    MOVAB   8(R0), R1						      ; 0485
		         50 	       61  3C 00013 	    MOVZWL  (R1), R0						      ;
	   00 	    01 A140	       56  2C 00016 	    MOVC5   FIBL, 1(R1)[R0], #0, #44, LOCAL_FIB			      ; 0484
		    FC   A7	       2C     0001C									      ;
		  0000G  CF	  FC   A7  9E 0001F 	    MOVAB   LOCAL_FIB, CURRENT_FIB				      ; 0489
		         50 	0000G  CF  D0 00025 	    MOVL    CURRENT_WINDOW, R0					      ; 0491
				       42  13 0002A 	    BEQL    4$							      ;
		         56 	  18   A0  D0 0002C 	    MOVL    24(R0), FCB						      ; 0494
				       67  B5 00030 	    TSTW    LOCAL_FIB+4						      ; 0495
				       0A  12 00032 	    BNEQ    1$							      ;
				  04   A7  B5 00034 	    TSTW    LOCAL_FIB+8						      ; 0496
				       05  12 00037 	    BNEQ    1$							      ;
	   67 	    20   A6	       06  28 00039 	    MOVC3   #6, 32(FCB), LOCAL_FIB+4				      ; 0497
		    20   A6	       67  B1 0003E 1$:     CMPW    LOCAL_FIB+4, 32(FCB)				      ; 0505
				       07  12 00042 	    BNEQ    2$							      ;

; Bliss-32 10.1-416	Monday 21-AUG-1978 23:16:42	DBB3:[F11B.SRC]GETFIB.B32;6					Page 2-3
;
		    24   A6	  04   A7  B1 00044 	    CMPW    LOCAL_FIB+8, 36(FCB)				      ; 0506
				       2E  13 00049 	    BEQL    5$							      ;
		         50 	0000G  CF  D0 0004B 2$:     MOVL    IO_PACKET, R0					      ; 0509
      20   A0	         06 	       00  ED 00050 	    CMPZV   #0, #6, 32(R0), #52					      ;
				       34     00055									      ;
				       0C  12 00056 	    BNEQ    3$							      ;
	   67 	    20   A6	       06  28 00058 	    MOVC3   #6, 32(FCB), LOCAL_FIB+4				      ; 0512
		  0000G  CF	       14  B0 0005D 	    MOVW    #20, USER_STATUS					      ; 0513
				       15  11 00062 	    BRB     5$							      ; 0509
				0000G  CF  D4 00064 3$:     CLRL    CURRENT_WINDOW					      ; 0517
				0000G  CF  D4 00068 	    CLRL    PRIMARY_FCB						      ; 0518
				       0B  11 0006C 	    BRB     5$							      ; 0505
		         0A 	       56  D1 0006E 4$:     CMPL    FIBL, #10						      ; 0528
				       06  18 00071 	    BGEQ    5$							      ;
				0114   8F  BF 00073 	    CHMU    #276						      ; 0529
				       30  11 00077 	    BRB     9$							      ;
		         50 	  06   A7  3C 00079 5$:     MOVZWL  LOCAL_FIB+10, R0					      ; 0536
				       05  12 0007D 	    BNEQ    6$							      ;
				  0A   A7  B5 0007F 	    TSTW    LOCAL_FIB+14					      ; 0537
				       06  13 00082 	    BEQL    7$							      ;
		  0000G  CF	  40   8F  88 00084 6$:     BISB2   #64, CLEANUP_FLAGS					      ; 0538
		  FFFF   8F	       50  B1 0008A 7$:     CMPW    R0, #65535						      ; 0544
				       13  12 0008F 	    BNEQ    8$							      ;
		  FFFF   8F	  08   A7  B1 00091 	    CMPW    LOCAL_FIB+12, #65535				      ; 0545
				       0B  12 00097 	    BNEQ    8$							      ;
		    06   A7 00040004   8F  D0 00099 	    MOVL    #262148, LOCAL_FIB+10				      ; 0548
				  0A   A7  B4 000A1 	    CLRW    LOCAL_FIB+14					      ; 0550
		         50 	  FC   A7  9E 000A4 8$:     MOVAB   LOCAL_FIB, R0					      ; 0553
					   04 000A8 	    RET     							      ;
				       50  D4 000A9 9$:     CLRL    R0							      ; 0420
					   04 000AB 	    RET     							      ;

; Routine Size:  172 bytes


;	0556	
;	0557	END
;	0558	ELUDOM






;				       PSECT SUMMARY
;
;	Name		 Bytes			       Attributes
;
;  $CODE$         	   172  NOWRT,  RD ,  EXE,NOSHR,  LCL,  REL,  CON,NOPIC,ALIGN(2)




;				LIBRARY STATISTICS
;

; Bliss-32 10.1-416	Monday 21-AUG-1978 23:16:42	DBB3:[F11B.SRC]GETFIB.B32;6					Page 2-4
;
;					     -------- Symbols --------    Blocks
;	File				     Total    Loaded   Percent      Read
;
;  DBA4:[SYSLIB]LIB.L32;1		      5582        28         0       237





; Size:		172 code + 0 data bytes
; Run Time:	00:06.4
; Elapsed Time:	00:12.8
; Memory Used:	284 pages
; Compilation Complete
