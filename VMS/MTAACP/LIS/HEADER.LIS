
; Bliss-32 7.352	Saturday 21-AUG-1978 23:35:19	DBB3:[MTAACP.SRC]HEADER.B32;12					Page 1
; Digital Equipment Corporation
;
;	0001	MODULE HEADER (
;	0002			LANGUAGE (BLISS32),
;	0003			IDENT = 'A0004'
;	0004			) =
;	0005	BEGIN
;	0006	
;	0007	!
;	0008	! COPYRIGHT (C) 1977
;	0009	! DIGITAL EQUIPMENT CORPORATION, MAYNARD, MASSACHUSETTS 01754
;	0010	!
;	0011	! THIS SOFTWARE IS FURNISHED  UNDER A LICENSE FOR USE ONLY ON A SINGLE
;	0012	! COMPUTER  SYSTEM AND  MAY BE  COPIED ONLY WITH  THE INCLUSION OF THE
;	0013	! ABOVE COPYRIGHT NOTICE.  THIS SOFTWARE, OR ANY OTHER COPIES THEREOF,
;	0014	! MAY NOT BE PROVIDED OR  OTHERWISE MADE AVAILABLE TO ANY OTHER PERSON
;	0015	! EXCEPT FOR USE ON SUCH SYSTEM AND TO ONE WHO AGREES TO THESE LICENSE
;	0016	! TERMS.  TITLE TO AND  OWNERSHIP OF THE  SOFTWARE  SHALL AT ALL TIMES
;	0017	! REMAIN IN DEC.
;	0018	!
;	0019	! THE INFORMATION IN THIS SOFTWARE IS SUBJECT TO CHANGE WITHOUT NOTICE
;	0020	! AND SHOULD  NOT BE CONSTRUED  AS A COMMITMENT  BY DIGITAL  EQUIPMENT
;	0021	! CORPORATION.
;	0022	!
;	0023	! DEC ASSUMES  NO  RESPONSIBILITY  FOR  THE USE OR  RELIABILITY OF ITS
;	0024	! SOFTWARE ON EQUIPMENT WHICH IS NOT SUPPLIED BY DEC.
;	0025	
;	0026	!++
;	0027	!
;	0028	! FACILITY:  MTAACP
;	0029	!
;	0030	! ABSTRACT:
;	0031	!	THIS MODULE CONTAINS ROUTINES WHICH POSITION TO HEADERS OR TRAILERS
;	0032	!	AND READ THEM
;	0033	!
;	0034	! ENVIRONMENT:
;	0035	!
;	0036	!	STARLET OPERATING SYSTEM, INCLUDING PRIVILEGED SYSTEM SERVICES
;	0037	!	AND INTERNAL EXEC ROUTINES.
;	0038	!
;	0039	!--
;	0040	!
;	0041	!
;	0042	! AUTHOR:  D. H. GILLESPIE,	 CREATION DATE:  25-MAY-77 15:00  
;	0043	!
;	0044	! REVISION HISTORY:
;	0045	!
;	0046	!   D. H. Gillespie, 12-May-78  13:49
;	0047	!   A0001 - change CURRENT_VCB to a register
;	0048	!
;	0049	!   D. H. Gillespie, 23-May-78  9:49
;	0050	!   A0002 - remove READ_NXTHDR_WA and READ_NXTHDR
;	0051	!
;	0052	!   D. H. Gillespie, 23-May-78  13:26
;	0053	!   A0003 - change linkage to GET_START_HDR
;	0054	!
;	0055	!   D. H. Gillespie, 25-May-78  11:17

; Bliss-32 7.352	Saturday 21-AUG-1978 23:35:19	DBB3:[MTAACP.SRC]HEADER.B32;12					Page 1-1
; Digital Equipment Corporation
;
;	0056	!   A0004 - change interface to MOUNT_VOL
;	0057	!
;	0058	!**
;	0059	
;	0060	LIBRARY 'SYS$LIBRARY:LIB.L32';
;	0061	REQUIRE 'SRC$:MTADEF.B32';
;	0357	
;	0358	FORWARD ROUTINE
;	0359		READ_HDR	: COMMON_CALL,			!READ HDR1 AND HDR2 IF EXIST
;	0360		SPACE_EOF	: COMMON_CALL	NOVALUE,	!SPACE TO END OF FILE
;	0361		UPDVCB_LEOV	: COMMON_CALL NOVALUE,		!UPDATE VCB LOG END OF FILE
;	0362		MAKE_CUR_FILE	: COMMON_CALL NOVALUE,		!UPDATE VCB
;	0363		WRAP_AROUND	: L$WRAP_AROUND;		!CONTINUE SEARCH AT BEGINNING OF VOLUME SET
;	0364	
;	0365	EXTERNAL
;	0366		CURRENT_UCB:	REF BBLOCK,
;	0367		HDR1:		REF BBLOCK,			!ADDRESS HDR1 LABEL
;	0368		HDR2:		REF BBLOCK;			!ADDRESS OF HDR2 LABEL

; Bliss-32 7.352	Saturday 21-AUG-1978 23:35:19	DBB3:[MTAACP.SRC]HEADER.B32;12					Page 2
; Digital Equipment Corporation
;
;	0369	GLOBAL ROUTINE GET_START_HDR : L$GET_START_HDR  =
;	0370	
;	0371	!++
;	0372	!
;	0373	! FUNCTIONAL DESCRIPTION:
;	0374	!	THIS ROUTINE POSITIONS TO THE HEADER LABEL SET OF THE START FILE
;	0375	!	IN CURRENT SEARCH AND READS HDR1 AND HDR2 LABELS UNLESS THEY HAVE ALREADY BEEN READ.
;	0376	!
;	0377	! CALLING SEQUENCE:
;	0378	!	GET_START_HDR()
;	0379	!
;	0380	! INPUT PARAMETERS:
;	0381	!	NONE
;	0382	!
;	0383	! IMPLICIT INPUTS:
;	0384	!	CURRENT_VCB, CURRENT_UCB
;	0385	!
;	0386	! OUTPUT PARAMETERS:
;	0387	!	NONE
;	0388	!
;	0389	! IMPLICIT OUTPUTS:
;	0390	!	HDR1 READ IN, HDR2 READ IN OR DEFAULTED
;	0391	!
;	0392	! ROUTINE VALUE:
;	0393	!	0 UNSUCCESSFUL, LOGICAL END OF VOLUME SET
;	0394	!	1 SUCCESSFUL
;	0395	!
;	0396	! SIDE EFFECTS:
;	0397	!	NONE
;	0398	!
;	0399	!--
;	0400	
;	0401	BEGIN
;	0402	
;	0403	EXTERNAL REGISTER
;	0404		COMMON_REG;
;	0405	
;	0406	
;	0407	EXTERNAL LITERAL
;	0408		UCB$L_MT_RECORD;		!DISPLACEMENT INTO UCB
;	0409	
;	0410	EXTERNAL ROUTINE
;	0411		MOUNT_VOL;				!MOUNT VOLUME
;	0412	
;	0413	EXTERNAL
;	0414		CURRENT_UCB:	REF BBLOCK,		!ADDRESS OF CURRENT UCB
;	0415		LOCAL_FIB:	BBLOCK;			!COPY OF USER'S FIB
;	0416	
;	0417	LOCAL
;	0418		RELATIVE_BLOCK,				!RELATIVE BLOCK NUMBER TO LAST TM
;	0419		TM;					!NUMBER OF TM'S
;	0420	
;	0421	! MOUNT VOLUME IF THE CURRENT RVN IS ZERO
;	0422	IF .CURRENT_VCB[VCB$B_CUR_RVN] EQL 0
;	0423	THEN MOUNT_VOL(1,$FIELDMASK(MOU$V_REWIND) + $FIELDMASK(MOU$V_LBLCHECK));

; Bliss-32 7.352	Saturday 21-AUG-1978 23:35:19	DBB3:[MTAACP.SRC]HEADER.B32;12					Page 2-1
; Digital Equipment Corporation
;
;	0424	
;	0425	! IF AT LOGICAL END OF VOLUME SET RETURN IMMEDIATELY
;	0426	IF .CURRENT_VCB[VCB$V_LOGICEOVS] THEN RETURN 0;
;	0427	
;	0428	! IF THE NUMBER OF TAPE MARKS INTO THE FILE IS NOT 0, THEN THE PREVIOUS FILE WAS CLOSED
;	0429	! PREMATURELY AND SHOULD NOT BE INCLUDED IN SEARCH EXCEPT IN THE CASE
;	0430	! WHERE THERE IS NOT A HDR2 AND THE TAPE IS LEFT POSITIONED BEYOND THE TM
;	0431	! IF THE SECTION IS NOT THE FIRST, THEN SPACE TO NEXT FILE
;	0432	IF (.CURRENT_VCB[VCB$B_TM] NEQU 0
;	0433	AND NOT (.CURRENT_VCB[VCB$B_TM] EQLU 1
;	0434		AND HDR2[HD2$L_HD2LID] NEQU 'HDR2'
;	0435		AND (.(.CURRENT_UCB + UCB$L_MT_RECORD)<0,32> - .CURRENT_VCB[VCB$L_ST_RECORD]) EQLU 0
;	0436		  ))
;	0437	OR .CURRENT_VCB[VCB$W_CUR_SEQ] GTR 1	!POSITION TO BEGINNING OF FILE
;	0438	THEN SPACE_EOF();
;	0439	
;	0440	! WHEN NEW VOLUME IS MOUNTED, VOL1 HAS BEEN READ BUT NOT HDR1 AND HDR2,
;	0441	! THEREFORE THE ACTUAL BLOCK COUNT EQUALS 1
;	0442	! IF RELATIVE BLOCK COUNT = 0 THEN THE HEADERS HAVE NOT BEEN READ FOR THIS FILE
;	0443	RELATIVE_BLOCK = .(.CURRENT_UCB + UCB$L_MT_RECORD)<0,32> - .CURRENT_VCB[VCB$L_ST_RECORD];
;	0444	IF (.RELATIVE_BLOCK EQL 0 OR .(.CURRENT_UCB + UCB$L_MT_RECORD)<0,32> EQLU 1)
;	0445	AND .CURRENT_VCB[VCB$B_TM] EQLU 0
;	0446	
;	0447	THEN RETURN READ_HDR();
;	0448	
;	0449	RETURN 1;
;	0450	END;						!END OF ROUTINE


							    .TITLE  HEADER
							    .IDENT  \A0004\

							    .GLOBL  CURRENT_UCB, HDR1, HDR2, UCB$L_MT_RECORD, MOUNT_VOL
							    .GLOBL  LOCAL_FIB

							    .PSECT  $CODE$,NOWRT,2

				  2F   AB  95 00000 GET_START_HDR::
							    TSTB    47(CURRENT_VCB)					      ; 0422
				       09  12 00003 	    BNEQ    1$							      ;
				       03  DD 00005 	    PUSHL   #3							      ; 0423
				       01  DD 00007 	    PUSHL   #1							      ;
		  0000G  CF	       02  FB 00009 	    CALLS   #2, MOUNT_VOL					      ;
	   57	    0B   AB	       01  E0 0000E 1$:     BBS     #1, 11(CURRENT_VCB), 7$				      ; 0426
				  2E   AB  95 00013 	    TSTB    46(CURRENT_VCB)					      ; 0432
				       22  13 00016 	    BEQL    2$							      ;
		         01	  2E   AB  91 00018 	    CMPB    46(CURRENT_VCB), #1					      ; 0433
				       22  12 0001C 	    BNEQ    3$							      ;
	      32524448   8F	0000G  CF  D1 0001E 	    CMPL    HDR2, #844252232					      ; 0434
				       17  13 00027 	    BEQL    3$							      ;
	   50	  0000G  CF 00000000G  8F  C1 00029 	    ADDL3   #UCB$L_MT_RECORD, CURRENT_UCB, R0			      ; 0435
	   50	         60	  30   AB  C3 00033 	    SUBL3   48(CURRENT_VCB), (R0), R0				      ;
				       06  12 00038 	    BNEQ    3$							      ;
		         01	  26   AB  B1 0003A 2$:     CMPW    38(CURRENT_VCB), #1					      ; 0437
				       05  1B 0003E 	    BLEQU   4$							      ;

; Bliss-32 7.352	Saturday 21-AUG-1978 23:35:19	DBB3:[MTAACP.SRC]HEADER.B32;12					Page 2-2
; Digital Equipment Corporation
;
		  0000V  CF	       00  FB 00040 3$:     CALLS   #0, SPACE_EOF					      ; 0438
	   51	  0000G  CF 00000000G  8F  C1 00045 4$:     ADDL3   #UCB$L_MT_RECORD, CURRENT_UCB, R1			      ; 0443
	   50	         61	  30   AB  C3 0004F 	    SUBL3   48(CURRENT_VCB), (R1), RELATIVE_BLOCK		      ;
				       05  13 00054 	    BEQL    5$							      ; 0444
		         01	       61  D1 00056 	    CMPL    (R1), #1						      ;
				       0B  12 00059 	    BNEQ    6$							      ;
				  2E   AB  95 0005B 5$:     TSTB    46(CURRENT_VCB)					      ; 0445
				       06  12 0005E 	    BNEQ    6$							      ;
		  0000V  CF	       00  FB 00060 	    CALLS   #0, READ_HDR					      ; 0447
					   05 00065 	    RSB     							      ;
		         50	       01  D0 00066 6$:     MOVL    #1, R0						      ; 0449
					   05 00069 	    RSB     							      ;
				       50  D4 0006A 7$:     CLRL    R0							      ; 0369
					   05 0006C 	    RSB     							      ;

; Routine Size:  109 bytes


;	0451	

; Bliss-32 7.352	Saturday 21-AUG-1978 23:35:19	DBB3:[MTAACP.SRC]HEADER.B32;12					Page 3
; Digital Equipment Corporation
;
;	0452	GLOBAL ROUTINE READ_HDR : COMMON_CALL  =
;	0453	
;	0454	!++
;	0455	!
;	0456	! FUNCTIONAL DESCRIPTION:
;	0457	!	READS HDR1 AND HDR2 IF IT EXISTS.  OTHERWISE, IT DEFAULTS HDR2.
;	0458	!
;	0459	! CALLING SEQUENCE:
;	0460	!	READ_HDR()
;	0461	!
;	0462	! INPUT PARAMETERS:
;	0463	!	NONE
;	0464	!
;	0465	! IMPLICIT INPUTS:
;	0466	!	CURRENT_VCB - ADDRESS OF VCB
;	0467	!
;	0468	! OUTPUT PARAMETERS:
;	0469	!	NONE
;	0470	!
;	0471	! IMPLICIT OUTPUTS:
;	0472	!	HDR1 AND HDR2 READ IN
;	0473	!	IF STARLET FILE, VCB NOTES THIS FACT
;	0474	!	IF LOGICAL END OF TAPE(IE:  TM ENCOUNTERED ON READ OF HDR1) THEN THIS FACT IS NOTED IN VCB
;	0475	!
;	0476	! ROUTINE VALUE:
;	0477	!	0 - TM ENCOUNTERED WHEN READING HDR1, LOGICAL END OF VOLUME SET
;	0478	!	1 - SUCCESSFUL
;	0479	!
;	0480	! SIDE EFFECTS:
;	0481	!	FIRST USER LABEL MAY BE LOCATED IN SCRATCH LABEL AREA
;	0482	!
;	0483	! USER ERRORS:
;	0484	!	SS$_TAPEPOSLOST - HDR1 NOT ENCOUNTERED ON READ
;	0485	!
;	0486	!--
;	0487	
;	0488	BEGIN
;	0489	
;	0490	LOCAL
;	0491		DESCR	: VECTOR [2];
;	0492	
;	0493	EXTERNAL REGISTER
;	0494		COMMON_REG;
;	0495	
;	0496	EXTERNAL ROUTINE
;	0497		READ_BLOCK;					!READ ONE MAG TAPE BLOCK
;	0498	
;	0499	BIND
;	0500		CVT5	= 	DESCRIPTOR('!5ZW'),
;	0501		DEFAULT	=	UPLIT ('00512');
;	0502	
;	0503	IF NOT READ_BLOCK(.HDR1,80) THEN
;	0504	    BEGIN
;	0505	    KERNEL_CALL(UPDVCB_LEOV);
;	0506	    RETURN 0;

; Bliss-32 7.352	Saturday 21-AUG-1978 23:35:19	DBB3:[MTAACP.SRC]HEADER.B32;12					Page 3-1
; Digital Equipment Corporation
;
;	0507	    END;
;	0508	WHILE 1 DO
;	0509	    BEGIN
;	0510	    IF .HDR1[HD1$L_HD1LID] EQLU 'HDR1' THEN EXITLOOP;
;	0511	    IF NOT READ_BLOCK(.HDR1,80) THEN ERR_EXIT(SS$_TAPEPOSLOST);
;	0512	    END;
;	0513	KERNEL_CALL(MAKE_CUR_FILE,.HDR1);
;	0514	
;	0515	! DEFAULT HEADER 2 VALUES
;	0516	CH$FILL (0,80,.HDR2);
;	0517	HDR2[HD2$B_RECFORMAT] = 'F';
;	0518	DESCR[0] = HD2$S_BLOCKLEN;
;	0519	DESCR[1] = HDR2[HD2$T_BLOCKLEN];
;	0520	IF NOT $FAO	( CVT5,
;     P 0521			  0,
;     P 0522			  DESCR,
;     P 0523			  .CURRENT_UCB[UCB$W_DEVBUFSIZ])
;	0524	THEN CH$MOVE(HD2$S_BLOCKLEN,DEFAULT,HDR2[HD2$T_BLOCKLEN]);
;	0525	CH$MOVE(HD2$S_RECLEN,HDR2[HD2$T_BLOCKLEN],HDR2[HD2$T_RECLEN]);
;	0526	IF .CURRENT_VCB[VCB$W_RECORDSZ] NEQ 0
;	0527	THEN
;	0528	    BEGIN
;	0529	    DESCR[0] = HD2$S_RECLEN;
;	0530	    DESCR[1] = HDR2[HD2$T_RECLEN];
;	0531	    IF NOT $FAO	( CVT5,
;     P 0532			  0,
;     P 0533			  DESCR,
;     P 0534			  .CURRENT_VCB[VCB$W_RECORDSZ])
;	0535	    THEN CH$MOVE(HD2$S_RECLEN,HDR2[HD2$T_BLOCKLEN],HDR2[HD2$T_RECLEN]);
;	0536	    END;
;	0537	! NOW TRY TO READ IT
;	0538	IF READ_BLOCK(.HDR2 + 80,80)
;	0539	THEN
;	0540	    IF .(.HDR2 + 80) EQLU 'HDR2'
;	0541	    THEN CH$MOVE(80,.HDR2 + 80,.HDR2);
;	0542	RETURN 1;
;	0543	
;	0544	END;							!END OF ROUTINE



					      0006D	    .BLKB   3
					      00070 P.AAB:  .ASCII  \!5ZW\						      ;
					      00074 P.AAA:  .LONG   4							      ;
					      00078 	    .ADDRESS  P.AAB						      ;
					      0007C P.AAC:  .ASCII  \00512\<0><0><0>					      ;

						    CVT5=		P.AAA
						    DEFAULT=		P.AAC
							    .GLOBL  READ_BLOCK, SYS$CMKRNL, SYS$FAO

					 07FC 00084 	    .ENTRY  READ_HDR, Save R2,R3,R4,R5,R6,R7,R8,R9,R10		      ; 0452
		         57	0000G  CF  9E 00086 	    MOVAB   HDR1, R7						      ;
		         58 00000000G  9F  9E 0008B 	    MOVAB   @#SYS$FAO, R8					      ;
		         59 00000000G  9F  9E 00092 	    MOVAB   @#SYS$CMKRNL, R9					      ;

; Bliss-32 7.352	Saturday 21-AUG-1978 23:35:19	DBB3:[MTAACP.SRC]HEADER.B32;12					Page 3-2
; Digital Equipment Corporation
;
		         5A	0000G  CF  9E 00099 	    MOVAB   HDR2, R10						      ;
		         5E	       08  C2 0009E 	    SUBL2   #8, SP						      ;
		         7E	  50   8F  9A 000A1 	    MOVZBL  #80, -(SP)						      ; 0503
				       67  DD 000A5 	    PUSHL   HDR1						      ;
		  0000G  CF	       02  FB 000A7 	    CALLS   #2, READ_BLOCK					      ;
		         0E	       50  E8 000AC 	    BLBS    R0, 1$						      ;
				       7E  D4 000AF 	    CLRL    -(SP)						      ; 0505
				       5E  DD 000B1 	    PUSHL   SP							      ;
				0000V  CF  9F 000B3 	    PUSHAB  UPDVCB_LEOV						      ;
		         69	       03  FB 000B7 	    CALLS   #3, SYS$CMKRNL					      ;
				     00C3  31 000BA 	    BRW     6$							      ; 0506
	      31524448   8F	  00   B7  D1 000BD 1$:     CMPL    @HDR1, #827475016					      ; 0510
				       14  13 000C5 	    BEQL    2$							      ;
		         7E	  50   8F  9A 000C7 	    MOVZBL  #80, -(SP)						      ; 0511
				       67  DD 000CB 	    PUSHL   HDR1						      ;
		  0000G  CF	       02  FB 000CD 	    CALLS   #2, READ_BLOCK					      ;
		         E8	       50  E8 000D2 	    BLBS    R0, 1$						      ;
				0224   8F  BF 000D5 	    CHMU    #548						      ;
				       E2  11 000D9 	    BRB     1$							      ; 0508
				       67  DD 000DB 2$:     PUSHL   HDR1						      ; 0513
				       01  DD 000DD 	    PUSHL   #1							      ;
				       5E  DD 000DF 	    PUSHL   SP							      ;
				0000V  CF  9F 000E1 	    PUSHAB  MAKE_CUR_FILE					      ;
		         69	       04  FB 000E5 	    CALLS   #4, SYS$CMKRNL					      ;
		         56	       6A  D0 000E8 	    MOVL    HDR2, R6						      ; 0516
	   00	         6E	       00  2C 000EB 	    MOVC5   #0, (SP), #0, #80, (R6)				      ;
		         66	0050   8F     000EF									      ;
		    04   A6	  46   8F  90 000F3 	    MOVB    #70, 4(R6)						      ; 0517
		         6E	       05  D0 000F8 	    MOVL    #5, DESCR						      ; 0518
      04   AE	         56	       05  C1 000FB 	    ADDL3   #5, R6, DESCR+4					      ; 0519
		         50	0000G  CF  D0 00100 	    MOVL    CURRENT_UCB, R0					      ; 0523
		         7E	  3A   A0  3C 00105 	    MOVZWL  58(R0), -(SP)					      ;
				  04   AE  9F 00109 	    PUSHAB  DESCR						      ;
				       7E  D4 0010C 	    CLRL    -(SP)						      ;
				FF62   CF  9F 0010E 	    PUSHAB  CVT5						      ; 0452
		         68	       04  FB 00112 	    CALLS   #4, SYS$FAO						      ; 0523
		         0A	       50  E8 00115 	    BLBS    R0, 3$						      ;
		         50	       6A  D0 00118 	    MOVL    HDR2, R0						      ; 0524
      05   A0	  FF5C   CF	       05  28 0011B 	    MOVC3   #5, DEFAULT, 5(R0)					      ;
		         56	       6A  D0 00122 3$:     MOVL    HDR2, R6						      ; 0525
      0A   A6	    05   A6	       05  28 00125 	    MOVC3   #5, 5(R6), 10(R6)					      ;
				  50   AB  B5 0012B 	    TSTW    80(CURRENT_VCB)					      ; 0526
				       24  13 0012E 	    BEQL    4$							      ;
		         6E	       05  D0 00130 	    MOVL    #5, DESCR						      ; 0529
		    04   AE	  0A   A6  9E 00133 	    MOVAB   10(R6), DESCR+4					      ; 0530
		         7E	  50   AB  3C 00138 	    MOVZWL  80(CURRENT_VCB), -(SP)				      ; 0534
				  04   AE  9F 0013C 	    PUSHAB  DESCR						      ;
				       7E  D4 0013F 	    CLRL    -(SP)						      ;
				FF2F   CF  9F 00141 	    PUSHAB  CVT5						      ; 0452
		         68	       04  FB 00145 	    CALLS   #4, SYS$FAO						      ; 0534
		         09	       50  E8 00148 	    BLBS    R0, 4$						      ;
		         50	       6A  D0 0014B 	    MOVL    HDR2, R0						      ; 0535
      0A   A0	    05   A0	       05  28 0014E 	    MOVC3   #5, 5(R0), 10(R0)					      ;
		         7E	  50   8F  9A 00154 4$:     MOVZBL  #80, -(SP)						      ; 0538
	   7E	         6A 00000050   8F  C1 00158 	    ADDL3   #80, HDR2, -(SP)					      ;

; Bliss-32 7.352	Saturday 21-AUG-1978 23:35:19	DBB3:[MTAACP.SRC]HEADER.B32;12					Page 3-3
; Digital Equipment Corporation
;
		  0000G  CF	       02  FB 00160 	    CALLS   #2, READ_BLOCK					      ;
		         14	       50  E9 00165 	    BLBC    R0, 5$						      ;
		         50	       6A  D0 00168 	    MOVL    HDR2, R0						      ; 0540
	      32524448   8F	  50   A0  D1 0016B 	    CMPL    80(R0), #844252232					      ;
				       07  12 00173 	    BNEQ    5$							      ;
	   60	    50   A0	0050   8F  28 00175 	    MOVC3   #80, 80(R0), (R0)					      ; 0541
		         50	       01  D0 0017C 5$:     MOVL    #1, R0						      ; 0542
					   04 0017F 	    RET     							      ;
				       50  D4 00180 6$:     CLRL    R0							      ; 0452
					   04 00182 	    RET     							      ;

; Routine Size:  255 bytes


;	0545	
;	0546	

; Bliss-32 7.352	Saturday 21-AUG-1978 23:35:19	DBB3:[MTAACP.SRC]HEADER.B32;12					Page 4
; Digital Equipment Corporation
;
;	0547	GLOBAL ROUTINE WRAP_AROUND : L$WRAP_AROUND  =
;	0548	
;	0549	!++
;	0550	!
;	0551	! FUNCTIONAL DESCRIPTION:
;	0552	!	IF THIS IS NOT THE FIRST TIME THROUGH AND THE SEARCH STARTED
;	0553	!	AT THE BEGINNING OF THE VOLUME SET THEN RETURN ERROR ELSE REWIND VOLUME SET
;	0554	!
;	0555	! CALLING SEQUENCE:
;	0556	!	WRAP_AROUND()
;	0557	!
;	0558	! INPUT PARAMETERS:
;	0559	!	NONE
;	0560	!
;	0561	! IMPLICIT INPUTS:
;	0562	!	LOCAL_FIB - COPY OF USER'S FIB
;	0563	!	CURRENT_VCB - ADDRESS OF CURRENT VOLUME CB
;	0564	!
;	0565	! OUTPUT PARAMETERS:
;	0566	!	NONE
;	0567	!
;	0568	! IMPLICIT OUTPUTS:
;	0569	!	NONE
;	0570	!
;	0571	! ROUTINE VALUE:
;	0572	!	0 BACK TO BEGINNING OF SEARCH
;	0573	!	1 AT BEGINNING OF VOLUME SET
;	0574	!
;	0575	! SIDE EFFECTS:
;	0576	!	NONE
;	0577	!
;	0578	!--
;	0579	
;	0580	BEGIN
;	0581	
;	0582	EXTERNAL REGISTER
;	0583		COMMON_REG;
;	0584	
;	0585	
;	0586	EXTERNAL ROUTINE
;	0587		MOUNT_VOL,				!MOUNT VOLUME
;	0588		REWIND_VOL_SET;				!REWIND VOLUME SET
;	0589	
;	0590	EXTERNAL
;	0591		LOCAL_FIB:	BBLOCK;			!COPY OF USER'S FIB
;	0592	
;	0593	IF  .CURRENT_VCB[VCB$L_START_FID] EQL %X'00010001'
;	0594	THEN RETURN 0
;	0595	ELSE
;	0596	    BEGIN
;	0597	    REWIND_VOL_SET();
;	0598	    MOUNT_VOL(1,$FIELDMASK(MOU$V_REWIND) + $FIELDMASK(MOU$V_LBLCHECK));	!GET FIRST VOLUME MOUNTED
;	0599	    IF NOT READ_HDR() THEN ERR_EXIT(SS$_TAPEPOSLOST);
;	0600	    END;
;	0601	

; Bliss-32 7.352	Saturday 21-AUG-1978 23:35:19	DBB3:[MTAACP.SRC]HEADER.B32;12					Page 4-1
; Digital Equipment Corporation
;
;	0602	RETURN 1;
;	0603	
;	0604	END;						!END OF ROUTINE



							    .GLOBL  REWIND_VOL_SET

	      00010001   8F	  28   AB  D1 00183 WRAP_AROUND::
							    CMPL    40(CURRENT_VCB), #65537				      ; 0593
				       1E  13 0018B 	    BEQL    2$							      ;
		  0000G  CF	       00  FB 0018D 	    CALLS   #0, REWIND_VOL_SET					      ; 0597
				       03  DD 00192 	    PUSHL   #3							      ; 0598
				       01  DD 00194 	    PUSHL   #1							      ;
		  0000G  CF	       02  FB 00196 	    CALLS   #2, MOUNT_VOL					      ;
		  FEE4   CF	       00  FB 0019B 	    CALLS   #0, READ_HDR					      ; 0599
		         04	       50  E8 001A0 	    BLBS    R0, 1$						      ;
				0224   8F  BF 001A3 	    CHMU    #548						      ;
		         50	       01  D0 001A7 1$:     MOVL    #1, R0						      ; 0602
					   05 001AA 	    RSB     							      ;
				       50  D4 001AB 2$:     CLRL    R0							      ; 0547
					   05 001AD 	    RSB     							      ;

; Routine Size:  43 bytes


;	0605	

; Bliss-32 7.352	Saturday 21-AUG-1978 23:35:19	DBB3:[MTAACP.SRC]HEADER.B32;12					Page 5
; Digital Equipment Corporation
;
;	0606	GLOBAL ROUTINE SPACE_EOF : COMMON_CALL NOVALUE  =
;	0607	
;	0608	!++
;	0609	!
;	0610	! FUNCTIONAL DESCRIPTION:
;	0611	!	THIS ROUTINE SPACES TO THE END OF THE CURRENT FILE, RIGHT BEFORE NEXT FILE
;	0612	!
;	0613	! CALLING SEQUENCE:
;	0614	!	SPACE_EOF()
;	0615	!
;	0616	! INPUT PARAMETERS:
;	0617	!	NONE
;	0618	!
;	0619	! IMPLICIT INPUTS:
;	0620	!	CURRENT_VCB _ ADDRESS OF CURRENT VCB
;	0621	!
;	0622	! OUTPUT PARAMETERS:
;	0623	!	NONE
;	0624	!
;	0625	! IMPLICIT OUTPUTS:
;	0626	!	NONE
;	0627	!
;	0628	! ROUTINE VALUE:
;	0629	!	NONE
;	0630	!
;	0631	! SIDE EFFECTS:
;	0632	!	THE TAPE IS LEFT POSITIONED IN FRONT OF HDR1 OF THE NEXT FILE
;	0633	!
;	0634	!--
;	0635	
;	0636	BEGIN
;	0637	
;	0638	EXTERNAL REGISTER
;	0639		COMMON_REG;
;	0640	
;	0641	
;	0642	EXTERNAL LITERAL
;	0643		UCB$L_MT_RECORD;		!GLOBAL DISPLACEMENT INTO UCB
;	0644	
;	0645	EXTERNAL ROUTINE
;	0646		GTNEXT_VOL_READ:	JSB,		!GET NEXT VOLUME ON READ
;	0647		READ_BLOCK,				!READ MAG TAPE BLOCK
;	0648		SPACE_TM;				!SPACE TM'S
;	0649		
;	0650	
;	0651	EXTERNAL
;	0652		CURRENT_UCB:	REF BBLOCK;		!ADDRESS OF CURRENT UCB
;	0653	
;	0654	LOCAL
;	0655		TM;
;	0656	
;	0657	! IF TAPE IS POSITIONED IN HEADER SET, SPACE 2
;	0658	IF .CURRENT_VCB[VCB$B_TM] EQL 0 
;	0659	AND .HDR1[HD1$L_HD1LID] EQL 'HDR1' THEN SPACE_TM(2);
;	0660	

; Bliss-32 7.352	Saturday 21-AUG-1978 23:35:19	DBB3:[MTAACP.SRC]HEADER.B32;12					Page 5-1
; Digital Equipment Corporation
;
;	0661	! IF IN DATA AREA, SPACE 1
;	0662	IF .CURRENT_VCB[VCB$B_TM] EQLU 1 THEN SPACE_TM(1);
;	0663	
;	0664	! NOW IF TRAILER HAS NOT BEEN READ, READ IT
;	0665	IF .CURRENT_VCB[VCB$B_TM]  EQLU 2
;	0666	AND (.(.CURRENT_UCB + UCB$L_MT_RECORD)<0,32> - .CURRENT_VCB[VCB$L_ST_RECORD]) EQL 0 
;	0667	THEN IF NOT READ_BLOCK(.HDR1,80) THEN ERR_EXIT(SS$_TAPEPOSLOST);
;	0668	
;	0669	WHILE 1 DO
;	0670	    BEGIN
;	0671	    IF .HDR1[HD1$L_HD1LID] EQL 'EOF1' THEN EXITLOOP;
;	0672	    IF .HDR1[HD1$L_HD1LID] NEQ 'EOV1' THEN ERR_EXIT(SS$_TAPEPOSLOST);
;	0673	    GTNEXT_VOL_READ();
;	0674	    SPACE_TM(2);
;	0675	    IF NOT READ_BLOCK(.HDR1,80) THEN ERR_EXIT(SS$_TAPEPOSLOST);
;	0676	    END;
;	0677	
;	0678	IF .CURRENT_VCB[VCB$B_TM] EQLU 2 THEN SPACE_TM(1);
;	0679	END;					!END OF ROUTINE



							    .GLOBL  GTNEXT_VOL_READ, SPACE_TM

					 07FC 001AE 	    .ENTRY  SPACE_EOF, Save R2,R3,R4,R5,R6,R7,R8,R9,R10		      ; 0606
		         5A	0000G  CF  9E 001B0 	    MOVAB   SPACE_TM, R10					      ;
				  2E   AB  95 001B5 	    TSTB    46(CURRENT_VCB)					      ; 0658
				       10  12 001B8 	    BNEQ    1$							      ;
	      31524448   8F	0000G  DF  D1 001BA 	    CMPL    @HDR1, #827475016					      ; 0659
				       05  12 001C3 	    BNEQ    1$							      ;
				       02  DD 001C5 	    PUSHL   #2							      ;
		         6A	       01  FB 001C7 	    CALLS   #1, SPACE_TM					      ;
		         01	  2E   AB  91 001CA 1$:     CMPB    46(CURRENT_VCB), #1					      ; 0662
				       05  12 001CE 	    BNEQ    2$							      ;
				       01  DD 001D0 	    PUSHL   #1							      ;
		         6A	       01  FB 001D2 	    CALLS   #1, SPACE_TM					      ;
		         02	  2E   AB  91 001D5 2$:     CMPB    46(CURRENT_VCB), #2					      ; 0665
				       25  12 001D9 	    BNEQ    4$							      ;
	   50	  0000G  CF 00000000G  8F  C1 001DB 	    ADDL3   #UCB$L_MT_RECORD, CURRENT_UCB, R0			      ; 0666
	   50	         60	  30   AB  C3 001E5 	    SUBL3   48(CURRENT_VCB), (R0), R0				      ;
				       14  12 001EA 	    BNEQ    4$							      ;
		         7E	  50   8F  9A 001EC 3$:     MOVZBL  #80, -(SP)						      ; 0667
				0000G  CF  DD 001F0 	    PUSHL   HDR1						      ;
		  0000G  CF	       02  FB 001F4 	    CALLS   #2, READ_BLOCK					      ;
		         04	       50  E8 001F9 	    BLBS    R0, 4$						      ;
				0224   8F  BF 001FC 	    CHMU    #548						      ;
	      31464F45   8F	0000G  DF  D1 00200 4$:     CMPL    @HDR1, #826691397					      ; 0671
				       19  13 00209 	    BEQL    6$							      ;
	      31564F45   8F	0000G  DF  D1 0020B 	    CMPL    @HDR1, #827739973					      ; 0672
				       04  13 00214 	    BEQL    5$							      ;
				0224   8F  BF 00216 	    CHMU    #548						      ;
				     0000  30 0021A 5$:     BSBW    GTNEXT_VOL_READ					      ; 0673
				       02  DD 0021D 	    PUSHL   #2							      ; 0674
		         6A	       01  FB 0021F 	    CALLS   #1, SPACE_TM					      ;
				       C8  11 00222 	    BRB     3$							      ; 0675

; Bliss-32 7.352	Saturday 21-AUG-1978 23:35:19	DBB3:[MTAACP.SRC]HEADER.B32;12					Page 5-2
; Digital Equipment Corporation
;
		         02	  2E   AB  91 00224 6$:     CMPB    46(CURRENT_VCB), #2					      ; 0678
				       05  12 00228 	    BNEQ    7$							      ;
				       01  DD 0022A 	    PUSHL   #1							      ;
		         6A	       01  FB 0022C 	    CALLS   #1, SPACE_TM					      ;
					   04 0022F 7$:     RET     							      ; 0606

; Routine Size:  130 bytes



; Bliss-32 7.352	Saturday 21-AUG-1978 23:35:19	DBB3:[MTAACP.SRC]HEADER.B32;12					Page 6
; Digital Equipment Corporation
;
;	0680	ROUTINE MAKE_CUR_FILE(LABELS) : COMMON_CALL NOVALUE  =
;	0681	
;	0682	!++
;	0683	!
;	0684	! FUNCTIONAL DESCRIPTION:
;	0685	!	THIS ROUTINE UPDATES THE CURRENT FILE NUMBER AND THE STARLET FILE INDICATOR
;	0686	!
;	0687	! CALLING SEQUENCE:
;	0688	!	UPDVCB(ARG1) , CALL IN KERNEL MODE
;	0689	!
;	0690	! INPUT PARAMETERS:
;	0691	!	ARG1 - ADDRESS OF LABELS
;	0692	!
;	0693	! IMPLICIT INPUTS:
;	0694	!	NONE
;	0695	!
;	0696	! OUTPUT PARAMETERS:
;	0697	!	NONE
;	0698	!
;	0699	! IMPLICIT OUTPUTS:
;	0700	!	IF FILE IS STARLET FILE, THEN VCB$V_STARFILE = 1
;	0701	!	CUR_NUM IS UPDATED
;	0702	!
;	0703	! ROUTINE VALUE:
;	0704	!	NONE
;	0705	!
;	0706	! SIDE EFFECTS:
;	0707	!	NONE
;	0708	!
;	0709	!--
;	0710	
;	0711	BEGIN
;	0712	
;	0713	EXTERNAL REGISTER
;	0714		COMMON_REG;
;	0715	
;	0716	
;	0717	MAP 
;	0718		LABELS	: REF BBLOCK;		!HDR1 AND HDR2 ADDRESS
;	0719	
;	0720	BIND
;	0721		STARID = UPLIT('DECFILE112   ');
;	0722	
;	0723	EXTERNAL ROUTINE
;	0724		FORMAT_FID;			!FORMAT FILE ID
;	0725	
;	0726	CURRENT_VCB[VCB$V_STARFILE] = CH$EQL(HD1$S_SYSCODE,STARID,HD1$S_SYSCODE,LABELS[HD1$T_SYSCODE],0);
;	0727	FORMAT_FID(CURRENT_VCB[VCB$W_CUR_NUM]);
;	0728	
;	0729	END;					!END OF ROUTINE



					      00230 P.AAD:  .ASCII  \DECFILE112   \<0><0><0>				      ;


; Bliss-32 7.352	Saturday 21-AUG-1978 23:35:19	DBB3:[MTAACP.SRC]HEADER.B32;12					Page 6-1
; Digital Equipment Corporation
;
						    STARID=		P.AAD
							    .GLOBL  FORMAT_FID

					 001C 00240 MAKE_CUR_FILE:
							    .WORD   Save R2,R3,R4					      ; 0680
		         50	  04   AC  D0 00242 	    MOVL    LABELS, R0						      ; 0726
				       54  D4 00246 	    CLRL    R4							      ;
      3C   A0	    E4   AF	       0D  29 00248 	    CMPC3   #13, STARID, 60(R0)					      ;
				       02  12 0024E 	    BNEQ    1$							      ;
				       54  D6 00250 	    INCL    R4							      ;
	   01	         00	       54  F0 00252 1$:     INSV    R4, #0, #1, 45(CURRENT_VCB)				      ;
				  2D   AB     00256									      ;
				  24   AB  9F 00258 	    PUSHAB  36(CURRENT_VCB)					      ; 0727
		  0000G  CF	       01  FB 0025B 	    CALLS   #1, FORMAT_FID					      ;
					   04 00260 	    RET     							      ; 0680

; Routine Size:  33 bytes



; Bliss-32 7.352	Saturday 21-AUG-1978 23:35:19	DBB3:[MTAACP.SRC]HEADER.B32;12					Page 7
; Digital Equipment Corporation
;
;	0730	ROUTINE UPDVCB_LEOV : COMMON_CALL NOVALUE  =
;	0731	
;	0732	!++
;	0733	!
;	0734	! FUNCTIONAL DESCRIPTION:
;	0735	!	THIS ROUTINE SETS THE LOGICAL END OF FILE BIT IN THE VCB
;	0736	!
;	0737	! CALLING SEQUENCE:
;	0738	!	UPDVCB_LEOV(), CALLED IN KERNEL MODE
;	0739	!
;	0740	! INPUT PARAMETERS:
;	0741	!	NONE
;	0742	!
;	0743	! IMPLICIT INPUTS:
;	0744	!	CURRENT_VCB - ADDRESS OF VOLUME CONTROL BLOCK
;	0745	!
;	0746	! OUTPUT PARAMETERS:
;	0747	!	NONE
;	0748	!
;	0749	! IMPLICIT OUTPUTS:
;	0750	!	CURRENT_VCB[VCB$V_LOGICEOVS] SET
;	0751	!
;	0752	! ROUTINE VALUE:
;	0753	!	NONE
;	0754	!
;	0755	! SIDE EFFECTS:
;	0756	!	NONE
;	0757	!
;	0758	!--
;	0759	
;	0760	BEGIN
;	0761	
;	0762	EXTERNAL REGISTER
;	0763		COMMON_REG;
;	0764	
;	0765	
;	0766	CURRENT_VCB[VCB$V_LOGICEOVS] = 1;
;	0767	END;						!END OF ROUTINE





					 0000 00261 UPDVCB_LEOV:
							    .WORD   Save nothing					      ; 0730
		    0B   AB	       02  88 00263 	    BISB2   #2, 11(CURRENT_VCB)					      ; 0766
					   04 00267 	    RET     							      ; 0730

; Routine Size:  7 bytes


;	0768	
;	0769	END
;	0770	ELUDOM


; Bliss-32 7.352	Saturday 21-AUG-1978 23:35:19	DBB3:[MTAACP.SRC]HEADER.B32;12					Page 7-1
; Digital Equipment Corporation
;





;				       PSECT SUMMARY
;
;	Name		 Bytes			       Attributes
;
;  $CODE$         	   616  NOWRT,  RD ,  EXE,NOSHR,  LCL,  REL,  CON,NOPIC,ALIGN(2)




;				LIBRARY STATISTICS
;
;					     -------- Symbols --------    Blocks
;	File				     Total    Loaded   Percent      Read
;
;  DBA4:[SYSLIB]LIB.L32;1		      5582        28         0       240





;	0771	
; Size:		577 code + 39 data bytes
; Run Time:	00:14.9
; Elapsed Time:	00:38.5
; Memory Used:	303 pages
; Compilation Complete
