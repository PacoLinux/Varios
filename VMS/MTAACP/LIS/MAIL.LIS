
; Bliss-32 7.352	Saturday 21-AUG-1978 23:37:16	DBB3:[MTAACP.SRC]MAIL.B32;5					Page 1
; Digital Equipment Corporation
;
;	0001	MODULE MAIL (
;	0002			LANGUAGE (BLISS32),
;	0003			IDENT = 'A0001'
;	0004			) =
;	0005	BEGIN
;	0006	
;	0007	!
;	0008	! COPYRIGHT (C) 1977
;	0009	! DIGITAL EQUIPMENT CORPORATION, MAYNARD, MASSACHUSETTS 01754
;	0010	!
;	0011	! THIS SOFTWARE IS FURNISHED  UNDER A LICENSE FOR USE ONLY ON A SINGLE
;	0012	! COMPUTER  SYSTEM AND  MAY BE  COPIED ONLY WITH  THE INCLUSION OF THE
;	0013	! ABOVE COPYRIGHT NOTICE.  THIS SOFTWARE, OR ANY OTHER COPIES THEREOF,
;	0014	! MAY NOT BE PROVIDED OR  OTHERWISE MADE AVAILABLE TO ANY OTHER PERSON
;	0015	! EXCEPT FOR USE ON SUCH SYSTEM AND TO ONE WHO AGREES TO THESE LICENSE
;	0016	! TERMS.  TITLE TO AND  OWNERSHIP OF THE  SOFTWARE  SHALL AT ALL TIMES
;	0017	! REMAIN IN DEC.
;	0018	!
;	0019	! THE INFORMATION IN THIS SOFTWARE IS SUBJECT TO CHANGE WITHOUT NOTICE
;	0020	! AND SHOULD  NOT BE CONSTRUED  AS A COMMITMENT  BY DIGITAL  EQUIPMENT
;	0021	! CORPORATION.
;	0022	!
;	0023	! DEC ASSUMES  NO  RESPONSIBILITY  FOR  THE USE OR  RELIABILITY OF ITS
;	0024	! SOFTWARE ON EQUIPMENT WHICH IS NOT SUPPLIED BY DEC.
;	0025	
;	0026	!++
;	0027	!
;	0028	! FACILITY:  MTAACP
;	0029	!
;	0030	! ABSTRACT:
;	0031	!	THIS MODULE HANDLES READING FROM THE MAILBOX AND ENABLING MAILBOX AST'S
;	0032	!
;	0033	!
;	0034	! ENVIRONMENT:
;	0035	!
;	0036	!	STARLET OPERATING SYSTEM, INCLUDING PRIVILEGED SYSTEM SERVICES
;	0037	!	AND INTERNAL EXEC ROUTINES.
;	0038	!
;	0039	!--
;	0040	!
;	0041	!
;	0042	! AUTHOR:  D. H. GILLESPIE,	 CREATION DATE:  31-OCT-77  
;	0043	!
;	0044	! REVISION HISTORY:
;	0045	!
;	0046	!   D. H. Gillespie, 12-May-78  14:13
;	0047	!   A0001 - change CURRENT_VCB to a register
;	0048	!
;	0049	!**
;	0050	
;	0051	LIBRARY	'SYS$LIBRARY:LIB.L32';
;	0052	REQUIRE 'SRC$:MTADEF.B32';
;	0348	
;	0349	FORWARD ROUTINE
;	0350		CHECK_MAIL	: COMMON_CALL NOVALUE,		!CHECK MAILBOX FOR REPLY FROM OPERATOR

; Bliss-32 7.352	Saturday 21-AUG-1978 23:37:16	DBB3:[MTAACP.SRC]MAIL.B32;5					Page 1-1
; Digital Equipment Corporation
;
;	0351		ENABLE_MAIL_AST	: COMMON_CALL NOVALUE;		!ENABLE AST'S FROM MAILBOX
;	0352	
;	0353	
;	0354	EXTERNAL ROUTINE
;	0355		DO_CANCEL,					!CANCEL ALL OUTSTANDING IO
;	0356		REQUEST_UNBLOCK,				!REQUEST UNBLOCK UNLESS CANCEL REQUESTED
;	0357		SYS$QIOW	: ADDRESSING_MODE(ABSOLUTE);	!QUEUE IO REQUEST AND WAIT
;	0358	
;	0359	EXTERNAL
;	0360		MAIL_CHANNEL,					!MAILBOX CHANNEL NUMBER
;	0361		IO_STATUS,					!STATUS OF IO
;	0362		WORK_AREA;					!WORK AREA DEFINED IN OPRCOM
;	0363	
;	0364	EXTERNAL LITERAL
;	0365		WORK_AREA_SZ;
;	0366	
;	0367	BIND
;	0368		MAIL	= WORK_AREA	: BBLOCK[MSGSIZE],
;	0369		MAILSZ	= WORK_AREA+MSGSIZE;

; Bliss-32 7.352	Saturday 21-AUG-1978 23:37:16	DBB3:[MTAACP.SRC]MAIL.B32;5					Page 2
; Digital Equipment Corporation
;
;	0370	GLOBAL ROUTINE CHECK_MAIL : COMMON_CALL NOVALUE  =
;	0371	
;	0372	!++
;	0373	!
;	0374	! FUNCTIONAL DESCRIPTION:
;	0375	!	THIS ROUTINE CHECKS FOR REPLY FROM OPERATOR IN MAILBOX
;	0376	!
;	0377	! CALLING SEQUENCE:
;	0378	!	CHECK_MAIL(), CALLED EITHER AS AN AST ROUTINE OR BEFORE HIBERNATING
;	0379	!
;	0380	! INPUT PARAMETERS:
;	0381	!	NONE
;	0382	!
;	0383	! IMPLICIT INPUTS:
;	0384	!	MAILBOX INPUT
;	0385	!
;	0386	! OUTPUT PARAMETERS:
;	0387	!	NONE
;	0388	!
;	0389	! IMPLICIT OUTPUTS:
;	0390	!	DEPENDING ON THE REPLY, THE BLOCKED REQUEST IS EITHER CANCELED, ABORTED OR
;	0391	!	CONTINUED
;	0392	!	MAILSZ - SIZE OF OPERATOR TEXT
;	0393	!	MAIL - CONTAINS MAILBOX MESSAGE WITH OPERATOR TEXT
;	0394	!
;	0395	! ROUTINE VALUE:
;	0396	!	NONE
;	0397	!
;	0398	! SIDE EFFECTS:
;	0399	!	NONE
;	0400	!
;	0401	! USER ERRORS:
;	0402	!	NONE
;	0403	!
;	0404	!--
;	0405	
;	0406	BEGIN
;	0407	
;	0408	EXTERNAL REGISTER
;	0409		COMMON_REG;
;	0410	
;	0411	
;	0412	LOCAL
;	0413		STATUS,
;	0414		VCB		: REF BBLOCK;		!ADDRESS OF VOLUME CONTROL BLOCK
;	0415	
;	0416	! READ THE MAILBOX AND IF NOTHING THERE EXIT IMMEDIATELY
;	0417	STATUS =
;	0418		SYS$QIOW(EFN,.MAIL_CHANNEL,IO$_READLBLK OR IO$M_NOW, IO_STATUS,,,MAIL,
;	0419			MSGSIZE,,,,);			!DON'T WAIT FOR REPLY
;	0420	IF NOT .STATUS THEN IO_STATUS = .STATUS;
;	0421	IF .IO_STATUS EQL SS$_ENDOFFILE THEN RETURN;
;	0422	
;	0423	! THE OTHER ERRORS THAT CAN SHOWUP ARE PROGRAMMING PROBLEMS-
;	0424	! SS$_NOPRIV,SS$_ACCVIO,SS$_MBTOOSML

; Bliss-32 7.352	Saturday 21-AUG-1978 23:37:16	DBB3:[MTAACP.SRC]MAIL.B32;5					Page 2-1
; Digital Equipment Corporation
;
;	0425	IF NOT .IO_STATUS THEN
;	0426	BUG_CHECK(ACPMBFAIL);
;	0427	
;	0428	! SETUP SIZE OF OPERATOR TEXT
;	0429	MAILSZ = .IO_STATUS<16,16> - $BYTEOFFSET(OPC$L_MS_TEXT);
;	0430	
;	0431	! NOW SINCE ALL AST'S ARE DELIVERED AT ONCE UPON RECEIPT TO ONE REPLY
;	0432	! REENABLE AST'S ON THIS MAILBOX
;	0433	ENABLE_MAIL_AST();
;	0434	
;	0435	! THE REPLY ID IS THE VCB ADDRESS, IF NOT VCB BLOCK THEN IGNORE MESSAGE
;	0436	VCB = .MAIL[OPC$L_MS_RPLYID];
;	0437	IF .VCB[VCB$B_TYPE] NEQ DYN$C_VCB THEN RETURN;
;	0438	
;	0439	! NOW EXAMINE MESSAGE TO SEE WHAT THE REPLY CONTAINS
;	0440	! IF REQUEST IS PENDING THEN IGNORE OPERATOR REPLY.
;	0441	STATUS = OPC$_RQSTPEND;
;	0442	IF .STATUS<0,16> EQL .MAIL[OPC$W_MS_STATUS] THEN RETURN;
;	0443	
;	0444	! IF THIS VOLUME IS NOT WAITING FOR VOLUME MOUNT THEN
;	0445	! THERE IS THE POSSIBILITY THAT A CANCEL_OP_REPLY FAILED AND THE CANCEL WAS 
;	0446	! COMPLETED BEFORE RECEIPT OF EITHER A COMPLETION OR CANCEL REPLY
;	0447	IF NOT .VCB[VCB$V_WAIMOUVOL] THEN RETURN;
;	0448	
;	0449	! IF THE REQUEST WAS SUCCESSFUL OR CANCELED THEN UNBLOCK THE PROCESS CHECKING
;	0450	! THAT THE CANCEL OF IO TAKES PLACE IF REQUESTED
;	0451	IF .MAIL[OPC$W_MS_STATUS] OR .VCB[VCB$V_CANCELIO] THEN
;	0452	    BEGIN
;	0453	    REQUEST_UNBLOCK(.VCB);
;	0454	    RETURN;			!RETURNS ONLY IF CANCEL DONE
;	0455	    END;
;	0456	
;	0457	! THE ONLY CASE LEFT IS THAT THE OPERATOR ABORTED THE REQUEST
;	0458	CURRENT_VCB = .VCB;
;	0459	ERROR(SS$_ABORT);
;	0460	KERNEL_CALL(DO_CANCEL);
;	0461	END;					!END OF ROUTINE


							    .TITLE  MAIL
							    .IDENT  \A0001\

							    .PSECT  $LOCKEDC2$,NOWRT,2

					      00000 P.AAA:  .WORD   0, -257						      ;
					      00004 	    .WORD    <BUG$_ACPMBFAIL!4>					      ;
					      00006	    .BLKB   2

							    .GLOBL  DO_CANCEL, REQUEST_UNBLOCK, SYS$QIOW, MAIL_CHANNEL
							    .GLOBL  IO_STATUS, WORK_AREA, WORK_AREA_SZ, BUG$_ACPMBFAIL
							    .GLOBL  USER_STATUS, SYS$CMKRNL

							    .PSECT  $CODE$,NOWRT,2

					 060C 00000 	    .ENTRY  CHECK_MAIL, Save R2,R3,R9,R10			      ; 0370

; Bliss-32 7.352	Saturday 21-AUG-1978 23:37:16	DBB3:[MTAACP.SRC]MAIL.B32;5					Page 2-2
; Digital Equipment Corporation
;
		         59	0000G  CF  9E 00002 	    MOVAB   IO_STATUS, R9					      ;
		         5A	0000G  CF  9E 00007 	    MOVAB   MAILSZ, R10						      ;
				       7E  7C 0000C 	    CLRQ    -(SP)						      ; 0418
				       7E  7C 0000E 	    CLRQ    -(SP)						      ;
				       14  DD 00010 	    PUSHL   #20							      ;
				  EC   AA  9F 00012 	    PUSHAB  MAIL						      ; 0370
				       7E  7C 00015 	    CLRQ    -(SP)						      ; 0418
				       59  DD 00017 	    PUSHL   R9							      ;
		         7E	  61   8F  9A 00019 	    MOVZBL  #97, -(SP)						      ;
				0000G  CF  DD 0001D 	    PUSHL   MAIL_CHANNEL					      ;
				       01  DD 00021 	    PUSHL   #1							      ;
	      00000000G  9F	       0C  FB 00023 	    CALLS   #12, @#SYS$QIOW					      ;
		         53	       50  D0 0002A 	    MOVL    R0, STATUS						      ;
		         03	       53  E8 0002D 	    BLBS    STATUS, 1$						      ; 0420
		         69	       53  D0 00030 	    MOVL    STATUS, IO_STATUS					      ;
	      00000870   8F	       69  D1 00033 1$:     CMPL    IO_STATUS, #2160					      ; 0421
				       58  13 0003A 	    BEQL    5$							      ;
		         05	       69  E8 0003C 	    BLBS    IO_STATUS, 2$					      ; 0425
		  0000'  CF	       00  FB 0003F 	    CALLS   #0, P.AAA						      ; 0426
		         6A	  02   A9  3C 00044 2$:     MOVZWL  IO_STATUS+2, MAILSZ					      ; 0429
		         6A	       08  C2 00048 	    SUBL2   #8, MAILSZ						      ;
		  0000V  CF	       00  FB 0004B 	    CALLS   #0, ENABLE_MAIL_AST					      ; 0433
		         52	  F0   AA  D0 00050 	    MOVL    MAIL+4, VCB						      ; 0436
		         11	  0A   A2  91 00054 	    CMPB    10(VCB), #17					      ; 0437
				       3A  12 00058 	    BNEQ    5$							      ;
		         53 00058021   8F  D0 0005A 	    MOVL    #360481, STATUS					      ; 0441
		    EE   AA	       53  B1 00061 	    CMPW    STATUS, MAIL+2					      ; 0442
				       2D  13 00065 	    BEQL    5$							      ;
	   28	    0B   A2	       02  E1 00067 	    BBC     #2, 11(VCB), 5$					      ; 0447
		         05	  EE   AA  E8 0006C 	    BLBS    MAIL+2, 3$						      ; 0451
	   08	    0B   A2	       05  E1 00070 	    BBC     #5, 11(VCB), 4$					      ;
				       52  DD 00075 3$:     PUSHL   VCB							      ; 0453
		  0000G  CF	       01  FB 00077 	    CALLS   #1, REQUEST_UNBLOCK					      ;
					   04 0007C 	    RET     							      ; 0454
		         5B	       52  D0 0007D 4$:     MOVL    VCB, CURRENT_VCB					      ; 0458
		  0000G  CF	       2C  B0 00080 	    MOVW    #44, USER_STATUS					      ; 0459
				       7E  D4 00085 	    CLRL    -(SP)						      ; 0460
				       5E  DD 00087 	    PUSHL   SP							      ;
				0000G  CF  9F 00089 	    PUSHAB  DO_CANCEL						      ;
	      00000000G  9F	       03  FB 0008D 	    CALLS   #3, @#SYS$CMKRNL					      ;
					   04 00094 5$:     RET     							      ; 0370

; Routine Size:  149 bytes


;	0462	

; Bliss-32 7.352	Saturday 21-AUG-1978 23:37:16	DBB3:[MTAACP.SRC]MAIL.B32;5					Page 3
; Digital Equipment Corporation
;
;	0463	GLOBAL ROUTINE ENABLE_MAIL_AST : COMMON_CALL NOVALUE  =
;	0464	
;	0465	!++
;	0466	!
;	0467	! FUNCTIONAL DESCRIPTION:
;	0468	!	THIS ROUTINE ENABLES AST'S ON THE MAILBOX CHANNEL
;	0469	!
;	0470	! CALLING SEQUENCE:
;	0471	!	ENABLE_MAIL_AST()
;	0472	!
;	0473	! INPUT PARAMETERS:
;	0474	!	NONE
;	0475	!
;	0476	! IMPLICIT INPUTS:
;	0477	!	NONE
;	0478	!
;	0479	! OUTPUT PARAMETERS:
;	0480	!	NONE
;	0481	!
;	0482	! IMPLICIT OUTPUTS:
;	0483	!	AST DECLARATION FOR MAILBOX ENABLED
;	0484	!
;	0485	! ROUTINE VALUE:
;	0486	!	NONE
;	0487	!
;	0488	! SIDE EFFECTS:
;	0489	!	NONE
;	0490	!
;	0491	! USER ERRORS:
;	0492	!	NONE
;	0493	!
;	0494	!--
;	0495	
;	0496	BEGIN
;	0497	
;	0498	EXTERNAL REGISTER
;	0499		COMMON_REG;
;	0500	
;	0501	
;	0502	BIND SECONDS = UPLIT(-70000000,-1);
;	0503	
;	0504	! THIS ENABLES AN AST WHEN MAIL IS PLACED IN THE OPERATOR COMMUNICATION MAILBOX
;	0505	WHILE 1 DO
;	0506	    BEGIN
;	0507	    (LOCAL STATUS;
;	0508	    STATUS =
;	0509	    SYS$QIOW(EFN,.MAIL_CHANNEL,IO$_SETMODE,IO_STATUS,,,CHECK_MAIL,,EXEC_MODE,,,);
;	0510	    IF NOT .STATUS THEN IO_STATUS = .STATUS);
;	0511	    IF .IO_STATUS NEQ SS$_INSFMEM THEN EXITLOOP;
;	0512	    IF $SETIMR(EFN=TIMEFN,DAYTIM=SECONDS) THEN $WAITFR(EFN=TIMEFN);
;	0513	    END;
;	0514	
;	0515	END;				!END OF ROUTINE



; Bliss-32 7.352	Saturday 21-AUG-1978 23:37:16	DBB3:[MTAACP.SRC]MAIL.B32;5					Page 3-1
; Digital Equipment Corporation
;

					      00095	    .BLKB   3
					      00098 P.AAB:  .LONG   -70000000, -1					      ;

						    SECONDS=		P.AAB
							    .GLOBL  SYS$SETIMR, SYS$WAITFR

					 0400 000A0 	    .ENTRY  ENABLE_MAIL_AST, Save R10				      ; 0463
		         5A	0000G  CF  9E 000A2 	    MOVAB   IO_STATUS, R10					      ;
				       7E  7C 000A7 1$:     CLRQ    -(SP)						      ; 0509
		         7E	       01  7D 000A9 	    MOVQ    #1, -(SP)						      ;
				       7E  D4 000AC 	    CLRL    -(SP)						      ;
				FF4E   CF  9F 000AE 	    PUSHAB  CHECK_MAIL						      ;
				       7E  7C 000B2 	    CLRQ    -(SP)						      ;
				       5A  DD 000B4 	    PUSHL   R10							      ;
				       23  DD 000B6 	    PUSHL   #35							      ;
				0000G  CF  DD 000B8 	    PUSHL   MAIL_CHANNEL					      ;
				       01  DD 000BC 	    PUSHL   #1							      ;
	      00000000G  9F	       0C  FB 000BE 	    CALLS   #12, @#SYS$QIOW					      ;
		         03	       50  E8 000C5 	    BLBS    STATUS, 2$						      ; 0510
		         6A	       50  D0 000C8 	    MOVL    STATUS, IO_STATUS					      ;
	      00000124   8F	       6A  D1 000CB 2$:     CMPL    IO_STATUS, #292					      ; 0511
				       1C  12 000D2 	    BNEQ    3$							      ;
				       7E  7C 000D4 	    CLRQ    -(SP)						      ; 0512
				  BF   AF  9F 000D6 	    PUSHAB  SECONDS						      ; 0463
				       03  DD 000D9 	    PUSHL   #3							      ; 0512
	      00000000G  9F	       04  FB 000DB 	    CALLS   #4, @#SYS$SETIMR					      ;
		         C2	       50  E9 000E2 	    BLBC    R0, 1$						      ;
				       03  DD 000E5 	    PUSHL   #3							      ;
	      00000000G  9F	       01  FB 000E7 	    CALLS   #1, @#SYS$WAITFR					      ;
				       B7  11 000EE 	    BRB     1$							      ; 0505
					   04 000F0 3$:     RET     							      ; 0463

; Routine Size:  81 bytes


;	0516	END
;	0517	ELUDOM






;				       PSECT SUMMARY
;
;	Name		 Bytes			       Attributes
;
;  $LOCKEDC2$     	     8  NOWRT,  RD ,  EXE,NOSHR,  LCL,  REL,  CON,NOPIC,ALIGN(2)
;  $CODE$         	   241  NOWRT,  RD ,  EXE,NOSHR,  LCL,  REL,  CON,NOPIC,ALIGN(2)




;				LIBRARY STATISTICS

; Bliss-32 7.352	Saturday 21-AUG-1978 23:37:16	DBB3:[MTAACP.SRC]MAIL.B32;5					Page 3-2
; Digital Equipment Corporation
;
;
;					     -------- Symbols --------    Blocks
;	File				     Total    Loaded   Percent      Read
;
;  DBA4:[SYSLIB]LIB.L32;1		      5582        23         0       240





;	0518	
; Size:		230 code + 19 data bytes
; Run Time:	00:08.3
; Elapsed Time:	00:25.0
; Memory Used:	285 pages
; Compilation Complete
