
; Bliss-32 7.352	Saturday 21-AUG-1978 23:28:02	DBB3:[MTAACP.SRC]CHKDMO.B32;12					Page 1
; Digital Equipment Corporation
;
;	0001	MODULE CHKDMO (
;	0002			LANGUAGE (BLISS32),
;	0003			IDENT = 'A0005'
;	0004			) =
;	0005	BEGIN
;	0006	
;	0007	!
;	0008	! Copyright (c) 1977
;	0009	! Digital Equipment Corporation, Maynard, Massachusetts 01754
;	0010	!
;	0011	! This software is furnished  under a license for use only on a single
;	0012	! computer  system and  may be  copied only with  the inclusion of the
;	0013	! above copyright notice.  This software, or any other copies thereof,
;	0014	! may not be provided or  otherwise made available to any other person
;	0015	! except for use on such system and to one who agrees to these license
;	0016	! terms.  Title to and  ownership of the  software  shall at all times
;	0017	! remain in DEC.
;	0018	!
;	0019	! The information in this software is subject to change without notice
;	0020	! and should  not be construed  as a commitment  by Digital  Equipment
;	0021	! Corporation.
;	0022	!
;	0023	! DEC assumes  no  responsibility  for  the use or  reliability of its
;	0024	! software on equipment which is not supplied by DEC.
;	0025	
;	0026	!++
;	0027	!
;	0028	! FACILITY:  VAS/VMS MTAACP
;	0029	!
;	0030	! ABSTRACT:
;	0031	!
;	0032	!	This routine dismounts the volume in use if it should be.
;	0033	!
;	0034	! ENVIRONMENT:
;	0035	!
;	0036	!	VAX/VMS operating system, including privileged system services
;	0037	!	and internal exec routines.
;	0038	!
;	0039	!--
;	0040	!
;	0041	!
;	0042	! AUTHOR:  Andrew C. Goldstein,	 CREATION DATE:  29-Apr-1977  17:19
;	0043	!
;	0044	! REVISION HISTORY:
;	0045	!
;	0046	!   Andrew C. Goldstein, 5-May-1977  22:31
;	0047	!   X0002 - Clear volume protection in UCB on dismount
;	0048	!
;	0049	!   Andrew C. Goldstein, 9-May-1977  16:48
;	0050	!   X0003 - Add call to flush buffer pool
;	0051	!
;	0052	!   DEBORAH H. GILLESPIE, 9-Jul-1977  12:35
;	0053	!   X0004 - CHANGE FOR MAGNETIC TAPE
;	0054	!
;	0055	!   D. H. Gillespie, 1-Feb-1978  13:41

; Bliss-32 7.352	Saturday 21-AUG-1978 23:28:02	DBB3:[MTAACP.SRC]CHKDMO.B32;12					Page 1-1
; Digital Equipment Corporation
;
;	0056	!   A0001 - ADD REWIND OF VOLUMES ON DISMOUNT
;	0057	!
;	0058	!   D. H. Gillespie, 18-May-78  15:12
;	0059	!   A0002 - add UNLOAD function on DISMOUNT
;	0060	!
;	0061	!   D. H. Gillespie, 8-Jun-78  8:22
;	0062	!   A0003 - change CTL$GL_CCB to @CTL$GL_CCBBASE
;	0063	!
;	0064	!   D. H. Gillespie, 28-Jun-78  9:12
;	0065	!   A0004 - add send message to error logger
;	0066	!
;	0067	!**
;	0068	
;	0069	
;	0070	LIBRARY	'SYS$LIBRARY:LIB.L32';
;	0071	REQUIRE 'SRC$:MTADEF.B32';
;	0367	
;	0368	
;	0369	!
;	0370	! Part of this routine runs at IPL$_SYNCH, so it must be locked into the
;	0371	! working set.
;	0372	!
;	0373	
;	0374	LOCK_CODE;

; Bliss-32 7.352	Saturday 21-AUG-1978 23:28:02	DBB3:[MTAACP.SRC]CHKDMO.B32;12					Page 2
; Digital Equipment Corporation
;
;	0375	GLOBAL ROUTINE CHECK_DISMOUNT(UCB) : NOVALUE =
;	0376	
;	0377	!++
;	0378	!
;	0379	! FUNCTIONAL DESCRIPTION:
;	0380	!
;	0381	!	This routine checks if the volume in use is marked for dismount and
;	0382	!	idle. If so, it completes the dismount.
;	0383	!
;	0384	! CALLING SEQUENCE:
;	0385	!	CHECK_DISMOUNT (ARG1)
;	0386	!
;	0387	! INPUT PARAMETERS:
;	0388	!	ARG1 - ADDRESS OF UNIT CONTROL BLOCK for primary UCB
;	0389	!
;	0390	! IMPLICIT INPUTS:
;	0391	!	QUEUE_HEAD: queue header for ACP
;	0392	!
;	0393	! OUTPUT PARAMETERS:
;	0394	!	NONE
;	0395	!
;	0396	! IMPLICIT OUTPUTS:
;	0397	!	NONE
;	0398	!
;	0399	! ROUTINE VALUE:
;	0400	!	NONE
;	0401	!
;	0402	! SIDE EFFECTS:
;	0403	!	Volume dismounted if appropriate
;	0404	!
;	0405	!--
;	0406	
;	0407	BEGIN
;	0408	
;	0409	LITERAL
;	0410		SUPER_MODE	= 2;		!SUPERVISOR MODE
;	0411	
;	0412	MAP
;	0413		UCB		: REF BBLOCK;	! ADDRESS OF UNIT CONTROL BLOCK
;	0414	
;	0415	LOCAL
;	0416		CCB		: REF BBLOCK,	!address of channel control block
;	0417		MVL_ENTRY	: REF BBLOCKVECTOR[,MVL$K_LENGTH],	!address of mag tape volume entry
;	0418		PAGE,
;	0419		UCBLIST		: REF VECTOR,	! VECTOR OF UCB'S ALLOCATED TO VOLUME SET
;	0420		VCB		: REF BBLOCK;	! local address of VCB
;	0421	
;	0422	EXTERNAL
;	0423		CTL$GL_CCBBASE	: REF BBLOCK ADDRESSING_MODE(ABSOLUTE),	!base address of channel control blocks
;	0424		IO_CHANNEL,			! assign channel for tape I/O
;	0425		QUEUE_HEAD	: REF BBLOCK;	! address of ACP queue header
;	0426	
;	0427	EXTERNAL ROUTINE
;	0428		RET_FREE_PAGE,			! RETURN FREE PAGE TO VIRTUAL MEMORY POOL
;	0429		LOCK_IODB,			! lock I/O data base mutex

; Bliss-32 7.352	Saturday 21-AUG-1978 23:28:02	DBB3:[MTAACP.SRC]CHKDMO.B32;12					Page 2-1
; Digital Equipment Corporation
;
;	0430		SEND_ERRLOG,
;	0431		UNLOCK_IODB,			! unlock I/O data base mutex
;	0432		DEALLOCATE;			! deallocate dynamic memory
;	0433	
;	0434	! first check if the volume is marked for dismount
;	0435	!
;	0436	IF NOT .BBLOCK[UCB[UCB$L_DEVCHAR],DEV$V_DMT] THEN RETURN;
;	0437	
;	0438	VCB = .UCB[UCB$L_VCB];			! pickup VCB address
;	0439	
;	0440	! The volume is marked for dismount. The remainder of the tests and the
;	0441	! dismount bit twiddling must be done interlocked.
;	0442	!
;	0443	
;	0444	LOCK_IODB ();
;	0445	SET_IPL (IPL$_SYNCH);
;	0446	
;	0447	IF .VCB[VCB$W_TRANS] EQL 1
;	0448	THEN
;	0449	    BEGIN
;	0450	
;	0451	! The volume is marked for dismount and idle.  Mark primary unit and secondary
;	0452	! units dismounted and deallocate those units which should be on dismount.
;	0453	!
;	0454	
;	0455	    UCBLIST = BBLOCK[.VCB[VCB$L_RVT],RVT$L_UCBLST];
;	0456	    DECR NVOL FROM .BBLOCK[.VCB[VCB$L_RVT],RVT$B_NVOLS] - 1 TO 0 DO
;	0457		BEGIN
;	0458		UCB = .UCBLIST[.NVOL];			! UCB from RVT list
;	0459		SEND_ERRLOG(0,.UCB);
;	0460		UCB[UCB$B_AMOD] = SUPER_MODE;		! set allocation access mode to super
;	0461		IF .UCB[UCB$V_DEADMO] AND .BBLOCK[UCB[UCB$L_DEVCHAR],DEV$V_ALL]
;	0462		THEN
;	0463		    BEGIN
;	0464		    UCB[UCB$V_DEADMO] = 0;
;	0465		    BBLOCK[UCB[UCB$L_DEVCHAR],DEV$V_ALL] = 0;
;	0466		    UCB[UCB$W_REFC] = .UCB[UCB$W_REFC] - 1;
;	0467		    UCB[UCB$L_PID] = 0;
;	0468		    END;
;	0469	
;	0470		BBLOCK [UCB[UCB$L_DEVCHAR], DEV$V_MNT] = 0;
;	0471		BBLOCK [UCB[UCB$L_DEVCHAR], DEV$V_DMT] = 0;
;	0472		BBLOCK [UCB[UCB$L_DEVCHAR], DEV$V_SWL] = 0;
;	0473		UCB[UCB$L_VCB] = 0;
;	0474		UCB[UCB$W_VPROT] = 0;
;	0475		UCB[UCB$L_OWNUIC] = 0;
;	0476		END;
;	0477	
;	0478	! We can now release the locks while we proceed to clean up the mounted
;	0479	! volume data base.
;	0480	!
;	0481	
;	0482	    UNLOCK_IODB ();
;	0483	
;	0484	

; Bliss-32 7.352	Saturday 21-AUG-1978 23:28:02	DBB3:[MTAACP.SRC]CHKDMO.B32;12					Page 2-2
; Digital Equipment Corporation
;
;	0485	! Now rewind those volumes that are still on a unit
;	0486	    CCB = .CTL$GL_CCBBASE - .IO_CHANNEL;	! calc address of channel control block
;	0487	    MVL_ENTRY = .VCB[VCB$L_MVL] + MVL$K_FIXLEN;
;	0488	
;	0489	! set UCB to primary UCB which has the UNLOAD/NOUNLOAD indicator
;	0490	    UCB = .UCBLIST[0];
;	0491	    DECR NVOL FROM .BBLOCK[.VCB[VCB$L_MVL],MVL$B_NVOLS] - 1 TO 0 DO
;	0492		BEGIN
;	0493		LOCAL FUNCTION;
;	0494		IF .MVL_ENTRY[.NVOL,MVL$V_MOUNTED] THEN
;	0495		    BEGIN
;	0496		    CCB[CCB$L_UCB] = .UCBLIST[.MVL_ENTRY[.NVOL,MVL$B_RVN]];	! pseudo assign device
;	0497		    IF .UCB[UCB$V_UNLOAD] 
;	0498		    THEN FUNCTION = IO$_UNLOAD OR IO$M_NOWAIT
;	0499		    ELSE FUNCTION = IO$_REWIND OR IO$M_NOWAIT;
;	0500		    $QIOW	( CHAN = .IO_CHANNEL,
;     P 0501				  FUNC = .FUNCTION);
;	0502		    END;
;	0503		END;
;	0504	
;	0505	! Run thru UCB's "invalidating" them
;	0506	    LOCK_IODB();
;	0507	    SET_IPL(IPL$_SYNCH);
;	0508	    DECR NVOL FROM .BBLOCK[.VCB[VCB$L_RVT],RVT$B_NVOLS] - 1 TO 0 DO
;	0509		BEGIN
;	0510		UCB = .UCBLIST[.NVOL];
;	0511		UCB[UCB$V_VALID] = 0;
;	0512		END;
;	0513	    UNLOCK_IODB();
;	0514	    DEALLOCATE(.VCB[VCB$L_RVT]);
;	0515	    DEALLOCATE(.VCB[VCB$L_MVL]);
;	0516	
;	0517	! RETURN VOLUME VIRTUAL PAGE
;	0518	    WHILE 1 DO
;	0519		BEGIN
;	0520		IF REMQUE(.VCB[VCB$L_VPFL],PAGE) THEN EXITLOOP;
;	0521		RET_FREE_PAGE(.PAGE);
;	0522		END;
;	0523	    DEALLOCATE (.VCB);			! release the VCB
;	0524	
;	0525	
;	0526	    QUEUE_HEAD[AQB$B_MNTCNT] = .QUEUE_HEAD[AQB$B_MNTCNT] - 1;
;	0527	    END					! end of dismount processing
;	0528	
;	0529	ELSE
;	0530	    UNLOCK_IODB ();
;	0531	
;	0532	END;					! end of routine CHECK_DISMOUNT


							    .TITLE  CHKDMO
							    .IDENT  \A0005\

							    .GLOBL  CTL$GL_CCBBASE, IO_CHANNEL, QUEUE_HEAD, RET_FREE_PAGE
							    .GLOBL  LOCK_IODB, SEND_ERRLOG, UNLOCK_IODB, DEALLOCATE

; Bliss-32 7.352	Saturday 21-AUG-1978 23:28:02	DBB3:[MTAACP.SRC]CHKDMO.B32;12					Page 2-3
; Digital Equipment Corporation
;
							    .GLOBL  SYS$QIOW

							    .PSECT  $LOCKEDC1$,NOWRT,2

					 0DFC 00000 	    .ENTRY  CHECK_DISMOUNT, Save R2,R3,R4,R5,R6,R7,R8,R10,R11	      ; 0375
		         5A	0000G  CF  9E 00002 	    MOVAB   DEALLOCATE, R10					      ;
		         5B	0000G  CF  9E 00007 	    MOVAB   UNLOCK_IODB, R11					      ;
		         50	  04   AC  D0 0000C 	    MOVL    UCB, R0						      ; 0436
	   01	    36   A0	       05  E0 00010 	    BBS     #5, 54(R0), 1$					      ;
					   04 00015 	    RET     							      ;
		         54	  30   A0  D0 00016 1$:     MOVL    48(R0), VCB						      ; 0438
		  0000G  CF	       00  FB 0001A 	    CALLS   #0, LOCK_IODB					      ; 0444
		         12	       07  DA 0001F 	    MTPR    #7, #18						      ; 0445
		         01	  0C   A4  B1 00022 	    CMPW    12(VCB), #1						      ; 0447
				       03  13 00026 	    BEQL    2$							      ;
				     00F7  31 00028 	    BRW     14$							      ;
		         56	  20   A4  D0 0002B 2$:     MOVL    32(VCB), R6						      ; 0455
	   57	         56	       0C  C1 0002F 	    ADDL3   #12, R6, UCBLIST					      ;
		         53	  0B   A6  9A 00033 	    MOVZBL  11(R6), NVOL					      ; 0456
				       3E  11 00037 	    BRB     5$							      ;
		    04   AC	     6743  D0 00039 3$:     MOVL    (UCBLIST)[NVOL], UCB				      ; 0458
		         52	  04   AC  D0 0003E 	    MOVL    UCB, R2						      ; 0459
				       52  DD 00042 	    PUSHL   R2							      ;
				       7E  D4 00044 	    CLRL    -(SP)						      ;
		  0000G  CF	       02  FB 00046 	    CALLS   #2, SEND_ERRLOG					      ;
		    53   A2	       02  90 0004B 	    MOVB    #2, 83(R2)						      ; 0460
	   14	    59   A2	       02  E1 0004F 	    BBC     #2, 89(R2), 4$					      ; 0461
	   0F	    36   A2	       07  E1 00054 	    BBC     #7, 54(R2), 4$					      ;
		    59   A2	       04  8A 00059 	    BICB2   #4, 89(R2)						      ; 0464
		    36   A2	  80   8F  8A 0005D 	    BICB2   #128, 54(R2)					      ; 0465
				  50   A2  B7 00062 	    DECW    80(R2)						      ; 0466
				  28   A2  D4 00065 	    CLRL    40(R2)						      ; 0467
		    36   A2	0228   8F  AA 00068 4$:     BICW2   #552, 54(R2)					      ; 0472
				  30   A2  D4 0006E 	    CLRL    48(R2)						      ; 0473
				  1A   A2  B4 00071 	    CLRW    26(R2)						      ; 0474
				  1C   A2  D4 00074 	    CLRL    28(R2)						      ; 0475
		         BF	       53  F4 00077 5$:     SOBGEQ  NVOL, 3$						      ; 0456
		         6B	       00  FB 0007A 	    CALLS   #0, UNLOCK_IODB					      ; 0482
	   58 00000000G  9F	0000G  CF  C3 0007D 	    SUBL3   IO_CHANNEL, @#CTL$GL_CCBBASE, CCB			      ; 0486
		         55	  34   A4  D0 00087 	    MOVL    52(VCB), R5						      ; 0487
	   53	         55	       0C  C1 0008B 	    ADDL3   #12, R5, MVL_ENTRY					      ;
		    04   AC	       67  D0 0008F 	    MOVL    (UCBLIST), UCB					      ; 0490
		         52	  0B   A5  9A 00093 	    MOVZBL  11(R5), NVOL					      ; 0491
				       3E  11 00097 	    BRB     9$							      ;
				  07 A342  7F 00099 6$:     PUSHAQ  7(MVL_ENTRY)[NVOL]					      ; 0494
		         37	       9E  E9 0009D 	    BLBC    @(SP)+, 9$						      ;
				  06 A342  7F 000A0 	    PUSHAQ  6(MVL_ENTRY)[NVOL]					      ; 0496
		         50	       9E  9A 000A4 	    MOVZBL  @(SP)+, R0						      ;
		         68	     6740  D0 000A7 	    MOVL    (UCBLIST)[R0], (CCB)				      ;
		         50	  04   AC  D0 000AB 	    MOVL    UCB, R0						      ; 0497
	   06	    59   A0	       04  E1 000AF 	    BBC     #4, 89(R0), 7$					      ;
		         50	  81   8F  9A 000B4 	    MOVZBL  #129, FUNCTION					      ; 0498
				       04  11 000B8 	    BRB     8$							      ; 0497
		         50	  A4   8F  9A 000BA 7$:     MOVZBL  #164, FUNCTION					      ; 0499
				       7E  7C 000BE 8$:     CLRQ    -(SP)						      ; 0501

; Bliss-32 7.352	Saturday 21-AUG-1978 23:28:02	DBB3:[MTAACP.SRC]CHKDMO.B32;12					Page 2-4
; Digital Equipment Corporation
;
				       7E  7C 000C0 	    CLRQ    -(SP)						      ;
				       7E  7C 000C2 	    CLRQ    -(SP)						      ;
				       7E  7C 000C4 	    CLRQ    -(SP)						      ;
				       7E  D4 000C6 	    CLRL    -(SP)						      ;
				       50  DD 000C8 	    PUSHL   FUNCTION						      ;
				0000G  CF  DD 000CA 	    PUSHL   IO_CHANNEL						      ;
				       7E  D4 000CE 	    CLRL    -(SP)						      ;
	      00000000G  9F	       0C  FB 000D0 	    CALLS   #12, @#SYS$QIOW					      ;
		         BF	       52  F4 000D7 9$:     SOBGEQ  NVOL, 6$						      ; 0491
		  0000G  CF	       00  FB 000DA 	    CALLS   #0, LOCK_IODB					      ; 0506
		         12	       07  DA 000DF 	    MTPR    #7, #18						      ; 0507
		         50	  0B   A6  9A 000E2 	    MOVZBL  11(R6), NVOL					      ; 0508
				       0D  11 000E6 	    BRB     11$							      ;
		    04   AC	     6740  D0 000E8 10$:    MOVL    (UCBLIST)[NVOL], UCB				      ; 0510
		         51	  04   AC  D0 000ED 	    MOVL    UCB, R1						      ; 0511
		    59   A1	       08  8A 000F1 	    BICB2   #8, 89(R1)						      ;
		         F0	       50  F4 000F5 11$:    SOBGEQ  NVOL, 10$						      ; 0508
		         6B	       00  FB 000F8 	    CALLS   #0, UNLOCK_IODB					      ; 0513
				       56  DD 000FB 	    PUSHL   R6							      ; 0514
		         6A	       01  FB 000FD 	    CALLS   #1, DEALLOCATE					      ;
				       55  DD 00100 	    PUSHL   R5							      ; 0515
		         6A	       01  FB 00102 	    CALLS   #1, DEALLOCATE					      ;
		         52	  3C   B4  0F 00105 12$:    REMQUE  @60(VCB), PAGE					      ; 0520
				       09  1D 00109 	    BVS     13$							      ;
				       52  DD 0010B 	    PUSHL   PAGE						      ; 0521
		  0000G  CF	       01  FB 0010D 	    CALLS   #1, RET_FREE_PAGE					      ;
				       F1  11 00112 	    BRB     12$							      ; 0518
				       54  DD 00114 13$:    PUSHL   VCB							      ; 0523
		         6A	       01  FB 00116 	    CALLS   #1, DEALLOCATE					      ;
		         50	0000G  CF  D0 00119 	    MOVL    QUEUE_HEAD, R0					      ; 0526
				  0B   A0  97 0011E 	    DECB    11(R0)						      ;
					   04 00121 	    RET     							      ; 0447
		         6B	       00  FB 00122 14$:    CALLS   #0, UNLOCK_IODB					      ; 0530
					   04 00125 15$:    RET     							      ; 0375

; Routine Size:  294 bytes


;	0533	
;	0534	END
;	0535	ELUDOM






;				       PSECT SUMMARY
;
;	Name		 Bytes			       Attributes
;
;  $LOCKEDC1$     	   294  NOWRT,  RD ,  EXE,NOSHR,  LCL,  REL,  CON,NOPIC,ALIGN(2)
;  $CODE$         	     0  NOWRT,  RD ,  EXE,NOSHR,  LCL,  REL,  CON,NOPIC,ALIGN(2)



; Bliss-32 7.352	Saturday 21-AUG-1978 23:28:02	DBB3:[MTAACP.SRC]CHKDMO.B32;12					Page 2-5
; Digital Equipment Corporation
;


;				LIBRARY STATISTICS
;
;					     -------- Symbols --------    Blocks
;	File				     Total    Loaded   Percent      Read
;
;  DBA4:[SYSLIB]LIB.L32;1		      5582        38         0       251





; Size:		294 code + 0 data bytes
; Run Time:	00:11.1
; Elapsed Time:	00:32.3
; Memory Used:	336 pages
; Compilation Complete
