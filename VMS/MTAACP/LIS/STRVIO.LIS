
; Bliss-32 7.352	Saturday 21-AUG-1978 23:46:14	DBB3:[MTAACP.SRC]STRVIO.B32;3					Page 1
; Digital Equipment Corporation
;
;	0001	MODULE STRVIO (
;	0002			LANGUAGE (BLISS32),
;	0003			IDENT = 'A0001'
;	0004			) =
;	0005	BEGIN
;	0006	
;	0007	!
;	0008	! COPYRIGHT (C) 1977
;	0009	! DIGITAL EQUIPMENT CORPORATION, MAYNARD, MASSACHUSETTS 01754
;	0010	!
;	0011	! THIS SOFTWARE IS FURNISHED  UNDER A LICENSE FOR USE ONLY ON A SINGLE
;	0012	! COMPUTER  SYSTEM AND  MAY BE  COPIED ONLY WITH  THE INCLUSION OF THE
;	0013	! ABOVE COPYRIGHT NOTICE.  THIS SOFTWARE, OR ANY OTHER COPIES THEREOF,
;	0014	! MAY NOT BE PROVIDED OR  OTHERWISE MADE AVAILABLE TO ANY OTHER PERSON
;	0015	! EXCEPT FOR USE ON SUCH SYSTEM AND TO ONE WHO AGREES TO THESE LICENSE
;	0016	! TERMS.  TITLE TO AND  OWNERSHIP OF THE  SOFTWARE  SHALL AT ALL TIMES
;	0017	! REMAIN IN DEC.
;	0018	!
;	0019	! THE INFORMATION IN THIS SOFTWARE IS SUBJECT TO CHANGE WITHOUT NOTICE
;	0020	! AND SHOULD  NOT BE CONSTRUED  AS A COMMITMENT  BY DIGITAL  EQUIPMENT
;	0021	! CORPORATION.
;	0022	!
;	0023	! DEC ASSUMES  NO  RESPONSIBILITY  FOR  THE USE OR  RELIABILITY OF ITS
;	0024	! SOFTWARE ON EQUIPMENT WHICH IS NOT SUPPLIED BY DEC.
;	0025	
;	0026	!++
;	0027	!
;	0028	! FACILITY:  MTAACP
;	0029	!
;	0030	! ABSTRACT:
;	0031	!	THIS MODULE REQUEUES BLOCK VIRTUAL IO ON THE CURRENT UNIT
;	0032	!
;	0033	!
;	0034	! ENVIRONMENT:
;	0035	!
;	0036	!	STARLET OPERATING SYSTEM, INCLUDING PRIVILEGED SYSTEM SERVICES
;	0037	!	AND INTERNAL EXEC ROUTINES.
;	0038	!
;	0039	!--
;	0040	!
;	0041	!
;	0042	! AUTHOR:  D. H. GILLESPIE,	 CREATION DATE:  30-AUG-1977  
;	0043	!
;	0044	! REVISION HISTORY:
;	0045	!
;	0046	!   D. H. Gillespie, 15-May-78  8:49
;	0047	!   A0001 - change CURRENT_VCB to a register
;	0048	!
;	0049	!**
;	0050	
;	0051	LIBRARY 'SYS$LIBRARY:LIB.L32';
;	0052	REQUIRE 'SRC$:MTADEF.B32';
;	0348	LINKAGE
;	0349		INS_QUE		= JSB(REGISTER = 3, REGISTER = 5) : NOPRESERVE (1,2,4);
;	0350	

; Bliss-32 7.352	Saturday 21-AUG-1978 23:46:14	DBB3:[MTAACP.SRC]STRVIO.B32;3					Page 1-1
; Digital Equipment Corporation
;
;	0351	EXTERNAL
;	0352		CURRENT_UCB	: REF BBLOCK,	!ADDRESS OF CURRENT UNIT CONTROL BLOCK
;	0353		CURRENT_WCB	: REF BBLOCK,	!ADDRESS OF CURRENT WINDOW CONTROL BLOCK
;	0354		QUEUE_HEAD	: REF BBLOCK;	!ADDRESS OF ACP INPUT QUEUE HEAD
;	0355	
;	0356	EXTERNAL ROUTINE
;	0357		EXE$INSIOQ	: INS_QUE ADDRESSING_MODE(ABSOLUTE);
;	0358	
;	0359	LOCK_CODE;

; Bliss-32 7.352	Saturday 21-AUG-1978 23:46:14	DBB3:[MTAACP.SRC]STRVIO.B32;3					Page 2
; Digital Equipment Corporation
;
;	0360	GLOBAL ROUTINE START_VIO : COMMON_CALL NOVALUE  =
;	0361	
;	0362	!++
;	0363	!
;	0364	! FUNCTIONAL DESCRIPTION:
;	0365	!	THIS ROUTINE QUEUES BLOCKED VIRTUAL IO TO THE CURRENT UNIT
;	0366	!
;	0367	! CALLING SEQUENCE:
;	0368	!	START_VIO(), CALLED IN KERNEL MODE
;	0369	!
;	0370	! INPUT PARAMETERS:
;	0371	!	NONE
;	0372	!
;	0373	! IMPLICIT INPUTS:
;	0374	!	CURRENT_UCB	- ADDRESS OF CURRENT UNIT CONTROL BLOCK TO WHICH ALL
;	0375	!			  BLOCKED VIRTUAL IO IS TO BE QUEUED
;	0376	!	CURRENT_VCB	- ADDRESS OF CURRENT VOLUME CONTROL BLOCK WHICH CONTAINS
;	0377	!		 	  THE BLOCKED VIRTUAL IO LIST HEAD
;	0378	!	CURRENT_WCB	- ADDRESS OF CURRENT WINDOW CONTROL BLOCK WHICH IS CURRENTLY
;	0379	!			  NOT MAPPING VIRTUAL IO
;	0380	!	QUEUE_HEAD	- ADDRESS OF ACP INPUT QUEUE HEAD TO WHICH MAPPING ERRORS
;	0381	!			  FOR THIS VOLUME ARE QUEUED
;	0382	!
;	0383	! OUTPUT PARAMETERS:
;	0384	!	NONE
;	0385	!
;	0386	! IMPLICIT OUTPUTS:
;	0387	!	WINDOW RESTORED MAPPING TO CURRENT UNIT
;	0388	!	VIRTUAL IO REQUEUED TO THAT UNIT
;	0389	!
;	0390	! ROUTINE VALUE:
;	0391	!	NONE
;	0392	!
;	0393	! SIDE EFFECTS:
;	0394	!	THIS ROUTINE RUNS AT FORK LEVEL IN ORDER TO SYNCHRONIZE WITH THE MAPPING
;	0395	!	PORTION OF QIO PROCESSING AND THE MAGNETIC TAPE DRIVER
;	0396	!
;	0397	!--
;	0398	
;	0399	BEGIN
;	0400	
;	0401	EXTERNAL REGISTER
;	0402		COMMON_REG;
;	0403	
;	0404	
;	0405	LOCAL
;	0406		ENTRY		: REF BBLOCK,		!ADDRESS OF ACP QUEUE ENTRY
;	0407		FUNCTION,				!IO FUNCTION CODE
;	0408		PACKET		: REF BBLOCK,		!ADDRESS OF IO REQUEST PACKET WHICH IS TO BE REQUEUED
;	0409		UCB		: REF BBLOCK,		!ADDRESS OF CURRENT UCB
;	0410		VCB		: REF BBLOCK;		!ADDRESS OF  CURRENT VOLUME CONTROL BLOCK
;	0411	
;	0412	UCB = .CURRENT_UCB;				!ADDRESS OF UCB TO WHICH IO IS TO BE QUEUE
;	0413	VCB = .CURRENT_VCB;				!ADDRESS OF CURRENT VCB
;	0414	

; Bliss-32 7.352	Saturday 21-AUG-1978 23:46:14	DBB3:[MTAACP.SRC]STRVIO.B32;3					Page 2-1
; Digital Equipment Corporation
;
;	0415	SET_IPL(.UCB[UCB$B_FIPL]);			!RAISE TO FORK LEVEL
;	0416	
;	0417	! FIX UP MAP POINTER WITH UCB WHICH IS TO RECEIVE VIRTUAL IO
;	0418	CURRENT_WCB[WCB$W_NMAP] = 1;
;	0419	(CURRENT_WCB[WCB$W_P1_COUNT])<0,32> = .UCB;
;	0420	
;	0421	! REQUEUE ALL BLOCKED IO TO CURRENT UNIT
;	0422	WHILE 1 DO
;	0423	    BEGIN
;	0424	    IF REMQUE(.VCB[VCB$L_BLOCKFL],PACKET) THEN EXITLOOP;
;	0425	    PACKET[IRP$V_VIRTUAL] = 1;		!MAY HAVE BEEN CLEARED WHEN ERROR WAS PROCESSED
;	0426	    UCB=.CURRENT_UCB;			!THIS IS HERE BECAUSE INSIOQ DOES NOT PRESERVE R5
;	0427	
;	0428	    EXE$INSIOQ(.PACKET,.UCB);
;	0429	    END;
;	0430	
;	0431	! SCANE INPUT QUEUE FOR ANY MAPPING ERRORS THAT BELONG TO THIS VOLUME
;	0432	! PUT THEM AT THE TAIL OF BLOCKED IO LIST
;	0433	ENTRY = .QUEUE_HEAD[AQB$L_ACPQFL];
;	0434	WHILE .ENTRY NEQA .QUEUE_HEAD DO
;	0435	    BEGIN
;	0436	    FUNCTION = .ENTRY[IRP$V_FCODE];
;	0437	    IF .FUNCTION EQL IO$_READPBLK OR .FUNCTION EQL IO$_WRITEPBLK THEN
;	0438		BEGIN
;	0439		IF .BBLOCK[.ENTRY[IRP$L_UCB],UCB$L_VCB] EQLA .VCB THEN
;	0440		    BEGIN
;	0441		    ENTRY = .ENTRY [IRP$L_IOQBL];
;	0442		    REMQUE(.ENTRY[IRP$L_IOQFL],PACKET);
;	0443		    PACKET[IRP$V_VIRTUAL] = 1;		!MAY HAVE BEEN CLEARED WHEN ERROR WAS PROCESSED
;	0444		    EXE$INSIOQ(.PACKET,.UCB);
;	0445		    END;
;	0446		END;
;	0447	    ENTRY = .ENTRY[IRP$L_IOQFL];
;	0448	    END;
;	0449	
;	0450	SET_IPL(0);
;	0451	
;	0452	END;					!END OF ROUTINE


							    .TITLE  STRVIO
							    .IDENT  \A0001\

							    .GLOBL  CURRENT_UCB, CURRENT_WCB, QUEUE_HEAD, EXE$INSIOQ

							    .PSECT  $LOCKEDC1$,NOWRT,2

					 07FC 00000 	    .ENTRY  START_VIO, Save R2,R3,R4,R5,R6,R7,R8,R9,R10		      ; 0360
		         5A 00000000G  9F  9E 00002 	    MOVAB   @#EXE$INSIOQ, R10					      ;
		         55	0000G  CF  D0 00009 	    MOVL    CURRENT_UCB, UCB					      ; 0412
		         58	       5B  D0 0000E 	    MOVL    CURRENT_VCB, VCB					      ; 0413
		         50	  0B   A5  9A 00011 	    MOVZBL  11(UCB), R0						      ; 0415
		         12	       50  DA 00015 	    MTPR    R0, #18						      ;
		         50	0000G  CF  D0 00018 	    MOVL    CURRENT_WCB, R0					      ; 0418
		    16   A0	       01  B0 0001D 	    MOVW    #1, 22(R0)						      ;

; Bliss-32 7.352	Saturday 21-AUG-1978 23:46:14	DBB3:[MTAACP.SRC]STRVIO.B32;3					Page 2-2
; Digital Equipment Corporation
;
		    24   A0	       55  D0 00021 	    MOVL    UCB, 36(R0)						      ; 0419
		         53	  00   B8  0F 00025 1$:     REMQUE  @0(VCB), PACKET					      ; 0424
				       0D  1D 00029 	    BVS     2$							      ;
		    2A   A3	       10  88 0002B 	    BISB2   #16, 42(PACKET)					      ; 0425
		         55	0000G  CF  D0 0002F 	    MOVL    CURRENT_UCB, UCB					      ; 0426
				       6A  16 00034 	    JSB     EXE$INSIOQ						      ; 0428
				       ED  11 00036 	    BRB     1$							      ; 0422
		         56	0000G  DF  D0 00038 2$:     MOVL    @QUEUE_HEAD, ENTRY					      ; 0433
		  0000G  CF	       56  D1 0003D 3$:     CMPL    ENTRY, QUEUE_HEAD					      ; 0434
				       2D  13 00042 	    BEQL    6$							      ;
      20   A6	         06	       00  EF 00044 	    EXTZV   #0, #6, 32(ENTRY), FUNCTION				      ; 0436
				       57     00049									      ;
		         0C	       57  D1 0004A 	    CMPL    FUNCTION, #12					      ; 0437
				       05  13 0004D 	    BEQL    4$							      ;
		         0B	       57  D1 0004F 	    CMPL    FUNCTION, #11					      ;
				       18  12 00052 	    BNEQ    5$							      ;
		         50	  1C   A6  D0 00054 4$:     MOVL    28(ENTRY), R0					      ; 0439
		         58	  30   A0  D1 00058 	    CMPL    48(R0), VCB						      ;
				       0E  12 0005C 	    BNEQ    5$							      ;
		         56	  04   A6  D0 0005E 	    MOVL    4(ENTRY), ENTRY					      ; 0441
		         53	  00   B6  0F 00062 	    REMQUE  @0(ENTRY), PACKET					      ; 0442
		    2A   A3	       10  88 00066 	    BISB2   #16, 42(PACKET)					      ; 0443
				       6A  16 0006A 	    JSB     EXE$INSIOQ						      ; 0444
		         56	       66  D0 0006C 5$:     MOVL    (ENTRY), ENTRY					      ; 0447
				       CC  11 0006F 	    BRB     3$							      ; 0434
		         12	       00  DA 00071 6$:     MTPR    #0, #18						      ; 0450
					   04 00074 	    RET     							      ; 0360

; Routine Size:  117 bytes


;	0453	END
;	0454	ELUDOM






;				       PSECT SUMMARY
;
;	Name		 Bytes			       Attributes
;
;  $LOCKEDC1$     	   117  NOWRT,  RD ,  EXE,NOSHR,  LCL,  REL,  CON,NOPIC,ALIGN(2)
;  $CODE$         	     0  NOWRT,  RD ,  EXE,NOSHR,  LCL,  REL,  CON,NOPIC,ALIGN(2)




;				LIBRARY STATISTICS
;
;					     -------- Symbols --------    Blocks
;	File				     Total    Loaded   Percent      Read
;
;  DBA4:[SYSLIB]LIB.L32;1		      5582        19         0       234

; Bliss-32 7.352	Saturday 21-AUG-1978 23:46:14	DBB3:[MTAACP.SRC]STRVIO.B32;3					Page 2-3
; Digital Equipment Corporation
;





;	0455	
; Size:		117 code + 0 data bytes
; Run Time:	00:06.2
; Elapsed Time:	00:15.4
; Memory Used:	275 pages
; Compilation Complete
