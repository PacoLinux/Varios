
; Bliss-32 10.1-416	Monday 21-AUG-1978 19:34:33	DBB3:[RTL.SRC]LLOOKU.B32;11					Page 1
;
;00100  0001	MODULE LIB$LOOKUP_KEY (				! Keyword lookup routine
;00200  0002		IDENT = '0-07'				! File: LLOOKU.B32
;00300  0003			) =
;00400  0004	BEGIN
;00500  0005	
;00600  0006	!
;00700  0007	!			  COPYRIGHT (c) 1978 BY
;00800  0008	!	      DIGITAL EQUIPMENT CORPORATION, MAYNARD, MASS.
;00900  0009	!
;01000  0010	! THIS SOFTWARE IS FURNISHED UNDER A LICENSE AND MAY BE USED AND  COPIED
;01100  0011	! ONLY  IN  ACCORDANCE  WITH  THE  TERMS  OF  SUCH  LICENSE AND WITH THE
;01200  0012	! INCLUSION OF THE ABOVE COPYRIGHT NOTICE.  THIS SOFTWARE OR  ANY  OTHER
;01300  0013	! COPIES  THEREOF MAY NOT BE PROVIDED OR OTHERWISE MADE AVAILABLE TO ANY
;01400  0014	! OTHER PERSON.  NO TITLE TO AND OWNERSHIP OF  THE  SOFTWARE  IS  HEREBY
;01500  0015	! TRANSFERRED.
;01600  0016	!
;01700  0017	! THE INFORMATION IN THIS SOFTWARE IS SUBJECT TO CHANGE  WITHOUT  NOTICE
;01800  0018	! AND  SHOULD  NOT  BE  CONSTRUED  AS  A COMMITMENT BY DIGITAL EQUIPMENT
;01900  0019	! CORPORATION.
;02000  0020	!
;02100  0021	! DIGITAL ASSUMES NO RESPONSIBILITY FOR THE USE OR  RELIABILITY  OF  ITS
;02200  0022	! SOFTWARE ON EQUIPMENT WHICH IS NOT SUPPLIED BY DIGITAL.
;02300  0023	!
;02400  0024	
;02500  0025	!++
;02600  0026	! FACILITY:  General Utility Procedure library
;02700  0027	!
;02800  0028	! ABSTRACT:
;02900  0029	!
;03000  0030	!	This routine attempts to match a caller-specified character string
;03100  0031	!	with a table of keywords built by the caller.
;03200  0032	!
;03300  0033	! ENVIRONMENT:  User mode, AST re-entrant.  Non-shared library
;03400  0034	!
;03500  0035	! AUTHOR:  Ward Clark,	CREATION DATE:  10 January 1978
;03600  0036	!
;03700  0037	! MODIFIED BY:
;03800  0038	!	Jonathan M. Taylor - 5-Mar-78
;03900  0039	!
;04000  0040	! 0-2	- Fixed call to LIB$SCOPY_R_DX after changing parameter
;04100  0041	!	  order.  JMT 5-Mar-78
;04200  0042	! 0-03	- Change to STARLET library.  DGP 20-Apr-78
;04300  0043	! 0-04	- Change REQUIRE files for VAX system build.  DGP 28-Apr-78
;04400  0044	! 0-05	- Change STARLET to RTLSTARLE to avoid conflicts.  DGP 1-May-78
;04500  0045	! 0-06	- Addressing mode general for LIB$SCOPY.  TNH 17-June-78
;04600  0046	!--

; Bliss-32 10.1-416	Monday 21-AUG-1978 19:34:33	DBB3:[RTL.SRC]LLOOKU.B32;11					Page 2
;
;00100  0047	!++
;00200  0048	! DETAILED FUNCTIONAL DESCRIPTION:
;00300  0049	!
;00400  0050	!	This keyword lookup routine scans a table of keywords (see
;00500  0051	!	below), attempting to find a keyword which matches a caller-
;00600  0052	!	specified keyword or keyword abbreviation.
;00700  0053	!
;00800  0054	!
;00900  0055	!	When a keyword match is found, the following information is
;01000  0056	!	optionally returned to the caller:
;01100  0057	!
;01200  0058	!	     * longword value associated with the matched keyword
;01300  0059	!	     * full keyword string (any descriptor type)
;01400  0060	!
;01500  0061	!	If an exact keyword match is found (i.e., the caller's search
;01600  0062	!	string is an unabbreviated keyword), no further processing is
;01700  0063	!	performed and a normal completion code is returned to the
;01800  0064	!	caller.  Otherwise, after a match has been found, the rest of
;01900  0065	!	the keyword table is scanned.  If an additional match is found,
;02000  0066	!	a "not enough characters" completion code is returned to the
;02100  0067	!	caller.
;02200  0068	!
;02300  0069	!	The keyword table, which the caller creates for this routine
;02400  0070	!	(using the $LIB_KEY_TABLE macro), has the following structure,
;02500  0071	!
;02600  0072	!	          longword vector
;02700  0073	!	   +---------------------------+
;02800  0074	!	   |      vector size - 1      |
;02900  0075	!	   +---------------------------+
;03000  0076	!	   | address of keyword string |-------+
;03100  0077	!	   | - - - - - - - - - - - - - |       |
;03200  0078	!	   | associated keyword value  |       V
;03300  0079	!	   +---------------------------+     +---+------------------+
;03400  0080	!	   |             .             |     |   |  keyword string  |
;03500  0081	!	   |             .             |     +---+------------------+
;03600  0082	!	   |             .             |       counted ASCII string
;03700  0083	!	   |                           |
;03800  0084	!	   |                           |
;03900  0085	!	   |                           |
;04000  0086	!	   |                           |
;04100  0087	!	   +---------------------------+
;04200  0088	!
;04300  0089	!	where the "counted ASCII string" starts with a byte which is
;04400  0090	!	the unsigned count of the number of ASCII characters which
;04500  0091	!	follow.
;04600  0092	!
;04700  0093	!--

; Bliss-32 10.1-416	Monday 21-AUG-1978 19:34:33	DBB3:[RTL.SRC]LLOOKU.B32;11					Page 3
;
;00100  0094	!
;00200  0095	! TABLE OF CONTENTS:
;00300  0096	!
;00400  0097	
;00500  0098	FORWARD ROUTINE
;00600  0099	
;00700  0100	    LIB$LOOKUP_KEY;					! Keyword table scanning routine
;00800  0101	
;00900  0102	!
;01000  0103	! INCLUDE FILES:
;01100  0104	!
;01200  0105	
;01300  0106	LIBRARY  'RTLSTARLE';					! VAX/VMS Literals
;01400  0107	
;01500  0108	REQUIRE  'RTLIN:LIBMAC';					! General library macros and literals
; %PRINT:	File: LIBMAC.B32, Version 1, Edit 5, TNH, 28-Apr-78
;01600  0465	
;01700  0466	!
;01800  0467	! MACROS:
;01900  0468	!
;02000  0469	!    None
;02100  0470	
;02200  0471	!
;02300  0472	! EQUATED SYMBOLS:
;02400  0473	!
;02500  0474	!    None
;02600  0475	
;02700  0476	!
;02800  0477	! PSECT DECLARATIONS:
;02900  0478	!
;03000  0479	
;03100  0480	    $LIB_PSECTS ( LIB );				! Declare PSECTs for LIB$ facility
;03200  0481	
;03300  0482	!
;03400  0483	! OWN STORAGE:
;03500  0484	!
;03600  0485	!    None
;03700  0486	
;03800  0487	!
;03900  0488	! EXTERNAL REFERENCES:
;04000  0489	!
;04100  0490	
;04200  0491	
;04300  0492	!+
;04400  0493	! MAINTENANCE NOTE:  Since this module is non-shared,
;04500  0494	! a separate copy of this module is linked with the user program when
;04600  0495	! the user calls it.  In order to prevent
;04700  0496	! data truncation errors from the linker, all external references are
;04800  0497	! of addressing mode general (rather than word displacement) even for
;04900  0498	! the same PSECT.
;05000  0499	!-
;05100  0500	
;05200  0501	EXTERNAL ROUTINE
;05300  0502	    LIB$SCOPY_R_DX: ADDRESSING_MODE (GENERAL);		! Copy a by-reference string to a descriptor of any type.

; Bliss-32 10.1-416	Monday 21-AUG-1978 19:34:33	DBB3:[RTL.SRC]LLOOKU.B32;11					Page 4
;
;00100  0503	GLOBAL ROUTINE LIB$LOOKUP_KEY (				! Keyword table scanning routine
;00200  0504				STRNG_DESC_ADDR,		! Search string
;00300  0505				KEY_TABLE_ADDR,			! Keyword table
;00400  0506				KEY_VALUE_ADDR,			! Keyword value deposit area
;00500  0507				FULL_DESC_ADDR ) =		! Full keyword deposit area
;00600  0508	
;00700  0509	!++
;00800  0510	! FUNCTIONAL DESCRIPTION:
;00900  0511	!
;01000  0512	!	All keyword table scanning is performed by this routine.
;01100  0513	!
;01200  0514	! FORMAL PARAMETERS:
;01300  0515	!
;01400  0516	!	STRNG_DESC_ADDR.rt.ds - Address of search string descriptor
;01500  0517	!	KEY_TABLE_ADDR.rlu.ra - Address of keyword table
;01600  0518	!	[KEY_VALUE_ADDR.wlu.r] - Address of keyword value deposit area (optional)
;01700  0519	!	[FULL_DESC_ADDR.wt.dx] - Address of full keyword deposit area (optional)
;01800  0520	!
;01900  0521	! IMPLICIT INPUTS:
;02000  0522	!
;02100  0523	!	None
;02200  0524	!
;02300  0525	! IMPLICIT OUTPUTS:
;02400  0526	!
;02500  0527	!	None
;02600  0528	!
;02700  0529	! COMPLETION CODES:
;02800  0530	!
;02900  0531	!	SS$_NORMAL = Unique keyword match found
;03000  0532	!	LIB$_AMBKEY = Multiple keyword match found (i.e., not enough characters specified)
;03100  0533	!	LIB$_UNRKEY = No keyword match found
;03200  0534	!	LIB$_INVARG = Invalid arguments, not enough arguments, bad keyword table
;03300  0535	!	LIB$_INSVIRMEM = Insufficient virtual memory to return keyword string
;03400  0536	!
;03500  0537	! SIDE EFFECTS:
;03600  0538	!
;03700  0539	!	None
;03800  0540	!
;03900  0541	!--
;04000  0542	
;04100  0543	    BEGIN
;04200  0544	
;04300  0545	    LOCAL
;04400  0546		MATCH,						! Index of a matched keyword table entry
;04500  0547		RETURN_CODE;					! Routine return code
;04600  0548	
;04700  0549	    BUILTIN
;04800  0550		ACTUALCOUNT;					! Actual parameter count
;04900  0551	
;05000  0552	    BIND						! Redefine routine arguments:
;05100  0553		STRING_SIZE = .STRNG_DESC_ADDR,			!    Size of the caller's search string
;05200  0554		STRING = .(.STRNG_DESC_ADDR+4),			!    Caller's search string
;05300  0555		KEY_TABLE = .KEY_TABLE_ADDR :  VECTOR,		!    Caller's keyword table
;05400  0556		KEY_VALUE = .KEY_VALUE_ADDR,			!    Caller's keyword value deposit area
;05500  0557		FULL_KEY_DESC = .FULL_DESC_ADDR;		!    Caller's keyword deposit descriptor

; Bliss-32 10.1-416	Monday 21-AUG-1978 19:34:33	DBB3:[RTL.SRC]LLOOKU.B32;11					Page 4-1
;
;05600  0558	
;05700  0559	!
;05800  0560	! Verify that the caller provided a proper argument list.
;05900  0561	!
;06000  0562	
;06100  0563	    IF ACTUALCOUNT() LSSU 2				! If less that 2 arguments were provided,
;06200  0564	    THEN						!
;06300  0565	        RETURN LIB$_INVARG;				! return an error code to the caller.
;06400  0566	
;06500  0567	!
;06600  0568	! Prepare to scan the caller's keyword table.
;06700  0569	!
;06800  0570	
;06900  0571	    RETURN_CODE = LIB$_UNRKEY;				! Initially assume no keyword match exists.
;07000  0572	
;07100  0573	!
;07200  0574	! Scan the keyword table for a match with the caller's string.
;07300  0575	!
;07400  0576	
;07500  0577	    INCR INDEX FROM 1 TO .KEY_TABLE BY 2 DO		! Loop until the end of the keyword table.
;07600  0578		BEGIN
;07700  0579	
;07800  0580		IF .STRING_SIZE<0,16> LEQU			! First make sure that the caller's string
;07900  0581		   $LIB_KEY_LENGTH(KEY_TABLE[.INDEX])		! is not longer than the current keyword.
;08000  0582		THEN
;08100  0583		    IF CH$EQL(.STRING_SIZE<0,16>, STRING,	! If the caller's string matches
;08200  0584			 .STRING_SIZE<0,16>,			! the current keyword,
;08300  0585			 $LIB_KEY_STRING(KEY_TABLE[.INDEX]) )	! begin additional checking.
;08400  0586		    THEN
;08500  0587			BEGIN
;08600  0588	
;08700  0589			IF .STRING_SIZE<0,16> EQLU		! If the caller's search string
;08800  0590			   $LIB_KEY_LENGTH(KEY_TABLE[.INDEX])	! is the same length as
;08900  0591			THEN					! the keyword it matches,
;09000  0592			    BEGIN				! begin special exact-match processing.
;09100  0593	
;09200  0594			    MATCH = .INDEX;			! Save the current keyword table index,
;09300  0595			    RETURN_CODE = SS$_NORMAL;		! indicate a keyword match was found,
;09400  0596			    EXITLOOP;				! and bypass further keyword table scanning.
;09500  0597			    END;
;09600  0598	
;09700  0599			IF .RETURN_CODE EQL LIB$_UNRKEY		! If a match has not already been found,
;09800  0600			THEN					!
;09900  0601			    BEGIN				!
;10000  0602			    MATCH = .INDEX;			! save the current keyword table index
;10100  0603			    RETURN_CODE = SS$_NORMAL;		! and indicate a match has been found.
;10200  0604			    END
;10300  0605			ELSE					! Otherwise, indicate that a multiple
;10400  0606			    BEGIN				! keyword match has been found
;10500  0607			    RETURN_CODE = LIB$_AMBKEY;		! (i.e., no enough characters provided)
;10600  0608			    EXITLOOP;				! and exit the keyword scanning loop.
;10700  0609			    END;
;10800  0610	
;10900  0611			END;					! End of keyword match processing.
;11000  0612	

; Bliss-32 10.1-416	Monday 21-AUG-1978 19:34:33	DBB3:[RTL.SRC]LLOOKU.B32;11					Page 4-2
;
;11100  0613		END;						! End of the keyword table searching loop.
;11200  0614	
;11300  0615	!
;11400  0616	! If a keyword match was found, return the keyword information to the caller.
;11500  0617	!
;11600  0618	
;11700  0619	    IF .RETURN_CODE NEQ LIB$_UNRKEY			! Make sure a keyword match was found.
;11800  0620	    THEN
;11900  0621		BEGIN
;12000  0622		IF ACTUALCOUNT() GEQU 3 AND			! If at least 3 routine arguments were provided
;12100  0623		   KEY_VALUE NEQ 0				! and the caller's value address is not zero,
;12200  0624		THEN						! return the keyword value to the caller.
;12300  0625		    KEY_VALUE = $LIB_KEY_VALUE(KEY_TABLE[.MATCH]);
;12400  0626	
;12500  0627		IF ACTUALCOUNT() GEQU 4 AND			! If at least 4 routine arguments were provided
;12600  0628		   FULL_KEY_DESC NEQ 0				! and the caller's deposit address is not zero,
;12700  0629		THEN						! call a routine to return the matched string
;12800  0630		    BEGIN					! to the caller,
;12900  0631		    LOCAL TEMP;					!
;13000  0632		    IF NOT ( TEMP = LIB$SCOPY_R_DX(		! specifying the following arguments:
;13100  0633			$LIB_KEY_LENGTH(KEY_TABLE[.MATCH]),	!    Length of the matched keyword
;13200  0634			$LIB_KEY_STRING(KEY_TABLE[.MATCH]),	!    Address of the matched keyword
;13300  0635				FULL_KEY_DESC))			!    Address of the caller's result descriptor
;13400  0636		    THEN
;13500  0637			RETURN_CODE = .TEMP;			! Update the return code if the string copy failed.
;13600  0638		    END;
;13700  0639		END;
;13800  0640	
;13900  0641	!
;14000  0642	! Return the current keyword match return code to the caller.
;14100  0643	!
;14200  0644	
;14300  0645	    RETURN .RETURN_CODE;				! Return the current match code to the caller.
;14400  0646	
;14500  0647	    END;						! End of LIB$LOOKUP_KEY routine


							    .TITLE  LIB$LOOKUP_KEY
							    .IDENT  \0-07\

							    .EXTRN  LIB$SCOPY_R_DX

							    .PSECT  LIB$CODE,NOWRT,  SHR,  PIC,2

					 03FC 00000 	    .ENTRY  LIB$LOOKUP_KEY, Save R2,R3,R4,R5,R6,R7,R8,R9	      ; 0503
		         57 	  04   AC  D0 00002 	    MOVL    STRNG_DESC_ADDR, R7					      ; 0553
		         59 	  08   AC  D0 00006 	    MOVL    KEY_TABLE_ADDR, R9					      ; 0543
		         02 	       6C  91 0000A 	    CMPB    (AP), #2						      ; 0563
				       08  1E 0000D 	    BGEQU   1$							      ;
		         50 00158234   8F  D0 0000F 	    MOVL    #1409588, R0					      ; 0565
					   04 00016 	    RET     							      ;
		         58 00158244   8F  D0 00017 1$:     MOVL    #1409604, RETURN_CODE				      ; 0571
		         55 	       01  CE 0001E 	    MNEGL   #1, INDEX						      ; 0577
				       3E  11 00021 	    BRB     5$							      ;
		         54 	     6945  D0 00023 2$:     MOVL    (R9)[INDEX], R4					      ; 0581

; Bliss-32 10.1-416	Monday 21-AUG-1978 19:34:33	DBB3:[RTL.SRC]LLOOKU.B32;11					Page 4-3
;
		         50 	       64  9A 00027 	    MOVZBL  (R4), R0						      ; 0580
		         67 	       50  B1 0002A 	    CMPW    R0, (R7)						      ;
				       32  1F 0002D 	    BLSSU   5$							      ;
      01   A4	    04   B7	       67  29 0002F 	    CMPC3   (R7), @4(R7), 1(R4)					      ; 0583
				       2A  12 00035 	    BNEQ    5$							      ;
		         50 	       64  9A 00037 	    MOVZBL  (R4), R0						      ; 0589
		         67 	       50  B1 0003A 	    CMPW    R0, (R7)						      ;
				       08  12 0003D 	    BNEQ    3$							      ;
		         56 	       55  D0 0003F 	    MOVL    INDEX, MATCH					      ; 0594
		         58 	       01  D0 00042 	    MOVL    #1, RETURN_CODE					      ; 0595
				       20  11 00045 	    BRB     6$							      ; 0596
	      00158244   8F	       58  D1 00047 3$:     CMPL    RETURN_CODE, #1409604				      ; 0599
				       08  12 0004E 	    BNEQ    4$							      ;
		         56 	       55  D0 00050 	    MOVL    INDEX, MATCH					      ; 0602
		         58 	       01  D0 00053 	    MOVL    #1, RETURN_CODE					      ; 0603
				       09  11 00056 	    BRB     5$							      ; 0599
		         58 0015823C   8F  D0 00058 4$:     MOVL    #1409596, RETURN_CODE				      ; 0607
				       06  11 0005F 	    BRB     6$							      ; 0608
	   55 	         02 	       69  F1 00061 5$:     ACBL    (R9), #2, INDEX, 2$					      ; 0577
				     FFBC     00065									      ;
	      00158244   8F	       58  D1 00067 6$:     CMPL    RETURN_CODE, #1409604				      ; 0619
				       34  13 0006E 	    BEQL    8$							      ;
		         03 	       6C  91 00070 	    CMPB    (AP), #3						      ; 0622
				       0B  1F 00073 	    BLSSU   7$							      ;
				  0C   AC  D5 00075 	    TSTL    KEY_VALUE_ADDR					      ; 0623
				       06  13 00078 	    BEQL    7$							      ;
		    0C   BC	  04 A946  D0 0007A 	    MOVL    4(R9)[MATCH], @KEY_VALUE_ADDR			      ; 0625
		         04 	       6C  91 00080 7$:     CMPB    (AP), #4						      ; 0627
				       1F  1F 00083 	    BLSSU   8$							      ;
				  10   AC  D5 00085 	    TSTL    FULL_DESC_ADDR					      ; 0628
				       1A  13 00088 	    BEQL    8$							      ;
				  10   AC  DD 0008A 	    PUSHL   FULL_DESC_ADDR					      ; 0632
		         50 	     6946  D0 0008D 	    MOVL    (R9)[MATCH], R0					      ; 0634
				  01   A0  9F 00091 	    PUSHAB  1(R0)						      ;
		         7E 	       60  9A 00094 	    MOVZBL  (R0), -(SP)						      ; 0632
	      00000000G  00	       03  FB 00097 	    CALLS   #3, LIB$SCOPY_R_DX					      ;
		         03 	       50  E8 0009E 	    BLBS    TEMP, 8$						      ;
		         58 	       50  D0 000A1 	    MOVL    TEMP, RETURN_CODE					      ; 0637
		         50 	       58  D0 000A4 8$:     MOVL    RETURN_CODE, R0					      ; 0645
					   04 000A7 	    RET     							      ; 0503

; Routine Size:  168 bytes


;14600  0648	
;14700  0649	END
;14800  0650	ELUDOM






;				       PSECT SUMMARY
;

; Bliss-32 10.1-416	Monday 21-AUG-1978 19:34:33	DBB3:[RTL.SRC]LLOOKU.B32;11					Page 4-4
;
;	Name		 Bytes			       Attributes
;
;  LIB$CODE       	   168  NOWRT,  RD ,  EXE,  SHR,  LCL,  REL,  CON,  PIC,ALIGN(2)




;				LIBRARY STATISTICS
;
;					     -------- Symbols --------    Blocks
;	File				     Total    Loaded   Percent      Read
;
;  DBA4:[SYSLIB]STARLET.L32;1		      2688         4         0       109





; Size:		168 code + 0 data bytes
; Run Time:	00:10.2
; Elapsed Time:	00:35.8
; Memory Used:	170 pages
; Compilation Complete
