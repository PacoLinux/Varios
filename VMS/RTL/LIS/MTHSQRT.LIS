MTH$SQRT        ; Floating Point Square Root routine             21-AUG-1978 19:08:59   VAX-11 MACRO X0.3-11               Page   0
TABLE OF CONTENTS   

   (2)     100  HISTORY	; Detailed Current Edit History
   (3)     100  DECLARATIONS	; Declarative Part of Module
   (4)     100  MTH$SQRT  - Standard Single Precision Floating 
   (5)     100  MTH$SQRT_R2  - JSB SQRT routine
MTH$SQRT        ; Floating Point Square Root routine             21-AUG-1978 19:08:59   VAX-11 MACRO X0.3-11               Page   1
01-9                                                                                                                             (1)

                                     0000   100 	.TITLE	MTH$SQRT 	; Floating Point Square Root routine
                                     0000   200 				; (SQRT)
                                     0000   300 	.IDENT /01-9/		; File: MTHSQRT.MAR
                                     0000   400 ;
                                     0000   500 ; Copyright (C) 1977
                                     0000   600 ; Digital Equipment Corporation, Maynard, Massachusetts 01754
                                     0000   700 ;
                                     0000   800 ; This  software  is furnished under a license for use only on a single
                                     0000   900 ; computer  system  and  may  be  copied only with the inclusion of the
                                     0000  1000 ; above copyright notice.  This software, or  any other copies thereof,
                                     0000  1100 ; may not  be  provided or otherwise made available to any other person
                                     0000  1200 ; except  for  use on such system and to one who agree to these license 
                                     0000  1300 ; terms.  Title  to  and  ownership of the software shall  at all times 
                                     0000  1400 ; remain in DEC.
                                     0000  1500 ;
                                     0000  1600 ; The information  in  the software is subject to change without notice
                                     0000  1700 ; and should  not  be  construed  as  a commitment by Digital Equipment 
                                     0000  1800 ; Corporation.
                                     0000  1900 ;
                                     0000  2000 ; DEC assumes  no  responsibility  for  the use  or  reliability of its
                                     0000  2100 ; software on equipment which is not supplied by DEC.
                                     0000  2200 ;
                                     0000  2300 ;
                                     0000  2400 ; FACILITY: MATH LIBRARY
                                     0000  2500 ;++
                                     0000  2600 ; ABSTRACT:
                                     0000  2700 ;
                                     0000  2800 ; MTH$SQRT is a function  which  returns the floating point square root
                                     0000  2900 ; of its single precision floating point argument. The call is standard
                                     0000  3000 ; call-by-reference.
                                     0000  3100 ; MTH$SQRT_R2 is a special routine which is the same as MTH$SQRT except
                                     0000  3200 ; a faster non-standard JSB call is used with the argument in R0 and no
                                     0000  3300 ; registers are saved.
                                     0000  3400 ;
                                     0000  3500 ;--
                                     0000  3600 ;
                                     0000  3700 ; VERSION: 01
                                     0000  3800 ;
                                     0000  3900 ; HISTORY:
                                     0000  4000 ; AUTHOR:
                                     0000  4100 ;	Peter Yuo, 15-Oct-76: Version 01
                                     0000  4200 ;
                                     0000  4300 ; MODIFIED BY:
                                     0000  4400 ;
                                     0000  4500 ; 01-1	Peter Yuo, 22-May-77
                                     0000  4600 ; 01-2 Peter Yuo, 31-May-77
                                     0000  4700 ;
                                     0000  4800 ;
MTH$SQRT        ; Floating Point Square Root routine             21-AUG-1978 19:08:59   VAX-11 MACRO X0.3-11               Page   2
01-9            HISTORY ; Detailed Current Edit History                                                                          (2)

                                     0000   100 	.SBTTL	HISTORY	; Detailed Current Edit History
                                     0000   200 
                                     0000   300 
                                     0000   400 ; ALGORITHMIC DIFFERENCES FROM FP-11/C ROUTINE:	none
                                     0000   500 ;
                                     0000   600 ; Edit History for Version 01 of MTH$SQRT 
                                     0000   700 ;
                                     0000   800 ; 01-1	Code saving after code review
                                     0000   900 ; 01-2	ROTL shift in garbage into highest bit. Use ASHL instead.
                                     0000  1000 ;	ADDL instruction after ADJUST has been changed into ADDW to prevent
                                     0000  1100 ;	overflow if R1<31:16> = FFFF and R0<31:16> = FFFF
                                     0000  1200 ; 01-3	Finish error handling 10-June-1977
                                     0000  1300 ; 01-5	MTH$$ERROR changed to MTH$$SIGNAL.
                                     0000  1400 ;	MTH$_... changed to MTH__....
                                     0000  1500 ;	Changed error handling mechanism. Put error result in R0 before 
                                     0000  1600 ;	calling MTH$$SIGNAL in order to allow user modify error result.
                                     0000  1700 ; 01-6	Return -0.0 on negative arg.  TNH 20-Dec-77
                                     0000  1800 ; 01-7	Edit in Rich Lary's code bums.  JSB routine is now _R2.  JMT 19-Jan-78
                                     0000  1900 ; 01-9	Move .ENTRY symbol to module header.  TNH 14-Aug-78
MTH$SQRT        ; Floating Point Square Root routine             21-AUG-1978 19:08:59   VAX-11 MACRO X0.3-11               Page   3
01-9            DECLARATIONS ; Declarative Part of Module                                                                        (3)

                                     0000   100 	.SBTTL	DECLARATIONS	; Declarative Part of Module
                                     0000   200 
                                     0000   300 ;
                                     0000   400 ; INCLUDE FILES:	OTSPARAMS.MAR
                                     0000   500 ;
                                     0000   600 ; EXTERNAL SYMBOLS:	MTH$JACKET_HDLR
                                     0000   700 ;
                                     0000   800 ; EQUATED SYMBOLS:
                                     0000   900 ;
                                     0000   910 
                           00004004  0000   920 	ACMASK = ^M<IV, R2>		; register save mask and IV enable
                                     0000  1000 ; MACROS:	none
                                     0000  1100 ;
                                     0000  1200 ; PSECT DECLARATIONS:
                                     0000  1300 
                                 00000000  1400 	.PSECT	MTH$CODE	PIC,SHR,LONG,EXE,NOWRT
                                     0000  1500 					; program section for math routines
                                     0000  1600 ;
                                     0000  1700 ; OWN STORAGE:	none
                                     0000  1800 ;
                                     0000  1900 ; CONSTANTS:
                                     0000  2000 
                                     0000  2100 ;
                                     0000  2200 ; Constants A and B chosen for k = odd
                                     0000  2300 ;
                           13CD5FD4  0000  2400 	LF_ODD_A_E63	=	^X13CD5FD4
                           3C4A2018  0000  2500 	LF_ODD_B_EM63	=	^X3C4A2018
                                     0000  2600 ;
                                     0000  2700 ; Constants A and B chosen for k = even
                                     0000  2800 ;
                           F61A4015  0000  2900 	LF_EVEN_A	=	^XF61A4015
                           4B231FD7  0000  3000 	LF_EVEN_B_EM64	=	^X4B231FD7
MTH$SQRT        ; Floating Point Square Root routine             21-AUG-1978 19:08:59   VAX-11 MACRO X0.3-11               Page   4
01-9            MTH$SQRT  - Standard Single Precision Floating                                                                   (4)

                                     0000   100 	.SBTTL	MTH$SQRT  - Standard Single Precision Floating SQRT
                                     0000   200 
                                     0000   300 
                                     0000   400 ;++
                                     0000   500 ; FUNCTIONAL DESCRIPTION:
                                     0000   600 ;
                                     0000   700 ; SQRT  - single precision floating point function
                                     0000   800 ;
                                     0000   900 ; SQRT(X) is computed using the following approximation technique:
                                     0000  1000 ;
                                     0000  1100 ;	If X <= 0 , error.  Let X = |X|.
                                     0000  1200 ;
                                     0000  1300 ;	Let X = 2**K * F where F is the fractional part.
                                     0000  1400 ;
                                     0000  1500 ;	If K = even, X = 2**(2P) * F,
                                     0000  1600 ;		SQRT(X) = 2**P * SQRT(F), 1/2 =< F < 1
                                     0000  1700 ;
                                     0000  1800 ;	If K = odd, X = 2**(2P+1) * F = 2**(2P+2) * (F/2),
                                     0000  1900 ;		SQRT(X) = 2**(P+1) * SQRT(F/2), 1/4 =< F/2 < 1/2.
                                     0000  2000 ;
                                     0000  2100 ;	Let F' = A*F + B,
                                     0000  2200 ;			  A = 0.453730314(octal),
                                     0000  2300 ;			  B = 0.327226214(octal), for K = even.
                                     0000  2400 ;	       = A*(F/2) + B,
                                     0000  2500 ;			  A = 0.650117146(octal),
                                     0000  2600 ;			  B = 0.230170444(octal), for K = odd.
                                     0000  2700 ;	and
                                     0000  2800 ;	    K' = P,	 for K = even
                                     0000  2900 ;	       = P + 1	 for K = odd.
                                     0000  3000 ;
                                     0000  3100 ;	Let Y0 = 2**K' * F' as a staight line approximation wthin the
                                     0000  3200 ;	given interval using coefficients A and B which minimize the
                                     0000  3300 ;	absolute error at the midpoint and endpoint.
                                     0000  3400 ;
                                     0000  3500 ;	Starting with Y0, two Newton-Raphson iterations are performed.
                                     0000  3600 ;
                                     0000  3700 ;	Y[n+1] = (1/2) * ( Y[n] + X/Y[n])
                                     0000  3800 ;
                                     0000  3900 ;	The relative error is < 10**-8.
                                     0000  4000 ;
                                     0000  4100 ; CALLING SEQUENCE:
                                     0000  4200 ;
                                     0000  4300 ;	sqrt.wf.v = MTH$SQRT(x.rf.r)
                                     0000  4400 ;
                                     0000  4500 ; INPUT PARAMETERS:
                                     0000  4600 
                           00000004  0000  4700 	LONG = 4			; define longword multiplier
                           00000004  0000  4800 	x = 1 * LONG			; Contents of x is the argument
                                     0000  4900 
                                     0000  5000 ; IMPLICIT INPUTS:	none
                                     0000  5100 ;
                                     0000  5200 ; OUTPUT PARAMETERS:
                                     0000  5300 ;
                                     0000  5400 ;	VALUE:	floating square root of the argument
                                     0000  5500 ;
                                     0000  5600 ; IMPLICIT OUTPUTS:	none
                                     0000  5700 ;
MTH$SQRT        ; Floating Point Square Root routine             21-AUG-1978 19:08:59   VAX-11 MACRO X0.3-11               Page   5
01-9            MTH$SQRT  - Standard Single Precision Floating                                                                   (4)

                                     0000  5800 ; COMPLETION CODES:	none
                                     0000  5900 ;
                                     0000  6000 ; SIDE EFFECTS:
                                     0000  6100 ;
                                     0000  6200 ; Signals: MTH$_SQUROONEG if X < 0.0 with reserved operand in R0 (copied to
                                     0000  6300 ; the signal mechanism vector CHF$L_MCH_R0/R1 by LIB$SIGNAL).
                                     0000  6400 ; Associated message is: "SQUARE ROOT OF NEGATIVE VALUE". Result is reserved
                                     0000  6500 ; operand -0.0 unless a user supplied (or any) error handler changes CHF$L_MCH_R0/R1
                                     0000  6600 ;
                                     0000  6700 ; NOTE: This procedure disables floating point underflow, enables integer
                                     0000  6800 ; overflow, causes no floating overflow or other arithmetic traps, and
                                     0000  6900 ; preserves enables across the call.
                                     0000  7000 ;
                                     0000  7100 ;---
                                     0000  7200 
                                     0000  7300 
                               4004' 0000  7400 	.ENTRY	MTH$SQRT, ACMASK	; standard call-by-reference entry
                                     0002  7500 					; disable DV (and FU), enable IV
                                     0002  7600 	MTH$FLAG_JACKET			; flag that this is a jacket procedure in
                                     0002      
            6D       0000'CF     3E  0002       	MOVAW	W^MTH$$JACKET_HND, (FP)
                                     0007       					; set handler address to jacket
                                     0007       					; handler
                                     0007       
                                     0007  7700 					; case of an error in special routine
            50         04 BC     50  0007  7800 	MOVF	@x(AP), R0		; R0 = arg 
                          01     10  000B  7900 	BSBB	MTH$SQRT_R2 		; call specail SQRT rountine
                                 04  000D  8000 	RET				; return - result in R0
                                     000E  8100 
MTH$SQRT        ; Floating Point Square Root routine             21-AUG-1978 19:08:59   VAX-11 MACRO X0.3-11               Page   6
01-9            MTH$SQRT_R2  - JSB SQRT routine                                                                                  (5)

                                     000E   100 	.SBTTL	MTH$SQRT_R2  - JSB SQRT routine
                                     000E   200 
                                     000E   300 ; JSB SQRT - used by the standard, and directly.
                                     000E   400 ;
                                     000E   500 ; CALLING SEQUENCE:
                                     000E   600 ;	save anything in R0:R2
                                     000E   700 ;	MOVF	..., R0			; input in R0
                                     000E   800 ;	JSB	MTH$SQRT_R2
                                     000E   900 ;	return with result in R0
                                     000E  1000 ;
                                     000E  1100 ; Note: This routine is written to avoid any integer overflows, floating overflows,
                                     000E  1200 ; floating underflows or divide by 0 conditions, whether enabled or not.
                                     000E  1300 ;
                                     000E  1400 ; REGISTERS USED:
                                     000E  1500 ;	R0 - Floating argument then result
                                     000E  1600 ;	R1 - X saved for use during iteration
                                     000E  1700 ;	R2 - scratch
                                     000E  1800 
                                     000E  2100 MTH$SQRT_R2::				; JSB routine for SQRT
            51            50     50  000E  2200 	MOVF	R0, R1			; test sign of X and save it in R1.
                          50     15  0011  2300 	BLEQ	ZERO_NEG		; branch to ZERO_NEG if X =< 0
                                     0013  2400 ;
                                     0013  2500 ; X > 0
                                     0013  2600 ;
                                     0013  2700 POS:
            52            50     3C  0013  2800 	MOVZWL	R0, R2			; isolate low 16 bits (sign,exp,>fract) in R2
                          52     94  0016  2900 	CLRB	R2			; R2 now has sign and left 7 exp bits
            50            52     AA  0018  3000 	BICW	R2, R0			; clear sign and left 7 exp bits
                          50     95  001B  3100 	TSTB	R0			; check low bit of exp
                          10     18  001D  3200 	BGEQ	EVEN			; and branch if 1
            50   13CD5FD4 8F     44  001F  3300 	MULF	#LF_ODD_A_E63, R0	; add 64 (half of bias) to (exponent-2)
                                     0026  3400 					; and start approximation calc
            50   3C4A2018 8F     40  0026  3500 	ADDF	#LF_ODD_B_EM63, R0	; R0 = (first approx) * 2**-64
                          13     11  002D  3600 	BRB	ADJUST			; go adjust
                                     002F  3700 
                                     002F  3800 EVEN:
            50       2000 8F     A0  002F  3900 	ADDW	#^X2000, R0		; exp is 0 - make it 64 (2**-64) for legality
            50   F61A4015 8F     44  0034  4000 	MULF	#LF_EVEN_A, R0
            50   4B231FD7 8F     40  003B  4100 	ADDF	#LF_EVEN_B_EM64, R0	; R0 = (first approx) * 2**-64
                                     0042  4200 ADJUST:
            52            1F     9C  0042  4300 	ROTL	#31, R2, R2		; divide R2 (exp+bias) by 2,
                          52         0045       
                                     0046  4400 					; giving (exp/2+64)
            50            52     A0  0046  4500 	ADDW	R2, R0			; insert exp/2 in first approx and
                                     0049  4600 					; re-bias it.
                                     0049  4700 
                                     0049  4800 ; first iteration - single precision is sufficient
                                     0049  4900 ;
            51            50     47  0049  5000 	DIVF3	R0, R1, R2		; R2 = X/Y0
                          52         004C       
            50            52     40  004D  5100 	ADDF	R2, R0			; R0 = Y0 + X/Y0
            50       0080 8F     A2  0050  5200 	SUBW	#^X80, R0		; R0 = Y1 = (1/2)(Y0 + X/Y0)
                                     0055  5300 					; no overflow possible
                                     0055  5400 
                                     0055  5500 ; second iteration, do in double precision to get truncated( rather than
                                     0055  5600 ; rounded) result.
                                     0055  5700 ;
MTH$SQRT        ; Floating Point Square Root routine             21-AUG-1978 19:08:59   VAX-11 MACRO X0.3-11               Page   7
01-9            MTH$SQRT_R2  - JSB SQRT routine                                                                                  (5)

                          52     D4  0055  5800 	CLRL	R2			; lower part (X) = 0
            51            50     66  0057  5900 	DIVD	R0, R1			; divide Y1 into X with low-order
                                     005A  6000 					; 32 bits of Y1 garbage.  This doesn't
                                     005A  6100 					; effect accuracy, since Y1 innacurate
                                     005A  6200 					; anyway.
            50            51     40  005A  6300 	ADDF	R1, R0			; R0 = Y1 + higher_part(X/Y1)
            50       0080 8F     A2  005D  6400 	SUBW	#^X80, R0		; R0 = SQRT(X) = (1/2) (Y1 + X/Y1)
                                 05  0062  6500 SQRTX:	RSB				; return, R0 = result
                                     0063  6600 
                                     0063  6700 ; X =< 0
                                     0063  6800 ;
                                     0063  6900 ZERO_NEG:
                          FD     13  0063  7000 	BEQL	SQRTX			; return with R0 = result = 0
                          6E     DD  0065  7100 	PUSHL	(SP)			; return PC from JSB routine
            7E         54 8F     9A  0067  7200 	MOVZBL	#MTH__SQUROONEG, -(SP)	; condition value
            01            0F     78  006B  7300 	ASHL	#15, #1, R0		; R0 = result = reserved operand -0.0
                          50         006E       
                                     006F  7400 					; R0 goes to signal mechanism vector
                                     006F  7500 					; (CHF$L_MCH_R0/R1) so error handler
                                     006F  7600 					; can modify the result.
       0000'CF            02     FB  006F  7700 	CALLS	#2, W^MTH$$SIGNAL	; signal error and use real user's PC
                                     0074  7800 					; independent of CALL vs JSB
                                 05  0074  7900 	RSB				; return - R0 restored from CHF$L_MCH_R0/R1
                                     0075  8000 
                                     0075  8100 	.END
MTH$SQRT        ; Floating Point Square Root routine             21-AUG-1978 19:08:59   VAX-11 MACRO X0.3-11               Page   8
SYMBOL TABLE                                                                                                                     (5)

ACMASK         = 00004004            
ADJUST           00000042 R     02   
EVEN             0000002F R     02   
FOR$K_ERR_PREFX= 00000018            
LF_EVEN_A      = F61A4015            
LF_EVEN_B_EM64 = 4B231FD7            
LF_ODD_A_E63   = 13CD5FD4            
LF_ODD_B_EM63  = 3C4A2018            
LONG           = 00000004            
MTH$$JACKET_HND  ********   X   02   
MTH$$SIGNAL      ********   X   02   
MTH$K_ERR_PREFX= 00000016            
MTH$SQRT         00000000 RG    02   
MTH$SQRT_R2      0000000E RG    02   
MTH__FLOOVEMAT = 00000058            
MTH__FLOUNDMAT = 00000059            
MTH__INVARG    = 00000051            
MTH__LOGZERNEG = 00000053            
MTH__SINSIGLOS = 00000057            
MTH__SQUROONEG = 00000054            
MTH__UNDEXP    = 00000052            
MTH__WRONUMARG = 00000050            
POS              00000013 R     02   
SQRTX            00000062 R     02   
X              = 00000004            
ZERO_NEG         00000063 R     02   


PROGRAM SECTION SYNOPSIS

.  ABS  .        00000000      00     NOPIC   USR   CON   ABS   LCL NOSHR NOEXE NORD  NOWRT BYTE  
. BLANK .        00000000      01     NOPIC   USR   CON   REL   LCL NOSHR   EXE   RD    WRT BYTE  
MTH$CODE         00000075      02       PIC   USR   CON   REL   LCL   SHR   EXE   RD  NOWRT LONG  


THERE WERE NO ERRORS OR WARNINGS.
27784. BYTES LEFT IN FREE MEMORY POOL.
OBJ$:MTHSQRT,LIS$:MTHSQRT/-SP=LIB$:S/ML,SRC$:P,MTHSQRT
0 MLB DIR RDS - 0 GETS TO DEFINE 0 MACROS. 3 INTER. FILE WRITES. 
