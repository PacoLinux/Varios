
; Bliss-32 10.1-416	Monday 21-AUG-1978 22:49:39	DBB3:[F11A.SRC]CHKHDR.B32;7					Page 1
;
;	0001	MODULE CHKHDR (
;	0002			LANGUAGE (BLISS32),
;	0003			IDENT = 'A0007'
;	0004			) =
;	0005	BEGIN
;	0006	
;	0007	!
;	0008	! Copyright (c) 1977
;	0009	! Digital Equipment Corporation, Maynard, Massachusetts 01754
;	0010	!
;	0011	! This software is furnished  under a license for use only on a single
;	0012	! computer  system and  may be  copied only with  the inclusion of the
;	0013	! above copyright notice.  This software, or any other copies thereof,
;	0014	! may not be provided or  otherwise made available to any other person
;	0015	! except for use on such system and to one who agrees to these license
;	0016	! terms.  Title to and  ownership of the  software  shall at all times
;	0017	! remain in DEC.
;	0018	!
;	0019	! The information in this software is subject to change without notice
;	0020	! and should  not be construed  as a commitment  by Digital  Equipment
;	0021	! Corporation.
;	0022	!
;	0023	! DEC assumes  no  responsibility  for  the use or  reliability of its
;	0024	! software on equipment which is not supplied by DEC.
;	0025	
;	0026	!++
;	0027	!
;	0028	! FACILITY:  F11ACP Structure Level 1
;	0029	!
;	0030	! ABSTRACT:
;	0031	!
;	0032	!	This routine verifies that the block given it is in fact a
;	0033	!	file header. If file number and/or file seqence number are also
;	0034	!	supplied, they are checked as well.
;	0035	! ENVIRONMENT:
;	0036	!
;	0037	!	STARLET operating system, including privileged system services
;	0038	!	and internal exec routines.
;	0039	!
;	0040	!--
;	0041	!
;	0042	!
;	0043	! AUTHOR:  Andrew C. Goldstein,	 CREATION DATE:  13-Dec-1976  16:11
;	0044	!
;	0045	! REVISION HISTORY:
;	0046	!
;	0047	!   Andrew C. Goldstein, 16-Mar-1977  14:45
;	0048	!   X0002 - Use common checksum routine
;	0049	!
;	0050	!   Andrew C. Goldstein, 29-Mar-1977  13:55
;	0051	!   X0003 - Recognize deleted file header from garbage
;	0052	!
;	0053	!   Andrew C. Goldstein, 25-Apr-1977  18:36
;	0054	!   X0004 - Move in checksum routine from RDBLOK
;	0055	!

; Bliss-32 10.1-416	Monday 21-AUG-1978 22:49:39	DBB3:[F11A.SRC]CHKHDR.B32;7					Page 1-1
;
;	0056	!   Andrew C. Goldstein, 22-Jul-1977  17:02
;	0057	!   X0005 - Modify for multi-header files
;	0058	!
;	0059	!   Andrew C. Goldstein, 22-Nov-1977  22:21
;	0060	!   X0006 - Break out checksum routine
;	0061	!
;	0062	!   Andrew C. Goldstein, 12-Dec-1977  13:04
;	0063	!   X0007 - file ID interface changes
;	0064	!
;	0065	!**
;	0066	
;	0067	
;	0068	LIBRARY 'SYS$LIBRARY:LIB.L32';
;	0069	REQUIRE 'SRC$:FCPDEF.B32';

; Bliss-32 10.1-416	Monday 21-AUG-1978 22:49:39	DBB3:[F11A.SRC]CHKHDR.B32;7					Page 2
;
;	0388	GLOBAL ROUTINE CHECK_HEADER (HEADER, FILE_ID) =
;	0389	
;	0390	!++
;	0391	!
;	0392	! FUNCTIONAL DESCRIPTION:
;	0393	!
;	0394	!	This routine verifies that the block given it is in fact a
;	0395	!	file header. If file number and/or file seqence number are also
;	0396	!	supplied, they are checked as well.
;	0397	!
;	0398	! CALLING SEQUENCE:
;	0399	!	CHECK_HEADER (ARG1, ARG2)
;	0400	!
;	0401	! INPUT PARAMETERS:
;	0402	!	ARG1: address of header image
;	0403	!	ARG2: address of file ID
;	0404	!
;	0405	! IMPLICIT INPUTS:
;	0406	!	NONE
;	0407	!
;	0408	! OUTPUT PARAMETERS:
;	0409	!	NONE
;	0410	!
;	0411	! IMPLICIT OUTPUTS:
;	0412	!	USER_STATUS contains code if not valid
;	0413	!
;	0414	! ROUTINE VALUE:
;	0415	!	0 if garbage
;	0416	!	1 if valid and correct file header
;	0417	!	2 if deleted file header
;	0418	!
;	0419	! SIDE EFFECTS:
;	0420	!	NONE
;	0421	!
;	0422	!--
;	0423	
;	0424	BEGIN
;	0425	
;	0426	MAP
;	0427		HEADER		: REF BBLOCK,	! file header arg
;	0428		FILE_ID		: REF BBLOCK;	! file ID arg
;	0429	
;	0430	LOCAL
;	0431		MAP_AREA	: REF BBLOCK;	! pointer to header map area
;	0432	
;	0433	EXTERNAL ROUTINE
;	0434		CHECKSUM;			! compute file header checksum
;	0435	
;	0436	
;	0437	! First check the structure level.
;	0438	!
;	0439	
;	0440	IF .HEADER[FH1$W_STRUCLEV] NEQ FH1$C_LEVEL1
;	0441	THEN (ERR_STATUS (SS$_FILESTRUCT); RETURN 0);
;	0442	

; Bliss-32 10.1-416	Monday 21-AUG-1978 22:49:39	DBB3:[F11A.SRC]CHKHDR.B32;7					Page 2-1
;
;	0443	! Now point to the map area and make sure that the extension
;	0444	! RVN is zero (no multi-volume supported yet.)
;	0445	! Also check the retrieval pointer format data.
;	0446	!
;	0447	
;	0448	MAP_AREA = .HEADER + .HEADER[FH1$B_MPOFFSET]*2;
;	0449	
;	0450	IF .MAP_AREA[FM1$B_EX_RVN] NEQ 0
;	0451	OR .MAP_AREA[FM1$B_COUNTSIZE] NEQ 1
;	0452	OR .MAP_AREA[FM1$B_LBNSIZE] NEQ 3
;	0453	THEN (ERR_STATUS (SS$_FILESTRUCT); RETURN 0);
;	0454	
;	0455	! Check the retrieval pointer counts for consistency with the
;	0456	! available space.
;	0457	!
;	0458	
;	0459	IF .MAP_AREA[FM1$B_INUSE] GTRU .MAP_AREA[FM1$B_AVAIL]
;	0460	OR .MAP_AREA[FM1$B_AVAIL] GTRU
;	0461	    255 - (.MAP_AREA + FM1$C_POINTERS - .HEADER) / 2
;	0462	THEN (ERR_STATUS (SS$_BADFILEHDR); RETURN 0);
;	0463	
;	0464	! At this point, we have verified that the block at least once was a
;	0465	! valid file header.
;	0466	!
;	0467	! Look at the file number in the header. If zero, this is a 
;	0468	! deleted header.
;	0469	!
;	0470	
;	0471	IF .HEADER[FH1$W_FID_NUM] EQL 0
;	0472	THEN (ERR_STATUS (SS$_NOSUCHFILE); RETURN 2);
;	0473	
;	0474	! Now compute the header checksum.
;	0475	!
;	0476	
;	0477	IF NOT CHECKSUM (.HEADER)
;	0478	THEN (ERR_STATUS (SS$_BADCHKSUM); RETURN 2);
;	0479	
;	0480	! Check file number and file sequence number.
;	0481	!
;	0482	
;	0483	IF .HEADER[FH1$W_FID_NUM] NEQ .FILE_ID[FID$W_NUM]
;	0484	THEN (ERR_STATUS (SS$_FILENUMCHK); RETURN 2);
;	0485	
;	0486	IF .HEADER[FH1$W_FID_SEQ] NEQ .FILE_ID[FID$W_SEQ]
;	0487	THEN (ERR_STATUS (SS$_FILESEQCHK); RETURN 2);
;	0488	
;	0489	! Header is ok.
;	0490	!
;	0491	
;	0492	RETURN 1;
;	0493	
;	0494	END;					! end of routine CHECK_HEADER


							    .TITLE  CHKHDR

; Bliss-32 10.1-416	Monday 21-AUG-1978 22:49:39	DBB3:[F11A.SRC]CHKHDR.B32;7					Page 2-2
;
							    .IDENT  \A0007\

							    .EXTRN  CHECKSUM, USER_STATUS

							    .PSECT  $CODE$,NOWRT,2

					 000C 00000 	    .ENTRY  CHECK_HEADER, Save R2,R3				      ; 0388
		         53 	0000G  CF  9E 00002 	    MOVAB   USER_STATUS, R3					      ;
		         52 	  04   AC  D0 00007 	    MOVL    HEADER, R2						      ; 0440
		  0101   8F	  06   A2  B1 0000B 	    CMPW    6(R2), #257						      ;
				       19  12 00011 	    BNEQ    1$							      ;
		         50 	  01   A2  9A 00013 	    MOVZBL  1(R2), R0						      ; 0448
		         50 	     6240  3E 00017 	    MOVAW   (R2)[R0], MAP_AREA					      ;
				  01   A0  95 0001B 	    TSTB    1(MAP_AREA)						      ; 0450
				       0C  12 0001E 	    BNEQ    1$							      ;
		         01 	  06   A0  91 00020 	    CMPB    6(MAP_AREA), #1					      ; 0451
				       06  12 00024 	    BNEQ    1$							      ;
		         03 	  07   A0  91 00026 	    CMPB    7(MAP_AREA), #3					      ; 0452
				       07  13 0002A 	    BEQL    2$							      ;
		         63 	08C0   8F  B0 0002C 1$:     MOVW    #2240, USER_STATUS					      ; 0453
				       67  11 00031 	    BRB     10$							      ;
		    09   A0	  08   A0  91 00033 2$:     CMPB    8(MAP_AREA), 9(MAP_AREA)				      ; 0459
				       17  1A 00038 	    BGTRU   3$							      ;
	   51 	         52 	       50  C3 0003A 	    SUBL3   MAP_AREA, R2, R1					      ; 0461
		         51 	       0A  C2 0003E 	    SUBL2   #10, R1						      ;
		         51 	       02  C6 00041 	    DIVL2   #2, R1						      ;
		         51 	00FF   C1  9E 00044 	    MOVAB   255(R1), R1						      ;
      09   A0	         08 	       00  ED 00049 	    CMPZV   #0, #8, 9(MAP_AREA), R1				      ; 0460
				       51     0004E									      ;
				       07  1B 0004F 	    BLEQU   4$							      ;
		         63 	0810   8F  B0 00051 3$:     MOVW    #2064, USER_STATUS					      ; 0462
				       42  11 00056 	    BRB     10$							      ;
				  02   A2  B5 00058 4$:     TSTW    2(R2)						      ; 0471
				       07  12 0005B 	    BNEQ    5$							      ;
		         63 	0910   8F  B0 0005D 	    MOVW    #2320, USER_STATUS					      ; 0472
				       2E  11 00062 	    BRB     8$							      ;
				       52  DD 00064 5$:     PUSHL   R2							      ; 0477
		  0000G  CF	       01  FB 00066 	    CALLS   #1, CHECKSUM					      ;
		         07 	       50  E8 0006B 	    BLBS    R0, 6$						      ;
		         63 	0808   8F  B0 0006E 	    MOVW    #2056, USER_STATUS					      ; 0478
				       1D  11 00073 	    BRB     8$							      ;
		         50 	  08   AC  D0 00075 6$:     MOVL    FILE_ID, R0						      ; 0483
		         60 	  02   A2  B1 00079 	    CMPW    2(R2), (R0)						      ;
				       07  13 0007D 	    BEQL    7$							      ;
		         63 	08B0   8F  B0 0007F 	    MOVW    #2224, USER_STATUS					      ; 0484
				       0C  11 00084 	    BRB     8$							      ;
		    02   A0	  04   A2  B1 00086 7$:     CMPW    4(R2), 2(R0)					      ; 0486
				       09  13 0008B 	    BEQL    9$							      ;
		         63 	08B8   8F  B0 0008D 	    MOVW    #2232, USER_STATUS					      ; 0487
		         50 	       02  D0 00092 8$:     MOVL    #2, R0						      ;
					   04 00095 	    RET     							      ;
		         50 	       01  D0 00096 9$:     MOVL    #1, R0						      ; 0492
					   04 00099 	    RET     							      ;
				       50  D4 0009A 10$:    CLRL    R0							      ; 0388
					   04 0009C 	    RET     							      ;

; Bliss-32 10.1-416	Monday 21-AUG-1978 22:49:39	DBB3:[F11A.SRC]CHKHDR.B32;7					Page 2-3
;

; Routine Size:  157 bytes


;	0495	
;	0496	END
;	0497	ELUDOM






;				       PSECT SUMMARY
;
;	Name		 Bytes			       Attributes
;
;  $CODE$         	   157  NOWRT,  RD ,  EXE,NOSHR,  LCL,  REL,  CON,NOPIC,ALIGN(2)




;				LIBRARY STATISTICS
;
;					     -------- Symbols --------    Blocks
;	File				     Total    Loaded   Percent      Read
;
;  DBA4:[SYSLIB]LIB.L32;1		      5582        20         0       235





; Size:		157 code + 0 data bytes
; Run Time:	00:05.7
; Elapsed Time:	00:14.7
; Memory Used:	278 pages
; Compilation Complete
