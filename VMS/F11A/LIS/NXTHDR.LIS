
; Bliss-32 10.1-416	Monday 21-AUG-1978 23:01:26	DBB3:[F11A.SRC]NXTHDR.B32;7					Page 1
;
;	0001	MODULE NXTHDR (
;	0002			LANGUAGE (BLISS32),
;	0003			IDENT = 'A0002'
;	0004			) =
;	0005	BEGIN
;	0006	
;	0007	!
;	0008	! Copyright (c) 1977
;	0009	! Digital Equipment Corporation, Maynard, Massachusetts 01754
;	0010	!
;	0011	! This software is furnished  under a license for use only on a single
;	0012	! computer  system and  may be  copied only with  the inclusion of the
;	0013	! above copyright notice.  This software, or any other copies thereof,
;	0014	! may not be provided or  otherwise made available to any other person
;	0015	! except for use on such system and to one who agrees to these license
;	0016	! terms.  Title to and  ownership of the  software  shall at all times
;	0017	! remain in DEC.
;	0018	!
;	0019	! The information in this software is subject to change without notice
;	0020	! and should  not be construed  as a commitment  by Digital  Equipment
;	0021	! Corporation.
;	0022	!
;	0023	! DEC assumes  no  responsibility  for  the use or  reliability of its
;	0024	! software on equipment which is not supplied by DEC.
;	0025	
;	0026	!++
;	0027	!
;	0028	! FACILITY:  F11ACP Structure Level 1
;	0029	!
;	0030	! ABSTRACT:
;	0031	!
;	0032	!	This routine reads the next extension header, if any, of the
;	0033	!	given file.
;	0034	!
;	0035	! ENVIRONMENT:
;	0036	!
;	0037	!	STARLET operating system, including privileged system services
;	0038	!	and internal exec routines.
;	0039	!
;	0040	!--
;	0041	!
;	0042	!
;	0043	! AUTHOR:  Andrew C. Goldstein,	 CREATION DATE:  22-Jul-1977  17:40
;	0044	!
;	0045	! REVISION HISTORY:
;	0046	!
;	0047	!   Andrew C. Goldstein, 12-Dec-1977  13:51
;	0048	!   X0002 - file ID interface changes
;	0049	!
;	0050	!**
;	0051	
;	0052	
;	0053	LIBRARY 'SYS$LIBRARY:LIB.L32';
;	0054	REQUIRE 'SRC$:FCPDEF.B32';

; Bliss-32 10.1-416	Monday 21-AUG-1978 23:01:26	DBB3:[F11A.SRC]NXTHDR.B32;7					Page 2
;
;	0373	GLOBAL ROUTINE NEXT_HEADER (HEADER, FCB, EXT_FID, SEGNUM) =
;	0374	
;	0375	!++
;	0376	!
;	0377	! FUNCTIONAL DESCRIPTION:
;	0378	!
;	0379	!	This routine reads the next extension header, if any, of the
;	0380	!	indicated file. Extension data is taked from either the indicated
;	0381	!	file header or the arguments.
;	0382	!
;	0383	!
;	0384	! CALLING SEQUENCE:
;	0385	!	NEXT_HEADER (ARG1, ARG2, ARG3, ARG4)
;	0386	!
;	0387	! INPUT PARAMETERS:
;	0388	!	ARG1: address of current file header or 0
;	0389	!	ARG2: address of corresponding FCB or zero
;	0390	!	ARG3: extension file ID, if present
;	0391	!	ARG4: extension segment number, if present
;	0392	!
;	0393	! IMPLICIT INPUTS:
;	0394	!	NONE
;	0395	!
;	0396	! OUTPUT PARAMETERS:
;	0397	!	NONE
;	0398	!
;	0399	! IMPLICIT OUTPUTS:
;	0400	!	NONE
;	0401	!
;	0402	! ROUTINE VALUE:
;	0403	!	Address of header read or 0 if none
;	0404	!
;	0405	! SIDE EFFECTS:
;	0406	!	File header may be read
;	0407	!
;	0408	!--
;	0409	
;	0410	BEGIN
;	0411	
;	0412	MAP
;	0413		HEADER		: REF BBLOCK,	! file header arg
;	0414		FCB		: REF BBLOCK,	! FCB arg
;	0415		EXT_FID		: REF BBLOCK;	! extension file ID arg
;	0416	
;	0417	LOCAL
;	0418		NEW_HEADER	: REF BBLOCK,	! address of extension file header read
;	0419		MAP_AREA	: REF BBLOCK,	! address of header map area
;	0420		EXT_FCB		: REF BBLOCK,	! address of extension FCB
;	0421		FILE_ID		: BBLOCK [FID$C_LENGTH], ! file ID of extension header
;	0422		SEG_NUMBER	: BYTE;		! segment number of file header
;	0423	
;	0424	EXTERNAL ROUTINE
;	0425		READ_HEADER;			! read a file header
;	0426	
;	0427	

; Bliss-32 10.1-416	Monday 21-AUG-1978 23:01:26	DBB3:[F11A.SRC]NXTHDR.B32;7					Page 2-1
;
;	0428	! Get the extension file number of the file header. If it is zero, then
;	0429	! there is no extension header. If it is non-zero, read the header, using
;	0430	! the extension FCB if one exists.
;	0431	!
;	0432	
;	0433	IF ACTUALCOUNT LSS 4
;	0434	THEN
;	0435	    BEGIN
;	0436	    MAP_AREA = .HEADER + .HEADER[FH1$B_MPOFFSET]*2;
;	0437	    FILE_ID[FID$W_NUM] = .MAP_AREA[FM1$W_EX_FILNUM];
;	0438	    FILE_ID[FID$W_SEQ] = .MAP_AREA[FM1$W_EX_FILSEQ];
;	0439	    FILE_ID[FID$W_RVN] = 0;
;	0440	    SEG_NUMBER = .MAP_AREA[FM1$B_EX_SEGNUM] + 1;
;	0441	    END
;	0442	ELSE
;	0443	    BEGIN
;	0444	    CH$MOVE (FID$C_LENGTH, .EXT_FID, FILE_ID);
;	0445	    SEG_NUMBER = .SEGNUM;
;	0446	    END;
;	0447	
;	0448	IF .FILE_ID[FID$W_NUM] EQL 0 THEN RETURN 0;
;	0449	EXT_FCB =
;	0450	    (IF .FCB NEQ 0
;	0451	     THEN .FCB[FCB$L_EXFCB]
;	0452	     ELSE 0
;	0453	    );
;	0454	NEW_HEADER = READ_HEADER (FILE_ID, .EXT_FCB);
;	0455	
;	0456	! Check the segment number of the header read for consistency.
;	0457	!
;	0458	
;	0459	MAP_AREA = .NEW_HEADER + .NEW_HEADER[FH1$B_MPOFFSET]*2;
;	0460	IF .SEG_NUMBER NEQ .MAP_AREA[FM1$B_EX_SEGNUM]
;	0461	THEN ERR_EXIT (SS$_BADFILEHDR);
;	0462	
;	0463	RETURN .NEW_HEADER;
;	0464	
;	0465	END;					! end of routine NEXT_HEADER


							    .TITLE  NXTHDR
							    .IDENT  \A0002\

							    .EXTRN  READ_HEADER

							    .PSECT  $CODE$,NOWRT,2

					 003C 00000 	    .ENTRY  NEXT_HEADER, Save R2,R3,R4,R5			      ; 0373
		         5E 	       08  C2 00002 	    SUBL2   #8, SP						      ;
		         04 	       6C  91 00005 	    CMPB    (AP), #4						      ; 0433
				       19  1E 00008 	    BGEQU   1$							      ;
		         51 	  04   AC  D0 0000A 	    MOVL    HEADER, R1						      ; 0436
		         50 	  01   A1  9A 0000E 	    MOVZBL  1(R1), R0						      ;
		         52 	     6140  3E 00012 	    MOVAW   (R1)[R0], MAP_AREA					      ;
		         6E 	  02   A2  D0 00016 	    MOVL    2(MAP_AREA), FILE_ID				      ; 0437

; Bliss-32 10.1-416	Monday 21-AUG-1978 23:01:26	DBB3:[F11A.SRC]NXTHDR.B32;7					Page 2-2
;
				  04   AE  B4 0001A 	    CLRW    FILE_ID+4						      ; 0439
	   53 	         62 	       01  81 0001D 	    ADDB3   #1, (MAP_AREA), SEG_NUMBER				      ; 0440
				       09  11 00021 	    BRB     2$							      ; 0433
	   6E 	    0C   BC	       06  28 00023 1$:     MOVC3   #6, @EXT_FID, FILE_ID				      ; 0444
		         53 	  10   AC  90 00028 	    MOVB    SEGNUM, SEG_NUMBER					      ; 0445
				       6E  B5 0002C 2$:     TSTW    FILE_ID						      ; 0448
				       30  13 0002E 	    BEQL    6$							      ;
		         50 	  08   AC  D0 00030 	    MOVL    FCB, R0						      ; 0450
				       06  13 00034 	    BEQL    3$							      ;
		         50 	  0C   A0  D0 00036 	    MOVL    12(R0), EXT_FCB					      ;
				       02  11 0003A 	    BRB     4$							      ;
				       50  D4 0003C 3$:     CLRL    EXT_FCB						      ;
				       50  DD 0003E 4$:     PUSHL   EXT_FCB						      ; 0454
				  04   AE  9F 00040 	    PUSHAB  FILE_ID						      ;
		  0000G  CF	       02  FB 00043 	    CALLS   #2, READ_HEADER					      ;
		         51 	       50  D0 00048 	    MOVL    R0, NEW_HEADER					      ;
		         50 	  01   A1  9A 0004B 	    MOVZBL  1(NEW_HEADER), R0					      ; 0459
		         52 	     6140  3E 0004F 	    MOVAW   (NEW_HEADER)[R0], MAP_AREA				      ;
		         62 	       53  91 00053 	    CMPB    SEG_NUMBER, (MAP_AREA)				      ; 0460
				       04  13 00056 	    BEQL    5$							      ;
				0810   8F  BF 00058 	    CHMU    #2064						      ; 0461
		         50 	       51  D0 0005C 5$:     MOVL    NEW_HEADER, R0					      ; 0463
					   04 0005F 	    RET     							      ;
				       50  D4 00060 6$:     CLRL    R0							      ; 0373
					   04 00062 	    RET     							      ;

; Routine Size:  99 bytes


;	0466	
;	0467	END
;	0468	ELUDOM






;				       PSECT SUMMARY
;
;	Name		 Bytes			       Attributes
;
;  $CODE$         	    99  NOWRT,  RD ,  EXE,NOSHR,  LCL,  REL,  CON,NOPIC,ALIGN(2)




;				LIBRARY STATISTICS
;
;					     -------- Symbols --------    Blocks
;	File				     Total    Loaded   Percent      Read
;
;  DBA4:[SYSLIB]LIB.L32;1		      5582        11         0       232



; Bliss-32 10.1-416	Monday 21-AUG-1978 23:01:26	DBB3:[F11A.SRC]NXTHDR.B32;7					Page 2-3
;



; Size:		99 code + 0 data bytes
; Run Time:	00:04.8
; Elapsed Time:	00:12.3
; Memory Used:	271 pages
; Compilation Complete
