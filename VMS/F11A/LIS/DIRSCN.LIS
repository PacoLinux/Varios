
; Bliss-32 10.1-416	Monday 21-AUG-1978 22:54:56	DBB3:[F11A.SRC]DIRSCN.B32;8					Page 1
;
;	0001	MODULE DIRSCN (
;	0002			LANGUAGE (BLISS32),
;	0003			IDENT = 'A0006'
;	0004			) =
;	0005	BEGIN
;	0006	
;	0007	!
;	0008	! Copyright (c) 1977
;	0009	! Digital Equipment Corporation, Maynard, Massachusetts 01754
;	0010	!
;	0011	! This software is furnished  under a license for use only on a single
;	0012	! computer  system and  may be  copied only with  the inclusion of the
;	0013	! above copyright notice.  This software, or any other copies thereof,
;	0014	! may not be provided or  otherwise made available to any other person
;	0015	! except for use on such system and to one who agrees to these license
;	0016	! terms.  Title to and  ownership of the  software  shall at all times
;	0017	! remain in DEC.
;	0018	!
;	0019	! The information in this software is subject to change without notice
;	0020	! and should  not be construed  as a commitment  by Digital  Equipment
;	0021	! Corporation.
;	0022	!
;	0023	! DEC assumes  no  responsibility  for  the use or  reliability of its
;	0024	! software on equipment which is not supplied by DEC.
;	0025	
;	0026	!++
;	0027	!
;	0028	! FACILITY:  F11ACP Structure Level 1
;	0029	!
;	0030	! ABSTRACT:
;	0031	!
;	0032	!	This routine performs the basic scan of a directory,
;	0033	!	searching for both relevant entries and free space.
;	0034	! ENVIRONMENT:
;	0035	!
;	0036	!	STARLET operating system, including privileged system services
;	0037	!	and internal exec routines.
;	0038	!
;	0039	!--
;	0040	!
;	0041	!
;	0042	! AUTHOR:  Andrew C. Goldstein,	 CREATION DATE:  26-Dec-1976  19:13
;	0043	!
;	0044	! REVISION HISTORY:
;	0045	!
;	0046	!   Andrew C. Goldstein, 29-Mar-1977  10:16
;	0047	!   X0002 - Remove -1 version processing, add ENTER function support
;	0048	!
;	0049	!   Andrew C. Goldstein, 5-Apr-1977  16:49
;	0050	!   X0003 - Remove FCB and window arguments from DIRGET call
;	0051	!
;	0052	!   Andrew C. Goldstein, 21-Apr-1977  14:29
;	0053	!   X0004 - Fix wild card version handling
;	0054	!
;	0055	!   Andrew C. Goldstein, 26-Sep-1977  18:06

; Bliss-32 10.1-416	Monday 21-AUG-1978 22:54:56	DBB3:[F11A.SRC]DIRSCN.B32;8					Page 1-1
;
;	0056	!   X0005 - Add high and low version detection, find oldest version, find FID.
;	0057	!
;	0058	!   Andrew C. Goldstein, 23-APR-78  19:40
;	0059	!   X0006 - Add long block directory reads
;	0060	!
;	0061	!**
;	0062	
;	0063	
;	0064	LIBRARY 'SYS$LIBRARY:LIB.L32';
;	0065	REQUIRE 'SRC$:FCPDEF.B32';

; Bliss-32 10.1-416	Monday 21-AUG-1978 22:54:56	DBB3:[F11A.SRC]DIRSCN.B32;8					Page 2
;
;	0384	GLOBAL ROUTINE DIR_SCAN (NAME_BLOCK, ENTER_MODE) =
;	0385	
;	0386	!++
;	0387	!
;	0388	! FUNCTIONAL DESCRIPTION:
;	0389	!
;	0390	!	This routine performs the basic scan of a directory,
;	0391	!	searching for both relevant entries and free space.
;	0392	!
;	0393	! CALLING SEQUENCE:
;	0394	!	DIR_SCAN (ARG1, ARG2)
;	0395	!
;	0396	! INPUT PARAMETERS:
;	0397	!	ARG1: address of name block
;	0398	!	ARG2: 0 if operation is FIND or REMOVE
;	0399	!	      1 if operation is ENTER
;	0400	!
;	0401	! IMPLICIT INPUTS:
;	0402	!	NONE
;	0403	!
;	0404	! OUTPUT PARAMETERS:
;	0405	!	NONE
;	0406	!
;	0407	! IMPLICIT OUTPUTS:
;	0408	!	FIRST_FREE: record number of first free directory entry
;	0409	!	DIR_RECORD: record number of found entry
;	0410	!	HIGHEST_VERSION: highest version number encountered
;	0411	!	LOWEST_VERSION: lowest version number encountered
;	0412	!
;	0413	! ROUTINE VALUE:
;	0414	!	address of found directory entry or
;	0415	!	0 if not found
;	0416	!
;	0417	! SIDE EFFECTS:
;	0418	!	NONE
;	0419	!
;	0420	!--
;	0421	
;	0422	BEGIN
;	0423	
;	0424	MAP
;	0425		NAME_BLOCK	: REF BBLOCK;	! name block arg
;	0426	
;	0427	EXTERNAL
;	0428		FIRST_FREE,			! record number of first free slot
;	0429		HIGHEST_VERSION,		! highest version number seen
;	0430		LOWEST_VERSION,			! lowest version number seen
;	0431		DIR_RECORD;			! record number of found entry
;	0432	
;	0433	EXTERNAL ROUTINE
;	0434		DIRGET;				! get a directory record
;	0435	
;	0436	LOCAL
;	0437		HIGH_VERSION	: SIGNED WORD,	! highest version so far
;	0438		LOW_VERSION	: SIGNED WORD,	! lowest version so far

; Bliss-32 10.1-416	Monday 21-AUG-1978 22:54:56	DBB3:[F11A.SRC]DIRSCN.B32;8					Page 2-1
;
;	0439		FREE_RECORD,			! first free record encountered
;	0440		REC_NUM,			! current record number
;	0441		BEST_REC,			! record number of highest/lowest version
;	0442		RECADDR		: REF BBLOCK;	! address of current directory record
;	0443	
;	0444	! Initialize things.
;	0445	!
;	0446	
;	0447	FREE_RECORD = 0;			! no empty record found yet
;	0448	BEST_REC = 0;				! no match found at all
;	0449	HIGH_VERSION = 0;			! no high version as yet
;	0450	LOW_VERSION = 32767;			! no low version as yet
;	0451	
;	0452	! Now scan the directory sequentially, looking at each entry. If the search
;	0453	! is for *.*;*, then read one block at a time. Otherwise, read whatever the
;	0454	! buffer pool will take.
;	0455	!
;	0456	
;	0457	REC_NUM = .NAME_BLOCK[NMB$W_CONTEXT];
;	0458	IF
;	0459	BEGIN
;	0460	WHILE 1 DO
;	0461	    BEGIN
;	0462	    REC_NUM = .REC_NUM + 1;
;	0463	    IF  .NAME_BLOCK[NMB$V_ALLNAM]
;	0464	    AND .NAME_BLOCK[NMB$V_ALLTYP]
;	0465	    AND .NAME_BLOCK[NMB$V_ALLVER]
;	0466	    THEN
;	0467		RECADDR = DIRGET (.REC_NUM, 0)
;	0468	    ELSE
;	0469		RECADDR = DIRGET (.REC_NUM, 1);
;	0470	
;	0471	    IF .RECADDR EQL 0 THEN EXITLOOP 1;	! out on end of file
;	0472	
;	0473	! Process each directory entry. First check for empty entries, noting
;	0474	! the first one.
;	0475	!
;	0476	
;	0477	    IF .RECADDR[NMB$W_FID_NUM] EQL 0
;	0478	    THEN
;	0479		BEGIN
;	0480		IF .FREE_RECORD EQL 0 THEN FREE_RECORD = .REC_NUM
;	0481		END
;	0482	
;	0483	! If we are in file ID search mode, compare the file ID
;	0484	!
;	0485	
;	0486	    ELSE IF .NAME_BLOCK[NMB$V_FINDFID]
;	0487	    THEN
;	0488		BEGIN
;	0489		IF CH$EQL (NMB$S_FID, NAME_BLOCK[NMB$W_FID],
;	0490			NMB$S_FID,  RECADDR[NMB$W_FID], 0)
;	0491		THEN EXITLOOP 0;
;	0492		END
;	0493	

; Bliss-32 10.1-416	Monday 21-AUG-1978 22:54:56	DBB3:[F11A.SRC]DIRSCN.B32;8					Page 2-2
;
;	0494	! Otherwise compare the name and type fields under wild card control.
;	0495	!
;	0496	
;	0497	    ELSE IF
;	0498		(
;	0499		.NAME_BLOCK[NMB$V_ALLNAM]
;	0500		OR CH$EQL (NMB$S_NAME, NAME_BLOCK[NMB$W_NAME],
;	0501		    NMB$S_NAME, RECADDR[NMB$W_NAME], 0)
;	0502		)
;	0503	    AND
;	0504		(
;	0505		.NAME_BLOCK[NMB$V_ALLTYP]
;	0506		OR .NAME_BLOCK[NMB$W_TYPE] EQL .RECADDR[NMB$W_TYPE]
;	0507		)
;	0508	
;	0509	! On a name and type match, process the version. Wild card is an immediate
;	0510	! match. Otherwise, maintain highest and lowest numbers found, keeping
;	0511	! the record number of what we are looking for, if any. On exact match,
;	0512	! exit immediately, note, or ignore, depending on the mode.
;	0513	!
;	0514	
;	0515	    THEN
;	0516		BEGIN
;	0517		IF .NAME_BLOCK[NMB$V_ALLVER]
;	0518		THEN EXITLOOP 0;		! wild card version
;	0519	
;	0520		IF .RECADDR[NMB$W_VERSION] GTR .HIGH_VERSION
;	0521		THEN
;	0522		    BEGIN
;	0523		    HIGH_VERSION = .RECADDR[NMB$W_VERSION];
;	0524		    IF NOT .ENTER_MODE AND .NAME_BLOCK[NMB$W_VERSION] EQL 0
;	0525		    THEN BEST_REC = .REC_NUM;
;	0526		    END;
;	0527	
;	0528		IF .RECADDR[NMB$W_VERSION] LSS .LOW_VERSION
;	0529		THEN
;	0530		    BEGIN
;	0531		    LOW_VERSION = .RECADDR[NMB$W_VERSION];
;	0532		    IF NOT .ENTER_MODE AND .NAME_BLOCK[NMB$W_VERSION] EQL -32768
;	0533		    THEN BEST_REC = .REC_NUM;
;	0534		    END;
;	0535	
;	0536		IF .RECADDR[NMB$W_VERSION] EQL .NAME_BLOCK[NMB$W_VERSION]
;	0537		THEN
;	0538		    BEGIN
;	0539		    IF NOT .ENTER_MODE THEN EXITLOOP 0;
;	0540		    IF NOT .NAME_BLOCK[NMB$V_NEWVER]
;	0541		    THEN BEST_REC = .REC_NUM;
;	0542		    END;
;	0543	
;	0544		END;				! end of version processing
;	0545	    END					! end of loop
;	0546	END					! end surrounding loop
;	0547	THEN					! if we scanned the whole directory
;	0548	    IF .BEST_REC NEQ 0			! and found a candidate

; Bliss-32 10.1-416	Monday 21-AUG-1978 22:54:56	DBB3:[F11A.SRC]DIRSCN.B32;8					Page 2-3
;
;	0549	    THEN
;	0550		BEGIN				! re-read the winning entry
;	0551		RECADDR = DIRGET (.BEST_REC, 0);
;	0552		REC_NUM = .BEST_REC;
;	0553		END;
;	0554	
;	0555	! Return the implicit outputs as specified and return the address of the
;	0556	! found directory entry (or 0 for none).
;	0557	!
;	0558	
;	0559	FIRST_FREE = .FREE_RECORD;		! first free entry
;	0560	HIGHEST_VERSION = .HIGH_VERSION;	! highest version number found
;	0561	LOWEST_VERSION = .LOW_VERSION;		! lowest version number found
;	0562	DIR_RECORD = .REC_NUM;			! record number of entry
;	0563	RETURN .RECADDR;
;	0564	END;					! end of routine DIR_SCAN


							    .TITLE  DIRSCN
							    .IDENT  \A0006\

							    .EXTRN  FIRST_FREE, HIGHEST_VERSION, LOWEST_VERSION, DIR_RECORD
							    .EXTRN  DIRGET

							    .PSECT  $CODE$,NOWRT,2

					 0FFC 00000 	    .ENTRY  DIR_SCAN, Save R2,R3,R4,R5,R6,R7,R8,R9,R10,R11	      ; 0384
				       5B  D4 00002 	    CLRL    FREE_RECORD						      ; 0447
				       58  D4 00004 	    CLRL    BEST_REC						      ; 0448
				       59  B4 00006 	    CLRW    HIGH_VERSION					      ; 0449
		         5A 	7FFF   8F  B0 00008 	    MOVW    #32767, LOW_VERSION					      ; 0450
		         54 	  04   AC  D0 0000D 	    MOVL    NAME_BLOCK, R4					      ; 0457
		         56 	  12   A4  3C 00011 	    MOVZWL  18(R4), REC_NUM					      ;
		         57 	  10   A4  9E 00015 	    MOVAB   16(R4), R7						      ; 0463
				       56  D6 00019 1$:     INCL    REC_NUM						      ; 0462
	   0C 	         67 	       05  E1 0001B 	    BBC     #5, (R7), 2$					      ; 0463
	   08 	         67 	       04  E1 0001F 	    BBC     #4, (R7), 2$					      ; 0464
	   04 	         67 	       03  E1 00023 	    BBC     #3, (R7), 2$					      ; 0465
				       7E  D4 00027 	    CLRL    -(SP)						      ; 0467
				       02  11 00029 	    BRB     3$							      ;
				       01  DD 0002B 2$:     PUSHL   #1							      ; 0469
				       56  DD 0002D 3$:     PUSHL   REC_NUM						      ;
		  0000G  CF	       02  FB 0002F 	    CALLS   #2, DIRGET						      ;
		         55 	       50  D0 00034 	    MOVL    R0, RECADDR						      ;
				       76  13 00037 	    BEQL    12$							      ; 0471
				       65  B5 00039 	    TSTW    (RECADDR)						      ; 0477
				       09  12 0003B 	    BNEQ    6$							      ;
				       5B  D5 0003D 	    TSTL    FREE_RECORD						      ; 0480
				       D8  12 0003F 4$:     BNEQ    1$							      ;
		         5B 	       56  D0 00041 	    MOVL    REC_NUM, FREE_RECORD				      ;
				       D3  11 00044 5$:     BRB     1$							      ; 0477
	   08 	         67 	       0B  E1 00046 6$:     BBC     #11, (R7), 7$					      ; 0486
	   65 	         64 	       06  29 0004A 	    CMPC3   #6, (R4), (RECADDR)					      ; 0489
				       C9  12 0004E 	    BNEQ    1$							      ;
				       70  11 00050 	    BRB     13$							      ; 0491

; Bliss-32 10.1-416	Monday 21-AUG-1978 22:54:56	DBB3:[F11A.SRC]DIRSCN.B32;8					Page 2-4
;
	   08 	         67 	       05  E0 00052 7$:     BBS     #5, (R7), 8$					      ; 0499
      06   A5	    06   A4	       06  29 00056 	    CMPC3   #6, 6(R4), 6(RECADDR)				      ; 0500
				       BB  12 0005C 	    BNEQ    1$							      ;
	   07 	         67 	       04  E0 0005E 8$:     BBS     #4, (R7), 9$					      ; 0505
		    0C   A5	  0C   A4  B1 00062 	    CMPW    12(R4), 12(RECADDR)					      ; 0506
				       B0  12 00067 	    BNEQ    1$							      ;
	   55 	         67 	       03  E0 00069 9$:     BBS     #3, (R7), 13$					      ; 0517
		         50 	  0E   A5  32 0006D 	    CVTWL   14(RECADDR), R0					      ; 0520
		         50 	       59  B1 00071 	    CMPW    HIGH_VERSION, R0					      ;
				       0F  18 00074 	    BGEQ    10$							      ;
		         59 	       50  B0 00076 	    MOVW    R0, HIGH_VERSION					      ; 0523
		         08 	  08   AC  E8 00079 	    BLBS    ENTER_MODE, 10$					      ; 0524
				  0E   A4  B5 0007D 	    TSTW    14(R4)						      ;
				       03  12 00080 	    BNEQ    10$							      ;
		         58 	       56  D0 00082 	    MOVL    REC_NUM, BEST_REC					      ; 0525
		         50 	       5A  B1 00085 10$:    CMPW    LOW_VERSION, R0					      ; 0528
				       12  15 00088 	    BLEQ    11$							      ;
		         5A 	       50  B0 0008A 	    MOVW    R0, LOW_VERSION					      ; 0531
		         0B 	  08   AC  E8 0008D 	    BLBS    ENTER_MODE, 11$					      ; 0532
		  8000   8F	  0E   A4  B1 00091 	    CMPW    14(R4), #-32768					      ;
				       03  12 00097 	    BNEQ    11$							      ;
		         58 	       56  D0 00099 	    MOVL    REC_NUM, BEST_REC					      ; 0533
		         50 	  0E   A4  B1 0009C 11$:    CMPW    14(R4), R0						      ; 0536
				       9D  12 000A0 	    BNEQ    4$							      ;
		         1C 	  08   AC  E9 000A2 	    BLBC    ENTER_MODE, 13$					      ; 0539
	   9A 	         67 	       09  E0 000A6 	    BBS     #9, (R7), 5$					      ; 0540
		         58 	       56  D0 000AA 	    MOVL    REC_NUM, BEST_REC					      ; 0541
				       95  11 000AD 	    BRB     5$							      ; 0536
				       58  D5 000AF 12$:    TSTL    BEST_REC						      ; 0548
				       0F  13 000B1 	    BEQL    13$							      ;
				       7E  D4 000B3 	    CLRL    -(SP)						      ; 0551
				       58  DD 000B5 	    PUSHL   BEST_REC						      ;
		  0000G  CF	       02  FB 000B7 	    CALLS   #2, DIRGET						      ;
		         55 	       50  D0 000BC 	    MOVL    R0, RECADDR						      ;
		         56 	       58  D0 000BF 	    MOVL    BEST_REC, REC_NUM					      ; 0552
		  0000G  CF	       5B  D0 000C2 13$:    MOVL    FREE_RECORD, FIRST_FREE				      ; 0559
		  0000G  CF	       59  32 000C7 	    CVTWL   HIGH_VERSION, HIGHEST_VERSION			      ; 0560
		  0000G  CF	       5A  32 000CC 	    CVTWL   LOW_VERSION, LOWEST_VERSION				      ; 0561
		  0000G  CF	       56  D0 000D1 	    MOVL    REC_NUM, DIR_RECORD					      ; 0562
		         50 	       55  D0 000D6 	    MOVL    RECADDR, R0						      ; 0563
					   04 000D9 	    RET     							      ; 0384

; Routine Size:  218 bytes


;	0565	
;	0566	END
;	0567	ELUDOM






;				       PSECT SUMMARY

; Bliss-32 10.1-416	Monday 21-AUG-1978 22:54:56	DBB3:[F11A.SRC]DIRSCN.B32;8					Page 2-5
;
;
;	Name		 Bytes			       Attributes
;
;  $CODE$         	   218  NOWRT,  RD ,  EXE,NOSHR,  LCL,  REL,  CON,NOPIC,ALIGN(2)




;				LIBRARY STATISTICS
;
;					     -------- Symbols --------    Blocks
;	File				     Total    Loaded   Percent      Read
;
;  DBA4:[SYSLIB]LIB.L32;1		      5582        14         0       223





; Size:		218 code + 0 data bytes
; Run Time:	00:08.4
; Elapsed Time:	00:19.5
; Memory Used:	326 pages
; Compilation Complete
