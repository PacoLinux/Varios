ALLOCB          - ALLOCATE DYNAMIC MEMORY                        21-AUG-1978 22:46:28   VAX-11 MACRO X0.3-11               Page   1
X0003                                                                                                                            (1)

                                     0000     1 	.TITLE	ALLOCB - ALLOCATE DYNAMIC MEMORY
                                     0000     2 	.IDENT	"X0003"
                                     0000     3 
                                     0000     4 ;
                                     0000     5 ; COPYRIGHT (C) 1976
                                     0000     6 ; DIGITAL EQUIPMENT CORPORATION, MAYNARD, MASSACHUSETTS 01754
                                     0000     7 ;
                                     0000     8 ; THIS SOFTWARE IS FURNISHED  UNDER A LICENSE FOR USE ONLY ON A SINGLE
                                     0000     9 ; COMPUTER  SYSTEM AND  MAY BE  COPIED ONLY WITH  THE INCLUSION OF THE
                                     0000    10 ; ABOVE COPYRIGHT NOTICE.  THIS SOFTWARE, OR ANY OTHER COPIES THEREOF,
                                     0000    11 ; MAY NOT BE PROVIDED OR  OTHERWISE MADE AVAILABLE TO ANY OTHER PERSON
                                     0000    12 ; EXCEPT FOR USE ON SUCH SYSTEM AND TO ONE WHO AGREES TO THESE LICENSE
                                     0000    13 ; TERMS.  TITLE TO AND  OWNERSHIP OF THE  SOFTWARE  SHALL AT ALL TIMES
                                     0000    14 ; REMAIN IN DEC.
                                     0000    15 ;
                                     0000    16 ; THE INFORMATION IN THIS SOFTWARE IS SUBJECT TO CHANGE WITHOUT NOTICE
                                     0000    17 ; AND SHOULD  NOT BE CONSTRUED  AS A COMMITMENT  BY DIGITAL  EQUIPMENT
                                     0000    18 ; CORPORATION.
                                     0000    19 ;
                                     0000    20 ; DEC ASSUMES  NO  RESPONSIBILITY  FOR  THE USE OR  RELIABILITY OF ITS
                                     0000    21 ; SOFTWARE ON EQUIPMENT WHICH IS NOT SUPPLIED BY DEC.
                                     0000    22 
                                     0000    23 ;++
                                     0000    24 ;
                                     0000    25 ; FACILITY:  F11ACP STRUCTURE LEVEL 1
                                     0000    26 ;
                                     0000    27 ; ABSTRACT:
                                     0000    28 ;
                                     0000    29 ;	THESE ROUTINES ALLOCATE AND DEALLOCATE SYSTEM NON-PAGED
                                     0000    30 ;	DYNAMIC MEMORY FOR FCP CONTROL BLOCKS.
                                     0000    31 ;
                                     0000    32 ; ENVIRONMENT:
                                     0000    33 ;
                                     0000    34 ;	STARLET OPERATING SYSTEM, INCLUDING PRIVILEGED SYSTEM SERVICES
                                     0000    35 ;	AND INTERNAL EXEC ROUTINES. NOTE THAT THIS ROUTINE MUST BE
                                     0000    36 ;	CALLED IN KERNEL MODE.
                                     0000    37 ;
                                     0000    38 ; AUTHOR:  ANDREW C. GOLDSTEIN, CREATION DATE:  14-DEC-1976  16:25
                                     0000    39 ;
                                     0000    40 ; MODIFIED BY:
                                     0000    41 ;
                                     0000    42 ; DEBORAH H. GILLESPIE, VERSION X0003  , 09-JUL-1977 15:00
                                     0000    43 ; X0003	- ADD MTAACP CONTROL BLOCKS
                                     0000    44  
                                     0000    45 ;--
                                     0000    46 
                                     0000    47 ;
                                     0000    48 ; INCLUDE FILES:
                                     0000    49 ;
                                     0000    50 ;	INCLUDE "FCPDEF.MAR"
                                     0000    51 
                                     0000    52 ;
                                     0000    53 ; EQUATED SYMBOLS:
                                     0000    54 ;
                                     0000    55 ; ARG LIST OFFSETS
                                     0000    56 ;
                           00000004  0000    57 BYTES	= 4				; BYTE COUNT DESIRED
ALLOCB          - ALLOCATE DYNAMIC MEMORY                        21-AUG-1978 22:46:28   VAX-11 MACRO X0.3-11               Page   2
X0003                                                                                                                            (1)

                           00000008  0000    58 TYPE	= 8				; BLOCK TYPE BEING ALLOCATED
                           00000004  0000    59 ADDRESS	= 4				; ADDRESS OF BLOCK BEING DEALLOCATED
                                     0000    60 
                                     0000    61 	$DYNDEF	GLOBAL			; DEFINE STRUCTURE TYPE CODES
                                     0000    62 	$IPLDEF				; DEFINE SYSTEM IPL NAMES
                                     0000    63 	$PRDEF				; DEFINE PROCESSOR REGISTER NAMES
                                     0000    64 	$RSNDEF				; DEFINE RESOURCE NAMES
                                     0000    65 	$WCBDEF				; DEFINE WINDOW BLOCK FORMAT
                                     0000    66 					; USED ONLY FOR TAGS TO THE BLOCK TYPE
                                     0000    67 					; AND SIZE FIELDS
                                     0000    68 
                                 00000000    69 	.PSECT	$LOCKEDC1$,NOWRT,LONG
                                     0000    70 ;
                                     0000    71 ; OWN STORAGE:
                                     0000    72 ;
                                     0000    73 BLOCK_TYPE:				; LIST OF SYSTEM TYPE CODES,
                                     0000    74 	.BYTE	DYN$C_FCB,-		; INDEXED BY FCP TYPE CODE
                                 07  0000    75 		DYN$C_WCB,-
                                 12  0001    76 		DYN$C_VCB,-
                                 11  0002    77 		DYN$C_RVT,-		; RELATIVE VOLUME TABLE CONTROL BLOCK
                                 0E  0003    78 		DYN$C_MVL,-		; MAGNETIC TAPE VOLUME LIST
                              03 16  0004    79 		DYN$C_AQB		; ACP QUEUE CONTROL BLOCK
                                     0006    80 
                                     0006    81 	.ALIGN	2
ALLOCB          - ALLOCATE DYNAMIC MEMORY                        21-AUG-1978 22:46:28   VAX-11 MACRO X0.3-11               Page   3
X0003                                                                                                                            (2)

                                     0008    83 ;++
                                     0008    84 ;
                                     0008    85 ; FUNCTIONAL DESCRIPTION:
                                     0008    86 ;
                                     0008    87 ; THIS ROUTINE ALLOCATES THE REQUESTED BLOCK SIZE FROM SYSTEM
                                     0008    88 ; NON-PAGED DYNAMIC MEMORY. THE BLOCK IS CLEARED, AND THE STANDARD
                                     0008    89 ; SIZE AND TYPE DATA IS INSERTED.
                                     0008    90 ;
                                     0008    91 ; CALLING SEQUENCE:
                                     0008    92 ;	CALL	ALLOCATE (ARG1, ARG2)
                                     0008    93 ;
                                     0008    94 ; INPUT PARAMETERS:
                                     0008    95 ;	ARG1: NUMBER OF BYTES TO ALLOCATE
                                     0008    96 ;	ARG2: TYPE OF BLOCK
                                     0008    97 ;
                                     0008    98 ; IMPLICIT INPUTS:
                                     0008    99 ;	NONE
                                     0008   100 ;
                                     0008   101 ; OUTPUT PARAMETERS:
                                     0008   102 ;	NONE
                                     0008   103 ;
                                     0008   104 ; IMPLICIT OUTPUTS:
                                     0008   105 ;	NONE
                                     0008   106 ;
                                     0008   107 ; ROUTINE VALUE:
                                     0008   108 ;	ADDRESS OF BLOCK
                                     0008   109 ;
                                     0008   110 ; SIDE EFFECTS:
                                     0008   111 ;	BLOCK ALLOCATED
                                     0008   112 ;
                                     0008   113 ;--
                                     0008   114 
                                     0008   115 ALLOCATE::
                               003C  0008   116 	.WORD	^M<R2,R3,R4,R5>		; SAVE THE USUAL REGISTERS
            51         04 AC     D0  000A   117 10$:	MOVL	BYTES(AP),R1		; GET SIZE ARGUMENT
                          7E     DC  000E   118 	MOVPSL	-(SP)			; SAVE THE PSL FOR WAIT CALL BELOW
                                     0010   119 	DSBINT	#IPL$_SYNCH,R2		; RAISE IPL TO SYNCHRONIZE
                 00000000'9F     16  0016   120 	JSB	@#EXE$ALONONPAGED	; GET BLOCK FROM EXEC
            20            50     E9  001C   121 	BLBC	R0,20$			; BRANCH ON FAILURE
                                     001F   122 	ENBINT	#0			; RESTORE IPL
                                     0022   123 					; CLEAN PSL OFF STACK AND
            6E            51     D0  0022   124 	MOVL	R1,(SP)			; SAVE RETURNED BYTE COUNT
                          52     DD  0025   125 	PUSHL	R2			; AND ADDRESS
            62            00     2C  0027   126 	MOVC5	#0,(R2),#0,R1,(R2)	; ZERO OUT THE BLOCK
            51            00         002A       
                          62         002C       
                                     002D   127 
            50            8E     D0  002D   128 	MOVL	(SP)+,R0		; GET BLOCK ADDRESS
         08 A0            8E     F7  0030   129 	CVTLW	(SP)+,WCB$W_SIZE(R0)	; PUT IN SIZE WORD
            51         08 AC     D0  0034   130 	MOVL	TYPE(AP),R1		; GET BLOCK TYPE ARG
         0A A0         C4 AF41   90  0038   131 	MOVB	BLOCK_TYPE[R1],WCB$B_TYPE(R0)
                                 04  003E   132 	RET				; AND RETURN
                                     003F   133 ;
                                     003F   134 ; WE GET HERE IF MEMORY IS NOT AVAILABLE
                                     003F   135 ;
            50            03     3C  003F   136 20$:	MOVZWL	#RSN$_NPDYNMEM,R0	; GET APPROPRIATE RESOURCE CODE
            54   00000000'9F     D0  0042   137 	MOVL	@#SCH$GL_CURPCB,R4	; AND PROCESS PCB ADDRESS
ALLOCB          - ALLOCATE DYNAMIC MEMORY                        21-AUG-1978 22:46:28   VAX-11 MACRO X0.3-11               Page   4
X0003                                                                                                                            (2)

                 00000000'9F     16  0049   138 	JSB	@#SCH$RWAIT		; AND WAIT FOR POOL TO APPEAR
                          B9     11  004F   139 	BRB	10$			; TRY AGAIN
ALLOCB          - ALLOCATE DYNAMIC MEMORY                        21-AUG-1978 22:46:28   VAX-11 MACRO X0.3-11               Page   5
X0003                                                                                                                            (3)

                                     0051   141 ;++
                                     0051   142 ;
                                     0051   143 ; FUNCTIONAL DESCRIPTION:
                                     0051   144 ;
                                     0051   145 ;	THIS ROUTINE DEALLOCATES THE INDICATED BLOCK OF MEMORY BACK
                                     0051   146 ;	TO THE SYSTEM POOL OF NON-PAGED DYNAMIC MEMORY.
                                     0051   147 ;
                                     0051   148 ; CALLING SEQUENCE:
                                     0051   149 ;	CALL	DEALLOCATE (ARG1)
                                     0051   150 ;
                                     0051   151 ; INPUT PARAMETERS:
                                     0051   152 ;	ARG1: ADDRESS OF BLOCK BEING DEALLOCATED
                                     0051   153 ;
                                     0051   154 ; IMPLICIT INPUTS:
                                     0051   155 ;	NONE
                                     0051   156 ;
                                     0051   157 ; OUTPUT PARAMETERS:
                                     0051   158 ;	NONE
                                     0051   159 ;
                                     0051   160 ; IMPLICIT OUTPUTS:
                                     0051   161 ;	NONE
                                     0051   162 ;
                                     0051   163 ; ROUTINE VALUE:
                                     0051   164 ;	NONE
                                     0051   165 ;
                                     0051   166 ; SIDE EFFECTS:
                                     0051   167 ;	BLOCK DEALLOCATED
                                     0051   168 ;
                                     0051   169 ;--
                                     0051   170 
                                     0051   171 DEALLOCATE::
                               003C  0051   172 	.WORD	^M<R2,R3,R4,R5>		; SAVE REGISTERS
            50         04 AC     D0  0053   173 	MOVL	ADDRESS(AP),R0		; GET ADDRESS OF BLOCK
            51         08 A0     3C  0057   174 	MOVZWL	WCB$W_SIZE(R0),R1	; GET BLOCK SIZE
                                     005B   175 	DSBINT	#IPL$_SYNCH,R2		; RAISE IPL TO SYNCHRONIZE
                 00000000'9F     16  0061   176 	JSB	@#EXE$DEANONPAGED	; AND DEALLOCATE THRU EXEC
                                     0067   177 	ENBINT	#0			; RESTORE IPL
                                 04  006A   178 	RET
                                     006B   179 
                                     006B   180 
                                     006B   181 
                                     006B   182 	.END
ALLOCB          - ALLOCATE DYNAMIC MEMORY                        21-AUG-1978 22:46:28   VAX-11 MACRO X0.3-11               Page   6
SYMBOL TABLE                                                                                                                     (3)

ADDRESS        = 00000004            IPL$_POWER     = 0000001F            TYPE           = 00000008            
ALLOCATE         00000008 RG    03   IPL$_QUEUEAST  = 00000006            VCB_TYPE       = 00000002            
AQB_TYPE       = 00000005            IPL$_SCHED     = 00000003            WCB$B_ACCESS     0000000B            
BIT...         = 0000000C            IPL$_SYNCH     = 00000007            WCB$B_TYPE       0000000A            
BITMAP_TYPE    = 00000001            IPL$_TIMER     = 00000007            WCB$C_LENGTH     00000024            
BLOCK_TYPE       00000000 R     03   MVL_TYPE       = 00000004            WCB$C_MAP        00000024            
BYTES          = 00000004            PR$_ACCR       = 00000029            WCB$K_LENGTH     00000024            
DEALLOCATE       00000051 RG    03   PR$_ACCS       = 00000028            WCB$K_MAP        00000024            
DIRECTORY_TYPE = 00000002            PR$_ASTLVL     = 00000013            WCB$L_FCB        00000018            
DYN$C_ACB      = 00000002  G         PR$_ESP        = 00000001            WCB$L_LBN        00000002            
DYN$C_ADP      = 00000001  G         PR$_ICCS       = 00000018            WCB$L_ORGUCB     00000010            
DYN$C_AQB      = 00000003  G         PR$_ICR        = 0000001A            WCB$L_P1_LBN     00000026            
DYN$C_BRDCST   = 0000001A  G         PR$_IPL        = 00000012            WCB$L_P2_LBN     0000002C            
DYN$C_BUFIO    = 00000013  G         PR$_ISP        = 00000004            WCB$L_PID        0000000C            
DYN$C_CEB      = 00000004  G         PR$_KSP        = 00000000            WCB$L_PREVLBN    FFFFFFFC            
DYN$C_CRB      = 00000005  G         PR$_MAPEN      = 00000038            WCB$L_RVT        0000001C            
DYN$C_CXB      = 0000001B  G         PR$_NICR       = 00000019            WCB$L_STVBN      00000020            
DYN$C_DDB      = 00000006  G         PR$_P0BR       = 00000008            WCB$L_WLBL       00000004            
DYN$C_DPT      = 0000001E  G         PR$_P0LR       = 00000009            WCB$L_WLFL       00000000            
DYN$C_FCB      = 00000007  G         PR$_P1BR       = 0000000A            WCB$M_NOTFCP   = 00000004            
DYN$C_FRK      = 00000008  G         PR$_P1LR       = 0000000B            WCB$M_READ     = 00000001            
DYN$C_GSD      = 00000015  G         PR$_PCBB       = 00000010            WCB$M_SHRWCB   = 00000008            
DYN$C_IDB      = 00000009  G         PR$_PME        = 0000003D            WCB$M_WRITE    = 00000002            
DYN$C_IRP      = 0000000A  G         PR$_RXCS       = 00000020            WCB$V_DLOCK    = 00000001            
DYN$C_JPB      = 0000001F  G         PR$_RXDB       = 00000021            WCB$V_NOREAD   = 0000000A            
DYN$C_KFH      = 00000026  G         PR$_SBIER      = 00000034            WCB$V_NOTFCP   = 00000002            
DYN$C_KFI      = 00000018  G         PR$_SBIFS      = 00000030            WCB$V_NOTRUNC  = 0000000B            
DYN$C_LOG      = 0000000B  G         PR$_SBIMT      = 00000033            WCB$V_NOWRITE  = 00000000            
DYN$C_MTL      = 00000019  G         PR$_SBIQC      = 00000036            WCB$V_READ     = 00000000            
DYN$C_MVL      = 00000016  G         PR$_SBIS       = 00000031            WCB$V_READCK   = 00000009            
DYN$C_NDB      = 0000001C  G         PR$_SBISC      = 00000032            WCB$V_SEQONLY  = 00000006            
DYN$C_NET      = 00000017  G         PR$_SBITA      = 00000035            WCB$V_SHRWCB   = 00000003            
DYN$C_PBH      = 00000020  G         PR$_SBR        = 0000000C            WCB$V_SPOOL    = 00000004            
DYN$C_PCB      = 0000000C  G         PR$_SCBB       = 00000011            WCB$V_WRITE    = 00000001            
DYN$C_PDB      = 00000021  G         PR$_SID        = 0000003E            WCB$V_WRITEAC  = 00000008            
DYN$C_PFL      = 00000023  G         PR$_SIRR       = 00000014            WCB$V_WRITECK  = 00000005            
DYN$C_PIB      = 00000022  G         PR$_SISR       = 00000015            WCB$W_ACON       00000014            
DYN$C_PQB      = 0000000D  G         PR$_SLR        = 0000000D            WCB$W_COUNT      00000000            
DYN$C_PTR      = 00000025  G         PR$_SSP        = 00000002            WCB$W_NMAP       00000016            
DYN$C_RVT      = 0000000E  G         PR$_TBIA       = 00000039            WCB$W_P1_COUNT   00000024            
DYN$C_SFT      = 00000024  G         PR$_TBIS       = 0000003A            WCB$W_P2_COUNT   0000002A            
DYN$C_SSB      = 0000001D  G         PR$_TODR       = 0000001B            WCB$W_PREVCOUNT  FFFFFFFA            
DYN$C_TQE      = 0000000F  G         PR$_TXCS       = 00000022            WCB$W_REFCNT     0000000E            
DYN$C_TYPAHD   = 00000014  G         PR$_TXDB       = 00000023            WCB$W_SIZE       00000008            
DYN$C_UCB      = 00000010  G         PR$_USP        = 00000003            WCB_TYPE       = 00000001            
DYN$C_VCB      = 00000011  G         PR$_WCSA       = 0000002C            
DYN$C_WCB      = 00000012  G         PR$_WCSD       = 0000002D            
EXE$ALONONPAGED  ********   X   03   RSN$_ASTWAIT   = 00000001            
EXE$DEANONPAGED  ********   X   03   RSN$_BRKTHRU   = 00000006            
FCB_TYPE       = 00000000            RSN$_IACLOCK   = 00000007            
GBL...         = 00000000            RSN$_MAILBOX   = 00000002            
HEADER_TYPE    = 00000000            RSN$_NPDYNMEM  = 00000003            
INDEX_TYPE     = 00000003            RSN$_PGDYNMEM  = 00000005            
IPL$_ASTDEL    = 00000002            RSN$_PGFILE    = 00000004            
IPL$_HWCLK     = 00000018            RVT_TYPE       = 00000003            
IPL$_IOPOST    = 00000004            SCH$GL_CURPCB    ********   X   03   
IPL$_MAILBOX   = 0000000B            SCH$RWAIT        ********   X   03   
ALLOCB          - ALLOCATE DYNAMIC MEMORY                        21-AUG-1978 22:46:28   VAX-11 MACRO X0.3-11               Page   7
PROGRAM SECTION SYNOPSIS                                                                                                         (3)



PROGRAM SECTION SYNOPSIS

.  ABS  .        00000000      00     NOPIC   USR   CON   ABS   LCL NOSHR NOEXE NORD  NOWRT BYTE  
. BLANK .        00000000      01     NOPIC   USR   CON   REL   LCL NOSHR   EXE   RD    WRT BYTE  
$ABS$            FFFFFFFC      02     NOPIC   USR   CON   ABS   LCL NOSHR   EXE   RD    WRT BYTE  
$LOCKEDC1$       0000006B      03     NOPIC   USR   CON   REL   LCL NOSHR   EXE   RD  NOWRT LONG  


THERE WERE NO ERRORS OR WARNINGS.
21862. BYTES LEFT IN FREE MEMORY POOL.
1000. BYTES OF RECLAIMED MEMORY.
OBJ$:ALLOCB,LIS$:ALLOCB/-SP=EXECML$/ML,SRC$:FCPDEF,ALLOCB
2 MLB DIR RDS - 310 GETS TO DEFINE 16 MACROS. 18 INTER. FILE WRITES. 
