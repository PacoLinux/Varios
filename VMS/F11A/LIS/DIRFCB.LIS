
; Bliss-32 10.1-416	Monday 21-AUG-1978 22:54:20	DBB3:[F11A.SRC]DIRFCB.B32;7					Page 1
;
;	0001	MODULE DIRFCB (
;	0002			LANGUAGE (BLISS32),
;	0003			IDENT = 'A0002'
;	0004			) =
;	0005	BEGIN
;	0006	
;	0007	!
;	0008	! Copyright (c) 1977
;	0009	! Digital Equipment Corporation, Maynard, Massachusetts 01754
;	0010	!
;	0011	! This software is furnished  under a license for use only on a single
;	0012	! computer  system and  may be  copied only with  the inclusion of the
;	0013	! above copyright notice.  This software, or any other copies thereof,
;	0014	! may not be provided or  otherwise made available to any other person
;	0015	! except for use on such system and to one who agrees to these license
;	0016	! terms.  Title to and  ownership of the  software  shall at all times
;	0017	! remain in DEC.
;	0018	!
;	0019	! The information in this software is subject to change without notice
;	0020	! and should  not be construed  as a commitment  by Digital  Equipment
;	0021	! Corporation.
;	0022	!
;	0023	! DEC assumes  no  responsibility  for  the use or  reliability of its
;	0024	! software on equipment which is not supplied by DEC.
;	0025	
;	0026	!++
;	0027	!
;	0028	! FACILITY:  F11ACP Structure Level 1
;	0029	!
;	0030	! ABSTRACT:
;	0031	!
;	0032	!	This routine makes the necessary adjustments to the FCP data
;	0033	!	base to make an FCB useful for directory operations.
;	0034	! ENVIRONMENT:
;	0035	!
;	0036	!	STARLET operating system, including privileged system services
;	0037	!	and internal exec routines. This routine must be called
;	0038	!	in kernel mode.
;	0039	!
;	0040	!--
;	0041	!
;	0042	!
;	0043	! AUTHOR:  Andrew C. Goldstein,	 CREATION DATE:  2-Jan-1977  23:37
;	0044	!
;	0045	! REVISION HISTORY:
;	0046	!
;	0047	!   Andrew C. Goldstein, 4-Nov-1977  14:56
;	0048	!   X0002 - Remove EOF setup (done in INIFCB)
;	0049	!
;	0050	!**
;	0051	
;	0052	
;	0053	LIBRARY 'SYS$LIBRARY:LIB.L32';
;	0054	REQUIRE 'SRC$:FCPDEF.B32';

; Bliss-32 10.1-416	Monday 21-AUG-1978 22:54:20	DBB3:[F11A.SRC]DIRFCB.B32;7					Page 2
;
;	0373	GLOBAL ROUTINE MAKE_DIR_FCB (FCB) : NOVALUE =
;	0374	
;	0375	!++
;	0376	!
;	0377	! FUNCTIONAL DESCRIPTION:
;	0378	!
;	0379	!	This routine makes the necessary adjustments to the FCP data
;	0380	!	base to make an FCB useful for directory operations.
;	0381	!
;	0382	! CALLING SEQUENCE:
;	0383	!	MAKE_DIR_FCB (ARG1)
;	0384	!
;	0385	! INPUT PARAMETERS:
;	0386	!	ARG1: address of FCB
;	0387	!
;	0388	! IMPLICIT INPUTS:
;	0389	!	CURRENT_VCB: address of VCB of volume in process
;	0390	!
;	0391	! OUTPUT PARAMETERS:
;	0392	!	NONE
;	0393	!
;	0394	! IMPLICIT OUTPUTS:
;	0395	!	NONE
;	0396	!
;	0397	! ROUTINE VALUE:
;	0398	!	NONE
;	0399	!
;	0400	! SIDE EFFECTS:
;	0401	!	FCB may be linked into FCB list
;	0402	!	oldest FCB LRU entry may be gone
;	0403	!
;	0404	!--
;	0405	
;	0406	BEGIN
;	0407	
;	0408	MAP
;	0409		FCB		: REF BBLOCK;	! FCB argument
;	0410	
;	0411	LOCAL
;	0412		DUMMY,				! dummy destination for REMQUE
;	0413		P		: REF BBLOCK;	! random pointer
;	0414	
;	0415	EXTERNAL
;	0416		CURRENT_VCB	: REF BBLOCK;	! volume VCB
;	0417	
;	0418	EXTERNAL ROUTINE
;	0419		DEALLOCATE;			! deallocate block
;	0420	
;	0421	
;	0422	! If the FCB represents a contiguous file, and it is not accessed,
;	0423	! hook it into the directory LRU list, if it is not already there.
;	0424	!
;	0425	
;	0426	IF .FCB[FCB$L_STLBN] NEQ 0
;	0427	AND .FCB[FCB$W_ACNT] EQL 0

; Bliss-32 10.1-416	Monday 21-AUG-1978 22:54:20	DBB3:[F11A.SRC]DIRFCB.B32;7					Page 2-1
;
;	0428	AND .CURRENT_VCB[VCB$B_LRU_LIM] GEQ 0
;	0429	THEN
;	0430	    BEGIN
;	0431	    IF NOT .FCB[FCB$V_DIR]
;	0432	    THEN
;	0433		BEGIN
;	0434		CURRENT_VCB[VCB$B_LRU_LIM] = .CURRENT_VCB[VCB$B_LRU_LIM] - 1;
;	0435	
;	0436	! If we just overflowed the LRU, search the FCB list for the first
;	0437	! (and therefore oldest) directory FCB and dump it.
;	0438	!
;	0439	
;	0440		IF .CURRENT_VCB[VCB$B_LRU_LIM] LSS 0
;	0441		THEN
;	0442		    BEGIN
;	0443		    P = .CURRENT_VCB[VCB$L_FCBFL];
;	0444		    IF NOT
;	0445			(
;	0446			WHILE .P NEQ .CURRENT_VCB DO
;	0447			    BEGIN
;	0448			    IF .P[FCB$V_DIR] THEN EXITLOOP 0;
;	0449			    P = .P[FCB$L_FCBFL];
;	0450			    END
;	0451			)
;	0452		    THEN			! FCB found
;	0453			BEGIN
;	0454			REMQUE (.P, DUMMY);	! remove FCB from list
;	0455			DEALLOCATE (.P);	! deallocate the block
;	0456			CURRENT_VCB[VCB$B_LRU_LIM] = .CURRENT_VCB[VCB$B_LRU_LIM] + 1;
;	0457			END
;	0458		    ELSE			! FCB not found - LRU not in use
;	0459			CURRENT_VCB[VCB$B_LRU_LIM] = -1;
;	0460		    END;
;	0461	
;	0462	! If the LRU is not disabled (now indicated by a negative count value),
;	0463	! insert the FCB into the list and mark it as a directory FCB.
;	0464	!
;	0465	
;	0466		IF .CURRENT_VCB[VCB$B_LRU_LIM] GEQ 0
;	0467		THEN
;	0468		    BEGIN
;	0469		    FCB[FCB$V_DIR] = 1;
;	0470		    INSQUE (.FCB, .CURRENT_VCB[VCB$L_FCBBL]);
;	0471		    END;
;	0472	
;	0473	! If the FCB was already in the LRU, move it to the end of the FCB list
;	0474	! to indicate its new use.
;	0475	!
;	0476	
;	0477		END
;	0478	    ELSE
;	0479		BEGIN
;	0480		REMQUE (.FCB, DUMMY);
;	0481		INSQUE (.FCB, .CURRENT_VCB[VCB$L_FCBBL]);
;	0482		END;

; Bliss-32 10.1-416	Monday 21-AUG-1978 22:54:20	DBB3:[F11A.SRC]DIRFCB.B32;7					Page 2-2
;
;	0483	    END;
;	0484	
;	0485	END;					! end of routine MAKE_DIR_ACCESS


							    .TITLE  DIRFCB
							    .IDENT  \A0002\

							    .EXTRN  CURRENT_VCB, DEALLOCATE

							    .PSECT  $CODE$,NOWRT,2

					 000C 00000 	    .ENTRY  MAKE_DIR_FCB, Save R2,R3				      ; 0373
		         53 	0000G  CF  9E 00002 	    MOVAB   CURRENT_VCB, R3					      ;
		         51 	  04   AC  D0 00007 	    MOVL    FCB, R1						      ; 0426
				  2C   A1  D5 0000B 	    TSTL    44(R1)						      ;
				       60  13 0000E 	    BEQL    6$							      ;
				  18   A1  B5 00010 	    TSTW    24(R1)						      ; 0427
				       5B  12 00013 	    BNEQ    6$							      ;
		         50 	       63  D0 00015 	    MOVL    CURRENT_VCB, R0					      ; 0428
				  49   A0  95 00018 	    TSTB    73(R0)						      ;
				       53  19 0001B 	    BLSS    6$							      ;
		         44 	  1E   A1  E8 0001D 	    BLBS    30(R1), 5$						      ; 0431
		         50 	       63  D0 00021 	    MOVL    CURRENT_VCB, R0					      ; 0434
				  49   A0  97 00024 	    DECB    73(R0)						      ;
				       27  18 00027 	    BGEQ    4$							      ; 0440
		         51 	       60  D0 00029 	    MOVL    (R0), P						      ; 0443
		         50 	       51  D1 0002C 1$:     CMPL    P, R0						      ; 0446
				       1B  13 0002F 	    BEQL    3$							      ;
		         05 	  1E   A1  E8 00031 	    BLBS    30(P), 2$						      ; 0448
		         51 	       61  D0 00035 	    MOVL    (P), P						      ; 0449
				       F2  11 00038 	    BRB     1$							      ; 0446
		         52 	       61  0F 0003A 2$:     REMQUE  (P), DUMMY						      ; 0454
				       51  DD 0003D 	    PUSHL   P							      ; 0455
		  0000G  CF	       01  FB 0003F 	    CALLS   #1, DEALLOCATE					      ;
		         50 	       63  D0 00044 	    MOVL    CURRENT_VCB, R0					      ; 0456
				  49   A0  96 00047 	    INCB    73(R0)						      ;
				       04  11 0004A 	    BRB     4$							      ; 0444
		    49   A0	       01  8E 0004C 3$:     MNEGB   #1, 73(R0)						      ; 0459
		         50 	       63  D0 00050 4$:     MOVL    CURRENT_VCB, R0					      ; 0466
				  49   A0  95 00053 	    TSTB    73(R0)						      ;
				       18  19 00056 	    BLSS    6$							      ;
		         51 	  04   AC  D0 00058 	    MOVL    FCB, R1						      ; 0469
		    1E   A1	       01  88 0005C 	    BISB2   #1, 30(R1)						      ;
		    04   B0	       61  0E 00060 	    INSQUE  (R1), @4(R0)					      ; 0470
					   04 00064 	    RET     							      ; 0431
		         52 	       61  0F 00065 5$:     REMQUE  (R1), DUMMY						      ; 0480
		         50 	       63  D0 00068 	    MOVL    CURRENT_VCB, R0					      ; 0481
		    04   B0	  04   BC  0E 0006B 	    INSQUE  @FCB, @4(R0)					      ;
					   04 00070 6$:     RET     							      ; 0373

; Routine Size:  113 bytes


;	0486	

; Bliss-32 10.1-416	Monday 21-AUG-1978 22:54:20	DBB3:[F11A.SRC]DIRFCB.B32;7					Page 2-3
;
;	0487	END
;	0488	ELUDOM






;				       PSECT SUMMARY
;
;	Name		 Bytes			       Attributes
;
;  $CODE$         	   113  NOWRT,  RD ,  EXE,NOSHR,  LCL,  REL,  CON,NOPIC,ALIGN(2)




;				LIBRARY STATISTICS
;
;					     -------- Symbols --------    Blocks
;	File				     Total    Loaded   Percent      Read
;
;  DBA4:[SYSLIB]LIB.L32;1		      5582         8         0       229





; Size:		113 code + 0 data bytes
; Run Time:	00:05.7
; Elapsed Time:	00:15.3
; Memory Used:	272 pages
; Compilation Complete
