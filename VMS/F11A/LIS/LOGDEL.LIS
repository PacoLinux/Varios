
; Bliss-32 10.1-416	Monday 21-AUG-1978 22:59:25	DBB3:[F11A.SRC]LOGDEL.B32;3					Page 1
;
;	0001	MODULE LOGDEL (
;	0002			LANGUAGE (BLISS32),
;	0003			IDENT = 'A0001'
;	0004			) =
;	0005	BEGIN
;	0006	
;	0007	!
;	0008	! Copyright (c) 1977
;	0009	! Digital Equipment Corporation, Maynard, Massachusetts 01754
;	0010	!
;	0011	! This software is furnished  under a license for use only on a single
;	0012	! computer  system and  may be  copied only with  the inclusion of the
;	0013	! above copyright notice.  This software, or any other copies thereof,
;	0014	! may not be provided or  otherwise made available to any other person
;	0015	! except for use on such system and to one who agrees to these license
;	0016	! terms.  Title to and  ownership of the  software  shall at all times
;	0017	! remain in DEC.
;	0018	!
;	0019	! The information in this software is subject to change without notice
;	0020	! and should  not be construed  as a commitment  by Digital  Equipment
;	0021	! Corporation.
;	0022	!
;	0023	! DEC assumes  no  responsibility  for  the use or  reliability of its
;	0024	! software on equipment which is not supplied by DEC.
;	0025	
;	0026	!++
;	0027	!
;	0028	! FACILITY:  F11ACP Structure Level 1
;	0029	!
;	0030	! ABSTRACT:
;	0031	!
;	0032	!	This routine sends a message to log each delete operation that takes
;	0033	!	place.
;	0034	!
;	0035	! ENVIRONMENT:
;	0036	!
;	0037	!	STARLET operating system, including privileged system services
;	0038	!	and internal exec routines.
;	0039	!
;	0040	!--
;	0041	!
;	0042	!
;	0043	! AUTHOR:  Andrew C. Goldstein,	 CREATION DATE:  21-Jul-1978  13:10
;	0044	!
;	0045	! REVISION HISTORY:
;	0046	!
;	0047	!**
;	0048	
;	0049	
;	0050	LIBRARY 'SYS$LIBRARY:LIB.L32';
;	0051	REQUIRE 'SRC$:FCPDEF.B32';

; Bliss-32 10.1-416	Monday 21-AUG-1978 22:59:25	DBB3:[F11A.SRC]LOGDEL.B32;3					Page 2
;
;	0370	!+
;	0371	!
;	0372	! Format of message to the delete logger
;	0373	!
;	0374	!-
;	0375	
;	0376	MACRO
;	0377		MSG_TIME	= 00, 0, 0, 0%,	! time of day (8 bytes)
;	0378		MSG_DEVNAME	= 08, 0,32, 0%,	! device name (counted ascii)
;	0379		MSG_UNIT	= 12, 0,16, 0%,	! unit number
;	0380		MSG_DID		= 14, 0, 0, 0%,	! directory ID (6 bytes)
;	0381		MSG_FILENAME	= 20, 0, 0, 0%,	! file name (20 bytes)
;	0382		MSG_OWNER	= 40, 0,32, 0%,	! file owner UIC
;	0383		MSG_PROCNAME	= 44, 0, 0, 0%,	! process name (16 bytes)
;	0384		MSG_UIC		= 60, 0,32, 0%;	! process UIC
;	0385	
;	0386	LITERAL
;	0387		MESSAGE_LENGTH	= 64;		! length of message

; Bliss-32 10.1-416	Monday 21-AUG-1978 22:59:25	DBB3:[F11A.SRC]LOGDEL.B32;3					Page 3
;
;	0388	GLOBAL ROUTINE LOG_DELETE (FIB, HEADER) : NOVALUE =
;	0389	
;	0390	!++
;	0391	!
;	0392	! FUNCTIONAL DESCRIPTION:
;	0393	!
;	0394	!	This routine sends a message to log each delete operation that takes
;	0395	!	place.
;	0396	!
;	0397	!
;	0398	! CALLING SEQUENCE:
;	0399	!	LOG_DELETE (ARG1, ARG2)
;	0400	!
;	0401	! INPUT PARAMETERS:
;	0402	!	ARG1: address of user FIB
;	0403	!	ARG2: address of file header
;	0404	!
;	0405	! IMPLICIT INPUTS:
;	0406	!	IO_PACKET: address of I/O request packet
;	0407	!
;	0408	! OUTPUT PARAMETERS:
;	0409	!	NONE
;	0410	!
;	0411	! IMPLICIT OUTPUTS:
;	0412	!	NONE
;	0413	!
;	0414	! ROUTINE VALUE:
;	0415	!	NONE
;	0416	!
;	0417	! SIDE EFFECTS:
;	0418	!	message sent to delete logger mailbox
;	0419	!
;	0420	!--
;	0421	
;	0422	BEGIN
;	0423	
;	0424	MAP
;	0425		FIB		: REF BBLOCK,	! user FIB
;	0426		HEADER		: REF BBLOCK;	! file header arg
;	0427	
;	0428	LOCAL
;	0429		MESSAGE		: BBLOCK [MESSAGE_LENGTH], ! message buffer
;	0430		IDENT_AREA	: REF BBLOCK,	! address of header ident area
;	0431		PCB		: REF BBLOCK,	! address of caller PCB
;	0432		CHANNEL		: WORD;		! channel assigned to mailbox
;	0433	
;	0434	EXTERNAL
;	0435		IO_PACKET	: REF BBLOCK,	! address of I/O packet
;	0436		CURRENT_UCB	: REF BBLOCK,	! address of device UCB
;	0437		SCH$GL_PCBVEC	: REF VECTOR ADDRESSING_MODE (ABSOLUTE);
;	0438						! system PCB vector
;	0439	
;	0440	EXTERNAL ROUTINE
;	0441		MAKE_STRING;			! make string from RAD-50 file name
;	0442	

; Bliss-32 10.1-416	Monday 21-AUG-1978 22:59:25	DBB3:[F11A.SRC]LOGDEL.B32;3					Page 3-1
;
;	0443	
;	0444	! Assign a channel to the mailbox. If the assignment fails, the logger is not
;	0445	! running. Then build the message and send it.
;	0446	!
;	0447	
;	0448	IF NOT $ASSIGN (CHAN = CHANNEL, DEVNAM = DESCRIPTOR ('ACP$DELLOG_MBX'))
;	0449	THEN RETURN;
;	0450	
;	0451	$GETTIM (TIMADR = MESSAGE[MSG_TIME]);	! time of day
;	0452	MESSAGE[MSG_DEVNAME]	= .(BBLOCK [.CURRENT_UCB[UCB$L_DDB], DDB$T_NAME])<0,32>;
;	0453	MESSAGE[MSG_UNIT]	= .CURRENT_UCB[UCB$W_UNIT];
;	0454	CH$MOVE (FIB$S_DID, FIB[FIB$W_DID], MESSAGE[MSG_DID]);
;	0455	IDENT_AREA = .HEADER + .HEADER[FH1$B_IDOFFSET]*2;
;	0456	CH$FILL (' ', 20, MESSAGE[MSG_FILENAME]);
;	0457	MAKE_STRING (IDENT_AREA[FI1$W_FILENAME]-6, MESSAGE[MSG_FILENAME]);
;	0458	MESSAGE[MSG_OWNER]	= .(HEADER[FH1$W_FILEOWNER])<0,8>;
;	0459	(MESSAGE[MSG_OWNER])<16,8>= .(HEADER[FH1$W_FILEOWNER])<8,8>;
;	0460	PCB = .SCH$GL_PCBVEC[.(IO_PACKET[IRP$L_PID])<0,16>];
;	0461	CH$MOVE (PCB$S_LNAME, PCB[PCB$T_LNAME], MESSAGE[MSG_PROCNAME]);
;	0462	MESSAGE[MSG_UIC]	= .PCB[PCB$L_UIC];
;	0463	
;	0464	$QIOW (
;     P 0465		CHAN = .CHANNEL,
;     P 0466		FUNC = IO$_WRITEVBLK OR IO$M_NOW,
;     P 0467		P1   = MESSAGE,
;     P 0468		P2   = MESSAGE_LENGTH
;     P 0469		);
;	0470	
;	0471	$DASSGN (CHAN = .CHANNEL);
;	0472	
;	0473	END;					! end of routine LOG_DELETE


							    .TITLE  LOGDEL
							    .IDENT  \A0001\

							    .PSECT  $CODE$,NOWRT,2

  5F  47  4F  4C  4C  45  44  24  50  43  41  00000 P.AAB:  .ASCII  \ACP$DELLOG_MBX\					      ;
				  58  42  4D  0000B									      ;
					      0000E	    .BLKB   2
				    0000000E  00010 P.AAA:  .LONG   14							      ;
				    00000000' 00014 	    .ADDRESS P.AAB						      ;

							    .EXTRN  IO_PACKET, CURRENT_UCB, SCH$GL_PCBVEC, MAKE_STRING
							    .EXTRN  SYS$ASSIGN, SYS$GETTIM, SYS$QIOW, SYS$DASSGN

					 00FC 00018 	    .ENTRY  LOG_DELETE, Save R2,R3,R4,R5,R6,R7			      ; 0388
		         5E 	  BC   AE  9E 0001A 	    MOVAB   -68(SP), SP						      ;
				       7E  7C 0001E 	    CLRQ    -(SP)						      ; 0448
				  08   AE  9F 00020 	    PUSHAB  CHANNEL						      ;
				  EA   AF  9F 00023 	    PUSHAB  P.AAA						      ;
	      00000000G  9F	       04  FB 00026 	    CALLS   #4, @#SYS$ASSIGN					      ;
		         01 	       50  E8 0002D 	    BLBS    R0, 1$						      ;
					   04 00030 	    RET     							      ;

; Bliss-32 10.1-416	Monday 21-AUG-1978 22:59:25	DBB3:[F11A.SRC]LOGDEL.B32;3					Page 3-2
;
				  04   AE  9F 00031 1$:     PUSHAB  MESSAGE						      ; 0451
	      00000000G  9F	       01  FB 00034 	    CALLS   #1, @#SYS$GETTIM					      ;
		         51 	0000G  CF  D0 0003B 	    MOVL    CURRENT_UCB, R1					      ; 0452
		         50 	  24   A1  D0 00040 	    MOVL    36(R1), R0						      ;
		    0C   AE	  14   A0  D0 00044 	    MOVL    20(R0), MESSAGE+8					      ;
		    10   AE	  48   A1  B0 00049 	    MOVW    72(R1), MESSAGE+12					      ; 0453
		         50 	  04   AC  D0 0004E 	    MOVL    FIB, R0						      ; 0454
      12   AE	    0A   A0	       06  28 00052 	    MOVC3   #6, 10(R0), MESSAGE+14				      ;
		         56 	  08   AC  D0 00058 	    MOVL    HEADER, R6						      ; 0455
		         50 	       66  9A 0005C 	    MOVZBL  (R6), R0						      ;
		         57 	     6640  3E 0005F 	    MOVAW   (R6)[R0], IDENT_AREA				      ;
	   20 	         6E 	       00  2C 00063 	    MOVC5   #0, (SP), #32, #20, MESSAGE+20			      ; 0456
		    18   AE	       14     00067									      ;
				  18   AE  9F 0006A 	    PUSHAB  MESSAGE+20						      ; 0457
				  FA   A7  9F 0006D 	    PUSHAB  -6(IDENT_AREA)					      ;
		  0000G  CF	       02  FB 00070 	    CALLS   #2, MAKE_STRING					      ;
		    2C   AE	  08   A6  9A 00075 	    MOVZBL  8(R6), MESSAGE+40					      ; 0458
		    2E   AE	  09   A6  90 0007A 	    MOVB    9(R6), MESSAGE+42					      ; 0459
		         51 00000000G  9F  D0 0007F 	    MOVL    @#SCH$GL_PCBVEC, R1					      ; 0460
		         50 	0000G  CF  D0 00086 	    MOVL    IO_PACKET, R0					      ;
		         50 	  0C   A0  3C 0008B 	    MOVZWL  12(R0), R0						      ;
		         56 	     6140  D0 0008F 	    MOVL    (R1)[R0], PCB					      ;
      30   AE	    6C   A6	       10  28 00093 	    MOVC3   #16, 108(PCB), MESSAGE+44				      ; 0461
		    40   AE	  20   A6  D0 00099 	    MOVL    32(PCB), MESSAGE+60					      ; 0462
				       7E  7C 0009E 	    CLRQ    -(SP)						      ; 0469
				       7E  7C 000A0 	    CLRQ    -(SP)						      ;
		         7E 	  40   8F  9A 000A2 	    MOVZBL  #64, -(SP)						      ;
				  18   AE  9F 000A6 	    PUSHAB  MESSAGE						      ;
				       7E  7C 000A9 	    CLRQ    -(SP)						      ;
				       7E  D4 000AB 	    CLRL    -(SP)						      ;
		         7E 	  70   8F  9A 000AD 	    MOVZBL  #112, -(SP)						      ;
		         7E 	  28   AE  3C 000B1 	    MOVZWL  CHANNEL, -(SP)					      ;
				       7E  D4 000B5 	    CLRL    -(SP)						      ;
	      00000000G  9F	       0C  FB 000B7 	    CALLS   #12, @#SYS$QIOW					      ;
		         7E 	       6E  3C 000BE 	    MOVZWL  CHANNEL, -(SP)					      ; 0471
	      00000000G  9F	       01  FB 000C1 	    CALLS   #1, @#SYS$DASSGN					      ;
					   04 000C8 2$:     RET     							      ; 0388

; Routine Size:  177 bytes


;	0474	
;	0475	END
;	0476	ELUDOM






;				       PSECT SUMMARY
;
;	Name		 Bytes			       Attributes
;
;  $CODE$         	   201  NOWRT,  RD ,  EXE,NOSHR,  LCL,  REL,  CON,NOPIC,ALIGN(2)

; Bliss-32 10.1-416	Monday 21-AUG-1978 22:59:25	DBB3:[F11A.SRC]LOGDEL.B32;3					Page 3-3
;




;				LIBRARY STATISTICS
;
;					     -------- Symbols --------    Blocks
;	File				     Total    Loaded   Percent      Read
;
;  DBA4:[SYSLIB]LIB.L32;1		      5582        19         0       238





; Size:		177 code + 24 data bytes
; Run Time:	00:06.0
; Elapsed Time:	00:15.0
; Memory Used:	294 pages
; Compilation Complete
