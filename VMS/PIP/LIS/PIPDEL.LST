PIPDEL M0215, DELETE AND REMOVE	MACRO M1110  22-AUG-78 01:32
TABLE OF CONTENTS

     7-    1	**** PIPDEL VERSION M0215 ****
PIPDEL M0215, DELETE AND REMOVE	MACRO M1110  22-AUG-78 01:32  PAGE 7


      1						.TITLE	PIPDEL M0215, DELETE AND REMOVE COMMANDS-PIP
						.SBTTL	**** PIPDEL VERSION M0215 ****
						.IDENT	/M0215/
      2					; ALTERED:
      3					; ANDREW C. GOLDSTEIN  2-AUG-78  14:16
      4					; BENN L. SCHREIBER 29-MAR-77
      5					;
      6					; B. SCHREIBER	27-AUG-77
      7					;
      8					;	BLS025 -- ADD EXIT WITH STATUS
      9					;
     10					; B. SCHREIBER	3-JUN-78
     11					;
     12					;	BLS052 -- INTEGRATE ODS-2 CHANGES DONE BY A. GOLDSTEIN AND
     13					;		E. MARISON
     14					;
     15					; B. SCHREIBER	13-JUL-78
     16					;
     17					;	BLS062 -- CORRECT BEHAVIOR OF /PU IN THE CASE OF
     18					;		"PIP FILE.EXT/PU:2,FILE.EXT"
     19					;
     20					; COPYRIGHT (C) 1978, DIGITAL EQUIPMENT CORP., MAYNARD, MASS.
     21					; COPYRIGHT (C) 1977, DIGITAL EQUIPMENT CORP., MAYNARD, MASS.
     22					; COPYRIGHT 1975, DIGITAL EQUIPMENT CORP., MAYNARD MASS.
     23					; COPYRIGHT 1974, DIGITAL EQUIPMENT CORP., MAYNARD MASS.
     24
     25					; THIS SOFTWARE IS FURNISHED TO PURCHASER UNDER A LICENSE FOR USE
     26					; ON A SINGLE COMPUTER SYSTEM AND CAN BE COPIED (WITH INCLUSION
     27					; OF DEC'S COPYRIGHT NOTICE) ONLY FOR USE IN SUCH SYSTEM, EXCEPT
     28					; AS MAY OTHERWISE BE PROVIDED IN WRITING BY DEC.
     29
     30					; THE INFORMATION IN THIS DOCUMENT IS SUBJECT TO CHANGE WITHOUT
     31					; NOTICE AND SHOULD NOT BE CONSTRUED AS A COMMITMENT BY DIGITAL
     32					; EQUIPMENT CORPORATION.
     33
     34					; DEC ASSUMES NO RESPONSIBILITY FOR THE USE OR RELIABILITY
     35					; OF ITS SOFTWARE ON EQUIPMENT WHICH IS NOT SUPPLIED BY DEC.
     36					;
     37					; PETER H. LIPMAN	2-MAY-74
     38
     39	000000					FLDSOF
     40						.MCALL	CALL,RETURN,DELET$
     41
     42	000000					IMPURE									;BLS062
     43															;BLS062
     44	000000				PURSAV:	.BLKW	1		;SAVE /PU IN CASE LATER SPEC NEEDS DEFAULT	;BLS062
     45
     46	000002					PURE.I
     47
     48					; DELETE THE SPECIFIED FILES
     49
     50	000000				REMOVE::
     51	000000				DELETE::CALL	FSTOUT
     52						.IF	DF,R$$VMS
     53	000004	016767 	000000G	000000'		MOV	PURGCT,PURSAV	;SAVE COMMAND PURGE COUNT
     54						.IFF
     55						CLR	PURSAV		;CLEAR SAVED PURGE COUNT			;BLS062
PIPDEL M0215, DELETE AND REMOVE	MACRO M1110  22-AUG-78 01:32  PAGE 7-1
**** PIPDEL VERSION M0215 ****

     56						.ENDC
     57	000012	012700 	000000G		DELET1:	MOV	#FDBOUT,R0
     58	000016					CALL	PARSE
     59	000022	103013 				BCC	10$
     60	000024					CALL	PRSERR		;FAILED TO PARSE FILE NAME
     61					;
     62					; PRIVILEGE VIOLATION FROM PARSE PROBABLY MEANS DEVICE NOT MOUNTED
     63					;
     64	000030	122767 	000000G	000000C		CMPB	#IE.PRI,FDBOUT+F.ERR
     65	000036	001170 				BNE	DELNXT
     66	000040	012767 	000000G	000000G		MOV	#EX$ERR,.EXSTS	;THIS IS REALLY AN ERROR
     67	000046	000167 	000000G			JMP	CLOSX		;EXIT FROM DELETE LOOP IF NOT MOUNTED
     68	000052				10$:										;BLS052
     69						.IF DF	O$$DS2								;BLS052
     70	000052	016167 	000000G	000000G		MOV	N.FVER(R1),VERSAV  ;SAVE ORIGINAL VERSION NUMBER		;BLS052
     71						.ENDC									;BLS052
     72	000060	132760 	000000G	000000G		BITB	#FD.DIR,F.RCTL(R0) ;MUST BE A DIRECTORY DEVICE			;BLS052
     73	000066	001003 				BNE	15$		;BRANCH IF IT IS				;**-1
     74	000070					ERROUX	DI08,1		;ERROR
	000070	104413 				TRAP	X
	000072	000000G				.WORD	DI08SZ
	000074	000000G				.WORD	DI08MG
     75	000076	052767 	000000G	000000G	15$:	BIS	#FRSTIM,CPYCTL
     76	000104	005767 	000000G			TST	PURGCT		; USER SAY /PU:N?
     77	000110	003007 				BGT	16$		; IF GT YES
     78	000112	016767 	000000'	000000G		MOV	PURSAV,PURGCT	; USE DEFAULT FROM LAST FILE SPEC		;BLS062
     79	000120	003003 				BGT	16$		; IF GT OK					;BLS062
     80	000122	012767 	000001 	000000G		MOV	#1,PURGCT	; ELSE DEFAULT TO /PU:1
     81	000130	016767 	000000G	000000'	16$:	MOV	PURGCT,PURSAV	; SET THE SAVED PURGE COUNT			;BLS062
     82	000136	032767 	000000G	000000G		BIT	#RMVBIT,CMDWRD	;SKIP EXPLICIT FILE ID CHECK IF REMOVE		;**-1
     83	000144	001007 				BNE	18$
     84	000146					CALL	USEFID
     85	000152	103404 				BCS	18$		;BRANCH IF NO EXPLICIT FILE ID
     86	000154	042761 	000000G	000000G		BIC	#NB.SFL,N.STAT(R1) ;EXPLICIT FILE ID WAS INPUT
     87	000162	000426 				BR	22$		;JUST DO THE MARK FOR DELETE
     88	000164	032767 	000000G	000000G	18$:	BIT	#PURGBT,CMDWRD	;PURGE MODE FOR THIS FILE?
     89	000172	001123 				BNE	DELPUR		;BRANCH IF YES
     90						.IF NDF	O$$DS2								;BLS052
     91						CALL	WLDVER		;DISALLOW WILD CARDS WITH DEFAULT VER
     92						BCS	DELNXT
     93						.ENDC									;BLS052
     94	000174	032761 	000000C	000000G		BIT	#NB.SVR!NB.VER,N.STAT(R1) ;VERSION MUST BE EXPLICIT
     95	000202	001004 				BNE	20$
     96	000204					ERROUT	DE04,1		;VERSION NO. NOT EXPLICIT OR WILD CARD
	000204	104412 				TRAP	X
	000206	000000G				.WORD	DE04SZ
	000210	000000G				.WORD	DE04MG
     97	000212	000502 				BR	DELNXT
     98	000214				20$:	CALL	RMVNXT		;REMOVE THE FILE FROM THE DIRECTORY
     99	000220	103425 				BCS	30$		;BRANCH IF ERROR
    100	000222	042767 	000000G	000000G		BIC	#FRSTIM,CPYCTL
    101	000230	032767 	000000G	000000G		BIT	#RMVBIT,CMDWRD	;IF REMOVE COMMAND
    102	000236	001012 				BNE	25$		;SKIP THE MARK FOR DELETE
    103	000240	010146 			22$:	MOV	R1,-(SP)
    104	000242	012701 	000000G			MOV	#IO.DEL,R1	;FUNCTION CODE FOR MARK FOR DELETE
    105	000246	012702 	000001 			MOV	#1,R2
    106	000252	010603 				MOV	SP,R3		;1 ADDITIONAL PARAM ON TOP OF STACK
PIPDEL M0215, DELETE AND REMOVE	MACRO M1110  22-AUG-78 01:32  PAGE 7-2
**** PIPDEL VERSION M0215 ****

    107	000254					CALL	.XQIO		;ISSUE THE MARK FOR DELETE AND WAIT
    108	000260	012601 				MOV	(SP)+,R1
    109	000262	103423 				BCS	40$
    110	000264				25$:	CALL	NXTFIL		;ANY MORE FILES IN THIS FILE SPEC?
    111	000270	103351 				BCC	20$		;BRANCH IF YES - DELETING A CLASS
    112	000272	000452 				BR	DELNXT		;DONE WITH THIS SPECIFIER
    113					;
    114					; ERROR FROM REMOVE - NO SUCH FILE WOULD INDICATE DONE
    115	000274				30$:	CALL	RMVERR
    116	000300	116705 	000000C			MOVB	FDBOUT+F.ERR,R5	;R5=ERROR CODE
    117	000304	122705 	000000G			CMPB	#IE.NSF,R5	;IF NO SUCH FILE, THEN GO DO NEXT SPEC
    118	000310	001443 				BEQ	DELNXT
    119	000312	122705 	000000G			CMPB	#IE.WER,R5	; CHECK FOR WRITE ERROR (UNIT WRITE LOCKED)
    120	000316	001040 				BNE	DELNXT		; ANYTHING ELSE, TRY NEXT FILE SPEC
    121	000320	012767 	000000G	000000G		MOV	#EX$ERR,.EXSTS	;WRITE LOCK IS AN ERROR
    122	000326	000167 	000000G			JMP	CLOSX		;TERMINATE THE DELETE OPERATION
    123					;
    124					; FAILED TO MARK FILE FOR DELETION
    125	000332				40$:	ERROUT	DE01,0,0
	000332	104426 				TRAP	X
	000334	000000G				.WORD	DE01SZ
	000336	000000G				.WORD	DE01MG
    126					;
    127					; NOW REENTER THE REMOVED DIRECTORY ENTRY TO FIX THINGS UP
    128	000340	012700 	000000G			MOV	#FDBOUT,R0
    129	000344	016002 	000000G			MOV	F.DSPT(R0),R2
    130	000350	005762 	000016 			TST	N.FLID(R2)
    131	000354	001021 				BNE	DELNXT		;IF EXPLICIT FILE ID, SKIP THIS
    132	000356	012701 	000000C			MOV	#FDBOUT+F.FNB,R1
    133	000362	016146 	000000G			MOV	N.NEXT(R1),-(SP) ;SAVE FIND/REMOVE NEXT POINTER
    134	000366					CALL	.ENTER
    135	000372	012661 	000000G			MOV	(SP)+,N.NEXT(R1)
    136	000376	103332 				BCC	25$		;BRANCH IF REENTER WORKED
    137					;
    138					; NOW WE REALLY HAVE TROUBLE, COULDN'T PUT DIRECTORY ENTRY BACK
    139					; FILE IS LOST, SHOULD AT LEAST TYPE FILE ID - BUT NOT YET DOING SO
    140	000400					ERROUT	DE02,0,0
	000400	104426 				TRAP	X
	000402	000000G				.WORD	DE02SZ
	000404	000000G				.WORD	DE02MG
    141					;
    142					; SET UP TO GO DO THE NEXT FILE
    143	000406	012700 	000000G			MOV	#FDBOUT,R0
    144	000412	012701 	000000C			MOV	#FDBOUT+F.FNB,R1
    145	000416	000722 				BR	25$
    146					; GO GET THE NEXT FILE SPECIFIER IF ANY MORE IN THE LIST
    147	000420	005067 	000000G		DELNXT:	CLR	PURGCT		; RESET TO DEFAULT /PU
    148	000424					CALL	NXTOUT
    149	000430	103402 				BCS	10$
    150	000432	000167 	177354 			JMP	DELET1		;GO DO THE NEXT FILE SPECIFIER
    151	000436	000167 	000000G		10$:	JMP	AGAIN		;NO MORE FILES IN LIST
    152					;
    153					; PURGE MODE FOR THIS FILE SPECIFIER (LOCAL SWITCH)
    154					; DELETE ALL BUT THE MOST RECENT VERSION OF THE SPECIFIED
    155					; FILE(S).  IF THE OPTIONAL VALUE IS SPECIFIED, THEN IF N IS
    156					; THE MOST RECENT VERSION AND M IS THE VALUE, THEN VERSION N-M+1
    157					; THOUGH VERSION N WILL NOT BE DELETED. I.E THE MOST RECENT M
PIPDEL M0215, DELETE AND REMOVE	MACRO M1110  22-AUG-78 01:32  PAGE 7-3
**** PIPDEL VERSION M0215 ****

    158					; VERSIONS WILL NOT BE DELETED WHERE THE VERSIONS ARE ASSUMED
    159					; CONSECUTIVELY NUMBERED
    160	000442	052761 	000000G	000000G	DELPUR:	BIS	#NB.SVR,N.STAT(R1) ;USER NEED NOT TYPE WILD VERSION
    161	000450				10$:	CALL	FNDNXT		;FIND THE NEXT FILE IN THE CLASS
    162	000454	103517 				BCS	80$
    163	000456	042767 	000000G	000000G		BIC	#FRSTIM,CPYCTL
    164	000464	016146 	000000G			MOV	N.NEXT(R1),-(SP) ;SAVE FIND NEXT POINTER
    165	000470	016146 	000000G			MOV	N.STAT(R1),-(SP) ;AND STATUS BITS
    166						.IF DF	O$$DS2								;BLS052
    167	000474	016146 	000000G			MOV	N.FVER(R1),-(SP) ;AND ORIGINAL FILE VERSION			;BLS052
    168						.ENDC									;BLS052
    169	000500	005061 	000000G			CLR	N.NEXT(R1)	;START AT BEGINNING OF DIRECTORY
    170	000504	005061 	000000G			CLR	N.STAT(R1)	;NO WILD CARDS
    171	000510	005061 	000000G			CLR	N.FVER(R1)	;FIND THE MOST RECENT VERSION NO.
    172	000514					CALL	FINDFL
    173	000520	103500 				BCS	85$
    174	000522	016105 	000000G			MOV	N.FVER(R1),R5	;SAVE THE NEWEST VERSION
    175	000526	166705 	000000G			SUB	PURGCT,R5	;R5=HIGHEST DELETABLE VERSION
    176	000532	003453 				BLE	28$		;BRANCH IF NONE TO DELETE IN THIS CLASS
    177	000534	005061 	000000G			CLR	N.NEXT(R1)
    178						.IF DF	O$$DS2								;BLS052
    179	000540	052760 	000000C	000000C	20$:	BIS	#NB.SVR!NB.WLV,F.FNB+N.STAT(R0) ;FIND WILD CARD VERSION		;BLS052
    180	000546	016161 	000000G	000004G	25$:	MOV	N.FVER(R1),N.FID+4(R1) ;SEND BACK PREVIOUS VERSION		;BLS052
    181	000554					CALL	FINDFL								;BLS052
    182						.IFF									;BLS052
    183					20$:	BIS	#NB.SVR,F.FNB+N.STAT(R0) ;FIND WILD CARD VERSION
    184					25$:	CALL	FINDFL
    185						.ENDC									;BLS052
    186	000560	103443 				BCS	30$
    187	000562	026105 	000000G			CMP	N.FVER(R1),R5
    188	000566	101367 				BHI	25$		;BRANCH IF TOO NEW TO DELETE
    189	000570	016146 	000000G			MOV	N.NEXT(R1),-(SP)
    190	000574	005061 	000000G			CLR	N.NEXT(R1)
    191	000600	005061 	000000G			CLR	N.STAT(R1)
    192	000604					DELET$	R0		;DELETE THIS ONE
    193	000610	012661 	000000G			MOV	(SP)+,N.NEXT(R1)
    194	000614	103351 				BCC	20$		;GO FIND THE NEXT ONE
    195					;
    196					; ERROR FROM DELETE
    197	000616	010046 				MOV	R0,-(SP)
    198	000620	010146 				MOV	R1,-(SP)							;BLS052
    199	000622	010546 				MOV	R5,-(SP)							;BLS052
    200	000624					ERROUT	DE09,0,0							;BLS052
	000624	104426 				TRAP	X
	000626	000000G				.WORD	DE09SZ
	000630	000000G				.WORD	DE09MG
    201	000632	012605 				MOV	(SP)+,R5							;BLS052
    202	000634	012601 				MOV	(SP)+,R1							;BLS052
    203	000636	012600 				MOV	(SP)+,R0							;**-3
    204					;
    205					; FILE PROCESSOR WRITE ERROR AT THIS POINT PROBABLY MEANS THAT THE
    206					; VOLUME IS WRITE LOCKED, STOP THE DELETE LOOP NOW.
    207					;
    208	000640	122767 	000000G	000000C		CMPB	#IE.WER,FDBOUT+F.ERR
    209	000646	001403 				BEQ	251$		;IF WRITE ERROR REALLY AN ERROR
    210	000650					CALL	SETWAR		;SET WARNING STATUS
    211	000654	000731 				BR	20$		;NEXT FILE
PIPDEL M0215, DELETE AND REMOVE	MACRO M1110  22-AUG-78 01:32  PAGE 7-4
**** PIPDEL VERSION M0215 ****

    212	000656				251$:				;REF LABEL
    213	000656	000167 	000000G			JMP	CLOSX
    214	000662	112760 	000000G	000000G	28$:	MOVB	#IE.NSF,F.ERR(R0)
    215					;
    216					; DONE PURGING THIS FILE NAME, GO GET ANOTHER
    217	000670				30$:										;BLS052
    218						.IF DF	O$$DS2								;BLS052
    219	000670	012661 	000000G			MOV	(SP)+,N.FVER(R1)						;BLS052
    220						.ENDC									;BLS052
    221	000674	012661 	000000G			MOV	(SP)+,N.STAT(R1)						;BLS052
    222	000700	012661 	000000G			MOV	(SP)+,N.NEXT(R1)						;**-1
    223	000704	122760 	000000G	000000G		CMPB	#IE.NSF,F.ERR(R0)
    224	000712	001656 				BEQ	10$
    225					;
    226					; FILE NOT FOUND, PROBABLY ALL DONE
    227	000714				80$:	CALL	FNDERR
    228	000720	000637 				BR	DELNXT
    229	000722	062706 	000006 		85$:	ADD	#6,SP								;BLS052
    230	000726	000772 				BR	80$								;**-1
    231
    232					;
    233					;
    234		000001 				.END
PIPDEL M0215, DELETE AND REMOVE	MACRO M1110  22-AUG-78 01:32  PAGE 7-5
SYMBOL TABLE

AB.CDT  000105   	DELNXT  000420R     003	FRSTIM= ****** GX	N.DIRD= 000004   	RMVERR= ****** GX
AB.CHU  000064   	DELPUR  000442R     003	FSTOUT= ****** GX	N.FID = ****** GX	RMVNXT= ****** GX
AB.EXP  000122   	DE01MG= ****** GX	F.DSPT= ****** GX	N.FLID= 000016   	R$$DPB= 000001
AB.FNU  000000   	DE01SZ= ****** GX	F.ERR = ****** GX	N.FNMD= 000010   	R$$DYM= 000001
AB.FP   000062   	DE02MG= ****** GX	F.FNB = ****** GX	N.FVER= ****** GX	R$$EIS= 000000
AB.FSQ  000002   	DE02SZ= ****** GX	F.RCTL= ****** GX	N.NEXT= ****** GX	R$$VMS= 000001
AB.GC   000061   	DE04MG= ****** GX	IE.NSF= ****** GX	N.SPEC= 000014   	R$$11M= 000001
AB.NAM  000006   	DE04SZ= ****** GX	IE.PRI= ****** GX	N.STAT= ****** GX	SETWAR= ****** GX
AB.PC   000060   	DE09MG= ****** GX	IE.WER= ****** GX	O$$DS2= 000001   	S.APPD= 000010
AB.RDT  000070   	DE09SZ= ****** GX	IO.DEL= ****** GX	PARSE = ****** GX	S.FIDS= 000014
AB.REV  000066   	DI08MG= ****** GX	NB.NXD= 020000   	PAR$$$= 000000   	USEFID= ****** GX
AB.UAT  000020   	DI08SZ= ****** GX	NB.SFL= ****** GX	PRSERR= ****** GX	VERSAV= ****** GX
AGAIN = ****** GX	EX$ERR= ****** GX	NB.SVR= ****** GX	PURGBT= ****** GX	X     = 000026
CLOSX = ****** GX	FDBOUT= ****** GX	NB.VER= ****** GX	PURGCT= ****** GX	.DELET= ****** G
CMDWRD= ****** GX	FD.DIR= ****** GX	NB.WLV= 010000   	PURSAV  000000R     002	.ENTER= ****** GX
CPYCTL= ****** GX	FINDFL= ****** GX	NXTFIL= ****** GX	REMOVE  000000RG    003	.EXSTS= ****** GX
DELETE  000000RG    003	FNDERR= ****** GX	NXTOUT= ****** GX	RMVBIT= ****** GX	.XQIO = ****** GX
DELET1  000012R     003	FNDNXT= ****** GX	N.DEVD= 000000

. ABS.	000131	   000
      	000000	   001
IMPURE	000002	   002
PURE$I	000730	   003
ERRORS DETECTED:  0

VIRTUAL MEMORY USED:  3211 WORDS  ( 13 PAGES)
DYNAMIC MEMORY:  3828 WORDS  ( 14 PAGES)
ELAPSED TIME:  00:00:16
OBJ$:PIPDEL,LIS$:PIPDEL/-SP=SRC$:PIPMAC,PIPDEL
