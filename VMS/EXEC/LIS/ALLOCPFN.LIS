ALLOCPFN        - PFN LIST MANIPULATING ROUTINES                 21-AUG-1978 19:37:05   VAX-11 MACRO X0.3-11               Page   0
TABLE OF CONTENTS   

   (1)    3300  HISTORY			; DETAILED
   (2)     100  DECLARATIONS
   (3)     100  ALLOCPFN - ALLOCATE A PAGE FROM THE FREE PAGE L
   (4)     100  DELCONPFN - DELETE CONTENTS OF PFN
   (6)     100  REMPFN - REMOVE A PFN FROM LIST
   (7)     100  RLPFNSAVPTE - RELEASE PFN SAVING PAGE TABLE ENT
   (8)     100  DELPFNLST - DELETE PFN FROM PFN LIST
   (9)     100  RELPFN - RELEASE PFN T0 FREE OR MODIFY LIST
   (10)    100  INSPFN - INSERT PFN AT HEAD OR TAIL OF PFN LIST
ALLOCPFN        - PFN LIST MANIPULATING ROUTINES                 21-AUG-1978 19:37:05   VAX-11 MACRO X0.3-11               Page   1
X0110                                                                                                                            (1)

                                     0000   100 	.TITLE	ALLOCPFN - PFN LIST MANIPULATING ROUTINES
                                     0000   200 	.IDENT	/X0110/
                                     0000   300 ;
                                     0000   400 ; COPYRIGHT (C) 1978
                                     0000   500 ; DIGITAL EQUIPMENT CORPORATION, MAYNARD, MASSACHUSETTS 01754
                                     0000   600 ;
                                     0000   700 ; THIS SOFTWARE IS FURNISHED  UNDER A LICENSE FOR USE ONLY ON A SINGLE
                                     0000   800 ; COMPUTER  SYSTEM AND  MAY BE  COPIED ONLY WITH  THE INCLUSION OF THE
                                     0000   900 ; ABOVE COPYRIGHT NOTICE.  THIS SOFTWARE, OR ANY OTHER COPIES THEREOF,
                                     0000  1000 ; MAY NOT BE PROVIDED OR  OTHERWISE MADE AVAILABLE TO ANY OTHER PERSON
                                     0000  1100 ; EXCEPT FOR USE ON SUCH SYSTEM AND TO ONE WHO AGREES TO THESE LICENSE
                                     0000  1200 ; TERMS.  TITLE TO AND  OWNERSHIP OF THE  SOFTWARE  SHALL AT ALL TIMES
                                     0000  1300 ; REMAIN IN DEC.
                                     0000  1400 ;
                                     0000  1500 ; THE INFORMATION IN THIS SOFTWARE IS SUBJECT TO CHANGE WITHOUT NOTICE
                                     0000  1600 ; AND SHOULD  NOT BE CONSTRUED  AS A COMMITMENT  BY DIGITAL  EQUIPMENT
                                     0000  1700 ; CORPORATION.
                                     0000  1800 ;
                                     0000  1900 ; DEC ASSUMES  NO  RESPONSIBILITY  FOR  THE USE OR  RELIABILITY OF ITS
                                     0000  2000 ; SOFTWARE ON EQUIPMENT WHICH IS NOT SUPPLIED BY DEC.
                                     0000  2100 
                                     0000  2200 ;++
                                     0000  2300 ; FACILITY:	EXECUTIVE, MEMORY MANAGEMENT SUBROUTINES
                                     0000  2400 ;
                                     0000  2500 ; ABSTRACT:	ALLOCPFN CONTAINS THE ROUTINES FOR MANIPULATING PFN LISTS
                                     0000  2600 ;	THE KNOWLEDGE OF THE FORMAT AND LOCATION OF THESE LISTS IS RESTRICTED
                                     0000  2650 ;	TO THIS MODULE, WRTMFYPAG, AND SWAPPER.  SINCE SHRCNT AND WSLX
                                     0000  2700 ;	OVERLAP FLINK AND BLINK, THOSE WORD REFERENCES CAN ALSO BE THOUGH
                                     0000  2750 ;	OF AS WORD WIDTH DEPENDENCIES FOR THE PFN
                                     0000  2800 ;
                                     0000  2900 ; ENVIRONMENT:	THESE ROUTINES MUST ALL BE CALLED AT THE SYNCH IPL!!!
                                     0000  3000 ;
                                     0000  3100 ;--
                                     0000  3200 ;
                                     0000  3300 	.SBTTL	HISTORY			; DETAILED
                                     0000  3400 ;
                                     0000  3500 ; AUTHOR: PETER H. LIPMAN	, CREATION DATE: 14-SEP-76
                                     0000  3600 ;
                                     0000  3700 ; MODIFIED BY:
                                     0000  3800 ;	, : VERSION
                                     0000  3900 ; 01	 -
ALLOCPFN        - PFN LIST MANIPULATING ROUTINES                 21-AUG-1978 19:37:05   VAX-11 MACRO X0.3-11               Page   2
X0110           DECLARATIONS                                                                                                     (2)

                                     0000   100 	.SBTTL	DECLARATIONS
                                     0000   200 ;
                                     0000   300 ; INCLUDE FILES:
                                     0000   400 ;
                                     0000   500 	$PFNDEF			;PFN DATA BASE DEFINITIONS
                                     0000   600 	$PRIDEF			;PRIORITY INCREMENT CLASS DEFINITIONS
                                     0000   700 	$PTEDEF			;PAGE TABLE ENTRY DEFINITIONS
                                     0000   800 	$VADEF			;VIRTUAL ADDRESS FIELD DEFINITIONS
                                     0000   900 	$WQHDEF			;WAIT QUEUE HEADER DEFINITIONS
                                     0000  1000 ;
                                     0000  1100 ; EXTERNAL SYMBOLS:
                                     0000  1200 ;
                                     0000  1300 ;
                                     0000  1400 ; MACROS:
                                     0000  1500 ;
                                     0000  1600 ;
                                     0000  1700 ; EQUATED SYMBOLS:
                                     0000  1800 ;
                                     0000  1900 ;
                                     0000  2000 ; OWN STORAGE:
                                     0000  2100 ;
                                 00000000  2200 	.PSECT	$$$210,LONG
                                     0000  2300 ;
                                     0000  2400 ; PFN LISTS INDEXED BY LIST IDENTIFIER, FREE, MODIFIED, AND BAD PAGE LISTS
                                     0000  2500 ;
                                     0000  2600 PFN$AW_HEAD::
                     0000 0000 0000  0000  2700 	.WORD	0,0,0			;HEAD OF PFN LISTS
                           00000002  0006  2750 	PFN$AW_MFYLSTHD==PFN$AW_HEAD+2	;ADDRESS OF MODIFIED PAGE LIST HEAD
                                     0006  2800 PFN$AW_TAIL:
                     0000 0000 0000  0006  2900 	.WORD	0,0,0			;TAIL OF PFN LISTS
                                     000C  3000 PFN$AL_COUNT:
         00000000 00000000 00000000  000C  3100 	.LONG	0,0,0			;COUNT OF PFN LIST ENTRIES
                           0000000C  0018  3200 	SCH$GL_FREECNT==PFN$AL_COUNT	;FREE PAGE COUNT
                           00000010  0018  3300 	SCH$GL_MFYCNT==PFN$AL_COUNT+4	;MODIFIED PAGE COUNT
                                     0018  3400 PFN$GL_PHYPGCNT::			;AVAILABLE PHYSICAL PAGE COUNT
                           00000000  0018  3500 	.LONG	0			;
                                     001C  3600 PFN$AL_HILIMIT::
         40000000 00000019 40000000  001C  3700 	.LONG	1@30,25,1@30		;"LIST TOO FULL" THRESHOLD
                           0000001C  0028  3800 	SCH$GL_FREEREQ==PFN$AL_HILIMIT	;REQUIRED FREE PAGES BY SWAPPER
                           00000020  0028  3900 	SCH$GL_MFYLIM==PFN$AL_HILIMIT+4	;MODIFIED PAGE LIST HILIMIT
                                     0028  4000 PFN$AL_LOLIMIT::
         FFFFFFFF 0000000A 0000000A  0028  4100 	.LONG	10,10,-1		;"LIST NEARLY EMPTY" THRESHOLD
                           00000028  0034  4200 	SCH$GL_FREELIM==PFN$AL_LOLIMIT
                           0000002C  0034  4250 	SCH$GL_MFYLOLIM==PFN$AL_LOLIMIT+4
                                     0034  4300 SCH$GL_MFYLIMSV::			;THE MODIFIED PAGE WRITER RESTORES
                           00000019  0034  4400 	.LONG	25			;THIS VALUE TO SCH$GL_MFYLIM AFTER
                                     0038  4500 					;WRITING ALL THE MODIFIED PAGES
                                     0038  4600 SCH$GL_MFYLOSV::			;THE MODIFIED PAGE WRITER RESTORES
                           0000000A  0038  4700 	.LONG	10			;THIS VALUE TO SCH$GL_MFYLOLIM AFTER
                                     003C  4750 					;WRITING ALL THE MODIFIED PAGES.
                                     003C  4800 ;
                                     003C  4900 ; **********************************************************************
                                     003C  5000 ;
                                     003C  5100 ; **************** THIS ENTIRE MODULE MUST BE RESIDENT *****************
                                     003C  5200 ;
                                 00000000  5300 	.PSECT	$MMGCOD
                                     0000  5400 ;
ALLOCPFN        - PFN LIST MANIPULATING ROUTINES                 21-AUG-1978 19:37:05   VAX-11 MACRO X0.3-11               Page   3
X0110           DECLARATIONS                                                                                                     (2)

                                     0000  5500 ; **********************************************************************
                                     0000  5600 ;
ALLOCPFN        - PFN LIST MANIPULATING ROUTINES                 21-AUG-1978 19:37:05   VAX-11 MACRO X0.3-11               Page   4
X0110           ALLOCPFN - ALLOCATE A PAGE FROM THE FREE PAGE L                                                                  (3)

                                     0000   100 	.SBTTL	ALLOCPFN - ALLOCATE A PAGE FROM THE FREE PAGE LIST
                                     0000   200 ;++
                                     0000   300 ; FUNCTIONAL DESCRIPTION:
                                     0000   400 ;
                                     0000   500 ;	ALLOCATE A PFN FROM THE FRONT OF THE FREE LIST, RELEASING ITS
                                     0000   600 ; CONTENTS IF ANY.  IPL MUST BE AT SYNCH OR HIGHER.
                                     0000   700 ;
                                     0000   800 ; CALLING SEQUENCE:
                                     0000   900 ;
                                     0000  1000 ;	BSBW	MMG$ALLOCPFN
                                     0000  1100 ;
                                     0000  1200 ; INPUT PARAMETERS:
                                     0000  1300 ;
                                     0000  1400 ;	IPL MUST BE AT SYNCH OR HIGHER
                                     0000  1500 ;
                                     0000  1600 ; IMPLICIT INPUTS:
                                     0000  1700 ;	NONE
                                     0000  1800 ;
                                     0000  1900 ; OUTPUT PARAMETERS:
                                     0000  2000 ;
                                     0000  2100 ;	R0 = PFN IF PAGE IS ALLOCATED OR NEGATIVE IF NONE AVAILABLE
                                     0000  2200 ;	PFN$AL_PTE[R0] = 0
                                     0000  2300 ;	PFN$AW_REFCNT[R0] = 0
                                     0000  2400 ;
                                     0000  2500 ; IMPLICIT OUTPUTS:
                                     0000  2600 ;
                                     0000  2700 ;	IF PFN HAD PREVIOUS CONTENTS (PFN$AL_PTE[R0] NEQ 0), THEN
                                     0000  2800 ; THE PREVIOUS PTE IS TRANSFORMED FROM "TRANSITION" TO ITS BACKUP ADDRESS.
                                     0000  2900 ;
                                     0000  3000 ; COMPLETION CODES:
                                     0000  3100 ;	NONE
                                     0000  3200 ;
                                     0000  3300 ; SIDE EFFECTS:
                                     0000  3400 ;	NONE
                                     0000  3500 ;
                                     0000  3600 ;--
                                     0000  3700 MMG$ALLOCPFN::
                                     0000  3800 	ASSUME	PFN$C_FREPAGLST EQ 0
                          52     D4  0000  3900 	CLRL	R2			;FREE PAGE LIST ID
                          0092   30  0002  4000 	BSBW	MMG$REMPFNH		;GET A PAGE FROM THE HEAD
            50            1F     E1  0005  4100 	BBC	#31,R0,20$		;BRANCH IF GOT A PAGE
                          01         0008       
                                 05  0009  4200 	RSB				;OTHERWISE RETURN, NONE AVAILABLE
                                     000A  4300 ;
                                     000A  4400 ; MUST NOW RELEASE ANY PREVIOUS CONTENTS
                                     000A  4500 ;
                                     000A  4600 20$:
                     0000'DF40   B5  000A  4700 	TSTW	@W^PFN$AW_REFCNT[R0]	;REF COUNT OK?
                          04     13  000F  4800 	BEQL	MMG$DELCONPFN		;IT MUST BE ZERO AT THIS POINT
                                     0011  4900 	BUG_CHECK FREEPAGREF,FATAL	;FREE PAGE REFERENCE COUNT NONZERO
ALLOCPFN        - PFN LIST MANIPULATING ROUTINES                 21-AUG-1978 19:37:05   VAX-11 MACRO X0.3-11               Page   5
X0110           DELCONPFN - DELETE CONTENTS OF PFN                                                                               (4)

                                     0015   100 	.SBTTL	DELCONPFN - DELETE CONTENTS OF PFN
                                     0015   200 ;++
                                     0015   300 ; FUNCTIONAL DESCRIPTION:
                                     0015   400 ;
                                     0015   500 ;	DELCONPFN DELETES THE CONTENTS OF A PFN.  WHEN A PAGE IS 
                                     0015   600 ; PLACED ON THE FREE PAGE LIST, IT NORMALLY RETAINS ITS CONTENTS SO THAT
                                     0015   700 ; IT MAY BE FAULTED OFF THE FREE LIST.  WHEN THE PAGE IS FINALLY ABOUT
                                     0015   800 ; TO BE REUSED, THEN ITS CONTENTS MUST BE DELETED.  THIS BASICALLY INVOLVES
                                     0015   900 ; STORING THE BACKUP ADDRESS IN THE ORIGINAL PTE SO THAT IT NO LONGER POINTS
                                     0015  1000 ; TO THIS PFN.
                                     0015  1100 ;
                                     0015  1200 ; CALLING SEQUENCE:
                                     0015  1300 ;
                                     0015  1400 ;	BSBW	MMG$DELCONPFN
                                     0015  1500 ;
                                     0015  1600 ; INPUT PARAMETERS:
                                     0015  1700 ;
                                     0015  1800 ;	R0 = PFN
                                     0015  1900 ;	PFN$AW_REFCNT[R0] = 0
                                     0015  2000 ;
                                     0015  2100 ; IMPLICIT INPUTS:
                                     0015  2200 ;	NONE
                                     0015  2300 ;
                                     0015  2400 ; OUTPUT PARAMETERS:
                                     0015  2500 ;
                                     0015  2600 ;	R0 PRESERVED
                                     0015  2700 ;
                                     0015  2800 ; IMPLICIT OUTPUTS:
                                     0015  2900 ;	NONE
                                     0015  3000 ;
                                     0015  3100 ; COMPLETION CODES:
                                     0015  3200 ;	NONE
                                     0015  3300 ;
                                     0015  3400 ; SIDE EFFECTS:
                                     0015  3500 ;	NONE
                                     0015  3600 ;
                                     0015  3700 ;--
                                     0015  3800 MMG$DELCONPFN::
            53       0000'DF40   D0  0015  3900 	MOVL	@W^PFN$AL_PTE[R0],R3	;SVA PTE OF CURRENT CONTENTS
                          65     13  001B  4000 	BEQL	60$			;BRANCH IF CONTENTS ALREADY RELEASED
            63   7BA00000 8F     CB  001D  4100 	BICL3	#^C<PTE$M_VALID ! PTE$M_TYP1 ! PTE$M_TYP0 ! PTE$M_PFN>,(R3),R1
                          51         0024       
            51            50     D1  0025  4200 	CMPL	R0,R1			;TRANSITION PAGE WITH SAME PFN?
                          37     12  0028  4300 	BNEQ	20$			;BRANCH IF INCONSISTENT
                                     002A  4400 ;
                                     002A  4500 ; NOW RESTORE BACKUP ADR TO PTE OF ORIGINAL OWNER OF THE PAGE
                                     002A  4600 ;
            63   867FFFFF 8F     CB  002A  4700 	BICL3	#^C<PTE$M_PROT ! PTE$M_OWN>,(R3),R1 ;R1 = PROT AND OWNER
                          51         0031       
                                 CB  0032  4800 	BICL3	#^C<PFN$M_BAK ! PFN$M_GBLBAK>,-
       0000'DF40 FF000000 8F         0033  4900 		@W^PFN$AL_BAK[R0],R2	;BACKING STORE ADDRESS
                          52         003C       
            52            17     E4  003D  5000 	BBSC	#PFN$V_GBLBAK,R2,10$	;CLR GBLBAK BRANCH IF WAS SET
                          04         0040       
            52            1A     E2  0041  5100 	BBSS	#PTE$V_TYP1,R2,10$	;SET THE HIGH ORDER TYPE BIT
                          00         0044       
                                     0045  5200 					;FOR SECTION OR PAGE FILE
ALLOCPFN        - PFN LIST MANIPULATING ROUTINES                 21-AUG-1978 19:37:05   VAX-11 MACRO X0.3-11               Page   6
X0110           DELCONPFN - DELETE CONTENTS OF PFN                                                                               (4)

            52            51     C9  0045  5300 10$:	BISL3	R1,R2,(R3)		;STORE THE BACKUP ADR
                          63         0048       
                                     0049  5400 
                                     0049  5500 	ASSUME	PFN$C_PROCESS EQ 0
                                     0049  5600 	ASSUME	PFN$C_SYSTEM  EQ 1
                                     0049  5700 	ASSUME	PFN$C_GLOBAL  EQ 2
                                     0049  5800 	ASSUME	PFN$C_GBLWRT  EQ 3
                                     0049  5900 	ASSUME	PFN$C_PPGTBL  EQ 4
                                     0049  6000 	ASSUME	PFN$C_GPGTBL  EQ 5
                                     0049  6100 
                          00     EF  0049  6200 	EXTZV	#PFN$V_PAGTYP,#PFN$S_PAGTYP,- ;GET PAGE TYPE TO DISPATCH ON
       0000'DF40          03         004B  6300 		@W^PFN$AB_TYPE[R0],R1
                          51         0050       
                                     0051  6400 	CASE	R1,<-
                                     0051  6500 		40$,-			;PROCESS PAGE
                                     0051  6600 		50$,-			;SYSTEM PAGE
                                     0051  6700 		40$,-			;GLOBAL READ ONLY
                                     0051  6800 		40$,-			;GLOBAL WRITABLE
                                     0051  6900 		30$,-			;PROCESS PAGE TABLE
                                     0051  7000 		50$-			;GLOBAL PAGE TABLE
                                     0051  7100 	>
                                     0061  7200 ;
                                     0061  7300 ; ERROR IN DELCONPFN
                                     0061  7400 ;
                                     0061  7500 20$:	BUG_CHECK DELCONPFN,FATAL	;
                                     0065  7600 ;
                                     0065  7700 ; PROCESS PAGE TABLE PAGE
                                     0065  7800 ;
            53       0000'CF     C3  0065  7900 30$:	SUBL3	W^SWP$GL_BALSPT,R3,R1	;BYTE OFFSET INTO SPT FOR PROCESS HEADERS
                          51         006A       
            51       0000'CF     C6  006B  8000 	DIVL	W^SWP$GL_BSLOTSZ,R1	;PROCESS HEADER INDEX
            51         FE 8F     78  0070  8050 	ASHL	#-2,R1,R1		;FOR BYTE COUNT
                          51         0074       
                          FF88'  30  0075  8100 	BSBW	MMG$DECPHDREF1		;DECREMENT PROCESS HEADER REF CNT
                          03     11  0078  8200 	BRB	50$
                                     007A  8300 ;
                                     007A  8400 ; PROCESS OR GLOBAL PAGE, MUST REDUCE PAGE TABLE REFERENCE COUNT
                                     007A  8500 ;
                          FF83'  30  007A  8600 40$:	BSBW	MMG$DECPTREF		;COUNT ONE LESS REF FOR PAGE TABLE
                                     007D  8700 ;
                                     007D  8800 ; REINITIALIZE THE PFN DATA BASE NOW
                                     007D  8900 ;
                     0000'DF40   D4  007D  9000 50$:	CLRL	@W^PFN$AL_PTE[R0]	;ZERO THE PTE POINTER (PAGE EMPTY)
                     0000'DF40   D4  0082  9100 60$:	CLRL	@W^PFN$AL_BAK[R0]	;ZERO THE BACKING STORE ADDRESS
                     0000'DF40   B4  0087  9200 	CLRW	@W^PFN$AW_SWPVBN[R0]	;ZERO THE SWAP FILE VBN
                     0000'DF40   94  008C  9300 	CLRB	@W^PFN$AB_STATE[R0]	;ZERO THE PFN STATE
                     0000'DF40   94  0091  9400 	CLRB	@W^PFN$AB_TYPE[R0]	;ZERO THE PFN TYPE
                                     0096  9500 ;
                                     0096  9600 ; ***** THE FOLLOWING ASSUMPTIONS ARE MADE HERE
                                     0096  9700 ;
                                     0096  9800 ;	PFN$AW_WSLX[R0]   IS THE SAME AS PFN$AW_BLINK[R0]
                                     0096  9900 ;	PFN$AW_SHRCNT[R0] IS THE SAME AS PFN$AW_FLINK[R0]
                                     0096 10000 ;
                                     0096 10100 ;	BOTH OF THE ABOVE ARE ZEROED BY MMG$REMPFN OR MMG$REMPFNH
                                     0096 10200 ;
                                 05  0096 10300 	RSB
ALLOCPFN        - PFN LIST MANIPULATING ROUTINES                 21-AUG-1978 19:37:05   VAX-11 MACRO X0.3-11               Page   7
X0110           REMPFN - REMOVE A PFN FROM LIST                                                                                  (6)

                                     0097   100 	.SBTTL	REMPFN - REMOVE A PFN FROM LIST
                                     0097   200 
                                     0097   300 ;++
                                     0097   400 ; FUNCTIONAL DESCRIPTION:
                                     0097   500 ;
                                     0097   600 ;	REMOVE A PFN FROM THE SPECIFIED PFN LIST.  THIS ROUTINE ACCEPTS
                                     0097   700 ; A PFN AND A PFN LIST IDENTIFIER AND REMOVES THE PFN FROM THE LIST.
                                     0097   800 ; IT MUST BE CALLED AT IPL GREATER OR EQUAL TO SYNCH.
                                     0097   900 ;
                                     0097  1000 ; CALLING SEQUENCE:
                                     0097  1100 ;
                                     0097  1200 ;	BSBW	MMG$REMPFNH		;REMOVE PFN FROM HEAD OF LIST
                                     0097  1300 ;	BSBW	MMG$REMPFN		;REMOVE SPECIFIED PFN FROM LIST
                                     0097  1400 ;
                                     0097  1500 ; INPUT PARAMETERS:
                                     0097  1600 ;
                                     0097  1700 ;	R0 = PFN TO REMOVE (UNLESS REMPFNH)
                                     0097  1800 ;	R2 = PFN LIST IDENTIFIER
                                     0097  1900 ;
                                     0097  2000 ; IMPLICIT INPUTS:
                                     0097  2100 ;	NONE
                                     0097  2200 ;
                                     0097  2300 ; OUTPUT PARAMETERS:
                                     0097  2400 ;
                                     0097  2500 ;	R0 = PFN REMOVED
                                     0097  2600 ;	     OR NEGATIVE IF REMPFNH FROM EMPTY LIST
                                     0097  2700 ;
                                     0097  2800 ; IMPLICIT OUTPUTS:
                                     0097  2900 ;
                                     0097  3000 ;	THE LIST HEAD, TAIL AND COUNT FOR THE SPECIFIED LIST IS UPDATED
                                     0097  3100 ;
                                     0097  3200 ; COMPLETION CODES:
                                     0097  3300 ;	NONE
                                     0097  3400 ;
                                     0097  3500 ; SIDE EFFECTS:
                                     0097  3600 ;	THE FLINK AND BLINK POINTERS FOR PHYSICAL PAGE ZERO ARE CONSIDERED
                                     0097  3700 ; GARBAGE AND ARE OVERWRITTEN WHEN THE LIST BECOMES EMPTY.
                                     0097  3800 ;
                                     0097  3900 ;--
                                     0097  4000 
                                     0097  4100 MMG$REMPFNH::
            50       0000'CF42   3C  0097  4200 	MOVZWL	W^PFN$AW_HEAD[R2],R0	;R0 = PFN FROM HEAD OF LIST
                          03     12  009D  4300 	BNEQ	MMG$REMPFN		;REMOVE THE PFN IF ANY
                          50     D7  009F  4400 	DECL	R0			;RETURN NEGATIVE IF EMPTY
                                 05  00A1  4500 	RSB
                                     00A2  4600 ;
                                     00A2  4700 ; R0 = PFN TO REMOVE, R2 = LIST IDENTIFIER
                                     00A2  4800 ;
                                     00A2  4900 MMG$REMPFN::
            51       0000'DF40   3C  00A2  5000 	MOVZWL	@W^PFN$AW_FLINK[R0],R1	;R1 = NEXT PFN
            53       0000'DF40   3C  00A8  5100 	MOVZWL	@W^PFN$AW_BLINK[R0],R3	;R3 = PREVIOUS PFN
       0000'DF43          51     B0  00AE  5200 	MOVW	R1,@W^PFN$AW_FLINK[R3]	;FLINK[PREV] = NEXT
                          06     12  00B4  5300 	BNEQ	10$			;BRANCH IF NOT TAIL
                                     00B6  5400 ;
                                     00B6  5500 ; IF NEXT = 0 THEN PFN BEING REMOVED WAS THE TAIL OF THE LIST
                                     00B6  5600 ;
       0006'CF42          53     B0  00B6  5700 	MOVW	R3,W^PFN$AW_TAIL[R2]	;TAIL = PREVIOUS
ALLOCPFN        - PFN LIST MANIPULATING ROUTINES                 21-AUG-1978 19:37:05   VAX-11 MACRO X0.3-11               Page   8
X0110           REMPFN - REMOVE A PFN FROM LIST                                                                                  (6)

                                     00BC  5800 10$:
       0000'DF41          53     B0  00BC  5900 	MOVW	R3,@W^PFN$AW_BLINK[R1]	;BLINK[NEXT] = PREVIOUS
                          06     12  00C2  6000 	BNEQ	20$			;BRANCH IF NOT HEAD
                                     00C4  6100 ;
                                     00C4  6200 ; IF PREVIOUS = 0 THEN PFN BEING REMOVED WAS HEAD OF THE LIST
                                     00C4  6300 ;
       0000'CF42          51     B0  00C4  6400 	MOVW	R1,W^PFN$AW_HEAD[R2]	;HEAD = NEXT
                                     00CA  6500 20$:
            09       000C'CF42   F5  00CA  6600 	SOBGTR	W^PFN$AL_COUNT[R2],30$	;ONE LESS PFN, BRANCH IF NOT EMPTY
                                     00D0  6700 ;
                                     00D0  6800 ; CHECK CONSISTENCY OF THE COUNT AND LIST HEAD OF EMPTY LIST
                                     00D0  6900 ;
            53            51     C8  00D0  7000 	BISL	R1,R3			;BOTH HEAD AND TAIL 0?
                          04     13  00D3  7100 	BEQL	30$			;BRANCH IF OK
                                     00D5  7200 	BUG_CHECK PFNLISTCNT,FATAL	;INCONSISTENT PFN LIST COUNT
                                     00D9  7300 30$:
                     0000'DF40   B4  00D9  7400 	CLRW	@W^PFN$AW_FLINK[R0]	;ZERO THE NEW PAGE'S FLINK
                     0000'DF40   B4  00DE  7500 	CLRW	@W^PFN$AW_BLINK[R0]	;ZERO THE NEW PAGE'S BLINK
       0028'CF42     000C'CF42   D1  00E3  7600 	CMPL	W^PFN$AL_COUNT[R2],W^PFN$AL_LOLIMIT[R2] ;NEARLY EMPTY?
                          06     14  00EC  7700 	BGTR	40$			;BRANCH IF NOT
                                     00EE  7800 ;
                                     00EE  7900 ; THIS LIST IS BELOW ITS THRESHOLD SIZE, INFORM THE INTERESTED PARTY
                                     00EE  8000 ;
                                     00EE  8100 	CASE	R2,<-
                                     00EE  8200 		WAKESWAPPER-		;FREE LIST - INFORM SWAPPER
                                     00EE  8300 	>
                                     00F4  8400 40$:
                                 05  00F4  8500 	RSB
ALLOCPFN        - PFN LIST MANIPULATING ROUTINES                 21-AUG-1978 19:37:05   VAX-11 MACRO X0.3-11               Page   9
X0110           RLPFNSAVPTE - RELEASE PFN SAVING PAGE TABLE ENT                                                                  (7)

                                     00F5   100 	.SBTTL	RLPFNSAVPTE - RELEASE PFN SAVING PAGE TABLE ENTRY
                                     00F5   200 ;++
                                     00F5   300 ; FUNCTIONAL DESCRIPTION:
                                     00F5   400 ;
                                     00F5   500 ;	THIS ROUTINE RELEASES THE GIVEN PFN BUT LEAVES THE CONTENTS OF
                                     00F5   550 ;	THE PTE ADDRESSED BY R3 ALONE.  IT IS USED FOR RELEASING THE PFN
                                     00F5   600 ;	FOR A GLOBAL DZRO PAGE WHEN 2 OR MORE PROCESSES TRIED TO ZERO THE
                                     00F5   650 ;	PAGE.  ONE MAKES IT, THE OTHERS RELEASE THE PFN AND START OVER.
                                     00F5   700 ;
                                     00F5   800 ; CALLING SEQUENCE:
                                     00F5   900 ;
                                     00F5  1000 ;	BSBW	MMG$RLPFNSAVPTE
                                     00F5  1100 ;
                                     00F5  1200 ; INPUT PARAMETERS:
                                     00F5  1300 ;
                                     00F5  1400 ;	R0 = PFN
                                     00F5  1500 ;	R3 = SYSTEM VIRTUAL ADDRESS OF PAGE TABLE ENTRY
                                     00F5  1600 ;
                                     00F5  1700 ; IMPLICIT INPUTS:
                                     00F5  1800 ;
                                     00F5  1900 ;	NONE
                                     00F5  2000 ;
                                     00F5  2100 ; OUTPUT PARAMETERS:
                                     00F5  2200 ;
                                     00F5  2300 ;	NONE
                                     00F5  2400 ;
                                     00F5  2500 ; IMPLICIT OUTPUTS:
                                     00F5  2600 ;
                                     00F5  2700 ;	NONE
                                     00F5  2800 ;
                                     00F5  2900 ; COMPLETION CODES:
                                     00F5  3000 ;
                                     00F5  3100 ;	NONE
                                     00F5  3200 ;
                                     00F5  3300 ; SIDE EFFECTS:
                                     00F5  3400 ;
                                     00F5  3500 ;	NONE
                                     00F5  3600 ;
                                     00F5  3700 ;--
                                     00F5  3800 
                                     00F5  3900 MMG$RLPFNSAVPTE::
                     0000'DF40   D4  00F5  4000 	CLRL	@W^PFN$AL_PTE[R0]	;NO PTE BACK POINTER
                     0000'DF40   B4  00FA  4100 	CLRW	@W^PFN$AW_REFCNT[R0]	;AND NO REFERENCES
                                 90  00FF  4200 	MOVB	#<PFN$C_ACTIVE ! PFN$M_DELCON>,-
       0000'DF40          17         0100  4300 		@W^PFN$AB_STATE[R0]	;SHUT OFF MODIFY, TURN ON DELCON
                                     0105  4310 ;
                                     0105  4320 ; THE FOLLOWING ASSUMES THAT THE PTE IS A GLOBAL PTE THAT MUST HAVE
                                     0105  4330 ; A REFERENCE COUNT TAKEN AWAY EVEN THOUGH ITS CONTENTS ARE NOT TO
                                     0105  4340 ; BE OVERWRITTEN.
                                     0105  4350 ;
                          FEF8'  30  0105  4400 	BSBW	MMG$DECPTREF		;COUNT ONE LESS PAGE TABLE REFERENCE
                          08     11  0108  4500 	BRB	MMG$RELPFN		;RELEASE THE PFN
                                     010A  4600 					;AND RETURN TO CALLER
ALLOCPFN        - PFN LIST MANIPULATING ROUTINES                 21-AUG-1978 19:37:05   VAX-11 MACRO X0.3-11               Page  10
X0110           DELPFNLST - DELETE PFN FROM PFN LIST                                                                             (8)

                                     010A   100 	.SBTTL	DELPFNLST - DELETE PFN FROM PFN LIST
                                     010A   200 ;++
                                     010A   300 ; FUNCTIONAL DESCRIPTION:
                                     010A   400 ;
                                     010A   500 ;	THIS ROUTINE REMOVES THE PFN FROM THE SPECIFIED LIST
                                     010A   600 ;	SETS DELCON AND RELEASES THE PAGE.
                                     010A   700 ;
                                     010A   800 ; CALLING SEQUENCE:
                                     010A   900 ;
                                     010A  1000 ;	BSBW	MMG$DELPFNLST
                                     010A  1100 ;
                                     010A  1200 ; INPUT PARAMETERS:
                                     010A  1300 ;
                                     010A  1400 ;	R0 = PFN
                                     010A  1500 ;	R2 = LIST IDENTIFIER
                                     010A  1600 ;
                                     010A  1700 ; IMPLICIT INPUTS:
                                     010A  1800 ;
                                     010A  1900 ;	NONE
                                     010A  2000 ;
                                     010A  2100 ; OUTPUT PARAMETERS:
                                     010A  2200 ;
                                     010A  2300 ;	NONE
                                     010A  2400 ;
                                     010A  2500 ; IMPLICIT OUTPUTS:
                                     010A  2600 ;
                                     010A  2700 ;	NONE
                                     010A  2800 ;
                                     010A  2900 ; COMPLETION CODES:
                                     010A  3000 ;
                                     010A  3100 ;	NONE
                                     010A  3200 ;
                                     010A  3300 ; SIDE EFFECTS:
                                     010A  3400 ;
                                     010A  3500 ;	NONE
                                     010A  3600 ;
                                     010A  3700 ;--
                                     010A  3800 
                                     010A  3900 MMG$DELPFNLST::
                          96     10  010A  4000 	BSBB	MMG$REMPFN		;REMOVE PFN FROM SPECIFIED LIST
       0000'DF40          10     88  010C  4100 	BISB	#PFN$M_DELCON,@W^PFN$AB_STATE[R0] ;JAM 'DELETE CONTENTS' BIT
                                     0112  4200 ;
                                     0112  4300 ; FALL THROUGH TO MMG$RELPFN
                                     0112  4400 ;
ALLOCPFN        - PFN LIST MANIPULATING ROUTINES                 21-AUG-1978 19:37:05   VAX-11 MACRO X0.3-11               Page  11
X0110           RELPFN - RELEASE PFN T0 FREE OR MODIFY LIST                                                                      (9)

                                     0112   100 	.SBTTL	RELPFN - RELEASE PFN T0 FREE OR MODIFY LIST
                                     0112   200 ;++
                                     0112   300 ; FUNCTIONAL DESCRIPTION:
                                     0112   400 ;
                                     0112   500 ;	THIS ROUTINE RELEASES THE SPECIFIED PFN TO THE MODIFY OR
                                     0112   600 ; FREE PAGE LIST ACCORDING TO THE STATE BITS IN PFN$AB_STATE[R0]
                                     0112   700 ;
                                     0112   800 ; CALLING SEQUENCE:
                                     0112   900 ;
                                     0112  1000 ;	BSBW	MMG$RELPFN
                                     0112  1100 ;
                                     0112  1200 ; INPUT PARAMETERS:
                                     0112  1300 ;
                                     0112  1400 ;	R0 = PFN, REFCNT=0
                                     0112  1500 ;
                                     0112  1600 ; IMPLICIT INPUTS:
                                     0112  1700 ;	NONE
                                     0112  1800 ;
                                     0112  1900 ; OUTPUT PARAMETERS:
                                     0112  2000 ;
                                     0112  2100 ;	R0 PRESEVED
                                     0112  2200 ;
                                     0112  2300 ; IMPLICIT OUTPUTS:
                                     0112  2400 ;	NONE
                                     0112  2500 ;
                                     0112  2600 ; COMPLETION CODES:
                                     0112  2700 ;	NONE
                                     0112  2800 ;
                                     0112  2900 ; SIDE EFFECTS:
                                     0112  3000 ;	NONE
                                     0112  3100 ;
                                     0112  3200 ;--
                                     0112  3300 MMG$RELPFN::
            53       0000'DF40   D0  0112  3400 	MOVL	@W^PFN$AL_PTE[R0],R3	;R3 = SVAPTE
                          08     13  0118  3500 	BEQL	10$			;BRANCH IF PAGE IS EMPTY
         02 A3       8440 8F     B3  011A  3600 	BITW	#<PTE$M_VALID ! PTE$M_TYP1 ! PTE$M_TYP0>@-16,2(R3)
                          30     12  0120  3700 	BNEQ	60$			;BRANCH IF NOT TRANSITION PAGE
            01            07     EF  0122  3800 10$:	EXTZV	#PFN$V_MODIFY,#1,@W^PFN$AB_STATE[R0],R2 ;R2 = MODIFY BIT
            52       0000'DF40       0125       
                          0F     12  012A  3900 	BNEQ	40$			;BRANCH IF PAGE MODIFIED
                                     012C  4000 ;
                                     012C  4100 ; PAGE NOT MODIFIED R2 = 0 = LIST ID FOR FREE PAGE LIST
                                     012C  4200 ; SEE IF SUPPOSED TO DELETE THE CONTENTS OF THE PAGE
                                     012C  4300 ;
       0000'DF40          04     E1  012C  4400 	BBC	#PFN$V_DELCON,@W^PFN$AB_STATE[R0],50$ ;BRANCH IF RETAIN CONTENTS
                          1C         0132       
                          FEDF   30  0133  4500 	BSBW	MMG$DELCONPFN		;DELETE PAGE CONTENTS
                                     0136  4600 	ASSUME	PFN$C_FREPAGLST EQ 0
                          52     D4  0136  4700 	CLRL	R2			;FREE PAGE LIST ID
                          2D     10  0138  4800 	BSBB	MMG$INSPFNH		;PUT PAGE ON FRONT OF FREE LIST
                                 05  013A  4900 	RSB
                                     013B  5000 40$:
                     0000'DF40   B5  013B  5100 	TSTW	@W^PFN$AW_SWPVBN[R0]	;CHECK FOR SWAP FILE BACKING STORE
                          0D     12  0140  5200 	BNEQ	50$			;YES, PAGE HAS BACKING STORE
       0000'DF40          09     78  0142  5300 	ASHL	#<32-PFN$S_BAK>,@W^PFN$AL_BAK[R0],R1 ;VALID BACKING STORE ADR?
                          51         0148       
                          04     12  0149  5400 	BNEQ	50$			;YES, SPACE ALLOCATED FOR PAGE
ALLOCPFN        - PFN LIST MANIPULATING ROUTINES                 21-AUG-1978 19:37:05   VAX-11 MACRO X0.3-11               Page  12
X0110           RELPFN - RELEASE PFN T0 FREE OR MODIFY LIST                                                                      (9)

                                     014B  5500 	BUG_CHECK MODRELNBAK,FATAL	;NO BACKING STORE ADDRESS FOR MODIFIED PAGE
                                     014F  5600 50$:
                          52     10  014F  5700 	BSBB	MMG$INSPFNT		;PUT PAGE AT END OF LIST IN R2
                                 05  0151  5800 	RSB
                                     0152  5900 ;
                                     0152  6000 ; PAGE IS NOT A TRANSITION PAGE, IF IT'S NOT VALID, THAT'S A FATAL ERROR.
                                     0152  6100 ; IF VALID, THEN FOLD MODIFY BACK TO PFN DATA, SHUT OFF VALID AND MODIFY,
                                     0152  6200 ; AND CONTINUE WITH RELEASING THE PAGE.
                                     0152  6300 ;
                          0F     14  0152  6400 60$:	BGTR	80$			;BRANCH IF PTE NOT VALID
            63            1A     E5  0154  6500 	BBCC	#PTE$V_MODIFY,(R3),70$	;CLEAR MODIFY, BRANCH IF WAS CLEAR
                          07         0157       
       0000'DF40       80 8F     88  0158  6600 	BISB	#PFN$M_MODIFY,@W^PFN$AB_STATE[R0] ;RECORD IT IN PFN DATA
            63            1F     E4  015F  6700 70$:	BBSC	#PTE$V_VALID,(R3),10$	;CLEAR VALID AND BRANCH (IT WAS SET)
                          BF         0162       
                                     0163  6800 80$:	BUG_CHECK PAGNTRNVAL,FATAL	;PAGE NOT IN TRANSITION OR VALID
ALLOCPFN        - PFN LIST MANIPULATING ROUTINES                 21-AUG-1978 19:37:05   VAX-11 MACRO X0.3-11               Page  13
X0110           INSPFN - INSERT PFN AT HEAD OR TAIL OF PFN LIST                                                                 (10)

                                     0167   100 	.SBTTL	INSPFN - INSERT PFN AT HEAD OR TAIL OF PFN LIST
                                     0167   200 
                                     0167   300 ;++
                                     0167   400 ; FUNCTIONAL DESCRIPTION:
                                     0167   500 ;
                                     0167   600 ;	INSERT PFN ON SPECIFIED PFN LIST, SETTING THE LOCATION FIELD
                                     0167   700 ; IN PFN$AB_STATE TO REFLECT THE LIST IDENTIFIER.  IPL MUST BE AT SYNCH
                                     0167   800 ; OR HIGHER.  IF THE LIST WAS EMPTY BEFORE THE INSERT SPECIAL ACTION
                                     0167   900 ; IS TAKEN TO INFORM ANY PROCESS THAT MIGHT BE WAITING.
                                     0167  1000 ;
                                     0167  1100 ; CALLING SEQUENCE:
                                     0167  1200 ;
                                     0167  1300 ;	BSBW	MMG$DALLOCPFN		;DEALLOCATE PFN, PUT AT TAIL OF FREE LIST
                                     0167  1400 ;	BSBW	MMG$INSPFNT		;INSERT PFN AT TAIL OF LIST SPECIFIED IN R2
                                     0167  1500 ;	BSBW	MMG$INSPFNH		;INSERT PFN AT HEAD OF LIST SPECIFIED IN R2
                                     0167  1600 ;
                                     0167  1700 ;
                                     0167  1800 ; INPUT PARAMETERS:
                                     0167  1900 ;
                                     0167  2000 ;	R0 = PFN TO INSERT IN THE LIST
                                     0167  2100 ;	R2 = PFN LIST IDENTIFIER (UNLESS DALLOCPFN)
                                     0167  2200 ;
                                     0167  2300 ; IMPLICIT INPUTS:
                                     0167  2400 ;	NONE
                                     0167  2500 ;
                                     0167  2600 ; OUTPUT PARAMETERS:
                                     0167  2700 ;
                                     0167  2800 ;	R0 PRESERVED
                                     0167  2900 ;
                                     0167  3000 ; IMPLICIT OUTPUTS:
                                     0167  3100 ;
                                     0167  3200 ;	PFN LIST HEAD, TAIL AND COUNT ARE UPDATED
                                     0167  3300 ;
                                     0167  3400 ; COMPLETION CODES:
                                     0167  3500 ;	NONE
                                     0167  3600 ;
                                     0167  3700 ; SIDE EFFECTS:
                                     0167  3800 ;
                                     0167  3900 ;	THE FLINK AND BLINK POINTER FOR PHYSICAL PAGE 0 ARE CONSIDERED
                                     0167  4000 ; GARBAGE AND ARE OVERWRITTEN WHEN INSERTING ON AN EMPTY LIST.
                                     0167  4100 ;	IF THE LIST WAS EMPTY BEFORE THE INSERT, THEN IF THE LIST IS
                                     0167  4200 ; THE FREE PAGE LIST, ANYONE WAITING FOR FREE PAGES IS AWAKENED.  IF
                                     0167  4300 ; THE LIST IS THE MODIFIED PAGE LIST, THE MODIFIED PAGE WRITER IS INFORMED.
                                     0167  4400 ;
                                     0167  4500 ;--
                                     0167  4600 
                                     0167  4700 MMG$INSPFNH::				;INSERT PFN AT HEAD OF LIST
                     0000'DF40   B5  0167  4800 	TSTW	@W^PFN$AW_REFCNT[R0]	;REFERENCE COUNT MUST BE ZERO
                          2F     12  016C  4900 	BNEQ	INSPFNREF		;BRANCH IF NOT, ERROR
            00            52     F0  016E  5000 	INSV	R2,#PFN$V_LOC,#PFN$S_LOC,@W^PFN$AB_STATE[R0] ;SET LOCATION
       0000'DF40          03         0171       
            51       0000'CF42   3C  0176  5100 	MOVZWL	W^PFN$AW_HEAD[R2],R1	;R1=PFN OF OLD HEAD
       0000'DF41          50     B0  017C  5200 	MOVW	R0,@W^PFN$AW_BLINK[R1]	;BLINK(OLD) = NEW
       0000'CF42          50     B0  0182  5300 	MOVW	R0,W^PFN$AW_HEAD[R2]	;HEAD = NEW
                     0000'DF40   B4  0188  5400 	CLRW	@W^PFN$AW_BLINK[R0]	;BLINK(NEW)=0
       0000'DF40          51     B0  018D  5500 	MOVW	R1,@W^PFN$AW_FLINK[R0]	;FLINK(NEW)=OLD
                          4F     12  0193  5600 	BNEQ	NOTEMPTY		;BRANCH IF LIST WAS NOT EMPTY
ALLOCPFN        - PFN LIST MANIPULATING ROUTINES                 21-AUG-1978 19:37:05   VAX-11 MACRO X0.3-11               Page  14
X0110           INSPFN - INSERT PFN AT HEAD OR TAIL OF PFN LIST                                                                 (10)

       0006'CF42          50     B0  0195  5700 	MOVW	R0,W^PFN$AW_TAIL[R2]	;LIST NOW HAS JUST ONE ENTRY
                          3A     11  019B  5800 	BRB	WASEMPTY		;INFORM OTHERS, LIST NO LONGER EMPTY
                                     019D  5900 ;
                                     019D  6000 ; PFN REFERENCE COUNT NON-ZERO
                                     019D  6100 ;
                                     019D  6200 INSPFNREF:
                                     019D  6300 	BUG_CHECK PFNREFNZRO,FATAL	;PFN REFERENCE COUNT NONZERO
                                     01A1  6400 
                                     01A1  6500 MMG$DALLOCPFN::
                                     01A1  6600 	ASSUME	PFN$C_FREPAGLST EQ 0
                          52     D4  01A1  6700 	CLRL	R2			;FREE PAGE LIST ID
                                     01A3  6800 MMG$INSPFNT::				;INSERT PFN AT TAIL OF LIST
                     0000'DF40   B5  01A3  6900 	TSTW	@W^PFN$AW_REFCNT[R0]	;MAKE SURE REFERENCE COUNT IS ZERO
                          F3     12  01A8  7000 	BNEQ	INSPFNREF		;BRANCH IF IT IS NOT, ERROR
            00            52     F0  01AA  7100 	INSV	R2,#PFN$V_LOC,#PFN$S_LOC,@W^PFN$AB_STATE[R0] ;SET LOCATION
       0000'DF40          03         01AD       
            51       0006'CF42   3C  01B2  7200 	MOVZWL	W^PFN$AW_TAIL[R2],R1	;R1=PFN OF LAST ENTRY ON LIST
       0006'CF42          50     B0  01B8  7300 	MOVW	R0,W^PFN$AW_TAIL[R2]	;NEW ENTRY IS THE NEW TAIL
                     0000'DF40   B4  01BE  7400 	CLRW	@W^PFN$AW_FLINK[R0]	;NEW ENTRY FLINK IS 0
       0000'DF41          50     B0  01C3  7500 	MOVW	R0,@W^PFN$AW_FLINK[R1]	;FLINK(OLD)=NEW
       0000'DF40          51     B0  01C9  7600 	MOVW	R1,@W^PFN$AW_BLINK[R0]	;NEW ENTRY BLINK IS OLD TAIL
                          13     12  01CF  7700 	BNEQ	NOTEMPTY		;BRANCH IF LIST WAS NOT EMPTY
       0000'CF42          50     B0  01D1  7800 	MOVW	R0,W^PFN$AW_HEAD[R2]	;LIST WAS EMPTY, NEW ENTRY IS HEAD AND TAIL
                                     01D7  7900 ;
                                     01D7  8000 ; THIS LIST JUST WENT FROM EMPTY TO ONE ENTRY.
                                     01D7  8100 ;
                                     01D7  8200 WASEMPTY:
       000C'CF42          01     D0  01D7  8300 	MOVL	#1,W^PFN$AL_COUNT[R2]	;RESET THE LIST COUNTER
                                     01DD  8400 	CASE	R2,<-
                                     01DD  8500 		WAKFREPAGWAITQ-		;FREE PAGE LIST WAS EMPTY
                                     01DD  8600 	>
                                 05  01E3  8700 	RSB
                                     01E4  8800 
                                     01E4  8900 NOTEMPTY:
       000C'CF42     001C'CF42   F2  01E4  9000 	AOBLSS	W^PFN$AL_HILIMIT[R2],W^PFN$AL_COUNT[R2],20$
                          08         01ED       
                                     01EE  9100 ;
                                     01EE  9200 ; THIS LIST IS ABOVE ITS THRESHOLD SIZE, INFORM THE INTERESTED PARTY
                                     01EE  9300 ;
                                     01EE  9400 	CASE	R2,<-
                                     01EE  9500 		WAKESWAPPER,-		;FREE PAGE LIST
                                     01EE  9600 		WAKE_MPW-		;MODIFIED PAGE LIST
                                     01EE  9700 	>
                                     01F6  9800 20$:
                                 05  01F6  9900 	RSB
                                     01F7 10000 
                                     01F7 10100 ;
                                     01F7 10200 ; FREE PAGE LIST JUST WENT FROM EMPTY TO ONE PAGE.  MUST REPORT 
                                     01F7 10300 ; THE "FREE PAGE AVAILABLE" EVENT FOR ALL PROCESSES WAITING.
                                     01F7 10400 ;
                                     01F7 10500 WAKFREPAGWAITQ:
                          11     BB  01F7 10600 	PUSHR	#^M<R0,R4>		;SAVE THE REGISTERS TO BE RETURNED
            52            02     D0  01F9 10700 	MOVL	#PRI$_RESAVL,R2		;"RESOURCE AVAILABLE" PRIORITY INC
                                     01FC 10800 10$:
                     0008'CF     B5  01FC 10900 	TSTW	W^SCH$GQ_FPGWQ+WQH$W_WQCNT ;ANYONE WAITING?
                          0B     15  0200 11000 	BLEQ	20$			;BRANCH IF NOT
            54       0000'CF     D0  0202 11100 	MOVL	W^SCH$GQ_FPGWQ,R4	;GET THE NEXT PCB
ALLOCPFN        - PFN LIST MANIPULATING ROUTINES                 21-AUG-1978 19:37:05   VAX-11 MACRO X0.3-11               Page  15
X0110           INSPFN - INSERT PFN AT HEAD OR TAIL OF PFN LIST                                                                 (10)

                                     0207 11200 	RPTEVT	FPGA			;REPORT "FREE PAGE AVAILABLE"
                          EF     11  020B 11300 	BRB	10$
                          11     BA  020D 11400 20$:	POPR	#^M<R0,R4>		;RESTORE REGISTERS
                                 05  020F 11500 	RSB
                                     0210 11510 ;
                                     0210 11520 ; NEED TO START WRITING MODIFIED PAGES
                                     0210 11530 ;
                                     0210 11540 WAKE_MPW:
       0000'CF            00'    E1  0210 11550 	BBC	S^#SCH$V_MPW,W^SCH$GB_SIP,WAKESWAPPER ;BRANCH IF MODIFIED PAGE
                          06         0215       
                                     0216 11560 					;WRITER IS NOT ALREADY ACTIVE
       0023'CF            01     90  0216 11570 	MOVB	#1,W^SCH$GL_MFYLIM+3	;DISABLE THE THRESHOLD CHECK WHILE
                                     021B 11580 					;MODIFIED PAGE WRITER IS ACTIVE
                                 05  021B 11590 	RSB
                                     021C 11600 ;
                                     021C 11700 ; INFORM THE SWAPPER PROCESS THAT SOMETHING OF INTEREST HAS OCCURRED
                                     021C 11800 ;
                                     021C 11900 WAKESWAPPER:
                          FDE1'  30  021C 12000 	BSBW	SCH$SWPWAKE		;WAKE UP THE SWAPPER PROCESS
                                 05  021F 12100 	RSB
                                     0220 12200 
                                     0220 12300 
                                     0220 12400 	.END
ALLOCPFN        - PFN LIST MANIPULATING ROUTINES                 21-AUG-1978 19:37:05   VAX-11 MACRO X0.3-11               Page  16
SYMBOL TABLE                                                                                                                    (10)

BIT...         = 00000020            PFN$M_LOC      = 00000007            PTE$S_GPTX     = 00000016            
BUG$_DELCONPFN   ********   X   04   PFN$M_MODIFY   = 00000080            PTE$S_OWN      = 00000002            
BUG$_FREEPAGREF  ********   X   04   PFN$M_PAGTYP   = 00000007            PTE$S_PFN      = 00000015            
BUG$_MODRELNBAK  ********   X   04   PFN$M_PGFLX    = FF000000            PTE$S_PGFLVB   = 00000016            
BUG$_PAGNTRNVAL  ********   X   04   PFN$M_RPTEVT   = 00000040            PTE$S_PROT     = 00000004            
BUG$_PFNLISTCNT  ********   X   04   PFN$S_BAK      = 00000017            PTE$S_STX      = 00000010            
BUG$_PFNREFNZRO  ********   X   04   PFN$S_GBLBAK   = 00000001            PTE$V_CRF      = 00000010            
EVT$_FPGA        ********   X   04   PFN$S_LOC      = 00000003            PTE$V_DZRO     = 00000011            
GBL...         = 00000000            PFN$S_PAGTYP   = 00000003            PTE$V_GPTX     = 00000000            
INSPFNREF        0000019D R     04   PFN$S_PGFLX    = 00000008            PTE$V_MODIFY   = 0000001A            
MMG$ALLOCPFN     00000000 RG    04   PFN$V_BADPAG   = 00000005            PTE$V_OWN      = 00000017            
MMG$DALLOCPFN    000001A1 RG    04   PFN$V_BAK      = 00000000            PTE$V_PFN      = 00000000            
MMG$DECPHDREF1   ********   X   04   PFN$V_COLLISION= 00000004            PTE$V_PGFLVB   = 00000000            
MMG$DECPTREF     ********   X   04   PFN$V_DELCON   = 00000004            PTE$V_PROT     = 0000001B            
MMG$DELCONPFN    00000015 RG    04   PFN$V_GBLBAK   = 00000017            PTE$V_STX      = 00000000            
MMG$DELPFNLST    0000010A RG    04   PFN$V_LOC      = 00000000            PTE$V_TYP0     = 00000016            
MMG$INSPFNH      00000167 RG    04   PFN$V_MODIFY   = 00000007            PTE$V_TYP1     = 0000001A            
MMG$INSPFNT      000001A3 RG    04   PFN$V_PAGTYP   = 00000000            PTE$V_VALID    = 0000001F            
MMG$RELPFN       00000112 RG    04   PFN$V_PGFLX    = 00000018            PTE$V_WRT      = 00000012            
MMG$REMPFN       000000A2 RG    04   PFN$V_RPTEVT   = 00000006            SCH$GB_SIP       ********   X   04   
MMG$REMPFNH      00000097 RG    04   PRI$_IOCOM     = 00000001            SCH$GL_FREECNT = 0000000C RG    03   
MMG$RLPFNSAVPTE  000000F5 RG    04   PRI$_NULL      = 00000000            SCH$GL_FREELIM = 00000028 RG    03   
NOTEMPTY         000001E4 R     04   PRI$_RESAVL    = 00000002            SCH$GL_FREEREQ = 0000001C RG    03   
PFN$AB_STATE     ********   X   04   PRI$_TICOM     = 00000004            SCH$GL_MFYCNT  = 00000010 RG    03   
PFN$AB_TYPE      ********   X   04   PRI$_TIMER     = 00000002            SCH$GL_MFYLIM  = 00000020 RG    03   
PFN$AL_BAK       ********   X   04   PRI$_TOCOM     = 00000003            SCH$GL_MFYLIMSV  00000034 RG    03   
PFN$AL_COUNT     0000000C R     03   PTE$C_EOWN     = 00800000            SCH$GL_MFYLOLIM= 0000002C RG    03   
PFN$AL_HILIMIT   0000001C RG    03   PTE$C_ER       = 38000000            SCH$GL_MFYLOSV   00000038 RG    03   
PFN$AL_LOLIMIT   00000028 RG    03   PTE$C_ERKW     = 30000000            SCH$GQ_FPGWQ     ********   X   04   
PFN$AL_PTE       ********   X   04   PTE$C_EW       = 28000000            SCH$RSE          ********   X   04   
PFN$AW_BLINK     ********   X   04   PTE$C_KOWN     = 00000000            SCH$SWPWAKE      ********   X   04   
PFN$AW_FLINK     ********   X   04   PTE$C_KR       = 18000000            SCH$V_MPW        ********   X   04   
PFN$AW_HEAD      00000000 RG    03   PTE$C_KW       = 10000000            SWP$GL_BALSPT    ********   X   04   
PFN$AW_MFYLSTHD= 00000002 RG    03   PTE$C_NA       = 00000000            SWP$GL_BSLOTSZ   ********   X   04   
PFN$AW_REFCNT    ********   X   04   PTE$C_SOWN     = 01000000            VA$M_BYTE      = 000001FF            
PFN$AW_SWPVBN    ********   X   04   PTE$C_SR       = 58000000            VA$M_P1        = 40000000            
PFN$AW_TAIL      00000006 R     03   PTE$C_SREW     = 48000000            VA$M_SYSTEM    = 80000000            
PFN$C_ACTIVE   = 00000007            PTE$C_SRKW     = 50000000            VA$M_VPG       = FFFFFE00            
PFN$C_BADPAGLST= 00000002            PTE$C_SW       = 40000000            VA$M_VPN       = 3FFFFE00            
PFN$C_FREPAGLST= 00000000            PTE$C_UOWN     = 01800000            VA$S_BYTE      = 00000009            
PFN$C_GBLWRT   = 00000003            PTE$C_UR       = 78000000            VA$S_VPG       = 00000017            
PFN$C_GLOBAL   = 00000002            PTE$C_UREW     = 68000000            VA$S_VPN       = 00000015            
PFN$C_GPGTBL   = 00000005            PTE$C_URKW     = 70000000            VA$V_BYTE      = 00000000            
PFN$C_MFYPAGLST= 00000001            PTE$C_URSW     = 60000000            VA$V_P1        = 0000001E            
PFN$C_PPGTBL   = 00000004            PTE$C_UW       = 20000000            VA$V_SYSTEM    = 0000001F            
PFN$C_PROCESS  = 00000000            PTE$M_CRF      = 00010000            VA$V_VPG       = 00000009            
PFN$C_RDERR    = 00000004            PTE$M_DZRO     = 00020000            VA$V_VPN       = 00000009            
PFN$C_RDINPROG = 00000006            PTE$M_GPTX     = 003FFFFF            WAKESWAPPER      0000021C R     04   
PFN$C_RELPEND  = 00000003            PTE$M_MODIFY   = 04000000            WAKE_MPW         00000210 R     04   
PFN$C_SYSTEM   = 00000001            PTE$M_OWN      = 01800000            WAKFREPAGWAITQ   000001F7 R     04   
PFN$C_WRTINPROG= 00000005            PTE$M_PFN      = 001FFFFF            WASEMPTY         000001D7 R     04   
PFN$GL_PHYPGCNT  00000018 RG    03   PTE$M_PGFLVB   = 003FFFFF            WQH$C_LENGTH     0000000C            
PFN$M_BADPAG   = 00000020            PTE$M_PROT     = 78000000            WQH$K_LENGTH     0000000C            
PFN$M_BAK      = 007FFFFF            PTE$M_TYP0     = 00400000            WQH$L_WQBL       00000004            
PFN$M_COLLISION= 00000010            PTE$M_TYP1     = 04000000            WQH$L_WQFL       00000000            
PFN$M_DELCON   = 00000010            PTE$M_VALID    = 80000000            WQH$W_WQCNT      00000008            
PFN$M_GBLBAK   = 00800000            PTE$M_WRT      = 00040000            WQH$W_WQSTATE    0000000A            
ALLOCPFN        - PFN LIST MANIPULATING ROUTINES                 21-AUG-1978 19:37:05   VAX-11 MACRO X0.3-11               Page  17
PROGRAM SECTION SYNOPSIS                                                                                                        (10)



PROGRAM SECTION SYNOPSIS

.  ABS  .        00000000      00     NOPIC   USR   CON   ABS   LCL NOSHR NOEXE NORD  NOWRT BYTE  
. BLANK .        00000000      01     NOPIC   USR   CON   REL   LCL NOSHR   EXE   RD    WRT BYTE  
$ABS$            0000000C      02     NOPIC   USR   CON   ABS   LCL NOSHR   EXE   RD    WRT BYTE  
$$$210           0000003C      03     NOPIC   USR   CON   REL   LCL NOSHR   EXE   RD    WRT LONG  
$MMGCOD          00000220      04     NOPIC   USR   CON   REL   LCL NOSHR   EXE   RD    WRT BYTE  


THERE WERE NO ERRORS OR WARNINGS.
22048. BYTES LEFT IN FREE MEMORY POOL.
12. BYTES OF RECLAIMED MEMORY.
OBJ$:ALLOCPFN,LIS$:ALLOCPFN/-SP=EXECML$/ML,SRC$:ALLOCPFN
3 MLB DIR RDS - 252 GETS TO DEFINE 18 MACROS. 21 INTER. FILE WRITES. 
