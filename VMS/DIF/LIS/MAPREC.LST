FORTRAN IV-PLUS V02-51D		02:42:45    22-AUG-78		PAGE 1   
MAPREC.FTN   	/TR:BLOCKS/WR

        C
        C
        C
        C	MAPREC -- MAP A RECORD
        C
        C
        C
        C	COPYRIGHT (C) 1976,1977,1978
        C	DIGITAL EQUIPMENT CORPORATION, MAYNARD, MASS.
        C
        C	THIS SOFTWARE IS FURNISHED UNDER  A LICENSE FOR USE ONLY  ON  A
        C	SINGLE COMPUTER SYSTEM AND MAY BE  COPIED ONLY WITH  THE INCLU-
        C	SION OF  THE  ABOVE  COPYRIGHT NOTICE.  THIS SOFTWARE,  OR  ANY
        C	OTHER COPIES THEREOF, MAY NOT BE  PROVIDED  OR  OTHERWISE  MADE
        C	AVAILABLE TO ANY OTHER PERSON EXCEPT  FOR  USE  ON  SUCH SYSTEM
        C	AND TO  ONE WHO AGREES  TO  THESE LICENSE  TERMS.  TITLE TO AND
        C	OWNERSHIP OF THE SOFTWARE SHALL AT ALL TIMES REMAIN IN DEC.
        C
        C	THE INFORMATION IN THIS SOFTWARE  IS  SUBJECT TO CHANGE WITHOUT
        C	NOTICE AND SHOULD NOT BE CONSTRUED  AS  A COMMITMENT BY DIGITAL
        C	EQUIPMENT CORPORATION.
        C
        C	DEC ASSUMES NO RESPONSIBILITY FOR THE USE OR RELIABILITY OF ITS
        C	SOFTWARE ON EQUIPMENT WHICH IS NOT SUPPLIED BY DEC.
        C
        C
        C	K.D. MORSE	22-NOV-76
        C
        C
        C
        C	THIS ROUTINE HANDLES THE DATA RECORDING THE MAPPED RECORDS.
        C	IT KEEPS TWO BUFFERS OR MAPPING TABLES OF 100 WRODS EACH.
        C	IT ALSO REMEMBERS WHICH RECORD IS MAPPED IN THE FIRST POSITION
        C	IN THE TABLE.  WHEN THE TABLE IS FULL OR A REQUEST COMES TO MAP
        C	A VALUE NOT ABLE TO BE PLACED IN THE TABLE, MAPREC WRITES THE
        C	DATA TO A TEMPORARY FILE AND REINITIALIZES THE TABLE.
        C
        C
        C  MODIFICATIONS:
        C
        C  NO.		DATE		PROGRAMMER		PURPOSE
        C  --		----		----------		-------
        C
        C  01		26-APR-78	K.D. MORSE		MUST MAP ALL -2 VALUES.
        C							CAN IGNORE ONLY -1 VALUES.
FORTRAN IV-PLUS V02-51D		02:42:45    22-AUG-78		PAGE 2   
MAPREC.FTN   	/TR:BLOCKS/WR

         
        C
        C
        C  VARIABLES:
        C
        C	CLUN--LOGICAL UNIT NUMBER FOR OPENING COMPARE FILE CHANNEL
        C	IERR1--ERROR INDICATOR FROM FORTRAN ROUTINES
        C	IERR2--ERROR INDICATOR FROM MACRO ROUTINES
        C	ILUN--LOGICAL UNIT NUMBER FOR FILE OF RECORD BEING MAPPED
        C	IRECNM--RECORD NUMBER OF FILE BEING MAPPED
        C	LENGTH--LENGTH OF OUTPUT LINE
        C	LSTMAP--LAST RECORD MAPPED FROM THIS FILE
        C	LSTMAT--LAST RECORD MATCHED FROM THIS FILES
        C	MAP--MAPPING TABLE OF COMPARE FILE RECORDS ONTO INPUT FILE
        C		RECORDS, AND INPUT FILE RECORDS ONTO COMPARE FILE RECORDS
        C	MAPEND--RECORD NUMBER OF LAST RECORD THAT CAN BE MAPPED IN
        C		THE MAP TABLE
        C	MAPNAM--NAME OF MAP FILE
        C	MAPTOP--RECORD NUMBER OF THE FIRST RECORD THAT CAN BE MAPPED IN
        C		THE MAP TABLE
        C	MAPVAL--MAPPING VALUE FOR THIS PARTICULAR RECORD
        C	MLUN--MAP FILE LUN
        C	MNMLNG--LENGTH OF MAP FILE NAME
        C	MOUT--OUTPUT RECORD BUFFER
        C	NUMLIN--MAXIMUM NUMBER OF RECORDS PER FILE THAT CAN BE HELD IN
        C		THE MAP TABLE
FORTRAN IV-PLUS V02-51D		02:42:45    22-AUG-78		PAGE 3   
MAPREC.FTN   	/TR:BLOCKS/WR

         
0001    	SUBROUTINE MAPREC(ILUN,IRECNM,MAPVAL)
         
0002    	COMMON MAP(100,2),NUMLIN,MAPTOP(2),LSTMAP(2),MLUN,
        	1IHOLD(30,2),NINCOR,IFREE(2),IFIRST(2),LAST(2),MAXBUF,
        	2BUFR,ISWTCH,COMCHR,NSWVAL(10),LSTMAT(2),IRECSZ,
        	3MRKPNT(2,4),INOUT,MAPEND(2),LINSIZ,MAPNAM,MNMLNG,MTYPE,MSTAT
        	4,IERR1,IERR2,IKIND,OLUN,MAPMRK(3,2),MPRINT,BARCHR
         
0003    	BYTE BUFR(7680,2),COMCHR(16),MAPNAM(12),BARCHR
0004    	INTEGER MOUT(101),OLUN
         
         
        C
        C	DECIDE WHICH FILE IS REQUESTED.
        C
0005    	ISUB=1
0006    	IF (ILUN .EQ. 3) ISUB=2
        C
        C	IS THERE ROOM TO MAP THE VALUE INTO THIS TABLE?
        C
0007    	IF (IRECNM .GE. MAPTOP(ISUB)+NUMLIN) GOTO 10
        C
        C	YES, SET MAP VALUE AND LAST-RECORD-MAPPED.
        C
        C	FIRST CHECK THAT THE RECORD TO BE MAPPED IS INCLUDED WITHIN THIS MAP
        C	TABLE.  IF IT IS LESS THAN THE FIRST MAP RECORD IN THE TABLE (MAPTOP),
        C	THEN THE RECORD WAS PREVIOUSLY MAPPED.  IN THIS CASE, THIS MUST BE A
        C	CALL TO RE-MAP AN IGNORED RECORD, I.E., MAPVAL=-1.  THEREFORE, GO CHECK
        C	THAT IT IS INDEED AN IGNORED RECORD.  DON'T TRY TO MAP IT.
        C
0008    5	IF (IRECNM .LT. MAPTOP(ISUB)) GOTO 70
0009    	MAP(IRECNM-MAPTOP(ISUB)+1,ISUB)=MAPVAL
0010    	LSTMAP(ISUB)=IRECNM
0011    	GOTO 100
        C
        C	NO, MUST EMPTY TABLE AND SET UP NEW ONE.  RECORDS WRITTEN TO THE
        C	MAPPING FILE CONSIST OF THE FILE INDICATOR, ISUB, AND THEN THE
        C	MAPPED VALUES.
        C
0012    10	DO 6 LENGTH = NUMLIN,2,-1
0013    	IF (MAP(LENGTH,ISUB) .GT. 0) GOTO 7
0014    6	CONTINUE
0015    7	DO 8 KK = LENGTH,NUMLIN
0016    	IF (MAP(KK,ISUB) .EQ. 0) GOTO 9
0017    8	CONTINUE
0018    9	IF (KK .EQ. 1) GOTO 40
0019    	KK = KK - 1
0020    	MOUT(1)=ISUB
0021    	DO 11 I=1,KK
0022    11	MOUT(I+1)=MAP(I,ISUB)
0023    	LENGTH=2*(KK+1)
0024    	CALL PUTREC(MLUN,MOUT,IRECSZ,LENGTH,IERR2)
0025    	IF (IERR2 .LE. 0) GOTO 90
        C
        C	NOW RE-INITIALIZE TABLE.  FIRST MOVE UP THE UNMATCHED MAPPINGS.
FORTRAN IV-PLUS V02-51D		02:42:45    22-AUG-78		PAGE 4   
MAPREC.FTN   	/TR:BLOCKS/WR

        C	THEN FILL THE REMAINDER OF THE TABLE WITH ZEROS.
        C
0026    	IF (KK .EQ. NUMLIN) GOTO 20
0027    	DO 12 I=KK+1,NUMLIN
0028    12	MAP(I-KK,ISUB) = MAP(I,ISUB)
0029    	DO 13 J=1,KK
0030    13	MAP(NUMLIN-KK+J,ISUB)=0
0031    	GOTO 35
0032    20	DO 30 I=1,NUMLIN
0033    30	MAP(I,ISUB)=0
        C
        C	SET NEW RECORD NUMBER TO TOP ENTRY IN MAPPING TABLE.
        C
0034    35	MAPTOP(ISUB)=MAPTOP(ISUB)+KK
        C
        C	IF STILL CAN'T RECORD VALUE, WRITE OUT A TABLE'S WORTH OF
        C	UNMATCHED RECORDS AND TRY AGAIN.  THE ONE EXCEPTION IS IF THE MAPPING
        C	IS FOR AN IGNORED RECORD.  IN THIS CASE, DO NOT BOTHER TO MAP IT.
        C	(OUTPUTING THE MAPPING TABLE FOR AN IGNORED RECORD MIGHT CAUSE SOME
        C	UNMATCHED RECORDS IN IT TO BE MAPPED AFTER THE TABLE FOR THEM HAD BEEN
        C	WRITTEN.  THIS IS THE CASE WHEN THERE ARE LARGE NUMBERS OF IGNORED
        C	RECORDS IN ONE FILE BETWEEN UNMATCHED RECORDS.)
        C
0035    40	IF (IRECNM .LE. MAPTOP(ISUB)+NUMLIN) GOTO 5
0036    	IF (MAPVAL .EQ. -1) GOTO 100
0037    	LENGTH=2*(1+NUMLIN)
0038    	MOUT(1)=ISUB
0039    	DO 45 I=1,NUMLIN
0040    45	MOUT(I+1)=MAP(I,ISUB)
0041    	CALL PUTREC(MLUN,MOUT,MAXBUF,LENGTH,IERR2)
0042    	IF (IERR2 .LE. 0) GOTO 90
0043    	MAPTOP(ISUB)=MAPTOP(ISUB)+NUMLIN
0044    	GOTO 40
         
        C
        C	THE MAP TABLE FOR THE RECORD TO BE MAPPED HAS ALREADY BEEN WRITTEN
        C	TO THE FILE.  THIS SHOULD ONLY OCCUR FOR IGNORED RECORDS, I.E.,
        C	MAPVAL < 0.  IF THIS RECORD IS NOT IGNORED, THEN THERE IS A PROGRAM
        C	CODING ERROR.
        C
0045    70	IF (MAPVAL .EQ. -1) GOTO 100
0046    	IERR = 0
0047    	GOTO 100
0048    90	IERR1=-26
0049    100	RETURN
0050    	END
FORTRAN IV-PLUS V02-51D		02:42:45    22-AUG-78		PAGE 5   
MAPREC.FTN   	/TR:BLOCKS/WR

PROGRAM SECTIONS

NUMBER	 NAME	    SIZE		ATTRIBUTES

  1	$CODE1	001240   336		RW,I,CON,LCL
  3	$IDATA	000030    12		RW,D,CON,LCL
  4	$VARS	000326   107		RW,D,CON,LCL
  5	$TEMPS	000004     2		RW,D,CON,LCL
  6	.$$$$.	037222  8009		RW,D,OVR,GBL


ENTRY POINTS

 NAME   TYPE  ADDRESS    NAME   TYPE  ADDRESS    NAME   TYPE  ADDRESS    NAME   TYPE  ADDRESS    NAME   TYPE  ADDRESS   

 MAPREC	      1-000000


VARIABLES

 NAME   TYPE  ADDRESS    NAME   TYPE  ADDRESS    NAME   TYPE  ADDRESS    NAME   TYPE  ADDRESS    NAME   TYPE  ADDRESS   

 BARCHR	L*1   6-037220	 I	I*2   4-000320	 IERR	I*2   4-000324	 IERR1	I*2   6-037172	 IERR2	I*2   6-037174
 IKIND	I*2   6-037176	 ILUN	I*2   F-000002*	 INOUT	I*2   6-037140	 IRECNM	I*2   F-000004*	 IRECSZ	I*2   6-037116
 ISUB	I*2   4-000312	 ISWTCH	I*2   6-037044	 J	I*2   4-000322	 KK	I*2   4-000316	 LENGTH	I*2   4-000314
 LINSIZ	I*2   6-037146	 MAPVAL	I*2   F-000006*	 MAXBUF	I*2   6-001042	 MLUN	I*2   6-000632	 MNMLNG	I*2   6-037164
 MPRINT	I*2   6-037216	 MSTAT	I*2   6-037170	 MTYPE	I*2   6-037166	 NINCOR	I*2   6-001024	 NUMLIN	I*2   6-000620
 OLUN	I*2   6-037200


ARRAYS

 NAME   TYPE  ADDRESS	    SIZE 	DIMENSIONS

 BUFR	L*1   6-001044	036000  7680	(7680,2)
 COMCHR	L*1   6-037046	000020     8	(16)
 IFIRST	I*2   6-001032	000004     2	(2)
 IFREE	I*2   6-001026	000004     2	(2)
 IHOLD	I*2   6-000634	000170    60	(30,2)
 LAST	I*2   6-001036	000004     2	(2)
 LSTMAP	I*2   6-000626	000004     2	(2)
 LSTMAT	I*2   6-037112	000004     2	(2)
 MAP	I*2   6-000000	000620   200	(100,2)
 MAPEND	I*2   6-037142	000004     2	(2)
 MAPMRK	I*2   6-037202	000014     6	(3,2)
 MAPNAM	L*1   6-037150	000014     6	(12)
 MAPTOP	I*2   6-000622	000004     2	(2)
 MOUT	I*2   4-000000	000312   101	(101)
 MRKPNT	I*2   6-037120	000020     8	(2,4)
 NSWVAL	I*2   6-037066	000024    10	(10)


LABELS

 LABEL   ADDRESS 	 LABEL   ADDRESS 	 LABEL   ADDRESS 	 LABEL   ADDRESS 	 LABEL   ADDRESS 	

FORTRAN IV-PLUS V02-51D		02:42:45    22-AUG-78		PAGE 6   
MAPREC.FTN   	/TR:BLOCKS/WR

 5	 1-000072	 6	    **   	 7	 1-000252	 8	    **   	 9	 1-000336
 10	 1-000166	 11	    **   	 12	    **   	 13	    **   	 20	 1-000670
 30	    **   	 35	 1-000746	 40	 1-000770	 45	    **   	 70	 1-001176
 90	 1-001222	 100	 1-001236


FUNCTIONS AND SUBROUTINES REFERENCED

 PUTREC


TOTAL SPACE ALLOCATED = 041044  8466

NO FPP INSTRUCTIONS GENERATED

OBJ$:MAPREC,LIS$:MAPREC/-SP=SRC$:MAPREC
