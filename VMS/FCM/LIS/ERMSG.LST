ERMSG	MACRO M1110  21-AUG-78 23:21  PAGE 2


      1						.TITLE	ERMSG
      2						.IDENT	/02/
      3
      4					;
      5					; COPYRIGHT (C) 1977
      6					; DIGITAL EQUIPMENT CORPORATION, MAYNARD, MASS.
      7					;
      8					; THIS SOFTWARE IS FURNISHED UNDER A LICENSE FOR USE ONLY ON A
      9					; SINGLE COMPUTER SYSTEM AND MAY  BE  COPIED   ONLY  WITH  THE
     10					; INCLUSION OF THE ABOVE COPYRIGHT NOTICE.  THIS SOFTWARE,  OR
     11					; ANY OTHER COPIES THEREOF, MAY NOT BE PROVIDED  OR  OTHERWISE
     12					; MADE AVAILABLE TO ANY OTHER PERSON   EXCEPT FOR  USE ON SUCH
     13					; SYSTEM AND TO ONE WHO AGREES TO THESE LICENSE  TERMS.  TITLE
     14					; TO AND OWNERSHIP OF THE SOFTWARE SHALL AT ALL  TIMES  REMAIN
     15					; IN DEC.
     16					;
     17					; THE INFORMATION IN THIS DOCUMENT IS SUBJECT TO CHANGE WITHOUT
     18					; NOTICE AND SHOULD NOT BE CONSTRUED AS A COMMITMENT BY DIGITAL
     19					; EQUIPMENT CORPORATION.
     20					;
     21					; DEC ASSUMES NO RESPONSIBILITY FOR THE USE OR RELIABILITY OF
     22					; ITS SOFTWARE ON EQUIPMENT WHICH IS NOT SUPPLIED BY DEC.
     23					;
     24					;
     25					; VERSION 02
     26					;
     27					; C. MONIA 12-NOV-75
     28					;
     29					;
     30					; MODIFICATIONS:
     31					;
     32					;	JAK001	8-17-77		ADD EXIT WITH STATUS
     33					;
     34					; PATCH ERROR OUTPUT ROUTINE
     35					;
     36					; MACRO LIBRARY CALLS
     37					;
     38
     39						.IF NDF	R$$11M                                                          ; CM002
     40					                                                                                ; CM002
     41						.MCALL	PUT$S                                                           ; CM002
     42					                                                                                ; CM002
     43						.IFF                                                                    ; CM002
     44					                                                                                ; CM002
     45						.MCALL	DIR$,QIO$,WTSE$S                                                ; CM002
     46					                                                                                ; CM002
     47						.ENDC                                                                   ; CM002
     48					                                                                                ; CM002
     49					;
     50					; EQUATED SYMBOLS
     51					;
     52
     53		000000 			S$V0==0				; SEVERITY CODE 0 (NON-FATAL)
     54		000001 			S$V1==1				; SEVERITY CODE 1 (FATAL IF CMD. DEV NOT TERMINAL)
     55		000002 			S$V2==2				; SEVERITY CODE 2 (FATAL)
     56
     57					;
ERMSG	MACRO M1110  21-AUG-78 23:21  PAGE 2-1


     58					; LOCAL DATA
     59					;
     60					; COMMAND INPUT DEVICE CHARACTERISTICS FLAGS
     61					;
     62
     63	000000				CMFLG:	.BLKW	1		;
     64
     65					;
     66					; MESSAGE TEXT PREFIX FORMAT STRINGS
     67					;
     68
     69	000002	000044'			ERFMT:	.WORD	DIAG		; SEVERITY 0 PREFIX
     70	000004	000044'				.WORD	DIAG		; SEVERITY 1 PREFIX
     71	000006	000051'				.WORD	FATAL		; SEVERITY 2 PREFIX
     72					                                                                                ; CM002
     73						.IF DF	R$$11M                                                          ; CM002
     74					                                                                                ; CM002
     75					;                                                                               ; CM002
     76					; ERROR MESSAGE OUTPUT QIO DPB                                                  ; CM002
     77					;                                                                               ; CM002
     78					                                                                                ; CM002
     79	000010				MGDPB:	QIO$	IO.WVB,2,3,,MGSTS,,<$ERBF,,40>                                  ; CM002
     80					                                                                                ; CM002
     81					;                                                                               ; CM002
     82					; I/O STATUS DOUBLE WORD                                                        ; CM002
     83					;                                                                               ; CM002
     84					                                                                                ; CM002
     85	000040				MGSTS:	.BLKW	2		;                                               ; CM002
     86					                                                                                ; CM002
     87						.ENDC                                                                   ; CM002
     88					                                                                                ; CM002
     89
     90					;
     91					; PREFIX FORMAT STRINGS
     92					;
     93
     94	000044	   104 	   111 	   101 	DIAG:	.ASCIZ	/DIAG/		;
	000047	   107 	   000
     95	000051	   106 	   101 	   124 	FATAL:	.ASCIZ	/FATAL/		;
	000054	   101 	   114 	   000
     96	000057	   052 	   055 	   000 	SUFFIX:	.ASCIZ	/*-/
     97
     98						.EVEN
     99
    100					;+
    101					; **-$ERMSG-ERROR MESSAGE OUTPUT ROUTINE
    102					; **-$ERTRP-TRAP ENTRY POINT FOR ERROR MESSAGE HANDLER
    103					;
    104					; THIS ROUTINE IS ENTERED THROUGH ONE OF THE ABOVE ENTRY
    105					; POINTS TO OUTPUT ERROR MESSAGES. THE SEVERITY IS USED TO
    106					; SELECT A PREFIX THAT IS TO BE OUTPUT ALONG WITH
    107					; THE MESSAGE. THE ERROR NUMBER SPECIFIES AN ERROR FOR-
    108					; MAT WHICH IS PASSED TO $EDMSG TO EDIT THE OUTPUT STRING.
    109					; SEVERITY 2 ERRORS ALWAYS CAUSE PROCESSING TO TERMINATE VIA
    110					; A TRANSFER OF CONTROL TO $EXIT.
    111					;
    112					; SEVERITY 1 ERRORS CAUSE THE TASK TO TERMINATE COMMAND
ERMSG	MACRO M1110  21-AUG-78 23:21  PAGE 2-2


    113					; PROCESSING IF COMMAND INPUT IS NOT COMING FROM A TERMINAL
    114					; DEVICE.
    115					;
    116					; INPUTS:
    117					;
    118					;	R0=ADDRESS OF GCML CONTROL BLOCK
    119					;	R1=ERROR/SEVERITY
    120					;	R2=ARGUMENT BLOCK ADDRESS
    121					;
    122					; OUTPUTS:
    123					;
    124					;	THE ERROR MESSAGE IS TRANSMITTED TO THE TERMINAL OUTPUT
    125					;	DEVICE. SEVERITY 0 ERRORS RESULT IN A RETURN TO THE CALLER.
    126					;	SEVERITY 1 ERRORS CAUSE PROCESSING TO BE TERMINATED UNLESS
    127					;	INPUT IS COMING FROM A TERMINAL. SEVERITY 2 ERRORS
    128					;	ARE ALWAYS FATAL (EXIT IS VIA A JUMP TO $EXIT).
    129					;
    130					;-
    131
    132	000062				$ERTRP::			;
    133	000062					CALL	$ERMSG		; CALL ERROR MESSAGE PROCESSOR
    134	000066	000002 				RTI			; EXIT SST
    135
    136	000070				$ERMSG::			;
    137	000070					SAVRG			; SAVE NON-VOLATILE REGISTERS
    138	000074	116067 	000000G	177676 		MOVB	F.RCTL(R0),CMFLG ; SAVE DEVICE CHARACTERISTIC FLAGS
    139	000102				10$:				;
    140	000102	010205 				MOV	R2,R5		; COPY ARGUMENT POINTER
    141	000104	010104 				MOV	R1,R4		; COPY ERROR/SEVERITY
    142	000106	012700 	177774G			MOV	#$EPTR-4,R0	; GET ADDRESS OF ERROR DES. MINUS OFFSET
    143	000112				20$:				;
    144	000112	022020 				CMP	(R0)+,(R0)+	; POINT TO NEXT STRING DESCRIPTOR
    145	000114	005710 				TST	(R0)		; AT END OF LIST?
    146	000116	001516 				BEQ	40$		; IF EQ YES
    147	000120	121004 				CMPB	(R0),R4		; ERROR NUMBER AGREE?
    148	000122	001373 				BNE	20$		; IF NE NO
    149	000124	010003 				MOV	R0,R3		; SAVE R0
    150	000126	105001 				CLRB	R1		; CLEAR ERROR NUMBER
    151	000130	000301 				SWAB	R1		; POSITION SEVERITY TO LOW BYTE
    152	000132	120127 	000002 			CMPB	R1,#S$V2	; LEGAL SEVERITY?
    153	000136	101106 				BHI	40$		; IF HI NO
    154	000140	001405 				BEQ	25$		; IF EQ DON'T INCREMENT
    155	000142	132767 	000000G	177630 		BITB	#FD.TTY,CMFLG	; TERMINAL COMMAND INPUT?
    156	000150	001001 				BNE	25$		; IF NE YES
    157	000152	005201 				INC	R1		; INCREMENT SEVERITY
    158	000154				25$:				;
    159	000154	006301 				ASL	R1		; CONVERT SEVERITY TO WORD OFFSET
    160	000156	010146 				MOV	R1,-(SP)	; SAVE OFFSET
    161	000160	012700 	000000G			MOV	#$ERBF,R0	; GET ADDRESS OF ERROR MESSAGE BUFFER
    162	000164	012701 	000000G			MOV	#$PRFIX,R1	; GET ADDRESS OF PREFIX STRING
    163	000170					CALL	$EDMSG		; EDIT PREFIX STRING
    164	000174	012602 				MOV	(SP)+,R2	; GET SEVERITY-DEPENDANT OFFSET
    165	000176	016201 	000002'			MOV	ERFMT(R2),R1	; GET ADDRESS OF FORMAT STRING
    166	000202					CALL	$EDMSG		; EDIT PREFIX STRING
    167	000206	012701 	000057'			MOV	#SUFFIX,R1	; POINT TO SUFFIX STRING
    168	000212					CALL	$EDMSG		; EDIT SUFFIX STRING
    169	000216	016301 	000002 			MOV	2(R3),R1	; GET ADDRESS OF TEXT STRING
ERMSG	MACRO M1110  21-AUG-78 23:21  PAGE 2-3


    170	000222	010502 				MOV	R5,R2		; GET PARAMETER LIST ADDRESS
    171	000224					CALL	$EDMSG		; EDIT ERROR MESSAGE TEXT
    172	000230	010002 				MOV	R0,R2		; COPY ADDRESS OF NEXT BYTE
    173	000232	012701 	000000G			MOV	#$ERBF,R1	; GET ADDRESS OF BUFFER
    174	000236	160102 				SUB	R1,R2		; COMPUTE LENGTH OF OUTPUT STRING
    175					                                                                                ; CM002
    176						.IF DF	R$$11M                                                          ; CM002
    177					                                                                                ; CM002
    178	000240	010267 	177562 			MOV	R2,MGDPB+Q.IOPL+2 ; SET BYTE COUNT                              ; CM002
    179	000244					DIR$	#MGDPB,35$	; ISSUE ERROR MESSAGE                           ; CM002
    180	000260					WTSE$S	#3		; WAIT FOR COMPLETION                           ; CM002
    181	000272	105767 	177542 			TSTB	MGSTS		; TEST RESULT                                   ; CM002
    182	000276	100421 				BMI	35$		; IF MI DEVICE ERROR                            ; CM002
    183					                                                                                ; CM002
    184						.IFF                                                                    ; CM002
    185					                                                                                ; CM002
    186						PUT$S	#$PTEDB,R1,R2	; OUTPUT ERROR MESSAGE                          ; CM002
    187						BCS	30$		; IF C/S LEAVE QUIETLY                          ; CM002
    188					                                                                                ; CM002
    189						.ENDC                                                                   ; CM002
    190					                                                                                ; CM002
    191	000300	000304 				SWAB	R4		; POSITION SEVERITY TO LOW BYTE
    192	000302	120427 	000001 			CMPB	R4,#S$V1	; FATAL ERROR?
    193	000306	101010 				BHI	30$		; IF HIS YES
    194	000310	022767 	000000G	000000G		CMP	#EX$ERR,$EXSTS	; STATUS GREATER THEN CURRENT?			;JAK001
    195	000316	101403 				BLOS	27$		; IF LOS YES					;JAK001
    196	000320	012767 	000000G	000000G		MOV	#EX$ERR,$EXSTS	; SET STATUS TO ERROR				;JAK001
    197	000326				27$:										;JAK001
    198	000326					RETURN			;
    199	000330				30$:				;
    200	000330	012767 	000000G	000000G		MOV	#EX$SEV,$EXSTS	; SET EXIT STATUS TO SEVERE			;JAK001
    201	000336	000167 	000000G			JMP	$RSTRT		; CLOSE ALL FILES, RESTART
    202
    203	000342				35$:				;
    204	000342	012767 	000000G	000000G		MOV	#EX$SEV,$EXSTS	; SET EXIT STATUS TO SEVERE			;JAK001
    205	000350	000167 	000000G			JMP	$EXIT		; CLOSE ALL FILES, EXIT
    206					;
    207					; ILLEGAL ERROR/SEVERITY CODE
    208					;
    209
    210	000354				40$:				;
    211	000354	010546 				MOV	R5,-(SP)	; PUSH PARAMETER LIST ADDRESS
    212	000356	010446 				MOV	R4,-(SP)	; PUSH ERROR/SEVERITY
    213	000360	010602 				MOV	SP,R2		; SET PARAMETER LIST ADDRESS
    214	000362	012701 	000000C			MOV	#<S$V2*400!E$R0>,R1 ; SET NEW ERROR/SEVERITY
    215	000366	000645 				BR	10$		; REPORT FATAL ERROR
    216
    217		000001 				.END
ERMSG	MACRO M1110  21-AUG-78 23:21  PAGE 2-4
SYMBOL TABLE

CMFLG   000000R  	FF    = 000014   	Q.IOFN= 000002   	S$V1  = 000001 G 	$EXSTS= ****** GX
CR    = 000015   	F.RCTL= ****** GX	Q.IOLU= 000004   	S$V2  = 000002 G 	$PRFIX= ****** GX
DIAG    000044R  	HT    = 000011   	Q.IOPL= 000014   	VT    = 000013   	$RSTRT= ****** GX
ERFMT   000002R  	IO.WVB= ****** GX	Q.IOPR= 000007   	$EDMSG= ****** GX	$SAVRG= ****** GX
EX$ERR= ****** GX	LF    = 000012   	Q.IOSB= 000010   	$EPTR = ****** GX	$$    = 000001
EX$SEV= ****** GX	MGDPB   000010R  	R$$11M= 000000   	$ERBF = ****** GX	$$$ARG= 000003
E$R0  = ****** GX	MGSTS   000040R  	SPA   = 000040   	$ERMSG  000070RG 	$$$OST= 000014
FATAL   000051R  	Q.IOAE= 000012   	SUFFIX  000057R  	$ERTRP  000062RG 	$$$T1 = 000067
FD.TTY= ****** GX	Q.IOEF= 000006   	S$V0  = 000000 G 	$EXIT = ****** GX

. ABS.	000000	   000
      	000370	   001
ERRORS DETECTED:  0

VIRTUAL MEMORY USED:  1631 WORDS  ( 7 PAGES)
DYNAMIC MEMORY:  2772 WORDS  ( 10 PAGES)
ELAPSED TIME:  00:00:12
OBJ$:ERMSG,LIS$:ERMSG/-SP=SRC$:MACFLM,ERMSG
