GETBUF - ALLOCATE TEMP LINE BUF	MACRO M1110  22-AUG-78 05:30  PAGE 2


    100						.TITLE	GETBUF - ALLOCATE TEMP LINE BUFFER
    200					;
    300					; COPYRIGHT 1976, DIGITAL EQUIPMENT CORP., MAYNARD, MASS. 01754
    400					;
    500					; DEC ASSUMES NO RESPONSIBILITY FOR THE USE OR RELIABILITY OF ITS
    600					; SOFTWARE ON EQUIPMENT WHICH IS NOT SUPPLIED BY DEC.
    700					;
    800					; THIS SOFTWARE IS FURNISHED TO PURCHASER UNDER A LICENSE FOR USE
    900					; ON A SINGLE COMPUTER SYSTEM AND CAN BE COPIED (WITH INCLUSION
   1000					; OF DEC'S COPYRIGHT NOTICE) ONLY FOR USE IN SUCH SYSTEM, EXCEPT
   1100					; AS MAY OTHERWISE BE PROVIDED IN WRITING BY DEC.
   1200					;
   1300					; THE INFORMATION IN THIS DOCUMENT IS SUBJECT TO CHANGE WITHOUT
   1400					; NOTICE AND SHOULD NOT BE CONSTRUED AS A COMMITMENT BY DIGITAL
   1500					; EQUIPMENT CORPORATION.
   1600					;
   1700					;	01-AUG-77	BILL MARSHALL
   1800					;
   1900						.MCALL	CCML$
   2000
   2100
   2200					;	GETBUF(SPACE) - CALLED TO ALLOCATE A TEMPORARY BUFFER
   2300					;		OF INDICATED SIZE, TO BE USED FOR AT MOST UNTIL
   2400					;		THE NEXT COMMAND IS TYPED.
   2500					;		BUFFER SPACE IS ALLOCATED OUT OF THE FSR REGION,
   2600					;		AND THE COMMAND FILE IS CLOSED IF NECESSARY.
   2700					;
   2800					;		A CORRESPONDING CALL MUST BE MADE TO RLSBUF() BEFORE
   2900					;		THE NEXT COMMAND IS READ.
   2920
   2940	000000					CODE$	GTBF
   3000
   3100	000000	004167 	000000G		GETBUF::JSR	R1,$SAV2		; SAVE REGISTERS WE CHANGE
   3200	000004	016601 	000010 			MOV	10(SP),R1		; AMOUNT OF SPACE NEEDED
   3300	000010	020167 	000002G			CMP	R1,BUFPTR+2		; TEST AMOUNT ALREADY HAVE
   3400	000014	003434 				BLE	20$			; HAVE ENOUGH ALREADY
   3500	000016	005767 	000002G			TST	BUFPTR+2		; HAVE WE ANY?
   3600	000022	001402 				BEQ	5$			; NO
   3700	000024	004767 	000060 			JSR	PC,RLSBUF		; RELEASE ANY IF WE HAVE ONE NOW
   3800	000030	013700 	000000G		5$:	MOV	@#.FSRPT,R0		; BUFFER HEADER
   3900	000034	004767 	000000G			JSR	PC,$RQCB		; REQUEST CORE BLOCK
   4000	000040	103016 				BCC	15$			;WE GOT IT!!
   4100	000042					CCML$	#GCMLB			; CLOSE COMMAND FILE
   4200	000052	013700 	000000G			MOV	@#.FSRPT,R0		;NOW TRY AGAIN
   4300	000056	004767 	000000G			JSR	PC,$RQCB
   4400	000062	103005 				BCC	15$			; GOT IT NOW
   4500	000064	012746 	000002 			MOV	#2,-(SP)		; ELSE ERROR - ABORT COMMAND
   4600	000070	005046 				CLR	-(SP)			; INTERNAL ERROR
   4700	000072	004767 	000000G			JSR	PC,SOSERR		; CALL ERROR HANDLER
   4800	000076	010067 	000000G		15$:	MOV	R0,BUFPTR		; SAVE POINTER TO SPACE
   4900	000102	010167 	000002G			MOV	R1,BUFPTR+2		; AND LENGTH OF IT
   5000	000106	000207 			20$:	RTS	PC			; AND RETURN TO CALLER
   5100
   5200
   5300
   5400					;	RLSBUF() - CALLED TO RELEASE THE ABOVE ALLOCATED BUFFER
   5500
GETBUF - ALLOCATE TEMP LINE BUF	MACRO M1110  22-AUG-78 05:30  PAGE 2-1


   5600	000110	004167 	000000G		RLSBUF::JSR	R1,$SAV2		; NEED R1 AND R2
   5700	000114	016702 	000000G			MOV	BUFPTR,R2		; ADDRESS OF AREA
   5800	000120	001406 				BEQ	10$			; NONE
   5900	000122	016701 	000002G			MOV	BUFPTR+2,R1		; LENGTH OF AREA
   6000	000126	013700 	000000G			MOV	@#.FSRPT,R0		; FREE CHAIN HEAD
   6100	000132	004767 	000000G			JSR	PC,$RLCB		; RELEASE CORE BLOCK
   6200	000136	005067 	000000G		10$:	CLR	BUFPTR			; CLEAR POINTER TO BUFFER
   6300	000142	005067 	000002G			CLR	BUFPTR+2		; AND LENGTH
   6400	000146	000207 				RTS	PC			; RETURN
   6500
   6600		000001 				.END
GETBUF - ALLOCATE TEMP LINE BUF	MACRO M1110  22-AUG-78 05:30  PAGE 2-2
SYMBOL TABLE

BUFPTR= ****** GX	PAR$$$= 000027   	R$$EIS= 000001   	$RLCB = ****** GX	.FSRPT= ****** GX
GCMLB = ****** GX	RLSBUF  000110RG    002	R$$SHR= 000001   	$RQCB = ****** GX	.GCML3= ****** G
GETBUF  000000RG    002	RONLY$= 000001   	SOSERR= ****** GX	$SAV2 = ****** GX

. ABS.	000000	   000
      	000000	   001
CODE  	000150	   002
ERRORS DETECTED:  0

VIRTUAL MEMORY USED:  798 WORDS  ( 4 PAGES)
DYNAMIC MEMORY:  2772 WORDS  ( 10 PAGES)
ELAPSED TIME:  00:00:04
OBJ$:GETBUF,LIS$:GETBUF/-SP/NL:TOC=SRC$:PREFIX,GETBUF
