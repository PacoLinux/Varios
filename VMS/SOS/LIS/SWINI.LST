SWINI - SWITCH INITIAILIZATION	MACRO M1110  22-AUG-78 05:36  PAGE 2


    100						.TITLE	SWINI - SWITCH INITIAILIZATION
    200						.IDENT	/0102/
    300					;
    400					; COPYRIGHT 1976, DIGITAL EQUIPMENT CORP., MAYNARD, MASS. 01754
    500					;
    600					; DEC ASSUMES NO RESPONSIBILITY FOR THE USE OR RELIABILITY OF ITS
    700					; SOFTWARE ON EQUIPMENT WHICH IS NOT SUPPLIED BY DEC.
    800					;
    900					; THIS SOFTWARE IS FURNISHED TO PURCHASER UNDER A LICENSE FOR USE
   1000					; ON A SINGLE COMPUTER SYSTEM AND CAN BE COPIED (WITH INCLUSION
   1100					; OF DEC'S COPYRIGHT NOTICE) ONLY FOR USE IN SUCH SYSTEM, EXCEPT
   1200					; AS MAY OTHERWISE BE PROVIDED IN WRITING BY DEC.
   1300					;
   1400					; THE INFORMATION IN THIS DOCUMENT IS SUBJECT TO CHANGE WITHOUT
   1500					; NOTICE AND SHOULD NOT BE CONSTRUED AS A COMMITMENT BY DIGITAL
   1600					; EQUIPMENT CORPORATION.
   1700					;
   1800					; PETER H. LIPMAN	27-FEB-76
   1900					;
   1910						.MCALL	CSI$,FDOF$L,FCSBT$,IOERR$
   1955	000000					CSI$
   1960	000000					FDOF$L
   1965	000000					FCSBT$
   1970	000000					IOERR$
   1975
   2000						.MCALL	FDBDF$,NMBLK$,FDRC$R,FDOP$R,OFNB$R,GET$S,CLOSE$
   2050						.MCALL	CALL,RETURN,CSI$1,CSI$2
   2100
   2120	000000					PLIT$	SWIN
   2140
   2200	000000				SWFNM:	NMBLK$	SWITCH,INI,,SY,0
   2210
   2220	000036					DATA$	SWIN
   2230
   2300	000000				SWFDB:	FDBDF$
   2400
   2600					;
   2700					; INPUT:
   2800					;	R0=CSI CONTROL BLOCK
   2850					;	(R0) = LUN TO USE IN OPENING THE FILE
   2900					;	C.SWAD(R0) = SWITCH TABLE ADDRESS
   3000					;	C.DEVD(R0) = SIZE OF PROGRAM NMAE STRING OR 0 IF ASCIZ
   3100					;	C.DEVD+2(R0) = ADR PF PROGRAM NAME STRING
   3200					;	C.DIRD(R0) = SIZE OF OPTION NAME SRRING OR 0 IF ASCIZ
   3300					;	C.DIRD+2(R0) = ADR OF OPTION NAME STRING , 0 IF NO OPTION NAME
   3400					;
   3500					; OUTPUT:
   3600					;	C=0 IF OK, C=1 IF ERROR
   3700					;	IF C=0
   3800					;	C.FILD, C.FILD+2 = 0
   4000					;	IF C=1
   4100					;	C.FILD, C.FILD+2 = SIZE, ADR OF BAD RECORD IN SWITCH.INI
   4200					;	OR
   4300					;	C.FILD = 0, C.FILD+2 = F.ERR FROM FCS
   4400					;
SWINI - SWITCH INITIAILIZATION	MACRO M1110  22-AUG-78 05:36  PAGE 3


     10	000140					CODE$	SWIN
     20
    100	000000	004567 	000000G		.SWINI::JSR	R5,.SAVR1
    200	000004	010005 				MOV	R0,R5		;R5=CSI BLOCK ADR
    216	000006	016046 	000022 			MOV	C.SWAD(R0),-(SP) ;SAVE THIS , CSI1 CLEARS IT
    233	000012	005046 				CLR	-(SP)		;INIT C.MKW1 SAVE WORD
    266	000014	005046 				CLR	-(SP)		;INIT C.MKW2 SAVE WORD
    300	000016	005002 				CLR	R2		;OPTION NAME SIZE IF NO OPTION
    400	000020	016501 	000014 			MOV	C.DIRD+2(R5),R1 ;OPTION NAME ADR
    500	000024	001405 				BEQ	20$		;BRANCH IF NO OPTION SPECIFIED
    600	000026	016502 	000012 			MOV	C.DIRD(R5),R2	;OPTION SIZE
    700	000032	001002 				BNE	20$		;IF NON ZERO
    800	000034					CALL	GETSIZ		;OTHERWISE, GET SIZE
    900	000040	010246 			20$:	MOV	R2,-(SP)	;SAVE OPTION NAME SIZE
   1000	000042	010146 				MOV	R1,-(SP)	;AND ADDRESS
   1100	000044	016501 	000010 			MOV	C.DEVD+2(R5),R1 ;ADR OF PROGRAM NAME
   1200	000050	016502 	000006 			MOV	C.DEVD(R5),R2	;AND SIZE
   1300	000054	001002 				BNE	30$
   1400	000056					CALL	GETSIZ		;0 SIZE MEANS ASCIZ, GET SIZE
   1500	000062	010246 			30$:	MOV	R2,-(SP)	;SAVE SIZE, POSSIBLY 0
   1600	000064	010146 				MOV	R1,-(SP)	;AND ADR OF PROG NAME
   1700	000066	016501 	000004 			MOV	C.CMLD+2(R5),R1	;ADR OF RECORD BUFFER
   1800	000072	016502 	000002 			MOV	C.CMLD(R5),R2	;SIZE OF RECORD BUFFER
   1900	000076	112721 	000057 			MOVB	#'/,(R1)+	;INIT WITH LEAD "/"
   2000	000102	005302 				DEC	R2		;AND ADJUST SIZE
   2100	000104					FDRC$R	#SWFDB,,R1,R2	;SET UP RECORD BUFFER
   2150	000120					FDOP$R	R0,(R5)		;AND LUN
   2200	000124	012701 	000102'			MOV	#SWFDB+F.FNB,R1
   2300	000130	005002 				CLR	R2
   2400	000132	012703 	000000'			MOV	#SWFNM,R3
   2500	000136					CALL	.PARSE
   2600	000142	103524 				BCS	CHKNSF
   2700	000144					OFNB$R	R0		;OPEN SWITCH.INI
   2800	000156	103516 				BCS	CHKNSF
   2900	000160				50$:	GET$S	#SWFDB		;GET THE NEXT RECORD
   3000	000170	103504 				BCS	CHKEOF		;IF ERROR, THEN DONE
   3100	000172	016001 	000026 			MOV	F.NRBD+2(R0),R1	;ADR OF RECORD
   3200	000176	016002 	000024 			MOV	F.NRBD(R0),R2	;AND ITS SIZE
   3300	000202	001766 				BEQ	50$		;ALLOW NULL RECORDS
   3400	000204	005301 				DEC	R1		;INCLUDE THE "PLANTED" /
   3500	000206	005202 				INC	R2
   3600	000210					CSI$1	R5,R1,R2	;CHECK THE LINE'S SYNTAX
   3700	000226	103502 				BCS	BADLIN		;BRANCH IF NO GOOD
   3733	000230	132760 	000067 	000001 		BITB	#CS.EQU!CS.MOR!CS.DVF!CS.DIF!CS.NMF,C.STAT(R0)
   3766	000236	001076 				BNE	BADLIN		;ONLY SWITCHES AND VALUES ALLOWED
   3800	000240	005201 				INC	R1		;POINT TO 1ST CHAR OF PROG NAME
   3900	000242	016502 	000002 			MOV	C.CMLD(R5),R2	;GET POSSIBLY COMPACTED SIZE
   4000	000246	005302 				DEC	R2		;AND ACCOUNT FOR THE /
   4050	000250	010267 	000024'			MOV	R2,SWFDB+F.NRBD	;FIX RECORD SIZE FOR ERROR CASE
   4100	000254	011603 				MOV	(SP),R3		;ADR AND SIZE OF PROG NAME
   4200	000256	016604 	000002 			MOV	2(SP),R4
   4300	000262					CALL	COMPARE		;IS THIS LINE FOR THIS PROGRAM?
   4400	000266	001334 				BNE	50$		;BRANCH IF NO, TRY ANOTHER
   4450	000270	016603 	000004 			MOV	4(SP),R3	;ADDRESS OF OPTION NAME
   4500	000274	016604 	000006 			MOV	6(SP),R4	;SIZE OF OPTION NAME
   4700	000300	001407 				BEQ	80$		;BRANCH IF NO OPTION STRING
   4800	000302	122721 	000072 			CMPB	#':,(R1)+	;REQUIRE THE ":" AND SKIP IT
SWINI - SWITCH INITIAILIZATION	MACRO M1110  22-AUG-78 05:36  PAGE 3-1


   4900	000306	001324 				BNE	50$		;NO ":", NO THE RIGHT OPTION
   5000	000310	005302 				DEC	R2
   5100	000312					CALL	COMPARE		;SEE IF THE OPTION MATCHES
   5200	000316	001320 				BNE	50$		;BRANCH IF OPTION MISMATCH
   5300	000320	122711 	000057 		80$:	CMPB	#'/,(R1)	;MUST BE "/", NOT ":"
   5400	000324	001315 				BNE	50$		;IF NOT, THEN NO MATCH
   5500	000326					CSI$1	R0,R1,R2	;REINIT FOR CSI2 ON THE REST
   5600	000342	103434 				BCS	BADLIN		;THIS SHOULDN'T HAPPEN
   5700	000344					CSI$2	R0,OUTPUT,14(SP) ;PROCESS THE SWITCHES
   5800	000362	103424 				BCS	BADLIN
   5833	000364	056066 	000024 	000012 		BIS	C.MKW1(R0),12(SP) ;COLLECT MASK WORDS
   5866	000372	056066 	000026 	000010 		BIS	C.MKW2(R0),10(SP) ;FROM MULTIPLE RECORDS
   5900	000400	000667 				BR	50$
SWINI - SWITCH INITIAILIZATION	MACRO M1110  22-AUG-78 05:36  PAGE 4


    100	000402	122760 	177766 	000052 	CHKEOF:	CMPB	#IE.EOF,F.ERR(R0)	;END OF FILE?
    200	000410	001417 				BEQ	SUCCES
    300	000412	000404 				BR	FCSERR
    400	000414	122760 	177746 	000052 	CHKNSF:	CMPB	#IE.NSF,F.ERR(R0) ;NO SUCH FILE?
    500	000422	001412 				BEQ	SUCCES
    600	000424	016002 	000052 		FCSERR:	MOV	F.ERR(R0),R2	;ERROR CODE IN R2
    700	000430	005001 				CLR	R1		;0 IN R1
    800	000432	000404 				BR	FAILUR
    900	000434	016702 	000026'		BADLIN:	MOV	SWFDB+F.NRBD+2,R2 ;RECORD ADDRESS
   1000	000440	016701 	000024'			MOV	SWFDB+F.NRBD,R1	;AND SIZE
   1100	000444	000261 			FAILURE:	SEC
   1200	000446	000402 				BR	EXIT
   1300	000450	005001 			SUCCES:	CLR	R1
   1400	000452	005002 				CLR	R2
   1500	000454	010165 	000016 		EXIT:	MOV	R1,C.FILD(R5)
   1600	000460	010265 	000020 			MOV	R2,C.FILD+2(R5)
   1700	000464	006066 	000014 			ROR	14(SP)		;SAVE C IN SAVED C.SWAD
   1800	000470					CLOSE$	#SWFDB
   2000	000500	010500 				MOV	R5,R0
   2100	000502	032626 				BIT	(SP)+,(SP)+
   2200	000504	032626 				BIT	(SP)+,(SP)+
   2233	000506	012660 	000026 			MOV	(SP)+,C.MKW2(R0) ;RETURN COMBINED MASKS
   2266	000512	012660 	000024 			MOV	(SP)+,C.MKW1(R0) ;FROM MULTIPLE RECORDS
   2283	000516	006126 				ROL	(SP)+		;POP THE SAVED C BIT
   2300	000520					RETURN
SWINI - SWITCH INITIAILIZATION	MACRO M1110  22-AUG-78 05:36  PAGE 5


    100					; COMPARE STRINGS - MATCH STRING 1 WITH BEGINNING OF STRING2
    200					; INPUTS:
    300					;	R3=ADR, R4 = SIZE OF STRING 1
    400					;	R1 = ADR, R2 = SIZE OF STRING2
    500					;
    600					; OUTPUTS:
    700					;	Z=1 IF EQUAL, Z = 0 IF NOT
    800					;	R1, R2 UPDATED TO POINT AT FIRST CHARACTER NOT COMPARED
    900					;
   1000	000522	020204 			COMPARE:CMP	R2,R4		;STRING2 MUST BE AT LEAST
   1100	000524	002413 				BLT	20$		;AS BIG AS STRING1
   1200	000526	112146 			10$:	MOVB	(R1)+,-(SP)	;SET UP TO COMPARE
   1220	000530	112366 	000001 			MOVB	(R3)+,1(SP)	;THE CHARACTERS
   1240	000534	042716 	020040 			BIC	#20040,(SP)	;WITHOUT THE CASE BITS
   1260	000540	126626 	000001 			CMPB	1(SP),(SP)+	;DO THEY MATCH?
   1280	000544	001003 				BNE	20$		;BRANCH IF NOT
   1400	000546	005302 				DEC	R2
   1500	000550	005304 				DEC	R4		;Z SET IF THIS FALLS THROUGH
   1510	000552	003365 				BGT	10$
   1600	000554				20$:	RETURN
   1700
   1800					; GET SIZE OF ASCIZ STRING
   1900					;
   2000					; INPUTS:
   2100					;	R1 = STRING ADDRESS
   2200					; OUTPUTS:
   2300					;	R1 PRESERVED
   2400					; R2 = SIZE OF STRING
   2500					;
   2600	000556	010102 			GETSIZ:	MOV	R1,R2
   2700	000560	105722 			10$:	TSTB	(R2)+		;SEARCH FOR FIRST ZERO BYTE
   2800	000562	001376 				BNE	10$
   2900	000564	160102 				SUB	R1,R2
   3000	000566	005302 				DEC	R2		;CALCULATE SIZE
   3100	000570					RETURN			;AND RETURN
   3200
   3300
   3400		000001 				.END
SWINI - SWITCH INITIAILIZATION	MACRO M1110  22-AUG-78 05:36  PAGE 5-1
SYMBOL TABLE

BADLIN  000434R     004	FD.PSE= 010000   	F.RATT= 000001   	IE.IFU= 177747   	IS.SUC= 000001
CHKEOF  000402R     004	FD.RAH= 000001   	F.RCNM= 000034   	IE.ILL= 177726   	IS.TAB= 004401
CHKNSF  000414R     004	FD.RAN= 000002   	F.RCTL= 000017   	IE.ISQ= 177703   	IS.TMO= 000002
CH.AND= 000001   	FD.REC= 000001   	F.RSIZ= 000002   	IE.LCK= 177745   	NB.DEV= 000200
COMPAR  000522R     004	FD.RWM= 000001   	F.RTYP= 000000   	IE.MOD= 177753   	NB.DIR= 000100
CS.DIF= 000002   	FD.SDI= 000020   	F.SEQN= 000100   	IE.NBF= 177731   	NB.NAM= 000004
CS.DVF= 000004   	FD.SQD= 000040   	F.SPDV= 000072   	IE.NBK= 177727   	NB.SD1= 000400
CS.EQU= 000040   	FD.TTY= 000004   	F.SPUN= 000074   	IE.NDR= 177670   	NB.SD2= 001000
CS.INP= 000001   	FD.WBH= 000002   	F.STBK= 000036   	IE.NFI= 177704   	NB.SNM= 000040
CS.MOR= 000020   	FF.CHR= 000005   	F.UNIT= 000136   	IE.NFW= 177673   	NB.STP= 000020
CS.NMF= 000001   	FF.NV = 000003   	F.URBD= 000020   	IE.NLK= 177661   	NB.SVR= 000010
CS.OUT= 000002   	FF.POE= 000002   	F.VBN = 000064   	IE.NLN= 177733   	NB.TYP= 000002
CS.WLD= 000010   	FF.RWD= 000001   	F.VBSZ= 000060   	IE.NNC= 177663   	NB.VER= 000001
C.CMLD= 000002   	FF.RWF= 000006   	GETSIZ  000556R     004	IE.NNL= 177662   	N.DID = 000024
C.DEVD= 000006   	FF.SPC= 000004   	IE.ABO= 177761   	IE.NNN= 177674   	N.DVNM= 000032
C.DIRD= 000012   	FO.APD= 000106   	IE.ALC= 177654   	IE.NOD= 177751   	N.FID = 000000
C.DSDS= 000006   	FO.MFY= 000002   	IE.ALN= 177736   	IE.NSF= 177746   	N.FNAM= 000006
C.FILD= 000016   	FO.RD = 000001   	IE.AST= 177660   	IE.NST= 177660   	N.FTYP= 000014
C.MKW1= 000024   	FO.UPD= 000006   	IE.BAD= 177777   	IE.OFL= 177677   	N.FVER= 000016
C.MKW2= 000026   	FO.WRT= 000016   	IE.BBE= 177710   	IE.ONP= 177773   	N.NEXT= 000022
C.SIZE= 000054   	F.ACTL= 000076   	IE.BCC= 177676   	IE.OVR= 177756   	N.STAT= 000020
C.STAT= 000001   	F.ALOC= 000040   	IE.BDI= 177714   	IE.PES= 177655   	N.UNIT= 000034
C.SWAD= 000022   	F.BBFS= 000062   	IE.BDR= 177716   	IE.PRI= 177760   	PAR$$$= 000027
C.TYPR= 000000   	F.BDB = 000070   	IE.BDV= 177711   	IE.RAC= 177724   	RONLY$= 000001
EXIT    000454R     004	F.BGBC= 000057   	IE.BHD= 177700   	IE.RAT= 177723   	R$$EIS= 000001
FAILUR  000444R     004	F.BKDN= 000026   	IE.BLB= 177672   	IE.RBG= 177730   	R$$SHR= 000001
FA.APD= 000100   	F.BKDS= 000020   	IE.BLK= 177754   	IE.RCN= 177722   	R.FIX = 000001
FA.CRE= 000010   	F.BKEF= 000050   	IE.BNM= 177712   	IE.RER= 177740   	R.SEQ = 000003
FA.DLK= 001000   	F.BKP1= 000051   	IE.BTF= 177664   	IE.RNM= 177715   	R.VAR = 000002
FA.ENB= 100000   	F.BKST= 000024   	IE.BTP= 177725   	IE.RSU= 177757   	SUCCES  000450R     004
FA.EXC= 002000   	F.BKVB= 000064   	IE.BVR= 177701   	IE.SNC= 177735   	SWFDB   000000R     003
FA.EXT= 000004   	F.CHR = 000075   	IE.BYT= 177755   	IE.SPC= 177772   	SWFNM   000000R     002
FA.NSP= 000100   	F.CNTG= 000034   	IE.CKS= 177742   	IE.SQC= 177734   	S.FATT= 000016
FA.POS= 010000   	F.DFNB= 000046   	IE.CLO= 177732   	IE.SRE= 177762   	S.FDB = 000140
FA.RD = 000001   	F.DSPT= 000044   	IE.CNR= 177667   	IE.STK= 177706   	S.FNAM= 000006
FA.RWD= 004000   	F.DVNM= 000134   	IE.CON= 177752   	IE.TMM= 177671   	S.FNB = 000036
FA.SEQ= 040000   	F.EFBK= 000010   	IE.DAA= 177770   	IE.TMO= 177666   	S.FNBW= 000017
FA.SHR= 000040   	F.EFN = 000050   	IE.DAO= 177763   	IE.ULK= 177653   	S.FNTY= 000004
FA.TMP= 000020   	F.EOBB= 000032   	IE.DFU= 177750   	IE.VER= 177774   	S.FTYP= 000002
FA.WCK= 020000   	F.ERR = 000052   	IE.DNA= 177771   	IE.WAC= 177743   	S.NFEN= 000020
FA.WRT= 000002   	F.FACC= 000043   	IE.DNR= 177775   	IE.WAT= 177741   	$$MSG = 000000
FCSERR  000424R     004	F.FFBY= 000014   	IE.DUN= 177767   	IE.WCK= 177652   	.CLOSE= ****** G
FD.BLK= 000010   	F.FNAM= 000110   	IE.DUP= 177707   	IE.WER= 177737   	.CSI1 = ****** G
FD.CCL= 000002   	F.FNB = 000102   	IE.EOF= 177766   	IE.WLK= 177764   	.CSI2 = ****** G
FD.COM= 020000   	F.FTYP= 000116   	IE.EOT= 177702   	IE.2DV= 177720   	.GETSQ= ****** G
FD.CR = 000002   	F.FVER= 000120   	IE.EOV= 177765   	IS.BV = 000005   	.OPFNB= ****** G
FD.DIR= 000010   	F.HIBK= 000004   	IE.EXP= 177665   	IS.CC = 001401   	.PARSE= ****** GX
FD.FTN= 000001   	F.LUN = 000042   	IE.FEX= 177717   	IS.CR = 006401   	.SAVR1= ****** GX
FD.F11= 040000   	F.MBCT= 000054   	IE.FHE= 177705   	IS.EOT= 002001   	.SWINI  000000RG    004
FD.INS= 000010   	F.MBC1= 000055   	IE.FLN= 177657   	IS.ESC= 015401   	...GBL= 000000
FD.ISP= 002000   	F.MBFG= 000056   	IE.FOP= 177713   	IS.ESQ= 115401   	...PC1= 000000R     003
FD.MNT= 100000   	F.NRBD= 000024   	IE.HFU= 177744   	IS.PES= 100001   	...PC2= 000034R     002
FD.OSP= 004000   	F.NREC= 000030   	IE.IES= 177656   	IS.PND= 000000   	...PC3= 000000R     003
FD.PLC= 000004   	F.OVBS= 000030   	IE.IFC= 177776   	IS.RDD= 000002   	...TPC= 000140
FD.PRN= 000004   	F.RACC= 000016

. ABS.	000000	   000
SWINI - SWITCH INITIAILIZATION	MACRO M1110  22-AUG-78 05:36  PAGE 5-2
SYMBOL TABLE

      	000000	   001
PLIT  	000036	   002
SWIN.D	000140	   003
CODE  	000572	   004
ERRORS DETECTED:  0

VIRTUAL MEMORY USED:  5008 WORDS  ( 20 PAGES)
DYNAMIC MEMORY:  5940 WORDS  ( 22 PAGES)
ELAPSED TIME:  00:00:16
OBJ$:SWINI,LIS$:SWINI/-SP/NL:TOC=SRC$:PREFIX,SWINI
