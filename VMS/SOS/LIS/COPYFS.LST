COPYFSR - FSR EXPANDER FOR THE 	MACRO M1110  22-AUG-78 05:29  PAGE 2


    100						.TITLE	COPYFSR - FSR EXPANDER FOR THE COPY COMMAND
    200						.IDENT	/02.02/
    300
    400					; COPYRIGHT 1976, DIGITAL EQUIPMENT CORPORATION, MAYNARD, MASS. 01754
    500					;
    600					; DEC ASSUMES NO RESPONSIBILITY FOR THE USE OR RELIABILITY OF ITS
    700					; SOFTWARE ON EQUIPMENT WHICH IS NOT SUPPLIED BY DEC.
    800					;
    900					; THIS SOFTWARE IS FURNISHED TO PURCHASER UNDER A LICENSE FOR USE
   1000					; ON A SINGLE COMPUTER SYSTEM AND CAN BE COPIED (WITH INCLUSION
   1100					; OF DEC'S COPYRIGHT NOTICE) ONLY FOR USE IN SUCH SYSTEM, EXCEPT
   1200					; AS MAY BE OTHERWISE PROVIDED IN WRITING BY DEC.
   1300					;
   1400					; THE INFORMATION IN THIS DOCUMENT IS SUBJECT TO CHANGE WITHOUT
   1500					; NOTICE AND SHOULD NOT BE CONSTRUED AS A COMMITMENT BY DIGITAL
   1600					; EQUIPMENT CORPORATION.
   1700					;
   1800					; PETER H. LIPMAN	24-AUG-76
   1900					;
   2000						.MCALL	FDOF$L,FCSBT$,IOERR$
   2100	000000					FDOF$L
   2200	000000					FCSBT$
   2300	000000					IOERR$
   2400						.MCALL	CLOSE$
   2500
   2600					;  	COPY COMMAND FSR HANDLER ROUTINES
   2700					;
   2800					; GIVFSR - GIVES ENOUGH SPACE BACK TO THE FILE STORAGE REGION
   2900					;	FOR OPENING THE COPY FILE.  THIS IS ACCOMPLISHED BY
   3000					;	MARKING THE PLACE IN THE INPUT FILE AND CLOSING IT.
   3100					;
   3200	000000					CODE$	CPFS
   3300
   3400						.ENABL	LSB
   3500
   3600	000000	004167 	000000G		GIVFSR::JSR	R1,$SAV4		;SAVE R1-R3
   3700	000004	016700 	000030G			MOV	BUF+24.,R0		;R0=FDB ADR OF INPUT FDB
   3800	000010	012704 	000000G			MOV	#SVSTRM,R4		;ADDRESS OF STREAM POSITION INFO
   3900	000014	012446 				MOV	(R4)+,-(SP)		;SAVED POSITION PRESENT?
   4000	000016	001405 				BEQ	10$			;BRANCH IF NOT
   4020	000020	005416 				NEG	(SP)			;NEGATIVE INDICATES RECORD
   4040										;IS NO LONGER IN STREAM BUFFER
   4060										;AND MUST BE RE-READ
   4100	000022	012401 				MOV	(R4)+,R1		;LOAD REGISTERS
   4200	000024	012402 				MOV	(R4)+,R2		;  AS IF
   4300	000026	012403 				MOV	(R4)+,R3		;    CALLED .MARK
   4400	000030	000402 				BR	20$
   4500	000032	004767 	000000G		10$:	JSR	PC,.MARK		;RECORD POSITION OF FILE
   4600	000036	012704 	000000G		20$:	MOV	#SAVIFL,R4		;ADDRESS OF SAVE CONTEXT AREA
   4700	000042	010024 				MOV	R0,(R4)+		;FDB ADDRESS
   4800	000044	010124 				MOV	R1,(R4)+		;HIGH VBN
   4900	000046	010224 				MOV	R2,(R4)+		;LOW VBN BITS
   5000	000050	010324 				MOV	R3,(R4)+		;BYTE OFFSET IN VBN
   5100	000052	012624 				MOV	(SP)+,(R4)+		;BYTE OFFSET IN STREAM RECORD
   5200	000054	016046 	000102 			MOV	F.FNB(R0),-(SP)		;CLOSE WILL WIPE OUT FILE ID
   5300	000060					CLOSE$	R0			;AND CLOSE IT
   5400	000064	012660 	000102 			MOV	(SP)+,F.FNB(R0)		;RESTORE FILE ID FOR FAST OPEN
COPYFSR - FSR EXPANDER FOR THE 	MACRO M1110  22-AUG-78 05:29  PAGE 2-1


   5500	000070	103436 				BCS	60$			;BRANCH IF ERROR
   5600	000072	000207 				RTS	PC			;AND RETURN
   5700					;
   5800					; GETFSR - CALLED AFTER THE COPY FILE IS CLOSED TO "GET BACK
   5900					;	THE FILE STORAGE REGION SPACE."  THE INPUT FILE IS
   6000					;	NOW REOPENED AND POSITIONED TO ITS SAVED PLACE.
   6100					;
   6200	000074	004167 	000000G		GETFSR::JSR	R1,$SAV3		;SAVE R1-R3
   6300	000100	012700 	000012G			MOV	#SAVIFL+10.,R0		;POINTER TO SAVED FILE INFO
   6350	000104	014046 				MOV	-(R0),-(SP)		;BYTE OFFSET IN STREAM RECORD
   6400	000106	014003 				MOV	-(R0),R3		;RESTORE R1-R3
   6500	000110	014002 				MOV	-(R0),R2		;IN ORDER TO REPOSITION
   6600	000112	014001 				MOV	-(R0),R1		;THE FILE
   6700	000114	014000 				MOV	-(R0),R0		;RESTORE THE FDB ADDRESS
   6800	000116	142760 	000110 	000043 		BICB	#FA.CRE!FA.NSP,F.FACC(R0) ;IF FILE WAS OPEN FOR PUT AS WELL
   6900										;JUST LEAVE OPEN FOR UPDATE BITS
   7000	000124	004767 	000000G			JSR	PC,OPNCOM		;REOPEN THE INPUT FILE
   7100										;USING PREVIOUS FILE ACCESS
   7200	000130	103416 				BCS	60$			;DISASTER IF IT FAILS
   7300	000132	004767 	000000G			JSR	PC,.POINT		;REPOSITION
   7400	000136	103004 				BCC	40$			;BRANCH IF OK
   7500	000140	122760 	177766 	000052 		CMPB	#IE.EOF,F.ERR(R0)	;EOF ERROR IS OK
   7600	000146	001007 				BNE	60$			;OTHER ERROR IS FATAL
   7605	000150	012700 	000000G		40$:	MOV	#SVSTRM,R0		;ADDRESS OF GET STREAM CONTEXT
   7610	000154	012620 				MOV	(SP)+,(R0)+		;BYTE OFFSET IN STREAM RECORD
   7615	000156	010120 				MOV	R1,(R0)+		;HIGH VBN BITS
   7620	000160	010220 				MOV	R2,(R0)+		;LOW VBN BITS
   7625	000162	010320 				MOV	R3,(R0)+		;BYTE OFFSET IN VBN
   7700	000164	000207 				RTS	PC
   7800
   7900	000166	012746 	000003 		60$:	MOV	#3,-(SP)		;TROUBLE--BAD ERROR
   8000	000172	005046 				CLR	-(SP)			;INTERNAL CODE
   8100	000174	004767 	000000G			JSR	PC,SOSERR		;ABORT SOS
   8200
   8300						.DSABL	LSB
   8400
   8500		000001 				.END
COPYFSR - FSR EXPANDER FOR THE 	MACRO M1110  22-AUG-78 05:29  PAGE 2-2
SYMBOL TABLE

BUF   = ****** GX	FO.WRT= 000016   	GETFSR  000074RG    002	IE.NDR= 177670   	IS.TAB= 004401
CH.AND= 000001   	F.ACTL= 000076   	GIVFSR  000000RG    002	IE.NFI= 177704   	IS.TMO= 000002
FA.APD= 000100   	F.ALOC= 000040   	IE.ABO= 177761   	IE.NFW= 177673   	NB.DEV= 000200
FA.CRE= 000010   	F.BBFS= 000062   	IE.ALC= 177654   	IE.NLK= 177661   	NB.DIR= 000100
FA.DLK= 001000   	F.BDB = 000070   	IE.ALN= 177736   	IE.NLN= 177733   	NB.NAM= 000004
FA.ENB= 100000   	F.BGBC= 000057   	IE.AST= 177660   	IE.NNC= 177663   	NB.SD1= 000400
FA.EXC= 002000   	F.BKDN= 000026   	IE.BAD= 177777   	IE.NNL= 177662   	NB.SD2= 001000
FA.EXT= 000004   	F.BKDS= 000020   	IE.BBE= 177710   	IE.NNN= 177674   	NB.SNM= 000040
FA.NSP= 000100   	F.BKEF= 000050   	IE.BCC= 177676   	IE.NOD= 177751   	NB.STP= 000020
FA.POS= 010000   	F.BKP1= 000051   	IE.BDI= 177714   	IE.NSF= 177746   	NB.SVR= 000010
FA.RD = 000001   	F.BKST= 000024   	IE.BDR= 177716   	IE.NST= 177660   	NB.TYP= 000002
FA.RWD= 004000   	F.BKVB= 000064   	IE.BDV= 177711   	IE.OFL= 177677   	NB.VER= 000001
FA.SEQ= 040000   	F.CHR = 000075   	IE.BHD= 177700   	IE.ONP= 177773   	N.DID = 000024
FA.SHR= 000040   	F.CNTG= 000034   	IE.BLB= 177672   	IE.OVR= 177756   	N.DVNM= 000032
FA.TMP= 000020   	F.DFNB= 000046   	IE.BLK= 177754   	IE.PES= 177655   	N.FID = 000000
FA.WCK= 020000   	F.DSPT= 000044   	IE.BNM= 177712   	IE.PRI= 177760   	N.FNAM= 000006
FA.WRT= 000002   	F.DVNM= 000134   	IE.BTF= 177664   	IE.RAC= 177724   	N.FTYP= 000014
FD.BLK= 000010   	F.EFBK= 000010   	IE.BTP= 177725   	IE.RAT= 177723   	N.FVER= 000016
FD.CCL= 000002   	F.EFN = 000050   	IE.BVR= 177701   	IE.RBG= 177730   	N.NEXT= 000022
FD.COM= 020000   	F.EOBB= 000032   	IE.BYT= 177755   	IE.RCN= 177722   	N.STAT= 000020
FD.CR = 000002   	F.ERR = 000052   	IE.CKS= 177742   	IE.RER= 177740   	N.UNIT= 000034
FD.DIR= 000010   	F.FACC= 000043   	IE.CLO= 177732   	IE.RNM= 177715   	OPNCOM= ****** GX
FD.FTN= 000001   	F.FFBY= 000014   	IE.CNR= 177667   	IE.RSU= 177757   	PAR$$$= 000000
FD.F11= 040000   	F.FNAM= 000110   	IE.CON= 177752   	IE.SNC= 177735   	RONLY$= 000001
FD.INS= 000010   	F.FNB = 000102   	IE.DAA= 177770   	IE.SPC= 177772   	R$$EIS= 000001
FD.ISP= 002000   	F.FTYP= 000116   	IE.DAO= 177763   	IE.SQC= 177734   	R$$SHR= 000001
FD.MNT= 100000   	F.FVER= 000120   	IE.DFU= 177750   	IE.SRE= 177762   	R.FIX = 000001
FD.OSP= 004000   	F.HIBK= 000004   	IE.DNA= 177771   	IE.STK= 177706   	R.SEQ = 000003
FD.PLC= 000004   	F.LUN = 000042   	IE.DNR= 177775   	IE.TMM= 177671   	R.VAR = 000002
FD.PRN= 000004   	F.MBCT= 000054   	IE.DUN= 177767   	IE.TMO= 177666   	SAVIFL= ****** GX
FD.PSE= 010000   	F.MBC1= 000055   	IE.DUP= 177707   	IE.ULK= 177653   	SOSERR= ****** GX
FD.RAH= 000001   	F.MBFG= 000056   	IE.EOF= 177766   	IE.VER= 177774   	SVSTRM= ****** GX
FD.RAN= 000002   	F.NRBD= 000024   	IE.EOT= 177702   	IE.WAC= 177743   	S.FATT= 000016
FD.REC= 000001   	F.NREC= 000030   	IE.EOV= 177765   	IE.WAT= 177741   	S.FDB = 000140
FD.RWM= 000001   	F.OVBS= 000030   	IE.EXP= 177665   	IE.WCK= 177652   	S.FNAM= 000006
FD.SDI= 000020   	F.RACC= 000016   	IE.FEX= 177717   	IE.WER= 177737   	S.FNB = 000036
FD.SQD= 000040   	F.RATT= 000001   	IE.FHE= 177705   	IE.WLK= 177764   	S.FNBW= 000017
FD.TTY= 000004   	F.RCNM= 000034   	IE.FLN= 177657   	IE.2DV= 177720   	S.FNTY= 000004
FD.WBH= 000002   	F.RCTL= 000017   	IE.FOP= 177713   	IS.BV = 000005   	S.FTYP= 000002
FF.CHR= 000005   	F.RSIZ= 000002   	IE.HFU= 177744   	IS.CC = 001401   	S.NFEN= 000020
FF.NV = 000003   	F.RTYP= 000000   	IE.IES= 177656   	IS.CR = 006401   	$SAV3 = ****** GX
FF.POE= 000002   	F.SEQN= 000100   	IE.IFC= 177776   	IS.EOT= 002001   	$SAV4 = ****** GX
FF.RWD= 000001   	F.SPDV= 000072   	IE.IFU= 177747   	IS.ESC= 015401   	$$MSG = 000000
FF.RWF= 000006   	F.SPUN= 000074   	IE.ILL= 177726   	IS.ESQ= 115401   	.CLOSE= ****** G
FF.SPC= 000004   	F.STBK= 000036   	IE.ISQ= 177703   	IS.PES= 100001   	.MARK = ****** GX
FO.APD= 000106   	F.UNIT= 000136   	IE.LCK= 177745   	IS.PND= 000000   	.POINT= ****** GX
FO.MFY= 000002   	F.URBD= 000020   	IE.MOD= 177753   	IS.RDD= 000002   	...GBL= 000000
FO.RD = 000001   	F.VBN = 000064   	IE.NBF= 177731   	IS.SUC= 000001   	...TPC= 000140
FO.UPD= 000006   	F.VBSZ= 000060   	IE.NBK= 177727

. ABS.	000000	   000
      	000000	   001
CODE  	000200	   002
ERRORS DETECTED:  0

VIRTUAL MEMORY USED:  4716 WORDS  ( 19 PAGES)
DYNAMIC MEMORY:  5940 WORDS  ( 22 PAGES)
ELAPSED TIME:  00:00:11
COPYFSR - FSR EXPANDER FOR THE 	MACRO M1110  22-AUG-78 05:29  PAGE 2-3
SYMBOL TABLE

OBJ$:COPYFS,LIS$:COPYFS/-SP/NL:TOC=SRC$:PREFIX,COPYFS
