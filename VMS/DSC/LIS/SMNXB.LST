SMNXB	X0004 - SET UP NEXT STO	MACRO M1110  21-AUG-78 20:54  PAGE 3


      1	000000					$BEGIN	SMNXB,0004,<SET UP NEXT STORAGE MAP BIT>
						.TITLE	SMNXB	X0004 - SET UP NEXT STORAGE MAP BIT
						.IDENT	"X0004"
      2
      3					;
      4					; COPYRIGHT (C) 1976 BY DIGITAL EQUIPMENT CORPORATION,
      5					; MAYNARD, MASSACHUSETTS
      6					;
      7					; THIS SOFTWARE IS FURNISHED UNDER A LICENSE FOR USE ONLY ON A
      8					; SINGLE  COMPUTER  SYSTEM AND MAY BE COPIED ONLY WITH THE IN-
      9					; CLUSION OF THE ABOVE COPYRIGHT NOTICE.   THIS  SOFTWARE,  OR
     10					; ANY  OTHER  COPIES THEREOF, MAY NOT BE PROVIDED OR OTHERWISE
     11					; MADE AVAILABLE TO ANY OTHER PERSON EXCEPT FOR  USE  ON  SUCH
     12					; SYSTEM  AND TO ONE WHO AGREES TO THESE LICENSE TERMS.  TITLE
     13					; TO AND OWNERSHIP OF THE SOFTWARE SHALL AT ALL  TIMES  REMAIN
     14					; IN DIGITAL.
     15					;
     16					; THE INFORMATION IN THIS SOFTWARE IS SUBJECT TO CHANGE  WITH-
     17					; OUT  NOTICE  AND  SHOULD NOT BE CONSTRUED AS A COMMITMENT BY
     18					; DIGITAL EQUIPMENT CORPORATION.
     19					;
     20					; DIGITAL EQUIPMENT CORPORATION ASSUMES NO RESPONSIBILITY  FOR
     21					; THE USE OR RELIABILITY OF ITS SOFTWARE ON EQUIPMENT WHICH IS
     22					; NOT SUPPLIED BY DIGITAL.
     23					;
     24					; ANDREW C. GOLDSTEIN  18-AUG-76  4:24
     25					; PETER H. LIPMAN	27-FEB-74
SMNXB	X0004 - SET UP NEXT STO	MACRO M1110  21-AUG-78 20:54  PAGE 4


     27					;+
     28					; *** - .SMNXB	SET UP TO TEST NEXT STORAGE MAP BIT
     29					;
     30					; THIS ROUTINE ACCEPTS A MASK WORD AND ADDRESS IN THE CURRENT STORAGE
     31					; MAP BLOCK AND CALCULATES THE MASK AND ADDRESS FOR THE NEXT BIT, CROSSING
     32					; TO THE NEXT STORAGE MAP BLOCK IF NECESSARY. WHEN NECESSARY TO CROSS
     33					; TO ANOTHER STORAGE MAP BLOCK THE CURRENT ONE IS WRITTEN IF NECESSARY
     34					; AND THE NEXT ONE IS READ. A COUNT OF STORAGE MAP BLOCKS TO BE  SCANNED
     35					; MUST BE INITIALIZED BEFORE THIS ROUTINE IS CALLED. THIS
     36					; COUNT IS USED TO SEE IF THE NEXT BLOCK SHOULD BE READ. THE
     37					; NEXT BLOCK TO BE READ CORRECTLY WRAPS AROUND TO 1 IF THE NEXT BLOCK WOULD
     38					; BE BEYOND THE END.
     39					;
     40					; INPUTS:
     41					;
     42					;	R0 = MASK WORD
     43					;	R1 = ADDRESS IN BUFFER
     44					;	R4 = DEVICE TABLE ADDRESS
     45					;	.SMVBN = CURRENT STORAGE MAP BLOCK NUMBER
     46					;	.SMCNT = NO. OF BLOCKS TO SCAN.
     47					;
     48					; OUTPUT:
     49					;
     50					;	C = 1 IF NO MORE BITS (CHECKED ALL BLOCKS)
     51					;	C = 0 IF NEXT BIT IS SET TO TEST AND
     52					;	R = 0 MASK
     53					;	R1 = ADDRESS
     54					;	.SMVBN = UPDATED IF CROSSED TO NEW BLOCK
     55					;	.SMCNT DECREMENTED IF CROSSED TO NEW BLOCK
     56					;	R2-R5	PRESERVED
     57					;
     58					;-
     59
     60	000000				.SMNXB::
     61	000000	006300 				ASL	R0		; SHIFT THE MASK
     62	000002	103032 				BCC	20$		; BRANCH IF NOT LAST BIT
     63	000004	006100 				ROL	R0		; SET INITIAL MASK
     64	000006	005721 				TST	(R1)+		; AND NEXT WORD IN BUFFER
     65	000010	022701 	000776G			CMP	#.SMBUF+512.-2,R1
     66	000014	103025 				BHIS	20$		; BRANCH IF NOT BEYOND END OF BUFFER, C = 0
     67					;
     68					; READ NEXT VIRTUAL BLOCK OF STORAGE BIT MAP, C = 1
     69					;
     70	000016	006000 				ROR	R0		; C WAS 1, R0 WAS 1, R0  = 100000, C = 1
     71	000020	014111 				MOV	-(R1),(R1)	; BACK UP CONTEXT TO LAST BIT LAST WORD
     72	000022	005367 	000000G			DEC	.SMCNT		; TRIED ALL THE BLOCKS
     73	000026	003420 				BLE	20$		; BRANCH IF YES, C = 1
     74	000030	010346 				MOV	R3,-(SP)	; SAVE R3
     75	000032	016703 	000000G			MOV	.SMVBN,R3
     76	000036	005203 				INC	R3
     77	000040	026403 	000000G			CMP	V.SBSZ(R4),R3	; IF BEYOND LAST BLOCK
     78	000044	103002 				BHIS	10$
     79	000046	012703 	000001 			MOV	#1,R3		; THEN WRAP TO BLOCK 1
     80	000052	004767 	000000G		10$:	CALL	.SMRVB
     81	000056	012603 				MOV	(SP)+,R3	; RESTORE R3
     82	000060	012701 	000000G			MOV	#.SMBUF,R1	; SET BUFFER ADDRESS
     83	000064	005000 				CLR	R0		; CLEAR CARRY
SMNXB	X0004 - SET UP NEXT STO	MACRO M1110  21-AUG-78 20:54  PAGE 4-1


     84	000066	005200 				INC	R0		; SET R0 TO 1
     85	000070				20$:	RETURN
     86
     87
     88
     89		000001 				.END
SMNXB	X0004 - SET UP NEXT STO	MACRO M1110  21-AUG-78 20:54  PAGE 4-2
SYMBOL TABLE

IIII  = 177777   	$EF$  = 000000   	$L$   = 000000   	$T    = 000000   	.SMNXB  000000RG
V.SBSZ= ****** GX	$E$   = 000001   	$R    = 177777   	.SMBUF= ****** GX	.SMRVB= ****** GX
$DIDDO= 000000   	$L    = 000000   	$SUPMC= 000043   	.SMCNT= ****** GX	.SMVBN= ****** GX

. ABS.	000000	   000
      	000072	   001
ERRORS DETECTED:  0

VIRTUAL MEMORY USED:  11165 WORDS  ( 44 PAGES)
DYNAMIC MEMORY:  12276 WORDS  ( 47 PAGES)
ELAPSED TIME:  00:00:18
EXE$:SMNXB,LIS$:SMNXB/-SP=SRC$:SMAC/PA:1,DSCPRE,SMNXB
