BLDRP	X0001 - BUILD RETRIEVAL	MACRO M1110  21-AUG-78 19:59  PAGE 3


      1	000000					$BEGIN	BLDRP,0001,<BUILD RETRIEVAL POINTERS (ODS-2)>
						.TITLE	BLDRP	X0001 - BUILD RETRIEVAL POINTERS (ODS-2)
						.IDENT	"X0001"
      2
      3					;
      4					; COPYRIGHT (C) 1977 BY DIGITAL EQUIPMENT CORPORATION,
      5					; MAYNARD, MASSACHUSETTS
      6					;
      7					; THIS SOFTWARE IS FURNISHED UNDER A LICENSE FOR USE ONLY ON A
      8					; SINGLE  COMPUTER  SYSTEM AND MAY BE COPIED ONLY WITH THE IN-
      9					; CLUSION OF THE ABOVE COPYRIGHT NOTICE.   THIS  SOFTWARE,  OR
     10					; ANY  OTHER  COPIES THEREOF, MAY NOT BE PROVIDED OR OTHERWISE
     11					; MADE AVAILABLE TO ANY OTHER PERSON EXCEPT FOR  USE  ON  SUCH
     12					; SYSTEM  AND TO ONE WHO AGREES TO THESE LICENSE TERMS.  TITLE
     13					; TO AND OWNERSHIP OF THE SOFTWARE SHALL AT ALL  TIMES  REMAIN
     14					; IN DIGITAL.
     15					;
     16					; THE INFORMATION IN THIS SOFTWARE IS SUBJECT TO CHANGE  WITH-
     17					; OUT  NOTICE  AND  SHOULD NOT BE CONSTRUED AS A COMMITMENT BY
     18					; DIGITAL EQUIPMENT CORPORATION.
     19					;
     20					; DIGITAL EQUIPMENT CORPORATION ASSUMES NO RESPONSIBILITY  FOR
     21					; THE USE OR RELIABILITY OF ITS SOFTWARE ON EQUIPMENT WHICH IS
     22					; NOT SUPPLIED BY DIGITAL.
     23					;
     24					; JOSEPH A. CARCHIDI  5-DEC-77  19:30
     25
     26						.MCALL	FHDL2$
     27	000000					FHDL2$				; DEFINE FILE HEADER OFFSETS
BLDRP	X0001 - BUILD RETRIEVAL	MACRO M1110  21-AUG-78 19:59  PAGE 4


     29					;+
     30					;
     31					; *** - $BLDRP	BUILD RETRIEVAL POINTERS  (ODS-2 VERSION)
     32					;
     33					; THIS ROUTINE CONSTRUCTS ONE RETRIEVAL POINTER TO MAP THE
     34					; SET OF BLOCKS INDICATED BY R0,R1 AND R2,R3.
     35					; THE NEW POINTER IS APPENDED TO THE EXISTING MAP AREA OF THE HEADER.
     36					;
     37					;
     38					; INPUTS:
     39					;
     40					;	R0,R1 = BLOCK COUNT
     41					;	R2,R3 = STARTING LBN
     42					;	R5 = FILE HEADER ADDRESS
     43					;
     44					; OUTPUTS:
     45					;
     46					;	RETRIEVAL POINTERS BUILT
     47					;	CC - C	CLEAR IF ALL BLOCKS MAPPED
     48					;		SET IF HEADER FULL
     49					;	R0,R1,R2,R3 DESCRIBE UNMAPPED BLOCKS
     50					;	R4,R5 PRESERVED
     51					;-
     52
     53	000000				$BLDRP::
     54	000000					PUSH  R4			; SAVE CALLER'S R4.
     55	000002	005004 				CLR	R4
     56	000004	156504 	000001 			BISB	H.MPOF(R5),R4		; MAP AREA OFFSET TO R4.
     57	000010	006304 				ASL	R4			; CONVERT IT TO A BYTE OFFSET.
     58	000012	060504 				ADD	R5,R4			; ADD THE ADDRESS OF THE HEADER.
     59	000014	005046 				CLR	-(SP)
     60	000016	156516 	000072 			BISB	H.USE(R5),(SP)		; NUMBER OF MAP AREA WORDS IN USE.
     61	000022	006316 				ASL	(SP)			; CONVERT TO A BYTE OFFSET.
     62	000024	061604 				ADD	(SP),R4			; POINT R4 AT NEXT AVAILABLE POSITION.
     63	000026	005046 				CLR	-(SP)
     64	000030	156516 	000002 			BISB	H.ACOF(R5),(SP)		; ACCESS LIST AREA OFFSET.
     65	000034	006316 				ASL	(SP)			; CONVERT TO BYTE OFFSET.
     66	000036	060516 				ADD	R5,(SP)			; ADD THE ADDRESS OF THE HEADER.
     67	000040	160416 				SUB	R4,(SP)			; COMPUTE MAP AREA FREE SPACE IN BYTES.
     68
     69	000042					BEGIN	BLDPTR
     70					;
     71					; USE 2 WORD POINTER IF POSSIBLE.
     72					;
     73	000042					IF  R0  EQ  #0  AND  R1  LOS  #256.  ; CAN THE COUNT BE REPRESENTED IN 8 BITS ?
     74	000054					  IF  R2  LO  #64.		     ; IS STARTING LBN LT 2**22 ?
     75	000062					    IF  (SP)  LO  #4  GOTO  FULL     ; WILL POINTER FIT ?
     76	000070	062766 	000004 	000002 		    ADD  #4,2(SP)		; INCR MAP BYTES IN USE.
     77	000076	005014 				    CLR  (R4)
     78	000100	150214 				    BISB  R2,(R4)		; STORE THE HIGH ORDER LBN
     79	000102	000314 				    SWAB  (R4)			; IN THE HIGH BYTE.
     80	000104	150114 				    BISB  R1,(R4)		; STORE THE COUNT
     81	000106	105314 				    DECB  (R4)			; REDUCED BY 1.
     82	000110	052724 	040000 			    BIS  #40000,(R4)+		; INDICATE 2 WORD POINTER.
     83	000114	010314 				    MOV  R3,(R4)		; STORE LOW ORDER LBN.
     84	000116					    LEAVE  BLDPTR		; DONE, GET OUT.
     85	000120					  END
BLDRP	X0001 - BUILD RETRIEVAL	MACRO M1110  21-AUG-78 19:59  PAGE 4-1


     86	000120					END
     87					;
     88					; 2 WORD POINTER WON'T SUFFICE, TRY 3 WORD POINTER.
     89					;
     90	000120					IF  R0  EQ  #0  AND  R1  LOS  #16384.  ; CAN THE COUNT BE REPRESENTED IN 14 BITS ?
     91	000132					  IF  (SP)  LO  #6  GOTO  FULL	       ; WILL POINTER FIT ?
     92	000140	062766 	000006 	000002 		  ADD  #6,2(SP)			; INCR MAP AREA BYTES IN USE.
     93	000146	005014 				  CLR  (R4)
     94	000150	050114 				  BIS  R1,(R4)			; STORE THE BLOCK COUNT.
     95	000152	005314 				  DEC  (R4)			; REDUCED BY 1.
     96	000154	052724 	100000 			  BIS  #100000,(R4)+		; INDICATE 3 WORD POINTER .
     97	000160					  GOTO  MOVLBN
     98	000162					END
     99					;
    100					; 3 WORD POINTER WON'T SUFFICE, TRY 4 WORD POINTER.
    101					;
    102	000162					IF  R0  LOS  #16384.		; IS BLOCK COUNT LOS (2**30) ?
    103	000170					  IF  (SP)  LO  #8.  GOTO  FULL	; WILL POINTER FIT ?
    104	000176	062766 	000010 	000002 		  ADD  #8.,2(SP)		; INCR MAP AREA BYTES IN USE.
    105	000204	010024 				  MOV  R0,(R4)+			; STORE HIGH ORDER BLOCK COUNT.
    106	000206	010114 				  MOV  R1,(R4)			; STORE LOW ORDER COUNT.
    107	000210	162724 	000001 			  SUB  #1,(R4)+			; REDUCE COUNT BY 1.
    108	000214	005664 	177774 			  SBC  -4(R4)
    109	000220	052764 	140000 	177774 		  BIS  #140000,-4(R4)		; INDICATE 4 WORD POINTER.
    110	000226	010324 			MOVLBN:	  MOV  R3,(R4)+			; STORE LOW ORDER LBN.
    111	000230	010214 				  MOV  R2,(R4)			; STORE HIGH ORDER LBN.
    112	000232					  LEAVE  BLDPTR			; DONE, GET OUT.
    113	000234					END
    114					;
    115					; IF WE GE4 HERE, THE SET OF BLOCKS CAN'T BE MAPPED BY ONE
    116					; RETRIEVAL POINTER. THIS IS HIGHLY UNLIKELY, AND IS TREATED
    117					; AS AN ERROR.
    118					;
    119	000234	000000 				  .WORD	0			;TEMPORARY.....
    120	000236					END	BLDPTR
    121					;
    122					; ADJUST R2,R3 TO THE LBN BEYOND THE LAST ONE MAPPED.
    123					; CLEAR R0,R1 TO INDICATE NO UNMAPPED BLOCKS.
    124					;
    125	000236	060103 				ADD	R1,R3			; ADD CNT TO STARTING LBN
    126	000240	005502 				ADC	R2
    127	000242	060002 				ADD	R0,R2
    128	000244	005000 				CLR	R0
    129	000246	005001 				CLR	R1
    130	000250	005226 				INC	(SP)+			; DISCARD FREE SPACE COUNT.
    131	000252	006216 				ASR	(SP)			; CONVERT TO WORDS IN USE.
    132	000254	112665 	000072 			MOVB	(SP)+,H.USE(R5)		; UPDATE MAP AREA WORDS IN USE.
    133	000260					POP	R4			; RESTORE CALLER'S R4.
    134	000262					RETURN  NOERROR
    135					;
    136					; TO HERE IF MAP AREA IS FULL
    137					;
    138	000266	022626 			FULL:	CMP  (SP)+,(SP)+		; CLEAN STACK.
    139	000270					POP  R4				; RESTORE CALLER'S R4,R5.
    140	000272					RETURN  ERROR
    141
    142		000001 				.END
BLDRP	X0001 - BUILD RETRIEVAL	MACRO M1110  21-AUG-78 19:59  PAGE 4-2
SYMBOL TABLE

BLDPTR= 000000   	H.FPRO= 000100   	H.USE = 000072   	L3      000234R  	$EF$  = 000000
B0      000042R  	H.FRVN= 000014   	IIII  = 177777   	MOVLBN  000226R  	$E$   = 000001
E0      000236R  	H.FSEG= 000004   	I.BKDT= 000052   	SC.BAD= 000100   	$I$   = 000001
FP.DEL= 000010   	H.FSEQ= 000012   	I.CRDT= 000022   	SC.DIR= 000040   	$K$   = 000000
FP.EXE= 000004   	H.IDOF= 000000   	I.EXDT= 000042   	SC.MDL= 000200   	$L    = 000001
FP.RDV= 000001   	H.MPOF= 000001   	I.FNAM= 000000   	S.HDHD= 000114   	$L$   = 000000
FP.WRV= 000002   	H.PRIV= 000073   	I.RVDT= 000032   	S.IDHD= 000202   	$O$   = 000000
FULL    000266R  	H.PROG= 000074   	I.RVNO= 000020   	S.MPHD= 000000   	$R    = 177777
H.ACOF= 000002   	H.PROJ= 000076   	I.ULAB= 000062   	TYPS0 = 000003   	$SUPMC= 000043
H.CKSM= 000776   	H.RPRO= 000102   	LBLS0 = 000000   	TYPS1 = 000000   	$T    = 000004
H.EFNU= 000016   	H.RSOF= 000003   	LBLS1 = 000003   	TYPS2 = 000000   	$T1   = 000003
H.EFSQ= 000020   	H.SCHA= 000065   	LBLS2 = 000004   	TYPS3 = 000000   	$T2   = 000000
H.ERVN= 000022   	H.SEMK= 000104   	LBLS3 = 000002   	UC.CON= 000200   	$$S   = 000000
H.FCHA= 000064   	H.SMMX= 000110   	L0      000120R  	UC.DLK= 000100   	$$TT  = 000004
H.FLEV= 000006   	H.UCHA= 000064   	L1      000120R  	$BLDRP  000000RG 	...GBL= 000000
H.FNUM= 000010   	H.UFAT= 000024   	L2      000162R  	$DIDDO= 000000   	...TPC= 000000
H.FOWN= 000074

. ABS.	000000	   000
      	000276	   001
ERRORS DETECTED:  0

VIRTUAL MEMORY USED:  12779 WORDS  ( 50 PAGES)
DYNAMIC MEMORY:  14388 WORDS  ( 55 PAGES)
ELAPSED TIME:  00:00:38
EXE$:BLDRP,LIS$:BLDRP/-SP=SRC$:SMAC/PA:1,DSCPRE,BLDRP
