TRDEX	X0006 - READ FILE EXTEN	MACRO M1110  21-AUG-78 21:19  PAGE 3


      1	000000					$BEGIN	TRDEX,0006,<READ FILE EXTENSION HEADER FROM TAPE>
						.TITLE	TRDEX	X0006 - READ FILE EXTENSION HEADER FROM TAPE
						.IDENT	"X0006"
      2
      3					;
      4					; COPYRIGHT (C) 1977 BY DIGITAL EQUIPMENT CORPORATION,
      5					; MAYNARD, MASSACHUSETTS
      6					;
      7					; THIS SOFTWARE IS FURNISHED UNDER A LICENSE FOR USE ONLY ON A
      8					; SINGLE  COMPUTER  SYSTEM AND MAY BE COPIED ONLY WITH THE IN-
      9					; CLUSION OF THE ABOVE COPYRIGHT NOTICE.   THIS  SOFTWARE,  OR
     10					; ANY  OTHER  COPIES THEREOF, MAY NOT BE PROVIDED OR OTHERWISE
     11					; MADE AVAILABLE TO ANY OTHER PERSON EXCEPT FOR  USE  ON  SUCH
     12					; SYSTEM  AND TO ONE WHO AGREES TO THESE LICENSE TERMS.  TITLE
     13					; TO AND OWNERSHIP OF THE SOFTWARE SHALL AT ALL  TIMES  REMAIN
     14					; IN DIGITAL.
     15					;
     16					; THE INFORMATION IN THIS SOFTWARE IS SUBJECT TO CHANGE  WITH-
     17					; OUT  NOTICE  AND  SHOULD NOT BE CONSTRUED AS A COMMITMENT BY
     18					; DIGITAL EQUIPMENT CORPORATION.
     19					;
     20					; DIGITAL EQUIPMENT CORPORATION ASSUMES NO RESPONSIBILITY  FOR
     21					; THE USE OR RELIABILITY OF ITS SOFTWARE ON EQUIPMENT WHICH IS
     22					; NOT SUPPLIED BY DIGITAL.
     23					;
     24					; ANDREW C. GOLDSTEIN  17-AUG-76  23:14
     25					; GEORGE RITTENBURG	7-APR-77  MODIFIED FOR VFY/CMP DISK TO/FROM TAPE
     26
     27
     28						.MCALL	FHDL2$
     29	000000					FHDL2$			; DEFINE FILE HEADER OFFSETS
TRDEX	X0006 - READ FILE EXTEN	MACRO M1110  21-AUG-78 21:19  PAGE 4


     31					;+
     32					;
     33					; *** - $TRDEX	READ EXTENSION HEADER FROM TAPE
     34					;
     35					; THIS ROUTINE READS THE NEXT FILE EXTENSION HEADER FROM THE INPUT
     36					; TAPE AND CHECKS IT FOR CONSISTENCY. IF THE BLOCK READ IS NOT THE
     37					; EXTENSION HEADER, IT SEARCHES UNTIL IT IS FOUND OR THINGS ARE
     38					; CLEARLY HOPELESS.
     39					;
     40					; INPUTS:
     41					;
     42					;	INLUN ASSIGNED TO TAPE
     43					;	$INDEV POINTING AT DEVICE TABLE ENTRY
     44					;
     45					; OUTPUTS:
     46					;
     47					;	CC - C	CLEAR IF ALL OK
     48					;		SET IF ERROR
     49					;	$BUF2 CONTAINS FILE HEADER
     50					;	R5 = ADDRESS OF HEADER READ
     51					;	IF ERROR, R4 POINTS AT BCB OF OFFENDING BUFFER
     52					;
     53					;-
     54
     55	000000				$TRDEX::
     56	000000					IF #KY.NIP SET.IN $FLAG1
     57	000010						LET R0 := #$OHHD
     58	000014					ELSE
     59	000016							LET R0 := #$IHHD
     60	000022					END
     61	000022					LET B.STAT(R0) := #0		;DISCARD OLD FILE HEADER
     62	000026					  $CALL $RDWAT <,#512.+P.SIZ,,,#$B2HD>
     63	000042					  ON.ERROR
     64	000044						IF #KY.VFY SET.IN $FLAG1 OR #KY.CMP SET.IN $OFLAG
     65	000064							ERROR  ER.RXD
     66	000066						END
     67	000066					    ERRP ER.RHT			; PRINT I/O ERROR MESSAGE
     68	000070					    IFB (R4) EQ #IE.EOF GOTO NOHDR ; END OF FILE - NO MORE
     69	000076					  ELSE
     70	000100					    IF P.FLAG(R5) EQ #PF.ATR GOTO NOHDR
     71	000110					    IF P.FLAG(R5) EQ #PF.HDR	; CHECK IF HEADER BLOCK
     72	000120					      IF $FID EQ P.FID(R5)	; CHECK FILE ID OF FILE
     73	000130						IF $FID+2 EQ P.FID+2(R5)
     74	000140						  IF $FID+4 EQ P.FID+4(R5)
     75	000150						    LET R5 := R5 + #P.SIZ ; POINT TO HEADER DATA
     76	000154						    LET $FNU := H.FNUM(R5) ; SET FILE NUMBER
     77	000162						    $CALL $VFYHD <,,,,,R5> ; SEE IF REAL FILE HEADER
     78	000166						    ON.NOERROR
     79	000170						      LET $TESQN := $TESQN + #1	; BUMP SEG NUMBER
     80	000174						      IFB H.FSEG(R5) EQ $TESQN ; CHECK IT
     81	000204							IF #KY.NIP OFF.IN $FLAG1
     82	000214								$CALL $FILSZ <,,,,,#$B2DAT> ; COMPUTE FILE HEADER SIZE
     83	000224								LET $IHVBN := $IHVBN + R1 ; AND SAVE
     84	000230								LET $IHVBN+2 := $IHVBN+2 + CARRY + R0
     85	000240								LET $IFLAG := $IFLAG OFF.BY #KY.LOS
     86	000246								$CALL $BUFCK <,,,,#$IHHD> ; GET INDEX FILE HEADER BUFFER
     87	000256								LET B.STAT(R4) := #1 ; MARK IT BUSY
TRDEX	X0006 - READ FILE EXTEN	MACRO M1110  21-AUG-78 21:19  PAGE 4-1


     88	000264								LET R0 := #$IHBF ; COPY HEADER INTO IHBF
     89	000270								THRU R1 := #256.
     90	000274								  LET (R0)+ := (R5)+
     91	000276								END LOOP
     92	000302							ELSE
     93	000304								$CALL $FILSZ  <,,,,,#$B2DAT>
     94	000314								LET $OHVBN := $OHVBN + R1
     95	000320								LET $OHVBN+2 := $OHVBN+2 + CARRY + R0
     96	000330								LET R0 := #$OHBF
     97	000334								THRU R1 := #256.
     98	000340								LET (R0)+ := (R5)+
     99	000342								END LOOP
    100	000346							END
    101	000346							RETURN NOERROR
    102	000352						      END
    103	000352						    END
    104	000352						  END
    105	000352						END
    106	000352					      END
    107	000352					      GOTO NOHDR		; WRONG HEADER - OUT
    108	000354					    END
    109	000354					  END
    110	000354					  IF #KY.LOS OFF.IN $IFLAG	; IF WE ARE NOT LOST
    111	000364					    ERRP ER.NXT			; PRINT MESSAGE
    112	000366					  END
    113	000366					  LET $IFLAG := $IFLAG SET.BY #KY.LOS ; WE ARE NOW
    114	000374					  LET B.STAT(R4) := #0		; INVALIDATE BUFFER FOR RETRY
    115	000400					JUMPTO $TRDEX
    116	000404				NOHDR:
    117	000404					IF #KY.VFY SET.IN $FLAG1 OR #KY.CMP SET.IN $OFLAG
    118	000424						ERROR ER.RXD
    119	000426					END
    120	000426					ERRP ER.NNX			; FAILED TO FIND HEADER
    121	000430					RETURN ERROR
    122
    123
    124
    125		000001 				.END
TRDEX	X0006 - READ FILE EXTEN	MACRO M1110  21-AUG-78 21:19  PAGE 4-2
SYMBOL TABLE

A3    = 000001   	H.PRIV= 000073   	LBLS4 = 000011   	SC.DIR= 000040   	$IHHD = ****** GX
B.STAT= ****** GX	H.PROG= 000074   	LBLS5 = 000012   	SC.MDL= 000200   	$IHVBN= ****** GX
B0      000274R  	H.PROJ= 000076   	LBLS6 = 000013   	S.HDHD= 000114   	$I$   = 000001
B1      000340R  	H.RPRO= 000102   	LBLS7 = 000015   	S.IDHD= 000202   	$L    = 000002
ER.NNX= ****** GX	H.RSOF= 000003   	L0      000016R  	S.MPHD= 000000   	$L$   = 000000
ER.NXT= ****** GX	H.SCHA= 000065   	L1      000022R  	TYPS0 = 000000   	$OFLAG= ****** GX
ER.RHT= ****** GX	H.SEMK= 000104   	L10     000352R  	TYPS1 = 000000   	$OHBF = ****** GX
ER.RXD= ****** GX	H.SMMX= 000110   	L11     000352R  	TYPS10= 000006   	$OHHD = ****** GX
E0      000302R  	H.UCHA= 000064   	L12     000352R  	TYPS2 = 000000   	$OHVBN= ****** GX
E1      000346R  	H.UFAT= 000024   	L13     000352R  	TYPS3 = 000000   	$O$   = 000000
FP.DEL= 000010   	H.USE = 000072   	L14     000304R  	TYPS4 = 000000   	$R    = 177777
FP.EXE= 000004   	IE.EOF= ****** GX	L15     000346R  	TYPS5 = 000000   	$RDWAT= ****** GX
FP.RDV= 000001   	IIII  = 177777   	L16     000366R  	TYPS6 = 000000   	$SUPMC= 000043
FP.WRV= 000002   	I.BKDT= 000052   	L17     000424R  	TYPS7 = 000000   	$SV$  = 000000
H.ACOF= 000002   	I.CRDT= 000022   	L2      000100R  	UC.CON= 000200   	$T    = 000021
H.CKSM= 000776   	I.EXDT= 000042   	L20     000426R  	UC.DLK= 000100   	$TESQN= ****** GX
H.EFNU= 000016   	I.FNAM= 000000   	L3      000064R  	$BUFCK= ****** GX	$TRDEX  000000RG
H.EFSQ= 000020   	I.RVDT= 000032   	L4      000066R  	$B2DAT= ****** GX	$T1   = 000000
H.ERVN= 000022   	I.RVNO= 000020   	L5      000354R  	$B2HD = ****** GX	$T2   = 000020
H.FCHA= 000064   	I.ULAB= 000062   	L6      000354R  	$DIDDO= 000000   	$VFYHD= ****** GX
H.FLEV= 000006   	KY.CMP= ****** GX	L7      000352R  	$EF$  = 000000   	$Y$   = 000007
H.FNUM= 000010   	KY.LOS= ****** GX	NOHDR   000404R  	$E$   = 000001   	$Z$   = 000000
H.FOWN= 000074   	KY.NIP= ****** GX	PF.ATR= ****** GX	$FID  = ****** GX	$$S   = 000000
H.FPRO= 000100   	KY.VFY= ****** GX	PF.HDR= ****** GX	$FILSZ= ****** GX	$$T   = 000017
H.FRVN= 000014   	LBLS0 = 000020   	P.FID = ****** GX	$FLAG1= ****** GX	$$TT  = 000020
H.FSEG= 000004   	LBLS1 = 000020   	P.FLAG= ****** GX	$FNU  = ****** GX	.$T   = 000006
H.FSEQ= 000012   	LBLS10= 000001   	P.SIZ = ****** GX	$IFLAG= ****** GX	...GBL= 000000
H.IDOF= 000000   	LBLS2 = 000007   	SC.BAD= 000100   	$IHBF = ****** GX	...TPC= 000000
H.MPOF= 000001   	LBLS3 = 000010

. ABS.	000000	   000
      	000434	   001
ERRORS DETECTED:  0

VIRTUAL MEMORY USED:  13115 WORDS  ( 52 PAGES)
DYNAMIC MEMORY:  14388 WORDS  ( 55 PAGES)
ELAPSED TIME:  00:01:40
EXE$:TRDEX,LIS$:TRDEX/-SP=SRC$:SMAC/PA:1,DSCPRE,TRDEX
